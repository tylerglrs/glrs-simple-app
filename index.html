<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GLRS Recovery Connect</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: white;
            position: relative;
            overflow-x: hidden;
        }
        
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #f4c430;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%),
                        url('sunset1.jpg') center/cover;
            background-blend-mode: overlay;
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .logo-container {
            margin-bottom: 20px;
        }
        
        .lighthouse-logo {
            width: 100px;
            height: 100px;
            margin: 0 auto;
        }
        
        .app-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
            color: white;
        }
        
        .app-subtitle {
            font-size: 16px;
            opacity: 0.8;
            margin-bottom: 30px;
            color: #f4c430;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 16px;
        }
        
        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .btn-primary {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary.completed {
            background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
        }
        
        .error-message {
            color: #ff6b6b;
            margin-top: 10px;
            font-size: 14px;
            text-align: center;
        }
        
        .success-message {
            color: #4caf50;
            margin-top: 10px;
            font-size: 14px;
            text-align: center;
        }
        
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%),
                        url('sunset2.jpg') center/cover;
            background-blend-mode: overlay;
        }
        
        .header {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        
        .header-title {
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-logo {
            width: 30px;
            height: 30px;
        }
        
        .notification-badge {
            position: relative;
            cursor: pointer;
        }
        
        .badge-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .content {
            flex: 1;
            padding: 20px;
            padding-bottom: 80px;
            overflow-y: auto;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 1000;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .nav-item:active {
            transform: scale(0.95);
        }
        
        .nav-item.active {
            color: #f4c430;
        }
        
        .nav-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }
        
        .nav-label {
            font-size: 12px;
        }
        
        .section-content {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .hero-background {
            position: relative;
            border-radius: 20px;
            padding: 40px 20px;
            margin-bottom: 20px;
            overflow: hidden;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.5) 0%, rgba(118, 75, 162, 0.5) 100%);
        }
        
        .day-counter-container {
            position: relative;
            z-index: 1;
            text-align: center;
        }
        
        .large-number {
            font-size: 72px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #f4c430;
        }
        
        .large-text {
            font-size: 24px;
            margin-bottom: 20px;
            opacity: 0.9;
        }
        
        .motivational-quote {
            font-size: 16px;
            opacity: 0.8;
            font-style: italic;
        }
        
        .coach-info-card {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(67, 160, 71, 0.1) 100%);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #f4c430;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 4px;
        }
        
        .daily-pledge {
            background: linear-gradient(135deg, rgba(156, 39, 176, 0.2) 0%, rgba(103, 58, 183, 0.2) 100%);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .pledge-text {
            font-size: 18px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .mood-tracker {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .mood-options {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }
        
        .mood-emoji {
            font-size: 32px;
            cursor: pointer;
            transition: transform 0.2s;
            padding: 10px;
            border-radius: 50%;
        }
        
        .mood-emoji:hover {
            transform: scale(1.2);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .mood-emoji.selected {
            background: rgba(244, 196, 48, 0.3);
            transform: scale(1.2);
        }
        
        .milestone-preview {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(67, 160, 71, 0.1) 100%);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            margin-top: 20px;
        }
        
        .broadcast-banner {
            background: linear-gradient(135deg, rgba(244, 196, 48, 0.2) 0%, rgba(255, 149, 0, 0.2) 100%);
            border: 1px solid rgba(244, 196, 48, 0.5);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .broadcast-content {
            flex: 1;
        }
        
        .broadcast-dismiss {
            background: none;
            border: none;
            color: white;
            opacity: 0.6;
            cursor: pointer;
            font-size: 20px;
        }
        
        .daily-tasks-card {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(67, 160, 71, 0.1) 100%);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .task-list {
            margin-top: 15px;
        }
        
        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }
        
        .task-item:last-child {
            border-bottom: none;
        }
        
        .task-item:hover {
            background: rgba(255, 255, 255, 0.05);
            margin: 0 -10px;
            padding: 12px 10px;
            border-radius: 10px;
        }
        
        .completed {
            color: #4caf50;
            font-weight: bold;
        }
        
        .pending {
            color: #ff9800;
        }
        
        .overdue {
            color: #ff4757;
        }
        
        .goal-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .progress-badge {
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 10px;
            margin-bottom: 15px;
        }
        
        .progress-fill {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            border-radius: 10px;
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .objectives-list {
            margin-top: 15px;
            padding-left: 20px;
        }
        
        .objective-item {
            margin-bottom: 10px;
            list-style-type: none;
            position: relative;
        }
        
        .objective-item:before {
            content: "→";
            position: absolute;
            left: -20px;
            color: #f4c430;
        }
        
        .assignments-list {
            margin-top: 15px;
        }
        
        .assignment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .btn-complete {
            padding: 5px 15px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            border: none;
            border-radius: 15px;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            height: 300px;
        }
        
        .milestones-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .milestone-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .milestone-item:last-child {
            border-bottom: none;
        }
        
        .milestone-icon {
            font-size: 24px;
            margin-right: 15px;
        }
        
        .milestone-content {
            flex: 1;
        }
        
        .milestone-title {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .milestone-days {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .milestone-achieved {
            opacity: 0.5;
            text-decoration: line-through;
        }
        
        .compliance-card {
            background: linear-gradient(135deg, rgba(156, 39, 176, 0.1) 0%, rgba(103, 58, 183, 0.1) 100%);
            border: 1px solid rgba(156, 39, 176, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .chat-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 5px;
            border-radius: 15px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
        }
        
        .community-chat-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
        }
        
        .messages-container {
            height: 400px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .community-message {
            margin-bottom: 15px;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
            opacity: 0.8;
        }
        
        .message-author {
            font-weight: bold;
            color: #f4c430;
        }
        
        .message-time {
            font-size: 12px;
        }
        
        .message-content {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 10px;
            word-wrap: break-word;
        }
        
        .chat-input-group {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 16px;
        }
        
        .send-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            border: none;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
        
        .room-card {
            background: linear-gradient(135deg, rgba(244, 196, 48, 0.1) 0%, rgba(255, 149, 0, 0.1) 100%);
            border: 1px solid rgba(244, 196, 48, 0.3);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }
        
        .room-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .room-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .support-group-card {
            background: linear-gradient(135deg, rgba(156, 39, 176, 0.1) 0%, rgba(103, 58, 183, 0.1) 100%);
            border: 1px solid rgba(156, 39, 176, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .meeting-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .meeting-type {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 12px;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .join-btn {
            display: inline-block;
            margin-top: 15px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            border-radius: 25px;
            color: white;
            text-decoration: none;
            font-weight: bold;
            border: none;
            cursor: pointer;
        }
        
        .crisis-resources {
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid rgba(255, 71, 87, 0.3);
            border-radius: 15px;
        }
        
        .crisis-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #ff4757;
        }
        
        .crisis-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .crisis-number a {
            color: white;
            text-decoration: none;
        }
        
        .crisis-description {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .sos-btn {
            width: 100%;
            margin-top: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #ff4757 0%, #ff6348 100%);
            border: none;
            border-radius: 25px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .profile-menu {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .profile-header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .profile-avatar {
            width: 100px;
            height: 100px;
            margin: 0 auto 15px;
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            font-weight: bold;
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-avatar-upload {
            position: absolute;
            bottom: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .upload-input {
            display: none;
        }
        
        .profile-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .profile-email {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .menu-section {
            margin-top: 20px;
        }
        
        .menu-title {
            font-size: 12px;
            text-transform: uppercase;
            opacity: 0.6;
            margin-bottom: 10px;
            padding: 0 10px;
        }
        
        .menu-item {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            transition: background 0.2s;
            border-radius: 10px;
            text-align: left;
            text-decoration: none;
        }
        
        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .menu-item-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        
        .menu-icon {
            font-size: 20px;
        }
        
        .menu-arrow {
            opacity: 0.5;
        }
        
        .btn-danger {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #ff4757 0%, #ff6348 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            opacity: 0.6;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .empty-state-text {
            font-size: 16px;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
            animation: fadeIn 0.2s ease-in;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: bold;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-body {
            color: white;
        }
        
        .slider-group {
            margin-bottom: 25px;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .slider-value {
            color: #f4c430;
            font-weight: bold;
        }
        
        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #f4c430;
            cursor: pointer;
        }
        
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #f4c430;
            cursor: pointer;
        }
        
        .textarea {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 16px;
            min-height: 100px;
            resize: vertical;
        }
        
        .notification-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .notification-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .notification-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .notification-item.unread {
            border-left: 3px solid #f4c430;
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .notification-type {
            font-size: 12px;
            background: rgba(244, 196, 48, 0.3);
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        .notification-time {
            font-size: 12px;
            opacity: 0.7;
        }
        
        .notification-message {
            font-size: 14px;
            line-height: 1.4;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .large-number {
                font-size: 56px;
            }
            
            .modal-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React and Firebase -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script type="text/babel">
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAufSTHtCTFSEIeZ9YzvrULCnji5I-SMi0",
            authDomain: "glrs-pir-system.firebaseapp.com",
            projectId: "glrs-pir-system",
            storageBucket: "glrs-pir-system.appspot.com",
            messagingSenderId: "830378577655",
            appId: "1:830378577655:web:8a9ea644b8e3c5a9f15c42"
        };

        // Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// Global helper function for consistent sobriety day calculation - FIXED VERSION
window.getSobrietyDays = (sobrietyDate) => {
    if (!sobrietyDate) return 0;
    
    const sobrietyDateObj = new Date(sobrietyDate);
    const today = new Date();
    
    // Reset to midnight for accurate day counting
    sobrietyDateObj.setHours(0, 0, 0, 0);
    today.setHours(0, 0, 0, 0);
    
    // Calculate difference in milliseconds
    const diffTime = today - sobrietyDateObj;
    
    // Convert to days and add 1 (sobriety date counts as day 1)
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
    
    // Return at least 1 if sobriety date is today or in the past
    return Math.max(1, diffDays);
};

const { useState, useEffect, useRef } = React;

        // Lighthouse Logo Component
        function LighthouseLogo({ size = 100 }) {
            return (
                <svg width={size} height={size} viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="100" cy="100" r="95" stroke="#1e3c72" strokeWidth="3" fill="rgba(30, 60, 114, 0.1)"/>
                    <path d="M100 140 L85 180 L115 180 Z" fill="#ffffff"/>
                    <rect x="92" y="100" width="16" height="40" fill="#ffffff"/>
                    <rect x="88" y="90" width="24" height="10" fill="#1e3c72"/>
                    <path d="M100 70 L90 90 L110 90 Z" fill="#1e3c72"/>
                    <rect x="95" y="70" width="10" height="20" fill="#1e3c72"/>
                    <path d="M100 80 L60 70" stroke="#f4c430" strokeWidth="3" opacity="0.8"/>
                    <path d="M100 80 L140 70" stroke="#f4c430" strokeWidth="3" opacity="0.8"/>
                    <path d="M100 80 L50 85" stroke="#f4c430" strokeWidth="3" opacity="0.6"/>
                    <path d="M100 80 L150 85" stroke="#f4c430" strokeWidth="3" opacity="0.6"/>
                    <circle cx="100" cy="80" r="8" fill="#f4c430"/>
                    <path d="M 60 170 Q 80 165, 100 170 T 140 170" stroke="#4a90e2" strokeWidth="2" fill="none"/>
                    <path d="M 50 175 Q 75 170, 100 175 T 150 175" stroke="#4a90e2" strokeWidth="2" fill="none" opacity="0.6"/>
                </svg>
            );
        }

        // Main App Component
        function App() {
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(true);
    
    useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged(async (firebaseUser) => {
            if (firebaseUser) {
                try {
                    let userDoc = await db.collection('users').doc(firebaseUser.uid).get();
                    
                    if (!userDoc.exists) {
                        // Create new user document with timestamps
                        await db.collection('users').doc(firebaseUser.uid).set({
                            email: firebaseUser.email,
                            role: 'pir',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            active: true,
                            sobrietyDate: new Date().toISOString(),
                            profileComplete: false
                        });
                        
                        // Re-fetch the document after creating it
                        userDoc = await db.collection('users').doc(firebaseUser.uid).get();
                    }
                    
                    const userData = userDoc.data();
                    
                    // Check for existing users without createdAt
                    if (userData && !userData.createdAt) {
                        await db.collection('users').doc(firebaseUser.uid).update({
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                    // Verify role
                    if (userData && userData.role !== 'pir') {
                        await auth.signOut();
                        alert('This portal is for PIRs only. Coaches should use admin.html');
                        setUser(null);
                    } else {
                        setUser(firebaseUser);
                    }
                } catch (error) {
                    console.error('Error verifying user:', error);
                    setUser(null);
                }
            } else {
                setUser(null);
            }
            setLoading(false);
        });

        return () => unsubscribe();
    }, []);

    if (loading) {
        return (
            <div className="loading-container">
                <div className="loading-spinner"></div>
            </div>
        );
    }

    return user ? <PIRApp user={user} /> : <LoginScreen />;
}
       
                                
        // Login Screen Component
        function LoginScreen() {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [success, setSuccess] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                setSuccess('');
                
                if (!email || !password) {
                    setError('Please enter both email and password');
                    return;
                }

                setLoading(true);

                try {
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    const userDoc = await db.collection('users').doc(userCredential.user.uid).get();
                    
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        if (userData.role !== 'pir') {
                            await auth.signOut();
                            setError('This login is for PIR users only.');
                            setLoading(false);
                            return;
                        }
                        
                        if (!userData.active) {
                            await auth.signOut();
                            setError('Your account is inactive. Please contact your coach.');
                            setLoading(false);
                            return;
                        }
                    }
                    
                    setSuccess('Login successful! Redirecting...');
                } catch (error) {
                    console.error('Login error:', error);
                    
                    switch(error.code) {
                        case 'auth/user-not-found':
                            setError('No account found with this email');
                            break;
                        case 'auth/wrong-password':
                            setError('Incorrect password');
                            break;
                        case 'auth/invalid-email':
                            setError('Invalid email address');
                            break;
                        default:
                            setError('Failed to sign in. Please try again.');
                    }
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="login-container">
                    <div className="login-card">
                        <div className="logo-container">
                            <LighthouseLogo />
                        </div>
                        <h1 className="app-title">Guiding Light</h1>
                        <p className="app-subtitle">Recovery Services</p>
                        
                        <form onSubmit={handleLogin}>
                            <div className="form-group">
                                <label className="form-label">Email</label>
                                <input
                                    type="email"
                                    className="form-input"
                                    placeholder="Enter your email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    disabled={loading}
                                    autoComplete="email"
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Password</label>
                                <input
                                    type="password"
                                    className="form-input"
                                    placeholder="Enter your password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    disabled={loading}
                                    autoComplete="current-password"
                                />
                            </div>
                            
                            <button type="submit" className="btn-primary" disabled={loading}>
                                {loading ? 'Signing in...' : 'Sign In'}
                            </button>
                            
                            {error && <div className="error-message">{error}</div>}
                            {success && <div className="success-message">{success}</div>}
                        </form>
                    </div>
                </div>
            );
        }

        // Main PIR App Component
        function PIRApp({ user }) {
            // CORRECTED NAVIGATION ORDER: Tasks-Home-Progress-Connect-Profile
            const [currentView, setCurrentView] = useState('home');
            const [loading, setLoading] = useState(true);
            
            // User Data States
            const [userData, setUserData] = useState(null);
            const [profileImage, setProfileImage] = useState(null);
            const [coachInfo, setCoachInfo] = useState(null);
            
            // Home Section States
            const [sobrietyDays, setSobrietyDays] = useState(0);
            const [selectedMood, setSelectedMood] = useState(null);
            const [pledgeMade, setPledgeMade] = useState(false);
            const [moneySaved, setMoneySaved] = useState(0);
            const [dailyQuote, setDailyQuote] = useState(null);
            const [milestones, setMilestones] = useState([]);
            const [nextMilestone, setNextMilestone] = useState(null);
            const [activeBroadcast, setActiveBroadcast] = useState(null);
            const [broadcastDismissed, setBroadcastDismissed] = useState(false);
            const [checkInStatus, setCheckInStatus] = useState({ morning: false, evening: false });
            const [checkInStreak, setCheckInStreak] = useState(0);
            const [complianceRate, setComplianceRate] = useState({ checkIn: 0, assignment: 0 });
            const [totalCheckIns, setTotalCheckIns] = useState(0);
            
            // Progress States
            const [checkIns, setCheckIns] = useState([]);
            const [moodChartData, setMoodChartData] = useState(null);
            const [cravingChartData, setCravingChartData] = useState(null);
            const chartRef = useRef(null);
            const cravingChartRef = useRef(null);
            
            // Tasks States
            const [goals, setGoals] = useState([]);
            const [assignments, setAssignments] = useState([]);
            
            // Connect States
            const [activeChat, setActiveChat] = useState('main');
            const [communityMessages, setCommunityMessages] = useState([]);
            const [topicRooms, setTopicRooms] = useState([]);
            const [meetings, setMeetings] = useState([]);
            const [supportGroups, setSupportGroups] = useState([]);
            const [emergencyResources, setEmergencyResources] = useState([]);
            const [activeTopicRoom, setActiveTopicRoom] = useState(null);
            const [topicRoomMessages, setTopicRoomMessages] = useState([]);
            
            // Profile States
            const [resources, setResources] = useState({
                videos: [],
                articles: [],
                tools: [],
                worksheets: []
            });
            
            // General States
            const [notifications, setNotifications] = useState([]);
            const [unreadCount, setUnreadCount] = useState(0);
            const [showModal, setShowModal] = useState(null);
            const fileInputRef = useRef(null);

            // Real-time listeners references
            const listenersRef = useRef([]);

            // Load all data on mount
            useEffect(() => {
                if (user) {
                    loadAllData();
                    setupRealtimeListeners();
                }

                return () => {
                    // Cleanup listeners
                    listenersRef.current.forEach(unsubscribe => unsubscribe());
                };
            }, [user]);

            // Setup real-time listeners
            const setupRealtimeListeners = () => {
                // Notifications listener
                const notifListener = db.collection('notifications')
                    .where('userId', '==', user.uid)
                    .orderBy('createdAt', 'desc')
                    .limit(20)
                    .onSnapshot(snapshot => {
                        const notificationsList = [];
                        let unread = 0;
                        snapshot.forEach(doc => {
                            const notification = { id: doc.id, ...doc.data() };
                            notificationsList.push(notification);
                            if (!notification.read) unread++;
                        });
                        setNotifications(notificationsList);
                        setUnreadCount(unread);
                    });
                listenersRef.current.push(notifListener);

                // Community messages listener
                const messagesListener = db.collection('messages')
                    .where('roomId', '==', 'main')
                    .orderBy('createdAt', 'desc')
                    .limit(50)
                    .onSnapshot(snapshot => {
                        const messages = [];
                        snapshot.forEach(doc => {
                            messages.push({ id: doc.id, ...doc.data() });
                        });
                        setCommunityMessages(messages.reverse());
                    });
                listenersRef.current.push(messagesListener);

                // Goals listener
                const goalsListener = db.collection('goals')
                    .where('userId', '==', user.uid)
                    .where('status', '==', 'active')
                    .onSnapshot(snapshot => {
                        loadGoals();
                    });
                listenersRef.current.push(goalsListener);

                // Assignments listener
                const assignmentsListener = db.collection('assignments')
                    .where('userId', '==', user.uid)
                    .onSnapshot(snapshot => {
                        loadAssignments();
                    });
                listenersRef.current.push(assignmentsListener);

                // Broadcasts listener
                const broadcastsListener = db.collection('broadcasts')
                    .where('active', '==', true)
                    .orderBy('createdAt', 'desc')
                    .limit(1)
                    .onSnapshot(snapshot => {
                        if (!snapshot.empty && !broadcastDismissed) {
                            const broadcast = snapshot.docs[0].data();
                            setActiveBroadcast(broadcast);
                        }
                    });
                listenersRef.current.push(broadcastsListener);
            };

          // Correct sobriety days calculation function
const calculateSobrietyDays = (sobrietyDate) => {
    if (!sobrietyDate) return 0;
    
    const sobrietyDateObj = new Date(sobrietyDate);
    const today = new Date();
    
    // Reset time to start of day for accurate day counting
    sobrietyDateObj.setHours(0, 0, 0, 0);
    today.setHours(0, 0, 0, 0);
    
    // Calculate difference in milliseconds
    const diffTime = today - sobrietyDateObj;
    
    // Convert to days and add 1 (because day 1 is the sobriety date itself)
    const sobrietyDays = window.getSobrietyDays(userData.sobrietyDate);
    
    // Return at least 1 if sobriety date is today or in the past
    return Math.max(1, diffDays);
};

// Updated useEffect for PIRApp component
useEffect(() => {
    if (userData?.sobrietyDate) {
        const calculateStats = () => {
            const sobrietyDays = window.getSobrietyDays(userData.sobrietyDate);
            setSobrietyDays(sobrietyDays);
            
            // Use the user's custom daily cost, default to 20 if not set
            const dailyCost = userData.dailyCost || 20;
            setMoneySaved(sobrietyDays * dailyCost);
        };
        
        calculateStats();
        const interval = setInterval(calculateStats, 60000);
        return () => clearInterval(interval);
    }
}, [userData]);

            // Initialize charts when data changes
            useEffect(() => {
                if (currentView === 'progress' && moodChartData && cravingChartData) {
                    setTimeout(() => {
                        const moodCanvas = document.getElementById('moodChart');
                        const cravingCanvas = document.getElementById('cravingChart');
                        
                        // Destroy existing charts
                        if (chartRef.current) {
                            chartRef.current.destroy();
                        }
                        if (cravingChartRef.current) {
                            cravingChartRef.current.destroy();
                        }
                        
                        if (moodCanvas) {
                            const ctx = moodCanvas.getContext('2d');
                            chartRef.current = new Chart(ctx, {
                                type: 'line',
                                data: moodChartData,
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            max: 5
                                        }
                                    }
                                }
                            });
                        }
                        
                        if (cravingCanvas) {
                            const ctx = cravingCanvas.getContext('2d');
                            cravingChartRef.current = new Chart(ctx, {
                                type: 'line',
                                data: cravingChartData,
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            max: 5
                                        }
                                    }
                                }
                            });
                        }
                    }, 100);
                }
            }, [currentView, moodChartData, cravingChartData]);

            // Check profile completion
            useEffect(() => {
                if (userData && !userData.profileComplete) {
                    const checkProfileCompletion = () => {
                        if (userData.firstName && userData.lastName && userData.phone) {
                            db.collection('users').doc(user.uid).update({
                                profileComplete: true
                            });
                        } else if (!showModal) {
                            setTimeout(() => {
                                if (!localStorage.getItem('profilePromptShown')) {
                                    setShowModal('profilePrompt');
                                    localStorage.setItem('profilePromptShown', 'true');
                                }
                            }, 5000);
                        }
                    };
                    checkProfileCompletion();
                }
            }, [userData, showModal]);
            // Auto-refresh tasks at midnight PST
useEffect(() => {
    const checkMidnightReset = () => {
        const now = new Date();
        const pstNow = new Date(now.toLocaleString("en-US", {timeZone: "America/Los_Angeles"}));
        const hours = pstNow.getHours();
        const minutes = pstNow.getMinutes();
        const seconds = pstNow.getSeconds();
        
        // Calculate milliseconds until midnight PST
        const msUntilMidnight = ((23 - hours) * 60 * 60 + (59 - minutes) * 60 + (60 - seconds)) * 1000;
        
        // Set timeout for midnight reset
        const midnightTimer = setTimeout(() => {
            // Reset daily tasks
            loadDailyTasksStatus();
            loadCheckIns();
            setCheckInStatus({ morning: false, evening: false });
            
            // Set up daily interval
            const dailyInterval = setInterval(() => {
                loadDailyTasksStatus();
                loadCheckIns();
                setCheckInStatus({ morning: false, evening: false });
            }, 24 * 60 * 60 * 1000); // Every 24 hours
            
            return () => clearInterval(dailyInterval);
        }, msUntilMidnight);
        
        return () => clearTimeout(midnightTimer);
    };
    
    checkMidnightReset();
}, []);

            const loadAllData = async () => {
    try {
        await Promise.all([
    loadTopicRooms(),
    loadMeetings(),
    loadEmergencyResources(),
    loadGoals(),
    loadAssignments(),
    loadDailyInspiration(),
    loadMilestones(),
    loadBroadcasts(),
    loadResources(),
    loadSupportGroups(),
    loadCheckIns(),
    loadTodaysPledge(),
    loadStreak(),
    loadComplianceRates(),
    checkMilestoneNotifications(),
    loadDailyTasksStatus(),
    calculateTotalCheckIns().then(count => setTotalCheckIns(count))  // ADD THIS
]);
    } catch (error) {
        console.error('Error loading data:', error);
    } finally {
        setLoading(false);
    }
};

            // Load user data and coach info
            const loadUserData = async () => {
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        const data = userDoc.data();
                        setUserData(data);
                        
                        if (data.profileImageUrl) {
                            setProfileImage(data.profileImageUrl);
                        }
                        
                        // Load coach info
                        if (data.assignedCoach) {
                            const coachDoc = await db.collection('users').doc(data.assignedCoach).get();
                            if (coachDoc.exists) {
                                setCoachInfo(coachDoc.data());
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error loading user data:', error);
                }
            };

            // Load topic rooms
            const loadTopicRooms = async () => {
                try {
                    const roomsSnap = await db.collection('topicRooms')
                        .where('active', '==', true)
                        .get();
                    
                    const roomsData = [];
                    roomsSnap.forEach(doc => {
                        roomsData.push({ id: doc.id, ...doc.data() });
                    });
                    setTopicRooms(roomsData);
                } catch (error) {
                    console.error('Error loading topic rooms:', error);
                }
            };
            // Add these state variables in TopicRoom component
            // Add state for image modal (near your other state variables)
const [modalImage, setModalImage] = useState(null);

// Image Modal Component (add before the return statement)
const ImageModal = ({ imageUrl, onClose }) => {
    if (!imageUrl) return null;
    
    return (
        <div 
            onClick={onClose}
            style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                backgroundColor: 'rgba(0, 0, 0, 0.9)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 10000,
                cursor: 'pointer'
            }}
        >
            <img 
                src={imageUrl}
                style={{
                    maxWidth: '90%',
                    maxHeight: '90%',
                    objectFit: 'contain'
                }}
                onClick={(e) => e.stopPropagation()}
            />
            <button
                onClick={onClose}
                style={{
                    position: 'absolute',
                    top: '20px',
                    right: '20px',
                    background: 'transparent',
                    border: 'none',
                    color: 'white',
                    fontSize: '30px',
                    cursor: 'pointer'
                }}
            >
                ✕
            </button>
        </div>
    );
};
const [selectedImage, setSelectedImage] = useState(null);
const [uploading, setUploading] = useState(false);

// Image selection handler - UPDATED
const handleTopicImageSelect = (e) => {
    const file = e.target.files[0];
    if (file) {
        // Remove the size check here since we'll compress it
        setSelectedImage(file);
    }
};

// Update handleSendMessage in TopicRoom - UPDATED
const handleSendMessage = async () => {
    if ((!topicMessage.trim() && !selectedImage) || uploading) return;
    
    try {
        setUploading(true);
        const messageData = {
            senderId: user.uid,  // Changed from userId to senderId to match display
            senderName: userData?.displayName || userData?.firstName || 'Anonymous',
            content: topicMessage,  // Changed from 'message' to 'content' to match display
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            roomId: data.activeTopicRoom.id  // Changed from selectedRoom to data.activeTopicRoom
        };
        
        // Upload image if selected
        if (selectedImage) {
            const imageUrl = await uploadChatImage(selectedImage, 'topic', data.activeTopicRoom.id);
            messageData.imageUrl = imageUrl;
            messageData.imageName = selectedImage.name;
        }
        
        await db.collection('topicRooms').doc(data.activeTopicRoom.id)
            .collection('messages').add(messageData);
        
        setTopicMessage('');  // Changed from setNewMessage to setTopicMessage
        setSelectedImage(null);
        const fileInput = document.getElementById('topic-image-input');
        if (fileInput) fileInput.value = '';
    } catch (error) {
        console.error('Error sending message:', error);
        alert(error.message || 'Failed to send message');
    } finally {
        setUploading(false);
    }
};

// Flag handler for topic messages
const handleFlagTopicMessage = async (message) => {
    const flagData = {
        roomId: selectedRoom.id,
        roomName: selectedRoom.name,
        messageId: message.id,
        messageContent: message.message,
        messageImageUrl: message.imageUrl || null,
        authorId: message.userId,
        authorName: message.userName
    };
    
    const flagged = await flagContent('topic_message', flagData);
    if (flagged) {
        // Optionally remove from local view
        setMessages(prev => prev.filter(m => m.id !== message.id));
    }
};

           // Load meetings
const loadMeetings = async () => {
    try {
        const currentUserId = auth.currentUser?.uid;
        if (!currentUserId) return;

        // Get meetings where this PIR is specifically assigned
        const assignedMeetingsSnap = await db.collection('meetings')
            .where('assignedPIRs', 'array-contains', currentUserId)
            .where('status', '==', 'scheduled')
            .get();
        
        // Get global meetings (for all PIRs)
        const globalMeetingsSnap = await db.collection('meetings')
            .where('isGlobal', '==', true)
            .where('status', '==', 'scheduled')
            .get();
        
        // Combine both results and remove duplicates
        const meetingsMap = new Map();
        
        assignedMeetingsSnap.forEach(doc => {
            meetingsMap.set(doc.id, { id: doc.id, ...doc.data() });
        });
        
        globalMeetingsSnap.forEach(doc => {
            if (!meetingsMap.has(doc.id)) {
                meetingsMap.set(doc.id, { id: doc.id, ...doc.data() });
            }
        });
        
        // Convert to array and sort by scheduled time
        const meetingsData = Array.from(meetingsMap.values()).sort((a, b) => {
            const timeA = a.scheduledTime?.toDate ? a.scheduledTime.toDate() : new Date(a.scheduledTime);
            const timeB = b.scheduledTime?.toDate ? b.scheduledTime.toDate() : new Date(b.scheduledTime);
            return timeA - timeB;
        });
        
        setMeetings(meetingsData);
    } catch (error) {
        console.error('Error loading meetings:', error);
    }
};

            // Load support groups user is assigned to
           const loadSupportGroups = async () => {
    try {
        const groupsSnap = await db.collection('supportGroups')
            .where('active', '==', true)
            .orderBy('day')
            .get();
        
        const groupsData = [];
        groupsSnap.forEach(doc => {
            groupsData.push({ id: doc.id, ...doc.data() });
        });
        setSupportGroups(groupsData);
    } catch (error) {
        console.error('Error loading support groups:', error);
    }
};

            // Load emergency resources
            const loadEmergencyResources = async () => {
                try {
                    const emergencySnap = await db.collection('resources')
                        .where('category', '==', 'emergency')
                        .where('active', '==', true)
                        .get();
                    
                    const emergencyData = [];
                    emergencySnap.forEach(doc => {
                        emergencyData.push({ id: doc.id, ...doc.data() });
                    });
                    setEmergencyResources(emergencyData);
                } catch (error) {
                    console.error('Error loading emergency resources:', error);
                }
            };

           // Load goals with objectives - UPDATED VERSION
const loadGoals = async () => {
    try {
        // Load ALL goals, not just active ones
        const goalsSnap = await db.collection('goals')
            .where('userId', '==', user.uid)
            .orderBy('createdAt', 'desc')
            .get();
        
        const goalsData = [];
        for (const doc of goalsSnap.docs) {
            const goalData = { id: doc.id, ...doc.data() };
            
            // Load assignments for this goal
            const assignmentsSnap = await db.collection('assignments')
                .where('goalId', '==', doc.id)
                .where('userId', '==', user.uid)
                .get();
            
            const assignments = [];
            assignmentsSnap.forEach(aDoc => {
                assignments.push({ id: aDoc.id, ...aDoc.data() });
            });
            
            goalData.assignments = assignments;
            
            // Calculate goal progress
            const completed = assignments.filter(a => a.status === 'completed').length;
            goalData.progress = assignments.length > 0 ? 
                Math.round((completed / assignments.length) * 100) : 0;
            
            goalsData.push(goalData);
        }
        
        setGoals(goalsData);
        
        // Update lifetime stats
        updateLifetimeStats(goalsData);
    } catch (error) {
        console.error('Error loading goals:', error);
    }
};

// Load standalone assignments - UPDATED VERSION
const loadAssignments = async () => {
    try {
        const assignmentsSnap = await db.collection('assignments')
            .where('userId', '==', user.uid)
            .orderBy('createdAt', 'desc')
            .get();
        
        const assignmentsData = [];
        assignmentsSnap.forEach(doc => {
            const assignment = { id: doc.id, ...doc.data() };
            assignmentsData.push(assignment);
        });
        
        setAssignments(assignmentsData);
        
        // Update lifetime completed count
        const completedCount = assignmentsData.filter(a => a.status === 'completed').length;
        updateLifetimeCompletedTasks(completedCount);
        
    } catch (error) {
        console.error('Error loading assignments:', error);
    }
};
  // Calculate today's tasks (morning check-in + evening reflection + assignments)
const loadDailyTasksStatus = async () => {
    try {
        // Get PST midnight boundaries
        const pstNow = new Date(new Date().toLocaleString("en-US", {timeZone: "America/Los_Angeles"}));
        const today = new Date(pstNow);
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        // Check for today's check-ins
        const todayCheckInsSnap = await db.collection('checkIns')
            .where('userId', '==', user.uid)
            .where('createdAt', '>=', today)
            .where('createdAt', '<', tomorrow)
            .get();
        
        let morningDone = false;
        let eveningDone = false;
        
        todayCheckInsSnap.forEach(doc => {
            const data = doc.data();
            if (data.morningData) morningDone = true;
            if (data.eveningData) eveningDone = true;
        });
        
        // Get ALL assignments (not just incomplete) to properly track today's work
        const assignmentsSnap = await db.collection('assignments')
            .where('userId', '==', user.uid)
            .get();
        
        const todayAssignments = [];
        let todayCompletedAssignments = 0;
        
        assignmentsSnap.forEach(doc => {
            const data = doc.data();
            const dueDate = data.dueDate?.toDate ? data.dueDate.toDate() : null;
            const completedAt = data.completedAt?.toDate ? data.completedAt.toDate() : null;
            
            // Check if this assignment is relevant for today
            let isRelevantForToday = false;
            
            if (dueDate) {
                const dueDateString = dueDate.toDateString();
                const todayString = today.toDateString();
                // Include if due today or overdue (and not completed before today)
                if (dueDateString === todayString || (dueDate < today && (!completedAt || completedAt >= today))) {
                    isRelevantForToday = true;
                }
            } else if (!data.dueDate && (!completedAt || completedAt >= today)) {
                // Include assignments without due dates that aren't already completed before today
                isRelevantForToday = true;
            }
            
            if (isRelevantForToday) {
                todayAssignments.push({ id: doc.id, ...data });
                
                // Check if it was completed TODAY
                if (completedAt && completedAt >= today && completedAt < tomorrow) {
                    todayCompletedAssignments++;
                }
            }
        });
        
        // Filter to get only incomplete assignments for display
        const incompleteAssignments = todayAssignments.filter(a => a.status !== 'completed');
        
        // Calculate totals
        const totalDailyTasks = 2; // Morning + Evening
        const completedDailyTasks = (morningDone ? 1 : 0) + (eveningDone ? 1 : 0);
        const totalTasks = totalDailyTasks + incompleteAssignments.length + todayCompletedAssignments;
        const completedTasks = completedDailyTasks + todayCompletedAssignments;
        
        // Update dashboard display
        const tasksStatElement = document.querySelector('.tasks-stat');
        if (tasksStatElement) {
            tasksStatElement.textContent = `${completedTasks}/${totalTasks} Today`;
        }
        
        // Set check-in status for UI
        setCheckInStatus({ morning: morningDone, evening: eveningDone });
        
        return {
            totalTasks,
            completedTasks,
            morningDone,
            eveningDone,
            assignments: incompleteAssignments, // Return only incomplete for display
            completedAssignmentsToday: todayCompletedAssignments
        };
    } catch (error) {
        console.error('Error loading daily tasks:', error);
        return {
            totalTasks: 2,
            completedTasks: 0,
            morningDone: false,
            eveningDone: false,
            assignments: [],
            completedAssignmentsToday: 0
        };
    }
};

// Update lifetime stats with correct active goals calculation
const updateLifetimeStats = (goalsData) => {
    if (!goalsData) return;
    
    const completedGoals = goalsData.filter(g => g.status === 'completed').length;
    const activeGoals = goalsData.filter(g => g.status === 'active').length;
    const totalGoals = goalsData.length;
    
    // Update dashboard elements
    const goalsStatElement = document.querySelector('.goals-stat');
    if (goalsStatElement) {
        if (activeGoals === 0) {
            goalsStatElement.textContent = '0 Active';
        } else {
            goalsStatElement.textContent = `${activeGoals} Active / ${completedGoals} Complete`;
        }
    }
};

// Update lifetime completed tasks count
const updateLifetimeCompletedTasks = (count) => {
    const tasksStatElement = document.querySelector('.lifetime-tasks-stat');
    if (tasksStatElement) {
        tasksStatElement.textContent = count;
    }
};

// Handler for assignment completion - UPDATED with Goal Progress
const handleAssignmentComplete = async (assignmentId, isCompleted) => {
    try {
        // First, get the assignment to check if it has a goalId
        const assignmentDoc = await db.collection('assignments').doc(assignmentId).get();
        const assignment = assignmentDoc.exists ? { id: assignmentDoc.id, ...assignmentDoc.data() } : null;
        
        if (!assignment) {
            throw new Error('Assignment not found');
        }
        
        // Update the assignment
        const updates = {
            status: isCompleted ? 'completed' : 'pending',
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (isCompleted) {
            updates.completedAt = firebase.firestore.FieldValue.serverTimestamp();
        } else {
            updates.completedAt = null;
            updates.reflection = null;
        }
        
        await db.collection('assignments').doc(assignmentId).update(updates);
        
        // Update goal progress if this assignment belongs to a goal
        if (assignment.goalId) {
            await updateGoalProgress(assignment.goalId);
        }
        
        // Reload both assignments and goals to update all progress calculations
        await loadAssignments();
        await loadGoals();
        
        // Update the GoalsTasksView if it exists
        if (window.goalsTasksViewInstance) {
            window.goalsTasksViewInstance.forceUpdate();
        }
        
        // If completed, send notification to coach
        if (isCompleted && userData?.assignedCoach) {
            await db.collection('notifications').add({
                userId: userData.assignedCoach,
                senderId: user.uid,
                senderName: userData.displayName || userData.firstName || 'PIR',
                type: 'assignment_completed',
                title: 'Assignment Completed',
                message: `${userData.displayName || 'PIR'} completed: ${assignment.title}`,
                assignmentId: assignmentId,
                read: false,
                urgent: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        // Show success feedback
        const feedbackMsg = isCompleted ? 'Assignment marked complete!' : 'Assignment marked incomplete';
        showNotification(feedbackMsg, 'success');
        
    } catch (error) {
        console.error('Error updating assignment:', error);
        showNotification('Failed to update assignment', 'error');
    }
};

// Handler for saving reflection with assignment
const handleReflectionSave = async (assignmentId, reflection) => {
    try {
        await db.collection('assignments').doc(assignmentId).update({
            status: 'completed',
            reflection: reflection,
            completedAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Reload both to update progress everywhere
        await loadAssignments();
        await loadGoals();
        
        // Send notification to coach with reflection
        const assignment = assignments.find(a => a.id === assignmentId);
        if (assignment && userData?.assignedCoach) {
            await db.collection('notifications').add({
                userId: userData.assignedCoach,
                senderId: user.uid,
                senderName: userData.displayName || userData.firstName || 'PIR',
                type: 'assignment_reflection',
                title: 'Assignment Completed with Reflection',
                message: `${userData.displayName || 'PIR'} completed with reflection: ${assignment.title}`,
                reflection: reflection,
                assignmentId: assignmentId,
                read: false,
                urgent: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        showNotification('Assignment completed with reflection!', 'success');
    } catch (error) {
        console.error('Error saving reflection:', error);
        showNotification('Failed to save reflection', 'error');
    }
};

// Helper function to show notifications (add if not exists)
const showNotification = (message, type = 'info') => {
    // Create a temporary notification element
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => document.body.removeChild(notification), 300);
    }, 3000);
};
      // Fixed upload handler - saves data URL directly with message
const uploadChatImage = async (file, chatType, roomId) => {
    if (!file) return null;
    
    return new Promise((resolve, reject) => {
        // First compress the image
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                // Create canvas for compression
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Set max dimensions
                const maxWidth = 800;
                const maxHeight = 800;
                let width = img.width;
                let height = img.height;
                
                // Calculate new dimensions
                if (width > height) {
                    if (width > maxWidth) {
                        height = (maxWidth / width) * height;
                        width = maxWidth;
                    }
                } else {
                    if (height > maxHeight) {
                        width = (maxHeight / height) * width;
                        height = maxHeight;
                    }
                }
                
                // Set canvas size and draw compressed image
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                
                // Convert to data URL directly
                const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                
                // Check size
                if (dataUrl.length > 900000) { // ~900KB limit for safety
                    alert('Image too large. Please choose a smaller image.');
                    reject(new Error('Image too large after compression'));
                    return;
                }
                
                // Return the data URL directly - no Firestore save needed here
                resolve(dataUrl);
            };
            img.onerror = () => reject(new Error('Failed to load image'));
            img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
};
// Shared content flagging handler (this one is fine)
const flagContent = async (contentType, contentData) => {
    const reason = prompt('Please describe why you are flagging this content:');
    if (!reason) return false;
    
    try {
        await db.collection('flaggedContent').add({
            contentType: contentType, // 'topic_message' or 'community_message'
            ...contentData,
            flaggedBy: user.uid,
            flaggedByName: userData?.displayName || userData?.firstName || 'PIR',
            reason: reason,
            status: 'pending',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert('Thank you. This content has been flagged for review.');
        return true;
    } catch (error) {
        console.error('Error flagging content:', error);
        alert('Failed to flag content');
        return false;
    }
};

// ALL FUNCTIONS GO HERE BEFORE THE RETURN STATEMENT
const getRecoveryMilestones = (sobrietyDate) => {
    if (!sobrietyDate) return [];
    
    const startDate = new Date(sobrietyDate);
    const milestones = [
        { days: 1, title: '24 Hours Clean', icon: '🌟' },
        { days: 7, title: '1 Week Clean', icon: '📅' },
        { days: 30, title: '1 Month Clean', icon: '🏆' },
        { days: 60, title: '2 Months Clean', icon: '💪' },
        { days: 90, title: '3 Months Clean', icon: '🎯' },
        { days: 100, title: '100 Days Clean', icon: '💯' },
        { days: 120, title: '4 Months Clean', icon: '⭐' },
        { days: 150, title: '5 Months Clean', icon: '🌈' },
        { days: 180, title: '6 Months Clean', icon: '🎉' },
        { days: 200, title: '200 Days Clean', icon: '✨' },
        { days: 210, title: '7 Months Clean', icon: '🌟' },
        { days: 240, title: '8 Months Clean', icon: '🏅' },
        { days: 270, title: '9 Months Clean', icon: '💎' },
        { days: 300, title: '10 Months Clean', icon: '🌺' },
        { days: 330, title: '11 Months Clean', icon: '🎊' },
        { days: 365, title: '1 Year Clean', icon: '🎂' },
        { days: 500, title: '500 Days Clean', icon: '🏆' },
        { days: 548, title: '18 Months Clean', icon: '🌟' },
        { days: 730, title: '2 Years Clean', icon: '🎈' },
        { days: 1000, title: '1000 Days Clean', icon: '🏅' },
        { days: 1095, title: '3 Years Clean', icon: '🎉' },
        { days: 1460, title: '4 Years Clean', icon: '🌟' },
        { days: 1825, title: '5 Years Clean', icon: '💫' }
    ];
    
    // Add more yearly milestones dynamically
    for (let year = 6; year <= 20; year++) {
        milestones.push({
            days: year * 365,
            title: `${year} Years Clean`,
            icon: '🌟'
        });
    }
    
    const today = new Date();
    const daysSober = Math.floor((today - startDate) / (1000 * 60 * 60 * 24)) + 1;
    
    return milestones.map(milestone => {
        const milestoneDate = new Date(startDate);
        milestoneDate.setDate(milestoneDate.getDate() + milestone.days - 1);
        
        return {
            ...milestone,
            date: milestoneDate,
            achieved: daysSober >= milestone.days,
            isToday: daysSober === milestone.days,
            isTomorrow: daysSober === (milestone.days - 1),
            daysUntil: milestone.days - daysSober,
            type: 'recovery' // Mark as recovery milestone
        };
    });
};

// Check for milestone notifications
const checkMilestoneNotifications = async () => {
    if (!userData?.sobrietyDate) return;
    
    const recoveryMilestones = getRecoveryMilestones(userData.sobrietyDate);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    for (const milestone of recoveryMilestones) {
        // Check if notification already sent today
        const existingNotif = await db.collection('notifications')
            .where('recipientId', '==', user.uid)
            .where('type', 'in', ['milestone_today', 'milestone_tomorrow'])
            .where('milestoneTitle', '==', milestone.title)
            .where('createdAt', '>=', today)
            .limit(1)
            .get();
        
        if (!existingNotif.empty) continue;
        
        // Send notification for milestone TODAY
        if (milestone.isToday) {
            // Notify PIR
            await db.collection('notifications').add({
                recipientId: user.uid,
                type: 'milestone_today',
                message: `🎉 Congratulations! You've reached ${milestone.title}!`,
                milestoneTitle: milestone.title,
                icon: milestone.icon,
                read: false,
                urgent: true,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Notify Coach
            if (userData.assignedCoach) {
                await db.collection('notifications').add({
                    recipientId: userData.assignedCoach,
                    senderId: user.uid,
                    senderName: userData.displayName || userData.firstName || 'PIR',
                    type: 'pir_milestone_achieved',
                    message: `${userData.displayName || 'PIR'} reached ${milestone.title}!`,
                    milestoneTitle: milestone.title,
                    icon: milestone.icon,
                    read: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        }
        
        // Send notification for milestone TOMORROW
        if (milestone.isTomorrow) {
            // Notify PIR
            await db.collection('notifications').add({
                recipientId: user.uid,
                type: 'milestone_tomorrow',
                message: `Tomorrow you'll reach ${milestone.title}! Keep going!`,
                milestoneTitle: milestone.title,
                icon: milestone.icon,
                read: false,
                urgent: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Notify Coach
            if (userData.assignedCoach) {
                await db.collection('notifications').add({
                    recipientId: userData.assignedCoach,
                    senderId: user.uid,
                    senderName: userData.displayName || userData.firstName || 'PIR',
                    type: 'pir_milestone_upcoming',
                    message: `${userData.displayName || 'PIR'} will reach ${milestone.title} tomorrow`,
                    milestoneTitle: milestone.title,
                    icon: milestone.icon,
                    read: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        }
    }
};

// Load daily inspiration (rotates by day of year)
const loadDailyInspiration = async () => {
    try {
        const inspirationsSnap = await db.collection('dailyInspirations')
            .where('active', '==', true)
            .get();
        
        if (!inspirationsSnap.empty) {
            const inspirations = [];
            inspirationsSnap.forEach(doc => {
                inspirations.push({ id: doc.id, ...doc.data() });
            });
            
            // Use day of year for consistent daily rotation
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
            const index = dayOfYear % inspirations.length;
            setDailyQuote(inspirations[index]);
        } else {
            setDailyQuote({
                quote: "One day at a time.",
                author: "Recovery Wisdom"
            });
        }
    } catch (error) {
        console.error('Error loading inspiration:', error);
        setDailyQuote({
            quote: "Progress, not perfection.",
            author: "Recovery Wisdom"
        });
    }
};

// Load milestones
const loadMilestones = async () => {
    try {
        const milestonesSnap = await db.collection('milestones')
            .orderBy('daysRequired', 'asc')
            .get();
        
        const milestonesData = [];
        milestonesSnap.forEach(doc => {
            milestonesData.push({ id: doc.id, ...doc.data() });
        });
        setMilestones(milestonesData);
        
        // Calculate next milestone
        if (userData?.sobrietyDate) {
            const daysClean = Math.floor((new Date() - new Date(userData.sobrietyDate)) / (1000 * 60 * 60 * 24));
            const next = milestonesData.find(m => m.daysRequired > daysClean);
            setNextMilestone(next);
        }
    } catch (error) {
        console.error('Error loading milestones:', error);
    }
};

// Load broadcasts
const loadBroadcasts = async () => {
    try {
        const broadcastsSnap = await db.collection('broadcasts')
            .where('active', '==', true)
            .orderBy('createdAt', 'desc')
            .limit(1)
            .get();
        
        if (!broadcastsSnap.empty && !broadcastDismissed) {
            const broadcast = broadcastsSnap.docs[0].data();
            setActiveBroadcast(broadcast);
        }
    } catch (error) {
        console.error('Error loading broadcasts:', error);
    }
};

// Add this to your PIRApp component's loadResources function - REPLACE the existing loadResources function
const loadResources = async () => {
    try {
        // Get ALL resources that are either global OR specifically assigned to this PIR
        const resourcesSnap = await db.collection('resources')
            .where('active', '==', true)
            .get();
        
        const resourcesData = {
            videos: [],
            articles: [], 
            tools: [],
            worksheets: []
        };
        
        resourcesSnap.forEach(doc => {
            const resource = { id: doc.id, ...doc.data() };
            
            // Skip emergency resources - they're handled separately
            if (resource.category === 'emergency') return;
            
            // Check if PIR should see this resource
            const shouldShowResource = 
                resource.isGlobal === true || // Global resource
                (resource.assignedPIRs && resource.assignedPIRs.includes(user.uid)) || // Specifically assigned
                resource.userId === user.uid; // Created for this PIR
            
            if (!shouldShowResource) return;
            
            // Categorize by type
            if (resource.type === 'video') {
                resourcesData.videos.push(resource);
            } else if (resource.type === 'article') {
                resourcesData.articles.push(resource);
            } else if (resource.type === 'tool') {
                resourcesData.tools.push(resource);
            } else if (resource.type === 'worksheet') {
                resourcesData.worksheets.push(resource);
            }
        });
        
        setResources(resourcesData);
    } catch (error) {
        console.error('Error loading resources:', error);
    }
};

// Load check-ins and prepare chart data
const loadCheckIns = async () => {
    try {
        const checkInsSnapshot = await db.collection('checkIns')
            .where('userId', '==', user.uid)
            .orderBy('createdAt', 'desc')
            .limit(7)
            .get();
        
        const checkInsList = [];
        checkInsSnapshot.forEach(doc => {
            checkInsList.push({ id: doc.id, ...doc.data() });
        });
        setCheckIns(checkInsList);
        
        // Check today's status
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        const todayCheckIn = checkInsList.find(checkIn => {
            const checkInDate = checkIn.createdAt?.toDate ? 
                checkIn.createdAt.toDate() : new Date(checkIn.createdAt);
            return checkInDate >= today && checkInDate < tomorrow;
        });
        
        if (todayCheckIn) {
            setCheckInStatus({
                morning: !!todayCheckIn.morningData,
                evening: !!todayCheckIn.eveningData
            });
        }
        
        // Prepare chart data
        prepareChartData(checkInsList);
    } catch (error) {
        console.error('Error loading check-ins:', error);
    }
};

// Prepare 30-day scrollable chart data
const prepareChartData = (checkInsList) => {
    const labels = [];
    const moodData = [];
    const cravingData = [];
    
    // Get last 30 days
    for (let i = 29; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        
        const dateStr = date.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric' 
        });
        labels.push(dateStr);
        
        // Find check-in for this date
        const checkIn = checkInsList.find(c => {
            const checkInDate = c.createdAt?.toDate ? 
                c.createdAt.toDate() : new Date(c.createdAt);
            return checkInDate.toDateString() === date.toDateString();
        });
        
        if (checkIn?.morningData) {
            moodData.push(checkIn.morningData.mood || null);
            cravingData.push(checkIn.morningData.craving || null);
        } else {
            moodData.push(null);
            cravingData.push(null);
        }
    }
    
    setMoodChartData({
        labels: labels,
        datasets: [{
            label: 'Mood',
            data: moodData,
            borderColor: '#4caf50',
            backgroundColor: 'rgba(76, 175, 80, 0.1)',
            tension: 0.4,
            spanGaps: true
        }]
    });
    
    setCravingChartData({
        labels: labels,
        datasets: [{
            label: 'Cravings',
            data: cravingData,
            borderColor: '#ff9800',
            backgroundColor: 'rgba(255, 152, 0, 0.1)',
            tension: 0.4,
            spanGaps: true
        }]
    });
    
    // REMOVED setAnxietyChartData and setSleepChartData - they don't exist
};
    
    // Also set anxiety and sleep data if needed
    setAnxietyChartData({
        labels: labels,
        datasets: [{
            label: 'Anxiety',
            data: anxietyData,
            borderColor: '#f44336',
            backgroundColor: 'rgba(244, 67, 54, 0.1)',
            tension: 0.4,
            spanGaps: true
        }]
    });
    
    setSleepChartData({
        labels: labels,
        datasets: [{
            label: 'Sleep Quality',
            data: sleepData,
            borderColor: '#9c27b0',
            backgroundColor: 'rgba(156, 39, 176, 0.1)',
            tension: 0.4,
            spanGaps: true
        }]
    });
};

// Enhanced chart initialization with scroll capability
useEffect(() => {
    if (currentView === 'progress' && moodChartData && cravingChartData) {
        setTimeout(() => {
            const moodCanvas = document.getElementById('moodChart');
            const cravingCanvas = document.getElementById('cravingChart');
            
            // Destroy existing charts
            if (chartRef.current) {
                chartRef.current.destroy();
            }
            if (cravingChartRef.current) {
                cravingChartRef.current.destroy();
            }
            
            // Chart configuration for 30-day scrollable view
            const chartConfig = {
                type: 'line',
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        tooltip: {
                            enabled: true,
                            callbacks: {
                                label: function(context) {
                                    if (context.parsed.y === null) {
                                        return 'No data';
                                    }
                                    return `${context.dataset.label}: ${context.parsed.y}/10`;
                                }
                            }
                        },
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: true,
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x',
                            },
                            pan: {
                                enabled: true,
                                mode: 'x',
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10,  // Changed from 5 to 10
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Level (0-10)'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            };
            
            if (moodCanvas) {
                const ctx = moodCanvas.getContext('2d');
                chartRef.current = new Chart(ctx, {
                    ...chartConfig,
                    data: moodChartData
                });
            }
            
            if (cravingCanvas) {
                const ctx = cravingCanvas.getContext('2d');
                cravingChartRef.current = new Chart(ctx, {
                    ...chartConfig,
                    data: cravingChartData
                });
            }
        }, 100);
    }
}, [currentView, moodChartData, cravingChartData]);

// Load today's pledge status
const loadTodaysPledge = async () => {
    try {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        const pledgeSnapshot = await db.collection('pledges')
            .where('userId', '==', user.uid)
            .where('createdAt', '>=', today)
            .where('createdAt', '<', tomorrow)
            .get();
        
        setPledgeMade(!pledgeSnapshot.empty);
    } catch (error) {
        console.error('Error loading pledge:', error);
    }
};

// Load check-in streak
const loadStreak = async () => {
    try {
        const streakDoc = await db.collection('streaks').doc(user.uid).get();
        if (streakDoc.exists) {
            setCheckInStreak(streakDoc.data().currentStreak || 0);
        }
    } catch (error) {
        console.error('Error loading streak:', error);
    }
};
        // Calculate total lifetime check-ins
const calculateTotalCheckIns = async () => {
    try {
        const checkInsSnap = await db.collection('checkIns')
            .where('userId', '==', user.uid)
            .get();
        
        let totalCount = 0;
        checkInsSnap.forEach(doc => {
            const data = doc.data();
            if (data.morningData) totalCount++;
            if (data.eveningData) totalCount++;
        });
        
        return totalCount;
    } catch (error) {
        console.error('Error calculating total check-ins:', error);
        return 0;
    }
};

// Load compliance rates
const loadComplianceRates = async () => {
    try {
        // Get user's account creation date (same logic as loadProfileStats)
        const userDoc = await db.collection('users').doc(user.uid).get();
        const accountCreatedDate = userDoc.data()?.createdAt?.toDate() || new Date();

        // Calculate days since account creation (max 30 days for recent performance)
        const today = new Date();
        const daysSinceCreation = Math.floor((today - accountCreatedDate) / (1000 * 60 * 60 * 24));
        const daysToCheck = Math.min(daysSinceCreation, 30); // Cap at 30 days

        // Skip calculation if account is less than 1 day old
        if (daysToCheck < 1) {
            setComplianceRate({
                checkIn: 0,
                assignment: 0
            });
            return;
        }

        // Calculate check-in rate based on days since joining
        const dateToCheckFrom = new Date();
        dateToCheckFrom.setDate(dateToCheckFrom.getDate() - daysToCheck);

        const checkInsSnap = await db.collection('checkIns')
            .where('userId', '==', user.uid)
            .where('createdAt', '>=', dateToCheckFrom)
            .get();

        // COUNT ONLY MORNING CHECK-INS (same as ProfileView)
        let morningCheckInCount = 0;
        checkInsSnap.forEach(doc => {
            const data = doc.data();
            if (data.morningData) {
                morningCheckInCount++;
            }
        });

        // Calculate rate: morning check-ins / days they've been a member (max 30)
        const checkInRate = Math.min(100, Math.round((morningCheckInCount / daysToCheck) * 100));

        // Calculate assignment completion rate (keep existing logic)
        const assignmentsSnap = await db.collection('assignments')
            .where('userId', '==', user.uid)
            .get();

        let totalAssignments = 0;
        let completedAssignments = 0;

        assignmentsSnap.forEach(doc => {
            totalAssignments++;
            if (doc.data().status === 'completed') {
                completedAssignments++;
            }
        });

        const assignmentRate = totalAssignments > 0 ? 
            Math.round((completedAssignments / totalAssignments) * 100) : 0;

        setComplianceRate({
            checkIn: checkInRate,
            assignment: assignmentRate
        });
    } catch (error) {
        console.error('Error loading compliance rates:', error);
    }
};

// Handle daily pledge
const handlePledge = async () => {
    if (pledgeMade) return;
    
    try {
        await db.collection('pledges').add({
            userId: user.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        setPledgeMade(true);
        
        await db.collection('notifications').add({
            userId: user.uid,
            type: 'pledge',
            title: 'Daily Pledge Made',
            message: 'You\'ve committed to your recovery today!',
            read: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Create activity log
        await db.collection('activities').add({
            userId: user.uid,
            type: 'pledge',
            description: 'Made daily pledge',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (error) {
        console.error('Error making pledge:', error);
    }
};

// Handle morning check-in - UPDATED FOR 0-10 SCALE
const handleMorningCheckIn = async (data) => {
    try {
        // Get PST midnight boundaries
        const pstNow = new Date(new Date().toLocaleString("en-US", {timeZone: "America/Los_Angeles"}));
        const today = new Date(pstNow);
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        // Check if check-in already exists for today
        const existingCheckIn = await db.collection('checkIns')
            .where('userId', '==', user.uid)
            .where('createdAt', '>=', today)
            .where('createdAt', '<', tomorrow)
            .get();
        
        if (existingCheckIn.empty) {
            // Create new check-in
            await db.collection('checkIns').add({
                userId: user.uid,
                morningData: data,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        } else {
            // Update existing check-in
            await db.collection('checkIns').doc(existingCheckIn.docs[0].id).update({
                morningData: data,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        setCheckInStatus(prev => ({ ...prev, morning: true }));
        
        // Update streak
        await updateStreak();
        
        // Check for auto-triggered alerts with NEW THRESHOLDS (0-10 scale)
        if (data.mood <= 3) {  // Changed from <= 2 (on 1-5 scale)
            await db.collection('alerts').add({
                userId: user.uid,
                type: 'low_mood',
                status: 'active',
                severity: 'high',
                message: `Low mood detected (${data.mood}/10)`,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        if (data.craving >= 7) {  // Changed from >= 4 (on 1-5 scale)
            await db.collection('alerts').add({
                userId: user.uid,
                type: 'high_craving',
                status: 'active',
                severity: 'high',
                message: `High craving intensity detected (${data.craving}/10)`,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        // Create activity log
        await db.collection('activities').add({
            userId: user.uid,
            type: 'check_in',
            description: 'Completed morning check-in',
            data: data,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Create notification for coach
        if (userData?.assignedCoach) {
            await db.collection('notifications').add({
                userId: userData.assignedCoach,
                type: 'check_in',
                title: 'Morning Check-in Completed',
                message: `${userData.displayName || user.email} completed morning check-in`,
                pirId: user.uid,
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        await loadCheckIns();
        await loadDailyTasksStatus(); // Update today's tasks
        alert('Morning check-in complete!');
    } catch (error) {
        console.error('Error with morning check-in:', error);
        alert('Failed to save check-in');
    }
};

// Handle evening reflection - SAVES REAL DATA
const handleEveningReflection = async (data) => {
    try {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        const existingCheckIn = await db.collection('checkIns')
            .where('userId', '==', user.uid)
            .where('createdAt', '>=', today)
            .where('createdAt', '<', tomorrow)
            .get();
        
        if (existingCheckIn.empty) {
            await db.collection('checkIns').add({
                userId: user.uid,
                eveningData: data,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        } else {
            await db.collection('checkIns').doc(existingCheckIn.docs[0].id).update({
                eveningData: data,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        setCheckInStatus(prev => ({ ...prev, evening: true }));
        
        // Create activity log
        await db.collection('activities').add({
            userId: user.uid,
            type: 'reflection',
            description: 'Completed evening reflection',
            data: data,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        await loadCheckIns();
        await loadDailyTasksStatus();
        alert('Evening reflection complete!');
    } catch (error) {
        console.error('Error with evening reflection:', error);
        alert('Failed to save reflection');
    }
};

// Update check-in streak
const updateStreak = async () => {
    try {
        const streakDoc = await db.collection('streaks').doc(user.uid).get();
        
        if (streakDoc.exists) {
            const data = streakDoc.data();
            const lastCheckIn = data.lastCheckIn?.toDate ? 
                data.lastCheckIn.toDate() : new Date(data.lastCheckIn);
            const today = new Date();
            const daysDiff = Math.floor((today - lastCheckIn) / (1000 * 60 * 60 * 24));
            
            if (daysDiff === 1) {
                // Continue streak
                await db.collection('streaks').doc(user.uid).update({
                    currentStreak: data.currentStreak + 1,
                    lastCheckIn: firebase.firestore.FieldValue.serverTimestamp()
                });
                setCheckInStreak(data.currentStreak + 1);
            } else if (daysDiff > 1) {
                // Reset streak
                await db.collection('streaks').doc(user.uid).update({
                    currentStreak: 1,
                    lastCheckIn: firebase.firestore.FieldValue.serverTimestamp()
                });
                setCheckInStreak(1);
            }
        } else {
            // Create new streak
            await db.collection('streaks').doc(user.uid).set({
                currentStreak: 1,
                lastCheckIn: firebase.firestore.FieldValue.serverTimestamp()
            });
            setCheckInStreak(1);
        }
    } catch (error) {
        console.error('Error updating streak:', error);
    }
};

// Complete assignment WITH REFLECTION
const completeAssignment = async (assignmentId, goalId, reflection) => {
    try {
        await db.collection('assignments').doc(assignmentId).update({
            status: 'completed',
            completedAt: firebase.firestore.FieldValue.serverTimestamp(),
            reflection: reflection || ''
        });
        
        // Create activity log
        await db.collection('activities').add({
            userId: user.uid,
            type: 'assignment_completion',
            description: 'Completed assignment',
            assignmentId: assignmentId,
            reflection: reflection,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Create notification
        await db.collection('notifications').add({
            userId: user.uid,
            type: 'assignment',
            title: 'Assignment Completed',
            message: 'Great job completing your assignment!',
            read: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        if (goalId) {
            await updateGoalProgress(goalId);
        }
        
        await loadAssignments();
        await loadGoals();
        await loadComplianceRates();
    } catch (error) {
        console.error('Error completing assignment:', error);
    }
};

// Update goal progress - IMPROVED VERSION
const updateGoalProgress = async (goalId) => {
    try {
        // Get ALL assignments for this goal (not filtered by status)
        const assignmentsSnap = await db.collection('assignments')
            .where('goalId', '==', goalId)
            .where('userId', '==', user.uid)
            .get();
        
        let total = 0;
        let completed = 0;
        
        assignmentsSnap.forEach(doc => {
            total++;
            if (doc.data().status === 'completed') {
                completed++;
            }
        });
        
        const progress = total > 0 ? Math.round((completed / total) * 100) : 0;
        
        // Update the goal document
        await db.collection('goals').doc(goalId).update({
            progress: progress,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Also check if goal should be marked complete (100% progress)
        if (progress === 100) {
            const goalDoc = await db.collection('goals').doc(goalId).get();
            if (goalDoc.exists && goalDoc.data().status !== 'completed') {
                await db.collection('goals').doc(goalId).update({
                    status: 'completed',
                    completedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Send notification to PIR about goal completion
                await db.collection('notifications').add({
                    userId: user.uid,
                    type: 'goal_completed',
                    title: 'Goal Completed!',
                    message: `Congratulations! You've completed the goal: ${goalDoc.data().title}`,
                    goalId: goalId,
                    read: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        }
        
        // Trigger a refresh of the goals view if it exists
        if (window.goalsTasksViewInstance) {
            window.goalsTasksViewInstance.forceUpdate();
        }
        
    } catch (error) {
        console.error('Error updating goal progress:', error);
    }
};

// Update the send message function for GLRS Community - SAVES TO MESSAGES
const sendCommunityMessage = async (message, imageUrl) => {
    try {
        const messageData = {
            roomId: 'main',  // Required for messages collection
            senderId: user.uid,
            senderName: userData?.displayName || userData?.firstName || 'Anonymous',
            content: message,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()  // Changed from timestamp
        };
        
        // Add image URL if provided
        if (imageUrl) {
            messageData.imageUrl = imageUrl;
        }
        
        await db.collection('messages').add(messageData);  // Changed from glrsChat
    } catch (error) {
        console.error('Error sending community message:', error);
        throw error;
    }
};

const sendTopicRoomMessage = async (roomId, content, imageFile = null) => {
    // Allow sending with just an image or just text
    if (!content && !imageFile) return;
    
    try {
        const messageData = {
            roomId: roomId,
            userId: user.uid,
            senderId: user.uid,
            senderName: userData?.displayName || userData?.firstName || 'Anonymous',
            message: content || '',  // Allow empty message if there's an image
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Handle image upload if provided
        if (imageFile && imageFile instanceof File) {
            try {
                // Create canvas for resizing
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                // Read and process the file
                const reader = new FileReader();
                
                const base64 = await new Promise((resolve, reject) => {
                    reader.onload = (e) => {
                        img.onload = () => {
                            // Resize to max 500x500 pixels for chat
                            const MAX_SIZE = 500;
                            let width = img.width;
                            let height = img.height;
                            
                            if (width > height) {
                                if (width > MAX_SIZE) {
                                    height = Math.round((height * MAX_SIZE) / width);
                                    width = MAX_SIZE;
                                }
                            } else {
                                if (height > MAX_SIZE) {
                                    width = Math.round((width * MAX_SIZE) / height);
                                    height = MAX_SIZE;
                                }
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // Convert to base64 with compression
                            const resizedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                            resolve(resizedBase64);
                        };
                        
                        img.onerror = () => reject(new Error('Failed to load image'));
                        img.src = e.target.result;
                    };
                    
                    reader.onerror = () => reject(new Error('Failed to read file'));
                    reader.readAsDataURL(imageFile);
                });
                
                messageData.imageUrl = base64;
            } catch (imgError) {
                console.error('Error processing image:', imgError);
                showNotification('Failed to process image, sending message only', 'warning');
            }
        }

        // Add message to Firestore
        await db.collection('messages').add(messageData);
        
        // Reload messages after sending
        const messagesSnap = await db.collection('messages')
            .where('roomId', '==', roomId)
            .orderBy('createdAt', 'desc')
            .limit(50)
            .get();
        
        const messages = [];
        messagesSnap.forEach(doc => {
            messages.push({ id: doc.id, ...doc.data() });
        });
        setTopicRoomMessages(messages.reverse());
        
    } catch (error) {
        console.error('Error sending message:', error);
        showNotification('Failed to send message', 'error');
    }
};

// Enter topic room
const enterTopicRoom = async (room) => {
    setActiveTopicRoom(room);
    
    // Load room messages
    try {
        const messagesSnap = await db.collection('messages')
            .where('roomId', '==', room.id)
            .orderBy('createdAt', 'desc')
            .limit(50)
            .get();
        
        const messages = [];
        messagesSnap.forEach(doc => {
            messages.push({ id: doc.id, ...doc.data() });
        });
        setTopicRoomMessages(messages.reverse());
    } catch (error) {
        console.error('Error loading room messages:', error);
    }
    
    setShowModal('topicRoom');
};

// Handle SOS trigger
const triggerSOS = async () => {
    if (confirm('This will send an emergency alert to your coach. Continue?')) {
        try {
            await db.collection('alerts').add({
                userId: user.uid,
                type: 'sos',
                status: 'active',
                severity: 'critical',
                message: 'Emergency SOS triggered',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Create notification for coach
            if (userData?.assignedCoach) {
                await db.collection('notifications').add({
                    userId: userData.assignedCoach,
                    type: 'emergency',
                    title: '🚨 EMERGENCY SOS',
                    message: `${userData.displayName || user.email} has triggered an emergency alert!`,
                    pirId: user.uid,
                    severity: 'critical',
                    read: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            alert('Emergency alert sent. Your coach has been notified.');
        } catch (error) {
            console.error('Error triggering SOS:', error);
            alert('Failed to send alert. Please call 988 for immediate help.');
        }
    }
};

// Alternative Profile Image Upload - Resize and store in Firestore
const handleProfileImageUpload = async (file) => {
    try {
        // Check file size (limit to 5MB for upload)
        if (file.size > 5 * 1024 * 1024) {
            showNotification('Image size must be less than 5MB', 'error');
            return;
        }
        
        // Show loading
        showNotification('Processing image...', 'info');
        
        // Create canvas for resizing
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        // Read and process the file
        const reader = new FileReader();
        
        reader.onload = async (e) => {
            img.onload = async () => {
                try {
                    // Resize to max 300x300 pixels (slightly larger for better quality)
                    const MAX_SIZE = 300;
                    let width = img.width;
                    let height = img.height;
                    
                    // Calculate new dimensions maintaining aspect ratio
                    if (width > height) {
                        if (width > MAX_SIZE) {
                            height = Math.round((height * MAX_SIZE) / width);
                            width = MAX_SIZE;
                        }
                    } else {
                        if (height > MAX_SIZE) {
                            width = Math.round((width * MAX_SIZE) / height);
                            height = MAX_SIZE;
                        }
                    }
                    
                    // Set canvas size
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw and compress image
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Convert to base64 with compression
                    let resizedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                    
                    // Check final size (should be under 500KB)
                    const base64Size = resizedBase64.length * 0.75; // Approximate size in bytes
                    if (base64Size > 500 * 1024) {
                        // Try with more compression
                        const moreCompressed = canvas.toDataURL('image/jpeg', 0.5);
                        if (moreCompressed.length * 0.75 > 500 * 1024) {
                            showNotification('Image is too large even after compression. Please choose a smaller image.', 'error');
                            return;
                        }
                        resizedBase64 = moreCompressed;
                    }
                    
                    // Store directly in Firestore
                    await db.collection('users').doc(user.uid).update({
                        profileImageUrl: resizedBase64,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Update local state
                    if (typeof setProfileImage === 'function') {
                        setProfileImage(resizedBase64);
                    }
                    
                    if (typeof setUserData === 'function') {
                        setUserData(prevData => ({
                            ...prevData,
                            profileImageUrl: resizedBase64
                        }));
                    }
                    
                    // Update the displayed image immediately
                    const profileImgElements = document.querySelectorAll('.profile-image, #profileImage, .user-avatar');
                    profileImgElements.forEach(elem => {
                        if (elem.tagName === 'IMG') {
                            elem.src = resizedBase64;
                        } else {
                            elem.style.backgroundImage = `url(${resizedBase64})`;
                        }
                    });
                    
                    showNotification('Profile image updated successfully!', 'success');
                    
                } catch (error) {
                    console.error('Error processing image:', error);
                    showNotification('Failed to process image', 'error');
                }
            };
            
            img.onerror = () => {
                showNotification('Failed to load image', 'error');
            };
            
            img.src = e.target.result;
        };
        
        reader.onerror = () => {
            showNotification('Failed to read file', 'error');
        };
        
        reader.readAsDataURL(file);
        
    } catch (error) {
        console.error('Error uploading image:', error);
        showNotification('Failed to upload image', 'error');
    }
};

// Update the handleImageSelect function to use the new handler
const handleImageSelect = (e) => {
    const file = e.target.files[0];
    if (file) {
        // Check file type
        if (!file.type.startsWith('image/')) {
            showNotification('Please select an image file', 'error');
            return;
        }
        
        // Use the new upload handler
        handleProfileImageUpload(file);
    }
};

// Export data as JSON
const exportDataAsJSON = () => {
    const exportData = {
        userData: userData,
        checkIns: checkIns,
        goals: goals,
        assignments: assignments,
        sobrietyDays: sobrietyDays,
        streak: checkInStreak,
        complianceRates: complianceRate,
        exportedAt: new Date().toISOString()
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', `recovery_data_${new Date().toISOString().split('T')[0]}.json`);
    linkElement.click();
};

// Export data as PDF with comprehensive data
const exportDataAsPDF = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(20);
    doc.text('Recovery Progress Report', 20, 20);
    
    doc.setFontSize(12);
    doc.text(`Name: ${userData?.displayName || userData?.firstName || user.email}`, 20, 40);
    doc.text(`Days Clean: ${sobrietyDays}`, 20, 50);
    doc.text(`Money Saved: $${moneySaved.toLocaleString()}`, 20, 60);
    doc.text(`Check-in Streak: ${checkInStreak} days`, 20, 70);
    doc.text(`Check-in Compliance: ${complianceRate.checkIn}%`, 20, 80);
    doc.text(`Assignment Completion: ${complianceRate.assignment}%`, 20, 90);
    doc.text(`Export Date: ${new Date().toLocaleDateString()}`, 20, 100);
    
    // Add recent check-ins
    if (checkIns.length > 0) {
        doc.text('Recent Check-ins:', 20, 120);
        checkIns.slice(0, 5).forEach((checkIn, index) => {
            const date = checkIn.createdAt?.toDate ? 
                checkIn.createdAt.toDate().toLocaleDateString() : 'Unknown';
            const mood = checkIn.morningData?.mood || 'N/A';
            const craving = checkIn.morningData?.craving || 'N/A';
            doc.text(`${date} - Mood: ${mood}/5, Craving: ${craving}/5`, 30, 130 + (index * 10));
        });
    }
    
    // Add goals summary
    if (goals.length > 0) {
        doc.addPage();
        doc.text('Active Goals:', 20, 20);
        goals.forEach((goal, index) => {
            doc.text(`${goal.title} - ${goal.progress}% complete`, 30, 30 + (index * 10));
        });
    }
    
    doc.save(`recovery_report_${new Date().toISOString().split('T')[0]}.pdf`);
};

// Handle logout
const handleLogout = async () => {
    if (confirm('Are you sure you want to sign out?')) {
        await auth.signOut();
    }
};

// Mark notification as read
const markNotificationAsRead = async (notificationId) => {
    try {
        await db.collection('notifications').doc(notificationId).update({
            read: true,
            readAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (error) {
        console.error('Error marking notification as read:', error);
    }
};

// Mark all notifications as read
const markAllNotificationsAsRead = async () => {
    try {
        const batch = db.batch();
        
        notifications.forEach(notification => {
            if (!notification.read) {
                const notificationRef = db.collection('notifications').doc(notification.id);
                batch.update(notificationRef, {
                    read: true,
                    readAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        });
        
        await batch.commit();
    } catch (error) {
        console.error('Error marking all as read:', error);
    }
};

// Dismiss broadcast
const dismissBroadcast = () => {
    setBroadcastDismissed(true);
    setActiveBroadcast(null);
};

if (loading) {
    return (
        <div className="loading-container">
            <div className="loading-spinner"></div>
        </div>
    );
}

return (
    <div className="app-container">
        <div className="header">
            <div className="header-title">
                <LighthouseLogo size={30} />
                <span>GLRS Recovery</span>
            </div>
            <div 
                className="notification-badge"
                onClick={() => setShowModal('notifications')}
            >
                <span style={{fontSize: '24px'}}>🔔</span>
                {unreadCount > 0 && (
                    <span className="badge-count">{unreadCount}</span>
                )}
            </div>
        </div>
        
        <div className="content">
            {currentView === 'home' && (
                <>
                    {activeBroadcast && !broadcastDismissed && (
                        <div className="broadcast-banner">
                            <div className="broadcast-content">
                                <div style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                                    <span style={{fontSize: '20px'}}>📢</span>
                                    <div>
                                        <div style={{fontWeight: 'bold', color: '#f4c430'}}>Announcement</div>
                                        <div style={{color: 'white', marginTop: '5px'}}>{activeBroadcast.message}</div>
                                    </div>
                                </div>
                            </div>
                            <button className="broadcast-dismiss" onClick={dismissBroadcast}>×</button>
                        </div>
                    )}

                    {coachInfo && (
                        <div className="coach-info-card">
                            <h3 style={{color: '#4CAF50', marginBottom: '10px'}}>Your Recovery Coach</h3>
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                <div>
                                    <div style={{fontSize: '18px', fontWeight: 'bold', color: 'white'}}>
                                        {coachInfo.displayName || coachInfo.firstName + ' ' + coachInfo.lastName}
                                    </div>
                                    {coachInfo.credentials && (
                                        <div style={{fontSize: '14px', opacity: 0.8, marginTop: '5px'}}>
                                            {coachInfo.credentials}
                                        </div>
                                    )}
                                </div>
                                {coachInfo.phone && (
                                    <a href={`tel:${coachInfo.phone}`} style={{
                                        background: 'rgba(255, 255, 255, 0.1)',
                                        padding: '8px 15px',
                                        borderRadius: '20px',
                                        color: 'white',
                                        textDecoration: 'none',
                                        fontSize: '14px'
                                    }}>
                                        📞 Contact
                                    </a>
                                )}
                            </div>
                        </div>
                    )}

                    <div className="hero-background">
                        <div className="day-counter-container">
                            <div className="large-number">{sobrietyDays}</div>
                            <div className="large-text">Days Strong</div>
                            <div className="motivational-quote">
                                {dailyQuote?.quote || "One day at a time."}
                            </div>
                            {dailyQuote?.author && (
                                <div style={{fontSize: '12px', opacity: 0.7, marginTop: '5px'}}>
                                    — {dailyQuote.author}
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {nextMilestone && (
                        <div className="milestone-preview">
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                <div>
                                    <div style={{fontSize: '18px', color: 'white', fontWeight: 'bold'}}>
                                        {nextMilestone.icon || '🎯'} Next: {nextMilestone.title}
                                    </div>
                                    <div style={{color: 'rgba(255,255,255,0.7)', marginTop: '5px', fontSize: '14px'}}>
                                        {nextMilestone.description}
                                    </div>
                                </div>
                                <div style={{textAlign: 'center'}}>
                                    <div style={{fontSize: '24px', fontWeight: 'bold', color: '#4CAF50'}}>
                                        {nextMilestone.daysRequired - sobrietyDays}
                                    </div>
                                    <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.7)'}}>
                                        days to go
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    <div className="mood-tracker">
                        <div style={{color: 'white', marginBottom: '15px'}}>
                            How are you feeling today?
                        </div>
                        <div className="mood-options">
                            {['😊', '😐', '😔', '😰', '😡'].map(mood => (
                                <div
                                    key={mood}
                                    className={`mood-emoji ${selectedMood === mood ? 'selected' : ''}`}
                                    onClick={() => setSelectedMood(mood)}
                                >
                                    {mood}
                                </div>
                            ))}
                        </div>
                    </div>
                    
                    <div className="daily-pledge">
                        <div className="pledge-text">"I commit to my recovery today"</div>
                        <button 
                            className={`btn-primary ${pledgeMade ? 'completed' : ''}`}
                            onClick={handlePledge}
                            disabled={pledgeMade}
                            style={{cursor: pledgeMade ? 'not-allowed' : 'pointer'}}
                        >
                            {pledgeMade ? '✓ Pledge Made' : 'Make Today\'s Pledge'}
                        </button>
                    </div>
                    
                    <button 
                        onClick={() => setCurrentView('resources')}
                        style={{
                            width: '100%',
                            padding: '15px',
                            background: 'linear-gradient(135deg, #9c27b0 0%, #673ab7 100%)',
                            border: 'none',
                            borderRadius: '15px',
                            color: 'white',
                            fontSize: '16px',
                            fontWeight: 'bold',
                            cursor: 'pointer',
                            marginBottom: '20px',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            gap: '10px'
                        }}
                    >
                        <span style={{fontSize: '20px'}}>📚</span>
                        Recovery Resources
                        <span style={{
                            background: 'rgba(255,255,255,0.2)',
                            padding: '2px 8px',
                            borderRadius: '10px',
                            fontSize: '12px'
                        }}>
                            {userData?.newResourcesCount || 0} New
                        </span>
                    </button>
                    
                    <div className="stats-grid">
                        <div className="stat-card">
                            <div className="stat-icon">💰</div>
                            <div className="stat-value">${moneySaved.toLocaleString()}</div>
                            <div className="stat-label">Money Saved</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-icon">📅</div>
                            <div className="stat-value">{sobrietyDays}</div>
                            <div className="stat-label">Total Days</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-icon">🔥</div>
                            <div className="stat-value">{checkInStreak}</div>
                            <div className="stat-label">Day Streak</div>
                        </div>
                        <div className="stat-card">
    <div className="stat-icon">📅</div>
    <div className="stat-value">{Math.floor(sobrietyDays / 7)}</div>
    <div className="stat-label">Weeks Clean</div>
</div>
                        <div className="stat-card">
    <div className="stat-icon">✅</div>
    <div className="stat-value">{totalCheckIns}</div>
    <div className="stat-label">Total Check-ins</div>
</div>
                        <div className="stat-card">
                            <div className="stat-icon">📊</div>
                            <div className="stat-value">{complianceRate.checkIn}%</div>
                            <div className="stat-label">Check-in Rate</div>
                        </div>
                    </div>
                </>
            )}
            
            {currentView === 'tasks' && (
                <div className="section-content">
                    <h2 style={{color: 'white', marginBottom: '20px'}}>The Golden Thread</h2>
                    
                    <div className="daily-tasks-card">
                        <h3 style={{color: '#4CAF50', marginBottom: '15px'}}>📅 Daily Tasks</h3>
                        <div className="task-list">
                            <div 
                                className="task-item"
                                onClick={() => setShowModal('checkIn')}
                            >
                                <span>☀️ Morning Check-in</span>
                                <span className={checkInStatus.morning ? 'completed' : 'pending'}>
                                    {checkInStatus.morning ? '✓' : 'Pending'}
                                </span>
                            </div>
                            <div 
                                className="task-item"
                                onClick={() => setShowModal('reflection')}
                            >
                                <span>🌙 Evening Reflection</span>
                                <span className={checkInStatus.evening ? 'completed' : 'pending'}>
                                    {checkInStatus.evening ? '✓' : 'Pending'}
                                </span>
                            </div>
                        </div>
                    </div>

                    
                    <GoalsTasksView 
                        user={user}
                        goals={goals}
                        assignments={assignments}
                        onAssignmentComplete={handleAssignmentComplete}
                        onReflectionSave={handleReflectionSave}
                    />
                </div>
            )}

            {currentView === 'progress' && (
                <div className="section-content">
                    <h2 style={{color: 'white', marginBottom: '20px'}}>My Progress</h2>
                    
                    <div className="compliance-card">
                        <h3 style={{color: '#9c27b0', marginBottom: '15px'}}>Compliance Metrics</h3>
                        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px'}}>
                            <div>
                                <div style={{fontSize: '14px', opacity: 0.8}}>Check-in Compliance</div>
                                <div style={{fontSize: '24px', fontWeight: 'bold', color: '#f4c430'}}>
                                    {complianceRate.checkIn}%
                                </div>
                                <small style={{opacity: 0.6}}>Last 30 days</small>
                            </div>
                            <div>
                                <div style={{fontSize: '14px', opacity: 0.8}}>Assignment Completion</div>
                                <div style={{fontSize: '24px', fontWeight: 'bold', color: '#4CAF50'}}>
                                    {complianceRate.assignment}%
                                </div>
                                <small style={{opacity: 0.6}}>All time</small>
                            </div>
                        </div>
                    </div>
                    
                    <div style={{background: 'rgba(0, 0, 0, 0.3)', backdropFilter: 'blur(10px)', borderRadius: '15px', padding: '20px', marginBottom: '20px', border: '1px solid rgba(255, 255, 255, 0.1)'}}>
    <h3 style={{marginBottom: '20px', color: 'white'}}>30-Day Mood Trend</h3>
                        <div style={{height: '250px', overflowX: 'auto', overflowY: 'hidden', position: 'relative'}}>
                            <div style={{minWidth: '800px', height: '100%'}}>
                                <canvas id="moodChart"></canvas>
                            </div>
                        </div>
                        <div style={{display: 'flex', justifyContent: 'center', marginTop: '10px', fontSize: '12px', color: '#666'}}>
                            <span>← Scroll to view more days →</span>
                        </div>
                    </div>
                    
                    <div style={{background: 'white', borderRadius: '15px', padding: '20px'}}>
                        <h3 style={{marginBottom: '20px'}}>30-Day Craving Trend</h3>
                        <div style={{height: '250px', overflowX: 'auto', overflowY: 'hidden', position: 'relative'}}>
                            <div style={{minWidth: '800px', height: '100%'}}>
                                <canvas id="cravingChart"></canvas>
                            </div>
                        </div>
                        <div style={{display: 'flex', justifyContent: 'center', marginTop: '10px', fontSize: '12px', color: '#666'}}>
                            <span>← Scroll to view more days →</span>
                        </div>
                    </div>

                    <div style={{marginBottom: '20px'}}>
                        <div style={{
                            background: 'rgba(76, 175, 80, 0.1)',
                            borderRadius: '15px',
                            padding: '15px',
                            marginBottom: '15px'
                        }}>
                            <h3 style={{color: '#4CAF50', marginBottom: '10px'}}>
                                🏆 Recovery Milestones
                            </h3>
                            {userData?.sobrietyDate ? (
                                <>
                                    {(() => {
                                        const recoveryMilestones = getRecoveryMilestones(userData.sobrietyDate);
                                        const achieved = recoveryMilestones.filter(m => m.achieved);
                                        const upcoming = recoveryMilestones.find(m => !m.achieved);
                                        
                                        return (
                                            <>
                                                {achieved.length > 0 && (
                                                    <div style={{marginBottom: '10px'}}>
                                                        <small style={{color: 'rgba(255,255,255,0.6)'}}>
                                                            Latest Achievement:
                                                        </small>
                                                        <div style={{
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            gap: '10px',
                                                            marginTop: '5px'
                                                        }}>
                                                            <span style={{fontSize: '24px'}}>
                                                                {achieved[achieved.length - 1].icon}
                                                            </span>
                                                            <span style={{color: 'white'}}>
                                                                {achieved[achieved.length - 1].title}
                                                            </span>
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                {upcoming && (
                                                    <div>
                                                        <small style={{color: 'rgba(255,255,255,0.6)'}}>
                                                            Next Milestone:
                                                        </small>
                                                        <div style={{
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            justifyContent: 'space-between',
                                                            marginTop: '5px'
                                                        }}>
                                                            <div style={{
                                                                display: 'flex',
                                                                alignItems: 'center',
                                                                gap: '10px'
                                                            }}>
                                                                <span style={{fontSize: '24px'}}>
                                                                    {upcoming.icon}
                                                                </span>
                                                                <span style={{color: 'white'}}>
                                                                    {upcoming.title}
                                                                </span>
                                                            </div>
                                                            <span style={{
                                                                color: upcoming.daysUntil <= 1 ? '#ffd700' : 'rgba(255,255,255,0.6)',
                                                                fontSize: '14px'
                                                            }}>
                                                                {upcoming.daysUntil === 0 ? 'Today!' :
                                                                 upcoming.daysUntil === 1 ? 'Tomorrow!' :
                                                                 `${upcoming.daysUntil} days`}
                                                            </span>
                                                        </div>
                                                    </div>
                                                )}
                                            </>
                                        );
                                    })()}
                                </>
                            ) : (
                                <p style={{color: 'rgba(255,255,255,0.6)', fontSize: '14px'}}>
                                    Set your sobriety date to track milestones
                                </p>
                            )}
                        </div>
                        
                        {milestones && milestones.length > 0 && (
                            <div style={{
                                background: 'rgba(156, 39, 176, 0.1)',
                                borderRadius: '15px',
                                padding: '15px'
                            }}>
                                <h3 style={{color: '#9c27b0', marginBottom: '10px'}}>
                                    ⭐ Personal Milestones
                                </h3>
                                {milestones.slice(0, 3).map(milestone => (
                                    <div key={milestone.id} style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'space-between',
                                        padding: '8px 0',
                                        borderBottom: '1px solid rgba(255,255,255,0.1)'
                                    }}>
                                        <div style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '10px'
                                        }}>
                                            <span>{milestone.icon || '🎯'}</span>
                                            <span style={{color: 'white', fontSize: '14px'}}>
                                                {milestone.title}
                                            </span>
                                        </div>
                                        {milestone.targetDate && (
                                            <span style={{
                                                color: 'rgba(255,255,255,0.6)',
                                                fontSize: '12px'
                                            }}>
                                                {new Date(milestone.targetDate.toDate()).toLocaleDateString()}
                                            </span>
                                        )}
                                    </div>
                                ))}
                                {milestones.length > 3 && (
                                    <button 
                                        onClick={() => setCurrentView('milestones')}
                                        style={{
                                            marginTop: '10px',
                                            background: 'transparent',
                                            border: 'none',
                                            color: '#9c27b0',
                                            cursor: 'pointer',
                                            fontSize: '14px'
                                        }}
                                    >
                                        View all {milestones.length} personal milestones →
                                    </button>
                                )}
                            </div>
                        )}
                    </div>
                    
                    <div style={{marginTop: '30px'}}>
                        <h3 style={{color: '#f4c430', marginBottom: '15px'}}>Export Your Data</h3>
                        <button 
                            className="btn-primary" 
                            onClick={exportDataAsJSON} 
                            style={{marginBottom: '10px', display: 'block'}}
                        >
                            📥 Export as JSON
                        </button>
                        <button 
                            className="btn-primary" 
                            onClick={exportDataAsPDF}
                            style={{display: 'block'}}
                        >
                            📄 Export as PDF
                        </button>
                    </div>
                </div>
            )}
            
            {currentView === 'connect' && (
                <div className="section-content">
                    <h2 style={{color: 'white', marginBottom: '20px'}}>Community Connect</h2>
                    
                    <div className="chat-tabs">
                        <button 
                            className={`tab-btn ${activeChat === 'main' ? 'active' : ''}`}
                            onClick={() => setActiveChat('main')}
                        >
                            GLRS Community
                        </button>
                        <button 
                            className={`tab-btn ${activeChat === 'rooms' ? 'active' : ''}`}
                            onClick={() => setActiveChat('rooms')}
                        >
                            Topic Rooms
                        </button>
                        <button 
                            className={`tab-btn ${activeChat === 'groups' ? 'active' : ''}`}
                            onClick={() => setActiveChat('groups')}
                        >
                            Support Groups
                        </button>
                        <button 
                            className={`tab-btn ${activeChat === 'meetings' ? 'active' : ''}`}
                            onClick={() => setActiveChat('meetings')}
                        >
                            Meetings
                        </button>
                    </div>

                    {activeChat === 'main' && (
                        <CommunityChat 
                            messages={communityMessages}
                            onSendMessage={sendCommunityMessage}
                            currentUserId={user.uid}
                            uploadChatImage={uploadChatImage}  
                            flagContent={flagContent} 
                            setModalImage={setModalImage}
                        />
                    )}

                    {activeChat === 'rooms' && (
                        <>
                            <h3 style={{color: '#f4c430', marginBottom: '20px'}}>Recovery Topic Rooms</h3>
                            {topicRooms.length > 0 ? (
                                topicRooms.map(room => (
                                    <div 
                                        key={room.id} 
                                        className="room-card"
                                        onClick={() => enterTopicRoom(room)}
                                    >
                                        <div className="room-icon">{room.icon || '💬'}</div>
                                        <h4>{room.name}</h4>
                                        <p style={{color: 'rgba(255,255,255,0.7)'}}>{room.description}</p>
                                    </div>
                                ))
                            ) : (
                                <div className="empty-state">
                                    <div className="empty-state-icon">💬</div>
                                    <div className="empty-state-text">No topic rooms available yet.</div>
                                </div>
                            )}
                        </>
                    )}

                    {activeChat === 'groups' && (
                        <>
                            <h3 style={{color: '#f4c430', marginBottom: '20px'}}>Support Groups</h3>
                            {supportGroups.length > 0 ? (
                                supportGroups.map(group => (
                                    <div key={group.id} className="support-group-card">
                                        <div className="group-header">
                                            <h4 style={{color: 'white'}}>{group.name}</h4>
                                            <span className={`badge ${
                                                group.type === 'AA' ? 'badge-primary' :
                                                group.type === 'NA' ? 'badge-warning' :
                                                group.type === 'SMART' ? 'badge-success' :
                                                'badge-secondary'
                                            }`}>
                                                {group.type}
                                            </span>
                                        </div>
                                        
                                        {group.description && (
                                            <p style={{color: 'rgba(255,255,255,0.7)', marginBottom: '10px'}}>
                                                {group.description}
                                            </p>
                                        )}
                                        
                                        <div style={{fontSize: '14px', opacity: 0.8}}>
                                            <div>📅 {group.day}</div>
                                            <div>⏰ {group.time}</div>
                                            {group.location && (
                                                <div>📍 {group.location}</div>
                                            )}
                                            {!group.location && group.link && (
                                                <div>📍 Virtual Meeting</div>
                                            )}
                                        </div>
                                        
                                        {group.link && (
                                            <button 
                                                className="join-btn" 
                                                onClick={() => window.open(group.link, '_blank')}
                                                style={{marginTop: '10px'}}
                                            >
                                                Join Virtual Meeting
                                            </button>
                                        )}
                                    </div>
                                ))
                            ) : (
                                <div className="empty-state">
                                    <div className="empty-state-icon">👥</div>
                                    <div className="empty-state-text">
                                        No support groups available yet.
                                    </div>
                                </div>
                            )}
                        </>
                    )}

                    {activeChat === 'meetings' && (
                        <>
                            <h3 style={{color: '#f4c430', marginBottom: '20px'}}>Scheduled Group Meetings</h3>
                            {meetings.length > 0 ? (
                                meetings.map(meeting => {
                                    const meetingDate = meeting.scheduledTime?.toDate ? 
                                        meeting.scheduledTime.toDate() : 
                                        new Date(meeting.scheduledTime);
                                    
                                    return (
                                        <div key={meeting.id} className="meeting-card">
                                            <div className="meeting-header">
                                                <h4>{meeting.meetingTitle || 'Group Recovery Session'}</h4>
                                                <span className={`status-badge ${
                                                    meeting.status === 'scheduled' ? 'scheduled' : 
                                                    meeting.status === 'completed' ? 'completed' : 'cancelled'
                                                }`}>
                                                    {meeting.status}
                                                </span>
                                            </div>
                                            
                                            <div className="meeting-type">{meeting.type || 'Group Session'}</div>
                                            
                                            <div className="meeting-details">
                                                <div>📅 {meetingDate.toLocaleDateString()}</div>
                                                <div>⏰ {meetingDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                                                <div>⏱️ Duration: {meeting.duration || '60'} minutes</div>
                                                
                                                {meeting.isGlobal && (
                                                    <div>🌍 All PIRs Invited</div>
                                                )}
                                            </div>
                                            
                                            {meeting.notes && (
                                                <div className="meeting-notes">
                                                    📝 {meeting.notes}
                                                </div>
                                            )}
                                            
                                            {meeting.meetingLink && (
                                                <button 
                                                    className="join-btn" 
                                                    onClick={() => window.open(meeting.meetingLink, '_blank')}
                                                >
                                                    Join Virtual Meeting
                                                </button>
                                            )}
                                        </div>
                                    );
                                })
                            ) : (
                                <div className="empty-state">
                                    <div className="empty-state-icon">📅</div>
                                    <div className="empty-state-text">No group meetings scheduled.</div>
                                </div>
                            )}
                        </>
                    )}
                    
                    <div className="crisis-resources">
                        <div className="crisis-title">🆘 Crisis Resources</div>
                        {emergencyResources.length > 0 ? (
                            emergencyResources.map(resource => (
                                <div key={resource.id} style={{marginBottom: '15px'}}>
                                    <div className="crisis-number">
                                        {resource.phone && (
                                            <a href={`tel:${resource.phone}`}>
                                                {resource.phone}
                                            </a>
                                        )}
                                    </div>
                                    <div className="crisis-description">{resource.title}</div>
                                    <small style={{opacity: 0.7}}>{resource.available || '24/7'}</small>
                                </div>
                            ))
                        ) : (
                            <>
                                <div style={{marginBottom: '15px'}}>
                                    <div className="crisis-number">
                                        <a href="tel:988">988</a>
                                    </div>
                                    <div className="crisis-description">Suicide & Crisis Lifeline</div>
                                </div>
                                <div>
                                    <div className="crisis-number">
                                        <a href="tel:1-800-662-4357">1-800-662-HELP</a>
                                    </div>
                                    <div className="crisis-description">SAMHSA National Helpline</div>
                                </div>
                            </>
                        )}
                        <button className="sos-btn" onClick={triggerSOS}>
                            🚨 SOS - I Need Help Now
                        </button>
                    </div>
                </div>
            )}
            
            {currentView === 'profile' && (
                <ProfileView 
                    user={user}
                    userData={userData}
                    profileImage={profileImage}
                    resources={resources}
                    onShowModal={setShowModal}
                    onLogout={handleLogout}
                    onImageUpload={handleProfileImageUpload}
                    fileInputRef={fileInputRef}
                    coachInfo={coachInfo}
                />
            )}

            {currentView === 'resources' && (
                <ResourcesView 
                    user={user}
                    userData={userData}
                    onBack={() => setCurrentView('home')}
                />
            )}
        </div>
        
        <div className="bottom-nav">
            <div 
                className={`nav-item ${currentView === 'tasks' ? 'active' : ''}`}
                onClick={() => setCurrentView('tasks')}
            >
                <div className="nav-icon">✅</div>
                <div className="nav-label">Tasks</div>
            </div>
            <div 
                className={`nav-item ${currentView === 'home' ? 'active' : ''}`}
                onClick={() => setCurrentView('home')}
            >
                <div className="nav-icon">🏠</div>
                <div className="nav-label">Home</div>
            </div>
            <div 
                className={`nav-item ${currentView === 'progress' ? 'active' : ''}`}
                onClick={() => setCurrentView('progress')}
            >
                <div className="nav-icon">📈</div>
                <div className="nav-label">Progress</div>
            </div>
            <div 
                className={`nav-item ${currentView === 'connect' ? 'active' : ''}`}
                onClick={() => setCurrentView('connect')}
            >
                <div className="nav-icon">💬</div>
                <div className="nav-label">Connect</div>
            </div>
            <div 
                className={`nav-item ${currentView === 'profile' ? 'active' : ''}`}
                onClick={() => setCurrentView('profile')}
            >
                <div className="nav-icon">👤</div>
                <div className="nav-label">Profile</div>
            </div>
        </div>
        
        {showModal && (
            <ModalContainer 
                type={showModal}
                onClose={() => setShowModal(null)}
                data={{
                    notifications,
                    userData,
                    user,
                    resources,
                    activeTopicRoom,
                    topicRoomMessages,
                    coachInfo
                }}
                handlers={{
                    markNotificationAsRead,
                    markAllNotificationsAsRead,
                    handleMorningCheckIn,
                    handleEveningReflection,
                    sendTopicMessage: async (message, image) => {
                        if (activeTopicRoom) {
                            await sendTopicRoomMessage(activeTopicRoom.id, message, image);
                        }
                    },
                    exportDataAsJSON,
                    exportDataAsPDF
                }}
            />
        )}
        
        {modalImage && (
            <ImageModal 
                imageUrl={modalImage} 
                onClose={() => setModalImage(null)} 
            />
        )}
    </div>
);
}
    // Recovery Resources View Component - No Favorites
function ResourcesView({ user, userData, onBack }) {
    const [selectedCategory, setSelectedCategory] = useState(null);
    const [activeTab, setActiveTab] = useState('assigned');
    const [resources, setResources] = useState([]);
    const [allResources, setAllResources] = useState([]);
    const [notes, setNotes] = useState({});
    const [progress, setProgress] = useState({});
    const [searchQuery, setSearchQuery] = useState('');
    const [selectedResource, setSelectedResource] = useState(null);
    const [loading, setLoading] = useState(false);
    const [resourceCounts, setResourceCounts] = useState({});
    const [totalResourceCount, setTotalResourceCount] = useState(0);
    const [newResourceIds, setNewResourceIds] = useState([]);
    const [userNames, setUserNames] = useState({});

    const categories = [
        { id: 'coping', name: 'Coping Skills', icon: '🧘', color: '#4CAF50' },
        { id: 'relapse', name: 'Relapse Prevention', icon: '🛡️', color: '#ff9500' },
        { id: 'daily', name: 'Daily Tools', icon: '📝', color: '#2196F3' },
        { id: 'education', name: 'Education', icon: '🎓', color: '#9c27b0' },
        { id: 'support', name: 'Support', icon: '🤝', color: '#00bcd4' },
        { id: 'life', name: 'Life Skills', icon: '💪', color: '#ff5722' }
    ];

    useEffect(() => {
        loadAllResources();
        loadUserPreferences();
    }, [user.uid]);

    useEffect(() => {
        if (allResources.length > 0) {
            checkNewResources();
            loadUserNames();
        }
    }, [allResources]);

    useEffect(() => {
        if (selectedCategory) {
            filterCategoryResources();
        }
    }, [selectedCategory, activeTab, allResources]);

    const loadUserNames = async () => {
        try {
            const uniqueUserIds = [...new Set(allResources.map(r => r.addedBy).filter(Boolean))];
            const names = {};
            
            for (const userId of uniqueUserIds) {
                try {
                    const userDoc = await db.collection('users').doc(userId).get();
                    if (userDoc.exists) {
                        const data = userDoc.data();
                        names[userId] = data.displayName || `${data.firstName} ${data.lastName}` || 'Unknown';
                    }
                } catch (error) {
                    console.error(`Error loading user ${userId}:`, error);
                    names[userId] = 'Unknown';
                }
            }
            
            setUserNames(names);
        } catch (error) {
            console.error('Error loading user names:', error);
        }
    };

    const loadAllResources = async () => {
        try {
            const assignedQuery = await db.collection('resources')
                .where('assignedTo', 'array-contains', user.uid)
                .where('active', '==', true)
                .get();
            
            const globalQuery = await db.collection('resources')
                .where('isGlobal', '==', true)
                .where('active', '==', true)
                .get();

            const resourceMap = new Map();
            
            assignedQuery.forEach(doc => {
                resourceMap.set(doc.id, { 
                    id: doc.id, 
                    ...doc.data(),
                    isAssigned: true 
                });
            });
            
            globalQuery.forEach(doc => {
                if (!resourceMap.has(doc.id)) {
                    resourceMap.set(doc.id, { 
                        id: doc.id, 
                        ...doc.data(),
                        isAssigned: false 
                    });
                }
            });

            const allResourcesList = Array.from(resourceMap.values());
            setAllResources(allResourcesList);
            setTotalResourceCount(allResourcesList.length);
            
            const counts = {};
            categories.forEach(cat => {
                counts[cat.id] = allResourcesList.filter(r => r.category === cat.id).length;
            });
            setResourceCounts(counts);

        } catch (error) {
            console.error('Error loading resources:', error);
        }
    };

    const filterCategoryResources = () => {
        let filtered = allResources.filter(r => r.category === selectedCategory);
        
        if (activeTab === 'assigned') {
            filtered = filtered.filter(r => r.isAssigned);
        } else {
            filtered = filtered.filter(r => !r.isAssigned);
        }
        
        setResources(filtered);
    };

    const checkNewResources = async () => {
        try {
            const lastViewDoc = await db.collection('users').doc(user.uid)
                .collection('preferences').doc('lastResourceView').get();
            
            const lastView = lastViewDoc.exists ? lastViewDoc.data().timestamp : null;
            
            if (lastView && lastView.toDate) {
                const newResources = allResources.filter(r => 
                    r.addedAt && r.addedAt.toDate && r.addedAt.toDate() > lastView.toDate()
                );
                setNewResourceIds(newResources.map(r => r.id));
            }
            
            await db.collection('users').doc(user.uid)
                .collection('preferences').doc('lastResourceView')
                .set({ timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                
        } catch (error) {
            console.error('Error checking new resources:', error);
        }
    };

    const loadUserPreferences = async () => {
        try {
            const prefDoc = await db.collection('users').doc(user.uid)
                .collection('preferences').doc('resources').get();
            
            if (prefDoc.exists) {
                const data = prefDoc.data();
                setNotes(data.notes || {});
                setProgress(data.progress || {});
            }
        } catch (error) {
            console.error('Error loading preferences:', error);
            setNotes({});
            setProgress({});
        }
    };

    const updateProgress = async (resourceId, status) => {
        const newProgress = { 
            ...progress, 
            [resourceId]: {
                status: status,
                updatedAt: new Date().toISOString(),
                completedAt: status === 'completed' ? new Date().toISOString() : progress[resourceId]?.completedAt || null
            }
        };
        setProgress(newProgress);
        
        const saved = await savePreferences({ progress: newProgress });

        if (saved) {
            try {
                await db.collection('activities').add({
                    userId: user.uid,
                    type: 'resource_progress',
                    resourceId: resourceId,
                    status: status,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error('Error tracking activity:', error);
            }
            
            showNotification(`Progress updated to ${status}`, 'success');
        }
    };

    const saveNote = async (resourceId, note) => {
        const newNotes = { ...notes, [resourceId]: note };
        setNotes(newNotes);
        
        const saved = await savePreferences({ notes: newNotes });
        if (saved) {
            showNotification('Note saved', 'success');
        }
    };

    const savePreferences = async (updates) => {
        try {
            const currentPrefs = {
                notes: notes,
                progress: progress,
                ...updates,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection('users').doc(user.uid)
                .collection('preferences').doc('resources')
                .set(currentPrefs, { merge: true });
                
            return true;
        } catch (error) {
            console.error('Error saving preferences:', error);
            showNotification('Failed to save - check permissions', 'error');
            return false;
        }
    };

    const recordView = async (resourceId) => {
        try {
            await db.collection('users').doc(user.uid)
                .collection('resourceViews').doc(resourceId)
                .set({
                    viewedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
        } catch (error) {
            console.error('Error recording view:', error);
        }
    };

    const showNotification = (message, type) => {
        const existingToast = document.querySelector('.resource-toast');
        if (existingToast) {
            existingToast.remove();
        }
        
        const toast = document.createElement('div');
        toast.className = 'resource-toast';
        toast.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: ${type === 'success' ? '#4CAF50' : '#f44336'};
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        `;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 300);
        }, 3000);
    };

    const getFilteredResources = () => {
        if (!searchQuery) return resources;
        
        return resources.filter(resource => 
            resource.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
            resource.description?.toLowerCase().includes(searchQuery.toLowerCase()) ||
            resource.category.toLowerCase().includes(searchQuery.toLowerCase())
        );
    };

    const handleResourceClick = async (resource) => {
        if (!resource || !resource.id) {
            console.error('Invalid resource clicked');
            return;
        }
        
        let completeResource = resource;
        if (!resource.category || !resource.title) {
            completeResource = allResources.find(r => r.id === resource.id) || resource;
        }
        
        setSelectedResource(completeResource);
        
        try {
            await recordView(resource.id);
        } catch (error) {
            console.error('Error recording view:', error);
        }
    };

    // Category Selection View
    if (!selectedCategory) {
        return (
            <div style={{
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                minHeight: '100vh',
                padding: '20px'
            }}>
                <style>{`
                    @keyframes slideIn {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    @keyframes slideOut {
                        from {
                            transform: translateX(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                    }
                `}</style>

                <div style={{
                    background: 'rgba(255,255,255,0.1)',
                    backdropFilter: 'blur(10px)',
                    borderRadius: '20px',
                    padding: '20px',
                    marginBottom: '30px'
                }}>
                    <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        marginBottom: '20px'
                    }}>
                        <button 
                            onClick={onBack}
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                border: 'none',
                                color: 'white',
                                fontSize: '24px',
                                cursor: 'pointer',
                                padding: '10px',
                                borderRadius: '10px',
                                transition: 'all 0.3s'
                            }}
                        >
                            ←
                        </button>
                        <div style={{ flex: 1, textAlign: 'center' }}>
                            <h2 style={{ margin: 0, color: 'white' }}>Recovery Resources</h2>
                            <p style={{ 
                                margin: '5px 0 0 0', 
                                color: 'rgba(255,255,255,0.8)',
                                fontSize: '14px'
                            }}>
                                {totalResourceCount} resources available
                            </p>
                        </div>
                    </div>

                    <div style={{ position: 'relative' }}>
                        <input 
                            type="text"
                            placeholder="Search all resources..."
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '15px 20px 15px 50px',
                                background: 'rgba(255,255,255,0.9)',
                                border: 'none',
                                borderRadius: '15px',
                                fontSize: '16px',
                                outline: 'none',
                                transition: 'all 0.3s'
                            }}
                        />
                        <span style={{
                            position: 'absolute',
                            left: '20px',
                            top: '50%',
                            transform: 'translateY(-50%)',
                            fontSize: '20px'
                        }}>
                            🔍
                        </span>
                    </div>
                </div>

                {searchQuery && (
                    <div style={{
                        background: 'rgba(255,255,255,0.95)',
                        borderRadius: '20px',
                        padding: '20px',
                        marginBottom: '20px'
                    }}>
                        <h3 style={{ margin: '0 0 15px 0' }}>
                            Search Results ({allResources.filter(r => 
                                r.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
                                r.description?.toLowerCase().includes(searchQuery.toLowerCase())
                            ).length})
                        </h3>
                        <div style={{ maxHeight: '300px', overflowY: 'auto' }}>
                            {allResources
                                .filter(r => 
                                    r.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
                                    r.description?.toLowerCase().includes(searchQuery.toLowerCase())
                                )
                                .map(resource => (
                                    <div 
                                        key={resource.id}
                                        onClick={() => handleResourceClick(resource)}
                                        style={{
                                            padding: '10px',
                                            marginBottom: '10px',
                                            background: 'rgba(103,58,183,0.05)',
                                            borderRadius: '10px',
                                            cursor: 'pointer',
                                            transition: 'all 0.3s'
                                        }}
                                    >
                                        <div style={{ fontWeight: 'bold' }}>{resource.title}</div>
                                        <div style={{ fontSize: '12px', color: '#666' }}>
                                            {categories.find(c => c.id === resource.category)?.name}
                                        </div>
                                    </div>
                            ))}
                        </div>
                    </div>
                )}

                <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(2, 1fr)',
                    gap: '15px',
                    marginBottom: '30px'
                }}>
                    {categories.map(category => (
                        <button
                            key={category.id}
                            onClick={() => setSelectedCategory(category.id)}
                            style={{
                                background: 'rgba(255,255,255,0.95)',
                                border: 'none',
                                borderRadius: '20px',
                                padding: '25px',
                                cursor: 'pointer',
                                transition: 'all 0.3s',
                                position: 'relative',
                                overflow: 'hidden'
                            }}
                        >
                            {newResourceIds.some(id => 
                                allResources.find(r => r.id === id && r.category === category.id)
                            ) && (
                                <span style={{
                                    position: 'absolute',
                                    top: '10px',
                                    right: '10px',
                                    background: '#ff4444',
                                    color: 'white',
                                    padding: '2px 8px',
                                    borderRadius: '10px',
                                    fontSize: '10px',
                                    fontWeight: 'bold'
                                }}>
                                    NEW
                                </span>
                            )}
                            
                            <div style={{
                                width: '50px',
                                height: '50px',
                                background: `linear-gradient(135deg, ${category.color}40, ${category.color}60)`,
                                borderRadius: '15px',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '28px',
                                margin: '0 auto 15px'
                            }}>
                                {category.icon}
                            </div>
                            <div style={{
                                fontSize: '16px',
                                fontWeight: 'bold',
                                color: '#333',
                                marginBottom: '5px'
                            }}>
                                {category.name}
                            </div>
                            <div style={{
                                fontSize: '14px',
                                color: category.color,
                                fontWeight: 'bold'
                            }}>
                                {resourceCounts[category.id] || 0} resources
                            </div>
                        </button>
                    ))}
                </div>
            </div>
        );
    }

    // Resource List View
    if (!selectedResource) {
        const category = categories.find(c => c.id === selectedCategory);
        const filteredResources = getFilteredResources();
        
        return (
            <div style={{
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                minHeight: '100vh',
                padding: '20px'
            }}>
                <div style={{
                    background: 'rgba(255,255,255,0.1)',
                    backdropFilter: 'blur(10px)',
                    borderRadius: '20px',
                    padding: '20px',
                    marginBottom: '20px'
                }}>
                    <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        marginBottom: '20px'
                    }}>
                        <button 
                            onClick={() => setSelectedCategory(null)}
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                border: 'none',
                                color: 'white',
                                fontSize: '24px',
                                cursor: 'pointer',
                                padding: '10px',
                                borderRadius: '10px'
                            }}
                        >
                            ←
                        </button>
                        <div style={{ flex: 1, textAlign: 'center' }}>
                            <h2 style={{ margin: 0, color: 'white' }}>
                                {category?.icon} {category?.name}
                            </h2>
                            <p style={{ 
                                margin: '5px 0 0 0', 
                                color: 'rgba(255,255,255,0.8)',
                                fontSize: '14px'
                            }}>
                                {filteredResources.length} resources
                            </p>
                        </div>
                    </div>

                    <div style={{
                        display: 'flex',
                        background: 'rgba(255,255,255,0.2)',
                        borderRadius: '15px',
                        padding: '5px'
                    }}>
                        <button
                            onClick={() => setActiveTab('assigned')}
                            style={{
                                flex: 1,
                                padding: '12px',
                                background: activeTab === 'assigned' ? 'white' : 'transparent',
                                color: activeTab === 'assigned' ? '#764ba2' : 'white',
                                border: 'none',
                                borderRadius: '10px',
                                cursor: 'pointer',
                                fontWeight: 'bold',
                                transition: 'all 0.3s'
                            }}
                        >
                            Assigned ({resources.filter(r => r.isAssigned).length})
                        </button>
                        <button
                            onClick={() => setActiveTab('global')}
                            style={{
                                flex: 1,
                                padding: '12px',
                                background: activeTab === 'global' ? 'white' : 'transparent',
                                color: activeTab === 'global' ? '#764ba2' : 'white',
                                border: 'none',
                                borderRadius: '10px',
                                cursor: 'pointer',
                                fontWeight: 'bold',
                                transition: 'all 0.3s'
                            }}
                        >
                            Global ({resources.filter(r => !r.isAssigned).length})
                        </button>
                    </div>
                </div>

                {loading ? (
                    <div style={{
                        textAlign: 'center',
                        color: 'white',
                        padding: '40px'
                    }}>
                        Loading resources...
                    </div>
                ) : filteredResources.length === 0 ? (
                    <div style={{
                        textAlign: 'center',
                        color: 'rgba(255,255,255,0.8)',
                        padding: '40px',
                        background: 'rgba(255,255,255,0.1)',
                        borderRadius: '20px'
                    }}>
                        No resources found.
                    </div>
                ) : (
                    <div style={{
                        display: 'flex',
                        flexDirection: 'column',
                        gap: '15px'
                    }}>
                        {filteredResources.map(resource => (
                            <div 
                                key={resource.id}
                                style={{
                                    background: 'rgba(255,255,255,0.95)',
                                    borderRadius: '20px',
                                    padding: '20px',
                                    position: 'relative',
                                    transition: 'all 0.3s',
                                    cursor: 'pointer'
                                }}
                                onClick={() => handleResourceClick(resource)}
                            >
                                {newResourceIds.includes(resource.id) && (
                                    <span style={{
                                        position: 'absolute',
                                        top: '10px',
                                        right: '10px',
                                        background: '#ff4444',
                                        color: 'white',
                                        padding: '4px 10px',
                                        borderRadius: '10px',
                                        fontSize: '11px',
                                        fontWeight: 'bold'
                                    }}>
                                        NEW
                                    </span>
                                )}

                                <div style={{
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'flex-start'
                                }}>
                                    <div style={{ flex: 1 }}>
                                        <h4 style={{
                                            color: '#333',
                                            margin: '0 0 8px 0',
                                            fontSize: '18px'
                                        }}>
                                            {resource.title}
                                        </h4>
                                        {resource.description && (
                                            <p style={{
                                                color: '#666',
                                                fontSize: '14px',
                                                margin: '0 0 15px 0',
                                                lineHeight: '1.5'
                                            }}>
                                                {resource.description}
                                            </p>
                                        )}
                                        
                                        <div style={{
                                            display: 'flex',
                                            gap: '10px',
                                            flexWrap: 'wrap',
                                            marginBottom: '15px'
                                        }}>
                                            <span style={{
                                                background: progress[resource.id]?.status === 'completed' 
                                                    ? 'linear-gradient(135deg, #4CAF50, #45a049)'
                                                    : progress[resource.id]?.status === 'in-progress' 
                                                    ? 'linear-gradient(135deg, #ff9800, #f57c00)'
                                                    : 'linear-gradient(135deg, #9e9e9e, #757575)',
                                                color: 'white',
                                                padding: '6px 12px',
                                                borderRadius: '20px',
                                                fontSize: '12px',
                                                fontWeight: 'bold'
                                            }}>
                                                {progress[resource.id]?.status === 'completed' ? '✓ Completed' :
                                                 progress[resource.id]?.status === 'in-progress' ? '⏳ In Progress' :
                                                 '○ Not Started'}
                                            </span>

                                            {resource.addedAt && (
                                                <span style={{
                                                    background: 'rgba(103,58,183,0.1)',
                                                    color: '#673ab7',
                                                    padding: '6px 12px',
                                                    borderRadius: '20px',
                                                    fontSize: '12px'
                                                }}>
                                                    📅 Added {resource.addedAt.toDate ? 
                                                        new Date(resource.addedAt.toDate()).toLocaleDateString() :
                                                        new Date(resource.addedAt).toLocaleDateString()}
                                                </span>
                                            )}

                                            {progress[resource.id]?.completedAt && (
                                                <span style={{
                                                    background: 'rgba(76,175,80,0.1)',
                                                    color: '#4CAF50',
                                                    padding: '6px 12px',
                                                    borderRadius: '20px',
                                                    fontSize: '12px'
                                                }}>
                                                    ✅ Completed {new Date(progress[resource.id].completedAt).toLocaleDateString()}
                                                </span>
                                            )}
                                        </div>

                                        <div style={{
                                            display: 'flex',
                                            gap: '10px',
                                            alignItems: 'center'
                                        }}>
                                            <select
                                                value={progress[resource.id]?.status || 'not-started'}
                                                onChange={(e) => {
                                                    e.stopPropagation();
                                                    updateProgress(resource.id, e.target.value);
                                                }}
                                                onClick={(e) => e.stopPropagation()}
                                                style={{
                                                    padding: '8px 12px',
                                                    background: 'white',
                                                    border: '2px solid #e0e0e0',
                                                    borderRadius: '10px',
                                                    color: '#333',
                                                    cursor: 'pointer',
                                                    fontWeight: '500'
                                                }}
                                            >
                                                <option value="not-started">Not Started</option>
                                                <option value="in-progress">In Progress</option>
                                                <option value="completed">Completed</option>
                                            </select>
                                            
                                            {notes[resource.id] && (
                                                <span style={{
                                                    background: 'rgba(33,150,243,0.1)',
                                                    color: '#2196F3',
                                                    padding: '8px 12px',
                                                    borderRadius: '10px',
                                                    fontSize: '12px',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '5px'
                                                }}>
                                                    📝 Has notes
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );
    }

    return (
        <ResourceViewer 
            resource={selectedResource}
            onBack={() => setSelectedResource(null)}
            onUpdateNote={(note) => saveNote(selectedResource.id, note)}
            currentNote={notes[selectedResource.id]}
            progress={progress[selectedResource.id]}
            onUpdateProgress={(status) => updateProgress(selectedResource.id, status)}
            userName={userNames[selectedResource.addedBy] || 'Unknown'}
        />
    );
}

// Resource Viewer Component
function ResourceViewer({ resource, onBack, onUpdateNote, currentNote, progress, onUpdateProgress, userName }) {
    const [note, setNote] = useState(currentNote || '');
    const [showNoteInput, setShowNoteInput] = useState(false);

    const handlePrint = () => {
        window.print();
    };

    const handleDownload = async () => {
        if (resource.fileURL) {
            window.open(resource.fileURL, '_blank');
        } else if (resource.content) {
            const blob = new Blob([resource.content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${resource.title}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    };

    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'white',
            zIndex: 9999,
            overflowY: 'auto'
        }}>
            <div style={{
                background: 'linear-gradient(135deg, #9c27b0 0%, #673ab7 100%)',
                padding: '20px',
                position: 'sticky',
                top: 0,
                zIndex: 10
            }}>
                <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between'
                }}>
                    <button 
                        onClick={onBack}
                        style={{
                            background: 'rgba(255,255,255,0.2)',
                            border: 'none',
                            color: 'white',
                            fontSize: '24px',
                            cursor: 'pointer',
                            padding: '5px 10px',
                            borderRadius: '8px'
                        }}
                    >
                        ←
                    </button>
                    <h2 style={{
                        flex: 1,
                        textAlign: 'center',
                        margin: 0,
                        color: 'white',
                        fontSize: '18px'
                    }}>
                        {resource.title}
                    </h2>
                    <div style={{display: 'flex', gap: '10px'}}>
                        <button 
                            onClick={handlePrint}
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                border: 'none',
                                color: 'white',
                                padding: '8px 12px',
                                borderRadius: '8px',
                                cursor: 'pointer'
                            }}
                        >
                            🖨️
                        </button>
                        <button 
                            onClick={handleDownload}
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                border: 'none',
                                color: 'white',
                                padding: '8px 12px',
                                borderRadius: '8px',
                                cursor: 'pointer'
                            }}
                        >
                            📥
                        </button>
                    </div>
                </div>
                
                <div style={{
                    marginTop: '15px',
                    display: 'flex',
                    gap: '10px',
                    alignItems: 'center'
                }}>
                    <span style={{color: 'white', fontSize: '14px'}}>Progress:</span>
                    <select
                        value={progress?.status || 'not-started'}
                        onChange={(e) => onUpdateProgress(e.target.value)}
                        style={{
                            padding: '6px 12px',
                            background: 'rgba(255,255,255,0.9)',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            flex: 1
                        }}
                    >
                        <option value="not-started">Not Started</option>
                        <option value="in-progress">In Progress</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
            </div>

            <div style={{padding: '20px', maxWidth: '800px', margin: '0 auto'}}>
                {resource.content ? (
                    <div style={{
                        fontSize: '16px',
                        lineHeight: '1.8',
                        color: '#333'
                    }}>
                        {resource.content.split('\n').map((paragraph, index) => (
                            <p key={index} style={{marginBottom: '15px'}}>
                                {paragraph}
                            </p>
                        ))}
                    </div>
                ) : resource.embedUrl ? (
                    <iframe 
                        src={resource.embedUrl}
                        style={{
                            width: '100%',
                            height: '600px',
                            border: 'none',
                            borderRadius: '10px'
                        }}
                    />
                ) : (
                    <div style={{
                        padding: '40px',
                        textAlign: 'center',
                        color: '#999'
                    }}>
                        <p>This resource is available externally.</p>
                        <a 
                            href={resource.url}
                            target="_blank"
                            rel="noopener noreferrer"
                            style={{
                                display: 'inline-block',
                                marginTop: '20px',
                                padding: '12px 24px',
                                background: '#9c27b0',
                                color: 'white',
                                borderRadius: '8px',
                                textDecoration: 'none'
                            }}
                        >
                            Open Resource
                        </a>
                    </div>
                )}

                <div style={{
                    marginTop: '40px',
                    padding: '20px',
                    background: '#f5f5f5',
                    borderRadius: '10px'
                }}>
                    <h3 style={{margin: '0 0 15px 0'}}>
                        📝 Personal Notes
                    </h3>
                    {showNoteInput ? (
                        <div>
                            <textarea 
                                value={note}
                                onChange={(e) => setNote(e.target.value)}
                                placeholder="Add your thoughts, reflections, or key takeaways..."
                                style={{
                                    width: '100%',
                                    minHeight: '100px',
                                    padding: '10px',
                                    border: '1px solid #ddd',
                                    borderRadius: '8px',
                                    fontSize: '14px',
                                    resize: 'vertical'
                                }}
                            />
                            <div style={{marginTop: '10px', display: 'flex', gap: '10px'}}>
                                <button
                                    onClick={() => {
                                        onUpdateNote(note);
                                        setShowNoteInput(false);
                                    }}
                                    style={{
                                        padding: '8px 16px',
                                        background: '#4CAF50',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '8px',
                                        cursor: 'pointer'
                                    }}
                                >
                                    Save Note
                                </button>
                                <button
                                    onClick={() => {
                                        setNote(currentNote || '');
                                        setShowNoteInput(false);
                                    }}
                                    style={{
                                        padding: '8px 16px',
                                        background: '#999',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '8px',
                                        cursor: 'pointer'
                                    }}
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    ) : (
                        <div>
                            {currentNote ? (
                                <div>
                                    <p style={{margin: '0 0 10px 0', whiteSpace: 'pre-wrap'}}>
                                        {currentNote}
                                    </p>
                                    <button
                                        onClick={() => {
                                            setNote(currentNote);
                                            setShowNoteInput(true);
                                        }}
                                        style={{
                                            padding: '8px 16px',
                                            background: '#9c27b0',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '8px',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        Edit Note
                                    </button>
                                </div>
                            ) : (
                                <button
                                    onClick={() => setShowNoteInput(true)}
                                    style={{
                                        padding: '8px 16px',
                                        background: '#9c27b0',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '8px',
                                        cursor: 'pointer'
                                    }}
                                >
                                    Add Note
                                </button>
                            )}
                        </div>
                    )}
                </div>

                <div style={{
                    marginTop: '20px',
                    padding: '15px',
                    background: '#f9f9f9',
                    borderRadius: '10px',
                    fontSize: '14px',
                    color: '#666'
                }}>
                    <div style={{marginBottom: '8px'}}>
                        <strong>Category:</strong> {resource.category}
                    </div>
                    {resource.addedAt && (
                        <div style={{marginBottom: '8px'}}>
                            <strong>Added:</strong> {resource.addedAt.toDate ? 
                                new Date(resource.addedAt.toDate()).toLocaleDateString() :
                                new Date(resource.addedAt).toLocaleDateString()}
                        </div>
                    )}
                    {progress?.completedAt && (
                        <div style={{marginBottom: '8px'}}>
                            <strong>Completed:</strong> {new Date(progress.completedAt).toLocaleDateString()}
                        </div>
                    )}
                    {userName && (
                        <div>
                            <strong>Added by:</strong> {userName}
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
}
     // Goals and Tasks View Component with Popup Details and Reflections - UPDATED
function GoalsTasksView({ user, goals, assignments, onAssignmentComplete, onReflectionSave }) {
    const [expandedGoals, setExpandedGoals] = useState({});
    const [expandedAssignments, setExpandedAssignments] = useState({});
    const [reflections, setReflections] = useState({});
    const [objectives, setObjectives] = useState([]);
    const [selectedItem, setSelectedItem] = useState(null);
    const [showModal, setShowModal] = useState(false);
    const [showReflectionForm, setShowReflectionForm] = useState(false);
    const [currentReflection, setCurrentReflection] = useState('');
    
    // Load objectives when component mounts or goals change
    useEffect(() => {
        loadObjectives();
    }, [goals]);
    
    const loadObjectives = async () => {
        try {
            const objectivesSnap = await db.collection('objectives')
                .where('userId', '==', user.uid)
                .orderBy('order', 'asc')
                .get();
            
            const objectivesList = [];
            objectivesSnap.forEach(doc => {
                objectivesList.push({ id: doc.id, ...doc.data() });
            });
            
            setObjectives(objectivesList);
        } catch (error) {
            console.error('Error loading objectives:', error);
        }
    };
    
    const toggleGoal = (goalId) => {
        setExpandedGoals(prev => ({
            ...prev,
            [goalId]: !prev[goalId]
        }));
    };
    
    const openItemModal = (item, type) => {
        setSelectedItem({ ...item, type });
        setShowModal(true);
        setShowReflectionForm(false);
        setCurrentReflection('');
    };
    
    const closeModal = () => {
        setShowModal(false);
        setSelectedItem(null);
        setShowReflectionForm(false);
        setCurrentReflection('');
    };
    
    const calculateGoalProgress = (goalId) => {
        const goalAssignments = assignments.filter(a => a.goalId === goalId);
        if (goalAssignments.length === 0) return 0;
        
        const completed = goalAssignments.filter(a => a.status === 'completed').length;
        return Math.round((completed / goalAssignments.length) * 100);
    };
    
    const formatDate = (date) => {
        if (!date) return 'Not set';
        const dateObj = date.toDate ? date.toDate() : new Date(date);
        return dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    };
    
    const getDueDateStatus = (date, isCompleted) => {
        if (isCompleted) return { text: 'Completed', color: '#4CAF50' };
        if (!date) return { text: 'No due date', color: 'rgba(255,255,255,0.5)' };
        
        const dueDate = date.toDate ? date.toDate() : new Date(date);
        const today = new Date();
        const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
        
        if (diffDays < 0) return { text: 'Overdue', color: '#ff453a' };
        if (diffDays === 0) return { text: 'Due Today', color: '#ff9500' };
        if (diffDays === 1) return { text: 'Due Tomorrow', color: '#ff9500' };
        if (diffDays <= 7) return { text: `Due in ${diffDays} days`, color: '#ffd60a' };
        return { text: formatDate(date), color: 'rgba(255,255,255,0.7)' };
    };
    
    const makeLinksClickable = (text) => {
        if (!text) return null;
        
        // Regex to detect URLs
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        const parts = text.split(urlRegex);
        
        return parts.map((part, index) => {
            if (part.match(urlRegex)) {
                return (
                    <a 
                        key={index}
                        href={part} 
                        target="_blank" 
                        rel="noopener noreferrer"
                        style={{
                            color: '#4fc3f7',
                            textDecoration: 'underline'
                        }}
                    >
                        {part}
                    </a>
                );
            }
            return <span key={index}>{part}</span>;
        });
    };
    
    // Modal Component with Reflection Support
    const ItemModal = () => {
        if (!selectedItem || !showModal) return null;
        
        const isCompleted = selectedItem.status === 'completed';
        const typeColors = {
            objective: 'linear-gradient(135deg, #f4c430 0%, #ffa500 100%)',
            assignment: 'linear-gradient(135deg, #9c27b0 0%, #673ab7 100%)'
        };
        
        return (
            <div style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0,0,0,0.8)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 9999,
                padding: '20px'
            }}>
                <div style={{
                    background: '#1a1a1a',
                    borderRadius: '15px',
                    maxWidth: '600px',
                    width: '100%',
                    maxHeight: '80vh',
                    overflow: 'auto',
                    position: 'relative',
                    border: '1px solid rgba(255,255,255,0.1)'
                }}>
                    {/* Header */}
                    <div style={{
                        padding: '20px',
                        borderBottom: '1px solid rgba(255,255,255,0.1)',
                        background: typeColors[selectedItem.type]
                    }}>
                        <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'space-between'
                        }}>
                            <div style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '12px'
                            }}>
                                <span style={{
                                    background: 'rgba(0,0,0,0.3)',
                                    padding: '4px 10px',
                                    borderRadius: '6px',
                                    fontSize: '11px',
                                    fontWeight: 'bold',
                                    letterSpacing: '0.5px',
                                    color: 'white'
                                }}>
                                    {selectedItem.type.toUpperCase()}
                                </span>
                                {isCompleted && <span>✅</span>}
                            </div>
                            <button
                                onClick={closeModal}
                                style={{
                                    background: 'rgba(255,255,255,0.2)',
                                    border: 'none',
                                    borderRadius: '50%',
                                    width: '30px',
                                    height: '30px',
                                    cursor: 'pointer',
                                    color: 'white',
                                    fontSize: '18px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center'
                                }}
                            >
                                ×
                            </button>
                        </div>
                        <h3 style={{
                            color: 'white',
                            margin: '10px 0 0 0',
                            fontSize: '20px',
                            textDecoration: isCompleted ? 'line-through' : 'none'
                        }}>
                            {selectedItem.title}
                        </h3>
                    </div>
                    
                    {/* Body */}
                    <div style={{ padding: '20px' }}>
                        {/* Description */}
                        {selectedItem.description && (
                            <div style={{
                                marginBottom: '20px'
                            }}>
                                <h4 style={{
                                    color: 'rgba(255,255,255,0.7)',
                                    fontSize: '12px',
                                    marginBottom: '8px',
                                    textTransform: 'uppercase',
                                    letterSpacing: '1px'
                                }}>
                                    Description
                                </h4>
                                <div style={{
                                    color: 'white',
                                    fontSize: '14px',
                                    lineHeight: '1.6',
                                    background: 'rgba(255,255,255,0.05)',
                                    padding: '12px',
                                    borderRadius: '8px'
                                }}>
                                    {makeLinksClickable(selectedItem.description)}
                                </div>
                            </div>
                        )}
                        
                        {/* Dates */}
                        <div style={{
                            display: 'flex',
                            flexDirection: 'column',
                            gap: '10px',
                            marginBottom: '20px'
                        }}>
                            <div style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px',
                                color: 'rgba(255,255,255,0.7)',
                                fontSize: '13px'
                            }}>
                                <span>📅</span>
                                <span>Created:</span>
                                <span style={{ color: 'white' }}>
                                    {formatDate(selectedItem.createdAt)}
                                </span>
                            </div>
                            
                            {selectedItem.dueDate && (
                                <div style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '10px',
                                    color: 'rgba(255,255,255,0.7)',
                                    fontSize: '13px'
                                }}>
                                    <span>⏰</span>
                                    <span>Due:</span>
                                    <span style={{ 
                                        color: getDueDateStatus(selectedItem.dueDate, isCompleted).color 
                                    }}>
                                        {formatDate(selectedItem.dueDate)}
                                    </span>
                                </div>
                            )}
                            
                            {selectedItem.completedAt && (
                                <div style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '10px',
                                    color: '#4CAF50',
                                    fontSize: '13px'
                                }}>
                                    <span>✓</span>
                                    <span>Completed:</span>
                                    <span>{formatDate(selectedItem.completedAt)}</span>
                                </div>
                            )}
                        </div>
                        
                        {/* Status */}
                        <div style={{
                            padding: '10px',
                            background: isCompleted ? 
                                'rgba(76,175,80,0.1)' : 
                                'rgba(255,152,0,0.1)',
                            borderRadius: '8px',
                            border: `1px solid ${isCompleted ? 
                                'rgba(76,175,80,0.3)' : 
                                'rgba(255,152,0,0.3)'}`,
                            marginBottom: '20px'
                        }}>
                            <span style={{
                                color: isCompleted ? '#4CAF50' : '#ff9800',
                                fontSize: '13px',
                                fontWeight: '500'
                            }}>
                                Status: {isCompleted ? 'Completed' : 'Active'}
                            </span>
                        </div>
                        
                        {/* Existing Reflection */}
                        {selectedItem.reflection && (
                            <div style={{
                                marginTop: '15px',
                                padding: '12px',
                                background: 'rgba(76,175,80,0.1)',
                                borderRadius: '8px',
                                borderLeft: '3px solid #4CAF50'
                            }}>
                                <h4 style={{
                                    color: '#4CAF50',
                                    fontSize: '12px',
                                    marginBottom: '8px',
                                    textTransform: 'uppercase',
                                    letterSpacing: '1px'
                                }}>
                                    Your Reflection
                                </h4>
                                <p style={{
                                    color: 'rgba(255,255,255,0.9)',
                                    fontSize: '13px',
                                    margin: 0,
                                    lineHeight: '1.6'
                                }}>
                                    {selectedItem.reflection}
                                </p>
                            </div>
                        )}
                        
                        {/* Reflection Form for Incomplete Assignments */}
                        {selectedItem.type === 'assignment' && !isCompleted && showReflectionForm && (
                            <div style={{
                                marginTop: '20px',
                                padding: '15px',
                                background: 'rgba(255,255,255,0.05)',
                                borderRadius: '8px',
                                border: '1px solid rgba(255,255,255,0.1)'
                            }}>
                                <label style={{
                                    color: 'white',
                                    fontSize: '14px',
                                    display: 'block',
                                    marginBottom: '10px',
                                    fontWeight: '500'
                                }}>
                                    Add your reflection:
                                </label>
                                <textarea 
                                    value={currentReflection}
                                    onChange={(e) => setCurrentReflection(e.target.value)}
                                    placeholder="What did you learn? How did this help your recovery?"
                                    style={{
                                        width: '100%',
                                        minHeight: '100px',
                                        padding: '10px',
                                        background: 'rgba(0,0,0,0.3)',
                                        border: '1px solid rgba(255,255,255,0.2)',
                                        borderRadius: '6px',
                                        color: 'white',
                                        fontSize: '14px',
                                        resize: 'vertical'
                                    }}
                                    autoFocus
                                />
                                <div style={{
                                    marginTop: '12px',
                                    display: 'flex',
                                    gap: '10px'
                                }}>
                                    <button
                                        onClick={() => {
                                            onReflectionSave(selectedItem.id, currentReflection);
                                            closeModal();
                                        }}
                                        style={{
                                            flex: 1,
                                            padding: '10px',
                                            background: '#4CAF50',
                                            border: 'none',
                                            borderRadius: '6px',
                                            color: 'white',
                                            cursor: 'pointer',
                                            fontWeight: '500',
                                            fontSize: '14px'
                                        }}
                                    >
                                        Submit Reflection & Complete
                                    </button>
                                    <button
                                        onClick={() => {
                                            setShowReflectionForm(false);
                                            setCurrentReflection('');
                                        }}
                                        style={{
                                            padding: '10px 20px',
                                            background: 'rgba(255,255,255,0.1)',
                                            border: '1px solid rgba(255,255,255,0.2)',
                                            borderRadius: '6px',
                                            color: 'white',
                                            cursor: 'pointer',
                                            fontSize: '14px'
                                        }}
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        )}
                        
                        {/* Action buttons for assignments */}
                        {selectedItem.type === 'assignment' && !isCompleted && (
                            <div style={{
                                marginTop: '20px',
                                display: 'flex',
                                gap: '10px'
                            }}>
                                {!showReflectionForm && (
                                    <>
                                        <button
                                            onClick={() => setShowReflectionForm(true)}
                                            style={{
                                                flex: 1,
                                                padding: '12px',
                                                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                                border: 'none',
                                                borderRadius: '8px',
                                                color: 'white',
                                                cursor: 'pointer',
                                                fontWeight: '500',
                                                fontSize: '14px'
                                            }}
                                        >
                                            Complete with Reflection
                                        </button>
                                        <button
                                            onClick={() => {
                                                onAssignmentComplete(selectedItem.id, true);
                                                closeModal();
                                            }}
                                            style={{
                                                flex: 1,
                                                padding: '12px',
                                                background: '#4CAF50',
                                                border: 'none',
                                                borderRadius: '8px',
                                                color: 'white',
                                                cursor: 'pointer',
                                                fontWeight: '500',
                                                fontSize: '14px'
                                            }}
                                        >
                                            Mark Complete Only
                                        </button>
                                    </>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );
    };
    
    if (goals.length === 0) {
        return (
            <div style={{
                textAlign: 'center',
                color: 'rgba(255,255,255,0.6)',
                padding: '40px'
            }}>
                <div style={{fontSize: '48px', marginBottom: '20px'}}>🎯</div>
                <p>No goals assigned yet.</p>
                <p style={{fontSize: '14px', marginTop: '10px'}}>
                    Your coach will create goals for your recovery journey.
                </p>
            </div>
        );
    }
    
    return (
        <>
            <div style={{padding: '0 20px'}}>
                {goals.map(goal => {
                    const goalObjectives = objectives.filter(o => o.goalId === goal.id);
                    const goalProgress = calculateGoalProgress(goal.id);
                    const isExpanded = expandedGoals[goal.id];
                    const isGoalCompleted = goal.status === 'completed';
                    const dueDateStatus = getDueDateStatus(goal.dueDate, isGoalCompleted);
                    
                    return (
                        <div key={goal.id} style={{
                            background: isGoalCompleted ? 'rgba(76,175,80,0.08)' : 'rgba(255,255,255,0.05)',
                            borderRadius: '15px',
                            marginBottom: '20px',
                            overflow: 'hidden',
                            border: isGoalCompleted ? '1px solid rgba(76,175,80,0.3)' : '1px solid rgba(255,255,255,0.1)'
                        }}>
                            {/* Goal Header */}
                            <div 
                                onClick={() => toggleGoal(goal.id)}
                                style={{
                                    padding: '20px',
                                    cursor: 'pointer',
                                    borderBottom: isExpanded ? '1px solid rgba(255,255,255,0.1)' : 'none'
                                }}
                            >
                                {/* Type Label and Title */}
                                <div style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'space-between',
                                    marginBottom: '12px'
                                }}>
                                    <h3 style={{
                                        color: isGoalCompleted ? '#4CAF50' : 'white',
                                        margin: 0,
                                        fontSize: '18px',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '12px',
                                        textDecoration: isGoalCompleted ? 'line-through' : 'none'
                                    }}>
                                        <span style={{
                                            transform: isExpanded ? 'rotate(90deg)' : 'rotate(0)',
                                            transition: 'transform 0.3s',
                                            fontSize: '14px'
                                        }}>
                                            ▶
                                        </span>
                                        <span style={{
                                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                            padding: '4px 10px',
                                            borderRadius: '6px',
                                            fontSize: '11px',
                                            fontWeight: 'bold',
                                            letterSpacing: '0.5px'
                                        }}>
                                            GOAL
                                        </span>
                                        {goal.title}
                                        {isGoalCompleted && <span style={{color: '#4CAF50'}}>✅</span>}
                                    </h3>
                                    <span style={{
                                        color: dueDateStatus.color,
                                        fontSize: '13px',
                                        fontWeight: '500'
                                    }}>
                                        {dueDateStatus.text}
                                    </span>
                                </div>

                                {/* Goal Description - Now displayed here */}
                                {goal.description && (
                                    <div style={{
                                        color: 'rgba(255,255,255,0.8)',
                                        fontSize: '14px',
                                        marginBottom: '12px',
                                        paddingLeft: '26px',
                                        lineHeight: '1.5'
                                    }}>
                                        {makeLinksClickable(goal.description)}
                                    </div>
                                )}

                                {/* Date Information - After description */}
                                <div style={{
                                    display: 'flex',
                                    gap: '20px',
                                    marginBottom: '12px',
                                    paddingLeft: '26px'
                                }}>
                                    <span style={{
                                        color: 'rgba(255,255,255,0.5)',
                                        fontSize: '12px'
                                    }}>
                                        📅 Created: {formatDate(goal.createdAt)}
                                    </span>
                                    {goal.dueDate && (
                                        <span style={{
                                            color: 'rgba(255,255,255,0.5)',
                                            fontSize: '12px'
                                        }}>
                                            ⏰ Due: {formatDate(goal.dueDate)}
                                        </span>
                                    )}
                                    {goal.completedAt && (
                                        <span style={{
                                            color: '#4CAF50',
                                            fontSize: '12px'
                                        }}>
                                            ✓ Completed: {formatDate(goal.completedAt)}
                                        </span>
                                    )}
                                </div>
                                
                                {/* Progress Bar */}
                                <div style={{
                                    paddingLeft: '26px'
                                }}>
                                    <div style={{
                                        background: 'rgba(255,255,255,0.1)',
                                        borderRadius: '10px',
                                        height: '8px',
                                        overflow: 'hidden'
                                    }}>
                                        <div style={{
                                            background: isGoalCompleted ? 
                                                '#4CAF50' : 
                                                `linear-gradient(90deg, #4CAF50 0%, #45a049 100%)`,
                                            width: `${goalProgress}%`,
                                            height: '100%',
                                            transition: 'width 0.3s ease'
                                        }}/>
                                    </div>
                                    <div style={{
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        marginTop: '5px'
                                    }}>
                                        <span style={{
                                            color: 'rgba(255,255,255,0.6)',
                                            fontSize: '12px'
                                        }}>
                                            {goalProgress}% Complete
                                        </span>
                                        <span style={{
                                            color: 'rgba(255,255,255,0.6)',
                                            fontSize: '12px'
                                        }}>
                                            {goalObjectives.length} Objectives • {assignments.filter(a => a.goalId === goal.id).length} Assignments
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Objectives and Assignments - Simplified list */}
                            {isExpanded && (
                                <div style={{padding: '20px', paddingTop: '0'}}>
                                    {goalObjectives.length === 0 ? (
                                        <p style={{
                                            color: 'rgba(255,255,255,0.6)',
                                            fontSize: '14px',
                                            paddingLeft: '26px'
                                        }}>
                                            No objectives created yet.
                                        </p>
                                    ) : (
                                        goalObjectives.map(objective => {
                                            const objectiveAssignments = assignments.filter(a => a.objectiveId === objective.id);
                                            const isObjectiveCompleted = objective.status === 'completed';
                                            
                                            return (
                                                <div key={objective.id} style={{
                                                    marginTop: '15px',
                                                    paddingLeft: '26px'
                                                }}>
                                                    {/* Objective - Clickable */}
                                                    <div 
                                                        onClick={() => openItemModal(objective, 'objective')}
                                                        style={{
                                                            background: isObjectiveCompleted ? 'rgba(76,175,80,0.05)' : 'rgba(255,255,255,0.03)',
                                                            borderRadius: '10px',
                                                            padding: '12px',
                                                            marginBottom: '10px',
                                                            border: '1px solid rgba(255,255,255,0.08)',
                                                            cursor: 'pointer',
                                                            transition: 'all 0.2s'
                                                        }}
                                                        onMouseEnter={(e) => {
                                                            e.currentTarget.style.background = isObjectiveCompleted ? 
                                                                'rgba(76,175,80,0.08)' : 'rgba(255,255,255,0.06)';
                                                        }}
                                                        onMouseLeave={(e) => {
                                                            e.currentTarget.style.background = isObjectiveCompleted ? 
                                                                'rgba(76,175,80,0.05)' : 'rgba(255,255,255,0.03)';
                                                        }}
                                                    >
                                                        <div style={{
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            justifyContent: 'space-between'
                                                        }}>
                                                            <div style={{
                                                                display: 'flex',
                                                                alignItems: 'center',
                                                                gap: '10px'
                                                            }}>
                                                                <span style={{
                                                                    background: 'linear-gradient(135deg, #f4c430 0%, #ffa500 100%)',
                                                                    padding: '3px 8px',
                                                                    borderRadius: '5px',
                                                                    fontSize: '10px',
                                                                    fontWeight: 'bold',
                                                                    color: '#000',
                                                                    letterSpacing: '0.5px'
                                                                }}>
                                                                    OBJECTIVE
                                                                </span>
                                                                <span style={{
                                                                    color: isObjectiveCompleted ? '#4CAF50' : 'white',
                                                                    fontSize: '14px',
                                                                    textDecoration: isObjectiveCompleted ? 'line-through' : 'none'
                                                                }}>
                                                                    {objective.title}
                                                                </span>
                                                                {isObjectiveCompleted && <span>✅</span>}
                                                            </div>
                                                            <span style={{
                                                                color: 'rgba(255,255,255,0.4)',
                                                                fontSize: '12px'
                                                            }}>
                                                                Click for details →
                                                            </span>
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Assignments under this objective */}
                                                    {objectiveAssignments.map(assignment => {
                                                        const isAssignmentCompleted = assignment.status === 'completed';
                                                        
                                                        return (
                                                            <div key={assignment.id} style={{
                                                                display: 'flex',
                                                                alignItems: 'center',
                                                                gap: '10px',
                                                                marginLeft: '20px',
                                                                marginBottom: '8px'
                                                            }}>
                                                                {/* Checkbox for completion */}
                                                                <input 
                                                                    type="checkbox"
                                                                    checked={isAssignmentCompleted}
                                                                    onChange={(e) => {
                                                                        onAssignmentComplete(assignment.id, e.target.checked);
                                                                    }}
                                                                    style={{
                                                                        width: '18px',
                                                                        height: '18px',
                                                                        cursor: 'pointer'
                                                                    }}
                                                                />
                                                                
                                                                {/* Assignment - Clickable */}
                                                                <div 
                                                                    onClick={() => openItemModal(assignment, 'assignment')}
                                                                    style={{
                                                                        flex: 1,
                                                                        background: isAssignmentCompleted ? 
                                                                            'rgba(76,175,80,0.08)' : 
                                                                            'rgba(255,255,255,0.02)',
                                                                        borderRadius: '8px',
                                                                        padding: '10px',
                                                                        border: isAssignmentCompleted ? 
                                                                            '1px solid rgba(76,175,80,0.2)' : 
                                                                            '1px solid rgba(255,255,255,0.06)',
                                                                        cursor: 'pointer',
                                                                        transition: 'all 0.2s'
                                                                    }}
                                                                    onMouseEnter={(e) => {
                                                                        e.currentTarget.style.background = isAssignmentCompleted ? 
                                                                            'rgba(76,175,80,0.1)' : 'rgba(255,255,255,0.04)';
                                                                    }}
                                                                    onMouseLeave={(e) => {
                                                                        e.currentTarget.style.background = isAssignmentCompleted ? 
                                                                            'rgba(76,175,80,0.08)' : 'rgba(255,255,255,0.02)';
                                                                    }}
                                                                >
                                                                    <div style={{
                                                                        display: 'flex',
                                                                        alignItems: 'center',
                                                                        justifyContent: 'space-between'
                                                                    }}>
                                                                        <div style={{
                                                                            display: 'flex',
                                                                            alignItems: 'center',
                                                                            gap: '8px'
                                                                        }}>
                                                                            <span style={{
                                                                                background: 'linear-gradient(135deg, #9c27b0 0%, #673ab7 100%)',
                                                                                padding: '2px 7px',
                                                                                borderRadius: '4px',
                                                                                fontSize: '9px',
                                                                                fontWeight: 'bold',
                                                                                letterSpacing: '0.5px'
                                                                            }}>
                                                                                ASSIGNMENT
                                                                            </span>
                                                                            <span style={{
                                                                                color: isAssignmentCompleted ? 
                                                                                    'rgba(255,255,255,0.5)' : 'white',
                                                                                fontSize: '13px',
                                                                                textDecoration: isAssignmentCompleted ? 
                                                                                    'line-through' : 'none'
                                                                            }}>
                                                                                {assignment.title}
                                                                            </span>
                                                                            {isAssignmentCompleted && <span>✅</span>}
                                                                        </div>
                                                                        <span style={{
                                                                            color: 'rgba(255,255,255,0.3)',
                                                                            fontSize: '11px'
                                                                        }}>
                                                                            Click for details →
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            );
                                        })
                                    )}
                                </div>
                            )}
                        </div>
                    );
                })}
            </div>
            
            {/* Render Modal */}
            <ItemModal />
        </>
    );
}
        
       // Enhanced ProfileView Component with all missing features
function ProfileView({ user, userData, profileImage, resources, onShowModal, onLogout, onImageUpload, fileInputRef, coachInfo }) {
    const [profileStats, setProfileStats] = useState({
        checkInRate: 0,
        assignmentRate: 0,
        currentStreak: 0,
        avgMood: 0,
        avgCraving: 0
    });
    
    // Calculate profile completion percentage
    const calculateProfileCompletion = () => {
        let completed = 0;
        let total = 10;
        
        if (userData?.firstName) completed++;
        if (userData?.lastName) completed++;
        if (userData?.phone) completed++;
        if (userData?.sobrietyDate) completed++;
        if (userData?.substance) completed++;
        if (userData?.dailyCost) completed++;
        if (userData?.emergencyContacts?.length > 0) completed++;
        if (userData?.address?.city) completed++;
        if (userData?.profileImageUrl) completed++;
        if (userData?.dateOfBirth) completed++;
        
        return Math.round((completed / total) * 100);
    };
    
    // Load profile stats
    useEffect(() => {
        loadProfileStats();
    }, [user]);
    
    const loadProfileStats = async () => {
    try {
        // Get user's account creation date
        const userDoc = await db.collection('users').doc(user.uid).get();
        const accountCreatedDate = userDoc.data()?.createdAt?.toDate() || new Date();
        
        // Calculate days since account creation (max 30 days for recent performance)
        const today = new Date();
        const daysSinceCreation = Math.floor((today - accountCreatedDate) / (1000 * 60 * 60 * 24));
        const daysToCheck = Math.min(daysSinceCreation, 30); // Cap at 30 days
        
        // Skip calculation if account is less than 1 day old
        if (daysToCheck < 1) {
            setProfileStats({
                checkInRate: 0,
                assignmentRate: 0,
                currentStreak: 0,
                avgMood: 0,
                avgCraving: 0
            });
            return;
        }
        
        // Calculate check-in rate based on days since joining
        const dateToCheckFrom = new Date();
        dateToCheckFrom.setDate(dateToCheckFrom.getDate() - daysToCheck);
        
        const checkInsSnap = await db.collection('checkIns')
            .where('userId', '==', user.uid)
            .where('createdAt', '>=', dateToCheckFrom)
            .get();
        
        // COUNT ONLY MORNING CHECK-INS
        let morningCheckInCount = 0;
        let totalMood = 0;
        let totalCraving = 0;
        let moodCount = 0;
        
        checkInsSnap.forEach(doc => {
            const data = doc.data();
            if (data.morningData) {
                morningCheckInCount++;
                
                // Calculate average mood (and craving for potential future use)
                if (data.morningData.mood) {
                    totalMood += data.morningData.mood;
                    moodCount++;
                }
                if (data.morningData.craving) {
                    totalCraving += data.morningData.craving;
                }
            }
        });
        
        // Calculate check-in rate - CAPPED AT 100%
        const checkInRate = Math.min(100, Math.round((morningCheckInCount / daysToCheck) * 100));
        
        // Calculate LIFETIME task completion (all check-ins + reflections + assignments)
const taskCompletion = await calculateLifetimeTaskCompletion(user.uid);

// Get current streak
const streakDoc = await db.collection('streaks').doc(user.uid).get();
const currentStreak = streakDoc.exists ? streakDoc.data().currentStreak || 0 : 0;

// Use the lifetime task completion rate instead of just assignment rate
const assignmentRate = taskCompletion.completionRate; // This is now ALL tasks, not just assignments

setProfileStats({
    checkInRate,
    assignmentRate,  // This now represents total task completion, not just assignments
    currentStreak,
    avgMood: moodCount > 0 ? (totalMood / moodCount).toFixed(1) : 0,
    avgCraving: moodCount > 0 ? (totalCraving / moodCount).toFixed(1) : 0
});
} catch (error) {
    console.error('Error loading profile stats:', error);
}
};
    // Helper functions for task calculations - can be called by admin.html
const calculateLifetimeTaskCompletion = async (userId) => {
    try {
        // Get user's account creation date
        const userDoc = await db.collection('users').doc(userId).get();
        const accountCreatedDate = userDoc.data()?.createdAt?.toDate() || new Date();
        
        // Calculate total days since joining
        const today = new Date();
        const daysSinceJoining = Math.floor((today - accountCreatedDate) / (1000 * 60 * 60 * 24)) + 1; // +1 to include today
        
        // Get ALL check-ins (no date filter for lifetime)
        const checkInsSnap = await db.collection('checkIns')
            .where('userId', '==', userId)
            .get();
        
        // Count morning check-ins and evening reflections separately
        let morningCheckInsCompleted = 0;
        let eveningReflectionsCompleted = 0;
        
        checkInsSnap.forEach(doc => {
            const data = doc.data();
            if (data.morningData) {
                morningCheckInsCompleted++;
            }
            if (data.eveningData) {
                eveningReflectionsCompleted++;
            }
        });
        
        // Get ALL assignments (lifetime)
        const assignmentsSnap = await db.collection('assignments')
            .where('userId', '==', userId)
            .get();
        
        let totalAssignments = 0;
        let completedAssignments = 0;
        
        assignmentsSnap.forEach(doc => {
            totalAssignments++;
            if (doc.data().status === 'completed') {
                completedAssignments++;
            }
        });
        
        // Calculate totals
        const expectedDailyTasks = daysSinceJoining * 2; // Morning + Evening each day
        const totalExpectedTasks = expectedDailyTasks + totalAssignments;
        const totalCompletedTasks = morningCheckInsCompleted + eveningReflectionsCompleted + completedAssignments;
        
        // Calculate percentage
        const completionRate = totalExpectedTasks > 0 ? 
            Math.round((totalCompletedTasks / totalExpectedTasks) * 100) : 0;
        
        return {
            completionRate,
            totalCompleted: totalCompletedTasks,
            totalExpected: totalExpectedTasks,
            breakdown: {
                morningCheckIns: morningCheckInsCompleted,
                eveningReflections: eveningReflectionsCompleted,
                assignments: completedAssignments,
                expectedDailyTasks: expectedDailyTasks,
                totalAssignments: totalAssignments
            }
        };
    } catch (error) {
        console.error('Error calculating lifetime task completion:', error);
        return {
            completionRate: 0,
            totalCompleted: 0,
            totalExpected: 0
        };
    }
};
    
    const handleImageSelect = (e) => {
    const file = e.target.files[0];
    if (file) {
        onImageUpload(file);
    }
};
  

const profileCompletion = calculateProfileCompletion();

return (
    <>
        <div className="profile-menu">
            <div className="profile-header">
                <div className="profile-avatar" onClick={() => fileInputRef.current?.click()}>
                    {profileImage ? (
                        <img src={profileImage} alt="Profile" />
                    ) : (
                        (userData?.displayName || userData?.firstName || user.email || '👤').charAt(0).toUpperCase()
                    )}
                    <div className="profile-avatar-upload">
                        📷
                    </div>
                </div>
                <input 
                    ref={fileInputRef}
                    type="file"
                    accept="image/*"
                    className="upload-input"
                    onChange={handleImageSelect}
                />
                <div className="profile-name">
                    {userData?.displayName || userData?.firstName || 'User'}
                </div>
                <div className="profile-email">{user.email}</div>
                
                {/* Profile Completion Indicator */}
                {profileCompletion < 100 && (
                    <div style={{marginTop: '10px'}}>
                        <div style={{fontSize: '12px', opacity: 0.8, marginBottom: '5px'}}>
                            Profile {profileCompletion}% Complete
                        </div>
                        <div style={{
                            background: 'rgba(255,255,255,0.1)',
                            borderRadius: '10px',
                            height: '8px',
                            overflow: 'hidden'
                        }}>
                            <div style={{
                                background: 'linear-gradient(135deg, #f4c430 0%, #ff9500 100%)',
                                width: `${profileCompletion}%`,
                                height: '100%',
                                transition: 'width 0.3s ease'
                            }}/>
                        </div>
                    </div>
                )}
                
                {/* Sobriety Info */}
                {userData?.sobrietyDate && (
                    <div style={{
                        marginTop: '15px',
                        padding: '10px',
                        background: 'rgba(76, 175, 80, 0.1)',
                        borderRadius: '10px',
                        border: '1px solid rgba(76, 175, 80, 0.3)'
                    }}>
                        <div style={{fontSize: '24px', fontWeight: 'bold', color: '#4CAF50'}}>
                            {Math.floor((new Date() - new Date(userData.sobrietyDate)) / (1000 * 60 * 60 * 24)) + 1} Days Clean
                        </div>
                        <div style={{fontSize: '12px', opacity: 0.8, marginTop: '5px'}}>
                            Since {new Date(userData.sobrietyDate).toLocaleDateString('en-US', {
                                timeZone: 'UTC',
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            })}
                        </div>
                    </div>
                )}
            </div>  {/* THIS WAS MISSING - Closing profile-header */}
            
            {/* Stats Section */}
            <div className="menu-section">
                <div className="menu-title">My Stats</div>
                <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(2, 1fr)',
                    gap: '10px',
                    padding: '0 15px',
                    marginBottom: '15px'
                }}>
                    <div style={{
                        background: 'rgba(255,255,255,0.05)',
                        borderRadius: '10px',
                        padding: '10px',
                        textAlign: 'center'
                    }}>
                        <div style={{fontSize: '20px', fontWeight: 'bold', color: '#f4c430'}}>
                            {profileStats.checkInRate}%
                        </div>
                        <div style={{fontSize: '11px', opacity: 0.7}}>Check-in Rate</div>
                    </div>
                    
                    <div style={{
                        background: 'rgba(255,255,255,0.05)',
                        borderRadius: '10px',
                        padding: '10px',
                        textAlign: 'center'
                    }}>
                        <div style={{fontSize: '20px', fontWeight: 'bold', color: '#4CAF50'}}>
                            {profileStats.assignmentRate}%
                        </div>
                        <div style={{fontSize: '11px', opacity: 0.7}}>Lifetime Task</div>
                    </div>
                    
                    <div style={{
                        background: 'rgba(255,255,255,0.05)',
                        borderRadius: '10px',
                        padding: '10px',
                        textAlign: 'center'
                    }}>
                        <div style={{fontSize: '20px', fontWeight: 'bold', color: '#ff9500'}}>
                            {profileStats.currentStreak}
                        </div>
                        <div style={{fontSize: '11px', opacity: 0.7}}>Day Streak</div>
                    </div>
                    
                    <div style={{
                        background: 'rgba(255,255,255,0.05)',
                        borderRadius: '10px',
                        padding: '10px',
                        textAlign: 'center'
                    }}>
                        <div style={{fontSize: '20px', fontWeight: 'bold', color: '#9c27b0'}}>
                            {profileStats.avgMood}/5
                        </div>
                        <div style={{fontSize: '11px', opacity: 0.7}}>Avg Mood</div>
                    </div>
                </div>
            </div>
                
                {/* Coach Section */}
                {coachInfo && (
                    <div className="menu-section">
                        <div className="menu-title">My Coach</div>
                        <div style={{background: 'rgba(255,255,255,0.05)', borderRadius: '10px', padding: '15px', margin: '0 10px'}}>
                            <div style={{fontWeight: 'bold', marginBottom: '5px'}}>
                                {coachInfo.displayName || coachInfo.firstName + ' ' + coachInfo.lastName}
                            </div>
                            {coachInfo.credentials && (
                                <div style={{fontSize: '14px', opacity: 0.8, marginBottom: '5px'}}>
                                    {coachInfo.credentials}
                                </div>
                            )}
                            {coachInfo.phone && (
                                <div style={{fontSize: '14px'}}>
                                    📞 <a href={`tel:${coachInfo.phone}`} style={{color: '#f4c430', textDecoration: 'none'}}>
                                        {coachInfo.phone}
                                    </a>
                                </div>
                            )}
                        </div>
                    </div>
                )}
                
                {/* Account Settings */}
                <div className="menu-section">
                    <div className="menu-title">Account</div>
                    <button className="menu-item" onClick={() => onShowModal('personalInfo')}>
                        <div className="menu-item-left">
                            <span className="menu-icon">👤</span>
                            <span>Personal Information</span>
                        </div>
                        <span className="menu-arrow">›</span>
                    </button>
                    <button className="menu-item" onClick={() => onShowModal('recoveryInfo')}>
                        <div className="menu-item-left">
                            <span className="menu-icon">🎯</span>
                            <span>Recovery Settings</span>
                        </div>
                        <span className="menu-arrow">›</span>
                    </button>
                    <button className="menu-item" onClick={() => onShowModal('password')}>
                        <div className="menu-item-left">
                            <span className="menu-icon">🔐</span>
                            <span>Password & Security</span>
                        </div>
                        <span className="menu-arrow">›</span>
                    </button>
                    <button className="menu-item" onClick={() => onShowModal('notifications')}>
                        <div className="menu-item-left">
                            <span className="menu-icon">🔔</span>
                            <span>Notification Settings</span>
                        </div>
                        <span className="menu-arrow">›</span>
                    </button>
                    <button className="menu-item" onClick={() => onShowModal('emergency')}>
                        <div className="menu-item-left">
                            <span className="menu-icon">🆘</span>
                            <span>Emergency Contacts</span>
                        </div>
                        <span className="menu-arrow">›</span>
                    </button>
                    
                </div>
                
                {/* Support & Resources */}
                <div className="menu-section">
                    <div className="menu-title">Support</div>
                    <button className="menu-item" onClick={() => onShowModal('help')}>
                        <div className="menu-item-left">
                            <span className="menu-icon">❓</span>
                            <span>Help & Support</span>
                        </div>
                        <span className="menu-arrow">›</span>
                    </button>
                    <button className="menu-item" onClick={() => onShowModal('feedback')}>
                        <div className="menu-item-left">
                            <span className="menu-icon">💬</span>
                            <span>Send Feedback</span>
                        </div>
                        <span className="menu-arrow">›</span>
                    </button>
                    <button className="menu-item" onClick={() => onShowModal('export')}>
                        <div className="menu-item-left">
                            <span className="menu-icon">📥</span>
                            <span>Export My Data</span>
                        </div>
                        <span className="menu-arrow">›</span>
                    </button>
                </div>
                
                {/* About Section */}
                <div className="menu-section">
                    <div className="menu-title">About</div>
                    <button className="menu-item" onClick={() => onShowModal('terms')}>
                        <div className="menu-item-left">
                            <span className="menu-icon">📄</span>
                            <span>Terms of Service</span>
                        </div>
                        <span className="menu-arrow">›</span>
                    </button>
                    <button className="menu-item" onClick={() => onShowModal('privacy_policy')}>
                        <div className="menu-item-left">
                            <span className="menu-icon">📋</span>
                            <span>Privacy Policy</span>
                        </div>
                        <span className="menu-arrow">›</span>
                    </button>
                    <button className="menu-item" onClick={() => onShowModal('about')}>
                        <div className="menu-item-left">
                            <span className="menu-icon">ℹ️</span>
                            <span>About GLRS</span>
                        </div>
                        <span className="menu-arrow">›</span>
                    </button>
                </div>
                
                {/* Sign Out & Delete Account */}
                <div className="menu-section">
                    <button className="btn-danger" onClick={onLogout}>
                        Sign Out
                    </button>
                    <button 
                        style={{
                            width: '100%',
                            padding: '14px',
                            background: 'transparent',
                            border: '1px solid rgba(255, 71, 87, 0.5)',
                            borderRadius: '10px',
                            color: '#ff4757',
                            fontWeight: 'bold',
                            cursor: 'pointer',
                            marginTop: '10px'
                        }}
                        onClick={() => onShowModal('deleteAccount')}
                    >
                        Delete Account
                    </button>
                </div>
            </div>
        </>
    );
}
        
       // Community Chat Component - FULLY UPDATED VERSION
function CommunityChat({ messages, onSendMessage, currentUserId, uploadChatImage, flagContent, setModalImage }) {
    const [message, setMessage] = useState('');
    const [selectedImage, setSelectedImage] = useState(null);
    const [uploading, setUploading] = useState(false);
    const messagesEndRef = useRef(null);
    
    useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
    }, [messages]);
    
    const handleImageSelect = (e) => {
        const file = e.target.files[0];
        if (file) {
            setSelectedImage(file);  // Removed size check since we compress
        }
    };
    
    const handleSend = async () => {
        if ((message.trim() || selectedImage) && !uploading) {
            setUploading(true);
            
            try {
                let imageUrl = null;
                
                // Upload and compress image if selected
                if (selectedImage && uploadChatImage) {
                    imageUrl = await uploadChatImage(selectedImage, 'community', 'main');
                }
                
                // Send message with image URL (not the file)
                await onSendMessage(message, imageUrl);
                
                // Clear inputs
                setMessage('');
                setSelectedImage(null);
                const fileInput = document.getElementById('community-image-input');
                if (fileInput) fileInput.value = '';
                
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message');
            } finally {
                setUploading(false);
            }
        }
    };
    
    return (
        <div className="community-chat-container">
            <div className="messages-container">
                {messages.length > 0 ? (
                    messages.map(msg => (
                        <div key={msg.id} className="community-message">
                            <div className="message-header">
                                <span className="message-author">
                                    {msg.senderName || 'Anonymous'}
                                </span>
                                <div style={{display: 'flex', gap: '10px'}}>
                                    <span className="message-time">
                                        {msg.createdAt?.toDate ? 
                                            new Date(msg.createdAt.toDate()).toLocaleTimeString() :
                                            'now'}
                                    </span>
                                    {msg.senderId !== currentUserId && flagContent && (
                                        <button
                                            onClick={() => flagContent('community_message', {
                                                messageId: msg.id,
                                                messageContent: msg.content,
                                                messageImageUrl: msg.imageUrl || null,
                                                authorId: msg.senderId,
                                                authorName: msg.senderName
                                            })}
                                            style={{
                                                background: 'transparent',
                                                border: 'none',
                                                color: 'rgba(255,255,255,0.5)',
                                                cursor: 'pointer'
                                            }}
                                        >
                                            🚩
                                        </button>
                                    )}
                                </div>
                            </div>
                            <div className="message-content">
                                {msg.content}
                            </div>
                            {msg.imageUrl && (
    <img 
        src={msg.imageUrl}
        alt="Shared"
        style={{
            maxWidth: '100%',
            maxHeight: '200px',
            borderRadius: '8px',
            marginTop: '8px',
            cursor: 'pointer'
        }}
        onClick={() => setModalImage(msg.imageUrl)}  // Changed this line
    />
)}
                        </div>
                    ))
                ) : (
                    <div style={{textAlign: 'center', opacity: 0.6, padding: '40px'}}>
                        No messages yet. Start the conversation!
                    </div>
                )}
                <div ref={messagesEndRef} />
            </div>
            
            {selectedImage && (
                <div style={{padding: '10px', background: 'rgba(255,255,255,0.1)'}}>
                    📷 {selectedImage.name}
                    <button onClick={() => setSelectedImage(null)}>✕</button>
                </div>
            )}
            
            <div className="chat-input-group">
                <input
                    type="file"
                    id="community-image-input"
                    accept="image/*"
                    style={{display: 'none'}}
                    onChange={handleImageSelect}
                />
                <button onClick={() => document.getElementById('community-image-input').click()}>
                    📷
                </button>
                <input
                    type="text"
                    className="chat-input"
                    placeholder="Type your message..."
                    value={message}
                    onChange={(e) => setMessage(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && handleSend()}
                />
                <button className="send-btn" onClick={handleSend} disabled={uploading}>
                    {uploading ? '...' : 'Send'}
                </button>
            </div>
        </div>
    );
}
        
       // Modal Container Component with ALL modals working
function ModalContainer({ type, onClose, data, handlers }) {
    const [formData, setFormData] = useState({});
    const [morningData, setMorningData] = useState({
        mood: 5,        // Changed from 3 to 5 (middle of 0-10)
        craving: 0,     // Changed from 1 to 0 (start at no cravings)
        sleepQuality: 5,  // Changed from 3 to 5 (middle of 0-10)
        anxietyLevel: 0,  // Changed from 2 to 0 (start at no anxiety)
        notes: ''
    });
    const [eveningData, setEveningData] = useState({
        gratitude: '',
        challenges: '',
        tomorrowGoal: '',
        overallDay: 5   // Changed from 3 to 5 (middle of 0-10)
    });
    const [topicMessage, setTopicMessage] = useState('');
    
    // ADD THESE LINES HERE:
    const [selectedImage, setSelectedImage] = useState(null);
    const [newMessage, setNewMessage] = useState('');
    const [uploading, setUploading] = useState(false);
    
    // Get user from data
    const user = data.user || {};
    
    // Handler functions for topic room
    const handleTopicImageSelect = (e) => {
        const file = e.target.files[0];
        if (file) {
            setSelectedImage(file);
        }
    };
  // In ModalContainer - This is the ONLY handleSendMessage you need
const handleSendMessage = async () => {
    // Allow sending with either text or image
    if (!newMessage.trim() && !selectedImage) return;
    
    setUploading(true);
    try {
        await handlers.sendTopicMessage(newMessage || '', selectedImage);
        setNewMessage('');
        setSelectedImage(null);
        // Clear the file input
        const fileInput = document.querySelector('input[type="file"]');
        if (fileInput) fileInput.value = '';
    } catch (error) {
        console.error('Error sending message:', error);
        showNotification('Failed to send message', 'error');
    } finally {
        setUploading(false);
    }
};

const handleFlagTopicMessage = (msg) => {
    if (handlers.flagMessage) {
        handlers.flagMessage(msg);
    }
};
    
    const renderModalContent = () => {
        switch(type) {
            case 'notifications':
                return ( 
    
                
                            <div className="notification-panel">
                                <h3 style={{marginBottom: '20px'}}>Notifications</h3>
                                {data.notifications.length > 0 ? (
                                    <>
                                        {data.notifications.map(notification => (
                                            <div 
                                                key={notification.id}
                                                className={`notification-item ${!notification.read ? 'unread' : ''}`}
                                                onClick={() => handlers.markNotificationAsRead(notification.id)}
                                            >
                                                <div className="notification-header">
                                                    <span className="notification-type">{notification.type}</span>
                                                    <span className="notification-time">
                                                        {notification.createdAt?.toDate ? 
                                                            new Date(notification.createdAt.toDate()).toLocaleTimeString() :
                                                            'now'}
                                                    </span>
                                                </div>
                                                <div className="notification-message">
                                                    <strong>{notification.title}</strong>
                                                    <div>{notification.message}</div>
                                                </div>
                                            </div>
                                        ))}
                                        {data.notifications.some(n => !n.read) && (
                                            <button 
                                                className="btn-primary"
                                                onClick={handlers.markAllNotificationsAsRead}
                                                style={{marginTop: '15px'}}
                                            >
                                                Mark All as Read
                                            </button>
                                        )}
                                    </>
                                ) : (
                                    <div style={{textAlign: 'center', opacity: 0.6, padding: '40px'}}>
                                        No notifications
                                    </div>
                                )}
                            </div>
                        );
                        
                    case 'checkIn':
    return (
        <div>
            <h3 style={{marginBottom: '20px'}}>Morning Check-in</h3>
            <div className="slider-group">
                <div className="slider-label">
                    <span>Overall Mood</span>
                    <span className="slider-value">{morningData.mood}</span>
                </div>
                <input 
                    type="range"
                    className="slider"
                    min="0" max="10"
                    value={morningData.mood}
                    onChange={(e) => setMorningData({...morningData, mood: parseInt(e.target.value)})}
                />
                <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '12px', color: '#666', marginTop: '5px'}}>
                    <span>0 (Worst)</span>
                    <span>5 (Neutral)</span>
                    <span>10 (Best)</span>
                </div>
            </div>
            
            <div className="slider-group">
                <div className="slider-label">
                    <span>Craving Intensity</span>
                    <span className="slider-value">{morningData.craving}</span>
                </div>
                <input 
                    type="range"
                    className="slider"
                    min="0" max="10"
                    value={morningData.craving}
                    onChange={(e) => setMorningData({...morningData, craving: parseInt(e.target.value)})}
                />
                <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '12px', color: '#666', marginTop: '5px'}}>
                    <span>0 (None)</span>
                    <span>5 (Moderate)</span>
                    <span>10 (Intense)</span>
                </div>
            </div>
            
            <div className="slider-group">
                <div className="slider-label">
                    <span>Sleep Quality</span>
                    <span className="slider-value">{morningData.sleepQuality}</span>
                </div>
                <input 
                    type="range"
                    className="slider"
                    min="0" max="10"
                    value={morningData.sleepQuality}
                    onChange={(e) => setMorningData({...morningData, sleepQuality: parseInt(e.target.value)})}
                />
                <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '12px', color: '#666', marginTop: '5px'}}>
                    <span>0 (Terrible)</span>
                    <span>5 (Fair)</span>
                    <span>10 (Excellent)</span>
                </div>
            </div>
            
            <div className="slider-group">
                <div className="slider-label">
                    <span>Anxiety Level</span>
                    <span className="slider-value">{morningData.anxietyLevel}</span>
                </div>
                <input 
                    type="range"
                    className="slider"
                    min="0" max="10"
                    value={morningData.anxietyLevel}
                    onChange={(e) => setMorningData({...morningData, anxietyLevel: parseInt(e.target.value)})}
                />
                <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '12px', color: '#666', marginTop: '5px'}}>
                    <span>0 (Calm)</span>
                    <span>5 (Moderate)</span>
                    <span>10 (Severe)</span>
                </div>
            </div>
            
            <div className="form-group">
                <label className="form-label">Notes (Optional)</label>
                <textarea 
                    className="textarea"
                    placeholder="Any thoughts or feelings you'd like to share?"
                    value={morningData.notes}
                    onChange={(e) => setMorningData({...morningData, notes: e.target.value})}
                />
            </div>
            
            <button 
                className="btn-primary"
                onClick={async () => {
                    await handlers.handleMorningCheckIn(morningData);
                    onClose();
                }}
            >
                Submit Check-in
            </button>
        </div>
    );

case 'reflection':
    return (
        <div>
            <h3 style={{marginBottom: '20px'}}>Evening Reflection</h3>
            <div className="form-group">
                <label className="form-label">What are you grateful for today?</label>
                <textarea 
                    className="textarea"
                    placeholder="List 3 things you're grateful for..."
                    value={eveningData.gratitude}
                    onChange={(e) => setEveningData({...eveningData, gratitude: e.target.value})}
                />
            </div>
            
            <div className="form-group">
                <label className="form-label">What challenges did you face?</label>
                <textarea 
                    className="textarea"
                    placeholder="Describe any difficulties..."
                    value={eveningData.challenges}
                    onChange={(e) => setEveningData({...eveningData, challenges: e.target.value})}
                />
            </div>
            
            <div className="form-group">
                <label className="form-label">What's one goal for tomorrow?</label>
                <textarea 
                    className="textarea"
                    placeholder="Set an intention..."
                    value={eveningData.tomorrowGoal}
                    onChange={(e) => setEveningData({...eveningData, tomorrowGoal: e.target.value})}
                />
            </div>
            
            <div className="slider-group">
                <div className="slider-label">
                    <span>Overall Day Rating</span>
                    <span className="slider-value">{eveningData.overallDay}</span>
                </div>
                <input 
                    type="range"
                    className="slider"
                    min="0" max="10"
                    value={eveningData.overallDay}
                    onChange={(e) => setEveningData({...eveningData, overallDay: parseInt(e.target.value)})}
                />
                <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '12px', color: '#666', marginTop: '5px'}}>
                    <span>0 (Terrible)</span>
                    <span>5 (OK)</span>
                    <span>10 (Excellent)</span>
                </div>
            </div>
            
            <button 
                className="btn-primary"
                onClick={async () => {
                    await handlers.handleEveningReflection(eveningData);
                    onClose();
                }}
            >
                Submit Reflection
            </button>
        </div>
    );
                        
                  case 'topicRoom':
    return (
        <div> {/* Parent wrapper */}
            <h3 style={{marginBottom: '20px'}}>
                {data.activeTopicRoom?.icon} {data.activeTopicRoom?.name}
            </h3>
            <p style={{opacity: 0.8, marginBottom: '20px'}}>
                {data.activeTopicRoom?.description}
            </p>
            
            {/* Messages container */}
            <div style={{flex: 1, overflowY: 'auto', padding: '15px', height: '300px'}}>
                {data.topicRoomMessages?.map(msg => (
                    <div key={msg.id} style={{
                        background: msg.userId === user.uid ? 
                            'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 
                            'rgba(255,255,255,0.05)',
                        padding: '12px',
                        borderRadius: '12px',
                        marginBottom: '10px'
                    }}>
                        <div style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            marginBottom: '8px'
                        }}>
                            <span style={{fontWeight: 'bold', color: '#f4c430'}}>
                                {msg.senderName || 'Anonymous'}
                            </span>
                            <div style={{display: 'flex', gap: '10px', alignItems: 'center'}}>
                                <span style={{fontSize: '12px', opacity: 0.7, color: 'white'}}>
                                    {msg.createdAt?.toDate ? 
                                        msg.createdAt.toDate().toLocaleTimeString() : 
                                        'sending...'}
                                </span>
                                {msg.userId !== user.uid && (
                                    <button
                                        onClick={() => handleFlagTopicMessage(msg)}
                                        style={{
                                            background: 'transparent',
                                            border: 'none',
                                            color: 'rgba(255,255,255,0.5)',
                                            cursor: 'pointer',
                                            fontSize: '14px',
                                            padding: '2px'
                                        }}
                                        title="Flag inappropriate content"
                                    >
                                        🚩
                                    </button>
                                )}
                            </div>
                        </div>
                        {msg.message && (
                            <p style={{margin: 0, color: 'white', lineHeight: 1.5}}>
                                {msg.message}
                            </p>
                        )}
                        {msg.imageUrl && (
                            <img 
                                src={msg.imageUrl}
                                alt="Shared"
                                style={{
                                    maxWidth: '100%',
                                    maxHeight: '300px',
                                    borderRadius: '8px',
                                    marginTop: '10px',
                                    cursor: 'pointer'
                                }}
                                onClick={() => window.open(msg.imageUrl, '_blank')}
                            />
                        )}
                    </div>
                ))}
            </div>
            
            <div style={{
                padding: '15px',
                borderTop: '1px solid rgba(255,255,255,0.1)'
            }}>
                {selectedImage && (
                    <div style={{
                        marginBottom: '10px',
                        padding: '8px',
                        background: 'rgba(255,255,255,0.1)',
                        borderRadius: '8px',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center'
                    }}>
                        <span style={{color: 'white', fontSize: '14px'}}>
                            📷 {selectedImage.name}
                        </span>
                        <button
                            onClick={() => {
                                setSelectedImage(null);
                                document.getElementById('topic-image-input').value = '';
                            }}
                            style={{
                                background: 'transparent',
                                border: 'none',
                                color: 'white',
                                cursor: 'pointer'
                            }}
                        >
                            ✕
                        </button>
                    </div>
                )}
                <div style={{display: 'flex', gap: '10px'}}>
                    <input
                        type="file"
                        id="topic-image-input"
                        accept="image/*"
                        style={{display: 'none'}}
                        onChange={handleTopicImageSelect}
                    />
                    <button
                        onClick={() => document.getElementById('topic-image-input').click()}
                        style={{
                            background: 'rgba(255,255,255,0.1)',
                            border: 'none',
                            borderRadius: '8px',
                            padding: '10px',
                            color: 'white',
                            cursor: 'pointer'
                        }}
                        disabled={uploading}
                    >
                        📷
                    </button>
                    <input 
                        type="text"
                        value={newMessage}
                        onChange={(e) => setNewMessage(e.target.value)}
                        placeholder="Type a message..."
                        onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                        style={{
                            flex: 1,
                            padding: '10px',
                            background: 'rgba(255,255,255,0.1)',
                            border: 'none',
                            borderRadius: '8px',
                            color: 'white'
                        }}
                    />
                    <button 
                        onClick={handleSendMessage}
                        disabled={uploading || (!newMessage.trim() && !selectedImage)}
                        style={{
                            padding: '10px 20px',
                            background: uploading ? 'gray' : '#f4c430',
                            border: 'none',
                            borderRadius: '8px',
                            color: 'black',
                            fontWeight: 'bold',
                            cursor: uploading ? 'not-allowed' : 'pointer'
                        }}
                    >
                        {uploading ? '...' : 'Send'}
                    </button>
                </div>
            </div>
        </div> 
    ); 
                        
                    case 'account':
                        return (
                            <div>
                                <h3 style={{marginBottom: '20px'}}>Account Settings</h3>
                                <div className="form-group">
                                    <label className="form-label">Display Name</label>
                                    <input 
                                        type="text"
                                        className="form-input"
                                        value={formData.displayName || data.userData?.displayName || ''}
                                        onChange={(e) => setFormData({...formData, displayName: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">First Name</label>
                                    <input 
                                        type="text"
                                        className="form-input"
                                        value={formData.firstName || data.userData?.firstName || ''}
                                        onChange={(e) => setFormData({...formData, firstName: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Last Name</label>
                                    <input 
                                        type="text"
                                        className="form-input"
                                        value={formData.lastName || data.userData?.lastName || ''}
                                        onChange={(e) => setFormData({...formData, lastName: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Phone</label>
                                    <input 
                                        type="tel"
                                        className="form-input"
                                        value={formData.phone || data.userData?.phone || ''}
                                        onChange={(e) => setFormData({...formData, phone: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Street Address</label>
                                    <input 
                                        type="text"
                                        className="form-input"
                                        value={formData.street || data.userData?.address?.street || ''}
                                        onChange={(e) => setFormData({...formData, street: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">City</label>
                                    <input 
                                        type="text"
                                        className="form-input"
                                        value={formData.city || data.userData?.address?.city || ''}
                                        onChange={(e) => setFormData({...formData, city: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">State</label>
                                    <input 
                                        type="text"
                                        className="form-input"
                                        value={formData.state || data.userData?.address?.state || ''}
                                        onChange={(e) => setFormData({...formData, state: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">ZIP</label>
                                    <input 
                                        type="text"
                                        className="form-input"
                                        value={formData.zip || data.userData?.address?.zip || ''}
                                        onChange={(e) => setFormData({...formData, zip: e.target.value})}
                                    />
                                </div>
                                <button 
                                    className="btn-primary"
                                    onClick={async () => {
                                        try {
                                            const updates = {
                                                ...formData,
                                                address: {
                                                    street: formData.street,
                                                    city: formData.city,
                                                    state: formData.state,
                                                    zip: formData.zip
                                                }
                                            };
                                            await db.collection('users').doc(data.user.uid).update(updates);
                                            alert('Settings updated!');
                                            onClose();
                                        } catch (error) {
                                            alert('Failed to update settings');
                                        }
                                    }}
                                >
                                    Save Changes
                                </button>
                            </div>
                        );
                        
                    case 'emergency':
                        return (
                            <div>
                                <h3 style={{marginBottom: '20px'}}>Emergency Contacts</h3>
                                {data.userData?.emergencyContacts?.map((contact, index) => (
                                    <div key={index} style={{
                                        background: 'rgba(255,255,255,0.1)',
                                        borderRadius: '10px',
                                        padding: '15px',
                                        marginBottom: '10px'
                                    }}>
                                        <div style={{fontWeight: 'bold'}}>{contact.name}</div>
                                        <div>{contact.phone}</div>
                                        <div style={{opacity: 0.8, fontSize: '14px'}}>{contact.relationship}</div>
                                    </div>
                                ))}
                                
                                <h4 style={{marginTop: '20px', marginBottom: '15px'}}>Add New Contact</h4>
                                <div className="form-group">
                                    <input 
                                        type="text"
                                        className="form-input"
                                        placeholder="Name"
                                        value={formData.contactName || ''}
                                        onChange={(e) => setFormData({...formData, contactName: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <input 
                                        type="tel"
                                        className="form-input"
                                        placeholder="Phone"
                                        value={formData.contactPhone || ''}
                                        onChange={(e) => setFormData({...formData, contactPhone: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <input 
                                        type="text"
                                        className="form-input"
                                        placeholder="Relationship"
                                        value={formData.contactRelationship || ''}
                                        onChange={(e) => setFormData({...formData, contactRelationship: e.target.value})}
                                    />
                                </div>
                                <button 
                                    className="btn-primary"
                                    onClick={async () => {
                                        const newContact = {
                                            name: formData.contactName,
                                            phone: formData.contactPhone,
                                            relationship: formData.contactRelationship
                                        };
                                        const contacts = data.userData?.emergencyContacts || [];
                                        contacts.push(newContact);
                                        try {
                                            await db.collection('users').doc(data.user.uid).update({
                                                emergencyContacts: contacts
                                            });
                                            alert('Emergency contact added');
                                            onClose();
                                        } catch (error) {
                                            alert('Failed to add contact');
                                        }
                                    }}
                                >
                                    Add Contact
                                </button>
                            </div>
                        );
                        
                    case 'profilePrompt':
                        return (
                            <div>
                                <h3 style={{marginBottom: '20px'}}>Complete Your Profile</h3>
                                <p style={{marginBottom: '20px', opacity: 0.9}}>
                                    Help us personalize your recovery journey by completing your profile.
                                </p>
                                <button 
                                    className="btn-primary"
                                    onClick={() => {
                                        onClose();
                                        setTimeout(() => setShowModal('account'), 100);
                                    }}
                                >
                                    Complete Profile
                                </button>
                                <button 
                                    style={{
                                        background: 'transparent',
                                        border: '1px solid rgba(255,255,255,0.3)',
                                        color: 'white',
                                        padding: '10px',
                                        borderRadius: '10px',
                                        width: '100%',
                                        marginTop: '10px',
                                        cursor: 'pointer'
                                    }}
                                    onClick={onClose}
                                >
                                    Remind Me Later
                                </button>
                            </div>
                        );
                        // Enhanced Modal Cases for ModalContainer
        // PERSONAL INFORMATION MODAL
case 'personalInfo':
    return (
        <div>
            <h3 style={{marginBottom: '20px'}}>Personal Information</h3>
            <div className="form-group">
                <label className="form-label">First Name</label>
                <input 
                    type="text"
                    className="form-input"
                    value={formData.firstName || data.userData?.firstName || ''}
                    onChange={(e) => setFormData({...formData, firstName: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">Last Name</label>
                <input 
                    type="text"
                    className="form-input"
                    value={formData.lastName || data.userData?.lastName || ''}
                    onChange={(e) => setFormData({...formData, lastName: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">Display Name</label>
                <input 
                    type="text"
                    className="form-input"
                    value={formData.displayName || data.userData?.displayName || ''}
                    onChange={(e) => setFormData({...formData, displayName: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">Phone</label>
                <input 
                    type="tel"
                    className="form-input"
                    value={formData.phone || data.userData?.phone || ''}
                    onChange={(e) => setFormData({...formData, phone: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">Date of Birth</label>
                <input 
                    type="date"
                    className="form-input"
                    value={formData.dateOfBirth || data.userData?.dateOfBirth || ''}
                    onChange={(e) => setFormData({...formData, dateOfBirth: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">Gender</label>
                <select 
                    className="form-select"
                    value={formData.gender || data.userData?.gender || ''}
                    onChange={(e) => setFormData({...formData, gender: e.target.value})}
                >
                    <option value="">Select Gender</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="non-binary">Non-Binary</option>
                    <option value="prefer-not">Prefer Not to Say</option>
                </select>
            </div>
            <div className="form-group">
                <label className="form-label">Street Address</label>
                <input 
                    type="text"
                    className="form-input"
                    value={formData.street || data.userData?.address?.street || ''}
                    onChange={(e) => setFormData({...formData, street: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">City</label>
                <input 
                    type="text"
                    className="form-input"
                    value={formData.city || data.userData?.address?.city || ''}
                    onChange={(e) => setFormData({...formData, city: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">State</label>
                <input 
                    type="text"
                    className="form-input"
                    value={formData.state || data.userData?.address?.state || ''}
                    onChange={(e) => setFormData({...formData, state: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">ZIP Code</label>
                <input 
                    type="text"
                    className="form-input"
                    value={formData.zip || data.userData?.address?.zip || ''}
                    onChange={(e) => setFormData({...formData, zip: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">Insurance Provider (Optional)</label>
                <input 
                    type="text"
                    className="form-input"
                    value={formData.insurance || data.userData?.insurance || ''}
                    onChange={(e) => setFormData({...formData, insurance: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">Insurance ID (Optional)</label>
                <input 
                    type="text"
                    className="form-input"
                    value={formData.insuranceId || data.userData?.insuranceId || ''}
                    onChange={(e) => setFormData({...formData, insuranceId: e.target.value})}
                />
            </div>
            <button 
                className="btn-primary"
                onClick={async () => {
                    try {
                        // Build update object with proper validation
                        const updates = {};
                        
                        // Handle simple fields - only add if they have values
                        if (formData.firstName !== undefined && formData.firstName !== '') {
                            updates.firstName = formData.firstName;
                        }
                        if (formData.lastName !== undefined && formData.lastName !== '') {
                            updates.lastName = formData.lastName;
                        }
                        if (formData.displayName !== undefined && formData.displayName !== '') {
                            updates.displayName = formData.displayName;
                        }
                        if (formData.phone !== undefined && formData.phone !== '') {
                            updates.phone = formData.phone;
                        }
                        if (formData.dateOfBirth !== undefined && formData.dateOfBirth !== '') {
                            updates.dateOfBirth = formData.dateOfBirth;
                        }
                        if (formData.gender !== undefined && formData.gender !== '') {
                            updates.gender = formData.gender;
                        }
                        if (formData.insurance !== undefined && formData.insurance !== '') {
                            updates.insurance = formData.insurance;
                        }
                        if (formData.insuranceId !== undefined && formData.insuranceId !== '') {
                            updates.insuranceId = formData.insuranceId;
                        }
                        
                        // Handle address as a nested object - CRITICAL for admin.html sync
                        // Only update address if at least one field is provided
                        const addressFields = ['street', 'city', 'state', 'zip'];
                        const hasAddressData = addressFields.some(field => 
                            formData[field] !== undefined && formData[field] !== ''
                        );
                        
                        if (hasAddressData) {
                            // Get existing address to merge with
                            const userDoc = await db.collection('users').doc(data.user.uid).get();
                            const existingAddress = userDoc.data()?.address || {};
                            
                            updates.address = {
                                street: formData.street !== undefined ? formData.street : (existingAddress.street || ''),
                                city: formData.city !== undefined ? formData.city : (existingAddress.city || ''),
                                state: formData.state !== undefined ? formData.state : (existingAddress.state || ''),
                                zip: formData.zip !== undefined ? formData.zip : (existingAddress.zip || '')
                            };
                        }
                        
                        // Add timestamp
                        updates.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                        
                        // Only proceed if there are updates to make
                        if (Object.keys(updates).length === 1) { // Only updatedAt
                            alert('No changes to save');
                            return;
                        }
                        
                        // Perform the update
                        await db.collection('users').doc(data.user.uid).update(updates);
                        
                        // Log what was saved for debugging
                        console.log('Saved fields:', Object.keys(updates));
                        
                        // Update local userData to reflect changes immediately
                        const updatedUserDoc = await db.collection('users').doc(data.user.uid).get();
                        if (data.setUserData) {
                            data.setUserData(updatedUserDoc.data());
                        }
                        
                        // Provide specific feedback
                        const savedFields = Object.keys(updates).filter(k => k !== 'updatedAt');
                        alert(`Successfully updated: ${savedFields.join(', ')}`);
                        
                        onClose();
                    } catch (error) {
                        console.error('Save error details:', error);
                        
                        // Provide specific error feedback
                        if (error.code === 'permission-denied') {
                            alert('Permission denied. Please try logging out and back in.');
                        } else if (error.code === 'not-found') {
                            alert('User record not found. Please contact support.');
                        } else {
                            alert(`Failed to update information: ${error.message}`);
                        }
                    }
                }}
            >
                Save Changes
            </button>
        </div>
    );
            
        // RECOVERY INFO MODAL
case 'recoveryInfo':
    return (
        <div>
            <h3 style={{marginBottom: '20px'}}>Recovery Settings</h3>
            <div className="form-group">
                <label className="form-label">
                    Sobriety Date & Time
                    <small style={{display: 'block', opacity: 0.8, marginTop: '5px', fontSize: '12px'}}>
                        Enter the date and time 24 hours after your last use
                    </small>
                </label>
                <input 
                    type="datetime-local"
                    className="form-input"
                    value={formData.sobrietyDateTime || 
                           (data.userData?.sobrietyDate ? 
                            new Date(data.userData.sobrietyDate).toISOString().slice(0, 16) : '')}
                    onChange={(e) => setFormData({...formData, sobrietyDateTime: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">Primary Substance</label>
                <select 
                    className="form-select"
                    value={formData.substance || data.userData?.substance || ''}
                    onChange={(e) => setFormData({...formData, substance: e.target.value})}
                >
                    <option value="">Select Substance</option>
                    <option value="alcohol">Alcohol</option>
                    <option value="opioids">Opioids</option>
                    <option value="stimulants">Stimulants</option>
                    <option value="cannabis">Cannabis</option>
                    <option value="benzodiazepines">Benzodiazepines</option>
                    <option value="multiple">Multiple Substances</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div className="form-group">
                <label className="form-label">Daily Cost of Use ($)</label>
                <input 
                    type="number"
                    className="form-input"
                    placeholder="Amount spent per day (e.g., 20)"
                    value={formData.dailyCost || data.userData?.dailyCost || ''}
                    onChange={(e) => setFormData({...formData, dailyCost: parseFloat(e.target.value)})}
                />
                <small style={{color: 'rgba(255,255,255,0.6)', display: 'block', marginTop: '5px'}}>
                    Used to calculate money saved in recovery
                </small>
            </div>
            
            <div className="form-group">
                <label className="form-label">Sponsor Name (Optional)</label>
                <input 
                    type="text"
                    className="form-input"
                    value={formData.sponsorName || data.userData?.sponsorName || ''}
                    onChange={(e) => setFormData({...formData, sponsorName: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">Sponsor Phone (Optional)</label>
                <input 
                    type="tel"
                    className="form-input"
                    value={formData.sponsorPhone || data.userData?.sponsorPhone || ''}
                    onChange={(e) => setFormData({...formData, sponsorPhone: e.target.value})}
                />
            </div>
            <button 
                className="btn-primary"
                onClick={async () => {
                    try {
                        const updates = {};
                        
                        // Convert datetime-local to ISO string for consistent storage
                        if (formData.sobrietyDateTime) {
                            const sobrietyDate = new Date(formData.sobrietyDateTime);
                            updates.sobrietyDate = sobrietyDate.toISOString();
                        }
                        
                        // Only add fields that have values
                        if (formData.substance !== undefined && formData.substance !== '') {
                            updates.substance = formData.substance;
                        }
                        if (formData.dailyCost !== undefined && formData.dailyCost !== '') {
                            updates.dailyCost = parseFloat(formData.dailyCost);
                        }
                        if (formData.sponsorName !== undefined && formData.sponsorName !== '') {
                            updates.sponsorName = formData.sponsorName;
                        }
                        if (formData.sponsorPhone !== undefined && formData.sponsorPhone !== '') {
                            updates.sponsorPhone = formData.sponsorPhone;
                        }
                        
                        // Add timestamp
                        updates.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                        
                        // Only proceed if there are updates
                        if (Object.keys(updates).length === 1) { // Only has updatedAt
                            alert('No changes to save');
                            return;
                        }
                        
                        // Update Firestore
                        await db.collection('users').doc(data.user.uid).update(updates);
                        
                        // Reload user data to reflect changes
                        const updatedDoc = await db.collection('users').doc(data.user.uid).get();
                        if (data.setUserData) {
                            data.setUserData(updatedDoc.data());
                            
                            // Recalculate sobriety days if date was updated
                            if (updates.sobrietyDate) {
                                const sobrietyDate = new Date(updates.sobrietyDate);
                                const today = new Date();
                                const diffTime = today - sobrietyDate;
                                const sobrietyDays = window.getSobrietyDays(userData.sobrietyDate);
                                if (data.setSobrietyDays) {
                                    data.setSobrietyDays(diffDays >= 0 ? diffDays : 0);
                                }
                                
                                // Recalculate money saved
                                if (data.setMoneySaved && updatedDoc.data().dailyCost) {
                                    data.setMoneySaved((diffDays * updatedDoc.data().dailyCost).toFixed(2));
                                }
                            }
                        }
                        
                        alert('Recovery settings updated!');
                        onClose();
                    } catch (error) {
                        console.error('Error saving recovery settings:', error);
                        alert('Failed to update settings: ' + error.message);
                    }
                }}
            >
                Save Changes
            </button>
        </div>
    );
            
        // PASSWORD & SECURITY MODAL
        case 'password':
            return (
                <div>
                    <h3 style={{marginBottom: '20px'}}>Password & Security</h3>
                    <div className="form-group">
                        <label className="form-label">Current Password</label>
                        <input 
                            type="password"
                            className="form-input"
                            value={formData.currentPassword || ''}
                            onChange={(e) => setFormData({...formData, currentPassword: e.target.value})}
                        />
                    </div>
                    <div className="form-group">
                        <label className="form-label">New Password</label>
                        <input 
                            type="password"
                            className="form-input"
                            value={formData.newPassword || ''}
                            onChange={(e) => setFormData({...formData, newPassword: e.target.value})}
                        />
                    </div>
                    <div className="form-group">
                        <label className="form-label">Confirm New Password</label>
                        <input 
                            type="password"
                            className="form-input"
                            value={formData.confirmPassword || ''}
                            onChange={(e) => setFormData({...formData, confirmPassword: e.target.value})}
                        />
                    </div>
                    <button 
                        className="btn-primary"
                        onClick={async () => {
                            if (formData.newPassword !== formData.confirmPassword) {
                                alert('Passwords do not match');
                                return;
                            }
                            try {
                                const credential = firebase.auth.EmailAuthProvider.credential(
                                    data.user.email,
                                    formData.currentPassword
                                );
                                await data.user.reauthenticateWithCredential(credential);
                                await data.user.updatePassword(formData.newPassword);
                                alert('Password updated successfully!');
                                onClose();
                            } catch (error) {
                                alert('Failed to update password. Check current password.');
                            }
                        }}
                    >
                        Update Password
                    </button>
                    
                    <div style={{marginTop: '30px', paddingTop: '20px', borderTop: '1px solid rgba(255,255,255,0.1)'}}>
                        <h4 style={{marginBottom: '15px'}}>Two-Factor Authentication</h4>
                        <p style={{fontSize: '14px', opacity: 0.8, marginBottom: '15px'}}>
                            Add an extra layer of security to your account
                        </p>
                        <button className="btn-primary" style={{background: 'rgba(76, 175, 80, 0.2)', border: '1px solid #4CAF50'}}>
                            Enable 2FA (Coming Soon)
                        </button>
                    </div>
                </div>
            );
            
        // NOTIFICATION SETTINGS MODAL
        case 'notificationSettings':
            return (
                <div>
                    <h3 style={{marginBottom: '20px'}}>Notification Settings</h3>
                    
                    <h4 style={{marginBottom: '15px', color: '#f4c430'}}>Daily Reminders</h4>
                    <div className="form-group">
                        <label className="form-label">Morning Check-in Time</label>
                        <input 
                            type="time"
                            className="form-input"
                            value={formData.morningCheckInTime || data.userData?.notifications?.morningCheckIn || '08:00'}
                            onChange={(e) => setFormData({...formData, morningCheckInTime: e.target.value})}
                        />
                    </div>
                    <div className="form-group">
                        <label className="form-label">Evening Reflection Time</label>
                        <input 
                            type="time"
                            className="form-input"
                            value={formData.eveningReflectionTime || data.userData?.notifications?.eveningReflection || '20:00'}
                            onChange={(e) => setFormData({...formData, eveningReflectionTime: e.target.value})}
                        />
                    </div>
                    <div className="form-group">
                        <label className="form-label">Daily Pledge Reminder</label>
                        <input 
                            type="time"
                            className="form-input"
                            value={formData.pledgeTime || data.userData?.notifications?.dailyPledge || '09:00'}
                            onChange={(e) => setFormData({...formData, pledgeTime: e.target.value})}
                        />
                    </div>
                    
                    <h4 style={{marginBottom: '15px', marginTop: '25px', color: '#f4c430'}}>Alert Preferences</h4>
                    <div style={{display: 'flex', flexDirection: 'column', gap: '15px'}}>
                        <label style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                            <input 
                                type="checkbox"
                                checked={formData.assignmentAlerts !== false}
                                onChange={(e) => setFormData({...formData, assignmentAlerts: e.target.checked})}
                            />
                            Assignment due date reminders
                        </label>
                        <label style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                            <input 
                                type="checkbox"
                                checked={formData.milestoneAlerts !== false}
                                onChange={(e) => setFormData({...formData, milestoneAlerts: e.target.checked})}
                            />
                            Milestone celebration alerts
                        </label>
                        <label style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                            <input 
                                type="checkbox"
                                checked={formData.messageAlerts !== false}
                                onChange={(e) => setFormData({...formData, messageAlerts: e.target.checked})}
                            />
                            New message notifications
                        </label>
                        <label style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                            <input 
                                type="checkbox"
                                checked={formData.missedCheckInAlerts !== false}
                                onChange={(e) => setFormData({...formData, missedCheckInAlerts: e.target.checked})}
                            />
                            Missed check-in reminders
                        </label>
                    </div>
                    
                    <h4 style={{marginBottom: '15px', marginTop: '25px', color: '#f4c430'}}>Time Zone</h4>
                    <div className="form-group">
                        <select 
                            className="form-select"
                            value={formData.timezone || data.userData?.timezone || 'America/Los_Angeles'}
                            onChange={(e) => setFormData({...formData, timezone: e.target.value})}
                        >
                            <option value="America/Los_Angeles">Pacific Time</option>
                            <option value="America/Denver">Mountain Time</option>
                            <option value="America/Chicago">Central Time</option>
                            <option value="America/New_York">Eastern Time</option>
                            <option value="America/Phoenix">Arizona</option>
                            <option value="Pacific/Honolulu">Hawaii</option>
                            <option value="America/Anchorage">Alaska</option>
                        </select>
                    </div>
                    
                    <button 
                        className="btn-primary"
                        onClick={async () => {
                            try {
                                await db.collection('users').doc(data.user.uid).update({
                                    notifications: {
                                        morningCheckIn: formData.morningCheckInTime,
                                        eveningReflection: formData.eveningReflectionTime,
                                        dailyPledge: formData.pledgeTime,
                                        assignmentAlerts: formData.assignmentAlerts,
                                        milestoneAlerts: formData.milestoneAlerts,
                                        messageAlerts: formData.messageAlerts,
                                        missedCheckInAlerts: formData.missedCheckInAlerts
                                    },
                                    timezone: formData.timezone
                                });
                                alert('Notification settings updated!');
                                onClose();
                            } catch (error) {
                                alert('Failed to update settings');
                            }
                        }}
                    >
                        Save Settings
                    </button>
                </div>
            );
            
        
            
        // HELP & SUPPORT MODAL
        case 'help':
            return (
                <div>
                    <h3 style={{marginBottom: '20px'}}>Help & Support</h3>
                    
                    <div style={{
                        background: 'rgba(244, 196, 48, 0.1)',
                        border: '1px solid rgba(244, 196, 48, 0.3)',
                        borderRadius: '10px',
                        padding: '15px',
                        marginBottom: '20px'
                    }}>
                        <h4 style={{color: '#f4c430', marginBottom: '10px'}}>Need Immediate Help?</h4>
                        <div style={{marginBottom: '10px'}}>
                            <strong>Crisis Line:</strong> <a href="tel:988" style={{color: '#f4c430'}}>988</a>
                        </div>
                        <div>
                            <strong>SAMHSA Helpline:</strong> <a href="tel:1-800-662-4357" style={{color: '#f4c430'}}>1-800-662-HELP</a>
                        </div>
                    </div>
                    
                    <h4 style={{marginBottom: '15px'}}>Contact Support</h4>
                    <div style={{marginBottom: '15px'}}>
                        <strong>Email:</strong> info@glrecoveryservices.com
                    </div>
                    <div style={{marginBottom: '15px'}}>
                        <strong>Phone:</strong> Contact Your Coach
                    </div>
                    <div style={{marginBottom: '20px'}}>
                        <strong>Hours:</strong> Monday - Friday, 9am - 5pm PST
                    </div>
                    
                    <h4 style={{marginBottom: '15px'}}>Frequently Asked Questions</h4>
                    <div style={{display: 'flex', flexDirection: 'column', gap: '15px'}}>
                        <details style={{cursor: 'pointer'}}>
                            <summary style={{fontWeight: 'bold', marginBottom: '5px'}}>How do I complete a check-in?</summary>
                            <p style={{fontSize: '14px', opacity: 0.8, paddingLeft: '15px'}}>
                                Navigate to the Tasks tab and tap on Morning Check-in or Evening Reflection.
                            </p>
                        </details>
                        <details style={{cursor: 'pointer'}}>
                            <summary style={{fontWeight: 'bold', marginBottom: '5px'}}>How do I contact my coach?</summary>
                            <p style={{fontSize: '14px', opacity: 0.8, paddingLeft: '15px'}}>
                                Your coach's contact information is displayed in your profile. You can call or message them directly.
                            </p>
                        </details>
                        <details style={{cursor: 'pointer'}}>
                            <summary style={{fontWeight: 'bold', marginBottom: '5px'}}>What if I miss a check-in?</summary>
                            <p style={{fontSize: '14px', opacity: 0.8, paddingLeft: '15px'}}>
                                Missing occasional check-ins is okay. Focus on building consistency over time. Your coach will be notified of patterns.
                            </p>
                        </details>
                    </div>
                    
                    <button className="btn-primary" style={{marginTop: '20px'}} onClick={onClose}>
                        Close
                    </button>
                </div>
            );
            
        // FEEDBACK MODAL
        case 'feedback':
            return (
                <div>
                    <h3 style={{marginBottom: '20px'}}>Send Feedback</h3>
                    <p style={{fontSize: '14px', opacity: 0.8, marginBottom: '20px'}}>
                        Your feedback helps us improve the recovery experience for everyone.
                    </p>
                    <div className="form-group">
                        <label className="form-label">Feedback Type</label>
                        <select 
                            className="form-select"
                            value={formData.feedbackType || ''}
                            onChange={(e) => setFormData({...formData, feedbackType: e.target.value})}
                        >
                            <option value="">Select Type</option>
                            <option value="bug">Bug Report</option>
                            <option value="feature">Feature Request</option>
                            <option value="praise">Positive Feedback</option>
                            <option value="concern">Concern</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div className="form-group">
                        <label className="form-label">Your Feedback</label>
                        <textarea 
                            className="textarea"
                            placeholder="Tell us what's on your mind..."
                            value={formData.feedbackText || ''}
                            onChange={(e) => setFormData({...formData, feedbackText: e.target.value})}
                            style={{minHeight: '150px'}}
                        />
                    </div>
                    <button 
                        className="btn-primary"
                        onClick={async () => {
                            if (!formData.feedbackType || !formData.feedbackText) {
                                alert('Please select a type and enter feedback');
                                return;
                            }
                            try {
                                await db.collection('feedback').add({
                                    userId: data.user.uid,
                                    userName: data.userData?.displayName || data.userData?.firstName || 'Anonymous',
                                    type: formData.feedbackType,
                                    message: formData.feedbackText,
                                    status: 'new',
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                alert('Thank you for your feedback!');
                                onClose();
                            } catch (error) {
                                alert('Failed to send feedback');
                            }
                        }}
                    >
                        Send Feedback
                    </button>
                </div>
            );
            
        // EXPORT DATA MODAL
        case 'export':
            return (
                <div>
                    <h3 style={{marginBottom: '20px'}}>Export Your Data</h3>
                    <p style={{fontSize: '14px', opacity: 0.8, marginBottom: '20px'}}>
                        Download all your recovery data in your preferred format.
                    </p>
                    <div style={{display: 'flex', flexDirection: 'column', gap: '10px'}}>
                        <button 
                            className="btn-primary"
                            onClick={() => handlers.exportDataAsJSON()}
                        >
                            📥 Export as JSON (Technical Format)
                        </button>
                        <button 
                            className="btn-primary"
                            onClick={() => handlers.exportDataAsPDF()}
                        >
                            📄 Export as PDF (Report Format)
                        </button>
                    </div>
                    <small style={{display: 'block', marginTop: '20px', opacity: 0.6}}>
                        Your export will include all check-ins, goals, assignments, and progress data.
                    </small>
                </div>
            );
            
        // DELETE ACCOUNT MODAL
        case 'deleteAccount':
            return (
                <div>
                    <h3 style={{marginBottom: '20px', color: '#ff4757'}}>Delete Account</h3>
                    <div style={{
                        background: 'rgba(255, 71, 87, 0.1)',
                        border: '1px solid rgba(255, 71, 87, 0.3)',
                        borderRadius: '10px',
                        padding: '15px',
                        marginBottom: '20px'
                    }}>
                        <strong>⚠️ This action cannot be undone!</strong>
                        <p style={{marginTop: '10px', fontSize: '14px'}}>
                            Deleting your account will permanently remove:
                        </p>
                        <ul style={{fontSize: '14px', marginTop: '10px', paddingLeft: '20px'}}>
                            <li>All your check-ins and progress data</li>
                            <li>Goals and assignments</li>
                            <li>Messages and community posts</li>
                            <li>Your profile and settings</li>
                        </ul>
                    </div>
                    <div className="form-group">
                        <label className="form-label">Type "DELETE" to confirm:</label>
                        <input 
                            type="text"
                            className="form-input"
                            placeholder="Type DELETE"
                            value={formData.deleteConfirm || ''}
                            onChange={(e) => setFormData({...formData, deleteConfirm: e.target.value})}
                        />
                    </div>
                    <button 
                        className="btn-danger"
                        disabled={formData.deleteConfirm !== 'DELETE'}
                        onClick={async () => {
                            if (confirm('Are you absolutely sure? This cannot be undone.')) {
                                try {
                                    await db.collection('users').doc(data.user.uid).update({
                                        deleted: true,
                                        deletedAt: firebase.firestore.FieldValue.serverTimestamp()
                                    });
                                    await auth.currentUser.delete();
                                    alert('Account deleted. We wish you the best in your recovery journey.');
                                } catch (error) {
                                    alert('Failed to delete account. You may need to sign in again.');
                                }
                            }
                        }}
                    >
                        Permanently Delete Account
                    </button>
                    <button 
                        style={{
                            width: '100%',
                            padding: '14px',
                            background: 'transparent',
                            border: '1px solid rgba(255,255,255,0.3)',
                            borderRadius: '10px',
                            color: 'white',
                            cursor: 'pointer',
                            marginTop: '10px'
                        }}
                        onClick={onClose}
                    >
                        Cancel
                    </button>
                </div>
            );
            
        // TERMS OF SERVICE MODAL
        case 'terms':
            return (
                <div>
                    <h3 style={{marginBottom: '20px'}}>Terms of Service</h3>
                    <div style={{fontSize: '14px', lineHeight: '1.6', opacity: 0.9}}>
                        <h4 style={{marginTop: '15px', marginBottom: '10px'}}>1. Acceptance of Terms</h4>
                        <p>By using GLRS Recovery Services, you agree to these terms.</p>
                        
                        <h4 style={{marginTop: '15px', marginBottom: '10px'}}>2. Service Description</h4>
                        <p>GLRS provides recovery coaching and support services. We are not a medical provider.</p>
                        
                        <h4 style={{marginTop: '15px', marginBottom: '10px'}}>3. User Responsibilities</h4>
                        <p>You are responsible for maintaining the confidentiality of your account.</p>
                        
                        <h4 style={{marginTop: '15px', marginBottom: '10px'}}>4. Privacy</h4>
                        <p>Your use of our services is also governed by our Privacy Policy.</p>
                        
                        <h4 style={{marginTop: '15px', marginBottom: '10px'}}>5. Disclaimers</h4>
                        <p>Our services are not a substitute for medical treatment or professional therapy.</p>
                    </div>
                    <button className="btn-primary" style={{marginTop: '20px'}} onClick={onClose}>
                        I Understand
                    </button>
                </div>
            );
            
        // PRIVACY POLICY MODAL
        case 'privacy_policy':
            return (
                <div>
                    <h3 style={{marginBottom: '20px'}}>Privacy Policy</h3>
                    <div style={{fontSize: '14px', lineHeight: '1.6', opacity: 0.9}}>
                        <h4 style={{marginTop: '15px', marginBottom: '10px'}}>Information We Collect</h4>
                        <p>We collect information you provide directly, including recovery data and personal information.</p>
                        
                        <h4 style={{marginTop: '15px', marginBottom: '10px'}}>How We Use Your Information</h4>
                        <p>Your data is used to provide recovery support services and track your progress.</p>
                        
                        <h4 style={{marginTop: '15px', marginBottom: '10px'}}>Data Protection</h4>
                        <p>We implement appropriate security measures to protect your information.</p>
                        
                        <h4 style={{marginTop: '15px', marginBottom: '10px'}}>Your Rights</h4>
                        <p>You have the right to access, update, or delete your personal information.</p>
                    </div>
                    <button className="btn-primary" style={{marginTop: '20px'}} onClick={onClose}>
                        Close
                    </button>
                </div>
            );
            
        // ABOUT MODAL
        case 'about':
            return (
                <div>
                    <h3 style={{marginBottom: '20px'}}>About GLRS</h3>
                    <div style={{textAlign: 'center', marginBottom: '20px'}}>
                        <LighthouseLogo size={80} />
                    </div>
                    <div style={{fontSize: '14px', lineHeight: '1.6', opacity: 0.9}}>
                        <p style={{marginBottom: '15px'}}>
                            <strong>Guiding Light Recovery Services</strong>
                        </p>
                        <p style={{marginBottom: '15px'}}>
                            Version 1.0.0
                        </p>
                        <p style={{marginBottom: '15px'}}>
                            GLRS Recovery Connect is a comprehensive recovery support platform designed to help individuals 
                            maintain their sobriety journey with daily check-ins, goal tracking, and coach support.
                        </p>
                        <p style={{marginBottom: '15px'}}>
                            © 2024 Guiding Light Recovery Services. All rights reserved.
                        </p>
                    </div>
                    <button className="btn-primary" style={{marginTop: '20px'}} onClick={onClose}>
                        Close
                    </button>
                </div>
            );
                        
                    default:
                        return <div>Content not available</div>;
                }
            };
            
           return (
    <div className="modal-overlay" onClick={(e) => e.target === e.currentTarget && onClose()}>
        <div className="modal-content">
            <div className="modal-header">
                <h2 className="modal-title">{type === 'notifications' ? 'Notifications' : ''}</h2>
                <button className="close-btn" onClick={onClose}>×</button>
            </div>
            <div className="modal-body">
                {renderModalContent()}
            </div>
        </div>
    </div>
);
}

// Render the app
ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
