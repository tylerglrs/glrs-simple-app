<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Recovery Compass</title>
    <link rel="icon" type="image/png" sizes="32x32" href="glrs-logo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="glrs-logo.png">
    <link rel="apple-touch-icon" href="glrs-logo.png">

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- Google Identity Services - FOR CALENDAR INTEGRATION -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chart.js for Progress Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>

    <!-- jsPDF for Exporting Reports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* Design Tokens - Colors */
            --color-primary: #069494;
            --color-primary-light: #40E0D0;
            --color-primary-dark: #057575;
            --color-secondary: #5795A7;
            --color-secondary-light: #89B8CA;
            --color-accent: #FF8559;
            --color-accent-light: #FFB399;
            --color-success: #2ECC71;
            --color-warning: #F39C12;
            --color-error: #E74C3C;
            --color-info: #3498DB;

            /* Neutrals */
            --color-text-primary: #2C3E50;
            --color-text-secondary: #7F8C8D;
            --color-text-tertiary: #95A5A6;
            --color-bg: #FFFFFF;
            --color-bg-alt: #F8F9FA;
            --color-bg-dark: #E9ECEF;
            --color-border: #E5E7EB;

            /* Spacing (8px grid) */
            --space-1: 0.25rem;  /* 4px */
            --space-2: 0.5rem;   /* 8px */
            --space-3: 0.75rem;  /* 12px */
            --space-4: 1rem;     /* 16px */
            --space-6: 1.5rem;   /* 24px */
            --space-8: 2rem;     /* 32px */
            --space-12: 3rem;    /* 48px */

            /* Typography */
            --font-xs: 0.75rem;      /* 12px */
            --font-sm: 0.875rem;     /* 14px */
            --font-base: 1rem;       /* 16px */
            --font-lg: 1.125rem;     /* 18px */
            --font-xl: 1.25rem;      /* 20px */
            --font-2xl: 1.5rem;      /* 24px */
            --font-3xl: 2.25rem;     /* 36px */

            /* Border Radius */
            --radius-sm: 0.25rem;  /* 4px */
            --radius-md: 0.5rem;   /* 8px */
            --radius-lg: 0.75rem;  /* 12px */
            --radius-xl: 1rem;     /* 16px */

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);

            /* Gradients */
            --gradient-primary: linear-gradient(135deg, #069494 0%, #5795A7 100%);
            --gradient-accent: linear-gradient(135deg, #FF8559 0%, #FFB399 100%);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--gradient-primary);
            min-height: 100vh;
            color: white;
            position: relative;
            overflow-x: hidden;
        }
        
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: var(--space-4);
            background: var(--gradient-primary);
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .logo-container {
            margin-bottom: 20px;
        }
        
        .lighthouse-logo {
            width: 100px;
            height: 100px;
            margin: 0 auto;
        }
        
        .app-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
            color: white;
        }

        /* Lucide Icon Color Classes */
        [data-lucide] {
            stroke: currentColor;
        }

        .icon-primary {
            color: var(--color-primary);
        }

        .icon-success {
            color: var(--color-success);
        }

        .icon-warning {
            color: var(--color-warning);
        }

        .icon-accent {
            color: var(--color-accent);
        }
        
        .app-subtitle {
            font-size: var(--font-base);
            opacity: 0.8;
            margin-bottom: var(--space-8);
            color: var(--color-primary-light);
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 16px;
        }
        
        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .btn-primary {
            width: 100%;
            min-height: 48px;
            padding: var(--space-3) var(--space-4);
            border: none;
            border-radius: var(--radius-md);
            background: var(--gradient-accent);
            color: white;
            font-size: var(--font-base);
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary.completed {
            background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
        }
        
        .error-message {
            color: #ff6b6b;
            margin-top: 10px;
            font-size: 14px;
            text-align: center;
        }
        
        .success-message {
            color: #4caf50;
            margin-top: 10px;
            font-size: 14px;
            text-align: center;
        }
        
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: #FFFFFF;
        }

        .header {
            background: #FFFFFF;
            height: 48px;
            padding: 0 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #E5E5E5;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            font-size: 18px;
            font-weight: 600;
            color: #000000;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-btn {
            height: 32px;
            padding: 0 12px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--color-primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s;
        }

        .header-btn:hover {
            background: rgba(6, 148, 148, 0.1);
        }

        .header-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #FFFFFF;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .header-avatar:hover {
            transform: scale(1.05);
        }
        
        .header-logo {
            width: 30px;
            height: 30px;
        }
        
        .notification-badge {
            position: relative;
            cursor: pointer;
        }
        
        .badge-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .content {
            flex: 1;
            padding: 0;
            padding-bottom: 80px;
            overflow-y: auto;
            background: #FFFFFF;
        }

        .hero-section {
            background: var(--color-primary);
            padding: 24px 16px;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            margin-top: 0;
        }

        .body-section {
            padding: 16px;
            background: #FFFFFF;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: #FFFFFF;
            display: flex;
            justify-content: space-around;
            padding: 0;
            z-index: 1000;
            border-top: 1px solid #E5E5E5;
            box-shadow: 0 -1px 3px rgba(0, 0, 0, 0.05);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 48px;
            min-height: 48px;
            padding: var(--space-1) var(--space-3);
            gap: 2px;
            cursor: pointer;
            transition: color 0.2s;
            color: var(--color-text-secondary);
        }

        .nav-item:active {
            transform: scale(0.95);
        }

        .nav-item.active {
            color: var(--color-primary);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
        }

        .nav-label {
            font-size: 10px;
            font-weight: 500;
            letter-spacing: 0.01em;
        }

        .profile-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: flex;
            align-items: flex-end;
            animation: fadeIn 0.2s ease;
        }

        .profile-modal {
            background: #FFFFFF;
            width: 100%;
            max-height: 90vh;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            overflow-y: auto;
            animation: slideUp 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .profile-modal-header {
            padding: 20px;
            border-bottom: 1px solid #E5E5E5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .profile-modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: #F5F5F5;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-modal-content {
            padding: 20px;
        }

        .section-content {
            animation: fadeIn 0.3s ease-in;
            margin-top: 0;
            padding-top: 0;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .hero-background {
            position: relative;
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            margin-bottom: var(--space-4);
            overflow: hidden;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
        }

        .day-counter-container {
            position: relative;
            z-index: 1;
            text-align: center;
        }

        .large-number {
            font-size: clamp(2.5rem, 5vw, 3rem);
            font-weight: 700;
            margin-bottom: var(--space-2);
            color: white;
            font-variant-numeric: tabular-nums;
            line-height: 1.2;
        }

        .large-text {
            font-size: clamp(1rem, 2.5vw, 1.25rem);
            margin-bottom: var(--space-4);
            opacity: 0.95;
            font-weight: 500;
        }

        .motivational-quote {
            font-size: var(--font-sm);
            opacity: 0.85;
            font-style: italic;
            line-height: 1.5;
        }
        
        .coach-info-card {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-2);
        }

        .coach-info-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            flex-shrink: 0;
            background: var(--color-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .coach-info-details {
            flex: 1;
            min-width: 0;
        }

        .coach-info-name {
            font-size: var(--font-base);
            font-weight: 600;
            margin-bottom: var(--space-1);
            line-height: 1.3;
        }

        .coach-info-role {
            font-size: var(--font-sm);
            opacity: 0.8;
            line-height: 1.4;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: var(--space-2);
            margin-top: var(--space-4);
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border-radius: var(--radius-lg);
            padding: var(--space-3);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-icon {
            width: 24px;
            height: 24px;
            margin: 0 auto var(--space-2);
            color: var(--color-primary-light);
        }

        .stat-value {
            font-size: var(--font-xl);
            font-weight: 700;
            color: white;
            font-variant-numeric: tabular-nums;
        }

        .stat-label {
            font-size: var(--font-xs);
            opacity: 0.85;
            margin-top: var(--space-1);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .daily-pledge {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            text-align: center;
            margin-bottom: var(--space-4);
        }

        .pledge-text {
            font-size: var(--font-lg);
            margin-bottom: var(--space-3);
            font-weight: 600;
            line-height: 1.4;
        }
        
        .mood-tracker {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
            text-align: center;
        }

        .mood-options {
            display: flex;
            justify-content: space-around;
            gap: var(--space-2);
            margin-top: var(--space-4);
        }

        .mood-button {
            flex: 1;
            min-height: 48px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--space-1);
            cursor: pointer;
            transition: all 0.2s;
            padding: var(--space-2);
            border-radius: var(--radius-md);
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
        }

        .mood-button:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .mood-button.selected {
            background: rgba(6, 148, 148, 0.2);
            border-color: var(--color-primary);
            transform: scale(1.05);
        }

        .mood-icon {
            width: 24px;
            height: 24px;
        }

        .mood-label {
            font-size: var(--font-xs);
            font-weight: 500;
        }
        
        .milestone-preview {
            background: rgba(46, 204, 113, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(46, 204, 113, 0.3);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
            margin-top: var(--space-4);
        }

        .broadcast-banner {
            background: rgba(255, 133, 89, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 133, 89, 0.3);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--space-3);
        }
        
        .broadcast-content {
            flex: 1;
        }
        
        .broadcast-dismiss {
            background: none;
            border: none;
            color: white;
            opacity: 0.6;
            cursor: pointer;
            font-size: 20px;
        }
        
        .daily-tasks-card {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(67, 160, 71, 0.1) 100%);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .task-list {
            margin-top: 15px;
        }
        
        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }
        
        .task-item:last-child {
            border-bottom: none;
        }
        
        .task-item:hover {
            background: rgba(255, 255, 255, 0.05);
            margin: 0 -10px;
            padding: 12px 10px;
            border-radius: 10px;
        }
        
        .completed {
            color: #4caf50;
            font-weight: bold;
        }
        
        .pending {
            color: #ff9800;
        }
        
        .overdue {
            color: #ff4757;
        }
        
        .goal-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .progress-badge {
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 10px;
            margin-bottom: 15px;
        }
        
        .progress-fill {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            border-radius: 10px;
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .objectives-list {
            margin-top: 15px;
            padding-left: 20px;
        }
        
        .objective-item {
            margin-bottom: 10px;
            list-style-type: none;
            position: relative;
        }
        
        .objective-item:before {
            content: "→";
            position: absolute;
            left: -20px;
            color: #f4c430;
        }
        
        .assignments-list {
            margin-top: 15px;
        }
        
        .assignment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .btn-complete {
            padding: 5px 15px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            border: none;
            border-radius: 15px;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            height: 300px;
        }
        
        .milestones-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .milestone-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .milestone-item:last-child {
            border-bottom: none;
        }
        
        .milestone-icon {
            font-size: 24px;
            margin-right: 15px;
        }
        
        .milestone-content {
            flex: 1;
        }
        
        .milestone-title {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .milestone-days {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .milestone-achieved {
            opacity: 0.5;
            text-decoration: line-through;
        }
        
        .compliance-card {
            background: linear-gradient(135deg, rgba(156, 39, 176, 0.1) 0%, rgba(103, 58, 183, 0.1) 100%);
            border: 1px solid rgba(156, 39, 176, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .chat-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 5px;
            border-radius: 15px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
        }
        
        .community-chat-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
        }
        
        .messages-container {
            height: 400px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .community-message {
            margin-bottom: 15px;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
            opacity: 0.8;
        }
        
        .message-author {
            font-weight: bold;
            color: #f4c430;
        }
        
        .message-time {
            font-size: 12px;
        }
        
        .message-content {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 10px;
            word-wrap: break-word;
        }
        
        .chat-input-group {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 16px;
        }
        
        .send-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            border: none;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
        
        .room-card {
            background: linear-gradient(135deg, rgba(244, 196, 48, 0.1) 0%, rgba(255, 149, 0, 0.1) 100%);
            border: 1px solid rgba(244, 196, 48, 0.3);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }
        
        .room-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .room-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .support-group-card {
            background: linear-gradient(135deg, rgba(156, 39, 176, 0.1) 0%, rgba(103, 58, 183, 0.1) 100%);
            border: 1px solid rgba(156, 39, 176, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .meeting-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .meeting-type {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 12px;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .join-btn {
            display: inline-block;
            margin-top: 15px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            border-radius: 25px;
            color: white;
            text-decoration: none;
            font-weight: bold;
            border: none;
            cursor: pointer;
        }
        
        .crisis-resources {
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid rgba(255, 71, 87, 0.3);
            border-radius: 15px;
        }
        
        .crisis-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #ff4757;
        }
        
        .crisis-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .crisis-number a {
            color: white;
            text-decoration: none;
        }
        
        .crisis-description {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .sos-btn {
            width: 100%;
            margin-top: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #ff4757 0%, #ff6348 100%);
            border: none;
            border-radius: 25px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .profile-menu {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .profile-header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .profile-avatar {
            width: 100px;
            height: 100px;
            margin: 0 auto 15px;
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            font-weight: bold;
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-avatar-upload {
            position: absolute;
            bottom: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .upload-input {
            display: none;
        }
        
        .profile-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .profile-email {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .menu-section {
            margin-top: 20px;
        }
        
        .menu-title {
            font-size: 12px;
            text-transform: uppercase;
            opacity: 0.6;
            margin-bottom: 10px;
            padding: 0 10px;
        }
        
        .menu-item {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            transition: background 0.2s;
            border-radius: 10px;
            text-align: left;
            text-decoration: none;
        }
        
        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .menu-item-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        
        .menu-icon {
            font-size: 20px;
        }
        
        .menu-arrow {
            opacity: 0.5;
        }
        
        .btn-danger {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #ff4757 0%, #ff6348 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            opacity: 0.6;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .empty-state-text {
            font-size: 16px;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
            animation: fadeIn 0.2s ease-in;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: bold;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-body {
            color: white;
        }
        
        .slider-group {
            margin-bottom: 25px;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .slider-value {
            color: #f4c430;
            font-weight: bold;
        }
        
        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #f4c430;
            cursor: pointer;
        }
        
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #f4c430;
            cursor: pointer;
        }
        
        .textarea {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 16px;
            min-height: 100px;
            resize: vertical;
        }
        
        .notification-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .notification-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .notification-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .notification-item.unread {
            border-left: 3px solid #f4c430;
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .notification-type {
            font-size: 12px;
            background: rgba(244, 196, 48, 0.3);
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        .notification-time {
            font-size: 12px;
            opacity: 0.7;
        }
        
        .notification-message {
            font-size: 14px;
            line-height: 1.4;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .large-number {
                font-size: 56px;
            }

            .modal-content {
                padding: 20px;
            }
        }

        /* Hide scrollbars on swipeable pickers */
        .swipeable-picker-container::-webkit-scrollbar {
            display: none;
        }

        .swipeable-picker-container {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React and Firebase -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script type="text/babel">
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAufSTHtCTFSEIeZ9YzvrULCnji5I-SMi0",
            authDomain: "glrs-pir-system.firebaseapp.com",
            projectId: "glrs-pir-system",
            storageBucket: "glrs-pir-system.appspot.com",
            messagingSenderId: "830378577655",
            appId: "1:830378577655:web:8a9ea644b8e3c5a9f15c42"
        };

        // Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// Global helper function for consistent sobriety day calculation - FIXED VERSION
window.getSobrietyDays = (sobrietyDate) => {
    if (!sobrietyDate) return 0;
    
    const sobrietyDateObj = new Date(sobrietyDate);
    const today = new Date();
    
    // Reset to midnight for accurate day counting
    sobrietyDateObj.setHours(0, 0, 0, 0);
    today.setHours(0, 0, 0, 0);
    
    // Calculate difference in milliseconds
    const diffTime = today - sobrietyDateObj;
    
    // Convert to days and add 1 (sobriety date counts as day 1)
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
    
    // Return at least 1 if sobriety date is today or in the past
    return Math.max(1, diffDays);
};

const { useState, useEffect, useRef } = React;
         
        // Lighthouse Logo Component
        function LighthouseLogo({ size = 100 }) {
            return (
                <svg width={size} height={size} viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="100" cy="100" r="95" stroke="#1e3c72" strokeWidth="3" fill="rgba(30, 60, 114, 0.1)"/>
                    <path d="M100 140 L85 180 L115 180 Z" fill="#ffffff"/>
                    <rect x="92" y="100" width="16" height="40" fill="#ffffff"/>
                    <rect x="88" y="90" width="24" height="10" fill="#1e3c72"/>
                    <path d="M100 70 L90 90 L110 90 Z" fill="#1e3c72"/>
                    <rect x="95" y="70" width="10" height="20" fill="#1e3c72"/>
                    <path d="M100 80 L60 70" stroke="#f4c430" strokeWidth="3" opacity="0.8"/>
                    <path d="M100 80 L140 70" stroke="#f4c430" strokeWidth="3" opacity="0.8"/>
                    <path d="M100 80 L50 85" stroke="#f4c430" strokeWidth="3" opacity="0.6"/>
                    <path d="M100 80 L150 85" stroke="#f4c430" strokeWidth="3" opacity="0.6"/>
                    <circle cx="100" cy="80" r="8" fill="#f4c430"/>
                    <path d="M 60 170 Q 80 165, 100 170 T 140 170" stroke="#4a90e2" strokeWidth="2" fill="none"/>
                    <path d="M 50 175 Q 75 170, 100 175 T 150 175" stroke="#4a90e2" strokeWidth="2" fill="none" opacity="0.6"/>
                </svg>
            );
        }
    

       // Main App Component
function App() {
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(true);
    
    useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged(async (firebaseUser) => {
            if (firebaseUser) {
                try {
                    let userDoc = await db.collection('users').doc(firebaseUser.uid).get();
                    
                    if (!userDoc.exists) {
                        // Create new user document with timestamps
                        await db.collection('users').doc(firebaseUser.uid).set({
                            email: firebaseUser.email,
                            role: 'pir',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            active: true,
                            sobrietyDate: new Date().toISOString(),
                            profileComplete: false
                        });
                        
                        // Re-fetch the document after creating it
                        userDoc = await db.collection('users').doc(firebaseUser.uid).get();
                    }
                    
                    const userData = userDoc.data();
                    
                    // Check for existing users without createdAt
                    if (userData && !userData.createdAt) {
                        await db.collection('users').doc(firebaseUser.uid).update({
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                    // Verify role
                    if (userData && userData.role !== 'pir') {
                        await auth.signOut();
                        alert('This portal is for PIRs only. Coaches should use admin.html');
                        setUser(null);
                    } else {
                        setUser(firebaseUser);
                    }
                } catch (error) {
                    console.error('Error verifying user:', error);
                    setUser(null);
                }
            } else {
                setUser(null);
            }
            setLoading(false);
        });

        return () => unsubscribe();
    }, []);

    if (loading) {
        return (
            <div className="loading-container">
                <div className="loading-spinner"></div>
            </div>
        );
    }

    return user ? <PIRApp user={user} /> : <LoginScreen />;
}

// Login Screen Component
function LoginScreen() {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);
    const [success, setSuccess] = useState('');

    const handleLogin = async (e) => {
        e.preventDefault();
        setError('');
        setSuccess('');
        
        if (!email || !password) {
            setError('Please enter both email and password');
            return;
        }

        setLoading(true);

        try {
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            const userDoc = await db.collection('users').doc(userCredential.user.uid).get();
            
            if (userDoc.exists) {
                const userData = userDoc.data();
                if (userData.role !== 'pir') {
                    await auth.signOut();
                    setError('This login is for PIR users only.');
                    setLoading(false);
                    return;
                }
                
                if (!userData.active) {
                    await auth.signOut();
                    setError('Your account is inactive. Please contact your coach.');
                    setLoading(false);
                    return;
                }
                
                // Update last login timestamp
                await db.collection('users').doc(userCredential.user.uid).update({
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Create login activity record
                await db.collection('activities').add({
                    userId: userCredential.user.uid,
                    type: 'login',
                    description: 'User logged in',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            setSuccess('Login successful! Redirecting...');
        } catch (error) {
            console.error('Login error:', error);
            
            switch(error.code) {
                case 'auth/user-not-found':
                    setError('No account found with this email');
                    break;
                case 'auth/wrong-password':
                    setError('Incorrect password');
                    break;
                case 'auth/invalid-email':
                    setError('Invalid email address');
                    break;
                default:
                    setError('Failed to sign in. Please try again.');
            }
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="login-container">
            <div className="login-card">
                <div className="logo-container">
                    <img 
    src="glrs-logo.png" 
    alt="GLRS Logo"
    style={{
        width: '150px',
        height: 'auto',
        objectFit: 'contain'
    }}
/>
                </div>
                <h1 className="app-title">Guiding Light</h1>
                <p className="app-subtitle">Recovery Services</p>
                
                <form onSubmit={handleLogin}>
                    <div className="form-group">
                        <label className="form-label">Email</label>
                        <input
                            type="email"
                            className="form-input"
                            placeholder="Enter your email"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            disabled={loading}
                            autoComplete="email"
                        />
                    </div>
                    
                    <div className="form-group">
                        <label className="form-label">Password</label>
                        <input
                            type="password"
                            className="form-input"
                            placeholder="Enter your password"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            disabled={loading}
                            autoComplete="current-password"
                        />
                    </div>
                    
                    <button type="submit" className="btn-primary" disabled={loading}>
                        {loading ? 'Signing in...' : 'Sign In'}
                    </button>
                    
                    {error && <div className="error-message">{error}</div>}
                    {success && <div className="success-message">{success}</div>}
                </form>
            </div>
        </div>
    );
}
// Main PIR App Component
function PIRApp({ user }) {
    // CORRECTED NAVIGATION ORDER: Tasks-Journey-Home-Connect-Guides-Notifications
    const [currentView, setCurrentView] = useState('home');
    const [showProfileModal, setShowProfileModal] = useState(false);
    const [loading, setLoading] = useState(true);
    
    // User Data States
    const [userData, setUserData] = useState(null);
    const [profileImage, setProfileImage] = useState(null);
    const [coachInfo, setCoachInfo] = useState(null);
    
    // Home Section States
    const [sobrietyDays, setSobrietyDays] = useState(0);
    const [selectedMood, setSelectedMood] = useState(null);
    const [pledgeMade, setPledgeMade] = useState(false);
    const [moneySaved, setMoneySaved] = useState(0);
    const [dailyQuote, setDailyQuote] = useState(null);
    const [milestones, setMilestones] = useState([]);
    const [nextMilestone, setNextMilestone] = useState(null);
    const [activeBroadcast, setActiveBroadcast] = useState(null);
    const [broadcastDismissed, setBroadcastDismissed] = useState(false);
    const [checkInStatus, setCheckInStatus] = useState({ morning: false, evening: false });
    const [checkInStreak, setCheckInStreak] = useState(0);
    const [streakCheckIns, setStreakCheckIns] = useState([]);
    const [complianceRate, setComplianceRate] = useState({ checkIn: 0, assignment: 0 });
    const [totalCheckIns, setTotalCheckIns] = useState(0);
    const [googleConnected, setGoogleConnected] = useState(false);
    const [googleToken, setGoogleToken] = useState(null);
    const [googleTokenExpiry, setGoogleTokenExpiry] = useState(null);
    const [syncingGoogle, setSyncingGoogle] = useState(false);
    
    // Progress States
    const [checkIns, setCheckIns] = useState([]);
    const [moodChartData, setMoodChartData] = useState(null);
    const [cravingChartData, setCravingChartData] = useState(null);
    const chartRef = useRef(null);
    const cravingChartRef = useRef(null);
    const [anxietyChartData, setAnxietyChartData] = useState(null);
    const anxietyChartRef = useRef(null);
    const [sleepChartData, setSleepChartData] = useState(null);
    const sleepChartRef = useRef(null);
    
    // Tasks States
    const [goals, setGoals] = useState([]);
    const [assignments, setAssignments] = useState([]);
    const [activeTaskTab, setActiveTaskTab] = useState('checkin'); // checkin | reflections | golden
    const [morningCheckInData, setMorningCheckInData] = useState({
        mood: null,
        craving: null,
        anxiety: null,
        sleep: null
    });
    const [eveningReflectionData, setEveningReflectionData] = useState({
        overallDay: null,
        promptResponse: '',
        challenges: '',
        gratitude: '',
        tomorrowGoal: ''
    });
    const [patternDetection, setPatternDetection] = useState(null);
    const [showTipsModal, setShowTipsModal] = useState(false);
    const [showMoodPatternModal, setShowMoodPatternModal] = useState(false);
    const [showCravingPatternModal, setShowCravingPatternModal] = useState(false);
    const [showAnxietyPatternModal, setShowAnxietyPatternModal] = useState(false);
    const [showSleepPatternModal, setShowSleepPatternModal] = useState(false);
    const [showStreakModal, setShowStreakModal] = useState(false);
    const [showReflectionStreakModal, setShowReflectionStreakModal] = useState(false);
    const [showCalendarHeatmapModal, setShowCalendarHeatmapModal] = useState(false);
    const [calendarHeatmapData, setCalendarHeatmapData] = useState([]);
    const [selectedCalendarDay, setSelectedCalendarDay] = useState(null);
    const [calendarViewMode, setCalendarViewMode] = useState('month'); // 'week', 'month'
    const [calendarCurrentMonth, setCalendarCurrentMonth] = useState(new Date());
    const [calendarCurrentWeek, setCalendarCurrentWeek] = useState(new Date());
    const [showMoodInsightsModal, setShowMoodInsightsModal] = useState(false);
    const [moodWeekData, setMoodWeekData] = useState([]);
    const [showCopingTechniqueModal, setShowCopingTechniqueModal] = useState(false);
    const [showStreaksModal, setShowStreaksModal] = useState(false);
    const [streakData, setStreakData] = useState({ longestStreak: 0, currentStreak: 0, allStreaks: [] });
    const [showReflectionStreaksModal, setShowReflectionStreaksModal] = useState(false);
    const [reflectionStreakData, setReflectionStreakData] = useState({ longestStreak: 0, currentStreak: 0, allStreaks: [] });
    const [showMilestoneModal, setShowMilestoneModal] = useState(false);
    const [allMilestones, setAllMilestones] = useState([]);
    const [showPastReflectionsModal, setShowPastReflectionsModal] = useState(false);
    const [selectedReflection, setSelectedReflection] = useState(null);
    const [reflectionFilter, setReflectionFilter] = useState('all'); // 'all', 'week', 'month'
    const [showGratitudeModal, setShowGratitudeModal] = useState(false);
    const [gratitudeTheme, setGratitudeTheme] = useState('');
    const [gratitudeText, setGratitudeText] = useState('');
    const [showWeeklyReportModal, setShowWeeklyReportModal] = useState(false);
    const [weeklyStats, setWeeklyStats] = useState({
        checkRate: 0,
        avgMood: 0,
        thisWeekCompletion: 0
    });
    const [checkInData, setCheckInData] = useState([]);
    const [reflectionStreak, setReflectionStreak] = useState(0);
    const [streakReflections, setStreakReflections] = useState([]);
    const [reflectionData, setReflectionData] = useState([]);
    const [reflectionStats, setReflectionStats] = useState({
        totalThisMonth: 0,
        avgDailyScore: 0,
        topGratitudeTheme: ''
    });
    const [coachNotes, setCoachNotes] = useState([]);

    // Connect States
    const [activeChat, setActiveChat] = useState('main');
    const [communityMessages, setCommunityMessages] = useState([]);
    const [topicRooms, setTopicRooms] = useState([]);
    const [meetings, setMeetings] = useState([]);
    const [supportGroups, setSupportGroups] = useState([]);
    const [emergencyResources, setEmergencyResources] = useState([]);
    const [activeTopicRoom, setActiveTopicRoom] = useState(null);
    const [topicRoomMessages, setTopicRoomMessages] = useState([]);
    
    // Profile States
    const [resources, setResources] = useState({
        videos: [],
        articles: [],
        tools: [],
        worksheets: []
    });
    
    // General States
    const [notifications, setNotifications] = useState([]);
    const [unreadCount, setUnreadCount] = useState(0);
    const [showModal, setShowModal] = useState(null);
    const fileInputRef = useRef(null);

    // Phase 2: App Store Compliance Modals
    const [showTermsModal, setShowTermsModal] = useState(false);
    const [showPrivacyModal, setShowPrivacyModal] = useState(false);
    const [showDataHandlingModal, setShowDataHandlingModal] = useState(false);
    const [showCrisisModal, setShowCrisisModal] = useState(false);
    const [showDisclaimerModal, setShowDisclaimerModal] = useState(() => {
        return !localStorage.getItem('disclaimerAccepted');
    });

    // Phase 2: Mobile Interactions States
    const [pulling, setPulling] = useState(false);
    const [pullDistance, setPullDistance] = useState(0);
    const [refreshing, setRefreshing] = useState(false);
    const pullStartY = useRef(0);
    const contentRef = useRef(null);

    // 31 Daily Coping Techniques (Evidence-Based)
    const copingTechniques = [
        { day: 1, category: 'Breathing', title: 'Box Breathing', icon: 'wind', description: '1. Breathe in slowly for 4 counts\n2. Hold your breath for 4 counts\n3. Breathe out slowly for 4 counts\n4. Hold empty lungs for 4 counts\n5. Repeat for 5 minutes\n\nUsed by Navy SEALs to stay calm under pressure.' },
        { day: 2, category: 'Grounding', title: '5-4-3-2-1 Grounding', icon: 'eye', description: 'Notice and name aloud:\n\n5 things you can SEE\n4 things you can TOUCH\n3 things you can HEAR\n2 things you can SMELL\n1 thing you can TASTE\n\nBrings you back to the present moment when feeling overwhelmed.' },
        { day: 3, category: 'CBT', title: 'Thought Record', icon: 'file-text', description: '1. Write down the triggering situation\n2. Identify the automatic negative thought\n3. Note the emotions and intensity (1-10)\n4. Find evidence FOR the thought\n5. Find evidence AGAINST the thought\n6. Create a balanced alternative thought\n\nChallenges cognitive distortions.' },
        { day: 4, category: 'DBT', title: 'TIPP Skill', icon: 'thermometer', description: 'Temperature: Hold ice or splash cold water on face\nIntense exercise: Do 60 seconds of jumping jacks\nPaced breathing: Slow exhales longer than inhales\nProgressive muscle relaxation: Tense and release muscles\n\nQuickly reduces intense emotions in crisis.' },
        { day: 5, category: 'Mindfulness', title: 'Body Scan Meditation', icon: 'scan', description: '1. Lie down or sit comfortably\n2. Close your eyes\n3. Focus attention on your toes\n4. Slowly move awareness up through:\n   - Feet, ankles, calves, knees\n   - Thighs, hips, stomach\n   - Chest, shoulders, arms\n   - Neck, face, head\n5. Notice sensations without judgment\n\n10-minute practice.' },
        { day: 6, category: 'Anger Management', title: 'Timeout Technique', icon: 'pause-circle', description: '1. Notice anger rising (physical cues)\n2. Say "I need a timeout" out loud\n3. Leave the situation for 20 minutes\n4. Do calming activity (walk, breathe, music)\n5. Return when calm enough to discuss\n\nPrevents regrettable angry outbursts.' },
        { day: 7, category: 'Anxiety', title: 'Worry Time Schedule', icon: 'clock', description: '1. Schedule 15 minutes daily for worrying\n2. When worries arise during day, write them down\n3. Tell yourself "I\'ll think about this at 3pm"\n4. During worry time, review list and problem-solve\n5. After 15 minutes, close the list\n\nContains anxiety to specific time.' },
        { day: 8, category: 'Breathing', title: '4-7-8 Breathing', icon: 'wind', description: '1. Exhale completely through mouth\n2. Close mouth, inhale through nose for 4 counts\n3. Hold breath for 7 counts\n4. Exhale completely through mouth for 8 counts\n5. Repeat 4 cycles\n\nDr. Andrew Weil\'s natural tranquilizer.' },
        { day: 9, category: 'Grounding', title: 'Physical Grounding', icon: 'anchor', description: '1. Plant both feet firmly on ground\n2. Press feet down, feel the floor\n3. Notice the weight of your body\n4. Touch something nearby (wall, chair)\n5. Feel the texture and temperature\n6. Say "I am here, I am safe"\n\nAnchors you when dissociating.' },
        { day: 10, category: 'CBT', title: 'Cognitive Reframing', icon: 'refresh-cw', description: 'OLD THOUGHT: "I\'m a total failure"\nREFRAME: "I made a mistake, and I can learn from it"\n\nOLD: "Nobody likes me"\nREFRAME: "Some people like me, I can build connections"\n\nOLD: "I can\'t handle this"\nREFRAME: "This is hard, but I\'ve handled hard things before"\n\nReplace absolutes with balanced thoughts.' },
        { day: 11, category: 'DBT', title: 'STOP Skill', icon: 'octagon', description: 'S - STOP: Freeze, don\'t react\nT - TAKE A STEP BACK: Get space from situation\nO - OBSERVE: Notice thoughts, feelings, facts\nP - PROCEED MINDFULLY: What\'s effective here?\n\nPrevents impulsive reactions.' },
        { day: 12, category: 'Mindfulness', title: 'Mindful Walking', icon: 'footprints', description: '1. Walk slowly and deliberately\n2. Notice the sensation of each foot lifting\n3. Feel your foot moving through air\n4. Notice the foot touching ground\n5. Feel weight shifting to that foot\n6. Repeat with other foot\n\nWalk for 10 minutes focusing only on steps.' },
        { day: 13, category: 'Anger Management', title: 'Anger Ladder', icon: 'bar-chart-2', description: 'Rate your anger 1-10:\n\n1-3: Annoyed (deep breath, let it go)\n4-6: Frustrated (take a break, talk it out)\n7-8: Angry (use timeout, physical activity)\n9-10: Furious (immediate safety plan, call support)\n\nKnow your number, match your response.' },
        { day: 14, category: 'Anxiety', title: 'Progressive Muscle Relaxation', icon: 'activity', description: '1. Tense fists for 5 seconds, release\n2. Tense arms for 5 seconds, release\n3. Tense shoulders for 5 seconds, release\n4. Tense face for 5 seconds, release\n5. Tense stomach for 5 seconds, release\n6. Tense legs for 5 seconds, release\n7. Tense feet for 5 seconds, release\n\nReleases physical tension from anxiety.' },
        { day: 15, category: 'Breathing', title: 'Diaphragmatic Breathing', icon: 'wind', description: '1. Place one hand on chest, one on belly\n2. Breathe in through nose for 4 counts\n3. Belly should rise, chest stays still\n4. Exhale through mouth for 6 counts\n5. Belly should fall\n6. Repeat for 5 minutes\n\nActivates parasympathetic nervous system.' },
        { day: 16, category: 'Grounding', title: 'Categories Game', icon: 'list', description: 'Choose a category and name items:\n\n- 10 US states\n- 10 animals\n- 10 foods\n- 10 movies\n- 10 song titles\n\nSay them out loud. Engages logical brain, reduces emotional overwhelm.' },
        { day: 17, category: 'CBT', title: 'Decatastrophizing', icon: 'alert-triangle', description: 'WORST CASE: What\'s the absolute worst that could happen?\nBEST CASE: What\'s the best possible outcome?\nMOST LIKELY: What will probably actually happen?\n\nReality is usually in the middle. Reduces catastrophic thinking.' },
        { day: 18, category: 'DBT', title: 'DEAR MAN', icon: 'message-square', description: 'Describe the situation\nExpress your feelings\nAssert your needs\nReinforce (why they should help)\n\nstay Mindful (don\'t get distracted)\nAppear confident\nNegotiate (be willing to compromise)\n\nEffective interpersonal communication.' },
        { day: 19, category: 'Mindfulness', title: 'Mindful Eating', icon: 'coffee', description: '1. Choose one food (raisin, chocolate, fruit)\n2. Look at it closely for 30 seconds\n3. Smell it for 30 seconds\n4. Feel the texture for 30 seconds\n5. Place in mouth without chewing (30 sec)\n6. Chew slowly, noticing flavors\n7. Swallow mindfully\n\nPractices being fully present.' },
        { day: 20, category: 'Anger Management', title: 'Opposite Action', icon: 'repeat', description: 'When anger urges you to:\n\nYELL → Speak softly\nATTACK → Step away\nBLAME → Take responsibility\nBREAK THINGS → Hold something gently\n\nDoing the opposite reduces anger\'s intensity.' },
        { day: 21, category: 'Anxiety', title: 'Exposure Ladder', icon: 'trending-up', description: '1. List feared situation (1-10 difficulty)\n2. Start with easiest (difficulty 2-3)\n3. Face that situation repeatedly\n4. When anxiety drops 50%, move to next step\n5. Gradually work up the ladder\n\nGradual exposure builds confidence.' },
        { day: 22, category: 'Breathing', title: 'Alternate Nostril Breathing', icon: 'wind', description: '1. Close right nostril with thumb\n2. Inhale through left nostril (4 counts)\n3. Close left nostril with ring finger\n4. Exhale through right nostril (4 counts)\n5. Inhale through right nostril (4 counts)\n6. Switch, exhale through left\n7. Repeat 5 minutes\n\nBalances nervous system.' },
        { day: 23, category: 'Grounding', title: 'Safe Place Visualization', icon: 'home', description: '1. Close your eyes\n2. Picture a place where you feel completely safe\n3. Notice every detail: colors, sounds, smells\n4. Feel the safety in your body\n5. Create a cue word (e.g., "beach")\n6. Practice daily\n7. Use cue word in crisis\n\nMental safe space always available.' },
        { day: 24, category: 'CBT', title: 'Cost-Benefit Analysis', icon: 'scale', description: 'For any belief or behavior:\n\nCOSTS:\n- What are the disadvantages?\n- What does it cost me?\n\nBENEFITS:\n- What are the advantages?\n- What do I gain?\n\nMakes unconscious patterns conscious.' },
        { day: 25, category: 'DBT', title: 'Radical Acceptance', icon: 'check-circle', description: 'What it is:\n- Accepting reality as it is\n- Not approving or liking it\n- Stopping the fight with reality\n\n"I can\'t change what happened, AND I can choose how I respond now."\n\nReduces suffering from non-acceptance.' },
        { day: 26, category: 'Mindfulness', title: 'Loving-Kindness Meditation', icon: 'heart', description: 'Repeat silently:\n\n"May I be safe\nMay I be healthy\nMay I be happy\nMay I live with ease"\n\nThen wish same for:\n- Someone you love\n- Someone neutral\n- Someone difficult\n- All beings\n\nBuilds self-compassion.' },
        { day: 27, category: 'Anger Management', title: 'Anger Journal', icon: 'book', description: 'After anger episode, write:\n\n1. TRIGGER: What happened right before?\n2. THOUGHTS: What was I thinking?\n3. FEELINGS: What did I feel in my body?\n4. ACTIONS: What did I do?\n5. CONSEQUENCES: What happened as a result?\n6. ALTERNATIVE: What could I do differently?\n\nIdentifies patterns over time.' },
        { day: 28, category: 'Anxiety', title: 'Thought Stopping', icon: 'x-circle', description: '1. When anxious thought starts, yell "STOP!" (or picture a stop sign)\n2. Snap a rubber band on wrist (or clap)\n3. Replace with planned positive thought\n4. Engage in physical activity\n\nInterrupts rumination cycle.' },
        { day: 29, category: 'Breathing', title: 'Resonant Breathing', icon: 'wind', description: '1. Breathe at rate of 6 breaths per minute\n2. Inhale for 5 seconds\n3. Exhale for 5 seconds\n4. Keep rhythm steady\n5. Practice for 10-20 minutes\n\nOptimizes heart rate variability, reduces stress.' },
        { day: 30, category: 'Grounding', title: 'Cold Water Grounding', icon: 'droplet', description: '1. Hold ice cube in your hand\n2. Splash cold water on your face\n3. Take a cold shower\n4. Drink ice water slowly\n\nPhysical sensation brings immediate presence. Activates dive reflex, calms nervous system.' },
        { day: 31, category: 'CBT', title: 'Evidence Gathering', icon: 'search', description: 'BELIEF: "Everyone thinks I\'m incompetent"\n\nEVIDENCE FOR:\n- (list objective facts only)\n\nEVIDENCE AGAINST:\n- (list objective facts only)\n\nNEW BALANCED BELIEF:\n- Based on all evidence\n\nTests beliefs against reality.' }
    ];

    // Gratitude themes (12 categories)
    const gratitudeThemes = [
        { id: 'relationships', label: 'Relationships', icon: 'users', color: '#FF6B6B' },
        { id: 'health', label: 'Health & Wellness', icon: 'heart', color: '#4ECDC4' },
        { id: 'nature', label: 'Nature & Environment', icon: 'sun', color: '#95E1D3' },
        { id: 'personal', label: 'Personal Growth', icon: 'trending-up', color: '#F38181' },
        { id: 'moments', label: 'Small Moments', icon: 'smile', color: '#FFD93D' },
        { id: 'opportunities', label: 'Opportunities', icon: 'target', color: '#6BCB77' },
        { id: 'comfort', label: 'Comfort & Safety', icon: 'shield', color: '#4D96FF' },
        { id: 'accomplishments', label: 'Accomplishments', icon: 'award', color: '#9D84B7' },
        { id: 'support', label: 'Support & Help', icon: 'life-buoy', color: '#FFA500' },
        { id: 'creativity', label: 'Creativity & Expression', icon: 'palette', color: '#E74C3C' },
        { id: 'simple', label: 'Simple Pleasures', icon: 'coffee', color: '#795548' },
        { id: 'other', label: 'Other', icon: 'more-horizontal', color: '#999999' }
    ];

    // Real-time listeners references
    const listenersRef = useRef([]);

    // ==========================================
    // GOOGLE CALENDAR INTEGRATION - PIR SIDE
    // ==========================================

    // Simple encryption/decryption for token storage
    const encryptToken = (token) => {
        try {
            // Base64 encode with user-specific salt
            const salt = user.uid.substring(0, 8);
            const combined = salt + token + salt;
            return btoa(combined);
        } catch (error) {
            console.error('Encryption error:', error);
            return token; // Fallback to plain if encryption fails
        }
    };

    const decryptToken = (encryptedToken) => {
        try {
            const salt = user.uid.substring(0, 8);
            const decoded = atob(encryptedToken);
            // Remove salt from both ends
            return decoded.substring(salt.length, decoded.length - salt.length);
        } catch (error) {
            console.error('Decryption error:', error);
            return encryptedToken; // Fallback if decryption fails
        }
    };

    // Load Google connection status on mount
    const loadGoogleConnection = async () => {
        try {
            const userDoc = await db.collection('users').doc(user.uid).get();
            const data = userDoc.data();
            
            if (data?.googleConnected && data?.googleAccessToken) {
                setGoogleConnected(true);
                
                // Decrypt token
                const decrypted = decryptToken(data.googleAccessToken);
                setGoogleToken(decrypted);
                setGoogleTokenExpiry(data.googleTokenExpiry);
                
                // Check if token is expired
                if (data.googleTokenExpiry && Date.now() > data.googleTokenExpiry) {
                    console.log('Token expired, will need refresh on next use');
                }
            } else {
                setGoogleConnected(false);
                setGoogleToken(null);
            }
        } catch (error) {
            console.error('Error loading Google connection:', error);
            setGoogleConnected(false);
        }
    };

    // Check and auto-refresh Google token if needed
    const checkGoogleToken = async () => {
        try {
            if (!googleConnected || !googleToken) {
                return { 
                    valid: false, 
                    error: 'Google Calendar not connected. Please connect in Settings.' 
                };
            }
            
            // Check if token is expired or will expire in next 5 minutes
            const expiryBuffer = 5 * 60 * 1000; // 5 minutes
            const isExpired = googleTokenExpiry && (Date.now() + expiryBuffer) > googleTokenExpiry;
            
            if (isExpired) {
                console.log('Token expired or expiring soon, attempting refresh...');
                
                // Show user-friendly message
                showNotification('Refreshing Google Calendar connection...', 'info');
                
                // Attempt to refresh token
                const refreshed = await refreshGoogleToken();
                
                if (!refreshed) {
                    // Show error banner
                    showNotification(
                        'Google Calendar connection expired. Please reconnect in Settings.', 
                        'error'
                    );
                    return { 
                        valid: false, 
                        error: 'Token refresh failed. Please reconnect Google Calendar.' 
                    };
                }
                
                return { valid: true, token: googleToken };
            }
            
            return { valid: true, token: googleToken };
            
        } catch (error) {
            console.error('Error checking token:', error);
            showNotification('Error validating Google Calendar connection', 'error');
            return { 
                valid: false, 
                error: 'Failed to validate token: ' + error.message 
            };
        }
    };

    // Refresh Google token
    const refreshGoogleToken = async () => {
        try {
            // For OAuth tokens, we need to re-authenticate
            // Google doesn't provide refresh tokens for browser-based OAuth
            console.log('Token refresh requires re-authentication');
            
            // Attempt silent refresh if possible
            if (typeof google !== 'undefined' && google.accounts) {
                // This won't work automatically - user must re-consent
                console.log('Automatic refresh not available, user must reconnect');
                return false;
            }
            
            return false;
        } catch (error) {
            console.error('Token refresh error:', error);
            return false;
        }
    };

    // Connect Google Calendar
    const connectGoogleCalendar = async () => {
        setSyncingGoogle(true);
        try {
            console.log('Starting Google Calendar OAuth...');
            
            // Check if Google Identity Services loaded
            if (typeof google === 'undefined' || !google.accounts) {
                throw new Error('Google Identity Services not loaded. Please refresh the page.');
            }
            
            // Initialize token client with CALENDAR ONLY scope
            const tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: '457406864879-k1sunucuqofe22m5rg93hvo6nngiqh0u.apps.googleusercontent.com',
                scope: 'https://www.googleapis.com/auth/calendar.events',
                callback: async (tokenResponse) => {
                    try {
                        console.log('Token received');
                        
                        if (tokenResponse.error) {
                            throw new Error(tokenResponse.error);
                        }
                        
                        if (!tokenResponse.access_token) {
                            throw new Error('No access token received');
                        }
                        
                        // Encrypt token before storing
                        const encryptedToken = encryptToken(tokenResponse.access_token);
                        
                        console.log('Saving encrypted token to Firebase...');
                        
                        // Save to Firebase
                        await db.collection('users').doc(user.uid).update({
                            googleConnected: true,
                            googleAccessToken: encryptedToken,
                            googleTokenExpiry: Date.now() + (tokenResponse.expires_in * 1000),
                            googleConnectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            calendarSyncEnabled: false // Default to off, user must enable
                        });
                        
                        // Update local state
                        setGoogleConnected(true);
                        setGoogleToken(tokenResponse.access_token);
                        setGoogleTokenExpiry(Date.now() + (tokenResponse.expires_in * 1000));
                        
                        console.log('✅ Google Calendar connected successfully!');
                        showNotification('Google Calendar Connected!', 'success');
                        
                        // Close modal and reload
                        setShowModal(null);
                        setTimeout(() => loadGoogleConnection(), 500);
                        
                    } catch (error) {
                        console.error('Error saving token:', error);
                        showNotification('Failed to save connection: ' + error.message, 'error');
                    } finally {
                        setSyncingGoogle(false);
                    }
                },
            });
            
            // Request access token
            console.log('Requesting token...');
            tokenClient.requestAccessToken({ prompt: 'consent' });
            
        } catch (error) {
            console.error('Error connecting Google Calendar:', error);
            showNotification('Failed to connect: ' + error.message, 'error');
            setSyncingGoogle(false);
        }
    };

    // Disconnect Google Calendar
    const disconnectGoogleCalendar = async () => {
        if (!confirm('Disconnect Google Calendar?\n\nThis will remove:\n• Calendar sync\n• All synced milestones\n\nYou can reconnect anytime.')) {
            return;
        }
        
        setSyncingGoogle(true);
        try {
            console.log('Disconnecting Google Calendar...');
            
            // Revoke token if available
            if (googleToken && typeof google !== 'undefined' && google.accounts) {
                google.accounts.oauth2.revoke(googleToken, () => {
                    console.log('✓ Token revoked');
                });
            }
            
            // Remove from Firebase
            await db.collection('users').doc(user.uid).update({
                googleConnected: false,
                googleAccessToken: firebase.firestore.FieldValue.delete(),
                googleTokenExpiry: firebase.firestore.FieldValue.delete(),
                calendarSyncEnabled: false,
                milestoneCalendarEvents: firebase.firestore.FieldValue.delete(),
                googleDisconnectedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Update local state
            setGoogleConnected(false);
            setGoogleToken(null);
            setGoogleTokenExpiry(null);
            
            showNotification('Google Calendar disconnected', 'success');
            setShowModal(null);
            
        } catch (error) {
            console.error('Error disconnecting:', error);
            showNotification('Failed to disconnect: ' + error.message, 'error');
        } finally {
            setSyncingGoogle(false);
        }
    };

    // ==========================================
    // END GOOGLE CALENDAR INTEGRATION
    // ==========================================

    // ==========================================
    // PHASE 2: PULL-TO-REFRESH FUNCTIONALITY
    // ==========================================

    const handleRefresh = async () => {
        setRefreshing(true);

        try {
            // Trigger haptic feedback (if available)
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }

            // Reload data based on current view
            if (currentView === 'home') {
                await loadAllData();
            } else if (currentView === 'progress') {
                await loadCheckIns();
            } else if (currentView === 'tasks') {
                await loadGoals();
                await loadAssignments();
            } else if (currentView === 'connect') {
                await loadCommunityMessages();
                await loadTopicRooms();
            } else if (currentView === 'profile') {
                await loadResources();
            }

            // Show success notification
            showNotification('Refreshed', 'success');

        } catch (error) {
            console.error('Refresh error:', error);
            showNotification('Refresh failed', 'error');
        } finally {
            setRefreshing(false);
            setPullDistance(0);
            setPulling(false);
        }
    };

    const handleTouchStart = (e) => {
        if (!contentRef.current) return;
        const scrollTop = contentRef.current.scrollTop;

        // Only allow pull-to-refresh when at the top
        if (scrollTop === 0) {
            pullStartY.current = e.touches[0].clientY;
        }
    };

    const handleTouchMove = (e) => {
        if (!contentRef.current || pullStartY.current === 0) return;

        const scrollTop = contentRef.current.scrollTop;
        if (scrollTop > 0) {
            setPulling(false);
            setPullDistance(0);
            return;
        }

        const currentY = e.touches[0].clientY;
        const distance = currentY - pullStartY.current;

        if (distance > 0 && distance <= 120) {
            setPulling(true);
            setPullDistance(distance);
            e.preventDefault(); // Prevent scroll
        }
    };

    const handleTouchEnd = () => {
        if (pulling && pullDistance > 80) {
            handleRefresh();
        } else {
            setPulling(false);
            setPullDistance(0);
        }
        pullStartY.current = 0;
    };

    // ==========================================
    // END PULL-TO-REFRESH
    // ==========================================

    // ==========================================
    // HAPTIC FEEDBACK HELPER
    // ==========================================

    const triggerHaptic = (type = 'light') => {
        if (!navigator.vibrate) return;

        switch (type) {
            case 'light':
                navigator.vibrate(10);
                break;
            case 'medium':
                navigator.vibrate(20);
                break;
            case 'heavy':
                navigator.vibrate(50);
                break;
            case 'success':
                navigator.vibrate([10, 50, 10]);
                break;
            case 'error':
                navigator.vibrate([50, 100, 50]);
                break;
            default:
                navigator.vibrate(10);
        }
    };

    // ==========================================
    // END HAPTIC FEEDBACK
    // ==========================================

    // Load all data on mount
    useEffect(() => {
        if (user) {
            loadAllData();
            setupRealtimeListeners();
            loadGoogleConnection();
        }

        return () => {
            // Cleanup listeners
            listenersRef.current.forEach(unsubscribe => unsubscribe());
        };
    }, [user]);

    // Initialize Lucide icons
    useEffect(() => {
        if (typeof lucide !== 'undefined') {
            // Use setTimeout to ensure React finishes rendering before creating icons
            // This prevents DOM conflicts when React is updating components
            setTimeout(() => {
                lucide.createIcons();
            }, 0);
        }
    }, [currentView, showModal]);

    // Separate useEffect for calendar modal icons - only run once when modal opens
    useEffect(() => {
        if (showCalendarHeatmapModal && typeof lucide !== 'undefined') {
            // Longer delay to ensure all calendar rendering is complete
            const timer = setTimeout(() => {
                lucide.createIcons();
            }, 150);
            return () => clearTimeout(timer);
        }
    }, [showCalendarHeatmapModal]);

    // Setup real-time listeners
    const setupRealtimeListeners = () => {
        // Notifications listener
        const notifListener = db.collection('notifications')
            .where('userId', '==', user.uid)
            .orderBy('createdAt', 'desc')
            .limit(20)
            .onSnapshot(snapshot => {
                const notificationsList = [];
                let unread = 0;
                snapshot.forEach(doc => {
                    const notification = { id: doc.id, ...doc.data() };
                    notificationsList.push(notification);
                    if (!notification.read) unread++;
                });
                setNotifications(notificationsList);
                setUnreadCount(unread);
            });
        listenersRef.current.push(notifListener);

        // Community messages listener
        const messagesListener = db.collection('messages')
            .where('roomId', '==', 'main')
            .orderBy('createdAt', 'desc')
            .limit(50)
            .onSnapshot(snapshot => {
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });
                setCommunityMessages(messages.reverse());
            });
        listenersRef.current.push(messagesListener);

        // Goals listener
        const goalsListener = db.collection('goals')
            .where('userId', '==', user.uid)
            .where('status', '==', 'active')
            .onSnapshot(snapshot => {
                loadGoals();
            });
        listenersRef.current.push(goalsListener);

        // Assignments listener
        const assignmentsListener = db.collection('assignments')
            .where('userId', '==', user.uid)
            .onSnapshot(snapshot => {
                loadAssignments();
            });
        listenersRef.current.push(assignmentsListener);

        // Broadcasts listener
        const broadcastsListener = db.collection('broadcasts')
            .where('active', '==', true)
            .orderBy('createdAt', 'desc')
            .limit(1)
            .onSnapshot(snapshot => {
                if (!snapshot.empty && !broadcastDismissed) {
                    const broadcast = snapshot.docs[0].data();
                    setActiveBroadcast(broadcast);
                }
            });
        listenersRef.current.push(broadcastsListener);
    };

    // FIXED: Complete sobriety days calculation function
    const calculateSobrietyDays = (sobrietyDate) => {
        if (!sobrietyDate) return 0;
        
        const sobrietyDateObj = new Date(sobrietyDate);
        const today = new Date();
        
        // Reset time to start of day for accurate day counting
        sobrietyDateObj.setHours(0, 0, 0, 0);
        today.setHours(0, 0, 0, 0);
        
        // Calculate difference in milliseconds
        const diffTime = today - sobrietyDateObj;
        
        // Convert to days and add 1 (because day 1 is the sobriety date itself)
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
        
        // Return at least 1 if sobriety date is today or in the past
        return Math.max(1, diffDays);
    };

    // FIXED: Updated useEffect for sobriety calculation
    useEffect(() => {
        if (userData?.sobrietyDate) {
            const calculateStats = () => {
                const days = calculateSobrietyDays(userData.sobrietyDate);
                setSobrietyDays(days);
                
                // Use the user's custom daily cost, default to 20 if not set
                const dailyCost = userData.dailyCost || 20;
                setMoneySaved(days * dailyCost);
            };
            
            calculateStats();
            const interval = setInterval(calculateStats, 60000);
            return () => clearInterval(interval);
        }
    }, [userData]);

    // Initialize charts when data changes
    useEffect(() => {
        if (currentView === 'progress' && moodChartData && cravingChartData) {
            setTimeout(() => {
                const moodCanvas = document.getElementById('moodChart');
                const cravingCanvas = document.getElementById('cravingCanvas');
                
                // Destroy existing charts
                if (chartRef.current) {
                    chartRef.current.destroy();
                }
                if (cravingChartRef.current) {
                    cravingChartRef.current.destroy();
                }
                
                if (moodCanvas) {
                    const ctx = moodCanvas.getContext('2d');
                    chartRef.current = new Chart(ctx, {
                        type: 'line',
                        data: moodChartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 10
                                }
                            }
                        }
                    });
                }
                
                if (cravingCanvas) {
                    const ctx = cravingCanvas.getContext('2d');
                    cravingChartRef.current = new Chart(ctx, {
                        type: 'line',
                        data: cravingChartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 10
                                }
                            }
                        }
                    });
                }
            }, 100);
        }
    }, [currentView, moodChartData, cravingChartData]);

    // Check profile completion
    useEffect(() => {
        if (userData && !userData.profileComplete) {
            const checkProfileCompletion = () => {
                if (userData.firstName && userData.lastName && userData.phone) {
                    db.collection('users').doc(user.uid).update({
                        profileComplete: true
                    });
                } else if (!showModal) {
                    setTimeout(() => {
                        if (!localStorage.getItem('profilePromptShown')) {
                            setShowModal('profilePrompt');
                            localStorage.setItem('profilePromptShown', 'true');
                        }
                    }, 5000);
                }
            };
            checkProfileCompletion();
        }
    }, [userData, showModal]);

    // Auto-refresh tasks at midnight (user's timezone)
    // NOTE: Timezone is NEVER hardcoded - always uses user's profile setting
    useEffect(() => {
        const checkMidnightReset = () => {
            const now = new Date();
            const userTimezone = user.timezone || "America/Los_Angeles";
            const userNow = new Date(now.toLocaleString("en-US", {timeZone: userTimezone}));
            const hours = userNow.getHours();
            const minutes = userNow.getMinutes();
            const seconds = userNow.getSeconds();

            // Calculate milliseconds until midnight (user's timezone)
            const msUntilMidnight = ((23 - hours) * 60 * 60 + (59 - minutes) * 60 + (60 - seconds)) * 1000;
            
            // Set timeout for midnight reset
            const midnightTimer = setTimeout(() => {
                // Reset daily tasks
                loadDailyTasksStatus();
                loadCheckIns();
                setCheckInStatus({ morning: false, evening: false });
                
                // Set up daily interval
                const dailyInterval = setInterval(() => {
                    loadDailyTasksStatus();
                    loadCheckIns();
                    setCheckInStatus({ morning: false, evening: false });
                }, 24 * 60 * 60 * 1000); // Every 24 hours
                
                return () => clearInterval(dailyInterval);
            }, msUntilMidnight);
            
            return () => clearTimeout(midnightTimer);
        };
        
        checkMidnightReset();
    }, []);

    // FIXED: Complete loadAllData function
    const loadAllData = async () => {
        try {
            setLoading(true);
            await loadUserData();
            await Promise.all([
                loadTopicRooms(),
                loadMeetings(),
                loadEmergencyResources(),
                loadGoals(),
                loadAssignments(),
                loadDailyInspiration(),
                loadMilestones(),
                loadBroadcasts(),
                loadResources(),
                loadSupportGroups(),
                loadCheckIns(),
                loadTodaysPledge(),
                loadStreak(),
                loadCoachNotes(),
                loadReflections(),
                loadComplianceRates(),
                calculateMilestones(),
                checkMilestoneNotifications(),
                loadDailyTasksStatus(),
                calculateTotalCheckIns().then(count => setTotalCheckIns(count)),
                calculateStreaks(),
                calculateReflectionStreaks()
            ]);
        } catch (error) {
            console.error('Error loading data:', error);
        } finally {
            setLoading(false);
        }
    };

            // Load user data and coach info
            const loadUserData = async () => {
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        const data = userDoc.data();
                        setUserData(data);
                        
                        if (data.profileImageUrl) {
                            setProfileImage(data.profileImageUrl);
                        }
                        
                        // Load coach info
                        if (data.assignedCoach) {
                            const coachDoc = await db.collection('users').doc(data.assignedCoach).get();
                            if (coachDoc.exists) {
                                setCoachInfo(coachDoc.data());
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error loading user data:', error);
                }
            };

            // Load topic rooms
            const loadTopicRooms = async () => {
                try {
                    const roomsSnap = await db.collection('topicRooms')
                        .where('active', '==', true)
                        .get();
                    
                    const roomsData = [];
                    roomsSnap.forEach(doc => {
                        roomsData.push({ id: doc.id, ...doc.data() });
                    });
                    setTopicRooms(roomsData);
                } catch (error) {
                    console.error('Error loading topic rooms:', error);
                }
            };
            // Add these state variables in TopicRoom component
            // Add state for image modal (near your other state variables)
const [modalImage, setModalImage] = useState(null);

// Image Modal Component (add before the return statement)
const ImageModal = ({ imageUrl, onClose }) => {
    if (!imageUrl) return null;
    
    return (
        <div 
            onClick={onClose}
            style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                backgroundColor: 'rgba(0, 0, 0, 0.9)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 10000,
                cursor: 'pointer'
            }}
        >
            <img 
                src={imageUrl}
                style={{
                    maxWidth: '90%',
                    maxHeight: '90%',
                    objectFit: 'contain'
                }}
                onClick={(e) => e.stopPropagation()}
            />
            <button
                onClick={onClose}
                style={{
                    position: 'absolute',
                    top: '20px',
                    right: '20px',
                    background: 'transparent',
                    border: 'none',
                    color: 'white',
                    fontSize: '30px',
                    cursor: 'pointer'
                }}
            >
                ✕
            </button>
        </div>
    );
};
// ==========================================
// PHASE 2: APP STORE COMPLIANCE MODALS
// ==========================================

// First-Launch Disclaimer Modal
const DisclaimerModal = ({ onAccept }) => {
    const [checkboxChecked, setCheckboxChecked] = useState(false);

    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0,0,0,0.9)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 10000,
            padding: '20px'
        }}>
            <div style={{
                background: '#fff',
                borderRadius: '15px',
                maxWidth: '600px',
                width: '100%',
                maxHeight: '90vh',
                overflow: 'auto'
            }}>
                <div style={{
                    padding: '30px',
                    background: 'linear-gradient(135deg, #0077CC 0%, #00A86B 100%)',
                    color: '#fff',
                    borderRadius: '15px 15px 0 0'
                }}>
                    <h2 style={{ margin: '0 0 10px 0', fontSize: '28px' }}>
                        Welcome to Recovery Compass
                    </h2>
                    <p style={{ margin: 0, fontSize: '16px', opacity: 0.9 }}>
                        Please read this important information before using the app
                    </p>
                </div>

                <div style={{ padding: '30px' }}>
                    <div style={{
                        padding: '20px',
                        background: '#fff3cd',
                        borderRadius: '10px',
                        marginBottom: '20px',
                        border: '1px solid #ffc107'
                    }}>
                        <h3 style={{ margin: '0 0 15px 0', color: '#856404' }}>
                            ⚕️ Medical Disclaimer
                        </h3>
                        <p style={{ margin: 0, fontSize: '14px', color: '#856404', lineHeight: '1.6' }}>
                            <strong>This app is NOT a substitute for professional medical advice, diagnosis, or treatment.</strong>
                            <br/><br/>
                            Recovery Compass is a recovery support tool designed to complement professional treatment.
                            It should not replace in-person therapy, medical care, or emergency services.
                            <br/><br/>
                            <strong>If you are experiencing a medical or mental health emergency, call 911 or go to the nearest emergency room immediately.</strong>
                        </p>
                    </div>

                    <div style={{
                        padding: '20px',
                        background: '#f8f9fa',
                        borderRadius: '10px',
                        marginBottom: '20px'
                    }}>
                        <h3 style={{ margin: '0 0 15px 0', color: '#333', display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <i data-lucide="lock" style={{width: '20px', height: '20px', color: 'var(--color-primary)'}}></i>
                            Privacy & Confidentiality
                        </h3>
                        <p style={{ margin: 0, fontSize: '14px', color: '#666', lineHeight: '1.6' }}>
                            Your privacy is our priority. We use industry-standard encryption and HIPAA-compliant practices
                            to protect your information. However, no electronic system is 100% secure.
                            Please avoid sharing sensitive information you're not comfortable storing digitally.
                        </p>
                    </div>

                    <div style={{
                        padding: '20px',
                        background: '#f8f9fa',
                        borderRadius: '10px',
                        marginBottom: '20px'
                    }}>
                        <h3 style={{ margin: '0 0 15px 0', color: '#333', display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <i data-lucide="message-circle" style={{width: '20px', height: '20px', color: 'var(--color-primary)'}}></i>
                            Peer Support Disclaimer
                        </h3>
                        <p style={{ margin: 0, fontSize: '14px', color: '#666', lineHeight: '1.6' }}>
                            Community features connect you with others in recovery. While peer support can be valuable,
                            remember that other users are not medical professionals. Always consult your healthcare provider
                            for medical advice.
                        </p>
                    </div>

                    <label style={{
                        display: 'flex',
                        alignItems: 'center',
                        padding: '15px',
                        background: '#e7f5ff',
                        borderRadius: '10px',
                        marginBottom: '20px',
                        cursor: 'pointer'
                    }}>
                        <input
                            type="checkbox"
                            checked={checkboxChecked}
                            onChange={(e) => setCheckboxChecked(e.target.checked)}
                            style={{
                                width: '20px',
                                height: '20px',
                                marginRight: '12px',
                                cursor: 'pointer'
                            }}
                        />
                        <span style={{ fontSize: '14px', color: '#333' }}>
                            I have read and understand these disclaimers and agree to the Terms of Service and Privacy Policy
                        </span>
                    </label>

                    <button
                        onClick={() => {
                            if (!checkboxChecked) {
                                alert('Please check the box to confirm you understand and agree');
                                return;
                            }
                            onAccept();
                        }}
                        style={{
                            width: '100%',
                            background: 'linear-gradient(135deg, #0077CC 0%, #00A86B 100%)',
                            color: '#fff',
                            padding: '15px',
                            borderRadius: '8px',
                            border: 'none',
                            fontSize: '16px',
                            fontWeight: 'bold',
                            cursor: 'pointer'
                        }}
                    >
                        Continue to App
                    </button>
                </div>
            </div>
        </div>
    );
};

// Legal Modal Component (Terms, Privacy, Data Handling)
const LegalModal = ({ type, onClose }) => {
    const content = {
        terms: {
            title: 'Terms of Service',
            body: `Last Updated: January 2025

1. ACCEPTANCE OF TERMS
By accessing or using Recovery Compass, you agree to be bound by these Terms of Service.

2. SERVICE DESCRIPTION
Recovery Compass is a recovery support application designed to complement professional treatment.

3. USER RESPONSIBILITIES
- Provide accurate information
- Maintain confidentiality of your account
- Use the service responsibly and lawfully
- Not share sensitive medical information in community features

4. MEDICAL DISCLAIMER
This service is NOT a substitute for professional medical advice. Always consult healthcare providers for medical decisions.

5. PRIVACY
Your use is governed by our Privacy Policy. We protect your data using industry-standard encryption.

6. LIABILITY LIMITATION
Recovery Compass is provided "as is" without warranties. We are not liable for any damages arising from use.

7. TERMINATION
We may suspend or terminate access for violations of these terms.

8. GOVERNING LAW
These terms are governed by the laws of [Your State/Country].

9. CONTACT
For questions: support@glrecoveryservices.com`
        },
        privacy: {
            title: 'Privacy Policy',
            body: `Last Updated: January 2025

1. INFORMATION WE COLLECT
- Account information (name, email)
- Recovery data (check-ins, goals, progress)
- Usage data (features accessed, session duration)
- Device information (device type, OS version)

2. HOW WE USE YOUR INFORMATION
- Provide and improve our services
- Communicate with you about your account
- Track your recovery progress
- Personalize your experience
- Comply with legal obligations

3. INFORMATION SHARING
We DO NOT sell your personal information. We may share data only:
- With your explicit consent
- With your assigned coach/treatment team
- To comply with legal requirements
- With service providers under strict confidentiality agreements

4. DATA SECURITY
- Industry-standard encryption (AES-256)
- HIPAA-compliant practices
- Secure data transmission (HTTPS)
- Regular security audits
- Limited employee access

5. YOUR RIGHTS (GDPR/CCPA)
- Access your data
- Correct inaccurate data
- Request data deletion
- Export your data
- Opt out of communications

6. DATA RETENTION
We retain your data while your account is active and for 7 years after closure (HIPAA compliance).

7. COOKIES
We use essential cookies for functionality. No third-party advertising cookies.

8. CHILDREN'S PRIVACY
Our service is not intended for users under 13. We comply with COPPA.

9. CHANGES TO POLICY
We'll notify you of material changes via email or in-app notification.

10. CONTACT
Privacy questions: privacy@glrecoveryservices.com`
        },
        dataHandling: {
            title: 'Data Handling & Your Rights',
            body: `Last Updated: January 2025

WHAT DATA WE COLLECT

Recovery Data:
- Daily check-ins (mood, cravings, anxiety, sleep)
- Goals and assignments
- Progress tracking
- Community messages
- Resource usage

Account Data:
- Name, email, profile photo
- Subscription information
- Login history
- Device information

HOW WE PROTECT YOUR DATA

Encryption:
- AES-256 encryption for sensitive data
- Secure data transmission (HTTPS/TLS)
- Encrypted backups
- Zero-knowledge architecture (where applicable)

Access Controls:
- Role-based access (coaches see only assigned clients)
- Multi-factor authentication available
- Regular security audits
- Employee background checks

HIPAA Compliance:
- Business Associate Agreements with partners
- Regular compliance training
- Breach notification procedures
- Audit logging

YOUR RIGHTS

Access: Request a copy of your data anytime
Correction: Update inaccurate information
Deletion: Request permanent account deletion
Export: Download your data in JSON format
Portability: Transfer data to another service
Opt-out: Unsubscribe from non-essential emails

DATA RETENTION

Active Accounts: Data retained while account is active
Closed Accounts: Data retained for 7 years (HIPAA requirement)
Deletion Requests: 30-day grace period, then permanent deletion
Backups: Removed from backups within 90 days

THIRD-PARTY SERVICES

We use these trusted partners:
- Firebase (Google) - Database and authentication
- Stripe - Payment processing (PCI-DSS compliant)
- SendGrid - Email delivery
All partners sign data processing agreements.

DATA BREACHES

In the unlikely event of a breach:
- You'll be notified within 72 hours
- We'll report to authorities as required
- We'll provide credit monitoring if SSNs exposed
- We'll publish transparency reports

INTERNATIONAL TRANSFERS

Data is stored in US data centers (Firebase).
If you're in EU/EEA, we use Standard Contractual Clauses.

EXERCISING YOUR RIGHTS

Email: privacy@glrecoveryservices.com
Phone: 1-800-XXX-XXXX
In-app: Profile → Settings → Data Management

We respond to requests within 30 days.`
        }
    };

    const selectedContent = content[type] || content.terms;

    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0,0,0,0.7)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 10000,
            padding: '20px'
        }}>
            <div style={{
                background: '#fff',
                borderRadius: '15px',
                maxWidth: '700px',
                width: '100%',
                maxHeight: '90vh',
                display: 'flex',
                flexDirection: 'column'
            }}>
                <div style={{
                    padding: '20px 30px',
                    borderBottom: '1px solid #ddd',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center'
                }}>
                    <h2 style={{ margin: 0, color: '#333', fontSize: '24px' }}>
                        {selectedContent.title}
                    </h2>
                    <button
                        onClick={onClose}
                        style={{
                            background: 'transparent',
                            border: 'none',
                            fontSize: '28px',
                            cursor: 'pointer',
                            color: '#999'
                        }}
                    >
                        ×
                    </button>
                </div>

                <div style={{
                    padding: '30px',
                    overflowY: 'auto',
                    flex: 1
                }}>
                    <pre style={{
                        whiteSpace: 'pre-wrap',
                        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                        fontSize: '14px',
                        lineHeight: '1.6',
                        color: '#333',
                        margin: 0
                    }}>
                        {selectedContent.body}
                    </pre>
                </div>

                <div style={{
                    padding: '20px 30px',
                    borderTop: '1px solid #ddd'
                }}>
                    <button
                        onClick={onClose}
                        style={{
                            width: '100%',
                            background: '#0077CC',
                            color: '#fff',
                            padding: '12px',
                            borderRadius: '8px',
                            border: 'none',
                            fontSize: '16px',
                            fontWeight: 'bold',
                            cursor: 'pointer'
                        }}
                    >
                        Close
                    </button>
                </div>
            </div>
        </div>
    );
};

// Crisis Resources Modal
const CrisisModal = ({ onClose }) => {
    const resources = [
        {
            name: '988 Suicide & Crisis Lifeline',
            number: '988',
            description: '24/7 free and confidential support',
            action: () => window.location.href = 'tel:988'
        },
        {
            name: 'Crisis Text Line',
            number: 'Text HOME to 741741',
            description: 'Free 24/7 text support',
            action: () => window.location.href = 'sms:741741&body=HOME'
        },
        {
            name: 'SAMHSA National Helpline',
            number: '1-800-662-4357',
            description: 'Treatment referral and information',
            action: () => window.location.href = 'tel:18006624357'
        },
        {
            name: 'Veterans Crisis Line',
            number: '988 (Press 1)',
            description: 'Support for veterans and their families',
            action: () => window.location.href = 'tel:988'
        },
        {
            name: 'Emergency Services',
            number: '911',
            description: 'Life-threatening emergencies',
            action: () => window.location.href = 'tel:911'
        }
    ];

    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0,0,0,0.7)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 10000,
            padding: '20px'
        }}>
            <div style={{
                background: '#fff',
                borderRadius: '15px',
                maxWidth: '500px',
                width: '100%',
                maxHeight: '90vh',
                overflow: 'auto'
            }}>
                <div style={{
                    padding: '20px',
                    borderBottom: '2px solid #DC143C',
                    background: '#DC143C',
                    color: '#fff',
                    borderRadius: '15px 15px 0 0'
                }}>
                    <h2 style={{ margin: 0, fontSize: '24px', display: 'flex', alignItems: 'center', gap: '10px' }}>
                        <i data-lucide="alert-octagon" style={{width: '28px', height: '28px'}}></i>
                        Crisis Resources
                    </h2>
                    <p style={{ margin: '10px 0 0 0', fontSize: '14px', opacity: 0.9 }}>
                        If you're in crisis or need immediate help, please use one of these resources
                    </p>
                </div>

                <div style={{ padding: '20px' }}>
                    {resources.map((resource, index) => (
                        <div key={index} style={{
                            padding: '15px',
                            marginBottom: '15px',
                            background: '#f8f9fa',
                            borderRadius: '10px',
                            border: '1px solid #ddd'
                        }}>
                            <h3 style={{ margin: '0 0 5px 0', color: '#333', fontSize: '18px' }}>
                                {resource.name}
                            </h3>
                            <p style={{ margin: '0 0 10px 0', color: '#666', fontSize: '14px' }}>
                                {resource.description}
                            </p>
                            <button
                                onClick={resource.action}
                                style={{
                                    background: '#DC143C',
                                    color: '#fff',
                                    padding: '10px 20px',
                                    borderRadius: '8px',
                                    border: 'none',
                                    fontSize: '16px',
                                    fontWeight: 'bold',
                                    cursor: 'pointer',
                                    width: '100%'
                                }}
                            >
                                <i data-lucide="phone" style={{width: '18px', height: '18px', marginRight: '8px'}}></i>
                                {resource.number}
                            </button>
                        </div>
                    ))}

                    <div style={{
                        marginTop: '20px',
                        padding: '15px',
                        background: '#fff3cd',
                        borderRadius: '10px',
                        border: '1px solid #ffc107'
                    }}>
                        <p style={{ margin: 0, fontSize: '13px', color: '#856404' }}>
                            <strong>⚠️ Important:</strong> If you or someone else is in immediate danger, call 911 or go to the nearest emergency room.
                        </p>
                    </div>

                    <button
                        onClick={onClose}
                        style={{
                            marginTop: '20px',
                            background: '#6c757d',
                            color: '#fff',
                            padding: '12px',
                            borderRadius: '8px',
                            border: 'none',
                            fontSize: '16px',
                            cursor: 'pointer',
                            width: '100%'
                        }}
                    >
                        Close
                    </button>
                </div>
            </div>
        </div>
    );
};
const [selectedImage, setSelectedImage] = useState(null);
const [uploading, setUploading] = useState(false);

// Image selection handler - UPDATED
const handleTopicImageSelect = (e) => {
    const file = e.target.files[0];
    if (file) {
        // Remove the size check here since we'll compress it
        setSelectedImage(file);
    }
};

// Update handleSendMessage in TopicRoom - UPDATED
const handleSendMessage = async () => {
    if ((!topicMessage.trim() && !selectedImage) || uploading) return;
    
    try {
        setUploading(true);
        const messageData = {
            senderId: user.uid,  // Changed from userId to senderId to match display
            senderName: userData?.displayName || userData?.firstName || 'Anonymous',
            content: topicMessage,  // Changed from 'message' to 'content' to match display
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            roomId: data.activeTopicRoom.id  // Changed from selectedRoom to data.activeTopicRoom
        };
        
        // Upload image if selected
        if (selectedImage) {
            const imageUrl = await uploadChatImage(selectedImage, 'topic', data.activeTopicRoom.id);
            messageData.imageUrl = imageUrl;
            messageData.imageName = selectedImage.name;
        }
        
        await db.collection('topicRooms').doc(data.activeTopicRoom.id)
            .collection('messages').add(messageData);
        
        setTopicMessage('');  // Changed from setNewMessage to setTopicMessage
        setSelectedImage(null);
        const fileInput = document.getElementById('topic-image-input');
        if (fileInput) fileInput.value = '';
    } catch (error) {
        console.error('Error sending message:', error);
        alert(error.message || 'Failed to send message');
    } finally {
        setUploading(false);
    }
};

// Flag handler for topic messages
const handleFlagTopicMessage = async (message) => {
    const flagData = {
        roomId: selectedRoom.id,
        roomName: selectedRoom.name,
        messageId: message.id,
        messageContent: message.message,
        messageImageUrl: message.imageUrl || null,
        authorId: message.userId,
        authorName: message.userName
    };
    
    const flagged = await flagContent('topic_message', flagData);
    if (flagged) {
        // Optionally remove from local view
        setMessages(prev => prev.filter(m => m.id !== message.id));
    }
};

           // Load meetings
const loadMeetings = async () => {
    try {
        const currentUserId = auth.currentUser?.uid;
        if (!currentUserId) return;

        // Get meetings where this PIR is specifically assigned
        const assignedMeetingsSnap = await db.collection('meetings')
            .where('assignedPIRs', 'array-contains', currentUserId)
            .where('status', '==', 'scheduled')
            .get();
        
        // Get global meetings (for all PIRs)
        const globalMeetingsSnap = await db.collection('meetings')
            .where('isGlobal', '==', true)
            .where('status', '==', 'scheduled')
            .get();
        
        // Combine both results and remove duplicates
        const meetingsMap = new Map();
        
        assignedMeetingsSnap.forEach(doc => {
            meetingsMap.set(doc.id, { id: doc.id, ...doc.data() });
        });
        
        globalMeetingsSnap.forEach(doc => {
            if (!meetingsMap.has(doc.id)) {
                meetingsMap.set(doc.id, { id: doc.id, ...doc.data() });
            }
        });
        
        // Convert to array and sort by scheduled time
        const meetingsData = Array.from(meetingsMap.values()).sort((a, b) => {
            const timeA = a.scheduledTime?.toDate ? a.scheduledTime.toDate() : new Date(a.scheduledTime);
            const timeB = b.scheduledTime?.toDate ? b.scheduledTime.toDate() : new Date(b.scheduledTime);
            return timeA - timeB;
        });
        
        setMeetings(meetingsData);
    } catch (error) {
        console.error('Error loading meetings:', error);
    }
};

            // Load support groups user is assigned to
           const loadSupportGroups = async () => {
    try {
        const groupsSnap = await db.collection('supportGroups')
            .where('active', '==', true)
            .orderBy('day')
            .get();
        
        const groupsData = [];
        groupsSnap.forEach(doc => {
            groupsData.push({ id: doc.id, ...doc.data() });
        });
        setSupportGroups(groupsData);
    } catch (error) {
        console.error('Error loading support groups:', error);
    }
};

            // Load emergency resources
            const loadEmergencyResources = async () => {
                try {
                    const emergencySnap = await db.collection('resources')
                        .where('category', '==', 'emergency')
                        .where('active', '==', true)
                        .get();
                    
                    const emergencyData = [];
                    emergencySnap.forEach(doc => {
                        emergencyData.push({ id: doc.id, ...doc.data() });
                    });
                    setEmergencyResources(emergencyData);
                } catch (error) {
                    console.error('Error loading emergency resources:', error);
                }
            };

           // Load goals with objectives - UPDATED VERSION
const loadGoals = async () => {
    try {
        // Load ALL goals, not just active ones
        const goalsSnap = await db.collection('goals')
            .where('userId', '==', user.uid)
            .orderBy('createdAt', 'desc')
            .get();
        
        const goalsData = [];
        for (const doc of goalsSnap.docs) {
            const goalData = { id: doc.id, ...doc.data() };
            
            // Load assignments for this goal
            const assignmentsSnap = await db.collection('assignments')
                .where('goalId', '==', doc.id)
                .where('userId', '==', user.uid)
                .get();
            
            const assignments = [];
            assignmentsSnap.forEach(aDoc => {
                assignments.push({ id: aDoc.id, ...aDoc.data() });
            });
            
            goalData.assignments = assignments;
            
            // Calculate goal progress
            const completed = assignments.filter(a => a.status === 'completed').length;
            goalData.progress = assignments.length > 0 ? 
                Math.round((completed / assignments.length) * 100) : 0;
            
            goalsData.push(goalData);
        }
        
        setGoals(goalsData);
        
        // Update lifetime stats
        updateLifetimeStats(goalsData);
    } catch (error) {
        console.error('Error loading goals:', error);
    }
};

// Load standalone assignments - UPDATED VERSION
const loadAssignments = async () => {
    try {
        const assignmentsSnap = await db.collection('assignments')
            .where('userId', '==', user.uid)
            .orderBy('createdAt', 'desc')
            .get();
        
        const assignmentsData = [];
        assignmentsSnap.forEach(doc => {
            const assignment = { id: doc.id, ...doc.data() };
            assignmentsData.push(assignment);
        });
        
        setAssignments(assignmentsData);
        
        // Update lifetime completed count
        const completedCount = assignmentsData.filter(a => a.status === 'completed').length;
        updateLifetimeCompletedTasks(completedCount);
        
    } catch (error) {
        console.error('Error loading assignments:', error);
    }
};
  // Calculate today's tasks (morning check-in + evening reflection + assignments)
const loadDailyTasksStatus = async () => {
    try {
        // Get user's timezone midnight boundaries (uses user.timezone preference, defaults to PST)
        // NOTE: Timezone is NEVER hardcoded - always uses user's profile setting
        const userTimezone = user.timezone || "America/Los_Angeles";
        const userNow = new Date(new Date().toLocaleString("en-US", {timeZone: userTimezone}));
        const today = new Date(userNow);
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        // Check for today's check-ins
        const todayCheckInsSnap = await db.collection('checkIns')
            .where('userId', '==', user.uid)
            .where('createdAt', '>=', today)
            .where('createdAt', '<', tomorrow)
            .get();
        
        let morningDone = false;
        let eveningDone = false;
        
        todayCheckInsSnap.forEach(doc => {
            const data = doc.data();
            if (data.morningData) morningDone = true;
            if (data.eveningData) eveningDone = true;
        });
        
        // Get ALL assignments (not just incomplete) to properly track today's work
        const assignmentsSnap = await db.collection('assignments')
            .where('userId', '==', user.uid)
            .get();
        
        const todayAssignments = [];
        let todayCompletedAssignments = 0;
        
        assignmentsSnap.forEach(doc => {
            const data = doc.data();
            const dueDate = data.dueDate?.toDate ? data.dueDate.toDate() : null;
            const completedAt = data.completedAt?.toDate ? data.completedAt.toDate() : null;
            
            // Check if this assignment is relevant for today
            let isRelevantForToday = false;
            
            if (dueDate) {
                const dueDateString = dueDate.toDateString();
                const todayString = today.toDateString();
                // Include if due today or overdue (and not completed before today)
                if (dueDateString === todayString || (dueDate < today && (!completedAt || completedAt >= today))) {
                    isRelevantForToday = true;
                }
            } else if (!data.dueDate && (!completedAt || completedAt >= today)) {
                // Include assignments without due dates that aren't already completed before today
                isRelevantForToday = true;
            }
            
            if (isRelevantForToday) {
                todayAssignments.push({ id: doc.id, ...data });
                
                // Check if it was completed TODAY
                if (completedAt && completedAt >= today && completedAt < tomorrow) {
                    todayCompletedAssignments++;
                }
            }
        });
        
        // Filter to get only incomplete assignments for display
        const incompleteAssignments = todayAssignments.filter(a => a.status !== 'completed');
        
        // Calculate totals
        const totalDailyTasks = 2; // Morning + Evening
        const completedDailyTasks = (morningDone ? 1 : 0) + (eveningDone ? 1 : 0);
        const totalTasks = totalDailyTasks + incompleteAssignments.length + todayCompletedAssignments;
        const completedTasks = completedDailyTasks + todayCompletedAssignments;
        
        // Update dashboard display
        const tasksStatElement = document.querySelector('.tasks-stat');
        if (tasksStatElement) {
            tasksStatElement.textContent = `${completedTasks}/${totalTasks} Today`;
        }
        
        // Set check-in status for UI
        setCheckInStatus({ morning: morningDone, evening: eveningDone });
        console.log('✅ setCheckInStatus called with:', { morning: morningDone, evening: eveningDone });
        
        return {
            totalTasks,
            completedTasks,
            morningDone,
            eveningDone,
            assignments: incompleteAssignments, // Return only incomplete for display
            completedAssignmentsToday: todayCompletedAssignments
        };
    } catch (error) {
        console.error('Error loading daily tasks:', error);
        return {
            totalTasks: 2,
            completedTasks: 0,
            morningDone: false,
            eveningDone: false,
            assignments: [],
            completedAssignmentsToday: 0
        };
    }
};

// Update lifetime stats with correct active goals calculation
const updateLifetimeStats = (goalsData) => {
    if (!goalsData) return;
    
    const completedGoals = goalsData.filter(g => g.status === 'completed').length;
    const activeGoals = goalsData.filter(g => g.status === 'active').length;
    const totalGoals = goalsData.length;
    
    // Update dashboard elements
    const goalsStatElement = document.querySelector('.goals-stat');
    if (goalsStatElement) {
        if (activeGoals === 0) {
            goalsStatElement.textContent = '0 Active';
        } else {
            goalsStatElement.textContent = `${activeGoals} Active / ${completedGoals} Complete`;
        }
    }
};

// Update lifetime completed tasks count
const updateLifetimeCompletedTasks = (count) => {
    const tasksStatElement = document.querySelector('.lifetime-tasks-stat');
    if (tasksStatElement) {
        tasksStatElement.textContent = count;
    }
};

// Handler for assignment completion - UPDATED with Goal Progress
const handleAssignmentComplete = async (assignmentId, isCompleted) => {
    try {
        // First, get the assignment to check if it has a goalId
        const assignmentDoc = await db.collection('assignments').doc(assignmentId).get();
        const assignment = assignmentDoc.exists ? { id: assignmentDoc.id, ...assignmentDoc.data() } : null;
        
        if (!assignment) {
            throw new Error('Assignment not found');
        }
        
        // Update the assignment
        const updates = {
            status: isCompleted ? 'completed' : 'pending',
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (isCompleted) {
            updates.completedAt = firebase.firestore.FieldValue.serverTimestamp();
        } else {
            updates.completedAt = null;
            updates.reflection = null;
        }
        
        await db.collection('assignments').doc(assignmentId).update(updates);
        
        // Update goal progress if this assignment belongs to a goal
        if (assignment.goalId) {
            await updateGoalProgress(assignment.goalId);
        }
        
        // Reload both assignments and goals to update all progress calculations
        await loadAssignments();
        await loadGoals();
        
        // Update the GoalsTasksView if it exists
        if (window.goalsTasksViewInstance) {
            window.goalsTasksViewInstance.forceUpdate();
        }
        
        // If completed, send notification to coach
        if (isCompleted && userData?.assignedCoach) {
            await db.collection('notifications').add({
                userId: userData.assignedCoach,
                senderId: user.uid,
                senderName: userData.displayName || userData.firstName || 'PIR',
                type: 'assignment_completed',
                title: 'Assignment Completed',
                message: `${userData.displayName || 'PIR'} completed: ${assignment.title}`,
                assignmentId: assignmentId,
                read: false,
                urgent: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        // Show success feedback
        const feedbackMsg = isCompleted ? 'Assignment marked complete!' : 'Assignment marked incomplete';
        showNotification(feedbackMsg, 'success');
        
    } catch (error) {
        console.error('Error updating assignment:', error);
        showNotification('Failed to update assignment', 'error');
    }
};

// Handler for saving reflection with assignment
const handleReflectionSave = async (assignmentId, reflection) => {
    try {
        await db.collection('assignments').doc(assignmentId).update({
            status: 'completed',
            reflection: reflection,
            completedAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Reload both to update progress everywhere
        await loadAssignments();
        await loadGoals();
        
        // Send notification to coach with reflection
        const assignment = assignments.find(a => a.id === assignmentId);
        if (assignment && userData?.assignedCoach) {
            await db.collection('notifications').add({
                userId: userData.assignedCoach,
                senderId: user.uid,
                senderName: userData.displayName || userData.firstName || 'PIR',
                type: 'assignment_reflection',
                title: 'Assignment Completed with Reflection',
                message: `${userData.displayName || 'PIR'} completed with reflection: ${assignment.title}`,
                reflection: reflection,
                assignmentId: assignmentId,
                read: false,
                urgent: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        showNotification('Assignment completed with reflection!', 'success');
    } catch (error) {
        console.error('Error saving reflection:', error);
        showNotification('Failed to save reflection', 'error');
    }
};

// Helper function to show notifications (add if not exists)
const showNotification = (message, type = 'info') => {
    // Trigger haptic feedback
    if (navigator.vibrate) {
        navigator.vibrate(type === 'success' ? [10, 50, 10] : type === 'error' ? [50, 100, 50] : 10);
    }

    // Create notification container
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: var(--space-4);
        right: var(--space-4);
        background: ${type === 'success' ? 'var(--color-success)' : type === 'error' ? 'var(--color-danger)' : 'var(--color-info)'};
        color: white;
        padding: var(--space-4) var(--space-6);
        border-radius: var(--radius-lg);
        box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        z-index: 10000;
        animation: slideIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        display: flex;
        align-items: center;
        gap: var(--space-3);
        max-width: 400px;
        backdrop-filter: blur(10px);
    `;

    // Add icon based on type
    const icon = document.createElement('i');
    icon.setAttribute('data-lucide', type === 'success' ? 'check-circle' : type === 'error' ? 'alert-circle' : 'info');
    icon.style.cssText = 'width: 20px; height: 20px; flex-shrink: 0;';

    // Add message text
    const text = document.createElement('span');
    text.textContent = message;
    text.style.cssText = 'font-size: var(--font-sm); font-weight: 500;';

    notification.appendChild(icon);
    notification.appendChild(text);
    document.body.appendChild(notification);

    // Initialize icon
    if (window.lucide) {
        window.lucide.createIcons();
    }

    // Auto-dismiss after 3 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, 3000);
};
      // Fixed upload handler - saves data URL directly with message
const uploadChatImage = async (file, chatType, roomId) => {
    if (!file) return null;
    
    return new Promise((resolve, reject) => {
        // First compress the image
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                // Create canvas for compression
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Set max dimensions
                const maxWidth = 800;
                const maxHeight = 800;
                let width = img.width;
                let height = img.height;
                
                // Calculate new dimensions
                if (width > height) {
                    if (width > maxWidth) {
                        height = (maxWidth / width) * height;
                        width = maxWidth;
                    }
                } else {
                    if (height > maxHeight) {
                        width = (maxHeight / height) * width;
                        height = maxHeight;
                    }
                }
                
                // Set canvas size and draw compressed image
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                
                // Convert to data URL directly
                const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                
                // Check size
                if (dataUrl.length > 900000) { // ~900KB limit for safety
                    alert('Image too large. Please choose a smaller image.');
                    reject(new Error('Image too large after compression'));
                    return;
                }
                
                // Return the data URL directly - no Firestore save needed here
                resolve(dataUrl);
            };
            img.onerror = () => reject(new Error('Failed to load image'));
            img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
};
// Shared content flagging handler (this one is fine)
const flagContent = async (contentType, contentData) => {
    const reason = prompt('Please describe why you are flagging this content:');
    if (!reason) return false;
    
    try {
        await db.collection('flaggedContent').add({
            contentType: contentType, // 'topic_message' or 'community_message'
            ...contentData,
            flaggedBy: user.uid,
            flaggedByName: userData?.displayName || userData?.firstName || 'PIR',
            reason: reason,
            status: 'pending',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert('Thank you. This content has been flagged for review.');
        return true;
    } catch (error) {
        console.error('Error flagging content:', error);
        alert('Failed to flag content');
        return false;
    }
};

// ALL FUNCTIONS GO HERE BEFORE THE RETURN STATEMENT
const getRecoveryMilestones = (sobrietyDate) => {
    if (!sobrietyDate) return [];
    
    const startDate = new Date(sobrietyDate);
    const milestones = [
        { days: 1, title: '24 Hours Clean', icon: 'star' },
        { days: 7, title: '1 Week Clean', icon: 'calendar' },
        { days: 30, title: '1 Month Clean', icon: 'award' },
        { days: 60, title: '2 Months Clean', icon: 'trending-up' },
        { days: 90, title: '3 Months Clean', icon: 'target' },
        { days: 100, title: '100 Days Clean', icon: 'check-circle' },
        { days: 120, title: '4 Months Clean', icon: 'star' },
        { days: 150, title: '5 Months Clean', icon: 'sunrise' },
        { days: 180, title: '6 Months Clean', icon: 'zap' },
        { days: 200, title: '200 Days Clean', icon: 'sparkles' },
        { days: 210, title: '7 Months Clean', icon: 'star' },
        { days: 240, title: '8 Months Clean', icon: 'medal' },
        { days: 270, title: '9 Months Clean', icon: 'gem' },
        { days: 300, title: '10 Months Clean', icon: 'flower' },
        { days: 330, title: '11 Months Clean', icon: 'gift' },
        { days: 365, title: '1 Year Clean', icon: 'cake' },
        { days: 500, title: '500 Days Clean', icon: 'award' },
        { days: 548, title: '18 Months Clean', icon: 'star' },
        { days: 730, title: '2 Years Clean', icon: 'crown' },
        { days: 1000, title: '1000 Days Clean', icon: 'medal' },
        { days: 1095, title: '3 Years Clean', icon: 'zap' },
        { days: 1460, title: '4 Years Clean', icon: 'star' },
        { days: 1825, title: '5 Years Clean', icon: 'sparkles' }
    ];
    
    // Add more yearly milestones dynamically
    for (let year = 6; year <= 20; year++) {
        milestones.push({
            days: year * 365,
            title: `${year} Years Clean`,
            icon: 'star'
        });
    }
    
    const today = new Date();
    const daysSober = Math.floor((today - startDate) / (1000 * 60 * 60 * 24)) + 1;
    
    return milestones.map(milestone => {
        const milestoneDate = new Date(startDate);
        milestoneDate.setDate(milestoneDate.getDate() + milestone.days - 1);
        
        return {
            ...milestone,
            date: milestoneDate,
            achieved: daysSober >= milestone.days,
            isToday: daysSober === milestone.days,
            isTomorrow: daysSober === (milestone.days - 1),
            daysUntil: milestone.days - daysSober,
            type: 'recovery' // Mark as recovery milestone
        };
    });
};

// Check for milestone notifications
const checkMilestoneNotifications = async () => {
    if (!userData?.sobrietyDate) return;
    
    const recoveryMilestones = getRecoveryMilestones(userData.sobrietyDate);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    for (const milestone of recoveryMilestones) {
        // Check if notification already sent today
        const existingNotif = await db.collection('notifications')
            .where('recipientId', '==', user.uid)
            .where('type', 'in', ['milestone_today', 'milestone_tomorrow'])
            .where('milestoneTitle', '==', milestone.title)
            .where('createdAt', '>=', today)
            .limit(1)
            .get();
        
        if (!existingNotif.empty) continue;
        
        // Send notification for milestone TODAY
        if (milestone.isToday) {
            // Notify PIR
            await db.collection('notifications').add({
                recipientId: user.uid,
                type: 'milestone_today',
                message: `Congratulations! You've reached ${milestone.title}!`,
                milestoneTitle: milestone.title,
                icon: milestone.icon,
                read: false,
                urgent: true,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Notify Coach
            if (userData.assignedCoach) {
                await db.collection('notifications').add({
                    recipientId: userData.assignedCoach,
                    senderId: user.uid,
                    senderName: userData.displayName || userData.firstName || 'PIR',
                    type: 'pir_milestone_achieved',
                    message: `${userData.displayName || 'PIR'} reached ${milestone.title}!`,
                    milestoneTitle: milestone.title,
                    icon: milestone.icon,
                    read: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        }
        
        // Send notification for milestone TOMORROW
        if (milestone.isTomorrow) {
            // Notify PIR
            await db.collection('notifications').add({
                recipientId: user.uid,
                type: 'milestone_tomorrow',
                message: `Tomorrow you'll reach ${milestone.title}! Keep going!`,
                milestoneTitle: milestone.title,
                icon: milestone.icon,
                read: false,
                urgent: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Notify Coach
            if (userData.assignedCoach) {
                await db.collection('notifications').add({
                    recipientId: userData.assignedCoach,
                    senderId: user.uid,
                    senderName: userData.displayName || userData.firstName || 'PIR',
                    type: 'pir_milestone_upcoming',
                    message: `${userData.displayName || 'PIR'} will reach ${milestone.title} tomorrow`,
                    milestoneTitle: milestone.title,
                    icon: milestone.icon,
                    read: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        }
    }
};

// Load daily inspiration (rotates by day of year)
const loadDailyInspiration = async () => {
    try {
        const inspirationsSnap = await db.collection('dailyInspirations')
            .where('active', '==', true)
            .get();
        
        if (!inspirationsSnap.empty) {
            const inspirations = [];
            inspirationsSnap.forEach(doc => {
                inspirations.push({ id: doc.id, ...doc.data() });
            });
            
            // Use day of year for consistent daily rotation
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
            const index = dayOfYear % inspirations.length;
            setDailyQuote(inspirations[index]);
        } else {
            setDailyQuote({
                quote: "One day at a time.",
                author: "Recovery Wisdom"
            });
        }
    } catch (error) {
        console.error('Error loading inspiration:', error);
        setDailyQuote({
            quote: "Progress, not perfection.",
            author: "Recovery Wisdom"
        });
    }
};

// Load milestones
const loadMilestones = async () => {
    try {
        const milestonesSnap = await db.collection('milestones')
            .orderBy('daysRequired', 'asc')
            .get();
        
        const milestonesData = [];
        milestonesSnap.forEach(doc => {
            milestonesData.push({ id: doc.id, ...doc.data() });
        });
        setMilestones(milestonesData);
        
        // Calculate next milestone
        if (userData?.sobrietyDate) {
            const daysClean = Math.floor((new Date() - new Date(userData.sobrietyDate)) / (1000 * 60 * 60 * 24));
            const next = milestonesData.find(m => m.daysRequired > daysClean);
            setNextMilestone(next);
        }
    } catch (error) {
        console.error('Error loading milestones:', error);
    }
};

// Load broadcasts
const loadBroadcasts = async () => {
    try {
        const broadcastsSnap = await db.collection('broadcasts')
            .where('active', '==', true)
            .orderBy('createdAt', 'desc')
            .limit(1)
            .get();
        
        if (!broadcastsSnap.empty && !broadcastDismissed) {
            const broadcast = broadcastsSnap.docs[0].data();
            setActiveBroadcast(broadcast);
        }
    } catch (error) {
        console.error('Error loading broadcasts:', error);
    }
};

// Add this to your PIRApp component's loadResources function - REPLACE the existing loadResources function
const loadResources = async () => {
    try {
        // Get ALL resources that are either global OR specifically assigned to this PIR
        const resourcesSnap = await db.collection('resources')
            .where('active', '==', true)
            .get();
        
        const resourcesData = {
            videos: [],
            articles: [], 
            tools: [],
            worksheets: []
        };
        
        resourcesSnap.forEach(doc => {
            const resource = { id: doc.id, ...doc.data() };
            
            // Skip emergency resources - they're handled separately
            if (resource.category === 'emergency') return;
            
            // Check if PIR should see this resource
            const shouldShowResource = 
                resource.isGlobal === true || // Global resource
                (resource.assignedPIRs && resource.assignedPIRs.includes(user.uid)) || // Specifically assigned
                resource.userId === user.uid; // Created for this PIR
            
            if (!shouldShowResource) return;
            
            // Categorize by type
            if (resource.type === 'video') {
                resourcesData.videos.push(resource);
            } else if (resource.type === 'article') {
                resourcesData.articles.push(resource);
            } else if (resource.type === 'tool') {
                resourcesData.tools.push(resource);
            } else if (resource.type === 'worksheet') {
                resourcesData.worksheets.push(resource);
            }
        });
        
        setResources(resourcesData);
    } catch (error) {
        console.error('Error loading resources:', error);
    }
};

// Load check-ins and prepare chart data
const loadCheckIns = async () => {
    try {
        const checkInsSnapshot = await db.collection('checkIns')
            .where('userId', '==', user.uid)
            .orderBy('createdAt', 'desc')
            .limit(30)
            .get();
        
        const checkInsList = [];
        checkInsSnapshot.forEach(doc => {
            checkInsList.push({ id: doc.id, ...doc.data() });
        });
        setCheckIns(checkInsList);
        
        // Check today's status
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        const todayCheckIn = checkInsList.find(checkIn => {
            const checkInDate = checkIn.createdAt?.toDate ? 
                checkIn.createdAt.toDate() : new Date(checkIn.createdAt);
            return checkInDate >= today && checkInDate < tomorrow;
        });
        
        if (todayCheckIn) {
            setCheckInStatus({
                morning: !!todayCheckIn.morningData,
                evening: !!todayCheckIn.eveningData
            });
        }
        
        // Prepare chart data
        prepareChartData(checkInsList);
    } catch (error) {
        console.error('Error loading check-ins:', error);
    }
};

// Load all check-ins for streak modal
const loadStreakCheckIns = async () => {
    try {
        // Load enough check-ins to cover potential streak (last 90 days should be more than enough)
        const checkInsSnapshot = await db.collection('checkIns')
            .where('userId', '==', user.uid)
            .orderBy('createdAt', 'desc')
            .limit(90)
            .get();

        const allCheckIns = [];
        checkInsSnapshot.forEach(doc => {
            allCheckIns.push({ id: doc.id, ...doc.data() });
        });

        // Calculate consecutive days from today backwards
        const streakList = [];
        // Get user's timezone midnight boundaries (uses user.timezone preference, defaults to PST)
        // NOTE: Timezone is NEVER hardcoded - always uses user's profile setting
        const userTimezone = user.timezone || "America/Los_Angeles";
        const userNow = new Date(new Date().toLocaleString("en-US", {timeZone: userTimezone}));
        const today = new Date(userNow);
        today.setHours(0, 0, 0, 0);

        let currentDate = new Date(today);
        let consecutiveDays = true;
        let dayIndex = 0;

        while (consecutiveDays && dayIndex < 365) {
            const nextDay = new Date(currentDate);
            nextDay.setDate(nextDay.getDate() + 1);

            // Find check-in for current date
            const dayCheckIn = allCheckIns.find(checkIn => {
                const checkInDate = checkIn.createdAt?.toDate ?
                    checkIn.createdAt.toDate() : new Date(checkIn.createdAt);
                // Convert check-in date to user's timezone (to match currentDate's calculation)
                const checkInUserTZ = new Date(checkInDate.toLocaleString("en-US", {timeZone: userTimezone}));
                checkInUserTZ.setHours(0, 0, 0, 0);
                return checkInUserTZ.getTime() === currentDate.getTime();
            });

            if (dayCheckIn) {
                streakList.push(dayCheckIn);
                currentDate.setDate(currentDate.getDate() - 1);
                dayIndex++;
            } else {
                // Allow grace period for today if before 6pm (user's timezone)
                if (dayIndex === 0 && userNow.getHours() < 18) {
                    currentDate.setDate(currentDate.getDate() - 1);
                    dayIndex++;
                    continue;
                }
                consecutiveDays = false;
            }
        }

        setStreakCheckIns(streakList);

        // 🔍 DEBUG: Log streak modal data
        console.log('🔍 STREAK MODAL DEBUG:', {
            todayISO: today.toISOString(),
            todayUserTimezone: today.toLocaleString("en-US", {timeZone: userTimezone}),
            userTimezone: userTimezone,
            totalCheckIns: allCheckIns.length,
            streakListLength: streakList.length,
            streakDates: streakList.map(c => {
                const utcDate = c.createdAt?.toDate ? c.createdAt.toDate() : null;
                const userTZDate = utcDate ? new Date(utcDate.toLocaleString("en-US", {timeZone: userTimezone})) : null;
                return {
                    dateUTC: utcDate ? utcDate.toISOString() : 'invalid',
                    dateUserTimezone: userTZDate ? userTZDate.toLocaleString("en-US", {timeZone: userTimezone}) : 'invalid',
                    hasMorningData: !!c.morningData,
                    scores: {
                        mood: c.morningData?.mood,
                        craving: c.morningData?.craving,
                        anxiety: c.morningData?.anxiety,
                        sleep: c.morningData?.sleep
                    }
                };
            })
        });
    } catch (error) {
        console.error('Error loading streak check-ins:', error);
    }
};

// Prepare 30-day scrollable chart data
const prepareChartData = (checkInsList) => {
    const labels = [];
    const moodData = [];
    const cravingData = [];
    const anxietyData = [];
    const sleepData = [];
    
    // Get last 30 days
    for (let i = 29; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        
        const dateStr = date.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric' 
        });
        labels.push(dateStr);
        
        // Find check-in for this date
        const checkIn = checkInsList.find(c => {
            const checkInDate = c.createdAt?.toDate ? 
                c.createdAt.toDate() : new Date(c.createdAt);
            return checkInDate.toDateString() === date.toDateString();
        });
        
        if (checkIn?.morningData) {
            // Use nullish coalescing to properly handle 0 values
            moodData.push(checkIn.morningData.mood ?? null);
            cravingData.push(checkIn.morningData.craving ?? null);
            // Support both old field names (anxietyLevel) and new field names (anxiety)
            anxietyData.push(checkIn.morningData.anxiety ?? checkIn.morningData.anxietyLevel ?? null);
            // Support both old field names (sleepQuality) and new field names (sleep)
            sleepData.push(checkIn.morningData.sleep ?? checkIn.morningData.sleepQuality ?? null);
        } else {
            moodData.push(null);
            cravingData.push(null);
            anxietyData.push(null);
            sleepData.push(null);
        }
    }
    
    setMoodChartData({
        labels: labels,
        datasets: [{
            label: 'Mood',
            data: moodData,
            borderColor: '#4caf50',
            backgroundColor: 'rgba(76, 175, 80, 0.1)',
            tension: 0.4,
            spanGaps: false
        }]
    });
    
    setCravingChartData({
        labels: labels,
        datasets: [{
            label: 'Cravings',
            data: cravingData,
            borderColor: '#ff9800',
            backgroundColor: 'rgba(255, 152, 0, 0.1)',
            tension: 0.4,
            spanGaps: false
        }]
    });
    
    setAnxietyChartData({
        labels: labels,
        datasets: [{
            label: 'Anxiety',
            data: anxietyData,
            borderColor: '#f44336',
            backgroundColor: 'rgba(244, 67, 54, 0.1)',
            tension: 0.4,
            spanGaps: false
        }]
    });
    
    setSleepChartData({
        labels: labels,
        datasets: [{
            label: 'Sleep Quality',
            data: sleepData,
            borderColor: '#9c27b0',
            backgroundColor: 'rgba(156, 39, 176, 0.1)',
            tension: 0.4,
            spanGaps: false
        }]
    });
};
   

// Enhanced chart initialization with scroll capability
useEffect(() => {
    if (currentView === 'progress' && moodChartData && cravingChartData && anxietyChartData && sleepChartData) {
        setTimeout(() => {
            const moodCanvas = document.getElementById('moodChart');
            const cravingCanvas = document.getElementById('cravingChart');
            const anxietyCanvas = document.getElementById('anxietyChart');
            const sleepCanvas = document.getElementById('sleepChart');
            
            // Destroy existing charts
            if (chartRef.current) {
                chartRef.current.destroy();
            }
            if (cravingChartRef.current) {
                cravingChartRef.current.destroy();
            }
            if (anxietyChartRef.current) {
                anxietyChartRef.current.destroy();
            }
            if (sleepChartRef.current) {
                sleepChartRef.current.destroy();
            }
            
            // Chart configuration remains the same
            const chartConfig = {
                type: 'line',
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        tooltip: {
                            enabled: true,
                            callbacks: {
                                label: function(context) {
                                    if (context.parsed.y === null) {
                                        return 'No data';
                                    }
                                    return `${context.dataset.label}: ${context.parsed.y}/10`;
                                }
                            }
                        },
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: true,
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x',
                            },
                            pan: {
                                enabled: true,
                                mode: 'x',
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Level (0-10)'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            };
            
            if (moodCanvas) {
                const ctx = moodCanvas.getContext('2d');
                chartRef.current = new Chart(ctx, {
                    ...chartConfig,
                    data: moodChartData
                });
            }
            
            if (cravingCanvas) {
                const ctx = cravingCanvas.getContext('2d');
                cravingChartRef.current = new Chart(ctx, {
                    ...chartConfig,
                    data: cravingChartData
                });
            }
            
            if (anxietyCanvas) {
                const ctx = anxietyCanvas.getContext('2d');
                anxietyChartRef.current = new Chart(ctx, {
                    ...chartConfig,
                    data: anxietyChartData
                });
            }
            
            if (sleepCanvas) {
                const ctx = sleepCanvas.getContext('2d');
                sleepChartRef.current = new Chart(ctx, {
                    ...chartConfig,
                    data: sleepChartData
                });
            }
        }, 100);
    }
}, [currentView, moodChartData, cravingChartData, anxietyChartData, sleepChartData]);
    
// Load today's pledge status
const loadTodaysPledge = async () => {
    try {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        const pledgeSnapshot = await db.collection('pledges')
            .where('userId', '==', user.uid)
            .where('createdAt', '>=', today)
            .where('createdAt', '<', tomorrow)
            .get();
        
        setPledgeMade(!pledgeSnapshot.empty);
    } catch (error) {
        console.error('Error loading pledge:', error);
    }
};

// Load check-in streak and stats
const loadStreak = async () => {
    try {
        // Load last 90 days of check-ins for streak calculation
        const ninetyDaysAgo = new Date();
        ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);

        const checkInsSnapshot = await db.collection('checkIns')
            .where('userId', '==', user.uid)
            .where('createdAt', '>=', ninetyDaysAgo)
            .orderBy('createdAt', 'desc')
            .get();

        const checkInsList = [];
        checkInsSnapshot.forEach(doc => {
            checkInsList.push({ id: doc.id, ...doc.data() });
        });

        setCheckInData(checkInsList);

        // Calculate streak (consecutive days from today backwards)
        let streak = 0;
        // Use user's timezone to match handleMorningCheckIn save logic
        // NOTE: Timezone is NEVER hardcoded - always uses user's profile setting
        const userTimezone = user.timezone || "America/Los_Angeles";
        const userNow = new Date(new Date().toLocaleString("en-US", {timeZone: userTimezone}));
        const today = new Date(userNow);
        today.setHours(0, 0, 0, 0);

        for (let i = 0; i < 365; i++) {
            const checkDate = new Date(today);
            checkDate.setDate(checkDate.getDate() - i);
            checkDate.setHours(0, 0, 0, 0);

            const nextDay = new Date(checkDate);
            nextDay.setDate(nextDay.getDate() + 1);

            const hasCheckIn = checkInsList.some(checkIn => {
                const checkInDate = checkIn.createdAt?.toDate ?
                    checkIn.createdAt.toDate() : new Date(checkIn.createdAt);
                // Convert check-in date to user's timezone (to match today's calculation)
                const checkInUserTZ = new Date(checkInDate.toLocaleString("en-US", {timeZone: userTimezone}));
                checkInUserTZ.setHours(0, 0, 0, 0);
                return checkInUserTZ.getTime() === checkDate.getTime();
            });

            if (hasCheckIn) {
                streak++;
            } else {
                // Allow 1 grace day for today if it's before evening (user's timezone)
                if (i === 0 && userNow.getHours() < 18) {
                    continue;
                }
                break;
            }
        }

        setCheckInStreak(streak);
        console.log('✅ setCheckInStreak called with value:', streak);

        // 🔍 DEBUG: Log streak calculation results
        console.log('🔍 STREAK DEBUG:', {
            todayISO: today.toISOString(),
            todayUserTimezone: today.toLocaleString("en-US", {timeZone: userTimezone}),
            userTimezone: userTimezone,
            totalCheckInsLast90Days: checkInsList.length,
            streakCalculated: streak,
            checkInDates: checkInsList.slice(0, 5).map(c => {
                const utcDate = c.createdAt?.toDate ? c.createdAt.toDate() : null;
                const userTZDate = utcDate ? new Date(utcDate.toLocaleString("en-US", {timeZone: userTimezone})) : null;
                return {
                    dateUTC: utcDate ? utcDate.toISOString() : 'invalid',
                    dateUserTimezone: userTZDate ? userTZDate.toLocaleString("en-US", {timeZone: userTimezone}) : 'invalid',
                    hasMorningData: !!c.morningData,
                    mood: c.morningData?.mood
                };
            })
        });

        // Calculate weekly stats
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

        const recentCheckIns = checkInsList.filter(checkIn => {
            const checkInDate = checkIn.createdAt?.toDate ?
                checkIn.createdAt.toDate() : new Date(checkIn.createdAt);
            return checkInDate >= sevenDaysAgo;
        });

        // Check rate (percentage of last 30 days with check-ins)
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

        const last30DaysCheckIns = checkInsList.filter(checkIn => {
            const checkInDate = checkIn.createdAt?.toDate ?
                checkIn.createdAt.toDate() : new Date(checkIn.createdAt);
            return checkInDate >= thirtyDaysAgo;
        });

        const checkRate = Math.round((last30DaysCheckIns.length / 30) * 100);

        // Average mood (from last 30 days)
        const moodValues = last30DaysCheckIns
            .filter(c => c.morningData?.mood)
            .map(c => c.morningData.mood);

        const avgMood = moodValues.length > 0
            ? (moodValues.reduce((a, b) => a + b, 0) / moodValues.length).toFixed(1)
            : 0;

        // This week completion (last 7 days)
        const thisWeekCompletion = Math.round((recentCheckIns.length / 7) * 100);

        setWeeklyStats({
            checkRate,
            avgMood: parseFloat(avgMood),
            thisWeekCompletion
        });

    } catch (error) {
        console.error('Error loading streak:', error);
    }
};

// Load coach notes
const loadCoachNotes = async () => {
    try {
        const notesSnapshot = await db.collection('coachNotes')
            .where('userId', '==', user.uid)
            .orderBy('createdAt', 'desc')
            .limit(5)
            .get();

        const notesList = [];
        notesSnapshot.forEach(doc => {
            notesList.push({ id: doc.id, ...doc.data() });
        });

        setCoachNotes(notesList);
    } catch (error) {
        console.error('Error loading coach notes:', error);
    }
};

// Load calendar heatmap data (365 days of check-ins)
const loadCalendarHeatmapData = async () => {
    try {
        // Get user's timezone
        const userTimezone = user.timezone || "America/Los_Angeles";

        // Fetch last 365 days of check-ins
        const oneYearAgo = new Date();
        oneYearAgo.setDate(oneYearAgo.getDate() - 365);

        const snapshot = await db.collection('checkIns')
            .where('userId', '==', user.uid)
            .where('createdAt', '>=', oneYearAgo)
            .orderBy('createdAt', 'desc')
            .get();

        // Process check-ins into calendar data
        const calendarData = {};

        snapshot.docs.forEach(doc => {
            const checkIn = doc.data();
            const checkInDate = checkIn.createdAt?.toDate ?
                checkIn.createdAt.toDate() : new Date(checkIn.createdAt);

            // Convert to user's timezone and extract date components properly
            const checkInUserTZ = new Date(checkInDate.toLocaleString("en-US", {timeZone: userTimezone}));

            // IMPORTANT: Create dateKey from date components, NOT from ISO string
            // ISO string converts back to UTC which can shift the date!
            const year = checkInUserTZ.getFullYear();
            const month = String(checkInUserTZ.getMonth() + 1).padStart(2, '0');
            const day = String(checkInUserTZ.getDate()).padStart(2, '0');
            const dateKey = `${year}-${month}-${day}`;

            if (!calendarData[dateKey]) {
                calendarData[dateKey] = {
                    date: checkInUserTZ,
                    dateKey: dateKey,
                    morningCheckIn: null,
                    eveningCheckIn: null,
                    count: 0
                };
            }

            // Determine if morning or evening check-in
            // IMPORTANT: Only count once per type (morning/evening) per day
            // This prevents duplicate counting if there are multiple documents for the same day
            if (checkIn.morningData && !calendarData[dateKey].morningCheckIn) {
                calendarData[dateKey].morningCheckIn = checkIn.morningData;
                calendarData[dateKey].count++;
            }
            if (checkIn.eveningData && !calendarData[dateKey].eveningCheckIn) {
                calendarData[dateKey].eveningCheckIn = checkIn.eveningData;
                calendarData[dateKey].count++;
            }
        });

        // Convert to array and sort by date
        const calendarArray = Object.values(calendarData).sort((a, b) =>
            new Date(a.dateKey) - new Date(b.dateKey)
        );

        setCalendarHeatmapData(calendarArray);

        // Debug logging to help diagnose date issues
        console.log('📅 CALENDAR HEATMAP DEBUG:', {
            userTimezone: userTimezone,
            totalCheckInDocuments: snapshot.docs.length,
            daysWithData: calendarArray.length,
            last5Days: calendarArray.slice(-5).map(d => ({
                dateKey: d.dateKey,
                hasMorning: !!d.morningCheckIn,
                hasEvening: !!d.eveningCheckIn,
                count: d.count
            }))
        });

    } catch (error) {
        console.error('Error loading calendar heatmap data:', error);
    }
};

// Load 7-day mood data for mood insights modal
const loadMoodWeekData = async () => {
    try {
        // Get user's timezone
        const userTimezone = user.timezone || "America/Los_Angeles";

        // Fetch ALL check-ins (no date limit - pull complete history)
        const snapshot = await db.collection('checkIns')
            .where('userId', '==', user.uid)
            .orderBy('createdAt', 'desc')
            .get();

        // Process check-ins by day
        const moodByDay = {};

        snapshot.docs.forEach(doc => {
            const checkIn = doc.data();
            const checkInDate = checkIn.createdAt?.toDate ?
                checkIn.createdAt.toDate() : new Date(checkIn.createdAt);

            // Convert to user's timezone
            const checkInUserTZ = new Date(checkInDate.toLocaleString("en-US", {timeZone: userTimezone}));

            // Create dateKey
            const year = checkInUserTZ.getFullYear();
            const month = String(checkInUserTZ.getMonth() + 1).padStart(2, '0');
            const day = String(checkInUserTZ.getDate()).padStart(2, '0');
            const dateKey = `${year}-${month}-${day}`;

            // Get mood value (morning check-in mood, scale 1-10)
            const moodValue = checkIn.morningData?.mood;

            if (moodValue) {
                // Store the mood for this day (if multiple check-ins, take the latest/highest)
                if (!moodByDay[dateKey] || moodValue > moodByDay[dateKey].mood) {
                    moodByDay[dateKey] = {
                        dateKey: dateKey,
                        date: checkInUserTZ,
                        mood: moodValue
                    };
                }
            }
        });

        // Convert to array and sort by date (oldest first)
        const moodArray = Object.values(moodByDay).sort((a, b) =>
            new Date(a.dateKey) - new Date(b.dateKey)
        );

        // Split into last week and this week
        const today = new Date();

        // This week = last 7 days (days 0-6 from today)
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(today.getDate() - 7);
        const sevenDaysAgoKey = `${sevenDaysAgo.getFullYear()}-${String(sevenDaysAgo.getMonth() + 1).padStart(2, '0')}-${String(sevenDaysAgo.getDate()).padStart(2, '0')}`;

        // Last week = 7 days before that (days 7-13 from today)
        const fourteenDaysAgo = new Date();
        fourteenDaysAgo.setDate(today.getDate() - 14);
        const fourteenDaysAgoKey = `${fourteenDaysAgo.getFullYear()}-${String(fourteenDaysAgo.getMonth() + 1).padStart(2, '0')}-${String(fourteenDaysAgo.getDate()).padStart(2, '0')}`;

        const thisWeekMoods = moodArray.filter(m => m.dateKey >= sevenDaysAgoKey);
        const lastWeekMoods = moodArray.filter(m => m.dateKey >= fourteenDaysAgoKey && m.dateKey < sevenDaysAgoKey);

        // Calculate averages (only from days with actual check-ins)
        const thisWeekAvg = thisWeekMoods.length > 0
            ? thisWeekMoods.reduce((sum, m) => sum + m.mood, 0) / thisWeekMoods.length
            : 0;

        const lastWeekAvg = lastWeekMoods.length > 0
            ? lastWeekMoods.reduce((sum, m) => sum + m.mood, 0) / lastWeekMoods.length
            : 0;

        // Create 7-day breakdown (last 7 days)
        const weekData = [];
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        for (let i = 6; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);

            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dateKey = `${year}-${month}-${day}`;

            const dayName = dayNames[date.getDay()];
            const moodData = moodByDay[dateKey];

            weekData.push({
                dateKey: dateKey,
                dayName: dayName,
                mood: moodData ? moodData.mood : null, // null means no check-in
                hasMood: !!moodData
            });
        }

        setMoodWeekData({
            thisWeekAvg: parseFloat(thisWeekAvg.toFixed(1)),
            lastWeekAvg: parseFloat(lastWeekAvg.toFixed(1)),
            difference: parseFloat((thisWeekAvg - lastWeekAvg).toFixed(1)),
            weekData: weekData
        });

        console.log('📊 MOOD WEEK DATA:', {
            thisWeekAvg: parseFloat(thisWeekAvg.toFixed(1)),
            lastWeekAvg: parseFloat(lastWeekAvg.toFixed(1)),
            difference: parseFloat((thisWeekAvg - lastWeekAvg).toFixed(1)),
            daysWithMood: weekData.filter(d => d.hasMood).length
        });

    } catch (error) {
        console.error('Error loading mood week data:', error);
    }
};

// Calculate all check-in streaks
const calculateStreaks = async () => {
    try {
        const userTimezone = user.timezone || "America/Los_Angeles";

        // Fetch ALL check-ins
        const snapshot = await db.collection('checkIns')
            .where('userId', '==', user.uid)
            .orderBy('createdAt', 'asc')
            .get();

        // Group check-ins by date
        const checkInsByDate = {};
        snapshot.docs.forEach(doc => {
            const checkIn = doc.data();
            const checkInDate = checkIn.createdAt?.toDate ?
                checkIn.createdAt.toDate() : new Date(checkIn.createdAt);
            const checkInUserTZ = new Date(checkInDate.toLocaleString("en-US", {timeZone: userTimezone}));

            const year = checkInUserTZ.getFullYear();
            const month = String(checkInUserTZ.getMonth() + 1).padStart(2, '0');
            const day = String(checkInUserTZ.getDate()).padStart(2, '0');
            const dateKey = `${year}-${month}-${day}`;

            checkInsByDate[dateKey] = true;
        });

        // Get all dates with check-ins, sorted
        const datesWithCheckIns = Object.keys(checkInsByDate).sort();

        if (datesWithCheckIns.length === 0) {
            setStreakData({ longestStreak: 0, currentStreak: 0, allStreaks: [] });
            return;
        }

        // Find all streaks
        const allStreaks = [];
        let currentStreakStart = datesWithCheckIns[0];
        let currentStreakEnd = datesWithCheckIns[0];

        for (let i = 1; i < datesWithCheckIns.length; i++) {
            const prevDate = new Date(datesWithCheckIns[i - 1]);
            const currDate = new Date(datesWithCheckIns[i]);

            // Calculate day difference
            const diffTime = currDate - prevDate;
            const diffDays = diffTime / (1000 * 60 * 60 * 24);

            if (diffDays === 1) {
                // Consecutive day - extend current streak
                currentStreakEnd = datesWithCheckIns[i];
            } else {
                // Streak broken - save current streak
                const streakStart = new Date(currentStreakStart);
                const streakEnd = new Date(currentStreakEnd);
                const streakLength = Math.round((streakEnd - streakStart) / (1000 * 60 * 60 * 24)) + 1;

                allStreaks.push({
                    startDate: currentStreakStart,
                    endDate: currentStreakEnd,
                    length: streakLength
                });

                // Start new streak
                currentStreakStart = datesWithCheckIns[i];
                currentStreakEnd = datesWithCheckIns[i];
            }
        }

        // Add final streak
        const streakStart = new Date(currentStreakStart);
        const streakEnd = new Date(currentStreakEnd);
        const streakLength = Math.round((streakEnd - streakStart) / (1000 * 60 * 60 * 24)) + 1;
        allStreaks.push({
            startDate: currentStreakStart,
            endDate: currentStreakEnd,
            length: streakLength
        });

        // Sort streaks by length (longest first)
        allStreaks.sort((a, b) => b.length - a.length);

        // Find current streak (last streak if it includes today)
        const today = new Date();
        const todayKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        const lastStreak = allStreaks[allStreaks.length - 1];
        const currentStreak = lastStreak && lastStreak.endDate === todayKey ? lastStreak.length : 0;

        // Longest streak
        const longestStreak = allStreaks.length > 0 ? allStreaks[0].length : 0;

        setStreakData({
            longestStreak,
            currentStreak,
            allStreaks
        });

        console.log('🔥 STREAK DATA:', {
            longestStreak,
            currentStreak,
            totalStreaks: allStreaks.length
        });

    } catch (error) {
        console.error('Error calculating streaks:', error);
    }
};

// Load reflections and calculate stats
const loadReflections = async () => {
    try {
        // Load last 90 days of check-ins that have evening reflections
        const ninetyDaysAgo = new Date();
        ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);

        // Query checkIns collection instead of reflections collection
        const checkInsSnapshot = await db.collection('checkIns')
            .where('userId', '==', user.uid)
            .where('createdAt', '>=', ninetyDaysAgo)
            .orderBy('createdAt', 'desc')
            .get();

        // Extract only check-ins that have eveningData
        const reflectionsList = [];
        checkInsSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.eveningData) {
                // Flatten structure for easier use
                reflectionsList.push({
                    id: doc.id,
                    createdAt: data.createdAt,
                    updatedAt: data.updatedAt,
                    // Extract eveningData fields to top level
                    overallDay: data.eveningData.overallDay,
                    challenges: data.eveningData.challenges,
                    gratitude: data.eveningData.gratitude,
                    tomorrowGoal: data.eveningData.tomorrowGoal,
                    promptResponse: data.eveningData.promptResponse || '',
                    // Keep original eveningData for modal display
                    eveningData: data.eveningData
                });
            }
        });

        setReflectionData(reflectionsList);

        console.log('🌙 Loaded reflections:', reflectionsList.length, 'reflections found');

        // Calculate reflection streak
        let streak = 0;
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        for (let i = 0; i < 365; i++) {
            const checkDate = new Date(today);
            checkDate.setDate(checkDate.getDate() - i);
            checkDate.setHours(0, 0, 0, 0);

            const hasReflection = reflectionsList.some(reflection => {
                const reflectionDate = reflection.createdAt?.toDate ?
                    reflection.createdAt.toDate() : new Date(reflection.createdAt);
                reflectionDate.setHours(0, 0, 0, 0);
                return reflectionDate.getTime() === checkDate.getTime();
            });

            if (hasReflection) {
                streak++;
            } else {
                // Allow grace day for today if before 9 PM
                if (i === 0 && new Date().getHours() < 21) {
                    continue;
                }
                break;
            }
        }

        setReflectionStreak(streak);
        console.log('🔥 Reflection streak:', streak);

        // Calculate this month's total
        const startOfMonth = new Date();
        startOfMonth.setDate(1);
        startOfMonth.setHours(0, 0, 0, 0);

        const thisMonthReflections = reflectionsList.filter(reflection => {
            const reflectionDate = reflection.createdAt?.toDate ?
                reflection.createdAt.toDate() : new Date(reflection.createdAt);
            return reflectionDate >= startOfMonth;
        });

        const totalThisMonth = thisMonthReflections.length;

        // Calculate avg daily score (from overallDay field)
        const scores = thisMonthReflections
            .filter(r => r.overallDay !== undefined && r.overallDay !== null)
            .map(r => r.overallDay);

        const avgDailyScore = scores.length > 0
            ? (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1)
            : 0;

        console.log('📊 Reflection stats:', { totalThisMonth, avgDailyScore, scoresCount: scores.length });

        // Extract gratitude themes from reflection data
        let topGratitudeTheme = '';
        const gratitudes = thisMonthReflections
            .filter(r => r.gratitude && r.gratitude.trim())
            .map(r => r.gratitude);

        if (gratitudes.length > 0) {
            // Simple keyword extraction (can be improved later)
            const keywords = ['family', 'friends', 'health', 'recovery', 'therapy', 'support', 'peace', 'hope'];
            const themeCounts = {};

            gratitudes.forEach(gratitude => {
                const lowerGratitude = gratitude.toLowerCase();
                keywords.forEach(keyword => {
                    if (lowerGratitude.includes(keyword)) {
                        themeCounts[keyword] = (themeCounts[keyword] || 0) + 1;
                    }
                });
            });

            if (Object.keys(themeCounts).length > 0) {
                topGratitudeTheme = Object.keys(themeCounts).reduce((a, b) =>
                    themeCounts[a] > themeCounts[b] ? a : b
                );
                // Capitalize first letter
                topGratitudeTheme = topGratitudeTheme.charAt(0).toUpperCase() + topGratitudeTheme.slice(1);
            }
        }

        setReflectionStats({
            totalThisMonth,
            avgDailyScore: parseFloat(avgDailyScore),
            topGratitudeTheme
        });

    } catch (error) {
        console.error('Error loading reflections:', error);
    }
};

// Load all reflections for streak modal
const loadStreakReflections = async () => {
    try {
        // Load check-ins with evening reflections (last 90 days)
        const ninetyDaysAgo = new Date();
        ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);

        const checkInsSnapshot = await db.collection('checkIns')
            .where('userId', '==', user.uid)
            .where('createdAt', '>=', ninetyDaysAgo)
            .orderBy('createdAt', 'desc')
            .get();

        // Extract only check-ins that have eveningData
        const allReflections = [];
        checkInsSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.eveningData) {
                // Flatten structure for modal display
                allReflections.push({
                    id: doc.id,
                    createdAt: data.createdAt,
                    updatedAt: data.updatedAt,
                    // Extract eveningData fields
                    overallDay: data.eveningData.overallDay,
                    challenges: data.eveningData.challenges,
                    gratitude: data.eveningData.gratitude,
                    tomorrowGoal: data.eveningData.tomorrowGoal,
                    promptResponse: data.eveningData.promptResponse || '',
                    eveningData: data.eveningData
                });
            }
        });

        console.log('🔥 Loading streak reflections:', allReflections.length, 'reflections found');

        // Calculate consecutive days from today backwards
        const streakList = [];
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        let currentDate = new Date(today);
        let consecutiveDays = true;

        while (consecutiveDays) {
            // Find reflection for current date
            const dayReflection = allReflections.find(reflection => {
                const reflectionDate = reflection.createdAt?.toDate ?
                    reflection.createdAt.toDate() : new Date(reflection.createdAt);
                reflectionDate.setHours(0, 0, 0, 0);
                return reflectionDate.getTime() === currentDate.getTime();
            });

            if (dayReflection) {
                streakList.push(dayReflection);
                currentDate.setDate(currentDate.getDate() - 1);
            } else {
                // Allow grace period for today if before 9 PM
                if (currentDate.getTime() === today.getTime() && new Date().getHours() < 21) {
                    currentDate.setDate(currentDate.getDate() - 1);
                    continue;
                }
                consecutiveDays = false;
            }
        }

        console.log('🔥 Streak reflections:', streakList.length, 'consecutive days');
        setStreakReflections(streakList);
    } catch (error) {
        console.error('Error loading streak reflections:', error);
    }
};

// Calculate all reflection streaks (for longest streak feature)
const calculateReflectionStreaks = async () => {
    try {
        const userTimezone = user.timezone || "America/Los_Angeles";

        // Fetch ALL check-ins with eveningData
        const snapshot = await db.collection('checkIns')
            .where('userId', '==', user.uid)
            .orderBy('createdAt', 'asc')
            .get();

        // Group reflections by date (only check-ins with eveningData)
        const reflectionsByDate = {};
        snapshot.docs.forEach(doc => {
            const checkIn = doc.data();
            // Only count if it has eveningData (reflection)
            if (checkIn.eveningData) {
                const checkInDate = checkIn.createdAt?.toDate ?
                    checkIn.createdAt.toDate() : new Date(checkIn.createdAt);
                const checkInUserTZ = new Date(checkInDate.toLocaleString("en-US", {timeZone: userTimezone}));

                const year = checkInUserTZ.getFullYear();
                const month = String(checkInUserTZ.getMonth() + 1).padStart(2, '0');
                const day = String(checkInUserTZ.getDate()).padStart(2, '0');
                const dateKey = `${year}-${month}-${day}`;

                reflectionsByDate[dateKey] = true;
            }
        });

        // Get all dates with reflections, sorted
        const datesWithReflections = Object.keys(reflectionsByDate).sort();

        if (datesWithReflections.length === 0) {
            setReflectionStreakData({ longestStreak: 0, currentStreak: 0, allStreaks: [] });
            return;
        }

        // Find all streaks
        const allStreaks = [];
        let currentStreakStart = datesWithReflections[0];
        let currentStreakEnd = datesWithReflections[0];

        for (let i = 1; i < datesWithReflections.length; i++) {
            const prevDate = new Date(datesWithReflections[i - 1]);
            const currDate = new Date(datesWithReflections[i]);

            // Calculate day difference
            const diffTime = currDate - prevDate;
            const diffDays = diffTime / (1000 * 60 * 60 * 24);

            if (diffDays === 1) {
                // Consecutive day - extend current streak
                currentStreakEnd = datesWithReflections[i];
            } else {
                // Streak broken - save current streak
                const streakStart = new Date(currentStreakStart);
                const streakEnd = new Date(currentStreakEnd);
                const streakLength = Math.round((streakEnd - streakStart) / (1000 * 60 * 60 * 24)) + 1;

                allStreaks.push({
                    startDate: currentStreakStart,
                    endDate: currentStreakEnd,
                    length: streakLength
                });

                // Start new streak
                currentStreakStart = datesWithReflections[i];
                currentStreakEnd = datesWithReflections[i];
            }
        }

        // Add final streak
        const streakStart = new Date(currentStreakStart);
        const streakEnd = new Date(currentStreakEnd);
        const streakLength = Math.round((streakEnd - streakStart) / (1000 * 60 * 60 * 24)) + 1;
        allStreaks.push({
            startDate: currentStreakStart,
            endDate: currentStreakEnd,
            length: streakLength
        });

        // Sort streaks by length (longest first)
        allStreaks.sort((a, b) => b.length - a.length);

        // Find current streak (last streak if it includes today)
        const today = new Date();
        const todayKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        const lastStreak = allStreaks[allStreaks.length - 1];
        const currentStreak = lastStreak && lastStreak.endDate === todayKey ? lastStreak.length : 0;

        // Longest streak
        const longestStreak = allStreaks.length > 0 ? allStreaks[0].length : 0;

        setReflectionStreakData({
            longestStreak,
            currentStreak,
            allStreaks
        });

        console.log('🌙 REFLECTION STREAK DATA:', {
            longestStreak,
            currentStreak,
            totalStreaks: allStreaks.length
        });

    } catch (error) {
        console.error('Error calculating reflection streaks:', error);
    }
};

// Calculate milestones
const calculateMilestones = () => {
    try {
        if (!user.recoveryStartDate) {
            console.log('No recovery start date found');
            return;
        }

        // Get recovery start date
        const startDate = user.recoveryStartDate.toDate ?
            user.recoveryStartDate.toDate() : new Date(user.recoveryStartDate);

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        startDate.setHours(0, 0, 0, 0);

        // Calculate days sober
        const daysSober = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));

        // Define all milestones
        const milestoneDefinitions = [
            { days: 7, label: '1 Week', icon: 'calendar' },
            { days: 14, label: '2 Weeks', icon: 'calendar' },
            { days: 21, label: '3 Weeks', icon: 'calendar' },
            { days: 30, label: '1 Month', icon: 'award' },
            { days: 60, label: '2 Months', icon: 'award' },
            { days: 90, label: '3 Months', icon: 'star' },
            { days: 180, label: '6 Months', icon: 'star' },
            { days: 365, label: '1 Year', icon: 'trophy' },
            { days: 547, label: '18 Months', icon: 'trophy' },
            { days: 730, label: '2 Years', icon: 'medal' },
            { days: 1095, label: '3 Years', icon: 'medal' },
            { days: 1825, label: '5 Years', icon: 'crown' },
            { days: 3650, label: '10 Years', icon: 'crown' }
        ];

        // Calculate milestone status
        const milestones = milestoneDefinitions.map(m => {
            const achieved = daysSober >= m.days;
            const daysUntil = m.days - daysSober;
            const milestoneDate = new Date(startDate);
            milestoneDate.setDate(milestoneDate.getDate() + m.days);

            return {
                ...m,
                achieved,
                daysUntil,
                date: milestoneDate,
                dateString: milestoneDate.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                })
            };
        });

        // Find next milestone
        const upcomingMilestones = milestones.filter(m => !m.achieved);
        const next = upcomingMilestones.length > 0 ? upcomingMilestones[0] : null;

        // Calculate progress to next milestone
        if (next) {
            const previousMilestone = milestones.filter(m => m.achieved).slice(-1)[0];
            const startDays = previousMilestone ? previousMilestone.days : 0;
            const endDays = next.days;
            const currentProgress = daysSober - startDays;
            const totalRange = endDays - startDays;
            const progressPercentage = Math.round((currentProgress / totalRange) * 100);

            setNextMilestone({
                ...next,
                progressPercentage,
                daysSober
            });
        } else {
            // All milestones achieved!
            setNextMilestone({
                days: daysSober,
                label: 'All Milestones Complete!',
                icon: 'crown',
                achieved: true,
                daysUntil: 0,
                progressPercentage: 100,
                daysSober
            });
        }

        setAllMilestones(milestones);

    } catch (error) {
        console.error('Error calculating milestones:', error);
    }
};

// Save gratitude entry
const saveGratitude = async () => {
    try {
        if (!gratitudeTheme) {
            alert('Please select a theme');
            return;
        }
        if (!gratitudeText.trim()) {
            alert('Please write what you\'re grateful for');
            return;
        }

        await db.collection('gratitudes').add({
            userId: user.uid,
            theme: gratitudeTheme,
            text: gratitudeText.trim(),
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Reset form and close modal
        setGratitudeTheme('');
        setGratitudeText('');
        setShowGratitudeModal(false);

        // Show success message
        alert('Gratitude saved! 🙏');

        // Reload reflections to update top theme
        await loadReflections();

    } catch (error) {
        console.error('Error saving gratitude:', error);
        alert('Error saving gratitude. Please try again.');
    }
};


// Load compliance rates
const loadComplianceRates = async () => {
    try {
        // Get user's account creation date (same logic as loadProfileStats)
        const userDoc = await db.collection('users').doc(user.uid).get();
        const accountCreatedDate = userDoc.data()?.createdAt?.toDate() || new Date();

        // Calculate days since account creation (max 30 days for recent performance)
        const today = new Date();
        const daysSinceCreation = Math.floor((today - accountCreatedDate) / (1000 * 60 * 60 * 24));
        const daysToCheck = Math.min(daysSinceCreation, 30); // Cap at 30 days

        // Skip calculation if account is less than 1 day old
        if (daysToCheck < 1) {
            setComplianceRate({
                checkIn: 0,
                assignment: 0
            });
            return;
        }

        // Calculate check-in rate based on days since joining
        const dateToCheckFrom = new Date();
        dateToCheckFrom.setDate(dateToCheckFrom.getDate() - daysToCheck);

        const checkInsSnap = await db.collection('checkIns')
            .where('userId', '==', user.uid)
            .where('createdAt', '>=', dateToCheckFrom)
            .get();

        // COUNT ONLY MORNING CHECK-INS (same as ProfileView)
        let morningCheckInCount = 0;
        checkInsSnap.forEach(doc => {
            const data = doc.data();
            if (data.morningData) {
                morningCheckInCount++;
            }
        });

        // Calculate rate: morning check-ins / days they've been a member (max 30)
        const checkInRate = Math.min(100, Math.round((morningCheckInCount / daysToCheck) * 100));

        // Calculate assignment completion rate (keep existing logic)
        const assignmentsSnap = await db.collection('assignments')
            .where('userId', '==', user.uid)
            .get();

        let totalAssignments = 0;
        let completedAssignments = 0;

        assignmentsSnap.forEach(doc => {
            totalAssignments++;
            if (doc.data().status === 'completed') {
                completedAssignments++;
            }
        });

        const assignmentRate = totalAssignments > 0 ? 
            Math.round((completedAssignments / totalAssignments) * 100) : 0;

        setComplianceRate({
            checkIn: checkInRate,
            assignment: assignmentRate
        });
    } catch (error) {
        console.error('Error loading compliance rates:', error);
    }
};

         // Calculate total lifetime check-ins
const calculateTotalCheckIns = async () => {
    try {
        const checkInsSnap = await db.collection('checkIns')
            .where('userId', '==', user.uid)
            .get();
        
        let totalCount = 0;
        checkInsSnap.forEach(doc => {
            const data = doc.data();
            if (data.morningData) totalCount++;
            if (data.eveningData) totalCount++;
        });
        
        return totalCount;
    } catch (error) {
        console.error('Error calculating total check-ins:', error);
        return 0;
    }
};

// Handle daily pledge
const handlePledge = async () => {
    if (pledgeMade) return;
    
    try {
        await db.collection('pledges').add({
            userId: user.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        setPledgeMade(true);
        
        await db.collection('notifications').add({
            userId: user.uid,
            type: 'pledge',
            title: 'Daily Pledge Made',
            message: 'You\'ve committed to your recovery today!',
            read: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Create activity log
        await db.collection('activities').add({
            userId: user.uid,
            type: 'pledge',
            description: 'Made daily pledge',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (error) {
        console.error('Error making pledge:', error);
    }
};

// Handle morning check-in - UPDATED FOR 0-10 SCALE
const handleMorningCheckIn = async (data) => {
    try {
        // Get user's timezone midnight boundaries (uses user.timezone preference, defaults to PST)
        // NOTE: Timezone is NEVER hardcoded - always uses user's profile setting
        const userTimezone = user.timezone || "America/Los_Angeles";
        const userNow = new Date(new Date().toLocaleString("en-US", {timeZone: userTimezone}));
        const today = new Date(userNow);
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        // Check if check-in already exists for today
        const existingCheckIn = await db.collection('checkIns')
            .where('userId', '==', user.uid)
            .where('createdAt', '>=', today)
            .where('createdAt', '<', tomorrow)
            .get();
        
        if (existingCheckIn.empty) {
            // Create new check-in
            await db.collection('checkIns').add({
                userId: user.uid,
                morningData: data,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        } else {
            // Update existing check-in
            await db.collection('checkIns').doc(existingCheckIn.docs[0].id).update({
                morningData: data,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        setCheckInStatus(prev => ({ ...prev, morning: true }));
        
        // Update streak
        await updateStreak();
        
        // Check for auto-triggered alerts with NEW THRESHOLDS (0-10 scale)
        if (data.mood <= 3) {  // Changed from <= 2 (on 1-5 scale)
            await db.collection('alerts').add({
                userId: user.uid,
                type: 'low_mood',
                status: 'active',
                severity: 'high',
                message: `Low mood detected (${data.mood}/10)`,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        if (data.craving >= 7) {  // Changed from >= 4 (on 1-5 scale)
            await db.collection('alerts').add({
                userId: user.uid,
                type: 'high_craving',
                status: 'active',
                severity: 'high',
                message: `High craving intensity detected (${data.craving}/10)`,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        } catch (error) {
        console.error('Error with morning check-in:', error);
        alert('Failed to save check-in');
    }
};
        
       
// Handle evening reflection - SAVES TO CHECKINS COLLECTION ONLY
const handleEveningReflection = async (data) => {
    try {
        const userTimezone = user.timezone || "America/Los_Angeles";
        const userNow = new Date(new Date().toLocaleString("en-US", {timeZone: userTimezone}));
        const today = new Date(userNow);
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);

        // Save to checkIns collection with eveningData
        const existingCheckIn = await db.collection('checkIns')
            .where('userId', '==', user.uid)
            .where('createdAt', '>=', today)
            .where('createdAt', '<', tomorrow)
            .get();

        if (existingCheckIn.empty) {
            // Create new check-in with eveningData
            await db.collection('checkIns').add({
                userId: user.uid,
                tenantId: user.tenantId || 'glrs',
                eveningData: data,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            console.log('✅ Created new check-in with evening reflection');
        } else {
            // Update existing check-in with eveningData
            await db.collection('checkIns').doc(existingCheckIn.docs[0].id).update({
                eveningData: data,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            console.log('✅ Updated existing check-in with evening reflection');
        }

        setCheckInStatus(prev => ({ ...prev, evening: true }));

        // Clear the form
        setEveningReflectionData({
            promptResponse: '',
            overallDay: 5,
            challenges: '',
            gratitude: '',
            tomorrowGoal: ''
        });

        // Reload reflections to update stats
        await loadReflections();
        await loadCheckIns();
        await loadDailyTasksStatus();

        alert('Evening reflection complete!');
    } catch (error) {
        console.error('Error with evening reflection:', error);
        alert('Failed to save reflection');
    }
};

// Update check-in streak
const updateStreak = async () => {
    try {
        const streakDoc = await db.collection('streaks').doc(user.uid).get();
        
        if (streakDoc.exists) {
            const data = streakDoc.data();
            const lastCheckIn = data.lastCheckIn?.toDate ? 
                data.lastCheckIn.toDate() : new Date(data.lastCheckIn);
            const today = new Date();
            const daysDiff = Math.floor((today - lastCheckIn) / (1000 * 60 * 60 * 24));
            
            if (daysDiff === 1) {
                // Continue streak
                await db.collection('streaks').doc(user.uid).update({
                    currentStreak: data.currentStreak + 1,
                    lastCheckIn: firebase.firestore.FieldValue.serverTimestamp()
                });
                setCheckInStreak(data.currentStreak + 1);
            } else if (daysDiff > 1) {
                // Reset streak
                await db.collection('streaks').doc(user.uid).update({
                    currentStreak: 1,
                    lastCheckIn: firebase.firestore.FieldValue.serverTimestamp()
                });
                setCheckInStreak(1);
            }
        } else {
            // Create new streak
            await db.collection('streaks').doc(user.uid).set({
                currentStreak: 1,
                lastCheckIn: firebase.firestore.FieldValue.serverTimestamp()
            });
            setCheckInStreak(1);
        }
    } catch (error) {
        console.error('Error updating streak:', error);
    }
};

// Complete assignment WITH REFLECTION
const completeAssignment = async (assignmentId, goalId, reflection) => {
    try {
        await db.collection('assignments').doc(assignmentId).update({
            status: 'completed',
            completedAt: firebase.firestore.FieldValue.serverTimestamp(),
            reflection: reflection || ''
        });
        
        // Create activity log
        await db.collection('activities').add({
            userId: user.uid,
            type: 'assignment_completion',
            description: 'Completed assignment',
            assignmentId: assignmentId,
            reflection: reflection,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Create notification
        await db.collection('notifications').add({
            userId: user.uid,
            type: 'assignment',
            title: 'Assignment Completed',
            message: 'Great job completing your assignment!',
            read: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        if (goalId) {
            await updateGoalProgress(goalId);
        }
        
        await loadAssignments();
        await loadGoals();
        await loadComplianceRates();
    } catch (error) {
        console.error('Error completing assignment:', error);
    }
};

// Update goal progress - IMPROVED VERSION
const updateGoalProgress = async (goalId) => {
    try {
        // Get ALL assignments for this goal (not filtered by status)
        const assignmentsSnap = await db.collection('assignments')
            .where('goalId', '==', goalId)
            .where('userId', '==', user.uid)
            .get();
        
        let total = 0;
        let completed = 0;
        
        assignmentsSnap.forEach(doc => {
            total++;
            if (doc.data().status === 'completed') {
                completed++;
            }
        });
        
        const progress = total > 0 ? Math.round((completed / total) * 100) : 0;
        
        // Update the goal document
        await db.collection('goals').doc(goalId).update({
            progress: progress,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Also check if goal should be marked complete (100% progress)
        if (progress === 100) {
            const goalDoc = await db.collection('goals').doc(goalId).get();
            if (goalDoc.exists && goalDoc.data().status !== 'completed') {
                await db.collection('goals').doc(goalId).update({
                    status: 'completed',
                    completedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Send notification to PIR about goal completion
                await db.collection('notifications').add({
                    userId: user.uid,
                    type: 'goal_completed',
                    title: 'Goal Completed!',
                    message: `Congratulations! You've completed the goal: ${goalDoc.data().title}`,
                    goalId: goalId,
                    read: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        }
        
        // Trigger a refresh of the goals view if it exists
        if (window.goalsTasksViewInstance) {
            window.goalsTasksViewInstance.forceUpdate();
        }
        
    } catch (error) {
        console.error('Error updating goal progress:', error);
    }
};

// Update the send message function for GLRS Community - SAVES TO MESSAGES
const sendCommunityMessage = async (message, imageUrl) => {
    try {
        const messageData = {
            roomId: 'main',  // Required for messages collection
            senderId: user.uid,
            senderName: userData?.displayName || userData?.firstName || 'Anonymous',
            content: message,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()  // Changed from timestamp
        };
        
        // Add image URL if provided
        if (imageUrl) {
            messageData.imageUrl = imageUrl;
        }
        
        await db.collection('messages').add(messageData);  // Changed from glrsChat
    } catch (error) {
        console.error('Error sending community message:', error);
        throw error;
    }
};

const sendTopicRoomMessage = async (roomId, content, imageFile = null) => {
    // Allow sending with just an image or just text
    if (!content && !imageFile) return;
    
    try {
        const messageData = {
            roomId: roomId,
            userId: user.uid,
            senderId: user.uid,
            senderName: userData?.displayName || userData?.firstName || 'Anonymous',
            message: content || '',  // Allow empty message if there's an image
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Handle image upload if provided
        if (imageFile && imageFile instanceof File) {
            try {
                // Create canvas for resizing
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                // Read and process the file
                const reader = new FileReader();
                
                const base64 = await new Promise((resolve, reject) => {
                    reader.onload = (e) => {
                        img.onload = () => {
                            // Resize to max 500x500 pixels for chat
                            const MAX_SIZE = 500;
                            let width = img.width;
                            let height = img.height;
                            
                            if (width > height) {
                                if (width > MAX_SIZE) {
                                    height = Math.round((height * MAX_SIZE) / width);
                                    width = MAX_SIZE;
                                }
                            } else {
                                if (height > MAX_SIZE) {
                                    width = Math.round((width * MAX_SIZE) / height);
                                    height = MAX_SIZE;
                                }
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // Convert to base64 with compression
                            const resizedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                            resolve(resizedBase64);
                        };
                        
                        img.onerror = () => reject(new Error('Failed to load image'));
                        img.src = e.target.result;
                    };
                    
                    reader.onerror = () => reject(new Error('Failed to read file'));
                    reader.readAsDataURL(imageFile);
                });
                
                messageData.imageUrl = base64;
            } catch (imgError) {
                console.error('Error processing image:', imgError);
                showNotification('Failed to process image, sending message only', 'warning');
            }
        }

        // Add message to Firestore
        await db.collection('messages').add(messageData);
        
        // Reload messages after sending
        const messagesSnap = await db.collection('messages')
            .where('roomId', '==', roomId)
            .orderBy('createdAt', 'desc')
            .limit(50)
            .get();
        
        const messages = [];
        messagesSnap.forEach(doc => {
            messages.push({ id: doc.id, ...doc.data() });
        });
        setTopicRoomMessages(messages.reverse());
        
    } catch (error) {
        console.error('Error sending message:', error);
        showNotification('Failed to send message', 'error');
    }
};

// Enter topic room
const enterTopicRoom = async (room) => {
    setActiveTopicRoom(room);
    
    // Load room messages
    try {
        const messagesSnap = await db.collection('messages')
            .where('roomId', '==', room.id)
            .orderBy('createdAt', 'desc')
            .limit(50)
            .get();
        
        const messages = [];
        messagesSnap.forEach(doc => {
            messages.push({ id: doc.id, ...doc.data() });
        });
        setTopicRoomMessages(messages.reverse());
    } catch (error) {
        console.error('Error loading room messages:', error);
    }
    
    setShowModal('topicRoom');
};

// Handle SOS trigger
const triggerSOS = async () => {
    if (confirm('This will send an emergency alert to your coach. Continue?')) {
        try {
            await db.collection('alerts').add({
                userId: user.uid,
                type: 'sos',
                status: 'active',
                severity: 'critical',
                message: 'Emergency SOS triggered',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Create notification for coach
            if (userData?.assignedCoach) {
                await db.collection('notifications').add({
                    userId: userData.assignedCoach,
                    type: 'emergency',
                    title: 'EMERGENCY SOS',
                    message: `${userData.displayName || user.email} has triggered an emergency alert!`,
                    pirId: user.uid,
                    severity: 'critical',
                    read: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            alert('Emergency alert sent. Your coach has been notified.');
        } catch (error) {
            console.error('Error triggering SOS:', error);
            alert('Failed to send alert. Please call 988 for immediate help.');
        }
    }
};

// Alternative Profile Image Upload - Resize and store in Firestore
const handleProfileImageUpload = async (file) => {
    try {
        // Check file size (limit to 5MB for upload)
        if (file.size > 5 * 1024 * 1024) {
            showNotification('Image size must be less than 5MB', 'error');
            return;
        }
        
        // Show loading
        showNotification('Processing image...', 'info');
        
        // Create canvas for resizing
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        // Read and process the file
        const reader = new FileReader();
        
        reader.onload = async (e) => {
            img.onload = async () => {
                try {
                    // Resize to max 300x300 pixels (slightly larger for better quality)
                    const MAX_SIZE = 300;
                    let width = img.width;
                    let height = img.height;
                    
                    // Calculate new dimensions maintaining aspect ratio
                    if (width > height) {
                        if (width > MAX_SIZE) {
                            height = Math.round((height * MAX_SIZE) / width);
                            width = MAX_SIZE;
                        }
                    } else {
                        if (height > MAX_SIZE) {
                            width = Math.round((width * MAX_SIZE) / height);
                            height = MAX_SIZE;
                        }
                    }
                    
                    // Set canvas size
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw and compress image
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Convert to base64 with compression
                    let resizedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                    
                    // Check final size (should be under 500KB)
                    const base64Size = resizedBase64.length * 0.75; // Approximate size in bytes
                    if (base64Size > 500 * 1024) {
                        // Try with more compression
                        const moreCompressed = canvas.toDataURL('image/jpeg', 0.5);
                        if (moreCompressed.length * 0.75 > 500 * 1024) {
                            showNotification('Image is too large even after compression. Please choose a smaller image.', 'error');
                            return;
                        }
                        resizedBase64 = moreCompressed;
                    }
                    
                    // Store directly in Firestore
                    await db.collection('users').doc(user.uid).update({
                        profileImageUrl: resizedBase64,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Update local state
                    if (typeof setProfileImage === 'function') {
                        setProfileImage(resizedBase64);
                    }
                    
                    if (typeof setUserData === 'function') {
                        setUserData(prevData => ({
                            ...prevData,
                            profileImageUrl: resizedBase64
                        }));
                    }
                    
                    // Update the displayed image immediately
                    const profileImgElements = document.querySelectorAll('.profile-image, #profileImage, .user-avatar');
                    profileImgElements.forEach(elem => {
                        if (elem.tagName === 'IMG') {
                            elem.src = resizedBase64;
                        } else {
                            elem.style.backgroundImage = `url(${resizedBase64})`;
                        }
                    });
                    
                    showNotification('Profile image updated successfully!', 'success');
                    
                } catch (error) {
                    console.error('Error processing image:', error);
                    showNotification('Failed to process image', 'error');
                }
            };
            
            img.onerror = () => {
                showNotification('Failed to load image', 'error');
            };
            
            img.src = e.target.result;
        };
        
        reader.onerror = () => {
            showNotification('Failed to read file', 'error');
        };
        
        reader.readAsDataURL(file);
        
    } catch (error) {
        console.error('Error uploading image:', error);
        showNotification('Failed to upload image', 'error');
    }
};

// Update the handleImageSelect function to use the new handler
const handleImageSelect = (e) => {
    const file = e.target.files[0];
    if (file) {
        // Check file type
        if (!file.type.startsWith('image/')) {
            showNotification('Please select an image file', 'error');
            return;
        }
        
        // Use the new upload handler
        handleProfileImageUpload(file);
    }
};

// Export data as JSON
const exportDataAsJSON = () => {
    const exportData = {
        userData: userData,
        checkIns: checkIns,
        goals: goals,
        assignments: assignments,
        sobrietyDays: sobrietyDays,
        streak: checkInStreak,
        complianceRates: complianceRate,
        exportedAt: new Date().toISOString()
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', `recovery_data_${new Date().toISOString().split('T')[0]}.json`);
    linkElement.click();
};

// Export data as PDF with comprehensive data
const exportDataAsPDF = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(20);
    doc.text('Recovery Progress Report', 20, 20);
    
    doc.setFontSize(12);
    doc.text(`Name: ${userData?.displayName || userData?.firstName || user.email}`, 20, 40);
    doc.text(`Days Clean: ${sobrietyDays}`, 20, 50);
    doc.text(`Money Saved: $${moneySaved.toLocaleString()}`, 20, 60);
    doc.text(`Check-in Streak: ${checkInStreak} days`, 20, 70);
    doc.text(`Check-in Compliance: ${complianceRate.checkIn}%`, 20, 80);
    doc.text(`Assignment Completion: ${complianceRate.assignment}%`, 20, 90);
    doc.text(`Export Date: ${new Date().toLocaleDateString()}`, 20, 100);
    
    // Add recent check-ins
    if (checkIns.length > 0) {
        doc.text('Recent Check-ins:', 20, 120);
        checkIns.slice(0, 5).forEach((checkIn, index) => {
            const date = checkIn.createdAt?.toDate ? 
                checkIn.createdAt.toDate().toLocaleDateString() : 'Unknown';
            const mood = checkIn.morningData?.mood || 'N/A';
            const craving = checkIn.morningData?.craving || 'N/A';
            doc.text(`${date} - Mood: ${mood}/5, Craving: ${craving}/5`, 30, 130 + (index * 10));
        });
    }
    
    // Add goals summary
    if (goals.length > 0) {
        doc.addPage();
        doc.text('Active Goals:', 20, 20);
        goals.forEach((goal, index) => {
            doc.text(`${goal.title} - ${goal.progress}% complete`, 30, 30 + (index * 10));
        });
    }
    
    doc.save(`recovery_report_${new Date().toISOString().split('T')[0]}.pdf`);
};

// Handle logout
const handleLogout = async () => {
    if (confirm('Are you sure you want to sign out?')) {
        await auth.signOut();
    }
};

// Mark notification as read
const markNotificationAsRead = async (notificationId) => {
    try {
        await db.collection('notifications').doc(notificationId).update({
            read: true,
            readAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (error) {
        console.error('Error marking notification as read:', error);
    }
};

// Mark all notifications as read
const markAllNotificationsAsRead = async () => {
    try {
        const batch = db.batch();
        
        notifications.forEach(notification => {
            if (!notification.read) {
                const notificationRef = db.collection('notifications').doc(notification.id);
                batch.update(notificationRef, {
                    read: true,
                    readAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        });
        
        await batch.commit();
    } catch (error) {
        console.error('Error marking all as read:', error);
    }
};

// Dismiss broadcast
const dismissBroadcast = () => {
    setBroadcastDismissed(true);
    setActiveBroadcast(null);
};

// ========================================
// PATTERN DETECTION ALGORITHMS
// ========================================

// Algorithm 1: Day-of-Week Pattern Detection
const detectDayOfWeekPattern = (checkInsData) => {
    if (!checkInsData || checkInsData.length < 7) return null;

    const dayGroups = { 0: [], 1: [], 2: [], 3: [], 4: [], 5: [], 6: [] }; // Sun-Sat
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

    checkInsData.slice(0, 30).forEach(checkIn => {
        if (!checkIn.morningData) return;
        const date = checkIn.createdAt?.toDate ? checkIn.createdAt.toDate() : new Date(checkIn.createdAt);
        const dayOfWeek = date.getDay();

        dayGroups[dayOfWeek].push({
            mood: checkIn.morningData.mood || 3,
            craving: checkIn.morningData.craving || 3,
            anxiety: checkIn.morningData.anxiety || 3
        });
    });

    const dayAverages = {};
    let totalMood = 0, totalCraving = 0, totalAnxiety = 0, count = 0;

    Object.keys(dayGroups).forEach(day => {
        if (dayGroups[day].length === 0) return;

        const avgMood = dayGroups[day].reduce((sum, d) => sum + d.mood, 0) / dayGroups[day].length;
        const avgCraving = dayGroups[day].reduce((sum, d) => sum + d.craving, 0) / dayGroups[day].length;
        const avgAnxiety = dayGroups[day].reduce((sum, d) => sum + d.anxiety, 0) / dayGroups[day].length;

        dayAverages[day] = { mood: avgMood, craving: avgCraving, anxiety: avgAnxiety };
        totalMood += avgMood;
        totalCraving += avgCraving;
        totalAnxiety += avgAnxiety;
        count++;
    });

    if (count === 0) return null;

    const weeklyAvg = {
        mood: totalMood / count,
        craving: totalCraving / count,
        anxiety: totalAnxiety / count
    };

    let lowestMoodDay = null, highestCravingDay = null, highestAnxietyDay = null;
    let lowestMoodValue = 5, highestCravingValue = 0, highestAnxietyValue = 0;

    Object.keys(dayAverages).forEach(day => {
        if (dayAverages[day].mood < lowestMoodValue) {
            lowestMoodValue = dayAverages[day].mood;
            lowestMoodDay = parseInt(day);
        }
        if (dayAverages[day].craving > highestCravingValue) {
            highestCravingValue = dayAverages[day].craving;
            highestCravingDay = parseInt(day);
        }
        if (dayAverages[day].anxiety > highestAnxietyValue) {
            highestAnxietyValue = dayAverages[day].anxiety;
            highestAnxietyDay = parseInt(day);
        }
    });

    if (lowestMoodDay !== null && weeklyAvg.mood - lowestMoodValue >= 1) {
        return {
            type: 'dayOfWeek',
            metric: 'mood',
            day: dayNames[lowestMoodDay],
            value: lowestMoodValue.toFixed(1),
            message: `Your mood tends to dip on ${dayNames[lowestMoodDay]}s`,
            tips: [
                `Start your ${dayNames[lowestMoodDay]} with a morning routine`,
                `Schedule something enjoyable for ${dayNames[lowestMoodDay]} mornings`,
                `Connect with your accountability partner on ${dayNames[lowestMoodDay]}`,
                `Review your ${dayNames[lowestMoodDay]} triggers from past weeks`
            ]
        };
    }

    if (highestCravingDay !== null && highestCravingValue - weeklyAvg.craving >= 1) {
        return {
            type: 'dayOfWeek',
            metric: 'craving',
            day: dayNames[highestCravingDay],
            value: highestCravingValue.toFixed(1),
            message: `Your cravings spike on ${dayNames[highestCravingDay]}s`,
            tips: [
                `Identify your ${dayNames[highestCravingDay]} triggers (stress? social plans?)`,
                `Plan alternative activities for ${dayNames[highestCravingDay]} evenings`,
                `Check in with your support group on ${dayNames[highestCravingDay]}s`,
                `Practice grounding techniques on ${dayNames[highestCravingDay]} afternoons`
            ]
        };
    }

    if (highestAnxietyDay !== null && highestAnxietyValue - weeklyAvg.anxiety >= 1) {
        return {
            type: 'dayOfWeek',
            metric: 'anxiety',
            day: dayNames[highestAnxietyDay],
            value: highestAnxietyValue.toFixed(1),
            message: `Your anxiety is higher on ${dayNames[highestAnxietyDay]}s`,
            tips: [
                `Prepare for the week ahead on ${dayNames[highestAnxietyDay - 1 >= 0 ? highestAnxietyDay - 1 : 6]} night`,
                `Practice ${dayNames[highestAnxietyDay]} evening meditation`,
                `Limit social media on ${dayNames[highestAnxietyDay]}s`,
                `Connect with supportive friends on ${dayNames[highestAnxietyDay]}`
            ]
        };
    }

    return null;
};

// Algorithm 2: Consecutive Days Pattern Detection
const detectConsecutiveDaysPattern = (checkInsData) => {
    if (!checkInsData || checkInsData.length < 3) return null;

    let consecutiveLowMood = 0, consecutiveHighCraving = 0;
    let maxConsecutiveLowMood = 0, maxConsecutiveHighCraving = 0;

    checkInsData.slice(0, 14).forEach(checkIn => {
        if (!checkIn.morningData) {
            consecutiveLowMood = 0;
            consecutiveHighCraving = 0;
            return;
        }

        const mood = checkIn.morningData.mood || 3;
        const craving = checkIn.morningData.craving || 3;

        if (mood <= 2) {
            consecutiveLowMood++;
            maxConsecutiveLowMood = Math.max(maxConsecutiveLowMood, consecutiveLowMood);
        } else {
            consecutiveLowMood = 0;
        }

        if (craving >= 4) {
            consecutiveHighCraving++;
            maxConsecutiveHighCraving = Math.max(maxConsecutiveHighCraving, consecutiveHighCraving);
        } else {
            consecutiveHighCraving = 0;
        }
    });

    if (maxConsecutiveLowMood >= 3) {
        return {
            type: 'consecutive',
            metric: 'lowMood',
            days: maxConsecutiveLowMood,
            message: `You've had ${maxConsecutiveLowMood} consecutive days of low mood. Let's address this.`,
            tips: [
                'Consider reaching out to your coach today',
                'Review your coping strategies - what\'s working?',
                'Have you been completing your daily check-ins?',
                'Physical activity can help - take a walk today'
            ]
        };
    }

    if (maxConsecutiveHighCraving >= 3) {
        return {
            type: 'consecutive',
            metric: 'highCraving',
            days: maxConsecutiveHighCraving,
            message: `High cravings for ${maxConsecutiveHighCraving} days in a row. Time for extra support.`,
            tips: [
                'This is normal - cravings pass, you are strong',
                'Call your accountability partner right now',
                'Use the 5-minute rule: delay for 5 minutes, reassess',
                'Review your relapse prevention plan in Guides'
            ]
        };
    }

    return null;
};

// Algorithm 3: Time-of-Day Pattern Detection
const detectTimeOfDayPattern = (checkInsData) => {
    if (!checkInsData || checkInsData.length < 7) return null;

    let morningMoodSum = 0, eveningMoodSum = 0;
    let morningCount = 0, eveningCount = 0;

    checkInsData.slice(0, 14).forEach(checkIn => {
        if (checkIn.morningData && checkIn.morningData.mood) {
            morningMoodSum += checkIn.morningData.mood;
            morningCount++;
        }
        if (checkIn.eveningData && checkIn.eveningData.overallDay) {
            eveningMoodSum += checkIn.eveningData.overallDay;
            eveningCount++;
        }
    });

    if (morningCount < 5 || eveningCount < 5) return null;

    const avgMorningMood = morningMoodSum / morningCount;
    const avgEveningMood = eveningMoodSum / eveningCount;
    const difference = avgMorningMood - avgEveningMood;

    if (difference <= -1) {
        return {
            type: 'timeOfDay',
            metric: 'morningsHarder',
            difference: Math.abs(difference).toFixed(1),
            message: 'Your mornings tend to be more challenging',
            tips: [
                'Establish a consistent morning routine',
                'Avoid checking phone first thing in the morning',
                'Try morning meditation or stretching',
                'Plan something positive for each morning'
            ]
        };
    }

    if (difference >= 1) {
        return {
            type: 'timeOfDay',
            metric: 'eveningsHarder',
            difference: difference.toFixed(1),
            message: 'Your mood dips in the evenings',
            tips: [
                'Avoid isolation in the evenings',
                'Limit screen time after 8 PM',
                'Call a friend or family member each evening',
                'Practice evening reflection to process your day'
            ]
        };
    }

    return null;
};

// Run pattern detection on check-ins data
useEffect(() => {
    if (checkIns.length > 0) {
        const pattern = detectDayOfWeekPattern(checkIns) ||
                       detectConsecutiveDaysPattern(checkIns) ||
                       detectTimeOfDayPattern(checkIns);
        setPatternDetection(pattern);
    }
}, [checkIns]);

if (loading) {
    return (
        <div className="loading-container">
            <div className="loading-spinner"></div>
        </div>
    );
}

return (
    <div className="app-container">
        <div className="header">
            <div className="header-title">
                {currentView === 'home' && 'Home'}
                {currentView === 'tasks' && 'Tasks'}
                {currentView === 'progress' && 'Journey'}
                {currentView === 'connect' && 'Community'}
                {currentView === 'guides' && 'Guides'}
                {currentView === 'notifications' && 'Notifications'}
            </div>
            <div className="header-actions">
                {currentView === 'home' && (
                    <button className="header-btn" onClick={() => console.log('Filter')}>
                        <i data-lucide="filter" style={{width: '18px', height: '18px'}}></i>
                    </button>
                )}
                {currentView === 'tasks' && (
                    <button className="header-btn" onClick={() => setShowModal('createGoal')}>
                        <i data-lucide="plus" style={{width: '18px', height: '18px'}}></i>
                        <span>New Task</span>
                    </button>
                )}
                {currentView === 'progress' && (
                    <button className="header-btn" onClick={() => console.log('Date range')}>
                        <i data-lucide="calendar-range" style={{width: '18px', height: '18px'}}></i>
                    </button>
                )}
                {currentView === 'connect' && (
                    <button className="header-btn" onClick={() => console.log('Search')}>
                        <i data-lucide="search" style={{width: '18px', height: '18px'}}></i>
                    </button>
                )}
                {currentView === 'guides' && (
                    <button className="header-btn" onClick={() => console.log('Search guides')}>
                        <i data-lucide="search" style={{width: '18px', height: '18px'}}></i>
                    </button>
                )}
                {currentView === 'notifications' && (
                    <button className="header-btn" onClick={markAllNotificationsAsRead}>
                        <span>Mark All Read</span>
                    </button>
                )}
                <div className="header-avatar" onClick={() => setShowProfileModal(true)}>
                    {(userData?.displayName || userData?.firstName || user.email || 'U').charAt(0).toUpperCase()}
                </div>
            </div>
        </div>

        {/* Pull-to-Refresh Indicator */}
        {pulling && (
            <div style={{
                position: 'absolute',
                top: '80px',
                left: '50%',
                transform: `translateX(-50%) translateY(${Math.min(pullDistance, 80)}px)`,
                zIndex: 999,
                transition: refreshing ? 'transform 0.3s' : 'none'
            }}>
                <div style={{
                    width: '40px',
                    height: '40px',
                    borderRadius: '50%',
                    background: 'var(--color-primary)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    boxShadow: '0 2px 8px rgba(6, 148, 148, 0.3)',
                    animation: refreshing ? 'spin 1s linear infinite' : 'none'
                }}>
                    <i data-lucide={refreshing ? "loader" : "arrow-down"} style={{width: '24px', height: '24px', color: '#fff'}}></i>
                </div>
            </div>
        )}

        <div
            className="content"
            ref={contentRef}
            onTouchStart={handleTouchStart}
            onTouchMove={handleTouchMove}
            onTouchEnd={handleTouchEnd}
        >
            {currentView === 'home' && (
                <>
                    {activeBroadcast && !broadcastDismissed && (
                        <div className="broadcast-banner">
                            <div className="broadcast-content">
                                <div style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                                    <i data-lucide="megaphone" style={{width: '24px', height: '24px', color: 'var(--color-accent)'}}></i>
                                    <div>
                                        <div style={{fontWeight: 'bold', color: 'var(--color-accent)'}}>Announcement</div>
                                        <div style={{color: 'white', marginTop: '5px'}}>{activeBroadcast.message}</div>
                                    </div>
                                </div>
                            </div>
                            <button className="broadcast-dismiss" onClick={dismissBroadcast}>×</button>
                        </div>
                    )}

                    {/* HERO SECTION - Teal background with sobriety counter */}
                    <div className="hero-section">
                    {coachInfo && (
                        <div className="coach-info-card">
                            <h3 style={{color: '#4CAF50', marginBottom: '10px'}}>Your Recovery Coach</h3>
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                <div>
                                    <div style={{fontSize: '18px', fontWeight: 'bold', color: 'white'}}>
                                        {coachInfo.displayName || coachInfo.firstName + ' ' + coachInfo.lastName}
                                    </div>
                                    {coachInfo.credentials && (
                                        <div style={{fontSize: '14px', opacity: 0.8, marginTop: '5px'}}>
                                            {coachInfo.credentials}
                                        </div>
                                    )}
                                </div>
                                {coachInfo.phone && (
                                    <a href={`tel:${coachInfo.phone}`} style={{
                                        background: 'rgba(255, 255, 255, 0.1)',
                                        padding: '8px 15px',
                                        borderRadius: '20px',
                                        color: 'white',
                                        textDecoration: 'none',
                                        fontSize: '14px'
                                    }}>
                                        <i data-lucide="phone" style={{width: '16px', height: '16px', marginRight: '6px'}}></i>
                                        Contact
                                    </a>
                                )}
                            </div>
                        </div>
                    )}

                    <div className="hero-background">
                        <div className="day-counter-container">
                            <div className="large-number">{sobrietyDays}</div>
                            <div className="large-text">Days Strong</div>
                            <div className="motivational-quote">
                                {dailyQuote?.quote || "One day at a time."}
                            </div>
                            {dailyQuote?.author && (
                                <div style={{fontSize: '12px', opacity: 0.7, marginTop: '5px'}}>
                                    — {dailyQuote.author}
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {nextMilestone && (
                        <div className="milestone-preview">
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                <div>
                                    <div style={{fontSize: '18px', color: 'white', fontWeight: 'bold', display: 'flex', alignItems: 'center', gap: '8px'}}>
                                        <i data-lucide={nextMilestone.icon || 'target'} style={{width: '20px', height: '20px'}}></i>
                                        <span>Next: {nextMilestone.title}</span>
                                    </div>
                                    <div style={{color: 'rgba(255,255,255,0.7)', marginTop: '5px', fontSize: '14px'}}>
                                        {nextMilestone.description}
                                    </div>
                                </div>
                                <div style={{textAlign: 'center'}}>
                                    <div style={{fontSize: '24px', fontWeight: 'bold', color: '#4CAF50'}}>
                                        {nextMilestone.daysRequired - sobrietyDays}
                                    </div>
                                    <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.7)'}}>
                                        days to go
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    </div>
                    {/* END HERO SECTION */}

                    {/* BODY SECTION - White background with cards */}
                    <div className="body-section">
                    {/* Milestone Timeline with Achievement Badges */}
                    <div style={{
                        background: '#FFFFFF',
                        border: '1px solid #E5E5E5',
                        backdropFilter: 'blur(10px)',
                        borderRadius: 'var(--radius-lg)',
                        padding: 'var(--space-6)',
                        marginBottom: 'var(--space-4)'
                    }}>
                        <h3 style={{
                            color: '#fff',
                            fontSize: 'var(--font-lg)',
                            fontWeight: 'bold',
                            marginBottom: 'var(--space-4)',
                            display: 'flex',
                            alignItems: 'center',
                            gap: 'var(--space-2)'
                        }}>
                            <i data-lucide="trophy" style={{width: '24px', height: '24px', color: 'var(--color-accent)'}}></i>
                            <span>Milestone Journey</span>
                        </h3>
                        <div style={{
                            display: 'flex',
                            overflowX: 'auto',
                            gap: 'var(--space-3)',
                            paddingBottom: 'var(--space-2)'
                        }}>
                            {milestones.slice(0, 10).map((milestone, index) => {
                                const achieved = sobrietyDays >= milestone.days;
                                const isNext = nextMilestone && milestone.days === nextMilestone.daysRequired;

                                return (
                                    <div key={index} style={{
                                        minWidth: '80px',
                                        display: 'flex',
                                        flexDirection: 'column',
                                        alignItems: 'center',
                                        gap: 'var(--space-2)'
                                    }}>
                                        <div style={{
                                            width: '64px',
                                            height: '64px',
                                            borderRadius: '50%',
                                            background: achieved
                                                ? 'linear-gradient(135deg, var(--color-success) 0%, var(--color-success-dark) 100%)'
                                                : isNext
                                                    ? 'linear-gradient(135deg, var(--color-accent) 0%, #FF6B35 100%)'
                                                    : 'rgba(255,255,255,0.1)',
                                            border: isNext ? '3px solid var(--color-accent)' : 'none',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            position: 'relative',
                                            boxShadow: achieved ? '0 4px 12px rgba(46, 204, 113, 0.4)' : 'none',
                                            animation: isNext ? 'pulse 2s infinite' : 'none'
                                        }}>
                                            <i data-lucide={milestone.icon || 'award'}
                                               style={{
                                                   width: '32px',
                                                   height: '32px',
                                                   color: achieved || isNext ? '#fff' : 'rgba(255,255,255,0.3)'
                                               }}></i>
                                            {achieved && (
                                                <div style={{
                                                    position: 'absolute',
                                                    top: '-4px',
                                                    right: '-4px',
                                                    width: '24px',
                                                    height: '24px',
                                                    borderRadius: '50%',
                                                    background: '#fff',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center'
                                                }}>
                                                    <i data-lucide="check" style={{width: '16px', height: '16px', color: 'var(--color-success)'}}></i>
                                                </div>
                                            )}
                                        </div>
                                        <div style={{
                                            fontSize: 'var(--font-xs)',
                                            fontWeight: '600',
                                            color: achieved ? '#fff' : isNext ? 'var(--color-accent)' : 'rgba(255,255,255,0.5)',
                                            textAlign: 'center'
                                        }}>
                                            {milestone.days}d
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    <div className="mood-tracker">
                        <div style={{color: 'white', marginBottom: '15px'}}>
                            How are you feeling today?
                        </div>
                        <div className="mood-options">
                            {[
                                { value: 'great', label: 'Great', icon: 'smile' },
                                { value: 'good', label: 'Good', icon: 'meh' },
                                { value: 'okay', label: 'Okay', icon: 'frown' },
                                { value: 'struggling', label: 'Struggling', icon: 'frown' },
                                { value: 'crisis', label: 'Crisis', icon: 'alert-circle' }
                            ].map(mood => (
                                <div
                                    key={mood.value}
                                    className={`mood-button ${selectedMood === mood.value ? 'selected' : ''}`}
                                    onClick={() => setSelectedMood(mood.value)}
                                >
                                    <i data-lucide={mood.icon} className="mood-icon"></i>
                                    <div className="mood-label">{mood.label}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                    
                    <div className="daily-pledge" style={{
                        background: pledgeMade
                            ? 'linear-gradient(135deg, var(--color-success) 0%, var(--color-success-dark) 100%)'
                            : 'linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%)',
                        padding: 'var(--space-6)',
                        borderRadius: 'var(--radius-lg)',
                        marginBottom: 'var(--space-4)',
                        transition: 'all 0.3s ease'
                    }}>
                        <div style={{
                            fontSize: 'var(--font-lg)',
                            fontWeight: '600',
                            color: '#fff',
                            marginBottom: 'var(--space-4)',
                            textAlign: 'center',
                            fontStyle: 'italic'
                        }}>
                            "I commit to my recovery today"
                        </div>
                        <button
                            onClick={() => {
                                triggerHaptic('success');
                                handlePledge();
                            }}
                            disabled={pledgeMade}
                            style={{
                                width: '100%',
                                padding: 'var(--space-4)',
                                background: pledgeMade ? 'rgba(255,255,255,0.2)' : 'rgba(255,255,255,0.95)',
                                border: 'none',
                                borderRadius: 'var(--radius-md)',
                                color: pledgeMade ? '#fff' : 'var(--color-primary)',
                                fontSize: 'var(--font-base)',
                                fontWeight: 'bold',
                                cursor: pledgeMade ? 'default' : 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: 'var(--space-2)',
                                transition: 'all 0.2s'
                            }}
                        >
                            {pledgeMade ? (
                                <>
                                    <i data-lucide="check-circle" style={{width: '20px', height: '20px'}}></i>
                                    <span>Pledge Made Today</span>
                                </>
                            ) : (
                                <>
                                    <i data-lucide="heart" style={{width: '20px', height: '20px'}}></i>
                                    <span>Make Today's Pledge</span>
                                </>
                            )}
                        </button>
                    </div>
                    
                    <button
                        onClick={() => setCurrentView('guides')}
                        style={{
                            width: '100%',
                            padding: '15px',
                            background: 'linear-gradient(135deg, #9c27b0 0%, #673ab7 100%)',
                            border: 'none',
                            borderRadius: '15px',
                            color: 'white',
                            fontSize: '16px',
                            fontWeight: 'bold',
                            cursor: 'pointer',
                            marginBottom: '20px',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            gap: '10px'
                        }}
                    >
                        <i data-lucide="book-open" style={{width: '24px', height: '24px', marginRight: '8px'}}></i>
                        Recovery Resources
                        <span style={{
                            background: 'rgba(255,255,255,0.2)',
                            padding: '2px 8px',
                            borderRadius: '10px',
                            fontSize: '12px'
                        }}>
                            {userData?.newResourcesCount || 0} New
                        </span>
                    </button>
                    
                    <div className="stats-grid">
                        <div className="stat-card">
                            <div className="stat-icon"><i data-lucide="dollar-sign"></i></div>
                            <div className="stat-value">${moneySaved.toLocaleString()}</div>
                            <div className="stat-label">Money Saved</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-icon"><i data-lucide="calendar-days"></i></div>
                            <div className="stat-value">{sobrietyDays}</div>
                            <div className="stat-label">Total Days</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-icon"><i data-lucide="flame"></i></div>
                            <div className="stat-value">{checkInStreak}</div>
                            <div className="stat-label">Day Streak</div>
                        </div>
                        <div className="stat-card">
    <div className="stat-icon"><i data-lucide="calendar-check"></i></div>
    <div className="stat-value">{Math.floor(sobrietyDays / 7)}</div>
    <div className="stat-label">Weeks Clean</div>
</div>
                        <div className="stat-card">
    <div className="stat-icon"><i data-lucide="check-circle"></i></div>
    <div className="stat-value">{totalCheckIns}</div>
    <div className="stat-label">Total Check-ins</div>
</div>
                        <div className="stat-card">
                            <div className="stat-icon"><i data-lucide="bar-chart-2"></i></div>
                            <div className="stat-value">{complianceRate.checkIn}%</div>
                            <div className="stat-label">Check-in Rate</div>
                        </div>
                    </div>
                    </div>
                </>
            )}

            {currentView === 'tasks' && (
                <>
                    {/* TASKS SUB-NAVIGATION */}
                    <div style={{
                        background: '#058585',
                        display: 'flex',
                        justifyContent: 'space-around',
                        alignItems: 'center',
                        height: '48px',
                        position: 'fixed',
                        top: '40px',
                        left: 0,
                        right: 0,
                        zIndex: 99,
                        boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                    }}>
                        <button
                            onClick={() => {
                                triggerHaptic('light');
                                setActiveTaskTab('checkin');
                            }}
                            style={{
                                flex: 1,
                                height: '100%',
                                background: 'none',
                                border: 'none',
                                color: activeTaskTab === 'checkin' ? '#FFFFFF' : 'rgba(255,255,255,0.7)',
                                fontSize: '14px',
                                fontWeight: activeTaskTab === 'checkin' ? 'bold' : '400',
                                cursor: 'pointer',
                                position: 'relative',
                                transition: 'all 0.2s'
                            }}
                        >
                            Check-In
                            {activeTaskTab === 'checkin' && (
                                <div style={{
                                    position: 'absolute',
                                    bottom: 0,
                                    left: '50%',
                                    transform: 'translateX(-50%)',
                                    width: '60%',
                                    height: '2px',
                                    background: '#FFFFFF'
                                }} />
                            )}
                        </button>

                        <button
                            onClick={() => {
                                triggerHaptic('light');
                                setActiveTaskTab('reflections');
                            }}
                            style={{
                                flex: 1,
                                height: '100%',
                                background: 'none',
                                border: 'none',
                                color: activeTaskTab === 'reflections' ? '#FFFFFF' : 'rgba(255,255,255,0.7)',
                                fontSize: '14px',
                                fontWeight: activeTaskTab === 'reflections' ? 'bold' : '400',
                                cursor: 'pointer',
                                position: 'relative',
                                transition: 'all 0.2s'
                            }}
                        >
                            Reflections
                            {activeTaskTab === 'reflections' && (
                                <div style={{
                                    position: 'absolute',
                                    bottom: 0,
                                    left: '50%',
                                    transform: 'translateX(-50%)',
                                    width: '60%',
                                    height: '2px',
                                    background: '#FFFFFF'
                                }} />
                            )}
                        </button>

                        <button
                            onClick={() => {
                                triggerHaptic('light');
                                setActiveTaskTab('golden');
                            }}
                            style={{
                                flex: 1,
                                height: '100%',
                                background: 'none',
                                border: 'none',
                                color: activeTaskTab === 'golden' ? '#FFFFFF' : 'rgba(255,255,255,0.7)',
                                fontSize: '14px',
                                fontWeight: activeTaskTab === 'golden' ? 'bold' : '400',
                                cursor: 'pointer',
                                position: 'relative',
                                transition: 'all 0.2s'
                            }}
                        >
                            The Golden Thread
                            {activeTaskTab === 'golden' && (
                                <div style={{
                                    position: 'absolute',
                                    bottom: 0,
                                    left: '50%',
                                    transform: 'translateX(-50%)',
                                    width: '60%',
                                    height: '2px',
                                    background: '#FFFFFF'
                                }} />
                            )}
                        </button>
                    </div>

                    {/* WHITE CONTAINER FOR ALL TAB CONTENT */}
                    <div style={{
                        background: '#FFFFFF',
                        minHeight: '100vh',
                        paddingBottom: '80px',
                        paddingTop: '48px'
                    }}>
                        {/* CHECK-IN TAB */}
                        {activeTaskTab === 'checkin' && (
                        <div style={{
                            padding: '16px 5%',
                            maxWidth: '600px',
                            margin: '0 auto'
                        }}>
                            {/* Morning Check-In Section */}
                            <h3 style={{
                                fontSize: '16px',
                                fontWeight: '400',
                                color: '#000000',
                                marginBottom: '10px'
                            }}>
                                Morning Check-In
                            </h3>

                            {/* Check if morning check-in is already complete */}
                            {(() => {
                                console.log('🔍 Morning Check-In Status:', checkInStatus.morning);
                                return checkInStatus.morning;
                            })() ? (
                                // COMPLETE STATE - Show completion message
                                <div style={{
                                    width: '100%',
                                    background: 'linear-gradient(135deg, rgba(5, 133, 133, 0.1) 0%, rgba(5, 133, 133, 0.05) 100%)',
                                    borderRadius: '12px',
                                    padding: '30px 20px',
                                    marginBottom: '20px',
                                    textAlign: 'center',
                                    border: '2px solid rgba(5, 133, 133, 0.2)'
                                }}>
                                    <div style={{ fontSize: '64px', marginBottom: '15px' }}>✅</div>
                                    <h3 style={{
                                        fontSize: '18px',
                                        fontWeight: 'bold',
                                        color: '#058585',
                                        marginBottom: '8px'
                                    }}>
                                        Morning Check-In Complete!
                                    </h3>
                                    <p style={{
                                        fontSize: '14px',
                                        color: '#666',
                                        margin: 0
                                    }}>
                                        Great job! Your morning check-in has been recorded. Come back tomorrow for your next check-in.
                                    </p>
                                </div>
                            ) : (
                                // PENDING STATE - Show form
                                <>
                            {/* Mood Card */}
                            <div style={{
                                width: '100%',
                                background: '#FFFFFF',
                                borderRadius: '12px',
                                padding: '12px',
                                marginBottom: '8px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                            }}>
                                <div style={{
                                    fontSize: '14px',
                                    fontWeight: '400',
                                    color: '#000000',
                                    marginBottom: '8px'
                                }}>
                                    Mood
                                </div>
                                <div style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    position: 'relative',
                                    height: '70px',
                                    overflow: 'hidden'
                                }}>
                                    {/* Highlight Box Behind Selected Number */}
                                    <div style={{
                                        position: 'absolute',
                                        width: '70px',
                                        height: '60px',
                                        background: 'rgba(5, 133, 133, 0.12)',
                                        borderRadius: '12px',
                                        top: '50%',
                                        left: '50%',
                                        transform: 'translate(-50%, -50%)',
                                        pointerEvents: 'none',
                                        zIndex: 1
                                    }} />

                                    {/* Left Vertical Divider */}
                                    <div style={{
                                        position: 'absolute',
                                        width: '1px',
                                        height: '50px',
                                        background: 'rgba(5, 133, 133, 0.3)',
                                        left: 'calc(50% - 40px)',
                                        top: '50%',
                                        transform: 'translateY(-50%)',
                                        pointerEvents: 'none',
                                        zIndex: 2
                                    }} />

                                    {/* Right Vertical Divider */}
                                    <div style={{
                                        position: 'absolute',
                                        width: '1px',
                                        height: '50px',
                                        background: 'rgba(5, 133, 133, 0.3)',
                                        left: 'calc(50% + 40px)',
                                        top: '50%',
                                        transform: 'translateY(-50%)',
                                        pointerEvents: 'none',
                                        zIndex: 2
                                    }} />

                                    {/* Left Gradient Fade */}
                                    <div style={{
                                        position: 'absolute',
                                        width: '60px',
                                        height: '100%',
                                        background: 'linear-gradient(to right, rgba(255,255,255,1) 0%, rgba(255,255,255,0) 100%)',
                                        left: 0,
                                        top: 0,
                                        pointerEvents: 'none',
                                        zIndex: 3
                                    }} />

                                    {/* Right Gradient Fade */}
                                    <div style={{
                                        position: 'absolute',
                                        width: '60px',
                                        height: '100%',
                                        background: 'linear-gradient(to left, rgba(255,255,255,1) 0%, rgba(255,255,255,0) 100%)',
                                        right: 0,
                                        top: 0,
                                        pointerEvents: 'none',
                                        zIndex: 3
                                    }} />

                                    <div
                                    className="swipeable-picker-container"
                                    style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '20px',
                                        overflowX: 'auto',
                                        overflowY: 'hidden',
                                        scrollSnapType: 'x mandatory',
                                        WebkitOverflowScrolling: 'touch',
                                        scrollBehavior: 'smooth',
                                        padding: '0 calc(50% - 30px)',
                                        width: '100%',
                                        touchAction: 'pan-x'
                                    }}
                                    onScroll={(e) => {
                                        const container = e.target;
                                        const scrollLeft = container.scrollLeft;
                                        const itemWidth = 60 + 20; // width + gap
                                        const centerIndex = Math.round(scrollLeft / itemWidth);
                                        if (centerIndex !== morningCheckInData.mood && centerIndex >= 0 && centerIndex <= 10) {
                                            triggerHaptic('light');
                                            setMorningCheckInData(prev => ({ ...prev, mood: centerIndex }));
                                        }
                                    }}
                                    >
                                        {[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(rating => (
                                            <div
                                                key={rating}
                                                onClick={() => {
                                                    triggerHaptic('light');
                                                    setMorningCheckInData(prev => ({ ...prev, mood: rating }));
                                                }}
                                                style={{
                                                    minWidth: '60px',
                                                    height: '60px',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    fontSize: morningCheckInData.mood === rating ? '32px' : '20px',
                                                    fontWeight: morningCheckInData.mood === rating ? 'bold' : '400',
                                                    color: morningCheckInData.mood === rating ? '#058585' : '#cccccc',
                                                    cursor: 'pointer',
                                                    transition: 'all 0.3s ease',
                                                    transform: morningCheckInData.mood === rating ? 'scale(1.2)' : 'scale(1)',
                                                    scrollSnapAlign: 'center',
                                                    userSelect: 'none',
                                                    flexShrink: 0
                                                }}
                                            >
                                                {rating}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* Craving Card */}
                            <div style={{
                                width: '100%',
                                background: '#FFFFFF',
                                borderRadius: '12px',
                                padding: '12px',
                                marginBottom: '8px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                            }}>
                                <div style={{
                                    fontSize: '14px',
                                    fontWeight: '400',
                                    color: '#000000',
                                    marginBottom: '8px'
                                }}>
                                    Craving
                                </div>
                                <div style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    position: 'relative',
                                    height: '70px',
                                    overflow: 'hidden'
                                }}>
                                    {/* Highlight Box Behind Selected Number */}
                                    <div style={{
                                        position: 'absolute',
                                        width: '70px',
                                        height: '60px',
                                        background: 'rgba(5, 133, 133, 0.12)',
                                        borderRadius: '12px',
                                        top: '50%',
                                        left: '50%',
                                        transform: 'translate(-50%, -50%)',
                                        pointerEvents: 'none',
                                        zIndex: 1
                                    }} />

                                    {/* Left Vertical Divider */}
                                    <div style={{
                                        position: 'absolute',
                                        width: '1px',
                                        height: '50px',
                                        background: 'rgba(5, 133, 133, 0.3)',
                                        left: 'calc(50% - 40px)',
                                        top: '50%',
                                        transform: 'translateY(-50%)',
                                        pointerEvents: 'none',
                                        zIndex: 2
                                    }} />

                                    {/* Right Vertical Divider */}
                                    <div style={{
                                        position: 'absolute',
                                        width: '1px',
                                        height: '50px',
                                        background: 'rgba(5, 133, 133, 0.3)',
                                        left: 'calc(50% + 40px)',
                                        top: '50%',
                                        transform: 'translateY(-50%)',
                                        pointerEvents: 'none',
                                        zIndex: 2
                                    }} />

                                    {/* Left Gradient Fade */}
                                    <div style={{
                                        position: 'absolute',
                                        width: '60px',
                                        height: '100%',
                                        background: 'linear-gradient(to right, rgba(255,255,255,1) 0%, rgba(255,255,255,0) 100%)',
                                        left: 0,
                                        top: 0,
                                        pointerEvents: 'none',
                                        zIndex: 3
                                    }} />

                                    {/* Right Gradient Fade */}
                                    <div style={{
                                        position: 'absolute',
                                        width: '60px',
                                        height: '100%',
                                        background: 'linear-gradient(to left, rgba(255,255,255,1) 0%, rgba(255,255,255,0) 100%)',
                                        right: 0,
                                        top: 0,
                                        pointerEvents: 'none',
                                        zIndex: 3
                                    }} />

                                    <div
                                    className="swipeable-picker-container"
                                    style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '20px',
                                        overflowX: 'auto',
                                        overflowY: 'hidden',
                                        scrollSnapType: 'x mandatory',
                                        WebkitOverflowScrolling: 'touch',
                                        scrollBehavior: 'smooth',
                                        padding: '0 calc(50% - 30px)',
                                        width: '100%',
                                        touchAction: 'pan-x'
                                    }}
                                    onScroll={(e) => {
                                        const container = e.target;
                                        const scrollLeft = container.scrollLeft;
                                        const itemWidth = 60 + 20; // width + gap
                                        const centerIndex = Math.round(scrollLeft / itemWidth);
                                        if (centerIndex !== morningCheckInData.craving && centerIndex >= 0 && centerIndex <= 10) {
                                            triggerHaptic('light');
                                            setMorningCheckInData(prev => ({ ...prev, craving: centerIndex }));
                                        }
                                    }}
                                    >
                                        {[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(rating => (
                                            <div
                                                key={rating}
                                                onClick={() => {
                                                    triggerHaptic('light');
                                                    setMorningCheckInData(prev => ({ ...prev, craving: rating }));
                                                }}
                                                style={{
                                                    minWidth: '60px',
                                                    height: '60px',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    fontSize: morningCheckInData.craving === rating ? '32px' : '20px',
                                                    fontWeight: morningCheckInData.craving === rating ? 'bold' : '400',
                                                    color: morningCheckInData.craving === rating ? '#058585' : '#cccccc',
                                                    cursor: 'pointer',
                                                    transition: 'all 0.3s ease',
                                                    transform: morningCheckInData.craving === rating ? 'scale(1.2)' : 'scale(1)',
                                                    scrollSnapAlign: 'center',
                                                    userSelect: 'none',
                                                    flexShrink: 0
                                                }}
                                            >
                                                {rating}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* Anxiety Card */}
                            <div style={{
                                width: '100%',
                                background: '#FFFFFF',
                                borderRadius: '12px',
                                padding: '12px',
                                marginBottom: '8px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                            }}>
                                <div style={{
                                    fontSize: '14px',
                                    fontWeight: '400',
                                    color: '#000000',
                                    marginBottom: '8px'
                                }}>
                                    Anxiety
                                </div>
                                <div style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    position: 'relative',
                                    height: '70px',
                                    overflow: 'hidden'
                                }}>
                                    {/* Highlight Box Behind Selected Number */}
                                    <div style={{
                                        position: 'absolute',
                                        width: '70px',
                                        height: '60px',
                                        background: 'rgba(5, 133, 133, 0.12)',
                                        borderRadius: '12px',
                                        top: '50%',
                                        left: '50%',
                                        transform: 'translate(-50%, -50%)',
                                        pointerEvents: 'none',
                                        zIndex: 1
                                    }} />

                                    {/* Left Vertical Divider */}
                                    <div style={{
                                        position: 'absolute',
                                        width: '1px',
                                        height: '50px',
                                        background: 'rgba(5, 133, 133, 0.3)',
                                        left: 'calc(50% - 40px)',
                                        top: '50%',
                                        transform: 'translateY(-50%)',
                                        pointerEvents: 'none',
                                        zIndex: 2
                                    }} />

                                    {/* Right Vertical Divider */}
                                    <div style={{
                                        position: 'absolute',
                                        width: '1px',
                                        height: '50px',
                                        background: 'rgba(5, 133, 133, 0.3)',
                                        left: 'calc(50% + 40px)',
                                        top: '50%',
                                        transform: 'translateY(-50%)',
                                        pointerEvents: 'none',
                                        zIndex: 2
                                    }} />

                                    {/* Left Gradient Fade */}
                                    <div style={{
                                        position: 'absolute',
                                        width: '60px',
                                        height: '100%',
                                        background: 'linear-gradient(to right, rgba(255,255,255,1) 0%, rgba(255,255,255,0) 100%)',
                                        left: 0,
                                        top: 0,
                                        pointerEvents: 'none',
                                        zIndex: 3
                                    }} />

                                    {/* Right Gradient Fade */}
                                    <div style={{
                                        position: 'absolute',
                                        width: '60px',
                                        height: '100%',
                                        background: 'linear-gradient(to left, rgba(255,255,255,1) 0%, rgba(255,255,255,0) 100%)',
                                        right: 0,
                                        top: 0,
                                        pointerEvents: 'none',
                                        zIndex: 3
                                    }} />

                                    <div
                                    className="swipeable-picker-container"
                                    style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '20px',
                                        overflowX: 'auto',
                                        overflowY: 'hidden',
                                        scrollSnapType: 'x mandatory',
                                        WebkitOverflowScrolling: 'touch',
                                        scrollBehavior: 'smooth',
                                        padding: '0 calc(50% - 30px)',
                                        width: '100%',
                                        touchAction: 'pan-x'
                                    }}
                                    onScroll={(e) => {
                                        const container = e.target;
                                        const scrollLeft = container.scrollLeft;
                                        const itemWidth = 60 + 20; // width + gap
                                        const centerIndex = Math.round(scrollLeft / itemWidth);
                                        if (centerIndex !== morningCheckInData.anxiety && centerIndex >= 0 && centerIndex <= 10) {
                                            triggerHaptic('light');
                                            setMorningCheckInData(prev => ({ ...prev, anxiety: centerIndex }));
                                        }
                                    }}
                                    >
                                        {[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(rating => (
                                            <div
                                                key={rating}
                                                onClick={() => {
                                                    triggerHaptic('light');
                                                    setMorningCheckInData(prev => ({ ...prev, anxiety: rating }));
                                                }}
                                                style={{
                                                    minWidth: '60px',
                                                    height: '60px',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    fontSize: morningCheckInData.anxiety === rating ? '32px' : '20px',
                                                    fontWeight: morningCheckInData.anxiety === rating ? 'bold' : '400',
                                                    color: morningCheckInData.anxiety === rating ? '#058585' : '#cccccc',
                                                    cursor: 'pointer',
                                                    transition: 'all 0.3s ease',
                                                    transform: morningCheckInData.anxiety === rating ? 'scale(1.2)' : 'scale(1)',
                                                    scrollSnapAlign: 'center',
                                                    userSelect: 'none',
                                                    flexShrink: 0
                                                }}
                                            >
                                                {rating}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* Sleep Card */}
                            <div style={{
                                width: '100%',
                                background: '#FFFFFF',
                                borderRadius: '12px',
                                padding: '12px',
                                marginBottom: '12px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                            }}>
                                <div style={{
                                    fontSize: '14px',
                                    fontWeight: '400',
                                    color: '#000000',
                                    marginBottom: '8px'
                                }}>
                                    Sleep
                                </div>
                                <div style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    position: 'relative',
                                    height: '70px',
                                    overflow: 'hidden'
                                }}>
                                    {/* Highlight Box Behind Selected Number */}
                                    <div style={{
                                        position: 'absolute',
                                        width: '70px',
                                        height: '60px',
                                        background: 'rgba(5, 133, 133, 0.12)',
                                        borderRadius: '12px',
                                        top: '50%',
                                        left: '50%',
                                        transform: 'translate(-50%, -50%)',
                                        pointerEvents: 'none',
                                        zIndex: 1
                                    }} />

                                    {/* Left Vertical Divider */}
                                    <div style={{
                                        position: 'absolute',
                                        width: '1px',
                                        height: '50px',
                                        background: 'rgba(5, 133, 133, 0.3)',
                                        left: 'calc(50% - 40px)',
                                        top: '50%',
                                        transform: 'translateY(-50%)',
                                        pointerEvents: 'none',
                                        zIndex: 2
                                    }} />

                                    {/* Right Vertical Divider */}
                                    <div style={{
                                        position: 'absolute',
                                        width: '1px',
                                        height: '50px',
                                        background: 'rgba(5, 133, 133, 0.3)',
                                        left: 'calc(50% + 40px)',
                                        top: '50%',
                                        transform: 'translateY(-50%)',
                                        pointerEvents: 'none',
                                        zIndex: 2
                                    }} />

                                    {/* Left Gradient Fade */}
                                    <div style={{
                                        position: 'absolute',
                                        width: '60px',
                                        height: '100%',
                                        background: 'linear-gradient(to right, rgba(255,255,255,1) 0%, rgba(255,255,255,0) 100%)',
                                        left: 0,
                                        top: 0,
                                        pointerEvents: 'none',
                                        zIndex: 3
                                    }} />

                                    {/* Right Gradient Fade */}
                                    <div style={{
                                        position: 'absolute',
                                        width: '60px',
                                        height: '100%',
                                        background: 'linear-gradient(to left, rgba(255,255,255,1) 0%, rgba(255,255,255,0) 100%)',
                                        right: 0,
                                        top: 0,
                                        pointerEvents: 'none',
                                        zIndex: 3
                                    }} />

                                    <div
                                    className="swipeable-picker-container"
                                    style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '20px',
                                        overflowX: 'auto',
                                        overflowY: 'hidden',
                                        scrollSnapType: 'x mandatory',
                                        WebkitOverflowScrolling: 'touch',
                                        scrollBehavior: 'smooth',
                                        padding: '0 calc(50% - 30px)',
                                        width: '100%',
                                        touchAction: 'pan-x'
                                    }}
                                    onScroll={(e) => {
                                        const container = e.target;
                                        const scrollLeft = container.scrollLeft;
                                        const itemWidth = 60 + 20; // width + gap
                                        const centerIndex = Math.round(scrollLeft / itemWidth);
                                        if (centerIndex !== morningCheckInData.sleep && centerIndex >= 0 && centerIndex <= 10) {
                                            triggerHaptic('light');
                                            setMorningCheckInData(prev => ({ ...prev, sleep: centerIndex }));
                                        }
                                    }}
                                    >
                                        {[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(rating => (
                                            <div
                                                key={rating}
                                                onClick={() => {
                                                    triggerHaptic('light');
                                                    setMorningCheckInData(prev => ({ ...prev, sleep: rating }));
                                                }}
                                                style={{
                                                    minWidth: '60px',
                                                    height: '60px',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    fontSize: morningCheckInData.sleep === rating ? '32px' : '20px',
                                                    fontWeight: morningCheckInData.sleep === rating ? 'bold' : '400',
                                                    color: morningCheckInData.sleep === rating ? '#058585' : '#cccccc',
                                                    cursor: 'pointer',
                                                    transition: 'all 0.3s ease',
                                                    transform: morningCheckInData.sleep === rating ? 'scale(1.2)' : 'scale(1)',
                                                    scrollSnapAlign: 'center',
                                                    userSelect: 'none',
                                                    flexShrink: 0
                                                }}
                                            >
                                                {rating}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* Submit Button */}
                            <div style={{ display: 'flex', justifyContent: 'center', marginBottom: '20px' }}>
                                <button
                                    onClick={async () => {
                                        triggerHaptic('success');

                                        try {
                                            // Save check-in to Firestore
                                            await handleMorningCheckIn(morningCheckInData);

                                            // Wait for Firestore write to propagate (200ms)
                                            await new Promise(resolve => setTimeout(resolve, 200));

                                            // Refresh all stats from server (streak, check rate, avg mood, this week)
                                            await loadStreak();

                                            // Refresh check-ins and charts (for Journey/Progress tab graphs)
                                            await loadCheckIns();

                                            // Refresh streak modal data (for when user clicks streak card)
                                            await loadStreakCheckIns();

                                            // Refresh daily task status (updates checkInStatus.morning to true)
                                            await loadDailyTasksStatus();

                                            // Success feedback
                                            alert('Check-in submitted! ✅');

                                            // Reset form
                                            setMorningCheckInData({
                                                mood: null,
                                                craving: null,
                                                anxiety: null,
                                                sleep: null
                                            });
                                        } catch (error) {
                                            console.error('Submit error:', error);
                                            alert('Failed to submit check-in. Please try again.');
                                        }
                                    }}
                                    disabled={morningCheckInData.mood == null || morningCheckInData.craving == null || morningCheckInData.anxiety == null || morningCheckInData.sleep == null}
                                    style={{
                                        width: '120px',
                                        height: '40px',
                                        background: (morningCheckInData.mood == null || morningCheckInData.craving == null || morningCheckInData.anxiety == null || morningCheckInData.sleep == null) ? '#cccccc' : '#058585',
                                        border: 'none',
                                        borderRadius: '8px',
                                        color: '#FFFFFF',
                                        fontSize: '14px',
                                        fontWeight: '400',
                                        cursor: (morningCheckInData.mood == null || morningCheckInData.craving == null || morningCheckInData.anxiety == null || morningCheckInData.sleep == null) ? 'not-allowed' : 'pointer',
                                        transition: 'all 0.2s'
                                    }}
                                >
                                    Submit
                                </button>
                            </div>
                            </>
                            )}

                            {/* Streak Counter Card - Placeholder */}
                            <div style={{
                                width: '100%',
                                background: '#FFFFFF',
                                borderRadius: '12px',
                                padding: '12px',
                                marginBottom: '12px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                cursor: 'pointer'
                            }}
                            onClick={async () => {
                                triggerHaptic('light');
                                await loadStreakCheckIns();
                                setShowStreakModal(true);
                            }}>
                                <span style={{
                                    fontSize: '14px',
                                    fontWeight: '400',
                                    color: '#000000'
                                }}>
                                    Check-In Streak
                                </span>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                    {checkInStreak > 0 ? (
                                        <>
                                            <span style={{
                                                fontSize: '18px',
                                                fontWeight: 'bold',
                                                color: '#058585'
                                            }}>
                                                {checkInStreak} {checkInStreak === 1 ? 'day' : 'days'}
                                            </span>
                                            <i data-lucide="chevron-right" style={{ width: '16px', height: '16px', color: '#666666' }}></i>
                                        </>
                                    ) : (
                                        <span style={{
                                            fontSize: '14px',
                                            fontWeight: '400',
                                            color: '#999999',
                                            fontStyle: 'italic'
                                        }}>
                                            Start checking in daily!
                                        </span>
                                    )}
                                </div>
                            </div>

                            {/* Quick Stats Header */}
                            <h3 style={{
                                fontSize: '16px',
                                fontWeight: '400',
                                color: '#000000',
                                marginBottom: '10px',
                                marginTop: '20px'
                            }}>
                                Quick Stats
                            </h3>

                            {/* Check Rate Stat Card - Clickable */}
                            <div style={{
                                width: '100%',
                                background: '#FFFFFF',
                                borderRadius: '12px',
                                padding: '12px',
                                marginBottom: '8px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                cursor: 'pointer',
                                transition: 'all 0.2s'
                            }}
                            onClick={async () => {
                                triggerHaptic('light');
                                setShowCalendarHeatmapModal(true);
                                await loadCalendarHeatmapData();
                            }}>
                                <span style={{
                                    fontSize: '14px',
                                    fontWeight: '400',
                                    color: '#000000'
                                }}>
                                    Check Rate
                                </span>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                    {weeklyStats.checkRate > 0 ? (
                                        <>
                                            <span style={{
                                                fontSize: '18px',
                                                fontWeight: 'bold',
                                                color: '#000000'
                                            }}>
                                                {weeklyStats.checkRate}%
                                            </span>
                                            <i data-lucide="chevron-right" style={{ width: '16px', height: '16px', color: '#666666' }}></i>
                                        </>
                                    ) : (
                                        <span style={{
                                            fontSize: '14px',
                                            fontWeight: '400',
                                            color: '#999999',
                                            fontStyle: 'italic'
                                        }}>
                                            No data yet
                                        </span>
                                    )}
                                </div>
                            </div>

                            {/* Avg Mood Stat Card - Clickable */}
                            <div style={{
                                width: '100%',
                                background: '#FFFFFF',
                                borderRadius: '12px',
                                padding: '12px',
                                marginBottom: '8px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                cursor: 'pointer',
                                transition: 'all 0.2s'
                            }}
                            onClick={async () => {
                                triggerHaptic('light');
                                await loadMoodWeekData();
                                setShowMoodInsightsModal(true);
                            }}>
                                <span style={{
                                    fontSize: '14px',
                                    fontWeight: '400',
                                    color: '#000000'
                                }}>
                                    Avg Mood
                                </span>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                    {weeklyStats.avgMood > 0 ? (
                                        <>
                                            <span style={{
                                                fontSize: '18px',
                                                fontWeight: 'bold',
                                                color: '#000000'
                                            }}>
                                                {weeklyStats.avgMood}
                                            </span>
                                            <i data-lucide="chevron-right" style={{ width: '16px', height: '16px', color: '#666666' }}></i>
                                        </>
                                    ) : (
                                        <span style={{
                                            fontSize: '14px',
                                            fontWeight: '400',
                                            color: '#999999',
                                            fontStyle: 'italic'
                                        }}>
                                            No data yet
                                        </span>
                                    )}
                                </div>
                            </div>

                            {/* Longest Streak Stat Card - Clickable */}
                            <div style={{
                                width: '100%',
                                background: '#FFFFFF',
                                borderRadius: '12px',
                                padding: '12px',
                                marginBottom: '16px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                cursor: 'pointer',
                                transition: 'all 0.2s'
                            }}
                            onClick={() => {
                                triggerHaptic('light');
                                setShowStreaksModal(true);
                            }}>
                                <span style={{
                                    fontSize: '14px',
                                    fontWeight: '400',
                                    color: '#000000'
                                }}>
                                    Longest Streak
                                </span>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                    {streakData.longestStreak > 0 ? (
                                        <>
                                            <span style={{
                                                fontSize: '18px',
                                                fontWeight: 'bold',
                                                color: '#000000'
                                            }}>
                                                🔥 {streakData.longestStreak} {streakData.longestStreak === 1 ? 'day' : 'days'}
                                            </span>
                                            <i data-lucide="chevron-right" style={{ width: '16px', height: '16px', color: '#666666' }}></i>
                                        </>
                                    ) : (
                                        <span style={{
                                            fontSize: '14px',
                                            fontWeight: '400',
                                            color: '#999999',
                                            fontStyle: 'italic'
                                        }}>
                                            No data yet
                                        </span>
                                    )}
                                </div>
                            </div>

                            {/* View Check-In Trends Button */}
                            <button style={{
                                width: '100%',
                                height: '48px',
                                background: '#FFFFFF',
                                borderRadius: '12px',
                                padding: '12px',
                                marginBottom: '16px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                                border: '1px solid #058585',
                                color: '#058585',
                                fontSize: '14px',
                                fontWeight: '400',
                                cursor: 'pointer',
                                transition: 'all 0.2s',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '8px'
                            }}
                            onClick={() => {
                                triggerHaptic('light');
                                setCurrentView('progress');
                            }}>
                                <i data-lucide="bar-chart-3" style={{ width: '20px', height: '20px' }}></i>
                                View Check-In Trends
                            </button>

                            {/* Pattern Detection Cards - 4 Types */}
                            {patternDetection && patternDetection.type === 'mood' && (
                                <div style={{
                                    width: '100%',
                                    background: '#E8F5E9',
                                    borderRadius: '12px',
                                    padding: '16px',
                                    marginBottom: '16px',
                                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                                    border: '1px solid #4CAF50'
                                }}>
                                    <div style={{ marginBottom: '12px' }}>
                                        <div style={{
                                            fontSize: '14px',
                                            fontWeight: 'bold',
                                            color: '#000000',
                                            marginBottom: '4px',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '6px'
                                        }}>
                                            <i data-lucide="activity" style={{ width: '20px', height: '20px', color: '#058585' }}></i>
                                            Mood Pattern Detected
                                        </div>
                                        <div style={{
                                            fontSize: '14px',
                                            fontWeight: '400',
                                            color: '#666666'
                                        }}>
                                            {patternDetection.message}
                                        </div>
                                    </div>
                                    <button
                                        onClick={() => {
                                            triggerHaptic('light');
                                            setShowMoodPatternModal(true);
                                        }}
                                        style={{
                                            width: '100%',
                                            height: '40px',
                                            background: '#058585',
                                            border: 'none',
                                            borderRadius: '8px',
                                            color: '#FFFFFF',
                                            fontSize: '14px',
                                            fontWeight: '400',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        View Mood Tips
                                    </button>
                                </div>
                            )}

                            {patternDetection && patternDetection.type === 'craving' && (
                                <div style={{
                                    width: '100%',
                                    background: '#FFEBEE',
                                    borderRadius: '12px',
                                    padding: '16px',
                                    marginBottom: '16px',
                                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                                    border: '1px solid #EF5350'
                                }}>
                                    <div style={{ marginBottom: '12px' }}>
                                        <div style={{
                                            fontSize: '14px',
                                            fontWeight: 'bold',
                                            color: '#000000',
                                            marginBottom: '4px',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '6px'
                                        }}>
                                            <i data-lucide="flame" style={{ width: '20px', height: '20px', color: '#058585' }}></i>
                                            Craving Pattern Detected
                                        </div>
                                        <div style={{
                                            fontSize: '14px',
                                            fontWeight: '400',
                                            color: '#666666'
                                        }}>
                                            {patternDetection.message}
                                        </div>
                                    </div>
                                    <button
                                        onClick={() => {
                                            triggerHaptic('light');
                                            setShowCravingPatternModal(true);
                                        }}
                                        style={{
                                            width: '100%',
                                            height: '40px',
                                            background: '#058585',
                                            border: 'none',
                                            borderRadius: '8px',
                                            color: '#FFFFFF',
                                            fontSize: '14px',
                                            fontWeight: '400',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        View Craving Tips
                                    </button>
                                </div>
                            )}

                            {patternDetection && patternDetection.type === 'anxiety' && (
                                <div style={{
                                    width: '100%',
                                    background: '#FFF3E0',
                                    borderRadius: '12px',
                                    padding: '16px',
                                    marginBottom: '16px',
                                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                                    border: '1px solid #FFB74D'
                                }}>
                                    <div style={{ marginBottom: '12px' }}>
                                        <div style={{
                                            fontSize: '14px',
                                            fontWeight: 'bold',
                                            color: '#000000',
                                            marginBottom: '4px',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '6px'
                                        }}>
                                            <i data-lucide="alert-circle" style={{ width: '20px', height: '20px', color: '#058585' }}></i>
                                            Anxiety Pattern Detected
                                        </div>
                                        <div style={{
                                            fontSize: '14px',
                                            fontWeight: '400',
                                            color: '#666666'
                                        }}>
                                            {patternDetection.message}
                                        </div>
                                    </div>
                                    <button
                                        onClick={() => {
                                            triggerHaptic('light');
                                            setShowAnxietyPatternModal(true);
                                        }}
                                        style={{
                                            width: '100%',
                                            height: '40px',
                                            background: '#058585',
                                            border: 'none',
                                            borderRadius: '8px',
                                            color: '#FFFFFF',
                                            fontSize: '14px',
                                            fontWeight: '400',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        View Anxiety Tips
                                    </button>
                                </div>
                            )}

                            {patternDetection && patternDetection.type === 'sleep' && (
                                <div style={{
                                    width: '100%',
                                    background: '#E3F2FD',
                                    borderRadius: '12px',
                                    padding: '16px',
                                    marginBottom: '16px',
                                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                                    border: '1px solid #64B5F6'
                                }}>
                                    <div style={{ marginBottom: '12px' }}>
                                        <div style={{
                                            fontSize: '14px',
                                            fontWeight: 'bold',
                                            color: '#000000',
                                            marginBottom: '4px',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '6px'
                                        }}>
                                            <i data-lucide="moon" style={{ width: '20px', height: '20px', color: '#058585' }}></i>
                                            Sleep Pattern Detected
                                        </div>
                                        <div style={{
                                            fontSize: '14px',
                                            fontWeight: '400',
                                            color: '#666666'
                                        }}>
                                            {patternDetection.message}
                                        </div>
                                    </div>
                                    <button
                                        onClick={() => {
                                            triggerHaptic('light');
                                            setShowSleepPatternModal(true);
                                        }}
                                        style={{
                                            width: '100%',
                                            height: '40px',
                                            background: '#058585',
                                            border: 'none',
                                            borderRadius: '8px',
                                            color: '#FFFFFF',
                                            fontSize: '14px',
                                            fontWeight: '400',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        View Sleep Tips
                                    </button>
                                </div>
                            )}

                            {/* Coach Notes Card - Conditional */}
                            {coachNotes.length > 0 && (
                                <div style={{
                                    width: '100%',
                                    background: '#FFFFFF',
                                    borderRadius: '12px',
                                    padding: '12px',
                                    marginBottom: '8px',
                                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                                    cursor: 'pointer'
                                }}
                                onClick={() => {
                                    triggerHaptic('light');
                                    alert(coachNotes[0].note || 'Coach note available');
                                }}>
                                    <div style={{
                                        fontSize: '14px',
                                        fontWeight: '400',
                                        color: '#000000',
                                        marginBottom: '8px',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '6px'
                                    }}>
                                        <i data-lucide="message-square" style={{ width: '20px', height: '20px', color: '#058585' }}></i>
                                        Coach Notes
                                    </div>
                                    <div style={{
                                        fontSize: '12px',
                                        fontWeight: '400',
                                        color: '#666666'
                                    }}>
                                        "{coachNotes[0].note || 'New note from your coach'}"
                                    </div>
                                </div>
                            )}

                            {/* Bottom Features Section */}
                            <h3 style={{
                                fontSize: '16px',
                                fontWeight: '400',
                                color: '#000000',
                                marginBottom: '12px',
                                marginTop: '24px'
                            }}>
                                Quick Tools
                            </h3>

                            {/* 1. Emergency SOS Button */}
                            <div style={{
                                width: '100%',
                                background: 'linear-gradient(135deg, #DC143C 0%, #B01030 100%)',
                                borderRadius: '12px',
                                padding: '16px',
                                marginBottom: '8px',
                                boxShadow: '0 4px 12px rgba(220, 20, 60, 0.3)',
                                cursor: 'pointer',
                                border: '2px solid #DC143C'
                            }}
                            onClick={() => {
                                triggerHaptic('medium');
                                alert('Crisis resources:\n\n988 Suicide & Crisis Lifeline\nCall or Text 988\n\nCrisis Text Line\nText HOME to 741741\n\nSAMHSA National Helpline\n1-800-662-4357');
                            }}>
                                <div style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '12px'
                                }}>
                                    <div style={{
                                        width: '48px',
                                        height: '48px',
                                        borderRadius: '50%',
                                        background: 'rgba(255,255,255,0.2)',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center'
                                    }}>
                                        <i data-lucide="alert-octagon" style={{ width: '28px', height: '28px', color: '#FFFFFF' }}></i>
                                    </div>
                                    <div style={{ flex: 1 }}>
                                        <div style={{
                                            fontSize: '16px',
                                            fontWeight: 'bold',
                                            color: '#FFFFFF',
                                            marginBottom: '4px'
                                        }}>
                                            Emergency Support
                                        </div>
                                        <div style={{
                                            fontSize: '12px',
                                            fontWeight: '400',
                                            color: 'rgba(255,255,255,0.9)'
                                        }}>
                                            24/7 crisis resources and helplines
                                        </div>
                                    </div>
                                    <i data-lucide="chevron-right" style={{ width: '20px', height: '20px', color: 'rgba(255,255,255,0.7)' }}></i>
                                </div>
                            </div>

                            {/* 2. Weekly Progress Summary */}
                            <div style={{
                                width: '100%',
                                background: '#FFFFFF',
                                borderRadius: '12px',
                                padding: '12px',
                                marginBottom: '8px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                                cursor: 'pointer',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center'
                            }}
                            onClick={() => {
                                triggerHaptic('light');
                                setShowWeeklyReportModal(true);
                            }}>
                                <div style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '12px'
                                }}>
                                    <i data-lucide="calendar-check" style={{ width: '24px', height: '24px', color: '#058585' }}></i>
                                    <div>
                                        <div style={{
                                            fontSize: '14px',
                                            fontWeight: '400',
                                            color: '#000000'
                                        }}>
                                            Weekly Progress Report
                                        </div>
                                        <div style={{
                                            fontSize: '12px',
                                            fontWeight: '400',
                                            color: '#666666'
                                        }}>
                                            View detailed analytics and insights
                                        </div>
                                    </div>
                                </div>
                                <i data-lucide="chevron-right" style={{ width: '16px', height: '16px', color: '#666666' }}></i>
                            </div>

                            {/* 3. Share Progress */}
                            <div style={{
                                width: '100%',
                                background: '#FFFFFF',
                                borderRadius: '12px',
                                padding: '12px',
                                marginBottom: '8px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                                cursor: 'pointer',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center'
                            }}
                            onClick={() => {
                                triggerHaptic('light');
                                const shareText = checkInStreak > 0
                                    ? `${checkInStreak} ${checkInStreak === 1 ? 'day' : 'days'} check-in streak! Proud of my progress in recovery. ${weeklyStats.checkRate}% check-in rate this month.`
                                    : 'Starting my recovery journey! Following my daily check-ins and reflections.';

                                if (navigator.share) {
                                    navigator.share({
                                        title: 'My Recovery Progress',
                                        text: shareText,
                                    });
                                } else {
                                    alert(`Share your progress:\n\n${shareText}`);
                                }
                            }}>
                                <div style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '12px'
                                }}>
                                    <i data-lucide="share-2" style={{ width: '24px', height: '24px', color: '#058585' }}></i>
                                    <div>
                                        <div style={{
                                            fontSize: '14px',
                                            fontWeight: '400',
                                            color: '#000000'
                                        }}>
                                            Share Your Progress
                                        </div>
                                        <div style={{
                                            fontSize: '12px',
                                            fontWeight: '400',
                                            color: '#666666'
                                        }}>
                                            Celebrate milestones with supporters
                                        </div>
                                    </div>
                                </div>
                                <i data-lucide="chevron-right" style={{ width: '16px', height: '16px', color: '#666666' }}></i>
                            </div>

                            {/* 4. Daily Coping Technique */}
                            {(() => {
                                const dayOfMonth = new Date().getDate();
                                const technique = copingTechniques.find(t => t.day === dayOfMonth) || copingTechniques[0];

                                return (
                                    <div style={{
                                        width: '100%',
                                        background: '#FFFFFF',
                                        borderRadius: '12px',
                                        padding: '12px',
                                        marginBottom: '8px',
                                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center'
                                    }}
                                    onClick={() => {
                                        triggerHaptic('light');
                                        setShowCopingTechniqueModal(true);
                                    }}>
                                        <div style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '12px'
                                        }}>
                                            <i data-lucide={technique.icon} style={{ width: '24px', height: '24px', color: '#058585' }}></i>
                                            <div>
                                                <div style={{
                                                    fontSize: '14px',
                                                    fontWeight: '400',
                                                    color: '#000000'
                                                }}>
                                                    {technique.title}
                                                </div>
                                                <div style={{
                                                    fontSize: '12px',
                                                    fontWeight: '400',
                                                    color: '#666666'
                                                }}>
                                                    Today's coping technique • {technique.category}
                                                </div>
                                            </div>
                                        </div>
                                        <i data-lucide="chevron-right" style={{ width: '16px', height: '16px', color: '#666666' }}></i>
                                    </div>
                                );
                            })()}

                            {/* 5. Recovery Milestones */}
                            {nextMilestone && (
                                <div style={{
                                    width: '100%',
                                    background: 'linear-gradient(135deg, #058585 0%, #047373 100%)',
                                    borderRadius: '12px',
                                    padding: '16px',
                                    marginBottom: '16px',
                                    boxShadow: '0 4px 12px rgba(5, 133, 133, 0.3)',
                                    cursor: 'pointer'
                                }}
                                onClick={() => {
                                    triggerHaptic('light');
                                    setShowMilestoneModal(true);
                                }}>
                                    <div style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '12px'
                                    }}>
                                        <div style={{
                                            width: '48px',
                                            height: '48px',
                                            borderRadius: '50%',
                                            background: 'rgba(255,255,255,0.2)',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center'
                                        }}>
                                            <i data-lucide={nextMilestone.icon} style={{ width: '28px', height: '28px', color: '#FFFFFF' }}></i>
                                        </div>
                                        <div style={{ flex: 1 }}>
                                            <div style={{
                                                fontSize: '16px',
                                                fontWeight: 'bold',
                                                color: '#FFFFFF',
                                                marginBottom: '4px'
                                            }}>
                                                {nextMilestone.achieved ?
                                                    'All Milestones Complete!' :
                                                    `Next: ${nextMilestone.label}`
                                                }
                                            </div>
                                            <div style={{
                                                fontSize: '12px',
                                                fontWeight: '400',
                                                color: 'rgba(255,255,255,0.9)'
                                            }}>
                                                {nextMilestone.achieved ?
                                                    `${nextMilestone.daysSober} days sober - Amazing!` :
                                                    `${nextMilestone.daysUntil} ${nextMilestone.daysUntil === 1 ? 'day' : 'days'} to go • ${nextMilestone.progressPercentage}% there`
                                                }
                                            </div>
                                        </div>
                                        <i data-lucide="chevron-right" style={{ width: '20px', height: '20px', color: 'rgba(255,255,255,0.7)' }}></i>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* REFLECTIONS TAB */}
                    {activeTaskTab === 'reflections' && (
                        <div style={{
                            padding: '16px 5%',
                            maxWidth: '600px',
                            margin: '0 auto'
                        }}>
                            {/* Evening Reflections Section */}
                            <h3 style={{
                                fontSize: '16px',
                                fontWeight: '400',
                                color: '#000000',
                                marginBottom: '10px'
                            }}>
                                Evening Reflections
                            </h3>

                            {/* Check if evening reflection is already complete */}
                            {checkInStatus.evening ? (
                                // COMPLETE STATE - Show completion message
                                <div style={{
                                    width: '100%',
                                    background: 'linear-gradient(135deg, rgba(5, 133, 133, 0.1) 0%, rgba(5, 133, 133, 0.05) 100%)',
                                    borderRadius: '12px',
                                    padding: '30px 20px',
                                    marginBottom: '20px',
                                    textAlign: 'center',
                                    border: '2px solid rgba(5, 133, 133, 0.2)'
                                }}>
                                    <div style={{ fontSize: '64px', marginBottom: '15px' }}>✅</div>
                                    <h3 style={{
                                        fontSize: '18px',
                                        fontWeight: 'bold',
                                        color: '#058585',
                                        marginBottom: '8px'
                                    }}>
                                        Evening Reflection Complete!
                                    </h3>
                                    <p style={{
                                        fontSize: '14px',
                                        color: '#666',
                                        margin: 0
                                    }}>
                                        Great job! Your evening reflection has been recorded. Come back tomorrow for your next reflection.
                                    </p>
                                </div>
                            ) : (
                                // PENDING STATE - Show form
                                <>
                            {/* Daily Reflection Prompt */}
                            <div style={{
                                width: '100%',
                                background: '#E3F2FD',
                                borderRadius: '12px',
                                padding: '16px',
                                marginBottom: '12px',
                                border: '1px solid #90CAF9'
                            }}>
                                <div style={{
                                    fontSize: '14px',
                                    fontWeight: 'bold',
                                    color: '#000000',
                                    marginBottom: '8px'
                                }}>
                                    Today's Reflection Prompt
                                </div>
                                <div style={{
                                    fontSize: '14px',
                                    fontWeight: '400',
                                    color: '#666666',
                                    fontStyle: 'italic'
                                }}>
                                    "What challenged you today, and what did you learn from it?"
                                </div>
                            </div>

                            {/* Prompt Response Card */}
                            <div style={{
                                width: '100%',
                                background: '#FFFFFF',
                                borderRadius: '12px',
                                padding: '12px',
                                marginBottom: '8px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                            }}>
                                <div style={{
                                    fontSize: '14px',
                                    fontWeight: '400',
                                    color: '#000000',
                                    marginBottom: '8px'
                                }}>
                                    Your Response
                                </div>
                                <textarea
                                    value={eveningReflectionData.promptResponse}
                                    onChange={(e) => setEveningReflectionData(prev => ({ ...prev, promptResponse: e.target.value }))}
                                    placeholder="Reflect on today's prompt..."
                                    style={{
                                        width: '100%',
                                        minHeight: '80px',
                                        border: '1px solid #ddd',
                                        borderRadius: '8px',
                                        padding: '8px',
                                        fontSize: '14px',
                                        fontWeight: '400',
                                        color: '#000000',
                                        resize: 'vertical',
                                        fontFamily: 'inherit'
                                    }}
                                />
                            </div>

                            {/* Overall Day Card - Scrolling Picker */}
                            <div style={{
                                width: '100%',
                                background: '#FFFFFF',
                                borderRadius: '12px',
                                padding: '12px',
                                marginBottom: '8px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                            }}>
                                <div style={{
                                    fontSize: '14px',
                                    fontWeight: '400',
                                    color: '#000000',
                                    marginBottom: '8px'
                                }}>
                                    Overall Day
                                </div>
                                <div style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    position: 'relative',
                                    height: '70px',
                                    overflow: 'hidden'
                                }}>
                                    {/* Highlight Box Behind Selected Number */}
                                    <div style={{
                                        position: 'absolute',
                                        width: '70px',
                                        height: '60px',
                                        background: 'rgba(5, 133, 133, 0.12)',
                                        borderRadius: '12px',
                                        top: '50%',
                                        left: '50%',
                                        transform: 'translate(-50%, -50%)',
                                        pointerEvents: 'none',
                                        zIndex: 1
                                    }} />

                                    {/* Left Vertical Divider */}
                                    <div style={{
                                        position: 'absolute',
                                        width: '1px',
                                        height: '50px',
                                        background: 'rgba(5, 133, 133, 0.3)',
                                        left: 'calc(50% - 40px)',
                                        top: '50%',
                                        transform: 'translateY(-50%)',
                                        pointerEvents: 'none',
                                        zIndex: 2
                                    }} />

                                    {/* Right Vertical Divider */}
                                    <div style={{
                                        position: 'absolute',
                                        width: '1px',
                                        height: '50px',
                                        background: 'rgba(5, 133, 133, 0.3)',
                                        left: 'calc(50% + 40px)',
                                        top: '50%',
                                        transform: 'translateY(-50%)',
                                        pointerEvents: 'none',
                                        zIndex: 2
                                    }} />

                                    {/* Left Gradient Fade */}
                                    <div style={{
                                        position: 'absolute',
                                        width: '60px',
                                        height: '100%',
                                        background: 'linear-gradient(to right, rgba(255,255,255,1) 0%, rgba(255,255,255,0) 100%)',
                                        left: 0,
                                        top: 0,
                                        pointerEvents: 'none',
                                        zIndex: 3
                                    }} />

                                    {/* Right Gradient Fade */}
                                    <div style={{
                                        position: 'absolute',
                                        width: '60px',
                                        height: '100%',
                                        background: 'linear-gradient(to left, rgba(255,255,255,1) 0%, rgba(255,255,255,0) 100%)',
                                        right: 0,
                                        top: 0,
                                        pointerEvents: 'none',
                                        zIndex: 3
                                    }} />

                                    <div
                                        className="swipeable-picker-container"
                                        style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '20px',
                                            overflowX: 'auto',
                                            overflowY: 'hidden',
                                            scrollSnapType: 'x mandatory',
                                            WebkitOverflowScrolling: 'touch',
                                            scrollBehavior: 'smooth',
                                            padding: '0 calc(50% - 30px)',
                                            width: '100%',
                                            touchAction: 'pan-x'
                                        }}
                                        onScroll={(e) => {
                                            const container = e.target;
                                            const scrollLeft = container.scrollLeft;
                                            const itemWidth = 80; // 60px width + 20px gap
                                            const centerIndex = Math.round(scrollLeft / itemWidth);
                                            setEveningReflectionData(prev => ({ ...prev, overallDay: centerIndex }));
                                        }}
                                    >
                                        {[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(num => (
                                            <div
                                                key={num}
                                                style={{
                                                    minWidth: '60px',
                                                    height: '60px',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    fontSize: eveningReflectionData.overallDay === num ? '36px' : '24px',
                                                    fontWeight: eveningReflectionData.overallDay === num ? 'bold' : '400',
                                                    color: eveningReflectionData.overallDay === num ? '#058585' : '#CCCCCC',
                                                    transition: 'all 0.2s',
                                                    scrollSnapAlign: 'center',
                                                    cursor: 'pointer',
                                                    userSelect: 'none'
                                                }}
                                                onClick={() => {
                                                    triggerHaptic('light');
                                                    setEveningReflectionData(prev => ({ ...prev, overallDay: num }));
                                                    const container = e.target.closest('.swipeable-picker-container');
                                                    if (container) {
                                                        const itemWidth = 80;
                                                        container.scrollLeft = num * itemWidth;
                                                    }
                                                }}
                                            >
                                                {num}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* Challenges Card */}
                            <div style={{
                                width: '100%',
                                background: '#FFFFFF',
                                borderRadius: '12px',
                                padding: '12px',
                                marginBottom: '8px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                            }}>
                                <div style={{
                                    fontSize: '14px',
                                    fontWeight: '400',
                                    color: '#000000',
                                    marginBottom: '8px'
                                }}>
                                    Today's Challenges
                                </div>
                                <textarea
                                    value={eveningReflectionData.challenges}
                                    onChange={(e) => setEveningReflectionData(prev => ({ ...prev, challenges: e.target.value }))}
                                    placeholder="What challenges did you face today?"
                                    style={{
                                        width: '100%',
                                        minHeight: '60px',
                                        border: '1px solid #ddd',
                                        borderRadius: '8px',
                                        padding: '8px',
                                        fontSize: '14px',
                                        fontWeight: '400',
                                        color: '#000000',
                                        resize: 'vertical',
                                        fontFamily: 'inherit'
                                    }}
                                />
                            </div>

                            {/* Gratitude Card */}
                            <div style={{
                                width: '100%',
                                background: '#FFFFFF',
                                borderRadius: '12px',
                                padding: '12px',
                                marginBottom: '8px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                            }}>
                                <div style={{
                                    fontSize: '14px',
                                    fontWeight: '400',
                                    color: '#000000',
                                    marginBottom: '8px'
                                }}>
                                    What I'm Grateful For
                                </div>
                                <textarea
                                    value={eveningReflectionData.gratitude}
                                    onChange={(e) => setEveningReflectionData(prev => ({ ...prev, gratitude: e.target.value }))}
                                    placeholder="What are you grateful for today?"
                                    style={{
                                        width: '100%',
                                        minHeight: '60px',
                                        border: '1px solid #ddd',
                                        borderRadius: '8px',
                                        padding: '8px',
                                        fontSize: '14px',
                                        fontWeight: '400',
                                        color: '#000000',
                                        resize: 'vertical',
                                        fontFamily: 'inherit'
                                    }}
                                />
                            </div>

                            {/* Tomorrow's Goal Card */}
                            <div style={{
                                width: '100%',
                                background: '#FFFFFF',
                                borderRadius: '12px',
                                padding: '12px',
                                marginBottom: '16px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                            }}>
                                <div style={{
                                    fontSize: '14px',
                                    fontWeight: '400',
                                    color: '#000000',
                                    marginBottom: '8px'
                                }}>
                                    Tomorrow's Goal
                                </div>
                                <textarea
                                    value={eveningReflectionData.tomorrowGoal}
                                    onChange={(e) => setEveningReflectionData(prev => ({ ...prev, tomorrowGoal: e.target.value }))}
                                    placeholder="What's your goal for tomorrow?"
                                    style={{
                                        width: '100%',
                                        minHeight: '60px',
                                        border: '1px solid #ddd',
                                        borderRadius: '8px',
                                        padding: '8px',
                                        fontSize: '14px',
                                        fontWeight: '400',
                                        color: '#000000',
                                        resize: 'vertical',
                                        fontFamily: 'inherit'
                                    }}
                                />
                            </div>

                            {/* Submit Button */}
                            <div style={{ display: 'flex', justifyContent: 'center', marginBottom: '24px' }}>
                                <button
                                    onClick={async () => {
                                        triggerHaptic('success');
                                        await handleEveningReflection(eveningReflectionData);
                                    }}
                                    disabled={eveningReflectionData.overallDay === null || !eveningReflectionData.challenges || !eveningReflectionData.gratitude || !eveningReflectionData.tomorrowGoal}
                                    style={{
                                        width: '120px',
                                        height: '40px',
                                        background: (eveningReflectionData.overallDay === null || !eveningReflectionData.challenges || !eveningReflectionData.gratitude || !eveningReflectionData.tomorrowGoal) ? '#cccccc' : '#058585',
                                        border: 'none',
                                        borderRadius: '8px',
                                        color: '#FFFFFF',
                                        fontSize: '14px',
                                        fontWeight: '400',
                                        cursor: (eveningReflectionData.overallDay === null || !eveningReflectionData.challenges || !eveningReflectionData.gratitude || !eveningReflectionData.tomorrowGoal) ? 'not-allowed' : 'pointer',
                                        transition: 'all 0.2s'
                                    }}
                                >
                                    Submit
                                </button>
                            </div>
                                </>
                            )}

                            {/* Reflection Streak Card */}
                            <div style={{
                                width: '100%',
                                background: '#FFFFFF',
                                borderRadius: '12px',
                                padding: '12px',
                                marginBottom: '12px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                cursor: 'pointer'
                            }}
                            onClick={async () => {
                                triggerHaptic('light');
                                await loadStreakReflections();
                                setShowReflectionStreakModal(true);
                            }}>
                                <span style={{
                                    fontSize: '14px',
                                    fontWeight: '400',
                                    color: '#000000'
                                }}>
                                    Reflection Streak
                                </span>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                    {reflectionStreak > 0 ? (
                                        <>
                                            <span style={{
                                                fontSize: '18px',
                                                fontWeight: 'bold',
                                                color: '#058585'
                                            }}>
                                                {reflectionStreak} {reflectionStreak === 1 ? 'day' : 'days'}
                                            </span>
                                            <i data-lucide="chevron-right" style={{ width: '16px', height: '16px', color: '#666666' }}></i>
                                        </>
                                    ) : (
                                        <span style={{
                                            fontSize: '14px',
                                            fontWeight: '400',
                                            color: '#999999',
                                            fontStyle: 'italic'
                                        }}>
                                            Start reflecting daily!
                                        </span>
                                    )}
                                </div>
                            </div>

                            {/* Quick Stats Header */}
                            <h3 style={{
                                fontSize: '16px',
                                fontWeight: '400',
                                color: '#000000',
                                marginBottom: '10px',
                                marginTop: '20px'
                            }}>
                                Reflection Stats
                            </h3>

                            {/* Total This Month Stat Card */}
                            <div style={{
                                width: '100%',
                                background: '#FFFFFF',
                                borderRadius: '12px',
                                padding: '12px',
                                marginBottom: '8px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center'
                            }}>
                                <span style={{
                                    fontSize: '14px',
                                    fontWeight: '400',
                                    color: '#000000'
                                }}>
                                    Total This Month
                                </span>
                                {reflectionStats.totalThisMonth > 0 ? (
                                    <span style={{
                                        fontSize: '18px',
                                        fontWeight: 'bold',
                                        color: '#000000'
                                    }}>
                                        {reflectionStats.totalThisMonth}
                                    </span>
                                ) : (
                                    <span style={{
                                        fontSize: '14px',
                                        fontWeight: '400',
                                        color: '#999999',
                                        fontStyle: 'italic'
                                    }}>
                                        0
                                    </span>
                                )}
                            </div>

                            {/* Avg Daily Score Stat Card */}
                            <div style={{
                                width: '100%',
                                background: '#FFFFFF',
                                borderRadius: '12px',
                                padding: '12px',
                                marginBottom: '8px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center'
                            }}>
                                <span style={{
                                    fontSize: '14px',
                                    fontWeight: '400',
                                    color: '#000000'
                                }}>
                                    Avg Daily Score
                                </span>
                                {reflectionStats.avgDailyScore > 0 ? (
                                    <span style={{
                                        fontSize: '18px',
                                        fontWeight: 'bold',
                                        color: '#000000'
                                    }}>
                                        {reflectionStats.avgDailyScore}
                                    </span>
                                ) : (
                                    <span style={{
                                        fontSize: '14px',
                                        fontWeight: '400',
                                        color: '#999999',
                                        fontStyle: 'italic'
                                    }}>
                                        No data
                                    </span>
                                )}
                            </div>

                            {/* Top Gratitude Theme Stat Card */}
                            <div style={{
                                width: '100%',
                                background: '#FFFFFF',
                                borderRadius: '12px',
                                padding: '12px',
                                marginBottom: '16px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center'
                            }}>
                                <span style={{
                                    fontSize: '14px',
                                    fontWeight: '400',
                                    color: '#000000'
                                }}>
                                    Top Gratitude Theme
                                </span>
                                {reflectionStats.topGratitudeTheme ? (
                                    <span style={{
                                        fontSize: '14px',
                                        fontWeight: '400',
                                        color: '#058585'
                                    }}>
                                        {reflectionStats.topGratitudeTheme}
                                    </span>
                                ) : (
                                    <span style={{
                                        fontSize: '14px',
                                        fontWeight: '400',
                                        color: '#999999',
                                        fontStyle: 'italic'
                                    }}>
                                        No gratitudes yet
                                    </span>
                                )}
                            </div>

                            {/* Longest Streak Stat Card - Clickable */}
                            <div style={{
                                width: '100%',
                                background: '#FFFFFF',
                                borderRadius: '12px',
                                padding: '12px',
                                marginBottom: '16px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                cursor: 'pointer',
                                transition: 'all 0.2s'
                            }}
                            onClick={() => {
                                triggerHaptic('light');
                                setShowReflectionStreaksModal(true);
                            }}>
                                <span style={{
                                    fontSize: '14px',
                                    fontWeight: '400',
                                    color: '#000000'
                                }}>
                                    Longest Streak
                                </span>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                    {reflectionStreakData.longestStreak > 0 ? (
                                        <>
                                            <span style={{
                                                fontSize: '18px',
                                                fontWeight: 'bold',
                                                color: '#000000'
                                            }}>
                                                🔥 {reflectionStreakData.longestStreak} {reflectionStreakData.longestStreak === 1 ? 'day' : 'days'}
                                            </span>
                                            <i data-lucide="chevron-right" style={{ width: '16px', height: '16px', color: '#666666' }}></i>
                                        </>
                                    ) : (
                                        <span style={{
                                            fontSize: '14px',
                                            fontWeight: '400',
                                            color: '#999999',
                                            fontStyle: 'italic'
                                        }}>
                                            No data yet
                                        </span>
                                    )}
                                </div>
                            </div>

                            {/* View Past Reflections Button */}
                            <button style={{
                                width: '100%',
                                height: '48px',
                                background: '#FFFFFF',
                                borderRadius: '12px',
                                padding: '12px',
                                marginBottom: '12px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                                border: '1px solid #058585',
                                color: '#058585',
                                fontSize: '14px',
                                fontWeight: '400',
                                cursor: 'pointer',
                                transition: 'all 0.2s'
                            }}
                            onClick={() => {
                                triggerHaptic('light');
                                setShowPastReflectionsModal(true);
                            }}>
                                View Past Reflections
                            </button>

                            {/* Quick Tools Section */}
                            <h3 style={{
                                fontSize: '16px',
                                fontWeight: 'bold',
                                color: '#000000',
                                marginTop: '24px',
                                marginBottom: '12px'
                            }}>
                                Quick Tools
                            </h3>

                            {/* Gratitude Entry Button */}
                            <button style={{
                                width: '100%',
                                height: '48px',
                                background: '#058585',
                                borderRadius: '12px',
                                padding: '12px',
                                marginBottom: '12px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                                border: 'none',
                                color: '#FFFFFF',
                                fontSize: '14px',
                                fontWeight: '400',
                                cursor: 'pointer',
                                transition: 'all 0.2s',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '8px'
                            }}
                            onClick={() => {
                                triggerHaptic('light');
                                setShowGratitudeModal(true);
                            }}>
                                <i data-lucide="heart" style={{ width: '16px', height: '16px' }}></i>
                                Gratitude Entry
                            </button>
                        </div>
                    )}

                    {/* THE GOLDEN THREAD TAB */}
                    {activeTaskTab === 'golden' && (
                        <div style={{ padding: '16px 5%' }}>
                            <GoalsTasksView
                                user={user}
                                goals={goals}
                                assignments={assignments}
                                onAssignmentComplete={handleAssignmentComplete}
                                onReflectionSave={handleReflectionSave}
                                onShowGratitudeModal={() => setShowGratitudeModal(true)}
                            />
                        </div>
                    )}
                    </div>
                </>
            )}

            {currentView === 'progress' && (
    <div className="section-content">
        <h2 style={{
            color: 'white',
            marginBottom: 'var(--space-4)',
            display: 'flex',
            alignItems: 'center',
            gap: 'var(--space-2)'
        }}>
            <i data-lucide="compass" style={{width: '28px', height: '28px'}}></i>
            <span>My Journey</span>
        </h2>
        
        <div className="compliance-card">
            <h3 style={{color: '#9c27b0', marginBottom: '15px'}}>Compliance Metrics</h3>
            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px'}}>
                <div>
                    <div style={{fontSize: '14px', opacity: 0.8}}>Check-in Compliance</div>
                    <div style={{fontSize: '24px', fontWeight: 'bold', color: '#f4c430'}}>
                        {complianceRate.checkIn}%
                    </div>
                    <small style={{opacity: 0.6}}>Last 30 days</small>
                </div>
                <div>
                    <div style={{fontSize: '14px', opacity: 0.8}}>Assignment Completion</div>
                    <div style={{fontSize: '24px', fontWeight: 'bold', color: '#4CAF50'}}>
                        {complianceRate.assignment}%
                    </div>
                    <small style={{opacity: 0.6}}>All time</small>
                </div>
            </div>
        </div>
        
       <div style={{background: 'rgba(0, 0, 0, 0.3)', backdropFilter: 'blur(10px)', borderRadius: '15px', padding: '20px', marginBottom: '20px', border: '1px solid rgba(255, 255, 255, 0.1)'}}>
    <h3 style={{marginBottom: '20px', color: 'white'}}>30-Day Mood Trend</h3>
    <div style={{height: '250px', overflowX: 'auto', overflowY: 'hidden', position: 'relative'}}>
        <div style={{minWidth: '800px', height: '100%'}}>
            <canvas id="moodChart"></canvas>
        </div>
    </div>
    <div style={{display: 'flex', justifyContent: 'center', marginTop: '10px', fontSize: '12px', color: '#666'}}>
        <span>← Scroll to view more days →</span>
    </div>
</div>

<div style={{background: 'rgba(0, 0, 0, 0.3)', backdropFilter: 'blur(10px)', borderRadius: '15px', padding: '20px', marginBottom: '20px', border: '1px solid rgba(255, 255, 255, 0.1)'}}>
    <h3 style={{marginBottom: '20px', color: 'white'}}>30-Day Craving Trend</h3>
    <div style={{height: '250px', overflowX: 'auto', overflowY: 'hidden', position: 'relative'}}>
        <div style={{minWidth: '800px', height: '100%'}}>
            <canvas id="cravingChart"></canvas>
        </div>
    </div>
    <div style={{display: 'flex', justifyContent: 'center', marginTop: '10px', fontSize: '12px', color: '#666'}}>
        <span>← Scroll to view more days →</span>
    </div>
</div>

<div style={{background: 'rgba(0, 0, 0, 0.3)', backdropFilter: 'blur(10px)', borderRadius: '15px', padding: '20px', marginBottom: '20px', border: '1px solid rgba(255, 255, 255, 0.1)'}}>
    <h3 style={{marginBottom: '20px', color: 'white'}}>30-Day Anxiety Trend</h3>
    <div style={{height: '250px', overflowX: 'auto', overflowY: 'hidden', position: 'relative'}}>
        <div style={{minWidth: '800px', height: '100%'}}>
            <canvas id="anxietyChart"></canvas>
        </div>
    </div>
    <div style={{display: 'flex', justifyContent: 'center', marginTop: '10px', fontSize: '12px', color: '#666'}}>
        <span>← Scroll to view more days →</span>
    </div>
</div>

<div style={{background: 'rgba(0, 0, 0, 0.3)', backdropFilter: 'blur(10px)', borderRadius: '15px', padding: '20px', marginBottom: '20px', border: '1px solid rgba(255, 255, 255, 0.1)'}}>
    <h3 style={{marginBottom: '20px', color: 'white'}}>30-Day Sleep Quality Trend</h3>
    <div style={{height: '250px', overflowX: 'auto', overflowY: 'hidden', position: 'relative'}}>
        <div style={{minWidth: '800px', height: '100%'}}>
            <canvas id="sleepChart"></canvas>
        </div>
    </div>
    <div style={{display: 'flex', justifyContent: 'center', marginTop: '10px', fontSize: '12px', color: '#666'}}>
        <span>← Scroll to view more days →</span>
    </div>
</div>
        
        
        <div style={{marginBottom: '20px'}}>
            <div style={{
                background: 'rgba(76, 175, 80, 0.1)',
                borderRadius: '15px',
                padding: '15px',
                marginBottom: '15px'
            }}>
                            <h3 style={{color: '#4CAF50', marginBottom: '10px'}}>
                                Recovery Milestones
                            </h3>
                            {userData?.sobrietyDate ? (
                                <>
                                    {(() => {
                                        const recoveryMilestones = getRecoveryMilestones(userData.sobrietyDate);
                                        const achieved = recoveryMilestones.filter(m => m.achieved);
                                        const upcoming = recoveryMilestones.find(m => !m.achieved);
                                        
                                        return (
                                            <>
                                                {achieved.length > 0 && (
                                                    <div style={{marginBottom: '10px'}}>
                                                        <small style={{color: 'rgba(255,255,255,0.6)'}}>
                                                            Latest Achievement:
                                                        </small>
                                                        <div style={{
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            gap: '10px',
                                                            marginTop: '5px'
                                                        }}>
                                                            <span style={{fontSize: '24px'}}>
                                                                {achieved[achieved.length - 1].icon}
                                                            </span>
                                                            <span style={{color: 'white'}}>
                                                                {achieved[achieved.length - 1].title}
                                                            </span>
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                {upcoming && (
                                                    <div>
                                                        <small style={{color: 'rgba(255,255,255,0.6)'}}>
                                                            Next Milestone:
                                                        </small>
                                                        <div style={{
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            justifyContent: 'space-between',
                                                            marginTop: '5px'
                                                        }}>
                                                            <div style={{
                                                                display: 'flex',
                                                                alignItems: 'center',
                                                                gap: '10px'
                                                            }}>
                                                                <span style={{fontSize: '24px'}}>
                                                                    {upcoming.icon}
                                                                </span>
                                                                <span style={{color: 'white'}}>
                                                                    {upcoming.title}
                                                                </span>
                                                            </div>
                                                            <span style={{
                                                                color: upcoming.daysUntil <= 1 ? '#ffd700' : 'rgba(255,255,255,0.6)',
                                                                fontSize: '14px'
                                                            }}>
                                                                {upcoming.daysUntil === 0 ? 'Today!' :
                                                                 upcoming.daysUntil === 1 ? 'Tomorrow!' :
                                                                 `${upcoming.daysUntil} days`}
                                                            </span>
                                                        </div>
                                                    </div>
                                                )}
                                            </>
                                        );
                                    })()}
                                </>
                            ) : (
                                <p style={{color: 'rgba(255,255,255,0.6)', fontSize: '14px'}}>
                                    Set your sobriety date to track milestones
                                </p>
                            )}
                        </div>
                        
                        {milestones && milestones.length > 0 && (
                            <div style={{
                                background: 'rgba(156, 39, 176, 0.1)',
                                borderRadius: '15px',
                                padding: '15px'
                            }}>
                                <h3 style={{color: '#9c27b0', marginBottom: '10px'}}>
                                    ⭐ Personal Milestones
                                </h3>
                                {milestones.slice(0, 3).map(milestone => (
                                    <div key={milestone.id} style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'space-between',
                                        padding: '8px 0',
                                        borderBottom: '1px solid rgba(255,255,255,0.1)'
                                    }}>
                                        <div style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '10px'
                                        }}>
                                            <i data-lucide={milestone.icon || 'target'} style={{width: '20px', height: '20px', color: 'var(--color-primary-light)'}}></i>
                                            <span style={{color: 'white', fontSize: '14px'}}>
                                                {milestone.title}
                                            </span>
                                        </div>
                                        {milestone.targetDate && (
                                            <span style={{
                                                color: 'rgba(255,255,255,0.6)',
                                                fontSize: '12px'
                                            }}>
                                                {new Date(milestone.targetDate.toDate()).toLocaleDateString()}
                                            </span>
                                        )}
                                    </div>
                                ))}
                                {milestones.length > 3 && (
                                    <button 
                                        onClick={() => setCurrentView('milestones')}
                                        style={{
                                            marginTop: '10px',
                                            background: 'transparent',
                                            border: 'none',
                                            color: '#9c27b0',
                                            cursor: 'pointer',
                                            fontSize: '14px'
                                        }}
                                    >
                                        View all {milestones.length} personal milestones →
                                    </button>
                                )}
                            </div>
                        )}
                    </div>
                    
                    <div style={{marginTop: '30px'}}>
                        <h3 style={{color: '#f4c430', marginBottom: '15px'}}>Export Your Data</h3>
                        <button 
                            className="btn-primary" 
                            onClick={exportDataAsJSON} 
                            style={{marginBottom: '10px', display: 'block'}}
                        >
                            Export as JSON
                        </button>
                        <button 
                            className="btn-primary" 
                            onClick={exportDataAsPDF}
                            style={{display: 'block'}}
                        >
                            Export as PDF
                        </button>
                    </div>
                </div>
            )}
            
            {currentView === 'connect' && (
                <div className="section-content">
                    <h2 style={{color: 'white', marginBottom: '20px'}}>Community Connect</h2>
                    
                    <div className="chat-tabs">
                        <button 
                            className={`tab-btn ${activeChat === 'main' ? 'active' : ''}`}
                            onClick={() => setActiveChat('main')}
                        >
                            GLRS Community
                        </button>
                        <button 
                            className={`tab-btn ${activeChat === 'rooms' ? 'active' : ''}`}
                            onClick={() => setActiveChat('rooms')}
                        >
                            Topic Rooms
                        </button>
                        <button 
                            className={`tab-btn ${activeChat === 'groups' ? 'active' : ''}`}
                            onClick={() => setActiveChat('groups')}
                        >
                            Support Groups
                        </button>
                        <button 
                            className={`tab-btn ${activeChat === 'meetings' ? 'active' : ''}`}
                            onClick={() => setActiveChat('meetings')}
                        >
                            Meetings
                        </button>
                    </div>

                    {activeChat === 'main' && (
                        <CommunityChat 
                            messages={communityMessages}
                            onSendMessage={sendCommunityMessage}
                            currentUserId={user.uid}
                            uploadChatImage={uploadChatImage}  
                            flagContent={flagContent} 
                            setModalImage={setModalImage}
                        />
                    )}

                    {activeChat === 'rooms' && (
                        <>
                            <h3 style={{color: '#f4c430', marginBottom: '20px'}}>Recovery Topic Rooms</h3>
                            {topicRooms.length > 0 ? (
                                topicRooms.map(room => (
                                    <div 
                                        key={room.id} 
                                        className="room-card"
                                        onClick={() => enterTopicRoom(room)}
                                    >
                                        <div className="room-icon">
                                            {room.icon ? room.icon : <i data-lucide="message-circle" style={{width: '24px', height: '24px'}}></i>}
                                        </div>
                                        <h4>{room.name}</h4>
                                        <p style={{color: 'rgba(255,255,255,0.7)'}}>{room.description}</p>
                                    </div>
                                ))
                            ) : (
                                <div className="empty-state">
                                    <div className="empty-state-icon">
                                        <i data-lucide="message-square" style={{width: '48px', height: '48px', color: 'var(--color-text-secondary)'}}></i>
                                    </div>
                                    <div className="empty-state-text">No topic rooms available yet.</div>
                                </div>
                            )}
                        </>
                    )}

                    {activeChat === 'groups' && (
                        <>
                            <h3 style={{color: '#f4c430', marginBottom: '20px'}}>Support Groups</h3>
                            {supportGroups.length > 0 ? (
                                supportGroups.map(group => (
                                    <div key={group.id} className="support-group-card">
                                        <div className="group-header">
                                            <h4 style={{color: 'white'}}>{group.name}</h4>
                                            <span className={`badge ${
                                                group.type === 'AA' ? 'badge-primary' :
                                                group.type === 'NA' ? 'badge-warning' :
                                                group.type === 'SMART' ? 'badge-success' :
                                                'badge-secondary'
                                            }`}>
                                                {group.type}
                                            </span>
                                        </div>
                                        
                                        {group.description && (
                                            <p style={{color: 'rgba(255,255,255,0.7)', marginBottom: '10px'}}>
                                                {group.description}
                                            </p>
                                        )}
                                        
                                        <div style={{fontSize: '14px', opacity: 0.8}}>
                                            <div style={{display: 'flex', alignItems: 'center', gap: '6px'}}>
                                                <i data-lucide="calendar" style={{width: '14px', height: '14px'}}></i>
                                                {group.day}
                                            </div>
                                            <div style={{display: 'flex', alignItems: 'center', gap: '6px'}}>
                                                <i data-lucide="clock" style={{width: '14px', height: '14px'}}></i>
                                                {group.time}
                                            </div>
                                            {group.location && (
                                                <div style={{display: 'flex', alignItems: 'center', gap: '6px'}}>
                                                    <i data-lucide="map-pin" style={{width: '14px', height: '14px'}}></i>
                                                    {group.location}
                                                </div>
                                            )}
                                            {!group.location && group.link && (
                                                <div style={{display: 'flex', alignItems: 'center', gap: '6px'}}>
                                                    <i data-lucide="video" style={{width: '14px', height: '14px'}}></i>
                                                    Virtual Meeting
                                                </div>
                                            )}
                                        </div>
                                        
                                        {group.link && (
                                            <button 
                                                className="join-btn" 
                                                onClick={() => window.open(group.link, '_blank')}
                                                style={{marginTop: '10px'}}
                                            >
                                                Join Virtual Meeting
                                            </button>
                                        )}
                                    </div>
                                ))
                            ) : (
                                <div className="empty-state">
                                    <div className="empty-state-icon">
                                        <i data-lucide="users" style={{width: '48px', height: '48px', color: 'var(--color-primary)'}}></i>
                                    </div>
                                    <div className="empty-state-text">
                                        No support groups available yet.
                                    </div>
                                </div>
                            )}
                        </>
                    )}

                    {activeChat === 'meetings' && (
                        <>
                            <h3 style={{color: '#f4c430', marginBottom: '20px'}}>Scheduled Group Meetings</h3>
                            {meetings.length > 0 ? (
                                meetings.map(meeting => {
                                    const meetingDate = meeting.scheduledTime?.toDate ? 
                                        meeting.scheduledTime.toDate() : 
                                        new Date(meeting.scheduledTime);
                                    
                                    return (
                                        <div key={meeting.id} className="meeting-card">
                                            <div className="meeting-header">
                                                <h4>{meeting.meetingTitle || 'Group Recovery Session'}</h4>
                                                <span className={`status-badge ${
                                                    meeting.status === 'scheduled' ? 'scheduled' : 
                                                    meeting.status === 'completed' ? 'completed' : 'cancelled'
                                                }`}>
                                                    {meeting.status}
                                                </span>
                                            </div>
                                            
                                            <div className="meeting-type">{meeting.type || 'Group Session'}</div>
                                            
                                            <div className="meeting-details">
                                                <div style={{display: 'flex', alignItems: 'center', gap: '6px'}}>
                                                    <i data-lucide="calendar" style={{width: '14px', height: '14px'}}></i>
                                                    {meetingDate.toLocaleDateString()}
                                                </div>
                                                <div style={{display: 'flex', alignItems: 'center', gap: '6px'}}>
                                                    <i data-lucide="clock" style={{width: '14px', height: '14px'}}></i>
                                                    {meetingDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                                </div>
                                                <div style={{display: 'flex', alignItems: 'center', gap: '6px'}}>
                                                    <i data-lucide="timer" style={{width: '14px', height: '14px'}}></i>
                                                    Duration: {meeting.duration || '60'} minutes
                                                </div>

                                                {meeting.isGlobal && (
                                                    <div style={{display: 'flex', alignItems: 'center', gap: '6px'}}>
                                                        <i data-lucide="globe" style={{width: '14px', height: '14px'}}></i>
                                                        All PIRs Invited
                                                    </div>
                                                )}
                                            </div>

                                            {meeting.notes && (
                                                <div className="meeting-notes" style={{display: 'flex', alignItems: 'flex-start', gap: '6px'}}>
                                                    <i data-lucide="file-text" style={{width: '14px', height: '14px', marginTop: '2px'}}></i>
                                                    {meeting.notes}
                                                </div>
                                            )}
                                            
                                            {meeting.meetingLink && (
                                                <button 
                                                    className="join-btn" 
                                                    onClick={() => window.open(meeting.meetingLink, '_blank')}
                                                >
                                                    Join Virtual Meeting
                                                </button>
                                            )}
                                        </div>
                                    );
                                })
                            ) : (
                                <div className="empty-state">
                                    <div className="empty-state-icon">
                                        <i data-lucide="calendar" style={{width: '48px', height: '48px', color: 'var(--color-primary)'}}></i>
                                    </div>
                                    <div className="empty-state-text">No group meetings scheduled.</div>
                                </div>
                            )}
                        </>
                    )}
                    
                    <div className="crisis-resources">
                        <div className="crisis-title">
                            <i data-lucide="alert-octagon" style={{width: '20px', height: '20px', marginRight: '8px', color: '#DC143C'}}></i>
                            Crisis Resources
                        </div>
                        {emergencyResources.length > 0 ? (
                            emergencyResources.map(resource => (
                                <div key={resource.id} style={{marginBottom: '15px'}}>
                                    <div className="crisis-number">
                                        {resource.phone && (
                                            <a href={`tel:${resource.phone}`}>
                                                {resource.phone}
                                            </a>
                                        )}
                                    </div>
                                    <div className="crisis-description">{resource.title}</div>
                                    <small style={{opacity: 0.7}}>{resource.available || '24/7'}</small>
                                </div>
                            ))
                        ) : (
                            <>
                                <div style={{marginBottom: '15px'}}>
                                    <div className="crisis-number">
                                        <a href="tel:988">988</a>
                                    </div>
                                    <div className="crisis-description">Suicide & Crisis Lifeline</div>
                                </div>
                                <div>
                                    <div className="crisis-number">
                                        <a href="tel:1-800-662-4357">1-800-662-HELP</a>
                                    </div>
                                    <div className="crisis-description">SAMHSA National Helpline</div>
                                </div>
                            </>
                        )}
                        <button className="sos-btn" onClick={() => {
                            triggerHaptic('error');
                            triggerSOS();
                        }}>
                            <i data-lucide="alert-octagon" style={{width: '18px', height: '18px', marginRight: '8px'}}></i>
                            SOS - I Need Help Now
                        </button>
                    </div>
                </div>
            )}

           {currentView === 'notifications' && (
    <div className="body-section">
        <h2 style={{marginBottom: 'var(--space-4)', fontSize: '24px', fontWeight: 'bold', color: '#000'}}>
            Notifications
        </h2>
        {notifications.length === 0 ? (
            <div style={{
                textAlign: 'center',
                padding: 'var(--space-8)',
                color: '#999'
            }}>
                <i data-lucide="bell-off" style={{width: '48px', height: '48px', marginBottom: 'var(--space-4)'}}></i>
                <p>No notifications yet</p>
            </div>
        ) : (
            <div style={{display: 'flex', flexDirection: 'column', gap: 'var(--space-3)'}}>
                {notifications.slice().reverse().map(notification => (
                    <div key={notification.id} style={{
                        padding: 'var(--space-4)',
                        background: notification.read ? '#FFFFFF' : '#F0F8FF',
                        borderRadius: 'var(--radius-lg)',
                        border: '1px solid #E5E5E5',
                        boxShadow: '0 1px 3px rgba(0,0,0,0.05)'
                    }}>
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
                            <div style={{flex: 1}}>
                                <div style={{fontWeight: notification.read ? 'normal' : 'bold', marginBottom: '4px', color: '#000'}}>
                                    {notification.message}
                                </div>
                                <div style={{fontSize: '12px', color: '#999'}}>
                                    {notification.createdAt?.toDate ? new Date(notification.createdAt.toDate()).toLocaleString() : ''}
                                </div>
                            </div>
                            {!notification.read && (
                                <button onClick={() => markNotificationAsRead(notification.id)} style={{
                                    background: 'transparent',
                                    border: 'none',
                                    color: 'var(--color-primary)',
                                    cursor: 'pointer',
                                    fontSize: '12px'
                                }}>
                                    Mark Read
                                </button>
                            )}
                        </div>
                    </div>
                ))}
            </div>
        )}
    </div>
)}

            {currentView === 'guides' && (
                <ResourcesView
                    user={user}
                    userData={userData}
                    onBack={() => setCurrentView('home')}
                />
            )}
        </div>

        {/* Phase 2: Legal Footer */}
        <div style={{
            textAlign: 'center',
            padding: '20px',
            background: 'rgba(0,0,0,0.1)',
            borderTop: '1px solid rgba(255,255,255,0.1)',
            marginBottom: '70px'
        }}>
            <div style={{ fontSize: '12px', color: 'rgba(255,255,255,0.7)', marginBottom: '10px' }}>
                <a
                    href="#"
                    onClick={(e) => { e.preventDefault(); setShowTermsModal(true); }}
                    style={{ color: 'rgba(255,255,255,0.9)', textDecoration: 'none', margin: '0 10px' }}
                >
                    Terms of Service
                </a>
                <span>•</span>
                <a
                    href="#"
                    onClick={(e) => { e.preventDefault(); setShowPrivacyModal(true); }}
                    style={{ color: 'rgba(255,255,255,0.9)', textDecoration: 'none', margin: '0 10px' }}
                >
                    Privacy Policy
                </a>
                <span>•</span>
                <a
                    href="#"
                    onClick={(e) => { e.preventDefault(); setShowDataHandlingModal(true); }}
                    style={{ color: 'rgba(255,255,255,0.9)', textDecoration: 'none', margin: '0 10px' }}
                >
                    Data Handling
                </a>
            </div>
            <div style={{ fontSize: '11px', color: 'rgba(255,255,255,0.5)' }}>
                © 2025 Guiding Light Recovery Services. All rights reserved.
            </div>
        </div>

        {/* Phase 2: Floating Crisis Button */}
        <div style={{
            position: 'fixed',
            bottom: '90px',
            right: '20px',
            zIndex: 999
        }}>
            <button
                onClick={() => setShowCrisisModal(true)}
                style={{
                    background: '#DC143C',
                    color: '#fff',
                    width: '60px',
                    height: '60px',
                    borderRadius: '50%',
                    border: 'none',
                    fontSize: '28px',
                    cursor: 'pointer',
                    boxShadow: '0 4px 12px rgba(220, 20, 60, 0.4)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                }}
                title="Crisis Resources"
            >
                <i data-lucide="alert-octagon" style={{width: '32px', height: '32px'}}></i>
            </button>
        </div>

        <div className="bottom-nav">
            <div
                className={`nav-item ${currentView === 'tasks' ? 'active' : ''}`}
                onClick={() => {
                    triggerHaptic('light');
                    setCurrentView('tasks');
                }}
            >
                <i data-lucide="check-square" className="nav-icon"></i>
                <div className="nav-label">Tasks</div>
            </div>
            <div
                className={`nav-item ${currentView === 'progress' ? 'active' : ''}`}
                onClick={() => {
                    triggerHaptic('light');
                    setCurrentView('progress');
                }}
            >
                <i data-lucide="trending-up" className="nav-icon"></i>
                <div className="nav-label">Journey</div>
            </div>
            <div
                className={`nav-item ${currentView === 'home' ? 'active' : ''}`}
                onClick={() => {
                    triggerHaptic('light');
                    setCurrentView('home');
                }}
            >
                <i data-lucide="home" className="nav-icon"></i>
                <div className="nav-label">Home</div>
            </div>
            <div
                className={`nav-item ${currentView === 'connect' ? 'active' : ''}`}
                onClick={() => {
                    triggerHaptic('light');
                    setCurrentView('connect');
                }}
            >
                <i data-lucide="message-circle" className="nav-icon"></i>
                <div className="nav-label">Connect</div>
            </div>
            <div
                className={`nav-item ${currentView === 'guides' ? 'active' : ''}`}
                onClick={() => {
                    triggerHaptic('light');
                    setCurrentView('guides');
                }}
            >
                <i data-lucide="book-open" className="nav-icon"></i>
                <div className="nav-label">Guides</div>
            </div>
            <div
                className={`nav-item ${currentView === 'notifications' ? 'active' : ''}`}
                onClick={() => {
                    triggerHaptic('light');
                    setCurrentView('notifications');
                }}
            >
                <i data-lucide="bell" className="nav-icon"></i>
                <div className="nav-label">Notifications</div>
                {unreadCount > 0 && (
                    <span style={{
                        position: 'absolute',
                        top: '8px',
                        right: '50%',
                        marginRight: '-16px',
                        background: '#ff4757',
                        color: '#fff',
                        borderRadius: '50%',
                        width: '16px',
                        height: '16px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontSize: '10px',
                        fontWeight: 'bold'
                    }}>
                        {unreadCount > 9 ? '9+' : unreadCount}
                    </span>
                )}
            </div>
        </div>
        
       {showModal && (
    <ModalContainer 
        type={showModal}
        onClose={() => setShowModal(null)}
        data={{
            notifications,
            userData,
            user,
            resources,
            activeTopicRoom,
            topicRoomMessages,
            coachInfo,
            googleConnected,
            googleToken,
            googleTokenExpiry,
            syncingGoogle,
            connectGoogleCalendar,
            disconnectGoogleCalendar
        }}
        handlers={{
            markNotificationAsRead,
            markAllNotificationsAsRead,
            handleMorningCheckIn,
            handleEveningReflection,
            sendTopicMessage: async (message, image) => {
                if (activeTopicRoom) {
                    await sendTopicRoomMessage(activeTopicRoom.id, message, image);
                }
            },
            exportDataAsJSON,
            exportDataAsPDF
        }}
    />
)}

{modalImage && (
    <ImageModal
        imageUrl={modalImage}
        onClose={() => setModalImage(null)}
    />
)}

{/* Profile Modal */}
{showProfileModal && (
    <div className="profile-modal-overlay" onClick={() => setShowProfileModal(false)}>
        <div className="profile-modal" onClick={(e) => e.stopPropagation()}>
            <div className="profile-modal-header">
                <h3 style={{margin: 0, fontSize: '18px', fontWeight: '600'}}>Profile</h3>
                <button className="profile-modal-close" onClick={() => setShowProfileModal(false)}>
                    <i data-lucide="x" style={{width: '18px', height: '18px'}}></i>
                </button>
            </div>
            <div className="profile-modal-content">
                {/* Profile Content - Same as old Profile View */}
                <ProfileView
                    user={user}
                    userData={userData}
                    profileImage={profileImage}
                    sobrietyDays={sobrietyDays}
                    googleConnected={googleConnected}
                    onShowModal={setShowModal}
                    onLogout={handleLogout}
                />
            </div>
        </div>
    </div>
)}

{/* Phase 2: First-Launch Disclaimer Modal */}
{showDisclaimerModal && (
    <DisclaimerModal
        onAccept={() => {
            localStorage.setItem('disclaimerAccepted', 'true');
            localStorage.setItem('disclaimerAcceptedDate', new Date().toISOString());
            setShowDisclaimerModal(false);
        }}
    />
)}

{/* Phase 2: Legal Modals */}
{showTermsModal && (
    <LegalModal
        type="terms"
        onClose={() => setShowTermsModal(false)}
    />
)}

{showPrivacyModal && (
    <LegalModal
        type="privacy"
        onClose={() => setShowPrivacyModal(false)}
    />
)}

{showDataHandlingModal && (
    <LegalModal
        type="dataHandling"
        onClose={() => setShowDataHandlingModal(false)}
    />
)}

{/* Phase 2: Crisis Resources Modal */}
{showCrisisModal && (
    <CrisisModal
        onClose={() => setShowCrisisModal(false)}
    />
)}

{/* Tasks Tab Modals */}
{/* 1. Mood Pattern Modal */}
{showMoodPatternModal && (
    <div style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        background: 'rgba(0,0,0,0.7)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        zIndex: 10000,
        padding: '20px'
    }}
    onClick={() => setShowMoodPatternModal(false)}>
        <div style={{
            background: '#FFFFFF',
            borderRadius: '15px',
            maxWidth: '500px',
            width: '100%',
            maxHeight: '80vh',
            overflow: 'auto'
        }}
        onClick={(e) => e.stopPropagation()}>
            <div style={{
                padding: '20px',
                borderBottom: '1px solid #E5E5E5'
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <h3 style={{
                        margin: 0,
                        fontSize: '18px',
                        fontWeight: '400',
                        color: '#000000'
                    }}>
                        Mood Improvement Tips
                    </h3>
                    <button
                        onClick={() => setShowMoodPatternModal(false)}
                        style={{
                            background: 'none',
                            border: 'none',
                            cursor: 'pointer',
                            padding: '4px'
                        }}
                    >
                        <i data-lucide="x" style={{ width: '20px', height: '20px', color: '#666666' }}></i>
                    </button>
                </div>
            </div>

            <div style={{ padding: '20px' }}>
                <h4 style={{
                    fontSize: '16px',
                    fontWeight: '400',
                    color: '#000000',
                    marginBottom: '12px'
                }}>
                    Recommended Actions
                </h4>
                <div style={{ marginBottom: '20px' }}>
                    {[
                        'Practice 5 minutes of deep breathing when you wake up',
                        'Get 15-30 minutes of sunlight exposure daily',
                        'Maintain a consistent sleep schedule',
                        'Limit caffeine intake after 2pm',
                        'Exercise for at least 20 minutes per day',
                        'Connect with a friend or family member',
                        'Write down three things you are grateful for'
                    ].map((tip, index) => (
                        <div key={index} style={{
                            background: '#F5F5F5',
                            borderRadius: '8px',
                            padding: '12px',
                            marginBottom: '8px',
                            display: 'flex',
                            gap: '12px',
                            alignItems: 'flex-start'
                        }}>
                            <i data-lucide="check-circle" style={{ width: '20px', height: '20px', color: '#058585', flexShrink: 0, marginTop: '2px' }}></i>
                            <div style={{
                                fontSize: '14px',
                                fontWeight: '400',
                                color: '#000000',
                                lineHeight: '1.5'
                            }}>
                                {tip}
                            </div>
                        </div>
                    ))}
                </div>

                <button
                    onClick={() => {
                        triggerHaptic('light');
                        setShowMoodPatternModal(false);
                        setCurrentView('guides');
                    }}
                    style={{
                        width: '100%',
                        height: '48px',
                        background: '#058585',
                        border: 'none',
                        borderRadius: '8px',
                        color: '#FFFFFF',
                        fontSize: '14px',
                        fontWeight: '400',
                        cursor: 'pointer',
                        transition: 'all 0.2s'
                    }}
                >
                    View Related Resources
                </button>
            </div>
        </div>
    </div>
)}

{/* 2. Craving Pattern Modal */}
{showCravingPatternModal && (
    <div style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        background: 'rgba(0,0,0,0.7)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        zIndex: 10000,
        padding: '20px'
    }}
    onClick={() => setShowCravingPatternModal(false)}>
        <div style={{
            background: '#FFFFFF',
            borderRadius: '15px',
            maxWidth: '500px',
            width: '100%',
            maxHeight: '80vh',
            overflow: 'auto'
        }}
        onClick={(e) => e.stopPropagation()}>
            <div style={{
                padding: '20px',
                borderBottom: '1px solid #E5E5E5'
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <h3 style={{
                        margin: 0,
                        fontSize: '18px',
                        fontWeight: '400',
                        color: '#000000'
                    }}>
                        Craving Management Tips
                    </h3>
                    <button
                        onClick={() => setShowCravingPatternModal(false)}
                        style={{
                            background: 'none',
                            border: 'none',
                            cursor: 'pointer',
                            padding: '4px'
                        }}
                    >
                        <i data-lucide="x" style={{ width: '20px', height: '20px', color: '#666666' }}></i>
                    </button>
                </div>
            </div>

            <div style={{ padding: '20px' }}>
                <h4 style={{
                    fontSize: '16px',
                    fontWeight: '400',
                    color: '#000000',
                    marginBottom: '12px'
                }}>
                    Recommended Actions
                </h4>
                <div style={{ marginBottom: '20px' }}>
                    {[
                        'Use the 5-4-3-2-1 grounding technique when cravings hit',
                        'Call your sponsor or accountability partner immediately',
                        'Remove yourself from triggering environments',
                        'Engage in physical activity to redirect energy',
                        'Practice HALT: Check if you are Hungry, Angry, Lonely, or Tired',
                        'Keep a craving journal to identify patterns and triggers'
                    ].map((tip, index) => (
                        <div key={index} style={{
                            background: '#F5F5F5',
                            borderRadius: '8px',
                            padding: '12px',
                            marginBottom: '8px',
                            display: 'flex',
                            gap: '12px',
                            alignItems: 'flex-start'
                        }}>
                            <i data-lucide="check-circle" style={{ width: '20px', height: '20px', color: '#058585', flexShrink: 0, marginTop: '2px' }}></i>
                            <div style={{
                                fontSize: '14px',
                                fontWeight: '400',
                                color: '#000000',
                                lineHeight: '1.5'
                            }}>
                                {tip}
                            </div>
                        </div>
                    ))}
                </div>

                <button
                    onClick={() => {
                        triggerHaptic('light');
                        setShowCravingPatternModal(false);
                        setCurrentView('guides');
                    }}
                    style={{
                        width: '100%',
                        height: '48px',
                        background: '#058585',
                        border: 'none',
                        borderRadius: '8px',
                        color: '#FFFFFF',
                        fontSize: '14px',
                        fontWeight: '400',
                        cursor: 'pointer',
                        transition: 'all 0.2s'
                    }}
                >
                    View Related Resources
                </button>
            </div>
        </div>
    </div>
)}

{/* 3. Anxiety Pattern Modal */}
{showAnxietyPatternModal && (
    <div style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        background: 'rgba(0,0,0,0.7)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        zIndex: 10000,
        padding: '20px'
    }}
    onClick={() => setShowAnxietyPatternModal(false)}>
        <div style={{
            background: '#FFFFFF',
            borderRadius: '15px',
            maxWidth: '500px',
            width: '100%',
            maxHeight: '80vh',
            overflow: 'auto'
        }}
        onClick={(e) => e.stopPropagation()}>
            <div style={{
                padding: '20px',
                borderBottom: '1px solid #E5E5E5'
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <h3 style={{
                        margin: 0,
                        fontSize: '18px',
                        fontWeight: '400',
                        color: '#000000'
                    }}>
                        Anxiety Reduction Tips
                    </h3>
                    <button
                        onClick={() => setShowAnxietyPatternModal(false)}
                        style={{
                            background: 'none',
                            border: 'none',
                            cursor: 'pointer',
                            padding: '4px'
                        }}
                    >
                        <i data-lucide="x" style={{ width: '20px', height: '20px', color: '#666666' }}></i>
                    </button>
                </div>
            </div>

            <div style={{ padding: '20px' }}>
                <h4 style={{
                    fontSize: '16px',
                    fontWeight: '400',
                    color: '#000000',
                    marginBottom: '12px'
                }}>
                    Recommended Actions
                </h4>
                <div style={{ marginBottom: '20px' }}>
                    {[
                        'Practice box breathing: inhale 4 counts, hold 4, exhale 4, hold 4',
                        'Limit news and social media consumption',
                        'Establish a calming bedtime routine',
                        'Challenge anxious thoughts with evidence-based thinking',
                        'Engage in progressive muscle relaxation',
                        'Avoid excessive caffeine and sugar',
                        'Connect with nature through outdoor walks'
                    ].map((tip, index) => (
                        <div key={index} style={{
                            background: '#F5F5F5',
                            borderRadius: '8px',
                            padding: '12px',
                            marginBottom: '8px',
                            display: 'flex',
                            gap: '12px',
                            alignItems: 'flex-start'
                        }}>
                            <i data-lucide="check-circle" style={{ width: '20px', height: '20px', color: '#058585', flexShrink: 0, marginTop: '2px' }}></i>
                            <div style={{
                                fontSize: '14px',
                                fontWeight: '400',
                                color: '#000000',
                                lineHeight: '1.5'
                            }}>
                                {tip}
                            </div>
                        </div>
                    ))}
                </div>

                <button
                    onClick={() => {
                        triggerHaptic('light');
                        setShowAnxietyPatternModal(false);
                        setCurrentView('guides');
                    }}
                    style={{
                        width: '100%',
                        height: '48px',
                        background: '#058585',
                        border: 'none',
                        borderRadius: '8px',
                        color: '#FFFFFF',
                        fontSize: '14px',
                        fontWeight: '400',
                        cursor: 'pointer',
                        transition: 'all 0.2s'
                    }}
                >
                    View Related Resources
                </button>
            </div>
        </div>
    </div>
)}

{/* 4. Sleep Pattern Modal */}
{showSleepPatternModal && (
    <div style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        background: 'rgba(0,0,0,0.7)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        zIndex: 10000,
        padding: '20px'
    }}
    onClick={() => setShowSleepPatternModal(false)}>
        <div style={{
            background: '#FFFFFF',
            borderRadius: '15px',
            maxWidth: '500px',
            width: '100%',
            maxHeight: '80vh',
            overflow: 'auto'
        }}
        onClick={(e) => e.stopPropagation()}>
            <div style={{
                padding: '20px',
                borderBottom: '1px solid #E5E5E5'
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <h3 style={{
                        margin: 0,
                        fontSize: '18px',
                        fontWeight: '400',
                        color: '#000000'
                    }}>
                        Sleep Quality Tips
                    </h3>
                    <button
                        onClick={() => setShowSleepPatternModal(false)}
                        style={{
                            background: 'none',
                            border: 'none',
                            cursor: 'pointer',
                            padding: '4px'
                        }}
                    >
                        <i data-lucide="x" style={{ width: '20px', height: '20px', color: '#666666' }}></i>
                    </button>
                </div>
            </div>

            <div style={{ padding: '20px' }}>
                <h4 style={{
                    fontSize: '16px',
                    fontWeight: '400',
                    color: '#000000',
                    marginBottom: '12px'
                }}>
                    Recommended Actions
                </h4>
                <div style={{ marginBottom: '20px' }}>
                    {[
                        'Maintain a consistent sleep schedule, even on weekends',
                        'Avoid screens 1 hour before bedtime',
                        'Keep your bedroom cool, dark, and quiet',
                        'Avoid large meals and alcohol before bed',
                        'Create a relaxing bedtime routine',
                        'Exercise regularly, but not within 3 hours of bedtime',
                        'Consider melatonin or magnesium supplements after consulting your doctor'
                    ].map((tip, index) => (
                        <div key={index} style={{
                            background: '#F5F5F5',
                            borderRadius: '8px',
                            padding: '12px',
                            marginBottom: '8px',
                            display: 'flex',
                            gap: '12px',
                            alignItems: 'flex-start'
                        }}>
                            <i data-lucide="check-circle" style={{ width: '20px', height: '20px', color: '#058585', flexShrink: 0, marginTop: '2px' }}></i>
                            <div style={{
                                fontSize: '14px',
                                fontWeight: '400',
                                color: '#000000',
                                lineHeight: '1.5'
                            }}>
                                {tip}
                            </div>
                        </div>
                    ))}
                </div>

                <button
                    onClick={() => {
                        triggerHaptic('light');
                        setShowSleepPatternModal(false);
                        setCurrentView('guides');
                    }}
                    style={{
                        width: '100%',
                        height: '48px',
                        background: '#058585',
                        border: 'none',
                        borderRadius: '8px',
                        color: '#FFFFFF',
                        fontSize: '14px',
                        fontWeight: '400',
                        cursor: 'pointer',
                        transition: 'all 0.2s'
                    }}
                >
                    View Related Resources
                </button>
            </div>
        </div>
    </div>
)}

{/* 5. Generic Tips Modal (Fallback) */}
{showTipsModal && patternDetection && (
    <div style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        background: 'rgba(0,0,0,0.7)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        zIndex: 10000,
        padding: '20px'
    }}
    onClick={() => setShowTipsModal(false)}>
        <div style={{
            background: '#FFFFFF',
            borderRadius: '15px',
            maxWidth: '500px',
            width: '100%',
            maxHeight: '80vh',
            overflow: 'auto'
        }}
        onClick={(e) => e.stopPropagation()}>
            {/* Header */}
            <div style={{
                padding: '20px',
                borderBottom: '1px solid #E5E5E5'
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <h3 style={{
                        margin: 0,
                        fontSize: '18px',
                        fontWeight: '400',
                        color: '#000000'
                    }}>
                        Pattern Insights
                    </h3>
                    <button
                        onClick={() => setShowTipsModal(false)}
                        style={{
                            background: 'none',
                            border: 'none',
                            cursor: 'pointer',
                            padding: '4px'
                        }}
                    >
                        <i data-lucide="x" style={{ width: '20px', height: '20px', color: '#666666' }}></i>
                    </button>
                </div>
            </div>

            {/* Content */}
            <div style={{ padding: '20px' }}>
                {/* Pattern Message */}
                <div style={{
                    background: '#FFF8E1',
                    borderRadius: '12px',
                    padding: '16px',
                    marginBottom: '20px',
                    border: '1px solid #FFD54F'
                }}>
                    <div style={{
                        fontSize: '16px',
                        fontWeight: '400',
                        color: '#000000',
                        marginBottom: '8px'
                    }}>
                        {patternDetection.message}
                    </div>
                    {patternDetection.day && (
                        <div style={{
                            fontSize: '14px',
                            fontWeight: '400',
                            color: '#666666'
                        }}>
                            Day: {patternDetection.day} | Value: {patternDetection.value}
                        </div>
                    )}
                </div>

                {/* Tips List */}
                <h4 style={{
                    fontSize: '16px',
                    fontWeight: '400',
                    color: '#000000',
                    marginBottom: '12px'
                }}>
                    Recommended Actions
                </h4>
                <div style={{ marginBottom: '20px' }}>
                    {patternDetection.tips.map((tip, index) => (
                        <div key={index} style={{
                            background: '#F5F5F5',
                            borderRadius: '8px',
                            padding: '12px',
                            marginBottom: '8px',
                            display: 'flex',
                            gap: '12px'
                        }}>
                            <div style={{
                                width: '24px',
                                height: '24px',
                                borderRadius: '50%',
                                background: '#058585',
                                color: '#FFFFFF',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '12px',
                                fontWeight: 'bold',
                                flexShrink: 0
                            }}>
                                {index + 1}
                            </div>
                            <div style={{
                                fontSize: '14px',
                                fontWeight: '400',
                                color: '#000000',
                                lineHeight: '1.5'
                            }}>
                                {tip}
                            </div>
                        </div>
                    ))}
                </div>

                {/* Action Button */}
                <button
                    onClick={() => {
                        triggerHaptic('light');
                        setShowTipsModal(false);
                        setCurrentView('guides');
                    }}
                    style={{
                        width: '100%',
                        height: '48px',
                        background: '#058585',
                        border: 'none',
                        borderRadius: '8px',
                        color: '#FFFFFF',
                        fontSize: '14px',
                        fontWeight: '400',
                        cursor: 'pointer',
                        transition: 'all 0.2s'
                    }}
                >
                    View Related Guides
                </button>
            </div>
        </div>
    </div>
)}

{/* 6. Coping Technique Modal */}
{showCopingTechniqueModal && (() => {
    const dayOfMonth = new Date().getDate();
    const technique = copingTechniques.find(t => t.day === dayOfMonth) || copingTechniques[0];

    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0,0,0,0.7)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 10000,
            padding: '20px'
        }}
        onClick={() => setShowCopingTechniqueModal(false)}>
            <div style={{
                background: '#FFFFFF',
                borderRadius: '15px',
                maxWidth: '500px',
                width: '100%',
                maxHeight: '80vh',
                overflow: 'auto'
            }}
            onClick={(e) => e.stopPropagation()}>
                {/* Header */}
                <div style={{
                    padding: '20px',
                    borderBottom: '1px solid #E5E5E5'
                }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                            <i data-lucide={technique.icon} style={{ width: '24px', height: '24px', color: '#058585' }}></i>
                            <div>
                                <h3 style={{
                                    margin: 0,
                                    fontSize: '18px',
                                    fontWeight: '400',
                                    color: '#000000'
                                }}>
                                    {technique.title}
                                </h3>
                                <div style={{
                                    fontSize: '12px',
                                    fontWeight: '400',
                                    color: '#666666',
                                    marginTop: '4px'
                                }}>
                                    {technique.category} • Day {technique.day}
                                </div>
                            </div>
                        </div>
                        <button
                            onClick={() => setShowCopingTechniqueModal(false)}
                            style={{
                                background: 'none',
                                border: 'none',
                                cursor: 'pointer',
                                padding: '4px'
                            }}
                        >
                            <i data-lucide="x" style={{ width: '20px', height: '20px', color: '#666666' }}></i>
                        </button>
                    </div>
                </div>

                {/* Content */}
                <div style={{ padding: '20px' }}>
                    {/* Large Icon Display */}
                    <div style={{
                        textAlign: 'center',
                        padding: '20px',
                        marginBottom: '20px',
                        background: technique.category === 'Breathing' ? 'linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%)' :
                                    technique.category === 'Mindfulness' ? 'linear-gradient(135deg, #F3E5F5 0%, #E1BEE7 100%)' :
                                    technique.category === 'Physical' ? 'linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%)' :
                                    technique.category === 'Cognitive' ? 'linear-gradient(135deg, #FFF9C4 0%, #FFF59D 100%)' :
                                    'linear-gradient(135deg, #FFE0B2 0%, #FFCC80 100%)',
                        borderRadius: '12px'
                    }}>
                        <i data-lucide={technique.icon} style={{
                            width: '64px',
                            height: '64px',
                            color: technique.category === 'Breathing' ? '#1976D2' :
                                   technique.category === 'Mindfulness' ? '#7B1FA2' :
                                   technique.category === 'Physical' ? '#388E3C' :
                                   technique.category === 'Cognitive' ? '#F57F17' :
                                   '#E64A19',
                            marginBottom: '12px'
                        }}></i>
                        <div style={{
                            fontSize: '12px',
                            fontWeight: 'bold',
                            color: '#666666',
                            textTransform: 'uppercase',
                            letterSpacing: '1px'
                        }}>
                            {technique.category} Technique
                        </div>
                    </div>

                    <h4 style={{
                        fontSize: '16px',
                        fontWeight: 'bold',
                        color: '#000000',
                        marginBottom: '12px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                    }}>
                        <i data-lucide="list-checks" style={{ width: '20px', height: '20px', color: '#058585' }}></i>
                        How to Practice
                    </h4>

                    {/* Description with proper line breaks and enhanced styling */}
                    <div style={{
                        background: '#F5F5F5',
                        borderRadius: '12px',
                        padding: '16px',
                        marginBottom: '16px',
                        border: '1px solid #E0E0E0'
                    }}>
                        {technique.description.split('\n').map((line, index) => {
                            const isNumbered = /^\d+\./.test(line.trim());
                            const isBold = line.includes('Optimizes') || line.includes('Reduces') || line.includes('Improves');

                            return (
                                <div key={index} style={{
                                    fontSize: '14px',
                                    fontWeight: isBold ? 'bold' : '400',
                                    color: isBold ? '#058585' : '#000000',
                                    lineHeight: '1.6',
                                    marginBottom: line.trim() === '' ? '12px' : '6px',
                                    paddingLeft: isNumbered ? '0' : '0',
                                    display: 'flex',
                                    alignItems: 'flex-start',
                                    gap: '8px'
                                }}>
                                    {isNumbered && <span style={{ color: '#058585', fontWeight: 'bold', minWidth: '20px' }}>{line.match(/^\d+\./)?.[0]}</span>}
                                    <span>{isNumbered ? line.replace(/^\d+\.\s*/, '') : (line.trim() || '\u00A0')}</span>
                                </div>
                            );
                        })}
                    </div>

                    {/* Benefits Badge */}
                    <div style={{
                        padding: '12px',
                        background: 'linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%)',
                        borderRadius: '8px',
                        marginBottom: '20px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '10px'
                    }}>
                        <i data-lucide="heart-pulse" style={{ width: '20px', height: '20px', color: '#2E7D32' }}></i>
                        <div style={{
                            fontSize: '12px',
                            fontWeight: 'bold',
                            color: '#2E7D32'
                        }}>
                            Evidence-Based Technique
                        </div>
                    </div>

                    {/* Close Button */}
                    <button
                        onClick={() => {
                            triggerHaptic('light');
                            setShowCopingTechniqueModal(false);
                        }}
                        style={{
                            width: '100%',
                            height: '48px',
                            background: '#058585',
                            border: 'none',
                            borderRadius: '8px',
                            color: '#FFFFFF',
                            fontSize: '14px',
                            fontWeight: '400',
                            cursor: 'pointer',
                            transition: 'all 0.2s'
                        }}
                    >
                        Got It
                    </button>
                </div>
            </div>
        </div>
    );
})()}

{/* 7. Milestone Modal */}
{showMilestoneModal && (
    <div style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        background: 'rgba(0,0,0,0.7)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        zIndex: 10000,
        padding: '20px'
    }}
    onClick={() => setShowMilestoneModal(false)}>
        <div style={{
            background: '#FFFFFF',
            borderRadius: '15px',
            maxWidth: '500px',
            width: '100%',
            maxHeight: '80vh',
            overflow: 'auto'
        }}
        onClick={(e) => e.stopPropagation()}>
            {/* Header */}
            <div style={{
                padding: '20px',
                borderBottom: '1px solid #E5E5E5'
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                        <i data-lucide="trophy" style={{ width: '24px', height: '24px', color: '#058585' }}></i>
                        <h3 style={{
                            margin: 0,
                            fontSize: '18px',
                            fontWeight: '400',
                            color: '#000000'
                        }}>
                            Recovery Milestones
                        </h3>
                    </div>
                    <button
                        onClick={() => setShowMilestoneModal(false)}
                        style={{
                            background: 'none',
                            border: 'none',
                            cursor: 'pointer',
                            padding: '4px'
                        }}
                    >
                        <i data-lucide="x" style={{ width: '20px', height: '20px', color: '#666666' }}></i>
                    </button>
                </div>
            </div>

            {/* Content */}
            <div style={{ padding: '20px' }}>
                {nextMilestone && (
                    <>
                        {/* Progress Card */}
                        <div style={{
                            background: 'linear-gradient(135deg, #058585 0%, #047373 100%)',
                            borderRadius: '12px',
                            padding: '16px',
                            marginBottom: '20px',
                            color: '#FFFFFF'
                        }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px' }}>
                                <i data-lucide={nextMilestone.icon} style={{ width: '32px', height: '32px' }}></i>
                                <div>
                                    <div style={{ fontSize: '16px', fontWeight: 'bold' }}>
                                        {nextMilestone.achieved ?
                                            'All Milestones Complete!' :
                                            `Next: ${nextMilestone.label}`
                                        }
                                    </div>
                                    <div style={{ fontSize: '14px', opacity: 0.9 }}>
                                        {nextMilestone.achieved ?
                                            `${nextMilestone.daysSober} days sober` :
                                            `${nextMilestone.daysUntil} ${nextMilestone.daysUntil === 1 ? 'day' : 'days'} to go`
                                        }
                                    </div>
                                </div>
                            </div>
                            {!nextMilestone.achieved && (
                                <>
                                    {/* Progress Bar */}
                                    <div style={{
                                        background: 'rgba(255,255,255,0.3)',
                                        borderRadius: '10px',
                                        height: '8px',
                                        overflow: 'hidden',
                                        marginBottom: '8px'
                                    }}>
                                        <div style={{
                                            background: '#FFFFFF',
                                            height: '100%',
                                            width: `${nextMilestone.progressPercentage}%`,
                                            transition: 'width 0.3s ease'
                                        }}></div>
                                    </div>
                                    <div style={{ fontSize: '12px', textAlign: 'right', opacity: 0.9 }}>
                                        {nextMilestone.progressPercentage}% complete
                                    </div>
                                </>
                            )}
                        </div>

                        {/* All Milestones List */}
                        <h4 style={{
                            fontSize: '16px',
                            fontWeight: '400',
                            color: '#000000',
                            marginBottom: '12px'
                        }}>
                            All Milestones
                        </h4>
                        <div style={{ marginBottom: '20px' }}>
                            {allMilestones.map((milestone, index) => (
                                <div key={index} style={{
                                    background: milestone.achieved ? '#E8F5E9' : '#F5F5F5',
                                    borderRadius: '12px',
                                    padding: '12px',
                                    marginBottom: '8px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '12px',
                                    border: milestone.achieved ? '1px solid #4CAF50' : '1px solid #E0E0E0'
                                }}>
                                    <div style={{
                                        width: '40px',
                                        height: '40px',
                                        borderRadius: '50%',
                                        background: milestone.achieved ?
                                            'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)' :
                                            '#E0E0E0',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        flexShrink: 0
                                    }}>
                                        <i data-lucide={milestone.achieved ? 'check' : milestone.icon}
                                           style={{
                                               width: '20px',
                                               height: '20px',
                                               color: milestone.achieved ? '#FFFFFF' : '#999999'
                                           }}></i>
                                    </div>
                                    <div style={{ flex: 1 }}>
                                        <div style={{
                                            fontSize: '14px',
                                            fontWeight: '400',
                                            color: '#000000',
                                            marginBottom: '2px'
                                        }}>
                                            {milestone.label} ({milestone.days} days)
                                        </div>
                                        <div style={{
                                            fontSize: '12px',
                                            fontWeight: '400',
                                            color: '#666666'
                                        }}>
                                            {milestone.achieved ?
                                                `Achieved on ${milestone.dateString}` :
                                                `Target: ${milestone.dateString}`
                                            }
                                        </div>
                                    </div>
                                    {milestone.achieved && (
                                        <div style={{
                                            fontSize: '20px'
                                        }}>
                                            🎉
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>

                        {/* Close Button */}
                        <button
                            onClick={() => {
                                triggerHaptic('light');
                                setShowMilestoneModal(false);
                            }}
                            style={{
                                width: '100%',
                                height: '48px',
                                background: '#058585',
                                border: 'none',
                                borderRadius: '8px',
                                color: '#FFFFFF',
                                fontSize: '14px',
                                fontWeight: '400',
                                cursor: 'pointer',
                                transition: 'all 0.2s'
                            }}
                        >
                            Close
                        </button>
                    </>
                )}
            </div>
        </div>
    </div>
)}

{/* 8. Past Reflections Modal */}
{showPastReflectionsModal && (() => {
    // Filter reflections based on selected filter
    const getFilteredReflections = () => {
        if (reflectionFilter === 'all') {
            return reflectionData;
        } else if (reflectionFilter === 'week') {
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            return reflectionData.filter(r => {
                const reflectionDate = r.createdAt?.toDate ? r.createdAt.toDate() : new Date(r.createdAt);
                return reflectionDate >= weekAgo;
            });
        } else if (reflectionFilter === 'month') {
            const monthAgo = new Date();
            monthAgo.setDate(monthAgo.getDate() - 30);
            return reflectionData.filter(r => {
                const reflectionDate = r.createdAt?.toDate ? r.createdAt.toDate() : new Date(r.createdAt);
                return reflectionDate >= monthAgo;
            });
        }
        return reflectionData;
    };

    const filteredReflections = getFilteredReflections();

    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0,0,0,0.7)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 10000,
            padding: '20px'
        }}
        onClick={() => {
            setShowPastReflectionsModal(false);
            setSelectedReflection(null);
        }}>
            <div style={{
                background: '#FFFFFF',
                borderRadius: '15px',
                maxWidth: '600px',
                width: '100%',
                maxHeight: '85vh',
                overflow: 'auto',
                display: 'flex',
                flexDirection: 'column'
            }}
            onClick={(e) => e.stopPropagation()}>
                {/* Header */}
                <div style={{
                    padding: '20px',
                    borderBottom: '1px solid #E5E5E5',
                    position: 'sticky',
                    top: 0,
                    background: '#FFFFFF',
                    zIndex: 1
                }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                            <i data-lucide="book-open" style={{ width: '24px', height: '24px', color: '#058585' }}></i>
                            <h3 style={{
                                margin: 0,
                                fontSize: '18px',
                                fontWeight: '400',
                                color: '#000000'
                            }}>
                                Past Reflections
                            </h3>
                        </div>
                        <button
                            onClick={() => {
                                setShowPastReflectionsModal(false);
                                setSelectedReflection(null);
                            }}
                            style={{
                                background: 'none',
                                border: 'none',
                                cursor: 'pointer',
                                padding: '4px'
                            }}
                        >
                            <i data-lucide="x" style={{ width: '20px', height: '20px', color: '#666666' }}></i>
                        </button>
                    </div>

                    {/* Filter Tabs */}
                    <div style={{
                        display: 'flex',
                        gap: '8px',
                        marginTop: '16px'
                    }}>
                        {['all', 'week', 'month'].map(filter => (
                            <button
                                key={filter}
                                onClick={() => {
                                    triggerHaptic('light');
                                    setReflectionFilter(filter);
                                    setSelectedReflection(null);
                                }}
                                style={{
                                    flex: 1,
                                    padding: '8px 12px',
                                    background: reflectionFilter === filter ? '#058585' : '#F5F5F5',
                                    color: reflectionFilter === filter ? '#FFFFFF' : '#666666',
                                    border: 'none',
                                    borderRadius: '8px',
                                    fontSize: '13px',
                                    fontWeight: '400',
                                    cursor: 'pointer',
                                    transition: 'all 0.2s'
                                }}
                            >
                                {filter === 'all' ? 'All Time' : filter === 'week' ? 'This Week' : 'This Month'}
                            </button>
                        ))}
                    </div>
                </div>

                {/* Content */}
                <div style={{ padding: '20px', flex: 1, overflow: 'auto' }}>
                    {filteredReflections.length === 0 ? (
                        <div style={{
                            textAlign: 'center',
                            padding: '40px 20px',
                            color: '#999999'
                        }}>
                            <i data-lucide="book-open" style={{ width: '48px', height: '48px', color: '#E0E0E0', marginBottom: '12px' }}></i>
                            <div style={{ fontSize: '14px', fontWeight: '400' }}>
                                No reflections found
                            </div>
                        </div>
                    ) : (
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                            {filteredReflections.map((reflection, index) => {
                                const reflectionDate = reflection.createdAt?.toDate ?
                                    reflection.createdAt.toDate() : new Date(reflection.createdAt);
                                const isExpanded = selectedReflection?.id === reflection.id;

                                return (
                                    <div key={reflection.id || index} style={{
                                        background: '#F8F9FA',
                                        borderRadius: '12px',
                                        padding: '16px',
                                        border: isExpanded ? '2px solid #058585' : '1px solid #E5E5E5',
                                        cursor: 'pointer',
                                        transition: 'all 0.2s'
                                    }}
                                    onClick={() => {
                                        triggerHaptic('light');
                                        setSelectedReflection(isExpanded ? null : reflection);
                                    }}>
                                        {/* Header */}
                                        <div style={{
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            alignItems: 'center',
                                            marginBottom: isExpanded ? '16px' : '0'
                                        }}>
                                            <div>
                                                <div style={{
                                                    fontSize: '14px',
                                                    fontWeight: 'bold',
                                                    color: '#000000',
                                                    marginBottom: '4px'
                                                }}>
                                                    {reflectionDate.toLocaleDateString('en-US', {
                                                        weekday: 'short',
                                                        month: 'short',
                                                        day: 'numeric',
                                                        year: 'numeric'
                                                    })}
                                                </div>
                                                {reflection.overallDay && (
                                                    <div style={{
                                                        fontSize: '12px',
                                                        fontWeight: '400',
                                                        color: '#666666'
                                                    }}>
                                                        Daily Score: {reflection.overallDay}/10
                                                    </div>
                                                )}
                                            </div>
                                            <i data-lucide={isExpanded ? 'chevron-up' : 'chevron-down'}
                                               style={{ width: '20px', height: '20px', color: '#666666' }}></i>
                                        </div>

                                        {/* Expanded Content */}
                                        {isExpanded && (
                                            <div style={{
                                                display: 'flex',
                                                flexDirection: 'column',
                                                gap: '12px'
                                            }}>
                                                {/* Prompt Response */}
                                                {reflection.promptResponse && (
                                                    <div>
                                                        <div style={{
                                                            fontSize: '13px',
                                                            fontWeight: 'bold',
                                                            color: '#058585',
                                                            marginBottom: '6px'
                                                        }}>
                                                            Prompt Response
                                                        </div>
                                                        <div style={{
                                                            fontSize: '13px',
                                                            fontWeight: '400',
                                                            color: '#000000',
                                                            lineHeight: '1.5',
                                                            background: '#FFFFFF',
                                                            padding: '10px',
                                                            borderRadius: '8px'
                                                        }}>
                                                            {reflection.promptResponse}
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Challenges */}
                                                {reflection.challenges && (
                                                    <div>
                                                        <div style={{
                                                            fontSize: '13px',
                                                            fontWeight: 'bold',
                                                            color: '#058585',
                                                            marginBottom: '6px'
                                                        }}>
                                                            Challenges
                                                        </div>
                                                        <div style={{
                                                            fontSize: '13px',
                                                            fontWeight: '400',
                                                            color: '#000000',
                                                            lineHeight: '1.5',
                                                            background: '#FFFFFF',
                                                            padding: '10px',
                                                            borderRadius: '8px'
                                                        }}>
                                                            {reflection.challenges}
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Gratitude */}
                                                {reflection.gratitude && (
                                                    <div>
                                                        <div style={{
                                                            fontSize: '13px',
                                                            fontWeight: 'bold',
                                                            color: '#058585',
                                                            marginBottom: '6px'
                                                        }}>
                                                            Gratitude
                                                        </div>
                                                        <div style={{
                                                            fontSize: '13px',
                                                            fontWeight: '400',
                                                            color: '#000000',
                                                            lineHeight: '1.5',
                                                            background: '#FFFFFF',
                                                            padding: '10px',
                                                            borderRadius: '8px'
                                                        }}>
                                                            {reflection.gratitude}
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Tomorrow's Goal */}
                                                {reflection.tomorrowGoal && (
                                                    <div>
                                                        <div style={{
                                                            fontSize: '13px',
                                                            fontWeight: 'bold',
                                                            color: '#058585',
                                                            marginBottom: '6px'
                                                        }}>
                                                            Tomorrow's Goal
                                                        </div>
                                                        <div style={{
                                                            fontSize: '13px',
                                                            fontWeight: '400',
                                                            color: '#000000',
                                                            lineHeight: '1.5',
                                                            background: '#FFFFFF',
                                                            padding: '10px',
                                                            borderRadius: '8px'
                                                        }}>
                                                            {reflection.tomorrowGoal}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
})()}

{/* 9. Quick Gratitude Modal */}
{showGratitudeModal && (
    <div style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        background: 'rgba(0,0,0,0.7)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        zIndex: 10000,
        padding: '20px'
    }}
    onClick={() => {
        setShowGratitudeModal(false);
        setGratitudeTheme('');
        setGratitudeText('');
    }}>
        <div style={{
            background: '#FFFFFF',
            borderRadius: '15px',
            maxWidth: '500px',
            width: '100%',
            maxHeight: '85vh',
            overflow: 'auto'
        }}
        onClick={(e) => e.stopPropagation()}>
            {/* Header */}
            <div style={{
                padding: '20px',
                borderBottom: '1px solid #E5E5E5'
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                        <i data-lucide="heart" style={{ width: '24px', height: '24px', color: '#058585' }}></i>
                        <h3 style={{
                            margin: 0,
                            fontSize: '18px',
                            fontWeight: '400',
                            color: '#000000'
                        }}>
                            Gratitude Entry
                        </h3>
                    </div>
                    <button
                        onClick={() => {
                            setShowGratitudeModal(false);
                            setGratitudeTheme('');
                            setGratitudeText('');
                        }}
                        style={{
                            background: 'none',
                            border: 'none',
                            cursor: 'pointer',
                            padding: '4px'
                        }}
                    >
                        <i data-lucide="x" style={{ width: '20px', height: '20px', color: '#666666' }}></i>
                    </button>
                </div>
            </div>

            {/* Content */}
            <div style={{ padding: '20px' }}>
                {/* Theme Selection */}
                <div style={{ marginBottom: '20px' }}>
                    <h4 style={{
                        fontSize: '14px',
                        fontWeight: 'bold',
                        color: '#000000',
                        marginBottom: '12px'
                    }}>
                        Select a Theme
                    </h4>
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(auto-fill, minmax(140px, 1fr))',
                        gap: '8px'
                    }}>
                        {gratitudeThemes.map(theme => (
                            <button
                                key={theme.id}
                                onClick={() => {
                                    triggerHaptic('light');
                                    setGratitudeTheme(theme.id);
                                }}
                                style={{
                                    padding: '12px',
                                    background: gratitudeTheme === theme.id ? theme.color : '#F5F5F5',
                                    color: gratitudeTheme === theme.id ? '#FFFFFF' : '#000000',
                                    border: 'none',
                                    borderRadius: '8px',
                                    fontSize: '12px',
                                    fontWeight: '400',
                                    cursor: 'pointer',
                                    transition: 'all 0.2s',
                                    display: 'flex',
                                    flexDirection: 'column',
                                    alignItems: 'center',
                                    gap: '6px'
                                }}
                            >
                                <i data-lucide={theme.icon}
                                   style={{
                                       width: '20px',
                                       height: '20px',
                                       color: gratitudeTheme === theme.id ? '#FFFFFF' : theme.color
                                   }}></i>
                                <div style={{ textAlign: 'center', lineHeight: '1.2' }}>
                                    {theme.label}
                                </div>
                            </button>
                        ))}
                    </div>
                </div>

                {/* Gratitude Text */}
                <div style={{ marginBottom: '20px' }}>
                    <h4 style={{
                        fontSize: '14px',
                        fontWeight: 'bold',
                        color: '#000000',
                        marginBottom: '8px'
                    }}>
                        What are you grateful for?
                    </h4>
                    <textarea
                        value={gratitudeText}
                        onChange={(e) => setGratitudeText(e.target.value)}
                        placeholder="Express your gratitude..."
                        style={{
                            width: '100%',
                            minHeight: '100px',
                            padding: '12px',
                            border: '1px solid #E5E5E5',
                            borderRadius: '8px',
                            fontSize: '14px',
                            fontWeight: '400',
                            color: '#000000',
                            fontFamily: 'inherit',
                            resize: 'vertical'
                        }}
                    />
                </div>

                {/* Save Button */}
                <button
                    onClick={() => {
                        triggerHaptic('medium');
                        saveGratitude();
                    }}
                    style={{
                        width: '100%',
                        height: '48px',
                        background: '#058585',
                        border: 'none',
                        borderRadius: '8px',
                        color: '#FFFFFF',
                        fontSize: '14px',
                        fontWeight: '400',
                        cursor: 'pointer',
                        transition: 'all 0.2s'
                    }}
                >
                    Save Gratitude
                </button>
            </div>
        </div>
    </div>
)}

{/* Weekly Progress Report Modal */}
{showWeeklyReportModal && (() => {
    // Calculate week-specific stats
    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 7);
    weekAgo.setHours(0, 0, 0, 0);

    // Check-in stats for the week
    const thisWeekCheckIns = checkInData.filter(c => {
        const checkInDate = c.createdAt?.toDate ? c.createdAt.toDate() : new Date(c.createdAt);
        return checkInDate >= weekAgo;
    });

    const weekCheckInCount = thisWeekCheckIns.length;
    const weekCheckInRate = Math.round((weekCheckInCount / 7) * 100);

    const weekMoodScores = thisWeekCheckIns
        .filter(c => c.morningData?.mood !== undefined || c.eveningData?.mood !== undefined)
        .map(c => c.morningData?.mood ?? c.eveningData?.mood);
    const weekAvgMood = weekMoodScores.length > 0
        ? (weekMoodScores.reduce((a, b) => a + b, 0) / weekMoodScores.length).toFixed(1)
        : 'N/A';

    const weekCravingsScores = thisWeekCheckIns
        .filter(c => c.morningData?.craving !== undefined || c.eveningData?.craving !== undefined)
        .map(c => c.morningData?.craving ?? c.eveningData?.craving);
    const weekAvgCravings = weekCravingsScores.length > 0
        ? (weekCravingsScores.reduce((a, b) => a + b, 0) / weekCravingsScores.length).toFixed(1)
        : 'N/A';

    const weekAnxietyScores = thisWeekCheckIns
        .filter(c => c.morningData?.anxiety !== undefined || c.eveningData?.anxiety !== undefined)
        .map(c => c.morningData?.anxiety ?? c.eveningData?.anxiety);
    const weekAvgAnxiety = weekAnxietyScores.length > 0
        ? (weekAnxietyScores.reduce((a, b) => a + b, 0) / weekAnxietyScores.length).toFixed(1)
        : 'N/A';

    const weekSleepScores = thisWeekCheckIns
        .filter(c => c.morningData?.sleep !== undefined || c.eveningData?.sleep !== undefined)
        .map(c => c.morningData?.sleep ?? c.eveningData?.sleep);
    const weekAvgSleep = weekSleepScores.length > 0
        ? (weekSleepScores.reduce((a, b) => a + b, 0) / weekSleepScores.length).toFixed(1)
        : 'N/A';

    // Reflection stats for the week
    const thisWeekReflections = reflectionData.filter(r => {
        const reflectionDate = r.createdAt?.toDate ? r.createdAt.toDate() : new Date(r.createdAt);
        return reflectionDate >= weekAgo;
    });

    const weekReflectionCount = thisWeekReflections.length;
    const weekDailyScores = thisWeekReflections.filter(r => r.dailyScore).map(r => r.dailyScore);
    const weekAvgDailyScore = weekDailyScores.length > 0
        ? (weekDailyScores.reduce((a, b) => a + b, 0) / weekDailyScores.length).toFixed(1)
        : 'N/A';

    // Gratitude entries for the week
    const weekGratitudes = thisWeekReflections.filter(r => r.gratitude && r.gratitude.length > 0).length;

    // Assignment progress for the week
    const thisWeekAssignments = assignments.filter(a => {
        if (!a.createdAt) return false;
        const assignmentDate = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt);
        return assignmentDate >= weekAgo;
    });

    const weekAssignmentsCompleted = thisWeekAssignments.filter(a => a.status === 'completed').length;
    const weekAssignmentsTotal = thisWeekAssignments.length;
    const weekCompletionRate = weekAssignmentsTotal > 0
        ? Math.round((weekAssignmentsCompleted / weekAssignmentsTotal) * 100)
        : 0;

    // Coach notes for the week
    const thisWeekCoachNotes = coachNotes.filter(n => {
        if (!n.createdAt) return false;
        const noteDate = n.createdAt?.toDate ? n.createdAt.toDate() : new Date(n.createdAt);
        return noteDate >= weekAgo;
    });

    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0,0,0,0.7)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 10000,
            padding: '20px'
        }}
        onClick={() => setShowWeeklyReportModal(false)}>
            <div style={{
                background: '#FFFFFF',
                borderRadius: '15px',
                maxWidth: '600px',
                width: '100%',
                maxHeight: '90vh',
                overflow: 'auto'
            }}
            onClick={(e) => e.stopPropagation()}>
                {/* Header */}
                <div style={{
                    padding: '20px',
                    borderBottom: '1px solid #E5E5E5',
                    position: 'sticky',
                    top: 0,
                    background: '#FFFFFF',
                    zIndex: 1
                }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                            <i data-lucide="calendar-check" style={{ width: '24px', height: '24px', color: '#058585' }}></i>
                            <h3 style={{
                                margin: 0,
                                fontSize: '20px',
                                fontWeight: 'bold',
                                color: '#000000'
                            }}>
                                Weekly Progress Report
                            </h3>
                        </div>
                        <button
                            onClick={() => setShowWeeklyReportModal(false)}
                            style={{
                                background: 'none',
                                border: 'none',
                                cursor: 'pointer',
                                padding: '4px'
                            }}
                        >
                            <i data-lucide="x" style={{ width: '20px', height: '20px', color: '#666666' }}></i>
                        </button>
                    </div>
                    <div style={{
                        fontSize: '12px',
                        color: '#666666',
                        marginTop: '8px'
                    }}>
                        Last 7 Days • {new Date(weekAgo).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - {new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                    </div>
                </div>

                {/* Content */}
                <div style={{ padding: '20px' }}>
                    {/* Check-In Summary */}
                    <div style={{
                        marginBottom: '24px',
                        padding: '16px',
                        background: 'linear-gradient(135deg, #058585 0%, #047373 100%)',
                        borderRadius: '12px',
                        color: '#FFFFFF'
                    }}>
                        <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '10px',
                            marginBottom: '12px'
                        }}>
                            <i data-lucide="check-circle" style={{ width: '20px', height: '20px' }}></i>
                            <h4 style={{ margin: 0, fontSize: '16px', fontWeight: 'bold' }}>
                                Check-In Summary
                            </h4>
                        </div>
                        <div style={{
                            display: 'grid',
                            gridTemplateColumns: 'repeat(2, 1fr)',
                            gap: '12px'
                        }}>
                            <div>
                                <div style={{ fontSize: '12px', opacity: 0.9 }}>Check-In Rate</div>
                                <div style={{ fontSize: '24px', fontWeight: 'bold' }}>
                                    {weekCheckInRate}%
                                </div>
                                <div style={{ fontSize: '11px', opacity: 0.8 }}>
                                    {weekCheckInCount}/7 days
                                </div>
                            </div>
                            <div>
                                <div style={{ fontSize: '12px', opacity: 0.9 }}>Avg Mood</div>
                                <div style={{ fontSize: '24px', fontWeight: 'bold' }}>
                                    {weekAvgMood}
                                </div>
                                <div style={{ fontSize: '11px', opacity: 0.8 }}>out of 10</div>
                            </div>
                            <div>
                                <div style={{ fontSize: '12px', opacity: 0.9 }}>Avg Cravings</div>
                                <div style={{ fontSize: '24px', fontWeight: 'bold' }}>
                                    {weekAvgCravings}
                                </div>
                                <div style={{ fontSize: '11px', opacity: 0.8 }}>intensity</div>
                            </div>
                            <div>
                                <div style={{ fontSize: '12px', opacity: 0.9 }}>Avg Anxiety</div>
                                <div style={{ fontSize: '24px', fontWeight: 'bold' }}>
                                    {weekAvgAnxiety}
                                </div>
                                <div style={{ fontSize: '11px', opacity: 0.8 }}>level</div>
                            </div>
                        </div>
                        <div style={{
                            marginTop: '12px',
                            paddingTop: '12px',
                            borderTop: '1px solid rgba(255,255,255,0.2)'
                        }}>
                            <div style={{ fontSize: '12px', opacity: 0.9 }}>Avg Sleep Quality</div>
                            <div style={{ fontSize: '24px', fontWeight: 'bold' }}>
                                {weekAvgSleep}
                            </div>
                            <div style={{ fontSize: '11px', opacity: 0.8 }}>out of 10</div>
                        </div>
                    </div>

                    {/* Reflection Summary */}
                    <div style={{
                        marginBottom: '24px',
                        padding: '16px',
                        background: '#F5F5F5',
                        borderRadius: '12px'
                    }}>
                        <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '10px',
                            marginBottom: '12px'
                        }}>
                            <i data-lucide="book-open" style={{ width: '20px', height: '20px', color: '#058585' }}></i>
                            <h4 style={{ margin: 0, fontSize: '16px', fontWeight: 'bold', color: '#000000' }}>
                                Reflection Summary
                            </h4>
                        </div>
                        <div style={{
                            display: 'grid',
                            gridTemplateColumns: 'repeat(3, 1fr)',
                            gap: '12px'
                        }}>
                            <div>
                                <div style={{ fontSize: '12px', color: '#666666' }}>Reflections</div>
                                <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#058585' }}>
                                    {weekReflectionCount}
                                </div>
                            </div>
                            <div>
                                <div style={{ fontSize: '12px', color: '#666666' }}>Avg Daily Score</div>
                                <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#058585' }}>
                                    {weekAvgDailyScore}
                                </div>
                            </div>
                            <div>
                                <div style={{ fontSize: '12px', color: '#666666' }}>Gratitudes</div>
                                <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#058585' }}>
                                    {weekGratitudes}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Assignment Progress */}
                    <div style={{
                        marginBottom: '24px',
                        padding: '16px',
                        background: '#F5F5F5',
                        borderRadius: '12px'
                    }}>
                        <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '10px',
                            marginBottom: '12px'
                        }}>
                            <i data-lucide="clipboard-check" style={{ width: '20px', height: '20px', color: '#058585' }}></i>
                            <h4 style={{ margin: 0, fontSize: '16px', fontWeight: 'bold', color: '#000000' }}>
                                Assignment Progress
                            </h4>
                        </div>
                        <div style={{
                            display: 'grid',
                            gridTemplateColumns: 'repeat(2, 1fr)',
                            gap: '12px'
                        }}>
                            <div>
                                <div style={{ fontSize: '12px', color: '#666666' }}>Completed</div>
                                <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#058585' }}>
                                    {weekAssignmentsCompleted}
                                </div>
                                <div style={{ fontSize: '11px', color: '#999999' }}>
                                    of {weekAssignmentsTotal} assignments
                                </div>
                            </div>
                            <div>
                                <div style={{ fontSize: '12px', color: '#666666' }}>Completion Rate</div>
                                <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#058585' }}>
                                    {weekCompletionRate}%
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Streaks */}
                    <div style={{
                        marginBottom: '24px',
                        padding: '16px',
                        background: '#F5F5F5',
                        borderRadius: '12px'
                    }}>
                        <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '10px',
                            marginBottom: '12px'
                        }}>
                            <i data-lucide="flame" style={{ width: '20px', height: '20px', color: '#FF6B6B' }}></i>
                            <h4 style={{ margin: 0, fontSize: '16px', fontWeight: 'bold', color: '#000000' }}>
                                Current Streaks
                            </h4>
                        </div>
                        <div style={{
                            display: 'grid',
                            gridTemplateColumns: 'repeat(2, 1fr)',
                            gap: '12px'
                        }}>
                            <div>
                                <div style={{ fontSize: '12px', color: '#666666' }}>Check-In Streak</div>
                                <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#FF6B6B' }}>
                                    {checkInStreak}
                                </div>
                                <div style={{ fontSize: '11px', color: '#999999' }}>days</div>
                            </div>
                            <div>
                                <div style={{ fontSize: '12px', color: '#666666' }}>Reflection Streak</div>
                                <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#FF6B6B' }}>
                                    {reflectionStreak}
                                </div>
                                <div style={{ fontSize: '11px', color: '#999999' }}>days</div>
                            </div>
                        </div>
                    </div>

                    {/* Coach Notes */}
                    {thisWeekCoachNotes.length > 0 ? (
                        <div style={{
                            marginBottom: '16px',
                            padding: '16px',
                            background: '#FFF9E6',
                            borderRadius: '12px',
                            border: '1px solid #FFE066'
                        }}>
                            <div style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px',
                                marginBottom: '12px'
                            }}>
                                <i data-lucide="message-circle" style={{ width: '20px', height: '20px', color: '#F59E0B' }}></i>
                                <h4 style={{ margin: 0, fontSize: '16px', fontWeight: 'bold', color: '#000000' }}>
                                    Coach Notes This Week
                                </h4>
                            </div>
                            <div style={{ fontSize: '12px', color: '#666666', marginBottom: '8px' }}>
                                {thisWeekCoachNotes.length} note{thisWeekCoachNotes.length !== 1 ? 's' : ''} from your coach
                            </div>
                            {thisWeekCoachNotes.slice(0, 3).map((note, index) => (
                                <div key={note.id || index} style={{
                                    padding: '10px',
                                    background: '#FFFFFF',
                                    borderRadius: '8px',
                                    marginBottom: index < Math.min(2, thisWeekCoachNotes.length - 1) ? '8px' : 0,
                                    border: '1px solid #E5E5E5'
                                }}>
                                    <div style={{
                                        fontSize: '11px',
                                        color: '#999999',
                                        marginBottom: '4px'
                                    }}>
                                        {note.createdAt?.toDate ? note.createdAt.toDate().toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'Recent'}
                                    </div>
                                    <div style={{
                                        fontSize: '13px',
                                        color: '#000000',
                                        lineHeight: '1.4'
                                    }}>
                                        {note.note?.substring(0, 100)}{note.note?.length > 100 ? '...' : ''}
                                    </div>
                                </div>
                            ))}
                            {thisWeekCoachNotes.length > 3 && (
                                <div style={{
                                    fontSize: '12px',
                                    color: '#058585',
                                    marginTop: '8px',
                                    textAlign: 'center'
                                }}>
                                    + {thisWeekCoachNotes.length - 3} more note{thisWeekCoachNotes.length - 3 !== 1 ? 's' : ''}
                                </div>
                            )}
                        </div>
                    ) : (
                        <div style={{
                            marginBottom: '16px',
                            padding: '16px',
                            background: '#F5F5F5',
                            borderRadius: '12px',
                            textAlign: 'center'
                        }}>
                            <i data-lucide="message-circle" style={{ width: '32px', height: '32px', color: '#CCCCCC', marginBottom: '8px' }}></i>
                            <div style={{ fontSize: '14px', color: '#999999' }}>
                                No coach notes this week
                            </div>
                        </div>
                    )}

                    {/* Summary Message */}
                    <div style={{
                        padding: '16px',
                        background: 'linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%)',
                        borderRadius: '12px',
                        textAlign: 'center'
                    }}>
                        <div style={{
                            fontSize: '16px',
                            fontWeight: 'bold',
                            color: '#2E7D32',
                            marginBottom: '8px'
                        }}>
                            {weekCheckInRate >= 85 && weekReflectionCount >= 5 ? 'Outstanding Week!' :
                             weekCheckInRate >= 70 && weekReflectionCount >= 3 ? 'Great Progress!' :
                             weekCheckInRate >= 50 ? 'Keep Going!' : 'You\'ve Got This!'}
                        </div>
                        <div style={{
                            fontSize: '13px',
                            color: '#1B5E20',
                            lineHeight: '1.5'
                        }}>
                            {weekCheckInRate >= 85 && weekReflectionCount >= 5 ?
                                'You\'re crushing it! Your consistency is inspiring.' :
                             weekCheckInRate >= 70 && weekReflectionCount >= 3 ?
                                'You\'re making excellent progress. Keep up the momentum!' :
                             weekCheckInRate >= 50 ?
                                'You\'re building great habits. Every day counts!' :
                                'Remember, progress isn\'t always linear. We\'re here to support you.'}
                        </div>
                    </div>

                    {/* Export/Share Button */}
                    <button
                        onClick={() => {
                            const reportText = `Weekly Progress Report\nLast 7 Days\n\nCheck-In Summary:\n- Check-In Rate: ${weekCheckInRate}% (${weekCheckInCount}/7 days)\n- Avg Mood: ${weekAvgMood}/10\n- Avg Cravings: ${weekAvgCravings}/10\n- Avg Anxiety: ${weekAvgAnxiety}/10\n- Avg Sleep Quality: ${weekAvgSleep}/10\n\nReflection Summary:\n- Reflections: ${weekReflectionCount}\n- Avg Daily Score: ${weekAvgDailyScore}/10\n- Gratitudes: ${weekGratitudes}\n\nAssignment Progress:\n- Completed: ${weekAssignmentsCompleted}/${weekAssignmentsTotal}\n- Completion Rate: ${weekCompletionRate}%\n\nCurrent Streaks:\n- Check-In Streak: ${checkInStreak} days\n- Reflection Streak: ${reflectionStreak} days`;

                            if (navigator.share) {
                                navigator.share({
                                    title: 'Weekly Progress Report',
                                    text: reportText
                                }).catch(err => console.log('Share cancelled'));
                            } else {
                                // Fallback: copy to clipboard
                                navigator.clipboard.writeText(reportText).then(() => {
                                    alert('Report copied to clipboard!');
                                });
                            }
                        }}
                        style={{
                            width: '100%',
                            marginTop: '16px',
                            padding: '14px',
                            background: 'linear-gradient(135deg, #058585 0%, #047373 100%)',
                            color: '#FFFFFF',
                            border: 'none',
                            borderRadius: '12px',
                            fontSize: '16px',
                            fontWeight: 'bold',
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            gap: '8px'
                        }}
                    >
                        <i data-lucide="share-2" style={{ width: '20px', height: '20px' }}></i>
                        Export / Share Report
                    </button>
                </div>
            </div>
        </div>
    );
})()}

{/* 2. Streak Calendar Modal */}
{showStreakModal && (
    <div style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        background: 'rgba(0,0,0,0.7)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        zIndex: 10000,
        padding: '20px'
    }}
    onClick={() => setShowStreakModal(false)}>
        <div style={{
            background: '#FFFFFF',
            borderRadius: '15px',
            maxWidth: '400px',
            width: '100%',
            maxHeight: '80vh',
            overflow: 'auto'
        }}
        onClick={(e) => e.stopPropagation()}>
            {/* Header */}
            <div style={{
                padding: '20px',
                borderBottom: '1px solid #E5E5E5'
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <h3 style={{
                        margin: 0,
                        fontSize: '18px',
                        fontWeight: '400',
                        color: '#000000'
                    }}>
                        Check-In Streak
                    </h3>
                    <button
                        onClick={() => setShowStreakModal(false)}
                        style={{
                            background: 'none',
                            border: 'none',
                            cursor: 'pointer',
                            padding: '4px'
                        }}
                    >
                        <i data-lucide="x" style={{ width: '20px', height: '20px', color: '#666666' }}></i>
                    </button>
                </div>
            </div>

            {/* Content */}
            <div style={{ padding: '20px' }}>
                {/* Back Button */}
                <button
                    onClick={() => setShowStreakModal(false)}
                    style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px',
                        background: 'none',
                        border: 'none',
                        color: '#058585',
                        fontSize: '14px',
                        fontWeight: '400',
                        cursor: 'pointer',
                        marginBottom: '16px',
                        padding: 0
                    }}
                >
                    <i data-lucide="arrow-left" style={{ width: '20px', height: '20px' }}></i>
                    Back to Check-In
                </button>

                {/* Current Streak Summary */}
                <div style={{
                    background: '#E0F7FA',
                    borderRadius: '12px',
                    padding: '16px',
                    marginBottom: '20px',
                    textAlign: 'center'
                }}>
                    <div style={{
                        fontSize: '32px',
                        fontWeight: 'bold',
                        color: '#058585',
                        marginBottom: '4px'
                    }}>
                        {checkInStreak} {checkInStreak === 1 ? 'Day' : 'Days'}
                    </div>
                    <div style={{
                        fontSize: '14px',
                        fontWeight: '400',
                        color: '#666666'
                    }}>
                        Current Streak
                    </div>
                </div>

                {/* All Check-Ins List */}
                <div style={{
                    fontSize: '14px',
                    fontWeight: '400',
                    color: '#000000',
                    marginBottom: '12px'
                }}>
                    All Check-Ins in Streak
                </div>

                {/* Check-In Items - Vertical List */}
                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                    {streakCheckIns.length > 0 ? streakCheckIns.map((checkIn, index) => {
                        const checkInDate = checkIn.createdAt?.toDate ?
                            checkIn.createdAt.toDate() : new Date(checkIn.createdAt);
                        const dateStr = checkInDate.toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric'
                        });

                        // Get morning data (primary source for scores)
                        const mood = checkIn.morningData?.mood ?? checkIn.eveningData?.mood ?? 'N/A';
                        const craving = checkIn.morningData?.craving ?? checkIn.eveningData?.craving ?? 'N/A';
                        const anxiety = checkIn.morningData?.anxiety ?? checkIn.eveningData?.anxiety ?? 'N/A';
                        const sleep = checkIn.morningData?.sleep ?? checkIn.eveningData?.sleep ?? 'N/A';

                        return (
                            <div
                                key={checkIn.id}
                                style={{
                                    background: '#FFFFFF',
                                    border: '1px solid #E5E5E5',
                                    borderRadius: '8px',
                                    padding: '12px'
                                }}
                            >
                                <div style={{
                                    fontSize: '14px',
                                    fontWeight: 'bold',
                                    color: '#000000',
                                    marginBottom: '6px'
                                }}>
                                    Day {streakCheckIns.length - index} - {dateStr}
                                </div>
                                <div style={{
                                    fontSize: '12px',
                                    fontWeight: '400',
                                    color: '#666666',
                                    display: 'flex',
                                    flexWrap: 'wrap',
                                    gap: '12px'
                                }}>
                                    <span>Mood: {mood}</span>
                                    <span>Craving: {craving}</span>
                                    <span>Anxiety: {anxiety}</span>
                                    <span>Sleep: {sleep}</span>
                                </div>
                            </div>
                        );
                    }) : (
                        <div style={{
                            padding: '20px',
                            textAlign: 'center',
                            color: '#999999',
                            fontSize: '14px'
                        }}>
                            No check-ins in streak yet. Start checking in daily to build your streak!
                        </div>
                    )}
                </div>
            </div>
        </div>
    </div>
)}

{/* Calendar Heatmap Modal - 365-day check-in visualization */}
{showCalendarHeatmapModal && (
    <div style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        background: 'rgba(0,0,0,0.7)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        zIndex: 10000,
        padding: '20px'
    }}
    onClick={() => {
        setShowCalendarHeatmapModal(false);
        setSelectedCalendarDay(null);
    }}>
        <div style={{
            background: '#FFFFFF',
            borderRadius: '15px',
            maxWidth: '600px',
            width: '100%',
            maxHeight: '90vh',
            overflow: 'auto'
        }}
        onClick={(e) => e.stopPropagation()}>
            {/* Header */}
            <div style={{
                padding: '20px',
                borderBottom: '1px solid #E5E5E5',
                position: 'sticky',
                top: 0,
                background: '#FFFFFF',
                zIndex: 10
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                        <i data-lucide="calendar" style={{ width: '24px', height: '24px', color: '#058585' }}></i>
                        <h3 style={{
                            margin: 0,
                            fontSize: '20px',
                            fontWeight: '600',
                            color: '#000000'
                        }}>
                            Check-In Calendar
                        </h3>
                    </div>
                    <button
                        onClick={() => {
                            setShowCalendarHeatmapModal(false);
                            setSelectedCalendarDay(null);
                        }}
                        style={{
                            background: 'none',
                            border: 'none',
                            cursor: 'pointer',
                            padding: '4px'
                        }}
                    >
                        <i data-lucide="x" style={{ width: '20px', height: '20px', color: '#666666' }}></i>
                    </button>
                </div>

                {/* View Mode Toggle */}
                <div style={{
                    display: 'flex',
                    gap: '8px',
                    marginBottom: '15px'
                }}>
                    {['week', 'month'].map(mode => (
                        <button
                            key={mode}
                            onClick={() => {
                                triggerHaptic('light');
                                setCalendarViewMode(mode);
                                setSelectedCalendarDay(null);
                            }}
                            style={{
                                flex: 1,
                                padding: '10px 16px',
                                borderRadius: '8px',
                                border: calendarViewMode === mode ? '2px solid #058585' : '1px solid #E5E5E5',
                                background: calendarViewMode === mode ? 'rgba(5, 133, 133, 0.1)' : '#FFFFFF',
                                color: calendarViewMode === mode ? '#058585' : '#666666',
                                fontSize: '14px',
                                fontWeight: calendarViewMode === mode ? '600' : '400',
                                cursor: 'pointer',
                                transition: 'all 0.2s',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '6px'
                            }}
                        >
                            <i data-lucide={mode === 'week' ? 'calendar-days' : 'calendar'}
                               style={{ width: '16px', height: '16px' }}></i>
                            {mode.charAt(0).toUpperCase() + mode.slice(1)}
                        </button>
                    ))}
                </div>

                {/* Month Navigation */}
                {calendarViewMode === 'month' && (
                    <div style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        padding: '12px',
                        background: '#F8F9FA',
                        borderRadius: '8px'
                    }}>
                        <button
                            onClick={() => {
                                triggerHaptic('light');
                                const newMonth = new Date(calendarCurrentMonth);
                                newMonth.setMonth(newMonth.getMonth() - 1);
                                setCalendarCurrentMonth(newMonth);
                            }}
                            style={{
                                background: 'none',
                                border: 'none',
                                cursor: 'pointer',
                                padding: '4px'
                            }}
                        >
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#058585" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                        </button>

                        <div style={{
                            fontSize: '16px',
                            fontWeight: '600',
                            color: '#000000'
                        }}>
                            {calendarCurrentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                        </div>

                        <button
                            onClick={() => {
                                triggerHaptic('light');
                                const newMonth = new Date(calendarCurrentMonth);
                                newMonth.setMonth(newMonth.getMonth() + 1);
                                setCalendarCurrentMonth(newMonth);
                            }}
                            style={{
                                background: 'none',
                                border: 'none',
                                cursor: 'pointer',
                                padding: '4px'
                            }}
                        >
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#058585" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </button>
                    </div>
                )}

                {/* Week Navigation */}
                {calendarViewMode === 'week' && (() => {
                    // Get Monday as start of week (ISO 8601 standard)
                    const getMonday = (d) => {
                        const date = new Date(d);
                        const day = date.getDay();
                        const diff = date.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
                        return new Date(date.setDate(diff));
                    };

                    const monday = getMonday(calendarCurrentWeek);
                    const sunday = new Date(monday);
                    sunday.setDate(monday.getDate() + 6);

                    return (
                        <div style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            padding: '12px',
                            background: '#F8F9FA',
                            borderRadius: '8px'
                        }}>
                            <button
                                onClick={() => {
                                    triggerHaptic('light');
                                    const newWeek = new Date(calendarCurrentWeek);
                                    newWeek.setDate(newWeek.getDate() - 7);
                                    setCalendarCurrentWeek(newWeek);
                                    setSelectedCalendarDay(null);
                                }}
                                style={{
                                    background: 'none',
                                    border: 'none',
                                    cursor: 'pointer',
                                    padding: '4px'
                                }}
                            >
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#058585" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <polyline points="15 18 9 12 15 6"></polyline>
                                </svg>
                            </button>

                            <div style={{
                                fontSize: '16px',
                                fontWeight: '600',
                                color: '#000000',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                            }}>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#058585" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                                {monday.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - {sunday.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                            </div>

                            <button
                                onClick={() => {
                                    triggerHaptic('light');
                                    const newWeek = new Date(calendarCurrentWeek);
                                    newWeek.setDate(newWeek.getDate() + 7);
                                    setCalendarCurrentWeek(newWeek);
                                    setSelectedCalendarDay(null);
                                }}
                                style={{
                                    background: 'none',
                                    border: 'none',
                                    cursor: 'pointer',
                                    padding: '4px'
                                }}
                            >
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#058585" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                            </button>
                        </div>
                    );
                })()}

                {/* Jump to Today Button */}
                <button
                    onClick={() => {
                        triggerHaptic('light');
                        const today = new Date();
                        setCalendarCurrentMonth(today);
                        setCalendarCurrentWeek(today);
                        setSelectedCalendarDay(null);
                    }}
                    style={{
                        width: '100%',
                        marginTop: '12px',
                        padding: '10px',
                        borderRadius: '8px',
                        border: '1px solid #058585',
                        background: '#FFFFFF',
                        color: '#058585',
                        fontSize: '14px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        transition: 'all 0.2s',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '8px'
                    }}
                >
                    <i data-lucide="calendar-check" style={{ width: '16px', height: '16px' }}></i>
                    Jump to Today
                </button>

                {/* Legend */}
                <div style={{
                    marginTop: '15px',
                    padding: '15px',
                    background: '#F8F9FA',
                    borderRadius: '8px',
                    border: '1px solid #E5E5E5'
                }}>
                    <div style={{
                        fontSize: '13px',
                        fontWeight: '600',
                        color: '#000000',
                        marginBottom: '12px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                    }}>
                        <i data-lucide="info" style={{ width: '16px', height: '16px', color: '#058585' }}></i>
                        Daily Check-In Status
                    </div>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <div style={{ width: '20px', height: '20px', borderRadius: '4px', background: '#00A86B', flexShrink: 0 }}></div>
                            <span style={{ fontSize: '12px', color: '#666666' }}>
                                Morning & Evening Check-Ins Completed
                            </span>
                        </div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <div style={{ width: '20px', height: '20px', borderRadius: '4px', background: '#7FD4AA', flexShrink: 0 }}></div>
                            <span style={{ fontSize: '12px', color: '#666666' }}>
                                Only Morning OR Evening Completed
                            </span>
                        </div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <div style={{ width: '20px', height: '20px', borderRadius: '4px', background: '#E5E5E5', flexShrink: 0 }}></div>
                            <span style={{ fontSize: '12px', color: '#666666' }}>
                                No Check-Ins Completed
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            {/* Calendar Content */}
            <div style={{ padding: '20px' }}>
                {(() => {
                    // Get user's timezone
                    const userTimezone = user.timezone || "America/Los_Angeles";

                    // Helper function to get color based on check-in count
                    const getColorForCount = (count) => {
                        if (count >= 2) return '#00A86B'; // Dark green - both check-ins
                        if (count === 1) return '#7FD4AA'; // Light green - one check-in
                        return '#E5E5E5'; // Gray - no check-in
                    };

                    // Generate calendar data for the selected view mode
                    if (calendarViewMode === 'month') {
                        // Month view - Calendar grid for current month
                        const year = calendarCurrentMonth.getFullYear();
                        const month = calendarCurrentMonth.getMonth();

                        // Get first day of month and how many days in month
                        const firstDayOfMonth = new Date(year, month, 1);
                        const lastDayOfMonth = new Date(year, month + 1, 0);
                        const daysInMonth = lastDayOfMonth.getDate();
                        const startingDayOfWeek = firstDayOfMonth.getDay(); // 0 = Sunday

                        // Build calendar grid
                        const calendarDays = [];

                        // Add empty cells for days before month starts
                        for (let i = 0; i < startingDayOfWeek; i++) {
                            calendarDays.push(null);
                        }

                        // Add all days in month
                        for (let day = 1; day <= daysInMonth; day++) {
                            const date = new Date(year, month, day);
                            const dateKey = date.toISOString().split('T')[0];
                            const dayData = calendarHeatmapData.find(d => d.dateKey === dateKey);

                            calendarDays.push({
                                date: date,
                                dateKey: dateKey,
                                day: day,
                                count: dayData ? dayData.count : 0,
                                data: dayData
                            });
                        }

                        // Group into weeks
                        const weeks = [];
                        for (let i = 0; i < calendarDays.length; i += 7) {
                            weeks.push(calendarDays.slice(i, i + 7));
                        }

                        return (
                            <div>
                                {/* Weekday headers */}
                                <div style={{
                                    display: 'grid',
                                    gridTemplateColumns: 'repeat(7, 1fr)',
                                    gap: '8px',
                                    marginBottom: '12px',
                                    paddingBottom: '8px',
                                    borderBottom: '2px solid #E5E5E5'
                                }}>
                                    {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map((day, i) => (
                                        <div key={i} style={{
                                            fontSize: '12px',
                                            fontWeight: '600',
                                            color: '#666666',
                                            textAlign: 'center'
                                        }}>
                                            {day}
                                        </div>
                                    ))}
                                </div>

                                {/* Calendar grid */}
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                    {weeks.map((week, weekIndex) => (
                                        <div key={weekIndex} style={{
                                            display: 'grid',
                                            gridTemplateColumns: 'repeat(7, 1fr)',
                                            gap: '8px'
                                        }}>
                                            {week.map((day, dayIndex) => {
                                                if (!day) {
                                                    return <div key={dayIndex} style={{ aspectRatio: '1' }}></div>;
                                                }

                                                const isToday = day.dateKey === new Date().toISOString().split('T')[0];
                                                const isSelected = selectedCalendarDay?.dateKey === day.dateKey;

                                                return (
                                                    <div
                                                        key={dayIndex}
                                                        onClick={() => {
                                                            if (day.data) {
                                                                triggerHaptic('light');
                                                                setSelectedCalendarDay(day);
                                                            }
                                                        }}
                                                        style={{
                                                            aspectRatio: '1',
                                                            borderRadius: '8px',
                                                            background: getColorForCount(day.count),
                                                            border: isToday ? '3px solid #FF8C00' : (isSelected ? '3px solid #058585' : '1px solid #DDD'),
                                                            cursor: day.data ? 'pointer' : 'default',
                                                            transition: 'all 0.2s',
                                                            transform: isSelected ? 'scale(1.05)' : 'scale(1)',
                                                            boxShadow: isSelected ? '0 4px 12px rgba(5, 133, 133, 0.3)' : 'none',
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            justifyContent: 'center',
                                                            position: 'relative'
                                                        }}
                                                    >
                                                        {/* Day number */}
                                                        <span style={{
                                                            fontSize: '14px',
                                                            fontWeight: isToday ? '700' : '500',
                                                            color: day.count > 0 ? '#FFFFFF' : '#999999'
                                                        }}>
                                                            {day.day}
                                                        </span>

                                                        {/* Indicator dots for check-ins */}
                                                        {day.data && (
                                                            <div style={{
                                                                position: 'absolute',
                                                                bottom: '4px',
                                                                display: 'flex',
                                                                gap: '2px'
                                                            }}>
                                                                {day.data.morningCheckIn && (
                                                                    <div style={{
                                                                        width: '4px',
                                                                        height: '4px',
                                                                        borderRadius: '50%',
                                                                        background: '#FFFFFF'
                                                                    }}></div>
                                                                )}
                                                                {day.data.eveningCheckIn && (
                                                                    <div style={{
                                                                        width: '4px',
                                                                        height: '4px',
                                                                        borderRadius: '50%',
                                                                        background: '#FFFFFF'
                                                                    }}></div>
                                                                )}
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    ))}
                                </div>

                                {/* Selected Day Details */}
                                {selectedCalendarDay && selectedCalendarDay.data && (
                                    <div style={{
                                        marginTop: '20px',
                                        padding: '20px',
                                        background: 'linear-gradient(135deg, rgba(5, 133, 133, 0.05) 0%, rgba(5, 133, 133, 0.1) 100%)',
                                        borderRadius: '12px',
                                        border: '2px solid #058585',
                                        animation: 'fadeIn 0.3s'
                                    }}>
                                        <div style={{
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            alignItems: 'flex-start',
                                            marginBottom: '16px'
                                        }}>
                                            <div>
                                                <div style={{
                                                    fontSize: '18px',
                                                    fontWeight: '600',
                                                    color: '#000000',
                                                    marginBottom: '4px'
                                                }}>
                                                    {selectedCalendarDay.date.toLocaleDateString('en-US', {
                                                        weekday: 'long',
                                                        month: 'long',
                                                        day: 'numeric',
                                                        year: 'numeric'
                                                    })}
                                                </div>
                                                <div style={{
                                                    fontSize: '13px',
                                                    color: '#666666',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '6px'
                                                }}>
                                                    <i data-lucide="check-circle" style={{ width: '14px', height: '14px', color: '#00A86B' }}></i>
                                                    {selectedCalendarDay.count} check-in{selectedCalendarDay.count !== 1 ? 's' : ''} completed
                                                </div>
                                            </div>
                                            <button
                                                onClick={() => setSelectedCalendarDay(null)}
                                                style={{
                                                    background: 'none',
                                                    border: 'none',
                                                    cursor: 'pointer',
                                                    padding: '4px'
                                                }}
                                            >
                                                <i data-lucide="x" style={{ width: '18px', height: '18px', color: '#666666' }}></i>
                                            </button>
                                        </div>

                                        {/* Morning Check-In */}
                                        {selectedCalendarDay.data.morningCheckIn && (
                                            <div style={{
                                                marginBottom: selectedCalendarDay.data.eveningCheckIn ? '16px' : '0',
                                                padding: '15px',
                                                background: '#FFFFFF',
                                                borderRadius: '8px',
                                                border: '1px solid #E5E5E5'
                                            }}>
                                                <div style={{
                                                    fontSize: '14px',
                                                    fontWeight: '600',
                                                    color: '#058585',
                                                    marginBottom: '12px',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '8px'
                                                }}>
                                                    <i data-lucide="sunrise" style={{ width: '16px', height: '16px' }}></i>
                                                    Morning Check-In
                                                </div>
                                                <div style={{
                                                    display: 'grid',
                                                    gridTemplateColumns: 'repeat(2, 1fr)',
                                                    gap: '12px'
                                                }}>
                                                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                        <i data-lucide="smile" style={{ width: '16px', height: '16px', color: '#666666' }}></i>
                                                        <span style={{ fontSize: '13px', color: '#666666' }}>
                                                            Mood: <strong style={{ color: '#000000' }}>{selectedCalendarDay.data.morningCheckIn.mood ?? 'N/A'}</strong>
                                                        </span>
                                                    </div>
                                                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                        <i data-lucide="flame" style={{ width: '16px', height: '16px', color: '#666666' }}></i>
                                                        <span style={{ fontSize: '13px', color: '#666666' }}>
                                                            Craving: <strong style={{ color: '#000000' }}>{selectedCalendarDay.data.morningCheckIn.craving ?? 'N/A'}</strong>
                                                        </span>
                                                    </div>
                                                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                        <i data-lucide="alert-circle" style={{ width: '16px', height: '16px', color: '#666666' }}></i>
                                                        <span style={{ fontSize: '13px', color: '#666666' }}>
                                                            Anxiety: <strong style={{ color: '#000000' }}>{selectedCalendarDay.data.morningCheckIn.anxiety ?? 'N/A'}</strong>
                                                        </span>
                                                    </div>
                                                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                        <i data-lucide="moon" style={{ width: '16px', height: '16px', color: '#666666' }}></i>
                                                        <span style={{ fontSize: '13px', color: '#666666' }}>
                                                            Sleep: <strong style={{ color: '#000000' }}>{selectedCalendarDay.data.morningCheckIn.sleep ?? 'N/A'}</strong>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        {/* Evening Check-In */}
                                        {selectedCalendarDay.data.eveningCheckIn && (
                                            <div style={{
                                                padding: '15px',
                                                background: '#FFFFFF',
                                                borderRadius: '8px',
                                                border: '1px solid #E5E5E5'
                                            }}>
                                                <div style={{
                                                    fontSize: '14px',
                                                    fontWeight: '600',
                                                    color: '#058585',
                                                    marginBottom: '12px',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '8px'
                                                }}>
                                                    <i data-lucide="sunset" style={{ width: '16px', height: '16px' }}></i>
                                                    Evening Check-In
                                                </div>
                                                <div style={{
                                                    fontSize: '13px',
                                                    color: '#666666',
                                                    lineHeight: '1.6'
                                                }}>
                                                    {selectedCalendarDay.data.eveningCheckIn.reflection || 'No reflection recorded'}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        );
                    } else {
                        // Week view - Monday to Sunday
                        // Get Monday as start of week (ISO 8601 standard)
                        const getMonday = (d) => {
                            const date = new Date(d);
                            const day = date.getDay();
                            const diff = date.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
                            return new Date(date.setDate(diff));
                        };

                        const monday = getMonday(calendarCurrentWeek);

                        // Generate 7 days for the week (Monday to Sunday)
                        const weekDays = [];
                        for (let i = 0; i < 7; i++) {
                            const date = new Date(monday);
                            date.setDate(monday.getDate() + i);

                            // Create dateKey the same way we do in loadCalendarHeatmapData
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            const dateKey = `${year}-${month}-${day}`;

                            const dayData = calendarHeatmapData.find(d => d.dateKey === dateKey);

                            weekDays.push({
                                date: date,
                                dateKey: dateKey,
                                day: date.getDate(),
                                dayName: date.toLocaleDateString('en-US', { weekday: 'short' }),
                                count: dayData ? dayData.count : 0,
                                data: dayData
                            });
                        }

                        return (
                            <div>
                                {/* Week summary header */}
                                <div style={{
                                    padding: '15px',
                                    background: 'linear-gradient(135deg, rgba(5, 133, 133, 0.05) 0%, rgba(5, 133, 133, 0.1) 100%)',
                                    borderRadius: '12px',
                                    marginBottom: '20px',
                                    border: '1px solid rgba(5, 133, 133, 0.2)'
                                }}>
                                    <div style={{
                                        fontSize: '14px',
                                        fontWeight: '600',
                                        color: '#000000',
                                        marginBottom: '8px',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px'
                                    }}>
                                        <i data-lucide="calendar-days" style={{ width: '16px', height: '16px', color: '#058585' }}></i>
                                        {weekDays[0].date.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })} - {weekDays[6].date.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}
                                    </div>
                                    <div style={{
                                        fontSize: '13px',
                                        color: '#666666'
                                    }}>
                                        {(() => {
                                            // Calculate how many days to count based on current week
                                            const today = new Date();
                                            const todayDateKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

                                            // Check if today falls within this week
                                            const isCurrentWeek = weekDays.some(d => d.dateKey === todayDateKey);

                                            let totalDays = 7;
                                            if (isCurrentWeek) {
                                                // Find which day of the week today is (0 = Monday, 6 = Sunday)
                                                const todayIndex = weekDays.findIndex(d => d.dateKey === todayDateKey);
                                                totalDays = todayIndex + 1; // +1 because index is 0-based
                                            }

                                            const daysWithCheckIns = weekDays.slice(0, totalDays).filter(d => d.count > 0).length;
                                            return `${daysWithCheckIns} out of ${totalDays} days with check-ins`;
                                        })()}
                                    </div>
                                </div>

                                {/* Week days - Large cards */}
                                <div style={{
                                    display: 'flex',
                                    flexDirection: 'column',
                                    gap: '12px'
                                }}>
                                    {weekDays.map((day, dayIndex) => {
                                        const isToday = day.dateKey === new Date().toISOString().split('T')[0];
                                        const isSelected = selectedCalendarDay?.dateKey === day.dateKey;

                                        return (
                                            <div
                                                key={dayIndex}
                                                onClick={() => {
                                                    if (day.data) {
                                                        triggerHaptic('light');
                                                        setSelectedCalendarDay(day);
                                                    }
                                                }}
                                                style={{
                                                    padding: '16px',
                                                    borderRadius: '12px',
                                                    background: getColorForCount(day.count),
                                                    border: isToday ? '3px solid #FF8C00' : (isSelected ? '3px solid #058585' : '2px solid #E5E5E5'),
                                                    cursor: day.data ? 'pointer' : 'default',
                                                    transition: 'all 0.2s',
                                                    transform: isSelected ? 'scale(1.02)' : 'scale(1)',
                                                    boxShadow: isSelected ? '0 4px 12px rgba(5, 133, 133, 0.3)' : '0 2px 4px rgba(0,0,0,0.05)'
                                                }}
                                            >
                                                <div style={{
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'center'
                                                }}>
                                                    <div style={{
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: '12px'
                                                    }}>
                                                        <div style={{
                                                            width: '48px',
                                                            height: '48px',
                                                            borderRadius: '8px',
                                                            background: day.count > 0 ? 'rgba(255,255,255,0.3)' : 'rgba(0,0,0,0.05)',
                                                            display: 'flex',
                                                            flexDirection: 'column',
                                                            alignItems: 'center',
                                                            justifyContent: 'center',
                                                            border: '1px solid rgba(255,255,255,0.5)'
                                                        }}>
                                                            <div style={{
                                                                fontSize: '11px',
                                                                fontWeight: '600',
                                                                color: day.count > 0 ? '#FFFFFF' : '#999999'
                                                            }}>
                                                                {day.dayName.toUpperCase()}
                                                            </div>
                                                            <div style={{
                                                                fontSize: '18px',
                                                                fontWeight: '700',
                                                                color: day.count > 0 ? '#FFFFFF' : '#999999'
                                                            }}>
                                                                {day.day}
                                                            </div>
                                                        </div>

                                                        <div>
                                                            <div style={{
                                                                fontSize: '15px',
                                                                fontWeight: '600',
                                                                color: day.count > 0 ? '#FFFFFF' : '#000000',
                                                                marginBottom: '4px'
                                                            }}>
                                                                {isToday && <span style={{ marginRight: '6px' }}>(Today)</span>}
                                                                {day.date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
                                                            </div>
                                                            <div style={{
                                                                fontSize: '13px',
                                                                color: day.count > 0 ? 'rgba(255,255,255,0.9)' : '#666666',
                                                                display: 'flex',
                                                                alignItems: 'center',
                                                                gap: '6px'
                                                            }}>
                                                                {day.count === 0 && (
                                                                    <>
                                                                        <i data-lucide="x-circle" style={{ width: '14px', height: '14px' }}></i>
                                                                        No check-ins
                                                                    </>
                                                                )}
                                                                {day.count === 1 && (
                                                                    <>
                                                                        <i data-lucide="check" style={{ width: '14px', height: '14px' }}></i>
                                                                        1 check-in completed
                                                                    </>
                                                                )}
                                                                {day.count === 2 && (
                                                                    <>
                                                                        <i data-lucide="check-check" style={{ width: '14px', height: '14px' }}></i>
                                                                        Both check-ins completed
                                                                    </>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {/* Check-in indicators */}
                                                    {day.data && (
                                                        <div style={{
                                                            display: 'flex',
                                                            gap: '8px'
                                                        }}>
                                                            {day.data.morningCheckIn && (
                                                                <div style={{
                                                                    padding: '4px 8px',
                                                                    borderRadius: '6px',
                                                                    background: 'rgba(255,255,255,0.3)',
                                                                    fontSize: '11px',
                                                                    fontWeight: '600',
                                                                    color: '#FFFFFF',
                                                                    display: 'flex',
                                                                    alignItems: 'center',
                                                                    gap: '4px'
                                                                }}>
                                                                    <i data-lucide="sunrise" style={{ width: '12px', height: '12px' }}></i>
                                                                    AM
                                                                </div>
                                                            )}
                                                            {day.data.eveningCheckIn && (
                                                                <div style={{
                                                                    padding: '4px 8px',
                                                                    borderRadius: '6px',
                                                                    background: 'rgba(255,255,255,0.3)',
                                                                    fontSize: '11px',
                                                                    fontWeight: '600',
                                                                    color: '#FFFFFF',
                                                                    display: 'flex',
                                                                    alignItems: 'center',
                                                                    gap: '4px'
                                                                }}>
                                                                    <i data-lucide="sunset" style={{ width: '12px', height: '12px' }}></i>
                                                                    PM
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>

                                                {/* Expanded details when selected */}
                                                {isSelected && day.data && (
                                                    <div style={{
                                                        marginTop: '16px',
                                                        paddingTop: '16px',
                                                        borderTop: '1px solid rgba(255,255,255,0.3)'
                                                    }}>
                                                        {/* Morning Check-In */}
                                                        {day.data.morningCheckIn && (
                                                            <div style={{
                                                                marginBottom: day.data.eveningCheckIn ? '12px' : '0',
                                                                padding: '12px',
                                                                background: 'rgba(255,255,255,0.2)',
                                                                borderRadius: '8px'
                                                            }}>
                                                                <div style={{
                                                                    fontSize: '13px',
                                                                    fontWeight: '600',
                                                                    color: '#FFFFFF',
                                                                    marginBottom: '8px',
                                                                    display: 'flex',
                                                                    alignItems: 'center',
                                                                    gap: '6px'
                                                                }}>
                                                                    <i data-lucide="sunrise" style={{ width: '14px', height: '14px' }}></i>
                                                                    Morning Check-In
                                                                </div>
                                                                <div style={{
                                                                    display: 'grid',
                                                                    gridTemplateColumns: 'repeat(2, 1fr)',
                                                                    gap: '8px',
                                                                    fontSize: '12px',
                                                                    color: 'rgba(255,255,255,0.9)'
                                                                }}>
                                                                    <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                                                        <i data-lucide="smile" style={{ width: '12px', height: '12px' }}></i>
                                                                        Mood: <strong>{day.data.morningCheckIn.mood ?? 'N/A'}</strong>
                                                                    </div>
                                                                    <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                                                        <i data-lucide="flame" style={{ width: '12px', height: '12px' }}></i>
                                                                        Craving: <strong>{day.data.morningCheckIn.craving ?? 'N/A'}</strong>
                                                                    </div>
                                                                    <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                                                        <i data-lucide="alert-circle" style={{ width: '12px', height: '12px' }}></i>
                                                                        Anxiety: <strong>{day.data.morningCheckIn.anxiety ?? 'N/A'}</strong>
                                                                    </div>
                                                                    <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                                                        <i data-lucide="moon" style={{ width: '12px', height: '12px' }}></i>
                                                                        Sleep: <strong>{day.data.morningCheckIn.sleep ?? 'N/A'}</strong>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        )}

                                                        {/* Evening Check-In */}
                                                        {day.data.eveningCheckIn && (
                                                            <div style={{
                                                                padding: '12px',
                                                                background: 'rgba(255,255,255,0.2)',
                                                                borderRadius: '8px'
                                                            }}>
                                                                <div style={{
                                                                    fontSize: '13px',
                                                                    fontWeight: '600',
                                                                    color: '#FFFFFF',
                                                                    marginBottom: '8px',
                                                                    display: 'flex',
                                                                    alignItems: 'center',
                                                                    gap: '6px'
                                                                }}>
                                                                    <i data-lucide="sunset" style={{ width: '14px', height: '14px' }}></i>
                                                                    Evening Check-In
                                                                </div>
                                                                <div style={{
                                                                    fontSize: '12px',
                                                                    color: 'rgba(255,255,255,0.9)',
                                                                    lineHeight: '1.5'
                                                                }}>
                                                                    {day.data.eveningCheckIn.reflection || 'No reflection recorded'}
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        );
                    }
                })()}
            </div>
        </div>
    </div>
)}

{/* 3. Reflection Streak Detail Modal */}
{showReflectionStreakModal && (
    <div style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        background: 'rgba(0,0,0,0.7)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        zIndex: 10000,
        padding: '20px'
    }}
    onClick={() => setShowReflectionStreakModal(false)}>
        <div style={{
            background: '#FFFFFF',
            borderRadius: '15px',
            maxWidth: '400px',
            width: '100%',
            maxHeight: '80vh',
            overflow: 'auto'
        }}
        onClick={(e) => e.stopPropagation()}>
            {/* Header */}
            <div style={{
                padding: '20px',
                borderBottom: '1px solid #E5E5E5'
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <h3 style={{
                        margin: 0,
                        fontSize: '18px',
                        fontWeight: '400',
                        color: '#000000'
                    }}>
                        Reflection Streak
                    </h3>
                    <button
                        onClick={() => setShowReflectionStreakModal(false)}
                        style={{
                            background: 'none',
                            border: 'none',
                            cursor: 'pointer',
                            padding: '4px'
                        }}
                    >
                        <i data-lucide="x" style={{ width: '20px', height: '20px', color: '#666666' }}></i>
                    </button>
                </div>
            </div>

            {/* Content */}
            <div style={{ padding: '20px' }}>
                {/* Back Button */}
                <button
                    onClick={() => setShowReflectionStreakModal(false)}
                    style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px',
                        background: 'none',
                        border: 'none',
                        color: '#058585',
                        fontSize: '14px',
                        fontWeight: '400',
                        cursor: 'pointer',
                        marginBottom: '16px',
                        padding: 0
                    }}
                >
                    <i data-lucide="arrow-left" style={{ width: '20px', height: '20px' }}></i>
                    Back to Reflections
                </button>

                {/* Current Streak Summary */}
                <div style={{
                    background: '#E0F7FA',
                    borderRadius: '12px',
                    padding: '16px',
                    marginBottom: '20px',
                    textAlign: 'center'
                }}>
                    <div style={{
                        fontSize: '32px',
                        fontWeight: 'bold',
                        color: '#058585',
                        marginBottom: '4px'
                    }}>
                        {reflectionStreak} {reflectionStreak === 1 ? 'Day' : 'Days'}
                    </div>
                    <div style={{
                        fontSize: '14px',
                        fontWeight: '400',
                        color: '#666666'
                    }}>
                        Current Streak
                    </div>
                </div>

                {/* All Reflections List */}
                <div style={{
                    fontSize: '14px',
                    fontWeight: '400',
                    color: '#000000',
                    marginBottom: '12px'
                }}>
                    All Reflections in Streak
                </div>

                {/* Reflection Items - Vertical List */}
                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                    {streakReflections.length > 0 ? streakReflections.map((reflection, index) => {
                        const reflectionDate = reflection.createdAt?.toDate ?
                            reflection.createdAt.toDate() : new Date(reflection.createdAt);
                        const dateStr = reflectionDate.toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric'
                        });

                        const overallDay = reflection.overallDay ?? reflection.dailyScore ?? 'N/A';
                        const hasGratitude = reflection.gratitude && reflection.gratitude.length > 0;

                        // Score color coding
                        const scoreColor = overallDay >= 8 ? '#4CAF50' :
                                          overallDay >= 6 ? '#FFA726' :
                                          overallDay >= 4 ? '#FF7043' :
                                          overallDay !== 'N/A' ? '#DC143C' : '#999999';

                        return (
                            <div
                                key={reflection.id}
                                style={{
                                    background: '#FFFFFF',
                                    border: '1px solid #E5E5E5',
                                    borderRadius: '8px',
                                    padding: '12px'
                                }}
                            >
                                <div style={{
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center',
                                    marginBottom: '8px'
                                }}>
                                    <div style={{
                                        fontSize: '14px',
                                        fontWeight: 'bold',
                                        color: '#000000'
                                    }}>
                                        Day {streakReflections.length - index} - {dateStr}
                                    </div>
                                    {hasGratitude && (
                                        <i data-lucide="heart" style={{
                                            width: '16px',
                                            height: '16px',
                                            color: '#FF6B6B'
                                        }}></i>
                                    )}
                                </div>
                                <div style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px'
                                }}>
                                    <i data-lucide="smile" style={{
                                        width: '16px',
                                        height: '16px',
                                        color: scoreColor
                                    }}></i>
                                    <div style={{
                                        fontSize: '12px',
                                        fontWeight: 'bold',
                                        color: scoreColor
                                    }}>
                                        Overall Day Score: {overallDay}{overallDay !== 'N/A' ? '/10' : ''}
                                    </div>
                                </div>
                            </div>
                        );
                    }) : (
                        <div style={{
                            padding: '20px',
                            textAlign: 'center',
                            color: '#999999',
                            fontSize: '14px'
                        }}>
                            No reflections in streak yet. Start reflecting daily to build your streak!
                        </div>
                    )}
                </div>
            </div>
        </div>
    </div>
)}

{/* 4. Mood Insights Modal */}
{showMoodInsightsModal && (
    <div style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        background: 'rgba(0,0,0,0.7)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        zIndex: 10000,
        padding: '20px'
    }}
    onClick={() => setShowMoodInsightsModal(false)}>
        <div style={{
            background: '#FFFFFF',
            borderRadius: '15px',
            maxWidth: '500px',
            width: '100%',
            maxHeight: '80vh',
            overflow: 'auto'
        }}
        onClick={(e) => e.stopPropagation()}>
            {/* Header */}
            <div style={{
                padding: '20px',
                borderBottom: '1px solid #E5E5E5'
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <h3 style={{
                        margin: 0,
                        fontSize: '18px',
                        fontWeight: '400',
                        color: '#000000'
                    }}>
                        Mood Insights
                    </h3>
                    <button
                        onClick={() => setShowMoodInsightsModal(false)}
                        style={{
                            background: 'none',
                            border: 'none',
                            cursor: 'pointer',
                            padding: '4px'
                        }}
                    >
                        <i data-lucide="x" style={{ width: '20px', height: '20px', color: '#666666' }}></i>
                    </button>
                </div>
            </div>

            {/* Content */}
            <div style={{ padding: '20px' }}>
                {/* Average Mood */}
                <div style={{
                    textAlign: 'center',
                    marginBottom: '24px'
                }}>
                    <div style={{
                        fontSize: '14px',
                        fontWeight: '400',
                        color: '#666666',
                        marginBottom: '8px'
                    }}>
                        7-Day Average
                    </div>
                    <div style={{
                        fontSize: '48px',
                        fontWeight: 'bold',
                        color: '#058585',
                        marginBottom: '4px'
                    }}>
                        {moodWeekData.thisWeekAvg || '—'}
                    </div>
                    <div style={{
                        fontSize: '14px',
                        fontWeight: '400',
                        color: moodWeekData.difference > 0 ? '#00A86B' : moodWeekData.difference < 0 ? '#DC143C' : '#666666'
                    }}>
                        {moodWeekData.difference > 0 ? '↑' : moodWeekData.difference < 0 ? '↓' : '—'} {moodWeekData.difference > 0 ? '+' : ''}{moodWeekData.difference || '0'} from last week
                    </div>
                </div>

                {/* Weekly Breakdown */}
                <h4 style={{
                    fontSize: '16px',
                    fontWeight: '400',
                    color: '#000000',
                    marginBottom: '12px'
                }}>
                    Weekly Breakdown
                </h4>
                <div style={{ marginBottom: '20px' }}>
                    {moodWeekData.weekData && moodWeekData.weekData.map((dayData, index) => {
                        const score = dayData.mood;
                        const barWidth = score ? (score / 10) * 100 : 0; // Out of 10, not 5!

                        return (
                            <div key={dayData.dateKey} style={{
                                marginBottom: '12px'
                            }}>
                                <div style={{
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center',
                                    marginBottom: '4px'
                                }}>
                                    <span style={{
                                        fontSize: '14px',
                                        fontWeight: '400',
                                        color: '#000000'
                                    }}>
                                        {dayData.dayName}
                                    </span>
                                    <span style={{
                                        fontSize: '14px',
                                        fontWeight: 'bold',
                                        color: score ? '#058585' : '#999999'
                                    }}>
                                        {score ? score.toFixed(1) : 'No check-in'}
                                    </span>
                                </div>
                                <div style={{
                                    width: '100%',
                                    height: '8px',
                                    background: '#E5E5E5',
                                    borderRadius: '4px',
                                    overflow: 'hidden'
                                }}>
                                    <div style={{
                                        width: `${barWidth}%`,
                                        height: '100%',
                                        background: score >= 7 ? '#00A86B' : score >= 5 ? '#FFA500' : score ? '#DC143C' : '#E5E5E5',
                                        transition: 'width 0.3s'
                                    }} />
                                </div>
                            </div>
                        );
                    })}
                </div>

                {/* Back Button */}
                <button
                    onClick={() => {
                        triggerHaptic('light');
                        setShowMoodInsightsModal(false);
                    }}
                    style={{
                        width: '100%',
                        height: '48px',
                        background: '#058585',
                        border: 'none',
                        borderRadius: '8px',
                        color: '#FFFFFF',
                        fontSize: '14px',
                        fontWeight: '400',
                        cursor: 'pointer',
                        transition: 'all 0.2s'
                    }}
                >
                    Back
                </button>
            </div>
        </div>
    </div>
)}

{/* Streaks Modal */}
{showStreaksModal && (
    <div style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        background: 'rgba(0, 0, 0, 0.5)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        zIndex: 1000,
        padding: '20px'
    }}>
        <div style={{
            background: '#FFFFFF',
            borderRadius: '12px',
            width: '100%',
            maxWidth: '500px',
            maxHeight: '80vh',
            overflow: 'auto'
        }}>
            {/* Header */}
            <div style={{
                padding: '20px',
                borderBottom: '1px solid #E5E5E5',
                position: 'sticky',
                top: 0,
                background: '#FFFFFF',
                zIndex: 10
            }}>
                <h3 style={{
                    margin: 0,
                    fontSize: '20px',
                    fontWeight: 'bold',
                    color: '#000000'
                }}>
                    🔥 Your Check-In Streaks
                </h3>
            </div>

            {/* Content */}
            <div style={{ padding: '20px' }}>
                {/* Current Streak */}
                {streakData.currentStreak > 0 && (
                    <div style={{
                        padding: '16px',
                        background: 'linear-gradient(135deg, rgba(5, 133, 133, 0.1) 0%, rgba(0, 168, 107, 0.1) 100%)',
                        borderRadius: '12px',
                        marginBottom: '20px',
                        border: '2px solid #058585'
                    }}>
                        <div style={{ fontSize: '14px', color: '#666', marginBottom: '8px' }}>
                            Current Streak
                        </div>
                        <div style={{ fontSize: '32px', fontWeight: 'bold', color: '#058585' }}>
                            🔥 {streakData.currentStreak} {streakData.currentStreak === 1 ? 'day' : 'days'}
                        </div>
                        <div style={{ fontSize: '12px', color: '#666', marginTop: '8px' }}>
                            Keep it up! Check in today to extend your streak.
                        </div>
                    </div>
                )}

                {/* All Streaks List */}
                <div style={{ marginBottom: '12px', fontSize: '16px', fontWeight: '600', color: '#000' }}>
                    All Streaks
                </div>

                {streakData.allStreaks.length > 0 ? (
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                        {streakData.allStreaks.map((streak, index) => {
                            const startDate = new Date(streak.startDate);
                            const endDate = new Date(streak.endDate);
                            const isLongest = index === 0; // First in sorted array is longest
                            const isCurrent = streak.endDate === `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}-${String(new Date().getDate()).padStart(2, '0')}`;

                            return (
                                <div
                                    key={index}
                                    style={{
                                        padding: '14px',
                                        background: isLongest ? '#FFF9E6' : '#F8F9FA',
                                        borderRadius: '10px',
                                        border: isLongest ? '2px solid #FFA500' : '1px solid #E5E5E5',
                                        position: 'relative'
                                    }}
                                >
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                        <div>
                                            <div style={{ fontSize: '18px', fontWeight: 'bold', color: '#000', marginBottom: '4px' }}>
                                                {streak.length} {streak.length === 1 ? 'day' : 'days'}
                                                {isLongest && <span style={{ marginLeft: '8px', fontSize: '14px' }}>⭐ Longest</span>}
                                                {isCurrent && <span style={{ marginLeft: '8px', fontSize: '14px' }}>← Current</span>}
                                            </div>
                                            <div style={{ fontSize: '13px', color: '#666' }}>
                                                {startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                                {' - '}
                                                {endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                            </div>
                                        </div>
                                        <div style={{ fontSize: '24px' }}>
                                            🔥
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                ) : (
                    <div style={{
                        textAlign: 'center',
                        padding: '40px 20px',
                        color: '#999'
                    }}>
                        <div style={{ fontSize: '48px', marginBottom: '12px' }}>🔥</div>
                        <div>Start checking in to build your first streak!</div>
                    </div>
                )}

                {/* Close Button */}
                <button
                    onClick={() => {
                        triggerHaptic('light');
                        setShowStreaksModal(false);
                    }}
                    style={{
                        marginTop: '20px',
                        width: '100%',
                        height: '48px',
                        background: '#058585',
                        border: 'none',
                        borderRadius: '8px',
                        color: '#FFFFFF',
                        fontSize: '14px',
                        fontWeight: '400',
                        cursor: 'pointer',
                        transition: 'all 0.2s'
                    }}
                >
                    Back
                </button>
            </div>
        </div>
    </div>
)}

{/* Reflection Streaks Modal */}
{showReflectionStreaksModal && (
    <div style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        background: 'rgba(0, 0, 0, 0.5)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        zIndex: 1000,
        padding: '20px'
    }}>
        <div style={{
            background: '#FFFFFF',
            borderRadius: '12px',
            width: '100%',
            maxWidth: '500px',
            maxHeight: '80vh',
            overflow: 'auto'
        }}>
            {/* Header */}
            <div style={{
                padding: '20px',
                borderBottom: '1px solid #E5E5E5',
                position: 'sticky',
                top: 0,
                background: '#FFFFFF',
                zIndex: 10
            }}>
                <h3 style={{
                    margin: 0,
                    fontSize: '20px',
                    fontWeight: 'bold',
                    color: '#000000'
                }}>
                    🌙 Your Reflection Streaks
                </h3>
            </div>

            {/* Content */}
            <div style={{ padding: '20px' }}>
                {/* Current Streak */}
                {reflectionStreakData.currentStreak > 0 && (
                    <div style={{
                        padding: '16px',
                        background: 'linear-gradient(135deg, rgba(5, 133, 133, 0.1) 0%, rgba(0, 168, 107, 0.1) 100%)',
                        borderRadius: '12px',
                        marginBottom: '20px',
                        border: '2px solid #058585'
                    }}>
                        <div style={{ fontSize: '14px', color: '#666', marginBottom: '8px' }}>
                            Current Streak
                        </div>
                        <div style={{ fontSize: '32px', fontWeight: 'bold', color: '#058585' }}>
                            🔥 {reflectionStreakData.currentStreak} {reflectionStreakData.currentStreak === 1 ? 'day' : 'days'}
                        </div>
                        <div style={{ fontSize: '12px', color: '#666', marginTop: '8px' }}>
                            Keep it up! Reflect tonight to extend your streak.
                        </div>
                    </div>
                )}

                {/* All Streaks List */}
                <div style={{ marginBottom: '12px', fontSize: '16px', fontWeight: '600', color: '#000' }}>
                    All Streaks
                </div>

                {reflectionStreakData.allStreaks.length > 0 ? (
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                        {reflectionStreakData.allStreaks.map((streak, index) => {
                            const startDate = new Date(streak.startDate);
                            const endDate = new Date(streak.endDate);
                            const isLongest = index === 0; // First in sorted array is longest
                            const isCurrent = streak.endDate === `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}-${String(new Date().getDate()).padStart(2, '0')}`;

                            return (
                                <div
                                    key={index}
                                    style={{
                                        padding: '14px',
                                        background: isLongest ? '#FFF9E6' : '#F8F9FA',
                                        borderRadius: '10px',
                                        border: isLongest ? '2px solid #FFA500' : '1px solid #E5E5E5',
                                        position: 'relative'
                                    }}
                                >
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                        <div>
                                            <div style={{ fontSize: '18px', fontWeight: 'bold', color: '#000', marginBottom: '4px' }}>
                                                {streak.length} {streak.length === 1 ? 'day' : 'days'}
                                                {isLongest && <span style={{ marginLeft: '8px', fontSize: '14px' }}>⭐ Longest</span>}
                                                {isCurrent && <span style={{ marginLeft: '8px', fontSize: '14px' }}>← Current</span>}
                                            </div>
                                            <div style={{ fontSize: '13px', color: '#666' }}>
                                                {startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                                {' - '}
                                                {endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                            </div>
                                        </div>
                                        <div style={{ fontSize: '24px' }}>
                                            🔥
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                ) : (
                    <div style={{
                        textAlign: 'center',
                        padding: '40px 20px',
                        color: '#999'
                    }}>
                        <div style={{ fontSize: '48px', marginBottom: '12px' }}>🌙</div>
                        <div>Start reflecting daily to build your first streak!</div>
                    </div>
                )}

                {/* Close Button */}
                <button
                    onClick={() => {
                        triggerHaptic('light');
                        setShowReflectionStreaksModal(false);
                    }}
                    style={{
                        marginTop: '20px',
                        width: '100%',
                        height: '48px',
                        background: '#058585',
                        border: 'none',
                        borderRadius: '8px',
                        color: '#FFFFFF',
                        fontSize: '14px',
                        fontWeight: '400',
                        cursor: 'pointer',
                        transition: 'all 0.2s'
                    }}
                >
                    Back
                </button>
            </div>
        </div>
    </div>
)}
    </div>
);
}
    // Recovery Resources View Component - No Favorites
function ResourcesView({ user, userData, onBack }) {
    const [selectedCategory, setSelectedCategory] = useState(null);
    const [activeTab, setActiveTab] = useState('assigned');
    const [resources, setResources] = useState([]);
    const [allResources, setAllResources] = useState([]);
    const [notes, setNotes] = useState({});
    const [progress, setProgress] = useState({});
    const [searchQuery, setSearchQuery] = useState('');
    const [selectedResource, setSelectedResource] = useState(null);
    const [loading, setLoading] = useState(false);
    const [resourceCounts, setResourceCounts] = useState({});
    const [totalResourceCount, setTotalResourceCount] = useState(0);
    const [newResourceIds, setNewResourceIds] = useState([]);
    const [userNames, setUserNames] = useState({});

    const categories = [
        { id: 'coping', name: 'Coping Skills', icon: 'brain', color: 'var(--color-success)' },
        { id: 'relapse', name: 'Relapse Prevention', icon: 'shield', color: 'var(--color-warning)' },
        { id: 'daily', name: 'Daily Tools', icon: 'calendar-check', color: 'var(--color-info)' },
        { id: 'education', name: 'Education', icon: 'book-open', color: 'var(--color-secondary)' },
        { id: 'support', name: 'Support', icon: 'users', color: 'var(--color-primary)' },
        { id: 'life', name: 'Life Skills', icon: 'sparkles', color: 'var(--color-accent)' }
    ];

    useEffect(() => {
        loadAllResources();
        loadUserPreferences();
    }, [user.uid]);

    useEffect(() => {
        if (allResources.length > 0) {
            checkNewResources();
            loadUserNames();
        }
    }, [allResources]);

    useEffect(() => {
        if (selectedCategory) {
            filterCategoryResources();
        }
    }, [selectedCategory, activeTab, allResources]);

    const loadUserNames = async () => {
        try {
            const uniqueUserIds = [...new Set(allResources.map(r => r.addedBy).filter(Boolean))];
            const names = {};
            
            for (const userId of uniqueUserIds) {
                try {
                    const userDoc = await db.collection('users').doc(userId).get();
                    if (userDoc.exists) {
                        const data = userDoc.data();
                        names[userId] = data.displayName || `${data.firstName} ${data.lastName}` || 'Unknown';
                    }
                } catch (error) {
                    console.error(`Error loading user ${userId}:`, error);
                    names[userId] = 'Unknown';
                }
            }
            
            setUserNames(names);
        } catch (error) {
            console.error('Error loading user names:', error);
        }
    };

    const loadAllResources = async () => {
        try {
            const assignedQuery = await db.collection('resources')
                .where('assignedTo', 'array-contains', user.uid)
                .where('active', '==', true)
                .get();
            
            const globalQuery = await db.collection('resources')
                .where('isGlobal', '==', true)
                .where('active', '==', true)
                .get();

            const resourceMap = new Map();
            
            assignedQuery.forEach(doc => {
                resourceMap.set(doc.id, { 
                    id: doc.id, 
                    ...doc.data(),
                    isAssigned: true 
                });
            });
            
            globalQuery.forEach(doc => {
                if (!resourceMap.has(doc.id)) {
                    resourceMap.set(doc.id, { 
                        id: doc.id, 
                        ...doc.data(),
                        isAssigned: false 
                    });
                }
            });

            const allResourcesList = Array.from(resourceMap.values());
            setAllResources(allResourcesList);
            setTotalResourceCount(allResourcesList.length);
            
            const counts = {};
            categories.forEach(cat => {
                counts[cat.id] = allResourcesList.filter(r => r.category === cat.id).length;
            });
            setResourceCounts(counts);

        } catch (error) {
            console.error('Error loading resources:', error);
        }
    };

    const filterCategoryResources = () => {
        let filtered = allResources.filter(r => r.category === selectedCategory);
        
        if (activeTab === 'assigned') {
            filtered = filtered.filter(r => r.isAssigned);
        } else {
            filtered = filtered.filter(r => !r.isAssigned);
        }
        
        setResources(filtered);
    };

    const checkNewResources = async () => {
        try {
            const lastViewDoc = await db.collection('users').doc(user.uid)
                .collection('preferences').doc('lastResourceView').get();
            
            const lastView = lastViewDoc.exists ? lastViewDoc.data().timestamp : null;
            
            if (lastView && lastView.toDate) {
                const newResources = allResources.filter(r => 
                    r.addedAt && r.addedAt.toDate && r.addedAt.toDate() > lastView.toDate()
                );
                setNewResourceIds(newResources.map(r => r.id));
            }
            
            await db.collection('users').doc(user.uid)
                .collection('preferences').doc('lastResourceView')
                .set({ timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                
        } catch (error) {
            console.error('Error checking new resources:', error);
        }
    };

    const loadUserPreferences = async () => {
        try {
            const prefDoc = await db.collection('users').doc(user.uid)
                .collection('preferences').doc('resources').get();
            
            if (prefDoc.exists) {
                const data = prefDoc.data();
                setNotes(data.notes || {});
                setProgress(data.progress || {});
            }
        } catch (error) {
            console.error('Error loading preferences:', error);
            setNotes({});
            setProgress({});
        }
    };

    const updateProgress = async (resourceId, status) => {
        const newProgress = { 
            ...progress, 
            [resourceId]: {
                status: status,
                updatedAt: new Date().toISOString(),
                completedAt: status === 'completed' ? new Date().toISOString() : progress[resourceId]?.completedAt || null
            }
        };
        setProgress(newProgress);
        
        const saved = await savePreferences({ progress: newProgress });

        if (saved) {
            try {
                await db.collection('activities').add({
                    userId: user.uid,
                    type: 'resource_progress',
                    resourceId: resourceId,
                    status: status,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error('Error tracking activity:', error);
            }
            
            showNotification(`Progress updated to ${status}`, 'success');
        }
    };

    const saveNote = async (resourceId, note) => {
        const newNotes = { ...notes, [resourceId]: note };
        setNotes(newNotes);
        
        const saved = await savePreferences({ notes: newNotes });
        if (saved) {
            showNotification('Note saved', 'success');
        }
    };

    const savePreferences = async (updates) => {
        try {
            const currentPrefs = {
                notes: notes,
                progress: progress,
                ...updates,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection('users').doc(user.uid)
                .collection('preferences').doc('resources')
                .set(currentPrefs, { merge: true });
                
            return true;
        } catch (error) {
            console.error('Error saving preferences:', error);
            showNotification('Failed to save - check permissions', 'error');
            return false;
        }
    };

    const recordView = async (resourceId) => {
        try {
            await db.collection('users').doc(user.uid)
                .collection('resourceViews').doc(resourceId)
                .set({
                    viewedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
        } catch (error) {
            console.error('Error recording view:', error);
        }
    };

    const showNotification = (message, type) => {
        const existingToast = document.querySelector('.resource-toast');
        if (existingToast) {
            existingToast.remove();
        }
        
        const toast = document.createElement('div');
        toast.className = 'resource-toast';
        toast.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: ${type === 'success' ? '#4CAF50' : '#f44336'};
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        `;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 300);
        }, 3000);
    };

    const getFilteredResources = () => {
        if (!searchQuery) return resources;
        
        return resources.filter(resource => 
            resource.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
            resource.description?.toLowerCase().includes(searchQuery.toLowerCase()) ||
            resource.category.toLowerCase().includes(searchQuery.toLowerCase())
        );
    };

    const handleResourceClick = async (resource) => {
        if (!resource || !resource.id) {
            console.error('Invalid resource clicked');
            return;
        }
        
        let completeResource = resource;
        if (!resource.category || !resource.title) {
            completeResource = allResources.find(r => r.id === resource.id) || resource;
        }
        
        setSelectedResource(completeResource);
        
        try {
            await recordView(resource.id);
        } catch (error) {
            console.error('Error recording view:', error);
        }
    };

    // Category Selection View
    if (!selectedCategory) {
        return (
            <div style={{
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                minHeight: '100vh',
                padding: '20px'
            }}>
                <style>{`
                    @keyframes slideIn {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    @keyframes slideOut {
                        from {
                            transform: translateX(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                    }
                `}</style>

                <div style={{
                    background: 'rgba(255,255,255,0.1)',
                    backdropFilter: 'blur(10px)',
                    borderRadius: '20px',
                    padding: '20px',
                    marginBottom: '30px'
                }}>
                    <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        marginBottom: '20px'
                    }}>
                        <button 
                            onClick={onBack}
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                border: 'none',
                                color: 'white',
                                fontSize: '24px',
                                cursor: 'pointer',
                                padding: '10px',
                                borderRadius: '10px',
                                transition: 'all 0.3s'
                            }}
                        >
                            ←
                        </button>
                        <div style={{ flex: 1, textAlign: 'center' }}>
                            <h2 style={{ margin: 0, color: 'white' }}>Recovery Resources</h2>
                            <p style={{ 
                                margin: '5px 0 0 0', 
                                color: 'rgba(255,255,255,0.8)',
                                fontSize: '14px'
                            }}>
                                {totalResourceCount} resources available
                            </p>
                        </div>
                    </div>

                    <div style={{ position: 'relative' }}>
                        <input 
                            type="text"
                            placeholder="Search all resources..."
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '15px 20px 15px 50px',
                                background: 'rgba(255,255,255,0.9)',
                                border: 'none',
                                borderRadius: '15px',
                                fontSize: '16px',
                                outline: 'none',
                                transition: 'all 0.3s'
                            }}
                        />
                        <span style={{
                            position: 'absolute',
                            left: '20px',
                            top: '50%',
                            transform: 'translateY(-50%)',
                            fontSize: '20px'
                        }}>
                            <i data-lucide="search" style={{width: '18px', height: '18px'}}></i>
                        </span>
                    </div>
                </div>

                {searchQuery && (
                    <div style={{
                        background: 'rgba(255,255,255,0.95)',
                        borderRadius: '20px',
                        padding: '20px',
                        marginBottom: '20px'
                    }}>
                        <h3 style={{ margin: '0 0 15px 0' }}>
                            Search Results ({allResources.filter(r => 
                                r.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
                                r.description?.toLowerCase().includes(searchQuery.toLowerCase())
                            ).length})
                        </h3>
                        <div style={{ maxHeight: '300px', overflowY: 'auto' }}>
                            {allResources
                                .filter(r => 
                                    r.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
                                    r.description?.toLowerCase().includes(searchQuery.toLowerCase())
                                )
                                .map(resource => (
                                    <div 
                                        key={resource.id}
                                        onClick={() => handleResourceClick(resource)}
                                        style={{
                                            padding: '10px',
                                            marginBottom: '10px',
                                            background: 'rgba(103,58,183,0.05)',
                                            borderRadius: '10px',
                                            cursor: 'pointer',
                                            transition: 'all 0.3s'
                                        }}
                                    >
                                        <div style={{ fontWeight: 'bold' }}>{resource.title}</div>
                                        <div style={{ fontSize: '12px', color: '#666' }}>
                                            {categories.find(c => c.id === resource.category)?.name}
                                        </div>
                                    </div>
                            ))}
                        </div>
                    </div>
                )}

                <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(2, 1fr)',
                    gap: '15px',
                    marginBottom: '30px'
                }}>
                    {categories.map(category => (
                        <button
                            key={category.id}
                            onClick={() => setSelectedCategory(category.id)}
                            style={{
                                background: 'rgba(255,255,255,0.95)',
                                border: 'none',
                                borderRadius: '20px',
                                padding: '25px',
                                cursor: 'pointer',
                                transition: 'all 0.3s',
                                position: 'relative',
                                overflow: 'hidden'
                            }}
                        >
                            {newResourceIds.some(id => 
                                allResources.find(r => r.id === id && r.category === category.id)
                            ) && (
                                <span style={{
                                    position: 'absolute',
                                    top: '10px',
                                    right: '10px',
                                    background: '#ff4444',
                                    color: 'white',
                                    padding: '2px 8px',
                                    borderRadius: '10px',
                                    fontSize: '10px',
                                    fontWeight: 'bold'
                                }}>
                                    NEW
                                </span>
                            )}
                            
                            <div style={{
                                width: '64px',
                                height: '64px',
                                background: `linear-gradient(135deg, ${category.color}, ${category.color}cc)`,
                                borderRadius: 'var(--radius-lg)',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                margin: '0 auto var(--space-3)',
                                boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
                            }}>
                                <i data-lucide={category.icon} style={{width: '32px', height: '32px', color: '#fff'}}></i>
                            </div>
                            <div style={{
                                fontSize: '16px',
                                fontWeight: 'bold',
                                color: '#333',
                                marginBottom: '5px'
                            }}>
                                {category.name}
                            </div>
                            <div style={{
                                fontSize: '14px',
                                color: category.color,
                                fontWeight: 'bold'
                            }}>
                                {resourceCounts[category.id] || 0} resources
                            </div>
                        </button>
                    ))}
                </div>
            </div>
        );
    }

    // Resource List View
    if (!selectedResource) {
        const category = categories.find(c => c.id === selectedCategory);
        const filteredResources = getFilteredResources();
        
        return (
            <div style={{
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                minHeight: '100vh',
                padding: '20px'
            }}>
                <div style={{
                    background: 'rgba(255,255,255,0.1)',
                    backdropFilter: 'blur(10px)',
                    borderRadius: '20px',
                    padding: '20px',
                    marginBottom: '20px'
                }}>
                    <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        marginBottom: '20px'
                    }}>
                        <button 
                            onClick={() => setSelectedCategory(null)}
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                border: 'none',
                                color: 'white',
                                fontSize: '24px',
                                cursor: 'pointer',
                                padding: '10px',
                                borderRadius: '10px'
                            }}
                        >
                            ←
                        </button>
                        <div style={{ flex: 1, textAlign: 'center' }}>
                            <h2 style={{ margin: 0, color: 'white' }}>
                                {category?.icon} {category?.name}
                            </h2>
                            <p style={{ 
                                margin: '5px 0 0 0', 
                                color: 'rgba(255,255,255,0.8)',
                                fontSize: '14px'
                            }}>
                                {filteredResources.length} resources
                            </p>
                        </div>
                    </div>

                    <div style={{
                        display: 'flex',
                        background: 'rgba(255,255,255,0.2)',
                        borderRadius: '15px',
                        padding: '5px'
                    }}>
                        <button
                            onClick={() => setActiveTab('assigned')}
                            style={{
                                flex: 1,
                                padding: '12px',
                                background: activeTab === 'assigned' ? 'white' : 'transparent',
                                color: activeTab === 'assigned' ? '#764ba2' : 'white',
                                border: 'none',
                                borderRadius: '10px',
                                cursor: 'pointer',
                                fontWeight: 'bold',
                                transition: 'all 0.3s'
                            }}
                        >
                            Assigned ({resources.filter(r => r.isAssigned).length})
                        </button>
                        <button
                            onClick={() => setActiveTab('global')}
                            style={{
                                flex: 1,
                                padding: '12px',
                                background: activeTab === 'global' ? 'white' : 'transparent',
                                color: activeTab === 'global' ? '#764ba2' : 'white',
                                border: 'none',
                                borderRadius: '10px',
                                cursor: 'pointer',
                                fontWeight: 'bold',
                                transition: 'all 0.3s'
                            }}
                        >
                            Global ({resources.filter(r => !r.isAssigned).length})
                        </button>
                    </div>
                </div>

                {loading ? (
                    <div style={{
                        textAlign: 'center',
                        color: 'white',
                        padding: '40px'
                    }}>
                        Loading resources...
                    </div>
                ) : filteredResources.length === 0 ? (
                    <div style={{
                        textAlign: 'center',
                        color: 'rgba(255,255,255,0.8)',
                        padding: '40px',
                        background: 'rgba(255,255,255,0.1)',
                        borderRadius: '20px'
                    }}>
                        No resources found.
                    </div>
                ) : (
                    <div style={{
                        display: 'flex',
                        flexDirection: 'column',
                        gap: '15px'
                    }}>
                        {filteredResources.map(resource => (
                            <div 
                                key={resource.id}
                                style={{
                                    background: 'rgba(255,255,255,0.95)',
                                    borderRadius: '20px',
                                    padding: '20px',
                                    position: 'relative',
                                    transition: 'all 0.3s',
                                    cursor: 'pointer'
                                }}
                                onClick={() => handleResourceClick(resource)}
                            >
                                {newResourceIds.includes(resource.id) && (
                                    <span style={{
                                        position: 'absolute',
                                        top: '10px',
                                        right: '10px',
                                        background: '#ff4444',
                                        color: 'white',
                                        padding: '4px 10px',
                                        borderRadius: '10px',
                                        fontSize: '11px',
                                        fontWeight: 'bold'
                                    }}>
                                        NEW
                                    </span>
                                )}

                                <div style={{
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'flex-start'
                                }}>
                                    <div style={{ flex: 1 }}>
                                        <h4 style={{
                                            color: '#333',
                                            margin: '0 0 8px 0',
                                            fontSize: '18px'
                                        }}>
                                            {resource.title}
                                        </h4>
                                        {resource.description && (
                                            <p style={{
                                                color: '#666',
                                                fontSize: '14px',
                                                margin: '0 0 15px 0',
                                                lineHeight: '1.5'
                                            }}>
                                                {resource.description}
                                            </p>
                                        )}
                                        
                                        <div style={{
                                            display: 'flex',
                                            gap: '10px',
                                            flexWrap: 'wrap',
                                            marginBottom: '15px'
                                        }}>
                                            <span style={{
                                                background: progress[resource.id]?.status === 'completed' 
                                                    ? 'linear-gradient(135deg, #4CAF50, #45a049)'
                                                    : progress[resource.id]?.status === 'in-progress' 
                                                    ? 'linear-gradient(135deg, #ff9800, #f57c00)'
                                                    : 'linear-gradient(135deg, #9e9e9e, #757575)',
                                                color: 'white',
                                                padding: '6px 12px',
                                                borderRadius: '20px',
                                                fontSize: '12px',
                                                fontWeight: 'bold'
                                            }}>
                                                {progress[resource.id]?.status === 'completed' ? '✓ Completed' :
                                                 progress[resource.id]?.status === 'in-progress' ? '⏳ In Progress' :
                                                 '○ Not Started'}
                                            </span>

                                            {resource.addedAt && (
                                                <span style={{
                                                    background: 'rgba(103,58,183,0.1)',
                                                    color: '#673ab7',
                                                    padding: '6px 12px',
                                                    borderRadius: '20px',
                                                    fontSize: '12px'
                                                }}>
                                                    <i data-lucide="calendar" style={{width: '12px', height: '12px', marginRight: '4px'}}></i>
                                                    Added {resource.addedAt.toDate ?
                                                        new Date(resource.addedAt.toDate()).toLocaleDateString() :
                                                        new Date(resource.addedAt).toLocaleDateString()}
                                                </span>
                                            )}

                                            {progress[resource.id]?.completedAt && (
                                                <span style={{
                                                    background: 'rgba(76,175,80,0.1)',
                                                    color: '#4CAF50',
                                                    padding: '6px 12px',
                                                    borderRadius: '20px',
                                                    fontSize: '12px'
                                                }}>
                                                    ✅ Completed {new Date(progress[resource.id].completedAt).toLocaleDateString()}
                                                </span>
                                            )}
                                        </div>

                                        <div style={{
                                            display: 'flex',
                                            gap: '10px',
                                            alignItems: 'center'
                                        }}>
                                            <select
                                                value={progress[resource.id]?.status || 'not-started'}
                                                onChange={(e) => {
                                                    e.stopPropagation();
                                                    updateProgress(resource.id, e.target.value);
                                                }}
                                                onClick={(e) => e.stopPropagation()}
                                                style={{
                                                    padding: '8px 12px',
                                                    background: 'white',
                                                    border: '2px solid #e0e0e0',
                                                    borderRadius: '10px',
                                                    color: '#333',
                                                    cursor: 'pointer',
                                                    fontWeight: '500'
                                                }}
                                            >
                                                <option value="not-started">Not Started</option>
                                                <option value="in-progress">In Progress</option>
                                                <option value="completed">Completed</option>
                                            </select>
                                            
                                            {notes[resource.id] && (
                                                <span style={{
                                                    background: 'rgba(33,150,243,0.1)',
                                                    color: '#2196F3',
                                                    padding: '8px 12px',
                                                    borderRadius: '10px',
                                                    fontSize: '12px',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '5px'
                                                }}>
                                                    <i data-lucide="file-text" style={{width: '14px', height: '14px', marginRight: '4px'}}></i>
                                                    Has notes
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );
    }

    return (
        <ResourceViewer 
            resource={selectedResource}
            onBack={() => setSelectedResource(null)}
            onUpdateNote={(note) => saveNote(selectedResource.id, note)}
            currentNote={notes[selectedResource.id]}
            progress={progress[selectedResource.id]}
            onUpdateProgress={(status) => updateProgress(selectedResource.id, status)}
            userName={userNames[selectedResource.addedBy] || 'Unknown'}
        />
    );
}

// Resource Viewer Component
function ResourceViewer({ resource, onBack, onUpdateNote, currentNote, progress, onUpdateProgress, userName }) {
    const [note, setNote] = useState(currentNote || '');
    const [showNoteInput, setShowNoteInput] = useState(false);

    const handlePrint = () => {
        window.print();
    };

    const handleDownload = async () => {
        if (resource.fileURL) {
            window.open(resource.fileURL, '_blank');
        } else if (resource.content) {
            const blob = new Blob([resource.content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${resource.title}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    };

    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'white',
            zIndex: 9999,
            overflowY: 'auto'
        }}>
            <div style={{
                background: 'linear-gradient(135deg, #9c27b0 0%, #673ab7 100%)',
                padding: '20px',
                position: 'sticky',
                top: 0,
                zIndex: 10
            }}>
                <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between'
                }}>
                    <button 
                        onClick={onBack}
                        style={{
                            background: 'rgba(255,255,255,0.2)',
                            border: 'none',
                            color: 'white',
                            fontSize: '24px',
                            cursor: 'pointer',
                            padding: '5px 10px',
                            borderRadius: '8px'
                        }}
                    >
                        ←
                    </button>
                    <h2 style={{
                        flex: 1,
                        textAlign: 'center',
                        margin: 0,
                        color: 'white',
                        fontSize: '18px'
                    }}>
                        {resource.title}
                    </h2>
                    <div style={{display: 'flex', gap: '10px'}}>
                        <button 
                            onClick={handlePrint}
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                border: 'none',
                                color: 'white',
                                padding: '8px 12px',
                                borderRadius: '8px',
                                cursor: 'pointer'
                            }}
                        >
                            <i data-lucide="printer" style={{width: '18px', height: '18px'}}></i>
                        </button>
                        <button
                            onClick={handleDownload}
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                border: 'none',
                                color: 'white',
                                padding: '8px 12px',
                                borderRadius: '8px',
                                cursor: 'pointer'
                            }}
                        >
                            <i data-lucide="download" style={{width: '18px', height: '18px'}}></i>
                        </button>
                    </div>
                </div>
                
                <div style={{
                    marginTop: '15px',
                    display: 'flex',
                    gap: '10px',
                    alignItems: 'center'
                }}>
                    <span style={{color: 'white', fontSize: '14px'}}>Progress:</span>
                    <select
                        value={progress?.status || 'not-started'}
                        onChange={(e) => onUpdateProgress(e.target.value)}
                        style={{
                            padding: '6px 12px',
                            background: 'rgba(255,255,255,0.9)',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            flex: 1
                        }}
                    >
                        <option value="not-started">Not Started</option>
                        <option value="in-progress">In Progress</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
            </div>

            <div style={{padding: '20px', maxWidth: '800px', margin: '0 auto'}}>
                {resource.content ? (
                    <div style={{
                        fontSize: '16px',
                        lineHeight: '1.8',
                        color: '#333'
                    }}>
                        {resource.content.split('\n').map((paragraph, index) => (
                            <p key={index} style={{marginBottom: '15px'}}>
                                {paragraph}
                            </p>
                        ))}
                    </div>
                ) : resource.embedUrl ? (
                    <iframe 
                        src={resource.embedUrl}
                        style={{
                            width: '100%',
                            height: '600px',
                            border: 'none',
                            borderRadius: '10px'
                        }}
                    />
                ) : (
                    <div style={{
                        padding: '40px',
                        textAlign: 'center',
                        color: '#999'
                    }}>
                        <p>This resource is available externally.</p>
                        <a 
                            href={resource.url}
                            target="_blank"
                            rel="noopener noreferrer"
                            style={{
                                display: 'inline-block',
                                marginTop: '20px',
                                padding: '12px 24px',
                                background: '#9c27b0',
                                color: 'white',
                                borderRadius: '8px',
                                textDecoration: 'none'
                            }}
                        >
                            Open Resource
                        </a>
                    </div>
                )}

                <div style={{
                    marginTop: '40px',
                    padding: '20px',
                    background: '#f5f5f5',
                    borderRadius: '10px'
                }}>
                    <h3 style={{margin: '0 0 15px 0', display: 'flex', alignItems: 'center', gap: '8px'}}>
                        <i data-lucide="file-text" style={{width: '20px', height: '20px'}}></i>
                        Personal Notes
                    </h3>
                    {showNoteInput ? (
                        <div>
                            <textarea 
                                value={note}
                                onChange={(e) => setNote(e.target.value)}
                                placeholder="Add your thoughts, reflections, or key takeaways..."
                                style={{
                                    width: '100%',
                                    minHeight: '100px',
                                    padding: '10px',
                                    border: '1px solid #ddd',
                                    borderRadius: '8px',
                                    fontSize: '14px',
                                    resize: 'vertical'
                                }}
                            />
                            <div style={{marginTop: '10px', display: 'flex', gap: '10px'}}>
                                <button
                                    onClick={() => {
                                        onUpdateNote(note);
                                        setShowNoteInput(false);
                                    }}
                                    style={{
                                        padding: '8px 16px',
                                        background: '#4CAF50',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '8px',
                                        cursor: 'pointer'
                                    }}
                                >
                                    Save Note
                                </button>
                                <button
                                    onClick={() => {
                                        setNote(currentNote || '');
                                        setShowNoteInput(false);
                                    }}
                                    style={{
                                        padding: '8px 16px',
                                        background: '#999',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '8px',
                                        cursor: 'pointer'
                                    }}
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    ) : (
                        <div>
                            {currentNote ? (
                                <div>
                                    <p style={{margin: '0 0 10px 0', whiteSpace: 'pre-wrap'}}>
                                        {currentNote}
                                    </p>
                                    <button
                                        onClick={() => {
                                            setNote(currentNote);
                                            setShowNoteInput(true);
                                        }}
                                        style={{
                                            padding: '8px 16px',
                                            background: '#9c27b0',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '8px',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        Edit Note
                                    </button>
                                </div>
                            ) : (
                                <button
                                    onClick={() => setShowNoteInput(true)}
                                    style={{
                                        padding: '8px 16px',
                                        background: '#9c27b0',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '8px',
                                        cursor: 'pointer'
                                    }}
                                >
                                    Add Note
                                </button>
                            )}
                        </div>
                    )}
                </div>

                <div style={{
                    marginTop: '20px',
                    padding: '15px',
                    background: '#f9f9f9',
                    borderRadius: '10px',
                    fontSize: '14px',
                    color: '#666'
                }}>
                    <div style={{marginBottom: '8px'}}>
                        <strong>Category:</strong> {resource.category}
                    </div>
                    {resource.addedAt && (
                        <div style={{marginBottom: '8px'}}>
                            <strong>Added:</strong> {resource.addedAt.toDate ? 
                                new Date(resource.addedAt.toDate()).toLocaleDateString() :
                                new Date(resource.addedAt).toLocaleDateString()}
                        </div>
                    )}
                    {progress?.completedAt && (
                        <div style={{marginBottom: '8px'}}>
                            <strong>Completed:</strong> {new Date(progress.completedAt).toLocaleDateString()}
                        </div>
                    )}
                    {userName && (
                        <div>
                            <strong>Added by:</strong> {userName}
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
}
     // Goals and Tasks View Component with Popup Details and Reflections - UPDATED
function GoalsTasksView({ user, goals, assignments, onAssignmentComplete, onReflectionSave, onShowGratitudeModal }) {
    const [expandedGoals, setExpandedGoals] = useState({});
    const [expandedAssignments, setExpandedAssignments] = useState({});
    const [reflections, setReflections] = useState({});
    const [objectives, setObjectives] = useState([]);
    const [selectedItem, setSelectedItem] = useState(null);
    const [showModal, setShowModal] = useState(false);
    const [showReflectionForm, setShowReflectionForm] = useState(false);
    const [currentReflection, setCurrentReflection] = useState('');
    
    // Load objectives when component mounts or goals change
    useEffect(() => {
        loadObjectives();
    }, [goals]);
    
    const loadObjectives = async () => {
        try {
            const objectivesSnap = await db.collection('objectives')
                .where('userId', '==', user.uid)
                .orderBy('order', 'asc')
                .get();
            
            const objectivesList = [];
            objectivesSnap.forEach(doc => {
                objectivesList.push({ id: doc.id, ...doc.data() });
            });
            
            setObjectives(objectivesList);
        } catch (error) {
            console.error('Error loading objectives:', error);
        }
    };
    
    const toggleGoal = (goalId) => {
        setExpandedGoals(prev => ({
            ...prev,
            [goalId]: !prev[goalId]
        }));
    };
    
    const openItemModal = (item, type) => {
        setSelectedItem({ ...item, type });
        setShowModal(true);
        setShowReflectionForm(false);
        setCurrentReflection('');
    };
    
    const closeModal = () => {
        setShowModal(false);
        setSelectedItem(null);
        setShowReflectionForm(false);
        setCurrentReflection('');
    };
    
    const calculateGoalProgress = (goalId) => {
        const goalAssignments = assignments.filter(a => a.goalId === goalId);
        if (goalAssignments.length === 0) return 0;
        
        const completed = goalAssignments.filter(a => a.status === 'completed').length;
        return Math.round((completed / goalAssignments.length) * 100);
    };
    
    const formatDate = (date) => {
        if (!date) return 'Not set';
        const dateObj = date.toDate ? date.toDate() : new Date(date);
        return dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    };
    
    const getDueDateStatus = (date, isCompleted) => {
        if (isCompleted) return { text: 'Completed', color: '#4CAF50' };
        if (!date) return { text: 'No due date', color: 'rgba(255,255,255,0.5)' };
        
        const dueDate = date.toDate ? date.toDate() : new Date(date);
        const today = new Date();
        const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
        
        if (diffDays < 0) return { text: 'Overdue', color: '#ff453a' };
        if (diffDays === 0) return { text: 'Due Today', color: '#ff9500' };
        if (diffDays === 1) return { text: 'Due Tomorrow', color: '#ff9500' };
        if (diffDays <= 7) return { text: `Due in ${diffDays} days`, color: '#ffd60a' };
        return { text: formatDate(date), color: 'rgba(255,255,255,0.7)' };
    };
    
    const makeLinksClickable = (text) => {
        if (!text) return null;
        
        // Regex to detect URLs
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        const parts = text.split(urlRegex);
        
        return parts.map((part, index) => {
            if (part.match(urlRegex)) {
                return (
                    <a 
                        key={index}
                        href={part} 
                        target="_blank" 
                        rel="noopener noreferrer"
                        style={{
                            color: '#4fc3f7',
                            textDecoration: 'underline'
                        }}
                    >
                        {part}
                    </a>
                );
            }
            return <span key={index}>{part}</span>;
        });
    };
    
    // Modal Component with Reflection Support
    const ItemModal = () => {
        if (!selectedItem || !showModal) return null;
        
        const isCompleted = selectedItem.status === 'completed';
        const typeColors = {
            objective: 'linear-gradient(135deg, #f4c430 0%, #ffa500 100%)',
            assignment: 'linear-gradient(135deg, #9c27b0 0%, #673ab7 100%)'
        };
        
        return (
            <div style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0,0,0,0.8)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 9999,
                padding: '20px'
            }}>
                <div style={{
                    background: '#1a1a1a',
                    borderRadius: '15px',
                    maxWidth: '600px',
                    width: '100%',
                    maxHeight: '80vh',
                    overflow: 'auto',
                    position: 'relative',
                    border: '1px solid rgba(255,255,255,0.1)'
                }}>
                    {/* Header */}
                    <div style={{
                        padding: '20px',
                        borderBottom: '1px solid rgba(255,255,255,0.1)',
                        background: typeColors[selectedItem.type]
                    }}>
                        <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'space-between'
                        }}>
                            <div style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '12px'
                            }}>
                                <span style={{
                                    background: 'rgba(0,0,0,0.3)',
                                    padding: '4px 10px',
                                    borderRadius: '6px',
                                    fontSize: '11px',
                                    fontWeight: 'bold',
                                    letterSpacing: '0.5px',
                                    color: 'white'
                                }}>
                                    {selectedItem.type.toUpperCase()}
                                </span>
                                {isCompleted && <span>✅</span>}
                            </div>
                            <button
                                onClick={closeModal}
                                style={{
                                    background: 'rgba(255,255,255,0.2)',
                                    border: 'none',
                                    borderRadius: '50%',
                                    width: '30px',
                                    height: '30px',
                                    cursor: 'pointer',
                                    color: 'white',
                                    fontSize: '18px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center'
                                }}
                            >
                                ×
                            </button>
                        </div>
                        <h3 style={{
                            color: 'white',
                            margin: '10px 0 0 0',
                            fontSize: '20px',
                            textDecoration: isCompleted ? 'line-through' : 'none'
                        }}>
                            {selectedItem.title}
                        </h3>
                    </div>
                    
                    {/* Body */}
                    <div style={{ padding: '20px' }}>
                        {/* Description */}
                        {selectedItem.description && (
                            <div style={{
                                marginBottom: '20px'
                            }}>
                                <h4 style={{
                                    color: 'rgba(255,255,255,0.7)',
                                    fontSize: '12px',
                                    marginBottom: '8px',
                                    textTransform: 'uppercase',
                                    letterSpacing: '1px'
                                }}>
                                    Description
                                </h4>
                                <div style={{
                                    color: 'white',
                                    fontSize: '14px',
                                    lineHeight: '1.6',
                                    background: 'rgba(255,255,255,0.05)',
                                    padding: '12px',
                                    borderRadius: '8px'
                                }}>
                                    {makeLinksClickable(selectedItem.description)}
                                </div>
                            </div>
                        )}
                        
                        {/* Dates */}
                        <div style={{
                            display: 'flex',
                            flexDirection: 'column',
                            gap: '10px',
                            marginBottom: '20px'
                        }}>
                            <div style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px',
                                color: 'rgba(255,255,255,0.7)',
                                fontSize: '13px'
                            }}>
                                <i data-lucide="calendar" style={{width: '14px', height: '14px'}}></i>
                                <span>Created:</span>
                                <span style={{ color: 'white' }}>
                                    {formatDate(selectedItem.createdAt)}
                                </span>
                            </div>
                            
                            {selectedItem.dueDate && (
                                <div style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '10px',
                                    color: 'rgba(255,255,255,0.7)',
                                    fontSize: '13px'
                                }}>
                                    <span>⏰</span>
                                    <span>Due:</span>
                                    <span style={{ 
                                        color: getDueDateStatus(selectedItem.dueDate, isCompleted).color 
                                    }}>
                                        {formatDate(selectedItem.dueDate)}
                                    </span>
                                </div>
                            )}
                            
                            {selectedItem.completedAt && (
                                <div style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '10px',
                                    color: '#4CAF50',
                                    fontSize: '13px'
                                }}>
                                    <span>✓</span>
                                    <span>Completed:</span>
                                    <span>{formatDate(selectedItem.completedAt)}</span>
                                </div>
                            )}
                        </div>
                        
                        {/* Status */}
                        <div style={{
                            padding: '10px',
                            background: isCompleted ? 
                                'rgba(76,175,80,0.1)' : 
                                'rgba(255,152,0,0.1)',
                            borderRadius: '8px',
                            border: `1px solid ${isCompleted ? 
                                'rgba(76,175,80,0.3)' : 
                                'rgba(255,152,0,0.3)'}`,
                            marginBottom: '20px'
                        }}>
                            <span style={{
                                color: isCompleted ? '#4CAF50' : '#ff9800',
                                fontSize: '13px',
                                fontWeight: '500'
                            }}>
                                Status: {isCompleted ? 'Completed' : 'Active'}
                            </span>
                        </div>
                        
                        {/* Existing Reflection */}
                        {selectedItem.reflection && (
                            <div style={{
                                marginTop: '15px',
                                padding: '12px',
                                background: 'rgba(76,175,80,0.1)',
                                borderRadius: '8px',
                                borderLeft: '3px solid #4CAF50'
                            }}>
                                <h4 style={{
                                    color: '#4CAF50',
                                    fontSize: '12px',
                                    marginBottom: '8px',
                                    textTransform: 'uppercase',
                                    letterSpacing: '1px'
                                }}>
                                    Your Reflection
                                </h4>
                                <p style={{
                                    color: 'rgba(255,255,255,0.9)',
                                    fontSize: '13px',
                                    margin: 0,
                                    lineHeight: '1.6'
                                }}>
                                    {selectedItem.reflection}
                                </p>
                            </div>
                        )}
                        
                        {/* Reflection Form for Incomplete Assignments */}
                        {selectedItem.type === 'assignment' && !isCompleted && showReflectionForm && (
                            <div style={{
                                marginTop: '20px',
                                padding: '15px',
                                background: 'rgba(255,255,255,0.05)',
                                borderRadius: '8px',
                                border: '1px solid rgba(255,255,255,0.1)'
                            }}>
                                <label style={{
                                    color: 'white',
                                    fontSize: '14px',
                                    display: 'block',
                                    marginBottom: '10px',
                                    fontWeight: '500'
                                }}>
                                    Add your reflection:
                                </label>
                                <textarea 
                                    value={currentReflection}
                                    onChange={(e) => setCurrentReflection(e.target.value)}
                                    placeholder="What did you learn? How did this help your recovery?"
                                    style={{
                                        width: '100%',
                                        minHeight: '100px',
                                        padding: '10px',
                                        background: 'rgba(0,0,0,0.3)',
                                        border: '1px solid rgba(255,255,255,0.2)',
                                        borderRadius: '6px',
                                        color: 'white',
                                        fontSize: '14px',
                                        resize: 'vertical'
                                    }}
                                    autoFocus
                                />
                                <div style={{
                                    marginTop: '12px',
                                    display: 'flex',
                                    gap: '10px'
                                }}>
                                    <button
                                        onClick={() => {
                                            onReflectionSave(selectedItem.id, currentReflection);
                                            closeModal();
                                        }}
                                        style={{
                                            flex: 1,
                                            padding: '10px',
                                            background: '#4CAF50',
                                            border: 'none',
                                            borderRadius: '6px',
                                            color: 'white',
                                            cursor: 'pointer',
                                            fontWeight: '500',
                                            fontSize: '14px'
                                        }}
                                    >
                                        Submit Reflection & Complete
                                    </button>
                                    <button
                                        onClick={() => {
                                            setShowReflectionForm(false);
                                            setCurrentReflection('');
                                        }}
                                        style={{
                                            padding: '10px 20px',
                                            background: 'rgba(255,255,255,0.1)',
                                            border: '1px solid rgba(255,255,255,0.2)',
                                            borderRadius: '6px',
                                            color: 'white',
                                            cursor: 'pointer',
                                            fontSize: '14px'
                                        }}
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        )}
                        
                        {/* Action buttons for assignments */}
                        {selectedItem.type === 'assignment' && !isCompleted && (
                            <div style={{
                                marginTop: '20px',
                                display: 'flex',
                                gap: '10px'
                            }}>
                                {!showReflectionForm && (
                                    <>
                                        <button
                                            onClick={() => setShowReflectionForm(true)}
                                            style={{
                                                flex: 1,
                                                padding: '12px',
                                                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                                border: 'none',
                                                borderRadius: '8px',
                                                color: 'white',
                                                cursor: 'pointer',
                                                fontWeight: '500',
                                                fontSize: '14px'
                                            }}
                                        >
                                            Complete with Reflection
                                        </button>
                                        <button
                                            onClick={() => {
                                                onAssignmentComplete(selectedItem.id, true);
                                                closeModal();
                                            }}
                                            style={{
                                                flex: 1,
                                                padding: '12px',
                                                background: '#4CAF50',
                                                border: 'none',
                                                borderRadius: '8px',
                                                color: 'white',
                                                cursor: 'pointer',
                                                fontWeight: '500',
                                                fontSize: '14px'
                                            }}
                                        >
                                            Mark Complete Only
                                        </button>
                                    </>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );
    };
    
    if (goals.length === 0) {
        return (
            <div style={{
                textAlign: 'center',
                color: 'rgba(255,255,255,0.6)',
                padding: '40px'
            }}>
                <div style={{marginBottom: 'var(--space-4)'}}>
                    <i data-lucide="target" style={{width: '48px', height: '48px', color: 'var(--color-primary)'}}></i>
                </div>
                <p>No goals assigned yet.</p>
                <p style={{fontSize: '14px', marginTop: '10px'}}>
                    Your coach will create goals for your recovery journey.
                </p>
            </div>
        );
    }
    
    // Calculate summary stats
    const activeGoals = goals.filter(g => g.status !== 'completed').length;
    const activeObjectives = objectives.filter(o => o.status !== 'completed').length;
    const activeAssignments = assignments.filter(a => a.status !== 'completed').length;
    const totalAssignments = assignments.length;
    const completedAssignments = assignments.filter(a => a.status === 'completed').length;
    const completionRate = totalAssignments > 0 ? Math.round((completedAssignments / totalAssignments) * 100) : 0;

    return (
        <>
            {/* Compact Golden Thread Overview */}
            <div style={{
                padding: '12px 5%',
                maxWidth: '600px',
                margin: '16px auto'
            }}>
                <div style={{
                    background: '#FFFFFF',
                    borderRadius: '12px',
                    padding: '12px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                }}>
                    <div style={{
                        fontSize: '14px',
                        fontWeight: 'bold',
                        color: '#000000',
                        marginBottom: '8px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                    }}>
                        <i data-lucide="sparkles" style={{ width: '16px', height: '16px', color: '#058585' }}></i>
                        Golden Thread Overview
                    </div>
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(2, 1fr)',
                        gap: '8px'
                    }}>
                        <div style={{
                            fontSize: '12px',
                            color: '#666666',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px'
                        }}>
                            <span style={{ fontSize: '16px', fontWeight: 'bold', color: '#058585' }}>{activeGoals}</span>
                            Active Goals
                        </div>
                        <div style={{
                            fontSize: '12px',
                            color: '#666666',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px'
                        }}>
                            <span style={{ fontSize: '16px', fontWeight: 'bold', color: '#058585' }}>{activeAssignments}</span>
                            Active Tasks
                        </div>
                        <div style={{
                            fontSize: '12px',
                            color: '#666666',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px'
                        }}>
                            <span style={{ fontSize: '16px', fontWeight: 'bold', color: '#4CAF50' }}>{completionRate}%</span>
                            Completion
                        </div>
                        <div style={{
                            fontSize: '12px',
                            color: '#666666',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px'
                        }}>
                            <span style={{ fontSize: '16px', fontWeight: 'bold', color: '#058585' }}>{activeObjectives}</span>
                            Objectives
                        </div>
                    </div>
                </div>
            </div>

            <div style={{padding: '0 20px'}}>
                {goals.map(goal => {
                    const goalObjectives = objectives.filter(o => o.goalId === goal.id);
                    const goalProgress = calculateGoalProgress(goal.id);
                    const isExpanded = expandedGoals[goal.id];
                    const isGoalCompleted = goal.status === 'completed';
                    const dueDateStatus = getDueDateStatus(goal.dueDate, isGoalCompleted);
                    
                    return (
                        <div key={goal.id} style={{
                            background: isGoalCompleted ? 'rgba(76,175,80,0.08)' : 'rgba(255,255,255,0.05)',
                            borderRadius: '15px',
                            marginBottom: '20px',
                            overflow: 'hidden',
                            border: isGoalCompleted ? '1px solid rgba(76,175,80,0.3)' : '1px solid rgba(255,255,255,0.1)'
                        }}>
                            {/* Goal Header */}
                            <div 
                                onClick={() => toggleGoal(goal.id)}
                                style={{
                                    padding: '20px',
                                    cursor: 'pointer',
                                    borderBottom: isExpanded ? '1px solid rgba(255,255,255,0.1)' : 'none'
                                }}
                            >
                                {/* Type Label and Title */}
                                <div style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'space-between',
                                    marginBottom: '12px'
                                }}>
                                    <h3 style={{
                                        color: isGoalCompleted ? '#4CAF50' : 'white',
                                        margin: 0,
                                        fontSize: '18px',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '12px',
                                        textDecoration: isGoalCompleted ? 'line-through' : 'none'
                                    }}>
                                        <span style={{
                                            transform: isExpanded ? 'rotate(90deg)' : 'rotate(0)',
                                            transition: 'transform 0.3s',
                                            fontSize: '14px'
                                        }}>
                                            ▶
                                        </span>
                                        <span style={{
                                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                            padding: '4px 10px',
                                            borderRadius: '6px',
                                            fontSize: '11px',
                                            fontWeight: 'bold',
                                            letterSpacing: '0.5px'
                                        }}>
                                            GOAL
                                        </span>
                                        {goal.title}
                                        {isGoalCompleted && <span style={{color: '#4CAF50'}}>✅</span>}
                                    </h3>
                                    <span style={{
                                        color: dueDateStatus.color,
                                        fontSize: '13px',
                                        fontWeight: '500'
                                    }}>
                                        {dueDateStatus.text}
                                    </span>
                                </div>

                                {/* Goal Description - Now displayed here */}
                                {goal.description && (
                                    <div style={{
                                        color: 'rgba(255,255,255,0.8)',
                                        fontSize: '14px',
                                        marginBottom: '12px',
                                        paddingLeft: '26px',
                                        lineHeight: '1.5'
                                    }}>
                                        {makeLinksClickable(goal.description)}
                                    </div>
                                )}

                                {/* Date Information - After description */}
                                <div style={{
                                    display: 'flex',
                                    gap: '20px',
                                    marginBottom: '12px',
                                    paddingLeft: '26px'
                                }}>
                                    <span style={{
                                        color: 'rgba(255,255,255,0.5)',
                                        fontSize: '12px'
                                    }}>
                                        <i data-lucide="calendar" style={{width: '12px', height: '12px', marginRight: '4px'}}></i>
                                        Created: {formatDate(goal.createdAt)}
                                    </span>
                                    {goal.dueDate && (
                                        <span style={{
                                            color: 'rgba(255,255,255,0.5)',
                                            fontSize: '12px'
                                        }}>
                                            ⏰ Due: {formatDate(goal.dueDate)}
                                        </span>
                                    )}
                                    {goal.completedAt && (
                                        <span style={{
                                            color: '#4CAF50',
                                            fontSize: '12px'
                                        }}>
                                            ✓ Completed: {formatDate(goal.completedAt)}
                                        </span>
                                    )}
                                </div>
                                
                                {/* Progress Bar */}
                                <div style={{
                                    paddingLeft: '26px'
                                }}>
                                    <div style={{
                                        background: 'rgba(255,255,255,0.1)',
                                        borderRadius: '10px',
                                        height: '8px',
                                        overflow: 'hidden'
                                    }}>
                                        <div style={{
                                            background: isGoalCompleted ? 
                                                '#4CAF50' : 
                                                `linear-gradient(90deg, #4CAF50 0%, #45a049 100%)`,
                                            width: `${goalProgress}%`,
                                            height: '100%',
                                            transition: 'width 0.3s ease'
                                        }}/>
                                    </div>
                                    <div style={{
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        marginTop: '5px'
                                    }}>
                                        <span style={{
                                            color: 'rgba(255,255,255,0.6)',
                                            fontSize: '12px'
                                        }}>
                                            {goalProgress}% Complete
                                        </span>
                                        <span style={{
                                            color: 'rgba(255,255,255,0.6)',
                                            fontSize: '12px'
                                        }}>
                                            {goalObjectives.length} Objectives • {assignments.filter(a => a.goalId === goal.id).length} Assignments
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Objectives and Assignments - Simplified list */}
                            {isExpanded && (
                                <div style={{padding: '20px', paddingTop: '0'}}>
                                    {goalObjectives.length === 0 ? (
                                        <p style={{
                                            color: 'rgba(255,255,255,0.6)',
                                            fontSize: '14px',
                                            paddingLeft: '26px'
                                        }}>
                                            No objectives created yet.
                                        </p>
                                    ) : (
                                        goalObjectives.map(objective => {
                                            const objectiveAssignments = assignments.filter(a => a.objectiveId === objective.id);
                                            const isObjectiveCompleted = objective.status === 'completed';
                                            
                                            return (
                                                <div key={objective.id} style={{
                                                    marginTop: '15px',
                                                    paddingLeft: '26px'
                                                }}>
                                                    {/* Objective - Clickable */}
                                                    <div 
                                                        onClick={() => openItemModal(objective, 'objective')}
                                                        style={{
                                                            background: isObjectiveCompleted ? 'rgba(76,175,80,0.05)' : 'rgba(255,255,255,0.03)',
                                                            borderRadius: '10px',
                                                            padding: '12px',
                                                            marginBottom: '10px',
                                                            border: '1px solid rgba(255,255,255,0.08)',
                                                            cursor: 'pointer',
                                                            transition: 'all 0.2s'
                                                        }}
                                                        onMouseEnter={(e) => {
                                                            e.currentTarget.style.background = isObjectiveCompleted ? 
                                                                'rgba(76,175,80,0.08)' : 'rgba(255,255,255,0.06)';
                                                        }}
                                                        onMouseLeave={(e) => {
                                                            e.currentTarget.style.background = isObjectiveCompleted ? 
                                                                'rgba(76,175,80,0.05)' : 'rgba(255,255,255,0.03)';
                                                        }}
                                                    >
                                                        <div style={{
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            justifyContent: 'space-between'
                                                        }}>
                                                            <div style={{
                                                                display: 'flex',
                                                                alignItems: 'center',
                                                                gap: '10px'
                                                            }}>
                                                                <span style={{
                                                                    background: 'linear-gradient(135deg, #f4c430 0%, #ffa500 100%)',
                                                                    padding: '3px 8px',
                                                                    borderRadius: '5px',
                                                                    fontSize: '10px',
                                                                    fontWeight: 'bold',
                                                                    color: '#000',
                                                                    letterSpacing: '0.5px'
                                                                }}>
                                                                    OBJECTIVE
                                                                </span>
                                                                <span style={{
                                                                    color: isObjectiveCompleted ? '#4CAF50' : 'white',
                                                                    fontSize: '14px',
                                                                    textDecoration: isObjectiveCompleted ? 'line-through' : 'none'
                                                                }}>
                                                                    {objective.title}
                                                                </span>
                                                                {isObjectiveCompleted && <span>✅</span>}
                                                            </div>
                                                            <span style={{
                                                                color: 'rgba(255,255,255,0.4)',
                                                                fontSize: '12px'
                                                            }}>
                                                                Click for details →
                                                            </span>
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Assignments under this objective */}
                                                    {objectiveAssignments.map(assignment => {
                                                        const isAssignmentCompleted = assignment.status === 'completed';
                                                        
                                                        return (
                                                            <div key={assignment.id} style={{
                                                                display: 'flex',
                                                                alignItems: 'center',
                                                                gap: '10px',
                                                                marginLeft: '20px',
                                                                marginBottom: '8px'
                                                            }}>
                                                                {/* Checkbox for completion */}
                                                                <input 
                                                                    type="checkbox"
                                                                    checked={isAssignmentCompleted}
                                                                    onChange={(e) => {
                                                                        onAssignmentComplete(assignment.id, e.target.checked);
                                                                    }}
                                                                    style={{
                                                                        width: '18px',
                                                                        height: '18px',
                                                                        cursor: 'pointer'
                                                                    }}
                                                                />
                                                                
                                                                {/* Assignment - Clickable */}
                                                                <div 
                                                                    onClick={() => openItemModal(assignment, 'assignment')}
                                                                    style={{
                                                                        flex: 1,
                                                                        background: isAssignmentCompleted ? 
                                                                            'rgba(76,175,80,0.08)' : 
                                                                            'rgba(255,255,255,0.02)',
                                                                        borderRadius: '8px',
                                                                        padding: '10px',
                                                                        border: isAssignmentCompleted ? 
                                                                            '1px solid rgba(76,175,80,0.2)' : 
                                                                            '1px solid rgba(255,255,255,0.06)',
                                                                        cursor: 'pointer',
                                                                        transition: 'all 0.2s'
                                                                    }}
                                                                    onMouseEnter={(e) => {
                                                                        e.currentTarget.style.background = isAssignmentCompleted ? 
                                                                            'rgba(76,175,80,0.1)' : 'rgba(255,255,255,0.04)';
                                                                    }}
                                                                    onMouseLeave={(e) => {
                                                                        e.currentTarget.style.background = isAssignmentCompleted ? 
                                                                            'rgba(76,175,80,0.08)' : 'rgba(255,255,255,0.02)';
                                                                    }}
                                                                >
                                                                    <div style={{
                                                                        display: 'flex',
                                                                        alignItems: 'center',
                                                                        justifyContent: 'space-between'
                                                                    }}>
                                                                        <div style={{
                                                                            display: 'flex',
                                                                            alignItems: 'center',
                                                                            gap: '8px'
                                                                        }}>
                                                                            <span style={{
                                                                                background: 'linear-gradient(135deg, #9c27b0 0%, #673ab7 100%)',
                                                                                padding: '2px 7px',
                                                                                borderRadius: '4px',
                                                                                fontSize: '9px',
                                                                                fontWeight: 'bold',
                                                                                letterSpacing: '0.5px'
                                                                            }}>
                                                                                ASSIGNMENT
                                                                            </span>
                                                                            <span style={{
                                                                                color: isAssignmentCompleted ? 
                                                                                    'rgba(255,255,255,0.5)' : 'white',
                                                                                fontSize: '13px',
                                                                                textDecoration: isAssignmentCompleted ? 
                                                                                    'line-through' : 'none'
                                                                            }}>
                                                                                {assignment.title}
                                                                            </span>
                                                                            {isAssignmentCompleted && <span>✅</span>}
                                                                        </div>
                                                                        <span style={{
                                                                            color: 'rgba(255,255,255,0.3)',
                                                                            fontSize: '11px'
                                                                        }}>
                                                                            Click for details →
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            );
                                        })
                                    )}
                                </div>
                            )}
                        </div>
                    );
                })}
            </div>

            {/* 6 Golden Thread Cards */}
            <div style={{
                padding: '0 5%',
                maxWidth: '600px',
                margin: '0 auto 20px'
            }}>
                <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(2, 1fr)',
                    gap: '12px'
                }}>
                    {/* Card 1: Active Goals */}
                    <div style={{
                        background: '#FFFFFF',
                        borderRadius: '12px',
                        padding: '16px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                        cursor: 'pointer',
                        transition: 'transform 0.2s',
                        border: '1px solid #E5E5E5'
                    }}
                    onClick={() => {
                        triggerHaptic('light');
                        alert(`Active Goals: ${activeGoals}\n\nThese are your currently active recovery goals. Click on any goal below to view details and progress.`);
                    }}>
                        <i data-lucide="target" style={{ width: '24px', height: '24px', color: '#058585', marginBottom: '8px' }}></i>
                        <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#058585' }}>
                            {activeGoals}
                        </div>
                        <div style={{ fontSize: '12px', color: '#666666', marginTop: '4px' }}>
                            Active Goals
                        </div>
                    </div>

                    {/* Card 2: Active Objectives */}
                    <div style={{
                        background: '#FFFFFF',
                        borderRadius: '12px',
                        padding: '16px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                        cursor: 'pointer',
                        transition: 'transform 0.2s',
                        border: '1px solid #E5E5E5'
                    }}
                    onClick={() => {
                        triggerHaptic('light');
                        alert(`Active Objectives: ${activeObjectives}\n\nThese are the steps you're working on to achieve your goals. Each objective brings you closer to completing a goal.`);
                    }}>
                        <i data-lucide="list-checks" style={{ width: '24px', height: '24px', color: '#FFB84D', marginBottom: '8px' }}></i>
                        <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#FFB84D' }}>
                            {activeObjectives}
                        </div>
                        <div style={{ fontSize: '12px', color: '#666666', marginTop: '4px' }}>
                            Objectives
                        </div>
                    </div>

                    {/* Card 3: Active Assignments */}
                    <div style={{
                        background: '#FFFFFF',
                        borderRadius: '12px',
                        padding: '16px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                        cursor: 'pointer',
                        transition: 'transform 0.2s',
                        border: '1px solid #E5E5E5'
                    }}
                    onClick={() => {
                        triggerHaptic('light');
                        const activeList = assignments.filter(a => a.status !== 'completed').map(a => `• ${a.title}`).join('\n');
                        alert(`Active Assignments: ${activeAssignments}\n\n${activeList || 'No active assignments'}`);
                    }}>
                        <i data-lucide="clipboard-list" style={{ width: '24px', height: '24px', color: '#9B59B6', marginBottom: '8px' }}></i>
                        <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#9B59B6' }}>
                            {activeAssignments}
                        </div>
                        <div style={{ fontSize: '12px', color: '#666666', marginTop: '4px' }}>
                            Active Tasks
                        </div>
                    </div>

                    {/* Card 4: This Week's Priority Tasks */}
                    <div style={{
                        background: '#FFFFFF',
                        borderRadius: '12px',
                        padding: '16px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                        cursor: 'pointer',
                        transition: 'transform 0.2s',
                        border: '1px solid #E5E5E5'
                    }}
                    onClick={() => {
                        triggerHaptic('light');
                        const today = new Date();
                        const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
                        const thisWeekTasks = assignments.filter(a => {
                            if (a.status === 'completed' || !a.dueDate) return false;
                            const dueDate = a.dueDate.toDate ? a.dueDate.toDate() : new Date(a.dueDate);
                            return dueDate >= today && dueDate <= weekFromNow;
                        });
                        const taskList = thisWeekTasks.map(t => `• ${t.title}`).join('\n');
                        alert(`This Week's Tasks: ${thisWeekTasks.length}\n\n${taskList || 'No tasks due this week'}`);
                    }}>
                        <i data-lucide="calendar-clock" style={{ width: '24px', height: '24px', color: '#E74C3C', marginBottom: '8px' }}></i>
                        <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#E74C3C' }}>
                            {(() => {
                                const today = new Date();
                                const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
                                return assignments.filter(a => {
                                    if (a.status === 'completed' || !a.dueDate) return false;
                                    const dueDate = a.dueDate.toDate ? a.dueDate.toDate() : new Date(a.dueDate);
                                    return dueDate >= today && dueDate <= weekFromNow;
                                }).length;
                            })()}
                        </div>
                        <div style={{ fontSize: '12px', color: '#666666', marginTop: '4px' }}>
                            Due This Week
                        </div>
                    </div>

                    {/* Card 5: Assignment Completion Rate */}
                    <div style={{
                        background: '#FFFFFF',
                        borderRadius: '12px',
                        padding: '16px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                        cursor: 'pointer',
                        transition: 'transform 0.2s',
                        border: '1px solid #E5E5E5'
                    }}
                    onClick={() => {
                        triggerHaptic('light');
                        alert(`Completion Rate: ${completionRate}%\n\nYou've completed ${completedAssignments} out of ${totalAssignments} total assignments.\n\nKeep up the great work!`);
                    }}>
                        <i data-lucide="trending-up" style={{ width: '24px', height: '24px', color: '#4CAF50', marginBottom: '8px' }}></i>
                        <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#4CAF50' }}>
                            {completionRate}%
                        </div>
                        <div style={{ fontSize: '12px', color: '#666666', marginTop: '4px' }}>
                            Completion Rate
                        </div>
                    </div>

                    {/* Card 6: Recent Achievements */}
                    <div style={{
                        background: '#FFFFFF',
                        borderRadius: '12px',
                        padding: '16px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                        cursor: 'pointer',
                        transition: 'transform 0.2s',
                        border: '1px solid #E5E5E5'
                    }}
                    onClick={() => {
                        triggerHaptic('light');
                        const recentlyCompleted = assignments.filter(a => a.status === 'completed').slice(-5);
                        const achievementList = recentlyCompleted.map(a => `✅ ${a.title}`).join('\n');
                        alert(`Recent Achievements:\n\n${achievementList || 'No completed assignments yet'}\n\nKeep working on your goals!`);
                    }}>
                        <i data-lucide="award" style={{ width: '24px', height: '24px', color: '#F39C12', marginBottom: '8px' }}></i>
                        <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#F39C12' }}>
                            {completedAssignments}
                        </div>
                        <div style={{ fontSize: '12px', color: '#666666', marginTop: '4px' }}>
                            Completed
                        </div>
                    </div>
                </div>
            </div>

            {/* Render Modal */}
            <ItemModal />
        </>
    );
}
        
       // Enhanced ProfileView Component with all missing features
function ProfileView({ user, userData, profileImage, resources, onShowModal, onLogout, onImageUpload, fileInputRef, coachInfo, googleConnected }) {
    const [profileStats, setProfileStats] = useState({
        checkInRate: 0,
        assignmentRate: 0,
        currentStreak: 0,
        avgMood: 0,
        avgCraving: 0
    });
    
    // Calculate profile completion percentage
    const calculateProfileCompletion = () => {
        let completed = 0;
        let total = 10;
        
        if (userData?.firstName) completed++;
        if (userData?.lastName) completed++;
        if (userData?.phone) completed++;
        if (userData?.sobrietyDate) completed++;
        if (userData?.substance) completed++;
        if (userData?.dailyCost) completed++;
        if (userData?.emergencyContacts?.length > 0) completed++;
        if (userData?.address?.city) completed++;
        if (userData?.profileImageUrl) completed++;
        if (userData?.dateOfBirth) completed++;
        
        return Math.round((completed / total) * 100);
    };
    
    // Load profile stats
    useEffect(() => {
        loadProfileStats();
    }, [user]);
    
    const loadProfileStats = async () => {
    try {
        // Get user's account creation date
        const userDoc = await db.collection('users').doc(user.uid).get();
        const accountCreatedDate = userDoc.data()?.createdAt?.toDate() || new Date();
        
        // Calculate days since account creation (max 30 days for recent performance)
        const today = new Date();
        const daysSinceCreation = Math.floor((today - accountCreatedDate) / (1000 * 60 * 60 * 24));
        const daysToCheck = Math.min(daysSinceCreation, 30); // Cap at 30 days
        
        // Skip calculation if account is less than 1 day old
        if (daysToCheck < 1) {
            setProfileStats({
                checkInRate: 0,
                assignmentRate: 0,
                currentStreak: 0,
                avgMood: 0,
                avgCraving: 0
            });
            return;
        }
        
        // Calculate check-in rate based on days since joining
        const dateToCheckFrom = new Date();
        dateToCheckFrom.setDate(dateToCheckFrom.getDate() - daysToCheck);
        
        const checkInsSnap = await db.collection('checkIns')
            .where('userId', '==', user.uid)
            .where('createdAt', '>=', dateToCheckFrom)
            .get();
        
        // COUNT ONLY MORNING CHECK-INS
        let morningCheckInCount = 0;
        let totalMood = 0;
        let totalCraving = 0;
        let moodCount = 0;
        
        checkInsSnap.forEach(doc => {
            const data = doc.data();
            if (data.morningData) {
                morningCheckInCount++;
                
                // Calculate average mood (and craving for potential future use)
                if (data.morningData.mood) {
                    totalMood += data.morningData.mood;
                    moodCount++;
                }
                if (data.morningData.craving) {
                    totalCraving += data.morningData.craving;
                }
            }
        });
        
        // Calculate check-in rate - CAPPED AT 100%
        const checkInRate = Math.min(100, Math.round((morningCheckInCount / daysToCheck) * 100));
        
        // Calculate LIFETIME task completion (all check-ins + reflections + assignments)
const taskCompletion = await calculateLifetimeTaskCompletion(user.uid);

// Get current streak
const streakDoc = await db.collection('streaks').doc(user.uid).get();
const currentStreak = streakDoc.exists ? streakDoc.data().currentStreak || 0 : 0;

// Use the lifetime task completion rate instead of just assignment rate
const assignmentRate = taskCompletion.completionRate; // This is now ALL tasks, not just assignments

setProfileStats({
    checkInRate,
    assignmentRate,  // This now represents total task completion, not just assignments
    currentStreak,
    avgMood: moodCount > 0 ? (totalMood / moodCount).toFixed(1) : 0,
    avgCraving: moodCount > 0 ? (totalCraving / moodCount).toFixed(1) : 0
});
} catch (error) {
    console.error('Error loading profile stats:', error);
}
};
    // Helper functions for task calculations - can be called by admin.html
const calculateLifetimeTaskCompletion = async (userId) => {
    try {
        // Get user's account creation date
        const userDoc = await db.collection('users').doc(userId).get();
        const accountCreatedDate = userDoc.data()?.createdAt?.toDate() || new Date();
        
        // Calculate total days since joining
        const today = new Date();
        const daysSinceJoining = Math.floor((today - accountCreatedDate) / (1000 * 60 * 60 * 24)) + 1; // +1 to include today
        
        // Get ALL check-ins (no date filter for lifetime)
        const checkInsSnap = await db.collection('checkIns')
            .where('userId', '==', userId)
            .get();
        
        // Count morning check-ins and evening reflections separately
        let morningCheckInsCompleted = 0;
        let eveningReflectionsCompleted = 0;
        
        checkInsSnap.forEach(doc => {
            const data = doc.data();
            if (data.morningData) {
                morningCheckInsCompleted++;
            }
            if (data.eveningData) {
                eveningReflectionsCompleted++;
            }
        });
        
        // Get ALL assignments (lifetime)
        const assignmentsSnap = await db.collection('assignments')
            .where('userId', '==', userId)
            .get();
        
        let totalAssignments = 0;
        let completedAssignments = 0;
        
        assignmentsSnap.forEach(doc => {
            totalAssignments++;
            if (doc.data().status === 'completed') {
                completedAssignments++;
            }
        });
        
        // Calculate totals
        const expectedDailyTasks = daysSinceJoining * 2; // Morning + Evening each day
        const totalExpectedTasks = expectedDailyTasks + totalAssignments;
        const totalCompletedTasks = morningCheckInsCompleted + eveningReflectionsCompleted + completedAssignments;
        
        // Calculate percentage
        const completionRate = totalExpectedTasks > 0 ? 
            Math.round((totalCompletedTasks / totalExpectedTasks) * 100) : 0;
        
        return {
            completionRate,
            totalCompleted: totalCompletedTasks,
            totalExpected: totalExpectedTasks,
            breakdown: {
                morningCheckIns: morningCheckInsCompleted,
                eveningReflections: eveningReflectionsCompleted,
                assignments: completedAssignments,
                expectedDailyTasks: expectedDailyTasks,
                totalAssignments: totalAssignments
            }
        };
    } catch (error) {
        console.error('Error calculating lifetime task completion:', error);
        return {
            completionRate: 0,
            totalCompleted: 0,
            totalExpected: 0
        };
    }
};
    
    const handleImageSelect = (e) => {
    const file = e.target.files[0];
    if (file) {
        onImageUpload(file);
    }
};
  

const profileCompletion = calculateProfileCompletion();

return (
    <>
        <div className="profile-menu">
            <div className="profile-header">
                <div className="profile-avatar" onClick={() => fileInputRef.current?.click()}>
                    {profileImage ? (
                        <img src={profileImage} alt="Profile" />
                    ) : (
                        (userData?.displayName || userData?.firstName || user.email || 'U').charAt(0).toUpperCase()
                    )}
                    <div className="profile-avatar-upload">
                        <i data-lucide="camera" style={{width: '16px', height: '16px'}}></i>
                    </div>
                </div>
                <input 
                    ref={fileInputRef}
                    type="file"
                    accept="image/*"
                    className="upload-input"
                    onChange={handleImageSelect}
                />
                <div className="profile-name">
                    {userData?.displayName || userData?.firstName || 'User'}
                </div>
                <div className="profile-email">{user.email}</div>
                
                {/* Profile Completion Indicator */}
                {profileCompletion < 100 && (
                    <div style={{marginTop: '10px'}}>
                        <div style={{fontSize: '12px', opacity: 0.8, marginBottom: '5px'}}>
                            Profile {profileCompletion}% Complete
                        </div>
                        <div style={{
                            background: 'rgba(255,255,255,0.1)',
                            borderRadius: '10px',
                            height: '8px',
                            overflow: 'hidden'
                        }}>
                            <div style={{
                                background: 'linear-gradient(135deg, #f4c430 0%, #ff9500 100%)',
                                width: `${profileCompletion}%`,
                                height: '100%',
                                transition: 'width 0.3s ease'
                            }}/>
                        </div>
                    </div>
                )}
                
                {/* Sobriety Info */}
                {userData?.sobrietyDate && (
                    <div style={{
                        marginTop: '15px',
                        padding: '10px',
                        background: 'rgba(76, 175, 80, 0.1)',
                        borderRadius: '10px',
                        border: '1px solid rgba(76, 175, 80, 0.3)'
                    }}>
                        <div style={{fontSize: '24px', fontWeight: 'bold', color: '#4CAF50'}}>
                            {window.getSobrietyDays(userData.sobrietyDate)} Days Clean
                        </div>
                        <div style={{fontSize: '12px', opacity: 0.8, marginTop: '5px'}}>
                            Since {new Date(userData.sobrietyDate).toLocaleDateString('en-US', {
                                timeZone: 'UTC',
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            })}
                        </div>
                    </div>
                )}
            </div>  {/* THIS WAS MISSING - Closing profile-header */}
            
            {/* Stats Section */}
            <div className="menu-section">
                <div className="menu-title">My Stats</div>
                <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(2, 1fr)',
                    gap: '10px',
                    padding: '0 15px',
                    marginBottom: '15px'
                }}>
                    <div style={{
                        background: 'rgba(255,255,255,0.05)',
                        borderRadius: '10px',
                        padding: '10px',
                        textAlign: 'center'
                    }}>
                        <div style={{fontSize: '20px', fontWeight: 'bold', color: '#f4c430'}}>
                            {profileStats.checkInRate}%
                        </div>
                        <div style={{fontSize: '11px', opacity: 0.7}}>Check-in Rate</div>
                    </div>
                    
                    <div style={{
                        background: 'rgba(255,255,255,0.05)',
                        borderRadius: '10px',
                        padding: '10px',
                        textAlign: 'center'
                    }}>
                        <div style={{fontSize: '20px', fontWeight: 'bold', color: '#4CAF50'}}>
                            {profileStats.assignmentRate}%
                        </div>
                        <div style={{fontSize: '11px', opacity: 0.7}}>Lifetime Task</div>
                    </div>
                    
                    <div style={{
                        background: 'rgba(255,255,255,0.05)',
                        borderRadius: '10px',
                        padding: '10px',
                        textAlign: 'center'
                    }}>
                        <div style={{fontSize: '20px', fontWeight: 'bold', color: '#ff9500'}}>
                            {profileStats.currentStreak}
                        </div>
                        <div style={{fontSize: '11px', opacity: 0.7}}>Day Streak</div>
                    </div>
                    
                    <div style={{
                        background: 'rgba(255,255,255,0.05)',
                        borderRadius: '10px',
                        padding: '10px',
                        textAlign: 'center'
                    }}>
                        <div style={{fontSize: '20px', fontWeight: 'bold', color: '#9c27b0'}}>
                            {profileStats.avgMood}/10
                        </div>
                        <div style={{fontSize: '11px', opacity: 0.7}}>Avg Mood</div>
                    </div>
                </div>
            </div>
                
                {/* Coach Section */}
                {coachInfo && (
                    <div className="menu-section">
                        <div className="menu-title">My Coach</div>
                        <div style={{background: 'rgba(255,255,255,0.05)', borderRadius: '10px', padding: '15px', margin: '0 10px'}}>
                            <div style={{fontWeight: 'bold', marginBottom: '5px'}}>
                                {coachInfo.displayName || coachInfo.firstName + ' ' + coachInfo.lastName}
                            </div>
                            {coachInfo.credentials && (
                                <div style={{fontSize: '14px', opacity: 0.8, marginBottom: '5px'}}>
                                    {coachInfo.credentials}
                                </div>
                            )}
                            {coachInfo.phone && (
                                <div style={{fontSize: '14px'}}>
                                    📞 <a href={`tel:${coachInfo.phone}`} style={{color: '#f4c430', textDecoration: 'none'}}>
                                        {coachInfo.phone}
                                    </a>
                                </div>
                            )}
                        </div>
                    </div>
                )}
                
                {/* Account Settings */}
                <div className="menu-section">
                    <div className="menu-title">Account</div>
                    <button className="menu-item" onClick={() => onShowModal('personalInfo')}>
                        <div className="menu-item-left">
                            <span className="menu-icon"><i data-lucide="user" style={{width: '18px', height: '18px'}}></i></span>
                            <span>Personal Information</span>
                        </div>
                        <span className="menu-arrow">›</span>
                    </button>
                    <button className="menu-item" onClick={() => onShowModal('recoveryInfo')}>
                        <div className="menu-item-left">
                            <span className="menu-icon"><i data-lucide="target" style={{width: '18px', height: '18px'}}></i></span>
                            <span>Recovery Settings</span>
                        </div>
                        <span className="menu-arrow">›</span>
                    </button>
                    <button className="menu-item" onClick={() => onShowModal('password')}>
                        <div className="menu-item-left">
                            <span className="menu-icon"><i data-lucide="lock" style={{width: '18px', height: '18px'}}></i></span>
                            <span>Password & Security</span>
                        </div>
                        <span className="menu-arrow">›</span>
                    </button>
                    <button className="menu-item" onClick={() => onShowModal('notifications')}>
    <div className="menu-item-left">
        <span className="menu-icon"><i data-lucide="bell" style={{width: '18px', height: '18px'}}></i></span>
        <span>Notification Settings</span>
    </div>
    <span className="menu-arrow">›</span>
</button>

{/* NEW: Google Calendar Integration */}
<button className="menu-item" onClick={() => onShowModal('googleCalendar')}>
    <div className="menu-item-left">
        <span className="menu-icon"><i data-lucide="calendar" style={{width: '18px', height: '18px'}}></i></span>
        <span>Google Calendar</span>
    </div>
    <span className="menu-arrow" style={{
        color: googleConnected ? '#4CAF50' : 'rgba(255,255,255,0.5)',
        fontWeight: googleConnected ? 'bold' : 'normal'
    }}>
        {googleConnected ? '✓ Connected' : 'Not Connected'}
    </span>
</button>

<button className="menu-item" onClick={() => onShowModal('emergency')}>
    <div className="menu-item-left">
        <span className="menu-icon"><i data-lucide="alert-circle" style={{width: '18px', height: '18px'}}></i></span>
        <span>Emergency Contacts</span>
    </div>
    <span className="menu-arrow">›</span>
</button>
                    </div>
                {/* Support & Resources */}
                <div className="menu-section">
                    <div className="menu-title">Support</div>
                    <button className="menu-item" onClick={() => onShowModal('help')}>
                        <div className="menu-item-left">
                            <span className="menu-icon"><i data-lucide="help-circle" style={{width: '18px', height: '18px'}}></i></span>
                            <span>Help & Support</span>
                        </div>
                        <span className="menu-arrow">›</span>
                    </button>
                    <button className="menu-item" onClick={() => onShowModal('feedback')}>
                        <div className="menu-item-left">
                            <span className="menu-icon"><i data-lucide="message-square" style={{width: '18px', height: '18px'}}></i></span>
                            <span>Send Feedback</span>
                        </div>
                        <span className="menu-arrow">›</span>
                    </button>
                    <button className="menu-item" onClick={() => onShowModal('export')}>
                        <div className="menu-item-left">
                            <span className="menu-icon"><i data-lucide="download" style={{width: '18px', height: '18px'}}></i></span>
                            <span>Export My Data</span>
                        </div>
                        <span className="menu-arrow">›</span>
                    </button>
                </div>

                {/* About Section */}
                <div className="menu-section">
                    <div className="menu-title">About</div>
                    <button className="menu-item" onClick={() => onShowModal('terms')}>
                        <div className="menu-item-left">
                            <span className="menu-icon"><i data-lucide="file-text" style={{width: '18px', height: '18px'}}></i></span>
                            <span>Terms of Service</span>
                        </div>
                        <span className="menu-arrow">›</span>
                    </button>
                    <button className="menu-item" onClick={() => onShowModal('privacy_policy')}>
                        <div className="menu-item-left">
                            <span className="menu-icon"><i data-lucide="shield" style={{width: '18px', height: '18px'}}></i></span>
                            <span>Privacy Policy</span>
                        </div>
                        <span className="menu-arrow">›</span>
                    </button>
                    <button className="menu-item" onClick={() => onShowModal('about')}>
                        <div className="menu-item-left">
                            <span className="menu-icon"><i data-lucide="info" style={{width: '18px', height: '18px'}}></i></span>
                            <span>About GLRS</span>
                        </div>
                        <span className="menu-arrow">›</span>
                    </button>
                </div>
                
                {/* Sign Out & Delete Account */}
                <div className="menu-section">
                    <button className="btn-danger" onClick={onLogout}>
                        Sign Out
                    </button>
                    <button 
                        style={{
                            width: '100%',
                            padding: '14px',
                            background: 'transparent',
                            border: '1px solid rgba(255, 71, 87, 0.5)',
                            borderRadius: '10px',
                            color: '#ff4757',
                            fontWeight: 'bold',
                            cursor: 'pointer',
                            marginTop: '10px'
                        }}
                        onClick={() => onShowModal('deleteAccount')}
                    >
                        Delete Account
                    </button>
                </div>
            </div>
        </>
    );
}
        
       // Community Chat Component - FULLY UPDATED VERSION
function CommunityChat({ messages, onSendMessage, currentUserId, uploadChatImage, flagContent, setModalImage }) {
    const [message, setMessage] = useState('');
    const [selectedImage, setSelectedImage] = useState(null);
    const [uploading, setUploading] = useState(false);
    const [likes, setLikes] = useState({});
    const [showComments, setShowComments] = useState({});
    const messagesEndRef = useRef(null);

    useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
    }, [messages]);

    const handleImageSelect = (e) => {
        const file = e.target.files[0];
        if (file) {
            setSelectedImage(file);
        }
    };

    const handleSend = async () => {
        if ((message.trim() || selectedImage) && !uploading) {
            setUploading(true);

            try {
                let imageUrl = null;

                if (selectedImage && uploadChatImage) {
                    imageUrl = await uploadChatImage(selectedImage, 'community', 'main');
                }

                await onSendMessage(message, imageUrl);

                setMessage('');
                setSelectedImage(null);
                const fileInput = document.getElementById('community-image-input');
                if (fileInput) fileInput.value = '';

            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message');
            } finally {
                setUploading(false);
            }
        }
    };

    const handleLike = (msgId) => {
        setLikes(prev => ({
            ...prev,
            [msgId]: !prev[msgId]
        }));
    };

    const getInitials = (name) => {
        if (!name) return 'A';
        const parts = name.split(' ');
        return parts.length > 1
            ? parts[0][0] + parts[1][0]
            : parts[0][0];
    };

    const formatTimeAgo = (timestamp) => {
        if (!timestamp?.toDate) return 'now';
        const date = timestamp.toDate();
        const seconds = Math.floor((new Date() - date) / 1000);

        if (seconds < 60) return 'just now';
        if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
        if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
        return `${Math.floor(seconds / 86400)}d ago`;
    };

    return (
        <div style={{marginBottom: 'var(--space-4)'}}>
            {/* Create Post Card */}
            <div style={{
                background: 'rgba(255,255,255,0.95)',
                borderRadius: 'var(--radius-lg)',
                padding: 'var(--space-4)',
                marginBottom: 'var(--space-4)',
                boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
            }}>
                <div style={{display: 'flex', gap: 'var(--space-3)', alignItems: 'flex-start'}}>
                    <div style={{
                        width: '40px',
                        height: '40px',
                        borderRadius: '50%',
                        background: 'linear-gradient(135deg, var(--color-primary), var(--color-secondary))',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        color: '#fff',
                        fontSize: 'var(--font-sm)',
                        fontWeight: 'bold',
                        flexShrink: 0
                    }}>
                        {getInitials('You')}
                    </div>
                    <div style={{flex: 1}}>
                        <input
                            type="text"
                            placeholder="What's on your mind?"
                            value={message}
                            onChange={(e) => setMessage(e.target.value)}
                            onKeyPress={(e) => e.key === 'Enter' && handleSend()}
                            style={{
                                width: '100%',
                                padding: 'var(--space-3)',
                                border: '1px solid #ddd',
                                borderRadius: 'var(--radius-lg)',
                                fontSize: 'var(--font-base)',
                                background: '#f8f9fa',
                                outline: 'none'
                            }}
                        />
                        {selectedImage && (
                            <div style={{
                                marginTop: 'var(--space-2)',
                                padding: 'var(--space-2)',
                                background: '#e7f5ff',
                                borderRadius: 'var(--radius-md)',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'space-between'
                            }}>
                                <span style={{fontSize: 'var(--font-sm)', color: '#333'}}>
                                    <i data-lucide="image" style={{width: '16px', height: '16px', marginRight: '8px'}}></i>
                                    {selectedImage.name}
                                </span>
                                <button
                                    onClick={() => setSelectedImage(null)}
                                    style={{
                                        background: 'transparent',
                                        border: 'none',
                                        cursor: 'pointer',
                                        padding: '4px'
                                    }}
                                >
                                    <i data-lucide="x" style={{width: '16px', height: '16px', color: '#666'}}></i>
                                </button>
                            </div>
                        )}
                        <div style={{
                            display: 'flex',
                            gap: 'var(--space-2)',
                            marginTop: 'var(--space-3)',
                            paddingTop: 'var(--space-3)',
                            borderTop: '1px solid #eee'
                        }}>
                            <input
                                type="file"
                                id="community-image-input"
                                accept="image/*"
                                style={{display: 'none'}}
                                onChange={handleImageSelect}
                            />
                            <button
                                onClick={() => document.getElementById('community-image-input').click()}
                                style={{
                                    flex: 1,
                                    padding: 'var(--space-2)',
                                    background: 'transparent',
                                    border: 'none',
                                    borderRadius: 'var(--radius-md)',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    gap: 'var(--space-1)',
                                    fontSize: 'var(--font-sm)',
                                    color: '#666',
                                    fontWeight: '500'
                                }}
                            >
                                <i data-lucide="image" style={{width: '20px', height: '20px'}}></i>
                                Photo
                            </button>
                            <button
                                onClick={handleSend}
                                disabled={uploading || (!message.trim() && !selectedImage)}
                                style={{
                                    padding: 'var(--space-2) var(--space-4)',
                                    background: (uploading || (!message.trim() && !selectedImage))
                                        ? '#ccc'
                                        : 'linear-gradient(135deg, var(--color-primary), var(--color-secondary))',
                                    border: 'none',
                                    borderRadius: 'var(--radius-md)',
                                    color: '#fff',
                                    fontSize: 'var(--font-sm)',
                                    fontWeight: 'bold',
                                    cursor: (uploading || (!message.trim() && !selectedImage)) ? 'not-allowed' : 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: 'var(--space-1)'
                                }}
                            >
                                {uploading ? (
                                    <>
                                        <i data-lucide="loader" style={{width: '16px', height: '16px', animation: 'spin 1s linear infinite'}}></i>
                                        Posting...
                                    </>
                                ) : (
                                    <>
                                        <i data-lucide="send" style={{width: '16px', height: '16px'}}></i>
                                        Post
                                    </>
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            {/* Feed Posts */}
            <div>
                {messages.length > 0 ? (
                    messages.slice().reverse().map(msg => (
                        <div key={msg.id} style={{
                            background: 'rgba(255,255,255,0.95)',
                            borderRadius: 'var(--radius-lg)',
                            padding: 'var(--space-4)',
                            marginBottom: 'var(--space-4)',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                        }}>
                            {/* Post Header */}
                            <div style={{display: 'flex', alignItems: 'center', marginBottom: 'var(--space-3)'}}>
                                <div style={{
                                    width: '40px',
                                    height: '40px',
                                    borderRadius: '50%',
                                    background: 'linear-gradient(135deg, var(--color-secondary), var(--color-accent))',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    color: '#fff',
                                    fontSize: 'var(--font-sm)',
                                    fontWeight: 'bold',
                                    marginRight: 'var(--space-3)'
                                }}>
                                    {getInitials(msg.senderName)}
                                </div>
                                <div style={{flex: 1}}>
                                    <div style={{fontWeight: '600', color: '#333', fontSize: 'var(--font-base)'}}>
                                        {msg.senderName || 'Anonymous'}
                                    </div>
                                    <div style={{fontSize: 'var(--font-xs)', color: '#666'}}>
                                        {formatTimeAgo(msg.createdAt)}
                                    </div>
                                </div>
                                {msg.senderId !== currentUserId && flagContent && (
                                    <button
                                        onClick={() => flagContent('community_message', {
                                            messageId: msg.id,
                                            messageContent: msg.content,
                                            messageImageUrl: msg.imageUrl || null,
                                            authorId: msg.senderId,
                                            authorName: msg.senderName
                                        })}
                                        style={{
                                            background: 'transparent',
                                            border: 'none',
                                            cursor: 'pointer',
                                            padding: 'var(--space-2)'
                                        }}
                                    >
                                        <i data-lucide="flag" style={{width: '16px', height: '16px', color: '#999'}}></i>
                                    </button>
                                )}
                            </div>

                            {/* Post Content */}
                            {msg.content && (
                                <div style={{
                                    color: '#333',
                                    fontSize: 'var(--font-base)',
                                    lineHeight: '1.5',
                                    marginBottom: msg.imageUrl ? 'var(--space-3)' : 0
                                }}>
                                    {msg.content}
                                </div>
                            )}

                            {/* Post Image */}
                            {msg.imageUrl && (
                                <img
                                    src={msg.imageUrl}
                                    alt="Post content"
                                    style={{
                                        width: '100%',
                                        borderRadius: 'var(--radius-md)',
                                        cursor: 'pointer'
                                    }}
                                    onClick={() => setModalImage(msg.imageUrl)}
                                />
                            )}

                            {/* Post Actions */}
                            <div style={{
                                display: 'flex',
                                gap: 'var(--space-4)',
                                marginTop: 'var(--space-3)',
                                paddingTop: 'var(--space-3)',
                                borderTop: '1px solid #eee'
                            }}>
                                <button
                                    onClick={() => handleLike(msg.id)}
                                    style={{
                                        background: 'transparent',
                                        border: 'none',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: 'var(--space-1)',
                                        fontSize: 'var(--font-sm)',
                                        fontWeight: '500',
                                        color: likes[msg.id] ? 'var(--color-danger)' : '#666',
                                        padding: 'var(--space-2)'
                                    }}
                                >
                                    <i data-lucide="heart" style={{
                                        width: '18px',
                                        height: '18px',
                                        fill: likes[msg.id] ? 'var(--color-danger)' : 'none'
                                    }}></i>
                                    Like
                                </button>
                                <button
                                    onClick={() => setShowComments(prev => ({...prev, [msg.id]: !prev[msg.id]}))}
                                    style={{
                                        background: 'transparent',
                                        border: 'none',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: 'var(--space-1)',
                                        fontSize: 'var(--font-sm)',
                                        fontWeight: '500',
                                        color: '#666',
                                        padding: 'var(--space-2)'
                                    }}
                                >
                                    <i data-lucide="message-circle" style={{width: '18px', height: '18px'}}></i>
                                    Comment
                                </button>
                            </div>
                        </div>
                    ))
                ) : (
                    <div style={{
                        textAlign: 'center',
                        padding: 'var(--space-8)',
                        background: 'rgba(255,255,255,0.95)',
                        borderRadius: 'var(--radius-lg)',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                    }}>
                        <i data-lucide="users" style={{width: '48px', height: '48px', color: '#ccc', marginBottom: 'var(--space-3)'}}></i>
                        <div style={{color: '#666', fontSize: 'var(--font-base)'}}>
                            No posts yet. Be the first to share!
                        </div>
                    </div>
                )}
                <div ref={messagesEndRef} />
            </div>
        </div>
    );
}
        
      // Modal Container Component with ALL modals working
function ModalContainer({ type, onClose, data, handlers }) {
    const [formData, setFormData] = useState({});
    const [morningData, setMorningData] = useState({
        mood: 5,
        craving: 0,
        sleepQuality: 5,
        anxietyLevel: 0,
        notes: ''
    });
    const [eveningData, setEveningData] = useState({
        gratitude: '',
        challenges: '',
        tomorrowGoal: '',
        overallDay: 5   // Changed from 3 to 5 (middle of 0-10)
    });
    const [topicMessage, setTopicMessage] = useState('');
    
    // ADD THESE LINES HERE:
    const [selectedImage, setSelectedImage] = useState(null);
    const [newMessage, setNewMessage] = useState('');
    const [uploading, setUploading] = useState(false);
    
    // Get user from data
    const user = data.user || {};
    
    // Handler functions for topic room
    const handleTopicImageSelect = (e) => {
        const file = e.target.files[0];
        if (file) {
            setSelectedImage(file);
        }
    };
  // In ModalContainer - This is the ONLY handleSendMessage you need
const handleSendMessage = async () => {
    // Allow sending with either text or image
    if (!newMessage.trim() && !selectedImage) return;
    
    setUploading(true);
    try {
        await handlers.sendTopicMessage(newMessage || '', selectedImage);
        setNewMessage('');
        setSelectedImage(null);
        // Clear the file input
        const fileInput = document.querySelector('input[type="file"]');
        if (fileInput) fileInput.value = '';
    } catch (error) {
        console.error('Error sending message:', error);
        showNotification('Failed to send message', 'error');
    } finally {
        setUploading(false);
    }
};

const handleFlagTopicMessage = (msg) => {
    if (handlers.flagMessage) {
        handlers.flagMessage(msg);
    }
};
    
    const renderModalContent = () => {
        switch(type) {
            case 'notifications':
                return ( 
    
                
                            <div className="notification-panel">
                                <h3 style={{marginBottom: '20px'}}>Notifications</h3>
                                {data.notifications.length > 0 ? (
                                    <>
                                        {data.notifications.map(notification => (
                                            <div 
                                                key={notification.id}
                                                className={`notification-item ${!notification.read ? 'unread' : ''}`}
                                                onClick={() => handlers.markNotificationAsRead(notification.id)}
                                            >
                                                <div className="notification-header">
                                                    <span className="notification-type">{notification.type}</span>
                                                    <span className="notification-time">
                                                        {notification.createdAt?.toDate ? 
                                                            new Date(notification.createdAt.toDate()).toLocaleTimeString() :
                                                            'now'}
                                                    </span>
                                                </div>
                                                <div className="notification-message">
                                                    <strong>{notification.title}</strong>
                                                    <div>{notification.message}</div>
                                                </div>
                                            </div>
                                        ))}
                                        {data.notifications.some(n => !n.read) && (
                                            <button 
                                                className="btn-primary"
                                                onClick={handlers.markAllNotificationsAsRead}
                                                style={{marginTop: '15px'}}
                                            >
                                                Mark All as Read
                                            </button>
                                        )}
                                    </>
                                ) : (
                                    <div style={{textAlign: 'center', opacity: 0.6, padding: '40px'}}>
                                        No notifications
                                    </div>
                                )}
                            </div>
                        );
                        
                    case 'checkIn':
    return (
        <div>
            <h3 style={{marginBottom: '20px'}}>Morning Check-in</h3>
            <div className="slider-group">
                <div className="slider-label">
                    <span>Overall Mood</span>
                    <span className="slider-value">{morningData.mood}</span>
                </div>
                <input 
                    type="range"
                    className="slider"
                    min="0" max="10"
                    value={morningData.mood}
                    onChange={(e) => setMorningData({...morningData, mood: parseInt(e.target.value)})}
                />
                <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '12px', color: '#666', marginTop: '5px'}}>
                    <span>0 (Worst)</span>
                    <span>5 (Neutral)</span>
                    <span>10 (Best)</span>
                </div>
            </div>
            
            <div className="slider-group">
                <div className="slider-label">
                    <span>Craving Intensity</span>
                    <span className="slider-value">{morningData.craving}</span>
                </div>
                <input 
                    type="range"
                    className="slider"
                    min="0" max="10"
                    value={morningData.craving}
                    onChange={(e) => setMorningData({...morningData, craving: parseInt(e.target.value)})}
                />
                <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '12px', color: '#666', marginTop: '5px'}}>
                    <span>0 (None)</span>
                    <span>5 (Moderate)</span>
                    <span>10 (Intense)</span>
                </div>
            </div>
            
            <div className="slider-group">
                <div className="slider-label">
                    <span>Sleep Quality</span>
                    <span className="slider-value">{morningData.sleepQuality}</span>
                </div>
                <input 
                    type="range"
                    className="slider"
                    min="0" max="10"
                    value={morningData.sleepQuality}
                    onChange={(e) => setMorningData({...morningData, sleepQuality: parseInt(e.target.value)})}
                />
                <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '12px', color: '#666', marginTop: '5px'}}>
                    <span>0 (Terrible)</span>
                    <span>5 (Fair)</span>
                    <span>10 (Excellent)</span>
                </div>
            </div>
            
            <div className="slider-group">
                <div className="slider-label">
                    <span>Anxiety Level</span>
                    <span className="slider-value">{morningData.anxietyLevel}</span>
                </div>
                <input 
                    type="range"
                    className="slider"
                    min="0" max="10"
                    value={morningData.anxietyLevel}
                    onChange={(e) => setMorningData({...morningData, anxietyLevel: parseInt(e.target.value)})}
                />
                <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '12px', color: '#666', marginTop: '5px'}}>
                    <span>0 (Calm)</span>
                    <span>5 (Moderate)</span>
                    <span>10 (Severe)</span>
                </div>
            </div>
            
            <div className="form-group">
                <label className="form-label">Notes (Optional)</label>
                <textarea 
                    className="textarea"
                    placeholder="Any thoughts or feelings you'd like to share?"
                    value={morningData.notes}
                    onChange={(e) => setMorningData({...morningData, notes: e.target.value})}
                />
            </div>
            
            <button 
                className="btn-primary"
                onClick={async () => {
                    await handlers.handleMorningCheckIn(morningData);
                    onClose();
                }}
            >
                Submit Check-in
            </button>
        </div>
    );

case 'reflection':
    return (
        <div>
            <h3 style={{marginBottom: '20px'}}>Evening Reflection</h3>
            <div className="form-group">
                <label className="form-label">What are you grateful for today?</label>
                <textarea 
                    className="textarea"
                    placeholder="List 3 things you're grateful for..."
                    value={eveningData.gratitude}
                    onChange={(e) => setEveningData({...eveningData, gratitude: e.target.value})}
                />
            </div>
            
            <div className="form-group">
                <label className="form-label">What challenges did you face?</label>
                <textarea 
                    className="textarea"
                    placeholder="Describe any difficulties..."
                    value={eveningData.challenges}
                    onChange={(e) => setEveningData({...eveningData, challenges: e.target.value})}
                />
            </div>
            
            <div className="form-group">
                <label className="form-label">What's one goal for tomorrow?</label>
                <textarea 
                    className="textarea"
                    placeholder="Set an intention..."
                    value={eveningData.tomorrowGoal}
                    onChange={(e) => setEveningData({...eveningData, tomorrowGoal: e.target.value})}
                />
            </div>
            
            <div className="slider-group">
                <div className="slider-label">
                    <span>Overall Day Rating</span>
                    <span className="slider-value">{eveningData.overallDay}</span>
                </div>
                <input 
                    type="range"
                    className="slider"
                    min="0" max="10"
                    value={eveningData.overallDay}
                    onChange={(e) => setEveningData({...eveningData, overallDay: parseInt(e.target.value)})}
                />
                <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '12px', color: '#666', marginTop: '5px'}}>
                    <span>0 (Terrible)</span>
                    <span>5 (OK)</span>
                    <span>10 (Excellent)</span>
                </div>
            </div>
            
            <button 
                className="btn-primary"
                onClick={async () => {
                    await handlers.handleEveningReflection(eveningData);
                    onClose();
                }}
            >
                Submit Reflection
            </button>
        </div>
    );
                        
                  case 'topicRoom':
    return (
        <div> {/* Parent wrapper */}
            <h3 style={{marginBottom: '20px'}}>
                {data.activeTopicRoom?.icon} {data.activeTopicRoom?.name}
            </h3>
            <p style={{opacity: 0.8, marginBottom: '20px'}}>
                {data.activeTopicRoom?.description}
            </p>
            
            {/* Messages container */}
            <div style={{flex: 1, overflowY: 'auto', padding: '15px', height: '300px'}}>
                {data.topicRoomMessages?.map(msg => (
                    <div key={msg.id} style={{
                        background: msg.userId === user.uid ? 
                            'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 
                            'rgba(255,255,255,0.05)',
                        padding: '12px',
                        borderRadius: '12px',
                        marginBottom: '10px'
                    }}>
                        <div style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            marginBottom: '8px'
                        }}>
                            <span style={{fontWeight: 'bold', color: '#f4c430'}}>
                                {msg.senderName || 'Anonymous'}
                            </span>
                            <div style={{display: 'flex', gap: '10px', alignItems: 'center'}}>
                                <span style={{fontSize: '12px', opacity: 0.7, color: 'white'}}>
                                    {msg.createdAt?.toDate ? 
                                        msg.createdAt.toDate().toLocaleTimeString() : 
                                        'sending...'}
                                </span>
                                {msg.userId !== user.uid && (
                                    <button
                                        onClick={() => handleFlagTopicMessage(msg)}
                                        style={{
                                            background: 'transparent',
                                            border: 'none',
                                            color: 'rgba(255,255,255,0.5)',
                                            cursor: 'pointer',
                                            fontSize: '14px',
                                            padding: '2px'
                                        }}
                                        title="Flag inappropriate content"
                                    >
                                        <i data-lucide="flag" style={{width: '16px', height: '16px'}}></i>
                                    </button>
                                )}
                            </div>
                        </div>
                        {msg.message && (
                            <p style={{margin: 0, color: 'white', lineHeight: 1.5}}>
                                {msg.message}
                            </p>
                        )}
                        {msg.imageUrl && (
                            <img 
                                src={msg.imageUrl}
                                alt="Shared"
                                style={{
                                    maxWidth: '100%',
                                    maxHeight: '300px',
                                    borderRadius: '8px',
                                    marginTop: '10px',
                                    cursor: 'pointer'
                                }}
                                onClick={() => window.open(msg.imageUrl, '_blank')}
                            />
                        )}
                    </div>
                ))}
            </div>
            
            <div style={{
                padding: '15px',
                borderTop: '1px solid rgba(255,255,255,0.1)'
            }}>
                {selectedImage && (
                    <div style={{
                        marginBottom: '10px',
                        padding: '8px',
                        background: 'rgba(255,255,255,0.1)',
                        borderRadius: '8px',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center'
                    }}>
                        <span style={{color: 'white', fontSize: '14px', display: 'flex', alignItems: 'center', gap: '6px'}}>
                            <i data-lucide="camera" style={{width: '16px', height: '16px'}}></i>
                            {selectedImage.name}
                        </span>
                        <button
                            onClick={() => {
                                setSelectedImage(null);
                                document.getElementById('topic-image-input').value = '';
                            }}
                            style={{
                                background: 'transparent',
                                border: 'none',
                                color: 'white',
                                cursor: 'pointer'
                            }}
                        >
                            ✕
                        </button>
                    </div>
                )}
                <div style={{display: 'flex', gap: '10px'}}>
                    <input
                        type="file"
                        id="topic-image-input"
                        accept="image/*"
                        style={{display: 'none'}}
                        onChange={handleTopicImageSelect}
                    />
                    <button
                        onClick={() => document.getElementById('topic-image-input').click()}
                        style={{
                            background: 'rgba(255,255,255,0.1)',
                            border: 'none',
                            borderRadius: '8px',
                            padding: '10px',
                            color: 'white',
                            cursor: 'pointer'
                        }}
                        disabled={uploading}
                    >
                        <i data-lucide="camera" style={{width: '18px', height: '18px'}}></i>
                    </button>
                    <input 
                        type="text"
                        value={newMessage}
                        onChange={(e) => setNewMessage(e.target.value)}
                        placeholder="Type a message..."
                        onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                        style={{
                            flex: 1,
                            padding: '10px',
                            background: 'rgba(255,255,255,0.1)',
                            border: 'none',
                            borderRadius: '8px',
                            color: 'white'
                        }}
                    />
                    <button 
                        onClick={handleSendMessage}
                        disabled={uploading || (!newMessage.trim() && !selectedImage)}
                        style={{
                            padding: '10px 20px',
                            background: uploading ? 'gray' : '#f4c430',
                            border: 'none',
                            borderRadius: '8px',
                            color: 'black',
                            fontWeight: 'bold',
                            cursor: uploading ? 'not-allowed' : 'pointer'
                        }}
                    >
                        {uploading ? '...' : 'Send'}
                    </button>
                </div>
            </div>
        </div> 
    ); 
                        
                    case 'account':
                        return (
                            <div>
                                <h3 style={{marginBottom: '20px'}}>Account Settings</h3>
                                <div className="form-group">
                                    <label className="form-label">Display Name</label>
                                    <input 
                                        type="text"
                                        className="form-input"
                                        value={formData.displayName || data.userData?.displayName || ''}
                                        onChange={(e) => setFormData({...formData, displayName: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">First Name</label>
                                    <input 
                                        type="text"
                                        className="form-input"
                                        value={formData.firstName || data.userData?.firstName || ''}
                                        onChange={(e) => setFormData({...formData, firstName: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Last Name</label>
                                    <input 
                                        type="text"
                                        className="form-input"
                                        value={formData.lastName || data.userData?.lastName || ''}
                                        onChange={(e) => setFormData({...formData, lastName: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Phone</label>
                                    <input 
                                        type="tel"
                                        className="form-input"
                                        value={formData.phone || data.userData?.phone || ''}
                                        onChange={(e) => setFormData({...formData, phone: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Street Address</label>
                                    <input 
                                        type="text"
                                        className="form-input"
                                        value={formData.street || data.userData?.address?.street || ''}
                                        onChange={(e) => setFormData({...formData, street: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">City</label>
                                    <input 
                                        type="text"
                                        className="form-input"
                                        value={formData.city || data.userData?.address?.city || ''}
                                        onChange={(e) => setFormData({...formData, city: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">State</label>
                                    <input 
                                        type="text"
                                        className="form-input"
                                        value={formData.state || data.userData?.address?.state || ''}
                                        onChange={(e) => setFormData({...formData, state: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">ZIP</label>
                                    <input 
                                        type="text"
                                        className="form-input"
                                        value={formData.zip || data.userData?.address?.zip || ''}
                                        onChange={(e) => setFormData({...formData, zip: e.target.value})}
                                    />
                                </div>
                                <button 
                                    className="btn-primary"
                                    onClick={async () => {
                                        try {
                                            const updates = {
                                                ...formData,
                                                address: {
                                                    street: formData.street,
                                                    city: formData.city,
                                                    state: formData.state,
                                                    zip: formData.zip
                                                }
                                            };
                                            await db.collection('users').doc(data.user.uid).update(updates);
                                            alert('Settings updated!');
                                            onClose();
                                        } catch (error) {
                                            alert('Failed to update settings');
                                        }
                                    }}
                                >
                                    Save Changes
                                </button>
                            </div>
                        );
                        
                    case 'emergency':
                        return (
                            <div>
                                <h3 style={{marginBottom: '20px'}}>Emergency Contacts</h3>
                                {data.userData?.emergencyContacts?.map((contact, index) => (
                                    <div key={index} style={{
                                        background: 'rgba(255,255,255,0.1)',
                                        borderRadius: '10px',
                                        padding: '15px',
                                        marginBottom: '10px'
                                    }}>
                                        <div style={{fontWeight: 'bold'}}>{contact.name}</div>
                                        <div>{contact.phone}</div>
                                        <div style={{opacity: 0.8, fontSize: '14px'}}>{contact.relationship}</div>
                                    </div>
                                ))}
                                
                                <h4 style={{marginTop: '20px', marginBottom: '15px'}}>Add New Contact</h4>
                                <div className="form-group">
                                    <input 
                                        type="text"
                                        className="form-input"
                                        placeholder="Name"
                                        value={formData.contactName || ''}
                                        onChange={(e) => setFormData({...formData, contactName: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <input 
                                        type="tel"
                                        className="form-input"
                                        placeholder="Phone"
                                        value={formData.contactPhone || ''}
                                        onChange={(e) => setFormData({...formData, contactPhone: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <input 
                                        type="text"
                                        className="form-input"
                                        placeholder="Relationship"
                                        value={formData.contactRelationship || ''}
                                        onChange={(e) => setFormData({...formData, contactRelationship: e.target.value})}
                                    />
                                </div>
                                <button 
                                    className="btn-primary"
                                    onClick={async () => {
                                        const newContact = {
                                            name: formData.contactName,
                                            phone: formData.contactPhone,
                                            relationship: formData.contactRelationship
                                        };
                                        const contacts = data.userData?.emergencyContacts || [];
                                        contacts.push(newContact);
                                        try {
                                            await db.collection('users').doc(data.user.uid).update({
                                                emergencyContacts: contacts
                                            });
                                            alert('Emergency contact added');
                                            onClose();
                                        } catch (error) {
                                            alert('Failed to add contact');
                                        }
                                    }}
                                >
                                    Add Contact
                                </button>
                            </div>
                        );
                        
                    case 'profilePrompt':
                        return (
                            <div>
                                <h3 style={{marginBottom: '20px'}}>Complete Your Profile</h3>
                                <p style={{marginBottom: '20px', opacity: 0.9}}>
                                    Help us personalize your recovery journey by completing your profile.
                                </p>
                                <button 
                                    className="btn-primary"
                                    onClick={() => {
                                        onClose();
                                        setTimeout(() => setShowModal('account'), 100);
                                    }}
                                >
                                    Complete Profile
                                </button>
                                <button 
                                    style={{
                                        background: 'transparent',
                                        border: '1px solid rgba(255,255,255,0.3)',
                                        color: 'white',
                                        padding: '10px',
                                        borderRadius: '10px',
                                        width: '100%',
                                        marginTop: '10px',
                                        cursor: 'pointer'
                                    }}
                                    onClick={onClose}
                                >
                                    Remind Me Later
                                </button>
                            </div>
                        );
                        // Enhanced Modal Cases for ModalContainer
        // PERSONAL INFORMATION MODAL
case 'personalInfo':
    return (
        <div>
            <h3 style={{marginBottom: '20px'}}>Personal Information</h3>
            <div className="form-group">
                <label className="form-label">First Name</label>
                <input 
                    type="text"
                    className="form-input"
                    value={formData.firstName || data.userData?.firstName || ''}
                    onChange={(e) => setFormData({...formData, firstName: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">Last Name</label>
                <input 
                    type="text"
                    className="form-input"
                    value={formData.lastName || data.userData?.lastName || ''}
                    onChange={(e) => setFormData({...formData, lastName: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">Display Name</label>
                <input 
                    type="text"
                    className="form-input"
                    value={formData.displayName || data.userData?.displayName || ''}
                    onChange={(e) => setFormData({...formData, displayName: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">Phone</label>
                <input 
                    type="tel"
                    className="form-input"
                    value={formData.phone || data.userData?.phone || ''}
                    onChange={(e) => setFormData({...formData, phone: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">Date of Birth</label>
                <input 
                    type="date"
                    className="form-input"
                    value={formData.dateOfBirth || data.userData?.dateOfBirth || ''}
                    onChange={(e) => setFormData({...formData, dateOfBirth: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">Gender</label>
                <select 
                    className="form-select"
                    value={formData.gender || data.userData?.gender || ''}
                    onChange={(e) => setFormData({...formData, gender: e.target.value})}
                >
                    <option value="">Select Gender</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="non-binary">Non-Binary</option>
                    <option value="prefer-not">Prefer Not to Say</option>
                </select>
            </div>
            <div className="form-group">
                <label className="form-label">Street Address</label>
                <input 
                    type="text"
                    className="form-input"
                    value={formData.street || data.userData?.address?.street || ''}
                    onChange={(e) => setFormData({...formData, street: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">City</label>
                <input 
                    type="text"
                    className="form-input"
                    value={formData.city || data.userData?.address?.city || ''}
                    onChange={(e) => setFormData({...formData, city: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">State</label>
                <input 
                    type="text"
                    className="form-input"
                    value={formData.state || data.userData?.address?.state || ''}
                    onChange={(e) => setFormData({...formData, state: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">ZIP Code</label>
                <input 
                    type="text"
                    className="form-input"
                    value={formData.zip || data.userData?.address?.zip || ''}
                    onChange={(e) => setFormData({...formData, zip: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">Insurance Provider (Optional)</label>
                <input 
                    type="text"
                    className="form-input"
                    value={formData.insurance || data.userData?.insurance || ''}
                    onChange={(e) => setFormData({...formData, insurance: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">Insurance ID (Optional)</label>
                <input 
                    type="text"
                    className="form-input"
                    value={formData.insuranceId || data.userData?.insuranceId || ''}
                    onChange={(e) => setFormData({...formData, insuranceId: e.target.value})}
                />
            </div>
            <button 
                className="btn-primary"
                onClick={async () => {
                    try {
                        // Build update object with proper validation
                        const updates = {};
                        
                        // Handle simple fields - only add if they have values
                        if (formData.firstName !== undefined && formData.firstName !== '') {
                            updates.firstName = formData.firstName;
                        }
                        if (formData.lastName !== undefined && formData.lastName !== '') {
                            updates.lastName = formData.lastName;
                        }
                        if (formData.displayName !== undefined && formData.displayName !== '') {
                            updates.displayName = formData.displayName;
                        }
                        if (formData.phone !== undefined && formData.phone !== '') {
                            updates.phone = formData.phone;
                        }
                        if (formData.dateOfBirth !== undefined && formData.dateOfBirth !== '') {
                            updates.dateOfBirth = formData.dateOfBirth;
                        }
                        if (formData.gender !== undefined && formData.gender !== '') {
                            updates.gender = formData.gender;
                        }
                        if (formData.insurance !== undefined && formData.insurance !== '') {
                            updates.insurance = formData.insurance;
                        }
                        if (formData.insuranceId !== undefined && formData.insuranceId !== '') {
                            updates.insuranceId = formData.insuranceId;
                        }
                        
                        // Handle address as a nested object - CRITICAL for admin.html sync
                        // Only update address if at least one field is provided
                        const addressFields = ['street', 'city', 'state', 'zip'];
                        const hasAddressData = addressFields.some(field => 
                            formData[field] !== undefined && formData[field] !== ''
                        );
                        
                        if (hasAddressData) {
                            // Get existing address to merge with
                            const userDoc = await db.collection('users').doc(data.user.uid).get();
                            const existingAddress = userDoc.data()?.address || {};
                            
                            updates.address = {
                                street: formData.street !== undefined ? formData.street : (existingAddress.street || ''),
                                city: formData.city !== undefined ? formData.city : (existingAddress.city || ''),
                                state: formData.state !== undefined ? formData.state : (existingAddress.state || ''),
                                zip: formData.zip !== undefined ? formData.zip : (existingAddress.zip || '')
                            };
                        }
                        
                        // Add timestamp
                        updates.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                        
                        // Only proceed if there are updates to make
                        if (Object.keys(updates).length === 1) { // Only updatedAt
                            alert('No changes to save');
                            return;
                        }
                        
                        // Perform the update
                        await db.collection('users').doc(data.user.uid).update(updates);
                        
                        // Log what was saved for debugging
                        console.log('Saved fields:', Object.keys(updates));
                        
                        // Update local userData to reflect changes immediately
                        const updatedUserDoc = await db.collection('users').doc(data.user.uid).get();
                        if (data.setUserData) {
                            data.setUserData(updatedUserDoc.data());
                        }
                        
                        // Provide specific feedback
                        const savedFields = Object.keys(updates).filter(k => k !== 'updatedAt');
                        alert(`Successfully updated: ${savedFields.join(', ')}`);
                        
                        onClose();
                    } catch (error) {
                        console.error('Save error details:', error);
                        
                        // Provide specific error feedback
                        if (error.code === 'permission-denied') {
                            alert('Permission denied. Please try logging out and back in.');
                        } else if (error.code === 'not-found') {
                            alert('User record not found. Please contact support.');
                        } else {
                            alert(`Failed to update information: ${error.message}`);
                        }
                    }
                }}
            >
                Save Changes
            </button>
        </div>
    );
            
        // RECOVERY INFO MODAL
case 'recoveryInfo':
    return (
        <div>
            <h3 style={{marginBottom: '20px'}}>Recovery Settings</h3>
            <div className="form-group">
                <label className="form-label">
                    Sobriety Date & Time
                    <small style={{display: 'block', opacity: 0.8, marginTop: '5px', fontSize: '12px'}}>
                        Enter the date and time 24 hours after your last use
                    </small>
                </label>
                <input 
                    type="datetime-local"
                    className="form-input"
                    value={formData.sobrietyDateTime || 
                           (data.userData?.sobrietyDate ? 
                            new Date(data.userData.sobrietyDate).toISOString().slice(0, 16) : '')}
                    onChange={(e) => setFormData({...formData, sobrietyDateTime: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">Primary Substance</label>
                <select 
                    className="form-select"
                    value={formData.substance || data.userData?.substance || ''}
                    onChange={(e) => setFormData({...formData, substance: e.target.value})}
                >
                    <option value="">Select Substance</option>
                    <option value="alcohol">Alcohol</option>
                    <option value="opioids">Opioids</option>
                    <option value="stimulants">Stimulants</option>
                    <option value="cannabis">Cannabis</option>
                    <option value="benzodiazepines">Benzodiazepines</option>
                    <option value="multiple">Multiple Substances</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div className="form-group">
                <label className="form-label">Daily Cost of Use ($)</label>
                <input 
                    type="number"
                    className="form-input"
                    placeholder="Amount spent per day (e.g., 20)"
                    value={formData.dailyCost || data.userData?.dailyCost || ''}
                    onChange={(e) => setFormData({...formData, dailyCost: parseFloat(e.target.value)})}
                />
                <small style={{color: 'rgba(255,255,255,0.6)', display: 'block', marginTop: '5px'}}>
                    Used to calculate money saved in recovery
                </small>
            </div>
            
            <div className="form-group">
                <label className="form-label">Sponsor Name (Optional)</label>
                <input 
                    type="text"
                    className="form-input"
                    value={formData.sponsorName || data.userData?.sponsorName || ''}
                    onChange={(e) => setFormData({...formData, sponsorName: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">Sponsor Phone (Optional)</label>
                <input 
                    type="tel"
                    className="form-input"
                    value={formData.sponsorPhone || data.userData?.sponsorPhone || ''}
                    onChange={(e) => setFormData({...formData, sponsorPhone: e.target.value})}
                />
            </div>
            <button 
                className="btn-primary"
                onClick={async () => {
                    try {
                        const updates = {};
                        
                        // Convert datetime-local to ISO string for consistent storage
                        if (formData.sobrietyDateTime) {
                            const sobrietyDate = new Date(formData.sobrietyDateTime);
                            updates.sobrietyDate = sobrietyDate.toISOString();
                        }
                        
                        // Only add fields that have values
                        if (formData.substance !== undefined && formData.substance !== '') {
                            updates.substance = formData.substance;
                        }
                        if (formData.dailyCost !== undefined && formData.dailyCost !== '') {
                            updates.dailyCost = parseFloat(formData.dailyCost);
                        }
                        if (formData.sponsorName !== undefined && formData.sponsorName !== '') {
                            updates.sponsorName = formData.sponsorName;
                        }
                        if (formData.sponsorPhone !== undefined && formData.sponsorPhone !== '') {
                            updates.sponsorPhone = formData.sponsorPhone;
                        }
                        
                        // Add timestamp
                        updates.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                        
                        // Only proceed if there are updates
                        if (Object.keys(updates).length === 1) { // Only has updatedAt
                            alert('No changes to save');
                            return;
                        }
                        
                        // Update Firestore
                        await db.collection('users').doc(data.user.uid).update(updates);
                        
                        // Reload user data to reflect changes
                        const updatedDoc = await db.collection('users').doc(data.user.uid).get();
                        if (data.setUserData) {
                            data.setUserData(updatedDoc.data());
                            
                            // Recalculate sobriety days if date was updated
                            if (updates.sobrietyDate) {
                                const sobrietyDate = new Date(updates.sobrietyDate);
                                const today = new Date();
                                const diffTime = today - sobrietyDate;
                                const sobrietyDays = window.getSobrietyDays(userData.sobrietyDate);
                                if (data.setSobrietyDays) {
                                    data.setSobrietyDays(diffDays >= 0 ? diffDays : 0);
                                }
                                
                                // Recalculate money saved
                                if (data.setMoneySaved && updatedDoc.data().dailyCost) {
                                    data.setMoneySaved((diffDays * updatedDoc.data().dailyCost).toFixed(2));
                                }
                            }
                        }
                        
                        alert('Recovery settings updated!');
                        onClose();
                    } catch (error) {
                        console.error('Error saving recovery settings:', error);
                        alert('Failed to update settings: ' + error.message);
                    }
                }}
            >
                Save Changes
            </button>
        </div>
    );
            
        // PASSWORD & SECURITY MODAL
        case 'password':
            return (
                <div>
                    <h3 style={{marginBottom: '20px'}}>Password & Security</h3>
                    <div className="form-group">
                        <label className="form-label">Current Password</label>
                        <input 
                            type="password"
                            className="form-input"
                            value={formData.currentPassword || ''}
                            onChange={(e) => setFormData({...formData, currentPassword: e.target.value})}
                        />
                    </div>
                    <div className="form-group">
                        <label className="form-label">New Password</label>
                        <input 
                            type="password"
                            className="form-input"
                            value={formData.newPassword || ''}
                            onChange={(e) => setFormData({...formData, newPassword: e.target.value})}
                        />
                    </div>
                    <div className="form-group">
                        <label className="form-label">Confirm New Password</label>
                        <input 
                            type="password"
                            className="form-input"
                            value={formData.confirmPassword || ''}
                            onChange={(e) => setFormData({...formData, confirmPassword: e.target.value})}
                        />
                    </div>
                    <button 
                        className="btn-primary"
                        onClick={async () => {
                            if (formData.newPassword !== formData.confirmPassword) {
                                alert('Passwords do not match');
                                return;
                            }
                            try {
                                const credential = firebase.auth.EmailAuthProvider.credential(
                                    data.user.email,
                                    formData.currentPassword
                                );
                                await data.user.reauthenticateWithCredential(credential);
                                await data.user.updatePassword(formData.newPassword);
                                alert('Password updated successfully!');
                                onClose();
                            } catch (error) {
                                alert('Failed to update password. Check current password.');
                            }
                        }}
                    >
                        Update Password
                    </button>
                    
                    <div style={{marginTop: '30px', paddingTop: '20px', borderTop: '1px solid rgba(255,255,255,0.1)'}}>
                        <h4 style={{marginBottom: '15px'}}>Two-Factor Authentication</h4>
                        <p style={{fontSize: '14px', opacity: 0.8, marginBottom: '15px'}}>
                            Add an extra layer of security to your account
                        </p>
                        <button className="btn-primary" style={{background: 'rgba(76, 175, 80, 0.2)', border: '1px solid #4CAF50'}}>
                            Enable 2FA (Coming Soon)
                        </button>
                    </div>
                </div>
            );
            
        // NOTIFICATION SETTINGS MODAL
        case 'notificationSettings':
            return (
                <div>
                    <h3 style={{marginBottom: '20px'}}>Notification Settings</h3>
                    
                    <h4 style={{marginBottom: '15px', color: '#f4c430'}}>Daily Reminders</h4>
                    <div className="form-group">
                        <label className="form-label">Morning Check-in Time</label>
                        <input 
                            type="time"
                            className="form-input"
                            value={formData.morningCheckInTime || data.userData?.notifications?.morningCheckIn || '08:00'}
                            onChange={(e) => setFormData({...formData, morningCheckInTime: e.target.value})}
                        />
                    </div>
                    <div className="form-group">
                        <label className="form-label">Evening Reflection Time</label>
                        <input 
                            type="time"
                            className="form-input"
                            value={formData.eveningReflectionTime || data.userData?.notifications?.eveningReflection || '20:00'}
                            onChange={(e) => setFormData({...formData, eveningReflectionTime: e.target.value})}
                        />
                    </div>
                    <div className="form-group">
                        <label className="form-label">Daily Pledge Reminder</label>
                        <input 
                            type="time"
                            className="form-input"
                            value={formData.pledgeTime || data.userData?.notifications?.dailyPledge || '09:00'}
                            onChange={(e) => setFormData({...formData, pledgeTime: e.target.value})}
                        />
                    </div>
                    
                    <h4 style={{marginBottom: '15px', marginTop: '25px', color: '#f4c430'}}>Alert Preferences</h4>
                    <div style={{display: 'flex', flexDirection: 'column', gap: '15px'}}>
                        <label style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                            <input 
                                type="checkbox"
                                checked={formData.assignmentAlerts !== false}
                                onChange={(e) => setFormData({...formData, assignmentAlerts: e.target.checked})}
                            />
                            Assignment due date reminders
                        </label>
                        <label style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                            <input 
                                type="checkbox"
                                checked={formData.milestoneAlerts !== false}
                                onChange={(e) => setFormData({...formData, milestoneAlerts: e.target.checked})}
                            />
                            Milestone celebration alerts
                        </label>
                        <label style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                            <input 
                                type="checkbox"
                                checked={formData.messageAlerts !== false}
                                onChange={(e) => setFormData({...formData, messageAlerts: e.target.checked})}
                            />
                            New message notifications
                        </label>
                        <label style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                            <input 
                                type="checkbox"
                                checked={formData.missedCheckInAlerts !== false}
                                onChange={(e) => setFormData({...formData, missedCheckInAlerts: e.target.checked})}
                            />
                            Missed check-in reminders
                        </label>
                    </div>
                    
                    <h4 style={{marginBottom: '15px', marginTop: '25px', color: '#f4c430'}}>Time Zone</h4>
                    <div className="form-group">
                        <select 
                            className="form-select"
                            value={formData.timezone || data.userData?.timezone || 'America/Los_Angeles'}
                            onChange={(e) => setFormData({...formData, timezone: e.target.value})}
                        >
                            <option value="America/Los_Angeles">Pacific Time</option>
                            <option value="America/Denver">Mountain Time</option>
                            <option value="America/Chicago">Central Time</option>
                            <option value="America/New_York">Eastern Time</option>
                            <option value="America/Phoenix">Arizona</option>
                            <option value="Pacific/Honolulu">Hawaii</option>
                            <option value="America/Anchorage">Alaska</option>
                        </select>
                    </div>
                    
                    <button 
                        className="btn-primary"
                        onClick={async () => {
                            try {
                                await db.collection('users').doc(data.user.uid).update({
                                    notifications: {
                                        morningCheckIn: formData.morningCheckInTime,
                                        eveningReflection: formData.eveningReflectionTime,
                                        dailyPledge: formData.pledgeTime,
                                        assignmentAlerts: formData.assignmentAlerts,
                                        milestoneAlerts: formData.milestoneAlerts,
                                        messageAlerts: formData.messageAlerts,
                                        missedCheckInAlerts: formData.missedCheckInAlerts
                                    },
                                    timezone: formData.timezone
                                });
                                alert('Notification settings updated!');
                                onClose();
                            } catch (error) {
                                alert('Failed to update settings');
                            }
                        }}
                    >
                        Save Settings
                    </button>
                </div>
            );
            
   // GOOGLE CALENDAR MODAL - COMING SOON
case 'googleCalendar':
    return (
        <div>
            <h3 style={{marginBottom: '20px'}}>Google Calendar Integration</h3>
            
            {/* Coming Soon Card */}
            <div style={{
                background: 'rgba(244, 196, 48, 0.1)',
                border: '1px solid rgba(244, 196, 48, 0.3)',
                borderRadius: '10px',
                padding: '30px',
                marginBottom: '20px',
                textAlign: 'center'
            }}>
                <div style={{marginBottom: '15px'}}>
                    <i data-lucide="construction" style={{width: '64px', height: '64px', color: 'var(--color-warning)'}}></i>
                </div>
                <div style={{
                    fontSize: '24px',
                    fontWeight: 'bold',
                    marginBottom: '10px',
                    color: '#f4c430'
                }}>
                    Coming Soon!
                </div>
                <div style={{fontSize: '16px', opacity: 0.9, lineHeight: '1.6'}}>
                    We're working on Google Calendar integration.<br/>
                    This feature will be available soon.
                </div>
            </div>
            
            {/* What's Coming Info */}
            <div style={{
                background: 'rgba(33, 150, 243, 0.1)',
                border: '1px solid rgba(33, 150, 243, 0.3)',
                borderRadius: '10px',
                padding: '20px',
                marginBottom: '20px'
            }}>
                <h4 style={{color: '#2196F3', marginBottom: '15px', fontSize: '16px', display: 'flex', alignItems: 'center', gap: '8px'}}>
                    <i data-lucide="calendar" style={{width: '18px', height: '18px'}}></i>
                    What's Coming
                </h4>
                <ul style={{
                    fontSize: '14px',
                    opacity: 0.9,
                    paddingLeft: '20px',
                    margin: '10px 0',
                    lineHeight: '2'
                }}>
                    <li>Sync recovery milestones to your personal calendar</li>
                    <li>Automatic reminders for scheduled meetings</li>
                    <li>Support group session notifications</li>
                    <li>One-click calendar integration</li>
                </ul>
            </div>
            
            {/* Close Button */}
            <button 
                className="btn-primary"
                onClick={onClose}
            >
                Got It
            </button>
        </div>
    );
            
        // HELP & SUPPORT MODAL
        case 'help':
            return (
                <div>
                    <h3 style={{marginBottom: '20px'}}>Help & Support</h3>
                    
                    <div style={{
                        background: 'rgba(244, 196, 48, 0.1)',
                        border: '1px solid rgba(244, 196, 48, 0.3)',
                        borderRadius: '10px',
                        padding: '15px',
                        marginBottom: '20px'
                    }}>
                        <h4 style={{color: '#f4c430', marginBottom: '10px'}}>Need Immediate Help?</h4>
                        <div style={{marginBottom: '10px'}}>
                            <strong>Crisis Line:</strong> <a href="tel:988" style={{color: '#f4c430'}}>988</a>
                        </div>
                        <div>
                            <strong>SAMHSA Helpline:</strong> <a href="tel:1-800-662-4357" style={{color: '#f4c430'}}>1-800-662-HELP</a>
                        </div>
                    </div>
                    
                    <h4 style={{marginBottom: '15px'}}>Contact Support</h4>
                    <div style={{marginBottom: '15px'}}>
                        <strong>Email:</strong> info@glrecoveryservices.com
                    </div>
                    <div style={{marginBottom: '15px'}}>
                        <strong>Phone:</strong> Contact Your Coach
                    </div>
                    <div style={{marginBottom: '20px'}}>
                        <strong>Hours:</strong> Monday - Friday, 9am - 5pm PST
                    </div>
                    
                    <h4 style={{marginBottom: '15px'}}>Frequently Asked Questions</h4>
                    <div style={{display: 'flex', flexDirection: 'column', gap: '15px'}}>
                        <details style={{cursor: 'pointer'}}>
                            <summary style={{fontWeight: 'bold', marginBottom: '5px'}}>How do I complete a check-in?</summary>
                            <p style={{fontSize: '14px', opacity: 0.8, paddingLeft: '15px'}}>
                                Navigate to the Tasks tab and tap on Morning Check-in or Evening Reflection.
                            </p>
                        </details>
                        <details style={{cursor: 'pointer'}}>
                            <summary style={{fontWeight: 'bold', marginBottom: '5px'}}>How do I contact my coach?</summary>
                            <p style={{fontSize: '14px', opacity: 0.8, paddingLeft: '15px'}}>
                                Your coach's contact information is displayed in your profile. You can call or message them directly.
                            </p>
                        </details>
                        <details style={{cursor: 'pointer'}}>
                            <summary style={{fontWeight: 'bold', marginBottom: '5px'}}>What if I miss a check-in?</summary>
                            <p style={{fontSize: '14px', opacity: 0.8, paddingLeft: '15px'}}>
                                Missing occasional check-ins is okay. Focus on building consistency over time. Your coach will be notified of patterns.
                            </p>
                        </details>
                    </div>
                    
                    <button className="btn-primary" style={{marginTop: '20px'}} onClick={onClose}>
                        Close
                    </button>
                </div>
            );
            
        // FEEDBACK MODAL
        case 'feedback':
            return (
                <div>
                    <h3 style={{marginBottom: '20px'}}>Send Feedback</h3>
                    <p style={{fontSize: '14px', opacity: 0.8, marginBottom: '20px'}}>
                        Your feedback helps us improve the recovery experience for everyone.
                    </p>
                    <div className="form-group">
                        <label className="form-label">Feedback Type</label>
                        <select 
                            className="form-select"
                            value={formData.feedbackType || ''}
                            onChange={(e) => setFormData({...formData, feedbackType: e.target.value})}
                        >
                            <option value="">Select Type</option>
                            <option value="bug">Bug Report</option>
                            <option value="feature">Feature Request</option>
                            <option value="praise">Positive Feedback</option>
                            <option value="concern">Concern</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div className="form-group">
                        <label className="form-label">Your Feedback</label>
                        <textarea 
                            className="textarea"
                            placeholder="Tell us what's on your mind..."
                            value={formData.feedbackText || ''}
                            onChange={(e) => setFormData({...formData, feedbackText: e.target.value})}
                            style={{minHeight: '150px'}}
                        />
                    </div>
                    <button 
                        className="btn-primary"
                        onClick={async () => {
                            if (!formData.feedbackType || !formData.feedbackText) {
                                alert('Please select a type and enter feedback');
                                return;
                            }
                            try {
                                await db.collection('feedback').add({
                                    userId: data.user.uid,
                                    userName: data.userData?.displayName || data.userData?.firstName || 'Anonymous',
                                    type: formData.feedbackType,
                                    message: formData.feedbackText,
                                    status: 'new',
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                alert('Thank you for your feedback!');
                                onClose();
                            } catch (error) {
                                alert('Failed to send feedback');
                            }
                        }}
                    >
                        Send Feedback
                    </button>
                </div>
            );
            
        // EXPORT DATA MODAL
        case 'export':
            return (
                <div>
                    <h3 style={{marginBottom: '20px'}}>Export Your Data</h3>
                    <p style={{fontSize: '14px', opacity: 0.8, marginBottom: '20px'}}>
                        Download all your recovery data in your preferred format.
                    </p>
                    <div style={{display: 'flex', flexDirection: 'column', gap: '10px'}}>
                        <button
                            className="btn-primary"
                            onClick={() => {
                                triggerHaptic('light');
                                handlers.exportDataAsJSON();
                            }}
                            style={{display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px'}}
                        >
                            <i data-lucide="download" style={{width: '18px', height: '18px'}}></i>
                            Export as JSON (Technical Format)
                        </button>
                        <button
                            className="btn-primary"
                            onClick={() => {
                                triggerHaptic('light');
                                handlers.exportDataAsPDF();
                            }}
                            style={{display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px'}}
                        >
                            <i data-lucide="file-text" style={{width: '18px', height: '18px'}}></i>
                            Export as PDF (Report Format)
                        </button>
                    </div>
                    <small style={{display: 'block', marginTop: '20px', opacity: 0.6}}>
                        Your export will include all check-ins, goals, assignments, and progress data.
                    </small>
                </div>
            );
            
        // DELETE ACCOUNT MODAL
        case 'deleteAccount':
            return (
                <div>
                    <h3 style={{marginBottom: '20px', color: '#ff4757'}}>Delete Account</h3>
                    <div style={{
                        background: 'rgba(255, 71, 87, 0.1)',
                        border: '1px solid rgba(255, 71, 87, 0.3)',
                        borderRadius: '10px',
                        padding: '15px',
                        marginBottom: '20px'
                    }}>
                        <strong style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                            <i data-lucide="alert-triangle" style={{width: '18px', height: '18px', color: '#ff4757'}}></i>
                            This action cannot be undone!
                        </strong>
                        <p style={{marginTop: '10px', fontSize: '14px'}}>
                            Deleting your account will permanently remove:
                        </p>
                        <ul style={{fontSize: '14px', marginTop: '10px', paddingLeft: '20px'}}>
                            <li>All your check-ins and progress data</li>
                            <li>Goals and assignments</li>
                            <li>Messages and community posts</li>
                            <li>Your profile and settings</li>
                        </ul>
                    </div>
                    <div className="form-group">
                        <label className="form-label">Type "DELETE" to confirm:</label>
                        <input 
                            type="text"
                            className="form-input"
                            placeholder="Type DELETE"
                            value={formData.deleteConfirm || ''}
                            onChange={(e) => setFormData({...formData, deleteConfirm: e.target.value})}
                        />
                    </div>
                    <button 
                        className="btn-danger"
                        disabled={formData.deleteConfirm !== 'DELETE'}
                        onClick={async () => {
                            if (confirm('Are you absolutely sure? This cannot be undone.')) {
                                try {
                                    await db.collection('users').doc(data.user.uid).update({
                                        deleted: true,
                                        deletedAt: firebase.firestore.FieldValue.serverTimestamp()
                                    });
                                    await auth.currentUser.delete();
                                    alert('Account deleted. We wish you the best in your recovery journey.');
                                } catch (error) {
                                    alert('Failed to delete account. You may need to sign in again.');
                                }
                            }
                        }}
                    >
                        Permanently Delete Account
                    </button>
                    <button 
                        style={{
                            width: '100%',
                            padding: '14px',
                            background: 'transparent',
                            border: '1px solid rgba(255,255,255,0.3)',
                            borderRadius: '10px',
                            color: 'white',
                            cursor: 'pointer',
                            marginTop: '10px'
                        }}
                        onClick={onClose}
                    >
                        Cancel
                    </button>
                </div>
            );
            
        // TERMS OF SERVICE MODAL
        case 'terms':
            return (
                <div>
                    <h3 style={{marginBottom: '20px'}}>Terms of Service</h3>
                    <div style={{fontSize: '14px', lineHeight: '1.6', opacity: 0.9}}>
                        <h4 style={{marginTop: '15px', marginBottom: '10px'}}>1. Acceptance of Terms</h4>
                        <p>By using GLRS Recovery Services, you agree to these terms.</p>
                        
                        <h4 style={{marginTop: '15px', marginBottom: '10px'}}>2. Service Description</h4>
                        <p>GLRS provides recovery coaching and support services. We are not a medical provider.</p>
                        
                        <h4 style={{marginTop: '15px', marginBottom: '10px'}}>3. User Responsibilities</h4>
                        <p>You are responsible for maintaining the confidentiality of your account.</p>
                        
                        <h4 style={{marginTop: '15px', marginBottom: '10px'}}>4. Privacy</h4>
                        <p>Your use of our services is also governed by our Privacy Policy.</p>
                        
                        <h4 style={{marginTop: '15px', marginBottom: '10px'}}>5. Disclaimers</h4>
                        <p>Our services are not a substitute for medical treatment or professional therapy.</p>
                    </div>
                    <button className="btn-primary" style={{marginTop: '20px'}} onClick={onClose}>
                        I Understand
                    </button>
                </div>
            );
            
        // PRIVACY POLICY MODAL
        case 'privacy_policy':
            return (
                <div>
                    <h3 style={{marginBottom: '20px'}}>Privacy Policy</h3>
                    <div style={{fontSize: '14px', lineHeight: '1.6', opacity: 0.9}}>
                        <h4 style={{marginTop: '15px', marginBottom: '10px'}}>Information We Collect</h4>
                        <p>We collect information you provide directly, including recovery data and personal information.</p>
                        
                        <h4 style={{marginTop: '15px', marginBottom: '10px'}}>How We Use Your Information</h4>
                        <p>Your data is used to provide recovery support services and track your progress.</p>
                        
                        <h4 style={{marginTop: '15px', marginBottom: '10px'}}>Data Protection</h4>
                        <p>We implement appropriate security measures to protect your information.</p>
                        
                        <h4 style={{marginTop: '15px', marginBottom: '10px'}}>Your Rights</h4>
                        <p>You have the right to access, update, or delete your personal information.</p>
                    </div>
                    <button className="btn-primary" style={{marginTop: '20px'}} onClick={onClose}>
                        Close
                    </button>
                </div>
            );
            
        // ABOUT MODAL
        case 'about':
            return (
                <div>
                    <h3 style={{marginBottom: '20px'}}>About GLRS</h3>
                    <div style={{textAlign: 'center', marginBottom: '20px'}}>
                       <img 
    src="glrs-logo.png" 
    alt="GLRS Logo"
    style={{
        width: '80px',
        height: 'auto',
        objectFit: 'contain',
        margin: '0 auto'
    }}
/>
                    </div>
                    <div style={{fontSize: '14px', lineHeight: '1.6', opacity: 0.9}}>
                        <p style={{marginBottom: '15px'}}>
                            <strong>Guiding Light Recovery Services</strong>
                        </p>
                        <p style={{marginBottom: '15px'}}>
                            Version 1.0.0
                        </p>
                        <p style={{marginBottom: '15px'}}>
                            GLRS Recovery Connect is a comprehensive recovery support platform designed to help individuals 
                            maintain their sobriety journey with daily check-ins, goal tracking, and coach support.
                        </p>
                        <p style={{marginBottom: '15px'}}>
                            © 2024 Guiding Light Recovery Services. All rights reserved.
                        </p>
                    </div>
                    <button className="btn-primary" style={{marginTop: '20px'}} onClick={onClose}>
                        Close
                    </button>
                </div>
            );
                        
                    default:
                        return <div>Content not available</div>;
                }
            };
            
           return (
    <div className="modal-overlay" onClick={(e) => e.target === e.currentTarget && onClose()}>
        <div className="modal-content">
            <div className="modal-header">
                <h2 className="modal-title">{type === 'notifications' ? 'Notifications' : ''}</h2>
                <button className="close-btn" onClick={onClose}>×</button>
            </div>
            <div className="modal-body">
                {renderModalContent()}
            </div>
        </div>
    </div>
);
}

// Render the app
ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
