<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - GLRS Admin</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚öôÔ∏è</text></svg>">
    <link rel="stylesheet" href="/admin/shared/styles.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script src="/admin/shared/firebase.js"></script>
    <script src="/admin/shared/auth.js"></script>
    <script src="/admin/shared/permissions.js?v=1"></script>
    <script src="/admin/shared/utils.js"></script>
    <script src="/admin/shared/state.js?v=2"></script>
    <script type="text/babel" src="/admin/shared/navigation.js?v=7"></script>
    <script type="text/babel" src="/admin/shared/header.js?v=1"></script>
    <script type="text/babel">
(function initPage() {
    if (!window.FIREBASE_READY || !window.auth || !window.db) {
        console.log('Waiting for Firebase to initialize...');
        setTimeout(initPage, 50);
        return;
    }
    const { useState, useEffect, useRef, useMemo, useCallback } = React;
    const { auth, db, storage, CURRENT_TENANT, logAudit } = window;

// ==========================================
// PERMISSION EDITOR COMPONENT
// ==========================================
function PermissionEditor({ user }) {
    const [selectedUserId, setSelectedUserId] = useState('');
    const [selectedUser, setSelectedUser] = useState(null);
    const [userPermissions, setUserPermissions] = useState(null);
    const [users, setUsers] = useState([]);
    const [loading, setLoading] = useState(true);
    const [saving, setSaving] = useState(false);
    const [message, setMessage] = useState({ text: '', type: '' });

    // üîê Check if current user can edit permissions
    const canEdit = window.canEditPermissions(user);

    useEffect(() => {
        loadUsers();
    }, []);

    useEffect(() => {
        if (selectedUserId) {
            loadUserPermissions(selectedUserId);
        }
    }, [selectedUserId]);

    const loadUsers = async () => {
        try {
            const scope = window.getDataScope(user);
            let usersQuery = db.collection('users');

            if (scope === 'all_tenants') {
                // SuperAdmin: All users
                usersQuery = usersQuery.orderBy('displayName');
            } else {
                // SuperAdmin1/Admin: Only users in tenant
                usersQuery = usersQuery
                    .where('tenantId', '==', CURRENT_TENANT)
                    .orderBy('displayName');
            }

            const usersSnap = await usersQuery.get();
            const usersData = usersSnap.docs
                .map(doc => ({ id: doc.id, ...doc.data() }))
                .filter(u => u.role !== 'pir'); // Don't show PIRs in permission editor

            setUsers(usersData);
        } catch (error) {
            console.error('Error loading users:', error);
            setMessage({ text: 'Failed to load users', type: 'error' });
        } finally {
            setLoading(false);
        }
    };

    const loadUserPermissions = async (userId) => {
        try {
            const userDoc = await db.collection('users').doc(userId).get();
            if (userDoc.exists) {
                const userData = { id: userDoc.id, ...userDoc.data() };
                setSelectedUser(userData);

                // Ensure permissions object exists
                const perms = userData.permissions || window.getDefaultPermissions(userData.role);
                setUserPermissions(perms);
            }
        } catch (error) {
            console.error('Error loading user permissions:', error);
            setMessage({ text: 'Failed to load permissions', type: 'error' });
        }
    };

    const togglePermission = (permissionKey) => {
        if (!canEdit) return;
        setUserPermissions(prev => ({
            ...prev,
            [permissionKey]: !prev[permissionKey]
        }));
    };

    const updateScope = (newScope) => {
        if (!canEdit) return;
        setUserPermissions(prev => ({
            ...prev,
            scope: newScope
        }));
    };

    const applyPreset = (presetName) => {
        if (!canEdit) return;

        let preset;
        if (presetName === 'SUPERADMIN1') preset = window.SUPERADMIN1_PRESET;
        else if (presetName === 'ADMIN') preset = window.ADMIN_PRESET;
        else if (presetName === 'COACH') preset = window.COACH_PRESET;

        if (preset) {
            setUserPermissions({ ...preset });
            setMessage({ text: `Applied ${presetName} preset`, type: 'success' });
        }
    };

    const savePermissions = async () => {
        if (!canEdit) {
            setMessage({ text: 'You do not have permission to edit permissions', type: 'error' });
            return;
        }

        setSaving(true);
        try {
            await db.collection('users').doc(selectedUserId).update({
                permissions: userPermissions,
                permissionsLastModified: firebase.firestore.FieldValue.serverTimestamp(),
                permissionsModifiedBy: user.uid
            });

            // Audit log
            await logAudit('permissions_updated', {
                targetUserId: selectedUserId,
                targetUserEmail: selectedUser.email,
                modifiedBy: user.email,
                timestamp: new Date().toISOString()
            });

            setMessage({ text: '‚úÖ Permissions saved successfully', type: 'success' });
        } catch (error) {
            console.error('Error saving permissions:', error);
            setMessage({ text: '‚ùå Failed to save permissions', type: 'error' });
        } finally {
            setSaving(false);
        }
    };

    if (!canEdit) {
        return (
            <div style={{
                background: 'linear-gradient(135deg, rgba(220, 53, 69, 0.1) 0%, rgba(192, 46, 60, 0.1) 100%)',
                border: '1px solid rgba(220, 53, 69, 0.3)',
                borderRadius: '12px',
                padding: '30px',
                textAlign: 'center'
            }}>
                <h3 style={{ color: '#dc3545', marginBottom: '10px' }}>üîí Access Restricted</h3>
                <p style={{ color: '#ccc' }}>Only SuperAdmin and SuperAdmin1 can edit permissions.</p>
            </div>
        );
    }

    return (
        <div style={{
            background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%)',
            border: '1px solid rgba(255,255,255,0.1)',
            borderRadius: '20px',
            padding: '30px'
        }}>
            <h3 style={{
                marginBottom: '30px',
                background: 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)',
                WebkitBackgroundClip: 'text',
                WebkitTextFillColor: 'transparent',
                fontSize: '28px'
            }}>üîê Permission Editor</h3>

            {message.text && (
                <div style={{
                    padding: '15px',
                    borderRadius: '8px',
                    marginBottom: '20px',
                    background: message.type === 'success' ? 'rgba(76, 175, 80, 0.2)' : 'rgba(220, 53, 69, 0.2)',
                    border: `1px solid ${message.type === 'success' ? '#4caf50' : '#dc3545'}`,
                    color: message.type === 'success' ? '#4caf50' : '#dc3545'
                }}>
                    {message.text}
                </div>
            )}

            {/* USER SELECTION */}
            <div style={{ marginBottom: '30px' }}>
                <label style={{ display: 'block', marginBottom: '10px', color: '#0077CC', fontWeight: '600' }}>
                    Select User to Edit Permissions
                </label>
                <select
                    value={selectedUserId}
                    onChange={(e) => setSelectedUserId(e.target.value)}
                    style={{
                        width: '100%',
                        padding: '12px',
                        borderRadius: '8px',
                        border: '1px solid rgba(255,255,255,0.2)',
                        background: 'rgba(255,255,255,0.05)',
                        color: '#fff',
                        fontSize: '16px'
                    }}
                >
                    <option value="">-- Select a user --</option>
                    {users.map(u => (
                        <option key={u.id} value={u.id}>
                            {u.displayName || u.email} ({u.role})
                        </option>
                    ))}
                </select>
            </div>

            {selectedUser && userPermissions && (
                <>
                    {/* USER INFO */}
                    <div style={{
                        background: 'rgba(255,255,255,0.05)',
                        padding: '20px',
                        borderRadius: '12px',
                        marginBottom: '30px',
                        border: '1px solid rgba(255,255,255,0.1)'
                    }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div>
                                <h4 style={{ color: '#fff', marginBottom: '5px' }}>{selectedUser.displayName || selectedUser.email}</h4>
                                <p style={{ color: '#999', fontSize: '14px' }}>Role: <span style={{ color: '#667eea' }}>{selectedUser.role}</span></p>
                            </div>
                            <div style={{ display: 'flex', gap: '10px' }}>
                                <button onClick={() => applyPreset('SUPERADMIN1')} style={{
                                    padding: '8px 16px',
                                    background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '6px',
                                    cursor: 'pointer',
                                    fontSize: '14px'
                                }}>Apply SuperAdmin1</button>
                                <button onClick={() => applyPreset('ADMIN')} style={{
                                    padding: '8px 16px',
                                    background: 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '6px',
                                    cursor: 'pointer',
                                    fontSize: '14px'
                                }}>Apply Admin</button>
                                <button onClick={() => applyPreset('COACH')} style={{
                                    padding: '8px 16px',
                                    background: 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '6px',
                                    cursor: 'pointer',
                                    fontSize: '14px'
                                }}>Apply Coach</button>
                            </div>
                        </div>
                    </div>

                    {/* PAGE ACCESS PERMISSIONS */}
                    <div style={{ marginBottom: '30px' }}>
                        <h4 style={{ color: '#667eea', marginBottom: '15px', fontSize: '20px' }}>üìÑ Page Access Permissions</h4>
                        <div style={{
                            display: 'grid',
                            gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))',
                            gap: '12px'
                        }}>
                            {['dashboard', 'users', 'my_pirs', 'feedback', 'resources', 'goals', 'community', 'checkins', 'alerts', 'reports', 'settings', 'audit_logs'].map(page => (
                                <div key={page} style={{
                                    background: userPermissions[`access_${page}`] ? 'rgba(76, 175, 80, 0.2)' : 'rgba(220, 53, 69, 0.2)',
                                    border: `1px solid ${userPermissions[`access_${page}`] ? '#4caf50' : '#dc3545'}`,
                                    padding: '12px',
                                    borderRadius: '8px',
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center',
                                    cursor: 'pointer'
                                }} onClick={() => togglePermission(`access_${page}`)}>
                                    <span style={{ color: '#fff', fontSize: '14px' }}>
                                        {page.replace(/_/g, ' ').toUpperCase()}
                                    </span>
                                    <div style={{
                                        width: '50px',
                                        height: '24px',
                                        background: userPermissions[`access_${page}`] ? '#4caf50' : '#666',
                                        borderRadius: '12px',
                                        position: 'relative',
                                        transition: 'background 0.3s'
                                    }}>
                                        <div style={{
                                            width: '20px',
                                            height: '20px',
                                            background: 'white',
                                            borderRadius: '50%',
                                            position: 'absolute',
                                            top: '2px',
                                            left: userPermissions[`access_${page}`] ? '28px' : '2px',
                                            transition: 'left 0.3s'
                                        }}></div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* ACTION PERMISSIONS */}
                    <div style={{ marginBottom: '30px' }}>
                        <h4 style={{ color: '#667eea', marginBottom: '15px', fontSize: '20px' }}>‚ö° Action Permissions</h4>
                        <div style={{
                            display: 'grid',
                            gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))',
                            gap: '12px'
                        }}>
                            {['create_pir', 'delete_pir', 'create_resource', 'delete_resource', 'create_coach', 'create_admin', 'create_superadmin1', 'modify_settings', 'export_data', 'view_audit_logs', 'impersonate', 'create_goal', 'create_assignment', 'send_message'].map(action => (
                                <div key={action} style={{
                                    background: userPermissions[`action_${action}`] ? 'rgba(76, 175, 80, 0.2)' : 'rgba(220, 53, 69, 0.2)',
                                    border: `1px solid ${userPermissions[`action_${action}`] ? '#4caf50' : '#dc3545'}`,
                                    padding: '12px',
                                    borderRadius: '8px',
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center',
                                    cursor: 'pointer'
                                }} onClick={() => togglePermission(`action_${action}`)}>
                                    <span style={{ color: '#fff', fontSize: '14px' }}>
                                        {action.replace(/_/g, ' ').toUpperCase()}
                                    </span>
                                    <div style={{
                                        width: '50px',
                                        height: '24px',
                                        background: userPermissions[`action_${action}`] ? '#4caf50' : '#666',
                                        borderRadius: '12px',
                                        position: 'relative',
                                        transition: 'background 0.3s'
                                    }}>
                                        <div style={{
                                            width: '20px',
                                            height: '20px',
                                            background: 'white',
                                            borderRadius: '50%',
                                            position: 'absolute',
                                            top: '2px',
                                            left: userPermissions[`action_${action}`] ? '28px' : '2px',
                                            transition: 'left 0.3s'
                                        }}></div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* DATA SCOPE */}
                    <div style={{ marginBottom: '30px' }}>
                        <h4 style={{ color: '#667eea', marginBottom: '15px', fontSize: '20px' }}>üîç Data Scope</h4>
                        <select
                            value={userPermissions.scope || 'own_data'}
                            onChange={(e) => updateScope(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '12px',
                                borderRadius: '8px',
                                border: '1px solid rgba(255,255,255,0.2)',
                                background: 'rgba(255,255,255,0.05)',
                                color: '#fff',
                                fontSize: '16px'
                            }}
                        >
                            <option value="own_data">Own Data Only</option>
                            <option value="assigned_pirs">Assigned PIRs Only (Coach scope)</option>
                            <option value="all_pirs_tenant">All PIRs in Tenant</option>
                            <option value="all_coaches_tenant">All Coaches in Tenant</option>
                            <option value="all_tenants">All Tenants (SuperAdmin only)</option>
                        </select>
                    </div>

                    {/* SAVE BUTTON */}
                    <div style={{ textAlign: 'right' }}>
                        <button onClick={savePermissions} disabled={saving} style={{
                            padding: '15px 40px',
                            background: saving ? '#666' : 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)',
                            color: 'white',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: saving ? 'not-allowed' : 'pointer',
                            fontSize: '18px',
                            fontWeight: 'bold'
                        }}>
                            {saving ? 'Saving...' : 'üíæ Save Permissions'}
                        </button>
                    </div>
                </>
            )}
        </div>
    );
}

function SettingsView({ user }) {
    // ========== STATE VARIABLES ==========
    const [activeSection, setActiveSection] = useState('profile');
    const [settings, setSettings] = useState({
        // Notification Settings
        emailNotifications: false,
        smsNotifications: false,
        pushNotifications: true,
        sosAlertEmail: true,
        sosAlertSMS: false,
        dailyDigest: false,
        weeklyReport: false,
        
        // Check-in Settings
        checkInReminderTime: '09:00',
        eveningReminderTime: '20:00',
        missedCheckInAlert: true,
        
        // Alert Thresholds
        lowMoodThreshold: 3,
        highCravingThreshold: 7,
        highAnxietyThreshold: 7,
        poorSleepThreshold: 3,
        
        // System Settings
        timezone: 'America/Los_Angeles',
        dateFormat: 'MM/DD/YYYY',
        timeFormat: '12h',
        language: 'en',
        autoRefresh: 30,
        
        // Data Management
        autoBackupEnabled: false,
        backupFrequency: 'weekly',
        dataRetentionDays: 2555,
        autoArchiveOldMessages: true,
        archiveAfterDays: 90
    });
    
    const [coaches, setCoaches] = useState([]);
    const [pirs, setPirs] = useState([]);
    const [permissions, setPermissions] = useState({});
    const [saving, setSaving] = useState(false);
    const [loading, setLoading] = useState(true);
    const [googleConnected, setGoogleConnected] = useState(false);
    const [googleEmail, setGoogleEmail] = useState('');
    const [lastGoogleSync, setLastGoogleSync] = useState(null);
    const [notificationPrefs, setNotificationPrefs] = useState({
        // Email Notifications
        emailOnSOS: true,
        emailOnMissedCheckIn: true,
        emailOnNewPIR: true,
        emailOnGoalComplete: false,
        emailOnAlert: true,
        // Push Notifications
        pushOnSOS: true,
        pushOnMessage: false,
        pushOnAlert: true,
        // Calendar Integration
        calendarOnSOS: true,
        calendarOnMeeting: true,
        calendarOnMissedCheckIn: true,
        calendarAutoSync: true,
        // Quiet Hours
        quietHoursEnabled: false,
        quietHoursStart: '22:00',
        quietHoursEnd: '08:00',
        // Digest Settings
        dailyDigest: true,
        dailyDigestTime: '09:00',
        weeklyReport: true
    });

    // Profile-specific state
    const [profileData, setProfileData] = useState({
        firstName: user.firstName || '',
        lastName: user.lastName || '',
        displayName: user.displayName || '',
        phone: user.phone || '',
        email: user.email || '',
        role: user.role || ''
    });
    const [editingProfile, setEditingProfile] = useState(false);
    const [passwordData, setPasswordData] = useState({
        currentPassword: '',
        newPassword: '',
        confirmPassword: ''
    });
    const [showPassword, setShowPassword] = useState({
        current: false,
        new: false,
        confirm: false
    });
    const [passwordStrength, setPasswordStrength] = useState(0);

    // User creation form state
    const [showAddCoachForm, setShowAddCoachForm] = useState(false);
    const [showAddPIRForm, setShowAddPIRForm] = useState(false);
    const [newUserData, setNewUserData] = useState({
        email: '',
        password: '',
        firstName: '',
        lastName: '',
        assignedCoach: ''
    });

    // ========== USEEFFECT - INITIALIZATION ==========
    useEffect(() => {
        loadAllSettings();
        loadGoogleConnectionStatus();
        loadNotificationPreferences();
    }, []);

    // ========== LOAD ALL SETTINGS ==========
    const loadAllSettings = async () => {
        try {
            const [settingsDoc, coachesSnap, pirsSnap, permissionsDoc] = await Promise.all([
                db.collection('settings').doc('system').get(),
                db.collection('users').where('role', 'in', ['coach', 'admin']).get(),
                db.collection('users').where('role', '==', 'pir').get(),
                db.collection('settings').doc('permissions').get()
            ]);

            if (settingsDoc.exists) {
                setSettings({ ...settings, ...settingsDoc.data() });
            }

            setCoaches(coachesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            setPirs(pirsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })));

            if (permissionsDoc.exists) {
                setPermissions(permissionsDoc.data());
            }
        } catch (error) {
            console.error('Error loading settings:', error);
        } finally {
            setLoading(false);
        }
    };

    // ========== SAVE SETTINGS ==========
    const saveSettings = async () => {
        setSaving(true);
        try {
            await db.collection('settings').doc('system').set({
                ...settings,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: user.uid
            });
            alert('Settings saved successfully');
        } catch (error) {
            console.error('Error saving settings:', error);
            alert('Failed to save settings');
        } finally {
            setSaving(false);
        }
    };

    // ========== GOOGLE OAUTH INTEGRATION ==========
    const loadGoogleConnectionStatus = async () => {
        try {
            const userDoc = await db.collection('users').doc(user.uid).get();
            if (userDoc.exists) {
                const userData = userDoc.data();
                setGoogleConnected(userData.googleConnected || false);
                setGoogleEmail(userData.googleEmail || '');
                setLastGoogleSync(userData.lastGoogleSync || null);
            }
        } catch (error) {
            console.error('Error loading Google connection status:', error);
        }
    };

    const handleGoogleConnect = async () => {
        try {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.addScope('https://www.googleapis.com/auth/calendar');
            provider.addScope('https://www.googleapis.com/auth/calendar.events');

            const result = await auth.currentUser.linkWithPopup(provider);
            const credential = result.credential;
            const token = credential.accessToken;

            // Save token and connection info to user document
            await db.collection('users').doc(user.uid).update({
                googleAccessToken: token,
                googleRefreshToken: credential.refreshToken || null,
                googleConnected: true,
                googleEmail: result.user.email,
                googleConnectionDate: firebase.firestore.FieldValue.serverTimestamp(),
                lastGoogleSync: firebase.firestore.FieldValue.serverTimestamp()
            });

            setGoogleConnected(true);
            setGoogleEmail(result.user.email);
            setLastGoogleSync(new Date());

            // Log audit trail
            await logAudit({
                userId: user.uid,
                tenantId: CURRENT_TENANT,
                action: 'google-connected',
                resourceType: 'integrations',
                resourceId: user.uid,
                details: { email: result.user.email }
            });

            alert('‚úÖ Google Calendar connected successfully!');
        } catch (error) {
            console.error('Google OAuth error:', error);
            if (error.code === 'auth/credential-already-in-use') {
                alert('This Google account is already linked to another user.');
            } else {
                alert('Failed to connect Google Calendar. Please try again.');
            }
        }
    };

    const handleGoogleDisconnect = async () => {
        if (!confirm('Are you sure you want to disconnect Google Calendar? This will stop all calendar syncing.')) {
            return;
        }

        try {
            await db.collection('users').doc(user.uid).update({
                googleAccessToken: firebase.firestore.FieldValue.delete(),
                googleRefreshToken: firebase.firestore.FieldValue.delete(),
                googleConnected: false,
                googleEmail: firebase.firestore.FieldValue.delete(),
                googleDisconnectedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            setGoogleConnected(false);
            setGoogleEmail('');
            setLastGoogleSync(null);

            // Log audit trail
            await logAudit({
                userId: user.uid,
                tenantId: CURRENT_TENANT,
                action: 'google-disconnected',
                resourceType: 'integrations',
                resourceId: user.uid
            });

            alert('Google Calendar disconnected successfully');
        } catch (error) {
            console.error('Error disconnecting Google:', error);
            alert('Failed to disconnect Google Calendar');
        }
    };

    // ========== GOOGLE CALENDAR SYNC ==========
    const syncToGoogleCalendar = async () => {
        if (!googleConnected) {
            alert('Please connect Google Calendar first');
            return;
        }

        setSaving(true);
        try {
            const userDoc = await db.collection('users').doc(user.uid).get();
            const accessToken = userDoc.data().googleAccessToken;

            if (!accessToken) {
                alert('Google access token not found. Please reconnect.');
                return;
            }

            // Get all meetings from Firestore
            const meetingsSnap = await db.collection('meetings')
                .where('tenantId', '==', CURRENT_TENANT)
                .get();

            let synced = 0;
            const errors = [];

            for (const doc of meetingsSnap.docs) {
                const meeting = { id: doc.id, ...doc.data() };

                // Skip if already synced
                if (meeting.googleEventId) continue;

                try {
                    const event = {
                        summary: meeting.title || 'GLRS Meeting',
                        description: meeting.description || 'Meeting scheduled via GLRS',
                        start: {
                            dateTime: meeting.startTime?.toDate ? meeting.startTime.toDate().toISOString() : new Date(meeting.date).toISOString(),
                            timeZone: 'America/Los_Angeles'
                        },
                        end: {
                            dateTime: meeting.endTime?.toDate ? meeting.endTime.toDate().toISOString() : new Date(new Date(meeting.date).getTime() + 3600000).toISOString(),
                            timeZone: 'America/Los_Angeles'
                        }
                    };

                    const response = await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(event)
                    });

                    if (response.ok) {
                        const data = await response.json();
                        await db.collection('meetings').doc(meeting.id).update({
                            googleEventId: data.id,
                            lastSyncedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        synced++;
                    } else {
                        const error = await response.json();
                        errors.push(`${meeting.title}: ${error.message || 'Unknown error'}`);
                    }
                } catch (error) {
                    errors.push(`${meeting.title}: ${error.message}`);
                }
            }

            // Update last sync time
            await db.collection('users').doc(user.uid).update({
                lastGoogleSync: firebase.firestore.FieldValue.serverTimestamp()
            });

            setLastGoogleSync(new Date());

            if (errors.length > 0) {
                alert(`‚úÖ Synced ${synced} meetings to Google Calendar\n\n‚ùå ${errors.length} failed:\n${errors.slice(0, 3).join('\n')}${errors.length > 3 ? '\n...' : ''}`);
            } else {
                alert(`‚úÖ Successfully synced ${synced} meetings to Google Calendar!`);
            }
        } catch (error) {
            console.error('Error syncing to Google Calendar:', error);
            alert('Failed to sync to Google Calendar: ' + error.message);
        } finally {
            setSaving(false);
        }
    };

    const syncFromGoogleCalendar = async () => {
        if (!googleConnected) {
            alert('Please connect Google Calendar first');
            return;
        }

        setSaving(true);
        try {
            const userDoc = await db.collection('users').doc(user.uid).get();
            const accessToken = userDoc.data().googleAccessToken;

            if (!accessToken) {
                alert('Google access token not found. Please reconnect.');
                return;
            }

            // Get events from Google Calendar (next 30 days)
            const timeMin = new Date().toISOString();
            const timeMax = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString();

            const response = await fetch(
                `https://www.googleapis.com/calendar/v3/calendars/primary/events?timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`,
                {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                }
            );

            if (!response.ok) {
                throw new Error('Failed to fetch Google Calendar events');
            }

            const data = await response.json();
            let imported = 0;

            for (const event of data.items || []) {
                // Skip if event already exists in Firestore
                const existingSnap = await db.collection('meetings')
                    .where('googleEventId', '==', event.id)
                    .limit(1)
                    .get();

                if (!existingSnap.empty) continue;

                // Create meeting in Firestore
                await db.collection('meetings').add({
                    title: event.summary || 'Imported Meeting',
                    description: event.description || '',
                    startTime: firebase.firestore.Timestamp.fromDate(new Date(event.start.dateTime || event.start.date)),
                    endTime: firebase.firestore.Timestamp.fromDate(new Date(event.end.dateTime || event.end.date)),
                    googleEventId: event.id,
                    tenantId: CURRENT_TENANT,
                    createdBy: user.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    importedFromGoogle: true
                });
                imported++;
            }

            // Update last sync time
            await db.collection('users').doc(user.uid).update({
                lastGoogleSync: firebase.firestore.FieldValue.serverTimestamp()
            });

            setLastGoogleSync(new Date());
            alert(`‚úÖ Successfully imported ${imported} events from Google Calendar!`);
        } catch (error) {
            console.error('Error importing from Google Calendar:', error);
            alert('Failed to import from Google Calendar: ' + error.message);
        } finally {
            setSaving(false);
        }
    };

    // ========== NOTIFICATION PREFERENCES ==========
    const loadNotificationPreferences = async () => {
        try {
            const notifDoc = await db.collection('settings').doc(`${user.uid}-notifications`).get();
            if (notifDoc.exists) {
                setNotificationPrefs({ ...notificationPrefs, ...notifDoc.data() });
            }
        } catch (error) {
            console.error('Error loading notification preferences:', error);
        }
    };

    const saveNotificationPreferences = async () => {
        setSaving(true);
        try {
            await db.collection('settings').doc(`${user.uid}-notifications`).set({
                ...notificationPrefs,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: user.uid,
                tenantId: CURRENT_TENANT
            });

            // Log audit trail
            await logAudit({
                userId: user.uid,
                tenantId: CURRENT_TENANT,
                action: 'notification-preferences-updated',
                resourceType: 'settings',
                resourceId: `${user.uid}-notifications`
            });

            alert('‚úÖ Notification preferences saved successfully!');
        } catch (error) {
            console.error('Error saving notification preferences:', error);
            alert('Failed to save notification preferences');
        } finally {
            setSaving(false);
        }
    };

    // ========== PROFILE MANAGEMENT ==========
    const calculatePasswordStrength = (password) => {
        let strength = 0;
        if (password.length >= 8) strength += 25;
        if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength += 25;
        if (password.match(/[0-9]/)) strength += 25;
        if (password.match(/[^a-zA-Z0-9]/)) strength += 25;
        return strength;
    };

    const handlePasswordChange = (value) => {
        setPasswordData({...passwordData, newPassword: value});
        setPasswordStrength(calculatePasswordStrength(value));
    };

    const getPasswordStrengthColor = () => {
        if (passwordStrength <= 25) return '#f44336';
        if (passwordStrength <= 50) return '#FF9800';
        if (passwordStrength <= 75) return '#FFC107';
        return '#00A86B';
    };

    const getPasswordStrengthLabel = () => {
        if (passwordStrength <= 25) return 'Weak';
        if (passwordStrength <= 50) return 'Fair';
        if (passwordStrength <= 75) return 'Good';
        return 'Strong';
    };

    const handleSaveProfile = async () => {
        setSaving(true);
        try {
            const updates = {
                firstName: profileData.firstName,
                lastName: profileData.lastName,
                displayName: `${profileData.firstName} ${profileData.lastName}`,
                phone: profileData.phone,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            await db.collection('users').doc(user.uid).update(updates);

            // Log audit trail
            await logAudit({
                userId: user.uid,
                tenantId: CURRENT_TENANT,
                action: 'profile-updated',
                resourceType: 'user',
                resourceId: user.uid
            });

            // Update user object
            Object.assign(user, updates);

            setEditingProfile(false);
            alert('‚úÖ Profile updated successfully!');
        } catch (error) {
            console.error('Error updating profile:', error);
            alert('Failed to update profile: ' + error.message);
        } finally {
            setSaving(false);
        }
    };

    const handleChangePassword = async () => {
        if (passwordData.newPassword !== passwordData.confirmPassword) {
            alert('New passwords do not match');
            return;
        }

        if (passwordData.newPassword.length < 6) {
            alert('Password must be at least 6 characters');
            return;
        }

        setSaving(true);
        try {
            const credential = firebase.auth.EmailAuthProvider.credential(
                user.email,
                passwordData.currentPassword
            );

            await auth.currentUser.reauthenticateWithCredential(credential);
            await auth.currentUser.updatePassword(passwordData.newPassword);

            // Log audit trail
            await logAudit({
                userId: user.uid,
                tenantId: CURRENT_TENANT,
                action: 'password-changed',
                resourceType: 'user',
                resourceId: user.uid
            });

            alert('‚úÖ Password changed successfully!');
            setPasswordData({
                currentPassword: '',
                newPassword: '',
                confirmPassword: ''
            });
            setPasswordStrength(0);
        } catch (error) {
            console.error('Error changing password:', error);
            if (error.code === 'auth/wrong-password') {
                alert('Current password is incorrect');
            } else {
                alert('Failed to change password: ' + error.message);
            }
        } finally {
            setSaving(false);
        }
    };

    // ========== ADD COACH ==========
    const handleAddCoach = () => {
        setShowAddCoachForm(!showAddCoachForm);
        setShowAddPIRForm(false);
        setNewUserData({ email: '', password: '', firstName: '', lastName: '', assignedCoach: '' });
    };

    const submitAddCoach = async () => {
        const { email, password, firstName, lastName } = newUserData;

        if (!email || !password || !firstName || !lastName) {
            alert('Please fill in all fields');
            return;
        }

        setSaving(true);
        try {
            const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);

            await db.collection('users').doc(userCredential.user.uid).set({
                email,
                firstName,
                lastName,
                displayName: `${firstName} ${lastName}`,
                role: 'coach',
                active: true,
                tenantId: CURRENT_TENANT,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: user.uid
            });

            await loadAllSettings();
            setShowAddCoachForm(false);
            setNewUserData({ email: '', password: '', firstName: '', lastName: '', assignedCoach: '' });
            alert('‚úÖ Coach added successfully!');
        } catch (error) {
            console.error('Error adding coach:', error);
            alert('Failed to add coach: ' + error.message);
        } finally {
            setSaving(false);
        }
    };

    // ========== ADD PIR ==========
    const handleAddPIR = () => {
        setShowAddPIRForm(!showAddPIRForm);
        setShowAddCoachForm(false);
        setNewUserData({ email: '', password: '', firstName: '', lastName: '', assignedCoach: '' });
    };

    const submitAddPIR = async () => {
        const { email, password, firstName, lastName, assignedCoach } = newUserData;

        if (!email || !password || !firstName || !lastName) {
            alert('Please fill in all required fields');
            return;
        }

        setSaving(true);
        try {
            const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);

            await db.collection('users').doc(userCredential.user.uid).set({
                email,
                firstName,
                lastName,
                displayName: `${firstName} ${lastName}`,
                role: 'pir',
                active: true,
                assignedCoach: assignedCoach || null,
                tenantId: CURRENT_TENANT,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: user.uid
            });

            await loadAllSettings();
            setShowAddPIRForm(false);
            setNewUserData({ email: '', password: '', firstName: '', lastName: '', assignedCoach: '' });
            alert('‚úÖ PIR added successfully!');
        } catch (error) {
            console.error('Error adding PIR:', error);
            alert('Failed to add PIR: ' + error.message);
        } finally {
            setSaving(false);
        }
    };

    // ========== REMOVE USER ==========
    const handleRemoveUser = async (userId, role) => {
        if (!confirm(`Are you sure you want to remove this ${role}?`)) return;

        try {
            await db.collection('users').doc(userId).update({
                active: false,
                deactivatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                deactivatedBy: user.uid
            });

            await loadAllSettings();
            alert(`${role} removed successfully`);
        } catch (error) {
            console.error('Error removing user:', error);
            alert('Failed to remove user');
        }
    };

    // ========== ASSIGN COACH ==========
    const handleAssignCoach = async (pirId) => {
        const coachId = prompt('Enter coach ID to assign:');
        if (!coachId) return;

        try {
            await db.collection('users').doc(pirId).update({
                assignedCoach: coachId,
                assignedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            await loadAllSettings();
            alert('Coach assigned successfully');
        } catch (error) {
            console.error('Error assigning coach:', error);
            alert('Failed to assign coach');
        }
    };

    // ========== CHANGE COACH ==========
    const handleChangeCoach = async (pirId, currentCoachId) => {
        const newCoachId = prompt('Enter new coach ID:', currentCoachId);
        if (!newCoachId) return;

        try {
            await db.collection('users').doc(pirId).update({
                assignedCoach: newCoachId,
                coachChangedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            await loadAllSettings();
            alert('Coach changed successfully');
        } catch (error) {
            console.error('Error changing coach:', error);
            alert('Failed to change coach');
        }
    };

    // ========== UPDATE PERMISSIONS ==========
    const updatePermissions = async (userId, permissionType, value) => {
        try {
            const updatedPermissions = {
                ...permissions,
                [userId]: {
                    ...permissions[userId],
                    [permissionType]: value
                }
            };

            await db.collection('settings').doc('permissions').set(updatedPermissions);
            setPermissions(updatedPermissions);
            alert('Permissions updated');
        } catch (error) {
            console.error('Error updating permissions:', error);
            alert('Failed to update permissions');
        }
    };

    // ========== DATA EXPORT ==========
    const handleDataExport = async (format, scope, dataType) => {
        try {
            let data = {};

            if (scope === 'all') {
                const collections = ['users', 'checkIns', 'assignments', 'alerts', 'messages', 'goals', 'feedback', 'activities', 'notifications'];
                
                for (const collection of collections) {
                    const snapshot = await db.collection(collection).get();
                    data[collection] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }
            } else if (scope === 'specific_pir') {
                const pirId = prompt('Enter PIR ID:');
                if (!pirId) return;

                const pirDoc = await db.collection('users').doc(pirId).get();
                if (!pirDoc.exists) {
                    alert('PIR not found');
                    return;
                }

                data.pir = { id: pirDoc.id, ...pirDoc.data() };
                
                const [checkIns, assignments, goals, alerts, messages] = await Promise.all([
                    db.collection('checkIns').where('userId', '==', pirId).get(),
                    db.collection('assignments').where('userId', '==', pirId).get(),
                    db.collection('goals').where('userId', '==', pirId).get(),
                    db.collection('alerts').where('userId', '==', pirId).get(),
                    db.collection('messages').where('senderId', '==', pirId).get()
                ]);

                data.checkIns = checkIns.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                data.assignments = assignments.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                data.goals = goals.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                data.alerts = alerts.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                data.messages = messages.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } else if (scope === 'data_type') {
                const snapshot = await db.collection(dataType).get();
                data[dataType] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }

            const fileName = `glrs_export_${scope}_${new Date().toISOString().split('T')[0]}`;

            if (format === 'json') {
                exportToJSON(data, fileName);
            } else if (format === 'csv') {
                exportToCSV(data, fileName);
            } else if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text('Data Export', 20, 20);
                doc.text(JSON.stringify(data, null, 2).substring(0, 1000), 20, 30);
                doc.save(`${fileName}.pdf`);
            }

            alert('Export completed successfully');
        } catch (error) {
            console.error('Error exporting data:', error);
            alert('Export failed: ' + error.message);
        }
    };

    // ========== LOADING STATE ==========
    if (loading) {
        return (
            <div className="loading-container">
                <div className="loading-spinner"></div>
            </div>
        );
    }

    // ========== RETURN JSX ==========
    return (
        <div style={{ display: 'flex', gap: '20px', minHeight: '100vh' }}>
            {/* SIDEBAR NAVIGATION */}
            <div style={{
                width: '280px',
                background: 'linear-gradient(180deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.05) 100%)',
                borderRadius: '20px',
                padding: '30px 20px',
                backdropFilter: 'blur(10px)',
                border: '1px solid rgba(255,255,255,0.1)'
            }}>
                <h3 style={{
                    marginBottom: '30px',
                    background: 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)',
                    WebkitBackgroundClip: 'text',
                    WebkitTextFillColor: 'transparent',
                    fontSize: '24px',
                    fontWeight: 'bold'
                }}>Settings</h3>
                
                {[
                    { id: 'profile', icon: 'üë§', label: 'My Profile' },
                    { id: 'notifications', icon: 'üîî', label: 'Notifications' },
                    { id: 'checkins', icon: '‚úÖ', label: 'Check-ins' },
                    { id: 'alerts', icon: '‚ö†Ô∏è', label: 'Alert Thresholds' },
                    { id: 'dataExport', icon: 'üì•', label: 'Data Export' },
                    { id: 'userManagement', icon: 'üë•', label: 'User Management' },
                    { id: 'permissions', icon: 'üîê', label: 'Permissions' },
                    { id: 'integrations', icon: 'üîå', label: 'Integrations' },
                    { id: 'system', icon: '‚öôÔ∏è', label: 'System Config' }
                ].map(section => (
                    <div
                        key={section.id}
                        onClick={() => setActiveSection(section.id)}
                        style={{
                            padding: '16px 20px',
                            borderRadius: '12px',
                            cursor: 'pointer',
                            background: activeSection === section.id
                                ? 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)'
                                : 'transparent',
                            marginBottom: '8px',
                            transition: 'all 0.3s',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '12px',
                            transform: activeSection === section.id ? 'translateX(5px)' : 'translateX(0)',
                            boxShadow: activeSection === section.id ? '0 8px 16px rgba(102, 126, 234, 0.3)' : 'none'
                        }}
                    >
                        <span style={{ fontSize: '20px' }}>{section.icon}</span>
                        <span style={{ fontWeight: activeSection === section.id ? 'bold' : 'normal' }}>
                            {section.label}
                        </span>
                    </div>
                ))}
            </div>

            {/* MAIN CONTENT */}
            <div style={{ flex: 1 }}>
                {/* PROFILE SECTION */}
                {activeSection === 'profile' && (
                    <div className="table-container" style={{
                        background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%)',
                        border: '1px solid rgba(255,255,255,0.1)',
                        borderRadius: '20px',
                        padding: '30px'
                    }}>
                        <h3 style={{
                            marginBottom: '30px',
                            background: 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            fontSize: '28px',
                            fontWeight: 'bold'
                        }}>My Profile</h3>

                        {/* Profile Information */}
                        <div style={{
                            background: 'white',
                            borderRadius: '15px',
                            padding: '25px',
                            marginBottom: '25px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                        }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                                <h4 style={{ margin: 0, fontSize: '18px', color: '#333' }}>Profile Information</h4>
                                <button
                                    onClick={() => editingProfile ? handleSaveProfile() : setEditingProfile(true)}
                                    disabled={saving}
                                    style={{
                                        padding: '10px 24px',
                                        background: editingProfile
                                            ? 'linear-gradient(135deg, #00A86B 0%, #008554 100%)'
                                            : 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '10px',
                                        cursor: saving ? 'not-allowed' : 'pointer',
                                        fontSize: '14px',
                                        fontWeight: '600',
                                        transition: 'transform 0.2s'
                                    }}
                                >
                                    {saving ? 'Saving...' : editingProfile ? 'Save Changes' : 'Edit Profile'}
                                </button>
                            </div>

                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '20px' }}>
                                <div>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        First Name
                                    </label>
                                    <input
                                        type="text"
                                        value={profileData.firstName}
                                        onChange={(e) => setProfileData({...profileData, firstName: e.target.value})}
                                        disabled={!editingProfile}
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '10px',
                                            fontSize: '14px',
                                            background: editingProfile ? 'white' : '#f8f9fa'
                                        }}
                                    />
                                </div>

                                <div>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        Last Name
                                    </label>
                                    <input
                                        type="text"
                                        value={profileData.lastName}
                                        onChange={(e) => setProfileData({...profileData, lastName: e.target.value})}
                                        disabled={!editingProfile}
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '10px',
                                            fontSize: '14px',
                                            background: editingProfile ? 'white' : '#f8f9fa'
                                        }}
                                    />
                                </div>

                                <div>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        Email Address
                                    </label>
                                    <input
                                        type="email"
                                        value={profileData.email}
                                        disabled
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '10px',
                                            fontSize: '14px',
                                            background: '#f8f9fa',
                                            color: '#999'
                                        }}
                                    />
                                </div>

                                <div>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        Phone Number
                                    </label>
                                    <input
                                        type="tel"
                                        value={profileData.phone}
                                        onChange={(e) => setProfileData({...profileData, phone: e.target.value})}
                                        disabled={!editingProfile}
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '10px',
                                            fontSize: '14px',
                                            background: editingProfile ? 'white' : '#f8f9fa'
                                        }}
                                    />
                                </div>

                                <div>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        Role
                                    </label>
                                    <input
                                        type="text"
                                        value={profileData.role.toUpperCase()}
                                        disabled
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '10px',
                                            fontSize: '14px',
                                            background: '#f8f9fa',
                                            color: '#999'
                                        }}
                                    />
                                </div>
                            </div>

                            {editingProfile && (
                                <button
                                    onClick={() => {
                                        setEditingProfile(false);
                                        setProfileData({
                                            firstName: user.firstName || '',
                                            lastName: user.lastName || '',
                                            displayName: user.displayName || '',
                                            phone: user.phone || '',
                                            email: user.email || '',
                                            role: user.role || ''
                                        });
                                    }}
                                    style={{
                                        marginTop: '20px',
                                        padding: '10px 24px',
                                        background: '#6c757d',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '10px',
                                        cursor: 'pointer',
                                        fontSize: '14px',
                                        fontWeight: '600'
                                    }}
                                >
                                    Cancel
                                </button>
                            )}
                        </div>

                        {/* Change Password */}
                        <div style={{
                            background: 'white',
                            borderRadius: '15px',
                            padding: '25px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                        }}>
                            <h4 style={{ margin: '0 0 20px 0', fontSize: '18px', color: '#333' }}>Change Password</h4>

                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '20px', marginBottom: '20px' }}>
                                <div>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        Current Password
                                    </label>
                                    <input
                                        type={showPassword.current ? 'text' : 'password'}
                                        value={passwordData.currentPassword}
                                        onChange={(e) => setPasswordData({...passwordData, currentPassword: e.target.value})}
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '10px',
                                            fontSize: '14px'
                                        }}
                                    />
                                </div>

                                <div>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        New Password
                                    </label>
                                    <input
                                        type={showPassword.new ? 'text' : 'password'}
                                        value={passwordData.newPassword}
                                        onChange={(e) => handlePasswordChange(e.target.value)}
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '10px',
                                            fontSize: '14px'
                                        }}
                                    />
                                    {passwordData.newPassword && (
                                        <div style={{ marginTop: '8px' }}>
                                            <div style={{
                                                height: '4px',
                                                background: '#e0e0e0',
                                                borderRadius: '2px',
                                                overflow: 'hidden'
                                            }}>
                                                <div style={{
                                                    height: '100%',
                                                    width: `${passwordStrength}%`,
                                                    background: getPasswordStrengthColor(),
                                                    transition: 'all 0.3s'
                                                }}></div>
                                            </div>
                                            <div style={{
                                                fontSize: '12px',
                                                color: getPasswordStrengthColor(),
                                                marginTop: '4px'
                                            }}>
                                                {getPasswordStrengthLabel()}
                                            </div>
                                        </div>
                                    )}
                                </div>

                                <div>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        Confirm New Password
                                    </label>
                                    <input
                                        type={showPassword.confirm ? 'text' : 'password'}
                                        value={passwordData.confirmPassword}
                                        onChange={(e) => setPasswordData({...passwordData, confirmPassword: e.target.value})}
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: `2px solid ${passwordData.confirmPassword && passwordData.confirmPassword !== passwordData.newPassword ? '#f44336' : '#e0e0e0'}`,
                                            borderRadius: '10px',
                                            fontSize: '14px'
                                        }}
                                    />
                                    {passwordData.confirmPassword && passwordData.confirmPassword !== passwordData.newPassword && (
                                        <div style={{ fontSize: '12px', color: '#DC143C', marginTop: '4px' }}>
                                            Passwords do not match
                                        </div>
                                    )}
                                </div>
                            </div>

                            <button
                                onClick={handleChangePassword}
                                disabled={saving || !passwordData.currentPassword || !passwordData.newPassword || passwordData.newPassword !== passwordData.confirmPassword}
                                style={{
                                    padding: '12px 32px',
                                    background: (saving || !passwordData.currentPassword || !passwordData.newPassword || passwordData.newPassword !== passwordData.confirmPassword)
                                        ? '#ccc'
                                        : 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '10px',
                                    cursor: (saving || !passwordData.currentPassword || !passwordData.newPassword || passwordData.newPassword !== passwordData.confirmPassword)
                                        ? 'not-allowed'
                                        : 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '600'
                                }}
                            >
                                {saving ? 'Changing Password...' : 'Change Password'}
                            </button>
                        </div>
                    </div>
                )}

                {/* NOTIFICATIONS SECTION */}
                {activeSection === 'notifications' && (
                    <div className="table-container" style={{
                        background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%)',
                        border: '1px solid rgba(255,255,255,0.1)',
                        borderRadius: '20px',
                        padding: '30px'
                    }}>
                        <h3 style={{
                            marginBottom: '30px',
                            background: 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            fontSize: '28px'
                        }}>Notification Settings</h3>

                        <div style={{ marginBottom: '40px' }}>
                            <h4 style={{ marginBottom: '20px', color: '#0077CC' }}>Email Notifications</h4>
                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="emailOnSOS"
                                    checked={notificationPrefs.emailOnSOS}
                                    onChange={(e) => setNotificationPrefs({...notificationPrefs, emailOnSOS: e.target.checked})}
                                />
                                <label htmlFor="emailOnSOS">SOS Alert Emails</label>
                            </div>

                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="emailOnMissedCheckIn"
                                    checked={notificationPrefs.emailOnMissedCheckIn}
                                    onChange={(e) => setNotificationPrefs({...notificationPrefs, emailOnMissedCheckIn: e.target.checked})}
                                />
                                <label htmlFor="emailOnMissedCheckIn">Missed Check-in Alerts</label>
                            </div>

                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="emailOnNewPIR"
                                    checked={notificationPrefs.emailOnNewPIR}
                                    onChange={(e) => setNotificationPrefs({...notificationPrefs, emailOnNewPIR: e.target.checked})}
                                />
                                <label htmlFor="emailOnNewPIR">New PIR Assignments</label>
                            </div>

                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="emailOnAlert"
                                    checked={notificationPrefs.emailOnAlert}
                                    onChange={(e) => setNotificationPrefs({...notificationPrefs, emailOnAlert: e.target.checked})}
                                />
                                <label htmlFor="emailOnAlert">Alert Notifications</label>
                            </div>

                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="emailOnGoalComplete"
                                    checked={notificationPrefs.emailOnGoalComplete}
                                    onChange={(e) => setNotificationPrefs({...notificationPrefs, emailOnGoalComplete: e.target.checked})}
                                />
                                <label htmlFor="emailOnGoalComplete">Goal Completions</label>
                            </div>

                        </div>

                        <div style={{ marginBottom: '40px' }}>
                            <h4 style={{ marginBottom: '20px', color: '#0077CC' }}>Push Notifications</h4>
                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="pushOnSOS"
                                    checked={notificationPrefs.pushOnSOS}
                                    onChange={(e) => setNotificationPrefs({...notificationPrefs, pushOnSOS: e.target.checked})}
                                />
                                <label htmlFor="pushOnSOS">SOS Alert Push Notifications</label>
                            </div>

                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="pushOnMessage"
                                    checked={notificationPrefs.pushOnMessage}
                                    onChange={(e) => setNotificationPrefs({...notificationPrefs, pushOnMessage: e.target.checked})}
                                />
                                <label htmlFor="pushOnMessage">New Message Notifications</label>
                            </div>

                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="pushOnAlert"
                                    checked={notificationPrefs.pushOnAlert}
                                    onChange={(e) => setNotificationPrefs({...notificationPrefs, pushOnAlert: e.target.checked})}
                                />
                                <label htmlFor="pushOnAlert">Alert Notifications</label>
                            </div>
                        </div>

                        {googleConnected && (
                            <div style={{ marginBottom: '40px' }}>
                                <h4 style={{ marginBottom: '20px', color: '#0077CC' }}>Google Calendar Sync</h4>
                                <div className="checkbox-group">
                                    <input
                                        type="checkbox"
                                        id="calendarAutoSync"
                                        checked={notificationPrefs.calendarAutoSync}
                                        onChange={(e) => setNotificationPrefs({...notificationPrefs, calendarAutoSync: e.target.checked})}
                                    />
                                    <label htmlFor="calendarAutoSync">Enable Auto-Sync</label>
                                </div>

                                <div className="checkbox-group">
                                    <input
                                        type="checkbox"
                                        id="calendarOnSOS"
                                        checked={notificationPrefs.calendarOnSOS}
                                        onChange={(e) => setNotificationPrefs({...notificationPrefs, calendarOnSOS: e.target.checked})}
                                    />
                                    <label htmlFor="calendarOnSOS">Create Calendar Event for SOS Alerts</label>
                                </div>

                                <div className="checkbox-group">
                                    <input
                                        type="checkbox"
                                        id="calendarOnMeeting"
                                        checked={notificationPrefs.calendarOnMeeting}
                                        onChange={(e) => setNotificationPrefs({...notificationPrefs, calendarOnMeeting: e.target.checked})}
                                    />
                                    <label htmlFor="calendarOnMeeting">Sync Scheduled Meetings</label>
                                </div>

                                <div className="checkbox-group">
                                    <input
                                        type="checkbox"
                                        id="calendarOnMissedCheckIn"
                                        checked={notificationPrefs.calendarOnMissedCheckIn}
                                        onChange={(e) => setNotificationPrefs({...notificationPrefs, calendarOnMissedCheckIn: e.target.checked})}
                                    />
                                    <label htmlFor="calendarOnMissedCheckIn">Create Reminder for Missed Check-ins</label>
                                </div>
                            </div>
                        )}

                        <div style={{ marginBottom: '40px' }}>
                            <h4 style={{ marginBottom: '20px', color: '#0077CC' }}>Quiet Hours</h4>
                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="quietHoursEnabled"
                                    checked={notificationPrefs.quietHoursEnabled}
                                    onChange={(e) => setNotificationPrefs({...notificationPrefs, quietHoursEnabled: e.target.checked})}
                                />
                                <label htmlFor="quietHoursEnabled">Enable Quiet Hours (no notifications during this time)</label>
                            </div>

                            {notificationPrefs.quietHoursEnabled && (
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px', marginTop: '15px' }}>
                                    <div className="form-group">
                                        <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>Start Time</label>
                                        <input
                                            type="time"
                                            className="form-input"
                                            value={notificationPrefs.quietHoursStart}
                                            onChange={(e) => setNotificationPrefs({...notificationPrefs, quietHoursStart: e.target.value})}
                                            style={{
                                                background: 'rgba(255,255,255,0.05)',
                                                border: '1px solid rgba(255,255,255,0.1)',
                                                borderRadius: '8px',
                                                padding: '12px',
                                                color: '#fff',
                                                width: '100%'
                                            }}
                                        />
                                    </div>

                                    <div className="form-group">
                                        <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>End Time</label>
                                        <input
                                            type="time"
                                            className="form-input"
                                            value={notificationPrefs.quietHoursEnd}
                                            onChange={(e) => setNotificationPrefs({...notificationPrefs, quietHoursEnd: e.target.value})}
                                            style={{
                                                background: 'rgba(255,255,255,0.05)',
                                                border: '1px solid rgba(255,255,255,0.1)',
                                                borderRadius: '8px',
                                                padding: '12px',
                                                color: '#fff',
                                                width: '100%'
                                            }}
                                        />
                                    </div>
                                </div>
                            )}
                        </div>

                        <div style={{ marginBottom: '40px' }}>
                            <h4 style={{ marginBottom: '20px', color: '#0077CC' }}>Digest & Reports</h4>
                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="dailyDigest"
                                    checked={notificationPrefs.dailyDigest}
                                    onChange={(e) => setNotificationPrefs({...notificationPrefs, dailyDigest: e.target.checked})}
                                />
                                <label htmlFor="dailyDigest">Daily Digest Email</label>
                            </div>

                            {notificationPrefs.dailyDigest && (
                                <div className="form-group" style={{ marginTop: '15px', maxWidth: '200px' }}>
                                    <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>Delivery Time</label>
                                    <input
                                        type="time"
                                        className="form-input"
                                        value={notificationPrefs.dailyDigestTime}
                                        onChange={(e) => setNotificationPrefs({...notificationPrefs, dailyDigestTime: e.target.value})}
                                        style={{
                                            background: 'rgba(255,255,255,0.05)',
                                            border: '1px solid rgba(255,255,255,0.1)',
                                            borderRadius: '8px',
                                            padding: '12px',
                                            color: '#fff',
                                            width: '100%'
                                        }}
                                    />
                                </div>
                            )}

                            <div className="checkbox-group" style={{ marginTop: '15px' }}>
                                <input
                                    type="checkbox"
                                    id="weeklyReport"
                                    checked={notificationPrefs.weeklyReport}
                                    onChange={(e) => setNotificationPrefs({...notificationPrefs, weeklyReport: e.target.checked})}
                                />
                                <label htmlFor="weeklyReport">Weekly Summary Report</label>
                            </div>
                        </div>

                        <button className="btn btn-primary" onClick={saveNotificationPreferences} disabled={saving} style={{
                            marginTop: '30px',
                            background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                            border: 'none',
                            padding: '14px 32px',
                            fontSize: '16px',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            transition: 'transform 0.2s',
                            boxShadow: '0 4px 15px rgba(102, 126, 234, 0.4)'
                        }}>
                            {saving ? 'Saving...' : 'Save Notification Settings'}
                        </button>
                    </div>
                )}

                {/* CHECK-IN SETTINGS */}
                {activeSection === 'checkins' && (
                    <div className="table-container" style={{
                        background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%)',
                        border: '1px solid rgba(255,255,255,0.1)',
                        borderRadius: '20px',
                        padding: '30px'
                    }}>
                        <h3 style={{
                            marginBottom: '30px',
                            background: 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            fontSize: '28px'
                        }}>Check-in Settings</h3>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>Morning Check-in Reminder Time</label>
                            <input
                                type="time"
                                className="form-input"
                                value={settings.checkInReminderTime}
                                onChange={(e) => setSettings({...settings, checkInReminderTime: e.target.value})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%'
                                }}
                            />
                        </div>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>Evening Reflection Reminder Time</label>
                            <input
                                type="time"
                                className="form-input"
                                value={settings.eveningReminderTime}
                                onChange={(e) => setSettings({...settings, eveningReminderTime: e.target.value})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%'
                                }}
                            />
                        </div>

                        <div className="checkbox-group">
                            <input
                                type="checkbox"
                                id="missedCheckInAlert"
                                checked={settings.missedCheckInAlert}
                                onChange={(e) => setSettings({...settings, missedCheckInAlert: e.target.checked})}
                            />
                            <label htmlFor="missedCheckInAlert">Alert on Missed Check-ins</label>
                        </div>

                        <button className="btn btn-primary" onClick={saveSettings} disabled={saving} style={{ 
                            marginTop: '30px',
                            background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                            border: 'none',
                            padding: '14px 32px',
                            fontSize: '16px',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            transition: 'transform 0.2s',
                            boxShadow: '0 4px 15px rgba(102, 126, 234, 0.4)'
                        }}>
                            {saving ? 'Saving...' : 'Save Check-in Settings'}
                        </button>
                    </div>
                )}

                {/* ALERT THRESHOLDS */}
                {activeSection === 'alerts' && (
                    <div className="table-container" style={{
                        background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%)',
                        border: '1px solid rgba(255,255,255,0.1)',
                        borderRadius: '20px',
                        padding: '30px'
                    }}>
                        <h3 style={{
                            marginBottom: '30px',
                            background: 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            fontSize: '28px'
                        }}>Alert Thresholds</h3>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>Low Mood Threshold (1-10)</label>
                            <input
                                type="number"
                                className="form-input"
                                min="1"
                                max="10"
                                value={settings.lowMoodThreshold}
                                onChange={(e) => setSettings({...settings, lowMoodThreshold: parseInt(e.target.value)})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%'
                                }}
                            />
                            <small style={{ color: '#999', marginTop: '5px', display: 'block' }}>Alert when mood is at or below this value</small>
                        </div>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>High Craving Threshold (1-10)</label>
                            <input
                                type="number"
                                className="form-input"
                                min="1"
                                max="10"
                                value={settings.highCravingThreshold}
                                onChange={(e) => setSettings({...settings, highCravingThreshold: parseInt(e.target.value)})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%'
                                }}
                            />
                            <small style={{ color: '#999', marginTop: '5px', display: 'block' }}>Alert when cravings are at or above this value</small>
                        </div>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>High Anxiety Threshold (1-10)</label>
                            <input
                                type="number"
                                className="form-input"
                                min="1"
                                max="10"
                                value={settings.highAnxietyThreshold}
                                onChange={(e) => setSettings({...settings, highAnxietyThreshold: parseInt(e.target.value)})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%'
                                }}
                            />
                            <small style={{ color: '#999', marginTop: '5px', display: 'block' }}>Alert when anxiety is at or above this value</small>
                        </div>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>Poor Sleep Threshold (1-10)</label>
                            <input
                                type="number"
                                className="form-input"
                                min="1"
                                max="10"
                                value={settings.poorSleepThreshold}
                                onChange={(e) => setSettings({...settings, poorSleepThreshold: parseInt(e.target.value)})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%'
                                }}
                            />
                            <small style={{ color: '#999', marginTop: '5px', display: 'block' }}>Alert when sleep quality is at or below this value</small>
                        </div>

                        <button className="btn btn-primary" onClick={saveSettings} disabled={saving} style={{ 
                            marginTop: '30px',
                            background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                            border: 'none',
                            padding: '14px 32px',
                            fontSize: '16px',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            transition: 'transform 0.2s',
                            boxShadow: '0 4px 15px rgba(102, 126, 234, 0.4)'
                        }}>
                            {saving ? 'Saving...' : 'Save Alert Settings'}
                        </button>
                    </div>
                )}

                {/* DATA EXPORT */}
                {activeSection === 'dataExport' && (
                    <div className="table-container" style={{
                        background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%)',
                        border: '1px solid rgba(255,255,255,0.1)',
                        borderRadius: '20px',
                        padding: '30px'
                    }}>
                        <h3 style={{
                            marginBottom: '30px',
                            background: 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            fontSize: '28px'
                        }}>Data Export</h3>

                        <div style={{ marginBottom: '40px' }}>
                            <h4 style={{ marginBottom: '20px', color: '#0077CC' }}>Export All User Data</h4>
                            <div style={{ display: 'flex', gap: '15px', flexWrap: 'wrap' }}>
                                <button className="btn btn-secondary" onClick={() => handleDataExport('json', 'all')} style={{
                                    background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                                    border: 'none',
                                    padding: '12px 24px',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    transition: 'transform 0.2s'
                                }}>
                                    üìÑ Export as JSON
                                </button>
                                <button className="btn btn-secondary" onClick={() => handleDataExport('csv', 'all')} style={{
                                    background: 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)',
                                    border: 'none',
                                    padding: '12px 24px',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    transition: 'transform 0.2s'
                                }}>
                                    üìä Export as Spreadsheet
                                </button>
                                <button className="btn btn-secondary" onClick={() => handleDataExport('pdf', 'all')} style={{
                                    background: 'linear-gradient(135deg, #f44336 0%, #B01030 100%)',
                                    border: 'none',
                                    padding: '12px 24px',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    transition: 'transform 0.2s'
                                }}>
                                    üìë Export as PDF
                                </button>
                            </div>
                        </div>

                        <div style={{ marginBottom: '40px' }}>
                            <h4 style={{ marginBottom: '20px', color: '#0077CC' }}>Export Specific PIR Data</h4>
                            <div style={{ display: 'flex', gap: '15px', flexWrap: 'wrap' }}>
                                <button className="btn btn-secondary" onClick={() => handleDataExport('json', 'specific_pir')} style={{
                                    background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                                    border: 'none',
                                    padding: '12px 24px',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    transition: 'transform 0.2s'
                                }}>
                                    üìÑ Export as JSON
                                </button>
                                <button className="btn btn-secondary" onClick={() => handleDataExport('csv', 'specific_pir')} style={{
                                    background: 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)',
                                    border: 'none',
                                    padding: '12px 24px',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    transition: 'transform 0.2s'
                                }}>
                                    üìä Export as Spreadsheet
                                </button>
                                <button className="btn btn-secondary" onClick={() => handleDataExport('pdf', 'specific_pir')} style={{
                                    background: 'linear-gradient(135deg, #f44336 0%, #B01030 100%)',
                                    border: 'none',
                                    padding: '12px 24px',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    transition: 'transform 0.2s'
                                }}>
                                    üìë Export as PDF
                                </button>
                            </div>
                        </div>

                        <div style={{ marginBottom: '40px' }}>
                            <h4 style={{ marginBottom: '20px', color: '#0077CC' }}>Export by Data Type</h4>
                            <select 
                                className="form-input" 
                                onChange={(e) => {
                                    if (e.target.value) {
                                        const format = prompt('Export format? (json/csv/pdf)');
                                        if (format) handleDataExport(format, 'data_type', e.target.value);
                                    }
                                }}
                                defaultValue=""
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%',
                                    cursor: 'pointer'
                                }}
                            >
                                <option value="">Select data type...</option>
                                <option value="checkIns">Check-ins</option>
                                <option value="messages">Messages</option>
                                <option value="assignments">Assignments</option>
                                <option value="goals">Goals</option>
                                <option value="alerts">Alerts</option>
                                <option value="feedback">Feedback</option>
                                <option value="activities">Activities</option>
                                <option value="notifications">Notifications</option>
                            </select>
                        </div>

                        <div style={{ marginTop: '40px' }}>
                            <h4 style={{ marginBottom: '20px', color: '#0077CC' }}>Automated Exports</h4>
                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="autoBackup"
                                    checked={settings.autoBackupEnabled}
                                    onChange={(e) => setSettings({...settings, autoBackupEnabled: e.target.checked})}
                                />
                                <label htmlFor="autoBackup">Enable Automatic Backups</label>
                            </div>

                            <div className="form-group" style={{ marginTop: '20px' }}>
                                <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>Backup Frequency</label>
                                <select
                                    className="form-input"
                                    value={settings.backupFrequency}
                                    onChange={(e) => setSettings({...settings, backupFrequency: e.target.value})}
                                    style={{
                                        background: 'rgba(255,255,255,0.05)',
                                        border: '1px solid rgba(255,255,255,0.1)',
                                        borderRadius: '8px',
                                        padding: '12px',
                                        color: '#fff',
                                        width: '100%',
                                        cursor: 'pointer'
                                    }}
                                >
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>

                            <button className="btn btn-primary" onClick={saveSettings} disabled={saving} style={{ 
                                marginTop: '30px',
                                background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                border: 'none',
                                padding: '14px 32px',
                                fontSize: '16px',
                                borderRadius: '10px',
                                cursor: 'pointer',
                                transition: 'transform 0.2s',
                                boxShadow: '0 4px 15px rgba(102, 126, 234, 0.4)'
                            }}>
                                {saving ? 'Saving...' : 'Save Export Settings'}
                            </button>
                        </div>
                    </div>
                )}

                {/* USER MANAGEMENT */}
                {activeSection === 'userManagement' && (
                    <div className="table-container" style={{
                        background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%)',
                        border: '1px solid rgba(255,255,255,0.1)',
                        borderRadius: '20px',
                        padding: '30px'
                    }}>
                        <h3 style={{
                            marginBottom: '30px',
                            background: 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            fontSize: '28px'
                        }}>User Management</h3>

                        <div style={{ marginBottom: '40px' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                                <h4 style={{ color: '#0077CC' }}>Coaches ({coaches.filter(c => c.active !== false).length})</h4>
                                <button className="btn btn-primary" onClick={handleAddCoach} style={{
                                    background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                                    border: 'none',
                                    padding: '10px 20px',
                                    borderRadius: '8px',
                                    cursor: 'pointer'
                                }}>+ Add Coach</button>
                            </div>

                            {/* Add Coach Form */}
                            {showAddCoachForm && (
                                <div style={{
                                    background: 'white',
                                    borderRadius: '10px',
                                    padding: '20px',
                                    marginBottom: '20px',
                                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                                }}>
                                    <h5 style={{ marginBottom: '15px', color: '#333' }}>Add New Coach</h5>
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '15px' }}>
                                        <input
                                            type="text"
                                            placeholder="First Name"
                                            value={newUserData.firstName}
                                            onChange={(e) => setNewUserData({...newUserData, firstName: e.target.value})}
                                            style={{
                                                padding: '10px',
                                                borderRadius: '8px',
                                                border: '1px solid #ddd',
                                                fontSize: '14px'
                                            }}
                                        />
                                        <input
                                            type="text"
                                            placeholder="Last Name"
                                            value={newUserData.lastName}
                                            onChange={(e) => setNewUserData({...newUserData, lastName: e.target.value})}
                                            style={{
                                                padding: '10px',
                                                borderRadius: '8px',
                                                border: '1px solid #ddd',
                                                fontSize: '14px'
                                            }}
                                        />
                                        <input
                                            type="email"
                                            placeholder="Email Address"
                                            value={newUserData.email}
                                            onChange={(e) => setNewUserData({...newUserData, email: e.target.value})}
                                            style={{
                                                padding: '10px',
                                                borderRadius: '8px',
                                                border: '1px solid #ddd',
                                                fontSize: '14px'
                                            }}
                                        />
                                        <input
                                            type="password"
                                            placeholder="Temporary Password"
                                            value={newUserData.password}
                                            onChange={(e) => setNewUserData({...newUserData, password: e.target.value})}
                                            style={{
                                                padding: '10px',
                                                borderRadius: '8px',
                                                border: '1px solid #ddd',
                                                fontSize: '14px'
                                            }}
                                        />
                                    </div>
                                    <div style={{ display: 'flex', gap: '10px', marginTop: '15px' }}>
                                        <button
                                            onClick={submitAddCoach}
                                            disabled={saving}
                                            style={{
                                                padding: '10px 20px',
                                                background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '8px',
                                                cursor: saving ? 'not-allowed' : 'pointer',
                                                fontSize: '14px',
                                                fontWeight: '600'
                                            }}
                                        >
                                            {saving ? 'Adding...' : 'Add Coach'}
                                        </button>
                                        <button
                                            onClick={() => setShowAddCoachForm(false)}
                                            style={{
                                                padding: '10px 20px',
                                                background: '#6c757d',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '8px',
                                                cursor: 'pointer',
                                                fontSize: '14px',
                                                fontWeight: '600'
                                            }}
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            )}

                            <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                <thead>
                                    <tr style={{ borderBottom: '2px solid rgba(102, 126, 234, 0.3)' }}>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#0077CC' }}>Name</th>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#0077CC' }}>Email</th>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#0077CC' }}>Assigned PIRs</th>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#0077CC' }}>Status</th>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#0077CC' }}>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {coaches.map(coach => (
                                        <tr key={coach.id} style={{ borderBottom: '1px solid rgba(255,255,255,0.1)' }}>
                                            <td style={{ padding: '15px' }}>{coach.displayName}</td>
                                            <td style={{ padding: '15px' }}>{coach.email}</td>
                                            <td style={{ padding: '15px' }}>{pirs.filter(p => p.assignedCoach === coach.id).length}</td>
                                            <td style={{ padding: '15px' }}>
                                                <span className={`badge ${coach.active !== false ? 'badge-success' : 'badge-danger'}`} style={{
                                                    padding: '6px 12px',
                                                    borderRadius: '6px',
                                                    fontSize: '0.85em',
                                                    background: coach.active !== false ? 'linear-gradient(135deg, #00A86B, #008554)' : 'linear-gradient(135deg, #f44336, #B01030)'
                                                }}>
                                                    {coach.active !== false ? 'Active' : 'Inactive'}
                                                </span>
                                            </td>
                                            <td style={{ padding: '15px' }}>
                                                <button 
                                                    className="action-btn"
                                                    onClick={() => handleRemoveUser(coach.id, 'coach')}
                                                    style={{
                                                        background: 'linear-gradient(135deg, #f44336, #B01030)',
                                                        border: 'none',
                                                        padding: '8px 16px',
                                                        borderRadius: '6px',
                                                        cursor: 'pointer',
                                                        color: '#fff'
                                                    }}
                                                >
                                                    Remove
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        <div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                                <h4 style={{ color: '#0077CC' }}>PIRs ({pirs.filter(p => p.active !== false).length})</h4>
                                <button className="btn btn-primary" onClick={handleAddPIR} style={{
                                    background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                                    border: 'none',
                                    padding: '10px 20px',
                                    borderRadius: '8px',
                                    cursor: 'pointer'
                                }}>+ Add PIR</button>
                            </div>

                            {/* Add PIR Form */}
                            {showAddPIRForm && (
                                <div style={{
                                    background: 'white',
                                    borderRadius: '10px',
                                    padding: '20px',
                                    marginBottom: '20px',
                                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                                }}>
                                    <h5 style={{ marginBottom: '15px', color: '#333' }}>Add New PIR</h5>
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '15px' }}>
                                        <input
                                            type="text"
                                            placeholder="First Name"
                                            value={newUserData.firstName}
                                            onChange={(e) => setNewUserData({...newUserData, firstName: e.target.value})}
                                            style={{
                                                padding: '10px',
                                                borderRadius: '8px',
                                                border: '1px solid #ddd',
                                                fontSize: '14px'
                                            }}
                                        />
                                        <input
                                            type="text"
                                            placeholder="Last Name"
                                            value={newUserData.lastName}
                                            onChange={(e) => setNewUserData({...newUserData, lastName: e.target.value})}
                                            style={{
                                                padding: '10px',
                                                borderRadius: '8px',
                                                border: '1px solid #ddd',
                                                fontSize: '14px'
                                            }}
                                        />
                                        <input
                                            type="email"
                                            placeholder="Email Address"
                                            value={newUserData.email}
                                            onChange={(e) => setNewUserData({...newUserData, email: e.target.value})}
                                            style={{
                                                padding: '10px',
                                                borderRadius: '8px',
                                                border: '1px solid #ddd',
                                                fontSize: '14px'
                                            }}
                                        />
                                        <input
                                            type="password"
                                            placeholder="Temporary Password"
                                            value={newUserData.password}
                                            onChange={(e) => setNewUserData({...newUserData, password: e.target.value})}
                                            style={{
                                                padding: '10px',
                                                borderRadius: '8px',
                                                border: '1px solid #ddd',
                                                fontSize: '14px'
                                            }}
                                        />
                                        <select
                                            value={newUserData.assignedCoach}
                                            onChange={(e) => setNewUserData({...newUserData, assignedCoach: e.target.value})}
                                            style={{
                                                padding: '10px',
                                                borderRadius: '8px',
                                                border: '1px solid #ddd',
                                                fontSize: '14px',
                                                gridColumn: 'span 2'
                                            }}
                                        >
                                            <option value="">Assign to Coach (Optional)</option>
                                            {coaches.filter(c => c.active !== false).map(coach => (
                                                <option key={coach.id} value={coach.id}>
                                                    {coach.displayName}
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                    <div style={{ display: 'flex', gap: '10px', marginTop: '15px' }}>
                                        <button
                                            onClick={submitAddPIR}
                                            disabled={saving}
                                            style={{
                                                padding: '10px 20px',
                                                background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '8px',
                                                cursor: saving ? 'not-allowed' : 'pointer',
                                                fontSize: '14px',
                                                fontWeight: '600'
                                            }}
                                        >
                                            {saving ? 'Adding...' : 'Add PIR'}
                                        </button>
                                        <button
                                            onClick={() => setShowAddPIRForm(false)}
                                            style={{
                                                padding: '10px 20px',
                                                background: '#6c757d',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '8px',
                                                cursor: 'pointer',
                                                fontSize: '14px',
                                                fontWeight: '600'
                                            }}
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            )}

                            <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                <thead>
                                    <tr style={{ borderBottom: '2px solid rgba(102, 126, 234, 0.3)' }}>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#0077CC' }}>Name</th>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#0077CC' }}>Email</th>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#0077CC' }}>Assigned Coach</th>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#0077CC' }}>Status</th>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#0077CC' }}>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {pirs.map(pir => {
                                        const assignedCoach = coaches.find(c => c.id === pir.assignedCoach);
                                        return (
                                            <tr key={pir.id} style={{ borderBottom: '1px solid rgba(255,255,255,0.1)' }}>
                                                <td style={{ padding: '15px' }}>{pir.displayName}</td>
                                                <td style={{ padding: '15px' }}>{pir.email}</td>
                                                <td style={{ padding: '15px' }}>
                                                    {assignedCoach ? assignedCoach.displayName : 'Unassigned'}
                                                </td>
                                                <td style={{ padding: '15px' }}>
                                                    <span className={`badge ${pir.active !== false ? 'badge-success' : 'badge-danger'}`} style={{
                                                        padding: '6px 12px',
                                                        borderRadius: '6px',
                                                        fontSize: '0.85em',
                                                        background: pir.active !== false ? 'linear-gradient(135deg, #00A86B, #008554)' : 'linear-gradient(135deg, #f44336, #B01030)'
                                                    }}>
                                                        {pir.active !== false ? 'Active' : 'Inactive'}
                                                    </span>
                                                </td>
                                                <td style={{ padding: '15px' }}>
                                                    <div style={{ display: 'flex', gap: '8px' }}>
                                                        {!pir.assignedCoach ? (
                                                            <button 
                                                                className="action-btn"
                                                                onClick={() => handleAssignCoach(pir.id)}
                                                                style={{
                                                                    background: 'linear-gradient(135deg, #2196F3, #1976D2)',
                                                                    border: 'none',
                                                                    padding: '8px 16px',
                                                                    borderRadius: '6px',
                                                                    cursor: 'pointer',
                                                                    color: '#fff'
                                                                }}
                                                            >
                                                                Assign Coach
                                                            </button>
                                                        ) : (
                                                            <button 
                                                                className="action-btn"
                                                                onClick={() => handleChangeCoach(pir.id, pir.assignedCoach)}
                                                                style={{
                                                                    background: 'linear-gradient(135deg, #FF9800, #F57C00)',
                                                                    border: 'none',
                                                                    padding: '8px 16px',
                                                                    borderRadius: '6px',
                                                                    cursor: 'pointer',
                                                                    color: '#fff'
                                                                }}
                                                            >
                                                                Change Coach
                                                            </button>
                                                        )}
                                                        <button 
                                                            className="action-btn"
                                                            onClick={() => handleRemoveUser(pir.id, 'pir')}
                                                            style={{
                                                                background: 'linear-gradient(135deg, #f44336, #B01030)',
                                                                border: 'none',
                                                                padding: '8px 16px',
                                                                borderRadius: '6px',
                                                                cursor: 'pointer',
                                                                color: '#fff'
                                                            }}
                                                        >
                                                            Remove
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )}

                {/* PERMISSIONS - COMPREHENSIVE EDITOR */}
                {activeSection === 'permissions' && <PermissionEditor user={user} />}

                {/* INTEGRATIONS */}
                {activeSection === 'integrations' && (
                    <div className="table-container" style={{
                        background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%)',
                        border: '1px solid rgba(255,255,255,0.1)',
                        borderRadius: '20px',
                        padding: '30px'
                    }}>
                        <h3 style={{
                            marginBottom: '30px',
                            background: 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            fontSize: '28px'
                        }}>Integrations</h3>

                        {/* Google Calendar Integration */}
                        <div style={{
                            padding: '25px',
                            background: googleConnected
                                ? 'linear-gradient(135deg, rgba(52, 168, 83, 0.1) 0%, rgba(46, 125, 50, 0.1) 100%)'
                                : 'linear-gradient(135deg, rgba(66, 133, 244, 0.1) 0%, rgba(52, 168, 83, 0.1) 100%)',
                            borderRadius: '12px',
                            border: googleConnected
                                ? '1px solid rgba(52, 168, 83, 0.3)'
                                : '1px solid rgba(66, 133, 244, 0.3)',
                            marginBottom: '20px'
                        }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '15px' }}>
                                <div>
                                    <h4 style={{ color: googleConnected ? '#34A853' : '#4285F4', marginBottom: '10px', display: 'flex', alignItems: 'center', gap: '10px' }}>
                                        üìÖ Google Calendar Sync
                                        {googleConnected && (
                                            <span style={{
                                                background: 'linear-gradient(135deg, #00C851 0%, #007E33 100%)',
                                                color: 'white',
                                                padding: '4px 10px',
                                                borderRadius: '12px',
                                                fontSize: '11px',
                                                fontWeight: '600'
                                            }}>‚úì Connected</span>
                                        )}
                                    </h4>
                                    <p style={{ color: '#ccc', margin: 0, fontSize: '14px' }}>
                                        {googleConnected
                                            ? 'Two-way sync of sessions, meetings, and reminders with your Google Calendar.'
                                            : 'Connect your Google account to automatically sync events and reminders.'}
                                    </p>
                                </div>
                            </div>

                            {googleConnected ? (
                                <div>
                                    <div style={{
                                        background: 'rgba(255,255,255,0.05)',
                                        borderRadius: '8px',
                                        padding: '15px',
                                        marginBottom: '15px'
                                    }}>
                                        <div style={{ color: '#aaa', fontSize: '12px', marginBottom: '8px' }}>Connected Account</div>
                                        <div style={{ color: 'white', fontSize: '14px', fontWeight: '500', marginBottom: '8px' }}>
                                            {googleEmail}
                                        </div>
                                        {lastGoogleSync && (
                                            <div style={{ color: '#888', fontSize: '12px' }}>
                                                Last synced: {lastGoogleSync.toDate ? lastGoogleSync.toDate().toLocaleString() : new Date(lastGoogleSync).toLocaleString()}
                                            </div>
                                        )}
                                    </div>

                                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '10px', marginBottom: '15px' }}>
                                        <button
                                            onClick={syncToGoogleCalendar}
                                            disabled={saving}
                                            style={{
                                                padding: '10px 20px',
                                                background: saving ? '#ccc' : 'linear-gradient(135deg, #4285F4 0%, #34A853 100%)',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '8px',
                                                cursor: saving ? 'not-allowed' : 'pointer',
                                                fontSize: '14px',
                                                fontWeight: '500',
                                                transition: 'transform 0.2s'
                                            }}
                                            onMouseEnter={(e) => !saving && (e.currentTarget.style.transform = 'translateY(-2px)')}
                                            onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                                        >
                                            üì§ Push to Google
                                        </button>
                                        <button
                                            onClick={syncFromGoogleCalendar}
                                            disabled={saving}
                                            style={{
                                                padding: '10px 20px',
                                                background: saving ? '#ccc' : 'linear-gradient(135deg, #34A853 0%, #4285F4 100%)',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '8px',
                                                cursor: saving ? 'not-allowed' : 'pointer',
                                                fontSize: '14px',
                                                fontWeight: '500',
                                                transition: 'transform 0.2s'
                                            }}
                                            onMouseEnter={(e) => !saving && (e.currentTarget.style.transform = 'translateY(-2px)')}
                                            onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                                        >
                                            üì• Import from Google
                                        </button>
                                        <button
                                            onClick={handleGoogleDisconnect}
                                            disabled={saving}
                                            style={{
                                                padding: '10px 20px',
                                                background: saving ? '#ccc' : 'linear-gradient(135deg, #ef5350 0%, #d32f2f 100%)',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '8px',
                                                cursor: saving ? 'not-allowed' : 'pointer',
                                                fontSize: '14px',
                                                fontWeight: '500',
                                                transition: 'transform 0.2s'
                                            }}
                                            onMouseEnter={(e) => !saving && (e.currentTarget.style.transform = 'translateY(-2px)')}
                                            onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                                        >
                                            Disconnect
                                        </button>
                                    </div>
                                    <div style={{ color: '#aaa', fontSize: '12px', padding: '10px 0', background: 'rgba(255,255,255,0.05)', borderRadius: '6px', textAlign: 'center' }}>
                                        üí° Push: Sync GLRS meetings ‚Üí Google Calendar | Import: Sync Google Calendar ‚Üí GLRS
                                    </div>
                                </div>
                            ) : (
                                <button
                                    onClick={handleGoogleConnect}
                                    style={{
                                        padding: '12px 24px',
                                        background: 'white',
                                        color: '#4285F4',
                                        border: 'none',
                                        borderRadius: '8px',
                                        cursor: 'pointer',
                                        fontSize: '14px',
                                        fontWeight: '600',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '10px',
                                        transition: 'all 0.2s',
                                        boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                                    }}
                                    onMouseEnter={(e) => {
                                        e.currentTarget.style.transform = 'translateY(-2px)';
                                        e.currentTarget.style.boxShadow = '0 4px 12px rgba(66, 133, 244, 0.3)';
                                    }}
                                    onMouseLeave={(e) => {
                                        e.currentTarget.style.transform = 'translateY(0)';
                                        e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                                    }}
                                >
                                    <svg width="18" height="18" viewBox="0 0 18 18">
                                        <path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/>
                                        <path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"/>
                                        <path fill="#FBBC05" d="M4.5 10.52a4.8 4.8 0 0 1 0-3.04V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07z"/>
                                        <path fill="#EA4335" d="M8.98 4.18c1.17 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.4L4.5 7.49a4.77 4.77 0 0 1 4.48-3.3z"/>
                                    </svg>
                                    Connect Google Calendar
                                </button>
                            )}
                        </div>

                        {/* Coming Soon Integrations */}
                        <div style={{
                            padding: '25px',
                            background: 'linear-gradient(135deg, rgba(255,193,7,0.1) 0%, rgba(255,152,0,0.1) 100%)',
                            borderRadius: '12px',
                            border: '1px solid rgba(255,193,7,0.3)',
                            marginBottom: '20px'
                        }}>
                            <h4 style={{ color: '#FFC107', marginBottom: '15px' }}>üöß Coming Soon: Carepatron Webhook</h4>
                            <p style={{ color: '#ccc', margin: 0 }}>
                                Automatically sync session data with Carepatron practice management system.
                            </p>
                        </div>

                        <div style={{
                            padding: '25px',
                            background: 'linear-gradient(135deg, rgba(255,193,7,0.1) 0%, rgba(255,152,0,0.1) 100%)',
                            borderRadius: '12px',
                            border: '1px solid rgba(255,193,7,0.3)',
                            marginBottom: '20px'
                        }}>
                            <h4 style={{ color: '#FFC107', marginBottom: '15px' }}>üöß Coming Soon: Email Service Provider</h4>
                            <p style={{ color: '#ccc', margin: 0 }}>
                                Configure SendGrid or Mailgun for professional email delivery.
                            </p>
                        </div>

                        <div style={{
                            padding: '25px',
                            background: 'linear-gradient(135deg, rgba(255,193,7,0.1) 0%, rgba(255,152,0,0.1) 100%)',
                            borderRadius: '12px',
                            border: '1px solid rgba(255,193,7,0.3)',
                            marginBottom: '20px'
                        }}>
                            <h4 style={{ color: '#FFC107', marginBottom: '15px' }}>üöß Coming Soon: SMS Provider (Twilio)</h4>
                            <p style={{ color: '#ccc', margin: 0 }}>
                                Set up Twilio for SMS notifications and two-way messaging.
                            </p>
                        </div>

                        <div style={{
                            padding: '25px',
                            background: 'linear-gradient(135deg, rgba(255,193,7,0.1) 0%, rgba(255,152,0,0.1) 100%)',
                            borderRadius: '12px',
                            border: '1px solid rgba(255,193,7,0.3)'
                        }}>
                            <h4 style={{ color: '#FFC107', marginBottom: '15px' }}>üöß Coming Soon: Zapier Integration</h4>
                            <p style={{ color: '#ccc', margin: 0 }}>
                                Connect to 3000+ apps via Zapier for custom automation workflows.
                            </p>
                        </div>
                    </div>
                )}

                {/* SYSTEM CONFIGURATION */}
                {activeSection === 'system' && (
                    <div className="table-container" style={{
                        background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%)',
                        border: '1px solid rgba(255,255,255,0.1)',
                        borderRadius: '20px',
                        padding: '30px'
                    }}>
                        <h3 style={{
                            marginBottom: '30px',
                            background: 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            fontSize: '28px'
                        }}>System Configuration</h3>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>Timezone</label>
                            <select
                                className="form-input"
                                value={settings.timezone}
                                onChange={(e) => setSettings({...settings, timezone: e.target.value})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%',
                                    cursor: 'pointer'
                                }}
                            >
                                <option value="America/Los_Angeles">Pacific Time (PT)</option>
                                <option value="America/Denver">Mountain Time (MT)</option>
                                <option value="America/Chicago">Central Time (CT)</option>
                                <option value="America/New_York">Eastern Time (ET)</option>
                                <option value="America/Phoenix">Arizona (MST)</option>
                                <option value="America/Anchorage">Alaska (AKT)</option>
                                <option value="Pacific/Honolulu">Hawaii (HST)</option>
                            </select>
                        </div>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>Date Format</label>
                            <select
                                className="form-input"
                                value={settings.dateFormat}
                                onChange={(e) => setSettings({...settings, dateFormat: e.target.value})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%',
                                    cursor: 'pointer'
                                }}
                            >
                                <option value="MM/DD/YYYY">MM/DD/YYYY (US)</option>
                                <option value="DD/MM/YYYY">DD/MM/YYYY (International)</option>
                                <option value="YYYY-MM-DD">YYYY-MM-DD (ISO)</option>
                            </select>
                        </div>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>Time Format</label>
                            <select
                                className="form-input"
                                value={settings.timeFormat}
                                onChange={(e) => setSettings({...settings, timeFormat: e.target.value})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%',
                                    cursor: 'pointer'
                                }}
                            >
                                <option value="12h">12-hour (AM/PM)</option>
                                <option value="24h">24-hour</option>
                            </select>
                        </div>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>Language</label>
                            <select
                                className="form-input"
                                value={settings.language}
                                onChange={(e) => setSettings({...settings, language: e.target.value})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%',
                                    cursor: 'pointer'
                                }}
                            >
                                <option value="en">English</option>
                                <option value="es">Spanish (Coming Soon)</option>
                                <option value="fr">French (Coming Soon)</option>
                            </select>
                        </div>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>Auto-Refresh Interval</label>
                            <select
                                className="form-input"
                                value={settings.autoRefresh}
                                onChange={(e) => setSettings({...settings, autoRefresh: parseInt(e.target.value)})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%',
                                    cursor: 'pointer'
                                }}
                            >
                                <option value="0">Manual Only</option>
                                <option value="30">30 seconds</option>
                                <option value="60">1 minute</option>
                                <option value="300">5 minutes</option>
                                <option value="600">10 minutes</option>
                            </select>
                        </div>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>Data Retention (days)</label>
                            <input
                                type="number"
                                className="form-input"
                                min="90"
                                max="2555"
                                value={settings.dataRetentionDays}
                                onChange={(e) => setSettings({...settings, dataRetentionDays: parseInt(e.target.value)})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%'
                                }}
                            />
                            <small style={{ color: '#999', marginTop: '5px', display: 'block' }}>Minimum 90 days, maximum 7 years (2555 days) for HIPAA compliance</small>
                        </div>

                        <button className="btn btn-primary" onClick={saveSettings} disabled={saving} style={{ 
                            marginTop: '30px',
                            background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                            border: 'none',
                            padding: '14px 32px',
                            fontSize: '16px',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            transition: 'transform 0.2s',
                            boxShadow: '0 4px 15px rgba(102, 126, 234, 0.4)'
                        }}>
                            {saving ? 'Saving...' : 'Save System Settings'}
                        </button>
                    </div>
                )}
            </div>
        </div>
    );
}

     
    
// ==========================================
// ENHANCED CREATE USER MODAL - FIREBASE EXTENSION VERSION
// ==========================================
function SettingsApp() {
    const [searchQuery, setSearchQuery] = useState('');
    const [user, setUser] = useState(null);
    // Notification state
    const [notifications, setNotifications] = useState([]);
    // Connection status
    const [isOnline, setIsOnline] = useState(navigator.onLine);
    // Manage sidebar collapsed state
    const [sidebarCollapsed, setSidebarCollapsed] = useState(() => {
        return window.getPreference ? window.getPreference('sidebarCollapsed', false) : false;
    });
    useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged(async (firebaseUser) => {
            if (firebaseUser) {
                const userDoc = await db.collection('users').doc(firebaseUser.uid).get();
                const userData = { uid: firebaseUser.uid, ...userDoc.data() };
                // üîê PAGE ACCESS CONTROL: Check if user has permission to access Settings
                if (!window.canAccessPage(userData, 'settings')) {
                    alert('You do not have permission to access Settings.');
                    window.location.href = '/admin/mypirs.html'; // Redirect to My PIRs (default fallback)
                    return;
                }

                setUser(userData);
            } else {
                window.location.href = '/admin/login';
            }
        });
        return unsubscribe;
    }, []);
    // Set up notification listener
    useEffect(() => {
        if (!user) return;
        const unsubscribe = firebase.firestore()
            .collection('notifications')
            .where('userId', '==', user.uid)
            .orderBy('timestamp', 'desc')
            .limit(50)
            .onSnapshot((snapshot) => {
                const notifs = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                setNotifications(notifs);
            }, (error) => {
                console.error('Error loading notifications:', error);
            });
        return () => unsubscribe();
    }, [user]);
    // Set up connection status listener
    useEffect(() => {
        const handleOnline = () => setIsOnline(true);
        const handleOffline = () => setIsOnline(false);
        window.addEventListener('online', handleOnline);
        window.addEventListener('offline', handleOffline);
        return () => {
            window.removeEventListener('online', handleOnline);
            window.removeEventListener('offline', handleOffline);
        };
    }, []);
    // Clear notification handlers
    const handleClearNotification = async (notificationId) => {
        try {
            await firebase.firestore().collection('notifications').doc(notificationId).delete();
        } catch (error) {
            console.error('Error clearing notification:', error);
        }
    };
    const handleClearAllNotifications = async () => {
        try {
            const batch = firebase.firestore().batch();
            notifications.forEach(notif => {
                const docRef = firebase.firestore().collection('notifications').doc(notif.id);
                batch.delete(docRef);
            });
            await batch.commit();
        } catch (error) {
            console.error('Error clearing all notifications:', error);
        }
    };
    if (!user) {
        return <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '100vh' }}><div className="loading-spinner"></div></div>;
    }
    return (
        <>
            {/* Connection Status Bar */}
            {!isOnline && (
                <div style={{
                    background: '#FFA500',
                    color: 'white',
                    padding: '10px',
                    textAlign: 'center',
                    fontWeight: '600',
                    fontSize: '14px',
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    zIndex: 9999
                }}>
                    ‚ö†Ô∏è Offline - Some features may be limited
                </div>
            )}
            <div style={{ display: 'flex', flexDirection: 'column', minHeight: '100vh' }}>
                {/* Header Component */}
                <Header
                    user={user}
                    searchQuery={searchQuery}
                    setSearchQuery={setSearchQuery}
                    sidebarCollapsed={sidebarCollapsed}
                    notifications={notifications}
                    onClearNotification={handleClearNotification}
                    onClearAllNotifications={handleClearAllNotifications}
                />
                {/* Sidebar Component */}
                <Sidebar user={user} collapsed={sidebarCollapsed} onCollapsedChange={setSidebarCollapsed} />
                {/* Main Content */}
                <div style={{
                    marginLeft: sidebarCollapsed ? '80px' : '280px',
                    minHeight: '100vh',
                    background: '#c4c9cf',
                    padding: '20px',
                    transition: 'margin-left 0.3s'
                }}>
                    <SettingsView searchQuery={searchQuery} user={user} />
                </div>
            </div>
        </>
    );
}
ReactDOM.render(<SettingsApp />, document.getElementById('root'));
})();
</script>
</body>
</html>
