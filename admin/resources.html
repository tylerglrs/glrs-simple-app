<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resources - GLRS Admin</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📚</text></svg>">
    <link rel="stylesheet" href="/admin/shared/styles.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script src="/admin/shared/firebase.js"></script>
    <script src="/admin/shared/auth.js"></script>
    <script src="/admin/shared/permissions.js?v=1"></script>
    <script src="/admin/shared/utils.js"></script>
    <script src="/admin/shared/state.js?v=2"></script>
    <script type="text/babel" src="/admin/shared/navigation.js?v=7"></script>
    <script type="text/babel" src="/admin/shared/header.js?v=1"></script>
    <script type="text/babel">
(function initPage() {
    if (!window.FIREBASE_READY || !window.auth || !window.db) {
        console.log('Waiting for Firebase to initialize...');
        setTimeout(initPage, 50);
        return;
    }
    const { useState, useEffect, useRef, useMemo, useCallback } = React;
    const { auth, db, storage, CURRENT_TENANT, logAudit } = window;

function ResourcesView({ user, searchQuery }) {
    // ========== CORE STATES ==========
    const [resources, setResources] = useState([]);
    const [loading, setLoading] = useState(true);
    const [showCreateModal, setShowCreateModal] = useState(false);
    const [showDetailModal, setShowDetailModal] = useState(false);
    const [selectedResource, setSelectedResource] = useState(null);
    
    // ========== FILTER STATES ==========
    const [filterType, setFilterType] = useState('all');
    const [filterCategory, setFilterCategory] = useState('all');
    const [filterStatus, setFilterStatus] = useState('all');
    const [viewMode, setViewMode] = useState('grid'); // 'grid' or 'list'
    const [sortBy, setSortBy] = useState('newest'); // 'newest', 'oldest', 'title', 'category'
    
    // ========== STATS STATE ==========
    const [stats, setStats] = useState({
        total: 0,
        active: 0,
        inactive: 0,
        global: 0,
        assigned: 0,
        byType: {},
        byCategory: {}
    });

    // ========== LOAD DATA ON MOUNT ==========
    useEffect(() => {
        loadResourcesData();
    }, []);

    // ========== DATA LOADING FUNCTIONS ==========
    const loadResourcesData = async () => {
        try {
            setLoading(true);
            
            // Query root-level resources filtered by tenantId (matching UserDetailModal pattern)
            const resourcesRef = db.collection('resources')
                .where('tenantId', '==', user.tenantId);
            
            const snapshot = await resourcesRef.get();
            const resourcesData = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));

            console.log(`✓ Loaded ${resourcesData.length} resources for tenant: ${user.tenantId}`);
            setResources(resourcesData);
            calculateStats(resourcesData);
        } catch (error) {
            console.error('Error loading resources:', error);
            alert('Failed to load resources: ' + error.message);
        } finally {
            setLoading(false);
        }
    };

    const calculateStats = (resourcesData) => {
        const stats = {
            total: resourcesData.length,
            active: resourcesData.filter(r => r.active !== false).length,
            inactive: resourcesData.filter(r => r.active === false).length,
            global: resourcesData.filter(r => r.isGlobal === true).length,
            assigned: resourcesData.filter(r => r.assignedTo && r.assignedTo.length > 0).length,
            byType: {},
            byCategory: {}
        };

        resourcesData.forEach(resource => {
            // Count by type
            const type = resource.type || 'unknown';
            stats.byType[type] = (stats.byType[type] || 0) + 1;

            // Count by category
            const category = resource.category || 'uncategorized';
            stats.byCategory[category] = (stats.byCategory[category] || 0) + 1;
        });

        setStats(stats);
    };

    // ========== EVENT HANDLERS ==========
    const handleResourceClick = (resource) => {
        setSelectedResource(resource);
        setShowDetailModal(true);
    };

    const handleDeleteResource = async (resourceId) => {
        if (!confirm('Are you sure you want to delete this resource? This action cannot be undone.')) return;

        try {
            await db.collection('resources').doc(resourceId).delete();
            await loadResourcesData();
            alert('Resource deleted successfully');
        } catch (error) {
            console.error('Error deleting resource:', error);
            alert('Failed to delete resource: ' + error.message);
        }
    };

    const handleToggleStatus = async (resource, e) => {
        e.stopPropagation(); // Prevent opening modal
        
        try {
            const newStatus = !resource.active;
            await db.collection('resources')
                .doc(resource.id)
                .update({
                    active: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

            await loadResourcesData();
        } catch (error) {
            console.error('Error updating resource status:', error);
            alert('Failed to update resource status');
        }
    };

    const handleRefresh = () => {
        loadResourcesData();
    };

    // ========== FILTERING & SORTING ==========
    const getFilteredAndSortedResources = () => {
        let filtered = [...resources];

        // Apply search query
        if (searchQuery && searchQuery.trim()) {
            const query = searchQuery.toLowerCase();
            filtered = filtered.filter(resource => 
                resource.title?.toLowerCase().includes(query) ||
                resource.description?.toLowerCase().includes(query) ||
                resource.category?.toLowerCase().includes(query) ||
                resource.type?.toLowerCase().includes(query)
            );
        }

        // Apply type filter
        if (filterType !== 'all') {
            filtered = filtered.filter(r => r.type === filterType);
        }

        // Apply category filter
        if (filterCategory !== 'all') {
            filtered = filtered.filter(r => r.category === filterCategory);
        }

        // Apply status filter
        if (filterStatus === 'active') {
            filtered = filtered.filter(r => r.active !== false);
        } else if (filterStatus === 'inactive') {
            filtered = filtered.filter(r => r.active === false);
        } else if (filterStatus === 'global') {
            filtered = filtered.filter(r => r.isGlobal === true);
        } else if (filterStatus === 'assigned') {
            filtered = filtered.filter(r => r.assignedTo && r.assignedTo.length > 0);
        }

        // Apply sorting
        filtered.sort((a, b) => {
            switch (sortBy) {
                case 'newest':
                    return (b.addedAt?.seconds || 0) - (a.addedAt?.seconds || 0);
                case 'oldest':
                    return (a.addedAt?.seconds || 0) - (b.addedAt?.seconds || 0);
                case 'title':
                    return (a.title || '').localeCompare(b.title || '');
                case 'category':
                    return (a.category || '').localeCompare(b.category || '');
                default:
                    return 0;
            }
        });

        return filtered;
    };

    const filteredResources = getFilteredAndSortedResources();

    // ========== RENDER: LOADING STATE ==========
    if (loading) {
        return (
            <div style={{ 
                padding: '40px', 
                textAlign: 'center',
                background: '#f5f7fa',
                minHeight: '100vh',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center'
            }}>
                <div>
                    <div style={{
                        width: '60px',
                        height: '60px',
                        border: '4px solid white',
                        borderTop: '4px solid #0077CC',
                        borderRadius: '50%',
                        animation: 'spin 1s linear infinite',
                        margin: '0 auto 20px'
                    }}></div>
                    <div style={{ 
                        fontSize: '18px', 
                        color: '#333',
                        fontWeight: '600'
                    }}>
                        Loading resources...
                    </div>
                </div>
            </div>
        );
    }

    // ========== RENDER: MAIN VIEW ==========
    return (
        <div style={{ 
            padding: '30px',
            background: '#f5f7fa',
            minHeight: '100vh'
        }}>
            {/* ========== HEADER SECTION ========== */}
            <div style={{ 
                display: 'flex', 
                justifyContent: 'space-between', 
                alignItems: 'center',
                marginBottom: '30px',
                flexWrap: 'wrap',
                gap: '20px'
            }}>
                <div>
                    <h1 style={{ 
                        margin: '0 0 8px 0',
                        color: '#333',
                        fontSize: '32px',
                        fontWeight: '600',
                        letterSpacing: '-0.5px'
                    }}>
                        📚 Resources
                    </h1>
                    <p style={{ 
                        margin: 0,
                        color: '#666',
                        fontSize: '16px'
                    }}>
                        Manage recovery resources and educational materials
                    </p>
                </div>
                <div style={{ display: 'flex', gap: '12px' }}>
                    <button
                        onClick={handleRefresh}
                        style={{
                            background: 'white',
                            color: '#333',
                            border: '1px solid #e0e0e0',
                            padding: '12px 20px',
                            borderRadius: '8px',
                            fontSize: '16px',
                            fontWeight: '600',
                            cursor: 'pointer',
                            transition: 'all 0.3s ease',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px'
                        }}
                        onMouseEnter={(e) => {
                            e.currentTarget.style.background = '#e3f2fd';
                        }}
                        onMouseLeave={(e) => {
                            e.currentTarget.style.background = 'white';
                        }}
                    >
                        🔄 Refresh
                    </button>
                    {/* 🔐 ACTION PERMISSION: create_resource - Create new resource */}
                    {window.canPerformAction(user, 'create_resource') && (
                        <button
                            onClick={() => setShowCreateModal(true)}
                            style={{
                                background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                color: 'white',
                                border: 'none',
                                padding: '14px 28px',
                                borderRadius: '8px',
                                fontSize: '16px',
                                fontWeight: '600',
                                cursor: 'pointer',
                                boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
                                transition: 'all 0.3s ease',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.transform = 'translateY(-2px)';
                                e.currentTarget.style.boxShadow = '0 6px 20px rgba(0,0,0,0.15)';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.transform = 'translateY(0)';
                                e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                            }}
                        >
                            ➕ Create Resource
                        </button>
                    )}
                </div>
            </div>

            {/* ========== STATS CARDS ========== */}
            <div style={{ 
                display: 'grid', 
                gridTemplateColumns: 'repeat(auto-fit, minmax(240px, 1fr))',
                gap: '20px',
                marginBottom: '30px'
            }}>
                {/* Total Resources */}
                <div style={{
                    background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    padding: '25px',
                    borderRadius: '12px',
                    boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
                    cursor: 'pointer',
                    transition: 'all 0.3s ease'
                }}
                onClick={() => setFilterStatus('all')}
                onMouseEnter={(e) => {
                    e.currentTarget.style.transform = 'translateY(-4px)';
                    e.currentTarget.style.boxShadow = '0 6px 20px rgba(0,0,0,0.15)';
                }}
                onMouseLeave={(e) => {
                    e.currentTarget.style.transform = 'translateY(0)';
                    e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                }}>
                    <div style={{ 
                        fontSize: '14px', 
                        color: 'white',
                        fontWeight: '600',
                        marginBottom: '10px',
                        textTransform: 'uppercase',
                        letterSpacing: '0.5px',
                        opacity: 0.95
                    }}>
                        TOTAL RESOURCES
                    </div>
                    <div style={{ 
                        fontSize: '48px', 
                        color: 'white',
                        fontWeight: '700',
                        marginBottom: '5px',
                        lineHeight: 1
                    }}>
                        {stats.total}
                    </div>
                    <div style={{ 
                        fontSize: '14px', 
                        color: 'white',
                        opacity: 0.9
                    }}>
                        All time
                    </div>
                </div>

                {/* Active Resources */}
                <div style={{
                    background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                    padding: '25px',
                    borderRadius: '12px',
                    boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
                    cursor: 'pointer',
                    transition: 'all 0.3s ease'
                }}
                onClick={() => setFilterStatus('active')}
                onMouseEnter={(e) => {
                    e.currentTarget.style.transform = 'translateY(-4px)';
                    e.currentTarget.style.boxShadow = '0 6px 20px rgba(0,0,0,0.15)';
                }}
                onMouseLeave={(e) => {
                    e.currentTarget.style.transform = 'translateY(0)';
                    e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                }}>
                    <div style={{ 
                        fontSize: '14px', 
                        color: 'white',
                        fontWeight: '600',
                        marginBottom: '10px',
                        textTransform: 'uppercase',
                        letterSpacing: '0.5px',
                        opacity: 0.95
                    }}>
                        ACTIVE RESOURCES
                    </div>
                    <div style={{ 
                        fontSize: '48px', 
                        color: 'white',
                        fontWeight: '700',
                        marginBottom: '5px',
                        lineHeight: 1
                    }}>
                        {stats.active}
                    </div>
                    <div style={{ 
                        fontSize: '14px', 
                        color: 'white',
                        opacity: 0.9
                    }}>
                        Visible to PIRs
                    </div>
                </div>

                {/* Resource Types */}
                <div style={{
                    background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                    padding: '25px',
                    borderRadius: '12px',
                    boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
                    cursor: 'pointer',
                    transition: 'all 0.3s ease'
                }}
                onMouseEnter={(e) => {
                    e.currentTarget.style.transform = 'translateY(-4px)';
                    e.currentTarget.style.boxShadow = '0 6px 20px rgba(0,0,0,0.15)';
                }}
                onMouseLeave={(e) => {
                    e.currentTarget.style.transform = 'translateY(0)';
                    e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                }}>
                    <div style={{ 
                        fontSize: '14px', 
                        color: 'white',
                        fontWeight: '600',
                        marginBottom: '10px',
                        textTransform: 'uppercase',
                        letterSpacing: '0.5px',
                        opacity: 0.95
                    }}>
                        RESOURCE TYPES
                    </div>
                    <div style={{ 
                        fontSize: '48px', 
                        color: 'white',
                        fontWeight: '700',
                        marginBottom: '5px',
                        lineHeight: 1
                    }}>
                        {Object.keys(stats.byType).length}
                    </div>
                    <div style={{ 
                        fontSize: '14px', 
                        color: 'white',
                        opacity: 0.9
                    }}>
                        Different formats
                    </div>
                </div>

                {/* Categories */}
                <div style={{
                    background: 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)',
                    padding: '25px',
                    borderRadius: '12px',
                    boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
                    cursor: 'pointer',
                    transition: 'all 0.3s ease'
                }}
                onMouseEnter={(e) => {
                    e.currentTarget.style.transform = 'translateY(-4px)';
                    e.currentTarget.style.boxShadow = '0 6px 20px rgba(0,0,0,0.15)';
                }}
                onMouseLeave={(e) => {
                    e.currentTarget.style.transform = 'translateY(0)';
                    e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                }}>
                    <div style={{ 
                        fontSize: '14px', 
                        color: 'white',
                        fontWeight: '600',
                        marginBottom: '10px',
                        textTransform: 'uppercase',
                        letterSpacing: '0.5px',
                        opacity: 0.95
                    }}>
                        CATEGORIES
                    </div>
                    <div style={{ 
                        fontSize: '48px', 
                        color: 'white',
                        fontWeight: '700',
                        marginBottom: '5px',
                        lineHeight: 1
                    }}>
                        {Object.keys(stats.byCategory).length}
                    </div>
                    <div style={{ 
                        fontSize: '14px', 
                        color: 'white',
                        opacity: 0.9
                    }}>
                        Organized topics
                    </div>
                </div>

                {/* Global Resources */}
                <div style={{
                    background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    padding: '25px',
                    borderRadius: '12px',
                    boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
                    cursor: 'pointer',
                    transition: 'all 0.3s ease'
                }}
                onClick={() => setFilterStatus('global')}
                onMouseEnter={(e) => {
                    e.currentTarget.style.transform = 'translateY(-4px)';
                    e.currentTarget.style.boxShadow = '0 6px 20px rgba(0,0,0,0.15)';
                }}
                onMouseLeave={(e) => {
                    e.currentTarget.style.transform = 'translateY(0)';
                    e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                }}>
                    <div style={{ 
                        fontSize: '14px', 
                        color: 'white',
                        fontWeight: '600',
                        marginBottom: '10px',
                        textTransform: 'uppercase',
                        letterSpacing: '0.5px',
                        opacity: 0.95
                    }}>
                        GLOBAL RESOURCES
                    </div>
                    <div style={{ 
                        fontSize: '48px', 
                        color: 'white',
                        fontWeight: '700',
                        marginBottom: '5px',
                        lineHeight: 1
                    }}>
                        {stats.global}
                    </div>
                    <div style={{ 
                        fontSize: '14px', 
                        color: 'white',
                        opacity: 0.9
                    }}>
                        Available to all PIRs
                    </div>
                </div>

                {/* Assigned Resources */}
                <div style={{
                    background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                    padding: '25px',
                    borderRadius: '12px',
                    boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
                    cursor: 'pointer',
                    transition: 'all 0.3s ease'
                }}
                onClick={() => setFilterStatus('assigned')}
                onMouseEnter={(e) => {
                    e.currentTarget.style.transform = 'translateY(-4px)';
                    e.currentTarget.style.boxShadow = '0 6px 20px rgba(0,0,0,0.15)';
                }}
                onMouseLeave={(e) => {
                    e.currentTarget.style.transform = 'translateY(0)';
                    e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                }}>
                    <div style={{ 
                        fontSize: '14px', 
                        color: 'white',
                        fontWeight: '600',
                        marginBottom: '10px',
                        textTransform: 'uppercase',
                        letterSpacing: '0.5px',
                        opacity: 0.95
                    }}>
                        ASSIGNED RESOURCES
                    </div>
                    <div style={{ 
                        fontSize: '48px', 
                        color: 'white',
                        fontWeight: '700',
                        marginBottom: '5px',
                        lineHeight: 1
                    }}>
                        {stats.assigned}
                    </div>
                    <div style={{ 
                        fontSize: '14px', 
                        color: 'white',
                        opacity: 0.9
                    }}>
                        Assigned to PIRs
                    </div>
                </div>
            </div>

            {/* ========== FILTERS & CONTROLS ========== */}
            <div style={{
                background: 'white',
                padding: '20px',
                borderRadius: '12px',
                marginBottom: '25px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                display: 'flex',
                gap: '15px',
                alignItems: 'center',
                flexWrap: 'wrap'
            }}>
                {/* Type Filter */}
                <select
                    value={filterType}
                    onChange={(e) => setFilterType(e.target.value)}
                    style={{
                        padding: '10px 15px',
                        borderRadius: '8px',
                        border: '1px solid #e0e0e0',
                        background: '#f5f7fa',
                        color: '#333',
                        fontSize: '14px',
                        fontWeight: '500',
                        cursor: 'pointer',
                        minWidth: '150px',
                        transition: 'all 0.3s ease'
                    }}
                >
                    <option value="all">All Types</option>
                    {Object.keys(stats.byType).sort().map(type => (
                        <option key={type} value={type}>
                            {type.charAt(0).toUpperCase() + type.slice(1)} ({stats.byType[type]})
                        </option>
                    ))}
                </select>

                {/* Category Filter */}
                <select
                    value={filterCategory}
                    onChange={(e) => setFilterCategory(e.target.value)}
                    style={{
                        padding: '10px 15px',
                        borderRadius: '8px',
                        border: '1px solid #e0e0e0',
                        background: '#f5f7fa',
                        color: '#333',
                        fontSize: '14px',
                        fontWeight: '500',
                        cursor: 'pointer',
                        minWidth: '150px',
                        transition: 'all 0.3s ease'
                    }}
                >
                    <option value="all">All Categories</option>
                    {Object.keys(stats.byCategory).sort().map(category => (
                        <option key={category} value={category}>
                            {category.charAt(0).toUpperCase() + category.slice(1)} ({stats.byCategory[category]})
                        </option>
                    ))}
                </select>

                {/* Status Filter */}
                <select
                    value={filterStatus}
                    onChange={(e) => setFilterStatus(e.target.value)}
                    style={{
                        padding: '10px 15px',
                        borderRadius: '8px',
                        border: '1px solid #e0e0e0',
                        background: '#f5f7fa',
                        color: '#333',
                        fontSize: '14px',
                        fontWeight: '500',
                        cursor: 'pointer',
                        minWidth: '150px',
                        transition: 'all 0.3s ease'
                    }}
                >
                    <option value="all">All Status</option>
                    <option value="active">Active Only</option>
                    <option value="inactive">Inactive Only</option>
                    <option value="global">Global Only</option>
                    <option value="assigned">Assigned Only</option>
                </select>

                {/* Sort By */}
                <select
                    value={sortBy}
                    onChange={(e) => setSortBy(e.target.value)}
                    style={{
                        padding: '10px 15px',
                        borderRadius: '8px',
                        border: '1px solid #e0e0e0',
                        background: '#f5f7fa',
                        color: '#333',
                        fontSize: '14px',
                        fontWeight: '500',
                        cursor: 'pointer',
                        minWidth: '150px',
                        transition: 'all 0.3s ease'
                    }}
                >
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="title">Title (A-Z)</option>
                    <option value="category">Category</option>
                </select>

                {/* View Mode Toggle */}
                <div style={{ marginLeft: 'auto', display: 'flex', gap: '10px' }}>
                    <button
                        onClick={() => setViewMode('grid')}
                        style={{
                            padding: '10px 20px',
                            background: viewMode === 'grid' ? 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)' : '#f5f7fa',
                            color: viewMode === 'grid' ? 'white' : '#333',
                            border: '1px solid #e0e0e0',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '600',
                            transition: 'all 0.3s ease'
                        }}
                    >
                        ⊞ Grid
                    </button>
                    <button
                        onClick={() => setViewMode('list')}
                        style={{
                            padding: '10px 20px',
                            background: viewMode === 'list' ? 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)' : '#f5f7fa',
                            color: viewMode === 'list' ? 'white' : '#333',
                            border: '1px solid #e0e0e0',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '600',
                            transition: 'all 0.3s ease'
                        }}
                    >
                        ☰ List
                    </button>
                </div>
            </div>

            {/* Results Count */}
            <div style={{
                marginBottom: '20px',
                color: '#666',
                fontSize: '14px',
                fontWeight: '500'
            }}>
                Showing {filteredResources.length} of {stats.total} resources
            </div>

            {/* ========== RESOURCES GRID/LIST ========== */}
            {filteredResources.length === 0 ? (
                <div style={{
                    textAlign: 'center',
                    padding: '80px 20px',
                    background: 'white',
                    borderRadius: '12px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                }}>
                    <div style={{ fontSize: '64px', marginBottom: '20px' }}>📚</div>
                    <div style={{ 
                        fontSize: '24px', 
                        fontWeight: '600',
                        color: '#333',
                        marginBottom: '10px'
                    }}>
                        {resources.length === 0 ? 'No resources yet' : 'No resources match your filters'}
                    </div>
                    <div style={{ 
                        fontSize: '16px',
                        color: '#666',
                        marginBottom: '30px'
                    }}>
                        {resources.length === 0 
                            ? 'Create your first resource to get started' 
                            : 'Try adjusting your filters to see more resources'}
                    </div>
                    {/* 🔐 ACTION PERMISSION: create_resource - Create first resource */}
                    {resources.length === 0 && window.canPerformAction(user, 'create_resource') && (
                        <button
                            onClick={() => setShowCreateModal(true)}
                            style={{
                                background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                color: 'white',
                                border: 'none',
                                padding: '14px 28px',
                                borderRadius: '8px',
                                fontSize: '16px',
                                fontWeight: '600',
                                cursor: 'pointer',
                                boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
                                transition: 'all 0.3s ease'
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.transform = 'translateY(-2px)';
                                e.currentTarget.style.boxShadow = '0 6px 20px rgba(0,0,0,0.15)';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.transform = 'translateY(0)';
                                e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                            }}
                        >
                            ➕ Create First Resource
                        </button>
                    )}
                </div>
            ) : (
                <div style={{
                    display: viewMode === 'grid' ? 'grid' : 'flex',
                    gridTemplateColumns: viewMode === 'grid' ? 'repeat(auto-fill, minmax(320px, 1fr))' : 'none',
                    flexDirection: viewMode === 'list' ? 'column' : 'none',
                    gap: '20px'
                }}>
                    {filteredResources.map(resource => (
                        <div
                            key={resource.id}
                            onClick={() => handleResourceClick(resource)}
                            style={{
                                background: 'white',
                                padding: '25px',
                                borderRadius: '12px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                                cursor: 'pointer',
                                transition: 'all 0.3s ease',
                                border: '1px solid #e0e0e0',
                                display: 'flex',
                                flexDirection: viewMode === 'list' ? 'row' : 'column',
                                gap: viewMode === 'list' ? '20px' : '0'
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.transform = 'translateY(-4px)';
                                e.currentTarget.style.boxShadow = '0 6px 20px rgba(0,0,0,0.15)';
                                e.currentTarget.style.borderColor = '#0077CC';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.transform = 'translateY(0)';
                                e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
                                e.currentTarget.style.borderColor = '#e0e0e0';
                            }}
                        >
                            {/* Resource Icon & Status */}
                            <div style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'flex-start',
                                marginBottom: viewMode === 'grid' ? '15px' : '0',
                                minWidth: viewMode === 'list' ? '100px' : 'auto'
                            }}>
                                <div style={{
                                    fontSize: viewMode === 'list' ? '48px' : '40px'
                                }}>
                                    {resource.type === 'link' ? '🔗' :
                                     resource.type === 'file' ? '📄' :
                                     resource.type === 'video' ? '🎥' :
                                     resource.type === 'article' ? '📰' : '📚'}
                                </div>
                                {viewMode === 'grid' && (
                                    <div style={{
                                        padding: '6px 12px',
                                        background: resource.active !== false ? 'linear-gradient(135deg, #00A86B 0%, #008554 100%)' : 'linear-gradient(135deg, #f44336 0%, #e53935 100%)',
                                        color: 'white',
                                        borderRadius: '8px',
                                        fontSize: '12px',
                                        fontWeight: '600'
                                    }}>
                                        {resource.active !== false ? '✓ Active' : '✕ Inactive'}
                                    </div>
                                )}
                            </div>

                            {/* Resource Content */}
                            <div style={{ flex: 1 }}>
                                {/* Title */}
                                <h3 style={{
                                    margin: '0 0 10px 0',
                                    fontSize: viewMode === 'list' ? '20px' : '18px',
                                    fontWeight: '600',
                                    color: '#333',
                                    lineHeight: '1.3'
                                }}>
                                    {resource.title}
                                </h3>

                                {/* Description */}
                                <p style={{
                                    margin: '0 0 15px 0',
                                    fontSize: '14px',
                                    color: '#666',
                                    lineHeight: '1.5',
                                    display: '-webkit-box',
                                    WebkitLineClamp: viewMode === 'list' ? 2 : 3,
                                    WebkitBoxOrient: 'vertical',
                                    overflow: 'hidden'
                                }}>
                                    {resource.description || 'No description provided'}
                                </p>

                                {/* Tags */}
                                <div style={{
                                    display: 'flex',
                                    gap: '10px',
                                    flexWrap: 'wrap',
                                    marginBottom: viewMode === 'list' ? '0' : '15px'
                                }}>
                                    <span style={{
                                        padding: '6px 12px',
                                        background: '#e3f2fd',
                                        color: '#0077CC',
                                        borderRadius: '8px',
                                        fontSize: '12px',
                                        fontWeight: '600'
                                    }}>
                                        {resource.category || 'Uncategorized'}
                                    </span>
                                    <span style={{
                                        padding: '6px 12px',
                                        background: '#e1f5fe',
                                        color: '#0288d1',
                                        borderRadius: '8px',
                                        fontSize: '12px',
                                        fontWeight: '600'
                                    }}>
                                        {resource.type}
                                    </span>
                                    {resource.isGlobal && (
                                        <span style={{
                                            padding: '6px 12px',
                                            background: '#fff3e0',
                                            color: '#f57c00',
                                            borderRadius: '8px',
                                            fontSize: '12px',
                                            fontWeight: '600'
                                        }}>
                                            🌐 Global
                                        </span>
                                    )}
                                    {resource.assignedTo && resource.assignedTo.length > 0 && (
                                        <span style={{
                                            padding: '6px 12px',
                                            background: '#e8f5e9',
                                            color: '#388e3c',
                                            borderRadius: '8px',
                                            fontSize: '12px',
                                            fontWeight: '600'
                                        }}>
                                            👥 {resource.assignedTo.length} PIR{resource.assignedTo.length !== 1 ? 's' : ''}
                                        </span>
                                    )}
                                </div>
                            </div>

                            {/* List View Actions */}
                            {viewMode === 'list' && (
                                <div style={{
                                    display: 'flex',
                                    flexDirection: 'column',
                                    gap: '10px',
                                    minWidth: '120px'
                                }}>
                                    <div style={{
                                        padding: '8px 16px',
                                        background: resource.active !== false ? 'linear-gradient(135deg, #00A86B 0%, #008554 100%)' : 'linear-gradient(135deg, #f44336 0%, #e53935 100%)',
                                        color: 'white',
                                        borderRadius: '8px',
                                        fontSize: '12px',
                                        fontWeight: '600',
                                        textAlign: 'center'
                                    }}>
                                        {resource.active !== false ? '✓ Active' : '✕ Inactive'}
                                    </div>
                                    <button
                                        onClick={(e) => handleToggleStatus(resource, e)}
                                        style={{
                                            padding: '8px 16px',
                                            background: '#f5f7fa',
                                            color: '#333',
                                            border: '1px solid #e0e0e0',
                                            borderRadius: '8px',
                                            fontSize: '12px',
                                            fontWeight: '600',
                                            cursor: 'pointer',
                                            transition: 'all 0.3s ease'
                                        }}
                                        onMouseEnter={(e) => {
                                            e.currentTarget.style.background = '#e3f2fd';
                                        }}
                                        onMouseLeave={(e) => {
                                            e.currentTarget.style.background = '#f5f7fa';
                                        }}
                                    >
                                        Toggle
                                    </button>
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            )}

            {/* ========== MODALS ========== */}
            {showCreateModal && (
                <ResourceCreateModal
                    user={user}
                    onClose={() => setShowCreateModal(false)}
                    onSuccess={() => {
                        setShowCreateModal(false);
                        loadResourcesData();
                    }}
                />
            )}

            {showDetailModal && selectedResource && (
                <ResourceDetailModal
                    resource={selectedResource}
                    user={user}
                    onClose={() => {
                        setShowDetailModal(false);
                        setSelectedResource(null);
                    }}
                    onUpdate={() => {
                        loadResourcesData();
                    }}
                    onDelete={(id) => {
                        handleDeleteResource(id);
                        setShowDetailModal(false);
                        setSelectedResource(null);
                    }}
                />
            )}
        </div>
    );
}
    
   // ========================================
// RESOURCECREATEMODAL - COMPLETE CREATION MODAL
// Matches UserDetailModal styling patterns
// Uses root-level Firestore with tenantId field
// ========================================
function ResourceCreateModal({ user, onClose, onSuccess }) {
    // ========== FORM STATE ==========
    const [formData, setFormData] = useState({
        title: '',
        description: '',
        type: 'link',
        category: '',
        url: '',
        fileURL: '',
        embedUrl: '',
        content: '',
        isGlobal: false,
        active: true,
        tags: []
    });

    // ========== UI STATES ==========
    const [saving, setSaving] = useState(false);
    const [errors, setErrors] = useState({});
    const [showCategoryDropdown, setShowCategoryDropdown] = useState(false);
    const [customCategory, setCustomCategory] = useState('');
    
    // ========== PREDEFINED CATEGORIES ==========
    const predefinedCategories = [
        'Education',
        'Coping Skills',
        'Mindfulness',
        'Exercise & Wellness',
        'Nutrition',
        'Sleep Hygiene',
        'Stress Management',
        'Relapse Prevention',
        'Support Groups',
        'Motivational',
        'Personal Growth',
        'Relationships',
        'Financial Wellness',
        'Career Development',
        'Creative Expression'
    ];

    // ========== VALIDATION ==========
    const validateForm = () => {
        const newErrors = {};

        // Title validation
        if (!formData.title.trim()) {
            newErrors.title = 'Title is required';
        } else if (formData.title.length < 3) {
            newErrors.title = 'Title must be at least 3 characters';
        } else if (formData.title.length > 100) {
            newErrors.title = 'Title must be less than 100 characters';
        }

        // Category validation
        if (!formData.category.trim()) {
            newErrors.category = 'Category is required';
        }

        // Type-specific validation
        if (formData.type === 'link' && !formData.url.trim()) {
            newErrors.url = 'URL is required for link resources';
        } else if (formData.type === 'link' && formData.url.trim()) {
            try {
                new URL(formData.url);
            } catch (e) {
                newErrors.url = 'Please enter a valid URL';
            }
        }

        if (formData.type === 'file' && !formData.fileURL.trim()) {
            newErrors.fileURL = 'File URL is required for file resources';
        }

        if (formData.type === 'video' && !formData.embedUrl.trim()) {
            newErrors.embedUrl = 'Video embed URL is required for video resources';
        }

        if (formData.type === 'article' && !formData.content.trim()) {
            newErrors.content = 'Content is required for article resources';
        }

        setErrors(newErrors);
        return Object.keys(newErrors).length === 0;
    };

    // ========== FORM SUBMISSION ==========
    const handleSubmit = async (e) => {
        e.preventDefault();
        
        if (!validateForm()) {
            return;
        }

        try {
            setSaving(true);
            
            // Create resource in root-level collection with tenantId field
            await db.collection('resources').add({
                title: formData.title.trim(),
                description: formData.description.trim(),
                type: formData.type,
                category: formData.category.trim(),
                url: formData.url.trim(),
                fileURL: formData.fileURL.trim(),
                embedUrl: formData.embedUrl.trim(),
                content: formData.content.trim(),
                contentType: formData.type,
                isGlobal: formData.isGlobal,
                active: formData.active,
                tags: formData.tags,
                tenantId: user.tenantId,
                addedBy: user.uid,
                addedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                assignedTo: [],
                viewCount: 0,
                completionCount: 0
            });

            alert('Resource created successfully! 🎉');
            onSuccess();
        } catch (error) {
            console.error('Error creating resource:', error);
            alert('Failed to create resource: ' + error.message);
        } finally {
            setSaving(false);
        }
    };

    // ========== HELPER FUNCTIONS ==========
    const handleCategorySelect = (category) => {
        setFormData({...formData, category});
        setShowCategoryDropdown(false);
        setCustomCategory('');
    };

    const handleCustomCategory = () => {
        if (customCategory.trim()) {
            setFormData({...formData, category: customCategory.trim()});
            setShowCategoryDropdown(false);
            setCustomCategory('');
        }
    };

    const getResourceTypeIcon = (type) => {
        switch (type) {
            case 'link': return '🔗';
            case 'file': return '📄';
            case 'video': return '🎥';
            case 'article': return '📰';
            default: return '📚';
        }
    };

    const getResourceTypeDescription = (type) => {
        switch (type) {
            case 'link': return 'External website or web resource';
            case 'file': return 'PDF, document, or downloadable file';
            case 'video': return 'YouTube, Vimeo, or embedded video';
            case 'article': return 'Written content stored in the system';
            default: return 'Select a resource type';
        }
    };

    // ========== RENDER ==========
    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.5)',
            backdropFilter: 'blur(5px)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000,
            animation: 'fadeIn 0.3s ease-in-out',
            padding: '20px'
        }}>
            <div style={{
                maxWidth: '700px',
                width: '100%',
                maxHeight: '90vh',
                background: 'white',
                borderRadius: '20px',
                boxShadow: '0 10px 30px rgba(0,0,0,0.2)',
                display: 'flex',
                flexDirection: 'column',
                overflow: 'hidden',
                animation: 'slideUp 0.3s ease-out'
            }}>
                {/* ========== MODAL HEADER ========== */}
                <div style={{
                    background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                    padding: '25px 30px',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    borderBottom: '1px solid rgba(255,255,255,0.1)'
                }}>
                    <div>
                        <h3 style={{
                            margin: '0 0 5px 0',
                            color: 'white',
                            fontSize: '24px',
                            fontWeight: '600',
                            letterSpacing: '-0.5px'
                        }}>
                            Create New Resource
                        </h3>
                        <p style={{
                            margin: 0,
                            color: 'white',
                            fontSize: '14px',
                            opacity: 0.9
                        }}>
                            Add educational content for PIRs
                        </p>
                    </div>
                    <button
                        onClick={onClose}
                        disabled={saving}
                        style={{
                            background: 'rgba(255,255,255,0.2)',
                            border: 'none',
                            color: 'white',
                            fontSize: '28px',
                            width: '40px',
                            height: '40px',
                            borderRadius: '50%',
                            cursor: saving ? 'not-allowed' : 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            transition: 'all 0.3s ease',
                            fontWeight: '300',
                            opacity: saving ? 0.5 : 1
                        }}
                        onMouseEnter={(e) => {
                            if (!saving) {
                                e.currentTarget.style.background = 'rgba(255,255,255,0.3)';
                                e.currentTarget.style.transform = 'rotate(90deg)';
                            }
                        }}
                        onMouseLeave={(e) => {
                            if (!saving) {
                                e.currentTarget.style.background = 'rgba(255,255,255,0.2)';
                                e.currentTarget.style.transform = 'rotate(0deg)';
                            }
                        }}
                    >
                        ×
                    </button>
                </div>

                {/* ========== MODAL CONTENT ========== */}
                <form onSubmit={handleSubmit} style={{
                    flex: 1,
                    overflowY: 'auto',
                    background: '#f5f7fa'
                }}>
                    <div style={{ padding: '30px' }}>
                        
                        {/* ========== BASIC INFO SECTION ========== */}
                        <div style={{
                            background: 'white',
                            padding: '25px',
                            borderRadius: '12px',
                            marginBottom: '25px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                        }}>
                            <h4 style={{
                                margin: '0 0 20px 0',
                                color: '#333',
                                fontSize: '18px',
                                fontWeight: '600',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px'
                            }}>
                                📝 Basic Information
                            </h4>

                            {/* Title Field */}
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{
                                    display: 'block',
                                    marginBottom: '8px',
                                    color: '#333',
                                    fontWeight: '600',
                                    fontSize: '14px'
                                }}>
                                    Resource Title *
                                </label>
                                <input
                                    type="text"
                                    value={formData.title}
                                    onChange={(e) => setFormData({...formData, title: e.target.value})}
                                    placeholder="e.g., Guided Meditation for Stress Relief"
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        borderRadius: '8px',
                                        border: errors.title ? '2px solid #f44336' : '1px solid #e0e0e0',
                                        fontSize: '14px',
                                        color: '#333',
                                        background: '#f5f7fa',
                                        transition: 'all 0.3s ease'
                                    }}
                                    onFocus={(e) => {
                                        if (!errors.title) {
                                            e.currentTarget.style.borderColor = '#0077CC';
                                        }
                                    }}
                                    onBlur={(e) => {
                                        if (!errors.title) {
                                            e.currentTarget.style.borderColor = '#e0e0e0';
                                        }
                                    }}
                                />
                                {errors.title && (
                                    <div style={{
                                        marginTop: '5px',
                                        color: '#f44336',
                                        fontSize: '12px',
                                        fontWeight: '500'
                                    }}>
                                        ⚠️ {errors.title}
                                    </div>
                                )}
                            </div>

                            {/* Description Field */}
                            <div style={{ marginBottom: '0' }}>
                                <label style={{
                                    display: 'block',
                                    marginBottom: '8px',
                                    color: '#333',
                                    fontWeight: '600',
                                    fontSize: '14px'
                                }}>
                                    Description
                                </label>
                                <textarea
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                    placeholder="Describe what this resource is about and how it can help PIRs..."
                                    rows="4"
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        borderRadius: '8px',
                                        border: '1px solid #e0e0e0',
                                        fontSize: '14px',
                                        color: '#333',
                                        background: '#f5f7fa',
                                        resize: 'vertical',
                                        fontFamily: 'inherit',
                                        lineHeight: '1.5',
                                        transition: 'all 0.3s ease'
                                    }}
                                    onFocus={(e) => {
                                        e.currentTarget.style.borderColor = '#0077CC';
                                    }}
                                    onBlur={(e) => {
                                        e.currentTarget.style.borderColor = '#e0e0e0';
                                    }}
                                />
                            </div>
                        </div>

                        {/* ========== RESOURCE TYPE SECTION ========== */}
                        <div style={{
                            background: 'white',
                            padding: '25px',
                            borderRadius: '12px',
                            marginBottom: '25px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                        }}>
                            <h4 style={{
                                margin: '0 0 20px 0',
                                color: '#333',
                                fontSize: '18px',
                                fontWeight: '600',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px'
                            }}>
                                📋 Resource Type
                            </h4>

                            {/* Type Selector */}
                            <div style={{
                                display: 'grid',
                                gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))',
                                gap: '15px',
                                marginBottom: '20px'
                            }}>
                                {['link', 'file', 'video', 'article'].map(type => (
                                    <div
                                        key={type}
                                        onClick={() => setFormData({...formData, type})}
                                        style={{
                                            padding: '20px',
                                            borderRadius: '8px',
                                            border: formData.type === type ? '2px solid #0077CC' : '1px solid #e0e0e0',
                                            background: formData.type === type ? '#e3f2fd' : '#f5f7fa',
                                            cursor: 'pointer',
                                            transition: 'all 0.3s ease',
                                            textAlign: 'center'
                                        }}
                                        onMouseEnter={(e) => {
                                            if (formData.type !== type) {
                                                e.currentTarget.style.borderColor = '#0077CC';
                                                e.currentTarget.style.transform = 'translateY(-2px)';
                                            }
                                        }}
                                        onMouseLeave={(e) => {
                                            if (formData.type !== type) {
                                                e.currentTarget.style.borderColor = '#e0e0e0';
                                                e.currentTarget.style.transform = 'translateY(0)';
                                            }
                                        }}
                                    >
                                        <div style={{ fontSize: '32px', marginBottom: '8px' }}>
                                            {getResourceTypeIcon(type)}
                                        </div>
                                        <div style={{
                                            fontSize: '14px',
                                            fontWeight: '600',
                                            color: formData.type === type ? '#0077CC' : '#333',
                                            textTransform: 'capitalize'
                                        }}>
                                            {type}
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {/* Type Description */}
                            <div style={{
                                padding: '15px',
                                background: '#e1f5fe',
                                borderLeft: '4px solid #0288d1',
                                borderRadius: '8px',
                                fontSize: '14px',
                                color: '#333',
                                lineHeight: '1.5'
                            }}>
                                <strong>ℹ️ {formData.type.charAt(0).toUpperCase() + formData.type.slice(1)}:</strong> {getResourceTypeDescription(formData.type)}
                            </div>

                            {/* Type-Specific Fields */}
                            <div style={{ marginTop: '20px' }}>
                                {formData.type === 'link' && (
                                    <div>
                                        <label style={{
                                            display: 'block',
                                            marginBottom: '8px',
                                            color: '#333',
                                            fontWeight: '600',
                                            fontSize: '14px'
                                        }}>
                                            URL *
                                        </label>
                                        <input
                                            type="url"
                                            value={formData.url}
                                            onChange={(e) => setFormData({...formData, url: e.target.value})}
                                            placeholder="https://example.com/resource"
                                            style={{
                                                width: '100%',
                                                padding: '12px 15px',
                                                borderRadius: '8px',
                                                border: errors.url ? '2px solid #f44336' : '1px solid #e0e0e0',
                                                fontSize: '14px',
                                                color: '#333',
                                                background: '#f5f7fa',
                                                transition: 'all 0.3s ease'
                                            }}
                                            onFocus={(e) => {
                                                if (!errors.url) {
                                                    e.currentTarget.style.borderColor = '#0077CC';
                                                }
                                            }}
                                            onBlur={(e) => {
                                                if (!errors.url) {
                                                    e.currentTarget.style.borderColor = '#e0e0e0';
                                                }
                                            }}
                                        />
                                        {errors.url && (
                                            <div style={{
                                                marginTop: '5px',
                                                color: '#f44336',
                                                fontSize: '12px',
                                                fontWeight: '500'
                                            }}>
                                                ⚠️ {errors.url}
                                            </div>
                                        )}
                                    </div>
                                )}

                                {formData.type === 'file' && (
                                    <div>
                                        <label style={{
                                            display: 'block',
                                            marginBottom: '8px',
                                            color: '#333',
                                            fontWeight: '600',
                                            fontSize: '14px'
                                        }}>
                                            File URL *
                                        </label>
                                        <input
                                            type="url"
                                            value={formData.fileURL}
                                            onChange={(e) => setFormData({...formData, fileURL: e.target.value})}
                                            placeholder="https://storage.googleapis.com/..."
                                            style={{
                                                width: '100%',
                                                padding: '12px 15px',
                                                borderRadius: '8px',
                                                border: errors.fileURL ? '2px solid #f44336' : '1px solid #e0e0e0',
                                                fontSize: '14px',
                                                color: '#333',
                                                background: '#f5f7fa',
                                                transition: 'all 0.3s ease'
                                            }}
                                            onFocus={(e) => {
                                                if (!errors.fileURL) {
                                                    e.currentTarget.style.borderColor = '#0077CC';
                                                }
                                            }}
                                            onBlur={(e) => {
                                                if (!errors.fileURL) {
                                                    e.currentTarget.style.borderColor = '#e0e0e0';
                                                }
                                            }}
                                        />
                                        {errors.fileURL && (
                                            <div style={{
                                                marginTop: '5px',
                                                color: '#f44336',
                                                fontSize: '12px',
                                                fontWeight: '500'
                                            }}>
                                                ⚠️ {errors.fileURL}
                                            </div>
                                        )}
                                        <div style={{
                                            marginTop: '8px',
                                            fontSize: '12px',
                                            color: '#666'
                                        }}>
                                            💡 Upload your file to Google Drive or Firebase Storage first, then paste the URL here
                                        </div>
                                    </div>
                                )}

                                {formData.type === 'video' && (
                                    <div>
                                        <label style={{
                                            display: 'block',
                                            marginBottom: '8px',
                                            color: '#333',
                                            fontWeight: '600',
                                            fontSize: '14px'
                                        }}>
                                            Video Embed URL *
                                        </label>
                                        <input
                                            type="url"
                                            value={formData.embedUrl}
                                            onChange={(e) => setFormData({...formData, embedUrl: e.target.value})}
                                            placeholder="https://youtube.com/embed/..."
                                            style={{
                                                width: '100%',
                                                padding: '12px 15px',
                                                borderRadius: '8px',
                                                border: errors.embedUrl ? '2px solid #f44336' : '1px solid #e0e0e0',
                                                fontSize: '14px',
                                                color: '#333',
                                                background: '#f5f7fa',
                                                transition: 'all 0.3s ease'
                                            }}
                                            onFocus={(e) => {
                                                if (!errors.embedUrl) {
                                                    e.currentTarget.style.borderColor = '#0077CC';
                                                }
                                            }}
                                            onBlur={(e) => {
                                                if (!errors.embedUrl) {
                                                    e.currentTarget.style.borderColor = '#e0e0e0';
                                                }
                                            }}
                                        />
                                        {errors.embedUrl && (
                                            <div style={{
                                                marginTop: '5px',
                                                color: '#f44336',
                                                fontSize: '12px',
                                                fontWeight: '500'
                                            }}>
                                                ⚠️ {errors.embedUrl}
                                            </div>
                                        )}
                                        <div style={{
                                            marginTop: '8px',
                                            fontSize: '12px',
                                            color: '#666'
                                        }}>
                                            💡 Use YouTube embed format: https://youtube.com/embed/VIDEO_ID
                                        </div>
                                    </div>
                                )}

                                {formData.type === 'article' && (
                                    <div>
                                        <label style={{
                                            display: 'block',
                                            marginBottom: '8px',
                                            color: '#333',
                                            fontWeight: '600',
                                            fontSize: '14px'
                                        }}>
                                            Article Content *
                                        </label>
                                        <textarea
                                            value={formData.content}
                                            onChange={(e) => setFormData({...formData, content: e.target.value})}
                                            placeholder="Write your article content here..."
                                            rows="12"
                                            style={{
                                                width: '100%',
                                                padding: '12px 15px',
                                                borderRadius: '8px',
                                                border: errors.content ? '2px solid #f44336' : '1px solid #e0e0e0',
                                                fontSize: '14px',
                                                color: '#333',
                                                background: '#f5f7fa',
                                                resize: 'vertical',
                                                fontFamily: 'inherit',
                                                lineHeight: '1.6',
                                                transition: 'all 0.3s ease'
                                            }}
                                            onFocus={(e) => {
                                                if (!errors.content) {
                                                    e.currentTarget.style.borderColor = '#0077CC';
                                                }
                                            }}
                                            onBlur={(e) => {
                                                if (!errors.content) {
                                                    e.currentTarget.style.borderColor = '#e0e0e0';
                                                }
                                            }}
                                        />
                                        {errors.content && (
                                            <div style={{
                                                marginTop: '5px',
                                                color: '#f44336',
                                                fontSize: '12px',
                                                fontWeight: '500'
                                            }}>
                                                ⚠️ {errors.content}
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* ========== CATEGORY SECTION ========== */}
                        <div style={{
                            background: 'white',
                            padding: '25px',
                            borderRadius: '12px',
                            marginBottom: '25px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                        }}>
                            <h4 style={{
                                margin: '0 0 20px 0',
                                color: '#333',
                                fontSize: '18px',
                                fontWeight: '600',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px'
                            }}>
                                🏷️ Category *
                            </h4>

                            {/* Selected Category Display */}
                            <div style={{
                                padding: '12px 15px',
                                background: formData.category ? '#e3f2fd' : '#f5f7fa',
                                border: errors.category ? '2px solid #f44336' : '1px solid #e0e0e0',
                                borderRadius: '8px',
                                marginBottom: '15px',
                                fontSize: '14px',
                                color: formData.category ? '#0077CC' : '#666',
                                fontWeight: formData.category ? '600' : '400',
                                minHeight: '44px',
                                display: 'flex',
                                alignItems: 'center'
                            }}>
                                {formData.category || 'No category selected'}
                            </div>
                            {errors.category && (
                                <div style={{
                                    marginBottom: '15px',
                                    color: '#f44336',
                                    fontSize: '12px',
                                    fontWeight: '500'
                                }}>
                                    ⚠️ {errors.category}
                                </div>
                            )}

                            {/* Quick Select Categories */}
                            <div style={{
                                display: 'grid',
                                gridTemplateColumns: 'repeat(auto-fill, minmax(160px, 1fr))',
                                gap: '10px',
                                marginBottom: '15px'
                            }}>
                                {predefinedCategories.slice(0, 6).map(category => (
                                    <button
                                        key={category}
                                        type="button"
                                        onClick={() => handleCategorySelect(category.toLowerCase())}
                                        style={{
                                            padding: '10px 15px',
                                            background: formData.category === category.toLowerCase() ? 
                                                'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)' : 
                                                '#f5f7fa',
                                            color: formData.category === category.toLowerCase() ? 
                                                'white' : 
                                                '#333',
                                            border: '1px solid #e0e0e0',
                                            borderRadius: '8px',
                                            fontSize: '13px',
                                            fontWeight: '500',
                                            cursor: 'pointer',
                                            transition: 'all 0.3s ease',
                                            textAlign: 'center'
                                        }}
                                        onMouseEnter={(e) => {
                                            if (formData.category !== category.toLowerCase()) {
                                                e.currentTarget.style.background = '#e3f2fd';
                                                e.currentTarget.style.color = '#0077CC';
                                            }
                                        }}
                                        onMouseLeave={(e) => {
                                            if (formData.category !== category.toLowerCase()) {
                                                e.currentTarget.style.background = '#f5f7fa';
                                                e.currentTarget.style.color = '#333';
                                            }
                                        }}
                                    >
                                        {category}
                                    </button>
                                ))}
                            </div>

                            {/* Show All Categories Button */}
                            <button
                                type="button"
                                onClick={() => setShowCategoryDropdown(!showCategoryDropdown)}
                                style={{
                                    width: '100%',
                                    padding: '12px 15px',
                                    background: '#f5f7fa',
                                    color: '#333',
                                    border: '1px solid #e0e0e0',
                                    borderRadius: '8px',
                                    fontSize: '14px',
                                    fontWeight: '500',
                                    cursor: 'pointer',
                                    transition: 'all 0.3s ease',
                                    marginBottom: '15px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'space-between'
                                }}
                                onMouseEnter={(e) => {
                                    e.currentTarget.style.background = '#e3f2fd';
                                    e.currentTarget.style.borderColor = '#0077CC';
                                }}
                                onMouseLeave={(e) => {
                                    e.currentTarget.style.background = '#f5f7fa';
                                    e.currentTarget.style.borderColor = '#e0e0e0';
                                }}
                            >
                                <span>📂 {showCategoryDropdown ? 'Hide' : 'Show'} All Categories</span>
                                <span>{showCategoryDropdown ? '▲' : '▼'}</span>
                            </button>

                            {/* All Categories Dropdown */}
                            {showCategoryDropdown && (
                                <div style={{
                                    maxHeight: '200px',
                                    overflowY: 'auto',
                                    background: '#f5f7fa',
                                    border: '1px solid #e0e0e0',
                                    borderRadius: '8px',
                                    marginBottom: '15px'
                                }}>
                                    {predefinedCategories.map(category => (
                                        <div
                                            key={category}
                                            onClick={() => handleCategorySelect(category.toLowerCase())}
                                            style={{
                                                padding: '12px 15px',
                                                cursor: 'pointer',
                                                background: formData.category === category.toLowerCase() ? 
                                                    '#e3f2fd' : 
                                                    'transparent',
                                                color: formData.category === category.toLowerCase() ? 
                                                    '#0077CC' : 
                                                    '#333',
                                                fontSize: '14px',
                                                fontWeight: formData.category === category.toLowerCase() ? '600' : '400',
                                                borderBottom: '1px solid #e0e0e0',
                                                transition: 'all 0.3s ease'
                                            }}
                                            onMouseEnter={(e) => {
                                                e.currentTarget.style.background = '#e3f2fd';
                                            }}
                                            onMouseLeave={(e) => {
                                                if (formData.category !== category.toLowerCase()) {
                                                    e.currentTarget.style.background = 'transparent';
                                                }
                                            }}
                                        >
                                            {formData.category === category.toLowerCase() && '✓ '}{category}
                                        </div>
                                    ))}
                                </div>
                            )}

                            {/* Custom Category Input */}
                            <div>
                                <label style={{
                                    display: 'block',
                                    marginBottom: '8px',
                                    color: '#333',
                                    fontWeight: '600',
                                    fontSize: '14px'
                                }}>
                                    Or Create Custom Category
                                </label>
                                <div style={{ display: 'flex', gap: '10px' }}>
                                    <input
                                        type="text"
                                        value={customCategory}
                                        onChange={(e) => setCustomCategory(e.target.value)}
                                        placeholder="Enter custom category..."
                                        style={{
                                            flex: 1,
                                            padding: '12px 15px',
                                            borderRadius: '8px',
                                            border: '1px solid #e0e0e0',
                                            fontSize: '14px',
                                            color: '#333',
                                            background: '#f5f7fa',
                                            transition: 'all 0.3s ease'
                                        }}
                                        onFocus={(e) => {
                                            e.currentTarget.style.borderColor = '#0077CC';
                                        }}
                                        onBlur={(e) => {
                                            e.currentTarget.style.borderColor = '#e0e0e0';
                                        }}
                                    />
                                    <button
                                        type="button"
                                        onClick={handleCustomCategory}
                                        disabled={!customCategory.trim()}
                                        style={{
                                            padding: '12px 20px',
                                            background: customCategory.trim() ? 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)' : '#999',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '8px',
                                            fontSize: '14px',
                                            fontWeight: '600',
                                            cursor: customCategory.trim() ? 'pointer' : 'not-allowed',
                                            transition: 'all 0.3s ease',
                                            whiteSpace: 'nowrap'
                                        }}
                                    >
                                        Add
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* ========== OPTIONS SECTION ========== */}
                        <div style={{
                            background: 'white',
                            padding: '25px',
                            borderRadius: '12px',
                            marginBottom: '0',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                        }}>
                            <h4 style={{
                                margin: '0 0 20px 0',
                                color: '#333',
                                fontSize: '18px',
                                fontWeight: '600',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px'
                            }}>
                                ⚙️ Options
                            </h4>

                            {/* Global Resource Toggle */}
                            <label style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '12px',
                                padding: '15px',
                                background: '#f5f7fa',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                marginBottom: '15px',
                                transition: 'all 0.3s ease'
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.background = '#e3f2fd';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.background = '#f5f7fa';
                            }}>
                                <input
                                    type="checkbox"
                                    checked={formData.isGlobal}
                                    onChange={(e) => setFormData({...formData, isGlobal: e.target.checked})}
                                    style={{
                                        cursor: 'pointer',
                                        width: '20px',
                                        height: '20px'
                                    }}
                                />
                                <div style={{ flex: 1 }}>
                                    <div style={{
                                        fontSize: '14px',
                                        fontWeight: '600',
                                        color: '#333',
                                        marginBottom: '4px'
                                    }}>
                                        🌐 Make this a Global Resource
                                    </div>
                                    <div style={{
                                        fontSize: '12px',
                                        color: '#666',
                                        lineHeight: '1.4'
                                    }}>
                                        Global resources are automatically visible to all PIRs. Non-global resources must be manually assigned.
                                    </div>
                                </div>
                            </label>

                            {/* Active Status Toggle */}
                            <label style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '12px',
                                padding: '15px',
                                background: '#f5f7fa',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                transition: 'all 0.3s ease'
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.background = '#e3f2fd';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.background = '#f5f7fa';
                            }}>
                                <input
                                    type="checkbox"
                                    checked={formData.active}
                                    onChange={(e) => setFormData({...formData, active: e.target.checked})}
                                    style={{
                                        cursor: 'pointer',
                                        width: '20px',
                                        height: '20px'
                                    }}
                                />
                                <div style={{ flex: 1 }}>
                                    <div style={{
                                        fontSize: '14px',
                                        fontWeight: '600',
                                        color: '#333',
                                        marginBottom: '4px'
                                    }}>
                                        ✓ Mark as Active
                                    </div>
                                    <div style={{
                                        fontSize: '12px',
                                        color: '#666',
                                        lineHeight: '1.4'
                                    }}>
                                        Only active resources are visible to PIRs. Uncheck to save as draft.
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>

                    {/* ========== ACTION BUTTONS ========== */}
                    <div style={{
                        padding: '20px 30px',
                        background: 'white',
                        borderTop: '2px solid #e0e0e0',
                        display: 'flex',
                        gap: '15px',
                        justifyContent: 'flex-end',
                        position: 'sticky',
                        bottom: 0
                    }}>
                        <button
                            type="button"
                            onClick={onClose}
                            disabled={saving}
                            style={{
                                padding: '12px 24px',
                                borderRadius: '8px',
                                border: '1px solid #e0e0e0',
                                background: '#f5f7fa',
                                color: '#333',
                                fontSize: '14px',
                                fontWeight: '600',
                                cursor: saving ? 'not-allowed' : 'pointer',
                                transition: 'all 0.3s ease',
                                opacity: saving ? 0.5 : 1
                            }}
                            onMouseEnter={(e) => {
                                if (!saving) {
                                    e.currentTarget.style.background = '#ffebee';
                                    e.currentTarget.style.color = '#f44336';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (!saving) {
                                    e.currentTarget.style.background = '#f5f7fa';
                                    e.currentTarget.style.color = '#333';
                                }
                            }}
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            disabled={saving}
                            style={{
                                padding: '12px 32px',
                                borderRadius: '8px',
                                border: 'none',
                                background: saving ? '#999' : 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                color: 'white',
                                fontSize: '14px',
                                fontWeight: '600',
                                cursor: saving ? 'not-allowed' : 'pointer',
                                transition: 'all 0.3s ease',
                                boxShadow: saving ? 'none' : '0 4px 12px rgba(0,0,0,0.1)',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                            }}
                            onMouseEnter={(e) => {
                                if (!saving) {
                                    e.currentTarget.style.transform = 'translateY(-2px)';
                                    e.currentTarget.style.boxShadow = '0 6px 20px rgba(0,0,0,0.15)';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (!saving) {
                                    e.currentTarget.style.transform = 'translateY(0)';
                                    e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                                }
                            }}
                        >
                            {saving ? (
                                <>
                                    <span style={{
                                        display: 'inline-block',
                                        width: '16px',
                                        height: '16px',
                                        border: '2px solid white',
                                        borderTop: '2px solid transparent',
                                        borderRadius: '50%',
                                        animation: 'spin 0.8s linear infinite'
                                    }}></span>
                                    Creating...
                                </>
                            ) : (
                                <>✨ Create Resource</>
                            )}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
}
       // ========================================
// RESOURCEDETAILMODAL - COMPLETE DETAIL MODAL WITH 4 TABS
// Matches UserDetailModal styling patterns
// Uses root-level Firestore with tenantId filtering
// ========================================
function ResourceDetailModal({ resource, user, onClose, onUpdate, onDelete }) {
    // ========== CORE STATES ==========
    const [resourceData, setResourceData] = useState(resource);
    const [loading, setLoading] = useState(false);
    const [activeTab, setActiveTab] = useState('overview');
    
    // ========== DATA STATES ==========
    const [assignments, setAssignments] = useState([]);
    const [feedback, setFeedback] = useState([]);
    const [pirUsers, setPirUsers] = useState([]);
    const [analytics, setAnalytics] = useState({
        totalViews: 0,
        uniqueUsers: 0,
        completions: 0,
        avgRating: 0,
        totalAssignments: 0,
        completedAssignments: 0
    });
    const [assignedPirIds, setAssignedPirIds] = useState(resource.assignedTo || []);
    
    // ========== UI STATES ==========
    const [editing, setEditing] = useState(false);
    const [formData, setFormData] = useState(resource);
    const [saving, setSaving] = useState(false);
    const [showAssignModal, setShowAssignModal] = useState(false);
    const [selectedPirs, setSelectedPirs] = useState([]);
    const [searchPir, setSearchPir] = useState('');

    // ========== LOAD DATA ON MOUNT ==========
    useEffect(() => {
        if (resource.id) {
            loadAllData();
        }
    }, [resource.id]);

    const loadAllData = async () => {
        try {
            setLoading(true);
            await Promise.all([
                loadAssignments(),
                loadFeedback(),
                loadPirUsers(),
                loadAnalytics()
            ]);
        } catch (error) {
            console.error('Error loading resource data:', error);
        } finally {
            setLoading(false);
        }
    };

    // ========== DATA LOADING FUNCTIONS ==========
    const loadAssignments = async () => {
        try {
            const assignmentsSnap = await db.collection('assignments')
                .where('resourceId', '==', resource.id)
                .get();
            
            const assignmentsList = [];
            for (const doc of assignmentsSnap.docs) {
                const assignmentData = { id: doc.id, ...doc.data() };
                
                // Load user info for each assignment
                if (assignmentData.userId) {
                    try {
                        const userDoc = await db.collection('users').doc(assignmentData.userId).get();
                        if (userDoc.exists) {
                            assignmentData.userName = `${userDoc.data().firstName} ${userDoc.data().lastName}`;
                        }
                    } catch (error) {
                        console.error('Error loading user for assignment:', error);
                    }
                }
                
                assignmentsList.push(assignmentData);
            }
            setAssignments(assignmentsList);
        } catch (error) {
            console.error('Error loading assignments:', error);
            setAssignments([]);
        }
    };

    const loadFeedback = async () => {
        try {
            const feedbackSnap = await db.collection('resourceFeedback')
                .where('resourceId', '==', resource.id)
                .orderBy('createdAt', 'desc')
                .get();
            
            const feedbackList = [];
            for (const doc of feedbackSnap.docs) {
                const feedbackData = { id: doc.id, ...doc.data() };
                
                // Load user info for each feedback
                if (feedbackData.userId) {
                    try {
                        const userDoc = await db.collection('users').doc(feedbackData.userId).get();
                        if (userDoc.exists) {
                            feedbackData.userName = `${userDoc.data().firstName} ${userDoc.data().lastName}`;
                        }
                    } catch (error) {
                        console.error('Error loading user for feedback:', error);
                    }
                }
                
                feedbackList.push(feedbackData);
            }
            setFeedback(feedbackList);
        } catch (error) {
            console.error('Error loading feedback:', error);
            setFeedback([]);
        }
    };

    const loadPirUsers = async () => {
        try {
            const usersSnap = await db.collection('users')
                .where('role', '==', 'pir')
                .where('tenantId', '==', user.tenantId)
                .get();
            
            const usersList = [];
            usersSnap.forEach(doc => {
                usersList.push({ id: doc.id, ...doc.data() });
            });
            setPirUsers(usersList);
        } catch (error) {
            console.error('Error loading PIR users:', error);
            setPirUsers([]);
        }
    };

    const loadAnalytics = async () => {
        try {
            // Load view data
            const viewsSnap = await db.collection('resourceViews')
                .where('resourceId', '==', resource.id)
                .get();
            
            const uniqueUsers = new Set();
            let totalViews = 0;
            
            viewsSnap.forEach(doc => {
                totalViews++;
                const data = doc.data();
                if (data.userId) uniqueUsers.add(data.userId);
            });

            // Calculate assignment stats
            const completedAssignments = assignments.filter(a => a.completed).length;
            
            // Calculate average rating
            const avgRating = feedback.length > 0 
                ? (feedback.reduce((sum, f) => sum + (f.rating || 0), 0) / feedback.length).toFixed(1)
                : 0;

            setAnalytics({
                totalViews,
                uniqueUsers: uniqueUsers.size,
                completions: completedAssignments,
                avgRating,
                totalAssignments: assignments.length,
                completedAssignments
            });
        } catch (error) {
            console.error('Error loading analytics:', error);
        }
    };

    // ========== CRUD OPERATIONS ==========
    const handleSave = async () => {
        if (!formData.title.trim()) {
            alert('Title is required');
            return;
        }

        if (!formData.category.trim()) {
            alert('Category is required');
            return;
        }

        try {
            setSaving(true);
            
            await db.collection('resources')
                .doc(resource.id)
                .update({
                    title: formData.title.trim(),
                    description: formData.description.trim(),
                    category: formData.category.trim(),
                    type: formData.type,
                    url: formData.url.trim(),
                    fileURL: formData.fileURL.trim(),
                    embedUrl: formData.embedUrl.trim(),
                    content: formData.content.trim(),
                    isGlobal: formData.isGlobal,
                    active: formData.active,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

            setResourceData(formData);
            setEditing(false);
            alert('Resource updated successfully! ✓');
            onUpdate();
        } catch (error) {
            console.error('Error updating resource:', error);
            alert('Failed to update resource: ' + error.message);
        } finally {
            setSaving(false);
        }
    };

    const handleDelete = async () => {
        if (!confirm('⚠️ Are you sure you want to delete this resource?\n\nThis will also delete:\n• All assignments using this resource\n• All feedback for this resource\n• All analytics data\n\nThis action cannot be undone!')) {
            return;
        }

        try {
            // Delete resource
            await db.collection('resources').doc(resource.id).delete();
            
            // Delete related assignments
            const assignmentsToDelete = await db.collection('assignments')
                .where('resourceId', '==', resource.id)
                .get();
            
            const deletePromises = [];
            assignmentsToDelete.forEach(doc => {
                deletePromises.push(doc.ref.delete());
            });

            // Delete related feedback
            const feedbackToDelete = await db.collection('resourceFeedback')
                .where('resourceId', '==', resource.id)
                .get();
            
            feedbackToDelete.forEach(doc => {
                deletePromises.push(doc.ref.delete());
            });

            await Promise.all(deletePromises);

            alert('Resource deleted successfully! 🗑️');
            onDelete(resource.id);
        } catch (error) {
            console.error('Error deleting resource:', error);
            alert('Failed to delete resource: ' + error.message);
        }
    };

    const toggleStatus = async () => {
        try {
            const newStatus = !resourceData.active;
            await db.collection('resources')
                .doc(resource.id)
                .update({
                    active: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

            setResourceData({...resourceData, active: newStatus});
            alert(`Resource ${newStatus ? 'activated' : 'deactivated'} successfully! ${newStatus ? '✓' : '⏸️'}`);
            onUpdate();
        } catch (error) {
            console.error('Error updating status:', error);
            alert('Failed to update status: ' + error.message);
        }
    };

    const handleAssignPirs = async () => {
        if (selectedPirs.length === 0) {
            alert('Please select at least one PIR');
            return;
        }

        try {
            setSaving(true);

            // Get current assignedTo array
            const currentAssigned = assignedPirIds || [];
            const newAssigned = [...new Set([...currentAssigned, ...selectedPirs])];

            // Update resource
            await db.collection('resources')
                .doc(resource.id)
                .update({
                    assignedTo: newAssigned,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

            setAssignedPirIds(newAssigned);
            setSelectedPirs([]);
            setShowAssignModal(false);
            alert(`Resource assigned to ${selectedPirs.length} PIR(s) successfully! ✓`);
            onUpdate();
        } catch (error) {
            console.error('Error assigning resource:', error);
            alert('Failed to assign resource: ' + error.message);
        } finally {
            setSaving(false);
        }
    };

    const handleUnassignPir = async (pirId) => {
        if (!confirm('Remove this PIR from the resource?')) return;

        try {
            const newAssigned = assignedPirIds.filter(id => id !== pirId);

            await db.collection('resources')
                .doc(resource.id)
                .update({
                    assignedTo: newAssigned,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

            setAssignedPirIds(newAssigned);
            alert('PIR removed successfully! ✓');
            onUpdate();
        } catch (error) {
            console.error('Error unassigning PIR:', error);
            alert('Failed to remove PIR: ' + error.message);
        }
    };

    // ========== HELPER FUNCTIONS ==========
    const formatDate = (timestamp) => {
        if (!timestamp) return 'N/A';
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric'
        });
    };

    const getResourceIcon = (type) => {
        switch (type) {
            case 'link': return '🔗';
            case 'file': return '📄';
            case 'video': return '🎥';
            case 'article': return '📰';
            default: return '📚';
        }
    };

    const getAssignedPirs = () => {
        return pirUsers.filter(pir => assignedPirIds.includes(pir.id));
    };

    const getUnassignedPirs = () => {
        return pirUsers.filter(pir => !assignedPirIds.includes(pir.id));
    };

    const getFilteredUnassignedPirs = () => {
        const unassigned = getUnassignedPirs();
        if (!searchPir.trim()) return unassigned;
        
        const query = searchPir.toLowerCase();
        return unassigned.filter(pir => 
            pir.firstName?.toLowerCase().includes(query) ||
            pir.lastName?.toLowerCase().includes(query) ||
            pir.email?.toLowerCase().includes(query)
        );
    };

    // ========== TAB RENDER FUNCTIONS ==========
    const renderOverviewTab = () => (
        <div style={{ padding: '30px' }}>
            {editing ? (
                // ========== EDIT MODE ==========
                <div>
                    <div style={{
                        background: 'white',
                        padding: '25px',
                        borderRadius: '12px',
                        marginBottom: '25px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                    }}>
                        <h4 style={{
                            margin: '0 0 20px 0',
                            color: '#333',
                            fontSize: '18px',
                            fontWeight: '600'
                        }}>
                            Edit Resource Details
                        </h4>

                        {/* Title */}
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{
                                display: 'block',
                                marginBottom: '8px',
                                color: '#333',
                                fontWeight: '600',
                                fontSize: '14px'
                            }}>
                                Title *
                            </label>
                            <input
                                type="text"
                                value={formData.title}
                                onChange={(e) => setFormData({...formData, title: e.target.value})}
                                style={{
                                    width: '100%',
                                    padding: '12px 15px',
                                    borderRadius: '8px',
                                    border: '1px solid #e0e0e0',
                                    fontSize: '14px',
                                    color: '#333',
                                    background: '#f5f7fa',
                                    transition: 'all 0.3s ease'
                                }}
                                onFocus={(e) => e.currentTarget.style.borderColor = '#0077CC'}
                                onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                            />
                        </div>

                        {/* Description */}
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{
                                display: 'block',
                                marginBottom: '8px',
                                color: '#333',
                                fontWeight: '600',
                                fontSize: '14px'
                            }}>
                                Description
                            </label>
                            <textarea
                                value={formData.description}
                                onChange={(e) => setFormData({...formData, description: e.target.value})}
                                rows="6"
                                style={{
                                    width: '100%',
                                    padding: '12px 15px',
                                    borderRadius: '8px',
                                    border: '1px solid #e0e0e0',
                                    fontSize: '14px',
                                    color: '#333',
                                    background: '#f5f7fa',
                                    resize: 'vertical',
                                    fontFamily: 'inherit',
                                    lineHeight: '1.5',
                                    transition: 'all 0.3s ease'
                                }}
                                onFocus={(e) => e.currentTarget.style.borderColor = '#0077CC'}
                                onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                            />
                        </div>

                        {/* Category */}
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{
                                display: 'block',
                                marginBottom: '8px',
                                color: '#333',
                                fontWeight: '600',
                                fontSize: '14px'
                            }}>
                                Category *
                            </label>
                            <input
                                type="text"
                                value={formData.category}
                                onChange={(e) => setFormData({...formData, category: e.target.value})}
                                style={{
                                    width: '100%',
                                    padding: '12px 15px',
                                    borderRadius: '8px',
                                    border: '1px solid #e0e0e0',
                                    fontSize: '14px',
                                    color: '#333',
                                    background: '#f5f7fa',
                                    transition: 'all 0.3s ease'
                                }}
                                onFocus={(e) => e.currentTarget.style.borderColor = '#0077CC'}
                                onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                            />
                        </div>

                        {/* Type-specific URL fields */}
                        {formData.type === 'link' && (
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{
                                    display: 'block',
                                    marginBottom: '8px',
                                    color: '#333',
                                    fontWeight: '600',
                                    fontSize: '14px'
                                }}>
                                    URL
                                </label>
                                <input
                                    type="url"
                                    value={formData.url}
                                    onChange={(e) => setFormData({...formData, url: e.target.value})}
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        borderRadius: '8px',
                                        border: '1px solid #e0e0e0',
                                        fontSize: '14px',
                                        color: '#333',
                                        background: '#f5f7fa',
                                        transition: 'all 0.3s ease'
                                    }}
                                    onFocus={(e) => e.currentTarget.style.borderColor = '#0077CC'}
                                    onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                                />
                            </div>
                        )}

                        {formData.type === 'file' && (
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{
                                    display: 'block',
                                    marginBottom: '8px',
                                    color: '#333',
                                    fontWeight: '600',
                                    fontSize: '14px'
                                }}>
                                    File URL
                                </label>
                                <input
                                    type="url"
                                    value={formData.fileURL}
                                    onChange={(e) => setFormData({...formData, fileURL: e.target.value})}
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        borderRadius: '8px',
                                        border: '1px solid #e0e0e0',
                                        fontSize: '14px',
                                        color: '#333',
                                        background: '#f5f7fa',
                                        transition: 'all 0.3s ease'
                                    }}
                                    onFocus={(e) => e.currentTarget.style.borderColor = '#0077CC'}
                                    onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                                />
                            </div>
                        )}

                        {formData.type === 'video' && (
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{
                                    display: 'block',
                                    marginBottom: '8px',
                                    color: '#333',
                                    fontWeight: '600',
                                    fontSize: '14px'
                                }}>
                                    Video Embed URL
                                </label>
                                <input
                                    type="url"
                                    value={formData.embedUrl}
                                    onChange={(e) => setFormData({...formData, embedUrl: e.target.value})}
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        borderRadius: '8px',
                                        border: '1px solid #e0e0e0',
                                        fontSize: '14px',
                                        color: '#333',
                                        background: '#f5f7fa',
                                        transition: 'all 0.3s ease'
                                    }}
                                    onFocus={(e) => e.currentTarget.style.borderColor = '#0077CC'}
                                    onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                                />
                            </div>
                        )}

                        {/* Toggles */}
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px',
                                cursor: 'pointer',
                                marginBottom: '10px'
                            }}>
                                <input
                                    type="checkbox"
                                    checked={formData.isGlobal}
                                    onChange={(e) => setFormData({...formData, isGlobal: e.target.checked})}
                                    style={{ cursor: 'pointer', width: '18px', height: '18px' }}
                                />
                                <span style={{
                                    color: '#333',
                                    fontWeight: '600',
                                    fontSize: '14px'
                                }}>
                                    🌐 Global Resource
                                </span>
                            </label>
                            <label style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px',
                                cursor: 'pointer'
                            }}>
                                <input
                                    type="checkbox"
                                    checked={formData.active}
                                    onChange={(e) => setFormData({...formData, active: e.target.checked})}
                                    style={{ cursor: 'pointer', width: '18px', height: '18px' }}
                                />
                                <span style={{
                                    color: '#333',
                                    fontWeight: '600',
                                    fontSize: '14px'
                                }}>
                                    ✓ Active
                                </span>
                            </label>
                        </div>

                        {/* Action Buttons */}
                        <div style={{
                            display: 'flex',
                            gap: '15px',
                            justifyContent: 'flex-end',
                            paddingTop: '20px',
                            borderTop: '1px solid #e0e0e0'
                        }}>
                            <button
                                onClick={() => {
                                    setEditing(false);
                                    setFormData(resourceData);
                                }}
                                style={{
                                    padding: '12px 24px',
                                    borderRadius: '8px',
                                    border: '1px solid #e0e0e0',
                                    background: '#f5f7fa',
                                    color: '#333',
                                    fontSize: '14px',
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    transition: 'all 0.3s ease'
                                }}
                                onMouseEnter={(e) => {
                                    e.currentTarget.style.background = '#ffebee';
                                    e.currentTarget.style.color = '#f44336';
                                }}
                                onMouseLeave={(e) => {
                                    e.currentTarget.style.background = '#f5f7fa';
                                    e.currentTarget.style.color = '#333';
                                }}
                            >
                                Cancel
                            </button>
                            <button
                                onClick={handleSave}
                                disabled={saving}
                                style={{
                                    padding: '12px 24px',
                                    borderRadius: '8px',
                                    border: 'none',
                                    background: saving ? '#999' : 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                    color: 'white',
                                    fontSize: '14px',
                                    fontWeight: '600',
                                    cursor: saving ? 'not-allowed' : 'pointer',
                                    transition: 'all 0.3s ease',
                                    boxShadow: saving ? 'none' : '0 4px 12px rgba(0,0,0,0.1)'
                                }}
                                onMouseEnter={(e) => {
                                    if (!saving) {
                                        e.currentTarget.style.transform = 'translateY(-2px)';
                                        e.currentTarget.style.boxShadow = '0 6px 20px rgba(0,0,0,0.15)';
                                    }
                                }}
                                onMouseLeave={(e) => {
                                    if (!saving) {
                                        e.currentTarget.style.transform = 'translateY(0)';
                                        e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                                    }
                                }}
                            >
                                {saving ? 'Saving...' : '✓ Save Changes'}
                            </button>
                        </div>
                    </div>
                </div>
            ) : (
                // ========== VIEW MODE ==========
                <div>
                    {/* Resource Header Card */}
                    <div style={{
                        background: 'white',
                        padding: '30px',
                        borderRadius: '12px',
                        marginBottom: '25px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                    }}>
                        <div style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'flex-start',
                            marginBottom: '20px'
                        }}>
                            <div style={{ fontSize: '56px' }}>
                                {getResourceIcon(resourceData.type)}
                            </div>
                            <div style={{
                                padding: '10px 20px',
                                background: resourceData.active ? 'linear-gradient(135deg, #00A86B 0%, #008554 100%)' : 'linear-gradient(135deg, #f44336 0%, #e53935 100%)',
                                color: 'white',
                                borderRadius: '8px',
                                fontSize: '14px',
                                fontWeight: '600',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                            }}>
                                {resourceData.active ? '✓ Active' : '✕ Inactive'}
                            </div>
                        </div>

                        <h2 style={{
                            margin: '0 0 15px 0',
                            color: '#333',
                            fontSize: '28px',
                            fontWeight: '600',
                            lineHeight: '1.3'
                        }}>
                            {resourceData.title}
                        </h2>

                        <p style={{
                            margin: '0 0 20px 0',
                            color: '#666',
                            fontSize: '16px',
                            lineHeight: '1.6'
                        }}>
                            {resourceData.description || 'No description provided'}
                        </p>

                        <div style={{
                            display: 'flex',
                            gap: '12px',
                            flexWrap: 'wrap'
                        }}>
                            <span style={{
                                padding: '8px 16px',
                                background: '#e3f2fd',
                                color: '#0077CC',
                                borderRadius: '8px',
                                fontSize: '14px',
                                fontWeight: '600'
                            }}>
                                📂 {resourceData.category || 'Uncategorized'}
                            </span>
                            <span style={{
                                padding: '8px 16px',
                                background: '#e1f5fe',
                                color: '#0288d1',
                                borderRadius: '8px',
                                fontSize: '14px',
                                fontWeight: '600',
                                textTransform: 'capitalize'
                            }}>
                                {getResourceIcon(resourceData.type)} {resourceData.type}
                            </span>
                            {resourceData.isGlobal && (
                                <span style={{
                                    padding: '8px 16px',
                                    background: '#fff3e0',
                                    color: '#f57c00',
                                    borderRadius: '8px',
                                    fontSize: '14px',
                                    fontWeight: '600'
                                }}>
                                    🌐 Global
                                </span>
                            )}
                            {assignedPirIds.length > 0 && (
                                <span style={{
                                    padding: '8px 16px',
                                    background: '#e8f5e9',
                                    color: '#388e3c',
                                    borderRadius: '8px',
                                    fontSize: '14px',
                                    fontWeight: '600'
                                }}>
                                    👥 {assignedPirIds.length} PIR{assignedPirIds.length !== 1 ? 's' : ''}
                                </span>
                            )}
                        </div>
                    </div>

                    {/* Analytics Cards */}
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))',
                        gap: '20px',
                        marginBottom: '25px'
                    }}>
                        <div style={{
                            background: 'white',
                            padding: '20px',
                            borderRadius: '12px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                            textAlign: 'center',
                            border: '2px solid #e0e0e0',
                            transition: 'all 0.3s ease'
                        }}>
                            <div style={{
                                fontSize: '36px',
                                fontWeight: '700',
                                color: '#0077CC',
                                marginBottom: '8px'
                            }}>
                                {analytics.totalViews}
                            </div>
                            <div style={{
                                fontSize: '14px',
                                color: '#666',
                                fontWeight: '500'
                            }}>
                                Total Views
                            </div>
                        </div>

                        <div style={{
                            background: 'white',
                            padding: '20px',
                            borderRadius: '12px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                            textAlign: 'center',
                            border: '2px solid #e0e0e0',
                            transition: 'all 0.3s ease'
                        }}>
                            <div style={{
                                fontSize: '36px',
                                fontWeight: '700',
                                color: '#388e3c',
                                marginBottom: '8px'
                            }}>
                                {analytics.uniqueUsers}
                            </div>
                            <div style={{
                                fontSize: '14px',
                                color: '#666',
                                fontWeight: '500'
                            }}>
                                Unique Users
                            </div>
                        </div>

                        <div style={{
                            background: 'white',
                            padding: '20px',
                            borderRadius: '12px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                            textAlign: 'center',
                            border: '2px solid #e0e0e0',
                            transition: 'all 0.3s ease'
                        }}>
                            <div style={{
                                fontSize: '36px',
                                fontWeight: '700',
                                color: '#f57c00',
                                marginBottom: '8px'
                            }}>
                                {analytics.totalAssignments}
                            </div>
                            <div style={{
                                fontSize: '14px',
                                color: '#666',
                                fontWeight: '500'
                            }}>
                                Total Assignments
                            </div>
                        </div>

                        <div style={{
                            background: 'white',
                            padding: '20px',
                            borderRadius: '12px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                            textAlign: 'center',
                            border: '2px solid #e0e0e0',
                            transition: 'all 0.3s ease'
                        }}>
                            <div style={{
                                fontSize: '36px',
                                fontWeight: '700',
                                color: '#0288d1',
                                marginBottom: '8px'
                            }}>
                                {analytics.avgRating > 0 ? analytics.avgRating : 'N/A'}
                            </div>
                            <div style={{
                                fontSize: '14px',
                                color: '#666',
                                fontWeight: '500'
                            }}>
                                Avg Rating
                            </div>
                        </div>
                    </div>

                  {/* Resource URL Display */}
                    {(resourceData.url || resourceData.fileURL || resourceData.embedUrl) && (
                        <div style={{
                            background: 'white',
                            padding: '20px',
                            borderRadius: '12px',
                            marginBottom: '25px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                        }}>
                            <div style={{
                                fontSize: '14px',
                                color: '#666',
                                marginBottom: '8px',
                                fontWeight: '600'
                            }}>
                                🔗 Resource URL
                            </div>
                            <a
                                href={resourceData.url || resourceData.fileURL || resourceData.embedUrl}
                                target="_blank"
                                rel="noopener noreferrer"
                                style={{
                                    color: '#0077CC',
                                    fontSize: '14px',
                                    textDecoration: 'none',
                                    wordBreak: 'break-all',
                                    fontWeight: '500'
                                }}
                            >
                                {resourceData.url || resourceData.fileURL || resourceData.embedUrl}
                            </a>
                        </div>
                    )}
                    {/* Assigned PIRs */}
                    {assignedPirIds.length > 0 && (
                        <div style={{
                            background: 'white',
                            padding: '25px',
                            borderRadius: '12px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                        }}>
                            <h4 style={{
                                margin: '0 0 15px 0',
                                fontSize: '16px',
                                fontWeight: '600',
                                color: '#333',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px'
                            }}>
                                👥 Assigned PIRs ({assignedPirIds.length})
                            </h4>
                            <div style={{
                                display: 'flex',
                                flexDirection: 'column',
                                gap: '10px'
                            }}>
                                {getAssignedPirs().map(pir => (
                                    <div
                                        key={pir.id}
                                        style={{
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            alignItems: 'center',
                                            padding: '12px 15px',
                                            background: '#f5f7fa',
                                            borderRadius: '8px',
                                            border: '1px solid #e0e0e0'
                                        }}
                                    >
                                        <div>
                                            <div style={{
                                                fontSize: '14px',
                                                fontWeight: '600',
                                                color: '#333',
                                                marginBottom: '2px'
                                            }}>
                                                {pir.firstName} {pir.lastName}
                                            </div>
                                            <div style={{
                                                fontSize: '12px',
                                                color: '#666'
                                            }}>
                                                {pir.email}
                                            </div>
                                        </div>
                                        <button
                                            onClick={() => handleUnassignPir(pir.id)}
                                            style={{
                                                padding: '6px 12px',
                                                background: '#ffebee',
                                                color: '#f44336',
                                                border: '1px solid #f44336',
                                                borderRadius: '8px',
                                                fontSize: '12px',
                                                fontWeight: '600',
                                                cursor: 'pointer',
                                                transition: 'all 0.3s ease'
                                            }}
                                            onMouseEnter={(e) => {
                                                e.currentTarget.style.background = '#f44336';
                                                e.currentTarget.style.color = 'white';
                                            }}
                                            onMouseLeave={(e) => {
                                                e.currentTarget.style.background = '#ffebee';
                                                e.currentTarget.style.color = '#f44336';
                                            }}
                                        >
                                            Remove
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            )}
        </div>
    );

    const renderAssignmentsTab = () => (
        <div style={{ padding: '30px' }}>
            <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                marginBottom: '25px'
            }}>
                <h3 style={{
                    margin: 0,
                    color: '#333',
                    fontSize: '20px',
                    fontWeight: '600'
                }}>
                    Assignments ({assignments.length})
                </h3>
            </div>

            {loading ? (
                <div style={{
                    textAlign: 'center',
                    padding: '60px 20px',
                    background: 'white',
                    borderRadius: '12px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                }}>
                    <div style={{
                        width: '40px',
                        height: '40px',
                        border: '4px solid #f5f7fa',
                        borderTop: '4px solid #0077CC',
                        borderRadius: '50%',
                        animation: 'spin 1s linear infinite',
                        margin: '0 auto 15px'
                    }}></div>
                    <div style={{
                        fontSize: '16px',
                        color: '#666'
                    }}>
                        Loading assignments...
                    </div>
                </div>
            ) : assignments.length === 0 ? (
                <div style={{
                    textAlign: 'center',
                    padding: '60px 20px',
                    background: 'white',
                    borderRadius: '12px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                }}>
                    <div style={{ fontSize: '48px', marginBottom: '15px' }}>📋</div>
                    <div style={{
                        fontSize: '18px',
                        fontWeight: '600',
                        color: '#333',
                        marginBottom: '8px'
                    }}>
                        No assignments yet
                    </div>
                    <div style={{
                        fontSize: '14px',
                        color: '#666'
                    }}>
                        This resource hasn't been assigned to any PIRs yet
                    </div>
                </div>
            ) : (
                <div style={{ display: 'flex', flexDirection: 'column', gap: '15px' }}>
                    {assignments.map(assignment => (
                        <div
                            key={assignment.id}
                            style={{
                                background: 'white',
                                padding: '20px',
                                borderRadius: '12px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                                border: '1px solid #e0e0e0',
                                transition: 'all 0.3s ease'
                            }}
                        >
                            <div style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'flex-start',
                                marginBottom: '12px'
                            }}>
                                <div style={{ flex: 1 }}>
                                    <div style={{
                                        fontSize: '16px',
                                        fontWeight: '600',
                                        color: '#333',
                                        marginBottom: '8px'
                                    }}>
                                        {assignment.title || 'Untitled Assignment'}
                                    </div>
                                    {assignment.description && (
                                        <div style={{
                                            fontSize: '14px',
                                            color: '#666',
                                            marginBottom: '12px',
                                            lineHeight: '1.5'
                                        }}>
                                            {assignment.description}
                                        </div>
                                    )}
                                    <div style={{
                                        display: 'flex',
                                        gap: '15px',
                                        flexWrap: 'wrap',
                                        fontSize: '13px',
                                        color: '#666'
                                    }}>
                                        {assignment.userName && (
                                            <span>👤 {assignment.userName}</span>
                                        )}
                                        {assignment.dueDate && (
                                            <span>📅 Due: {formatDate(assignment.dueDate)}</span>
                                        )}
                                        {assignment.createdAt && (
                                            <span>🕒 Created: {formatDate(assignment.createdAt)}</span>
                                        )}
                                    </div>
                                </div>
                                <div style={{
                                    padding: '6px 12px',
                                    background: assignment.completed ? 
                                        'linear-gradient(135deg, #00A86B 0%, #008554 100%)' : 
                                        assignment.status === 'in_progress' ?
                                        'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)' :
                                        'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                                    color: 'white',
                                    borderRadius: '8px',
                                    fontSize: '12px',
                                    fontWeight: '600',
                                    whiteSpace: 'nowrap',
                                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                                }}>
                                    {assignment.completed ? '✓ Completed' : 
                                     assignment.status === 'in_progress' ? '⏳ In Progress' : 
                                     '📌 Pending'}
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );

    const renderFeedbackTab = () => (
        <div style={{ padding: '30px' }}>
            <h3 style={{
                margin: '0 0 25px 0',
                color: '#333',
                fontSize: '20px',
                fontWeight: '600'
            }}>
                Feedback & Ratings ({feedback.length})
            </h3>

            {loading ? (
                <div style={{
                    textAlign: 'center',
                    padding: '60px 20px',
                    background: 'white',
                    borderRadius: '12px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                }}>
                    <div style={{
                        width: '40px',
                        height: '40px',
                        border: '4px solid #f5f7fa',
                        borderTop: '4px solid #0077CC',
                        borderRadius: '50%',
                        animation: 'spin 1s linear infinite',
                        margin: '0 auto 15px'
                    }}></div>
                    <div style={{
                        fontSize: '16px',
                        color: '#666'
                    }}>
                        Loading feedback...
                    </div>
                </div>
            ) : feedback.length === 0 ? (
                <div style={{
                    textAlign: 'center',
                    padding: '60px 20px',
                    background: 'white',
                    borderRadius: '12px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                }}>
                    <div style={{ fontSize: '48px', marginBottom: '15px' }}>💬</div>
                    <div style={{
                        fontSize: '18px',
                        fontWeight: '600',
                        color: '#333',
                        marginBottom: '8px'
                    }}>
                        No feedback yet
                    </div>
                    <div style={{
                        fontSize: '14px',
                        color: '#666'
                    }}>
                        PIRs haven't provided feedback on this resource yet
                    </div>
                </div>
            ) : (
                <div style={{ display: 'flex', flexDirection: 'column', gap: '15px' }}>
                    {feedback.map(item => (
                        <div
                            key={item.id}
                            style={{
                                background: 'white',
                                padding: '20px',
                                borderRadius: '12px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                                border: '1px solid #e0e0e0'
                            }}
                        >
                            <div style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                marginBottom: '12px'
                            }}>
                                <div style={{
                                    fontSize: '14px',
                                    fontWeight: '600',
                                    color: '#333'
                                }}>
                                    {item.userName || 'Anonymous PIR'}
                                </div>
                                <div style={{
                                    display: 'flex',
                                    gap: '4px'
                                }}>
                                    {[1, 2, 3, 4, 5].map(star => (
                                        <span key={star} style={{
                                            color: star <= (item.rating || 0) ? 
                                                '#f57c00' : 
                                                '#999',
                                            fontSize: '18px'
                                        }}>
                                            ★
                                        </span>
                                    ))}
                                </div>
                            </div>
                            <div style={{
                                fontSize: '14px',
                                color: '#666',
                                lineHeight: '1.6',
                                marginBottom: '12px'
                            }}>
                                {item.comment || 'No comment provided'}
                            </div>
                            <div style={{
                                fontSize: '12px',
                                color: '#999'
                            }}>
                                📅 {formatDate(item.createdAt)}
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );

    const renderActionsTab = () => (
        <div style={{ padding: '30px' }}>
            <h3 style={{
                margin: '0 0 25px 0',
                color: '#333',
                fontSize: '20px',
                fontWeight: '600'
            }}>
                Resource Actions
            </h3>

            <div style={{
                display: 'flex',
                flexDirection: 'column',
                gap: '15px',
                marginBottom: '30px'
            }}>
                {/* Edit Button */}
                <button
                    onClick={() => {
                        setEditing(true);
                        setActiveTab('overview');
                    }}
                    style={{
                        padding: '18px 24px',
                        background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '12px',
                        fontSize: '16px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '10px',
                        transition: 'all 0.3s ease',
                        boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.transform = 'translateY(-2px)';
                        e.currentTarget.style.boxShadow = '0 6px 20px rgba(0,0,0,0.15)';
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                    }}
                >
                    <span style={{ fontSize: '20px' }}>✏️</span>
                    Edit Resource Details
                </button>

                {/* Assign to PIRs Button */}
                <button
                    onClick={() => setShowAssignModal(true)}
                    style={{
                        padding: '18px 24px',
                        background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '12px',
                        fontSize: '16px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '10px',
                        transition: 'all 0.3s ease',
                        boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.transform = 'translateY(-2px)';
                        e.currentTarget.style.boxShadow = '0 6px 20px rgba(0,0,0,0.15)';
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                    }}
                >
                    <span style={{ fontSize: '20px' }}>👥</span>
                    Assign to PIRs
                </button>

                {/* Toggle Status Button */}
                <button
                    onClick={toggleStatus}
                    style={{
                        padding: '18px 24px',
                        background: resourceData.active ? 
                            'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)' : 
                            'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '12px',
                        fontSize: '16px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '10px',
                        transition: 'all 0.3s ease',
                        boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.transform = 'translateY(-2px)';
                        e.currentTarget.style.boxShadow = '0 6px 20px rgba(0,0,0,0.15)';
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                    }}
                >
                    <span style={{ fontSize: '20px' }}>
                        {resourceData.active ? '⏸️' : '▶️'}
                    </span>
                    {resourceData.active ? 'Deactivate Resource' : 'Activate Resource'}
                </button>

                {/* 🔐 ACTION PERMISSION: delete_resource - Delete resource */}
                {window.canPerformAction(user, 'delete_resource') && (
                    <button
                        onClick={handleDelete}
                        style={{
                            padding: '18px 24px',
                            background: 'linear-gradient(135deg, #f44336 0%, #e53935 100%)',
                            color: 'white',
                            border: 'none',
                            borderRadius: '12px',
                            fontSize: '16px',
                            fontWeight: '600',
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            gap: '10px',
                            transition: 'all 0.3s ease',
                            boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
                        }}
                        onMouseEnter={(e) => {
                            e.currentTarget.style.transform = 'translateY(-2px)';
                            e.currentTarget.style.boxShadow = '0 6px 20px rgba(0,0,0,0.15)';
                        }}
                        onMouseLeave={(e) => {
                            e.currentTarget.style.transform = 'translateY(0)';
                            e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                        }}
                    >
                        <span style={{ fontSize: '20px' }}>🗑️</span>
                        Delete Resource
                    </button>
                )}
            </div>

            {/* Resource Information Card */}
            <div style={{
                background: 'white',
                padding: '25px',
                borderRadius: '12px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <h4 style={{
                    margin: '0 0 20px 0',
                    fontSize: '16px',
                    fontWeight: '600',
                    color: '#333',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '10px'
                }}>
                    ℹ️ Resource Information
                </h4>
                <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                    gap: '15px',
                    fontSize: '14px'
                }}>
                    <div style={{
                        padding: '15px',
                        background: '#f5f7fa',
                        borderRadius: '8px',
                        border: '1px solid #e0e0e0'
                    }}>
                        <div style={{ 
                            color: '#666', 
                            marginBottom: '5px',
                            fontSize: '12px',
                            fontWeight: '600'
                        }}>
                            Created
                        </div>
                        <div style={{ 
                            color: '#333', 
                            fontWeight: '600'
                        }}>
                            {formatDate(resourceData.addedAt)}
                        </div>
                    </div>
                    <div style={{
                        padding: '15px',
                        background: '#f5f7fa',
                        borderRadius: '8px',
                        border: '1px solid #e0e0e0'
                    }}>
                        <div style={{ 
                            color: '#666', 
                            marginBottom: '5px',
                            fontSize: '12px',
                            fontWeight: '600'
                        }}>
                            Type
                        </div>
                        <div style={{ 
                            color: '#333', 
                            fontWeight: '600',
                            textTransform: 'capitalize'
                        }}>
                            {getResourceIcon(resourceData.type)} {resourceData.type}
                        </div>
                    </div>
                    <div style={{
                        padding: '15px',
                        background: '#f5f7fa',
                        borderRadius: '8px',
                        border: '1px solid #e0e0e0'
                    }}>
                        <div style={{ 
                            color: '#666', 
                            marginBottom: '5px',
                            fontSize: '12px',
                            fontWeight: '600'
                        }}>
                            Status
                        </div>
                        <div style={{ 
                            color: resourceData.active ? '#388e3c' : '#f44336',
                            fontWeight: '600'
                        }}>
                            {resourceData.active ? '✓ Active' : '✕ Inactive'}
                        </div>
                    </div>
                    <div style={{
                        padding: '15px',
                        background: '#f5f7fa',
                        borderRadius: '8px',
                        border: '1px solid #e0e0e0'
                    }}>
                        <div style={{ 
                            color: '#666', 
                            marginBottom: '5px',
                            fontSize: '12px',
                            fontWeight: '600'
                        }}>
                            Visibility
                        </div>
                        <div style={{ 
                            color: '#333', 
                            fontWeight: '600'
                        }}>
                            {resourceData.isGlobal ? '🌐 Global' : '👥 Assigned Only'}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );

    // ========== MAIN RENDER ==========
    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.5)',
            backdropFilter: 'blur(5px)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000,
            animation: 'fadeIn 0.3s ease-in-out',
            padding: '20px'
        }}>
            <div style={{
                maxWidth: '1100px',
                width: '100%',
                maxHeight: '90vh',
                background: 'white',
                borderRadius: '20px',
                boxShadow: '0 10px 30px rgba(0,0,0,0.2)',
                display: 'flex',
                flexDirection: 'column',
                overflow: 'hidden',
                animation: 'slideUp 0.3s ease-out'
            }}>
                {/* ========== MODAL HEADER ========== */}
                <div style={{
                    background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                    padding: '25px 30px',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    borderBottom: '1px solid rgba(255,255,255,0.1)'
                }}>
                    <h3 style={{
                        margin: 0,
                        color: 'white',
                        fontSize: '24px',
                        fontWeight: '600',
                        letterSpacing: '-0.5px'
                    }}>
                        {resourceData.title}
                    </h3>
                    <button
                        onClick={onClose}
                        style={{
                            background: 'rgba(255,255,255,0.2)',
                            border: 'none',
                            color: 'white',
                            fontSize: '28px',
                            width: '40px',
                            height: '40px',
                            borderRadius: '50%',
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            transition: 'all 0.3s ease',
                            fontWeight: '300'
                        }}
                        onMouseEnter={(e) => {
                            e.currentTarget.style.background = 'rgba(255,255,255,0.3)';
                            e.currentTarget.style.transform = 'rotate(90deg)';
                        }}
                        onMouseLeave={(e) => {
                            e.currentTarget.style.background = 'rgba(255,255,255,0.2)';
                            e.currentTarget.style.transform = 'rotate(0deg)';
                        }}
                    >
                        ×
                    </button>
                </div>

                {/* ========== TAB NAVIGATION ========== */}
                <div style={{
                    display: 'flex',
                    gap: '8px',
                    padding: '20px 25px 0 25px',
                    background: '#f5f7fa',
                    borderBottom: '2px solid #e0e0e0',
                    overflowX: 'auto',
                    position: 'sticky',
                    top: 0,
                    zIndex: 10
                }}>
                    {[
                        { id: 'overview', icon: '📊', label: 'Overview' },
                        { id: 'assignments', icon: '📝', label: 'Assignments' },
                        { id: 'feedback', icon: '💬', label: 'Feedback' },
                        { id: 'actions', icon: '⚙️', label: 'Actions' }
                    ].map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveTab(tab.id)}
                            style={{
                                padding: '12px 20px',
                                border: 'none',
                                background: activeTab === tab.id ? 
                                    'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)' : 
                                    'transparent',
                                color: activeTab === tab.id ? 
                                    'white' : 
                                    '#666',
                                borderRadius: '8px 8px 0 0',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: activeTab === tab.id ? '600' : '500',
                                transition: 'all 0.3s ease',
                                whiteSpace: 'nowrap',
                                boxShadow: activeTab === tab.id ? '0 2px 8px rgba(0,0,0,0.08)' : 'none'
                            }}
                            onMouseEnter={(e) => {
                                if (activeTab !== tab.id) {
                                    e.currentTarget.style.background = 'white';
                                    e.currentTarget.style.color = '#333';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (activeTab !== tab.id) {
                                    e.currentTarget.style.background = 'transparent';
                                    e.currentTarget.style.color = '#666';
                                }
                            }}
                        >
                            {tab.icon} {tab.label}
                        </button>
                    ))}
                </div>

                {/* ========== TAB CONTENT ========== */}
                <div style={{
                    flex: 1,
                    overflowY: 'auto',
                    background: '#f5f7fa',
                    transition: 'opacity 0.3s ease-in-out',
                    position: 'relative',
                    zIndex: 1
                }}>
                    {activeTab === 'overview' && renderOverviewTab()}
                    {activeTab === 'assignments' && renderAssignmentsTab()}
                    {activeTab === 'feedback' && renderFeedbackTab()}
                    {activeTab === 'actions' && renderActionsTab()}
                </div>
            </div>

            {/* ========== ASSIGN PIRs MODAL ========== */}
            {showAssignModal && (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0, 0, 0, 0.7)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 10001
                }}>
                    <div style={{
                        maxWidth: '600px',
                        width: '90%',
                        maxHeight: '80vh',
                        background: 'white',
                        borderRadius: '20px',
                        boxShadow: '0 10px 30px rgba(0,0,0,0.2)',
                        display: 'flex',
                        flexDirection: 'column',
                        overflow: 'hidden'
                    }}>
                        {/* Modal Header */}
                        <div style={{
                            background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                            padding: '20px 25px',
                            borderBottom: '1px solid rgba(255,255,255,0.1)'
                        }}>
                            <h4 style={{
                                margin: 0,
                                color: 'white',
                                fontSize: '20px',
                                fontWeight: '600'
                            }}>
                                Assign Resource to PIRs
                            </h4>
                        </div>

                        {/* Modal Content */}
                        <div style={{
                            flex: 1,
                            overflowY: 'auto',
                            padding: '25px',
                            background: '#f5f7fa'
                        }}>
                            {/* Search */}
                            <input
                                type="text"
                                value={searchPir}
                                onChange={(e) => setSearchPir(e.target.value)}
                                placeholder="🔍 Search PIRs by name or email..."
                                style={{
                                    width: '100%',
                                    padding: '12px 15px',
                                    borderRadius: '8px',
                                    border: '1px solid #e0e0e0',
                                    fontSize: '14px',
                                    color: '#333',
                                    background: 'white',
                                    marginBottom: '20px'
                                }}
                            />

                            {/* PIR List */}
                            <div style={{
                                display: 'flex',
                                flexDirection: 'column',
                                gap: '10px'
                            }}>
                                {getFilteredUnassignedPirs().length === 0 ? (
                                    <div style={{
                                        textAlign: 'center',
                                        padding: '40px 20px',
                                        background: 'white',
                                        borderRadius: '12px',
                                        color: '#666'
                                    }}>
                                        {getUnassignedPirs().length === 0 
                                            ? 'All PIRs are already assigned to this resource'
                                            : 'No PIRs match your search'}
                                    </div>
                                ) : (
                                    getFilteredUnassignedPirs().map(pir => (
                                        <label
                                            key={pir.id}
                                            style={{
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '12px',
                                                padding: '15px',
                                                background: selectedPirs.includes(pir.id) ? 
                                                    '#e3f2fd' : 
                                                    'white',
                                                borderRadius: '8px',
                                                cursor: 'pointer',
                                                transition: 'all 0.3s ease',
                                                border: '1px solid #e0e0e0'
                                            }}
                                            onMouseEnter={(e) => {
                                                e.currentTarget.style.borderColor = '#0077CC';
                                            }}
                                            onMouseLeave={(e) => {
                                                e.currentTarget.style.borderColor = '#e0e0e0';
                                            }}
                                        >
                                            <input
                                                type="checkbox"
                                                checked={selectedPirs.includes(pir.id)}
                                                onChange={(e) => {
                                                    if (e.target.checked) {
                                                        setSelectedPirs([...selectedPirs, pir.id]);
                                                    } else {
                                                        setSelectedPirs(selectedPirs.filter(id => id !== pir.id));
                                                    }
                                                }}
                                                style={{
                                                    cursor: 'pointer',
                                                    width: '18px',
                                                    height: '18px'
                                                }}
                                            />
                                            <div style={{ flex: 1 }}>
                                                <div style={{
                                                    fontSize: '14px',
                                                    fontWeight: '600',
                                                    color: '#333',
                                                    marginBottom: '2px'
                                                }}>
                                                    {pir.firstName} {pir.lastName}
                                                </div>
                                                <div style={{
                                                    fontSize: '12px',
                                                    color: '#666'
                                                }}>
                                                    {pir.email}
                                                </div>
                                            </div>
                                        </label>
                                    ))
                                )}
                            </div>
                        </div>

                        {/* Modal Footer */}
                        <div style={{
                            padding: '20px 25px',
                            background: 'white',
                            borderTop: '2px solid #e0e0e0',
                            display: 'flex',
                            gap: '12px',
                            justifyContent: 'flex-end'
                        }}>
                            <button
                                onClick={() => {
                                    setShowAssignModal(false);
                                    setSelectedPirs([]);
                                    setSearchPir('');
                                }}
                                disabled={saving}
                                style={{
                                    padding: '12px 20px',
                                    borderRadius: '8px',
                                    border: '1px solid #e0e0e0',
                                    background: '#f5f7fa',
                                    color: '#333',
                                    fontSize: '14px',
                                    fontWeight: '600',
                                    cursor: saving ? 'not-allowed' : 'pointer',
                                    opacity: saving ? 0.5 : 1
                                }}
                            >
                                Cancel
                            </button>
                            <button
                                onClick={handleAssignPirs}
                                disabled={saving || selectedPirs.length === 0}
                                style={{
                                    padding: '12px 20px',
                                    borderRadius: '8px',
                                    border: 'none',
                                    background: (saving || selectedPirs.length === 0) ? 
                                        '#999' : 
                                        'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                                    color: 'white',
                                    fontSize: '14px',
                                    fontWeight: '600',
                                    cursor: (saving || selectedPirs.length === 0) ? 'not-allowed' : 'pointer',
                                    boxShadow: (saving || selectedPirs.length === 0) ? 'none' : '0 4px 12px rgba(0,0,0,0.1)'
                                }}
                            >
                                {saving ? 'Assigning...' : `Assign to ${selectedPirs.length} PIR${selectedPirs.length !== 1 ? 's' : ''}`}
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}
      // COMPLETE ENHANCED CHECK-INS VIEW - ALL FEATURES WITH ANALYTICS

function ResourcesApp() {
    const [searchQuery, setSearchQuery] = useState('');
    const [user, setUser] = useState(null);
    // Notification state
    const [notifications, setNotifications] = useState([]);
    // Connection status
    const [isOnline, setIsOnline] = useState(navigator.onLine);
    // Manage sidebar collapsed state
    const [sidebarCollapsed, setSidebarCollapsed] = useState(() => {
        return window.getPreference ? window.getPreference('sidebarCollapsed', false) : false;
    });
    useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged(async (firebaseUser) => {
            if (firebaseUser) {
                const userDoc = await db.collection('users').doc(firebaseUser.uid).get();
                const userData = { uid: firebaseUser.uid, ...userDoc.data() };
                // 🔐 PAGE ACCESS CONTROL: Check if user has permission to access Resources
                if (!window.canAccessPage(userData, 'resources')) {
                    alert('You do not have permission to access Resources.');
                    window.location.href = '/admin/mypirs.html'; // Redirect to My PIRs (default fallback)
                    return;
                }

                setUser(userData);
            } else {
                window.location.href = '/admin/login';
            }
        });
        return unsubscribe;
    }, []);
    // Set up notification listener
    useEffect(() => {
        if (!user) return;
        const unsubscribe = firebase.firestore()
            .collection('notifications')
            .where('userId', '==', user.uid)
            .orderBy('timestamp', 'desc')
            .limit(50)
            .onSnapshot((snapshot) => {
                const notifs = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                setNotifications(notifs);
            }, (error) => {
                console.error('Error loading notifications:', error);
            });
        return () => unsubscribe();
    }, [user]);
    // Set up connection status listener
    useEffect(() => {
        const handleOnline = () => setIsOnline(true);
        const handleOffline = () => setIsOnline(false);
        window.addEventListener('online', handleOnline);
        window.addEventListener('offline', handleOffline);
        return () => {
            window.removeEventListener('online', handleOnline);
            window.removeEventListener('offline', handleOffline);
        };
    }, []);
    // Clear notification handlers
    const handleClearNotification = async (notificationId) => {
        try {
            await firebase.firestore().collection('notifications').doc(notificationId).delete();
        } catch (error) {
            console.error('Error clearing notification:', error);
        }
    };
    const handleClearAllNotifications = async () => {
        try {
            const batch = firebase.firestore().batch();
            notifications.forEach(notif => {
                const docRef = firebase.firestore().collection('notifications').doc(notif.id);
                batch.delete(docRef);
            });
            await batch.commit();
        } catch (error) {
            console.error('Error clearing all notifications:', error);
        }
    };
    if (!user) {
        return <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '100vh' }}><div className="loading-spinner"></div></div>;
    }
    return (
        <>
            {/* Connection Status Bar */}
            {!isOnline && (
                <div style={{
                    background: '#FFA500',
                    color: 'white',
                    padding: '10px',
                    textAlign: 'center',
                    fontWeight: '600',
                    fontSize: '14px',
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    zIndex: 9999
                }}>
                    ⚠️ Offline - Some features may be limited
                </div>
            )}
            <div style={{ display: 'flex', flexDirection: 'column', minHeight: '100vh' }}>
                {/* Header Component */}
                <Header
                    user={user}
                    searchQuery={searchQuery}
                    setSearchQuery={setSearchQuery}
                    sidebarCollapsed={sidebarCollapsed}
                    notifications={notifications}
                    onClearNotification={handleClearNotification}
                    onClearAllNotifications={handleClearAllNotifications}
                />
                {/* Sidebar Component */}
                <Sidebar user={user} collapsed={sidebarCollapsed} onCollapsedChange={setSidebarCollapsed} />
                {/* Main Content */}
                <div style={{
                    marginLeft: sidebarCollapsed ? '80px' : '280px',
                    minHeight: '100vh',
                    background: '#c4c9cf',
                    padding: '20px',
                    transition: 'margin-left 0.3s'
                }}>
                    <ResourcesView user={user} searchQuery={searchQuery} />
                </div>
            </div>
        </>
    );
}
ReactDOM.render(<ResourcesApp />, document.getElementById('root'));
})();
</script>
</body>
</html>
