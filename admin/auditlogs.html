<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Logs - GLRS Admin</title>

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📋</text></svg>">

    <!-- Shared Styles -->
    <link rel="stylesheet" href="/admin/shared/styles.css">

    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <!-- Shared Components -->
    <script src="/admin/shared/firebase.js"></script>
    <script src="/admin/shared/auth.js"></script>
    <script src="/admin/shared/permissions.js?v=1"></script>
    <script src="/admin/shared/utils.js"></script>
    <script src="/admin/shared/state.js?v=2"></script>
    <script type="text/babel" src="/admin/shared/navigation.js?v=7"></script>
    <script type="text/babel" src="/admin/shared/header.js?v=1"></script>

    <script type="text/babel">
        // Wait for Firebase to initialize before running
(function initPage() {
    if (!window.FIREBASE_READY || !window.auth || !window.db) {
        console.log('Waiting for Firebase to initialize...');
        setTimeout(initPage, 50);
        return;
    }

    const { useState, useEffect, useRef, useMemo, useCallback } = React;
    const { auth, db, storage, CURRENT_TENANT, logAudit } = window;

        // ==========================================
        // AUDIT LOGS VIEW
        // ==========================================
        function AuditLogsView({ user, searchQuery }) {
            const [logs, setLogs] = useState([]);
            const [loading, setLoading] = useState(true);
            const [filters, setFilters] = useState({
                dateRange: '7days'
            });
            const [currentPage, setCurrentPage] = useState(1);
            const itemsPerPage = 50;

            useEffect(() => {
                loadAuditLogs();
            }, [filters]);

            const loadAuditLogs = async () => {
                try {
                    setLoading(true);
                    let startDate = new Date();
                    switch(filters.dateRange) {
                        case '24hours': startDate.setHours(startDate.getHours() - 24); break;
                        case '7days': startDate.setDate(startDate.getDate() - 7); break;
                        case '30days': startDate.setDate(startDate.getDate() - 30); break;
                        default: startDate.setDate(startDate.getDate() - 7);
                    }

                    let query = db.collection('auditLogs');
                    if (!isSuperAdmin(user)) {
                        query = query.where('tenantId', '==', CURRENT_TENANT);
                    }
                    query = query.where('timestamp', '>=', startDate).orderBy('timestamp', 'desc').limit(500);

                    const snapshot = await query.get();
                    const logsData = [];
                    snapshot.forEach(doc => logsData.push({ id: doc.id, ...doc.data() }));
                    setLogs(logsData);
                } catch (error) {
                    console.error('Error loading audit logs:', error);
                } finally {
                    setLoading(false);
                }
            };

            const filteredLogs = logs.filter(log => {
                if (searchQuery) {
                    const q = searchQuery.toLowerCase();
                    return log.userEmail?.toLowerCase().includes(q) || log.userName?.toLowerCase().includes(q) || log.action?.toLowerCase().includes(q);
                }
                return true;
            });

            const totalPages = Math.ceil(filteredLogs.length / itemsPerPage);
            const paginatedLogs = filteredLogs.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

            const formatTimestamp = (ts) => {
                if (!ts) return 'N/A';
                const d = ts.toDate ? ts.toDate() : new Date(ts);
                return d.toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            };

            const getActionColor = (a) => {
                if (a?.includes('CREATE')) return '#00A86B';
                if (a?.includes('UPDATE')) return '#0077CC';
                if (a?.includes('DELETE')) return '#DC143C';
                return '#666';
            };

            return (
                <div style={{ padding: '20px', animation: 'fadeIn 0.5s' }}>
                    {/* Header */}
                    <div style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        marginBottom: '30px',
                        flexWrap: 'wrap',
                        gap: '15px'
                    }}>
                        <div>
                            <h1 style={{ margin: 0, color: '#333', fontSize: '32px' }}>
                                📋 Audit Logs
                            </h1>
                            {isSuperAdmin(user) && (
                                <p style={{ margin: '8px 0 0 0', color: '#666', fontSize: '14px' }}>
                                    Viewing logs for all tenants
                                </p>
                            )}
                        </div>
                        <button
                            onClick={loadAuditLogs}
                            style={{
                                padding: '10px 20px',
                                background: 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '500',
                                transition: 'transform 0.2s',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                            onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                        >
                            ↻ Refresh
                        </button>
                    </div>

                    {/* Filters Bar */}
                    <div style={{
                        background: 'white',
                        borderRadius: '15px',
                        padding: '20px',
                        marginBottom: '20px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '15px'
                    }}>
                        <label style={{ fontWeight: '600', color: '#333' }}>Date Range:</label>
                        <select
                            value={filters.dateRange}
                            onChange={(e) => setFilters({dateRange: e.target.value})}
                            style={{
                                padding: '10px 16px',
                                borderRadius: '8px',
                                border: '1px solid #ddd',
                                background: 'white',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '500'
                            }}
                        >
                            <option value="24hours">Last 24 Hours</option>
                            <option value="7days">Last 7 Days</option>
                            <option value="30days">Last 30 Days</option>
                        </select>
                        <div style={{
                            marginLeft: 'auto',
                            color: '#666',
                            fontSize: '14px'
                        }}>
                            {filteredLogs.length} log{filteredLogs.length !== 1 ? 's' : ''} found
                        </div>
                    </div>

                    {loading ? (
                        <div style={{
                            display: 'flex',
                            flexDirection: 'column',
                            alignItems: 'center',
                            justifyContent: 'center',
                            minHeight: '400px',
                            gap: '20px'
                        }}>
                            <div style={{
                                width: '60px',
                                height: '60px',
                                border: '4px solid #f3f3f3',
                                borderTop: '4px solid #667eea',
                                borderRadius: '50%',
                                animation: 'spin 1s linear infinite'
                            }}></div>
                            <p style={{ color: '#666' }}>Loading audit logs...</p>
                        </div>
                    ) : (
                        <>
                            {/* Logs Table */}
                            <div style={{
                                background: 'white',
                                borderRadius: '15px',
                                overflow: 'hidden',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                            }}>
                                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                    <thead>
                                        <tr style={{
                                            background: 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)',
                                            borderBottom: '2px solid #dee2e6'
                                        }}>
                                            <th style={{
                                                padding: '16px',
                                                textAlign: 'left',
                                                fontWeight: '600',
                                                color: '#495057',
                                                fontSize: '14px',
                                                textTransform: 'uppercase',
                                                letterSpacing: '0.5px'
                                            }}>
                                                Time
                                            </th>
                                            {isSuperAdmin(user) && (
                                                <th style={{
                                                    padding: '16px',
                                                    textAlign: 'left',
                                                    fontWeight: '600',
                                                    color: '#495057',
                                                    fontSize: '14px',
                                                    textTransform: 'uppercase',
                                                    letterSpacing: '0.5px'
                                                }}>
                                                    Tenant
                                                </th>
                                            )}
                                            <th style={{
                                                padding: '16px',
                                                textAlign: 'left',
                                                fontWeight: '600',
                                                color: '#495057',
                                                fontSize: '14px',
                                                textTransform: 'uppercase',
                                                letterSpacing: '0.5px'
                                            }}>
                                                User
                                            </th>
                                            <th style={{
                                                padding: '16px',
                                                textAlign: 'left',
                                                fontWeight: '600',
                                                color: '#495057',
                                                fontSize: '14px',
                                                textTransform: 'uppercase',
                                                letterSpacing: '0.5px'
                                            }}>
                                                Action
                                            </th>
                                            <th style={{
                                                padding: '16px',
                                                textAlign: 'left',
                                                fontWeight: '600',
                                                color: '#495057',
                                                fontSize: '14px',
                                                textTransform: 'uppercase',
                                                letterSpacing: '0.5px'
                                            }}>
                                                Resource
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {paginatedLogs.map((log, index) => (
                                            <tr key={log.id} style={{
                                                borderBottom: '1px solid #f0f0f0',
                                                background: index % 2 === 0 ? 'white' : '#fafafa',
                                                transition: 'background 0.2s'
                                            }}
                                            onMouseEnter={(e) => e.currentTarget.style.background = '#f8f9fa'}
                                            onMouseLeave={(e) => e.currentTarget.style.background = index % 2 === 0 ? 'white' : '#fafafa'}
                                            >
                                                <td style={{
                                                    padding: '16px',
                                                    fontSize: '13px',
                                                    color: '#495057',
                                                    fontFamily: 'monospace'
                                                }}>
                                                    {formatTimestamp(log.timestamp)}
                                                </td>
                                                {isSuperAdmin(user) && (
                                                    <td style={{
                                                        padding: '16px',
                                                        fontWeight: '600',
                                                        color: '#333'
                                                    }}>
                                                        <span style={{
                                                            background: 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)',
                                                            color: 'white',
                                                            padding: '4px 12px',
                                                            borderRadius: '20px',
                                                            fontSize: '12px',
                                                            fontWeight: '600',
                                                            textTransform: 'uppercase'
                                                        }}>
                                                            {log.tenantId}
                                                        </span>
                                                    </td>
                                                )}
                                                <td style={{ padding: '16px' }}>
                                                    <div style={{
                                                        fontWeight: '500',
                                                        color: '#333',
                                                        marginBottom: '4px'
                                                    }}>
                                                        {log.userName || log.userEmail}
                                                    </div>
                                                    <div style={{
                                                        fontSize: '12px',
                                                        color: '#999',
                                                        textTransform: 'uppercase',
                                                        letterSpacing: '0.5px'
                                                    }}>
                                                        {log.userRole}
                                                    </div>
                                                </td>
                                                <td style={{ padding: '16px' }}>
                                                    <span style={{
                                                        padding: '6px 14px',
                                                        borderRadius: '6px',
                                                        background: getActionColor(log.action) + '20',
                                                        color: getActionColor(log.action),
                                                        fontSize: '12px',
                                                        fontWeight: '600',
                                                        letterSpacing: '0.5px',
                                                        display: 'inline-block'
                                                    }}>
                                                        {log.action}
                                                    </span>
                                                </td>
                                                <td style={{
                                                    padding: '16px',
                                                    fontSize: '13px',
                                                    color: '#666'
                                                }}>
                                                    {log.targetResource || '-'}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>

                                {filteredLogs.length === 0 && (
                                    <div style={{
                                        padding: '60px 20px',
                                        textAlign: 'center',
                                        color: '#999'
                                    }}>
                                        <div style={{ fontSize: '48px', marginBottom: '15px' }}>📋</div>
                                        <div style={{ fontSize: '18px', fontWeight: '500', marginBottom: '8px' }}>
                                            No audit logs found
                                        </div>
                                        <div style={{ fontSize: '14px' }}>
                                            {searchQuery ? 'Try adjusting your search terms' : 'Audit logs will appear here when actions are performed'}
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Pagination */}
                            {totalPages > 1 && (
                                <div style={{
                                    display: 'flex',
                                    justifyContent: 'center',
                                    alignItems: 'center',
                                    gap: '15px',
                                    marginTop: '20px',
                                    padding: '20px'
                                }}>
                                    <button
                                        onClick={() => setCurrentPage(Math.max(1, currentPage - 1))}
                                        disabled={currentPage === 1}
                                        style={{
                                            padding: '10px 20px',
                                            background: currentPage === 1 ? '#f0f0f0' : 'white',
                                            color: currentPage === 1 ? '#999' : '#333',
                                            border: '1px solid #ddd',
                                            borderRadius: '8px',
                                            cursor: currentPage === 1 ? 'not-allowed' : 'pointer',
                                            fontSize: '14px',
                                            fontWeight: '500',
                                            transition: 'all 0.2s'
                                        }}
                                        onMouseEnter={(e) => {
                                            if (currentPage !== 1) {
                                                e.currentTarget.style.background = '#f8f9fa';
                                            }
                                        }}
                                        onMouseLeave={(e) => {
                                            if (currentPage !== 1) {
                                                e.currentTarget.style.background = 'white';
                                            }
                                        }}
                                    >
                                        ← Previous
                                    </button>

                                    <span style={{
                                        padding: '10px 16px',
                                        color: '#666',
                                        fontSize: '14px',
                                        fontWeight: '500'
                                    }}>
                                        Page {currentPage} of {totalPages}
                                    </span>

                                    <button
                                        onClick={() => setCurrentPage(Math.min(totalPages, currentPage + 1))}
                                        disabled={currentPage === totalPages}
                                        style={{
                                            padding: '10px 20px',
                                            background: currentPage === totalPages ? '#f0f0f0' : 'white',
                                            color: currentPage === totalPages ? '#999' : '#333',
                                            border: '1px solid #ddd',
                                            borderRadius: '8px',
                                            cursor: currentPage === totalPages ? 'not-allowed' : 'pointer',
                                            fontSize: '14px',
                                            fontWeight: '500',
                                            transition: 'all 0.2s'
                                        }}
                                        onMouseEnter={(e) => {
                                            if (currentPage !== totalPages) {
                                                e.currentTarget.style.background = '#f8f9fa';
                                            }
                                        }}
                                        onMouseLeave={(e) => {
                                            if (currentPage !== totalPages) {
                                                e.currentTarget.style.background = 'white';
                                            }
                                        }}
                                    >
                                        Next →
                                    </button>
                                </div>
                            )}
                        </>
                    )}
                </div>
            );
        }

        // ==========================================
        // ROOT APP COMPONENT
        // ==========================================
        function AuditLogsApp() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [searchQuery, setSearchQuery] = useState('');
            // Manage sidebar collapsed state
            const [sidebarCollapsed, setSidebarCollapsed] = useState(() => {
                return window.getPreference ? window.getPreference('sidebarCollapsed', false) : false;
            });
            // Notification state
            const [notifications, setNotifications] = useState([]);
            // Connection status
            const [isOnline, setIsOnline] = useState(navigator.onLine);

            useEffect(() => {
                const unsubscribe = firebase.auth().onAuthStateChanged(async (firebaseUser) => {
                    if (firebaseUser) {
                        const userDoc = await firebase.firestore()
                            .collection('users')
                            .doc(firebaseUser.uid)
                            .get();

                        if (userDoc.exists) {
                            const userData = { uid: firebaseUser.uid, ...userDoc.data() };
                            // 🔐 PAGE ACCESS CONTROL: Check if user has permission to access Audit Logs
                            if (!window.canAccessPage(userData, 'audit_logs')) {
                                alert('You do not have permission to access Audit Logs.');
                                window.location.href = '/admin/mypirs.html'; // Redirect to My PIRs (default fallback)
                                return;
                            }

                            setUser(userData);
                        } else {
                            window.location.href = '/admin/login';
                        }
                    } else {
                        window.location.href = '/admin/login';
                    }
                    setLoading(false);
                });

                return () => unsubscribe();
            }, []);

            // Set up notification listener
            useEffect(() => {
                if (!user) return;
                const unsubscribe = firebase.firestore()
                    .collection('notifications')
                    .where('userId', '==', user.uid)
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .onSnapshot((snapshot) => {
                        const notifs = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setNotifications(notifs);
                    }, (error) => {
                        console.error('Error loading notifications:', error);
                    });
                return () => unsubscribe();
            }, [user]);

            // Set up connection status listener
            useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);

            // Clear notification handlers
            const handleClearNotification = async (notificationId) => {
                try {
                    await firebase.firestore().collection('notifications').doc(notificationId).delete();
                } catch (error) {
                    console.error('Error clearing notification:', error);
                }
            };

            const handleClearAllNotifications = async () => {
                try {
                    const batch = firebase.firestore().batch();
                    notifications.forEach(notif => {
                        const docRef = firebase.firestore().collection('notifications').doc(notif.id);
                        batch.delete(docRef);
                    });
                    await batch.commit();
                } catch (error) {
                    console.error('Error clearing all notifications:', error);
                }
            };

            if (loading) {
                return (
                    <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        minHeight: '100vh',
                        background: '#f5f7fa'
                    }}>
                        <div style={{
                            width: '60px',
                            height: '60px',
                            border: '4px solid #f3f3f3',
                            borderTop: '4px solid #667eea',
                            borderRadius: '50%',
                            animation: 'spin 1s linear infinite'
                        }}></div>
                    </div>
                );
            }

            return (
                <>
                    {!isOnline && (
                        <div style={{
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            right: 0,
                            background: '#ff9800',
                            color: 'white',
                            padding: '10px',
                            textAlign: 'center',
                            zIndex: 10000,
                            fontSize: '14px',
                            fontWeight: '500'
                        }}>
                            You are currently offline. Some features may be unavailable.
                        </div>
                    )}
                    <div style={{ display: 'flex', flexDirection: 'column', minHeight: '100vh' }}>
                        {/* Header Component */}
                        <Header
                            user={user}
                            searchQuery={searchQuery}
                            setSearchQuery={setSearchQuery}
                            sidebarCollapsed={sidebarCollapsed}
                            notifications={notifications}
                            onClearNotification={handleClearNotification}
                            onClearAllNotifications={handleClearAllNotifications}
                        />
                        {/* Sidebar Component */}
                        <Sidebar user={user} collapsed={sidebarCollapsed} onCollapsedChange={setSidebarCollapsed} />
                        {/* Main Content */}
                        <div style={{
                            marginLeft: sidebarCollapsed ? '80px' : '280px',
                            minHeight: '100vh',
                            background: '#c4c9cf',
                            padding: '20px',
                            transition: 'margin-left 0.3s'
                        }}>
                            <AuditLogsView user={user} searchQuery={searchQuery} />
                        </div>
                    </div>
                </>
            );
        }

        // Render the app
        ReactDOM.render(<AuditLogsApp />, document.getElementById('root'));

})(); // End initPage
    </script>
</body>
</html>
