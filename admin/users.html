<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users Management - GLRS Admin</title>

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üë•</text></svg>">

    <!-- Shared Styles -->
    <link rel="stylesheet" href="/admin/shared/styles.css">

    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <!-- Shared Components -->
    <script src="/admin/shared/firebase.js"></script>
    <script src="/admin/shared/auth.js"></script>
    <script src="/admin/shared/utils.js"></script>
    <script src="/admin/shared/state.js"></script>
    <script src="/admin/shared/navigation.js"></script>

    <script type="text/babel">
        // Wait for Firebase to initialize before running
(function initPage() {
    if (!window.FIREBASE_READY || !window.auth || !window.db) {
        console.log('Waiting for Firebase to initialize...');
        setTimeout(initPage, 50);
        return;
    }

    const { useState, useEffect, useRef, useMemo, useCallback } = React;
    const { auth, db, storage, CURRENT_TENANT, logAudit } = window;

        // ==========================================
        // PAGINATION COMPONENT
        // ==========================================
        function Pagination({ currentPage, totalPages, onPageChange }) {
            const renderPageNumbers = () => {
                const pages = [];
                const showPages = 5;
                let startPage = Math.max(1, currentPage - Math.floor(showPages / 2));
                let endPage = Math.min(totalPages, startPage + showPages - 1);

                if (endPage - startPage < showPages - 1) {
                    startPage = Math.max(1, endPage - showPages + 1);
                }

                for (let i = startPage; i <= endPage; i++) {
                    pages.push(
                        <button
                            key={i}
                            onClick={() => onPageChange(i)}
                            style={{
                                padding: '8px 12px',
                                margin: '0 2px',
                                background: currentPage === i
                                    ? 'var(--primary-color)'
                                    : 'white',
                                color: currentPage === i ? 'white' : '#333',
                                border: currentPage === i ? 'none' : '1px solid #ddd',
                                borderRadius: '6px',
                                cursor: 'pointer',
                                fontWeight: currentPage === i ? '600' : 'normal',
                                fontSize: '14px'
                            }}
                        >
                            {i}
                        </button>
                    );
                }

                return pages;
            };

            return (
                <div style={{
                    display: 'flex',
                    justifyContent: 'center',
                    alignItems: 'center',
                    gap: '10px',
                    padding: '20px'
                }}>
                    <button
                        onClick={() => onPageChange(Math.max(1, currentPage - 1))}
                        disabled={currentPage === 1}
                        style={{
                            padding: '8px 16px',
                            background: currentPage === 1 ? '#f0f0f0' : 'white',
                            color: currentPage === 1 ? '#999' : '#333',
                            border: '1px solid #ddd',
                            borderRadius: '6px',
                            cursor: currentPage === 1 ? 'not-allowed' : 'pointer',
                            fontSize: '14px',
                            fontWeight: '500'
                        }}
                    >
                        Previous
                    </button>

                    {renderPageNumbers()}

                    <button
                        onClick={() => onPageChange(Math.min(totalPages, currentPage + 1))}
                        disabled={currentPage === totalPages}
                        style={{
                            padding: '8px 16px',
                            background: currentPage === totalPages ? '#f0f0f0' : 'white',
                            color: currentPage === totalPages ? '#999' : '#333',
                            border: '1px solid #ddd',
                            borderRadius: '6px',
                            cursor: currentPage === totalPages ? 'not-allowed' : 'pointer',
                            fontSize: '14px',
                            fontWeight: '500'
                        }}
                    >
                        Next
                    </button>
                </div>
            );
        }

        // ==========================================
        // TODO: ADD MODAL COMPONENTS
        // ==========================================
        // The following modals need to be added from admin.html:
        // 1. CreateUserModal (lines 31290-31928, ~638 lines)
        // 2. UserDetailModal (lines 32839-37711, ~4,872 lines)
        // 3. CoachDetailModal (lines 37711+, size unknown)
        //
        // For now, using placeholder stubs.
        // ==========================================

        // Temporary CreateUserModal stub
        function CreateUserModal({ onClose, onSuccess, defaultRole }) {
            return (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0, 0, 0, 0.5)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1000
                }}>
                    <div style={{
                        background: 'white',
                        borderRadius: '12px',
                        padding: '30px',
                        maxWidth: '500px'
                    }}>
                        <h2>Create User Modal</h2>
                        <p>CreateUserModal component (~638 lines) needs to be added.</p>
                        <p>Location: admin.html lines 31290-31928</p>
                        <button
                            onClick={onClose}
                            style={{
                                padding: '10px 20px',
                                background: 'var(--primary-color)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '6px',
                                cursor: 'pointer',
                                marginTop: '20px'
                            }}
                        >
                            Close
                        </button>
                    </div>
                </div>
            );
        }

        // Temporary UserDetailModal stub (same as dashboard.html)
        function UserDetailModal({ user, onClose, onUpdate, currentUserId }) {
            return (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0, 0, 0, 0.5)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1000
                }}>
                    <div style={{
                        background: 'white',
                        borderRadius: '12px',
                        padding: '30px',
                        maxWidth: '500px'
                    }}>
                        <h2>PIR Detail Modal</h2>
                        <p>UserDetailModal component (~4,872 lines) needs to be added.</p>
                        <p>Location: admin.html lines 32839-37711</p>
                        <p>PIR: {user.displayName || user.email}</p>
                        <button
                            onClick={onClose}
                            style={{
                                padding: '10px 20px',
                                background: 'var(--primary-color)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '6px',
                                cursor: 'pointer',
                                marginTop: '20px'
                            }}
                        >
                            Close
                        </button>
                    </div>
                </div>
            );
        }

        // Temporary CoachDetailModal stub
        function CoachDetailModal({ coach, onClose, onUpdate, currentUserId }) {
            return (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0, 0, 0, 0.5)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1000
                }}>
                    <div style={{
                        background: 'white',
                        borderRadius: '12px',
                        padding: '30px',
                        maxWidth: '500px'
                    }}>
                        <h2>Coach Detail Modal</h2>
                        <p>CoachDetailModal component needs to be added.</p>
                        <p>Location: admin.html lines 37711+</p>
                        <p>Coach: {coach.displayName || coach.email}</p>
                        <button
                            onClick={onClose}
                            style={{
                                padding: '10px 20px',
                                background: 'var(--primary-color)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '6px',
                                cursor: 'pointer',
                                marginTop: '20px'
                            }}
                        >
                            Close
                        </button>
                    </div>
                </div>
            );
        }

        // ==========================================
        // USERS VIEW (Lines 3987-4942 from admin.html)
        // ==========================================
        function UsersView({ searchQuery, user, onImpersonate }) {
            const [users, setUsers] = useState([]);
            const [filteredUsers, setFilteredUsers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [currentPage, setCurrentPage] = useState(1);
            const [showCreateModal, setShowCreateModal] = useState(false);
            const [selectedUser, setSelectedUser] = useState(null);
            const [activeTab, setActiveTab] = useState('pir');

            // New state for enhancements
            const [stats, setStats] = useState({
                totalPIRs: 0,
                activePIRs: 0,
                avgCompliance: 0,
                criticalAlerts: 0,
                newThisWeek: 0
            });
            const [selectedUsers, setSelectedUsers] = useState(new Set());
            const [showBulkActions, setShowBulkActions] = useState(false);
            const [statusFilter, setStatusFilter] = useState('all'); // 'all', 'active', 'inactive', 'critical'
            const [complianceFilter, setComplianceFilter] = useState('all'); // 'all', 'high', 'medium', 'low'
            const [pirHealthData, setPirHealthData] = useState({}); // Store compliance and last check-in per PIR

            const itemsPerPage = 20;

            // Separate users by role
            const pirUsers = useMemo(() => users.filter(u => u.role === 'pir'), [users]);
            const coachUsers = useMemo(() => users.filter(u => u.role === 'coach'), [users]);
            const adminUsers = useMemo(() => users.filter(u => u.role === 'admin'), [users]);

            useEffect(() => {
                loadUsers();
            }, []);

            useEffect(() => {
                if (activeTab === 'pir') {
                    loadPIRHealthData();
                    calculateStats();
                }
            }, [users, activeTab]);

            useEffect(() => {
                filterUsers();
                setCurrentPage(1);
            }, [users, searchQuery, activeTab, statusFilter, complianceFilter]);

            const loadUsers = async () => {
                try {
                    setLoading(true);

                    const usersSnap = await db.collection('users')
                        .where('tenantId', '==', CURRENT_TENANT)
                        .orderBy('createdAt', 'desc')
                        .get();

                    const usersData = [];
                    const coachIds = new Set();

                    usersSnap.forEach(doc => {
                        const userData = { id: doc.id, ...doc.data() };
                        usersData.push(userData);
                        if (userData.assignedCoach) {
                            coachIds.add(userData.assignedCoach);
                        }
                    });

                    // Batch load coaches
                    const coachesMap = {};
                    if (coachIds.size > 0) {
                        const coachResults = await batchQuery('users',
                            firebase.firestore.FieldPath.documentId(),
                            Array.from(coachIds)
                        );

                        coachResults.forEach(coach => {
                            coachesMap[coach.id] = coach.displayName || coach.email;
                        });
                    }

                    usersData.forEach(user => {
                        if (user.assignedCoach && coachesMap[user.assignedCoach]) {
                            user.coachName = coachesMap[user.assignedCoach];
                        }
                    });

                    setUsers(usersData);

                } catch (error) {
                    console.error('Error loading users:', error);
                    alert('Failed to load users. Please refresh the page.');
                } finally {
                    setLoading(false);
                }
            };

            const loadPIRHealthData = async () => {
                try {
                    const healthData = {};
                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

                    // Load check-ins for all PIRs from last 7 days
                    const checkInsSnap = await db.collection('checkIns')
                        .where('tenantId', '==', CURRENT_TENANT)
                        .where('createdAt', '>=', sevenDaysAgo)
                        .get();

                    const pirCheckIns = {};
                    checkInsSnap.forEach(doc => {
                        const data = doc.data();
                        if (!pirCheckIns[data.userId]) {
                            pirCheckIns[data.userId] = [];
                        }
                        pirCheckIns[data.userId].push(data);
                    });

                    // Calculate compliance and last check-in for each PIR
                    pirUsers.forEach(pir => {
                        const checkIns = pirCheckIns[pir.id] || [];
                        const compliance = Math.round((checkIns.length / 14) * 100); // 2 check-ins per day * 7 days

                        const lastCheckIn = checkIns.length > 0
                            ? checkIns.reduce((latest, current) => {
                                const currentDate = current.createdAt?.toDate ? current.createdAt.toDate() : new Date(current.createdAt);
                                const latestDate = latest.createdAt?.toDate ? latest.createdAt.toDate() : new Date(latest.createdAt);
                                return currentDate > latestDate ? current : latest;
                            }).createdAt
                            : null;

                        healthData[pir.id] = {
                            compliance: Math.min(compliance, 100),
                            lastCheckIn,
                            checkInCount: checkIns.length,
                            status: compliance >= 70 ? 'good' : compliance >= 40 ? 'moderate' : 'critical'
                        };
                    });

                    setPirHealthData(healthData);

                } catch (error) {
                    console.error('Error loading PIR health data:', error);
                }
            };

            const calculateStats = async () => {
                try {
                    const oneWeekAgo = new Date();
                    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

                    // Count active PIRs
                    const activePIRs = pirUsers.filter(p => p.active !== false).length;

                    // Calculate average compliance
                    const complianceValues = Object.values(pirHealthData).map(h => h.compliance || 0);
                    const avgCompliance = complianceValues.length > 0
                        ? Math.round(complianceValues.reduce((a, b) => a + b, 0) / complianceValues.length)
                        : 0;

                    // Count critical alerts
                    const alertsSnap = await db.collection('alerts')
                        .where('tenantId', '==', CURRENT_TENANT)
                        .where('resolved', '==', false)
                        .where('priority', '==', 'critical')
                        .get();

                    // Count new PIRs this week
                    const newThisWeek = pirUsers.filter(p => {
                        const createdAt = p.createdAt?.toDate ? p.createdAt.toDate() : new Date(p.createdAt);
                        return createdAt >= oneWeekAgo;
                    }).length;

                    setStats({
                        totalPIRs: pirUsers.length,
                        activePIRs,
                        avgCompliance,
                        criticalAlerts: alertsSnap.size,
                        newThisWeek
                    });

                } catch (error) {
                    console.error('Error calculating stats:', error);
                }
            };

            const filterUsers = () => {
                let tabFiltered = [];
                if (activeTab === 'pir') {
                    tabFiltered = pirUsers;
                } else if (activeTab === 'coach') {
                    tabFiltered = coachUsers;
                } else if (activeTab === 'admin') {
                    tabFiltered = adminUsers;
                }

                // Apply status filter
                if (statusFilter !== 'all') {
                    if (statusFilter === 'active') {
                        tabFiltered = tabFiltered.filter(u => u.active !== false);
                    } else if (statusFilter === 'inactive') {
                        tabFiltered = tabFiltered.filter(u => u.active === false);
                    } else if (statusFilter === 'critical') {
                        tabFiltered = tabFiltered.filter(u => pirHealthData[u.id]?.status === 'critical');
                    }
                }

                // Apply compliance filter (PIRs only)
                if (activeTab === 'pir' && complianceFilter !== 'all') {
                    if (complianceFilter === 'high') {
                        tabFiltered = tabFiltered.filter(u => (pirHealthData[u.id]?.compliance || 0) >= 70);
                    } else if (complianceFilter === 'medium') {
                        tabFiltered = tabFiltered.filter(u => {
                            const comp = pirHealthData[u.id]?.compliance || 0;
                            return comp >= 40 && comp < 70;
                        });
                    } else if (complianceFilter === 'low') {
                        tabFiltered = tabFiltered.filter(u => (pirHealthData[u.id]?.compliance || 0) < 40);
                    }
                }

                // Apply search filter
                if (searchQuery) {
                    const query = searchQuery.toLowerCase();
                    tabFiltered = tabFiltered.filter(user =>
                        user.email?.toLowerCase().includes(query) ||
                        user.displayName?.toLowerCase().includes(query) ||
                        user.firstName?.toLowerCase().includes(query) ||
                        user.lastName?.toLowerCase().includes(query) ||
                        user.phone?.toLowerCase().includes(query) ||
                        user.coachName?.toLowerCase().includes(query)
                    );
                }

                setFilteredUsers(tabFiltered);
            };

            const paginatedUsers = useMemo(() => {
                const start = (currentPage - 1) * itemsPerPage;
                const end = start + itemsPerPage;
                return filteredUsers.slice(start, end);
            }, [filteredUsers, currentPage]);

            const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);

            const handleSelectAll = () => {
                if (selectedUsers.size === paginatedUsers.length) {
                    setSelectedUsers(new Set());
                } else {
                    setSelectedUsers(new Set(paginatedUsers.map(u => u.id)));
                }
            };

            const handleSelectUser = (userId) => {
                const newSelected = new Set(selectedUsers);
                if (newSelected.has(userId)) {
                    newSelected.delete(userId);
                } else {
                    newSelected.add(userId);
                }
                setSelectedUsers(newSelected);
            };

            const handleBulkAssignCoach = async () => {
                const coachId = prompt('Enter coach ID to assign:');
                if (!coachId) return;

                try {
                    const batch = db.batch();
                    selectedUsers.forEach(userId => {
                        const userRef = db.collection('users').doc(userId);
                        batch.update(userRef, { assignedCoach: coachId });
                    });

                    await batch.commit();
                    alert(`Assigned coach to ${selectedUsers.size} users`);
                    setSelectedUsers(new Set());
                    loadUsers();
                } catch (error) {
                    console.error('Error in bulk assign:', error);
                    alert('Failed to assign coach');
                }
            };

            const handleBulkToggleStatus = async () => {
                try {
                    const batch = db.batch();
                    selectedUsers.forEach(userId => {
                        const user = users.find(u => u.id === userId);
                        const userRef = db.collection('users').doc(userId);
                        batch.update(userRef, { active: user.active === false });
                    });

                    await batch.commit();
                    alert(`Updated status for ${selectedUsers.size} users`);
                    setSelectedUsers(new Set());
                    loadUsers();
                } catch (error) {
                    console.error('Error in bulk status toggle:', error);
                    alert('Failed to update status');
                }
            };

            const handleExport = (format) => {
                const exportData = filteredUsers.map(user => ({
                    name: user.displayName || 'N/A',
                    email: user.email,
                    role: user.role,
                    status: user.active !== false ? 'Active' : 'Inactive',
                    coach: user.coachName || 'N/A',
                    compliance: activeTab === 'pir' ? `${pirHealthData[user.id]?.compliance || 0}%` : 'N/A',
                    phone: user.phone || 'N/A',
                    joined: formatDate(user.createdAt)
                }));

                if (format === 'json') {
                    exportToJSON(exportData, `${activeTab}_users`);
                } else if (format === 'csv') {
                    exportToCSV(exportData, `${activeTab}_users`);
                } else if (format === 'pdf') {
                    exportToPDF(exportData, `${activeTab.toUpperCase()} Users Report`);
                }
            };

            const getHealthBadgeColor = (status) => {
                if (status === 'good') return '#00A86B';
                if (status === 'moderate') return '#FF9800';
                return '#f44336';
            };

            if (loading) {
                return (
                    <div style={{
                        display: 'flex',
                        flexDirection: 'column',
                        alignItems: 'center',
                        justifyContent: 'center',
                        minHeight: '400px',
                        gap: '20px'
                    }}>
                        <div style={{
                            width: '60px',
                            height: '60px',
                            border: '4px solid #f3f3f3',
                            borderTop: '4px solid #0077CC',
                            borderRadius: '50%',
                            animation: 'spin 1s linear infinite'
                        }}></div>
                        <p style={{ color: '#666', fontSize: '16px' }}>Loading users...</p>
                    </div>
                );
            }

            return (
                <div style={{ animation: 'fadeIn 0.3s ease-in', padding: '20px' }}>
                    {/* Stats Cards - PIRs Only */}
                    {activeTab === 'pir' && (
                        <div style={{
                            display: 'grid',
                            gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                            gap: '20px',
                            marginBottom: '30px'
                        }}>
                           <div style={{
                                background: 'var(--gradient-primary)',
                                borderRadius: 'var(--radius-lg)',
                                padding: '25px',
                                color: 'var(--text-white)',
                                boxShadow: 'var(--shadow-primary)',
                                transition: 'var(--transition-fast)',
                                cursor: 'pointer'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                            onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                            >
                                <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '10px' }}>Total PIRs</div>
                                <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{stats.totalPIRs}</div>
                                <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '10px' }}>
                                    {stats.activePIRs} active
                                </div>
                            </div>

                            <div style={{
                                background: 'var(--gradient-warning)',
                                borderRadius: 'var(--radius-lg)',
                                padding: '25px',
                                color: 'var(--text-white)',
                                boxShadow: 'var(--shadow-md)',
                                transition: 'var(--transition-fast)',
                                cursor: 'pointer'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                            onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                            >
                                <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '10px' }}>Avg Compliance</div>
                                <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{stats.avgCompliance}%</div>
                                <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '10px' }}>
                                    Last 7 days
                                </div>
                            </div>

                            <div style={{
                                background: 'var(--gradient-info)',
                                borderRadius: 'var(--radius-lg)',
                                padding: '25px',
                                color: 'var(--text-white)',
                                boxShadow: 'var(--shadow-md)',
                                transition: 'var(--transition-fast)',
                                cursor: 'pointer'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                            onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                            >
                                <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '10px' }}>Critical Alerts</div>
                                <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{stats.criticalAlerts}</div>
                                <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '10px' }}>
                                    Require attention
                                </div>
                            </div>

                            <div style={{
                                background: 'var(--gradient-success)',
                                borderRadius: 'var(--radius-lg)',
                                padding: '25px',
                                color: 'var(--text-white)',
                                boxShadow: 'var(--shadow-success)',
                                transition: 'var(--transition-fast)',
                                cursor: 'pointer'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                            onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                            >
                                <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '10px' }}>New This Week</div>
                                <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{stats.newThisWeek}</div>
                                <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '10px' }}>
                                    Recent additions
                                </div>
                            </div>
                        </div>
                    )}

                  {/* Tab Navigation - FIXED: Using CSS Variables */}
                    <div style={{
                        display: 'flex',
                        gap: '10px',
                        marginBottom: '25px',
                        borderBottom: '2px solid var(--border-color)',
                        paddingBottom: '5px'
                    }}>
                        <button
                            onClick={() => setActiveTab('pir')}
                            style={{
                                padding: '12px 24px',
                                border: 'none',
                                background: activeTab === 'pir' ? 'var(--gradient-primary)' : 'transparent',
                                color: activeTab === 'pir' ? 'var(--text-white)' : 'var(--text-gray)',
                                borderRadius: 'var(--radius-md) var(--radius-md) 0 0',
                                cursor: 'pointer',
                                fontSize: '15px',
                                fontWeight: activeTab === 'pir' ? '600' : '500',
                                transition: 'var(--transition-normal)',
                                boxShadow: activeTab === 'pir' ? 'var(--shadow-primary)' : 'none',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                            }}
                            onMouseEnter={(e) => {
                                if (activeTab !== 'pir') {
                                    e.currentTarget.style.background = 'var(--background-secondary)';
                                    e.currentTarget.style.color = 'var(--text-primary)';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (activeTab !== 'pir') {
                                    e.currentTarget.style.background = 'transparent';
                                    e.currentTarget.style.color = 'var(--text-gray)';
                                }
                            }}
                        >
                            <span style={{ fontSize: '18px' }}>üë•</span>
                            PIRs ({pirUsers.length})
                        </button>
                        <button
                            onClick={() => setActiveTab('coach')}
                            style={{
                                padding: '12px 24px',
                                border: 'none',
                                background: activeTab === 'coach' ? 'var(--gradient-primary)' : 'transparent',
                                color: activeTab === 'coach' ? 'var(--text-white)' : 'var(--text-gray)',
                                borderRadius: 'var(--radius-md) var(--radius-md) 0 0',
                                cursor: 'pointer',
                                fontSize: '15px',
                                fontWeight: activeTab === 'coach' ? '600' : '500',
                                transition: 'var(--transition-normal)',
                                boxShadow: activeTab === 'coach' ? 'var(--shadow-primary)' : 'none',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                            }}
                            onMouseEnter={(e) => {
                                if (activeTab !== 'coach') {
                                    e.currentTarget.style.background = 'var(--background-secondary)';
                                    e.currentTarget.style.color = 'var(--text-primary)';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (activeTab !== 'coach') {
                                    e.currentTarget.style.background = 'transparent';
                                    e.currentTarget.style.color = 'var(--text-gray)';
                                }
                            }}
                        >
                            <span style={{ fontSize: '18px' }}>üéì</span>
                            Coaches ({coachUsers.length})
                        </button>
                        <button
                            onClick={() => setActiveTab('admin')}
                            style={{
                                padding: '12px 24px',
                                border: 'none',
                                background: activeTab === 'admin' ? 'var(--gradient-primary)' : 'transparent',
                                color: activeTab === 'admin' ? 'var(--text-white)' : 'var(--text-gray)',
                                borderRadius: 'var(--radius-md) var(--radius-md) 0 0',
                                cursor: 'pointer',
                                fontSize: '15px',
                                fontWeight: activeTab === 'admin' ? '600' : '500',
                                transition: 'var(--transition-normal)',
                                boxShadow: activeTab === 'admin' ? 'var(--shadow-primary)' : 'none',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                            }}
                            onMouseEnter={(e) => {
                                if (activeTab !== 'admin') {
                                    e.currentTarget.style.background = 'var(--background-secondary)';
                                    e.currentTarget.style.color = 'var(--text-primary)';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (activeTab !== 'admin') {
                                    e.currentTarget.style.background = 'transparent';
                                    e.currentTarget.style.color = 'var(--text-gray)';
                                }
                            }}
                        >
                            <span style={{ fontSize: '18px' }}>‚öôÔ∏è</span>
                            Admins ({adminUsers.length})
                        </button>
                    </div>

                    {/* Filters and Actions Bar */}
                    <div style={{
                        background: 'white',
                        borderRadius: '15px',
                        padding: '20px',
                        marginBottom: '20px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        flexWrap: 'wrap',
                        gap: '15px'
                    }}>
                        <div style={{ display: 'flex', gap: '10px', alignItems: 'center', flexWrap: 'wrap' }}>
                            {/* Status Filter */}
                            <select
                                value={statusFilter}
                                onChange={(e) => setStatusFilter(e.target.value)}
                                style={{
                                    padding: '8px 12px',
                                    borderRadius: '8px',
                                    border: '1px solid #ddd',
                                    background: 'white',
                                    cursor: 'pointer',
                                    fontSize: '14px'
                                }}
                            >
                                <option value="all">All Status</option>
                                <option value="active">Active Only</option>
                                <option value="inactive">Inactive Only</option>
                                {activeTab === 'pir' && <option value="critical">Critical Status</option>}
                            </select>

                            {/* Compliance Filter - PIRs only */}
                            {activeTab === 'pir' && (
                                <select
                                    value={complianceFilter}
                                    onChange={(e) => setComplianceFilter(e.target.value)}
                                    style={{
                                        padding: '8px 12px',
                                        borderRadius: '8px',
                                        border: '1px solid #ddd',
                                        background: 'white',
                                        cursor: 'pointer',
                                        fontSize: '14px'
                                    }}
                                >
                                    <option value="all">All Compliance</option>
                                    <option value="high">High (70%+)</option>
                                    <option value="medium">Medium (40-70%)</option>
                                    <option value="low">Low (&lt;40%)</option>
                                </select>
                            )}

                            <div style={{
                                fontSize: '14px',
                                color: '#666',
                                padding: '8px 12px',
                                background: '#f8f9fa',
                                borderRadius: '8px'
                            }}>
                                Showing {paginatedUsers.length} of {filteredUsers.length} {activeTab}s
                                {searchQuery && ' (filtered)'}
                            </div>
                        </div>

                        <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                            {/* Bulk Actions - PIRs only */}
                            {activeTab === 'pir' && selectedUsers.size > 0 && (
                                <>
                                    <button
                                        onClick={handleBulkAssignCoach}
                                        style={{
                                            padding: '10px 16px',
                                            background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '8px',
                                            cursor: 'pointer',
                                            fontSize: '14px',
                                            fontWeight: '500',
                                            transition: 'transform 0.2s',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '6px'
                                        }}
                                        onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                                        onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                                    >
                                        Assign Coach ({selectedUsers.size})
                                    </button>
                                    <button
                                        onClick={handleBulkToggleStatus}
                                        style={{
                                            padding: '10px 16px',
                                            background: 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '8px',
                                            cursor: 'pointer',
                                            fontSize: '14px',
                                            fontWeight: '500',
                                            transition: 'transform 0.2s',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '6px'
                                        }}
                                        onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                                        onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                                    >
                                        Toggle Status ({selectedUsers.size})
                                    </button>
                                </>
                            )}

                            {/* Export Buttons */}
                            <button
                                onClick={() => handleExport('csv')}
                                style={{
                                    padding: '10px 16px',
                                    background: '#6c757d',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500',
                                    transition: 'all 0.2s'
                                }}
                                onMouseEnter={(e) => {
                                    e.currentTarget.style.background = '#5a6268';
                                    e.currentTarget.style.transform = 'translateY(-2px)';
                                }}
                                onMouseLeave={(e) => {
                                    e.currentTarget.style.background = '#6c757d';
                                    e.currentTarget.style.transform = 'translateY(0)';
                                }}
                            >
                                Export CSV
                            </button>

                            <button
                                onClick={() => setShowCreateModal(true)}
                                style={{
                                    padding: '10px 20px',
                                    background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '600',
                                    transition: 'all 0.2s',
                                    boxShadow: '0 4px 12px rgba(102, 126, 234, 0.4)',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px'
                                }}
                                onMouseEnter={(e) => {
                                    e.currentTarget.style.transform = 'translateY(-2px)';
                                    e.currentTarget.style.boxShadow = '0 6px 16px rgba(102, 126, 234, 0.5)';
                                }}
                                onMouseLeave={(e) => {
                                    e.currentTarget.style.transform = 'translateY(0)';
                                    e.currentTarget.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.4)';
                                }}
                            >
                                <span style={{ fontSize: '16px' }}>+</span> Create User
                            </button>
                        </div>
                    </div>

                 {/* User Table */}
                    <div style={{
                        background: 'var(--text-white)',
                        borderRadius: 'var(--radius-lg)',
                        boxShadow: 'var(--shadow-md)',
                        overflow: 'hidden'
                    }}>
                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead>
                                <tr style={{ background: 'var(--background-secondary)', borderBottom: '2px solid var(--border-color)' }}>
                                    {activeTab === 'pir' && (
                                        <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: 'var(--text-primary)' }}>
                                            <input
                                                type="checkbox"
                                                checked={selectedUsers.size === paginatedUsers.length && paginatedUsers.length > 0}
                                                onChange={handleSelectAll}
                                                style={{ cursor: 'pointer', width: '16px', height: '16px' }}
                                            />
                                        </th>
                                    )}
                                    <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: 'var(--text-primary)' }}>Name</th>
                                    <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: 'var(--text-primary)' }}>Email</th>
                                    <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: 'var(--text-primary)' }}>Status</th>
                                    {activeTab === 'pir' && <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: 'var(--text-primary)' }}>Health</th>}
                                    {activeTab === 'pir' && <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: 'var(--text-primary)' }}>Assigned Coach</th>}
                                    {activeTab === 'pir' && <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: 'var(--text-primary)' }}>Last Check-in</th>}
                                    <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: 'var(--text-primary)' }}>Phone</th>
                                    <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: 'var(--text-primary)' }}>Joined</th>
                                    <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: 'var(--text-primary)' }}>Actions</th>
                                </tr>
                            </thead>
                           <tbody>
                                {paginatedUsers.map((user, index) => (
                                    <tr key={user.id} style={{
                                        borderBottom: '1px solid var(--border-color)',
                                        transition: 'var(--transition-fast)',
                                        background: selectedUsers.has(user.id) ? 'var(--bg-primary-light)' : 'var(--text-white)'
                                    }}
                                    onMouseEnter={(e) => {
                                        if (!selectedUsers.has(user.id)) {
                                            e.currentTarget.style.background = 'var(--background-secondary)';
                                        }
                                    }}
                                    onMouseLeave={(e) => {
                                        if (!selectedUsers.has(user.id)) {
                                            e.currentTarget.style.background = 'var(--text-white)';
                                        }
                                    }}
                                    >
                                        {activeTab === 'pir' && (
                                            <td style={{ padding: '15px' }}>
                                                <input
                                                    type="checkbox"
                                                    checked={selectedUsers.has(user.id)}
                                                    onChange={() => handleSelectUser(user.id)}
                                                    style={{ cursor: 'pointer', width: '16px', height: '16px' }}
                                                />
                                            </td>
                                        )}
                                        <td style={{ padding: '15px' }}>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                                <div style={{
                                                    width: '40px',
                                                    height: '40px',
                                                    borderRadius: '50%',
                                                    background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    color: 'white',
                                                    fontWeight: '600',
                                                    fontSize: '16px'
                                                }}>
                                                    {(user.displayName || user.email || 'U').charAt(0).toUpperCase()}
                                                </div>
                                                <span style={{ fontWeight: '500', color: '#333' }}>
                                                    {user.displayName || 'N/A'}
                                                </span>
                                            </div>
                                       </td>
                                        <td style={{ padding: '15px', color: 'var(--text-gray)' }}>{user.email}</td>
                                        <td style={{ padding: '15px' }}>
                                            <span style={{
                                                padding: '4px 12px',
                                                borderRadius: 'var(--radius-xl)',
                                                fontSize: '12px',
                                                fontWeight: '500',
                                                background: user.active !== false ? 'var(--bg-success-light)' : 'var(--bg-danger-light)',
                                                color: user.active !== false ? 'var(--success-dark)' : 'var(--danger-dark)'
                                            }}>
                                                {user.active !== false ? 'Active' : 'Inactive'}
                                            </span>
                                        </td>
                                        {activeTab === 'pir' && (
                                            <td style={{ padding: '15px' }}>
                                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                    <div style={{
                                                        width: '8px',
                                                        height: '8px',
                                                        borderRadius: '50%',
                                                        background: getHealthBadgeColor(pirHealthData[user.id]?.status)
                                                    }}></div>
                                                    <span style={{
                                                        fontSize: '13px',
                                                        fontWeight: '500',
                                                        color: 'var(--text-gray)'
                                                    }}>
                                                        {pirHealthData[user.id]?.compliance || 0}%
                                                    </span>
                                                </div>
                                            </td>
                                        )}
                                        {activeTab === 'pir' && <td style={{ padding: '15px', color: 'var(--text-gray)' }}>{user.coachName || '-'}</td>}
                                        {activeTab === 'pir' && (
                                            <td style={{ padding: '15px', color: 'var(--text-gray)' }}>
                                                {pirHealthData[user.id]?.lastCheckIn ? formatTimeAgo(pirHealthData[user.id].lastCheckIn) : 'Never'}
                                            </td>
                                        )}
                                        <td style={{ padding: '15px', color: 'var(--text-gray)' }}>{user.phone || '-'}</td>
                                        <td style={{ padding: '15px', color: 'var(--text-gray)' }}>{formatDate(user.createdAt)}</td>
                                        <td style={{ padding: '15px' }}>
                                            <div style={{ display: 'flex', gap: '8px' }}>
                                               <button
                                                    onClick={() => setSelectedUser(user)}
                                                    style={{
                                                        padding: '6px 12px',
                                                        background: 'var(--gradient-primary)',
                                                        color: 'var(--text-white)',
                                                        border: 'none',
                                                        borderRadius: 'var(--radius-sm)',
                                                        cursor: 'pointer',
                                                        fontSize: '13px',
                                                        fontWeight: '500',
                                                        transition: 'var(--transition-fast)'
                                                    }}
                                                    onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.05)'}
                                                    onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
                                                >
                                                    View
                                                </button>
                                                {user.role === 'pir' && (
                                                    <button
                                                        onClick={() => onImpersonate && onImpersonate(user)}
                                                        style={{
                                                            padding: '6px 12px',
                                                            background: 'var(--text-dark-gray)',
                                                            color: 'var(--text-white)',
                                                            border: 'none',
                                                            borderRadius: 'var(--radius-sm)',
                                                            cursor: 'pointer',
                                                            fontSize: '13px',
                                                            fontWeight: '500',
                                                            transition: 'var(--transition-fast)'
                                                        }}
                                                        onMouseEnter={(e) => {
                                                            e.currentTarget.style.background = 'var(--text-gray)';
                                                            e.currentTarget.style.transform = 'scale(1.05)';
                                                        }}
                                                        onMouseLeave={(e) => {
                                                            e.currentTarget.style.background = 'var(--text-dark-gray)';
                                                            e.currentTarget.style.transform = 'scale(1)';
                                                        }}
                                                    >
                                                        View As
                                                    </button>
                                                )}
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>

                        {filteredUsers.length === 0 && (
                            <div style={{
                                padding: '60px 20px',
                                textAlign: 'center',
                                color: 'var(--text-gray)'
                            }}>
                                <div style={{ fontSize: '48px', marginBottom: '15px' }}>üîç</div>
                                <div style={{ fontSize: '18px', fontWeight: '500', marginBottom: '8px' }}>
                                    {searchQuery ? `No ${activeTab}s found matching your search` : `No ${activeTab}s found`}
                                </div>
                                <div style={{ fontSize: '14px' }}>
                                    {searchQuery ? 'Try adjusting your search terms' : `Click "Create User" to add a new ${activeTab}`}
                                </div>
                            </div>
                        )}
                    </div>

                    {totalPages > 1 && (
                        <div style={{ marginTop: '20px' }}>
                            <Pagination
                                currentPage={currentPage}
                                totalPages={totalPages}
                                onPageChange={setCurrentPage}
                            />
                        </div>
                    )}

                    {showCreateModal && (
                        <CreateUserModal
                            onClose={() => setShowCreateModal(false)}
                            onSuccess={() => {
                                setShowCreateModal(false);
                                loadUsers();
                            }}
                        />
                    )}

                    {selectedUser && (
                        selectedUser.role === 'coach' || selectedUser.role === 'admin' ? (
                            <CoachDetailModal
                                coach={selectedUser}
                                onClose={() => setSelectedUser(null)}
                                onUpdate={() => {
                                    setSelectedUser(null);
                                    loadUsers();
                                }}
                                currentUserId={user.uid}
                            />
                        ) : (
                            <UserDetailModal
                                user={selectedUser}
                                onClose={() => setSelectedUser(null)}
                                onUpdate={() => {
                                    setSelectedUser(null);
                                    loadUsers();
                                }}
                                currentUserId={user.uid}
                            />
                        )
                    )}
                </div>
            );
        }

        // ==========================================
        // ROOT APP COMPONENT
        // ==========================================
        function UsersApp() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [searchQuery, setSearchQuery] = useState('');

            useEffect(() => {
                const unsubscribe = firebase.auth().onAuthStateChanged(async (firebaseUser) => {
                    if (firebaseUser) {
                        const userDoc = await firebase.firestore()
                            .collection('users')
                            .doc(firebaseUser.uid)
                            .get();

                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            // Check if user has admin or superadmin role
                            if (userData.role === 'admin' || userData.role === 'superadmin') {
                                setUser({ uid: firebaseUser.uid, ...userData });
                            } else {
                                alert('Access denied. Admin access required for Users Management.');
                                window.location.href = '/';
                            }
                        } else {
                            window.location.href = '/';
                        }
                    } else {
                        window.location.href = '/';
                    }
                    setLoading(false);
                });

                return () => unsubscribe();
            }, []);

            const handleImpersonate = (pirUser) => {
                alert(`Impersonation feature not yet implemented for: ${pirUser.displayName || pirUser.email}`);
            };

            if (loading) {
                return (
                    <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        minHeight: '100vh',
                        background: '#f5f7fa'
                    }}>
                        <div style={{
                            width: '60px',
                            height: '60px',
                            border: '4px solid #f3f3f3',
                            borderTop: '4px solid var(--primary-color)',
                            borderRadius: '50%',
                            animation: 'spin 1s linear infinite'
                        }}></div>
                    </div>
                );
            }

            return (
                <div style={{ display: 'flex', minHeight: '100vh', background: '#f5f7fa' }}>
                    <Sidebar user={user} />
                    <div style={{
                        flex: 1,
                        marginLeft: '280px',
                        transition: 'margin-left 0.3s'
                    }}>
                        <UsersView user={user} searchQuery={searchQuery} onImpersonate={handleImpersonate} />
                    </div>
                </div>
            );
        }

        // Render the app
        ReactDOM.render(<UsersApp />, document.getElementById('root'));

})(); // End initPage
    </script>
</body>
</html>
