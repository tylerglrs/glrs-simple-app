<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback Management - GLRS Admin</title>

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìù</text></svg>">

    <!-- Shared Styles -->
    <link rel="stylesheet" href="/admin/shared/styles.css">

    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <!-- Shared Components -->
    <script src="/admin/shared/firebase.js"></script>
    <script src="/admin/shared/auth.js"></script>
    <script src="/admin/shared/permissions.js?v=1"></script>
    <script src="/admin/shared/utils.js"></script>
    <script src="/admin/shared/state.js?v=2"></script>
    <script type="text/babel" src="/admin/shared/navigation.js?v=7"></script>
    <script type="text/babel" src="/admin/shared/header.js?v=1"></script>

    <script type="text/babel">
        // Wait for Firebase to initialize before running
(function initPage() {
    if (!window.FIREBASE_READY || !window.auth || !window.db) {
        console.log('Waiting for Firebase to initialize...');
        setTimeout(initPage, 50);
        return;
    }

    const { useState, useEffect, useRef, useMemo, useCallback } = React;
    const { auth, db, storage, CURRENT_TENANT, logAudit } = window;

        // ==========================================
        // PAGINATION COMPONENT
        // ==========================================
        function Pagination({ currentPage, totalPages, onPageChange }) {
            const renderPageNumbers = () => {
                const pages = [];
                const showPages = 5;
                let startPage = Math.max(1, currentPage - Math.floor(showPages / 2));
                let endPage = Math.min(totalPages, startPage + showPages - 1);

                if (endPage - startPage < showPages - 1) {
                    startPage = Math.max(1, endPage - showPages + 1);
                }

                for (let i = startPage; i <= endPage; i++) {
                    pages.push(
                        <button
                            key={i}
                            onClick={() => onPageChange(i)}
                            style={{
                                padding: '8px 12px',
                                margin: '0 2px',
                                background: currentPage === i
                                    ? '#0077CC'
                                    : 'white',
                                color: currentPage === i ? 'white' : '#333',
                                border: currentPage === i ? 'none' : '1px solid #ddd',
                                borderRadius: '6px',
                                cursor: 'pointer',
                                fontWeight: currentPage === i ? '600' : 'normal',
                                fontSize: '14px'
                            }}
                        >
                            {i}
                        </button>
                    );
                }

                return pages;
            };

            return (
                <div style={{
                    display: 'flex',
                    justifyContent: 'center',
                    alignItems: 'center',
                    gap: '10px',
                    padding: '20px'
                }}>
                    <button
                        onClick={() => onPageChange(Math.max(1, currentPage - 1))}
                        disabled={currentPage === 1}
                        style={{
                            padding: '8px 16px',
                            background: currentPage === 1 ? '#f0f0f0' : 'white',
                            color: currentPage === 1 ? '#999' : '#333',
                            border: '1px solid #ddd',
                            borderRadius: '6px',
                            cursor: currentPage === 1 ? 'not-allowed' : 'pointer',
                            fontSize: '14px',
                            fontWeight: '500'
                        }}
                    >
                        Previous
                    </button>

                    {renderPageNumbers()}

                    <button
                        onClick={() => onPageChange(Math.min(totalPages, currentPage + 1))}
                        disabled={currentPage === totalPages}
                        style={{
                            padding: '8px 16px',
                            background: currentPage === totalPages ? '#f0f0f0' : 'white',
                            color: currentPage === totalPages ? '#999' : '#333',
                            border: '1px solid #ddd',
                            borderRadius: '6px',
                            cursor: currentPage === totalPages ? 'not-allowed' : 'pointer',
                            fontSize: '14px',
                            fontWeight: '500'
                        }}
                    >
                        Next
                    </button>
                </div>
            );
        }

        // ==========================================
        // FEEDBACK DETAIL MODAL
        // ==========================================
        function FeedbackDetailModal({ feedback, onClose, onRespond, onMarkReviewed, getSentimentColor, renderStars }) {
            const [response, setResponse] = useState(feedback.response || '');
            const [submitting, setSubmitting] = useState(false);

            const handleSubmit = async () => {
                if (!response.trim()) {
                    alert('Please enter a response');
                    return;
                }

                setSubmitting(true);
                await onRespond(feedback.id, response);
                setSubmitting(false);
                onClose();
            };

            return (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0, 0, 0, 0.5)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1000,
                    padding: '20px',
                    animation: 'fadeIn 0.2s'
                }}>
                    <div style={{
                        background: 'white',
                        borderRadius: '20px',
                        maxWidth: '700px',
                        width: '100%',
                        maxHeight: '90vh',
                        overflow: 'auto',
                        boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
                        animation: 'slideUp 0.3s'
                    }}>
                        {/* Header */}
                        <div style={{
                            background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                            padding: '25px 30px',
                            borderRadius: '20px 20px 0 0',
                            color: 'white',
                            position: 'sticky',
                            top: 0,
                            zIndex: 1
                        }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <h2 style={{ margin: 0, fontSize: '24px' }}>Feedback Details</h2>
                                <button
                                    onClick={onClose}
                                    style={{
                                        background: 'rgba(255,255,255,0.2)',
                                        border: 'none',
                                        color: 'white',
                                        fontSize: '24px',
                                        width: '36px',
                                        height: '36px',
                                        borderRadius: '50%',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        transition: 'background 0.2s'
                                    }}
                                    onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.3)'}
                                    onMouseLeave={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.2)'}
                                >
                                    √ó
                                </button>
                            </div>
                        </div>

                        {/* Content */}
                        <div style={{ padding: '30px' }}>
                            {/* Info Grid */}
                            <div style={{
                                display: 'grid',
                                gridTemplateColumns: 'repeat(2, 1fr)',
                                gap: '20px',
                                marginBottom: '25px'
                            }}>
                                <div>
                                    <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>User</div>
                                    <div style={{ fontSize: '16px', fontWeight: '500', color: '#333' }}>
                                        {feedback.userName}
                                    </div>
                                </div>
                                <div>
                                    <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Type</div>
                                    <div style={{ fontSize: '16px', fontWeight: '500', color: '#333' }}>
                                        {feedback.type}
                                    </div>
                                </div>
                                <div>
                                    <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Rating</div>
                                    {renderStars(feedback.rating)}
                                </div>
                                <div>
                                    <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Sentiment</div>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                        <div style={{
                                            width: '12px',
                                            height: '12px',
                                            borderRadius: '50%',
                                            background: getSentimentColor(feedback.sentiment)
                                        }}></div>
                                        <span style={{ textTransform: 'capitalize' }}>{feedback.sentiment}</span>
                                    </div>
                                </div>
                                <div>
                                    <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Date</div>
                                    <div style={{ fontSize: '16px', fontWeight: '500', color: '#333' }}>
                                        {formatDate(feedback.createdAt)}
                                    </div>
                                </div>
                                <div>
                                    <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Status</div>
                                    <span style={{
                                        padding: '4px 12px',
                                        borderRadius: '20px',
                                        fontSize: '12px',
                                        fontWeight: '500',
                                        background: feedback.reviewed ? '#d4edda' : '#fff3cd',
                                        color: feedback.reviewed ? '#155724' : '#856404'
                                    }}>
                                        {feedback.reviewed ? 'Reviewed' : 'Pending'}
                                    </span>
                                </div>
                            </div>

                            {/* Subject */}
                            <div style={{ marginBottom: '20px' }}>
                                <div style={{ fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Subject
                                </div>
                                <div style={{
                                    padding: '15px',
                                    background: '#f8f9fa',
                                    borderRadius: '10px',
                                    color: '#666'
                                }}>
                                    {feedback.subject}
                                </div>
                            </div>

                            {/* Message */}
                            <div style={{ marginBottom: '25px' }}>
                                <div style={{ fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Message
                                </div>
                                <div style={{
                                    padding: '15px',
                                    background: '#f8f9fa',
                                    borderRadius: '10px',
                                    color: '#666',
                                    lineHeight: '1.6',
                                    whiteSpace: 'pre-wrap'
                                }}>
                                    {feedback.message}
                                </div>
                            </div>

                            {/* Response Section */}
                            <div style={{ marginBottom: '20px' }}>
                                <div style={{ fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    {feedback.response ? 'Your Response' : 'Add Response'}
                                </div>
                                <textarea
                                    value={response}
                                    onChange={(e) => setResponse(e.target.value)}
                                    placeholder="Type your response here..."
                                    style={{
                                        width: '100%',
                                        minHeight: '120px',
                                        padding: '15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px',
                                        fontFamily: 'inherit',
                                        resize: 'vertical',
                                        transition: 'border-color 0.2s'
                                    }}
                                    onFocus={(e) => e.currentTarget.style.borderColor = '#0077CC'}
                                    onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                                />
                            </div>

                            {/* Actions */}
                            <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                                {!feedback.reviewed && (
                                    <button
                                        onClick={() => {
                                            onMarkReviewed(feedback.id, true);
                                            onClose();
                                        }}
                                        style={{
                                            padding: '12px 24px',
                                            background: '#6c757d',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '8px',
                                            cursor: 'pointer',
                                            fontSize: '14px',
                                            fontWeight: '500',
                                            transition: 'background 0.2s'
                                        }}
                                        onMouseEnter={(e) => e.currentTarget.style.background = '#5a6268'}
                                        onMouseLeave={(e) => e.currentTarget.style.background = '#6c757d'}
                                    >
                                        Mark as Reviewed
                                    </button>
                                )}
                                <button
                                    onClick={handleSubmit}
                                    disabled={submitting || !response.trim()}
                                    style={{
                                        padding: '12px 24px',
                                        background: submitting || !response.trim()
                                            ? '#ccc'
                                            : 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '8px',
                                        cursor: submitting || !response.trim() ? 'not-allowed' : 'pointer',
                                        fontSize: '14px',
                                        fontWeight: '500',
                                        transition: 'transform 0.2s'
                                    }}
                                    onMouseEnter={(e) => {
                                        if (!submitting && response.trim()) {
                                            e.currentTarget.style.transform = 'translateY(-2px)';
                                        }
                                    }}
                                    onMouseLeave={(e) => {
                                        e.currentTarget.style.transform = 'translateY(0)';
                                    }}
                                >
                                    {submitting ? 'Sending...' : 'Send Response'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // ==========================================
        // FEEDBACK VIEW
        // ==========================================
        function FeedbackView({ searchQuery, user }) {
            const [feedbacks, setFeedbacks] = useState([]);
            const [filteredFeedbacks, setFilteredFeedbacks] = useState([]);
            const [loading, setLoading] = useState(true);
            const [currentPage, setCurrentPage] = useState(1);
            const [filterStatus, setFilterStatus] = useState('all');
            const [filterType, setFilterType] = useState('all');
            const [filterSentiment, setFilterSentiment] = useState('all');
            const [selectedFeedback, setSelectedFeedback] = useState(null);
            const [selectedFeedbacks, setSelectedFeedbacks] = useState(new Set());
            const [stats, setStats] = useState({
                total: 0,
                pending: 0,
                avgRating: 0,
                responseRate: 0
            });
            const itemsPerPage = 20;

            useEffect(() => {
                loadFeedbacks();
            }, []);

            useEffect(() => {
                filterFeedbacks();
                calculateStats();
            }, [feedbacks, filterStatus, filterType, filterSentiment, searchQuery]);

            const analyzeSentiment = (feedback) => {
                const text = (feedback.message + ' ' + feedback.subject).toLowerCase();
                const positiveWords = ['great', 'excellent', 'amazing', 'love', 'perfect', 'fantastic', 'wonderful', 'helpful', 'thank'];
                const negativeWords = ['bad', 'terrible', 'awful', 'hate', 'worst', 'horrible', 'disappointed', 'frustrated', 'angry', 'useless'];

                let score = 0;
                positiveWords.forEach(word => { if (text.includes(word)) score++; });
                negativeWords.forEach(word => { if (text.includes(word)) score--; });

                if (score > 1) return 'positive';
                if (score < -1) return 'negative';
                return 'neutral';
            };

            const loadFeedbacks = async () => {
                try {
                    const feedbacksSnap = await db.collection('feedback')
                        .orderBy('createdAt', 'desc')
                        .get();

                    const feedbacksData = [];
                    const userIds = new Set();

                    feedbacksSnap.forEach(doc => {
                        const feedback = { id: doc.id, ...doc.data() };
                        feedback.sentiment = analyzeSentiment(feedback);
                        feedbacksData.push(feedback);
                        if (feedback.userId) userIds.add(feedback.userId);
                    });

                    if (userIds.size > 0) {
                        const userResults = await batchQuery('users',
                            firebase.firestore.FieldPath.documentId(),
                            Array.from(userIds)
                        );

                        const userMap = {};
                        userResults.forEach(user => {
                            userMap[user.id] = user.displayName || user.email;
                        });

                        feedbacksData.forEach(feedback => {
                            feedback.userName = userMap[feedback.userId] || 'Anonymous';
                        });
                    }

                    setFeedbacks(feedbacksData);
                    setFilteredFeedbacks(feedbacksData);
                } catch (error) {
                    console.error('Error loading feedback:', error);
                    alert('Failed to load feedback');
                } finally {
                    setLoading(false);
                }
            };

            const calculateStats = () => {
                const total = feedbacks.length;
                const pending = feedbacks.filter(f => !f.reviewed).length;
                const ratings = feedbacks.filter(f => f.rating).map(f => f.rating);
                const avgRating = ratings.length > 0 ? (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1) : 0;
                const responded = feedbacks.filter(f => f.response).length;
                const responseRate = total > 0 ? Math.round((responded / total) * 100) : 0;

                setStats({ total, pending, avgRating, responseRate });
            };

            const filterFeedbacks = () => {
                let filtered = feedbacks;

                if (filterStatus !== 'all') {
                    filtered = filtered.filter(feedback =>
                        filterStatus === 'reviewed' ? feedback.reviewed : !feedback.reviewed
                    );
                }

                if (filterType !== 'all') {
                    filtered = filtered.filter(feedback => feedback.type === filterType);
                }

                if (filterSentiment !== 'all') {
                    filtered = filtered.filter(feedback => feedback.sentiment === filterSentiment);
                }

                if (searchQuery) {
                    const query = searchQuery.toLowerCase();
                    filtered = filtered.filter(feedback =>
                        feedback.userName?.toLowerCase().includes(query) ||
                        feedback.subject?.toLowerCase().includes(query) ||
                        feedback.message?.toLowerCase().includes(query)
                    );
                }

                setFilteredFeedbacks(filtered);
                setCurrentPage(1);
            };

            const quickFilter = (type) => {
                if (type === 'urgent') {
                    setFilterType('complaint');
                    setFilterStatus('pending');
                } else if (type === 'high-priority') {
                    setFilterSentiment('negative');
                    setFilterStatus('pending');
                } else if (type === 'needs-response') {
                    setFilterStatus('pending');
                }
            };

            const handleSelectAll = () => {
                if (selectedFeedbacks.size === paginatedFeedbacks.length) {
                    setSelectedFeedbacks(new Set());
                } else {
                    setSelectedFeedbacks(new Set(paginatedFeedbacks.map(f => f.id)));
                }
            };

            const handleSelectFeedback = (feedbackId) => {
                const newSelected = new Set(selectedFeedbacks);
                if (newSelected.has(feedbackId)) {
                    newSelected.delete(feedbackId);
                } else {
                    newSelected.add(feedbackId);
                }
                setSelectedFeedbacks(newSelected);
            };

            const handleBulkMarkReviewed = async () => {
                try {
                    const batch = db.batch();
                    selectedFeedbacks.forEach(feedbackId => {
                        const feedbackRef = db.collection('feedback').doc(feedbackId);
                        batch.update(feedbackRef, {
                            reviewed: true,
                            reviewedBy: user.uid,
                            reviewedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });

                    await batch.commit();

                    setFeedbacks(prev => prev.map(f =>
                        selectedFeedbacks.has(f.id) ? { ...f, reviewed: true } : f
                    ));
                    setSelectedFeedbacks(new Set());
                    alert(`Marked ${selectedFeedbacks.size} feedbacks as reviewed`);
                } catch (error) {
                    console.error('Error bulk updating:', error);
                    alert('Failed to update feedbacks');
                }
            };

            const handleMarkReviewed = async (feedbackId, reviewed = true) => {
                try {
                    await db.collection('feedback').doc(feedbackId).update({
                        reviewed: reviewed,
                        reviewedBy: user.uid,
                        reviewedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    setFeedbacks(prev => prev.map(f =>
                        f.id === feedbackId ? { ...f, reviewed } : f
                    ));

                    alert('Feedback marked as ' + (reviewed ? 'reviewed' : 'unreviewed'));
                } catch (error) {
                    console.error('Error updating feedback:', error);
                    alert('Failed to update feedback');
                }
            };

            const handleRespond = async (feedbackId, response) => {
                try {
                    await db.collection('feedback').doc(feedbackId).update({
                        response: response,
                        respondedBy: user.uid,
                        respondedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        reviewed: true
                    });

                    setFeedbacks(prev => prev.map(f =>
                        f.id === feedbackId ? { ...f, response, reviewed: true } : f
                    ));

                    alert('Response sent successfully');
                } catch (error) {
                    console.error('Error responding to feedback:', error);
                    alert('Failed to send response');
                }
            };

            const handleDelete = async (feedbackId) => {
                if (!confirm('Are you sure you want to delete this feedback?')) return;

                try {
                    await db.collection('feedback').doc(feedbackId).delete();
                    setFeedbacks(prev => prev.filter(f => f.id !== feedbackId));
                    alert('Feedback deleted');
                } catch (error) {
                    console.error('Error deleting feedback:', error);
                    alert('Failed to delete feedback');
                }
            };

            const renderStars = (rating) => {
                if (!rating) return '-';
                return (
                    <div style={{ display: 'flex', gap: '2px' }}>
                        {[1, 2, 3, 4, 5].map(star => (
                            <span key={star} style={{
                                color: star <= rating ? '#FFD700' : '#ddd',
                                fontSize: '16px'
                            }}>
                                ‚òÖ
                            </span>
                        ))}
                    </div>
                );
            };

            const getSentimentColor = (sentiment) => {
                if (sentiment === 'positive') return '#00A86B';
                if (sentiment === 'negative') return '#f44336';
                return '#9E9E9E';
            };

            const paginatedFeedbacks = useMemo(() => {
                const start = (currentPage - 1) * itemsPerPage;
                const end = start + itemsPerPage;
                return filteredFeedbacks.slice(start, end);
            }, [filteredFeedbacks, currentPage]);

            const totalPages = Math.ceil(filteredFeedbacks.length / itemsPerPage);

            const handleExport = (format) => {
                const exportData = filteredFeedbacks.map(feedback => ({
                    user: feedback.userName,
                    type: feedback.type,
                    subject: feedback.subject,
                    message: feedback.message,
                    rating: feedback.rating || 'N/A',
                    sentiment: feedback.sentiment,
                    status: feedback.reviewed ? 'Reviewed' : 'Pending',
                    createdAt: formatDate(feedback.createdAt),
                    response: feedback.response || 'No response yet'
                }));

                if (format === 'json') {
                    exportToJSON(exportData, 'feedback');
                } else if (format === 'csv') {
                    exportToCSV(exportData, 'feedback');
                } else if (format === 'pdf') {
                    exportToPDF(exportData, 'Feedback Report');
                }
            };

            if (loading) {
                return (
                    <div style={{
                        display: 'flex',
                        flexDirection: 'column',
                        alignItems: 'center',
                        justifyContent: 'center',
                        minHeight: '400px',
                        gap: '20px'
                    }}>
                        <div style={{
                            width: '60px',
                            height: '60px',
                            border: '4px solid #f3f3f3',
                            borderTop: '4px solid #0077CC',
                            borderRadius: '50%',
                            animation: 'spin 1s linear infinite'
                        }}></div>
                        <p style={{ color: '#666' }}>Loading feedback...</p>
                    </div>
                );
            }

            return (
                <div style={{ padding: '20px', animation: 'fadeIn 0.5s' }}>
                    {/* Stats Cards */}
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(auto-fit, minmax(240px, 1fr))',
                        gap: '20px',
                        marginBottom: '30px'
                    }}>
                        <div style={{
                            background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                            borderRadius: '15px',
                            padding: '25px',
                            color: 'white',
                            boxShadow: '0 4px 15px rgba(102, 126, 234, 0.3)',
                            transition: 'transform 0.2s'
                        }}
                        onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                        onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                        >
                            <div style={{ fontSize: '14px', opacity: 0.9 }}>Total Feedback</div>
                            <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                                {stats.total}
                            </div>
                            <div style={{ fontSize: '12px', opacity: 0.8 }}>All time</div>
                        </div>

                        <div style={{
                            background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                            borderRadius: '15px',
                            padding: '25px',
                            color: 'white',
                            boxShadow: '0 4px 15px rgba(240, 147, 251, 0.3)',
                            transition: 'transform 0.2s'
                        }}
                        onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                        onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                        >
                            <div style={{ fontSize: '14px', opacity: 0.9 }}>Pending Reviews</div>
                            <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                                {stats.pending}
                            </div>
                            <div style={{ fontSize: '12px', opacity: 0.8 }}>Awaiting action</div>
                        </div>

                        <div style={{
                            background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                            borderRadius: '15px',
                            padding: '25px',
                            color: 'white',
                            boxShadow: '0 4px 15px rgba(79, 172, 254, 0.3)',
                            transition: 'transform 0.2s'
                        }}
                        onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                        onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                        >
                            <div style={{ fontSize: '14px', opacity: 0.9 }}>Average Rating</div>
                            <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                                {stats.avgRating}/5
                            </div>
                            <div style={{ fontSize: '12px', opacity: 0.8 }}>From rated feedback</div>
                        </div>

                        <div style={{
                            background: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                            borderRadius: '15px',
                            padding: '25px',
                            color: 'white',
                            boxShadow: '0 4px 15px rgba(250, 112, 154, 0.3)',
                            transition: 'transform 0.2s'
                        }}
                        onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                        onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                        >
                            <div style={{ fontSize: '14px', opacity: 0.9 }}>Response Rate</div>
                            <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                                {stats.responseRate}%
                            </div>
                            <div style={{ fontSize: '12px', opacity: 0.8 }}>Responded to</div>
                        </div>
                    </div>

                    {/* Quick Filters */}
                    <div style={{
                        background: 'white',
                        borderRadius: '15px',
                        padding: '15px 20px',
                        marginBottom: '20px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                        display: 'flex',
                        gap: '10px',
                        flexWrap: 'wrap',
                        alignItems: 'center'
                    }}>
                        <span style={{ fontWeight: '600', color: '#333', marginRight: '10px' }}>Quick Filters:</span>
                        <button
                            onClick={() => quickFilter('urgent')}
                            style={{
                                padding: '8px 16px',
                                background: 'linear-gradient(135deg, #f44336 0%, #e53935 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '13px',
                                fontWeight: '500',
                                transition: 'transform 0.2s'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                            onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                        >
                            Urgent Complaints
                        </button>
                        <button
                            onClick={() => quickFilter('high-priority')}
                            style={{
                                padding: '8px 16px',
                                background: 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '13px',
                                fontWeight: '500',
                                transition: 'transform 0.2s'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                            onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                        >
                            High Priority
                        </button>
                        <button
                            onClick={() => quickFilter('needs-response')}
                            style={{
                                padding: '8px 16px',
                                background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '13px',
                                fontWeight: '500',
                                transition: 'transform 0.2s'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                            onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                        >
                            Needs Response
                        </button>
                    </div>

                    {/* Filters and Actions Bar */}
                    <div style={{
                        background: 'white',
                        borderRadius: '15px',
                        padding: '20px',
                        marginBottom: '20px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                    }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', flexWrap: 'wrap', gap: '15px' }}>
                            <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                                <select
                                    value={filterStatus}
                                    onChange={(e) => setFilterStatus(e.target.value)}
                                    style={{
                                        padding: '8px 12px',
                                        borderRadius: '8px',
                                        border: '1px solid #ddd',
                                        background: 'white',
                                        cursor: 'pointer',
                                        fontSize: '14px'
                                    }}
                                >
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending Review</option>
                                    <option value="reviewed">Reviewed</option>
                                </select>

                                <select
                                    value={filterType}
                                    onChange={(e) => setFilterType(e.target.value)}
                                    style={{
                                        padding: '8px 12px',
                                        borderRadius: '8px',
                                        border: '1px solid #ddd',
                                        background: 'white',
                                        cursor: 'pointer',
                                        fontSize: '14px'
                                    }}
                                >
                                    <option value="all">All Types</option>
                                    <option value="bug">Bug Report</option>
                                    <option value="feature">Feature Request</option>
                                    <option value="general">General Feedback</option>
                                    <option value="complaint">Complaint</option>
                                    <option value="praise">Praise</option>
                                </select>

                                <select
                                    value={filterSentiment}
                                    onChange={(e) => setFilterSentiment(e.target.value)}
                                    style={{
                                        padding: '8px 12px',
                                        borderRadius: '8px',
                                        border: '1px solid #ddd',
                                        background: 'white',
                                        cursor: 'pointer',
                                        fontSize: '14px'
                                    }}
                                >
                                    <option value="all">All Sentiments</option>
                                    <option value="positive">Positive</option>
                                    <option value="neutral">Neutral</option>
                                    <option value="negative">Negative</option>
                                </select>
                            </div>

                            <div style={{ display: 'flex', gap: '10px' }}>
                                {selectedFeedbacks.size > 0 && (
                                    <button
                                        onClick={handleBulkMarkReviewed}
                                        style={{
                                            padding: '10px 16px',
                                            background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '8px',
                                            cursor: 'pointer',
                                            fontSize: '14px',
                                            fontWeight: '500'
                                        }}
                                    >
                                        Mark {selectedFeedbacks.size} as Reviewed
                                    </button>
                                )}
                                <button
                                    onClick={() => handleExport('csv')}
                                    style={{
                                        padding: '10px 16px',
                                        background: '#6c757d',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '8px',
                                        cursor: 'pointer',
                                        fontSize: '14px',
                                        fontWeight: '500'
                                    }}
                                >
                                    Export CSV
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Enhanced Table */}
                    <div style={{
                        background: 'white',
                        borderRadius: '15px',
                        overflow: 'hidden',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                    }}>
                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead>
                                <tr style={{ background: '#f8f9fa', borderBottom: '2px solid #e9ecef' }}>
                                    <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>
                                        <input
                                            type="checkbox"
                                            checked={selectedFeedbacks.size === paginatedFeedbacks.length && paginatedFeedbacks.length > 0}
                                            onChange={handleSelectAll}
                                            style={{ cursor: 'pointer', width: '16px', height: '16px' }}
                                        />
                                    </th>
                                    <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>User</th>
                                    <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Type</th>
                                    <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Subject</th>
                                    <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Rating</th>
                                    <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Sentiment</th>
                                    <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Status</th>
                                    <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Date</th>
                                    <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {paginatedFeedbacks.map(feedback => (
                                    <tr key={feedback.id} style={{
                                        borderBottom: '1px solid #f0f0f0',
                                        transition: 'all 0.2s',
                                        background: selectedFeedbacks.has(feedback.id) ? '#f0f4ff' : 'white'
                                    }}
                                    onMouseEnter={(e) => {
                                        if (!selectedFeedbacks.has(feedback.id)) {
                                            e.currentTarget.style.background = '#f8f9fa';
                                        }
                                    }}
                                    onMouseLeave={(e) => {
                                        if (!selectedFeedbacks.has(feedback.id)) {
                                            e.currentTarget.style.background = 'white';
                                        }
                                    }}
                                    >
                                        <td style={{ padding: '15px' }}>
                                            <input
                                                type="checkbox"
                                                checked={selectedFeedbacks.has(feedback.id)}
                                                onChange={() => handleSelectFeedback(feedback.id)}
                                                style={{ cursor: 'pointer', width: '16px', height: '16px' }}
                                            />
                                        </td>
                                        <td style={{ padding: '15px', fontWeight: '500', color: '#333' }}>
                                            {feedback.userName}
                                        </td>
                                        <td style={{ padding: '15px' }}>
                                            <span style={{
                                                padding: '4px 12px',
                                                borderRadius: '20px',
                                                fontSize: '12px',
                                                fontWeight: '500',
                                                background: '#e3f2fd',
                                                color: '#1976d2'
                                            }}>
                                                {feedback.type}
                                            </span>
                                        </td>
                                        <td style={{ padding: '15px', color: '#666', maxWidth: '200px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                            {feedback.subject}
                                        </td>
                                        <td style={{ padding: '15px' }}>{renderStars(feedback.rating)}</td>
                                        <td style={{ padding: '15px' }}>
                                            <div style={{
                                                width: '10px',
                                                height: '10px',
                                                borderRadius: '50%',
                                                background: getSentimentColor(feedback.sentiment),
                                                display: 'inline-block'
                                            }}></div>
                                        </td>
                                        <td style={{ padding: '15px' }}>
                                            <span style={{
                                                padding: '4px 12px',
                                                borderRadius: '20px',
                                                fontSize: '12px',
                                                fontWeight: '500',
                                                background: feedback.reviewed ? '#d4edda' : '#fff3cd',
                                                color: feedback.reviewed ? '#155724' : '#856404'
                                            }}>
                                                {feedback.reviewed ? 'Reviewed' : 'Pending'}
                                            </span>
                                        </td>
                                        <td style={{ padding: '15px', color: '#666' }}>{formatDate(feedback.createdAt)}</td>
                                        <td style={{ padding: '15px' }}>
                                            <button
                                                onClick={() => setSelectedFeedback(feedback)}
                                                style={{
                                                    padding: '6px 12px',
                                                    background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                                    color: 'white',
                                                    border: 'none',
                                                    borderRadius: '6px',
                                                    cursor: 'pointer',
                                                    fontSize: '13px',
                                                    fontWeight: '500'
                                                }}
                                            >
                                                View
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>

                        {filteredFeedbacks.length === 0 && (
                            <div style={{
                                padding: '60px 20px',
                                textAlign: 'center',
                                color: '#999'
                            }}>
                                <div style={{ fontSize: '48px', marginBottom: '15px' }}>üìù</div>
                                <div style={{ fontSize: '18px', fontWeight: '500', marginBottom: '8px' }}>
                                    No feedback found
                                </div>
                                <div style={{ fontSize: '14px' }}>
                                    {searchQuery ? 'Try adjusting your search terms' : 'Feedback will appear here when submitted'}
                                </div>
                            </div>
                        )}
                    </div>

                    {totalPages > 1 && (
                        <div style={{ marginTop: '20px' }}>
                            <Pagination
                                currentPage={currentPage}
                                totalPages={totalPages}
                                onPageChange={setCurrentPage}
                            />
                        </div>
                    )}

                    {selectedFeedback && (
                        <FeedbackDetailModal
                            feedback={selectedFeedback}
                            onClose={() => setSelectedFeedback(null)}
                            onRespond={handleRespond}
                            onMarkReviewed={handleMarkReviewed}
                            getSentimentColor={getSentimentColor}
                            renderStars={renderStars}
                        />
                    )}
                </div>
            );
        }

        // ==========================================
        // ROOT APP COMPONENT
        // ==========================================
        function FeedbackApp() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [searchQuery, setSearchQuery] = useState('');
            // Manage sidebar collapsed state
            const [sidebarCollapsed, setSidebarCollapsed] = useState(() => {
                return window.getPreference ? window.getPreference('sidebarCollapsed', false) : false;
            });
            // Notification state
            const [notifications, setNotifications] = useState([]);
            // Connection status
            const [isOnline, setIsOnline] = useState(navigator.onLine);

            useEffect(() => {
                const unsubscribe = firebase.auth().onAuthStateChanged(async (firebaseUser) => {
                    if (firebaseUser) {
                        const userDoc = await firebase.firestore()
                            .collection('users')
                            .doc(firebaseUser.uid)
                            .get();

                        if (userDoc.exists) {
                            const userData = { uid: firebaseUser.uid, ...userDoc.data() };
                            // üîê PAGE ACCESS CONTROL: Check if user has permission to access Feedback
                            if (!window.canAccessPage(userData, 'feedback')) {
                                alert('You do not have permission to access Feedback.');
                                window.location.href = '/admin/mypirs.html'; // Redirect to My PIRs (default fallback)
                                return;
                            }

                            setUser(userData);
                        } else {
                            window.location.href = '/admin/login';
                        }
                    } else {
                        window.location.href = '/admin/login';
                    }
                    setLoading(false);
                });

                return () => unsubscribe();
            }, []);

            // Set up notification listener
            useEffect(() => {
                if (!user) return;
                const unsubscribe = firebase.firestore()
                    .collection('notifications')
                    .where('userId', '==', user.uid)
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .onSnapshot((snapshot) => {
                        const notifs = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setNotifications(notifs);
                    }, (error) => {
                        console.error('Error loading notifications:', error);
                    });
                return () => unsubscribe();
            }, [user]);

            // Set up connection status listener
            useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);

            // Clear notification handlers
            const handleClearNotification = async (notificationId) => {
                try {
                    await firebase.firestore().collection('notifications').doc(notificationId).delete();
                } catch (error) {
                    console.error('Error clearing notification:', error);
                }
            };

            const handleClearAllNotifications = async () => {
                try {
                    const batch = firebase.firestore().batch();
                    notifications.forEach(notif => {
                        const docRef = firebase.firestore().collection('notifications').doc(notif.id);
                        batch.delete(docRef);
                    });
                    await batch.commit();
                } catch (error) {
                    console.error('Error clearing all notifications:', error);
                }
            };

            if (loading) {
                return (
                    <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        minHeight: '100vh',
                        background: '#f5f7fa'
                    }}>
                        <div style={{
                            width: '60px',
                            height: '60px',
                            border: '4px solid #f3f3f3',
                            borderTop: '4px solid #0077CC',
                            borderRadius: '50%',
                            animation: 'spin 1s linear infinite'
                        }}></div>
                    </div>
                );
            }

            return (
                <>
                    {!isOnline && (
                        <div style={{
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            right: 0,
                            background: '#ff9800',
                            color: 'white',
                            padding: '10px',
                            textAlign: 'center',
                            zIndex: 10000,
                            fontSize: '14px',
                            fontWeight: '500'
                        }}>
                            You are currently offline. Some features may be unavailable.
                        </div>
                    )}
                    <div style={{ display: 'flex', flexDirection: 'column', minHeight: '100vh' }}>
                        {/* Header Component */}
                        <Header
                            user={user}
                            searchQuery={searchQuery}
                            setSearchQuery={setSearchQuery}
                            sidebarCollapsed={sidebarCollapsed}
                            notifications={notifications}
                            onClearNotification={handleClearNotification}
                            onClearAllNotifications={handleClearAllNotifications}
                        />
                        {/* Sidebar Component */}
                        <Sidebar user={user} collapsed={sidebarCollapsed} onCollapsedChange={setSidebarCollapsed} />
                        {/* Main Content */}
                        <div style={{
                            marginLeft: sidebarCollapsed ? '80px' : '280px',
                            minHeight: '100vh',
                            background: '#c4c9cf',
                            padding: '20px',
                            transition: 'margin-left 0.3s'
                        }}>
                            <FeedbackView user={user} searchQuery={searchQuery} />
                        </div>
                    </div>
                </>
            );
        }

        // Render the app
        ReactDOM.render(<FeedbackApp />, document.getElementById('root'));

})(); // End initPage
    </script>
</body>
</html>
