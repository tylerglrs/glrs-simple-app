<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community - GLRS Admin</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>💬</text></svg>">
    <link rel="stylesheet" href="/admin/shared/styles.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script src="/admin/shared/firebase.js"></script>
    <script src="/admin/shared/auth.js"></script>
    <script src="/admin/shared/utils.js"></script>
    <script src="/admin/shared/state.js"></script>
    <script src="/admin/shared/navigation.js"></script>
    <script type="text/babel">
(function initPage() {
    if (!window.FIREBASE_READY || !window.auth || !window.db) {
        console.log('Waiting for Firebase to initialize...');
        setTimeout(initPage, 50);
        return;
    }
    const { useState, useEffect, useRef, useMemo, useCallback } = React;
    const { auth, db, storage, CURRENT_TENANT, logAudit } = window;

function CommunityView({ searchQuery, user }) {
    const [activeTab, setActiveTab] = useState('analytics');
    const [loading, setLoading] = useState(true);
    const [createType, setCreateType] = useState('room');
    const [messages, setMessages] = useState([]);
    const [topicRooms, setTopicRooms] = useState([]);
    const [flaggedMessages, setFlaggedMessages] = useState([]);
    const [supportGroups, setSupportGroups] = useState([]);
    const [meetings, setMeetings] = useState([]);
    const [selectedRoom, setSelectedRoom] = useState('main');
    const [newMessage, setNewMessage] = useState('');
    const [showCreateModal, setShowCreateModal] = useState(false);
    const [selectedItem, setSelectedItem] = useState(null);
    const [selectedImage, setSelectedImage] = useState(null);
    const [messageListener, setMessageListener] = useState(null);
    const [pinnedMessages, setPinnedMessages] = useState([]);
    const [messageReactions, setMessageReactions] = useState({});
    const [chatSearch, setChatSearch] = useState('');
    const [filteredMessages, setFilteredMessages] = useState([]);
    const [onlineUsers, setOnlineUsers] = useState(new Set());
    const [typingUsers, setTypingUsers] = useState(new Set());
    const [moderationKeywords, setModerationKeywords] = useState([]);
    const [userWarnings, setUserWarnings] = useState({});
    const [moderationHistory, setModerationHistory] = useState([]);
    const [selectedMeeting, setSelectedMeeting] = useState(null);
    const [attendanceData, setAttendanceData] = useState({});
    const [showAttendanceModal, setShowAttendanceModal] = useState(false);
    const [viewMode, setViewMode] = useState('messages');
    const [selectedThread, setSelectedThread] = useState(null);
    
    const activityChartRef = useRef(null);
    const sentimentChartRef = useRef(null);
    const engagementChartRef = useRef(null);
    const chartInstances = useRef({});
    
    const [stats, setStats] = useState({
        totalMessages: 0,
        activeUsers: 0,
        flaggedCount: 0,
        roomsCount: 0,
        supportGroupsCount: 0,
        meetingsCount: 0,
        todayMessages: 0,
        weekMessages: 0,
        avgMessagesPerUser: 0,
        topContributors: [],
        engagementRate: 0
    });

    const [analyticsData, setAnalyticsData] = useState({
        activityByHour: [],
        activityByDay: [],
        roomEngagement: [],
        sentimentTrend: [],
        topContributors: [],
        messageVolume: []
    });

    useEffect(() => {
        loadCommunityData();
        loadModerationKeywords();
        setupPresenceListener();
        
        return () => {
            if (messageListener) messageListener();
            if (chartInstances.current.activity) chartInstances.current.activity.destroy();
            if (chartInstances.current.sentiment) chartInstances.current.sentiment.destroy();
            if (chartInstances.current.engagement) chartInstances.current.engagement.destroy();
        };
    }, []);

    useEffect(() => {
        if (selectedRoom) {
            loadMessages(selectedRoom);
            loadPinnedMessages(selectedRoom);
        }
    }, [selectedRoom]);

    useEffect(() => {
        filterMessages();
    }, [messages, chatSearch]);

    useEffect(() => {
        if (analyticsData.activityByHour.length > 0) {
            renderAnalyticsCharts();
        }
    }, [analyticsData]);

    const setupPresenceListener = () => {
        const presenceRef = db.collection('presence');
        
        presenceRef.where('online', '==', true).onSnapshot(snapshot => {
            const online = new Set();
            snapshot.forEach(doc => {
                online.add(doc.id);
            });
            setOnlineUsers(online);
        });
    };

    const loadModerationKeywords = async () => {
        try {
            const keywordsDoc = await db.collection('settings').doc('moderation').get();
            if (keywordsDoc.exists) {
                setModerationKeywords(keywordsDoc.data().keywords || []);
            }
        } catch (error) {
            console.error('Error loading moderation keywords:', error);
        }
    };

    const loadCommunityData = async () => {
        try {
            setLoading(true);

            // Load rooms
            const roomsSnap = await db.collection('topicRooms').where('tenantId', '==', CURRENT_TENANT).get();
            const roomsData = [];
            for (const doc of roomsSnap.docs) {
                const roomData = { id: doc.id, ...doc.data() };
                
                // Get message count
                const messagesCount = await db.collection('messages')
                    .where('tenantId', '==', CURRENT_TENANT)
                    .where('roomId', '==', doc.id)
                    .get();
                roomData.messageCount = messagesCount.size;
                
                roomsData.push(roomData);
            }
            setTopicRooms(roomsData);

            // Load support groups
            const supportGroupsSnap = await db.collection('supportGroups')
                .where('tenantId', '==', CURRENT_TENANT)
                .orderBy('createdAt', 'desc')
                .get();
            const supportGroupsData = [];
            supportGroupsSnap.forEach(doc => {
                supportGroupsData.push({ id: doc.id, ...doc.data() });
            });
            setSupportGroups(supportGroupsData);

            // Load meetings
            const meetingsSnap = await db.collection('meetings')
                .where('tenantId', '==', CURRENT_TENANT)
                .where('coachId', '==', user.uid)
                .orderBy('scheduledTime', 'desc')
                .limit(50)
                .get();
            
            const meetingsData = [];
            for (const doc of meetingsSnap.docs) {
                const meetingData = { id: doc.id, ...doc.data() };
                
                if (meetingData.assignedPIRs && meetingData.assignedPIRs.length > 0) {
                    const pirNames = [];
                    for (const pirId of meetingData.assignedPIRs) {
                        const pirDoc = await db.collection('users').doc(pirId).get();
                        if (pirDoc.exists) {
                            const pirData = pirDoc.data();
                            pirNames.push(pirData.displayName || pirData.email);
                        }
                    }
                    meetingData.pirNames = pirNames;
                }
                
                // Load attendance data
                const attendanceSnap = await db.collection('meetingAttendance')
                    .where('tenantId', '==', CURRENT_TENANT)
                    .where('meetingId', '==', doc.id)
                    .get();
                meetingData.attendanceCount = attendanceSnap.size;
                
                meetingsData.push(meetingData);
            }
            setMeetings(meetingsData);

            // Load flagged messages
            const flaggedSnap = await db.collection('messages')
                .where('tenantId', '==', CURRENT_TENANT)
                .where('flagged', '==', true)
                .where('resolved', '==', false)
                .orderBy('flaggedAt', 'desc')
                .limit(20)
                .get();

            const flaggedData = [];
            for (const doc of flaggedSnap.docs) {
                const messageData = { id: doc.id, ...doc.data() };
                
                if (messageData.userId) {
                    const userDoc = await db.collection('users').doc(messageData.userId).get();
                    if (userDoc.exists) {
                        messageData.userName = userDoc.data().displayName || userDoc.data().email;
                    }
                }
                
                flaggedData.push(messageData);
            }
            setFlaggedMessages(flaggedData);

            // Load moderation history
            const moderationSnap = await db.collection('moderationActions')
                .where('tenantId', '==', CURRENT_TENANT)
                .orderBy('timestamp', 'desc')
                .limit(50)
                .get();
            
            const moderationData = [];
            moderationSnap.forEach(doc => {
                moderationData.push({ id: doc.id, ...doc.data() });
            });
            setModerationHistory(moderationData);

            // Load user warnings
            const warningsSnap = await db.collection('userWarnings').where('tenantId', '==', CURRENT_TENANT).get();
            const warnings = {};
            warningsSnap.forEach(doc => {
                warnings[doc.id] = doc.data().warnings || [];
            });
            setUserWarnings(warnings);

            // Calculate comprehensive stats
            await calculateStats(roomsData, supportGroupsData, meetingsData);
            await calculateAnalytics();

        } catch (error) {
            console.error('Error loading community data:', error);
        } finally {
            setLoading(false);
        }
    };

    const calculateStats = async (rooms, groups, meets) => {
        try {
            // Get all messages for analysis
            const allMessagesSnap = await db.collection('messages')
                .where('tenantId', '==', CURRENT_TENANT)
                .orderBy('createdAt', 'desc')
                .limit(1000)
                .get();

            const allMessages = [];
            const uniqueUsers = new Set();
            const userMessageCounts = {};
            
            const now = new Date();
            const todayStart = new Date(now.setHours(0, 0, 0, 0));
            const weekStart = new Date(now.setDate(now.getDate() - 7));
            
            let todayCount = 0;
            let weekCount = 0;

            allMessagesSnap.forEach(doc => {
                const msg = doc.data();
                allMessages.push(msg);
                
                if (msg.userId) {
                    uniqueUsers.add(msg.userId);
                    userMessageCounts[msg.userId] = (userMessageCounts[msg.userId] || 0) + 1;
                }
                
                const msgDate = msg.createdAt?.toDate ? msg.createdAt.toDate() : new Date(msg.createdAt);
                if (msgDate >= todayStart) todayCount++;
                if (msgDate >= weekStart) weekCount++;
            });

            // Top contributors
            const topContributors = Object.entries(userMessageCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([userId, count]) => ({ userId, count }));

            // Load user names for top contributors
            for (const contributor of topContributors) {
                const userDoc = await db.collection('users').doc(contributor.userId).get();
                if (userDoc.exists) {
                    contributor.userName = userDoc.data().displayName || userDoc.data().email;
                }
            }

            const totalMessages = allMessages.length;

            const engagementRate = uniqueUsers.size > 0 
                ? Math.round((totalMessages / uniqueUsers.size) * 10) / 10 
                : 0;

            setStats({
                totalMessages: totalMessages,
                activeUsers: uniqueUsers.size,
                flaggedCount: flaggedMessages.length,
                roomsCount: rooms.length,
                supportGroupsCount: groups.length,
                meetingsCount: meets.length,
                todayMessages: todayCount,
                weekMessages: weekCount,
                avgMessagesPerUser: engagementRate,
                topContributors: topContributors,
                engagementRate: engagementRate
            });

        } catch (error) {
            console.error('Error calculating stats:', error);
        }
    };

    const calculateAnalytics = async () => {
        try {
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

            const messagesSnap = await db.collection('messages')
                .where('tenantId', '==', CURRENT_TENANT)
                .where('createdAt', '>=', sevenDaysAgo)
                .get();

            // Activity by hour (0-23)
            const hourlyActivity = new Array(24).fill(0);
            
            // Activity by day
            const dailyActivity = {};
            
            // Room engagement
            const roomEngagement = {};
            
            // Sentiment trend
            const sentimentByDay = {};

            messagesSnap.forEach(doc => {
                const msg = doc.data();
                const date = msg.createdAt?.toDate ? msg.createdAt.toDate() : new Date(msg.createdAt);
                
                // Hour analysis
                hourlyActivity[date.getHours()]++;
                
                // Day analysis
                const dayKey = date.toISOString().split('T')[0];
                dailyActivity[dayKey] = (dailyActivity[dayKey] || 0) + 1;
                
                // Room engagement
                roomEngagement[msg.roomId] = (roomEngagement[msg.roomId] || 0) + 1;
                
                // Sentiment by day
                const content = (msg.content || '').toLowerCase();
                const isPositive = ['great', 'good', 'thanks', 'helpful', 'love'].some(w => content.includes(w));
                const isNegative = ['bad', 'worst', 'hate', 'terrible', 'awful'].some(w => content.includes(w));
                
                if (!sentimentByDay[dayKey]) sentimentByDay[dayKey] = { positive: 0, negative: 0, neutral: 0 };
                if (isPositive) sentimentByDay[dayKey].positive++;
                else if (isNegative) sentimentByDay[dayKey].negative++;
                else sentimentByDay[dayKey].neutral++;
            });

            setAnalyticsData({
                activityByHour: hourlyActivity,
                activityByDay: Object.entries(dailyActivity).map(([day, count]) => ({ day, count })),
                roomEngagement: Object.entries(roomEngagement).map(([room, count]) => ({ room, count })),
                sentimentTrend: Object.entries(sentimentByDay).map(([day, data]) => ({ day, ...data })),
                messageVolume: Object.entries(dailyActivity).map(([day, count]) => ({ day, count }))
            });

        } catch (error) {
            console.error('Error calculating analytics:', error);
        }
    };

    const renderAnalyticsCharts = () => {
        // Activity by Hour Chart
        if (activityChartRef.current) {
            if (chartInstances.current.activity) {
                chartInstances.current.activity.destroy();
            }
            
            const ctx = activityChartRef.current.getContext('2d');
            chartInstances.current.activity = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: [{
                        label: 'Messages',
                        data: analyticsData.activityByHour,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: '#0077CC',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // Sentiment Trend Chart
        if (sentimentChartRef.current && analyticsData.sentimentTrend.length > 0) {
            if (chartInstances.current.sentiment) {
                chartInstances.current.sentiment.destroy();
            }
            
            const ctx = sentimentChartRef.current.getContext('2d');
            chartInstances.current.sentiment = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: analyticsData.sentimentTrend.map(d => new Date(d.day).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                    datasets: [
                        {
                            label: 'Positive',
                            data: analyticsData.sentimentTrend.map(d => d.positive),
                            borderColor: '#00A86B',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Negative',
                            data: analyticsData.sentimentTrend.map(d => d.negative),
                            borderColor: '#f44336',
                            backgroundColor: 'rgba(244, 67, 54, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Room Engagement Chart
        if (engagementChartRef.current && analyticsData.roomEngagement.length > 0) {
            if (chartInstances.current.engagement) {
                chartInstances.current.engagement.destroy();
            }
            
            const ctx = engagementChartRef.current.getContext('2d');
            const roomNames = analyticsData.roomEngagement.map(r => {
                if (r.room === 'main') return 'Main Chat';
                const room = topicRooms.find(tr => tr.id === r.room);
                return room?.name || 'Unknown';
            });
            
            chartInstances.current.engagement = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: roomNames,
                    datasets: [{
                        data: analyticsData.roomEngagement.map(r => r.count),
                        backgroundColor: [
                            '#0077CC',
                            '#f093fb',
                            '#4facfe',
                            '#fa709a',
                            '#43e97b',
                            '#38f9d7'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
    };

    const loadMessages = async (roomId) => {
        if (messageListener) {
            messageListener();
        }

        const listener = db.collection('messages')
            .where('tenantId', '==', CURRENT_TENANT)
            .where('roomId', '==', roomId)
            .orderBy('createdAt', 'desc')
            .limit(100)
            .onSnapshot(async snapshot => {
                const messagesData = [];
                
                for (const doc of snapshot.docs) {
                    const messageData = { id: doc.id, ...doc.data() };
                    
                    if (messageData.userId) {
                        const userDoc = await db.collection('users').doc(messageData.userId).get();
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            messageData.userName = userData.displayName || userData.email;
                            messageData.userRole = userData.role;
                        }
                    }
                    
                    // Load reactions
                    const reactionsSnap = await db.collection('messageReactions')
                        .where('tenantId', '==', CURRENT_TENANT)
                        .where('messageId', '==', doc.id)
                        .get();
                    
                    const reactions = {};
                    reactionsSnap.forEach(reactionDoc => {
                        const data = reactionDoc.data();
                        if (!reactions[data.emoji]) {
                            reactions[data.emoji] = [];
                        }
                        reactions[data.emoji].push(data.userId);
                    });
                    messageData.reactions = reactions;
                    
                    // Load replies count
                    const repliesSnap = await db.collection('messages')
                        .where('tenantId', '==', CURRENT_TENANT)
                        .where('parentId', '==', doc.id)
                        .get();
                    messageData.repliesCount = repliesSnap.size;
                    
                    messagesData.push(messageData);
                }
                
                setMessages(messagesData);
            });

        setMessageListener(() => listener);
    };

    const loadPinnedMessages = async (roomId) => {
        try {
            const pinnedSnap = await db.collection('messages')
                .where('tenantId', '==', CURRENT_TENANT)
                .where('roomId', '==', roomId)
                .where('pinned', '==', true)
                .orderBy('pinnedAt', 'desc')
                .get();
            
            const pinned = [];
            for (const doc of pinnedSnap.docs) {
                const msgData = { id: doc.id, ...doc.data() };
                
                if (msgData.userId) {
                    const userDoc = await db.collection('users').doc(msgData.userId).get();
                    if (userDoc.exists) {
                        msgData.userName = userDoc.data().displayName || userDoc.data().email;
                    }
                }
                
                pinned.push(msgData);
            }
            setPinnedMessages(pinned);
        } catch (error) {
            console.error('Error loading pinned messages:', error);
        }
    };

    const filterMessages = () => {
        if (!chatSearch) {
            setFilteredMessages(messages);
            return;
        }
        
        const query = chatSearch.toLowerCase();
        const filtered = messages.filter(msg =>
            msg.content?.toLowerCase().includes(query) ||
            msg.userName?.toLowerCase().includes(query)
        );
        setFilteredMessages(filtered);
    };

    const handleSendMessage = async () => {
        if (!newMessage.trim()) return;

        try {
            // Check for moderation keywords
            const lowerMessage = newMessage.toLowerCase();
            const hasBlockedKeyword = moderationKeywords.some(keyword => 
                lowerMessage.includes(keyword.toLowerCase())
            );

            if (hasBlockedKeyword) {
                alert('Your message contains inappropriate content and cannot be sent.');
                return;
            }

            await db.collection('messages').add({
                tenantId: CURRENT_TENANT,
                roomId: selectedRoom,
                userId: user.uid,
                content: newMessage,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                edited: false,
                flagged: false,
                resolved: false,
                fromAdmin: true,
                pinned: false,
                parentId: selectedThread
            });

            setNewMessage('');
            setSelectedThread(null);
        } catch (error) {
            console.error('Error sending message:', error);
            alert('Failed to send message');
        }
    };

    const handleReaction = async (messageId, emoji) => {
        try {
            const reactionRef = db.collection('messageReactions')
                .doc(`${messageId}_${user.uid}_${emoji}`);
            
            const reactionDoc = await reactionRef.get();
            
            if (reactionDoc.exists) {
                await reactionRef.delete();
            } else {
                await reactionRef.set({
                    messageId: messageId,
                    userId: user.uid,
                    emoji: emoji,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        } catch (error) {
            console.error('Error handling reaction:', error);
        }
    };

    const handlePinMessage = async (messageId, isPinned) => {
        try {
            await db.collection('messages').doc(messageId).update({
                pinned: !isPinned,
                pinnedAt: !isPinned ? firebase.firestore.FieldValue.serverTimestamp() : null,
                pinnedBy: !isPinned ? user.uid : null
            });
            
            loadPinnedMessages(selectedRoom);
        } catch (error) {
            console.error('Error pinning message:', error);
        }
    };

    const handleDeleteMessage = async (messageId) => {
        if (confirm('Delete this message permanently?')) {
            try {
                await db.collection('messages').doc(messageId).delete();
                
                // Log moderation action
                await db.collection('moderationActions').add({
                    tenantId: CURRENT_TENANT,
                    action: 'delete',
                    messageId: messageId,
                    moderatorId: user.uid,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('Message deleted');
            } catch (error) {
                console.error('Error deleting message:', error);
                alert('Failed to delete message');
            }
        }
    };

    const handleWarnUser = async (userId, reason) => {
        try {
            const warningData = {
                userId: userId,
                reason: reason,
                issuedBy: user.uid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection('userWarnings').doc(userId).set({
                warnings: firebase.firestore.FieldValue.arrayUnion(warningData)
            }, { merge: true });
            
            // Log moderation action
            await db.collection('moderationActions').add({
                tenantId: CURRENT_TENANT,
                action: 'warn',
                userId: userId,
                reason: reason,
                moderatorId: user.uid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            alert('Warning issued');
            loadCommunityData();
        } catch (error) {
            console.error('Error warning user:', error);
            alert('Failed to issue warning');
        }
    };

    const handleFlagResolve = async (messageId, action) => {
        try {
            if (action === 'delete') {
                await db.collection('messages').doc(messageId).delete();
            } else if (action === 'unflag') {
                await db.collection('messages').doc(messageId).update({
                    flagged: false,
                    resolved: true,
                    resolvedBy: user.uid,
                    resolvedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            // Log action
            await db.collection('moderationActions').add({
                tenantId: CURRENT_TENANT,
                action: action,
                messageId: messageId,
                moderatorId: user.uid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            loadCommunityData();
        } catch (error) {
            console.error('Error resolving flag:', error);
            alert('Failed to resolve flag');
        }
    };

    const handleCreateRoom = async (roomData) => {
        try {
            await db.collection('topicRooms').add({
                tenantId: CURRENT_TENANT,
                ...roomData,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: user.uid,
                active: true,
                messageCount: 0
            });

            alert('Topic room created successfully!');
            setShowCreateModal(false);
            setSelectedItem(null);
            loadCommunityData();
        } catch (error) {
            console.error('Error creating room:', error);
            alert('Failed to create room');
        }
    };

    const handleToggleRoom = async (roomId, currentStatus) => {
        try {
            await db.collection('topicRooms').doc(roomId).update({
                active: !currentStatus
            });
            loadCommunityData();
        } catch (error) {
            console.error('Error toggling room:', error);
        }
    };

    const handleDeleteRoom = async (roomId) => {
        if (confirm('Delete this topic room?')) {
            try {
                await db.collection('topicRooms').doc(roomId).delete();
                alert('Room deleted');
                loadCommunityData();
            } catch (error) {
                console.error('Error deleting room:', error);
            }
        }
    };

    // NEW: Helper to calculate next occurrence of a day
    const getNextDayOfWeek = (dayName, time) => {
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const targetDay = days.indexOf(dayName);
        
        if (targetDay === -1) {
            throw new Error('Invalid day name');
        }
        
        const now = new Date();
        const currentDay = now.getDay();
        
        // Calculate days until target day
        let daysUntilTarget = targetDay - currentDay;
        if (daysUntilTarget <= 0) {
            daysUntilTarget += 7; // Next week
        }
        
        // Create date for next occurrence
        const nextDate = new Date(now);
        nextDate.setDate(now.getDate() + daysUntilTarget);
        
        // Set time
        const [hours, minutes] = time.split(':');
        nextDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
        
        return nextDate;
    };

    // NEW: Create Google Calendar event for Support Group
    const createSupportGroupCalendarEvent = async (groupData, pirId, accessToken) => {
        try {
            // Calculate next occurrence
            const startDateTime = getNextDayOfWeek(groupData.day, groupData.time);
            
            // End time is 1 hour after start (default for support groups)
            const endDateTime = new Date(startDateTime);
            endDateTime.setHours(endDateTime.getHours() + 1);
            
            // Build description
            let description = groupData.description || '';
            if (groupData.location) {
                description += `\n\nLocation: ${groupData.location}`;
            }
            if (groupData.link) {
                description += `\n\nVirtual Meeting Link: ${groupData.link}`;
            }
            
            const event = {
                summary: `${groupData.type} - ${groupData.name}`,
                description: description,
                location: groupData.location || '',
                start: {
                    dateTime: startDateTime.toISOString(),
                    timeZone: 'America/Los_Angeles'
                },
                end: {
                    dateTime: endDateTime.toISOString(),
                    timeZone: 'America/Los_Angeles'
                },
                recurrence: [
                    'RRULE:FREQ=WEEKLY' // Repeats weekly
                ],
                reminders: {
                    useDefault: false,
                    overrides: [
                        { method: 'popup', minutes: 30 },
                        { method: 'email', minutes: 60 }
                    ]
                }
            };
            
            console.log('Creating support group calendar event for PIR:', pirId);
            
            // Get PIR's Google access token
            const pirDoc = await db.collection('users').doc(pirId).get();
            if (!pirDoc.exists) {
                throw new Error('PIR not found');
            }
            
            const pirData = pirDoc.data();
            const pirAccessToken = pirData.googleAccessToken || accessToken;
            
            if (!pirAccessToken) {
                console.warn('PIR does not have Google connected, skipping calendar event');
                return null;
            }
            
            // Make API request to PIR's calendar
            const response = await fetch(
                'https://www.googleapis.com/calendar/v3/calendars/primary/events',
                {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${pirAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(event)
                }
            );
            
            if (!response.ok) {
                const error = await response.json();
                console.error('Google Calendar API error for PIR:', error);
                throw new Error('Failed to create calendar event for PIR');
            }
            
            const createdEvent = await response.json();
            console.log('✓ Calendar event created for PIR:', pirId);
            
            return {
                eventId: createdEvent.id,
                htmlLink: createdEvent.htmlLink,
                pirId: pirId
            };
            
        } catch (error) {
            console.error('Error creating support group calendar event:', error);
            return null;
        }
    };

    // UPDATED: Handle Create Support Group with Calendar Integration
    const handleCreateSupportGroup = async (groupData) => {
        try {
            console.log('Creating support group with data:', groupData);
            
            // Save support group to Firebase first
            const groupDoc = await db.collection('supportGroups').add({
                tenantId: CURRENT_TENANT,
                ...groupData,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: user.uid,
                active: true
            });
            
            console.log('✓ Support group saved to Firebase:', groupDoc.id);
            
            // If there are assigned PIRs and coach has Google connected, create calendar events
            if (groupData.assignedPIRs && groupData.assignedPIRs.length > 0 && user.googleConnected) {
                console.log(`Creating calendar events for ${groupData.assignedPIRs.length} PIRs...`);
                
                const calendarEvents = [];
                let successCount = 0;
                let failCount = 0;
                
                for (const pirId of groupData.assignedPIRs) {
                    try {
                        const eventData = await createSupportGroupCalendarEvent(
                            groupData,
                            pirId,
                            user.googleAccessToken
                        );
                        
                        if (eventData) {
                            calendarEvents.push(eventData);
                            successCount++;
                        } else {
                            failCount++;
                        }
                    } catch (error) {
                        console.error(`Failed to create calendar event for PIR ${pirId}:`, error);
                        failCount++;
                    }
                }
                
                // Save calendar event IDs to the support group document
                if (calendarEvents.length > 0) {
                    await db.collection('supportGroups').doc(groupDoc.id).update({
                        googleCalendarEvents: calendarEvents
                    });
                    
                    console.log(`✓ Created ${successCount} calendar events`);
                }
                
                // Show summary
                if (successCount > 0 && failCount === 0) {
                    alert(
                        `✅ Support group created successfully!\n\n` +
                        `📅 Added to ${successCount} PIR calendar(s)\n` +
                        `🔁 Repeats: Weekly on ${groupData.day}s\n` +
                        `🕐 Time: ${groupData.time} PT`
                    );
                } else if (successCount > 0 && failCount > 0) {
                    alert(
                        `⚠️ Support group created!\n\n` +
                        `✅ Added to ${successCount} calendar(s)\n` +
                        `❌ Failed for ${failCount} PIR(s)\n\n` +
                        `(Some PIRs may not have Google Calendar connected)`
                    );
                } else if (failCount > 0) {
                    alert(
                        `✅ Support group created!\n\n` +
                        `⚠️ Calendar events could not be created.\n` +
                        `PIRs may need to connect their Google Calendar.`
                    );
                }
            } else {
                // No calendar integration
                if (!user.googleConnected) {
                    alert(
                        `✅ Support group created!\n\n` +
                        `⚠️ Connect Google Services in your Profile to automatically\n` +
                        `add support groups to PIR calendars.`
                    );
                } else {
                    alert('✅ Support group created successfully!');
                }
            }
            
            setShowCreateModal(false);
            setSelectedItem(null);
            loadCommunityData();
            
        } catch (error) {
            console.error('Error creating support group:', error);
            alert('Failed to create support group: ' + error.message);
        }
    };

    // AUTO-REFRESH: Silently refresh Google token if expired
    const refreshGoogleToken = async () => {
        return new Promise((resolve, reject) => {
            try {
                console.log('Attempting to refresh Google token...');
                
                // Check if Google Identity Services is loaded
                if (typeof google === 'undefined' || !google.accounts) {
                    reject(new Error('Google Identity Services not loaded'));
                    return;
                }
                
                // Use token client to get new token silently
                const tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: '457406864879-k1sunucuqofe22m5rg93hvo6nngiqh0u.apps.googleusercontent.com',
                    scope: [
                        'https://www.googleapis.com/auth/calendar.events',
                        'https://www.googleapis.com/auth/drive.file',
                        'https://www.googleapis.com/auth/gmail.send'
                    ].join(' '),
                    callback: async (tokenResponse) => {
                        try {
                            if (tokenResponse.error) {
                                reject(new Error(tokenResponse.error));
                                return;
                            }
                            
                            if (tokenResponse.access_token) {
                                // Update Firebase with new token
                                await db.collection('users').doc(user.uid).update({
                                    googleAccessToken: tokenResponse.access_token,
                                    googleTokenExpiry: Date.now() + (tokenResponse.expires_in * 1000),
                                    googleTokenRefreshedAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                
                                console.log('✓ Token refreshed successfully');
                                
                                // Update local user object
                                user.googleAccessToken = tokenResponse.access_token;
                                user.googleTokenExpiry = Date.now() + (tokenResponse.expires_in * 1000);
                                
                                resolve(tokenResponse.access_token);
                            } else {
                                reject(new Error('No access token received'));
                            }
                        } catch (error) {
                            reject(error);
                        }
                    },
                });
                
                // Request new token (will try silently first with prompt: '')
                tokenClient.requestAccessToken({ prompt: '' });
                
            } catch (error) {
                console.error('Failed to refresh token:', error);
                reject(error);
            }
        });
    };

    // Check if Google token is valid and auto-refresh if needed
    const checkGoogleToken = async () => {
        // Check if user has Google connected
        if (!user.googleConnected || !user.googleAccessToken) {
            return {
                valid: false,
                error: 'Google Services not connected. Please connect Google in your Profile settings.'
            };
        }
        
        // Check if token is expired
        if (user.googleTokenExpiry) {
            const now = Date.now();
            const expiryTime = user.googleTokenExpiry;
            const fiveMinutes = 5 * 60 * 1000;
            
            if (now >= expiryTime - fiveMinutes) {
                // Token expired - try to refresh automatically
                try {
                    console.log('⚠️ Token expired, attempting auto-refresh...');
                    await refreshGoogleToken();
                    console.log('✓ Token auto-refreshed successfully');
                    return { valid: true };
                } catch (refreshError) {
                    console.error('❌ Auto-refresh failed:', refreshError);
                    return {
                        valid: false,
                        error: 'Google token expired and could not be refreshed automatically.\n\nPlease:\n1. Go to Profile\n2. Click "Disconnect Google Services"\n3. Click "Connect Google Services" again\n\nThen try scheduling the meeting again.'
                    };
                }
            }
        }
        
        return { valid: true };
    };

  // PERMANENT FIX: Google Calendar Helper - Timezone-Safe Meeting Creation
const createGoogleMeeting = async (meetingData, accessToken) => {
    try {
        // BUILD DATETIME STRING DIRECTLY IN PACIFIC TIMEZONE (NO CONVERSIONS!)
        const date = meetingData.date; // Already in YYYY-MM-DD format
        const time = meetingData.time; // Already in HH:MM format
        
        // Construct RFC3339 datetime in Pacific timezone (no Date object conversions)
        const startDateTimeString = `${date}T${time}:00`; // e.g., "2025-10-08T14:30:00"
        
        console.log('Meeting datetime (Pacific):', startDateTimeString);
        
        // Calculate end time
        const [startHours, startMinutes] = time.split(':').map(Number);
        const durationMinutes = parseInt(meetingData.duration || 60);
        
        let endHours = startHours;
        let endMinutes = startMinutes + durationMinutes;
        
        // Handle minute overflow
        if (endMinutes >= 60) {
            endHours += Math.floor(endMinutes / 60);
            endMinutes = endMinutes % 60;
        }
        
        // Handle hour overflow (next day)
        let endDate = date;
        if (endHours >= 24) {
            endHours = endHours % 24;
            const dateParts = date.split('-');
            const nextDay = new Date(
                parseInt(dateParts[0]),
                parseInt(dateParts[1]) - 1,
                parseInt(dateParts[2]) + 1
            );
            endDate = nextDay.toISOString().split('T')[0];
        }
        
        const endDateTimeString = `${endDate}T${String(endHours).padStart(2, '0')}:${String(endMinutes).padStart(2, '0')}:00`;
        
        console.log('End datetime (Pacific):', endDateTimeString);
        
        // BUILD RECURRENCE RULE WITH PROPER END CONDITIONS
        let recurrence = [];
        let estimatedOccurrences = 1;
        
        if (meetingData.recurring && meetingData.recurring !== 'none') {
            const freq = meetingData.recurring.toUpperCase();
            
            if (meetingData.recurringEnd === 'count') {
                // After X occurrences
                recurrence = [`RRULE:FREQ=${freq};COUNT=${meetingData.recurringCount}`];
                estimatedOccurrences = parseInt(meetingData.recurringCount);
            } else if (meetingData.recurringEnd === 'until') {
                // Until specific date - use 23:59:59 on that day in Pacific
                const untilDateString = `${meetingData.recurringUntil}T23:59:59`;
                // Convert to RRULE format (basic ISO string without separators + Z)
                const untilStr = untilDateString.replace(/[-:]/g, '') + 'Z';
                recurrence = [`RRULE:FREQ=${freq};UNTIL=${untilStr}`];
                
                // Calculate estimated occurrences
                const startDate = new Date(date);
                const untilDate = new Date(meetingData.recurringUntil);
                const daysBetween = Math.floor((untilDate - startDate) / (1000 * 60 * 60 * 24));
                
                if (meetingData.recurring === 'daily') {
                    estimatedOccurrences = daysBetween + 1;
                } else if (meetingData.recurring === 'weekly') {
                    estimatedOccurrences = Math.floor(daysBetween / 7) + 1;
                } else if (meetingData.recurring === 'monthly') {
                    estimatedOccurrences = Math.floor(daysBetween / 30) + 1;
                }
            } else if (meetingData.recurringEnd === 'never') {
                // Infinite - no COUNT or UNTIL
                recurrence = [`RRULE:FREQ=${freq}`];
                estimatedOccurrences = '∞';
            }
        }
        
        // Create event with Meet link - PACIFIC TIME (NO CONVERSIONS!)
        const event = {
            summary: meetingData.title || meetingData.meetingTitle,
            description: meetingData.description || meetingData.notes || '',
            start: {
                dateTime: startDateTimeString,
                timeZone: 'America/Los_Angeles'
            },
            end: {
                dateTime: endDateTimeString,
                timeZone: 'America/Los_Angeles'
            },
            conferenceData: {
                createRequest: {
                    requestId: `meet-${Date.now()}`,
                    conferenceSolutionKey: { type: 'hangoutsMeet' }
                }
            },
            reminders: {
                useDefault: false,
                overrides: [
                    { method: 'email', minutes: 24 * 60 },
                    { method: 'popup', minutes: 30 }
                ]
            }
        };
        
        if (recurrence.length > 0) {
            event.recurrence = recurrence;
        }
        
        console.log('Sending request to Google Calendar API...');
        console.log('Event payload:', JSON.stringify(event, null, 2));
        
        // Make API request
        const response = await fetch(
            'https://www.googleapis.com/calendar/v3/calendars/primary/events?conferenceDataVersion=1',
            {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(event)
            }
        );
        
        console.log('Google Calendar API response status:', response.status);
        
        if (!response.ok) {
            const error = await response.json();
            console.error('Google Calendar API error:', error);
            
            if (response.status === 401) {
                throw new Error('TOKEN_EXPIRED');
            }
            
            throw new Error(error.error?.message || 'Failed to create calendar event');
        }
        
        const createdEvent = await response.json();
        console.log('Calendar event created successfully:', createdEvent.id);
        
        return {
            eventId: createdEvent.id,
            meetLink: createdEvent.hangoutLink,
            htmlLink: createdEvent.htmlLink,
            occurrences: estimatedOccurrences
        };
        
    } catch (error) {
        console.error('Error creating Google Calendar event:', error);
        throw error;
    }
};
   // UPDATED: Handle Create Meeting with Occurrence Count Display
const handleCreateMeeting = async (meetingData) => {
    try {
        // CRITICAL: Check Google token FIRST (now async with auto-refresh)
        const tokenCheck = await checkGoogleToken();
        
        if (!tokenCheck.valid) {
            alert('❌ Cannot create meeting without Google Calendar\n\n' + tokenCheck.error);
            return;
        }
        
        console.log('✓ Google token valid, proceeding with meeting creation...');
        
        let googleEventData = null;
        let occurrenceCount = 1;
        
        try {
            console.log('Creating Google Calendar event with Meet link...');
            googleEventData = await createGoogleMeeting(meetingData, user.googleAccessToken);
            console.log('✓ Google event created:', googleEventData);
            
            // Get occurrence count
            occurrenceCount = googleEventData.occurrences || 1;
            
            // Update meeting data with generated Meet link
            if (googleEventData.meetLink) {
                meetingData.meetingLink = googleEventData.meetLink;
            }
        } catch (googleError) {
            console.error('❌ Google Calendar integration failed:', googleError);
            
            // If token expired during creation, show reconnect message
            if (googleError.message === 'TOKEN_EXPIRED') {
                alert('❌ Google token expired during creation!\n\nPlease:\n1. Go to Profile\n2. Disconnect Google Services\n3. Connect Google Services again\n4. Try scheduling the meeting again');
                return;
            }
            
            // Other Google errors - let user decide
            const continueWithoutGoogle = confirm(
                '⚠️ Google Calendar sync failed!\n\n' +
                'Error: ' + googleError.message + '\n\n' +
                'Do you want to create the meeting WITHOUT a Google Meet link?\n\n' +
                '(You can add the link manually later)'
            );
            
            if (!continueWithoutGoogle) {
                return;
            }
        }
        
        // Only reach here if Google Calendar succeeded OR user chose to continue
        console.log('Saving meeting to Firebase...');
        
        // Save to Firebase
        const meetingDoc = await db.collection('meetings').add({
            tenantId: CURRENT_TENANT,
            ...meetingData,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            coachId: user.uid,
            status: 'scheduled',
            googleCalendarEventId: googleEventData?.eventId || null,
            googleCalendarLink: googleEventData?.htmlLink || null,
            recurring: meetingData.recurring || 'none',
            recurringEnd: meetingData.recurringEnd || 'never',
            recurringCount: meetingData.recurringCount || null,
            recurringUntil: meetingData.recurringUntil || null,
            timezone: 'America/Los_Angeles'
        });
        
        console.log('✓ Meeting saved to Firebase:', meetingDoc.id);
        
        // ENHANCED SUCCESS MESSAGE WITH OCCURRENCE COUNT
        let successMessage = '✅ Meeting scheduled successfully!\n\n';
        
        if (meetingData.recurring && meetingData.recurring !== 'none') {
            if (occurrenceCount === '∞') {
                successMessage += `📅 Recurring ${meetingData.recurring} (infinite)\n`;
                successMessage += '⚠️ This meeting will repeat forever until manually deleted\n\n';
            } else {
                const startDate = new Date(
                    parseInt(meetingData.date.split('-')[0]),
                    parseInt(meetingData.date.split('-')[1]) - 1,
                    parseInt(meetingData.date.split('-')[2])
                ).toLocaleDateString();
                
                successMessage += `📅 ${occurrenceCount} occurrences created\n`;
                successMessage += `📆 Starting ${startDate}\n\n`;
            }
        } else {
            const meetingDateTime = new Date(
                parseInt(meetingData.date.split('-')[0]),
                parseInt(meetingData.date.split('-')[1]) - 1,
                parseInt(meetingData.date.split('-')[2]),
                parseInt(meetingData.time.split(':')[0]),
                parseInt(meetingData.time.split(':')[1])
            );
            successMessage += `📅 ${meetingDateTime.toLocaleString()}\n\n`;
        }
        
        if (googleEventData?.meetLink) {
            successMessage += `🔗 Meet link: ${googleEventData.meetLink}\n`;
        }
        
        if (googleEventData?.htmlLink) {
            successMessage += `📆 View in Calendar: ${googleEventData.htmlLink}\n`;
        }
        
        successMessage += '🕐 Time: Pacific Time (PT)';
        
        alert(successMessage);
        
        setShowCreateModal(false);
        setSelectedItem(null);
        loadCommunityData();
        
    } catch (error) {
        console.error('❌ Error creating meeting:', error);
        alert('Failed to create meeting: ' + error.message);
    }
};

    const handleRecordAttendance = async (meetingId, pirId, status) => {
        try {
            await db.collection('meetingAttendance').doc(`${meetingId}_${pirId}`).set({
                meetingId: meetingId,
                pirId: pirId,
                status: status,
                recordedAt: firebase.firestore.FieldValue.serverTimestamp(),
                recordedBy: user.uid
            });
            
            alert('Attendance recorded');
            loadCommunityData();
        } catch (error) {
            console.error('Error recording attendance:', error);
        }
    };

    const exportData = (type, format) => {
        let data = [];
        let filename = '';
        
        if (type === 'messages') {
            data = messages.map(msg => ({
                room: selectedRoom,
                user: msg.userName,
                message: msg.content,
                timestamp: formatDateTime(msg.createdAt),
                flagged: msg.flagged ? 'Yes' : 'No'
            }));
            filename = 'chat-messages';
        } else if (type === 'analytics') {
            data = [
                { metric: 'Total Messages', value: stats.totalMessages },
                { metric: 'Active Users', value: stats.activeUsers },
                { metric: 'Flagged Messages', value: stats.flaggedCount },
                { metric: 'Engagement Rate', value: stats.engagementRate }
            ];
            filename = 'community-analytics';
        } else if (type === 'moderation') {
            data = moderationHistory.map(action => ({
                action: action.action,
                moderator: action.moderatorId,
                timestamp: formatDateTime(action.timestamp),
                details: action.reason || 'N/A'
            }));
            filename = 'moderation-history';
        }
        
        if (format === 'csv') {
            exportToCSV(data, filename);
        } else if (format === 'pdf') {
            exportToPDF(data, `${filename} Report`);
        } else {
            exportToJSON(data, filename);
        }
    };

    if (loading) {
        return (
            <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                minHeight: '400px',
                gap: '20px'
            }}>
                <div style={{
                    width: '60px',
                    height: '60px',
                    border: '4px solid #f3f3f3',
                    borderTop: '4px solid #0077CC',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite'
                }}></div>
                <p style={{ color: '#666' }}>Loading community data...</p>
            </div>
        );
    }

    return (
        <div style={{ padding: '20px', animation: 'fadeIn 0.5s' }}>
            {/* Enhanced Navigation */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '15px 20px',
                marginBottom: '20px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                display: 'flex',
                gap: '10px',
                flexWrap: 'wrap',
                overflowX: 'auto'
            }}>
                {[
                    { id: 'analytics', label: 'Analytics', icon: '📊' },
                    { id: 'chat', label: 'Chat', icon: '💬' },
                    { id: 'rooms', label: `Rooms (${topicRooms.length})`, icon: '🏠' },
                    { id: 'supportGroups', label: `Support Groups (${supportGroups.length})`, icon: '🤝' },
                    { id: 'meetings', label: `Meetings (${meetings.length})`, icon: '📅' },
                    { id: 'moderation', label: `Moderation ${flaggedMessages.length > 0 ? `(${flaggedMessages.length})` : ''}`, icon: '🛡️' }
                ].map(tab => (
                    <button
                        key={tab.id}
                        onClick={() => setActiveTab(tab.id)}
                        style={{
                            padding: '10px 20px',
                            background: activeTab === tab.id 
                                ? 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)' 
                                : '#f0f0f0',
                            color: activeTab === tab.id ? 'white' : '#666',
                            border: 'none',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500',
                            transition: 'all 0.2s',
                            whiteSpace: 'nowrap'
                        }}
                    >
                        {tab.icon} {tab.label}
                    </button>
                ))}
            </div>

            {/* Render Active Tab */}
            {activeTab === 'analytics' && (
                <AnalyticsTab 
                    stats={stats}
                    analyticsData={analyticsData}
                    activityChartRef={activityChartRef}
                    sentimentChartRef={sentimentChartRef}
                    engagementChartRef={engagementChartRef}
                    exportData={exportData}
                />
            )}

            {activeTab === 'chat' && (
                <EnhancedChatTab
                    messages={filteredMessages}
                    selectedRoom={selectedRoom}
                    setSelectedRoom={setSelectedRoom}
                    topicRooms={topicRooms}
                    newMessage={newMessage}
                    setNewMessage={setNewMessage}
                    handleSendMessage={handleSendMessage}
                    handleReaction={handleReaction}
                    handlePinMessage={handlePinMessage}
                    handleDeleteMessage={handleDeleteMessage}
                    handleWarnUser={handleWarnUser}
                    pinnedMessages={pinnedMessages}
                    chatSearch={chatSearch}
                    setChatSearch={setChatSearch}
                    onlineUsers={onlineUsers}
                    setSelectedImage={setSelectedImage}
                    viewMode={viewMode}
                    setViewMode={setViewMode}
                    selectedThread={selectedThread}
                    setSelectedThread={setSelectedThread}
                    user={user}
                    exportData={exportData}
                />
            )}

            {activeTab === 'rooms' && (
                <RoomsTab
                    topicRooms={topicRooms}
                    handleToggleRoom={handleToggleRoom}
                    handleDeleteRoom={handleDeleteRoom}
                    setShowCreateModal={setShowCreateModal}
                    setCreateType={setCreateType}
                />
            )}

            {activeTab === 'supportGroups' && (
                <SupportGroupsTab
                    supportGroups={supportGroups}
                    setShowCreateModal={setShowCreateModal}
                    setCreateType={setCreateType}
                    loadCommunityData={loadCommunityData}
                />
            )}

            {activeTab === 'meetings' && (
                <MeetingsTab
                    meetings={meetings}
                    setShowCreateModal={setShowCreateModal}
                    setCreateType={setCreateType}
                    setSelectedMeeting={setSelectedMeeting}
                    setShowAttendanceModal={setShowAttendanceModal}
                    loadCommunityData={loadCommunityData}
                />
            )}

            {activeTab === 'moderation' && (
                <ModerationTab
                    flaggedMessages={flaggedMessages}
                    moderationHistory={moderationHistory}
                    userWarnings={userWarnings}
                    moderationKeywords={moderationKeywords}
                    setModerationKeywords={setModerationKeywords}
                    handleFlagResolve={handleFlagResolve}
                    stats={stats}
                    exportData={exportData}
                />
            )}

            {/* Modals */}
            {selectedImage && (
                <ImageModal image={selectedImage} onClose={() => setSelectedImage(null)} />
            )}

            {showCreateModal && (
                <CommunityCreateModal
                    type={createType}
                    item={selectedItem}
                    onSubmit={(data) => {
                        if (createType === 'meeting') {
                            handleCreateMeeting(data);
                        } else if (createType === 'room') {
                            handleCreateRoom(data);
                        } else if (createType === 'supportGroup') {
                            handleCreateSupportGroup(data);
                        }
                    }}
                    onClose={() => {
                        setShowCreateModal(false);
                        setSelectedItem(null);
                    }}
                    user={user}
                />
            )}

            {showAttendanceModal && selectedMeeting && (
                <AttendanceModal
                    meeting={selectedMeeting}
                    onClose={() => {
                        setShowAttendanceModal(false);
                        setSelectedMeeting(null);
                    }}
                    handleRecordAttendance={handleRecordAttendance}
                />
            )}
        </div>
    );
}
        // ANALYTICS TAB
function AnalyticsTab({ stats, analyticsData, activityChartRef, sentimentChartRef, engagementChartRef, exportData }) {
    return (
        <div style={{ animation: 'fadeIn 0.5s' }}>

            {/* Charts */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(400px, 1fr))', gap: '20px', marginBottom: '30px' }}>
                <div style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '25px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                }}>
                    <h3 style={{ margin: '0 0 20px 0', color: '#333' }}>Activity by Hour</h3>
                    <div style={{ height: '300px' }}>
                        <canvas ref={activityChartRef}></canvas>
                    </div>
                </div>


                <div style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '25px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                }}>
                    <h3 style={{ margin: '0 0 20px 0', color: '#333' }}>Room Engagement</h3>
                    <div style={{ height: '300px' }}>
                        <canvas ref={engagementChartRef}></canvas>
                    </div>
                </div>
            </div>

            {/* Top Contributors */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '25px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                marginBottom: '20px'
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                    <h3 style={{ margin: 0, color: '#333' }}>Top Contributors</h3>
                    <button
                        onClick={() => exportData('analytics', 'csv')}
                        style={{
                            padding: '8px 16px',
                            background: '#6c757d',
                            color: 'white',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500'
                        }}
                    >
                        Export Analytics
                    </button>
                </div>
                <div style={{ display: 'grid', gap: '10px' }}>
                    {stats.topContributors.slice(0, 10).map((contributor, index) => (
                        <div key={contributor.userId} style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            padding: '15px',
                            background: '#f8f9fa',
                            borderRadius: '10px'
                        }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                                <div style={{
                                    width: '40px',
                                    height: '40px',
                                    borderRadius: '50%',
                                    background: index < 3 ? 'linear-gradient(135deg, #FFD700, #FFA500)' : 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                    color: 'white',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    fontSize: '18px',
                                    fontWeight: 'bold'
                                }}>
                                    {index + 1}
                                </div>
                                <div>
                                    <div style={{ fontWeight: '600', color: '#333' }}>
                                        {contributor.userName || 'Unknown User'}
                                    </div>
                                    <div style={{ fontSize: '13px', color: '#666' }}>
                                        {contributor.count} messages
                                    </div>
                                </div>
                            </div>
                            <div style={{
                                padding: '6px 16px',
                                background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                                color: 'white',
                                borderRadius: '20px',
                                fontSize: '13px',
                                fontWeight: '600'
                            }}>
                                Active
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
}

// ENHANCED CHAT TAB
function EnhancedChatTab({ 
    messages, 
    selectedRoom, 
    setSelectedRoom, 
    topicRooms, 
    newMessage, 
    setNewMessage, 
    handleSendMessage,
    handleReaction,
    handlePinMessage,
    handleDeleteMessage,
    handleWarnUser,
    pinnedMessages,
    chatSearch,
    setChatSearch,
    onlineUsers,
    setSelectedImage,
    viewMode,
    setViewMode,
    selectedThread,
    setSelectedThread,
    user,
    exportData
}) {
    const reactions = ['👍', '❤️', '😊', '🎉', '💪', '🙏'];

    return (
        <div style={{ display: 'grid', gridTemplateColumns: '250px 1fr', gap: '20px', height: '700px' }}>
            {/* Sidebar */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                overflowY: 'auto'
            }}>
                <h4 style={{ margin: '0 0 15px 0', color: '#333' }}>Chat Rooms</h4>
                
                <div 
                    onClick={() => setSelectedRoom('main')}
                    style={{
                        padding: '12px',
                        background: selectedRoom === 'main' ? 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)' : '#f8f9fa',
                        color: selectedRoom === 'main' ? 'white' : '#333',
                        borderRadius: '10px',
                        cursor: 'pointer',
                        marginBottom: '8px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '10px',
                        transition: 'all 0.2s'
                    }}
                >
                    <span style={{ fontSize: '20px' }}>🏠</span>
                    <span style={{ fontWeight: '500' }}>Main Chat</span>
                </div>
                
                {topicRooms.filter(room => room.active).map(room => (
                    <div 
                        key={room.id}
                        onClick={() => setSelectedRoom(room.id)}
                        style={{
                            padding: '12px',
                            background: selectedRoom === room.id ? 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)' : '#f8f9fa',
                            color: selectedRoom === room.id ? 'white' : '#333',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            marginBottom: '8px',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '10px',
                            transition: 'all 0.2s'
                        }}
                    >
                        <span style={{ fontSize: '20px' }}>{room.icon || '💬'}</span>
                        <div style={{ flex: 1 }}>
                            <div style={{ fontWeight: '500', fontSize: '14px' }}>{room.name}</div>
                            <div style={{ fontSize: '11px', opacity: 0.8 }}>{room.messageCount || 0} msgs</div>
                        </div>
                    </div>
                ))}
            </div>

            {/* Main Chat Area */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                display: 'flex',
                flexDirection: 'column',
                overflow: 'hidden'
            }}>
                {/* Header */}
                <div style={{
                    padding: '20px',
                    borderBottom: '1px solid #f0f0f0',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center'
                }}>
                    <div>
                        <h3 style={{ margin: 0, color: '#333' }}>
                            {selectedRoom === 'main' ? 'GLRS Community Chat' : 
                             topicRooms.find(r => r.id === selectedRoom)?.name || 'Chat'}
                        </h3>
                        <div style={{ fontSize: '13px', color: '#666', marginTop: '5px' }}>
                            {messages.length} messages • {onlineUsers.size} online
                        </div>
                    </div>
                    <div style={{ display: 'flex', gap: '10px' }}>
                        <input
                            type="text"
                            placeholder="Search messages..."
                            value={chatSearch}
                            onChange={(e) => setChatSearch(e.target.value)}
                            style={{
                                padding: '8px 12px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '8px',
                                fontSize: '14px',
                                width: '200px'
                            }}
                        />
                        <button
                            onClick={() => exportData('messages', 'csv')}
                            style={{
                                padding: '8px 16px',
                                background: '#6c757d',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '500'
                            }}
                        >
                            Export
                        </button>
                    </div>
                </div>

                {/* Pinned Messages */}
                {pinnedMessages.length > 0 && (
                    <div style={{
                        padding: '15px 20px',
                        background: '#fff3cd',
                        borderBottom: '1px solid #f0f0f0'
                    }}>
                        <div style={{ fontWeight: '600', color: '#856404', marginBottom: '10px', fontSize: '13px' }}>
                            📌 Pinned Messages
                        </div>
                        {pinnedMessages.map(msg => (
                            <div key={msg.id} style={{
                                padding: '8px',
                                background: 'rgba(255,255,255,0.5)',
                                borderRadius: '6px',
                                marginBottom: '5px',
                                fontSize: '13px',
                                color: '#856404'
                            }}>
                                <strong>{msg.userName}:</strong> {msg.content}
                            </div>
                        ))}
                    </div>
                )}

                {/* Messages */}
                <div style={{
                    flex: 1,
                    overflowY: 'auto',
                    padding: '20px',
                    display: 'flex',
                    flexDirection: 'column-reverse'
                }}>
                    {messages.map(message => (
                        <div key={message.id} style={{
                            marginBottom: '20px',
                            padding: '15px',
                            background: message.fromAdmin ? 'rgba(102, 126, 234, 0.1)' : '#f8f9fa',
                            borderRadius: '10px',
                            borderLeft: message.flagged ? '4px solid #f44336' : 'none'
                        }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '8px' }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                    <div style={{
                                        width: '36px',
                                        height: '36px',
                                        borderRadius: '50%',
                                        background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                        color: 'white',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        fontSize: '16px',
                                        fontWeight: 'bold'
                                    }}>
                                        {message.userName?.charAt(0).toUpperCase() || '?'}
                                    </div>
                                    <div>
                                        <div style={{ fontWeight: '600', color: '#333', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            {message.userName || 'Unknown'}
                                            {message.userRole === 'admin' && <span>🛡️</span>}
                                            {message.userRole === 'coach' && <span>👤</span>}
                                            {onlineUsers.has(message.userId) && (
                                                <span style={{
                                                    width: '8px',
                                                    height: '8px',
                                                    borderRadius: '50%',
                                                    background: '#00A86B',
                                                    display: 'inline-block'
                                                }}></span>
                                            )}
                                        </div>
                                        <div style={{ fontSize: '12px', color: '#999' }}>
                                            {formatTimeAgo(message.createdAt)}
                                        </div>
                                    </div>
                                </div>
                                <div style={{ display: 'flex', gap: '5px' }}>
                                    <button
                                        onClick={() => handlePinMessage(message.id, message.pinned)}
                                        style={{
                                            padding: '4px 8px',
                                            background: message.pinned ? '#FFC107' : 'transparent',
                                            border: '1px solid #ddd',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '12px'
                                        }}
                                        title={message.pinned ? 'Unpin' : 'Pin message'}
                                    >
                                        📌
                                    </button>
                                    <button
                                        onClick={() => {
                                            const reason = prompt('Warning reason:');
                                            if (reason) handleWarnUser(message.userId, reason);
                                        }}
                                        style={{
                                            padding: '4px 8px',
                                            background: 'transparent',
                                            border: '1px solid #ddd',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '12px'
                                        }}
                                        title="Warn user"
                                    >
                                        ⚠️
                                    </button>
                                    <button
                                        onClick={() => handleDeleteMessage(message.id)}
                                        style={{
                                            padding: '4px 8px',
                                            background: 'transparent',
                                            border: '1px solid #ddd',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '12px'
                                        }}
                                        title="Delete message"
                                    >
                                        🗑️
                                    </button>
                                </div>
                            </div>
                            
                            <div style={{ color: '#333', marginBottom: '10px', lineHeight: '1.6' }}>
                                {message.content}
                            </div>

                            {message.imageUrl && (
                                <img 
                                    src={message.imageUrl}
                                    alt="Shared"
                                    onClick={() => setSelectedImage(message.imageUrl)}
                                    style={{
                                        maxWidth: '300px',
                                        borderRadius: '8px',
                                        cursor: 'pointer',
                                        marginBottom: '10px'
                                    }}
                                />
                            )}

                            {/* Reactions */}
                            <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap', marginBottom: '8px' }}>
                                {reactions.map(emoji => {
                                    const count = message.reactions?.[emoji]?.length || 0;
                                    const hasReacted = message.reactions?.[emoji]?.includes(user.uid);
                                    
                                    return (
                                        <button
                                            key={emoji}
                                            onClick={() => handleReaction(message.id, emoji)}
                                            style={{
                                                padding: '4px 10px',
                                                background: hasReacted ? '#e3f2fd' : 'white',
                                                border: '1px solid #ddd',
                                                borderRadius: '20px',
                                                cursor: 'pointer',
                                                fontSize: '14px',
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '4px'
                                            }}
                                        >
                                            {emoji} {count > 0 && <span style={{ fontSize: '12px' }}>{count}</span>}
                                        </button>
                                    );
                                })}
                            </div>

                            {message.repliesCount > 0 && (
                                <button
                                    onClick={() => setSelectedThread(message.id)}
                                    style={{
                                        padding: '6px 12px',
                                        background: '#e3f2fd',
                                        border: 'none',
                                        borderRadius: '6px',
                                        cursor: 'pointer',
                                        fontSize: '12px',
                                        color: '#1976d2',
                                        fontWeight: '500'
                                    }}
                                >
                                    {message.repliesCount} {message.repliesCount === 1 ? 'reply' : 'replies'}
                                </button>
                            )}

                            {message.flagged && (
                                <div style={{
                                    marginTop: '10px',
                                    padding: '8px',
                                    background: '#ffebee',
                                    borderRadius: '6px',
                                    color: '#c62828',
                                    fontSize: '12px',
                                    fontWeight: '500'
                                }}>
                                    🚩 This message has been flagged
                                </div>
                            )}
                        </div>
                    ))}
                    
                    {messages.length === 0 && (
                        <div style={{
                            textAlign: 'center',
                            padding: '60px 20px',
                            color: '#999'
                        }}>
                            <div style={{ fontSize: '48px', marginBottom: '15px' }}>💬</div>
                            <div>No messages yet. Start the conversation!</div>
                        </div>
                    )}
                </div>

                {/* Input */}
                <div style={{
                    padding: '20px',
                    borderTop: '1px solid #f0f0f0'
                }}>
                    {selectedThread && (
                        <div style={{
                            padding: '8px 12px',
                            background: '#e3f2fd',
                            borderRadius: '8px',
                            marginBottom: '10px',
                            fontSize: '13px',
                            color: '#1976d2',
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center'
                        }}>
                            <span>Replying to thread...</span>
                            <button
                                onClick={() => setSelectedThread(null)}
                                style={{
                                    background: 'none',
                                    border: 'none',
                                    color: '#1976d2',
                                    cursor: 'pointer',
                                    fontSize: '16px'
                                }}
                            >
                                ×
                            </button>
                        </div>
                    )}
                    <div style={{ display: 'flex', gap: '10px' }}>
                        <input
                            type="text"
                            placeholder="Type a message..."
                            value={newMessage}
                            onChange={(e) => setNewMessage(e.target.value)}
                            onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                            style={{
                                flex: 1,
                                padding: '12px 16px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '10px',
                                fontSize: '14px'
                            }}
                        />
                        <button
                            onClick={handleSendMessage}
                            style={{
                                padding: '12px 24px',
                                background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '10px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '600'
                            }}
                        >
                            Send
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
}

// ROOMS TAB
function RoomsTab({ topicRooms, handleToggleRoom, handleDeleteRoom, setShowCreateModal, setModalType }) {
    return (
        <div style={{ animation: 'fadeIn 0.5s' }}>
            <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                marginBottom: '20px'
            }}>
                <h3 style={{ margin: 0, color: '#333' }}>Topic Rooms Management</h3>
                <button
                    onClick={() => {
                        setModalType('room');
                        setShowCreateModal(true);
                    }}
                    style={{
                        padding: '10px 20px',
                        background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '10px',
                        cursor: 'pointer',
                        fontSize: '14px',
                        fontWeight: '600'
                    }}
                >
                    + Create Room
                </button>
            </div>

            <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))',
                gap: '20px'
            }}>
                {topicRooms.map(room => (
                    <div key={room.id} style={{
                        background: 'white',
                        borderRadius: '15px',
                        padding: '20px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                        transition: 'all 0.2s'
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.transform = 'translateY(-5px)';
                        e.currentTarget.style.boxShadow = '0 8px 20px rgba(0,0,0,0.15)';
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
                    }}
                    >
                        <div style={{ fontSize: '48px', textAlign: 'center', marginBottom: '15px' }}>
                            {room.icon || '💬'}
                        </div>
                        <h4 style={{ margin: '0 0 10px 0', textAlign: 'center', color: '#333' }}>
                            {room.name}
                        </h4>
                        <p style={{ fontSize: '14px', color: '#666', textAlign: 'center', marginBottom: '15px' }}>
                            {room.description}
                        </p>
                        <div style={{
                            display: 'flex',
                            justifyContent: 'center',
                            gap: '8px',
                            marginBottom: '15px'
                        }}>
                            <span style={{
                                padding: '4px 12px',
                                background: room.active ? '#d4edda' : '#f8d7da',
                                color: room.active ? '#155724' : '#721c24',
                                borderRadius: '20px',
                                fontSize: '12px',
                                fontWeight: '500'
                            }}>
                                {room.active ? 'Active' : 'Inactive'}
                            </span>
                            <span style={{
                                padding: '4px 12px',
                                background: '#e3f2fd',
                                color: '#1976d2',
                                borderRadius: '20px',
                                fontSize: '12px',
                                fontWeight: '500'
                            }}>
                                {room.messageCount || 0} messages
                            </span>
                        </div>
                        <div style={{ display: 'flex', gap: '8px' }}>
                            <button
                                onClick={() => handleToggleRoom(room.id, room.active)}
                                style={{
                                    flex: 1,
                                    padding: '8px',
                                    background: room.active ? '#FFC107' : '#00A86B',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '13px',
                                    fontWeight: '500'
                                }}
                            >
                                {room.active ? 'Deactivate' : 'Activate'}
                            </button>
                            <button
                                onClick={() => handleDeleteRoom(room.id)}
                                style={{
                                    flex: 1,
                                    padding: '8px',
                                    background: '#DC143C',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '13px',
                                    fontWeight: '500'
                                }}
                            >
                                Delete
                            </button>
                        </div>
                    </div>
                ))}
            </div>

            {topicRooms.length === 0 && (
                <div style={{
                    padding: '80px 20px',
                    textAlign: 'center',
                    background: 'white',
                    borderRadius: '15px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                }}>
                    <div style={{ fontSize: '64px', marginBottom: '20px' }}>🏠</div>
                    <div style={{ fontSize: '20px', fontWeight: '600', color: '#333', marginBottom: '10px' }}>
                        No Topic Rooms Yet
                    </div>
                    <div style={{ fontSize: '16px', color: '#999' }}>
                        Create topic-specific rooms for focused discussions
                    </div>
                </div>
            )}
        </div>
    );
}
     // SUPPORT GROUPS TAB - CORRECTED
function SupportGroupsTab({ supportGroups, setShowCreateModal, setModalType, loadCommunityData }) {
    return (
        <div style={{ animation: 'fadeIn 0.5s' }}>
            <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                marginBottom: '20px'
            }}>
                <h3 style={{ margin: 0, color: '#333' }}>Support Groups</h3>
                <button
                    onClick={() => {
                        setModalType('supportGroup');
                        setShowCreateModal(true);
                    }}
                    style={{
                        padding: '10px 20px',
                        background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '10px',
                        cursor: 'pointer',
                        fontSize: '14px',
                        fontWeight: '600'
                    }}
                >
                    + Add Support Group
                </button>
            </div>

            <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fill, minmax(350px, 1fr))',
                gap: '20px'
            }}>
                {supportGroups.map(group => (
                    <div key={group.id} style={{
                        background: 'white',
                        borderRadius: '15px',
                        padding: '20px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                        transition: 'all 0.2s'
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.transform = 'translateY(-5px)';
                        e.currentTarget.style.boxShadow = '0 8px 20px rgba(0,0,0,0.15)';
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
                    }}
                    >
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '15px' }}>
                            <h4 style={{ margin: 0, color: '#333' }}>{group.name}</h4>
                            <span style={{
                                padding: '4px 12px',
                                background: group.type === 'AA' ? '#0077CC' :
                                           group.type === 'NA' ? '#f093fb' :
                                           group.type === 'SMART' ? '#4facfe' : '#fa709a',
                                color: 'white',
                                borderRadius: '20px',
                                fontSize: '12px',
                                fontWeight: '600'
                            }}>
                                {group.type}
                            </span>
                        </div>

                        {group.description && (
                            <p style={{ fontSize: '14px', color: '#666', marginBottom: '15px' }}>
                                {group.description}
                            </p>
                        )}

                        <div style={{
                            display: 'grid',
                            gap: '10px',
                            marginBottom: '15px',
                            padding: '15px',
                            background: '#f8f9fa',
                            borderRadius: '10px'
                        }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px', fontSize: '14px' }}>
                                <span>📅</span>
                                <span style={{ fontWeight: '600' }}>{group.day}</span>
                            </div>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px', fontSize: '14px' }}>
                                <span>🕐</span>
                                <span style={{ fontWeight: '600' }}>{group.time}</span>
                            </div>
                            {group.location && (
                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px', fontSize: '14px' }}>
                                    <span>📍</span>
                                    <span>{group.location}</span>
                                </div>
                            )}
                            {group.link && (
                                <a
                                    href={group.link}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px',
                                        color: '#1976d2',
                                        textDecoration: 'none',
                                        fontSize: '14px',
                                        fontWeight: '500'
                                    }}
                                >
                                    <span>🔗</span>
                                    <span>Join Meeting</span>
                                </a>
                            )}
                        </div>

                        <div style={{ display: 'flex', gap: '8px' }}>
                            <button
                                onClick={async () => {
                                    await db.collection('supportGroups').doc(group.id).update({
                                        active: !group.active
                                    });
                                    loadCommunityData();
                                }}
                                style={{
                                    flex: 1,
                                    padding: '8px',
                                    background: group.active ? '#00A86B' : '#6c757d',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '13px',
                                    fontWeight: '500'
                                }}
                            >
                                {group.active ? 'Active' : 'Inactive'}
                            </button>
                            <button
                                onClick={async () => {
                                    if (confirm('Delete this support group?')) {
                                        await db.collection('supportGroups').doc(group.id).delete();
                                        loadCommunityData();
                                    }
                                }}
                                style={{
                                    flex: 1,
                                    padding: '8px',
                                    background: '#DC143C',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '13px',
                                    fontWeight: '500'
                                }}
                            >
                                Delete
                            </button>
                        </div>
                    </div>
                ))}
            </div>

            {supportGroups.length === 0 && (
                <div style={{
                    padding: '80px 20px',
                    textAlign: 'center',
                    background: 'white',
                    borderRadius: '15px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                }}>
                    <div style={{ fontSize: '64px', marginBottom: '20px' }}>🤝</div>
                    <div style={{ fontSize: '20px', fontWeight: '600', color: '#333', marginBottom: '10px' }}>
                        No Support Groups Yet
                    </div>
                    <div style={{ fontSize: '16px', color: '#999' }}>
                        Add support groups for PIRs to join
                    </div>
                </div>
            )}
        </div>
    );
}
// MEETINGS TAB
function MeetingsTab({ meetings, setShowCreateModal, setCreateType, setSelectedMeeting, setShowAttendanceModal, loadCommunityData }) {
    return (
        <div style={{ animation: 'fadeIn 0.5s' }}>
            <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                marginBottom: '20px'
            }}>
                <h3 style={{ margin: 0, color: '#333' }}>Group Meetings</h3>
                <button
                    onClick={() => {
                        setCreateType('meeting');
                        setShowCreateModal(true);
                    }}
                    style={{
                        padding: '10px 20px',
                        background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '10px',
                        cursor: 'pointer',
                        fontSize: '14px',
                        fontWeight: '600'
                    }}
                >
                    + Schedule Meeting
                </button>
            </div>

            <div style={{ display: 'grid', gap: '20px' }}>
                {meetings.map(meeting => (
                    <div key={meeting.id} style={{
                        background: 'white',
                        borderRadius: '15px',
                        padding: '25px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                        transition: 'all 0.2s'
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.transform = 'translateY(-2px)';
                        e.currentTarget.style.boxShadow = '0 8px 20px rgba(0,0,0,0.15)';
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
                    }}
                    >
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '15px' }}>
                            <div style={{ flex: 1 }}>
                                <h4 style={{ margin: '0 0 10px 0', color: '#333', fontSize: '20px' }}>
                                    {meeting.meetingTitle || 'Group Recovery Session'}
                                </h4>
                                <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap', marginBottom: '10px' }}>
                                    <span style={{
                                        padding: '4px 12px',
                                        background: meeting.status === 'completed' ? '#d4edda' :
                                                   meeting.status === 'scheduled' ? '#cfe2ff' :
                                                   meeting.status === 'cancelled' ? '#f8d7da' : '#e2e3e5',
                                        color: meeting.status === 'completed' ? '#155724' :
                                               meeting.status === 'scheduled' ? '#084298' :
                                               meeting.status === 'cancelled' ? '#721c24' : '#41464b',
                                        borderRadius: '20px',
                                        fontSize: '12px',
                                        fontWeight: '600',
                                        textTransform: 'uppercase'
                                    }}>
                                        {meeting.status}
                                    </span>
                                    <span style={{
                                        padding: '4px 12px',
                                        background: '#e3f2fd',
                                        color: '#1976d2',
                                        borderRadius: '20px',
                                        fontSize: '12px',
                                        fontWeight: '500'
                                    }}>
                                        {meeting.type || 'Group Session'}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div style={{
                            display: 'grid',
                            gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                            gap: '15px',
                            marginBottom: '15px',
                            padding: '15px',
                            background: '#f8f9fa',
                            borderRadius: '10px'
                        }}>
                            <div>
                                <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Date & Time</div>
                                <div style={{ fontSize: '14px', fontWeight: '600', color: '#333' }}>
                                    {formatDate(meeting.scheduledTime)}
                                </div>
                                <div style={{ fontSize: '13px', color: '#666' }}>
                                    {new Date(meeting.scheduledTime?.toDate ? meeting.scheduledTime.toDate() : meeting.scheduledTime).toLocaleTimeString()}
                                </div>
                            </div>
                            <div>
                                <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Duration</div>
                                <div style={{ fontSize: '14px', fontWeight: '600', color: '#333' }}>
                                    {meeting.duration || 60} minutes
                                </div>
                            </div>
                            {meeting.attendanceCount !== undefined && (
                                <div>
                                    <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Attendance</div>
                                    <div style={{ fontSize: '14px', fontWeight: '600', color: '#333' }}>
                                        {meeting.attendanceCount} recorded
                                    </div>
                                </div>
                            )}
                        </div>

                        {meeting.isGlobal ? (
                            <div style={{
                                padding: '12px',
                                background: '#e8f5e9',
                                borderRadius: '10px',
                                marginBottom: '15px'
                            }}>
                                <div style={{ fontSize: '14px', fontWeight: '600', color: '#2e7d32' }}>
                                    🌍 All PIRs Invited
                                </div>
                            </div>
                        ) : meeting.pirNames && meeting.pirNames.length > 0 && (
                            <div style={{ marginBottom: '15px' }}>
                                <div style={{ fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '10px' }}>
                                    Participants ({meeting.pirNames.length})
                                </div>
                                <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                                    {meeting.pirNames.slice(0, 5).map((name, idx) => (
                                        <span key={idx} style={{
                                            padding: '6px 12px',
                                            background: '#e3f2fd',
                                            color: '#1976d2',
                                            borderRadius: '20px',
                                            fontSize: '13px'
                                        }}>
                                            {name}
                                        </span>
                                    ))}
                                    {meeting.pirNames.length > 5 && (
                                        <span style={{
                                            padding: '6px 12px',
                                            background: '#f0f0f0',
                                            color: '#666',
                                            borderRadius: '20px',
                                            fontSize: '13px',
                                            fontWeight: '600'
                                        }}>
                                            +{meeting.pirNames.length - 5} more
                                        </span>
                                    )}
                                </div>
                            </div>
                        )}

                        {meeting.meetingLink && (
                            <a
                                href={meeting.meetingLink}
                                target="_blank"
                                rel="noopener noreferrer"
                                style={{
                                    display: 'inline-flex',
                                    alignItems: 'center',
                                    gap: '8px',
                                    padding: '10px 16px',
                                    background: '#e3f2fd',
                                    color: '#1976d2',
                                    textDecoration: 'none',
                                    borderRadius: '8px',
                                    fontSize: '14px',
                                    fontWeight: '500',
                                    marginBottom: '15px'
                                }}
                            >
                                🔗 Join Meeting
                            </a>
                        )}

                        {meeting.notes && (
                            <div style={{
                                padding: '12px',
                                background: '#fff3cd',
                                borderRadius: '10px',
                                marginBottom: '15px'
                            }}>
                                <div style={{ fontSize: '12px', fontWeight: '600', color: '#856404', marginBottom: '5px' }}>
                                    Notes
                                </div>
                                <div style={{ fontSize: '14px', color: '#856404' }}>
                                    {meeting.notes}
                                </div>
                            </div>
                        )}

                        <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                            <button
                                onClick={() => {
                                    setSelectedMeeting(meeting);
                                    setShowAttendanceModal(true);
                                }}
                                style={{
                                    padding: '8px 16px',
                                    background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '13px',
                                    fontWeight: '500'
                                }}
                            >
                                Attendance
                            </button>
                            <button
                                onClick={async () => {
                                    await db.collection('meetings').doc(meeting.id).update({
                                        status: 'completed',
                                        completedAt: firebase.firestore.FieldValue.serverTimestamp()
                                    });
                                    loadCommunityData();
                                }}
                                disabled={meeting.status === 'completed'}
                                style={{
                                    padding: '8px 16px',
                                    background: meeting.status === 'completed' ? '#ccc' : '#00A86B',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: meeting.status === 'completed' ? 'not-allowed' : 'pointer',
                                    fontSize: '13px',
                                    fontWeight: '500'
                                }}
                            >
                                Mark Complete
                            </button>
                            <button
                                onClick={async () => {
                                    if (confirm('Cancel this meeting?')) {
                                        await db.collection('meetings').doc(meeting.id).update({
                                            status: 'cancelled'
                                        });
                                        loadCommunityData();
                                    }
                                }}
                                disabled={meeting.status === 'cancelled'}
                                style={{
                                    padding: '8px 16px',
                                    background: meeting.status === 'cancelled' ? '#ccc' : '#FFC107',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: meeting.status === 'cancelled' ? 'not-allowed' : 'pointer',
                                    fontSize: '13px',
                                    fontWeight: '500'
                                }}
                            >
                                Cancel
                            </button>
                            <button
                                onClick={async () => {
                                    if (confirm('Delete this meeting permanently?')) {
                                        await db.collection('meetings').doc(meeting.id).delete();
                                        loadCommunityData();
                                    }
                                }}
                                style={{
                                    padding: '8px 16px',
                                    background: '#DC143C',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '13px',
                                    fontWeight: '500'
                                }}
                            >
                                Delete
                            </button>
                        </div>
                    </div>
                ))}
            </div>

            {meetings.length === 0 && (
                <div style={{
                    padding: '80px 20px',
                    textAlign: 'center',
                    background: 'white',
                    borderRadius: '15px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                }}>
                    <div style={{ fontSize: '64px', marginBottom: '20px' }}>📅</div>
                    <div style={{ fontSize: '20px', fontWeight: '600', color: '#333', marginBottom: '10px' }}>
                        No Meetings Scheduled
                    </div>
                    <div style={{ fontSize: '16px', color: '#999' }}>
                        Schedule group meetings for PIRs
                    </div>
                </div>
            )}
        </div>
    );
}

// MODERATION TAB
function ModerationTab({ 
    flaggedMessages, 
    moderationHistory, 
    userWarnings, 
    moderationKeywords, 
    setModerationKeywords, 
    handleFlagResolve, 
    stats,
    exportData 
}) {
    const [newKeyword, setNewKeyword] = useState('');
    const [showKeywordManager, setShowKeywordManager] = useState(false);

    const handleAddKeyword = async () => {
        if (!newKeyword.trim()) return;
        
        try {
            const updated = [...moderationKeywords, newKeyword.toLowerCase()];
            await db.collection('settings').doc('moderation').set({
                keywords: updated
            });
            setModerationKeywords(updated);
            setNewKeyword('');
            alert('Keyword added');
        } catch (error) {
            console.error('Error adding keyword:', error);
        }
    };

    const handleRemoveKeyword = async (keyword) => {
        try {
            const updated = moderationKeywords.filter(k => k !== keyword);
            await db.collection('settings').doc('moderation').set({
                keywords: updated
            });
            setModerationKeywords(updated);
        } catch (error) {
            console.error('Error removing keyword:', error);
        }
    };

    return (
        <div style={{ animation: 'fadeIn 0.5s' }}>
            {/* Stats Row */}
            <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                gap: '20px',
                marginBottom: '30px'
            }}>
                <div style={{
                    background: 'linear-gradient(135deg, #f44336 0%, #e53935 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(244, 67, 54, 0.3)'
                }}>
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Flagged Messages</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {flaggedMessages.length}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Pending review</div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #FFC107 0%, #FFA000 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(255, 193, 7, 0.3)'
                }}>
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Total Warnings</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {Object.values(userWarnings).reduce((acc, warnings) => acc + warnings.length, 0)}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Issued to users</div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(102, 126, 234, 0.3)'
                }}>
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Moderation Actions</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {moderationHistory.length}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>All time</div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(79, 172, 254, 0.3)'
                }}>
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Blocked Keywords</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {moderationKeywords.length}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Auto-filtered</div>
                </div>
            </div>

            {/* Keyword Manager */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '25px',
                marginBottom: '20px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
                    <h3 style={{ margin: 0, color: '#333' }}>Keyword Filtering</h3>
                    <button
                        onClick={() => setShowKeywordManager(!showKeywordManager)}
                        style={{
                            padding: '8px 16px',
                            background: '#0077CC',
                            color: 'white',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500'
                        }}
                    >
                        {showKeywordManager ? 'Hide' : 'Manage Keywords'}
                    </button>
                </div>

                {showKeywordManager && (
                    <>
                        <div style={{ display: 'flex', gap: '10px', marginBottom: '15px' }}>
                            <input
                                type="text"
                                placeholder="Add keyword to block..."
                                value={newKeyword}
                                onChange={(e) => setNewKeyword(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && handleAddKeyword()}
                                style={{
                                    flex: 1,
                                    padding: '10px 15px',
                                    border: '2px solid #e0e0e0',
                                    borderRadius: '8px',
                                    fontSize: '14px'
                                }}
                            />
                            <button
                                onClick={handleAddKeyword}
                                style={{
                                    padding: '10px 20px',
                                    background: '#00A86B',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500'
                                }}
                            >
                                Add
                            </button>
                        </div>

                        <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                            {moderationKeywords.map(keyword => (
                                <div key={keyword} style={{
                                    padding: '6px 12px',
                                    background: '#ffebee',
                                    color: '#c62828',
                                    borderRadius: '20px',
                                    fontSize: '13px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px'
                                }}>
                                    <span>{keyword}</span>
                                    <button
                                        onClick={() => handleRemoveKeyword(keyword)}
                                        style={{
                                            background: 'none',
                                            border: 'none',
                                            color: '#c62828',
                                            cursor: 'pointer',
                                            fontSize: '16px',
                                            padding: 0,
                                            lineHeight: 1
                                        }}
                                    >
                                        ×
                                    </button>
                                </div>
                            ))}
                            {moderationKeywords.length === 0 && (
                                <div style={{ color: '#999', fontSize: '14px' }}>
                                    No keywords set. Messages will not be auto-filtered.
                                </div>
                            )}
                        </div>
                    </>
                )}
            </div>

            {/* Flagged Messages */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '25px',
                marginBottom: '20px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                    <h3 style={{ margin: 0, color: '#333' }}>
                        Flagged Messages ({flaggedMessages.length})
                    </h3>
                    {flaggedMessages.length > 0 && (
                        <button
                            onClick={() => exportData('moderation', 'csv')}
                            style={{
                                padding: '8px 16px',
                                background: '#6c757d',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '500'
                            }}
                        >
                            Export Report
                        </button>
                    )}
                </div>

                {flaggedMessages.length > 0 ? (
                    <div style={{ display: 'grid', gap: '15px' }}>
                        {flaggedMessages.map(message => (
                            <div key={message.id} style={{
                                padding: '20px',
                                background: '#fff3cd',
                                border: '2px solid #f44336',
                                borderRadius: '10px'
                            }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px' }}>
                                    <div>
                                        <div style={{ fontWeight: '600', color: '#333' }}>
                                            {message.userName || 'Unknown User'}
                                        </div>
                                        <div style={{ fontSize: '12px', color: '#666' }}>
                                            {formatTimeAgo(message.flaggedAt)}
                                        </div>
                                    </div>
                                    <span style={{
                                        padding: '6px 12px',
                                        background: '#DC143C',
                                        color: 'white',
                                        borderRadius: '20px',
                                        fontSize: '12px',
                                        fontWeight: '600'
                                    }}>
                                        FLAGGED
                                    </span>
                                </div>

                                <div style={{
                                    padding: '15px',
                                    background: 'white',
                                    borderRadius: '8px',
                                    marginBottom: '10px',
                                    color: '#333'
                                }}>
                                    {message.content}
                                </div>

                                {message.imageUrl && (
                                    <img
                                        src={message.imageUrl}
                                        alt="Flagged content"
                                        style={{
                                            maxWidth: '200px',
                                            borderRadius: '8px',
                                            marginBottom: '10px'
                                        }}
                                    />
                                )}

                                {message.flagReason && (
                                    <div style={{
                                        padding: '10px',
                                        background: 'rgba(244, 67, 54, 0.1)',
                                        borderRadius: '8px',
                                        fontSize: '14px',
                                        color: '#c62828',
                                        marginBottom: '10px'
                                    }}>
                                        <strong>Reason:</strong> {message.flagReason}
                                    </div>
                                )}

                                <div style={{ display: 'flex', gap: '10px' }}>
                                    <button
                                        onClick={() => handleFlagResolve(message.id, 'delete')}
                                        style={{
                                            padding: '8px 16px',
                                            background: '#DC143C',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '8px',
                                            cursor: 'pointer',
                                            fontSize: '14px',
                                            fontWeight: '500'
                                        }}
                                    >
                                        Delete Message
                                    </button>
                                    <button
                                        onClick={() => handleFlagResolve(message.id, 'unflag')}
                                        style={{
                                            padding: '8px 16px',
                                            background: '#00A86B',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '8px',
                                            cursor: 'pointer',
                                            fontSize: '14px',
                                            fontWeight: '500'
                                        }}
                                    >
                                        Unflag & Keep
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                ) : (
                    <div style={{
                        padding: '60px 20px',
                        textAlign: 'center',
                        color: '#999'
                    }}>
                        <div style={{ fontSize: '48px', marginBottom: '15px' }}>✅</div>
                        <div style={{ fontSize: '18px', fontWeight: '500', marginBottom: '8px' }}>
                            No Flagged Messages
                        </div>
                        <div style={{ fontSize: '14px' }}>
                            Community is clean!
                        </div>
                    </div>
                )}
            </div>

            {/* Moderation History */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '25px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <h3 style={{ margin: '0 0 20px 0', color: '#333' }}>
                    Recent Moderation Actions
                </h3>

                {moderationHistory.length > 0 ? (
                    <div style={{ display: 'grid', gap: '10px' }}>
                        {moderationHistory.slice(0, 20).map(action => (
                            <div key={action.id} style={{
                                padding: '15px',
                                background: '#f8f9fa',
                                borderRadius: '10px',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center'
                            }}>
                                <div>
                                    <div style={{ fontWeight: '600', color: '#333', marginBottom: '5px' }}>
                                        {action.action === 'delete' && '🗑️ Message Deleted'}
                                        {action.action === 'warn' && '⚠️ User Warned'}
                                        {action.action === 'unflag' && '✅ Message Unflagged'}
                                    </div>
                                    <div style={{ fontSize: '13px', color: '#666' }}>
                                        {formatTimeAgo(action.timestamp)}
                                        {action.reason && ` • ${action.reason}`}
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                ) : (
                    <div style={{ textAlign: 'center', padding: '40px', color: '#999' }}>
                        No moderation actions yet
                    </div>
                )}
            </div>
        </div>
    );
}
            // IMAGE MODAL
function ImageModal({ image, onClose }) {
    return (
        <div 
            onClick={onClose}
            style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0, 0, 0, 0.9)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 2000,
                cursor: 'pointer',
                animation: 'fadeIn 0.2s'
            }}
        >
            <img 
                src={image}
                alt="Full size"
                onClick={(e) => e.stopPropagation()}
                style={{
                    maxWidth: '90vw',
                    maxHeight: '90vh',
                    objectFit: 'contain',
                    borderRadius: '10px',
                    boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5)'
                }}
            />
            <button
                onClick={onClose}
                style={{
                    position: 'absolute',
                    top: '20px',
                    right: '20px',
                    background: 'rgba(255,255,255,0.2)',
                    border: 'none',
                    color: 'white',
                    fontSize: '32px',
                    width: '48px',
                    height: '48px',
                    borderRadius: '50%',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    backdropFilter: 'blur(10px)',
                    transition: 'background 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.3)'}
                onMouseLeave={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.2)'}
            >
                ×
            </button>
        </div>
    );
}

// COMMUNITY CREATE MODAL - WITH RECURRING END OPTIONS
function CommunityCreateModal({ type, item, onSubmit, onClose, user }) {
    const [formData, setFormData] = useState(() => {
        if (item) {
            return {
                ...item,
                assignedPIRs: item.assignedPIRs || [],
                recurring: item.recurring || 'none',
                recurringEnd: item.recurringEnd || 'never',
                recurringCount: item.recurringCount || 10,
                recurringUntil: item.recurringUntil || ''
            };
        }
        
        if (type === 'room') {
            return {
                name: '',
                description: '',
                icon: '💬',
                rules: ''
            };
        } else if (type === 'supportGroup') {
            return {
                name: '',
                type: 'AA',
                day: 'Monday',
                time: '',
                link: '',
                location: '',
                description: '',
                active: true
            };
        } else if (type === 'meeting') {
            return {
                meetingTitle: '',
                scheduledTime: '',
                type: 'Group Session',
                meetingLink: '',
                duration: '60',
                isGlobal: false,
                assignedPIRs: [],
                notes: '',
                sendReminder: true,
                status: 'scheduled',
                recurring: 'none',
                recurringEnd: 'never',
                recurringCount: 10,
                recurringUntil: ''
            };
        }
    });

    const [allPIRs, setAllPIRs] = useState([]);
    const [selectedPIRs, setSelectedPIRs] = useState(item?.assignedPIRs || []);
    const [loading, setLoading] = useState(true);

    const icons = ['💬', '🎯', '💪', '🧘', '📖', '🌟', '❤️', '🙏', '🎨', '🎵'];

    useEffect(() => {
        if (type === 'meeting' || type === 'supportGroup') {
            loadPIRs();
        } else {
            setLoading(false);
        }
    }, []);

    const loadPIRs = async () => {
        try {
            const pirsSnap = await db.collection('users')
                .where('role', '==', 'pir')
                .where('active', '!=', false)
                .get();
            
            const pirsData = [];
            pirsSnap.forEach(doc => {
                const data = doc.data();
                pirsData.push({
                    id: doc.id,
                    name: data.displayName || `${data.firstName} ${data.lastName}` || data.email,
                    email: data.email
                });
            });
            setAllPIRs(pirsData);
        } catch (error) {
            console.error('Error loading PIRs:', error);
        } finally {
            setLoading(false);
        }
    };

    const handleSubmit = (e) => {
        e.preventDefault();
        
        if (type === 'room') {
            if (!formData.name || !formData.description) {
                alert('Please fill in all required fields');
                return;
            }
        } else if (type === 'supportGroup') {
            if (!formData.name || !formData.day || !formData.time) {
                alert('Please fill in all required fields');
                return;
            }
            
            const finalData = {
                ...formData,
                assignedPIRs: selectedPIRs
            };
            
            onSubmit(finalData);
            return;
        } else if (type === 'meeting') {
            if (!formData.meetingTitle || !formData.scheduledTime) {
                alert('Please provide a meeting title and scheduled time');
                return;
            }
            
            // Validate recurring end options
            if (formData.recurring !== 'none') {
                if (formData.recurringEnd === 'count' && (!formData.recurringCount || formData.recurringCount < 1)) {
                    alert('Please specify how many times the meeting should repeat');
                    return;
                }
                if (formData.recurringEnd === 'until' && !formData.recurringUntil) {
                    alert('Please specify when the recurring meetings should end');
                    return;
                }
            }
            
            const scheduledDate = new Date(formData.scheduledTime);
            const dateStr = scheduledDate.toISOString().split('T')[0];
            const timeStr = formData.scheduledTime.split('T')[1];
            
            const finalData = {
                ...formData,
                scheduledTime: firebase.firestore.Timestamp.fromDate(scheduledDate),
                assignedPIRs: formData.isGlobal ? [] : selectedPIRs,
                date: dateStr,
                time: timeStr,
                title: formData.meetingTitle,
                description: formData.notes || ''
            };
            
            onSubmit(finalData);
            return;
        }
        
        onSubmit(formData);
    };

    const handlePIRSelection = (pirId) => {
        if (selectedPIRs.includes(pirId)) {
            setSelectedPIRs(selectedPIRs.filter(id => id !== pirId));
        } else {
            setSelectedPIRs([...selectedPIRs, pirId]);
        }
    };

    const selectAllPIRs = () => {
        setSelectedPIRs(allPIRs.map(pir => pir.id));
    };

    const clearSelection = () => {
        setSelectedPIRs([]);
    };

    const getCurrentDateTime = () => {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        return now.toISOString().slice(0, 16);
    };

    const getMinRecurringEndDate = () => {
        if (!formData.scheduledTime) return '';
        const scheduledDate = new Date(formData.scheduledTime);
        scheduledDate.setDate(scheduledDate.getDate() + 1); // At least 1 day after start
        return scheduledDate.toISOString().split('T')[0];
    };

    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1500,
            padding: '20px',
            animation: 'fadeIn 0.2s'
        }}>
            <div style={{
                background: 'white',
                borderRadius: '20px',
                maxWidth: '700px',
                width: '100%',
                maxHeight: '90vh',
                overflow: 'auto',
                boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
                animation: 'slideUp 0.3s'
            }}>
                {/* Header */}
                <div style={{
                    background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                    padding: '25px 30px',
                    borderRadius: '20px 20px 0 0',
                    color: 'white',
                    position: 'sticky',
                    top: 0,
                    zIndex: 1
                }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <h3 style={{ margin: 0, fontSize: '24px' }}>
                            {item ? 'Edit' : 'Create'} {
                                type === 'room' ? 'Topic Room' :
                                type === 'supportGroup' ? 'Support Group' :
                                'Group Meeting'
                            }
                        </h3>
                        <button 
                            onClick={onClose}
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                border: 'none',
                                color: 'white',
                                fontSize: '24px',
                                width: '36px',
                                height: '36px',
                                borderRadius: '50%',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center'
                            }}
                        >
                            ×
                        </button>
                    </div>
                </div>

                {/* Form Content */}
                <form onSubmit={handleSubmit} style={{ padding: '30px' }}>
                    {/* TIMEZONE BANNER */}
                    {(type === 'meeting' || type === 'supportGroup') && (
                        <div style={{
                            marginBottom: '25px',
                            padding: '15px 20px',
                            background: 'linear-gradient(135deg, #0077CC15 0%, #008B8B15 100%)',
                            border: '2px solid #0077CC',
                            borderRadius: '12px',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '12px'
                        }}>
                            <span style={{ fontSize: '24px' }}>🕐</span>
                            <div>
                                <div style={{ fontWeight: '600', color: '#0077CC', fontSize: '15px', marginBottom: '4px' }}>
                                    Pacific Time Zone (PT)
                                </div>
                                <div style={{ fontSize: '13px', color: '#666' }}>
                                    All times are in Pacific Time. Calendar events will be created in PT timezone.
                                </div>
                            </div>
                        </div>
                    )}

                    {type === 'room' && (
                        <>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Room Name *
                                </label>
                                <input
                                    type="text"
                                    value={formData.name}
                                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                                    placeholder="e.g., Daily Reflections"
                                    required
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px'
                                    }}
                                />
                            </div>

                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Description *
                                </label>
                                <textarea
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                    placeholder="What is this room about?"
                                    rows="3"
                                    required
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px',
                                        fontFamily: 'inherit',
                                        resize: 'vertical'
                                    }}
                                />
                            </div>

                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Icon
                                </label>
                                <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                                    {icons.map(icon => (
                                        <button
                                            key={icon}
                                            type="button"
                                            onClick={() => setFormData({...formData, icon})}
                                            style={{
                                                padding: '10px 15px',
                                                background: formData.icon === icon ? '#e3f2fd' : '#f0f0f0',
                                                border: formData.icon === icon ? '2px solid #1976d2' : '2px solid transparent',
                                                borderRadius: '8px',
                                                cursor: 'pointer',
                                                fontSize: '24px',
                                                transition: 'all 0.2s'
                                            }}
                                        >
                                            {icon}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Room Rules (optional)
                                </label>
                                <textarea
                                    value={formData.rules}
                                    onChange={(e) => setFormData({...formData, rules: e.target.value})}
                                    placeholder="Any specific guidelines for this room?"
                                    rows="2"
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px',
                                        fontFamily: 'inherit',
                                        resize: 'vertical'
                                    }}
                                />
                            </div>
                        </>
                    )}

                    {type === 'supportGroup' && (
                        <>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Group Name *
                                </label>
                                <input
                                    type="text"
                                    value={formData.name}
                                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                                    placeholder="e.g., Wednesday Night NA Meeting"
                                    required
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px'
                                    }}
                                />
                            </div>
                            
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px', marginBottom: '20px' }}>
                                <div>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        Type *
                                    </label>
                                    <select
                                        value={formData.type}
                                        onChange={(e) => setFormData({...formData, type: e.target.value})}
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '10px',
                                            fontSize: '14px',
                                            background: 'white'
                                        }}
                                    >
                                        <option value="AA">AA</option>
                                        <option value="NA">NA</option>
                                        <option value="Al-Anon">Al-Anon</option>
                                        <option value="SMART">SMART Recovery</option>
                                        <option value="Celebrate Recovery">Celebrate Recovery</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        Day *
                                    </label>
                                    <select
                                        value={formData.day}
                                        onChange={(e) => setFormData({...formData, day: e.target.value})}
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '10px',
                                            fontSize: '14px',
                                            background: 'white'
                                        }}
                                    >
                                        <option value="Monday">Monday</option>
                                        <option value="Tuesday">Tuesday</option>
                                        <option value="Wednesday">Wednesday</option>
                                        <option value="Thursday">Thursday</option>
                                        <option value="Friday">Friday</option>
                                        <option value="Saturday">Saturday</option>
                                        <option value="Sunday">Sunday</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Time (PT) *
                                </label>
                                <input
                                    type="time"
                                    value={formData.time}
                                    onChange={(e) => setFormData({...formData, time: e.target.value})}
                                    required
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px'
                                    }}
                                />
                            </div>
                            
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Meeting Link (for virtual meetings)
                                </label>
                                <input
                                    type="url"
                                    value={formData.link}
                                    onChange={(e) => setFormData({...formData, link: e.target.value})}
                                    placeholder="https://zoom.us/j/..."
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px'
                                    }}
                                />
                            </div>
                            
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Location (for in-person meetings)
                                </label>
                                <input
                                    type="text"
                                    value={formData.location || ''}
                                    onChange={(e) => setFormData({...formData, location: e.target.value})}
                                    placeholder="e.g., Community Center, 123 Main St"
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px'
                                    }}
                                />
                            </div>
                            
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Description
                                </label>
                                <textarea
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                    placeholder="Additional details about this support group"
                                    rows="3"
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px',
                                        fontFamily: 'inherit',
                                        resize: 'vertical'
                                    }}
                                />
                            </div>

                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Assign PIRs to This Support Group
                                </label>
                                <div style={{
                                    marginBottom: '10px',
                                    padding: '10px 12px',
                                    background: '#f0f9ff',
                                    borderRadius: '8px',
                                    fontSize: '13px',
                                    color: '#0369a1'
                                }}>
                                    ℹ️ Selected PIRs will have this support group added to their calendars
                                </div>
                                <div style={{ display: 'flex', gap: '10px', marginBottom: '10px' }}>
                                    <button 
                                        type="button"
                                        onClick={selectAllPIRs}
                                        style={{
                                            padding: '6px 12px',
                                            background: '#0077CC',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            fontWeight: '500'
                                        }}
                                    >
                                        Select All
                                    </button>
                                    <button 
                                        type="button"
                                        onClick={clearSelection}
                                        style={{
                                            padding: '6px 12px',
                                            background: '#6c757d',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            fontWeight: '500'
                                        }}
                                    >
                                        Clear All
                                    </button>
                                    <span style={{ fontSize: '13px', color: '#666', lineHeight: '32px' }}>
                                        {selectedPIRs.length} selected
                                    </span>
                                </div>
                                <div style={{
                                    maxHeight: '200px',
                                    overflowY: 'auto',
                                    border: '2px solid #e0e0e0',
                                    borderRadius: '10px',
                                    padding: '10px'
                                }}>
                                    {loading ? (
                                        <div style={{ textAlign: 'center', padding: '20px', color: '#999' }}>
                                            Loading PIRs...
                                        </div>
                                    ) : allPIRs.length > 0 ? (
                                        allPIRs.map(pir => (
                                            <label key={pir.id} style={{
                                                display: 'block',
                                                padding: '8px',
                                                cursor: 'pointer',
                                                background: selectedPIRs.includes(pir.id) ? '#e3f2fd' : 'transparent',
                                                borderRadius: '6px',
                                                marginBottom: '4px',
                                                transition: 'background 0.2s'
                                            }}>
                                                <input
                                                    type="checkbox"
                                                    checked={selectedPIRs.includes(pir.id)}
                                                    onChange={() => handlePIRSelection(pir.id)}
                                                    style={{ marginRight: '10px', width: '16px', height: '16px', cursor: 'pointer' }}
                                                />
                                                <span style={{ fontSize: '14px' }}>
                                                    {pir.name} <span style={{ color: '#999', fontSize: '12px' }}>({pir.email})</span>
                                                </span>
                                            </label>
                                        ))
                                    ) : (
                                        <div style={{ color: '#999', textAlign: 'center', padding: '20px' }}>
                                            No PIRs available
                                        </div>
                                    )}
                                </div>
                            </div>
                        </>
                    )}

                    {type === 'meeting' && (
                        <>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Meeting Title *
                                </label>
                                <input
                                    type="text"
                                    value={formData.meetingTitle}
                                    onChange={(e) => setFormData({...formData, meetingTitle: e.target.value})}
                                    placeholder="e.g., Weekly Progress Review, Drop-In Hours"
                                    required
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px'
                                    }}
                                />
                            </div>
                            
                            <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr', gap: '15px', marginBottom: '20px' }}>
                                <div>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        Date & Time (PT) *
                                    </label>
                                    <input
                                        type="datetime-local"
                                        value={formData.scheduledTime}
                                        onChange={(e) => setFormData({...formData, scheduledTime: e.target.value})}
                                        min={getCurrentDateTime()}
                                        required
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '10px',
                                            fontSize: '14px'
                                        }}
                                    />
                                </div>
                                
                                <div>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        Duration
                                    </label>
                                    <select
                                        value={formData.duration}
                                        onChange={(e) => setFormData({...formData, duration: e.target.value})}
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '10px',
                                            fontSize: '14px',
                                            background: 'white'
                                        }}
                                    >
                                        <option value="30">30 min</option>
                                        <option value="60">60 min</option>
                                        <option value="90">90 min</option>
                                        <option value="120">2 hours</option>
                                    </select>
                                </div>
                            </div>

                            {/* RECURRING OPTIONS */}
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Recurring Schedule
                                </label>
                                <select
                                    value={formData.recurring}
                                    onChange={(e) => setFormData({...formData, recurring: e.target.value})}
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px',
                                        background: 'white'
                                    }}
                                >
                                    <option value="none">One-time meeting</option>
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>

                            {/* RECURRING END OPTIONS - NEW! */}
                            {formData.recurring !== 'none' && (
                                <div style={{ 
                                    marginBottom: '20px',
                                    padding: '20px',
                                    background: '#f8f9fa',
                                    borderRadius: '12px',
                                    border: '2px solid #e0e0e0'
                                }}>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '12px' }}>
                                        When should this recurring meeting end?
                                    </label>
                                    
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                        {/* After X occurrences */}
                                        <label style={{ display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer' }}>
                                            <input
                                                type="radio"
                                                name="recurringEnd"
                                                value="count"
                                                checked={formData.recurringEnd === 'count'}
                                                onChange={(e) => setFormData({...formData, recurringEnd: e.target.value})}
                                                style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                            />
                                            <span style={{ fontSize: '14px', fontWeight: '500', color: '#333' }}>
                                                After
                                            </span>
                                            <select
                                                value={formData.recurringCount}
                                                onChange={(e) => setFormData({...formData, recurringEnd: 'count', recurringCount: e.target.value})}
                                                disabled={formData.recurringEnd !== 'count'}
                                                style={{
                                                    padding: '8px 12px',
                                                    border: '2px solid #e0e0e0',
                                                    borderRadius: '8px',
                                                    fontSize: '14px',
                                                    background: 'white',
                                                    cursor: formData.recurringEnd !== 'count' ? 'not-allowed' : 'pointer',
                                                    opacity: formData.recurringEnd !== 'count' ? 0.5 : 1
                                                }}
                                            >
                                                <option value="5">5</option>
                                                <option value="10">10</option>
                                                <option value="15">15</option>
                                                <option value="20">20</option>
                                                <option value="25">25</option>
                                                <option value="30">30</option>
                                            </select>
                                            <span style={{ fontSize: '14px', fontWeight: '500', color: '#333' }}>
                                                occurrences
                                            </span>
                                        </label>

                                        {/* Until specific date */}
                                        <label style={{ display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer' }}>
                                            <input
                                                type="radio"
                                                name="recurringEnd"
                                                value="until"
                                                checked={formData.recurringEnd === 'until'}
                                                onChange={(e) => setFormData({...formData, recurringEnd: e.target.value})}
                                                style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                            />
                                            <span style={{ fontSize: '14px', fontWeight: '500', color: '#333' }}>
                                                Until
                                            </span>
                                            <input
                                                type="date"
                                                value={formData.recurringUntil}
                                                onChange={(e) => setFormData({...formData, recurringEnd: 'until', recurringUntil: e.target.value})}
                                                min={getMinRecurringEndDate()}
                                                disabled={formData.recurringEnd !== 'until'}
                                                style={{
                                                    padding: '8px 12px',
                                                    border: '2px solid #e0e0e0',
                                                    borderRadius: '8px',
                                                    fontSize: '14px',
                                                    cursor: formData.recurringEnd !== 'until' ? 'not-allowed' : 'pointer',
                                                    opacity: formData.recurringEnd !== 'until' ? 0.5 : 1
                                                }}
                                            />
                                        </label>

                                        {/* Never (infinite) */}
                                        <label style={{ display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer' }}>
                                            <input
                                                type="radio"
                                                name="recurringEnd"
                                                value="never"
                                                checked={formData.recurringEnd === 'never'}
                                                onChange={(e) => setFormData({...formData, recurringEnd: e.target.value})}
                                                style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                            />
                                            <span style={{ fontSize: '14px', fontWeight: '500', color: '#333' }}>
                                                Never (infinite)
                                            </span>
                                        </label>
                                    </div>

                                    {/* Warning for "Never" */}
                                    {formData.recurringEnd === 'never' && (
                                        <div style={{
                                            marginTop: '12px',
                                            padding: '12px',
                                            background: '#fff3cd',
                                            border: '2px solid #ffc107',
                                            borderRadius: '8px',
                                            fontSize: '13px',
                                            color: '#856404',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '8px'
                                        }}>
                                            <span>⚠️</span>
                                            <span>This meeting will repeat forever until manually deleted. Consider setting an end date or occurrence limit.</span>
                                        </div>
                                    )}

                                    {/* Info for selected option */}
                                    {formData.recurringEnd === 'count' && formData.recurringCount && (
                                        <div style={{
                                            marginTop: '12px',
                                            padding: '10px 12px',
                                            background: '#f0f9ff',
                                            borderRadius: '8px',
                                            fontSize: '13px',
                                            color: '#0369a1'
                                        }}>
                                            ℹ️ This meeting will repeat {formData.recurring} {formData.recurringCount} times
                                        </div>
                                    )}

                                    {formData.recurringEnd === 'until' && formData.recurringUntil && (
                                        <div style={{
                                            marginTop: '12px',
                                            padding: '10px 12px',
                                            background: '#f0f9ff',
                                            borderRadius: '8px',
                                            fontSize: '13px',
                                            color: '#0369a1'
                                        }}>
                                            ℹ️ This meeting will repeat {formData.recurring} until {new Date(formData.recurringUntil).toLocaleDateString()}
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Meeting Type
                                </label>
                                <select
                                    value={formData.type}
                                    onChange={(e) => setFormData({...formData, type: e.target.value})}
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px',
                                        background: 'white'
                                    }}
                                >
                                    <option value="Group Session">Group Session</option>
                                    <option value="Progress Review">Progress Review</option>
                                    <option value="Educational">Educational</option>
                                    <option value="Group Therapy">Group Therapy</option>
                                    <option value="Special Topic">Special Topic</option>
                                    <option value="Check-in">Check-in</option>
                                </select>
                            </div>
                            
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Meeting Link
                                </label>
                                <input
                                    type="url"
                                    value={formData.meetingLink}
                                    onChange={(e) => setFormData({...formData, meetingLink: e.target.value})}
                                    placeholder={user?.googleConnected ? "Will auto-generate Google Meet link" : "https://zoom.us/j/..."}
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px'
                                    }}
                                />
                                {user?.googleConnected ? (
                                    <div style={{
                                        marginTop: '8px',
                                        padding: '10px 12px',
                                        background: '#f0fdf4',
                                        borderRadius: '8px',
                                        fontSize: '13px',
                                        color: '#166534',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px'
                                    }}>
                                        <span>✓</span>
                                        <span>Google Meet link will be generated automatically when you save</span>
                                    </div>
                                ) : (
                                    <div style={{
                                        marginTop: '8px',
                                        padding: '10px 12px',
                                        background: '#fef9c3',
                                        borderRadius: '8px',
                                        fontSize: '13px',
                                        color: '#854d0e',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px'
                                    }}>
                                        <span>⚠️</span>
                                        <span>Connect Google Services in your Profile to auto-generate Meet links</span>
                                    </div>
                                )}
                            </div>
                            
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer' }}>
                                    <input
                                        type="checkbox"
                                        checked={formData.isGlobal}
                                        onChange={(e) => setFormData({...formData, isGlobal: e.target.checked})}
                                        style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                    />
                                    <span style={{ fontSize: '14px', fontWeight: '500', color: '#333' }}>
                                        Invite all PIRs (Global Meeting / Drop-In Hours)
                                    </span>
                                </label>
                            </div>
                            
                            {!formData.isGlobal && (
                                <div style={{ marginBottom: '20px' }}>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        Select PIRs to Invite
                                    </label>
                                    <div style={{ display: 'flex', gap: '10px', marginBottom: '10px' }}>
                                        <button 
                                            type="button"
                                            onClick={selectAllPIRs}
                                            style={{
                                                padding: '6px 12px',
                                                background: '#0077CC',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '6px',
                                                cursor: 'pointer',
                                                fontSize: '13px',
                                                fontWeight: '500'
                                            }}
                                        >
                                            Select All
                                        </button>
                                        <button 
                                            type="button"
                                            onClick={clearSelection}
                                            style={{
                                                padding: '6px 12px',
                                                background: '#6c757d',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '6px',
                                                cursor: 'pointer',
                                                fontSize: '13px',
                                                fontWeight: '500'
                                            }}
                                        >
                                            Clear All
                                        </button>
                                        <span style={{ fontSize: '13px', color: '#666', lineHeight: '32px' }}>
                                            {selectedPIRs.length} selected
                                        </span>
                                    </div>
                                    <div style={{
                                        maxHeight: '200px',
                                        overflowY: 'auto',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        padding: '10px'
                                    }}>
                                        {loading ? (
                                            <div style={{ textAlign: 'center', padding: '20px', color: '#999' }}>
                                                Loading PIRs...
                                            </div>
                                        ) : allPIRs.length > 0 ? (
                                            allPIRs.map(pir => (
                                                <label key={pir.id} style={{
                                                    display: 'block',
                                                    padding: '8px',
                                                    cursor: 'pointer',
                                                    background: selectedPIRs.includes(pir.id) ? '#e3f2fd' : 'transparent',
                                                    borderRadius: '6px',
                                                    marginBottom: '4px',
                                                    transition: 'background 0.2s'
                                                }}>
                                                    <input
                                                        type="checkbox"
                                                        checked={selectedPIRs.includes(pir.id)}
                                                        onChange={() => handlePIRSelection(pir.id)}
                                                        style={{ marginRight: '10px', width: '16px', height: '16px', cursor: 'pointer' }}
                                                    />
                                                    <span style={{ fontSize: '14px' }}>
                                                        {pir.name} <span style={{ color: '#999', fontSize: '12px' }}>({pir.email})</span>
                                                    </span>
                                                </label>
                                            ))
                                        ) : (
                                            <div style={{ color: '#999', textAlign: 'center', padding: '20px' }}>
                                                No PIRs available
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                            
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Meeting Notes
                                </label>
                                <textarea
                                    value={formData.notes}
                                    onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                    placeholder="Topics to cover, preparation needed, etc."
                                    rows="3"
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px',
                                        fontFamily: 'inherit',
                                        resize: 'vertical'
                                    }}
                                />
                            </div>
                        </>
                    )}
                    
                    <div style={{ display: 'flex', gap: '10px', marginTop: '25px' }}>
                        <button
                            type="button"
                            onClick={onClose}
                            style={{
                                flex: 1,
                                padding: '12px',
                                background: '#6c757d',
                                color: 'white',
                                border: 'none',
                                borderRadius: '10px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '600'
                            }}
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            style={{
                                flex: 2,
                                padding: '12px',
                                background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '10px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '600'
                            }}
                        >
                            {item ? 'Update' : 'Create'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
}

// ATTENDANCE MODAL
function AttendanceModal({ meeting, onClose, handleRecordAttendance }) {
    const [attendanceData, setAttendanceData] = useState({});
    const [loading, setLoading] = useState(true);
    const [participants, setParticipants] = useState([]);

    useEffect(() => {
        loadAttendance();
    }, []);

    const loadAttendance = async () => {
        try {
            // Load PIRs
            let pirIds = meeting.assignedPIRs || [];
            
            if (meeting.isGlobal) {
                const pirsSnap = await db.collection('users')
                    .where('role', '==', 'pir')
                    .get();
                pirIds = pirsSnap.docs.map(doc => doc.id);
            }

            const pirData = [];
            for (const pirId of pirIds) {
                const pirDoc = await db.collection('users').doc(pirId).get();
                if (pirDoc.exists) {
                    const data = pirDoc.data();
                    pirData.push({
                        id: pirId,
                        name: data.displayName || data.email
                    });
                }
            }
            setParticipants(pirData);

            // Load existing attendance
            const attendanceSnap = await db.collection('meetingAttendance')
                .where('meetingId', '==', meeting.id)
                .get();

            const attendance = {};
            attendanceSnap.forEach(doc => {
                const data = doc.data();
                attendance[data.pirId] = data.status;
            });
            setAttendanceData(attendance);

        } catch (error) {
            console.error('Error loading attendance:', error);
        } finally {
            setLoading(false);
        }
    };

    const handleStatusChange = async (pirId, status) => {
        try {
            await handleRecordAttendance(meeting.id, pirId, status);
            setAttendanceData(prev => ({ ...prev, [pirId]: status }));
        } catch (error) {
            console.error('Error updating attendance:', error);
        }
    };

    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1500,
            padding: '20px',
            animation: 'fadeIn 0.2s'
        }}>
            <div style={{
                background: 'white',
                borderRadius: '20px',
                maxWidth: '600px',
                width: '100%',
                maxHeight: '90vh',
                overflow: 'auto',
                boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
                animation: 'slideUp 0.3s'
            }}>
                {/* Header */}
                <div style={{
                    background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                    padding: '25px 30px',
                    borderRadius: '20px 20px 0 0',
                    color: 'white',
                    position: 'sticky',
                    top: 0,
                    zIndex: 1
                }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div>
                            <h3 style={{ margin: '0 0 5px 0', fontSize: '24px' }}>Meeting Attendance</h3>
                            <div style={{ fontSize: '14px', opacity: 0.9 }}>
                                {meeting.meetingTitle}
                            </div>
                        </div>
                        <button 
                            onClick={onClose}
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                border: 'none',
                                color: 'white',
                                fontSize: '24px',
                                width: '36px',
                                height: '36px',
                                borderRadius: '50%',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center'
                            }}
                        >
                            ×
                        </button>
                    </div>
                </div>

                {/* Content */}
                <div style={{ padding: '30px' }}>
                    {loading ? (
                        <div style={{ textAlign: 'center', padding: '40px', color: '#999' }}>
                            Loading participants...
                        </div>
                    ) : participants.length > 0 ? (
                        <div style={{ display: 'grid', gap: '12px' }}>
                            {participants.map(pir => (
                                <div key={pir.id} style={{
                                    padding: '15px',
                                    background: '#f8f9fa',
                                    borderRadius: '10px',
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center'
                                }}>
                                    <div style={{ fontWeight: '600', color: '#333' }}>
                                        {pir.name}
                                    </div>
                                    <div style={{ display: 'flex', gap: '8px' }}>
                                        <button
                                            onClick={() => handleStatusChange(pir.id, 'present')}
                                            style={{
                                                padding: '6px 12px',
                                                background: attendanceData[pir.id] === 'present' ? '#00A86B' : 'white',
                                                color: attendanceData[pir.id] === 'present' ? 'white' : '#333',
                                                border: '2px solid #00A86B',
                                                borderRadius: '6px',
                                                cursor: 'pointer',
                                                fontSize: '13px',
                                                fontWeight: '500'
                                            }}
                                        >
                                            Present
                                        </button>
                                        <button
                                            onClick={() => handleStatusChange(pir.id, 'absent')}
                                            style={{
                                                padding: '6px 12px',
                                                background: attendanceData[pir.id] === 'absent' ? '#f44336' : 'white',
                                                color: attendanceData[pir.id] === 'absent' ? 'white' : '#333',
                                                border: '2px solid #f44336',
                                                borderRadius: '6px',
                                                cursor: 'pointer',
                                                fontSize: '13px',
                                                fontWeight: '500'
                                            }}
                                        >
                                            Absent
                                        </button>
                                        <button
                                            onClick={() => handleStatusChange(pir.id, 'excused')}
                                            style={{
                                                padding: '6px 12px',
                                                background: attendanceData[pir.id] === 'excused' ? '#FFC107' : 'white',
                                                color: attendanceData[pir.id] === 'excused' ? 'white' : '#333',
                                                border: '2px solid #FFC107',
                                                borderRadius: '6px',
                                                cursor: 'pointer',
                                                fontSize: '13px',
                                                fontWeight: '500'
                                            }}
                                        >
                                            Excused
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div style={{ textAlign: 'center', padding: '40px', color: '#999' }}>
                            No participants for this meeting
                        </div>
                    )}

                    <button
                        onClick={onClose}
                        style={{
                            width: '100%',
                            marginTop: '20px',
                            padding: '12px',
                            background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                            color: 'white',
                            border: 'none',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '600'
                        }}
                    >
                        Done
                    </button>
                </div>
            </div>
        </div>
    );
}
    // PIR-Centric Goals & Objectives Management View with Enhanced UI - FIXED VERSION

function CommunityApp() {
    const [searchQuery, setSearchQuery] = useState('');
    const [user, setUser] = useState(null);
    useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged(async (firebaseUser) => {
            if (firebaseUser) {
                const userDoc = await db.collection('users').doc(firebaseUser.uid).get();
                setUser({ uid: firebaseUser.uid, ...userDoc.data() });
            } else {
                window.location.href = '/';
            }
        });
        return unsubscribe;
    }, []);
    if (!user) {
        return <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '100vh' }}><div className="loading-spinner"></div></div>;
    }
    return (
        <div style={{ display: 'flex', minHeight: '100vh' }}>
            <Sidebar activePage="community" />
            <div style={{ flex: 1, marginLeft: '280px' }}>
                <Topbar user={user} searchQuery={searchQuery} onSearchChange={setSearchQuery} />
                <div style={{ padding: '20px' }}>
                    <CommunityView searchQuery={searchQuery} user={user} />
                </div>
            </div>
        </div>
    );
}
ReactDOM.render(<CommunityApp />, document.getElementById('root'));
})();
</script>
</body>
</html>
