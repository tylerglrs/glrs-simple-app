<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - GLRS Admin</title>

    <!-- Favicon - Lucide Dashboard Icon -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24' fill='none' stroke='%230077CC' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='3' width='7' height='9'/%3E%3Crect x='14' y='3' width='7' height='5'/%3E%3Crect x='14' y='12' width='7' height='9'/%3E%3Crect x='3' y='16' width='7' height='5'/%3E%3C/svg%3E">

    <!-- Shared Styles -->
    <link rel="stylesheet" href="/admin/shared/styles.css">

    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <!-- Shared Components -->
    <script src="/admin/shared/firebase.js"></script>
    <script src="/admin/shared/auth.js"></script>
    <script src="/admin/shared/permissions.js"></script>
    <script src="/admin/shared/utils.js"></script>
    <script src="/admin/shared/state.js?v=2"></script>
    <script src="/admin/shared/icons.js"></script>
    <script type="text/babel" src="/admin/shared/navigation.js?v=8"></script>
    <script type="text/babel" src="/admin/shared/header.js?v=1"></script>
    <script type="text/babel" src="/admin/shared/StatusBanner.js"></script>

    <script type="text/babel">
        // Wait for Firebase to initialize before running
(function initPage() {
    if (!window.FIREBASE_READY || !window.auth || !window.db) {
        console.log('Waiting for Firebase to initialize...');
        setTimeout(initPage, 50);
        return;
    }

    const { useState, useEffect, useRef, useMemo, useCallback } = React;
    const { auth, db, storage, CURRENT_TENANT, logAudit } = window;

// ========== ENHANCED GOLDEN THREAD MODAL - COMPLETE VERSION ==========
const CreateGoalModal = ({ type, selectedPIR, selectedParent, currentUser, onSubmit, onClose }) => {
    const [goldenThreadData, setGoldenThreadData] = useState({
        goals: [
            {
                title: '',
                description: '',
                dueDate: '',
                objectives: [
                    { title: '', dueDate: '', assignments: [{ title: '', description: '', dueDate: '' }] },
                    { title: '', dueDate: '', assignments: [{ title: '', description: '', dueDate: '' }] }
                ]
            },
            {
                title: '',
                description: '',
                dueDate: '',
                objectives: [
                    { title: '', dueDate: '', assignments: [{ title: '', description: '', dueDate: '' }] },
                    { title: '', dueDate: '', assignments: [{ title: '', description: '', dueDate: '' }] }
                ]
            }
        ]
    });

    const [singleFormData, setSingleFormData] = useState({
        title: '',
        description: '',
        dueDate: '',
        targetDate: '',
        icon: 'target',
        goalId: selectedParent?.goalId || '',
        objectiveId: selectedParent?.id || ''
    });

    const addGoal = () => {
        setGoldenThreadData({
            ...goldenThreadData,
            goals: [...goldenThreadData.goals, {
                title: '',
                description: '',
                dueDate: '',
                objectives: [
                    { title: '', dueDate: '', assignments: [{ title: '', description: '', dueDate: '' }] }
                ]
            }]
        });
    };

    const addObjective = (goalIndex) => {
        const newGoals = [...goldenThreadData.goals];
        newGoals[goalIndex].objectives.push({
            title: '',
            dueDate: '',
            assignments: [{ title: '', description: '', dueDate: '' }]
        });
        setGoldenThreadData({ ...goldenThreadData, goals: newGoals });
    };

    const addAssignment = (goalIndex, objIndex) => {
        const newGoals = [...goldenThreadData.goals];
        newGoals[goalIndex].objectives[objIndex].assignments.push({
            title: '',
            description: '',
            dueDate: ''
        });
        setGoldenThreadData({ ...goldenThreadData, goals: newGoals });
    };

    const updateGoal = (index, field, value) => {
        const newGoals = [...goldenThreadData.goals];
        newGoals[index][field] = value;
        setGoldenThreadData({ ...goldenThreadData, goals: newGoals });
    };

    const updateObjective = (goalIndex, objIndex, field, value) => {
        const newGoals = [...goldenThreadData.goals];
        newGoals[goalIndex].objectives[objIndex][field] = value;
        setGoldenThreadData({ ...goldenThreadData, goals: newGoals });
    };

    const updateAssignment = (goalIndex, objIndex, assignIndex, field, value) => {
        const newGoals = [...goldenThreadData.goals];
        newGoals[goalIndex].objectives[objIndex].assignments[assignIndex][field] = value;
        setGoldenThreadData({ ...goldenThreadData, goals: newGoals });
    };

    const handleGoldenThreadSubmit = async () => {
        try {
            for (const goal of goldenThreadData.goals) {
                if (!goal.title) continue;

                const goalRef = await db.collection('goals').add({
                    tenantId: CURRENT_TENANT,
                    userId: selectedPIR.id,
                    title: goal.title,
                    description: goal.description,
                    dueDate: goal.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(goal.dueDate)) : null,
                    status: 'active',
                    createdBy: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                for (let i = 0; i < goal.objectives.length; i++) {
                    const objective = goal.objectives[i];
                    if (!objective.title) continue;

                    const objectiveRef = await db.collection('objectives').add({
                        tenantId: CURRENT_TENANT,
                        goalId: goalRef.id,
                        userId: selectedPIR.id,
                        title: objective.title,
                        order: i + 1,
                        dueDate: objective.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(objective.dueDate)) : null,
                        status: 'active',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    for (const assignment of objective.assignments) {
                        if (!assignment.title) continue;

                        await db.collection('assignments').add({
                            tenantId: CURRENT_TENANT,
                            goalId: goalRef.id,
                            objectiveId: objectiveRef.id,
                            userId: selectedPIR.id,
                            pirName: selectedPIR.displayName || selectedPIR.email,
                            coachId: currentUser.uid,
                            coachName: currentUser.displayName || currentUser.email,
                            title: assignment.title,
                            description: assignment.description,
                            dueDate: assignment.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(assignment.dueDate)) : null,
                            status: 'pending',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }
            }

            alert('Golden Thread created successfully!');
            onClose();
            window.location.reload();
        } catch (error) {
            console.error('Error creating golden thread:', error);
            alert('Failed to create golden thread');
        }
    };

    if (type === 'goldenThread') {
        return (
            <div className="modal-overlay" style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0,0,0,0.5)',
                display: 'flex',
                justifyContent: 'center',
                alignItems: 'center',
                zIndex: 2000,
                overflow: 'auto'
            }}>
                <div style={{
                    background: 'white',
                    borderRadius: '12px',
                    width: '90%',
                    maxWidth: '900px',
                    maxHeight: '90vh',
                    overflow: 'auto',
                    padding: '30px'
                }}>
                    <div style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        marginBottom: '20px'
                    }}>
                        <h2 style={{ margin: 0 }}>Create Golden Thread</h2>
                        <button
                            onClick={onClose}
                            style={{
                                background: 'none',
                                border: 'none',
                                fontSize: '24px',
                                cursor: 'pointer'
                            }}
                        >
                            ×
                        </button>
                    </div>

                    {goldenThreadData.goals.map((goal, goalIndex) => (
                        <div key={goalIndex} style={{
                            background: '#f8f9fa',
                            borderRadius: '8px',
                            padding: '20px',
                            marginBottom: '20px'
                        }}>
                            <h3 style={{ color: '#0077CC', marginTop: 0 }}>Goal {goalIndex + 1}</h3>
                            <input
                                type="text"
                                placeholder="Goal Title"
                                value={goal.title}
                                onChange={(e) => updateGoal(goalIndex, 'title', e.target.value)}
                                style={{
                                    width: '100%',
                                    padding: '10px',
                                    marginBottom: '10px',
                                    border: '1px solid #ddd',
                                    borderRadius: '6px'
                                }}
                            />
                            <textarea
                                placeholder="Goal Description"
                                value={goal.description}
                                onChange={(e) => updateGoal(goalIndex, 'description', e.target.value)}
                                style={{
                                    width: '100%',
                                    padding: '10px',
                                    marginBottom: '10px',
                                    border: '1px solid #ddd',
                                    borderRadius: '6px',
                                    minHeight: '60px'
                                }}
                            />
                            <input
                                type="date"
                                value={goal.dueDate}
                                onChange={(e) => updateGoal(goalIndex, 'dueDate', e.target.value)}
                                style={{
                                    padding: '10px',
                                    marginBottom: '20px',
                                    border: '1px solid #ddd',
                                    borderRadius: '6px'
                                }}
                            />

                            {goal.objectives.map((objective, objIndex) => (
                                <div key={objIndex} style={{
                                    background: 'white',
                                    borderLeft: '3px solid #0077CC',
                                    padding: '15px',
                                    marginLeft: '20px',
                                    marginBottom: '15px',
                                    borderRadius: '4px'
                                }}>
                                    <h4 style={{ color: '#555', marginTop: 0 }}>Objective {objIndex + 1}</h4>
                                    <input
                                        type="text"
                                        placeholder="Objective Title"
                                        value={objective.title}
                                        onChange={(e) => updateObjective(goalIndex, objIndex, 'title', e.target.value)}
                                        style={{
                                            width: '100%',
                                            padding: '8px',
                                            marginBottom: '8px',
                                            border: '1px solid #ddd',
                                            borderRadius: '4px'
                                        }}
                                    />
                                    <input
                                        type="date"
                                        value={objective.dueDate}
                                        onChange={(e) => updateObjective(goalIndex, objIndex, 'dueDate', e.target.value)}
                                        style={{
                                            padding: '8px',
                                            marginBottom: '15px',
                                            border: '1px solid #ddd',
                                            borderRadius: '4px'
                                        }}
                                    />

                                    {objective.assignments.map((assignment, assignIndex) => (
                                        <div key={assignIndex} style={{
                                            background: '#f8f9fa',
                                            padding: '10px',
                                            marginLeft: '20px',
                                            marginBottom: '8px',
                                            borderRadius: '4px'
                                        }}>
                                            <div style={{ color: '#777', fontSize: '0.9em', marginBottom: '5px' }}>
                                                Assignment {assignIndex + 1}
                                            </div>
                                            <input
                                                type="text"
                                                placeholder="Assignment Title"
                                                value={assignment.title}
                                                onChange={(e) => updateAssignment(goalIndex, objIndex, assignIndex, 'title', e.target.value)}
                                                style={{
                                                    width: '100%',
                                                    padding: '6px',
                                                    marginBottom: '6px',
                                                    border: '1px solid #ddd',
                                                    borderRadius: '4px'
                                                }}
                                            />
                                            <input
                                                type="text"
                                                placeholder="Assignment Description"
                                                value={assignment.description}
                                                onChange={(e) => updateAssignment(goalIndex, objIndex, assignIndex, 'description', e.target.value)}
                                                style={{
                                                    width: '100%',
                                                    padding: '6px',
                                                    marginBottom: '6px',
                                                    border: '1px solid #ddd',
                                                    borderRadius: '4px'
                                                }}
                                            />
                                            <input
                                                type="date"
                                                value={assignment.dueDate}
                                                onChange={(e) => updateAssignment(goalIndex, objIndex, assignIndex, 'dueDate', e.target.value)}
                                                style={{
                                                    padding: '6px',
                                                    border: '1px solid #ddd',
                                                    borderRadius: '4px'
                                                }}
                                            />
                                        </div>
                                    ))}

                                    <button
                                        onClick={() => addAssignment(goalIndex, objIndex)}
                                        style={{
                                            marginLeft: '20px',
                                            marginTop: '5px',
                                            background: '#9C27B0',
                                            border: 'none',
                                            borderRadius: '4px',
                                            color: 'white',
                                            padding: '6px 12px',
                                            cursor: 'pointer',
                                            fontSize: '0.85em'
                                        }}
                                    >
                                        + Add Assignment
                                    </button>
                                </div>
                            ))}

                            <button
                                onClick={() => addObjective(goalIndex)}
                                style={{
                                    marginLeft: '20px',
                                    background: '#00A86B',
                                    border: 'none',
                                    borderRadius: '4px',
                                    color: 'white',
                                    padding: '8px 16px',
                                    cursor: 'pointer'
                                }}
                            >
                                + Add Objective
                            </button>
                        </div>
                    ))}

                    <button
                        onClick={addGoal}
                        style={{
                            background: '#4682B4',
                            border: 'none',
                            borderRadius: '6px',
                            color: 'white',
                            padding: '10px 20px',
                            cursor: 'pointer',
                            marginBottom: '20px'
                        }}
                    >
                        + Add Another Goal
                    </button>

                    <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                        <button
                            onClick={onClose}
                            style={{
                                background: '#e0e0e0',
                                border: 'none',
                                borderRadius: '6px',
                                padding: '12px 24px',
                                cursor: 'pointer'
                            }}
                        >
                            Cancel
                        </button>
                        <button
                            onClick={handleGoldenThreadSubmit}
                            style={{
                                background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                border: 'none',
                                borderRadius: '6px',
                                color: 'white',
                                padding: '12px 24px',
                                cursor: 'pointer',
                                fontWeight: 'bold'
                            }}
                        >
                            Create Golden Thread
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // Regular single item creation forms
    return (
        <div className="modal-overlay" style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0,0,0,0.5)',
            display: 'flex',
            justifyContent: 'center',
            alignItems: 'center',
            zIndex: 2000
        }}>
            <div style={{
                background: 'white',
                borderRadius: '12px',
                width: '90%',
                maxWidth: '500px',
                padding: '30px'
            }}>
                <div style={{
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    marginBottom: '20px'
                }}>
                    <h2 style={{ margin: 0 }}>
                        {type === 'goal' && 'Add New Goal'}
                        {type === 'objective' && `Add Objective to: ${selectedParent?.title}`}
                        {type === 'assignment' && `Add Assignment to: ${selectedParent?.title}`}
                        {type === 'milestone' && 'Add Custom Milestone'}
                    </h2>
                    <button
                        onClick={onClose}
                        style={{
                            background: 'none',
                            border: 'none',
                            fontSize: '24px',
                            cursor: 'pointer'
                        }}
                    >
                        ×
                    </button>
                </div>

                <form onSubmit={(e) => {
                    e.preventDefault();
                    onSubmit({...singleFormData, ...selectedParent});
                }}>
                    <input
                        type="text"
                        placeholder="Title"
                        value={singleFormData.title}
                        onChange={(e) => setSingleFormData({...singleFormData, title: e.target.value})}
                        required
                        style={{
                            width: '100%',
                            padding: '10px',
                            marginBottom: '15px',
                            border: '1px solid #ddd',
                            borderRadius: '6px'
                        }}
                    />

                    {(type === 'goal' || type === 'assignment' || type === 'milestone') && (
                        <textarea
                            placeholder="Description"
                            value={singleFormData.description}
                            onChange={(e) => setSingleFormData({...singleFormData, description: e.target.value})}
                            style={{
                                width: '100%',
                                padding: '10px',
                                marginBottom: '15px',
                                border: '1px solid #ddd',
                                borderRadius: '6px',
                                minHeight: '80px'
                            }}
                        />
                    )}

                    <input
                        type="date"
                        value={singleFormData.dueDate || singleFormData.targetDate}
                        onChange={(e) => setSingleFormData({
                            ...singleFormData,
                            dueDate: e.target.value,
                            targetDate: e.target.value
                        })}
                        style={{
                            width: '100%',
                            padding: '10px',
                            marginBottom: '15px',
                            border: '1px solid #ddd',
                            borderRadius: '6px'
                        }}
                    />

                    <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                        <button
                            type="button"
                            onClick={onClose}
                            style={{
                                background: '#e0e0e0',
                                border: 'none',
                                borderRadius: '6px',
                                padding: '10px 20px',
                                cursor: 'pointer'
                            }}
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            style={{
                                background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                border: 'none',
                                borderRadius: '6px',
                                color: 'white',
                                padding: '10px 20px',
                                cursor: 'pointer',
                                fontWeight: 'bold'
                            }}
                        >
                            Create
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};

      // ========== COMPLETE ENHANCED PIR DETAIL MODAL - FULLY REFACTORED ==========
function UserDetailModal({ user, onClose, onUpdate }) {
    // Extract ID from user object
    const pirId = user?.id;
    
    // Core States
    const [pirData, setPirData] = useState(null);
    const [loading, setLoading] = useState(true);
    const [activeTab, setActiveTab] = useState('overview');
    
    // Data States
    const [activities, setActivities] = useState([]);
    const [availableCoaches, setAvailableCoaches] = useState([]);
    const [checkIns, setCheckIns] = useState([]);
    const [assignments, setAssignments] = useState([]);
    const [goals, setGoals] = useState([]);
    const [objectives, setObjectives] = useState([]);
    const [alerts, setAlerts] = useState([]);
    const [meetings, setMeetings] = useState([]);
    const [resources, setResources] = useState([]);
    const [milestones, setMilestones] = useState([]);
    const [messages, setMessages] = useState([]);
    const [supportGroups, setSupportGroups] = useState([]);
    const [pledges, setPledges] = useState([]);
    const [notifications, setNotifications] = useState([]);
    const [topicRooms, setTopicRooms] = useState([]);
    const [resourceProgress, setResourceProgress] = useState({});
    const [resourceNotes, setResourceNotes] = useState({});
    const [streakData, setStreakData] = useState({});
    const [complianceData, setComplianceData] = useState({});
    const [allMessages, setAllMessages] = useState([]);
    
    // UI States
    const [editing, setEditing] = useState(false);
    const [editData, setEditData] = useState({});
    const [chartData, setChartData] = useState(null);
    const [expandedGoals, setExpandedGoals] = useState({});
    const [expandedObjectives, setExpandedObjectives] = useState({});
    const [showAddGoal, setShowAddGoal] = useState(false);
    const [showAddObjective, setShowAddObjective] = useState(false);
    const [showAddAssignment, setShowAddAssignment] = useState(false);
    const [selectedGoalId, setSelectedGoalId] = useState(null);
    const [selectedObjectiveId, setSelectedObjectiveId] = useState(null);
    const [showAssignResource, setShowAssignResource] = useState(false);
    const [showCreateResource, setShowCreateResource] = useState(false);
    const [showGoldenThread, setShowGoldenThread] = useState(false);
    const [selectedGoalForObjective, setSelectedGoalForObjective] = useState(null);
    const [selectedObjectiveForAssignment, setSelectedObjectiveForAssignment] = useState(null);
    
    // Chart refs
    const moodChartRef = useRef(null);
    const cravingChartRef = useRef(null);
    const anxietyChartRef = useRef(null);
    const sleepChartRef = useRef(null);

    // ========== LOAD DATA ON MOUNT ==========
    useEffect(() => {
        if (pirId) {
            loadCompletePIRData();
        }
    }, [pirId]);

    const loadCompletePIRData = async () => {
        try {
            setLoading(true);
            
            const userDoc = await db.collection('users').doc(pirId).get();
            if (!userDoc.exists) {
                alert('PIR not found');
                onClose();
                return;
            }
            
            const userData = { id: userDoc.id, ...userDoc.data() };
            
            // Fix timezone issues for dates
            userData.sobrietyDays = calculateSobrietyDaysFixed(userData.sobrietyDate);
            userData.accountAge = daysSince(userData.createdAt);
            userData.lastLoginFormatted = await getLastLoginFormatted(pirId, userData);
            userData.firstLoginFormatted = formatFirstLogin(userData.createdAt);
            userData.moneySaved = userData.sobrietyDays * (userData.dailyCost || 20);
            
            setPirData(userData);
            setEditData(userData);
            
            // Load all related data in parallel
            await Promise.all([
                loadActivitiesData(),
                loadCheckInsData(),
                loadAssignmentsData(),
                loadGoalsData(),
                loadObjectivesData(),
                loadAlertsData(),
                loadMeetingsData(),
                loadResourcesData(),
                loadMilestonesData(),
                loadMessagesData(),
                loadAllUserMessages(),
                loadSupportGroupsData(),
                loadPledgesData(),
                loadNotificationsData(),
                loadTopicRoomsData(),
                loadResourceProgressData(),
                loadStreakData(),
                loadComplianceDataFixed(userData.createdAt),
                loadProgressChartData(),
                loadAvailableCoaches()
            ]);
            
        } catch (error) {
            console.error('Error loading PIR data:', error);
            alert('Failed to load PIR data: ' + error.message);
        } finally {
            setLoading(false);
        }
    };

    // ========== CALCULATION FUNCTIONS ==========
    const calculateSobrietyDaysFixed = (sobrietyDate) => {
        if (!sobrietyDate) return 0;
        
        let year, month, day;
        
        if (typeof sobrietyDate === 'string' && sobrietyDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
            [year, month, day] = sobrietyDate.split('-').map(Number);
        } else if (sobrietyDate.toDate) {
            const date = sobrietyDate.toDate();
            year = date.getFullYear();
            month = date.getMonth() + 1;
            day = date.getDate();
        } else if (sobrietyDate.seconds) {
            const date = new Date(sobrietyDate.seconds * 1000);
            year = date.getFullYear();
            month = date.getMonth() + 1;
            day = date.getDate();
        } else {
            const date = new Date(sobrietyDate);
            year = date.getFullYear();
            month = date.getMonth() + 1;
            day = date.getDate();
        }
        
        const today = new Date();
        const todayYear = today.getFullYear();
        const todayMonth = today.getMonth() + 1;
        const todayDay = today.getDate();
        
        const startDate = new Date(year, month - 1, day, 0, 0, 0, 0);
        const endDate = new Date(todayYear, todayMonth - 1, todayDay, 0, 0, 0, 0);
        
        const millisecondsDiff = endDate.getTime() - startDate.getTime();
        const complete24HourPeriods = Math.floor(millisecondsDiff / (1000 * 60 * 60 * 24));
        const totalDays = complete24HourPeriods + 2;
        
        return Math.max(1, totalDays);
    };

    const getLastLoginFormatted = async (userId, userData) => {
        try {
            if (userData.lastLogin) {
                const lastLogin = userData.lastLogin.toDate ? userData.lastLogin.toDate() : new Date(userData.lastLogin);
                return lastLogin.toLocaleString('en-US', { 
                    month: 'short', day: 'numeric', year: 'numeric',
                    hour: 'numeric', minute: '2-digit', hour12: true 
                });
            }
            
            const loginActivity = await db.collection('activities')
                .where('userId', '==', userId)
                .where('type', '==', 'login')
                .orderBy('createdAt', 'desc')
                .limit(1)
                .get();
            
            if (!loginActivity.empty) {
                const lastLogin = loginActivity.docs[0].data().createdAt.toDate();
                return lastLogin.toLocaleString('en-US', { 
                    month: 'short', day: 'numeric', year: 'numeric',
                    hour: 'numeric', minute: '2-digit', hour12: true 
                });
            }
            
            return 'No login recorded';
        } catch (error) {
            console.error('Error getting last login:', error);
            return 'Unable to determine';
        }
    };

    const formatFirstLogin = (createdAt) => {
        if (!createdAt) return 'Unknown';
        const date = createdAt.toDate ? createdAt.toDate() : new Date(createdAt);
        return date.toLocaleString('en-US', { 
            month: 'short', day: 'numeric', year: 'numeric'
        });
    };

    const daysSince = (date) => {
        if (!date) return 0;
        const start = date?.toDate ? date.toDate() : new Date(date);
        const today = new Date();
        const diffTime = Math.abs(today - start);
        return Math.floor(diffTime / (1000 * 60 * 60 * 24));
    };

    const formatDate = (date) => {
        if (!date) return 'N/A';
        
        let d;
        if (date?.toDate) {
            d = date.toDate();
        } else if (date?.seconds) {
            d = new Date(date.seconds * 1000);
        } else if (typeof date === 'string') {
            if (!date.includes('T')) {
                d = new Date(date + 'T00:00:00');
            } else {
                d = new Date(date);
            }
        } else {
            d = new Date(date);
        }
        
        return d.toLocaleDateString('en-US', {
            year: 'numeric', month: 'long', day: 'numeric'
        });
    };

    const formatDateTime = (date) => {
        if (!date) return 'N/A';
        const d = date?.toDate ? date.toDate() : new Date(date);
        return d.toLocaleString();
    };

    const formatTimeAgo = (date) => {
        if (!date) return 'Never';
        const d = date?.toDate ? date.toDate() : new Date(date);
        const now = new Date();
        const diff = Math.floor((now - d) / 1000);

        if (diff < 60) return 'Just now';
        if (diff < 3600) return Math.floor(diff / 60) + ' minutes ago';
        if (diff < 86400) return Math.floor(diff / 3600) + ' hours ago';
        if (diff < 604800) return Math.floor(diff / 86400) + ' days ago';
        return d.toLocaleDateString();
    };

    // ========== ICON HELPER FUNCTIONS ==========

    // Map milestone icon keys to Lucide icons
    const getMilestoneIcon = (iconKey, options = {}) => {
        const { size = 32, color = 'currentColor' } = options;
        const iconMap = {
            'trophy': () => AdminIcons.Trophy({ size, color }),
            'star': () => AdminIcons.Star({ size, color }),
            'award': () => AdminIcons.Award({ size, color }),
            'target': () => AdminIcons.Target({ size, color }),
            'sunrise': () => AdminIcons.Sunrise({ size, color }),
            'calendar': () => AdminIcons.Calendar({ size, color }),
            'party': () => AdminIcons.PartyPopper({ size, color }),
            'diamond': () => AdminIcons.Award({ size, color }),
            'crown': () => AdminIcons.Award({ size, color }),
            'flame': () => AdminIcons.Flame({ size, color }),
            'flower': () => AdminIcons.Award({ size, color }),
            'rainbow': () => AdminIcons.Award({ size, color })
        };
        return iconMap[iconKey] ? iconMap[iconKey]() : AdminIcons.Award({ size, color });
    };

    // Note: getActivityIcon defined later in file (line ~1462) with more activity types

    // ========== DATA LOADING FUNCTIONS ==========
    const loadAvailableCoaches = async () => {
        try {
            const coachesSnap = await db.collection('users')
                .where('role', 'in', ['admin', 'coach'])
                .get();
            
            const coachesList = [];
            coachesSnap.forEach(doc => {
                coachesList.push({ id: doc.id, ...doc.data() });
            });
            setAvailableCoaches(coachesList);
        } catch (error) {
            console.error('Error loading coaches:', error);
            setAvailableCoaches([]);
        }
    };

    const loadComplianceDataFixed = async (accountCreatedAt) => {
        try {
            const accountDate = accountCreatedAt?.toDate ? accountCreatedAt.toDate() : new Date(accountCreatedAt);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            accountDate.setHours(0, 0, 0, 0);
            
            const daysSinceCreation = Math.floor((today - accountDate) / (1000 * 60 * 60 * 24));
            const daysToCheck = Math.min(daysSinceCreation, 30);
            
            if (daysToCheck <= 0) {
                setComplianceData({
                    morningRate: 0, eveningRate: 0, assignmentRate: 0,
                    totalCheckIns: 0, daysTracked: 0, recentCheckIns: []
                });
                return;
            }
            
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - daysToCheck);
            startDate.setHours(0, 0, 0, 0);
            
            const allCheckInsSnap = await db.collection('checkIns')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .get();
            
            const complianceCheckInsSnap = await db.collection('checkIns')
                .where('userId', '==', pirId)
                .where('createdAt', '>=', startDate)
                .get();
            
            const allCheckInsData = [];
            allCheckInsSnap.forEach(doc => {
                const data = doc.data();
                allCheckInsData.push({
                    id: doc.id, ...data,
                    date: data.createdAt?.toDate ? data.createdAt.toDate() : new Date(data.createdAt)
                });
            });
            
            let morningCount = 0, eveningCount = 0;
            const dateMap = new Map();
            
            complianceCheckInsSnap.forEach(doc => {
                const data = doc.data();
                const checkInDate = data.createdAt?.toDate ? data.createdAt.toDate() : new Date(data.createdAt);
                const dateKey = checkInDate.toDateString();
                
                if (!dateMap.has(dateKey)) {
                    dateMap.set(dateKey, { morning: false, evening: false });
                }
                
                if (data.morningData && !dateMap.get(dateKey).morning) {
                    morningCount++;
                    dateMap.get(dateKey).morning = true;
                }
                if (data.eveningData && !dateMap.get(dateKey).evening) {
                    eveningCount++;
                    dateMap.get(dateKey).evening = true;
                }
            });
            
            const completedAssignments = assignments.filter(a => a.status === 'completed').length;
            const totalAssignments = assignments.length;
            
            const morningRate = Math.min(100, Math.round((morningCount / daysToCheck) * 100));
            const eveningRate = Math.min(100, Math.round((eveningCount / daysToCheck) * 100));
            const assignmentRate = totalAssignments > 0 ? 
                Math.min(100, Math.round((completedAssignments / totalAssignments) * 100)) : 0;
            
            setComplianceData({
                morningRate, eveningRate, assignmentRate,
                totalCheckIns: morningCount + eveningCount,
                daysTracked: daysToCheck,
                recentCheckIns: allCheckInsData
            });
            
            setCheckIns(allCheckInsData);
            
        } catch (error) {
            console.error('Error calculating compliance:', error);
            setComplianceData({
                morningRate: 0, eveningRate: 0, assignmentRate: 0,
                totalCheckIns: 0, daysTracked: 0, recentCheckIns: []
            });
        }
    };

    const loadMilestonesData = async () => {
        try {
            const milestonesList = [];
            
            try {
                const milestonesSnap = await db.collection('milestones')
                    .where('userId', '==', pirId)
                    .get();
                
                milestonesSnap.forEach(doc => {
                    milestonesList.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.error('Error loading custom milestones:', error);
            }
            
            if (pirData?.sobrietyDate) {
                const standardMilestones = getStandardMilestones(pirData.sobrietyDate);
                milestonesList.push(...standardMilestones);
            }
            
            setMilestones(milestonesList);
        } catch (error) {
            console.error('Error loading milestones:', error);
            setMilestones([]);
        }
    };

    const getStandardMilestones = (sobrietyDate) => {
        const milestones = [
            { days: 1, title: '24 Hours', icon: 'sunrise', description: 'First day of recovery' },
            { days: 7, title: 'One Week', icon: 'calendar', description: 'A week of sobriety' },
            { days: 30, title: 'One Month', icon: 'calendar', description: 'First month milestone' },
            { days: 60, title: 'Two Months', icon: 'calendar', description: 'Two months strong' },
            { days: 90, title: 'Three Months', icon: 'trophy', description: 'Quarter year achieved' },
            { days: 180, title: 'Six Months', icon: 'star', description: 'Half year milestone' },
            { days: 365, title: 'One Year', icon: 'party', description: 'Full year of recovery' },
            { days: 730, title: 'Two Years', icon: 'party', description: 'Two years of sobriety' }
        ];
        
        const sobrietyDateObj = sobrietyDate?.toDate ? sobrietyDate.toDate() : new Date(sobrietyDate);
        const today = new Date();
        
        return milestones.map(m => {
            const targetDate = new Date(sobrietyDateObj);
            targetDate.setDate(targetDate.getDate() + m.days);
            const achieved = today >= targetDate;
            const daysUntil = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
            
            return {
                ...m, targetDate, achieved,
                daysUntil: achieved ? 0 : daysUntil,
                type: 'standard',
                id: `standard-${m.days}`
            };
        });
    };

    const loadActivitiesData = async () => {
        try {
            const activitiesSnap = await db.collection('activities')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .limit(100)
                .get();
            
            const activitiesList = [];
            activitiesSnap.forEach(doc => {
                activitiesList.push({ id: doc.id, ...doc.data() });
            });
            setActivities(activitiesList);
        } catch (error) {
            console.error('Error loading activities:', error);
            setActivities([]);
        }
    };

    const loadCheckInsData = async () => {
        try {
            const checkInsSnap = await db.collection('checkIns')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .limit(60)
                .get();
            
            const checkInsList = [];
            checkInsSnap.forEach(doc => {
                checkInsList.push({ id: doc.id, ...doc.data() });
            });
            setCheckIns(checkInsList);
        } catch (error) {
            console.error('Error loading check-ins:', error);
            setCheckIns([]);
        }
    };

    const loadAssignmentsData = async () => {
        try {
            const assignmentsSnap = await db.collection('assignments')
                .where('userId', '==', pirId)
                .get();
            
            const assignmentsList = [];
            assignmentsSnap.forEach(doc => {
                assignmentsList.push({ id: doc.id, ...doc.data() });
            });
            setAssignments(assignmentsList);
        } catch (error) {
            console.error('Error loading assignments:', error);
            setAssignments([]);
        }
    };

    const loadGoalsData = async () => {
        try {
            const goalsSnap = await db.collection('goals')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .get();
            
            const goalsList = [];
            for (const doc of goalsSnap.docs) {
                const goalData = { id: doc.id, ...doc.data() };
                goalData.progress = await calculateGoalProgress(doc.id);
                goalsList.push(goalData);
            }
            setGoals(goalsList);
        } catch (error) {
            console.error('Error loading goals:', error);
            setGoals([]);
        }
    };

    const loadObjectivesData = async () => {
        try {
            const objectivesSnap = await db.collection('objectives')
                .where('userId', '==', pirId)
                .orderBy('order', 'asc')
                .get();
            
            const objectivesList = [];
            objectivesSnap.forEach(doc => {
                objectivesList.push({ id: doc.id, ...doc.data() });
            });
            setObjectives(objectivesList);
        } catch (error) {
            console.error('Error loading objectives:', error);
            setObjectives([]);
        }
    };

    const loadAlertsData = async () => {
        try {
            const alertsSnap = await db.collection('alerts')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .limit(50)
                .get();
            
            const alertsList = [];
            alertsSnap.forEach(doc => {
                alertsList.push({ id: doc.id, ...doc.data() });
            });
            setAlerts(alertsList);
        } catch (error) {
            console.error('Error loading alerts:', error);
            setAlerts([]);
        }
    };

    const loadMeetingsData = async () => {
        try {
            const meetingsSnap = await db.collection('meetings')
                .where('pirId', '==', pirId)
                .orderBy('scheduledTime', 'desc')
                .get();
            
            const meetingsList = [];
            meetingsSnap.forEach(doc => {
                meetingsList.push({ id: doc.id, ...doc.data() });
            });
            setMeetings(meetingsList);
        } catch (error) {
            console.error('Error loading meetings:', error);
            setMeetings([]);
        }
    };

    const loadResourcesData = async () => {
        try {
            const resourcesList = [];
            
            try {
                const assignedResources = await db.collection('resources')
                    .where('assignedTo', 'array-contains', pirId)
                    .get();
                
                assignedResources.forEach(doc => {
                    resourcesList.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.log('Array-contains query failed, trying alternative');
            }
            
            try {
                const globalResources = await db.collection('resources')
                    .where('isGlobal', '==', true)
                    .get();
                
                globalResources.forEach(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    if (!resourcesList.find(r => r.id === doc.id)) {
                        resourcesList.push(data);
                    }
                });
            } catch (error) {
                console.log('Global resources query failed');
            }
            
            setResources(resourcesList);
        } catch (error) {
            console.error('Error loading resources:', error);
            setResources([]);
        }
    };

    const loadMessagesData = async () => {
        try {
            const messagesSnap = await db.collection('messages')
                .where('senderId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .limit(50)
                .get();
            
            const messagesList = [];
            messagesSnap.forEach(doc => {
                messagesList.push({ id: doc.id, ...doc.data() });
            });
            setMessages(messagesList);
        } catch (error) {
            console.error('Error loading messages:', error);
            setMessages([]);
        }
    };

    const loadAllUserMessages = async () => {
        try {
            const messagesData = [];
            
            try {
                const directMessages = await db.collection('messages')
                    .where('senderId', '==', pirId)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                directMessages.forEach(doc => {
                    messagesData.push({ id: doc.id, ...doc.data(), type: 'direct' });
                });
            } catch (error) {
                console.log('Error loading direct messages:', error);
            }
            
            try {
                const receivedMessages = await db.collection('messages')
                    .where('userId', '==', pirId)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                receivedMessages.forEach(doc => {
                    const data = doc.data();
                    if (data.senderId === pirId) {
                        messagesData.push({ id: doc.id, ...data, type: 'direct' });
                    }
                });
            } catch (error) {
                console.log('Error loading received messages:', error);
            }
            
            try {
                const communityMessages = await db.collection('glrsChat')
                    .where('senderId', '==', pirId)
                    .orderBy('createdAt', 'desc')
                    .limit(50)
                    .get();
                
                communityMessages.forEach(doc => {
                    messagesData.push({ id: doc.id, ...doc.data(), type: 'community' });
                });
            } catch (error) {
                console.log('Community chat collection may not exist:', error);
            }
            
            try {
                const topicMessages = await db.collection('topicRoomMessages')
                    .where('senderId', '==', pirId)
                    .orderBy('createdAt', 'desc')
                    .limit(50)
                    .get();
                
                topicMessages.forEach(doc => {
                    messagesData.push({ id: doc.id, ...doc.data(), type: 'topic' });
                });
            } catch (error) {
                console.log('Topic room messages may not exist:', error);
            }
            
            messagesData.sort((a, b) => {
                const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
                const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
                return dateB - dateA;
            });
            
            setAllMessages(messagesData);
            
        } catch (error) {
            console.error('Error loading user messages:', error);
            setAllMessages([]);
        }
    };

    const loadSupportGroupsData = async () => {
        try {
            const supportGroupsSnap = await db.collection('supportGroups')
                .where('active', '==', true)
                .get();
            
            const supportGroupsList = [];
            supportGroupsSnap.forEach(doc => {
                supportGroupsList.push({ id: doc.id, ...doc.data() });
            });
            setSupportGroups(supportGroupsList);
        } catch (error) {
            console.error('Error loading support groups:', error);
            setSupportGroups([]);
        }
    };

    const loadPledgesData = async () => {
        try {
            const pledgesSnap = await db.collection('pledges')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .limit(30)
                .get();
            
            const pledgesList = [];
            pledgesSnap.forEach(doc => {
                pledgesList.push({ id: doc.id, ...doc.data() });
            });
            setPledges(pledgesList);
        } catch (error) {
            console.error('Error loading pledges:', error);
            setPledges([]);
        }
    };

    const loadNotificationsData = async () => {
        try {
            const notificationsSnap = await db.collection('notifications')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .limit(50)
                .get();
            
            const notificationsList = [];
            notificationsSnap.forEach(doc => {
                notificationsList.push({ id: doc.id, ...doc.data() });
            });
            setNotifications(notificationsList);
        } catch (error) {
            console.error('Error loading notifications:', error);
            setNotifications([]);
        }
    };

    const loadTopicRoomsData = async () => {
        try {
            const topicRoomsSnap = await db.collection('topicRooms').get();
            
            const topicRoomsList = [];
            topicRoomsSnap.forEach(doc => {
                topicRoomsList.push({ id: doc.id, ...doc.data() });
            });
            setTopicRooms(topicRoomsList);
        } catch (error) {
            console.error('Error loading topic rooms:', error);
            setTopicRooms([]);
        }
    };

    const loadResourceProgressData = async () => {
        try {
            const progressDoc = await db.collection('users').doc(pirId)
                .collection('resourcePreferences').doc('progress').get();
            
            if (progressDoc.exists) {
                setResourceProgress(progressDoc.data() || {});
            }
            
            const notesDoc = await db.collection('users').doc(pirId)
                .collection('resourcePreferences').doc('notes').get();
            
            if (notesDoc.exists) {
                setResourceNotes(notesDoc.data() || {});
            }
        } catch (error) {
            console.error('Error loading resource progress:', error);
        }
    };

    const loadStreakData = async () => {
        try {
            const streakDoc = await db.collection('streaks').doc(pirId).get();
            if (streakDoc.exists) {
                setStreakData(streakDoc.data());
            }
        } catch (error) {
            console.error('Error loading streak data:', error);
        }
    };

    const loadProgressChartData = async () => {
        try {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const checkInsSnap = await db.collection('checkIns')
                .where('userId', '==', pirId)
                .where('createdAt', '>=', thirtyDaysAgo)
                .orderBy('createdAt', 'asc')
                .get();
            
            const chartLabels = [];
            const moodData = [];
            const cravingData = [];
            const anxietyData = [];
            const sleepData = [];
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                chartLabels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                
                let dayCheckIn = null;
                checkInsSnap.forEach(doc => {
                    const checkInDate = doc.data().createdAt?.toDate() || new Date(doc.data().createdAt);
                    if (checkInDate.toDateString() === date.toDateString()) {
                        dayCheckIn = doc.data();
                    }
                });
                
                moodData.push(dayCheckIn?.morningData?.mood ?? null);
                cravingData.push(dayCheckIn?.morningData?.craving ?? null);
                anxietyData.push(dayCheckIn?.morningData?.anxietyLevel ?? null);
                sleepData.push(dayCheckIn?.morningData?.sleepQuality ?? null);
            }
            
            setChartData({
                labels: chartLabels,
                mood: moodData,
                craving: cravingData,
                anxiety: anxietyData,
                sleep: sleepData
            });
        } catch (error) {
            console.error('Error loading chart data:', error);
        }
    };

    const calculateGoalProgress = async (goalId) => {
        const goalAssignments = assignments.filter(a => a.goalId === goalId);
        const completed = goalAssignments.filter(a => a.status === 'completed').length;
        return goalAssignments.length > 0 ? Math.round((completed / goalAssignments.length) * 100) : 0;
    };

    const getActivityIcon = (type, options = {}) => {
        const { size = 18, color = 'currentColor' } = options;
        const iconMap = {
            'check_in': () => AdminIcons.CheckCircle({ size, color }),
            'assignment_completed': () => AdminIcons.FileText({ size, color }),
            'goal_completed': () => AdminIcons.Target({ size, color }),
            'objective_completed': () => AdminIcons.Target({ size, color }),
            'message_sent': () => AdminIcons.MessageSquare({ size, color }),
            'sos_triggered': () => AdminIcons.AlertTriangle({ size, color }),
            'login': () => AdminIcons.LogIn({ size, color }),
            'profile_updated': () => AdminIcons.User({ size, color }),
            'pledge_completed': () => AdminIcons.CheckCircle({ size, color }),
            'resource_viewed': () => AdminIcons.Book({ size, color }),
            'milestone_achieved': () => AdminIcons.Trophy({ size, color }),
            'streak_update': () => AdminIcons.Flame({ size, color })
        };
        return iconMap[type] ? iconMap[type]() : AdminIcons.Activity({ size, color });
    };

    const getActivityColor = (type) => {
        const colors = {
            'check_in': '#00A86B',
            'assignment_completed': '#0077CC',
            'goal_completed': '#FF9800',
            'message_sent': '#9C27B0',
            'sos_triggered': '#DC143C',
            'login': '#2196F3',
            'profile_updated': '#6c757d'
        };
        return colors[type] || '#999999';
    };

    // ========== CHART RENDERING ==========
    useEffect(() => {
        if (chartData && activeTab === 'progress') {
            setTimeout(() => {
                renderCharts();
            }, 100);
        }
    }, [chartData, activeTab]);

    const renderCharts = () => {
        const chartConfig = {
            type: 'line',
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 10, ticks: { stepSize: 1 } }
                },
                plugins: {
                    legend: { display: true },
                    tooltip: { enabled: true }
                }
            }
        };

        if (moodChartRef.current) moodChartRef.current.destroy();
        if (cravingChartRef.current) cravingChartRef.current.destroy();
        if (anxietyChartRef.current) anxietyChartRef.current.destroy();
        if (sleepChartRef.current) sleepChartRef.current.destroy();

        const moodCanvas = document.getElementById(`mood-chart-${pirId}`);
        if (moodCanvas) {
            moodChartRef.current = new Chart(moodCanvas, {
                ...chartConfig,
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Mood',
                        data: chartData.mood,
                        borderColor: '#00A86B',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4,
                        spanGaps: true
                    }]
                }
            });
        }

        const cravingCanvas = document.getElementById(`craving-chart-${pirId}`);
        if (cravingCanvas) {
            cravingChartRef.current = new Chart(cravingCanvas, {
                ...chartConfig,
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Craving',
                        data: chartData.craving,
                        borderColor: '#FF9800',
                        backgroundColor: 'rgba(255, 152, 0, 0.1)',
                        tension: 0.4,
                        spanGaps: true
                    }]
                }
            });
        }

        const anxietyCanvas = document.getElementById(`anxiety-chart-${pirId}`);
        if (anxietyCanvas) {
            anxietyChartRef.current = new Chart(anxietyCanvas, {
                ...chartConfig,
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Anxiety',
                        data: chartData.anxiety,
                        borderColor: '#DC143C',
                        backgroundColor: 'rgba(244, 67, 54, 0.1)',
                        tension: 0.4,
                        spanGaps: true
                    }]
                }
            });
        }

        const sleepCanvas = document.getElementById(`sleep-chart-${pirId}`);
        if (sleepCanvas) {
            sleepChartRef.current = new Chart(sleepCanvas, {
                ...chartConfig,
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Sleep Quality',
                        data: chartData.sleep,
                        borderColor: '#9C27B0',
                        backgroundColor: 'rgba(156, 39, 176, 0.1)',
                        tension: 0.4,
                        spanGaps: true
                    }]
                }
            });
        }
    };

    // ========== ACTION HANDLERS ==========
    const handleSaveProfile = async () => {
        try {
            const updates = {
                ...editData,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            if (editData.assignedCoach !== pirData.assignedCoach) {
                const newCoach = availableCoaches.find(c => c.id === editData.assignedCoach);
                const oldCoach = availableCoaches.find(c => c.id === pirData.assignedCoach);
                
                const historyEntry = {
                    assignedAt: new Date().toISOString(),
                    assignedBy: user.uid,
                    coachId: editData.assignedCoach,
                    coachName: newCoach?.displayName || newCoach?.email || 'Unknown',
                    previousCoachId: pirData.assignedCoach || null,
                    previousCoachName: oldCoach?.displayName || oldCoach?.email || 'None'
                };
                
                updates.coachAssignmentHistory = firebase.firestore.FieldValue.arrayUnion(historyEntry);
                
                if (editData.assignedCoach) {
                    await createNotificationWithPreferences({
                        recipientId: editData.assignedCoach,
                        type: 'pir_assigned',
                        message: `${pirData.displayName || pirData.email} has been assigned to you`,
                        pirId: pirId,
                        pirName: pirData.displayName || pirData.email,
                        read: false
                    }, 'pir_assigned');
                }

                await createNotificationWithPreferences({
                    recipientId: pirId,
                    type: 'coach_changed',
                    message: `Your coach has been updated to ${newCoach?.displayName || 'a new coach'}`,
                    read: false
                }, 'coach_changed');
            }
            
            await db.collection('users').doc(pirId).update(updates);
            
            await db.collection('activities').add({
                userId: pirId,
                type: 'profile_updated',
                description: 'Profile information updated' + 
                    (editData.assignedCoach !== pirData.assignedCoach ? ' - Coach assignment changed' : ''),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            setPirData(editData);
            setEditing(false);
            alert('Profile updated successfully' + 
                (editData.assignedCoach !== pirData.assignedCoach ? '\n\nCoach assignment changed and notifications sent!' : ''));
            if (onUpdate) onUpdate();
        } catch (error) {
            console.error('Error updating profile:', error);
            alert('Failed to update profile: ' + error.message);
        }
    };

    // ========== NEW: DELETE ACCOUNT (SOFT DELETE) ==========
    const handleDeleteAccount = async () => {
        const confirmDelete = confirm(
            `DELETE ACCOUNT WARNING\n\n` +
            `Are you sure you want to delete ${pirData.displayName || pirData.email}'s account?\n\n` +
            `This will:\n` +
            `• Mark account as DELETED and INACTIVE\n` +
            `• Prevent PIR from logging in\n` +
            `• Preserve all data for compliance (7 years)\n` +
            `• Record deletion in activity log\n\n` +
            `Type "DELETE" in the next prompt to confirm.`
        );
        
        if (!confirmDelete) return;
        
        const confirmText = prompt('Type DELETE to confirm account deletion:');
        if (confirmText !== 'DELETE') {
            alert('Deletion cancelled. Text did not match.');
            return;
        }
        
        try {
            await db.collection('users').doc(pirId).update({
                deleted: true,
                active: false,
                deletedAt: firebase.firestore.FieldValue.serverTimestamp(),
                deletedBy: user.uid,
                deletedReason: 'Admin deleted account',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await db.collection('activities').add({
                userId: pirId,
                type: 'account_deleted',
                description: `Account deleted by ${user.displayName || user.email}`,
                deletedBy: user.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await createNotificationWithPreferences({
                recipientId: pirId,
                type: 'account_deleted',
                message: 'Your account has been deactivated. Please contact support if you believe this is an error.',
                read: false
            }, 'alert');
            
            alert('Account deleted successfully.\n\nThe PIR can no longer log in, but all data is preserved for compliance.');
            
            if (onUpdate) onUpdate();
            onClose();
            
        } catch (error) {
            console.error('Error deleting account:', error);
            alert('Failed to delete account: ' + error.message);
        }
    };

    // ========== NEW: TOGGLE ACTIVE STATUS ==========
    const handleToggleActiveStatus = async () => {
        const newActiveStatus = !pirData.active;
        const action = newActiveStatus ? 'ACTIVATE' : 'DEACTIVATE';
        
        const confirm = window.confirm(
            `${action} ACCOUNT\n\n` +
            `Are you sure you want to ${action.toLowerCase()} ${pirData.displayName || pirData.email}'s account?\n\n` +
            `${newActiveStatus ? 
                '• PIR will be able to log in\n• All features will be accessible' : 
                '• PIR will NOT be able to log in\n• Account will be locked'}`
        );
        
        if (!confirm) return;
        
        try {
            await db.collection('users').doc(pirId).update({
                active: newActiveStatus,
                activeStatusChangedAt: firebase.firestore.FieldValue.serverTimestamp(),
                activeStatusChangedBy: user.uid,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await db.collection('activities').add({
                userId: pirId,
                type: newActiveStatus ? 'account_activated' : 'account_deactivated',
                description: `Account ${newActiveStatus ? 'activated' : 'deactivated'} by ${user.displayName || user.email}`,
                changedBy: user.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await createNotificationWithPreferences({
                recipientId: pirId,
                type: newActiveStatus ? 'account_activated' : 'account_deactivated',
                message: newActiveStatus ?
                    'Your account has been activated. You can now log in.' :
                    'Your account has been deactivated. Please contact support.',
                read: false
            }, 'alert');
            
            setPirData({...pirData, active: newActiveStatus});
            setEditData({...editData, active: newActiveStatus});
            
            alert(`Account ${newActiveStatus ? 'activated' : 'deactivated'} successfully.`);
            
            if (onUpdate) onUpdate();
            
        } catch (error) {
            console.error('Error toggling active status:', error);
            alert('Failed to update status: ' + error.message);
        }
    };

    const handleAddGoal = async (goalData) => {
        try {
            await db.collection('goals').add({
                ...goalData,
                userId: pirId,
                createdBy: user.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await loadGoalsData();
            setShowAddGoal(false);
            alert('Goal added successfully');
        } catch (error) {
            console.error('Error adding goal:', error);
            alert('Failed to add goal');
        }
    };

    const handleAssignResource = async (resourceId) => {
        try {
            const resourceDoc = await db.collection('resources').doc(resourceId).get();
            const resourceData = resourceDoc.data();
            
            const currentAssigned = resourceData.assignedTo || [];
            if (!currentAssigned.includes(pirId)) {
                await db.collection('resources').doc(resourceId).update({
                    assignedTo: firebase.firestore.FieldValue.arrayUnion(pirId)
                });
                
                await loadResourcesData();
                alert('Resource assigned successfully');
            } else {
                alert('Resource already assigned to this PIR');
            }
        } catch (error) {
            console.error('Error assigning resource:', error);
            alert('Failed to assign resource');
        }
    };

    const handleDeleteMessage = async (messageId, messageType) => {
        if (!confirm('Are you sure you want to delete this message?')) return;
        
        try {
            let collection = 'messages';
            if (messageType === 'community') collection = 'glrsChat';
            if (messageType === 'topic') collection = 'topicRoomMessages';
            
            await db.collection(collection).doc(messageId).delete();
            
            await db.collection('flaggedContent').add({
                originalCollection: collection,
                originalId: messageId,
                userId: pirId,
                flaggedBy: user.uid,
                reason: 'Deleted by coach',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await loadAllUserMessages();
            alert('Message deleted and flagged');
        } catch (error) {
            console.error('Error deleting message:', error);
            alert('Failed to delete message');
        }
    };

    // ========== RENDER OVERVIEW TAB (UPDATED WITH CSS VARIABLES) ==========
    const renderOverviewTab = () => (
        <div style={{ padding: '20px' }}>
            {/* Account Status Banner */}
            {(!pirData.active || pirData.deleted) && (
                <div style={{
                    background: pirData.deleted ? 'linear-gradient(135deg, #DC143C 0%, #c41230 100%)' : 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)',
                    padding: '15px 20px',
                    borderRadius: '8px',
                    color: '#FFFFFF',
                    marginBottom: '20px',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    fontWeight: 'bold',
                    boxShadow: '0 4px 8px rgba(0,0,0,0.15)'
                }}>
                    <span style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                        {pirData.deleted
                            ? React.createElement(React.Fragment, null, AdminIcons.XCircle({ size: 16, color: 'white' }), ' ACCOUNT DELETED')
                            : React.createElement(React.Fragment, null, AdminIcons.AlertCircle({ size: 16, color: 'white' }), ' ACCOUNT INACTIVE')
                        }
                        {pirData.deleted && ' - PIR cannot log in. Data preserved for compliance.'}
                        {!pirData.deleted && !pirData.active && ' - PIR cannot log in until activated.'}
                    </span>
                    {!pirData.deleted && (
                        <button
                            onClick={handleToggleActiveStatus}
                            style={{
                                background: '#FFFFFF',
                                color: pirData.active ? '#FF9800' : '#00A86B',
                                border: 'none',
                                padding: '8px 16px',
                                borderRadius: '4px',
                                cursor: 'pointer',
                                fontWeight: 'bold',
                                fontSize: '13px',
                                transition: 'all 0.2s ease'
                            }}
                        >
                            {pirData.active ? 'Deactivate' : 'Activate'}
                        </button>
                    )}
                </div>
            )}

            {/* Key Metrics Cards */}
            <div style={{ 
                display: 'grid', 
                gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
                gap: '20px',
                marginBottom: '30px'
            }}>
                <div style={{
                    background: 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)',
                    padding: '20px',
                    borderRadius: '12px',
                    color: '#FFFFFF',
                    boxShadow: '0 8px 20px rgba(0,119,204,0.3)',
                    transition: 'all 0.2s ease',
                    cursor: 'default'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '13px', opacity: 0.9 }}>Sobriety Days</div>
                    <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{pirData.sobrietyDays}</div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Since {formatDate(pirData.sobrietyDate)}</div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)',
                    padding: '20px',
                    borderRadius: '12px',
                    color: '#FFFFFF',
                    boxShadow: '0 4px 8px rgba(0,0,0,0.15)',
                    transition: 'all 0.2s ease',
                    cursor: 'default'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '13px', opacity: 0.9 }}>Current Streak</div>
                    <div style={{ fontSize: '36px', fontWeight: 'bold', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}>
                        {streakData.currentStreak || 0}
                        {AdminIcons.Flame({ size: 32, color: '#ff6b35' })}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Best: {streakData.longestStreak || 0} days</div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)',
                    padding: '20px',
                    borderRadius: '12px',
                    color: '#FFFFFF',
                    boxShadow: '0 4px 8px rgba(0,0,0,0.15)',
                    transition: 'all 0.2s ease',
                    cursor: 'default'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '13px', opacity: 0.9 }}>Last Login</div>
                    <div style={{ fontSize: '16px', fontWeight: 'bold' }}>{pirData.lastLoginFormatted}</div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Account age: {pirData.accountAge} days</div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)',
                    padding: '20px',
                    borderRadius: '12px',
                    color: '#FFFFFF',
                    boxShadow: '0 4px 8px rgba(0,0,0,0.15)',
                    transition: 'all 0.2s ease',
                    cursor: 'default'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '13px', opacity: 0.9 }}>Money Saved</div>
                    <div style={{ fontSize: '36px', fontWeight: 'bold' }}>${pirData.moneySaved}</div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>${pirData.dailyCost || 20}/day saved</div>
                </div>
            </div>
            
            {/* Profile Information */}
            <div style={{
                background: '#FFFFFF',
                borderRadius: '12px',
                padding: '25px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                marginBottom: '20px'
            }}>
                <div style={{ 
                    display: 'flex', 
                    justifyContent: 'space-between', 
                    alignItems: 'center',
                    marginBottom: '20px'
                }}>
                    <h3 style={{ margin: 0, color: '#333333' }}>Profile Information</h3>
                    {!editing ? (
                        <button 
                            className="btn btn-secondary"
                            onClick={() => setEditing(true)}
                            style={{
                                background: 'linear-gradient(135deg, #9C27B0 0%, #673AB7 100%)',
                                color: '#FFFFFF',
                                border: 'none',
                                padding: '10px 20px',
                                borderRadius: '4px',
                                cursor: 'pointer',
                                fontWeight: '500',
                                transition: 'all 0.2s ease'
                            }}
                        >
                            Edit Profile
                        </button>
                    ) : (
                        <div style={{ display: 'flex', gap: '10px' }}>
                            <button 
                                className="btn btn-primary"
                                onClick={handleSaveProfile}
                                style={{
                                    background: 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)',
                                    color: '#FFFFFF',
                                    border: 'none',
                                    padding: '10px 20px',
                                    borderRadius: '4px',
                                    cursor: 'pointer',
                                    fontWeight: '500',
                                    transition: 'all 0.2s ease'
                                }}
                            >
                                Save Changes
                            </button>
                            <button 
                                className="btn btn-secondary"
                                onClick={() => {
                                    setEditing(false);
                                    setEditData(pirData);
                                }}
                                style={{
                                    background: '#999999',
                                    color: '#FFFFFF',
                                    border: 'none',
                                    padding: '10px 20px',
                                    borderRadius: '4px',
                                    cursor: 'pointer',
                                    fontWeight: '500',
                                    transition: 'all 0.2s ease'
                                }}
                            >
                                Cancel
                            </button>
                        </div>
                    )}
                </div>

                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
                    <div>
                        <label style={{ fontWeight: 'bold', color: '#666666' }}>Full Name</label>
                        {editing ? (
                            <div style={{ display: 'flex', gap: '10px' }}>
                                <input
                                    type="text"
                                    value={editData.firstName || ''}
                                    onChange={(e) => setEditData({...editData, firstName: e.target.value})}
                                    style={{ 
                                        flex: 1, 
                                        padding: '8px', 
                                        borderRadius: '4px', 
                                        border: '1px solid #e0e0e0' 
                                    }}
                                />
                                <input
                                    type="text"
                                    value={editData.lastName || ''}
                                    onChange={(e) => setEditData({...editData, lastName: e.target.value})}
                                    style={{ 
                                        flex: 1, 
                                        padding: '8px', 
                                        borderRadius: '4px', 
                                        border: '1px solid #e0e0e0' 
                                    }}
                                />
                            </div>
                        ) : (
                            <p style={{ color: '#333333' }}>{pirData.firstName} {pirData.lastName}</p>
                        )}
                    </div>

                    <div>
                        <label style={{ fontWeight: 'bold', color: '#666666' }}>Email</label>
                        <p style={{ color: '#333333' }}>{pirData.email}</p>
                    </div>

                    <div>
                        <label style={{ fontWeight: 'bold', color: '#666666' }}>Phone</label>
                        {editing ? (
                            <input
                                type="tel"
                                value={editData.phone || ''}
                                onChange={(e) => setEditData({...editData, phone: e.target.value})}
                                style={{ 
                                    width: '100%', 
                                    padding: '8px', 
                                    borderRadius: '4px', 
                                    border: '1px solid #e0e0e0' 
                                }}
                            />
                        ) : (
                            <p style={{ color: '#333333' }}>{pirData.phone || 'Not provided'}</p>
                        )}
                    </div>

                    <div>
                        <label style={{ fontWeight: 'bold', color: '#666666' }}>Date of Birth</label>
                        {editing ? (
                            <input
                                type="date"
                                value={editData.dateOfBirth || ''}
                                onChange={(e) => setEditData({...editData, dateOfBirth: e.target.value})}
                                style={{ 
                                    width: '100%', 
                                    padding: '8px', 
                                    borderRadius: '4px', 
                                    border: '1px solid #e0e0e0' 
                                }}
                            />
                        ) : (
                            <p style={{ color: '#333333' }}>{pirData.dateOfBirth || 'Not provided'}</p>
                        )}
                    </div>

                    <div>
                        <label style={{ fontWeight: 'bold', color: '#666666' }}>Sobriety Date</label>
                        {editing ? (
                            <input
                                type="date"
                                value={editData.sobrietyDate || ''}
                                onChange={(e) => setEditData({...editData, sobrietyDate: e.target.value})}
                                style={{ 
                                    width: '100%', 
                                    padding: '8px', 
                                    borderRadius: '4px', 
                                    border: '1px solid #e0e0e0' 
                                }}
                            />
                        ) : (
                            <p style={{ color: '#333333' }}>{formatDate(pirData.sobrietyDate)}</p>
                        )}
                    </div>

                    <div>
                        <label style={{ fontWeight: 'bold', color: '#666666' }}>Substance</label>
                        <p style={{ color: '#333333' }}>{pirData.substance || 'Not specified'}</p>
                    </div>

                    <div style={{ gridColumn: 'span 2' }}>
                        <label style={{ fontWeight: 'bold', color: '#666666' }}>Address</label>
                        {editing ? (
                            <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr 1fr', gap: '10px' }}>
                                <input
                                    type="text"
                                    value={editData.address?.street || ''}
                                    onChange={(e) => setEditData({
                                        ...editData, 
                                        address: {...editData.address, street: e.target.value}
                                    })}
                                    placeholder="Street Address"
                                    style={{ 
                                        padding: '8px', 
                                        borderRadius: '4px', 
                                        border: '1px solid #e0e0e0' 
                                    }}
                                />
                                <input
                                    type="text"
                                    value={editData.address?.city || ''}
                                    onChange={(e) => setEditData({
                                        ...editData, 
                                        address: {...editData.address, city: e.target.value}
                                    })}
                                    placeholder="City"
                                    style={{ 
                                        padding: '8px', 
                                        borderRadius: '4px', 
                                        border: '1px solid #e0e0e0' 
                                    }}
                                />
                                <input
                                    type="text"
                                    value={editData.address?.state || ''}
                                    onChange={(e) => setEditData({
                                        ...editData, 
                                        address: {...editData.address, state: e.target.value}
                                    })}
                                    placeholder="State"
                                    style={{ 
                                        padding: '8px', 
                                        borderRadius: '4px', 
                                        border: '1px solid #e0e0e0' 
                                    }}
                                />
                                <input
                                    type="text"
                                    value={editData.address?.zip || ''}
                                    onChange={(e) => setEditData({
                                        ...editData, 
                                        address: {...editData.address, zip: e.target.value}
                                    })}
                                    placeholder="ZIP"
                                    style={{ 
                                        padding: '8px', 
                                        borderRadius: '4px', 
                                        border: '1px solid #e0e0e0' 
                                    }}
                                />
                            </div>
                        ) : (
                            <p style={{ color: '#333333' }}>
                                {pirData.address ? 
                                    `${pirData.address.street || ''} ${pirData.address.city || ''}, ${pirData.address.state || ''} ${pirData.address.zip || ''}`.trim() : 
                                    'Not provided'}
                            </p>
                        )}
                    </div>
                </div>
            </div>

            {/* Assigned Coach Section */}
            <div style={{
                background: '#FFFFFF',
                borderRadius: '12px',
                padding: '25px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                marginBottom: '20px'
            }}>
                <h3 style={{ marginBottom: '20px', color: '#333333' }}>Assigned Coach</h3>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
                    <div>
                        <label style={{ fontWeight: 'bold', color: '#666666' }}>Current Coach</label>
                        {editing ? (
                            <select
                                value={editData.assignedCoach || ''}
                                onChange={(e) => setEditData({...editData, assignedCoach: e.target.value})}
                                style={{ 
                                    width: '100%', 
                                    padding: '8px', 
                                    borderRadius: '4px', 
                                    border: '1px solid #e0e0e0',
                                    fontSize: '13px'
                                }}
                            >
                                <option value="">-- No Coach Assigned --</option>
                                {availableCoaches.map(coach => (
                                    <option key={coach.id} value={coach.id}>
                                        {coach.displayName || coach.email} ({coach.role})
                                    </option>
                                ))}
                            </select>
                        ) : (
                            <p style={{ color: '#333333' }}>
                                {availableCoaches.find(c => c.id === pirData.assignedCoach)?.displayName || 
                                 availableCoaches.find(c => c.id === pirData.assignedCoach)?.email || 
                                 'No coach assigned'}
                            </p>
                        )}
                    </div>
                    <div>
                        <label style={{ fontWeight: 'bold', color: '#666666' }}>Coach Email</label>
                        <p style={{ color: '#333333' }}>
                            {availableCoaches.find(c => c.id === pirData.assignedCoach)?.email || 'N/A'}
                        </p>
                    </div>
                </div>
                
                {pirData.coachAssignmentHistory && pirData.coachAssignmentHistory.length > 0 && (
                    <div style={{ marginTop: '20px', paddingTop: '20px', borderTop: '1px solid #e0e0e0' }}>
                        <h4 style={{ fontSize: '13px', color: '#666666', marginBottom: '10px' }}>Assignment History</h4>
                        <div style={{ fontSize: '12px', color: '#999999' }}>
                            {pirData.coachAssignmentHistory.slice(0, 3).map((history, index) => (
                                <div key={index} style={{ padding: '5px 0' }}>
                                    {formatDate(history.assignedAt)} - Assigned to {history.coachName || 'Unknown'}
                                </div>
                            ))}
                        </div>
                    </div>
                )}
            </div>

            {/* Account Management Section */}
            <div style={{
                background: '#FFFFFF',
                borderRadius: '12px',
                padding: '25px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                marginBottom: '20px',
                border: '2px solid #e0e0e0'
            }}>
                <h3 style={{ marginBottom: '20px', color: '#333333', display: 'flex', alignItems: 'center', gap: '8px' }}>
                    {AdminIcons.Settings({ size: 20, color: '#333333' })}
                    Account Management
                </h3>
                
                <div style={{ display: 'grid', gap: '15px' }}>
                    {/* Active Status Control */}
                    <div style={{
                        padding: '15px',
                        background: pirData.active ? 'rgba(76, 175, 80, 0.1)' : 'rgba(255, 193, 7, 0.1)',
                        borderRadius: '8px',
                        border: pirData.active ? '1px solid #00A86B' : '1px solid #FF9800'
                    }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div>
                                <div style={{ fontWeight: 'bold', marginBottom: '5px', color: '#333333', display: 'flex', alignItems: 'center', gap: '6px' }}>
                                    Account Status:
                                    {pirData.active
                                        ? React.createElement(React.Fragment, null, AdminIcons.CheckCircle({ size: 16, color: '#00A86B' }), ' Active')
                                        : React.createElement(React.Fragment, null, AdminIcons.AlertCircle({ size: 16, color: '#FF9800' }), ' Inactive')
                                    }
                                </div>
                                <div style={{ fontSize: '13px', color: '#666666' }}>
                                    {pirData.active ? 
                                        'PIR can log in and access all features' : 
                                        'PIR cannot log in. Activate to restore access.'}
                                </div>
                            </div>
                            {!pirData.deleted && (
                                <button
                                    onClick={handleToggleActiveStatus}
                                    style={{
                                        background: pirData.active ? 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)' : 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                                        color: '#FFFFFF',
                                        border: 'none',
                                        padding: '10px 20px',
                                        borderRadius: '4px',
                                        cursor: 'pointer',
                                        fontWeight: 'bold',
                                        fontSize: '13px',
                                        transition: 'all 0.2s ease'
                                    }}
                                    onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                                    onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                                >
                                    {pirData.active ? 'Deactivate Account' : 'Activate Account'}
                                </button>
                            )}
                        </div>
                    </div>

                    {/* Delete Account Control */}
                    {!pirData.deleted && (
                        <div style={{
                            padding: '15px',
                            background: 'rgba(244, 67, 54, 0.05)',
                            borderRadius: '8px',
                            border: '2px solid #DC143C'
                        }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <div>
                                    <div style={{ fontWeight: 'bold', marginBottom: '5px', color: '#333333', display: 'flex', alignItems: 'center', gap: '6px' }}>
                                        {AdminIcons.XCircle({ size: 16, color: '#DC143C' })} Danger Zone: Delete Account
                                    </div>
                                    <div style={{ fontSize: '13px', color: '#666666' }}>
                                        Permanently mark account as deleted. Data preserved for compliance.
                                    </div>
                                </div>
                                <button
                                    onClick={handleDeleteAccount}
                                    style={{
                                        background: 'linear-gradient(135deg, #DC143C 0%, #c41230 100%)',
                                        color: '#FFFFFF',
                                        border: 'none',
                                        padding: '10px 20px',
                                        borderRadius: '4px',
                                        cursor: 'pointer',
                                        fontWeight: 'bold',
                                        fontSize: '13px',
                                        transition: 'all 0.2s ease'
                                    }}
                                    onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                                    onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                                >
                                    Delete Account
                                </button>
                            </div>
                        </div>
                    )}
                    
                    {/* Deleted Account Banner */}
                    {pirData.deleted && (
                        <div style={{
                            padding: '15px',
                            background: 'rgba(244, 67, 54, 0.1)',
                            borderRadius: '8px',
                            border: '2px solid #DC143C'
                        }}>
                            <div style={{ fontWeight: 'bold', marginBottom: '5px', color: '#DC143C', display: 'flex', alignItems: 'center', gap: '6px' }}>
                                {AdminIcons.XCircle({ size: 16, color: '#DC143C' })} ACCOUNT DELETED
                            </div>
                            <div style={{ fontSize: '13px', color: '#666666' }}>
                                Deleted on: {pirData.deletedAt ? formatDateTime(pirData.deletedAt) : 'Unknown'}
                                <br />
                                PIR cannot log in. All data preserved for compliance.
                            </div>
                        </div>
                    )}
                </div>
            </div>

            {/* Emergency Contacts */}
            <div style={{
                background: '#FFFFFF',
                borderRadius: '12px',
                padding: '25px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                marginBottom: '20px'
            }}>
                <h3 style={{ marginBottom: '20px', color: '#333333' }}>Emergency Contacts</h3>
                {pirData.emergencyContacts && pirData.emergencyContacts.length > 0 ? (
                    <div style={{ display: 'grid', gap: '15px' }}>
                        {pirData.emergencyContacts.map((contact, index) => (
                            <div key={index} style={{
                                padding: '15px',
                                background: contact.isPrimary ? 'rgba(76, 175, 80, 0.1)' : '#f8f9fa',
                                borderRadius: '8px',
                                border: contact.isPrimary ? '2px solid #00A86B' : '1px solid #e0e0e0'
                            }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <div>
                                        <div style={{ fontWeight: 'bold', fontSize: '16px', color: '#333333' }}>
                                            {contact.name} 
                                            {contact.isPrimary && (
                                                <span style={{
                                                    marginLeft: '10px',
                                                    background: '#00A86B',
                                                    color: '#FFFFFF',
                                                    padding: '2px 8px',
                                                    borderRadius: '12px',
                                                    fontSize: '12px'
                                                }}>PRIMARY</span>
                                            )}
                                        </div>
                                        <div style={{ color: '#666666', marginTop: '5px' }}>
                                            {contact.relationship} • {contact.phone}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                ) : (
                    <p style={{ color: '#666666' }}>No emergency contacts configured</p>
                )}
            </div>

            {/* Sponsor Information */}
            <div style={{
                background: '#FFFFFF',
                borderRadius: '12px',
                padding: '25px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
            }}>
                <h3 style={{ marginBottom: '20px', color: '#333333' }}>Sponsor Information</h3>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
                    <div>
                        <label style={{ fontWeight: 'bold', color: '#666666' }}>Sponsor Name</label>
                        {editing ? (
                            <input
                                type="text"
                                value={editData.sponsorName || ''}
                                onChange={(e) => setEditData({...editData, sponsorName: e.target.value})}
                                style={{ 
                                    width: '100%', 
                                    padding: '8px', 
                                    borderRadius: '4px', 
                                    border: '1px solid #e0e0e0' 
                                }}
                            />
                        ) : (
                            <p style={{ color: '#333333' }}>{pirData.sponsorName || 'Not assigned'}</p>
                        )}
                    </div>
                    <div>
                        <label style={{ fontWeight: 'bold', color: '#666666' }}>Sponsor Phone</label>
                        {editing ? (
                            <input
                                type="tel"
                                value={editData.sponsorPhone || ''}
                                onChange={(e) => setEditData({...editData, sponsorPhone: e.target.value})}
                                style={{ 
                                    width: '100%', 
                                    padding: '8px', 
                                    borderRadius: '4px', 
                                    border: '1px solid #e0e0e0' 
                                }}
                            />
                        ) : (
                            <p style={{ color: '#333333' }}>{pirData.sponsorPhone || 'Not provided'}</p>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
// ========== PROGRESS TAB - CSS VARIABLES + READABLE TEXT ==========
const renderProgressTab = () => (
    <div style={{ padding: '20px' }}>
        {/* Compliance Metrics */}
        <div style={{
            background: '#FFFFFF',
            borderRadius: '12px',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
            <h3 style={{ 
                marginBottom: '20px', 
                color: '#333333',
                fontSize: '18px',
                fontWeight: '600'
            }}>
                Compliance Metrics (Last {complianceData.daysTracked} Days)
            </h3>
            <div style={{ 
                display: 'grid', 
                gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', 
                gap: '20px' 
            }}>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ 
                        fontSize: '36px', 
                        fontWeight: 'bold', 
                        color: '#00A86B' 
                    }}>
                        {complianceData.morningRate}%
                    </div>
                    <div style={{ color: '#666666', fontSize: '13px' }}>
                        Morning Check-ins
                    </div>
                </div>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ 
                        fontSize: '36px', 
                        fontWeight: 'bold', 
                        color: '#0077CC' 
                    }}>
                        {complianceData.eveningRate}%
                    </div>
                    <div style={{ color: '#666666', fontSize: '13px' }}>
                        Evening Reflections
                    </div>
                </div>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ 
                        fontSize: '36px', 
                        fontWeight: 'bold', 
                        color: '#FF9800' 
                    }}>
                        {complianceData.assignmentRate}%
                    </div>
                    <div style={{ color: '#666666', fontSize: '13px' }}>
                        Assignments Complete
                    </div>
                </div>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ 
                        fontSize: '36px', 
                        fontWeight: 'bold', 
                        color: '#9C27B0' 
                    }}>
                        {complianceData.totalCheckIns}
                    </div>
                    <div style={{ color: '#666666', fontSize: '13px' }}>
                        Total Check-ins
                    </div>
                </div>
            </div>
        </div>

        {/* Check-ins History Table */}
        <div style={{
            background: '#FFFFFF',
            borderRadius: '12px',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
            <h3 style={{ 
                marginBottom: '20px', 
                color: '#333333',
                fontSize: '18px',
                fontWeight: '600'
            }}>
                Check-in History
            </h3>
            <div style={{ overflowX: 'auto' }}>
                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                    <thead>
                        <tr style={{ 
                            borderBottom: '2px solid #e0e0e0', 
                            background: '#f8f9fa' 
                        }}>
                            <th style={{ 
                                padding: '12px', 
                                textAlign: 'left', 
                                color: '#333333', 
                                fontWeight: 'bold',
                                fontSize: '13px'
                            }}>Date</th>
                            <th style={{ 
                                padding: '12px', 
                                textAlign: 'center', 
                                color: '#333333', 
                                fontWeight: 'bold',
                                fontSize: '13px'
                            }}>Morning</th>
                            <th style={{ 
                                padding: '12px', 
                                textAlign: 'center', 
                                color: '#333333', 
                                fontWeight: 'bold',
                                fontSize: '13px'
                            }}>Evening</th>
                            <th style={{ 
                                padding: '12px', 
                                textAlign: 'center', 
                                color: '#333333', 
                                fontWeight: 'bold',
                                fontSize: '13px'
                            }}>Mood</th>
                            <th style={{ 
                                padding: '12px', 
                                textAlign: 'center', 
                                color: '#333333', 
                                fontWeight: 'bold',
                                fontSize: '13px'
                            }}>Craving</th>
                            <th style={{ 
                                padding: '12px', 
                                textAlign: 'center', 
                                color: '#333333', 
                                fontWeight: 'bold',
                                fontSize: '13px'
                            }}>Sleep</th>
                            <th style={{ 
                                padding: '12px', 
                                textAlign: 'left', 
                                color: '#333333', 
                                fontWeight: 'bold',
                                fontSize: '13px'
                            }}>Daily Pledge</th>
                        </tr>
                    </thead>
                    <tbody>
                        {checkIns && checkIns.length > 0 ? (
                            checkIns.map((checkIn, index) => (
                                <tr key={checkIn.id} style={{ 
                                    borderBottom: '1px solid #e0e0e0',
                                    background: index % 2 === 0 ? '#FFFFFF' : '#f8f9fa'
                                }}>
                                    <td style={{ 
                                        padding: '10px', 
                                        color: '#333333', 
                                        fontWeight: '500',
                                        fontSize: '13px'
                                    }}>
                                        {formatDate(checkIn.createdAt)}
                                    </td>
                                    <td style={{ padding: '10px', textAlign: 'center' }}>
                                        {checkIn.morningData ? (
                                            AdminIcons.CheckCircle({ size: 18, color: '#00A86B' })
                                        ) : (
                                            AdminIcons.XCircle({ size: 18, color: '#999999' })
                                        )}
                                    </td>
                                    <td style={{ padding: '10px', textAlign: 'center' }}>
                                        {checkIn.eveningData ? (
                                            AdminIcons.CheckCircle({ size: 18, color: '#0077CC' })
                                        ) : (
                                            AdminIcons.XCircle({ size: 18, color: '#999999' })
                                        )}
                                    </td>
                                    <td style={{ 
                                        padding: '10px', 
                                        textAlign: 'center', 
                                        color: '#333333', 
                                        fontWeight: '500',
                                        fontSize: '13px'
                                    }}>
                                        {checkIn.morningData?.mood || checkIn.eveningData?.mood || '-'}/10
                                    </td>
                                    <td style={{ 
                                        padding: '10px', 
                                        textAlign: 'center', 
                                        color: '#333333', 
                                        fontWeight: '500',
                                        fontSize: '13px'
                                    }}>
                                        {checkIn.morningData?.craving || checkIn.eveningData?.craving || '-'}/10
                                    </td>
                                    <td style={{ 
                                        padding: '10px', 
                                        textAlign: 'center', 
                                        color: '#333333', 
                                        fontWeight: '500',
                                        fontSize: '13px'
                                    }}>
                                        {checkIn.morningData?.sleepQuality || '-'}/10
                                    </td>
                                    <td style={{ padding: '10px' }}>
                                        <div style={{ 
                                            maxWidth: '200px', 
                                            overflow: 'hidden', 
                                            textOverflow: 'ellipsis',
                                            textAlign: 'left', width: '100%',
                                            fontSize: '13px',
                                            color: '#666666',
                                            fontWeight: '400'
                                        }}>
                                            {checkIn.morningData?.dailyPledge || '-'}
                                        </div>
                                    </td>
                                </tr>
                            ))
                        ) : (
                            <tr>
                                <td colSpan="7" style={{ 
                                    padding: '40px', 
                                    textAlign: 'center', 
                                    color: '#666666',
                                    background: '#f8f9fa',
                                    fontSize: '13px'
                                }}>
                                    No check-ins recorded yet
                                </td>
                            </tr>
                        )}
                    </tbody>
                </table>
            </div>
        </div>

        {/* Progress Charts */}
        <div style={{ 
            display: 'grid', 
            gridTemplateColumns: '1fr 1fr', 
            gap: '20px', 
            marginBottom: '20px' 
        }}>
            <div style={{
                background: '#FFFFFF',
                borderRadius: '12px',
                padding: '20px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
            }}>
                <h4 style={{ 
                    marginBottom: '15px', 
                    color: '#333333',
                    fontSize: '16px',
                    fontWeight: '600'
                }}>
                    30-Day Mood Trend
                </h4>
                <div style={{ height: '200px' }}>
                    <canvas id={`mood-chart-${pirId}`}></canvas>
                </div>
            </div>
            
            <div style={{
                background: '#FFFFFF',
                borderRadius: '12px',
                padding: '20px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
            }}>
                <h4 style={{ 
                    marginBottom: '15px', 
                    color: '#333333',
                    fontSize: '16px',
                    fontWeight: '600'
                }}>
                    30-Day Craving Trend
                </h4>
                <div style={{ height: '200px' }}>
                    <canvas id={`craving-chart-${pirId}`}></canvas>
                </div>
            </div>
            
            <div style={{
                background: '#FFFFFF',
                borderRadius: '12px',
                padding: '20px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
            }}>
                <h4 style={{ 
                    marginBottom: '15px', 
                    color: '#333333',
                    fontSize: '16px',
                    fontWeight: '600'
                }}>
                    30-Day Anxiety Trend
                </h4>
                <div style={{ height: '200px' }}>
                    <canvas id={`anxiety-chart-${pirId}`}></canvas>
                </div>
            </div>
            
            <div style={{
                background: '#FFFFFF',
                borderRadius: '12px',
                padding: '20px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
            }}>
                <h4 style={{ 
                    marginBottom: '15px', 
                    color: '#333333',
                    fontSize: '16px',
                    fontWeight: '600'
                }}>
                    30-Day Sleep Quality Trend
                </h4>
                <div style={{ height: '200px' }}>
                    <canvas id={`sleep-chart-${pirId}`}></canvas>
                </div>
            </div>
        </div>

        {/* Evening Reflections Section */}
        <div style={{
            background: '#FFFFFF',
            borderRadius: '12px',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
            <h3 style={{ 
                marginBottom: '20px', 
                color: '#333333',
                fontSize: '18px',
                fontWeight: '600'
            }}>
                Evening Reflections
            </h3>
            <div style={{ maxHeight: '500px', overflowY: 'auto' }}>
                {checkIns && checkIns.filter(c => c.eveningData).length > 0 ? (
                    checkIns.filter(c => c.eveningData).map((checkIn, index) => (
                        <div key={checkIn.id} style={{
                            padding: '20px',
                            marginBottom: '15px',
                            background: index % 2 === 0 ? '#f8f9fa' : '#f5f5f5',
                            borderRadius: '8px',
                            borderLeft: '4px solid #0077CC'
                        }}>
                            <div style={{ 
                                display: 'flex', 
                                justifyContent: 'space-between', 
                                alignItems: 'center',
                                marginBottom: '15px'
                            }}>
                                <h5 style={{ 
                                    margin: 0, 
                                    color: '#333333',
                                    fontSize: '15px',
                                    fontWeight: '600'
                                }}>
                                    {formatDate(checkIn.createdAt)}
                                </h5>
                                <div style={{
                                    background: '#0077CC',
                                    color: '#FFFFFF',
                                    padding: '4px 12px',
                                    borderRadius: '12px',
                                    fontSize: '12px',
                                    fontWeight: '500'
                                }}>
                                    Overall Day: {checkIn.eveningData.overallDay || 0}/10
                                </div>
                            </div>
                            
                            <div style={{ display: 'grid', gap: '12px' }}>
                                {checkIn.eveningData.gratitude && (
                                    <div>
                                        <strong style={{ 
                                            color: '#00A86B', 
                                            fontSize: '13px',
                                            fontWeight: '600'
                                        }}>Gratitude:</strong>
                                        <p style={{ 
                                            margin: '4px 0', 
                                            color: '#333333', 
                                            fontSize: '13px',
                                            lineHeight: '1.5'
                                        }}>
                                            {checkIn.eveningData.gratitude}
                                        </p>
                                    </div>
                                )}
                                
                                {checkIn.eveningData.challenges && (
                                    <div>
                                        <strong style={{ 
                                            color: '#FF9800', 
                                            fontSize: '13px',
                                            fontWeight: '600'
                                        }}>Challenges:</strong>
                                        <p style={{ 
                                            margin: '4px 0', 
                                            color: '#333333', 
                                            fontSize: '13px',
                                            lineHeight: '1.5'
                                        }}>
                                            {checkIn.eveningData.challenges}
                                        </p>
                                    </div>
                                )}
                                
                                {checkIn.eveningData.tomorrowGoal && (
                                    <div>
                                        <strong style={{ 
                                            color: '#9C27B0', 
                                            fontSize: '13px',
                                            fontWeight: '600'
                                        }}>Tomorrow's Goal:</strong>
                                        <p style={{ 
                                            margin: '4px 0', 
                                            color: '#333333', 
                                            fontSize: '13px',
                                            lineHeight: '1.5'
                                        }}>
                                            {checkIn.eveningData.tomorrowGoal}
                                        </p>
                                    </div>
                                )}
                            </div>
                        </div>
                    ))
                ) : (
                    <div style={{ 
                        padding: '40px', 
                        textAlign: 'center', 
                        color: '#666666',
                        fontSize: '13px'
                    }}>
                        No evening reflections recorded yet
                    </div>
                )}
            </div>
        </div>

        {/* Pledges Section */}
        <div style={{
            background: '#FFFFFF',
            borderRadius: '12px',
            padding: '20px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
            <h3 style={{ 
                marginBottom: '20px', 
                color: '#333333',
                fontSize: '18px',
                fontWeight: '600'
            }}>
                Daily Pledges
            </h3>
            <div style={{ maxHeight: '400px', overflowY: 'auto' }}>
                {pledges && pledges.length > 0 ? (
                    pledges.map((pledge, index) => (
                        <div key={pledge.id} style={{
                            padding: '15px',
                            marginBottom: '10px',
                            background: index % 2 === 0 ? '#f8f9fa' : '#f5f5f5',
                            borderRadius: '4px',
                            borderLeft: `4px solid ${pledge.completed ? '#00A86B' : '#FF9800'}`
                        }}>
                            <div style={{ 
                                display: 'flex', 
                                justifyContent: 'space-between', 
                                alignItems: 'center',
                                marginBottom: '8px'
                            }}>
                                <span style={{ 
                                    fontSize: '12px', 
                                    color: '#666666',
                                    fontWeight: '500'
                                }}>
                                    {formatDate(pledge.createdAt)}
                                </span>
                                {pledge.completed && (
                                    AdminIcons.CheckCircle({ size: 16, color: '#00A86B' })
                                )}
                            </div>
                            <p style={{ 
                                margin: 0, 
                                color: '#333333', 
                                fontSize: '13px',
                                lineHeight: '1.5'
                            }}>
                                {pledge.content || pledge.text || pledge.pledge}
                            </p>
                        </div>
                    ))
                ) : (
                    <div style={{ 
                        padding: '30px', 
                        textAlign: 'center', 
                        color: '#666666',
                        fontSize: '13px'
                    }}>
                        No pledges recorded yet
                    </div>
                )}
            </div>
        </div>
    </div>
);

// ========== GOLDEN THREAD TAB - REFACTORED TO MATCH GOALS.HTML ==========
const renderGoldenThreadTab = () => {
    // Handler functions for Golden Thread operations
    const handleCreateGoldenThread = async (threadData) => {
        // This is handled inside CreateGoalModal component
        // Modal closes and reloads on success
    };

    const handleAddGoal = async (goalData) => {
        try {
            await db.collection('goals').add({
                tenantId: CURRENT_TENANT,
                userId: pirId,
                title: goalData.title,
                description: goalData.description,
                dueDate: goalData.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(goalData.dueDate)) : null,
                status: 'active',
                createdBy: user.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            await loadGoalsData();
            setShowAddGoal(false);
            alert('Goal added successfully');
        } catch (error) {
            console.error('Error adding goal:', error);
            alert('Failed to add goal');
        }
    };

    const handleAddObjective = async (objectiveData) => {
        try {
            const objectivesSnap = await db.collection('objectives')
                .where('tenantId', '==', CURRENT_TENANT)
                .where('goalId', '==', objectiveData.goalId)
                .get();

            await db.collection('objectives').add({
                tenantId: CURRENT_TENANT,
                goalId: objectiveData.goalId,
                userId: pirId,
                title: objectiveData.title,
                order: objectivesSnap.size + 1,
                dueDate: objectiveData.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(objectiveData.dueDate)) : null,
                status: 'active',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            await loadGoalsData();
            setShowAddObjective(false);
            setSelectedGoalForObjective(null);
            alert('Objective added successfully');
        } catch (error) {
            console.error('Error adding objective:', error);
            alert('Failed to add objective');
        }
    };

    const handleAddAssignment = async (assignmentData) => {
        try {
            let dueDateTimestamp = null;
            if (assignmentData.dueDate) {
                const dateObj = new Date(assignmentData.dueDate);
                if (!isNaN(dateObj.getTime())) {
                    dueDateTimestamp = firebase.firestore.Timestamp.fromDate(dateObj);
                }
            }

            await db.collection('assignments').add({
                tenantId: CURRENT_TENANT,
                goalId: assignmentData.goalId,
                objectiveId: assignmentData.objectiveId,
                userId: pirId,
                pirName: pirData.displayName || pirData.email,
                coachId: user.uid,
                coachName: user.displayName || user.email,
                title: assignmentData.title,
                description: assignmentData.description,
                dueDate: dueDateTimestamp,
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            await loadGoalsData();
            setShowAddAssignment(false);
            setSelectedObjectiveForAssignment(null);
            alert('Assignment added successfully');
        } catch (error) {
            console.error('Error adding assignment:', error);
            alert('Failed to add assignment');
        }
    };

    // Sub-component: GoalItem - matches goals.html structure
    const GoalItem = ({ goal }) => {
        const isExpanded = expandedGoals[goal.id];
        const goalObjectives = objectives.filter(obj => obj.goalId === goal.id);
        const isCompleted = goal.status === 'completed';

        return (
            <div style={{
                background: isCompleted ? '#f0f8ff' : 'white',
                borderRadius: '10px',
                padding: '20px',
                marginBottom: '15px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                transition: 'all 0.3s',
                opacity: isCompleted ? 0.9 : 1
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <div
                        onClick={() => setExpandedGoals({...expandedGoals, [goal.id]: !expandedGoals[goal.id]})}
                        style={{ cursor: 'pointer', flex: 1 }}
                    >
                        <h4 style={{ margin: 0, color: '#333', display: 'flex', alignItems: 'center', gap: '10px' }}>
                            <span>{isExpanded ? '▼' : '▶'}</span>
                            {goal.title}
                            <span style={{
                                background: isCompleted ? '#00A86B' : `linear-gradient(90deg, #0077CC ${goal.progress}%, #e0e0e0 ${goal.progress}%)`,
                                padding: '2px 10px',
                                borderRadius: '12px',
                                fontSize: '0.8em',
                                color: 'white'
                            }}>
                                {isCompleted ? 'Completed' : `${goal.progress}%`}
                            </span>
                        </h4>
                        <div style={{ marginTop: '5px', fontSize: '0.9em', color: '#666' }}>
                            Created: {formatDate(goal.createdAt)}
                            {goal.dueDate && ` • Due: ${formatDate(goal.dueDate)}`}
                            {goal.completedAt && ` • Completed: ${formatDate(goal.completedAt)}`}
                        </div>
                        {goal.description && (
                            <div style={{ marginTop: '8px', fontSize: '0.9em', color: '#555' }}>
                                {goal.description}
                            </div>
                        )}
                    </div>
                    <div style={{ display: 'flex', gap: '10px' }}>
                        {!isCompleted && (
                            <>
                                <button
                                    onClick={() => {
                                        setSelectedGoalForObjective(goal);
                                        setShowAddObjective(true);
                                    }}
                                    style={{
                                        background: '#00A86B',
                                        border: 'none',
                                        borderRadius: '6px',
                                        color: 'white',
                                        padding: '6px 12px',
                                        cursor: 'pointer',
                                        fontSize: '0.85em'
                                    }}
                                >
                                    + Objective
                                </button>
                            </>
                        )}
                    </div>
                </div>

                {isExpanded && (
                    <div style={{ marginTop: '20px', paddingLeft: '30px' }}>
                        {goalObjectives.map(objective => (
                            <ObjectiveItem key={objective.id} objective={objective} goal={goal} />
                        ))}
                        {goalObjectives.length === 0 && (
                            <p style={{ color: '#999', fontSize: '0.9em' }}>No objectives yet</p>
                        )}
                    </div>
                )}
            </div>
        );
    };

    // Sub-component: ObjectiveItem - matches goals.html structure
    const ObjectiveItem = ({ objective, goal }) => {
        const isExpanded = expandedObjectives[objective.id];
        const objectiveAssignments = assignments.filter(a => a.objectiveId === objective.id);
        const isCompleted = objective.status === 'completed';

        return (
            <div style={{
                background: isCompleted ? '#f5fff5' : '#f8f9fa',
                borderLeft: `3px solid ${isCompleted ? '#00A86B' : '#0077CC'}`,
                padding: '15px',
                marginBottom: '10px',
                borderRadius: '6px',
                opacity: isCompleted ? 0.9 : 1
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <div
                        onClick={() => setExpandedObjectives({...expandedObjectives, [objective.id]: !expandedObjectives[objective.id]})}
                        style={{ cursor: 'pointer', flex: 1 }}
                    >
                        <h5 style={{ margin: 0, color: '#555', display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <span>{isExpanded ? '▼' : '▶'}</span>
                            {objective.title}
                            <span style={{
                                background: isCompleted ? '#00A86B' : '#FFA726',
                                padding: '2px 8px',
                                borderRadius: '10px',
                                fontSize: '0.75em',
                                color: 'white'
                            }}>
                                {isCompleted ? 'completed' : 'active'}
                            </span>
                        </h5>
                        <div style={{ marginTop: '5px', fontSize: '0.85em', color: '#777' }}>
                            {objective.dueDate && `Due: ${formatDate(objective.dueDate)}`}
                            {objective.completedAt && ` • Completed: ${formatDate(objective.completedAt)}`}
                        </div>
                    </div>
                    <div style={{ display: 'flex', gap: '10px' }}>
                        {!isCompleted && (
                            <>
                                <button
                                    onClick={() => {
                                        setSelectedObjectiveForAssignment(objective);
                                        setShowAddAssignment(true);
                                    }}
                                    style={{
                                        background: '#9C27B0',
                                        border: 'none',
                                        borderRadius: '6px',
                                        color: 'white',
                                        padding: '5px 10px',
                                        cursor: 'pointer',
                                        fontSize: '0.8em'
                                    }}
                                >
                                    + Assignment
                                </button>
                            </>
                        )}
                    </div>
                </div>

                {isExpanded && (
                    <div style={{ marginTop: '15px', paddingLeft: '20px' }}>
                        {objectiveAssignments.map(assignment => (
                            <AssignmentItem key={assignment.id} assignment={assignment} />
                        ))}
                        {objectiveAssignments.length === 0 && (
                            <p style={{ color: '#999', fontSize: '0.9em' }}>No assignments yet</p>
                        )}
                    </div>
                )}
            </div>
        );
    };

    // Sub-component: AssignmentItem - matches goals.html structure
    const AssignmentItem = ({ assignment }) => {
        const isCompleted = assignment.status === 'completed';

        return (
            <div style={{
                background: isCompleted ? '#f0fff0' : 'white',
                border: `1px solid ${isCompleted ? '#c8e6c9' : '#e0e0e0'}`,
                padding: '12px',
                marginBottom: '8px',
                borderRadius: '4px',
                display: 'flex',
                alignItems: 'flex-start',
                gap: '10px'
            }}>
                <span style={{ marginTop: '2px' }}>
                    {isCompleted ? AdminIcons.CheckCircle({ size: 18, color: '#00A86B' }) : AdminIcons.Clock({ size: 18, color: '#FFA500' })}
                </span>
                <div style={{ flex: 1 }}>
                    <div style={{ fontWeight: '500', color: '#333' }}>
                        {assignment.title}
                    </div>
                    {assignment.description && (
                        <div style={{ fontSize: '0.85em', color: '#666', marginTop: '4px' }}>
                            {assignment.description}
                        </div>
                    )}
                    {assignment.reflection && (
                        <div style={{
                            background: '#e3f2fd',
                            padding: '8px',
                            borderRadius: '4px',
                            marginTop: '8px',
                            fontSize: '0.85em',
                            borderLeft: '3px solid #2196F3'
                        }}>
                            <strong style={{ color: '#1565C0' }}>PIR Reflection:</strong>
                            <div style={{ marginTop: '4px', color: '#424242' }}>
                                {assignment.reflection}
                            </div>
                        </div>
                    )}
                    <div style={{ fontSize: '0.8em', color: '#999', marginTop: '6px' }}>
                        {assignment.createdAt && `Created: ${formatDate(assignment.createdAt)}`}
                        {assignment.dueDate && ` • Due: ${formatDate(assignment.dueDate)}`}
                        {assignment.completedAt && ` • Completed: ${formatDate(assignment.completedAt)}`}
                    </div>
                </div>
            </div>
        );
    };

    // Main render function
    return (
        <div style={{ padding: '20px' }}>
            <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                marginBottom: '20px'
            }}>
                <h3 style={{
                    margin: 0,
                    color: '#333333',
                    fontSize: '18px',
                    fontWeight: '600'
                }}>
                    Recovery Journey Structure
                </h3>
                <div style={{ display: 'flex', gap: '10px' }}>
                    <button
                        className="btn btn-primary"
                        onClick={() => setShowGoldenThread(true)}
                        style={{
                            background: 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)',
                            border: 'none',
                            color: '#FFFFFF',
                            padding: '10px 20px',
                            borderRadius: '4px',
                            cursor: 'pointer',
                            fontWeight: '500',
                            transition: 'all 0.2s ease'
                        }}
                    >
                        + Golden Thread
                    </button>
                    <button
                        className="btn btn-secondary"
                        onClick={() => setShowAddGoal(true)}
                        style={{
                            background: '#00A86B',
                            border: 'none',
                            color: '#FFFFFF',
                            padding: '10px 20px',
                            borderRadius: '4px',
                            cursor: 'pointer',
                            fontWeight: '500',
                            transition: 'all 0.2s ease'
                        }}
                    >
                        + Add Goal
                    </button>
                </div>
            </div>

            {/* Goals list using GoalItem component */}
            {goals.length > 0 ? (
                goals.map(goal => <GoalItem key={goal.id} goal={goal} />)
            ) : (
                <div style={{
                    background: 'white',
                    borderRadius: '10px',
                    padding: '40px',
                    textAlign: 'center',
                    color: '#666666',
                    boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                }}>
                    <p style={{ fontSize: '15px', margin: '0 0 10px 0' }}>
                        No goals configured yet
                    </p>
                    <p style={{ fontSize: '13px', margin: 0 }}>
                        Click "Golden Thread" or "Add Goal" to get started
                    </p>
                </div>
            )}

            {/* Modals */}
            {showGoldenThread && (
                <CreateGoalModal
                    type="goldenThread"
                    selectedPIR={{ id: pirId, displayName: pirData?.displayName, email: pirData?.email }}
                    selectedParent={null}
                    currentUser={user}
                    onSubmit={handleCreateGoldenThread}
                    onClose={() => setShowGoldenThread(false)}
                />
            )}

            {showAddGoal && (
                <CreateGoalModal
                    type="goal"
                    selectedPIR={{ id: pirId }}
                    selectedParent={null}
                    currentUser={user}
                    onSubmit={handleAddGoal}
                    onClose={() => setShowAddGoal(false)}
                />
            )}

            {showAddObjective && (
                <CreateGoalModal
                    type="objective"
                    selectedPIR={{ id: pirId }}
                    selectedParent={selectedGoalForObjective}
                    currentUser={user}
                    onSubmit={handleAddObjective}
                    onClose={() => {
                        setShowAddObjective(false);
                        setSelectedGoalForObjective(null);
                    }}
                />
            )}

            {showAddAssignment && (
                <CreateGoalModal
                    type="assignment"
                    selectedPIR={{ id: pirId }}
                    selectedParent={selectedObjectiveForAssignment}
                    currentUser={user}
                    onSubmit={handleAddAssignment}
                    onClose={() => {
                        setShowAddAssignment(false);
                        setSelectedObjectiveForAssignment(null);
                    }}
                />
            )}
        </div>
    );
};

  const renderMilestonesTab = () => {
    // Calculate milestones based on sobriety date using same logic as getRecoveryMilestones
    const calculateMilestones = () => {
        if (!pirData?.sobrietyDate) return [];
        
        // Parse sobriety date in LOCAL timezone (Pacific) - SAME AS getRecoveryMilestones
        let startYear, startMonth, startDay;
        
        if (typeof pirData.sobrietyDate === 'string' && pirData.sobrietyDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
            [startYear, startMonth, startDay] = pirData.sobrietyDate.split('-').map(Number);
        } else if (pirData.sobrietyDate.toDate) {
            const d = pirData.sobrietyDate.toDate();
            startYear = d.getFullYear();
            startMonth = d.getMonth() + 1;
            startDay = d.getDate();
        } else if (pirData.sobrietyDate.seconds) {
            const d = new Date(pirData.sobrietyDate.seconds * 1000);
            startYear = d.getFullYear();
            startMonth = d.getMonth() + 1;
            startDay = d.getDate();
        } else {
            const d = new Date(pirData.sobrietyDate);
            startYear = d.getFullYear();
            startMonth = d.getMonth() + 1;
            startDay = d.getDate();
        }
        
        const startDate = new Date(startYear, startMonth - 1, startDay, 0, 0, 0, 0);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const allMilestones = [];
        
        // DAY-BASED MILESTONES (count exact days)
        const dayBased = [
            { days: 1, title: '24 Hours Clean', icon: 'star', description: 'The first day - the hardest step' },
            { days: 7, title: '1 Week Clean', icon: 'calendar', description: 'A full week of sobriety' },
            { days: 30, title: '1 Month Clean', icon: 'trophy', description: 'First major milestone' },
            { days: 60, title: '2 Months Clean', icon: 'award', description: 'Establishing new habits' },
            { days: 90, title: '3 Months Clean', icon: 'target', description: 'Quarter year achieved' },
            { days: 100, title: '100 Days Clean', icon: 'trophy', description: 'Triple digits!' },
            { days: 200, title: '200 Days Clean', icon: 'star', description: 'Incredible progress' },
            { days: 500, title: '500 Days Clean', icon: 'trophy', description: 'Over a year of dedication' },
            { days: 1000, title: '1000 Days Clean', icon: 'trophy', description: 'A thousand days strong' }
        ];
        
        dayBased.forEach(milestone => {
            const targetDate = new Date(startDate);
            targetDate.setDate(targetDate.getDate() + milestone.days - 1);
            const achieved = today >= targetDate;
            const daysUntil = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
            
            allMilestones.push({
                ...milestone,
                targetDate,
                achieved,
                daysUntil: achieved ? 0 : daysUntil,
                achievedDate: achieved ? targetDate : null,
                id: `day-${milestone.days}`
            });
        });
        
        // MONTHLY MILESTONES (same day of month)
        const monthBased = [
            { months: 4, title: '4 Months Clean', icon: 'star', description: 'Solid foundation built' },
            { months: 5, title: '5 Months Clean', icon: 'award', description: 'Five months of growth' },
            { months: 6, title: '6 Months Clean', icon: 'party', description: 'Half year milestone' },
            { months: 7, title: '7 Months Clean', icon: 'star', description: 'Seven months strong' },
            { months: 8, title: '8 Months Clean', icon: 'trophy', description: 'Eight months of progress' },
            { months: 9, title: '9 Months Clean', icon: 'diamond', description: 'Nine months of recovery' },
            { months: 10, title: '10 Months Clean', icon: 'award', description: 'Ten months achieved' },
            { months: 11, title: '11 Months Clean', icon: 'party', description: 'Almost a year!' },
            { months: 12, title: '1 Year Clean', icon: 'party', description: 'Full year of recovery' },
            { months: 18, title: '18 Months Clean', icon: 'star', description: 'A year and a half strong' }
        ];
        
        monthBased.forEach(milestone => {
            const targetDate = new Date(startYear, (startMonth - 1) + milestone.months, startDay, 0, 0, 0, 0);
            const achieved = today >= targetDate;
            const daysUntil = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
            
            allMilestones.push({
                days: Math.floor((targetDate - startDate) / (1000 * 60 * 60 * 24)) + 2,
                title: milestone.title,
                icon: milestone.icon,
                description: milestone.description,
                targetDate,
                achieved,
                daysUntil: achieved ? 0 : daysUntil,
                achievedDate: achieved ? targetDate : null,
                id: `month-${milestone.months}`
            });
        });
        
        // YEARLY MILESTONES (same month & day every year)
        const yearBased = [
            { years: 2, title: '2 Years Clean', icon: 'party', description: 'Two years of sobriety' },
            { years: 3, title: '3 Years Clean', icon: 'party', description: 'Three years of growth' },
            { years: 4, title: '4 Years Clean', icon: 'star', description: 'Four years strong' },
            { years: 5, title: '5 Years Clean', icon: 'star', description: 'Half a decade of recovery' },
            { years: 6, title: '6 Years Clean', icon: 'star', description: 'Six years of dedication' },
            { years: 7, title: '7 Years Clean', icon: 'star', description: 'Seven years achieved' },
            { years: 8, title: '8 Years Clean', icon: 'star', description: 'Eight years of sobriety' },
            { years: 9, title: '9 Years Clean', icon: 'star', description: 'Nine years strong' },
            { years: 10, title: '10 Years Clean', icon: 'diamond', description: 'A decade of sobriety' }
        ];

        // Add 11-20 years dynamically
        for (let year = 11; year <= 20; year++) {
            yearBased.push({
                years: year,
                title: `${year} Years Clean`,
                icon: 'star',
                description: `${year} years of recovery`
            });
        }
        
        yearBased.forEach(milestone => {
            const targetDate = new Date(startYear + milestone.years, startMonth - 1, startDay, 0, 0, 0, 0);
            const achieved = today >= targetDate;
            const daysUntil = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
            
            allMilestones.push({
                days: Math.floor((targetDate - startDate) / (1000 * 60 * 60 * 24)) + 2,
                title: milestone.title,
                icon: milestone.icon,
                description: milestone.description,
                targetDate,
                achieved,
                daysUntil: achieved ? 0 : daysUntil,
                achievedDate: achieved ? targetDate : null,
                id: `year-${milestone.years}`
            });
        });
        
        // Sort by target date
        allMilestones.sort((a, b) => a.targetDate - b.targetDate);
        
        return allMilestones;
    };
    
    const allMilestones = calculateMilestones();
    const achievedMilestones = allMilestones.filter(m => m.achieved);
    const upcomingMilestones = allMilestones.filter(m => !m.achieved).slice(0, 6);
    
    return (
        <div style={{ padding: '20px' }}>
            <h3 style={{ 
                marginBottom: '30px', 
                color: '#333333',
                fontSize: '18px',
                fontWeight: '600'
            }}>
                Recovery Milestones
            </h3>
            
            {/* Summary Stats */}
            <div style={{
                background: 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)',
                borderRadius: '12px',
                padding: '25px',
                marginBottom: '30px',
                color: '#FFFFFF',
                textAlign: 'center',
                boxShadow: '0 8px 20px rgba(0,119,204,0.3)'
            }}>
                <div style={{ fontSize: '48px', fontWeight: 'bold', marginBottom: '10px' }}>
                    {achievedMilestones.length}
                </div>
                <div style={{ fontSize: '18px', opacity: 0.9 }}>
                    Milestones Achieved
                </div>
                <div style={{ fontSize: '13px', opacity: 0.8, marginTop: '10px' }}>
                    {pirData?.sobrietyDays || 0} days of continuous sobriety
                </div>
            </div>
            
            {/* Achieved Milestones Section */}
            {achievedMilestones.length > 0 && (
                <>
                    <h4 style={{ 
                        marginBottom: '20px', 
                        color: '#333333',
                        fontSize: '16px',
                        fontWeight: '600'
                    }}>
                        <span style={{ display: 'inline-flex', alignItems: 'center', gap: '8px' }}>
                            {AdminIcons.Trophy({ size: 18, color: '#FFD700' })} Achieved Milestones
                        </span>
                    </h4>
                    <div style={{ 
                        display: 'grid', 
                        gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
                        gap: '20px',
                        marginBottom: '40px'
                    }}>
                        {achievedMilestones.map((milestone, index) => (
                            <div key={milestone.id || index} style={{
                                background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                                borderRadius: '12px',
                                padding: '20px',
                                boxShadow: '0 4px 8px rgba(0,0,0,0.15)',
                                position: 'relative',
                                overflow: 'hidden',
                                transform: 'scale(1)',
                                transition: 'all 0.2s ease',
                                cursor: 'pointer'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.05)'}
                            onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}>
                                <div style={{
                                    position: 'absolute',
                                    top: '10px',
                                    right: '10px',
                                    color: 'rgba(255,255,255,0.9)'
                                }}>
                                    {AdminIcons.CheckCircle({ size: 24, color: 'rgba(255,255,255,0.9)' })}
                                </div>
                                <div style={{
                                    marginBottom: '10px',
                                    textAlign: 'center',
                                    display: 'flex',
                                    justifyContent: 'center'
                                }}>
                                    {getMilestoneIcon(milestone.icon, { size: 36, color: 'white' })}
                                </div>
                                <h5 style={{
                                    margin: '0 0 10px 0',
                                    color: '#FFFFFF',
                                    textAlign: 'center',
                                    fontSize: '16px',
                                    fontWeight: 'bold'
                                }}>
                                    {milestone.title}
                                </h5>
                                <p style={{
                                    fontSize: '12px',
                                    color: 'rgba(255,255,255,0.9)',
                                    textAlign: 'center',
                                    margin: '0 0 10px 0'
                                }}>
                                    {milestone.description}
                                </p>
                                <div style={{
                                    fontSize: '11px',
                                    color: 'rgba(255,255,255,0.8)',
                                    textAlign: 'center',
                                    fontWeight: 'bold'
                                }}>
                                    Achieved on {formatDate(milestone.achievedDate)}
                                </div>
                            </div>
                        ))}
                    </div>
                </>
            )}
            
            {/* Upcoming Milestones Section */}
            {upcomingMilestones.length > 0 && (
                <>
                    <h4 style={{ 
                        marginBottom: '20px', 
                        color: '#333333',
                        fontSize: '16px',
                        fontWeight: '600'
                    }}>
                        <span style={{ display: 'inline-flex', alignItems: 'center', gap: '8px' }}>
                            {AdminIcons.Target({ size: 18, color: '#0077CC' })} Upcoming Milestones
                        </span>
                    </h4>
                    <div style={{ 
                        display: 'grid', 
                        gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
                        gap: '20px' 
                    }}>
                        {upcomingMilestones.map((milestone, index) => (
                            <div key={milestone.id || index} style={{
                                background: '#FFFFFF',
                                borderRadius: '12px',
                                padding: '20px',
                                boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                                border: '2px solid #e0e0e0',
                                position: 'relative',
                                overflow: 'hidden',
                                transform: 'scale(1)',
                                transition: 'all 0.2s ease',
                                cursor: 'pointer'
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.transform = 'scale(1.05)';
                                e.currentTarget.style.borderColor = '#0077CC';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.transform = 'scale(1)';
                                e.currentTarget.style.borderColor = '#e0e0e0';
                            }}>
                                {milestone.daysUntil <= 7 && (
                                    <div style={{
                                        position: 'absolute',
                                        top: '10px',
                                        right: '10px',
                                        background: '#FF9800',
                                        color: '#FFFFFF',
                                        padding: '2px 8px',
                                        borderRadius: '12px',
                                        fontSize: '10px',
                                        fontWeight: 'bold'
                                    }}>
                                        SOON!
                                    </div>
                                )}
                                <div style={{
                                    marginBottom: '10px',
                                    textAlign: 'center',
                                    display: 'flex',
                                    justifyContent: 'center',
                                    opacity: 0.7
                                }}>
                                    {getMilestoneIcon(milestone.icon, { size: 36, color: '#0077CC' })}
                                </div>
                                <h5 style={{
                                    margin: '0 0 10px 0',
                                    color: '#333333',
                                    textAlign: 'center',
                                    fontSize: '16px',
                                    fontWeight: 'bold'
                                }}>
                                    {milestone.title}
                                </h5>
                                <p style={{
                                    fontSize: '12px',
                                    color: '#666666',
                                    textAlign: 'center',
                                    margin: '0 0 15px 0'
                                }}>
                                    {milestone.description}
                                </p>
                                <div style={{
                                    background: '#f8f9fa',
                                    borderRadius: '20px',
                                    padding: '8px',
                                    textAlign: 'center'
                                }}>
                                    <div style={{
                                        fontSize: '20px',
                                        fontWeight: 'bold',
                                        color: milestone.daysUntil <= 7 ? '#FF9800' : '#0077CC'
                                    }}>
                                        {milestone.daysUntil}
                                    </div>
                                    <div style={{
                                        fontSize: '11px',
                                        color: '#999999',
                                        textTransform: 'uppercase'
                                    }}>
                                        days to go
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </>
            )}
            
            {allMilestones.length === 0 && (
                <div style={{
                    background: '#FFFFFF',
                    borderRadius: '12px',
                    padding: '40px',
                    textAlign: 'center',
                    color: '#666666',
                    boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                }}>
                    <p style={{ fontSize: '15px', margin: '0 0 10px 0' }}>
                        No milestones configured yet
                    </p>
                    <p style={{ fontSize: '13px', margin: 0 }}>
                        Milestones will appear once a sobriety date is set
                    </p>
                </div>
            )}
        </div>
    );
};

// Fixed renderCommunicationsTab
const renderCommunicationsTab = () => {
    const handleDeleteMessage = async (messageId, messageType) => {
        if (!confirm('Are you sure you want to delete this message?')) return;
        
        try {
            let collection = 'messages';
            if (messageType === 'community') collection = 'glrsChat';
            if (messageType === 'topic') collection = 'topicRoomMessages';
            
            await db.collection(collection).doc(messageId).delete();
            
            await db.collection('flaggedContent').add({
                originalCollection: collection,
                originalId: messageId,
                userId: pirId,
                flaggedBy: user.uid,
                reason: 'Deleted by coach',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await loadAllUserMessages();
            alert('Message deleted and flagged');
        } catch (error) {
            console.error('Error deleting message:', error);
            alert('Failed to delete message');
        }
    };
    
    return (
        <div style={{ padding: '20px' }}>
            <h3 style={{ 
                marginBottom: '20px', 
                color: '#333333',
                fontSize: '18px',
                fontWeight: '600'
            }}>
                Communication Activity
            </h3>
            
            {/* Message Stats */}
            <div style={{
                background: '#FFFFFF',
                borderRadius: '12px',
                padding: '20px',
                marginBottom: '20px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
            }}>
                <h4 style={{ 
                    marginBottom: '15px', 
                    color: '#333333',
                    fontSize: '16px',
                    fontWeight: '600'
                }}>
                    Engagement Metrics
                </h4>
                <div style={{ 
                    display: 'grid', 
                    gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', 
                    gap: '20px' 
                }}>
                    <div style={{ textAlign: 'center' }}>
                        <div style={{ 
                            fontSize: '36px', 
                            fontWeight: 'bold', 
                            color: '#2196F3' 
                        }}>
                            {allMessages.length}
                        </div>
                        <div style={{ 
                            color: '#666666',
                            fontSize: '13px'
                        }}>
                            Total Messages
                        </div>
                    </div>
                    <div style={{ textAlign: 'center' }}>
                        <div style={{ 
                            fontSize: '36px', 
                            fontWeight: 'bold', 
                            color: '#00A86B' 
                        }}>
                            {allMessages.filter(m => m.type === 'community').length}
                        </div>
                        <div style={{ 
                            color: '#666666',
                            fontSize: '13px'
                        }}>
                            Community Posts
                        </div>
                    </div>
                    <div style={{ textAlign: 'center' }}>
                        <div style={{ 
                            fontSize: '36px', 
                            fontWeight: 'bold', 
                            color: '#FF9800' 
                        }}>
                            {allMessages.filter(m => m.type === 'topic').length}
                        </div>
                        <div style={{ 
                            color: '#666666',
                            fontSize: '13px'
                        }}>
                            Topic Room Posts
                        </div>
                    </div>
                    <div style={{ textAlign: 'center' }}>
                        <div style={{ 
                            fontSize: '36px', 
                            fontWeight: 'bold', 
                            color: '#9C27B0' 
                        }}>
                            {allMessages.filter(m => m.type === 'direct').length}
                        </div>
                        <div style={{ 
                            color: '#666666',
                            fontSize: '13px'
                        }}>
                            Direct Messages
                        </div>
                    </div>
                </div>
            </div>

            {/* All Messages with Moderation Controls */}
            <div style={{
                background: '#FFFFFF',
                borderRadius: '12px',
                padding: '20px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
            }}>
                <h4 style={{ 
                    marginBottom: '15px', 
                    color: '#333333',
                    fontSize: '16px',
                    fontWeight: '600'
                }}>
                    Message History
                </h4>
                {allMessages.length > 0 ? (
                    <div style={{ maxHeight: '600px', overflowY: 'auto' }}>
                        {allMessages.map(message => (
                            <div key={message.id} style={{
                                padding: '15px',
                                borderBottom: '1px solid #e0e0e0',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'start'
                            }}>
                                <div style={{ flex: 1 }}>
                                    <div style={{ display: 'flex', gap: '10px', marginBottom: '5px' }}>
                                        <span style={{
                                            background: message.type === 'community' ? '#00A86B' :
                                                       message.type === 'topic' ? '#FF9800' : 
                                                       '#2196F3',
                                            color: '#FFFFFF',
                                            padding: '2px 8px',
                                            borderRadius: '12px',
                                            fontSize: '10px',
                                            fontWeight: 'bold'
                                        }}>
                                            {message.type.toUpperCase()}
                                        </span>
                                        {message.roomId && (
                                            <span style={{ 
                                                fontSize: '12px', 
                                                color: '#999999' 
                                            }}>
                                                Room: {message.roomId}
                                            </span>
                                        )}
                                        <span style={{ 
                                            fontSize: '12px', 
                                            color: '#999999' 
                                        }}>
                                            {formatTimeAgo(message.createdAt)}
                                        </span>
                                    </div>
                                    <div style={{ color: '#333333', fontSize: '13px' }}>
                                        {message.content || message.text || message.message || 'No content'}
                                    </div>
                                    {message.imageUrl && (
                                        <div style={{ marginTop: '10px' }}>
                                            <img 
                                                src={message.imageUrl} 
                                                alt="Message attachment" 
                                                style={{ 
                                                    maxWidth: '200px', 
                                                    borderRadius: '4px' 
                                                }}
                                            />
                                        </div>
                                    )}
                                </div>
                                <div style={{ display: 'flex', gap: '10px' }}>
                                    <button
                                        onClick={() => handleDeleteMessage(message.id, message.type)}
                                        style={{
                                            background: '#DC143C',
                                            color: '#FFFFFF',
                                            border: 'none',
                                            padding: '5px 10px',
                                            borderRadius: '4px',
                                            cursor: 'pointer',
                                            fontSize: '12px',
                                            fontWeight: '500',
                                            transition: 'all 0.2s ease'
                                        }}
                                    >
                                        Delete
                                    </button>
                                    <button
                                        onClick={async () => {
                                            try {
                                                await db.collection('flaggedContent').add({
                                                    messageId: message.id,
                                                    messageType: message.type,
                                                    userId: pirId,
                                                    flaggedBy: user.uid,
                                                    reason: 'Flagged for review',
                                                    content: message.content || message.text,
                                                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                                });
                                                alert('Message flagged for review');
                                            } catch (error) {
                                                console.error('Error flagging message:', error);
                                                alert('Failed to flag message');
                                            }
                                        }}
                                        style={{
                                            background: '#FF9800',
                                            color: '#FFFFFF',
                                            border: 'none',
                                            padding: '5px 10px',
                                            borderRadius: '4px',
                                            cursor: 'pointer',
                                            fontSize: '12px',
                                            fontWeight: '500',
                                            transition: 'all 0.2s ease'
                                        }}
                                    >
                                        Flag
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                ) : (
                    <p style={{ 
                        color: '#666666', 
                        padding: '20px', 
                        textAlign: 'center',
                        fontSize: '13px'
                    }}>
                        No messages sent yet
                    </p>
                )}
            </div>
        </div>
    );
};

const renderResourcesTab = () => (
    <div style={{ padding: '20px' }}>
        <div style={{ 
            display: 'flex', 
            justifyContent: 'space-between', 
            alignItems: 'center', 
            marginBottom: '20px' 
        }}>
            <h3 style={{ 
                margin: 0, 
                color: '#333333',
                fontSize: '18px',
                fontWeight: '600'
            }}>
                Resource Management
            </h3>
            <div style={{ display: 'flex', gap: '10px' }}>
                <button
                    className="btn btn-primary"
                    onClick={() => setShowAssignResource(true)}
                    style={{
                        background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                        border: 'none',
                        color: '#FFFFFF',
                        padding: '10px 20px',
                        borderRadius: '4px',
                        cursor: 'pointer',
                        fontWeight: '500',
                        transition: 'all 0.2s ease'
                    }}
                >
                    Assign Resource
                </button>
                <button
                    className="btn btn-primary"
                    onClick={() => setShowCreateResource(true)}
                    style={{
                        background: 'linear-gradient(135deg, #9C27B0 0%, #673AB7 100%)',
                        border: 'none',
                        color: '#FFFFFF',
                        padding: '10px 20px',
                        borderRadius: '4px',
                        cursor: 'pointer',
                        fontWeight: '500',
                        transition: 'all 0.2s ease'
                    }}
                >
                    Create Resource
                </button>
            </div>
        </div>
        
        {['education', 'coping', 'daily', 'life', 'support', 'relapse'].map(category => {
            const categoryResources = resources.filter(r => r.category === category);
            if (categoryResources.length === 0) return null;
            
            return (
                <div key={category} style={{
                    background: '#FFFFFF',
                    borderRadius: '12px',
                    padding: '20px',
                    marginBottom: '20px',
                    boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                }}>
                    <h4 style={{ 
                        marginBottom: '15px', 
                        color: '#333333', 
                        textTransform: 'capitalize',
                        fontSize: '16px',
                        fontWeight: '600'
                    }}>
                        {category} Resources ({categoryResources.length})
                    </h4>
                    <div style={{ display: 'grid', gap: '10px' }}>
                        {categoryResources.map(resource => (
                            <div key={resource.id} style={{
                                padding: '15px',
                                background: '#f8f9fa',
                                borderRadius: '8px',
                                borderLeft: `3px solid ${
                                    resourceProgress[resource.id]?.status === 'completed' ? '#00A86B' :
                                    resourceProgress[resource.id]?.status === 'in-progress' ? '#FF9800' :
                                    '#2196F3'
                                }`,
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center'
                            }}>
                                <div style={{ flex: 1 }}>
                                    <strong style={{ 
                                        color: '#333333',
                                        fontSize: '13px',
                                        fontWeight: '600'
                                    }}>
                                        {resource.title}
                                    </strong>
                                    <p style={{ 
                                        fontSize: '12px', 
                                        color: '#666666', 
                                        margin: '5px 0' 
                                    }}>
                                        {resource.description}
                                    </p>
                                    {resource.url && (
                                        <a 
                                            href={resource.url} 
                                            target="_blank" 
                                            rel="noopener noreferrer"
                                            style={{
                                                fontSize: '11px',
                                                color: '#0077CC',
                                                textDecoration: 'none',
                                                fontWeight: '500'
                                            }}
                                        >
                                            View Resource →
                                        </a>
                                    )}
                                </div>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                    <span style={{
                                        background: resourceProgress[resource.id]?.status === 'completed' ? '#00A86B' :
                                                   resourceProgress[resource.id]?.status === 'in-progress' ? '#FF9800' :
                                                   '#e0e0e0',
                                        color: '#FFFFFF',
                                        padding: '4px 8px',
                                        borderRadius: '12px',
                                        fontSize: '10px',
                                        fontWeight: 'bold'
                                    }}>
                                        {resourceProgress[resource.id]?.status || 'Not Started'}
                                    </span>
                                    <button
                                        onClick={async () => {
                                            if (confirm('Are you sure you want to unassign this resource?')) {
                                                try {
                                                    await db.collection('resources').doc(resource.id).update({
                                                        assignedTo: firebase.firestore.FieldValue.arrayRemove(pirId)
                                                    });
                                                    await loadResourcesData();
                                                    alert('Resource unassigned successfully');
                                                } catch (error) {
                                                    console.error('Error unassigning resource:', error);
                                                    alert('Failed to unassign resource');
                                                }
                                            }
                                        }}
                                        style={{
                                            background: '#DC143C',
                                            color: '#FFFFFF',
                                            border: 'none',
                                            padding: '4px 8px',
                                            borderRadius: '4px',
                                            cursor: 'pointer',
                                            fontSize: '10px',
                                            fontWeight: '600',
                                            transition: 'all 0.2s ease'
                                        }}
                                    >
                                        Unassign
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        })}

        {/* Assign Resource Modal */}
        {showAssignResource && (
            <div style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0,0,0,0.5)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 10000
            }}>
                <div style={{
                    background: '#FFFFFF',
                    padding: '30px',
                    borderRadius: '12px',
                    width: '600px',
                    maxWidth: '90%',
                    maxHeight: '80vh',
                    overflow: 'auto',
                    boxShadow: '0 8px 16px rgba(0,0,0,0.2)'
                }}>
                    <h3 style={{ 
                        marginBottom: '20px',
                        color: '#333333',
                        fontSize: '18px',
                        fontWeight: '600'
                    }}>
                        Assign Resource to {pirData?.firstName || 'PIR'}
                    </h3>
                    
                    <div style={{ marginBottom: '20px' }}>
                        <label style={{ 
                            display: 'block', 
                            marginBottom: '10px', 
                            color: '#666666',
                            fontSize: '13px',
                            fontWeight: '500'
                        }}>
                            Select Resource to Assign:
                        </label>
                        <select 
                            id="resource-select"
                            style={{
                                width: '100%',
                                padding: '10px',
                                borderRadius: '4px',
                                border: '1px solid #e0e0e0',
                                fontSize: '13px',
                                color: '#333333'
                            }}
                        >
                            <option value="">Choose a resource...</option>
                            {resources.filter(r => !r.assignedTo?.includes(pirId)).map(resource => (
                                <option key={resource.id} value={resource.id}>
                                    {resource.title} ({resource.category})
                                </option>
                            ))}
                        </select>
                    </div>
                    
                    <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                        <button
                            onClick={() => setShowAssignResource(false)}
                            style={{
                                padding: '10px 20px',
                                borderRadius: '4px',
                                border: '1px solid #e0e0e0',
                                background: '#FFFFFF',
                                color: '#333333',
                                cursor: 'pointer',
                                fontSize: '13px',
                                fontWeight: '500',
                                transition: 'all 0.2s ease'
                            }}
                        >
                            Cancel
                        </button>
                        <button
                            onClick={async () => {
                                const select = document.getElementById('resource-select');
                                const resourceId = select.value;
                                if (resourceId) {
                                    try {
                                        await db.collection('resources').doc(resourceId).update({
                                            assignedTo: firebase.firestore.FieldValue.arrayUnion(pirId)
                                        });
                                        await loadResourcesData();
                                        setShowAssignResource(false);
                                        alert('Resource assigned successfully');
                                    } catch (error) {
                                        console.error('Error assigning resource:', error);
                                        alert('Failed to assign resource');
                                    }
                                } else {
                                    alert('Please select a resource');
                                }
                            }}
                            style={{
                                padding: '10px 20px',
                                borderRadius: '4px',
                                border: 'none',
                                background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                                color: '#FFFFFF',
                                cursor: 'pointer',
                                fontSize: '13px',
                                fontWeight: '500',
                                transition: 'all 0.2s ease'
                            }}
                        >
                            Assign Resource
                        </button>
                    </div>
                </div>
            </div>
        )}

        {/* Create Resource Modal */}
        {showCreateResource && (
            <div style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0,0,0,0.5)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 10000
            }}>
                <div style={{
                    background: '#FFFFFF',
                    padding: '30px',
                    borderRadius: '12px',
                    width: '600px',
                    maxWidth: '90%',
                    boxShadow: '0 8px 16px rgba(0,0,0,0.2)'
                }}>
                    <h3 style={{ 
                        marginBottom: '20px',
                        color: '#333333',
                        fontSize: '18px',
                        fontWeight: '600'
                    }}>
                        Create New Resource
                    </h3>
                    
                    <form onSubmit={async (e) => {
                        e.preventDefault();
                        const form = e.target;
                        try {
                            await db.collection('resources').add({
                                title: form.title.value,
                                description: form.description.value,
                                category: form.category.value,
                                url: form.url.value || null,
                                assignedTo: [pirId],
                                createdBy: user.uid,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            await loadResourcesData();
                            setShowCreateResource(false);
                            alert('Resource created and assigned successfully');
                        } catch (error) {
                            console.error('Error creating resource:', error);
                            alert('Failed to create resource');
                        }
                    }}>
                        <div style={{ marginBottom: '15px' }}>
                            <label style={{ 
                                display: 'block', 
                                marginBottom: '5px',
                                color: '#666666',
                                fontSize: '13px',
                                fontWeight: '500'
                            }}>
                                Title *
                            </label>
                            <input
                                name="title"
                                type="text"
                                required
                                style={{
                                    width: '100%',
                                    padding: '8px',
                                    borderRadius: '4px',
                                    border: '1px solid #e0e0e0',
                                    fontSize: '13px',
                                    color: '#333333'
                                }}
                            />
                        </div>
                        
                        <div style={{ marginBottom: '15px' }}>
                            <label style={{ 
                                display: 'block', 
                                marginBottom: '5px',
                                color: '#666666',
                                fontSize: '13px',
                                fontWeight: '500'
                            }}>
                                Description *
                            </label>
                            <textarea
                                name="description"
                                required
                                rows="3"
                                style={{
                                    width: '100%',
                                    padding: '8px',
                                    borderRadius: '4px',
                                    border: '1px solid #e0e0e0',
                                    fontSize: '13px',
                                    color: '#333333'
                                }}
                            />
                        </div>
                        
                        <div style={{ marginBottom: '15px' }}>
                            <label style={{ 
                                display: 'block', 
                                marginBottom: '5px',
                                color: '#666666',
                                fontSize: '13px',
                                fontWeight: '500'
                            }}>
                                Category *
                            </label>
                            <select
                                name="category"
                                required
                                style={{
                                    width: '100%',
                                    padding: '8px',
                                    borderRadius: '4px',
                                    border: '1px solid #e0e0e0',
                                    fontSize: '13px',
                                    color: '#333333'
                                }}
                            >
                                <option value="">Select category...</option>
                                <option value="education">Education</option>
                                <option value="coping">Coping</option>
                                <option value="daily">Daily</option>
                                <option value="life">Life</option>
                                <option value="support">Support</option>
                                <option value="relapse">Relapse Prevention</option>
                            </select>
                        </div>
                        
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{ 
                                display: 'block', 
                                marginBottom: '5px',
                                color: '#666666',
                                fontSize: '13px',
                                fontWeight: '500'
                            }}>
                                URL (optional)
                            </label>
                            <input
                                name="url"
                                type="url"
                                placeholder="https://..."
                                style={{
                                    width: '100%',
                                    padding: '8px',
                                    borderRadius: '4px',
                                    border: '1px solid #e0e0e0',
                                    fontSize: '13px',
                                    color: '#333333'
                                }}
                            />
                        </div>
                        
                        <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                            <button
                                type="button"
                                onClick={() => setShowCreateResource(false)}
                                style={{
                                    padding: '10px 20px',
                                    borderRadius: '4px',
                                    border: '1px solid #e0e0e0',
                                    background: '#FFFFFF',
                                    color: '#333333',
                                    cursor: 'pointer',
                                    fontSize: '13px',
                                    fontWeight: '500',
                                    transition: 'all 0.2s ease'
                                }}
                            >
                                Cancel
                            </button>
                            <button
                                type="submit"
                                style={{
                                    padding: '10px 20px',
                                    borderRadius: '4px',
                                    border: 'none',
                                    background: 'linear-gradient(135deg, #9C27B0 0%, #673AB7 100%)',
                                    color: '#FFFFFF',
                                    cursor: 'pointer',
                                    fontSize: '13px',
                                    fontWeight: '500',
                                    transition: 'all 0.2s ease'
                                }}
                            >
                                Create Resource
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        )}
    </div>
);

const renderActivityTab = () => (
    <div style={{ padding: '20px' }}>
        <h3 style={{ 
            marginBottom: '20px', 
            color: '#333333',
            fontSize: '18px',
            fontWeight: '600'
        }}>
            Complete Activity Feed
        </h3>
        
        <div style={{
            background: '#FFFFFF',
            borderRadius: '12px',
            padding: '20px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
            <div style={{ maxHeight: '600px', overflowY: 'auto' }}>
                {activities.length > 0 ? (
                    activities.map(activity => (
                        <div key={activity.id} style={{
                            padding: '15px',
                            borderBottom: '1px solid #e0e0e0',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '15px'
                        }}>
                            <div style={{
                                width: '40px',
                                height: '40px',
                                borderRadius: '50%',
                                background: getActivityColor(activity.type),
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '20px',
                                flexShrink: 0
                            }}>
                                {getActivityIcon(activity.type)}
                            </div>
                            <div style={{ flex: 1 }}>
                                <div style={{ 
                                    fontWeight: 'bold', 
                                    color: '#333333',
                                    fontSize: '13px'
                                }}>
                                    {activity.description || activity.type?.replace(/_/g, ' ').toUpperCase()}
                                </div>
                                <div style={{ 
                                    fontSize: '11px', 
                                    color: '#999999', 
                                    marginTop: '5px' 
                                }}>
                                    {formatTimeAgo(activity.createdAt)}
                                </div>
                            </div>
                        </div>
                    ))
                ) : (
                    <p style={{ 
                        color: '#666666',
                        textAlign: 'center',
                        padding: '20px',
                        fontSize: '13px'
                    }}>
                        No activity recorded
                    </p>
                )}
            </div>
        </div>
    </div>
);

const renderFinancialTab = () => (
    <div style={{ padding: '20px' }}>
        <h3 style={{ 
            marginBottom: '20px', 
            color: '#333333',
            fontSize: '18px',
            fontWeight: '600'
        }}>
            Financial Impact
        </h3>
        
        <div style={{
            background: 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)',
            borderRadius: '12px',
            padding: '30px',
            marginBottom: '20px',
            color: '#FFFFFF',
            textAlign: 'center',
            boxShadow: '0 8px 20px rgba(0,119,204,0.3)'
        }}>
            <div style={{ fontSize: '48px', fontWeight: 'bold' }}>
                ${pirData?.moneySaved || 0}
            </div>
            <div style={{ fontSize: '18px', opacity: 0.9 }}>
                Total Saved in Recovery
            </div>
            <div style={{ fontSize: '13px', opacity: 0.8, marginTop: '10px' }}>
                Based on ${pirData?.dailyCost || 20}/day
            </div>
        </div>

        <div style={{ 
            display: 'grid', 
            gridTemplateColumns: '1fr 1fr', 
            gap: '20px' 
        }}>
            <div style={{
                background: '#FFFFFF',
                borderRadius: '12px',
                padding: '20px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
            }}>
                <h4 style={{ 
                    marginBottom: '15px', 
                    color: '#333333',
                    fontSize: '16px',
                    fontWeight: '600'
                }}>
                    Monthly Projection
                </h4>
                <div style={{ 
                    fontSize: '32px', 
                    fontWeight: 'bold', 
                    color: '#00A86B' 
                }}>
                    ${(pirData?.dailyCost || 20) * 30}
                </div>
                <div style={{ 
                    fontSize: '12px', 
                    color: '#666666' 
                }}>
                    Saved per month
                </div>
            </div>

            <div style={{
                background: '#FFFFFF',
                borderRadius: '12px',
                padding: '20px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
            }}>
                <h4 style={{ 
                    marginBottom: '15px', 
                    color: '#333333',
                    fontSize: '16px',
                    fontWeight: '600'
                }}>
                    Yearly Projection
                </h4>
                <div style={{ 
                    fontSize: '32px', 
                    fontWeight: 'bold', 
                    color: '#2196F3' 
                }}>
                    ${(pirData?.dailyCost || 20) * 365}
                </div>
                <div style={{ 
                    fontSize: '12px', 
                    color: '#666666' 
                }}>
                    Saved per year
                </div>
            </div>
        </div>
    </div>
);

const renderCommunityTab = () => (
    <div style={{ padding: '20px' }}>
        <h3 style={{ 
            marginBottom: '30px', 
            color: '#333333',
            fontSize: '18px',
            fontWeight: '600'
        }}>
            Community Engagement
        </h3>
        
        {/* Community Stats Overview */}
        <div style={{
            background: 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)',
            borderRadius: '12px',
            padding: '20px',
            marginBottom: '30px',
            color: '#FFFFFF',
            boxShadow: '0 8px 20px rgba(0,119,204,0.3)'
        }}>
            <div style={{ 
                display: 'grid', 
                gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', 
                gap: '20px' 
            }}>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '32px', fontWeight: 'bold' }}>
                        {meetings.filter(m => m.status === 'scheduled').length}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.9 }}>Upcoming Meetings</div>
                </div>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '32px', fontWeight: 'bold' }}>
                        {topicRooms.filter(room => 
                            room.members?.includes(pirId) || room.activeParticipants?.includes(pirId)
                        ).length}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.9 }}>Topic Rooms</div>
                </div>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '32px', fontWeight: 'bold' }}>
                        {supportGroups.filter(group => 
                            group.members?.includes(pirId) || group.participants?.includes(pirId)
                        ).length}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.9 }}>Support Groups</div>
                </div>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '32px', fontWeight: 'bold' }}>
                        {allMessages.filter(m => m.type === 'community').length}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.9 }}>Community Posts</div>
                </div>
            </div>
        </div>

        {/* Scheduled Meetings Section */}
        <div style={{
            background: '#FFFFFF',
            borderRadius: '12px',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
            <h4 style={{ 
                marginBottom: '20px', 
                color: '#333333',
                fontSize: '16px',
                fontWeight: '600'
            }}>
                <span style={{ display: 'inline-flex', alignItems: 'center', gap: '8px' }}>
                    {AdminIcons.Calendar({ size: 18, color: '#0077CC' })} Scheduled Meetings
                </span>
            </h4>
            {meetings && meetings.filter(m => 
                (m.pirId === pirId || m.pirIds?.includes(pirId) || m.isGlobal) && 
                m.status === 'scheduled'
            ).length > 0 ? (
                <div style={{ display: 'grid', gap: '15px' }}>
                    {meetings.filter(m => 
                        (m.pirId === pirId || m.pirIds?.includes(pirId) || m.isGlobal) && 
                        m.status === 'scheduled'
                    ).map(meeting => (
                        <div key={meeting.id} style={{
                            padding: '15px',
                            background: '#f8f9fa',
                            borderRadius: '8px',
                            borderLeft: '4px solid #2196F3'
                        }}>
                            <div style={{ 
                                display: 'flex', 
                                justifyContent: 'space-between', 
                                alignItems: 'center' 
                            }}>
                                <div>
                                    <h5 style={{ 
                                        margin: '0 0 10px 0', 
                                        color: '#333333',
                                        fontSize: '15px',
                                        fontWeight: '600'
                                    }}>
                                        {meeting.meetingTitle || meeting.title || 'Recovery Session'}
                                    </h5>
                                    <div style={{ 
                                        display: 'flex', 
                                        gap: '15px', 
                                        fontSize: '13px', 
                                        color: '#666666' 
                                    }}>
                                        <span style={{ display: 'inline-flex', alignItems: 'center', gap: '4px' }}>
                                            {AdminIcons.Calendar({ size: 14, color: '#666666' })} {formatDate(meeting.scheduledTime)}
                                        </span>
                                        <span style={{ display: 'inline-flex', alignItems: 'center', gap: '4px' }}>
                                            {AdminIcons.Clock({ size: 14, color: '#666666' })} {new Date(meeting.scheduledTime?.toDate ?
                                            meeting.scheduledTime.toDate() :
                                            meeting.scheduledTime).toLocaleTimeString('en-US', {
                                                hour: 'numeric',
                                                minute: '2-digit',
                                                hour12: true
                                            })}
                                        </span>
                                        <span style={{ display: 'inline-flex', alignItems: 'center', gap: '4px' }}>
                                            {AdminIcons.FileText({ size: 14, color: '#666666' })} {meeting.type || 'Group Session'}
                                        </span>
                                    </div>
                                    {meeting.notes && (
                                        <p style={{ 
                                            margin: '10px 0 0 0', 
                                            fontSize: '12px', 
                                            color: '#666666' 
                                        }}>
                                            {meeting.notes}
                                        </p>
                                    )}
                                </div>
                                <div style={{ 
                                    display: 'flex', 
                                    flexDirection: 'column', 
                                    gap: '5px' 
                                }}>
                                    {meeting.isGlobal && (
                                        <span style={{
                                            background: '#00A86B',
                                            color: '#FFFFFF',
                                            padding: '4px 8px',
                                            borderRadius: '12px',
                                            fontSize: '10px',
                                            textAlign: 'center',
                                            fontWeight: 'bold'
                                        }}>
                                            ALL PIRS
                                        </span>
                                    )}
                                    {meeting.meetingLink && (
                                        <a 
                                            href={meeting.meetingLink} 
                                            target="_blank" 
                                            rel="noopener noreferrer"
                                            style={{
                                                background: '#2196F3',
                                                color: '#FFFFFF',
                                                padding: '6px 12px',
                                                borderRadius: '4px',
                                                textDecoration: 'none',
                                                fontSize: '12px',
                                                textAlign: 'center',
                                                fontWeight: '500'
                                            }}
                                        >
                                            Join Meeting
                                        </a>
                                    )}
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            ) : (
                <p style={{ 
                    color: '#666666', 
                    textAlign: 'center', 
                    padding: '20px',
                    fontSize: '13px'
                }}>
                    No upcoming meetings scheduled
                </p>
            )}
        </div>

        {/* Topic Rooms Section */}
        <div style={{
            background: '#FFFFFF',
            borderRadius: '12px',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
            <h4 style={{ 
                marginBottom: '20px', 
                color: '#333333',
                fontSize: '16px',
                fontWeight: '600'
            }}>
                <span style={{ display: 'inline-flex', alignItems: 'center', gap: '8px' }}>
                    {AdminIcons.MessageSquare({ size: 18, color: '#0077CC' })} Topic Rooms
                </span>
            </h4>
            {topicRooms && topicRooms.length > 0 ? (
                <div style={{ 
                    display: 'grid', 
                    gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', 
                    gap: '15px' 
                }}>
                    {topicRooms.map(room => {
                        const isMember = room.members?.includes(pirId) || 
                                        room.activeParticipants?.includes(pirId);
                        return (
                            <div key={room.id} style={{
                                padding: '15px',
                                background: isMember ? 'rgba(33, 150, 243, 0.1)' : '#f8f9fa',
                                borderRadius: '8px',
                                border: isMember ? '2px solid #2196F3' : '1px solid #e0e0e0',
                                position: 'relative'
                            }}>
                                {isMember && (
                                    <span style={{
                                        position: 'absolute',
                                        top: '10px',
                                        right: '10px',
                                        background: '#00A86B',
                                        color: '#FFFFFF',
                                        padding: '2px 6px',
                                        borderRadius: '10px',
                                        fontSize: '10px',
                                        fontWeight: 'bold'
                                    }}>
                                        MEMBER
                                    </span>
                                )}
                                <h5 style={{ 
                                    margin: '0 0 10px 0', 
                                    color: '#333333',
                                    fontSize: '15px',
                                    fontWeight: '600'
                                }}>
                                    {room.name}
                                </h5>
                                <p style={{ 
                                    fontSize: '12px', 
                                    color: '#666666', 
                                    margin: '0 0 10px 0' 
                                }}>
                                    {room.description}
                                </p>
                                <div style={{ 
                                    fontSize: '11px', 
                                    color: '#999999' 
                                }}>
                                    👥 {room.members?.length || 0} members
                                    {room.lastActivity && (
                                        <span style={{ marginLeft: '10px' }}>
                                            Last active: {formatTimeAgo(room.lastActivity)}
                                        </span>
                                    )}
                                </div>
                            </div>
                        );
                    })}
                </div>
            ) : (
                <p style={{ 
                    color: '#666666', 
                    textAlign: 'center', 
                    padding: '20px',
                    fontSize: '13px'
                }}>
                    No topic rooms available
                </p>
            )}
        </div>

        {/* Support Groups Section */}
        <div style={{
            background: '#FFFFFF',
            borderRadius: '12px',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
            <h4 style={{ 
                marginBottom: '20px', 
                color: '#333333',
                fontSize: '16px',
                fontWeight: '600'
            }}>
                <span style={{ display: 'inline-flex', alignItems: 'center', gap: '8px' }}>
                    {AdminIcons.Users({ size: 18, color: '#9C27B0' })} Support Groups
                </span>
            </h4>
            {supportGroups && supportGroups.length > 0 ? (
                <div style={{ display: 'grid', gap: '15px' }}>
                    {supportGroups.map(group => {
                        const isMember = group.members?.includes(pirId) || 
                                        group.participants?.includes(pirId);
                        return (
                            <div key={group.id} style={{
                                padding: '20px',
                                background: isMember ? 'rgba(156, 39, 176, 0.05)' : '#f8f9fa',
                                borderRadius: '8px',
                                borderLeft: `4px solid ${isMember ? '#9C27B0' : '#e0e0e0'}`
                            }}>
                                <div style={{ 
                                    display: 'flex', 
                                    justifyContent: 'space-between', 
                                    alignItems: 'start' 
                                }}>
                                    <div style={{ flex: 1 }}>
                                        <h5 style={{ 
                                            margin: '0 0 10px 0', 
                                            color: '#333333',
                                            fontSize: '15px',
                                            fontWeight: '600'
                                        }}>
                                            {group.name}
                                        </h5>
                                        <p style={{ 
                                            fontSize: '13px', 
                                            color: '#666666', 
                                            margin: '0 0 10px 0' 
                                        }}>
                                            {group.description}
                                        </p>
                                        {group.meetingSchedule && (
                                            <div style={{ 
                                                fontSize: '12px', 
                                                color: '#666666' 
                                            }}>
                                                <span style={{ display: 'inline-flex', alignItems: 'center', gap: '4px' }}>
                                                    {AdminIcons.Calendar({ size: 12, color: '#666666' })} Meets: {group.meetingSchedule}
                                                </span>
                                            </div>
                                        )}
                                        <div style={{ 
                                            fontSize: '11px', 
                                            color: '#999999', 
                                            marginTop: '10px' 
                                        }}>
                                            👥 {group.members?.length || 0} members
                                            {group.facilitator && (
                                                <span style={{ marginLeft: '15px' }}>
                                                    Facilitated by: {group.facilitator}
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                    {isMember && (
                                        <span style={{
                                            background: '#9C27B0',
                                            color: '#FFFFFF',
                                            padding: '4px 12px',
                                            borderRadius: '12px',
                                            fontSize: '11px',
                                            fontWeight: 'bold'
                                        }}>
                                            ENROLLED
                                        </span>
                                    )}
                                </div>
                            </div>
                        );
                    })}
                </div>
            ) : (
                <p style={{ 
                    color: '#666666', 
                    textAlign: 'center', 
                    padding: '20px',
                    fontSize: '13px'
                }}>
                    No support groups available
                </p>
            )}
        </div>

        {/* Recent Community Activity */}
        <div style={{
            background: '#FFFFFF',
            borderRadius: '12px',
            padding: '20px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
            <h4 style={{ 
                marginBottom: '20px', 
                color: '#333333',
                fontSize: '16px',
                fontWeight: '600'
            }}>
                🌐 Recent Community Activity
            </h4>
            {allMessages.filter(m => m.type === 'community' || m.type === 'topic').length > 0 ? (
                <div style={{ maxHeight: '300px', overflowY: 'auto' }}>
                    {allMessages
                        .filter(m => m.type === 'community' || m.type === 'topic')
                        .slice(0, 10)
                        .map(message => (
                        <div key={message.id} style={{
                            padding: '10px',
                            borderBottom: '1px solid #e0e0e0',
                            fontSize: '13px'
                        }}>
                            <div style={{ 
                                display: 'flex', 
                                gap: '10px', 
                                marginBottom: '5px' 
                            }}>
                                <span style={{
                                    background: message.type === 'community' ? '#00A86B' : '#FF9800',
                                    color: '#FFFFFF',
                                    padding: '2px 6px',
                                    borderRadius: '8px',
                                    fontSize: '10px',
                                    fontWeight: 'bold'
                                }}>
                                    {message.type === 'community' ? 'COMMUNITY' : 'TOPIC'}
                                </span>
                                <span style={{ 
                                    color: '#999999', 
                                    fontSize: '11px' 
                                }}>
                                    {formatTimeAgo(message.createdAt)}
                                </span>
                            </div>
                            <div style={{ color: '#333333' }}>
                                {message.content || message.text || 'Posted a message'}
                            </div>
                        </div>
                    ))}
                </div>
            ) : (
                <p style={{ 
                    color: '#666666', 
                    textAlign: 'center', 
                    padding: '20px',
                    fontSize: '13px'
                }}>
                    No recent community activity
                </p>
            )}
        </div>
    </div>
);
    // ========== MAIN MODAL RENDER ==========
    if (loading) {
        return (
            <div style={{
                position: 'fixed',
                top: 0, left: 0, right: 0, bottom: 0,
                background: 'rgba(0,0,0,0.7)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 10000
            }}>
                <div style={{
                    background: '#FFFFFF',
                    padding: '40px',
                    borderRadius: '12px',
                    textAlign: 'center'
                }}>
                    <div style={{ marginBottom: '20px' }}>{AdminIcons.Clock({ size: 32, color: '#0077CC' })}</div>
                    <div style={{ color: '#333333' }}>Loading PIR data...</div>
                </div>
            </div>
        );
    }

    if (!pirData) return null;
   return (
    <div className="modal-overlay" style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        background: 'rgba(0, 0, 0, 0.5)',
        backdropFilter: 'blur(5px)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        zIndex: 1000,
        animation: 'fadeIn 0.3s ease-in-out'
    }}>
        <div className="modal-content" style={{
            maxWidth: '1600px',
            width: '98%',
            maxHeight: '92vh',
            background: '#FFFFFF',
            borderRadius: '16px',
            boxShadow: '0 12px 24px rgba(0,0,0,0.25)',
            display: 'flex',
            flexDirection: 'column',
            overflow: 'hidden',
            animation: 'slideUp 0.3s ease-out'
        }}>
            {/* MODAL HEADER */}
            <div className="modal-header" style={{
                background: 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)',
                padding: '25px 30px',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                borderBottom: '1px solid rgba(255,255,255,0.1)'
            }}>
                <h3 style={{
                    margin: 0,
                    color: '#FFFFFF',
                    fontSize: '24px',
                    fontWeight: '600',
                    letterSpacing: '-0.5px'
                }}>
                    {pirData?.firstName} {pirData?.lastName} - PIR Details
                </h3>
                <button 
                    className="close-btn" 
                    onClick={onClose}
                    style={{
                        background: 'rgba(255,255,255,0.2)',
                        border: 'none',
                        color: '#FFFFFF',
                        fontSize: '28px',
                        width: '40px',
                        height: '40px',
                        borderRadius: '50%',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        transition: 'all 0.2s ease',
                        fontWeight: '300'
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.background = 'rgba(255,255,255,0.3)';
                        e.currentTarget.style.transform = 'rotate(90deg)';
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.background = 'rgba(255,255,255,0.2)';
                        e.currentTarget.style.transform = 'rotate(0deg)';
                    }}
                >
                    ×
                </button>
            </div>
            
            {loading ? (
                <div className="loading-container" style={{
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    justifyContent: 'center',
                    minHeight: '400px',
                    gap: '20px'
                }}>
                    <div className="loading-spinner" style={{
                        width: '60px',
                        height: '60px',
                        border: '4px solid #f8f9fa',
                        borderTop: '4px solid #0077CC',
                        borderRadius: '50%',
                        animation: 'spin 1s linear infinite'
                    }}></div>
                    <p style={{
                        color: '#666666',
                        fontSize: '16px',
                        margin: 0
                    }}>
                        Loading PIR data...
                    </p>
                </div>
            ) : (
                <>
{/* SIDEBAR + CONTENT CONTAINER */}
<div style={{
    display: 'flex',
    flexDirection: 'row',
    flex: 1,
    minHeight: 0,
    overflow: 'hidden'
}}>
{/* SIDEBAR NAVIGATION */}
<div className="sidebar-nav" style={{
    width: '200px',
    background: '#f8f9fa',
    borderRight: '2px solid #e0e0e0',
    display: 'flex',
    flexDirection: 'column',
    gap: '6px',
    padding: '20px 12px',
    overflowY: 'auto'
}}>
    <button
        className={`tab-btn ${activeTab === 'overview' ? 'active' : ''}`}
        onClick={() => setActiveTab('overview')}
        style={{
            padding: '10px 15px',
            border: 'none',
            background: activeTab === 'overview' ? 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)' : 'transparent',
            color: activeTab === 'overview' ? '#FFFFFF' : '#666666',
            borderRadius: '8px',
            cursor: 'pointer',
            fontSize: '13px',
            fontWeight: activeTab === 'overview' ? '600' : '500',
            transition: 'all 0.2s ease',
            textAlign: 'left',
            width: '100%',
            boxShadow: activeTab === 'overview' ? '0 2px 4px rgba(0,0,0,0.1)' : 'none'
        }}
        onMouseEnter={(e) => {
            if (activeTab !== 'overview') {
                e.currentTarget.style.background = '#ffffff';
                e.currentTarget.style.color = '#333333';
            }
        }}
        onMouseLeave={(e) => {
            if (activeTab !== 'overview') {
                e.currentTarget.style.background = 'transparent';
                e.currentTarget.style.color = '#666666';
            }
        }}
    >
        <span style={{ display: 'inline-flex', alignItems: 'center', gap: '6px' }}>
            {AdminIcons.BarChart({ size: 16 })} Overview
        </span>
    </button>
    <button 
        className={`tab-btn ${activeTab === 'progress' ? 'active' : ''}`}
        onClick={() => setActiveTab('progress')}
        style={{
            padding: '10px 15px',
            border: 'none',
            background: activeTab === 'progress' ? 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)' : 'transparent',
            color: activeTab === 'progress' ? '#FFFFFF' : '#666666',
            borderRadius: '8px',
            cursor: 'pointer',
            fontSize: '13px',
            fontWeight: activeTab === 'progress' ? '600' : '500',
            transition: 'all 0.2s ease',
            textAlign: 'left', width: '100%',
            boxShadow: activeTab === 'progress' ? '0 2px 4px rgba(0,0,0,0.1)' : 'none'
        }}
        onMouseEnter={(e) => {
            if (activeTab !== 'progress') {
                e.currentTarget.style.background = '#ffffff';
                e.currentTarget.style.color = '#333333';
            }
        }}
        onMouseLeave={(e) => {
            if (activeTab !== 'progress') {
                e.currentTarget.style.background = 'transparent';
                e.currentTarget.style.color = '#666666';
            }
        }}
    >
        <span style={{ display: 'inline-flex', alignItems: 'center', gap: '6px' }}>
            {AdminIcons.TrendingUp({ size: 16 })} Progress
        </span>
    </button>
    <button 
        className={`tab-btn ${activeTab === 'goldenthread' ? 'active' : ''}`}
        onClick={() => setActiveTab('goldenthread')}
        style={{
            padding: '10px 15px',
            border: 'none',
            background: activeTab === 'goldenthread' ? 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)' : 'transparent',
            color: activeTab === 'goldenthread' ? '#FFFFFF' : '#666666',
            borderRadius: '8px',
            cursor: 'pointer',
            fontSize: '13px',
            fontWeight: activeTab === 'goldenthread' ? '600' : '500',
            transition: 'all 0.2s ease',
            textAlign: 'left', width: '100%',
            boxShadow: activeTab === 'goldenthread' ? '0 2px 4px rgba(0,0,0,0.1)' : 'none'
        }}
        onMouseEnter={(e) => {
            if (activeTab !== 'goldenthread') {
                e.currentTarget.style.background = '#ffffff';
                e.currentTarget.style.color = '#333333';
            }
        }}
        onMouseLeave={(e) => {
            if (activeTab !== 'goldenthread') {
                e.currentTarget.style.background = 'transparent';
                e.currentTarget.style.color = '#666666';
            }
        }}
    >
        🧵 Golden Thread
    </button>
    <button 
        className={`tab-btn ${activeTab === 'milestones' ? 'active' : ''}`}
        onClick={() => setActiveTab('milestones')}
        style={{
            padding: '10px 15px',
            border: 'none',
            background: activeTab === 'milestones' ? 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)' : 'transparent',
            color: activeTab === 'milestones' ? '#FFFFFF' : '#666666',
            borderRadius: '8px',
            cursor: 'pointer',
            fontSize: '13px',
            fontWeight: activeTab === 'milestones' ? '600' : '500',
            transition: 'all 0.2s ease',
            textAlign: 'left', width: '100%',
            boxShadow: activeTab === 'milestones' ? '0 2px 4px rgba(0,0,0,0.1)' : 'none'
        }}
        onMouseEnter={(e) => {
            if (activeTab !== 'milestones') {
                e.currentTarget.style.background = '#ffffff';
                e.currentTarget.style.color = '#333333';
            }
        }}
        onMouseLeave={(e) => {
            if (activeTab !== 'milestones') {
                e.currentTarget.style.background = 'transparent';
                e.currentTarget.style.color = '#666666';
            }
        }}
    >
        <span style={{ display: 'inline-flex', alignItems: 'center', gap: '6px' }}>
            {AdminIcons.Trophy({ size: 16 })} Milestones
        </span>
    </button>
    <button 
        className={`tab-btn ${activeTab === 'resources' ? 'active' : ''}`}
        onClick={() => setActiveTab('resources')}
        style={{
            padding: '10px 15px',
            border: 'none',
            background: activeTab === 'resources' ? 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)' : 'transparent',
            color: activeTab === 'resources' ? '#FFFFFF' : '#666666',
            borderRadius: '8px',
            cursor: 'pointer',
            fontSize: '13px',
            fontWeight: activeTab === 'resources' ? '600' : '500',
            transition: 'all 0.2s ease',
            textAlign: 'left', width: '100%',
            boxShadow: activeTab === 'resources' ? '0 2px 4px rgba(0,0,0,0.1)' : 'none'
        }}
        onMouseEnter={(e) => {
            if (activeTab !== 'resources') {
                e.currentTarget.style.background = '#ffffff';
                e.currentTarget.style.color = '#333333';
            }
        }}
        onMouseLeave={(e) => {
            if (activeTab !== 'resources') {
                e.currentTarget.style.background = 'transparent';
                e.currentTarget.style.color = '#666666';
            }
        }}
    >
        📚 Resources
    </button>
    <button 
        className={`tab-btn ${activeTab === 'communications' ? 'active' : ''}`}
        onClick={() => setActiveTab('communications')}
        style={{
            padding: '10px 15px',
            border: 'none',
            background: activeTab === 'communications' ? 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)' : 'transparent',
            color: activeTab === 'communications' ? '#FFFFFF' : '#666666',
            borderRadius: '8px',
            cursor: 'pointer',
            fontSize: '13px',
            fontWeight: activeTab === 'communications' ? '600' : '500',
            transition: 'all 0.2s ease',
            textAlign: 'left', width: '100%',
            boxShadow: activeTab === 'communications' ? '0 2px 4px rgba(0,0,0,0.1)' : 'none'
        }}
        onMouseEnter={(e) => {
            if (activeTab !== 'communications') {
                e.currentTarget.style.background = '#ffffff';
                e.currentTarget.style.color = '#333333';
            }
        }}
        onMouseLeave={(e) => {
            if (activeTab !== 'communications') {
                e.currentTarget.style.background = 'transparent';
                e.currentTarget.style.color = '#666666';
            }
        }}
    >
        <span style={{ display: 'inline-flex', alignItems: 'center', gap: '6px' }}>
            {AdminIcons.MessageSquare({ size: 16 })} Communications
        </span>
    </button>
    <button 
        className={`tab-btn ${activeTab === 'activity' ? 'active' : ''}`}
        onClick={() => setActiveTab('activity')}
        style={{
            padding: '10px 15px',
            border: 'none',
            background: activeTab === 'activity' ? 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)' : 'transparent',
            color: activeTab === 'activity' ? '#FFFFFF' : '#666666',
            borderRadius: '8px',
            cursor: 'pointer',
            fontSize: '13px',
            fontWeight: activeTab === 'activity' ? '600' : '500',
            transition: 'all 0.2s ease',
            textAlign: 'left', width: '100%',
            boxShadow: activeTab === 'activity' ? '0 2px 4px rgba(0,0,0,0.1)' : 'none'
        }}
        onMouseEnter={(e) => {
            if (activeTab !== 'activity') {
                e.currentTarget.style.background = '#ffffff';
                e.currentTarget.style.color = '#333333';
            }
        }}
        onMouseLeave={(e) => {
            if (activeTab !== 'activity') {
                e.currentTarget.style.background = 'transparent';
                e.currentTarget.style.color = '#666666';
            }
        }}
    >
        📋 Activity
    </button>
    <button 
        className={`tab-btn ${activeTab === 'financial' ? 'active' : ''}`}
        onClick={() => setActiveTab('financial')}
        style={{
            padding: '10px 15px',
            border: 'none',
            background: activeTab === 'financial' ? 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)' : 'transparent',
            color: activeTab === 'financial' ? '#FFFFFF' : '#666666',
            borderRadius: '8px',
            cursor: 'pointer',
            fontSize: '13px',
            fontWeight: activeTab === 'financial' ? '600' : '500',
            transition: 'all 0.2s ease',
            textAlign: 'left', width: '100%',
            boxShadow: activeTab === 'financial' ? '0 2px 4px rgba(0,0,0,0.1)' : 'none'
        }}
        onMouseEnter={(e) => {
            if (activeTab !== 'financial') {
                e.currentTarget.style.background = '#ffffff';
                e.currentTarget.style.color = '#333333';
            }
        }}
        onMouseLeave={(e) => {
            if (activeTab !== 'financial') {
                e.currentTarget.style.background = 'transparent';
                e.currentTarget.style.color = '#666666';
            }
        }}
    >
        💰 Financial
    </button>
    <button 
        className={`tab-btn ${activeTab === 'community' ? 'active' : ''}`}
        onClick={() => setActiveTab('community')}
        style={{
            padding: '10px 15px',
            border: 'none',
            background: activeTab === 'community' ? 'linear-gradient(135deg, #667eea 0%, #764BA2 100%)' : 'transparent',
            color: activeTab === 'community' ? '#FFFFFF' : '#666666',
            borderRadius: '8px',
            cursor: 'pointer',
            fontSize: '13px',
            fontWeight: activeTab === 'community' ? '600' : '500',
            transition: 'all 0.2s ease',
            textAlign: 'left', width: '100%',
            boxShadow: activeTab === 'community' ? '0 2px 4px rgba(0,0,0,0.1)' : 'none'
        }}
        onMouseEnter={(e) => {
            if (activeTab !== 'community') {
                e.currentTarget.style.background = '#ffffff';
                e.currentTarget.style.color = '#333333';
            }
        }}
        onMouseLeave={(e) => {
            if (activeTab !== 'community') {
                e.currentTarget.style.background = 'transparent';
                e.currentTarget.style.color = '#666666';
            }
        }}
    >
        🌐 Community
    </button>
</div>

{/* MAIN CONTENT AREA */}
<div className="tab-content" style={{
    flex: 1,
    minHeight: 0,
    overflowY: 'auto',
    background: '#f8f9fa',
    padding: '20px',
    transition: 'opacity 0.3s ease-in-out'
}}>
    {activeTab === 'overview' && renderOverviewTab()}
    {activeTab === 'progress' && renderProgressTab()}
    {activeTab === 'goldenthread' && renderGoldenThreadTab()}
    {activeTab === 'milestones' && renderMilestonesTab()}
    {activeTab === 'resources' && renderResourcesTab()}
    {activeTab === 'communications' && renderCommunicationsTab()}
    {activeTab === 'activity' && renderActivityTab()}
    {activeTab === 'financial' && renderFinancialTab()}
    {activeTab === 'community' && renderCommunityTab()}
</div>
</div>
                </>
            )}
        </div>
    </div>
);
}; // This closes the UserDetailModal function
    
        // ==========================================
        // DASHBOARD VIEW
        // ==========================================
        function DashboardView({ user, searchQuery = '', isMobile = false }) {
            const [stats, setStats] = useState({
                totalPirs: 0,
                totalCoaches: 0,
                alertsToday: 0,
                avgCompliance: 0
            });
            const [chartData, setChartData] = useState({
                mood: { labels: [], data: [], average: 0 },
                craving: { labels: [], data: [], average: 0 },
                anxiety: { labels: [], data: [], average: 0 },
                sleep: { labels: [], data: [], average: 0 }
            });
            const [sobrietyData, setSobrietyData] = useState({ labels: [], data: [], average: 0 });
            const [recentActivity, setRecentActivity] = useState([]);
            const [activePIRs, setActivePIRs] = useState([]);
            const [priorityTasks, setPriorityTasks] = useState([]);
            const [recentAlerts, setRecentAlerts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedPIR, setSelectedPIR] = useState(null);

            // Tablet breakpoint (768-1024px) calculated from window width
            const isTablet = typeof window !== 'undefined' && window.innerWidth >= 768 && window.innerWidth < 1024;

            // Filter active PIRs based on search query
            const filteredPIRs = useMemo(() => {
                if (!searchQuery.trim()) return activePIRs;
                const query = searchQuery.toLowerCase();
                return activePIRs.filter(pir =>
                    (pir.displayName?.toLowerCase().includes(query)) ||
                    (pir.firstName?.toLowerCase().includes(query)) ||
                    (pir.lastName?.toLowerCase().includes(query)) ||
                    (pir.email?.toLowerCase().includes(query))
                );
            }, [activePIRs, searchQuery]);

            // Chart refs
            const moodChartRef = useRef(null);
            const cravingChartRef = useRef(null);
            const anxietyChartRef = useRef(null);
            const sleepChartRef = useRef(null);
            const sobrietyChartRef = useRef(null);

            // Chart instances
            const chartInstances = useRef({});

            useEffect(() => {
                loadDashboardData();

                return () => {
                    // Cleanup all charts
                    Object.values(chartInstances.current).forEach(chart => {
                        if (chart) chart.destroy();
                    });
                };
            }, []);

            useEffect(() => {
                if (!loading) {
                    renderAllCharts();
                }
            }, [chartData, sobrietyData, loading]);

            const loadDashboardData = async () => {
                try {
                    console.log('🔄 Loading dashboard data for portal:', CURRENT_TENANT);

                    // 🔐 SCOPE FILTERING: Apply data scope based on user role
                    // - Coaches: Only see assigned PIRs
                    // - Admins/SuperAdmin1: See all users in tenant
                    // - SuperAdmin: See all users across all tenants
                    const scope = window.getDataScope(user);
                    let usersQuery = db.collection('users');

                    if (scope === 'all_tenants') {
                        // SuperAdmin: No filter
                        usersQuery = usersQuery;
                    } else if (scope === 'all_pirs_tenant' || scope === 'all_coaches_tenant') {
                        // Admin/SuperAdmin1: Filter by tenant
                        usersQuery = usersQuery.where('tenantId', '==', CURRENT_TENANT);
                    } else if (scope === 'assigned_pirs') {
                        // Coach: Only assigned PIRs
                        usersQuery = usersQuery
                            .where('tenantId', '==', CURRENT_TENANT)
                            .where('role', '==', 'pir')
                            .where('assignedCoach', '==', user.uid);
                    } else {
                        // own_data or unknown: Only own user
                        usersQuery = usersQuery
                            .where('tenantId', '==', CURRENT_TENANT)
                            .where(firebase.firestore.FieldPath.documentId(), '==', user.uid);
                    }

                    const usersSnap = await usersQuery.get();
                    console.log('[Dashboard] Loaded users:', usersSnap.size);

                    let totalPirs = 0;
                    let totalCoaches = 0;
                    const pirIds = [];
                    const pirsData = [];

                    usersSnap.forEach(doc => {
                        const data = doc.data();
                        if (data.role === 'pir') {
                            totalPirs++;
                            pirIds.push(doc.id);
                            pirsData.push({ id: doc.id, ...data });
                        }
                        if (data.role === 'coach') totalCoaches++;
                    });

                    console.log(`[Dashboard] Found ${totalPirs} PIRs and ${totalCoaches} coaches`);

                    // Process PIRs for Active PIRs section
                    const processedPIRs = await Promise.all(pirsData.map(async (pir) => {
                        // Calculate days sober
                        let daysSober = 0;
                        if (pir.sobrietyDate) {
                            const sobrietyDate = typeof pir.sobrietyDate === 'string'
                                ? new Date(pir.sobrietyDate)
                                : pir.sobrietyDate.toDate ? pir.sobrietyDate.toDate() : new Date(pir.sobrietyDate);
                            const today = new Date();
                            daysSober = Math.floor((today - sobrietyDate) / (1000 * 60 * 60 * 24));
                        }

                        // Get coach name
                        let coachName = 'Unassigned';
                        if (pir.assignedCoach) {
                            try {
                                const coachDoc = await db.collection('users').doc(pir.assignedCoach).get();
                                if (coachDoc.exists) {
                                    const coachData = coachDoc.data();
                                    coachName = coachData.displayName || coachData.firstName || 'Coach';
                                }
                            } catch (error) {
                                console.error('Error fetching coach:', error);
                            }
                        }

                        return {
                            ...pir,
                            daysSober,
                            coachName
                        };
                    }));

                    // Sort by first name
                    processedPIRs.sort((a, b) => {
                        const nameA = (a.firstName || a.displayName || '').toLowerCase();
                        const nameB = (b.firstName || b.displayName || '').toLowerCase();
                        return nameA.localeCompare(nameB);
                    });

                    setActivePIRs(processedPIRs);
                    console.log('[Dashboard] Processed PIRs for Active PIRs widget:', processedPIRs.length);

                    // Get today's alerts
                    console.log('[Dashboard] Loading alerts...');
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const alertsSnap = await db.collection('alerts')
                        .where('tenantId', '==', CURRENT_TENANT)
                        .where('createdAt', '>=', today)
                        .get();

                    console.log('[Dashboard] Loaded alerts:', alertsSnap.size);

                    // SET BASIC STATS EARLY - before chart data loading
                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    const recentCheckIns = await db.collection('checkIns')
                        .where('tenantId', '==', CURRENT_TENANT)
                        .where('createdAt', '>=', sevenDaysAgo)
                        .get();

                    const avgCompliance = totalPirs > 0
                        ? Math.round((recentCheckIns.size / (totalPirs * 14)) * 100)
                        : 0;

                    // Set stats immediately so they display
                    setStats({
                        totalPirs,
                        totalCoaches,
                        alertsToday: alertsSnap.size,
                        avgCompliance: Math.min(avgCompliance, 100)
                    });

                    console.log('[Dashboard] Stats loaded:', { totalPirs, totalCoaches, alertsToday: alertsSnap.size, avgCompliance });

                    // Continue loading chart data
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                    const checkInsSnap = await db.collection('checkIns')
                        .where('tenantId', '==', CURRENT_TENANT)
                        .where('createdAt', '>=', thirtyDaysAgo)
                        .get();

                    // Process check-ins data
                    const last30Days = [];
                    const moodData = [];
                    const cravingData = [];
                    const anxietyData = [];
                    const sleepData = [];

                    // All-time data for averages
                    const allCheckInsSnap = await db.collection('checkIns').where('tenantId', '==', CURRENT_TENANT).get();
                    let allTimeMood = [];
                    let allTimeCraving = [];
                    let allTimeAnxiety = [];
                    let allTimeSleep = [];

                    allCheckInsSnap.forEach(doc => {
                        const data = doc.data();
                        if (data.morningData) {
                            if (data.morningData.mood) allTimeMood.push(data.morningData.mood);
                            if (data.morningData.craving) allTimeCraving.push(data.morningData.craving);
                            if (data.morningData.anxietyLevel) allTimeAnxiety.push(data.morningData.anxietyLevel);
                            if (data.morningData.sleepQuality) allTimeSleep.push(data.morningData.sleepQuality);
                        }
                        if (data.eveningData) {
                            if (data.eveningData.mood) allTimeMood.push(data.eveningData.mood);
                            if (data.eveningData.craving) allTimeCraving.push(data.eveningData.craving);
                        }
                    });

                    // Calculate all-time averages
                    const avgMood = allTimeMood.length > 0
                        ? (allTimeMood.reduce((a, b) => a + b, 0) / allTimeMood.length).toFixed(1)
                        : 0;
                    const avgCraving = allTimeCraving.length > 0
                        ? (allTimeCraving.reduce((a, b) => a + b, 0) / allTimeCraving.length).toFixed(1)
                        : 0;
                    const avgAnxiety = allTimeAnxiety.length > 0
                        ? (allTimeAnxiety.reduce((a, b) => a + b, 0) / allTimeAnxiety.length).toFixed(1)
                        : 0;
                    const avgSleep = allTimeSleep.length > 0
                        ? (allTimeSleep.reduce((a, b) => a + b, 0) / allTimeSleep.length).toFixed(1)
                        : 0;

                    // Build 30-day data
                    for (let i = 29; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        last30Days.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));

                        const dayCheckIns = [];
                        checkInsSnap.forEach(doc => {
                            const checkInDate = doc.data().createdAt?.toDate
                                ? doc.data().createdAt.toDate()
                                : new Date(doc.data().createdAt);
                            if (checkInDate.toDateString() === date.toDateString()) {
                                dayCheckIns.push(doc.data());
                            }
                        });

                        // Calculate averages for the day
                        const dayMoods = [];
                        const dayCravings = [];
                        const dayAnxiety = [];
                        const daySleep = [];

                        dayCheckIns.forEach(checkIn => {
                            if (checkIn.morningData) {
                                if (checkIn.morningData.mood) dayMoods.push(checkIn.morningData.mood);
                                if (checkIn.morningData.craving) dayCravings.push(checkIn.morningData.craving);
                                if (checkIn.morningData.anxietyLevel) dayAnxiety.push(checkIn.morningData.anxietyLevel);
                                if (checkIn.morningData.sleepQuality) daySleep.push(checkIn.morningData.sleepQuality);
                            }
                            if (checkIn.eveningData) {
                                if (checkIn.eveningData.mood) dayMoods.push(checkIn.eveningData.mood);
                                if (checkIn.eveningData.craving) dayCravings.push(checkIn.eveningData.craving);
                            }
                        });

                        moodData.push(dayMoods.length > 0 ? dayMoods.reduce((a, b) => a + b) / dayMoods.length : null);
                        cravingData.push(dayCravings.length > 0 ? dayCravings.reduce((a, b) => a + b) / dayCravings.length : null);
                        anxietyData.push(dayAnxiety.length > 0 ? dayAnxiety.reduce((a, b) => a + b) / dayAnxiety.length : null);
                        sleepData.push(daySleep.length > 0 ? daySleep.reduce((a, b) => a + b) / daySleep.length : null);
                    }

                    setChartData({
                        mood: { labels: last30Days, data: moodData, average: avgMood },
                        craving: { labels: last30Days, data: cravingData, average: avgCraving },
                        anxiety: { labels: last30Days, data: anxietyData, average: avgAnxiety },
                        sleep: { labels: last30Days, data: sleepData, average: avgSleep }
                    });

                    // Load sobriety data
                    const sobrietyLabels = [];
                    const sobrietyDays = [];
                    let totalSobrietyDays = 0;

                    for (const pirId of pirIds.slice(0, 20)) {
                        const pirDoc = await db.collection('users').doc(pirId).get();
                        if (pirDoc.exists) {
                            const pirData = pirDoc.data();
                            if (pirData.sobrietyDate) {
                                const sobrietyDate = pirData.sobrietyDate.toDate
                                    ? pirData.sobrietyDate.toDate()
                                    : new Date(pirData.sobrietyDate);
                                const today = new Date();
                                const days = Math.floor((today - sobrietyDate) / (1000 * 60 * 60 * 24));

                                sobrietyLabels.push(pirData.displayName || pirData.email?.split('@')[0] || 'PIR');
                                sobrietyDays.push(days);
                                totalSobrietyDays += days;
                            }
                        }
                    }

                    const avgSobriety = sobrietyDays.length > 0
                        ? Math.round(totalSobrietyDays / sobrietyDays.length)
                        : 0;

                    setSobrietyData({
                        labels: sobrietyLabels,
                        data: sobrietyDays,
                        average: avgSobriety
                    });

                    // Load recent activity
                    const activityData = [];

                    const recentCheckInsSnap = await db.collection('checkIns')
                        .where('tenantId', '==', CURRENT_TENANT)
                        .orderBy('createdAt', 'desc')
                        .limit(5)
                        .get();

                    recentCheckInsSnap.forEach(doc => {
                        const data = doc.data();
                        activityData.push({
                            type: 'check-in',
                            message: `${data.userName || 'PIR'} completed check-in`,
                            time: data.createdAt
                        });
                    });

                    const recentAlertsSnap = await db.collection('alerts')
                        .where('tenantId', '==', CURRENT_TENANT)
                        .orderBy('createdAt', 'desc')
                        .limit(3)
                        .get();

                    recentAlertsSnap.forEach(doc => {
                        const data = doc.data();
                        activityData.push({
                            type: 'alert',
                            message: `Alert: ${data.message || 'New alert triggered'}`,
                            time: data.createdAt
                        });
                    });

                    activityData.sort((a, b) => {
                        const timeA = a.time?.toDate ? a.time.toDate() : new Date(a.time);
                        const timeB = b.time?.toDate ? b.time.toDate() : new Date(b.time);
                        return timeB - timeA;
                    });

                    setRecentActivity(activityData.slice(0, 10));

                    // Load priority tasks (pending/overdue assignments)
                    const now = new Date();
                    const pendingAssignmentsSnap = await db.collection('assignments')
                        .where('tenantId', '==', CURRENT_TENANT)
                        .where('status', '==', 'pending')
                        .orderBy('dueDate', 'asc')
                        .limit(5)
                        .get();

                    const priorityTasksList = [];
                    pendingAssignmentsSnap.forEach(doc => {
                        const data = doc.data();
                        const dueDate = data.dueDate?.toDate ? data.dueDate.toDate() : new Date(data.dueDate);
                        const isOverdue = dueDate < now;
                        priorityTasksList.push({
                            id: doc.id,
                            title: data.title || 'Untitled Task',
                            pirName: data.pirName || 'Unknown PIR',
                            pirId: data.pirId,
                            dueDate: dueDate,
                            isOverdue: isOverdue,
                            priority: isOverdue ? 'high' : (dueDate - now < 86400000 ? 'medium' : 'low')
                        });
                    });
                    setPriorityTasks(priorityTasksList);

                    // Load recent alerts for panel
                    const recentAlertsForPanel = await db.collection('alerts')
                        .where('tenantId', '==', CURRENT_TENANT)
                        .orderBy('createdAt', 'desc')
                        .limit(5)
                        .get();

                    const alertsList = [];
                    recentAlertsForPanel.forEach(doc => {
                        const data = doc.data();
                        alertsList.push({
                            id: doc.id,
                            type: data.type || 'general',
                            message: data.message || 'Alert triggered',
                            pirName: data.pirName || 'Unknown PIR',
                            pirId: data.pirId,
                            severity: data.severity || 'medium',
                            createdAt: data.createdAt,
                            status: data.status || 'active'
                        });
                    });
                    setRecentAlerts(alertsList);

                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                } finally {
                    setLoading(false);
                }
            };

            const renderAllCharts = () => {
                Object.values(chartInstances.current).forEach(chart => {
                    if (chart) chart.destroy();
                });

                const chartConfig = {
                    type: 'line',
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 10,
                                ticks: { stepSize: 1 }
                            }
                        },
                        plugins: {
                            legend: { display: true }
                        }
                    }
                };

                if (moodChartRef.current) {
                    chartInstances.current.mood = new Chart(moodChartRef.current, {
                        ...chartConfig,
                        data: {
                            labels: chartData.mood.labels,
                            datasets: [{
                                label: 'Mood',
                                data: chartData.mood.data,
                                borderColor: '#00A86B',
                                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                                tension: 0.4,
                                spanGaps: true
                            }]
                        }
                    });
                }

                if (cravingChartRef.current) {
                    chartInstances.current.craving = new Chart(cravingChartRef.current, {
                        ...chartConfig,
                        data: {
                            labels: chartData.craving.labels,
                            datasets: [{
                                label: 'Craving',
                                data: chartData.craving.data,
                                borderColor: '#FF9800',
                                backgroundColor: 'rgba(255, 152, 0, 0.1)',
                                tension: 0.4,
                                spanGaps: true
                            }]
                        }
                    });
                }

                if (anxietyChartRef.current) {
                    chartInstances.current.anxiety = new Chart(anxietyChartRef.current, {
                        ...chartConfig,
                        data: {
                            labels: chartData.anxiety.labels,
                            datasets: [{
                                label: 'Anxiety',
                                data: chartData.anxiety.data,
                                borderColor: '#DC143C',
                                backgroundColor: 'rgba(244, 67, 54, 0.1)',
                                tension: 0.4,
                                spanGaps: true
                            }]
                        }
                    });
                }

                if (sleepChartRef.current) {
                    chartInstances.current.sleep = new Chart(sleepChartRef.current, {
                        ...chartConfig,
                        data: {
                            labels: chartData.sleep.labels,
                            datasets: [{
                                label: 'Sleep Quality',
                                data: chartData.sleep.data,
                                borderColor: '#0077CC',
                                backgroundColor: 'rgba(0, 119, 204, 0.1)',
                                tension: 0.4,
                                spanGaps: true
                            }]
                        }
                    });
                }

                if (sobrietyChartRef.current) {
                    chartInstances.current.sobriety = new Chart(sobrietyChartRef.current, {
                        type: 'bar',
                        data: {
                            labels: sobrietyData.labels,
                            datasets: [{
                                label: 'Sobriety Days',
                                data: sobrietyData.data,
                                backgroundColor: '#0077CC',
                                borderColor: '#0077CC',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { stepSize: 30 }
                                },
                                x: {
                                    ticks: {
                                        maxRotation: 45,
                                        minRotation: 45
                                    }
                                }
                            },
                            plugins: {
                                legend: { display: true }
                            }
                        }
                    });
                }
            };

            // Helper function to get initials
            const getInitials = (pir) => {
                const firstName = pir.firstName || '';
                const lastName = pir.lastName || '';
                return `${firstName.charAt(0)}${lastName.charAt(0)}`.toUpperCase() || '?';
            };

            // Helper function to get color for initials
            const getInitialsColor = (name) => {
                const colors = [
                    '#0077CC',
                    '#4CAF50',
                    '#4facfe',
                    '#FF9800'
                ];
                const index = (name || '').charCodeAt(0) % colors.length;
                return colors[index];
            };

            if (loading) {
                return (
                    <div style={{
                        display: 'flex',
                        flexDirection: 'column',
                        alignItems: 'center',
                        justifyContent: 'center',
                        minHeight: '400px',
                        gap: '20px'
                    }}>
                        <div style={{
                            width: '60px',
                            height: '60px',
                            border: '4px solid #f3f3f3',
                            borderTop: '4px solid #0077CC',
                            borderRadius: '50%',
                            animation: 'spin 1s linear infinite'
                        }}></div>
                        <p style={{ color: '#666' }}>Loading dashboard...</p>
                    </div>
                );
            }

            return (
                <div style={{ animation: 'fadeIn 0.5s' }}>
                    {/* Portal Status Banner */}
                    <StatusBanner user={user} />

                    {/* Dashboard Grid Layout - Activity Feed + Sidebar Panels */}
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: isMobile ? '1fr' : isTablet ? '1fr' : '1fr 380px',
                        gap: isMobile ? '16px' : '24px',
                        marginBottom: isMobile ? '16px' : '24px'
                    }}>
                        {/* Activity Feed - Primary Dashboard Content */}
                        <div style={{
                            background: 'white',
                            borderRadius: '12px',
                            padding: isMobile ? '16px' : '24px',
                            boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                            border: '1px solid #e5e7eb'
                        }}>
                        <div style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            marginBottom: '20px',
                            paddingBottom: '16px',
                            borderBottom: '1px solid #e5e7eb'
                        }}>
                            <h2 style={{
                                fontSize: '18px',
                                fontWeight: '600',
                                color: '#1f2937',
                                margin: 0,
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px'
                            }}>
                                {AdminIcons.Activity({ size: 20, color: '#0077CC' })}
                                Recent Activity
                            </h2>
                            <span style={{
                                fontSize: '13px',
                                color: '#6b7280',
                                background: '#f3f4f6',
                                padding: '4px 12px',
                                borderRadius: '12px'
                            }}>
                                Last 24 hours
                            </span>
                        </div>

                        {recentActivity.length === 0 ? (
                            <div style={{
                                padding: '40px 20px',
                                textAlign: 'center',
                                color: '#9ca3af'
                            }}>
                                <div style={{ marginBottom: '12px' }}>
                                    {AdminIcons.Activity({ size: 40, color: '#d1d5db' })}
                                </div>
                                <p style={{ margin: 0, fontSize: '14px' }}>No recent activity to display</p>
                            </div>
                        ) : (
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '0' }}>
                                {recentActivity.slice(0, 8).map((activity, index) => (
                                    <div
                                        key={index}
                                        style={{
                                            padding: '14px 0',
                                            borderBottom: index < Math.min(recentActivity.length, 8) - 1 ? '1px solid #f3f4f6' : 'none',
                                            display: 'flex',
                                            alignItems: 'flex-start',
                                            gap: '14px',
                                            transition: 'background-color 0.15s ease'
                                        }}
                                        onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#f9fafb'}
                                        onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}
                                    >
                                        <div style={{
                                            width: '36px',
                                            height: '36px',
                                            borderRadius: '8px',
                                            background: activity.type === 'check-in'
                                                ? '#dcfce7'
                                                : activity.type === 'alert'
                                                ? '#fef2f2'
                                                : '#e0f2fe',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            flexShrink: 0
                                        }}>
                                            {activity.type === 'check-in'
                                                ? AdminIcons.CheckCircle({ size: 18, color: '#16a34a' })
                                                : activity.type === 'alert'
                                                ? AdminIcons.AlertTriangle({ size: 18, color: '#dc2626' })
                                                : AdminIcons.Activity({ size: 18, color: '#0284c7' })
                                            }
                                        </div>
                                        <div style={{ flex: 1, minWidth: 0 }}>
                                            <div style={{
                                                fontWeight: '500',
                                                color: '#1f2937',
                                                fontSize: '14px',
                                                lineHeight: '1.4'
                                            }}>
                                                {activity.message}
                                            </div>
                                            <div style={{
                                                fontSize: '12px',
                                                color: '#9ca3af',
                                                marginTop: '4px',
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '6px'
                                            }}>
                                                {AdminIcons.Clock({ size: 12, color: '#9ca3af' })}
                                                {formatTimeAgo(activity.time)}
                                            </div>
                                        </div>
                                        {activity.type === 'alert' && (
                                            <span style={{
                                                fontSize: '11px',
                                                fontWeight: '500',
                                                color: '#dc2626',
                                                background: '#fef2f2',
                                                padding: '2px 8px',
                                                borderRadius: '4px',
                                                border: '1px solid #fecaca'
                                            }}>
                                                Needs Review
                                            </span>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}

                        {recentActivity.length > 8 && (
                            <div style={{
                                marginTop: '16px',
                                paddingTop: '16px',
                                borderTop: '1px solid #e5e7eb',
                                textAlign: 'center'
                            }}>
                                <button style={{
                                    background: 'none',
                                    border: '1px solid #d1d5db',
                                    padding: '8px 16px',
                                    borderRadius: '6px',
                                    fontSize: '13px',
                                    color: '#4b5563',
                                    cursor: 'pointer',
                                    fontWeight: '500',
                                    transition: 'all 0.15s ease'
                                }}
                                onMouseEnter={(e) => {
                                    e.currentTarget.style.background = '#f3f4f6';
                                    e.currentTarget.style.borderColor = '#9ca3af';
                                }}
                                onMouseLeave={(e) => {
                                    e.currentTarget.style.background = 'none';
                                    e.currentTarget.style.borderColor = '#d1d5db';
                                }}
                                >
                                    View All Activity ({recentActivity.length})
                                </button>
                            </div>
                        )}
                        </div>

                        {/* Right Sidebar - Quick Actions, Priority Tasks, Alerts */}
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>
                            {/* Quick Actions Panel */}
                            <div style={{
                                background: 'white',
                                borderRadius: '12px',
                                padding: '20px',
                                boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                                border: '1px solid #e5e7eb'
                            }}>
                                <h3 style={{
                                    fontSize: '15px',
                                    fontWeight: '600',
                                    color: '#1f2937',
                                    margin: '0 0 16px 0',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px'
                                }}>
                                    {AdminIcons.Zap({ size: 16, color: '#0077CC' })}
                                    Quick Actions
                                </h3>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                    <button
                                        onClick={() => window.location.href = '/admin/alerts.html'}
                                        style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '12px',
                                            padding: '12px 14px',
                                            background: '#fef2f2',
                                            border: '1px solid #fecaca',
                                            borderRadius: '8px',
                                            cursor: 'pointer',
                                            fontSize: '14px',
                                            fontWeight: '500',
                                            color: '#991b1b',
                                            transition: 'all 0.15s ease',
                                            textAlign: 'left',
                                            width: '100%'
                                        }}
                                        onMouseEnter={(e) => {
                                            e.currentTarget.style.background = '#fee2e2';
                                            e.currentTarget.style.transform = 'translateX(4px)';
                                        }}
                                        onMouseLeave={(e) => {
                                            e.currentTarget.style.background = '#fef2f2';
                                            e.currentTarget.style.transform = 'translateX(0)';
                                        }}
                                    >
                                        {AdminIcons.AlertTriangle({ size: 18, color: '#dc2626' })}
                                        <span>View Alerts</span>
                                        {stats.alertsToday > 0 && (
                                            <span style={{
                                                marginLeft: 'auto',
                                                background: '#dc2626',
                                                color: 'white',
                                                padding: '2px 8px',
                                                borderRadius: '10px',
                                                fontSize: '12px',
                                                fontWeight: '600'
                                            }}>
                                                {stats.alertsToday}
                                            </span>
                                        )}
                                    </button>
                                    <button
                                        onClick={() => window.location.href = '/admin/users.html?action=new'}
                                        style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '12px',
                                            padding: '12px 14px',
                                            background: '#f0fdf4',
                                            border: '1px solid #bbf7d0',
                                            borderRadius: '8px',
                                            cursor: 'pointer',
                                            fontSize: '14px',
                                            fontWeight: '500',
                                            color: '#166534',
                                            transition: 'all 0.15s ease',
                                            textAlign: 'left',
                                            width: '100%'
                                        }}
                                        onMouseEnter={(e) => {
                                            e.currentTarget.style.background = '#dcfce7';
                                            e.currentTarget.style.transform = 'translateX(4px)';
                                        }}
                                        onMouseLeave={(e) => {
                                            e.currentTarget.style.background = '#f0fdf4';
                                            e.currentTarget.style.transform = 'translateX(0)';
                                        }}
                                    >
                                        {AdminIcons.UserPlus({ size: 18, color: '#16a34a' })}
                                        <span>Add New PIR</span>
                                    </button>
                                    <button
                                        onClick={() => window.location.href = '/admin/settings.html?tab=broadcasts'}
                                        style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '12px',
                                            padding: '12px 14px',
                                            background: '#eff6ff',
                                            border: '1px solid #bfdbfe',
                                            borderRadius: '8px',
                                            cursor: 'pointer',
                                            fontSize: '14px',
                                            fontWeight: '500',
                                            color: '#1e40af',
                                            transition: 'all 0.15s ease',
                                            textAlign: 'left',
                                            width: '100%'
                                        }}
                                        onMouseEnter={(e) => {
                                            e.currentTarget.style.background = '#dbeafe';
                                            e.currentTarget.style.transform = 'translateX(4px)';
                                        }}
                                        onMouseLeave={(e) => {
                                            e.currentTarget.style.background = '#eff6ff';
                                            e.currentTarget.style.transform = 'translateX(0)';
                                        }}
                                    >
                                        {AdminIcons.Megaphone({ size: 18, color: '#2563eb' })}
                                        <span>Send Broadcast</span>
                                    </button>
                                    <button
                                        onClick={() => window.location.href = '/admin/reports.html'}
                                        style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '12px',
                                            padding: '12px 14px',
                                            background: '#faf5ff',
                                            border: '1px solid #e9d5ff',
                                            borderRadius: '8px',
                                            cursor: 'pointer',
                                            fontSize: '14px',
                                            fontWeight: '500',
                                            color: '#6b21a8',
                                            transition: 'all 0.15s ease',
                                            textAlign: 'left',
                                            width: '100%'
                                        }}
                                        onMouseEnter={(e) => {
                                            e.currentTarget.style.background = '#f3e8ff';
                                            e.currentTarget.style.transform = 'translateX(4px)';
                                        }}
                                        onMouseLeave={(e) => {
                                            e.currentTarget.style.background = '#faf5ff';
                                            e.currentTarget.style.transform = 'translateX(0)';
                                        }}
                                    >
                                        {AdminIcons.BarChart({ size: 18, color: '#7c3aed' })}
                                        <span>Generate Report</span>
                                    </button>
                                </div>
                            </div>

                            {/* Priority Tasks Panel */}
                            <div style={{
                                background: 'white',
                                borderRadius: '12px',
                                padding: '20px',
                                boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                                border: '1px solid #e5e7eb'
                            }}>
                                <h3 style={{
                                    fontSize: '15px',
                                    fontWeight: '600',
                                    color: '#1f2937',
                                    margin: '0 0 16px 0',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px'
                                }}>
                                    {AdminIcons.ClipboardList({ size: 16, color: '#0077CC' })}
                                    Priority Tasks
                                    {priorityTasks.length > 0 && (
                                        <span style={{
                                            marginLeft: 'auto',
                                            background: '#fef3c7',
                                            color: '#92400e',
                                            padding: '2px 8px',
                                            borderRadius: '10px',
                                            fontSize: '12px',
                                            fontWeight: '600'
                                        }}>
                                            {priorityTasks.length}
                                        </span>
                                    )}
                                </h3>
                                {priorityTasks.length === 0 ? (
                                    <div style={{
                                        padding: '24px 16px',
                                        textAlign: 'center',
                                        color: '#9ca3af'
                                    }}>
                                        <div style={{ marginBottom: '8px' }}>
                                            {AdminIcons.CheckCircle({ size: 32, color: '#10b981' })}
                                        </div>
                                        <p style={{ margin: 0, fontSize: '13px' }}>All caught up!</p>
                                    </div>
                                ) : (
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                        {priorityTasks.map((task, index) => (
                                            <div
                                                key={task.id}
                                                onClick={() => {
                                                    const pir = activePIRs.find(p => p.id === task.pirId);
                                                    if (pir) setSelectedPIR(pir);
                                                }}
                                                style={{
                                                    padding: '12px',
                                                    background: task.isOverdue ? '#fef2f2' : '#f9fafb',
                                                    border: task.isOverdue ? '1px solid #fecaca' : '1px solid #e5e7eb',
                                                    borderRadius: '8px',
                                                    cursor: 'pointer',
                                                    transition: 'all 0.15s ease'
                                                }}
                                                onMouseEnter={(e) => {
                                                    e.currentTarget.style.background = task.isOverdue ? '#fee2e2' : '#f3f4f6';
                                                }}
                                                onMouseLeave={(e) => {
                                                    e.currentTarget.style.background = task.isOverdue ? '#fef2f2' : '#f9fafb';
                                                }}
                                            >
                                                <div style={{
                                                    fontSize: '13px',
                                                    fontWeight: '500',
                                                    color: '#1f2937',
                                                    marginBottom: '4px',
                                                    display: '-webkit-box',
                                                    WebkitLineClamp: 1,
                                                    WebkitBoxOrient: 'vertical',
                                                    overflow: 'hidden'
                                                }}>
                                                    {task.title}
                                                </div>
                                                <div style={{
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'center',
                                                    fontSize: '12px'
                                                }}>
                                                    <span style={{ color: '#6b7280' }}>{task.pirName}</span>
                                                    <span style={{
                                                        color: task.isOverdue ? '#dc2626' : '#6b7280',
                                                        fontWeight: task.isOverdue ? '500' : '400',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: '4px'
                                                    }}>
                                                        {AdminIcons.Clock({ size: 12, color: task.isOverdue ? '#dc2626' : '#9ca3af' })}
                                                        {task.isOverdue ? 'Overdue' : task.dueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                                    </span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* Alerts Panel */}
                            <div style={{
                                background: 'white',
                                borderRadius: '12px',
                                padding: '20px',
                                boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                                border: recentAlerts.length > 0 ? '1px solid #fecaca' : '1px solid #e5e7eb'
                            }}>
                                <h3 style={{
                                    fontSize: '15px',
                                    fontWeight: '600',
                                    color: '#1f2937',
                                    margin: '0 0 16px 0',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px'
                                }}>
                                    {AdminIcons.Bell({ size: 16, color: recentAlerts.length > 0 ? '#dc2626' : '#0077CC' })}
                                    Recent Alerts
                                    {recentAlerts.length > 0 && (
                                        <span style={{
                                            marginLeft: 'auto',
                                            background: '#dc2626',
                                            color: 'white',
                                            padding: '2px 8px',
                                            borderRadius: '10px',
                                            fontSize: '12px',
                                            fontWeight: '600'
                                        }}>
                                            {recentAlerts.length}
                                        </span>
                                    )}
                                </h3>
                                {recentAlerts.length === 0 ? (
                                    <div style={{
                                        padding: '24px 16px',
                                        textAlign: 'center',
                                        color: '#9ca3af'
                                    }}>
                                        <div style={{ marginBottom: '8px' }}>
                                            {AdminIcons.CheckCircle({ size: 32, color: '#10b981' })}
                                        </div>
                                        <p style={{ margin: 0, fontSize: '13px' }}>No active alerts</p>
                                    </div>
                                ) : (
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                        {recentAlerts.map((alert) => (
                                            <div
                                                key={alert.id}
                                                onClick={() => window.location.href = '/admin/alerts.html'}
                                                style={{
                                                    padding: '12px',
                                                    background: alert.severity === 'high' ? '#fef2f2' : '#fffbeb',
                                                    border: alert.severity === 'high' ? '1px solid #fecaca' : '1px solid #fde68a',
                                                    borderRadius: '8px',
                                                    cursor: 'pointer',
                                                    transition: 'all 0.15s ease'
                                                }}
                                                onMouseEnter={(e) => {
                                                    e.currentTarget.style.background = alert.severity === 'high' ? '#fee2e2' : '#fef3c7';
                                                }}
                                                onMouseLeave={(e) => {
                                                    e.currentTarget.style.background = alert.severity === 'high' ? '#fef2f2' : '#fffbeb';
                                                }}
                                            >
                                                <div style={{
                                                    display: 'flex',
                                                    alignItems: 'flex-start',
                                                    gap: '10px'
                                                }}>
                                                    <div style={{ flexShrink: 0, marginTop: '2px' }}>
                                                        {AdminIcons.AlertTriangle({
                                                            size: 16,
                                                            color: alert.severity === 'high' ? '#dc2626' : '#d97706'
                                                        })}
                                                    </div>
                                                    <div style={{ flex: 1, minWidth: 0 }}>
                                                        <div style={{
                                                            fontSize: '13px',
                                                            fontWeight: '500',
                                                            color: '#1f2937',
                                                            marginBottom: '4px',
                                                            display: '-webkit-box',
                                                            WebkitLineClamp: 2,
                                                            WebkitBoxOrient: 'vertical',
                                                            overflow: 'hidden'
                                                        }}>
                                                            {alert.message}
                                                        </div>
                                                        <div style={{
                                                            display: 'flex',
                                                            justifyContent: 'space-between',
                                                            alignItems: 'center',
                                                            fontSize: '11px',
                                                            color: '#6b7280'
                                                        }}>
                                                            <span>{alert.pirName}</span>
                                                            <span>{formatTimeAgo(alert.createdAt)}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                        <button
                                            onClick={() => window.location.href = '/admin/alerts.html'}
                                            style={{
                                                marginTop: '8px',
                                                padding: '10px',
                                                background: '#fef2f2',
                                                border: '1px solid #fecaca',
                                                borderRadius: '8px',
                                                cursor: 'pointer',
                                                fontSize: '13px',
                                                fontWeight: '500',
                                                color: '#991b1b',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                gap: '8px',
                                                transition: 'all 0.15s ease'
                                            }}
                                            onMouseEnter={(e) => {
                                                e.currentTarget.style.background = '#fee2e2';
                                            }}
                                            onMouseLeave={(e) => {
                                                e.currentTarget.style.background = '#fef2f2';
                                            }}
                                        >
                                            {AdminIcons.ExternalLink({ size: 14, color: '#991b1b' })}
                                            View All Alerts
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Active PIRs Section */}
                    <div style={{ marginBottom: isMobile ? '24px' : '40px' }}>
                        <h2 style={{
                            marginBottom: isMobile ? '16px' : '20px',
                            fontSize: isMobile ? '20px' : '24px',
                            color: '#1f2937',
                            fontWeight: '600'
                        }}>
                            Active PIRs ({activePIRs.length})
                        </h2>
                        <div style={{
                            display: 'grid',
                            gridTemplateColumns: isMobile ? '1fr' : 'repeat(auto-fit, minmax(280px, 1fr))',
                            gap: isMobile ? '12px' : '20px'
                        }}>
                            {activePIRs.map(pir => (
                                <div
                                    key={pir.id}
                                    onClick={() => setSelectedPIR(pir)}
                                    style={{
                                        background: 'white',
                                        borderRadius: '12px',
                                        padding: isMobile ? '16px' : '20px',
                                        boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
                                        cursor: 'pointer',
                                        transition: 'all 0.3s ease',
                                        display: 'flex',
                                        gap: isMobile ? '12px' : '15px',
                                        alignItems: 'center'
                                    }}
                                    onMouseEnter={(e) => {
                                        e.currentTarget.style.transform = 'translateY(-3px)';
                                        e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                                    }}
                                    onMouseLeave={(e) => {
                                        e.currentTarget.style.transform = 'translateY(0)';
                                        e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                                    }}
                                >
                                    {/* Profile Photo or Initials */}
                                    <div style={{
                                        width: isMobile ? '60px' : '80px',
                                        height: isMobile ? '60px' : '80px',
                                        borderRadius: '50%',
                                        flexShrink: 0,
                                        overflow: 'hidden',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        background: pir.profileImageUrl ? 'transparent' : getInitialsColor(pir.firstName),
                                        color: 'white',
                                        fontSize: isMobile ? '20px' : '28px',
                                        fontWeight: 'bold'
                                    }}>
                                        {pir.profileImageUrl ? (
                                            <img
                                                src={pir.profileImageUrl}
                                                alt={pir.displayName}
                                                style={{
                                                    width: '100%',
                                                    height: '100%',
                                                    objectFit: 'cover'
                                                }}
                                                onError={(e) => {
                                                    e.target.style.display = 'none';
                                                    e.target.parentElement.textContent = getInitials(pir);
                                                }}
                                            />
                                        ) : (
                                            getInitials(pir)
                                        )}
                                    </div>

                                    {/* PIR Info */}
                                    <div style={{ flex: 1, minWidth: 0 }}>
                                        <div style={{
                                            fontSize: '18px',
                                            fontWeight: '600',
                                            color: '#333',
                                            marginBottom: '8px',
                                            overflow: 'hidden',
                                            textOverflow: 'ellipsis',
                                            textAlign: 'left', width: '100%'
                                        }}>
                                            {pir.displayName || pir.firstName || 'Unknown'}
                                        </div>
                                        <div style={{
                                            fontSize: '13px',
                                            color: '#666',
                                            marginBottom: '4px',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '6px'
                                        }}>
                                            {AdminIcons.Calendar({ size: 14, color: '#666' })}
                                            <span>{pir.daysSober} days sober</span>
                                        </div>
                                        <div style={{
                                            fontSize: '13px',
                                            color: '#666',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '6px',
                                            overflow: 'hidden',
                                            textOverflow: 'ellipsis',
                                            textAlign: 'left', width: '100%'
                                        }}>
                                            {AdminIcons.User({ size: 14, color: '#666' })}
                                            <span>Coach: {pir.coachName}</span>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Trend Charts */}
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: isMobile ? '1fr' : isTablet ? 'repeat(2, 1fr)' : 'repeat(auto-fit, minmax(400px, 1fr))',
                        gap: isMobile ? '16px' : '25px',
                        marginBottom: isMobile ? '24px' : '40px'
                    }}>
                        <div style={{
                            background: 'white',
                            borderRadius: isMobile ? '12px' : '15px',
                            padding: isMobile ? '16px' : '25px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                        }}>
                            <h3 style={{ marginBottom: isMobile ? '12px' : '15px', color: '#333', fontSize: isMobile ? '16px' : '18px' }}>30-Day Mood Trend</h3>
                            <div style={{ height: isMobile ? '200px' : '250px' }}>
                                <canvas ref={moodChartRef}></canvas>
                            </div>
                            <div style={{
                                marginTop: '15px',
                                padding: '15px',
                                background: '#f8f9fa',
                                borderRadius: '8px',
                                textAlign: 'center'
                            }}>
                                <div style={{ fontSize: '12px', color: '#666', marginBottom: '5px' }}>
                                    All-Time Average
                                </div>
                                <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#4CAF50' }}>
                                    {chartData.mood.average}/10
                                </div>
                            </div>
                        </div>

                        <div style={{
                            background: 'white',
                            borderRadius: isMobile ? '12px' : '15px',
                            padding: isMobile ? '16px' : '25px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                        }}>
                            <h3 style={{ marginBottom: isMobile ? '12px' : '15px', color: '#333', fontSize: isMobile ? '16px' : '18px' }}>30-Day Craving Trend</h3>
                            <div style={{ height: isMobile ? '200px' : '250px' }}>
                                <canvas ref={cravingChartRef}></canvas>
                            </div>
                            <div style={{
                                marginTop: '15px',
                                padding: '15px',
                                background: '#f8f9fa',
                                borderRadius: '8px',
                                textAlign: 'center'
                            }}>
                                <div style={{ fontSize: '12px', color: '#666', marginBottom: '5px' }}>
                                    All-Time Average
                                </div>
                                <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#FF9800' }}>
                                    {chartData.craving.average}/10
                                </div>
                            </div>
                        </div>

                        <div style={{
                            background: 'white',
                            borderRadius: isMobile ? '12px' : '15px',
                            padding: isMobile ? '16px' : '25px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                        }}>
                            <h3 style={{ marginBottom: isMobile ? '12px' : '15px', color: '#333', fontSize: isMobile ? '16px' : '18px' }}>30-Day Anxiety Trend</h3>
                            <div style={{ height: isMobile ? '200px' : '250px' }}>
                                <canvas ref={anxietyChartRef}></canvas>
                            </div>
                            <div style={{
                                marginTop: '15px',
                                padding: '15px',
                                background: '#f8f9fa',
                                borderRadius: '8px',
                                textAlign: 'center'
                            }}>
                                <div style={{ fontSize: '12px', color: '#666', marginBottom: '5px' }}>
                                    All-Time Average
                                </div>
                                <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#F44336' }}>
                                    {chartData.anxiety.average}/10
                                </div>
                            </div>
                        </div>

                        <div style={{
                            background: 'white',
                            borderRadius: isMobile ? '12px' : '15px',
                            padding: isMobile ? '16px' : '25px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                        }}>
                            <h3 style={{ marginBottom: isMobile ? '12px' : '15px', color: '#333', fontSize: isMobile ? '16px' : '18px' }}>30-Day Sleep Quality Trend</h3>
                            <div style={{ height: isMobile ? '200px' : '250px' }}>
                                <canvas ref={sleepChartRef}></canvas>
                            </div>
                            <div style={{
                                marginTop: '15px',
                                padding: '15px',
                                background: '#f8f9fa',
                                borderRadius: '8px',
                                textAlign: 'center'
                            }}>
                                <div style={{ fontSize: '12px', color: '#666', marginBottom: '5px' }}>
                                    All-Time Average
                                </div>
                                <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#0077CC' }}>
                                    {chartData.sleep.average}/10
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Sobriety Bar Chart */}
                    <div style={{
                        background: 'white',
                        borderRadius: isMobile ? '12px' : '15px',
                        padding: isMobile ? '16px' : '25px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
                        marginBottom: isMobile ? '24px' : '40px',
                        overflowX: 'auto'
                    }}>
                        <h3 style={{ marginBottom: isMobile ? '12px' : '15px', color: '#333', fontSize: isMobile ? '16px' : '18px' }}>PIR Sobriety Days</h3>
                        <div style={{ height: isMobile ? '250px' : '350px', minWidth: isMobile ? '400px' : 'auto' }}>
                            <canvas ref={sobrietyChartRef}></canvas>
                        </div>
                        <div style={{
                            marginTop: '20px',
                            padding: '20px',
                            background: 'linear-gradient(135deg, #0077CC 0%, #005999 100%)',
                            borderRadius: '10px',
                            textAlign: 'center',
                            color: 'white'
                        }}>
                            <div style={{ fontSize: '13px', opacity: 0.9, marginBottom: '5px' }}>
                                Average Sobriety Days (All PIRs)
                            </div>
                            <div style={{ fontSize: '36px', fontWeight: 'bold' }}>
                                {sobrietyData.average} days
                            </div>
                        </div>
                    </div>

                    {/* PIR Detail Modal */}
                    {selectedPIR && (
                        <UserDetailModal
                            user={selectedPIR}
                            onClose={() => setSelectedPIR(null)}
                            onUpdate={() => {
                                setSelectedPIR(null);
                                loadDashboardData();
                            }}
                            currentUserId={user.uid}
                        />
                    )}
                </div>
            );
        }

        // ==========================================
        // ROOT APP COMPONENT
        // ==========================================
        function DashboardApp() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            // Manage sidebar collapsed state
            const [sidebarCollapsed, setSidebarCollapsed] = useState(() => {
                return window.getPreference ? window.getPreference('sidebarCollapsed', false) : false;
            });
            // Search state
            const [searchQuery, setSearchQuery] = useState('');
            // Notification state
            const [notifications, setNotifications] = useState([]);
            // Connection status
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            // Responsive state - showBottomNav when <1024px (matches navigation.js breakpoint)
            const [showBottomNav, setShowBottomNav] = useState(window.innerWidth < 1024);

            // Responsive resize listener
            useEffect(() => {
                const handleResize = () => {
                    setShowBottomNav(window.innerWidth < 1024);
                };
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            useEffect(() => {
                const unsubscribe = firebase.auth().onAuthStateChanged(async (firebaseUser) => {
                    if (firebaseUser) {
                        // Use shared getCurrentUser() function which includes tenant status checking
                        const userData = await window.getCurrentUser();

                        if (userData) {
                            // 🔐 PAGE ACCESS CONTROL: Check if user has permission to access dashboard
                            if (!window.canAccessPage(userData, 'dashboard')) {
                                alert('You do not have permission to access the Dashboard.');
                                window.location.href = '/admin/users'; // Redirect to My PIRs (most users have this)
                                return;
                            }

                            setUser(userData);
                        } else {
                            // getCurrentUser returns null if tenant is suspended/expired (already redirected)
                            // or if user doc doesn't exist
                            window.location.href = '/admin/login';
                        }
                    } else {
                        window.location.href = '/admin/login';
                    }
                    setLoading(false);
                });

                return () => unsubscribe();
            }, []);

            // Set up notification listener
            useEffect(() => {
                if (!user) return;

                const unsubscribe = firebase.firestore()
                    .collection('notifications')
                    .where('userId', '==', user.uid)
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .onSnapshot((snapshot) => {
                        const notifs = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setNotifications(notifs);
                    }, (error) => {
                        console.error('Error loading notifications:', error);
                    });

                return () => unsubscribe();
            }, [user]);

            // Set up connection status listener
            useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);

                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);

                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);

            // Clear notification handlers
            const handleClearNotification = async (notificationId) => {
                try {
                    await firebase.firestore().collection('notifications').doc(notificationId).delete();
                } catch (error) {
                    console.error('Error clearing notification:', error);
                }
            };

            const handleClearAllNotifications = async () => {
                try {
                    const batch = firebase.firestore().batch();
                    notifications.forEach(notif => {
                        const docRef = firebase.firestore().collection('notifications').doc(notif.id);
                        batch.delete(docRef);
                    });
                    await batch.commit();
                } catch (error) {
                    console.error('Error clearing all notifications:', error);
                }
            };

            if (loading) {
                return (
                    <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        minHeight: '100vh',
                        background: '#f5f7fa'
                    }}>
                        <div style={{
                            width: '60px',
                            height: '60px',
                            border: '4px solid #f3f3f3',
                            borderTop: '4px solid #0077CC',
                            borderRadius: '50%',
                            animation: 'spin 1s linear infinite'
                        }}></div>
                    </div>
                );
            }

            return (
                <>
                    {/* Connection Status Bar */}
                    {!isOnline && (
                        <div style={{
                            background: '#FFA500',
                            color: 'white',
                            padding: '10px',
                            textAlign: 'center',
                            fontWeight: '600',
                            fontSize: '13px',
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            right: 0,
                            zIndex: 9999
                        }}>
                            <span style={{ display: 'inline-flex', alignItems: 'center', gap: '6px' }}>
                                {AdminIcons.AlertCircle({ size: 16, color: 'white' })} Offline - Some features may be limited
                            </span>
                        </div>
                    )}

                    <div style={{ display: 'flex', minHeight: '100vh', background: '#f5f7fa' }}>
                        {/* Sidebar Component */}
                        <Sidebar
                            activePage="dashboard"
                            user={user}
                            collapsed={sidebarCollapsed}
                            onCollapsedChange={setSidebarCollapsed}
                        />
                        {/* Main Content Wrapper - no margin when bottom nav visible */}
                        <div style={{
                            flex: 1,
                            marginLeft: showBottomNav ? 0 : (sidebarCollapsed ? '80px' : '280px'),
                            display: 'flex',
                            flexDirection: 'column',
                            transition: 'margin-left 0.3s ease',
                            width: showBottomNav ? '100%' : 'auto',
                            paddingBottom: showBottomNav ? '72px' : 0
                        }}>
                            <Header
                                user={user}
                                searchQuery={searchQuery}
                                setSearchQuery={setSearchQuery}
                                sidebarCollapsed={sidebarCollapsed}
                                notifications={notifications}
                                onClearNotification={handleClearNotification}
                                onClearAllNotifications={handleClearAllNotifications}
                            />
                            {/* Main Content */}
                            <main style={{ flex: 1, overflow: 'auto', padding: showBottomNav ? '16px' : '20px' }}>
                                <DashboardView user={user} searchQuery={searchQuery} isMobile={showBottomNav} />
                            </main>
                        </div>
                    </div>
                </>
            );
        }

        // Render the app
        ReactDOM.render(<DashboardApp />, document.getElementById('root'));

})(); // End initPage
    </script>
</body>
</html>
