<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Detail - GLRS Admin</title>

    <!-- Favicon - Lucide User Icon -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24' fill='none' stroke='%230077CC' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2'/%3E%3Ccircle cx='12' cy='7' r='4'/%3E%3C/svg%3E">

    <!-- Shared Styles -->
    <link rel="stylesheet" href="/admin/shared/styles.css">

    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <!-- Shared Components -->
    <script src="/admin/shared/firebase.js"></script>
    <script src="/admin/shared/auth.js"></script>
    <script src="/admin/shared/permissions.js"></script>
    <script src="/admin/shared/utils.js"></script>
    <script src="/admin/shared/state.js?v=2"></script>
    <script src="/admin/shared/icons.js"></script>
    <script type="text/babel" src="/admin/shared/navigation.js?v=8"></script>
    <script type="text/babel" src="/admin/shared/header.js?v=1"></script>
    <script type="text/babel" src="/admin/shared/StatusBanner.js"></script>

    <script type="text/babel">
// ==========================================
// GLRS ADMIN - USER DETAIL PAGE
// Complete PIR Profile & Management
// ==========================================
// Design: Kipu Health inspired - healthcare-grade professional UI
// Tab Design: Option B - Horizontal, Text Only, No Icons on Tabs
// ==========================================

(function initPage() {
    if (!window.FIREBASE_READY || !window.auth || !window.db) {
        console.log('Waiting for Firebase to initialize...');
        setTimeout(initPage, 50);
        return;
    }

    const { useState, useEffect, useRef, useMemo, useCallback } = React;
    const { auth, db, storage, CURRENT_TENANT, logAudit } = window;

    // ==========================================
    // TAB CONFIGURATION - 11 Tabs (Option B: Text Only)
    // ==========================================
    const TABS = [
        { id: 'overview', label: 'Overview' },
        { id: 'wellness', label: 'Wellness' },
        { id: 'tasks', label: 'Tasks' },
        { id: 'messages', label: 'Messages' },
        { id: 'meetings', label: 'Meetings' },
        { id: 'guides', label: 'Guides' },
        { id: 'journey', label: 'Journey' },
        { id: 'community', label: 'Community' },
        { id: 'financial', label: 'Financial' },
        { id: 'documentation', label: 'Documentation' },
        { id: 'activity', label: 'Activity' }
    ];

    // ==========================================
    // MAIN PAGE COMPONENT
    // ==========================================
    function UserDetailPage() {
        const [user, setUser] = useState(null);
        const [loading, setLoading] = useState(true);
        // Initialize sidebar state from localStorage to stay in sync
        const [sidebarCollapsed, setSidebarCollapsed] = useState(() => {
            const saved = localStorage.getItem('glrs_pref_sidebarCollapsed');
            return saved === 'true';
        });
        const [searchQuery, setSearchQuery] = useState('');
        const [isOnline, setIsOnline] = useState(navigator.onLine);
        const [notifications, setNotifications] = useState([]);

        // Responsive states - showBottomNav when <1024px (matches navigation.js)
        const [isMobile, setIsMobile] = useState(window.innerWidth < 600);
        const [isTablet, setIsTablet] = useState(window.innerWidth >= 600 && window.innerWidth < 1024);
        const [showBottomNav, setShowBottomNav] = useState(window.innerWidth < 1024);

        // Get userId from URL params
        const urlParams = new URLSearchParams(window.location.search);
        const pirId = urlParams.get('id');

        // Track online status
        useEffect(() => {
            const handleOnline = () => setIsOnline(true);
            const handleOffline = () => setIsOnline(false);

            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);

            return () => {
                window.removeEventListener('online', handleOnline);
                window.removeEventListener('offline', handleOffline);
            };
        }, []);

        // Responsive resize listener
        useEffect(() => {
            const handleResize = () => {
                const width = window.innerWidth;
                setIsMobile(width < 600);
                setIsTablet(width >= 600 && width < 1024);
                setShowBottomNav(width < 1024);
            };
            window.addEventListener('resize', handleResize);
            return () => window.removeEventListener('resize', handleResize);
        }, []);

        // Authentication check
        useEffect(() => {
            const unsubscribe = auth.onAuthStateChanged(async (firebaseUser) => {
                if (!firebaseUser) {
                    window.location.href = '/admin/login.html';
                    return;
                }

                try {
                    const userDoc = await db.collection('users').doc(firebaseUser.uid).get();
                    if (userDoc.exists) {
                        const userData = { id: userDoc.id, ...userDoc.data() };

                        // Check if user has permission to view user details
                        if (!window.canAccessPage(userData, 'users') && !window.canAccessPage(userData, 'my_pirs')) {
                            alert('You do not have permission to view user details.');
                            window.location.href = '/admin/dashboard.html';
                            return;
                        }

                        setUser(userData);
                    } else {
                        console.error('User document not found');
                        window.location.href = '/admin/login.html';
                    }
                } catch (error) {
                    console.error('Error fetching user data:', error);
                }
                setLoading(false);
            });

            return () => unsubscribe();
        }, []);

        // Clear notifications
        const handleClearNotification = (index) => {
            setNotifications(prev => prev.filter((_, i) => i !== index));
        };

        const handleClearAllNotifications = () => {
            setNotifications([]);
        };

        // Handle back navigation
        const handleBack = () => {
            window.location.href = '/admin/users.html';
        };

        // Handle sidebar collapse - update state and save to localStorage
        const handleSidebarCollapse = (collapsed) => {
            setSidebarCollapsed(collapsed);
            localStorage.setItem('glrs_pref_sidebarCollapsed', collapsed.toString());
        };

        if (loading) {
            return (
                <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    minHeight: '100vh',
                    background: '#f5f7fa'
                }}>
                    <div style={{ textAlign: 'center', padding: '40px' }}>
                        <div style={{
                            width: '50px',
                            height: '50px',
                            border: '4px solid #e0e0e0',
                            borderTop: '4px solid #0077CC',
                            borderRadius: '50%',
                            animation: 'spin 1s linear infinite',
                            margin: '0 auto 20px'
                        }}></div>
                        <div style={{ color: '#666' }}>Loading...</div>
                    </div>
                </div>
            );
        }

        if (!pirId) {
            return (
                <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    minHeight: '100vh',
                    background: '#f5f7fa'
                }}>
                    <div style={{
                        textAlign: 'center',
                        padding: '40px',
                        background: 'white',
                        borderRadius: '12px',
                        boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
                    }}>
                        <div style={{ marginBottom: '20px' }}>
                            {AdminIcons.AlertCircle({ size: 48, color: '#DC143C' })}
                        </div>
                        <h2 style={{ margin: '0 0 10px 0', color: '#333' }}>No User ID Provided</h2>
                        <p style={{ color: '#666', marginBottom: '20px' }}>
                            Please select a user from the Users page.
                        </p>
                        <button
                            onClick={handleBack}
                            style={{
                                padding: '12px 24px',
                                background: '#0077CC',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '500',
                                display: 'inline-flex',
                                alignItems: 'center',
                                gap: '8px'
                            }}
                        >
                            {AdminIcons.ArrowLeft({ size: 18 })}
                            Back to Users
                        </button>
                    </div>
                </div>
            );
        }

        return (
            <>
                {/* Connection Status Bar */}
                {!isOnline && (
                    <div style={{
                        background: '#FFA500',
                        color: 'white',
                        padding: '10px',
                        textAlign: 'center',
                        fontWeight: '600',
                        fontSize: '14px',
                        position: 'fixed',
                        top: 0,
                        left: 0,
                        right: 0,
                        zIndex: 9999
                    }}>
                        <span style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}>
                            {AdminIcons.AlertTriangle({ size: 18 })} Offline - Some features may be limited
                        </span>
                    </div>
                )}

                <div style={{ display: 'flex', minHeight: '100vh' }}>
                    {/* Sidebar Navigation */}
                    <Sidebar
                        user={user}
                        activePage="users"
                        collapsed={sidebarCollapsed}
                        onCollapsedChange={handleSidebarCollapse}
                    />

                    {/* Main Content Wrapper - no margin when bottom nav visible */}
                    <div style={{
                        flex: 1,
                        marginLeft: showBottomNav ? 0 : (sidebarCollapsed ? '80px' : '280px'),
                        width: showBottomNav ? '100%' : 'auto',
                        transition: 'margin-left 0.3s ease',
                        display: 'flex',
                        flexDirection: 'column',
                        minHeight: '100vh',
                        paddingBottom: showBottomNav ? '72px' : 0
                    }}>
                        {/* Header Component - now inside the shifting wrapper */}
                        <div style={{
                            position: 'sticky',
                            top: 0,
                            zIndex: 100
                        }}>
                            <Header
                                user={user}
                                searchQuery={searchQuery}
                                setSearchQuery={setSearchQuery}
                                sidebarCollapsed={sidebarCollapsed}
                                notifications={notifications}
                                onClearNotification={handleClearNotification}
                                onClearAllNotifications={handleClearAllNotifications}
                            />
                        </div>

                        {/* Main Content Area */}
                        <main style={{
                            flex: 1,
                            background: '#f5f7fa',
                            minHeight: 'calc(100vh - 70px)',
                            padding: showBottomNav ? '16px' : '0'
                        }}>
                            {/* User Detail Content */}
                            <UserDetailContent
                                pirId={pirId}
                                currentUser={user}
                                onBack={handleBack}
                            />
                        </main>
                    </div>
                </div>
            </>
        );
    }

    // ==========================================
    // USER DETAIL CONTENT COMPONENT
    // ==========================================
    function UserDetailContent({ pirId, currentUser, onBack }) {
        // Core States
        const [pirData, setPirData] = useState(null);
        const [loading, setLoading] = useState(true);
        const [activeTab, setActiveTab] = useState('overview');
        const [saving, setSaving] = useState(false);

        // Data States
        const [activities, setActivities] = useState([]);
        const [availableCoaches, setAvailableCoaches] = useState([]);
        const [assignedCoachData, setAssignedCoachData] = useState(null);
        const [checkIns, setCheckIns] = useState([]);
        const [assignments, setAssignments] = useState([]);
        const [goals, setGoals] = useState([]);
        const [objectives, setObjectives] = useState([]);
        const [alerts, setAlerts] = useState([]);
        const [meetings, setMeetings] = useState([]);
        const [savedMeetings, setSavedMeetings] = useState([]);
        const [resources, setResources] = useState([]);
        const [assignedResources, setAssignedResources] = useState([]);
        const [milestones, setMilestones] = useState([]);
        const [messages, setMessages] = useState([]);
        const [supportGroups, setSupportGroups] = useState([]);
        const [pledges, setPledges] = useState([]);
        const [dailyPosts, setDailyPosts] = useState([]);
        const [notifications, setNotifications] = useState([]);
        const [topicRooms, setTopicRooms] = useState([]);
        const [resourceProgress, setResourceProgress] = useState({});
        const [streakData, setStreakData] = useState({});
        const [complianceData, setComplianceData] = useState({});
        const [allMessages, setAllMessages] = useState([]);
        const [journeyData, setJourneyData] = useState({});
        const [financialData, setFinancialData] = useState({});
        const [documentationData, setDocumentationData] = useState([]);

        // UI States
        const [editing, setEditing] = useState(false);
        const [editData, setEditData] = useState({});
        const [chartData, setChartData] = useState(null);

        // Chart refs for Wellness tab
        const moodChartRef = useRef(null);
        const cravingChartRef = useRef(null);
        const anxietyChartRef = useRef(null);
        const sleepChartRef = useRef(null);

        // ========== LOAD DATA ON MOUNT ==========
        useEffect(() => {
            if (pirId) {
                loadCompletePIRData();
            }
        }, [pirId]);

        // ========== CALCULATION FUNCTIONS ==========
        const calculateSobrietyDays = (sobrietyDate) => {
            if (!sobrietyDate) return 0;

            let year, month, day;

            if (typeof sobrietyDate === 'string' && sobrietyDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
                [year, month, day] = sobrietyDate.split('-').map(Number);
            } else if (sobrietyDate.toDate) {
                const date = sobrietyDate.toDate();
                year = date.getFullYear();
                month = date.getMonth() + 1;
                day = date.getDate();
            } else if (sobrietyDate.seconds) {
                const date = new Date(sobrietyDate.seconds * 1000);
                year = date.getFullYear();
                month = date.getMonth() + 1;
                day = date.getDate();
            } else {
                const date = new Date(sobrietyDate);
                year = date.getFullYear();
                month = date.getMonth() + 1;
                day = date.getDate();
            }

            const today = new Date();
            const todayYear = today.getFullYear();
            const todayMonth = today.getMonth() + 1;
            const todayDay = today.getDate();

            const startDate = new Date(year, month - 1, day, 0, 0, 0, 0);
            const endDate = new Date(todayYear, todayMonth - 1, todayDay, 0, 0, 0, 0);

            const millisecondsDiff = endDate.getTime() - startDate.getTime();
            const complete24HourPeriods = Math.floor(millisecondsDiff / (1000 * 60 * 60 * 24));
            const totalDays = complete24HourPeriods + 2;

            return Math.max(1, totalDays);
        };

        const formatDate = (date) => {
            if (!date) return 'N/A';

            let d;
            if (date?.toDate) {
                d = date.toDate();
            } else if (date?.seconds) {
                d = new Date(date.seconds * 1000);
            } else if (typeof date === 'string') {
                if (!date.includes('T')) {
                    d = new Date(date + 'T00:00:00');
                } else {
                    d = new Date(date);
                }
            } else {
                d = new Date(date);
            }

            return d.toLocaleDateString('en-US', {
                year: 'numeric', month: 'long', day: 'numeric'
            });
        };

        const formatDateTime = (date) => {
            if (!date) return 'N/A';
            const d = date?.toDate ? date.toDate() : new Date(date);
            return d.toLocaleString();
        };

        const formatTimeAgo = (date) => {
            if (!date) return 'Never';
            const d = date?.toDate ? date.toDate() : new Date(date);
            const now = new Date();
            const diff = Math.floor((now - d) / 1000);

            if (diff < 60) return 'Just now';
            if (diff < 3600) return Math.floor(diff / 60) + ' minutes ago';
            if (diff < 86400) return Math.floor(diff / 3600) + ' hours ago';
            if (diff < 604800) return Math.floor(diff / 86400) + ' days ago';
            return d.toLocaleDateString();
        };

        const daysSince = (date) => {
            if (!date) return 0;
            const start = date?.toDate ? date.toDate() : new Date(date);
            const today = new Date();
            const diffTime = Math.abs(today - start);
            return Math.floor(diffTime / (1000 * 60 * 60 * 24));
        };

        // ========== MAIN DATA LOADING ==========
        const loadCompletePIRData = async () => {
            try {
                setLoading(true);

                const userDoc = await db.collection('users').doc(pirId).get();
                if (!userDoc.exists) {
                    alert('User not found');
                    onBack();
                    return;
                }

                const userData = { id: userDoc.id, ...userDoc.data() };

                // Calculate derived data
                userData.sobrietyDays = calculateSobrietyDays(userData.sobrietyDate);
                userData.accountAge = daysSince(userData.createdAt);
                userData.moneySaved = userData.sobrietyDays * (userData.dailyCost || 20);

                // Format dates
                if (userData.lastLogin) {
                    const lastLogin = userData.lastLogin.toDate ? userData.lastLogin.toDate() : new Date(userData.lastLogin);
                    userData.lastLoginFormatted = lastLogin.toLocaleString('en-US', {
                        month: 'short', day: 'numeric', year: 'numeric',
                        hour: 'numeric', minute: '2-digit', hour12: true
                    });
                } else {
                    userData.lastLoginFormatted = 'Never logged in';
                }

                if (userData.createdAt) {
                    const created = userData.createdAt.toDate ? userData.createdAt.toDate() : new Date(userData.createdAt);
                    userData.createdAtFormatted = created.toLocaleDateString('en-US', {
                        month: 'short', day: 'numeric', year: 'numeric'
                    });
                }

                setPirData(userData);
                setEditData(userData);

                // Load all related data in parallel
                await Promise.all([
                    loadActivitiesData(),
                    loadCheckInsData(),
                    loadAssignmentsData(),
                    loadGoalsData(),
                    loadObjectivesData(),
                    loadAlertsData(),
                    loadMeetingsData(),
                    loadSavedMeetingsData(),
                    loadResourcesData(),
                    loadAssignedResourcesData(),
                    loadMilestonesData(),
                    loadMessagesData(),
                    loadAllUserMessages(),
                    loadSupportGroupsData(),
                    loadPledgesData(),
                    loadDailyPostsData(),
                    loadNotificationsData(),
                    loadTopicRoomsData(),
                    loadResourceProgressData(),
                    loadStreakData(),
                    loadComplianceData(userData.createdAt),
                    loadProgressChartData(),
                    loadAvailableCoaches(),
                    loadJourneyData(),
                    loadFinancialData(),
                    loadDocumentationData(),
                    loadAssignedCoach(userData.assignedCoach)
                ]);

            } catch (error) {
                console.error('Error loading PIR data:', error);
                alert('Failed to load user data: ' + error.message);
            } finally {
                setLoading(false);
            }
        };

        // ========== DATA LOADING FUNCTIONS ==========
        const loadAvailableCoaches = async () => {
            try {
                // Query for all potential coaches/admins (multiple role types)
                const coachesSnap = await db.collection('users')
                    .where('role', 'in', ['admin', 'coach', 'superadmin', 'superadmin1'])
                    .get();

                const coachesList = [];
                coachesSnap.forEach(doc => {
                    coachesList.push({ id: doc.id, ...doc.data() });
                });
                setAvailableCoaches(coachesList);
            } catch (error) {
                console.error('Error loading coaches:', error);
            }
        };

        // Fetch single coach by ID (fallback if not in availableCoaches)
        const loadAssignedCoach = async (coachId) => {
            if (!coachId) return;
            try {
                const coachDoc = await db.collection('users').doc(coachId).get();
                if (coachDoc.exists) {
                    setAssignedCoachData({ id: coachDoc.id, ...coachDoc.data() });
                }
            } catch (error) {
                console.error('Error loading assigned coach:', error);
            }
        };

        const loadComplianceData = async (accountCreatedAt) => {
            try {
                if (!accountCreatedAt) {
                    setComplianceData({ morningRate: 0, eveningRate: 0, totalCheckIns: 0, daysTracked: 0 });
                    return;
                }
                const accountDate = accountCreatedAt?.toDate ? accountCreatedAt.toDate() : new Date(accountCreatedAt);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                accountDate.setHours(0, 0, 0, 0);

                const daysSinceCreation = Math.floor((today - accountDate) / (1000 * 60 * 60 * 24));
                const daysToCheck = Math.min(daysSinceCreation, 30);

                if (daysToCheck <= 0) {
                    setComplianceData({ morningRate: 0, eveningRate: 0, totalCheckIns: 0, daysTracked: 0 });
                    return;
                }

                const startDate = new Date();
                startDate.setDate(startDate.getDate() - daysToCheck);

                const checkInsSnap = await db.collection('checkIns')
                    .where('userId', '==', pirId)
                    .where('createdAt', '>=', startDate)
                    .get();

                let morningCount = 0, eveningCount = 0;
                checkInsSnap.forEach(doc => {
                    const data = doc.data();
                    if (data.type === 'morning' || data.morningData) morningCount++;
                    if (data.type === 'evening' || data.eveningData) eveningCount++;
                });

                setComplianceData({
                    morningRate: Math.round((morningCount / daysToCheck) * 100),
                    eveningRate: Math.round((eveningCount / daysToCheck) * 100),
                    totalCheckIns: checkInsSnap.size,
                    daysTracked: daysToCheck
                });
            } catch (error) {
                console.error('Error loading compliance data:', error);
            }
        };

        const loadActivitiesData = async () => {
            try {
                const snap = await db.collection('activities')
                    .where('userId', '==', pirId)
                    .orderBy('createdAt', 'desc')
                    .limit(100)
                    .get();
                const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setActivities(data);
            } catch (error) {
                console.error('Error loading activities:', error);
            }
        };

        const loadCheckInsData = async () => {
            try {
                const snap = await db.collection('checkIns')
                    .where('userId', '==', pirId)
                    .orderBy('createdAt', 'desc')
                    .limit(60)
                    .get();
                const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setCheckIns(data);
            } catch (error) {
                console.error('Error loading check-ins:', error);
            }
        };

        const loadAssignmentsData = async () => {
            try {
                const snap = await db.collection('assignments')
                    .where('userId', '==', pirId)
                    .orderBy('createdAt', 'desc')
                    .get();
                const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setAssignments(data);
            } catch (error) {
                console.error('Error loading assignments:', error);
            }
        };

        const loadGoalsData = async () => {
            try {
                const snap = await db.collection('goals')
                    .where('userId', '==', pirId)
                    .orderBy('createdAt', 'desc')
                    .get();
                const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setGoals(data);
            } catch (error) {
                console.error('Error loading goals:', error);
            }
        };

        const loadObjectivesData = async () => {
            try {
                const snap = await db.collection('objectives')
                    .where('userId', '==', pirId)
                    .get();
                const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setObjectives(data);
            } catch (error) {
                console.error('Error loading objectives:', error);
            }
        };

        const loadAlertsData = async () => {
            try {
                const snap = await db.collection('alerts')
                    .where('userId', '==', pirId)
                    .orderBy('createdAt', 'desc')
                    .limit(20)
                    .get();
                const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setAlerts(data);
            } catch (error) {
                console.error('Error loading alerts:', error);
            }
        };

        const loadMeetingsData = async () => {
            try {
                const snap = await db.collection('meetings')
                    .where('attendees', 'array-contains', pirId)
                    .orderBy('date', 'desc')
                    .limit(50)
                    .get();
                const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setMeetings(data);
            } catch (error) {
                console.error('Error loading meetings:', error);
            }
        };

        const loadSavedMeetingsData = async () => {
            try {
                const snap = await db.collection('users').doc(pirId).collection('savedMeetings').get();
                const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setSavedMeetings(data);
            } catch (error) {
                console.error('Error loading saved meetings:', error);
            }
        };

        const loadResourcesData = async () => {
            try {
                const snap = await db.collection('resources').get();
                const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setResources(data);
            } catch (error) {
                console.error('Error loading resources:', error);
            }
        };

        const loadAssignedResourcesData = async () => {
            try {
                const snap = await db.collection('resources')
                    .where('assignedTo', 'array-contains', pirId)
                    .get();
                const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setAssignedResources(data);
            } catch (error) {
                console.error('Error loading assigned resources:', error);
            }
        };

        const loadMilestonesData = async () => {
            try {
                const snap = await db.collection('milestones').get();
                const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setMilestones(data);
            } catch (error) {
                console.error('Error loading milestones:', error);
            }
        };

        const loadMessagesData = async () => {
            try {
                const snap = await db.collection('messages')
                    .where('recipientId', '==', pirId)
                    .orderBy('createdAt', 'desc')
                    .limit(50)
                    .get();
                const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setMessages(data);
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        };

        const loadAllUserMessages = async () => {
            try {
                const sentSnap = await db.collection('messages')
                    .where('senderId', '==', pirId)
                    .orderBy('createdAt', 'desc')
                    .limit(50)
                    .get();

                const receivedSnap = await db.collection('messages')
                    .where('recipientId', '==', pirId)
                    .orderBy('createdAt', 'desc')
                    .limit(50)
                    .get();

                const allMsgs = [
                    ...sentSnap.docs.map(doc => ({ id: doc.id, ...doc.data(), direction: 'sent' })),
                    ...receivedSnap.docs.map(doc => ({ id: doc.id, ...doc.data(), direction: 'received' }))
                ];

                allMsgs.sort((a, b) => {
                    const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
                    const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
                    return dateB - dateA;
                });

                setAllMessages(allMsgs.slice(0, 100));
            } catch (error) {
                console.error('Error loading all messages:', error);
            }
        };

        const loadSupportGroupsData = async () => {
            try {
                const snap = await db.collection('supportGroups').get();
                const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setSupportGroups(data);
            } catch (error) {
                console.error('Error loading support groups:', error);
            }
        };

        const loadPledgesData = async () => {
            try {
                const snap = await db.collection('pledges')
                    .where('userId', '==', pirId)
                    .orderBy('createdAt', 'desc')
                    .get();
                const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setPledges(data);
            } catch (error) {
                console.error('Error loading pledges:', error);
            }
        };

        const loadDailyPostsData = async () => {
            try {
                const snap = await db.collection('dailyPosts')
                    .where('userId', '==', pirId)
                    .orderBy('createdAt', 'desc')
                    .limit(50)
                    .get();
                const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setDailyPosts(data);
            } catch (error) {
                console.error('Error loading daily posts:', error);
            }
        };

        const loadNotificationsData = async () => {
            try {
                const snap = await db.collection('notifications')
                    .where('userId', '==', pirId)
                    .orderBy('createdAt', 'desc')
                    .limit(50)
                    .get();
                const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setNotifications(data);
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        };

        const loadTopicRoomsData = async () => {
            try {
                const snap = await db.collection('topicRooms').get();
                const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setTopicRooms(data);
            } catch (error) {
                console.error('Error loading topic rooms:', error);
            }
        };

        const loadResourceProgressData = async () => {
            try {
                const snap = await db.collection('users').doc(pirId).collection('resourceProgress').get();
                const progress = {};
                snap.forEach(doc => {
                    progress[doc.id] = doc.data();
                });
                setResourceProgress(progress);
            } catch (error) {
                console.error('Error loading resource progress:', error);
            }
        };

        const loadStreakData = async () => {
            try {
                const streakDoc = await db.collection('streaks').doc(pirId).get();
                if (streakDoc.exists) {
                    setStreakData(streakDoc.data());
                }
            } catch (error) {
                console.error('Error loading streak data:', error);
            }
        };

        const loadProgressChartData = async () => {
            try {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                const snap = await db.collection('checkIns')
                    .where('userId', '==', pirId)
                    .where('createdAt', '>=', thirtyDaysAgo)
                    .orderBy('createdAt', 'asc')
                    .get();

                const moods = [], cravings = [], anxiety = [], sleep = [], labels = [];

                snap.forEach(doc => {
                    const data = doc.data();
                    const date = data.createdAt?.toDate ? data.createdAt.toDate() : new Date(data.createdAt);
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));

                    const mood = data.morningData?.mood ?? data.mood ?? null;
                    const craving = data.morningData?.craving ?? data.craving ?? null;
                    const anx = data.morningData?.anxiety ?? data.anxiety ?? null;
                    const slp = data.morningData?.sleep ?? data.sleep ?? null;

                    moods.push(mood);
                    cravings.push(craving);
                    anxiety.push(anx);
                    sleep.push(slp);
                });

                setChartData({ labels, moods, cravings, anxiety, sleep });
            } catch (error) {
                console.error('Error loading chart data:', error);
            }
        };

        const loadJourneyData = async () => {
            try {
                // Load gratitudes, reflections, breakthroughs
                const [gratitudesSnap, reflectionsSnap, breakthroughsSnap] = await Promise.all([
                    db.collection('gratitudes').where('userId', '==', pirId).orderBy('createdAt', 'desc').limit(20).get(),
                    db.collection('reflections').where('userId', '==', pirId).orderBy('createdAt', 'desc').limit(20).get(),
                    db.collection('breakthroughs').where('userId', '==', pirId).orderBy('createdAt', 'desc').limit(20).get()
                ]);

                setJourneyData({
                    gratitudes: gratitudesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                    reflections: reflectionsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                    breakthroughs: breakthroughsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                });
            } catch (error) {
                console.error('Error loading journey data:', error);
            }
        };

        const loadFinancialData = async () => {
            try {
                const [savingsItemsSnap, savingsGoalsSnap] = await Promise.all([
                    db.collection('savingsItems').where('userId', '==', pirId).get(),
                    db.collection('savingsGoals').where('userId', '==', pirId).get()
                ]);

                setFinancialData({
                    savingsItems: savingsItemsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                    savingsGoals: savingsGoalsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                });
            } catch (error) {
                console.error('Error loading financial data:', error);
            }
        };

        const loadDocumentationData = async () => {
            try {
                // Load any clinical notes, progress notes, etc.
                const snap = await db.collection('clinicalNotes')
                    .where('pirId', '==', pirId)
                    .orderBy('createdAt', 'desc')
                    .limit(50)
                    .get();
                const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setDocumentationData(data);
            } catch (error) {
                console.error('Error loading documentation:', error);
            }
        };

        // ========== SAVE FUNCTIONS ==========
        const saveProfile = async () => {
            try {
                setSaving(true);
                await db.collection('users').doc(pirId).update({
                    firstName: editData.firstName || '',
                    lastName: editData.lastName || '',
                    displayName: editData.displayName || '',
                    phone: editData.phone || '',
                    dateOfBirth: editData.dateOfBirth || null,
                    address: editData.address || {},
                    sobrietyDate: editData.sobrietyDate || null,
                    substance: editData.substance || '',
                    dailyCost: editData.dailyCost || 20,
                    assignedCoach: editData.assignedCoach || null,
                    emergencyContacts: editData.emergencyContacts || [],
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Log audit
                if (window.logAudit) {
                    window.logAudit('user_profile_updated', { pirId, updatedBy: currentUser.id });
                }

                setPirData({ ...pirData, ...editData });
                setEditing(false);
                alert('Profile updated successfully');
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Failed to save profile: ' + error.message);
            } finally {
                setSaving(false);
            }
        };

        const changeCoach = async (newCoachId) => {
            try {
                setSaving(true);
                await db.collection('users').doc(pirId).update({
                    assignedCoach: newCoachId,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                if (window.logAudit) {
                    window.logAudit('coach_assignment_changed', { pirId, newCoachId, changedBy: currentUser.id });
                }

                setPirData({ ...pirData, assignedCoach: newCoachId });
                setEditData({ ...editData, assignedCoach: newCoachId });
                alert('Coach assignment updated');
            } catch (error) {
                console.error('Error changing coach:', error);
                alert('Failed to change coach: ' + error.message);
            } finally {
                setSaving(false);
            }
        };

        // ========== RENDER CHARTS (for Wellness tab) ==========
        useEffect(() => {
            if (chartData && activeTab === 'wellness') {
                setTimeout(() => renderCharts(), 100);
            }
        }, [chartData, activeTab]);

        const renderCharts = () => {
            if (!chartData) return;

            const chartConfig = (data, color, label) => ({
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: label,
                        data: data,
                        borderColor: color,
                        backgroundColor: color + '20',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { min: 0, max: 10, grid: { color: '#f0f0f0' } },
                        x: { grid: { display: false } }
                    }
                }
            });

            // Destroy existing charts
            ['moodChart', 'cravingChart', 'anxietyChart', 'sleepChart'].forEach(id => {
                const existing = Chart.getChart(id);
                if (existing) existing.destroy();
            });

            // Create new charts
            if (moodChartRef.current) {
                new Chart(moodChartRef.current, chartConfig(chartData.moods, '#00A86B', 'Mood'));
            }
            if (cravingChartRef.current) {
                new Chart(cravingChartRef.current, chartConfig(chartData.cravings, '#FF6B35', 'Craving'));
            }
            if (anxietyChartRef.current) {
                new Chart(anxietyChartRef.current, chartConfig(chartData.anxiety, '#9C27B0', 'Anxiety'));
            }
            if (sleepChartRef.current) {
                new Chart(sleepChartRef.current, chartConfig(chartData.sleep, '#2196F3', 'Sleep'));
            }
        };

        // ========== LOADING STATE ==========
        if (loading) {
            return (
                <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    minHeight: '400px'
                }}>
                    <div style={{ textAlign: 'center' }}>
                        <div style={{
                            width: '50px',
                            height: '50px',
                            border: '4px solid #e0e0e0',
                            borderTop: '4px solid #0077CC',
                            borderRadius: '50%',
                            animation: 'spin 1s linear infinite',
                            margin: '0 auto 20px'
                        }}></div>
                        <div style={{ color: '#666' }}>Loading user data...</div>
                    </div>
                </div>
            );
        }

        if (!pirData) {
            return (
                <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    minHeight: '400px'
                }}>
                    <div style={{ textAlign: 'center', color: '#666' }}>
                        {AdminIcons.AlertCircle({ size: 48, color: '#ccc' })}
                        <div style={{ marginTop: '12px' }}>User data not found</div>
                    </div>
                </div>
            );
        }

        // ========== MAIN RENDER ==========
        return (
            <div>
                {/* Page Header with Back Button and User Info */}
                <div style={{
                    background: 'white',
                    borderBottom: '1px solid #e0e0e0',
                    padding: '20px 30px'
                }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '20px', marginBottom: '16px' }}>
                        <button
                            onClick={onBack}
                            style={{
                                padding: '8px 16px',
                                background: '#f5f7fa',
                                color: '#333',
                                border: '1px solid #e0e0e0',
                                borderRadius: '6px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '500',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px',
                                transition: 'all 0.2s'
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.background = '#e8ecef';
                                e.currentTarget.style.borderColor = '#0077CC';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.background = '#f5f7fa';
                                e.currentTarget.style.borderColor = '#e0e0e0';
                            }}
                        >
                            {AdminIcons.ArrowLeft({ size: 16 })}
                            Back to Users
                        </button>
                    </div>

                    {/* User Summary Bar */}
                    <div style={{ display: 'flex', alignItems: 'center', gap: '20px', flexWrap: 'wrap' }}>
                        {/* Avatar */}
                        <div style={{
                            width: '60px',
                            height: '60px',
                            borderRadius: '50%',
                            background: 'linear-gradient(135deg, #0077CC, #005A9C)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            color: 'white',
                            fontSize: '24px',
                            fontWeight: '600',
                            flexShrink: 0
                        }}>
                            {pirData.profileImageUrl ? (
                                <img
                                    src={pirData.profileImageUrl}
                                    alt="Profile"
                                    style={{ width: '100%', height: '100%', borderRadius: '50%', objectFit: 'cover' }}
                                />
                            ) : (
                                (pirData.firstName?.[0] || pirData.email?.[0] || '?').toUpperCase()
                            )}
                        </div>

                        {/* Name, Contact Info, and Status */}
                        <div style={{ flex: 1, minWidth: '200px' }}>
                            <h1 style={{ margin: 0, fontSize: '22px', color: '#333', fontWeight: '600' }}>
                                {pirData.displayName || `${pirData.firstName || ''} ${pirData.lastName || ''}`.trim() || pirData.email}
                            </h1>

                            {/* Contact Info - Email & Phone */}
                            <div style={{ display: 'flex', gap: '16px', marginTop: '4px', flexWrap: 'wrap', alignItems: 'center' }}>
                                {pirData.email && (
                                    <a href={`mailto:${pirData.email}`} style={{
                                        fontSize: '13px',
                                        color: '#008B8B',
                                        textDecoration: 'none',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '4px'
                                    }}>
                                        {AdminIcons.Mail({ size: 14, color: '#008B8B' })}
                                        {pirData.email}
                                    </a>
                                )}
                                {pirData.phone && (
                                    <a href={`tel:${pirData.phone}`} style={{
                                        fontSize: '13px',
                                        color: '#008B8B',
                                        textDecoration: 'none',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '4px'
                                    }}>
                                        {AdminIcons.Phone({ size: 14, color: '#008B8B' })}
                                        {pirData.phone}
                                    </a>
                                )}
                            </div>

                            {/* Status Badges - All Teal */}
                            <div style={{ display: 'flex', gap: '8px', marginTop: '8px', flexWrap: 'wrap' }}>
                                <span style={{
                                    padding: '4px 10px',
                                    borderRadius: '12px',
                                    fontSize: '12px',
                                    fontWeight: '500',
                                    background: pirData.active !== false ? '#E0F2F1' : '#FFEBEE',
                                    color: pirData.active !== false ? '#008B8B' : '#C62828'
                                }}>
                                    {pirData.active !== false ? 'Active' : 'Inactive'}
                                </span>
                                <span style={{
                                    padding: '4px 10px',
                                    borderRadius: '12px',
                                    fontSize: '12px',
                                    fontWeight: '500',
                                    background: '#E0F2F1',
                                    color: '#008B8B'
                                }}>
                                    {pirData.role?.toUpperCase() || 'PIR'}
                                </span>
                                {pirData.sobrietyDays && (
                                    <span style={{
                                        padding: '4px 10px',
                                        borderRadius: '12px',
                                        fontSize: '12px',
                                        fontWeight: '600',
                                        background: '#008B8B',
                                        color: 'white'
                                    }}>
                                        {pirData.sobrietyDays} Days
                                    </span>
                                )}
                            </div>
                        </div>

                        {/* Emergency Contact */}
                        <div style={{
                            padding: '12px 16px',
                            background: '#FFF8E1',
                            borderRadius: '8px',
                            borderLeft: '3px solid #FF9800',
                            minWidth: '180px'
                        }}>
                            <div style={{ fontSize: '11px', color: '#666', fontWeight: '600', marginBottom: '4px', display: 'flex', alignItems: 'center', gap: '4px' }}>
                                {AdminIcons.Phone({ size: 12, color: '#FF9800' })}
                                EMERGENCY CONTACT
                            </div>
                            {pirData.emergencyContacts && pirData.emergencyContacts.length > 0 ? (
                                <div>
                                    <div style={{ fontSize: '13px', fontWeight: '600', color: '#333' }}>
                                        {pirData.emergencyContacts[0].name}
                                    </div>
                                    <div style={{ fontSize: '12px', color: '#666' }}>
                                        {pirData.emergencyContacts[0].relationship}
                                    </div>
                                    <a href={`tel:${pirData.emergencyContacts[0].phone}`} style={{
                                        fontSize: '12px',
                                        color: '#008B8B',
                                        textDecoration: 'none',
                                        fontWeight: '500'
                                    }}>
                                        {pirData.emergencyContacts[0].phone}
                                    </a>
                                </div>
                            ) : (
                                <div style={{ fontSize: '12px', color: '#999', fontStyle: 'italic' }}>
                                    Not set
                                </div>
                            )}
                        </div>

                        {/* Quick Stats - All Teal */}
                        <div style={{ display: 'flex', gap: '24px' }}>
                            <div style={{ textAlign: 'center' }}>
                                <div style={{ fontSize: '20px', fontWeight: '700', color: '#008B8B' }}>
                                    {complianceData.morningRate || 0}%
                                </div>
                                <div style={{ fontSize: '11px', color: '#666' }}>Morning</div>
                            </div>
                            <div style={{ textAlign: 'center' }}>
                                <div style={{ fontSize: '20px', fontWeight: '700', color: '#008B8B' }}>
                                    {complianceData.eveningRate || 0}%
                                </div>
                                <div style={{ fontSize: '11px', color: '#666' }}>Evening</div>
                            </div>
                            <div style={{ textAlign: 'center' }}>
                                <div style={{ fontSize: '20px', fontWeight: '700', color: '#008B8B' }}>
                                    {streakData.checkInStreak || 0}
                                </div>
                                <div style={{ fontSize: '11px', color: '#666' }}>Streak</div>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Tab Bar - Option B: Horizontal, Text Only */}
                <div style={{
                    background: 'white',
                    borderBottom: '1px solid #e0e0e0',
                    padding: '0 30px'
                }}>
                    <div style={{
                        display: 'flex',
                        flexWrap: 'wrap',
                        gap: '0'
                    }}>
                        {TABS.map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => setActiveTab(tab.id)}
                                style={{
                                    padding: '14px 20px',
                                    border: 'none',
                                    background: 'transparent',
                                    color: activeTab === tab.id ? '#0077CC' : '#666',
                                    fontSize: '14px',
                                    fontWeight: activeTab === tab.id ? '600' : '500',
                                    cursor: 'pointer',
                                    position: 'relative',
                                    transition: 'color 0.2s'
                                }}
                                onMouseEnter={(e) => {
                                    if (activeTab !== tab.id) {
                                        e.currentTarget.style.color = '#333';
                                    }
                                }}
                                onMouseLeave={(e) => {
                                    if (activeTab !== tab.id) {
                                        e.currentTarget.style.color = '#666';
                                    }
                                }}
                            >
                                {tab.label}
                                {/* Active indicator - underline */}
                                {activeTab === tab.id && (
                                    <div style={{
                                        position: 'absolute',
                                        bottom: 0,
                                        left: '20px',
                                        right: '20px',
                                        height: '3px',
                                        background: '#0077CC',
                                        borderRadius: '3px 3px 0 0'
                                    }} />
                                )}
                            </button>
                        ))}
                    </div>
                </div>

                {/* Tab Content */}
                <div style={{ minHeight: '500px' }}>
                    {activeTab === 'overview' && (
                        <OverviewTab
                            pirData={pirData}
                            editData={editData}
                            setEditData={setEditData}
                            editing={editing}
                            setEditing={setEditing}
                            saving={saving}
                            saveProfile={saveProfile}
                            changeCoach={changeCoach}
                            availableCoaches={availableCoaches}
                            assignedCoachData={assignedCoachData}
                            complianceData={complianceData}
                            streakData={streakData}
                            formatDate={formatDate}
                        />
                    )}
                    {activeTab === 'wellness' && (
                        <WellnessTab
                            checkIns={checkIns}
                            chartData={chartData}
                            moodChartRef={moodChartRef}
                            cravingChartRef={cravingChartRef}
                            anxietyChartRef={anxietyChartRef}
                            sleepChartRef={sleepChartRef}
                            streakData={streakData}
                            pirId={pirId}
                            currentUser={currentUser}
                            formatDateTime={formatDateTime}
                        />
                    )}
                    {activeTab === 'tasks' && (
                        <TasksTab
                            assignments={assignments}
                            setAssignments={setAssignments}
                            goals={goals}
                            setGoals={setGoals}
                            objectives={objectives}
                            setObjectives={setObjectives}
                            checkIns={checkIns}
                            journeyData={journeyData}
                            pirId={pirId}
                            currentUser={currentUser}
                            formatDate={formatDate}
                            formatDateTime={formatDateTime}
                            formatTimeAgo={formatTimeAgo}
                        />
                    )}
                    {activeTab === 'messages' && (
                        <MessagesTab
                            allMessages={allMessages}
                            pirId={pirId}
                            pirData={pirData}
                            currentUser={currentUser}
                            formatDateTime={formatDateTime}
                            formatTimeAgo={formatTimeAgo}
                        />
                    )}
                    {activeTab === 'meetings' && (
                        <MeetingsTab
                            meetings={meetings}
                            savedMeetings={savedMeetings}
                            pirId={pirId}
                            pirData={pirData}
                            currentUser={currentUser}
                            formatDate={formatDate}
                            formatDateTime={formatDateTime}
                        />
                    )}
                    {activeTab === 'guides' && (
                        <GuidesTab
                            resources={resources}
                            assignedResources={assignedResources}
                            resourceProgress={resourceProgress}
                            pirId={pirId}
                            currentUser={currentUser}
                        />
                    )}
                    {activeTab === 'journey' && (
                        <JourneyTab
                            journeyData={journeyData}
                            milestones={milestones}
                            pirData={pirData}
                            checkIns={checkIns}
                            activities={activities}
                            formatDate={formatDate}
                            formatTimeAgo={formatTimeAgo}
                        />
                    )}
                    {activeTab === 'community' && (
                        <CommunityTab
                            supportGroups={supportGroups}
                            topicRooms={topicRooms}
                            pledges={pledges}
                            dailyPosts={dailyPosts}
                            pirId={pirId}
                            currentUser={currentUser}
                            formatTimeAgo={formatTimeAgo}
                        />
                    )}
                    {activeTab === 'financial' && (
                        <FinancialTab
                            financialData={financialData}
                            pirData={pirData}
                            formatDate={formatDate}
                        />
                    )}
                    {activeTab === 'documentation' && (
                        <DocumentationTab
                            documentationData={documentationData}
                            pirId={pirId}
                            currentUser={currentUser}
                            formatDateTime={formatDateTime}
                        />
                    )}
                    {activeTab === 'activity' && (
                        <ActivityTab
                            activities={activities}
                            formatTimeAgo={formatTimeAgo}
                        />
                    )}
                </div>
            </div>
        );
    }

    // ==========================================
    // OVERVIEW TAB - Complete Implementation
    // ==========================================
    function OverviewTab({
        pirData,
        editData,
        setEditData,
        editing,
        setEditing,
        saving,
        saveProfile,
        changeCoach,
        availableCoaches,
        assignedCoachData,
        complianceData,
        streakData,
        formatDate
    }) {
        const [showCoachModal, setShowCoachModal] = useState(false);
        const [showEmergencyModal, setShowEmergencyModal] = useState(false);
        const [newEmergencyContact, setNewEmergencyContact] = useState({ name: '', relationship: '', phone: '' });

        const addEmergencyContact = () => {
            if (!newEmergencyContact.name || !newEmergencyContact.phone) {
                alert('Please enter name and phone number');
                return;
            }
            const contacts = [...(editData.emergencyContacts || []), newEmergencyContact];
            setEditData({ ...editData, emergencyContacts: contacts });
            setNewEmergencyContact({ name: '', relationship: '', phone: '' });
            setShowEmergencyModal(false);
        };

        const removeEmergencyContact = (index) => {
            const contacts = editData.emergencyContacts.filter((_, i) => i !== index);
            setEditData({ ...editData, emergencyContacts: contacts });
        };

        return (
            <div style={{ padding: '30px' }}>
                {/* Edit Mode Toggle */}
                <div style={{ display: 'flex', justifyContent: 'flex-end', marginBottom: '20px' }}>
                    {!editing ? (
                        <button
                            onClick={() => setEditing(true)}
                            style={{
                                padding: '10px 20px',
                                background: '#0077CC',
                                color: 'white',
                                border: 'none',
                                borderRadius: '6px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '500',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                            }}
                        >
                            {AdminIcons.Edit({ size: 16 })}
                            Edit Profile
                        </button>
                    ) : (
                        <div style={{ display: 'flex', gap: '10px' }}>
                            <button
                                onClick={() => {
                                    setEditData(pirData);
                                    setEditing(false);
                                }}
                                style={{
                                    padding: '10px 20px',
                                    background: '#f5f7fa',
                                    color: '#333',
                                    border: '1px solid #e0e0e0',
                                    borderRadius: '6px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500'
                                }}
                            >
                                Cancel
                            </button>
                            <button
                                onClick={saveProfile}
                                disabled={saving}
                                style={{
                                    padding: '10px 20px',
                                    background: saving ? '#ccc' : '#00A86B',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '6px',
                                    cursor: saving ? 'not-allowed' : 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px'
                                }}
                            >
                                {saving ? 'Saving...' : 'Save Changes'}
                            </button>
                        </div>
                    )}
                </div>

                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(350px, 1fr))', gap: '24px' }}>
                    {/* Personal Information Card */}
                    <div style={{
                        background: 'white',
                        borderRadius: '12px',
                        padding: '24px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                    }}>
                        <h3 style={{
                            margin: '0 0 20px 0',
                            fontSize: '16px',
                            color: '#333',
                            fontWeight: '600',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '10px',
                            paddingBottom: '12px',
                            borderBottom: '1px solid #f0f0f0'
                        }}>
                            {AdminIcons.User({ size: 18, color: '#0077CC' })}
                            Personal Information
                        </h3>

                        <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                            {/* First Name */}
                            <div>
                                <label style={{ display: 'block', fontSize: '12px', color: '#666', marginBottom: '4px', fontWeight: '500' }}>
                                    First Name
                                </label>
                                {editing ? (
                                    <input
                                        type="text"
                                        value={editData.firstName || ''}
                                        onChange={(e) => setEditData({ ...editData, firstName: e.target.value })}
                                        style={{
                                            width: '100%',
                                            padding: '10px 12px',
                                            border: '1px solid #e0e0e0',
                                            borderRadius: '6px',
                                            fontSize: '14px',
                                            boxSizing: 'border-box'
                                        }}
                                    />
                                ) : (
                                    <div style={{ fontSize: '14px', color: '#333' }}>{pirData.firstName || 'Not provided'}</div>
                                )}
                            </div>

                            {/* Last Name */}
                            <div>
                                <label style={{ display: 'block', fontSize: '12px', color: '#666', marginBottom: '4px', fontWeight: '500' }}>
                                    Last Name
                                </label>
                                {editing ? (
                                    <input
                                        type="text"
                                        value={editData.lastName || ''}
                                        onChange={(e) => setEditData({ ...editData, lastName: e.target.value })}
                                        style={{
                                            width: '100%',
                                            padding: '10px 12px',
                                            border: '1px solid #e0e0e0',
                                            borderRadius: '6px',
                                            fontSize: '14px',
                                            boxSizing: 'border-box'
                                        }}
                                    />
                                ) : (
                                    <div style={{ fontSize: '14px', color: '#333' }}>{pirData.lastName || 'Not provided'}</div>
                                )}
                            </div>

                            {/* Email (read-only) */}
                            <div>
                                <label style={{ display: 'block', fontSize: '12px', color: '#666', marginBottom: '4px', fontWeight: '500' }}>
                                    Email
                                </label>
                                <div style={{ fontSize: '14px', color: '#333' }}>{pirData.email}</div>
                            </div>

                            {/* Phone */}
                            <div>
                                <label style={{ display: 'block', fontSize: '12px', color: '#666', marginBottom: '4px', fontWeight: '500' }}>
                                    Phone
                                </label>
                                {editing ? (
                                    <input
                                        type="tel"
                                        value={editData.phone || ''}
                                        onChange={(e) => setEditData({ ...editData, phone: e.target.value })}
                                        style={{
                                            width: '100%',
                                            padding: '10px 12px',
                                            border: '1px solid #e0e0e0',
                                            borderRadius: '6px',
                                            fontSize: '14px',
                                            boxSizing: 'border-box'
                                        }}
                                    />
                                ) : (
                                    <div style={{ fontSize: '14px', color: '#333' }}>{pirData.phone || 'Not provided'}</div>
                                )}
                            </div>

                            {/* Date of Birth */}
                            <div>
                                <label style={{ display: 'block', fontSize: '12px', color: '#666', marginBottom: '4px', fontWeight: '500' }}>
                                    Date of Birth
                                </label>
                                {editing ? (
                                    <input
                                        type="date"
                                        value={editData.dateOfBirth || ''}
                                        onChange={(e) => setEditData({ ...editData, dateOfBirth: e.target.value })}
                                        style={{
                                            width: '100%',
                                            padding: '10px 12px',
                                            border: '1px solid #e0e0e0',
                                            borderRadius: '6px',
                                            fontSize: '14px',
                                            boxSizing: 'border-box'
                                        }}
                                    />
                                ) : (
                                    <div style={{ fontSize: '14px', color: '#333' }}>{formatDate(pirData.dateOfBirth) || 'Not provided'}</div>
                                )}
                            </div>

                            {/* Account Info */}
                            <div style={{ marginTop: '8px', paddingTop: '16px', borderTop: '1px solid #f0f0f0' }}>
                                <div style={{ fontSize: '12px', color: '#666', marginBottom: '4px' }}>Account Created</div>
                                <div style={{ fontSize: '14px', color: '#333' }}>{pirData.createdAtFormatted || 'Unknown'}</div>
                            </div>
                            <div>
                                <div style={{ fontSize: '12px', color: '#666', marginBottom: '4px' }}>Last Login</div>
                                <div style={{ fontSize: '14px', color: '#333' }}>{pirData.lastLoginFormatted || 'Never'}</div>
                            </div>
                        </div>
                    </div>

                    {/* Recovery Information Card */}
                    <div style={{
                        background: 'white',
                        borderRadius: '12px',
                        padding: '24px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                    }}>
                        <h3 style={{
                            margin: '0 0 20px 0',
                            fontSize: '16px',
                            color: '#333',
                            fontWeight: '600',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '10px',
                            paddingBottom: '12px',
                            borderBottom: '1px solid #f0f0f0'
                        }}>
                            {AdminIcons.Target({ size: 18, color: '#00A86B' })}
                            Recovery Information
                        </h3>

                        <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                            {/* Sobriety Date */}
                            <div>
                                <label style={{ display: 'block', fontSize: '12px', color: '#666', marginBottom: '4px', fontWeight: '500' }}>
                                    Sobriety Date
                                </label>
                                {editing ? (
                                    <input
                                        type="date"
                                        value={editData.sobrietyDate || ''}
                                        onChange={(e) => setEditData({ ...editData, sobrietyDate: e.target.value })}
                                        style={{
                                            width: '100%',
                                            padding: '10px 12px',
                                            border: '1px solid #e0e0e0',
                                            borderRadius: '6px',
                                            fontSize: '14px',
                                            boxSizing: 'border-box'
                                        }}
                                    />
                                ) : (
                                    <div style={{ fontSize: '14px', color: '#333' }}>{formatDate(pirData.sobrietyDate) || 'Not set'}</div>
                                )}
                            </div>

                            {/* Days Clean */}
                            <div>
                                <label style={{ display: 'block', fontSize: '12px', color: '#666', marginBottom: '4px', fontWeight: '500' }}>
                                    Days Clean
                                </label>
                                <div style={{
                                    fontSize: '28px',
                                    fontWeight: '700',
                                    background: 'linear-gradient(135deg, #FFD700, #FFA500)',
                                    WebkitBackgroundClip: 'text',
                                    WebkitTextFillColor: 'transparent',
                                    backgroundClip: 'text'
                                }}>
                                    {pirData.sobrietyDays || 0} days
                                </div>
                            </div>

                            {/* Primary Substance */}
                            <div>
                                <label style={{ display: 'block', fontSize: '12px', color: '#666', marginBottom: '4px', fontWeight: '500' }}>
                                    Primary Substance
                                </label>
                                {editing ? (
                                    <input
                                        type="text"
                                        value={editData.substance || ''}
                                        onChange={(e) => setEditData({ ...editData, substance: e.target.value })}
                                        style={{
                                            width: '100%',
                                            padding: '10px 12px',
                                            border: '1px solid #e0e0e0',
                                            borderRadius: '6px',
                                            fontSize: '14px',
                                            boxSizing: 'border-box'
                                        }}
                                    />
                                ) : (
                                    <div style={{ fontSize: '14px', color: '#333' }}>{pirData.substance || 'Not specified'}</div>
                                )}
                            </div>

                            {/* Daily Cost */}
                            <div>
                                <label style={{ display: 'block', fontSize: '12px', color: '#666', marginBottom: '4px', fontWeight: '500' }}>
                                    Daily Cost (before recovery)
                                </label>
                                {editing ? (
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                        <span>$</span>
                                        <input
                                            type="number"
                                            value={editData.dailyCost || 20}
                                            onChange={(e) => setEditData({ ...editData, dailyCost: parseInt(e.target.value) || 0 })}
                                            style={{
                                                width: '100px',
                                                padding: '10px 12px',
                                                border: '1px solid #e0e0e0',
                                                borderRadius: '6px',
                                                fontSize: '14px'
                                            }}
                                        />
                                        <span>/day</span>
                                    </div>
                                ) : (
                                    <div style={{ fontSize: '14px', color: '#333' }}>${pirData.dailyCost || 20}/day</div>
                                )}
                            </div>

                            {/* Money Saved */}
                            <div style={{ marginTop: '8px', paddingTop: '16px', borderTop: '1px solid #f0f0f0' }}>
                                <label style={{ display: 'block', fontSize: '12px', color: '#666', marginBottom: '4px', fontWeight: '500' }}>
                                    Total Money Saved
                                </label>
                                <div style={{ fontSize: '24px', fontWeight: '700', color: '#00A86B' }}>
                                    ${pirData.moneySaved?.toLocaleString() || 0}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Coach Assignment Card */}
                    <div style={{
                        background: 'white',
                        borderRadius: '12px',
                        padding: '24px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                    }}>
                        <h3 style={{
                            margin: '0 0 20px 0',
                            fontSize: '16px',
                            color: '#333',
                            fontWeight: '600',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'space-between',
                            paddingBottom: '12px',
                            borderBottom: '1px solid #f0f0f0'
                        }}>
                            <span style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                {AdminIcons.Award({ size: 18, color: '#9C27B0' })}
                                Coach Assignment
                            </span>
                            <button
                                onClick={() => setShowCoachModal(true)}
                                style={{
                                    padding: '6px 12px',
                                    background: '#f5f7fa',
                                    color: '#0077CC',
                                    border: '1px solid #e0e0e0',
                                    borderRadius: '4px',
                                    cursor: 'pointer',
                                    fontSize: '12px',
                                    fontWeight: '500'
                                }}
                            >
                                Change Coach
                            </button>
                        </h3>

                        {pirData.assignedCoach ? (
                            <div>
                                {(() => {
                                    // Try to find coach in availableCoaches first, fall back to directly loaded assignedCoachData
                                    const coach = availableCoaches.find(c => c.id === pirData.assignedCoach) || assignedCoachData;
                                    return coach ? (
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                            <div style={{
                                                width: '48px',
                                                height: '48px',
                                                borderRadius: '50%',
                                                background: 'linear-gradient(135deg, #9C27B0, #7B1FA2)',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                color: 'white',
                                                fontSize: '18px',
                                                fontWeight: '600'
                                            }}>
                                                {(coach.firstName?.[0] || coach.email?.[0] || '?').toUpperCase()}
                                            </div>
                                            <div>
                                                <div style={{ fontSize: '15px', fontWeight: '500', color: '#333' }}>
                                                    {coach.displayName || `${coach.firstName || ''} ${coach.lastName || ''}`.trim() || coach.email}
                                                </div>
                                                <div style={{ fontSize: '13px', color: '#666' }}>{coach.email}</div>
                                            </div>
                                        </div>
                                    ) : (
                                        <div style={{ fontSize: '14px', color: '#666' }}>Loading coach info...</div>
                                    );
                                })()}
                            </div>
                        ) : (
                            <div style={{
                                textAlign: 'center',
                                padding: '20px',
                                background: '#FFF8E1',
                                borderRadius: '8px',
                                color: '#F57C00'
                            }}>
                                {AdminIcons.AlertCircle({ size: 24 })}
                                <div style={{ marginTop: '8px', fontWeight: '500' }}>No coach assigned</div>
                                <div style={{ fontSize: '13px', marginTop: '4px' }}>Click "Change Coach" to assign</div>
                            </div>
                        )}
                    </div>

                    {/* Emergency Contacts Card */}
                    <div style={{
                        background: 'white',
                        borderRadius: '12px',
                        padding: '24px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                    }}>
                        <h3 style={{
                            margin: '0 0 20px 0',
                            fontSize: '16px',
                            color: '#333',
                            fontWeight: '600',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'space-between',
                            paddingBottom: '12px',
                            borderBottom: '1px solid #f0f0f0'
                        }}>
                            <span style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                {AdminIcons.Phone({ size: 18, color: '#DC143C' })}
                                Emergency Contacts
                            </span>
                            {editing && (
                                <button
                                    onClick={() => setShowEmergencyModal(true)}
                                    style={{
                                        padding: '6px 12px',
                                        background: '#f5f7fa',
                                        color: '#0077CC',
                                        border: '1px solid #e0e0e0',
                                        borderRadius: '4px',
                                        cursor: 'pointer',
                                        fontSize: '12px',
                                        fontWeight: '500'
                                    }}
                                >
                                    + Add Contact
                                </button>
                            )}
                        </h3>

                        {(editing ? editData.emergencyContacts : pirData.emergencyContacts)?.length > 0 ? (
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                {(editing ? editData.emergencyContacts : pirData.emergencyContacts).map((contact, i) => (
                                    <div key={i} style={{
                                        padding: '12px',
                                        background: '#f8f9fa',
                                        borderRadius: '8px',
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center'
                                    }}>
                                        <div>
                                            <div style={{ fontWeight: '500', color: '#333' }}>{contact.name}</div>
                                            <div style={{ fontSize: '13px', color: '#666' }}>
                                                {contact.relationship} - {contact.phone}
                                            </div>
                                        </div>
                                        {editing && (
                                            <button
                                                onClick={() => removeEmergencyContact(i)}
                                                style={{
                                                    padding: '4px 8px',
                                                    background: '#FFEBEE',
                                                    color: '#C62828',
                                                    border: 'none',
                                                    borderRadius: '4px',
                                                    cursor: 'pointer',
                                                    fontSize: '12px'
                                                }}
                                            >
                                                Remove
                                            </button>
                                        )}
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div style={{
                                textAlign: 'center',
                                padding: '20px',
                                background: '#FFEBEE',
                                borderRadius: '8px',
                                color: '#C62828'
                            }}>
                                {AdminIcons.AlertTriangle({ size: 24 })}
                                <div style={{ marginTop: '8px', fontWeight: '500' }}>No emergency contacts</div>
                                <div style={{ fontSize: '13px', marginTop: '4px' }}>
                                    {editing ? 'Click "+ Add Contact" to add one' : 'Edit profile to add contacts'}
                                </div>
                            </div>
                        )}
                    </div>
                </div>

                {/* Coach Selection Modal */}
                {showCoachModal && (
                    <div style={{
                        position: 'fixed',
                        top: 0,
                        left: 0,
                        right: 0,
                        bottom: 0,
                        background: 'rgba(0,0,0,0.5)',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        zIndex: 10000
                    }} onClick={() => setShowCoachModal(false)}>
                        <div style={{
                            background: 'white',
                            borderRadius: '12px',
                            padding: '24px',
                            width: '400px',
                            maxHeight: '500px',
                            overflow: 'auto'
                        }} onClick={(e) => e.stopPropagation()}>
                            <h3 style={{ margin: '0 0 20px 0', fontSize: '18px', color: '#333' }}>Select Coach</h3>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                {availableCoaches.map(coach => (
                                    <button
                                        key={coach.id}
                                        onClick={() => {
                                            changeCoach(coach.id);
                                            setShowCoachModal(false);
                                        }}
                                        style={{
                                            padding: '12px',
                                            background: coach.id === pirData.assignedCoach ? '#E3F2FD' : '#f8f9fa',
                                            border: coach.id === pirData.assignedCoach ? '2px solid #0077CC' : '1px solid #e0e0e0',
                                            borderRadius: '8px',
                                            cursor: 'pointer',
                                            textAlign: 'left',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '12px'
                                        }}
                                    >
                                        <div style={{
                                            width: '40px',
                                            height: '40px',
                                            borderRadius: '50%',
                                            background: 'linear-gradient(135deg, #9C27B0, #7B1FA2)',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            color: 'white',
                                            fontSize: '16px',
                                            fontWeight: '600'
                                        }}>
                                            {(coach.firstName?.[0] || coach.email?.[0] || '?').toUpperCase()}
                                        </div>
                                        <div>
                                            <div style={{ fontWeight: '500', color: '#333' }}>
                                                {coach.displayName || `${coach.firstName || ''} ${coach.lastName || ''}`.trim() || coach.email}
                                            </div>
                                            <div style={{ fontSize: '12px', color: '#666' }}>{coach.email}</div>
                                        </div>
                                    </button>
                                ))}
                            </div>
                            <button
                                onClick={() => setShowCoachModal(false)}
                                style={{
                                    marginTop: '20px',
                                    padding: '10px 20px',
                                    background: '#f5f7fa',
                                    color: '#333',
                                    border: '1px solid #e0e0e0',
                                    borderRadius: '6px',
                                    cursor: 'pointer',
                                    width: '100%'
                                }}
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                )}

                {/* Emergency Contact Modal */}
                {showEmergencyModal && (
                    <div style={{
                        position: 'fixed',
                        top: 0,
                        left: 0,
                        right: 0,
                        bottom: 0,
                        background: 'rgba(0,0,0,0.5)',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        zIndex: 10000
                    }} onClick={() => setShowEmergencyModal(false)}>
                        <div style={{
                            background: 'white',
                            borderRadius: '12px',
                            padding: '24px',
                            width: '400px'
                        }} onClick={(e) => e.stopPropagation()}>
                            <h3 style={{ margin: '0 0 20px 0', fontSize: '18px', color: '#333' }}>Add Emergency Contact</h3>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                <div>
                                    <label style={{ display: 'block', fontSize: '12px', color: '#666', marginBottom: '4px' }}>Name *</label>
                                    <input
                                        type="text"
                                        value={newEmergencyContact.name}
                                        onChange={(e) => setNewEmergencyContact({ ...newEmergencyContact, name: e.target.value })}
                                        style={{
                                            width: '100%',
                                            padding: '10px 12px',
                                            border: '1px solid #e0e0e0',
                                            borderRadius: '6px',
                                            fontSize: '14px',
                                            boxSizing: 'border-box'
                                        }}
                                    />
                                </div>
                                <div>
                                    <label style={{ display: 'block', fontSize: '12px', color: '#666', marginBottom: '4px' }}>Relationship</label>
                                    <input
                                        type="text"
                                        value={newEmergencyContact.relationship}
                                        onChange={(e) => setNewEmergencyContact({ ...newEmergencyContact, relationship: e.target.value })}
                                        placeholder="e.g., Spouse, Parent, Friend"
                                        style={{
                                            width: '100%',
                                            padding: '10px 12px',
                                            border: '1px solid #e0e0e0',
                                            borderRadius: '6px',
                                            fontSize: '14px',
                                            boxSizing: 'border-box'
                                        }}
                                    />
                                </div>
                                <div>
                                    <label style={{ display: 'block', fontSize: '12px', color: '#666', marginBottom: '4px' }}>Phone *</label>
                                    <input
                                        type="tel"
                                        value={newEmergencyContact.phone}
                                        onChange={(e) => setNewEmergencyContact({ ...newEmergencyContact, phone: e.target.value })}
                                        style={{
                                            width: '100%',
                                            padding: '10px 12px',
                                            border: '1px solid #e0e0e0',
                                            borderRadius: '6px',
                                            fontSize: '14px',
                                            boxSizing: 'border-box'
                                        }}
                                    />
                                </div>
                            </div>
                            <div style={{ display: 'flex', gap: '10px', marginTop: '20px' }}>
                                <button
                                    onClick={() => setShowEmergencyModal(false)}
                                    style={{
                                        flex: 1,
                                        padding: '10px',
                                        background: '#f5f7fa',
                                        color: '#333',
                                        border: '1px solid #e0e0e0',
                                        borderRadius: '6px',
                                        cursor: 'pointer'
                                    }}
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={addEmergencyContact}
                                    style={{
                                        flex: 1,
                                        padding: '10px',
                                        background: '#0077CC',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '6px',
                                        cursor: 'pointer'
                                    }}
                                >
                                    Add Contact
                                </button>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    // ==========================================
    // ==========================================
    // WELLNESS TAB - Phase 3 Implementation
    // 30-day charts, trends, patterns, coach notes
    // ==========================================
    function WellnessTab({
        checkIns, chartData, moodChartRef, cravingChartRef, anxietyChartRef, sleepChartRef,
        streakData, pirId, currentUser, formatDateTime
    }) {
        const [activeSubTab, setActiveSubTab] = useState('charts');
        const [coachNotes, setCoachNotes] = useState([]);
        const [loadingNotes, setLoadingNotes] = useState(true);
        const [showAddNote, setShowAddNote] = useState(false);
        const [editingNote, setEditingNote] = useState(null);
        const [noteText, setNoteText] = useState('');
        const [noteCategory, setNoteCategory] = useState('general');
        const [saving, setSaving] = useState(false);

        // Load coach notes
        useEffect(() => {
            if (pirId) loadCoachNotes();
        }, [pirId]);

        const loadCoachNotes = async () => {
            try {
                setLoadingNotes(true);
                const snap = await db.collection('coachNotes')
                    .where('pirId', '==', pirId)
                    .orderBy('createdAt', 'desc')
                    .get();
                const notes = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setCoachNotes(notes);
            } catch (error) {
                console.error('Error loading coach notes:', error);
            } finally {
                setLoadingNotes(false);
            }
        };

        // Calculate trend data
        const calculateTrends = () => {
            if (!chartData || !chartData.moods) return null;

            const metrics = ['moods', 'cravings', 'anxiety', 'sleep'];
            const trends = {};

            metrics.forEach(metric => {
                const data = chartData[metric].filter(v => v !== null && v !== undefined);
                if (data.length === 0) {
                    trends[metric] = { avg30: 0, avg7: 0, trend: 'stable', change: 0 };
                    return;
                }

                const last30 = data;
                const last7 = data.slice(-7);

                const avg30 = last30.reduce((a, b) => a + b, 0) / last30.length;
                const avg7 = last7.length > 0 ? last7.reduce((a, b) => a + b, 0) / last7.length : avg30;

                const change = avg7 - avg30;
                let trend = 'stable';
                if (Math.abs(change) > 0.5) {
                    trend = change > 0 ? 'up' : 'down';
                }

                trends[metric] = {
                    avg30: avg30.toFixed(1),
                    avg7: avg7.toFixed(1),
                    trend,
                    change: change.toFixed(1)
                };
            });

            return trends;
        };

        // Detect concerning patterns
        const detectPatterns = () => {
            if (!chartData) return [];

            const patterns = [];
            const trends = calculateTrends();
            if (!trends) return patterns;

            // High craving average
            if (parseFloat(trends.cravings.avg7) > 5) {
                patterns.push({
                    type: 'warning',
                    title: 'Elevated Craving Levels',
                    message: `7-day average craving is ${trends.cravings.avg7}/10. Consider additional support or coping strategies.`,
                    metric: 'craving',
                    severity: 'high'
                });
            }

            // Low mood
            if (parseFloat(trends.moods.avg7) < 4) {
                patterns.push({
                    type: 'warning',
                    title: 'Low Mood Detected',
                    message: `7-day average mood is ${trends.moods.avg7}/10. May indicate depression or struggles.`,
                    metric: 'mood',
                    severity: 'high'
                });
            }

            // Poor sleep
            if (parseFloat(trends.sleep.avg7) < 4) {
                patterns.push({
                    type: 'warning',
                    title: 'Poor Sleep Quality',
                    message: `7-day average sleep quality is ${trends.sleep.avg7}/10. Sleep issues can impact recovery.`,
                    metric: 'sleep',
                    severity: 'medium'
                });
            }

            // Rising anxiety
            if (trends.anxiety.trend === 'up' && parseFloat(trends.anxiety.change) > 1) {
                patterns.push({
                    type: 'warning',
                    title: 'Rising Anxiety',
                    message: `Anxiety increased by ${Math.abs(trends.anxiety.change)} points over the week. Monitor closely.`,
                    metric: 'anxiety',
                    severity: 'medium'
                });
            }

            // Positive patterns
            if (parseFloat(trends.moods.avg7) >= 7) {
                patterns.push({
                    type: 'positive',
                    title: 'Strong Mood',
                    message: `7-day average mood is ${trends.moods.avg7}/10. Excellent progress!`,
                    metric: 'mood',
                    severity: 'positive'
                });
            }

            if (parseFloat(trends.cravings.avg7) < 3) {
                patterns.push({
                    type: 'positive',
                    title: 'Low Cravings',
                    message: `7-day average craving is only ${trends.cravings.avg7}/10. Great control!`,
                    metric: 'craving',
                    severity: 'positive'
                });
            }

            return patterns;
        };

        // Coach Notes CRUD
        const handleSaveNote = async () => {
            if (!noteText.trim()) return;
            try {
                setSaving(true);
                if (editingNote) {
                    await db.collection('coachNotes').doc(editingNote.id).update({
                        text: noteText.trim(),
                        category: noteCategory,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: currentUser.id
                    });
                    setCoachNotes(coachNotes.map(n =>
                        n.id === editingNote.id ? { ...n, text: noteText, category: noteCategory } : n
                    ));
                } else {
                    const docRef = await db.collection('coachNotes').add({
                        pirId,
                        text: noteText.trim(),
                        category: noteCategory,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: currentUser.id,
                        coachName: currentUser.displayName || currentUser.email
                    });
                    setCoachNotes([{
                        id: docRef.id,
                        text: noteText,
                        category: noteCategory,
                        createdAt: new Date(),
                        coachName: currentUser.displayName || currentUser.email
                    }, ...coachNotes]);
                }
                setNoteText('');
                setNoteCategory('general');
                setShowAddNote(false);
                setEditingNote(null);
            } catch (error) {
                console.error('Error saving note:', error);
                alert('Failed to save note: ' + error.message);
            } finally {
                setSaving(false);
            }
        };

        const handleDeleteNote = async (noteId) => {
            if (!confirm('Are you sure you want to delete this note?')) return;
            try {
                await db.collection('coachNotes').doc(noteId).delete();
                setCoachNotes(coachNotes.filter(n => n.id !== noteId));
            } catch (error) {
                console.error('Error deleting note:', error);
                alert('Failed to delete note: ' + error.message);
            }
        };

        const trends = calculateTrends();
        const patterns = detectPatterns();

        const noteCategories = [
            { value: 'general', label: 'General', color: '#666' },
            { value: 'progress', label: 'Progress', color: '#00A86B' },
            { value: 'concern', label: 'Concern', color: '#FF6B35' },
            { value: 'goal', label: 'Goal Update', color: '#0077CC' },
            { value: 'session', label: 'Session Note', color: '#9C27B0' }
        ];

        // Sub-tab styles
        const subTabStyle = (isActive) => ({
            padding: '10px 20px',
            background: isActive ? '#0077CC' : 'transparent',
            color: isActive ? 'white' : '#666',
            border: 'none',
            borderRadius: '6px',
            cursor: 'pointer',
            fontSize: '14px',
            fontWeight: '500',
            transition: 'all 0.2s'
        });

        return (
            <div style={{ padding: '24px' }}>
                {/* Sub-tabs */}
                <div style={{
                    display: 'flex',
                    gap: '8px',
                    marginBottom: '24px',
                    background: '#f8f9fa',
                    padding: '6px',
                    borderRadius: '10px',
                    width: 'fit-content'
                }}>
                    {[
                        { id: 'charts', label: 'Charts', icon: 'Activity' },
                        { id: 'trends', label: 'Trends', icon: 'TrendingUp' },
                        { id: 'patterns', label: 'Patterns', icon: 'AlertTriangle' },
                        { id: 'notes', label: 'Coach Notes', icon: 'FileText' }
                    ].map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveSubTab(tab.id)}
                            style={subTabStyle(activeSubTab === tab.id)}
                        >
                            <span style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                {AdminIcons[tab.icon]({ size: 16 })}
                                {tab.label}
                            </span>
                        </button>
                    ))}
                </div>

                {/* Charts Sub-tab */}
                {activeSubTab === 'charts' && (
                    <div>
                        {/* Streak Banner */}
                        {streakData && streakData.checkInStreak > 0 && (
                            <div style={{
                                background: 'linear-gradient(135deg, #FF6B35 0%, #FF8C42 100%)',
                                borderRadius: '12px',
                                padding: '16px 24px',
                                marginBottom: '24px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '16px',
                                color: 'white'
                            }}>
                                {AdminIcons.Flame({ size: 32, color: 'white' })}
                                <div>
                                    <div style={{ fontSize: '24px', fontWeight: '700' }}>
                                        {streakData.checkInStreak} Day Streak
                                    </div>
                                    <div style={{ fontSize: '14px', opacity: 0.9 }}>
                                        Consecutive check-ins completed
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Charts Grid */}
                        {chartData ? (
                            <div style={{
                                display: 'grid',
                                gridTemplateColumns: 'repeat(2, 1fr)',
                                gap: '24px'
                            }}>
                                {/* Mood Chart */}
                                <div style={{
                                    background: 'white',
                                    borderRadius: '12px',
                                    padding: '20px',
                                    boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                                }}>
                                    <div style={{
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center',
                                        marginBottom: '16px'
                                    }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            {AdminIcons.Heart({ size: 20, color: '#00A86B' })}
                                            <span style={{ fontWeight: '600', color: '#333' }}>Mood</span>
                                        </div>
                                        {trends && (
                                            <div style={{
                                                background: '#00A86B20',
                                                color: '#00A86B',
                                                padding: '4px 10px',
                                                borderRadius: '12px',
                                                fontSize: '13px',
                                                fontWeight: '600'
                                            }}>
                                                Avg: {trends.moods.avg7}/10
                                            </div>
                                        )}
                                    </div>
                                    <div style={{ height: '200px' }}>
                                        <canvas ref={moodChartRef} id="moodChart"></canvas>
                                    </div>
                                </div>

                                {/* Craving Chart */}
                                <div style={{
                                    background: 'white',
                                    borderRadius: '12px',
                                    padding: '20px',
                                    boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                                }}>
                                    <div style={{
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center',
                                        marginBottom: '16px'
                                    }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            {AdminIcons.Zap({ size: 20, color: '#FF6B35' })}
                                            <span style={{ fontWeight: '600', color: '#333' }}>Craving</span>
                                        </div>
                                        {trends && (
                                            <div style={{
                                                background: '#FF6B3520',
                                                color: '#FF6B35',
                                                padding: '4px 10px',
                                                borderRadius: '12px',
                                                fontSize: '13px',
                                                fontWeight: '600'
                                            }}>
                                                Avg: {trends.cravings.avg7}/10
                                            </div>
                                        )}
                                    </div>
                                    <div style={{ height: '200px' }}>
                                        <canvas ref={cravingChartRef} id="cravingChart"></canvas>
                                    </div>
                                </div>

                                {/* Anxiety Chart */}
                                <div style={{
                                    background: 'white',
                                    borderRadius: '12px',
                                    padding: '20px',
                                    boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                                }}>
                                    <div style={{
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center',
                                        marginBottom: '16px'
                                    }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            {AdminIcons.Activity({ size: 20, color: '#9C27B0' })}
                                            <span style={{ fontWeight: '600', color: '#333' }}>Anxiety</span>
                                        </div>
                                        {trends && (
                                            <div style={{
                                                background: '#9C27B020',
                                                color: '#9C27B0',
                                                padding: '4px 10px',
                                                borderRadius: '12px',
                                                fontSize: '13px',
                                                fontWeight: '600'
                                            }}>
                                                Avg: {trends.anxiety.avg7}/10
                                            </div>
                                        )}
                                    </div>
                                    <div style={{ height: '200px' }}>
                                        <canvas ref={anxietyChartRef} id="anxietyChart"></canvas>
                                    </div>
                                </div>

                                {/* Sleep Chart */}
                                <div style={{
                                    background: 'white',
                                    borderRadius: '12px',
                                    padding: '20px',
                                    boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                                }}>
                                    <div style={{
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center',
                                        marginBottom: '16px'
                                    }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            {AdminIcons.Moon({ size: 20, color: '#2196F3' })}
                                            <span style={{ fontWeight: '600', color: '#333' }}>Sleep Quality</span>
                                        </div>
                                        {trends && (
                                            <div style={{
                                                background: '#2196F320',
                                                color: '#2196F3',
                                                padding: '4px 10px',
                                                borderRadius: '12px',
                                                fontSize: '13px',
                                                fontWeight: '600'
                                            }}>
                                                Avg: {trends.sleep.avg7}/10
                                            </div>
                                        )}
                                    </div>
                                    <div style={{ height: '200px' }}>
                                        <canvas ref={sleepChartRef} id="sleepChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div style={{
                                background: 'white',
                                borderRadius: '12px',
                                padding: '60px',
                                textAlign: 'center',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                            }}>
                                {AdminIcons.Activity({ size: 48, color: '#ccc' })}
                                <p style={{ color: '#666', marginTop: '16px' }}>
                                    No check-in data available for the past 30 days.
                                </p>
                            </div>
                        )}

                        {/* Recent Check-ins List */}
                        <div style={{
                            background: 'white',
                            borderRadius: '12px',
                            padding: '20px',
                            marginTop: '24px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                        }}>
                            <h3 style={{ margin: '0 0 16px', color: '#333', fontSize: '16px' }}>
                                Recent Check-ins ({checkIns.length})
                            </h3>
                            {checkIns.length > 0 ? (
                                <div style={{ maxHeight: '300px', overflowY: 'auto' }}>
                                    {checkIns.slice(0, 10).map((checkin, index) => {
                                        const mood = checkin.morningData?.mood ?? checkin.mood;
                                        const craving = checkin.morningData?.craving ?? checkin.craving;
                                        const anxiety = checkin.morningData?.anxiety ?? checkin.anxiety;
                                        const sleep = checkin.morningData?.sleep ?? checkin.sleep;
                                        return (
                                            <div key={checkin.id} style={{
                                                padding: '12px 0',
                                                borderBottom: index < 9 ? '1px solid #f0f0f0' : 'none',
                                                display: 'flex',
                                                justifyContent: 'space-between',
                                                alignItems: 'center'
                                            }}>
                                                <div>
                                                    <div style={{ fontWeight: '500', color: '#333', marginBottom: '4px' }}>
                                                        {formatDateTime(checkin.createdAt)}
                                                    </div>
                                                    <div style={{ display: 'flex', gap: '16px', fontSize: '13px', color: '#666' }}>
                                                        <span>Mood: {mood ?? '-'}</span>
                                                        <span>Craving: {craving ?? '-'}</span>
                                                        <span>Anxiety: {anxiety ?? '-'}</span>
                                                        <span>Sleep: {sleep ?? '-'}</span>
                                                    </div>
                                                </div>
                                                <div style={{
                                                    background: checkin.type === 'morning' ? '#FF6B3520' : '#2196F320',
                                                    color: checkin.type === 'morning' ? '#FF6B35' : '#2196F3',
                                                    padding: '4px 10px',
                                                    borderRadius: '12px',
                                                    fontSize: '12px',
                                                    fontWeight: '500'
                                                }}>
                                                    {checkin.type || 'Check-in'}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            ) : (
                                <p style={{ color: '#999', textAlign: 'center', margin: '20px 0' }}>
                                    No check-ins recorded yet.
                                </p>
                            )}
                        </div>
                    </div>
                )}

                {/* Trends Sub-tab */}
                {activeSubTab === 'trends' && (
                    <div>
                        {trends ? (
                            <div style={{
                                display: 'grid',
                                gridTemplateColumns: 'repeat(2, 1fr)',
                                gap: '24px'
                            }}>
                                {[
                                    { key: 'moods', label: 'Mood', icon: 'Heart', color: '#00A86B', goodTrend: 'up' },
                                    { key: 'cravings', label: 'Craving', icon: 'Zap', color: '#FF6B35', goodTrend: 'down' },
                                    { key: 'anxiety', label: 'Anxiety', icon: 'Activity', color: '#9C27B0', goodTrend: 'down' },
                                    { key: 'sleep', label: 'Sleep', icon: 'Moon', color: '#2196F3', goodTrend: 'up' }
                                ].map(metric => {
                                    const data = trends[metric.key];
                                    const isGood = (metric.goodTrend === 'up' && data.trend === 'up') ||
                                                   (metric.goodTrend === 'down' && data.trend === 'down') ||
                                                   data.trend === 'stable';
                                    const trendColor = data.trend === 'stable' ? '#666' : isGood ? '#00A86B' : '#DC143C';

                                    return (
                                        <div key={metric.key} style={{
                                            background: 'white',
                                            borderRadius: '12px',
                                            padding: '24px',
                                            boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                                        }}>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '20px' }}>
                                                <div style={{
                                                    width: '48px',
                                                    height: '48px',
                                                    borderRadius: '12px',
                                                    background: metric.color + '15',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center'
                                                }}>
                                                    {AdminIcons[metric.icon]({ size: 24, color: metric.color })}
                                                </div>
                                                <div>
                                                    <div style={{ fontSize: '18px', fontWeight: '600', color: '#333' }}>
                                                        {metric.label}
                                                    </div>
                                                    <div style={{ fontSize: '13px', color: '#999' }}>
                                                        30-day trend analysis
                                                    </div>
                                                </div>
                                            </div>

                                            <div style={{
                                                display: 'grid',
                                                gridTemplateColumns: '1fr 1fr 1fr',
                                                gap: '16px'
                                            }}>
                                                <div style={{ textAlign: 'center' }}>
                                                    <div style={{ fontSize: '28px', fontWeight: '700', color: '#333' }}>
                                                        {data.avg7}
                                                    </div>
                                                    <div style={{ fontSize: '12px', color: '#999' }}>7-Day Avg</div>
                                                </div>
                                                <div style={{ textAlign: 'center' }}>
                                                    <div style={{ fontSize: '28px', fontWeight: '700', color: '#666' }}>
                                                        {data.avg30}
                                                    </div>
                                                    <div style={{ fontSize: '12px', color: '#999' }}>30-Day Avg</div>
                                                </div>
                                                <div style={{ textAlign: 'center' }}>
                                                    <div style={{
                                                        fontSize: '28px',
                                                        fontWeight: '700',
                                                        color: trendColor,
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        justifyContent: 'center',
                                                        gap: '4px'
                                                    }}>
                                                        {data.trend === 'up' && AdminIcons.TrendingUp({ size: 24, color: trendColor })}
                                                        {data.trend === 'down' && AdminIcons.TrendingDown({ size: 24, color: trendColor })}
                                                        {data.trend === 'stable' && ''}
                                                        {data.trend !== 'stable' && (data.change > 0 ? '+' : '') + data.change}
                                                    </div>
                                                    <div style={{ fontSize: '12px', color: '#999' }}>Change</div>
                                                </div>
                                            </div>

                                            <div style={{
                                                marginTop: '16px',
                                                padding: '12px',
                                                background: isGood ? '#00A86B10' : '#DC143C10',
                                                borderRadius: '8px',
                                                textAlign: 'center',
                                                color: isGood ? '#00A86B' : '#DC143C',
                                                fontSize: '13px',
                                                fontWeight: '500'
                                            }}>
                                                {data.trend === 'stable' ? 'Stable - no significant change' :
                                                 isGood ? 'Positive trend - keep it up!' :
                                                 'Needs attention - review with PIR'}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        ) : (
                            <div style={{
                                background: 'white',
                                borderRadius: '12px',
                                padding: '60px',
                                textAlign: 'center',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                            }}>
                                {AdminIcons.TrendingUp({ size: 48, color: '#ccc' })}
                                <p style={{ color: '#666', marginTop: '16px' }}>
                                    Not enough data for trend analysis. Need at least one week of check-ins.
                                </p>
                            </div>
                        )}
                    </div>
                )}

                {/* Patterns Sub-tab */}
                {activeSubTab === 'patterns' && (
                    <div>
                        {patterns.length > 0 ? (
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                {patterns.map((pattern, index) => (
                                    <div key={index} style={{
                                        background: 'white',
                                        borderRadius: '12px',
                                        padding: '20px',
                                        boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                                        borderLeft: `4px solid ${pattern.type === 'positive' ? '#00A86B' : pattern.severity === 'high' ? '#DC143C' : '#FF6B35'}`
                                    }}>
                                        <div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>
                                            <div style={{
                                                width: '48px',
                                                height: '48px',
                                                borderRadius: '12px',
                                                background: pattern.type === 'positive' ? '#00A86B15' : pattern.severity === 'high' ? '#DC143C15' : '#FF6B3515',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                flexShrink: 0
                                            }}>
                                                {pattern.type === 'positive' ?
                                                    AdminIcons.Check({ size: 24, color: '#00A86B' }) :
                                                    AdminIcons.AlertTriangle({ size: 24, color: pattern.severity === 'high' ? '#DC143C' : '#FF6B35' })
                                                }
                                            </div>
                                            <div style={{ flex: 1 }}>
                                                <div style={{
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'center',
                                                    marginBottom: '8px'
                                                }}>
                                                    <h3 style={{ margin: 0, color: '#333', fontSize: '16px' }}>
                                                        {pattern.title}
                                                    </h3>
                                                    <span style={{
                                                        padding: '4px 10px',
                                                        borderRadius: '12px',
                                                        fontSize: '11px',
                                                        fontWeight: '600',
                                                        textTransform: 'uppercase',
                                                        background: pattern.type === 'positive' ? '#00A86B20' : pattern.severity === 'high' ? '#DC143C20' : '#FF6B3520',
                                                        color: pattern.type === 'positive' ? '#00A86B' : pattern.severity === 'high' ? '#DC143C' : '#FF6B35'
                                                    }}>
                                                        {pattern.type === 'positive' ? 'Positive' : pattern.severity}
                                                    </span>
                                                </div>
                                                <p style={{ margin: 0, color: '#666', fontSize: '14px', lineHeight: '1.5' }}>
                                                    {pattern.message}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div style={{
                                background: 'white',
                                borderRadius: '12px',
                                padding: '60px',
                                textAlign: 'center',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                            }}>
                                {AdminIcons.Check({ size: 48, color: '#00A86B' })}
                                <h3 style={{ color: '#333', margin: '16px 0 8px' }}>No Concerning Patterns</h3>
                                <p style={{ color: '#666', margin: 0 }}>
                                    All wellness metrics are within healthy ranges. Keep up the great work!
                                </p>
                            </div>
                        )}
                    </div>
                )}

                {/* Coach Notes Sub-tab */}
                {activeSubTab === 'notes' && (
                    <div>
                        {/* Add Note Button */}
                        <div style={{ marginBottom: '20px' }}>
                            <button
                                onClick={() => { setShowAddNote(true); setEditingNote(null); setNoteText(''); setNoteCategory('general'); }}
                                style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px',
                                    padding: '12px 20px',
                                    background: '#0077CC',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500'
                                }}
                            >
                                {AdminIcons.Plus({ size: 18 })}
                                Add Coach Note
                            </button>
                        </div>

                        {/* Add/Edit Note Form */}
                        {(showAddNote || editingNote) && (
                            <div style={{
                                background: 'white',
                                borderRadius: '12px',
                                padding: '20px',
                                marginBottom: '20px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                            }}>
                                <h4 style={{ margin: '0 0 16px', color: '#333' }}>
                                    {editingNote ? 'Edit Note' : 'New Coach Note'}
                                </h4>
                                <div style={{ marginBottom: '16px' }}>
                                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', color: '#666' }}>
                                        Category
                                    </label>
                                    <select
                                        value={noteCategory}
                                        onChange={(e) => setNoteCategory(e.target.value)}
                                        style={{
                                            width: '100%',
                                            padding: '10px 12px',
                                            border: '1px solid #e0e0e0',
                                            borderRadius: '8px',
                                            fontSize: '14px'
                                        }}
                                    >
                                        {noteCategories.map(cat => (
                                            <option key={cat.value} value={cat.value}>{cat.label}</option>
                                        ))}
                                    </select>
                                </div>
                                <div style={{ marginBottom: '16px' }}>
                                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', color: '#666' }}>
                                        Note
                                    </label>
                                    <textarea
                                        value={noteText}
                                        onChange={(e) => setNoteText(e.target.value)}
                                        placeholder="Enter your note about this PIR..."
                                        style={{
                                            width: '100%',
                                            padding: '12px',
                                            border: '1px solid #e0e0e0',
                                            borderRadius: '8px',
                                            fontSize: '14px',
                                            minHeight: '120px',
                                            resize: 'vertical',
                                            boxSizing: 'border-box'
                                        }}
                                    />
                                </div>
                                <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                                    <button
                                        onClick={() => { setShowAddNote(false); setEditingNote(null); setNoteText(''); }}
                                        style={{
                                            padding: '10px 20px',
                                            background: '#f5f5f5',
                                            color: '#666',
                                            border: 'none',
                                            borderRadius: '8px',
                                            cursor: 'pointer',
                                            fontSize: '14px'
                                        }}
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={handleSaveNote}
                                        disabled={saving || !noteText.trim()}
                                        style={{
                                            padding: '10px 20px',
                                            background: saving ? '#ccc' : '#0077CC',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '8px',
                                            cursor: saving ? 'not-allowed' : 'pointer',
                                            fontSize: '14px',
                                            fontWeight: '500'
                                        }}
                                    >
                                        {saving ? 'Saving...' : editingNote ? 'Update Note' : 'Save Note'}
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Notes List */}
                        {loadingNotes ? (
                            <div style={{ textAlign: 'center', padding: '40px' }}>
                                <div style={{
                                    width: '40px',
                                    height: '40px',
                                    border: '4px solid #e0e0e0',
                                    borderTop: '4px solid #0077CC',
                                    borderRadius: '50%',
                                    animation: 'spin 1s linear infinite',
                                    margin: '0 auto'
                                }}></div>
                            </div>
                        ) : coachNotes.length > 0 ? (
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                {coachNotes.map(note => {
                                    const category = noteCategories.find(c => c.value === note.category) || noteCategories[0];
                                    const noteDate = note.createdAt?.toDate ? note.createdAt.toDate() : new Date(note.createdAt);
                                    return (
                                        <div key={note.id} style={{
                                            background: 'white',
                                            borderRadius: '12px',
                                            padding: '20px',
                                            boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                                        }}>
                                            <div style={{
                                                display: 'flex',
                                                justifyContent: 'space-between',
                                                alignItems: 'flex-start',
                                                marginBottom: '12px'
                                            }}>
                                                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                                    <span style={{
                                                        padding: '4px 10px',
                                                        borderRadius: '12px',
                                                        fontSize: '12px',
                                                        fontWeight: '500',
                                                        background: category.color + '20',
                                                        color: category.color
                                                    }}>
                                                        {category.label}
                                                    </span>
                                                    <span style={{ fontSize: '13px', color: '#999' }}>
                                                        {noteDate.toLocaleDateString('en-US', {
                                                            month: 'short', day: 'numeric', year: 'numeric',
                                                            hour: 'numeric', minute: '2-digit'
                                                        })}
                                                    </span>
                                                </div>
                                                <div style={{ display: 'flex', gap: '8px' }}>
                                                    <button
                                                        onClick={() => {
                                                            setEditingNote(note);
                                                            setNoteText(note.text);
                                                            setNoteCategory(note.category || 'general');
                                                            setShowAddNote(false);
                                                        }}
                                                        style={{
                                                            background: 'transparent',
                                                            border: 'none',
                                                            cursor: 'pointer',
                                                            padding: '4px'
                                                        }}
                                                        title="Edit note"
                                                    >
                                                        {AdminIcons.Edit({ size: 16, color: '#666' })}
                                                    </button>
                                                    <button
                                                        onClick={() => handleDeleteNote(note.id)}
                                                        style={{
                                                            background: 'transparent',
                                                            border: 'none',
                                                            cursor: 'pointer',
                                                            padding: '4px'
                                                        }}
                                                        title="Delete note"
                                                    >
                                                        {AdminIcons.Trash2({ size: 16, color: '#DC143C' })}
                                                    </button>
                                                </div>
                                            </div>
                                            <p style={{ margin: 0, color: '#333', lineHeight: '1.6', whiteSpace: 'pre-wrap' }}>
                                                {note.text}
                                            </p>
                                            {note.coachName && (
                                                <div style={{
                                                    marginTop: '12px',
                                                    paddingTop: '12px',
                                                    borderTop: '1px solid #f0f0f0',
                                                    fontSize: '13px',
                                                    color: '#999'
                                                }}>
                                                    Added by: {note.coachName}
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        ) : (
                            <div style={{
                                background: 'white',
                                borderRadius: '12px',
                                padding: '60px',
                                textAlign: 'center',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                            }}>
                                {AdminIcons.FileText({ size: 48, color: '#ccc' })}
                                <h3 style={{ color: '#333', margin: '16px 0 8px' }}>No Coach Notes Yet</h3>
                                <p style={{ color: '#666', margin: 0 }}>
                                    Add your first note to track observations and progress.
                                </p>
                            </div>
                        )}
                    </div>
                )}
            </div>
        );
    }

    // ==========================================
    // PLACEHOLDER TAB COMPONENTS
    // (To be implemented in Phase 4-5)
    // ==========================================

    function TasksTab({
        assignments, setAssignments,
        goals, setGoals,
        objectives, setObjectives,
        checkIns, journeyData,
        pirId, currentUser,
        formatDate, formatDateTime, formatTimeAgo
    }) {
        const [activeSubTab, setActiveSubTab] = useState('assignments');
        const [statusFilter, setStatusFilter] = useState('all');
        const [showCreateModal, setShowCreateModal] = useState(false);
        const [showEditModal, setShowEditModal] = useState(false);
        const [editingItem, setEditingItem] = useState(null);
        const [createType, setCreateType] = useState('assignment'); // assignment, goal, objective
        const [saving, setSaving] = useState(false);
        const [expandedGoals, setExpandedGoals] = useState({});
        const [expandedObjectives, setExpandedObjectives] = useState({});

        // Form data for create/edit
        const [formData, setFormData] = useState({
            title: '',
            description: '',
            category: 'general',
            priority: 'medium',
            status: 'pending',
            dueDate: '',
            goalId: '',
            objectiveId: ''
        });

        const categories = [
            { value: 'general', label: 'General' },
            { value: 'wellness', label: 'Wellness' },
            { value: 'therapy', label: 'Therapy' },
            { value: 'medication', label: 'Medication' },
            { value: 'lifestyle', label: 'Lifestyle' },
            { value: 'social', label: 'Social' },
            { value: 'financial', label: 'Financial' },
            { value: 'vocational', label: 'Vocational' }
        ];

        const priorities = [
            { value: 'low', label: 'Low', color: '#00A86B' },
            { value: 'medium', label: 'Medium', color: '#FFA500' },
            { value: 'high', label: 'High', color: '#DC143C' }
        ];

        const statuses = [
            { value: 'pending', label: 'Pending', color: '#999' },
            { value: 'in_progress', label: 'In Progress', color: '#0077CC' },
            { value: 'completed', label: 'Completed', color: '#00A86B' },
            { value: 'overdue', label: 'Overdue', color: '#DC143C' }
        ];

        // Check for overdue assignments
        const enrichedAssignments = assignments.map(a => {
            if (a.status !== 'completed' && a.dueDate) {
                const dueDate = a.dueDate?.toDate ? a.dueDate.toDate() : new Date(a.dueDate);
                if (dueDate < new Date()) {
                    return { ...a, status: 'overdue' };
                }
            }
            return a;
        });

        // Filter assignments
        const filteredAssignments = statusFilter === 'all'
            ? enrichedAssignments
            : enrichedAssignments.filter(a => a.status === statusFilter);

        // Stats
        const stats = {
            total: enrichedAssignments.length,
            pending: enrichedAssignments.filter(a => a.status === 'pending').length,
            inProgress: enrichedAssignments.filter(a => a.status === 'in_progress').length,
            completed: enrichedAssignments.filter(a => a.status === 'completed').length,
            overdue: enrichedAssignments.filter(a => a.status === 'overdue').length
        };

        // CRUD Operations
        const handleCreate = async () => {
            try {
                setSaving(true);
                const docRef = await db.collection(createType === 'goal' ? 'goals' : createType === 'objective' ? 'objectives' : 'assignments').add({
                    ...formData,
                    userId: pirId,
                    createdBy: currentUser.id,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                const newItem = { id: docRef.id, ...formData, createdAt: new Date() };

                if (createType === 'assignment') {
                    setAssignments([newItem, ...assignments]);
                } else if (createType === 'goal') {
                    setGoals([newItem, ...goals]);
                } else {
                    setObjectives([newItem, ...objectives]);
                }

                setShowCreateModal(false);
                setFormData({ title: '', description: '', category: 'general', priority: 'medium', status: 'pending', dueDate: '', goalId: '', objectiveId: '' });
            } catch (error) {
                console.error('Error creating item:', error);
                alert('Failed to create: ' + error.message);
            } finally {
                setSaving(false);
            }
        };

        const handleUpdate = async () => {
            try {
                setSaving(true);
                const collection = editingItem.type === 'goal' ? 'goals' : editingItem.type === 'objective' ? 'objectives' : 'assignments';
                await db.collection(collection).doc(editingItem.id).update({
                    ...formData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                if (editingItem.type === 'assignment') {
                    setAssignments(assignments.map(a => a.id === editingItem.id ? { ...a, ...formData } : a));
                } else if (editingItem.type === 'goal') {
                    setGoals(goals.map(g => g.id === editingItem.id ? { ...g, ...formData } : g));
                } else {
                    setObjectives(objectives.map(o => o.id === editingItem.id ? { ...o, ...formData } : o));
                }

                setShowEditModal(false);
                setEditingItem(null);
            } catch (error) {
                console.error('Error updating item:', error);
                alert('Failed to update: ' + error.message);
            } finally {
                setSaving(false);
            }
        };

        const handleDelete = async (item, type) => {
            if (!confirm(`Are you sure you want to delete this ${type}?`)) return;
            try {
                const collection = type === 'goal' ? 'goals' : type === 'objective' ? 'objectives' : 'assignments';
                await db.collection(collection).doc(item.id).delete();

                if (type === 'assignment') {
                    setAssignments(assignments.filter(a => a.id !== item.id));
                } else if (type === 'goal') {
                    setGoals(goals.filter(g => g.id !== item.id));
                } else {
                    setObjectives(objectives.filter(o => o.id !== item.id));
                }
            } catch (error) {
                console.error('Error deleting item:', error);
                alert('Failed to delete: ' + error.message);
            }
        };

        const handleStatusChange = async (assignment, newStatus) => {
            try {
                await db.collection('assignments').doc(assignment.id).update({
                    status: newStatus,
                    completedAt: newStatus === 'completed' ? firebase.firestore.FieldValue.serverTimestamp() : null,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                setAssignments(assignments.map(a => a.id === assignment.id ? { ...a, status: newStatus } : a));
            } catch (error) {
                console.error('Error updating status:', error);
            }
        };

        const openEditModal = (item, type) => {
            setEditingItem({ ...item, type });
            setFormData({
                title: item.title || '',
                description: item.description || '',
                category: item.category || 'general',
                priority: item.priority || 'medium',
                status: item.status || 'pending',
                dueDate: item.dueDate ? (item.dueDate?.toDate ? item.dueDate.toDate().toISOString().split('T')[0] : new Date(item.dueDate).toISOString().split('T')[0]) : '',
                goalId: item.goalId || '',
                objectiveId: item.objectiveId || ''
            });
            setShowEditModal(true);
        };

        const openCreateModal = (type, parentGoalId = '', parentObjectiveId = '') => {
            setCreateType(type);
            setFormData({
                title: '',
                description: '',
                category: 'general',
                priority: 'medium',
                status: 'pending',
                dueDate: '',
                goalId: parentGoalId,
                objectiveId: parentObjectiveId
            });
            setShowCreateModal(true);
        };

        const toggleGoalExpand = (goalId) => {
            setExpandedGoals(prev => ({ ...prev, [goalId]: !prev[goalId] }));
        };

        const toggleObjectiveExpand = (objectiveId) => {
            setExpandedObjectives(prev => ({ ...prev, [objectiveId]: !prev[objectiveId] }));
        };

        // Get objectives for a goal
        const getObjectivesForGoal = (goalId) => objectives.filter(o => o.goalId === goalId);

        // Get assignments for an objective
        const getAssignmentsForObjective = (objectiveId) => assignments.filter(a => a.objectiveId === objectiveId);

        // Render sub-tabs
        const subTabs = [
            { id: 'assignments', label: 'Assignments', icon: AdminIcons.CheckSquare, count: stats.total },
            { id: 'goals', label: 'Golden Thread', icon: AdminIcons.Target, count: goals.length },
            { id: 'checkins', label: 'Check-ins', icon: AdminIcons.ClipboardCheck, count: checkIns.length },
            { id: 'reflections', label: 'Reflections', icon: AdminIcons.Heart, count: (journeyData.gratitudes?.length || 0) + (journeyData.reflections?.length || 0) }
        ];

        return (
            <div style={{ padding: '30px' }}>
                {/* Sub-tab Navigation */}
                <div style={{
                    display: 'flex',
                    gap: '8px',
                    marginBottom: '24px',
                    background: 'white',
                    padding: '8px',
                    borderRadius: '12px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                }}>
                    {subTabs.map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveSubTab(tab.id)}
                            style={{
                                flex: 1,
                                padding: '12px 16px',
                                background: activeSubTab === tab.id ? '#0077CC' : 'transparent',
                                color: activeSubTab === tab.id ? 'white' : '#666',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '8px',
                                fontWeight: activeSubTab === tab.id ? '600' : '500',
                                transition: 'all 0.2s'
                            }}
                        >
                            {tab.icon({ size: 18, color: activeSubTab === tab.id ? 'white' : '#666' })}
                            {tab.label}
                            <span style={{
                                background: activeSubTab === tab.id ? 'rgba(255,255,255,0.2)' : '#e0e0e0',
                                padding: '2px 8px',
                                borderRadius: '10px',
                                fontSize: '12px'
                            }}>
                                {tab.count}
                            </span>
                        </button>
                    ))}
                </div>

                {/* ASSIGNMENTS SUB-TAB */}
                {activeSubTab === 'assignments' && (
                    <div>
                        {/* Filter and Actions Bar */}
                        <div style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            marginBottom: '20px',
                            flexWrap: 'wrap',
                            gap: '12px'
                        }}>
                            {/* Status Filters */}
                            <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                                {[
                                    { id: 'all', label: 'All', count: stats.total },
                                    { id: 'pending', label: 'Pending', count: stats.pending, color: '#999' },
                                    { id: 'in_progress', label: 'In Progress', count: stats.inProgress, color: '#0077CC' },
                                    { id: 'completed', label: 'Completed', count: stats.completed, color: '#00A86B' },
                                    { id: 'overdue', label: 'Overdue', count: stats.overdue, color: '#DC143C' }
                                ].map(filter => (
                                    <button
                                        key={filter.id}
                                        onClick={() => setStatusFilter(filter.id)}
                                        style={{
                                            padding: '8px 16px',
                                            background: statusFilter === filter.id ? (filter.color || '#0077CC') : 'white',
                                            color: statusFilter === filter.id ? 'white' : '#666',
                                            border: `1px solid ${filter.color || '#e0e0e0'}`,
                                            borderRadius: '20px',
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            fontWeight: '500',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '6px'
                                        }}
                                    >
                                        {filter.label}
                                        <span style={{
                                            background: statusFilter === filter.id ? 'rgba(255,255,255,0.2)' : '#f0f0f0',
                                            padding: '2px 6px',
                                            borderRadius: '8px',
                                            fontSize: '11px'
                                        }}>
                                            {filter.count}
                                        </span>
                                    </button>
                                ))}
                            </div>

                            {/* Create Button */}
                            <button
                                onClick={() => openCreateModal('assignment')}
                                style={{
                                    padding: '10px 20px',
                                    background: 'linear-gradient(135deg, #0077CC 0%, #005A9C 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontWeight: '600',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px'
                                }}
                            >
                                {AdminIcons.Plus({ size: 18, color: 'white' })}
                                Create Assignment
                            </button>
                        </div>

                        {/* Assignments List */}
                        <div style={{
                            background: 'white',
                            borderRadius: '12px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                            overflow: 'hidden'
                        }}>
                            {filteredAssignments.length > 0 ? (
                                filteredAssignments.map((assignment, i) => {
                                    const statusInfo = statuses.find(s => s.value === assignment.status) || statuses[0];
                                    const priorityInfo = priorities.find(p => p.value === assignment.priority) || priorities[1];
                                    return (
                                        <div
                                            key={assignment.id}
                                            style={{
                                                padding: '20px 24px',
                                                borderBottom: i < filteredAssignments.length - 1 ? '1px solid #f0f0f0' : 'none',
                                                display: 'flex',
                                                alignItems: 'flex-start',
                                                gap: '16px'
                                            }}
                                        >
                                            {/* Status Checkbox */}
                                            <div
                                                onClick={() => handleStatusChange(assignment, assignment.status === 'completed' ? 'pending' : 'completed')}
                                                style={{
                                                    width: '24px',
                                                    height: '24px',
                                                    borderRadius: '6px',
                                                    border: `2px solid ${statusInfo.color}`,
                                                    background: assignment.status === 'completed' ? statusInfo.color : 'transparent',
                                                    cursor: 'pointer',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    flexShrink: 0,
                                                    marginTop: '2px'
                                                }}
                                            >
                                                {assignment.status === 'completed' && AdminIcons.Check({ size: 14, color: 'white' })}
                                            </div>

                                            {/* Assignment Content */}
                                            <div style={{ flex: 1 }}>
                                                <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '6px' }}>
                                                    <span style={{
                                                        fontWeight: '600',
                                                        color: assignment.status === 'completed' ? '#999' : '#333',
                                                        textDecoration: assignment.status === 'completed' ? 'line-through' : 'none',
                                                        fontSize: '15px'
                                                    }}>
                                                        {assignment.title}
                                                    </span>
                                                    <span style={{
                                                        padding: '3px 8px',
                                                        background: priorityInfo.color + '15',
                                                        color: priorityInfo.color,
                                                        borderRadius: '4px',
                                                        fontSize: '11px',
                                                        fontWeight: '600',
                                                        textTransform: 'uppercase'
                                                    }}>
                                                        {priorityInfo.label}
                                                    </span>
                                                    <span style={{
                                                        padding: '3px 8px',
                                                        background: statusInfo.color + '15',
                                                        color: statusInfo.color,
                                                        borderRadius: '4px',
                                                        fontSize: '11px',
                                                        fontWeight: '600'
                                                    }}>
                                                        {statusInfo.label}
                                                    </span>
                                                </div>
                                                {assignment.description && (
                                                    <p style={{ margin: '0 0 8px', color: '#666', fontSize: '14px' }}>
                                                        {assignment.description}
                                                    </p>
                                                )}
                                                <div style={{ display: 'flex', gap: '16px', fontSize: '12px', color: '#999' }}>
                                                    {assignment.category && (
                                                        <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                                            {AdminIcons.Tag({ size: 12 })} {categories.find(c => c.value === assignment.category)?.label || assignment.category}
                                                        </span>
                                                    )}
                                                    {assignment.dueDate && (
                                                        <span style={{
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            gap: '4px',
                                                            color: assignment.status === 'overdue' ? '#DC143C' : '#999'
                                                        }}>
                                                            {AdminIcons.Calendar({ size: 12 })} Due: {formatDate(assignment.dueDate)}
                                                        </span>
                                                    )}
                                                    <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                                        {AdminIcons.Clock({ size: 12 })} {formatTimeAgo(assignment.createdAt)}
                                                    </span>
                                                </div>
                                            </div>

                                            {/* Actions */}
                                            <div style={{ display: 'flex', gap: '8px' }}>
                                                <button
                                                    onClick={() => openEditModal(assignment, 'assignment')}
                                                    style={{
                                                        padding: '8px',
                                                        background: '#f5f7fa',
                                                        border: 'none',
                                                        borderRadius: '6px',
                                                        cursor: 'pointer'
                                                    }}
                                                    title="Edit"
                                                >
                                                    {AdminIcons.Edit({ size: 16, color: '#666' })}
                                                </button>
                                                <button
                                                    onClick={() => handleDelete(assignment, 'assignment')}
                                                    style={{
                                                        padding: '8px',
                                                        background: '#fff5f5',
                                                        border: 'none',
                                                        borderRadius: '6px',
                                                        cursor: 'pointer'
                                                    }}
                                                    title="Delete"
                                                >
                                                    {AdminIcons.Trash2({ size: 16, color: '#DC143C' })}
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })
                            ) : (
                                <div style={{ textAlign: 'center', padding: '60px', color: '#666' }}>
                                    {AdminIcons.Inbox({ size: 48, color: '#ccc' })}
                                    <div style={{ marginTop: '12px' }}>No assignments found</div>
                                    <button
                                        onClick={() => openCreateModal('assignment')}
                                        style={{
                                            marginTop: '16px',
                                            padding: '10px 20px',
                                            background: '#0077CC',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '8px',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        Create First Assignment
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                )}

                {/* GOLDEN THREAD (GOALS) SUB-TAB */}
                {activeSubTab === 'goals' && (
                    <div>
                        {/* Header */}
                        <div style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            marginBottom: '20px'
                        }}>
                            <div>
                                <h3 style={{ margin: 0, color: '#333' }}>Golden Thread Hierarchy</h3>
                                <p style={{ margin: '4px 0 0', color: '#666', fontSize: '14px' }}>
                                    Goals  Objectives  Assignments
                                </p>
                            </div>
                            <button
                                onClick={() => openCreateModal('goal')}
                                style={{
                                    padding: '10px 20px',
                                    background: 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontWeight: '600',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px'
                                }}
                            >
                                {AdminIcons.Plus({ size: 18, color: 'white' })}
                                Create Goal
                            </button>
                        </div>

                        {/* Goals Hierarchy */}
                        <div style={{
                            background: 'white',
                            borderRadius: '12px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                            overflow: 'hidden'
                        }}>
                            {goals.length > 0 ? (
                                goals.map((goal, gi) => {
                                    const goalObjectives = getObjectivesForGoal(goal.id);
                                    const isExpanded = expandedGoals[goal.id] !== false;
                                    return (
                                        <div key={goal.id} style={{ borderBottom: gi < goals.length - 1 ? '1px solid #f0f0f0' : 'none' }}>
                                            {/* Goal Header */}
                                            <div
                                                style={{
                                                    padding: '20px 24px',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '12px',
                                                    background: '#fafbfc',
                                                    cursor: 'pointer'
                                                }}
                                                onClick={() => toggleGoalExpand(goal.id)}
                                            >
                                                <div style={{
                                                    transform: isExpanded ? 'rotate(90deg)' : 'rotate(0deg)',
                                                    transition: 'transform 0.2s'
                                                }}>
                                                    {AdminIcons.ChevronRight({ size: 20, color: '#666' })}
                                                </div>
                                                <div style={{
                                                    width: '40px',
                                                    height: '40px',
                                                    borderRadius: '10px',
                                                    background: 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center'
                                                }}>
                                                    {AdminIcons.Target({ size: 20, color: 'white' })}
                                                </div>
                                                <div style={{ flex: 1 }}>
                                                    <div style={{ fontWeight: '600', color: '#333', fontSize: '16px' }}>
                                                        {goal.title}
                                                    </div>
                                                    <div style={{ fontSize: '13px', color: '#666' }}>
                                                        {goalObjectives.length} objective{goalObjectives.length !== 1 ? 's' : ''}
                                                    </div>
                                                </div>
                                                <div style={{ display: 'flex', gap: '8px' }} onClick={e => e.stopPropagation()}>
                                                    <button
                                                        onClick={() => openCreateModal('objective', goal.id)}
                                                        style={{
                                                            padding: '6px 12px',
                                                            background: '#e8f4fd',
                                                            color: '#0077CC',
                                                            border: 'none',
                                                            borderRadius: '6px',
                                                            cursor: 'pointer',
                                                            fontSize: '12px',
                                                            fontWeight: '500'
                                                        }}
                                                    >
                                                        + Objective
                                                    </button>
                                                    <button
                                                        onClick={() => openEditModal(goal, 'goal')}
                                                        style={{
                                                            padding: '6px',
                                                            background: '#f5f7fa',
                                                            border: 'none',
                                                            borderRadius: '6px',
                                                            cursor: 'pointer'
                                                        }}
                                                    >
                                                        {AdminIcons.Edit({ size: 14, color: '#666' })}
                                                    </button>
                                                    <button
                                                        onClick={() => handleDelete(goal, 'goal')}
                                                        style={{
                                                            padding: '6px',
                                                            background: '#fff5f5',
                                                            border: 'none',
                                                            borderRadius: '6px',
                                                            cursor: 'pointer'
                                                        }}
                                                    >
                                                        {AdminIcons.Trash2({ size: 14, color: '#DC143C' })}
                                                    </button>
                                                </div>
                                            </div>

                                            {/* Objectives */}
                                            {isExpanded && goalObjectives.map((objective, oi) => {
                                                const objAssignments = getAssignmentsForObjective(objective.id);
                                                const isObjExpanded = expandedObjectives[objective.id] !== false;
                                                return (
                                                    <div key={objective.id} style={{ marginLeft: '40px' }}>
                                                        {/* Objective Header */}
                                                        <div
                                                            style={{
                                                                padding: '16px 24px',
                                                                display: 'flex',
                                                                alignItems: 'center',
                                                                gap: '12px',
                                                                borderTop: '1px solid #f0f0f0',
                                                                cursor: 'pointer'
                                                            }}
                                                            onClick={() => toggleObjectiveExpand(objective.id)}
                                                        >
                                                            <div style={{
                                                                transform: isObjExpanded ? 'rotate(90deg)' : 'rotate(0deg)',
                                                                transition: 'transform 0.2s'
                                                            }}>
                                                                {AdminIcons.ChevronRight({ size: 18, color: '#999' })}
                                                            </div>
                                                            <div style={{
                                                                width: '32px',
                                                                height: '32px',
                                                                borderRadius: '8px',
                                                                background: 'linear-gradient(135deg, #0077CC 0%, #005A9C 100%)',
                                                                display: 'flex',
                                                                alignItems: 'center',
                                                                justifyContent: 'center'
                                                            }}>
                                                                {AdminIcons.Flag({ size: 16, color: 'white' })}
                                                            </div>
                                                            <div style={{ flex: 1 }}>
                                                                <div style={{ fontWeight: '500', color: '#333' }}>
                                                                    {objective.title}
                                                                </div>
                                                                <div style={{ fontSize: '12px', color: '#999' }}>
                                                                    {objAssignments.length} assignment{objAssignments.length !== 1 ? 's' : ''}
                                                                </div>
                                                            </div>
                                                            <div style={{ display: 'flex', gap: '8px' }} onClick={e => e.stopPropagation()}>
                                                                <button
                                                                    onClick={() => openCreateModal('assignment', goal.id, objective.id)}
                                                                    style={{
                                                                        padding: '5px 10px',
                                                                        background: '#e8f9f0',
                                                                        color: '#00A86B',
                                                                        border: 'none',
                                                                        borderRadius: '6px',
                                                                        cursor: 'pointer',
                                                                        fontSize: '11px',
                                                                        fontWeight: '500'
                                                                    }}
                                                                >
                                                                    + Task
                                                                </button>
                                                                <button
                                                                    onClick={() => openEditModal(objective, 'objective')}
                                                                    style={{
                                                                        padding: '5px',
                                                                        background: '#f5f7fa',
                                                                        border: 'none',
                                                                        borderRadius: '5px',
                                                                        cursor: 'pointer'
                                                                    }}
                                                                >
                                                                    {AdminIcons.Edit({ size: 12, color: '#666' })}
                                                                </button>
                                                                <button
                                                                    onClick={() => handleDelete(objective, 'objective')}
                                                                    style={{
                                                                        padding: '5px',
                                                                        background: '#fff5f5',
                                                                        border: 'none',
                                                                        borderRadius: '5px',
                                                                        cursor: 'pointer'
                                                                    }}
                                                                >
                                                                    {AdminIcons.Trash2({ size: 12, color: '#DC143C' })}
                                                                </button>
                                                            </div>
                                                        </div>

                                                        {/* Assignments under objective */}
                                                        {isObjExpanded && objAssignments.map((assignment, ai) => {
                                                            const statusInfo = statuses.find(s => s.value === assignment.status) || statuses[0];
                                                            return (
                                                                <div
                                                                    key={assignment.id}
                                                                    style={{
                                                                        padding: '12px 24px',
                                                                        marginLeft: '40px',
                                                                        borderTop: '1px solid #f5f5f5',
                                                                        display: 'flex',
                                                                        alignItems: 'center',
                                                                        gap: '12px',
                                                                        background: '#fafbfc'
                                                                    }}
                                                                >
                                                                    <div
                                                                        onClick={() => handleStatusChange(assignment, assignment.status === 'completed' ? 'pending' : 'completed')}
                                                                        style={{
                                                                            width: '20px',
                                                                            height: '20px',
                                                                            borderRadius: '4px',
                                                                            border: `2px solid ${statusInfo.color}`,
                                                                            background: assignment.status === 'completed' ? statusInfo.color : 'transparent',
                                                                            cursor: 'pointer',
                                                                            display: 'flex',
                                                                            alignItems: 'center',
                                                                            justifyContent: 'center'
                                                                        }}
                                                                    >
                                                                        {assignment.status === 'completed' && AdminIcons.Check({ size: 12, color: 'white' })}
                                                                    </div>
                                                                    <span style={{
                                                                        flex: 1,
                                                                        color: assignment.status === 'completed' ? '#999' : '#333',
                                                                        textDecoration: assignment.status === 'completed' ? 'line-through' : 'none',
                                                                        fontSize: '14px'
                                                                    }}>
                                                                        {assignment.title}
                                                                    </span>
                                                                    <span style={{
                                                                        padding: '2px 6px',
                                                                        background: statusInfo.color + '15',
                                                                        color: statusInfo.color,
                                                                        borderRadius: '4px',
                                                                        fontSize: '10px',
                                                                        fontWeight: '600'
                                                                    }}>
                                                                        {statusInfo.label}
                                                                    </span>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    );
                                })
                            ) : (
                                <div style={{ textAlign: 'center', padding: '60px', color: '#666' }}>
                                    {AdminIcons.Target({ size: 48, color: '#ccc' })}
                                    <div style={{ marginTop: '12px' }}>No goals defined yet</div>
                                    <p style={{ fontSize: '14px', color: '#999', marginTop: '8px' }}>
                                        Create a goal to start building the Golden Thread hierarchy
                                    </p>
                                    <button
                                        onClick={() => openCreateModal('goal')}
                                        style={{
                                            marginTop: '16px',
                                            padding: '10px 20px',
                                            background: '#FF9800',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '8px',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        Create First Goal
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                )}

                {/* CHECK-INS SUB-TAB */}
                {activeSubTab === 'checkins' && (
                    <div>
                        <div style={{
                            background: 'white',
                            borderRadius: '12px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                            overflow: 'hidden'
                        }}>
                            <div style={{
                                padding: '20px 24px',
                                borderBottom: '1px solid #f0f0f0',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'space-between'
                            }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                    {AdminIcons.ClipboardCheck({ size: 20, color: '#0077CC' })}
                                    <h3 style={{ margin: 0, fontSize: '16px', color: '#333', fontWeight: '600' }}>
                                        Check-in History ({checkIns.length})
                                    </h3>
                                </div>
                            </div>

                            {checkIns.length > 0 ? (
                                <div>
                                    {checkIns.map((checkIn, i) => {
                                        const isMorning = checkIn.type === 'morning' || checkIn.morningData;
                                        const data = checkIn.morningData || checkIn.eveningData || checkIn;
                                        return (
                                            <div
                                                key={checkIn.id}
                                                style={{
                                                    padding: '20px 24px',
                                                    borderBottom: i < checkIns.length - 1 ? '1px solid #f0f0f0' : 'none'
                                                }}
                                            >
                                                <div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>
                                                    <div style={{
                                                        width: '44px',
                                                        height: '44px',
                                                        borderRadius: '10px',
                                                        background: isMorning
                                                            ? 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)'
                                                            : 'linear-gradient(135deg, #5C6BC0 0%, #3949AB 100%)',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        justifyContent: 'center',
                                                        flexShrink: 0
                                                    }}>
                                                        {isMorning
                                                            ? AdminIcons.Sunrise({ size: 22, color: 'white' })
                                                            : AdminIcons.Moon({ size: 22, color: 'white' })
                                                        }
                                                    </div>
                                                    <div style={{ flex: 1 }}>
                                                        <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' }}>
                                                            <span style={{ fontWeight: '600', color: '#333' }}>
                                                                {isMorning ? 'Morning Check-in' : 'Evening Check-in'}
                                                            </span>
                                                            <span style={{ fontSize: '13px', color: '#999' }}>
                                                                {formatDateTime(checkIn.createdAt)}
                                                            </span>
                                                        </div>

                                                        {/* Metrics Grid */}
                                                        <div style={{
                                                            display: 'grid',
                                                            gridTemplateColumns: 'repeat(4, 1fr)',
                                                            gap: '12px',
                                                            marginBottom: data.notes ? '12px' : 0
                                                        }}>
                                                            {[
                                                                { label: 'Mood', value: data.mood, color: '#00A86B', icon: AdminIcons.Smile },
                                                                { label: 'Craving', value: data.craving, color: '#FF6B35', icon: AdminIcons.Flame },
                                                                { label: 'Anxiety', value: data.anxiety, color: '#9C27B0', icon: AdminIcons.Activity },
                                                                { label: 'Sleep', value: data.sleep, color: '#2196F3', icon: AdminIcons.Moon }
                                                            ].map(metric => (
                                                                <div
                                                                    key={metric.label}
                                                                    style={{
                                                                        padding: '10px',
                                                                        background: '#f8f9fa',
                                                                        borderRadius: '8px',
                                                                        textAlign: 'center'
                                                                    }}
                                                                >
                                                                    <div style={{ fontSize: '11px', color: '#666', marginBottom: '4px' }}>
                                                                        {metric.label}
                                                                    </div>
                                                                    <div style={{
                                                                        fontSize: '20px',
                                                                        fontWeight: '700',
                                                                        color: metric.value != null ? metric.color : '#ccc'
                                                                    }}>
                                                                        {metric.value != null ? metric.value : '-'}
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>

                                                        {/* Notes */}
                                                        {data.notes && (
                                                            <div style={{
                                                                padding: '12px',
                                                                background: '#f8f9fa',
                                                                borderRadius: '8px',
                                                                fontSize: '14px',
                                                                color: '#555',
                                                                borderLeft: '3px solid #0077CC'
                                                            }}>
                                                                {data.notes}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            ) : (
                                <div style={{ textAlign: 'center', padding: '60px', color: '#666' }}>
                                    {AdminIcons.ClipboardCheck({ size: 48, color: '#ccc' })}
                                    <div style={{ marginTop: '12px' }}>No check-ins recorded yet</div>
                                </div>
                            )}
                        </div>
                    </div>
                )}

                {/* REFLECTIONS SUB-TAB */}
                {activeSubTab === 'reflections' && (
                    <div>
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '24px' }}>
                            {/* Gratitudes */}
                            <div style={{
                                background: 'white',
                                borderRadius: '12px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                                overflow: 'hidden'
                            }}>
                                <div style={{
                                    padding: '20px 24px',
                                    borderBottom: '1px solid #f0f0f0',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '10px'
                                }}>
                                    {AdminIcons.Heart({ size: 20, color: '#E91E63' })}
                                    <h3 style={{ margin: 0, fontSize: '16px', color: '#333', fontWeight: '600' }}>
                                        Gratitudes ({journeyData.gratitudes?.length || 0})
                                    </h3>
                                </div>

                                {journeyData.gratitudes?.length > 0 ? (
                                    <div style={{ maxHeight: '400px', overflowY: 'auto' }}>
                                        {journeyData.gratitudes.map((gratitude, i) => (
                                            <div
                                                key={gratitude.id}
                                                style={{
                                                    padding: '16px 24px',
                                                    borderBottom: i < journeyData.gratitudes.length - 1 ? '1px solid #f0f0f0' : 'none'
                                                }}
                                            >
                                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                                                    <span style={{
                                                        fontSize: '11px',
                                                        color: '#E91E63',
                                                        background: '#fce4ec',
                                                        padding: '2px 8px',
                                                        borderRadius: '10px',
                                                        fontWeight: '500'
                                                    }}>
                                                        {gratitude.theme || 'General'}
                                                    </span>
                                                    <span style={{ fontSize: '12px', color: '#999' }}>
                                                        {formatTimeAgo(gratitude.createdAt)}
                                                    </span>
                                                </div>
                                                <p style={{ margin: 0, color: '#333', fontSize: '14px', lineHeight: '1.5' }}>
                                                    {gratitude.content || gratitude.text || 'No content'}
                                                </p>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div style={{ textAlign: 'center', padding: '40px', color: '#666' }}>
                                        {AdminIcons.Heart({ size: 32, color: '#ccc' })}
                                        <div style={{ marginTop: '12px', fontSize: '14px' }}>No gratitudes recorded</div>
                                    </div>
                                )}
                            </div>

                            {/* Reflections */}
                            <div style={{
                                background: 'white',
                                borderRadius: '12px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                                overflow: 'hidden'
                            }}>
                                <div style={{
                                    padding: '20px 24px',
                                    borderBottom: '1px solid #f0f0f0',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '10px'
                                }}>
                                    {AdminIcons.BookOpen({ size: 20, color: '#5C6BC0' })}
                                    <h3 style={{ margin: 0, fontSize: '16px', color: '#333', fontWeight: '600' }}>
                                        Evening Reflections ({journeyData.reflections?.length || 0})
                                    </h3>
                                </div>

                                {journeyData.reflections?.length > 0 ? (
                                    <div style={{ maxHeight: '400px', overflowY: 'auto' }}>
                                        {journeyData.reflections.map((reflection, i) => (
                                            <div
                                                key={reflection.id}
                                                style={{
                                                    padding: '16px 24px',
                                                    borderBottom: i < journeyData.reflections.length - 1 ? '1px solid #f0f0f0' : 'none'
                                                }}
                                            >
                                                <div style={{ fontSize: '12px', color: '#999', marginBottom: '8px' }}>
                                                    {formatTimeAgo(reflection.createdAt)}
                                                </div>
                                                <p style={{ margin: 0, color: '#333', fontSize: '14px', lineHeight: '1.5' }}>
                                                    {reflection.content || reflection.text || 'No content'}
                                                </p>
                                                {reflection.wins && reflection.wins.length > 0 && (
                                                    <div style={{ marginTop: '8px' }}>
                                                        <span style={{ fontSize: '12px', color: '#00A86B', fontWeight: '500' }}>Today's Wins:</span>
                                                        <ul style={{ margin: '4px 0 0', paddingLeft: '20px', fontSize: '13px', color: '#555' }}>
                                                            {reflection.wins.map((win, wi) => (
                                                                <li key={wi}>{win}</li>
                                                            ))}
                                                        </ul>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div style={{ textAlign: 'center', padding: '40px', color: '#666' }}>
                                        {AdminIcons.BookOpen({ size: 32, color: '#ccc' })}
                                        <div style={{ marginTop: '12px', fontSize: '14px' }}>No reflections recorded</div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Breakthroughs */}
                        {journeyData.breakthroughs?.length > 0 && (
                            <div style={{
                                background: 'white',
                                borderRadius: '12px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                                overflow: 'hidden',
                                marginTop: '24px'
                            }}>
                                <div style={{
                                    padding: '20px 24px',
                                    borderBottom: '1px solid #f0f0f0',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '10px'
                                }}>
                                    {AdminIcons.Zap({ size: 20, color: '#FF9800' })}
                                    <h3 style={{ margin: 0, fontSize: '16px', color: '#333', fontWeight: '600' }}>
                                        Breakthroughs ({journeyData.breakthroughs.length})
                                    </h3>
                                </div>

                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '16px', padding: '20px 24px' }}>
                                    {journeyData.breakthroughs.map((breakthrough) => (
                                        <div
                                            key={breakthrough.id}
                                            style={{
                                                padding: '16px',
                                                background: 'linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%)',
                                                borderRadius: '10px',
                                                border: '1px solid #FFE0B2'
                                            }}
                                        >
                                            <div style={{ fontSize: '12px', color: '#F57C00', marginBottom: '8px', fontWeight: '500' }}>
                                                {formatTimeAgo(breakthrough.createdAt)}
                                            </div>
                                            <p style={{ margin: 0, color: '#333', fontSize: '14px', lineHeight: '1.5' }}>
                                                {breakthrough.content || breakthrough.text || 'Breakthrough moment'}
                                            </p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                )}

                {/* CREATE/EDIT MODAL */}
                {(showCreateModal || showEditModal) && (
                    <div style={{
                        position: 'fixed',
                        top: 0,
                        left: 0,
                        right: 0,
                        bottom: 0,
                        background: 'rgba(0,0,0,0.5)',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        zIndex: 1000
                    }}>
                        <div style={{
                            background: 'white',
                            borderRadius: '16px',
                            width: '500px',
                            maxHeight: '90vh',
                            overflow: 'auto',
                            boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
                        }}>
                            {/* Modal Header */}
                            <div style={{
                                padding: '24px',
                                borderBottom: '1px solid #f0f0f0',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'space-between'
                            }}>
                                <h3 style={{ margin: 0, color: '#333' }}>
                                    {showEditModal ? `Edit ${editingItem?.type}` : `Create ${createType}`}
                                </h3>
                                <button
                                    onClick={() => { setShowCreateModal(false); setShowEditModal(false); setEditingItem(null); }}
                                    style={{
                                        background: 'none',
                                        border: 'none',
                                        cursor: 'pointer',
                                        padding: '4px'
                                    }}
                                >
                                    {AdminIcons.X({ size: 24, color: '#666' })}
                                </button>
                            </div>

                            {/* Modal Body */}
                            <div style={{ padding: '24px' }}>
                                {/* Title */}
                                <div style={{ marginBottom: '20px' }}>
                                    <label style={{ display: 'block', marginBottom: '6px', fontWeight: '500', color: '#333' }}>
                                        Title *
                                    </label>
                                    <input
                                        type="text"
                                        value={formData.title}
                                        onChange={e => setFormData({ ...formData, title: e.target.value })}
                                        style={{
                                            width: '100%',
                                            padding: '12px',
                                            border: '1px solid #e0e0e0',
                                            borderRadius: '8px',
                                            fontSize: '14px',
                                            boxSizing: 'border-box'
                                        }}
                                        placeholder={`Enter ${createType || editingItem?.type} title`}
                                    />
                                </div>

                                {/* Description */}
                                <div style={{ marginBottom: '20px' }}>
                                    <label style={{ display: 'block', marginBottom: '6px', fontWeight: '500', color: '#333' }}>
                                        Description
                                    </label>
                                    <textarea
                                        value={formData.description}
                                        onChange={e => setFormData({ ...formData, description: e.target.value })}
                                        rows={3}
                                        style={{
                                            width: '100%',
                                            padding: '12px',
                                            border: '1px solid #e0e0e0',
                                            borderRadius: '8px',
                                            fontSize: '14px',
                                            resize: 'vertical',
                                            boxSizing: 'border-box'
                                        }}
                                        placeholder="Add description..."
                                    />
                                </div>

                                {/* Assignment-specific fields */}
                                {(createType === 'assignment' || editingItem?.type === 'assignment') && (
                                    <>
                                        {/* Category & Priority */}
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '20px' }}>
                                            <div>
                                                <label style={{ display: 'block', marginBottom: '6px', fontWeight: '500', color: '#333' }}>
                                                    Category
                                                </label>
                                                <select
                                                    value={formData.category}
                                                    onChange={e => setFormData({ ...formData, category: e.target.value })}
                                                    style={{
                                                        width: '100%',
                                                        padding: '12px',
                                                        border: '1px solid #e0e0e0',
                                                        borderRadius: '8px',
                                                        fontSize: '14px',
                                                        background: 'white'
                                                    }}
                                                >
                                                    {categories.map(cat => (
                                                        <option key={cat.value} value={cat.value}>{cat.label}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div>
                                                <label style={{ display: 'block', marginBottom: '6px', fontWeight: '500', color: '#333' }}>
                                                    Priority
                                                </label>
                                                <select
                                                    value={formData.priority}
                                                    onChange={e => setFormData({ ...formData, priority: e.target.value })}
                                                    style={{
                                                        width: '100%',
                                                        padding: '12px',
                                                        border: '1px solid #e0e0e0',
                                                        borderRadius: '8px',
                                                        fontSize: '14px',
                                                        background: 'white'
                                                    }}
                                                >
                                                    {priorities.map(p => (
                                                        <option key={p.value} value={p.value}>{p.label}</option>
                                                    ))}
                                                </select>
                                            </div>
                                        </div>

                                        {/* Status & Due Date */}
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '20px' }}>
                                            <div>
                                                <label style={{ display: 'block', marginBottom: '6px', fontWeight: '500', color: '#333' }}>
                                                    Status
                                                </label>
                                                <select
                                                    value={formData.status}
                                                    onChange={e => setFormData({ ...formData, status: e.target.value })}
                                                    style={{
                                                        width: '100%',
                                                        padding: '12px',
                                                        border: '1px solid #e0e0e0',
                                                        borderRadius: '8px',
                                                        fontSize: '14px',
                                                        background: 'white'
                                                    }}
                                                >
                                                    {statuses.filter(s => s.value !== 'overdue').map(s => (
                                                        <option key={s.value} value={s.value}>{s.label}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div>
                                                <label style={{ display: 'block', marginBottom: '6px', fontWeight: '500', color: '#333' }}>
                                                    Due Date
                                                </label>
                                                <input
                                                    type="date"
                                                    value={formData.dueDate}
                                                    onChange={e => setFormData({ ...formData, dueDate: e.target.value })}
                                                    style={{
                                                        width: '100%',
                                                        padding: '12px',
                                                        border: '1px solid #e0e0e0',
                                                        borderRadius: '8px',
                                                        fontSize: '14px',
                                                        boxSizing: 'border-box'
                                                    }}
                                                />
                                            </div>
                                        </div>
                                    </>
                                )}
                            </div>

                            {/* Modal Footer */}
                            <div style={{
                                padding: '20px 24px',
                                borderTop: '1px solid #f0f0f0',
                                display: 'flex',
                                justifyContent: 'flex-end',
                                gap: '12px'
                            }}>
                                <button
                                    onClick={() => { setShowCreateModal(false); setShowEditModal(false); setEditingItem(null); }}
                                    style={{
                                        padding: '10px 20px',
                                        background: '#f5f7fa',
                                        color: '#666',
                                        border: 'none',
                                        borderRadius: '8px',
                                        cursor: 'pointer',
                                        fontWeight: '500'
                                    }}
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={showEditModal ? handleUpdate : handleCreate}
                                    disabled={!formData.title || saving}
                                    style={{
                                        padding: '10px 20px',
                                        background: !formData.title || saving ? '#ccc' : 'linear-gradient(135deg, #0077CC 0%, #005A9C 100%)',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '8px',
                                        cursor: !formData.title || saving ? 'not-allowed' : 'pointer',
                                        fontWeight: '600'
                                    }}
                                >
                                    {saving ? 'Saving...' : showEditModal ? 'Update' : 'Create'}
                                </button>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    function MessagesTab({ allMessages, pirId, pirData, currentUser, formatDateTime, formatTimeAgo }) {
        const [messages, setMessages] = useState(allMessages || []);
        const [newMessage, setNewMessage] = useState('');
        const [sending, setSending] = useState(false);
        const [selectedImage, setSelectedImage] = useState(null);
        const messagesEndRef = useRef(null);

        // Auto-scroll to bottom when messages change
        useEffect(() => {
            messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
        }, [messages]);

        // Real-time message listener
        useEffect(() => {
            if (!pirId || !currentUser?.id) return;

            // Listen for new messages in real-time
            const unsubscribeSent = db.collection('messages')
                .where('senderId', '==', currentUser.id)
                .where('recipientId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .limit(50)
                .onSnapshot(snap => {
                    const sentMsgs = snap.docs.map(doc => ({ id: doc.id, ...doc.data(), direction: 'sent' }));
                    updateMessages(sentMsgs, 'sent');
                });

            const unsubscribeReceived = db.collection('messages')
                .where('senderId', '==', pirId)
                .where('recipientId', '==', currentUser.id)
                .orderBy('createdAt', 'desc')
                .limit(50)
                .onSnapshot(snap => {
                    const receivedMsgs = snap.docs.map(doc => ({ id: doc.id, ...doc.data(), direction: 'received' }));
                    updateMessages(receivedMsgs, 'received');
                    // Mark received messages as read
                    snap.docs.forEach(doc => {
                        if (!doc.data().readAt) {
                            db.collection('messages').doc(doc.id).update({
                                readAt: firebase.firestore.FieldValue.serverTimestamp(),
                                status: 'read'
                            }).catch(() => {});
                        }
                    });
                });

            return () => {
                unsubscribeSent();
                unsubscribeReceived();
            };
        }, [pirId, currentUser?.id]);

        const updateMessages = (newMsgs, direction) => {
            setMessages(prev => {
                const otherDirection = prev.filter(m => m.direction !== direction);
                const combined = [...otherDirection, ...newMsgs];
                combined.sort((a, b) => {
                    const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
                    const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
                    return dateA - dateB;
                });
                return combined;
            });
        };

        const sendMessage = async () => {
            if (!newMessage.trim() || sending) return;

            try {
                setSending(true);
                await db.collection('messages').add({
                    senderId: currentUser.id,
                    senderName: currentUser.displayName || currentUser.firstName || 'Coach',
                    recipientId: pirId,
                    recipientName: pirData?.displayName || pirData?.firstName || 'PIR',
                    text: newMessage.trim(),
                    type: 'text',
                    status: 'sent',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                setNewMessage('');

                // Log activity
                if (window.logAudit) {
                    window.logAudit('message_sent', { pirId, senderId: currentUser.id });
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message: ' + error.message);
            } finally {
                setSending(false);
            }
        };

        const handleKeyPress = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        };

        const pirName = pirData?.displayName || pirData?.firstName || 'PIR';
        const pirInitial = pirName.charAt(0).toUpperCase();
        const coachName = currentUser?.displayName || currentUser?.firstName || 'Coach';
        const coachInitial = coachName.charAt(0).toUpperCase();

        return (
            <div style={{ padding: '30px', height: 'calc(100vh - 300px)', display: 'flex', flexDirection: 'column' }}>
                {/* Messages Container */}
                <div style={{
                    background: 'white',
                    borderRadius: '12px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                    flex: 1,
                    display: 'flex',
                    flexDirection: 'column',
                    overflow: 'hidden'
                }}>
                    {/* Header */}
                    <div style={{
                        padding: '20px 24px',
                        borderBottom: '1px solid #f0f0f0',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px'
                    }}>
                        <div style={{
                            width: '44px',
                            height: '44px',
                            borderRadius: '50%',
                            background: 'linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            color: 'white',
                            fontWeight: 'bold',
                            fontSize: '18px'
                        }}>
                            {pirInitial}
                        </div>
                        <div style={{ flex: 1 }}>
                            <div style={{ fontWeight: '600', color: '#333', fontSize: '16px' }}>
                                Conversation with {pirName}
                            </div>
                            <div style={{ fontSize: '13px', color: '#666' }}>
                                {messages.length} message{messages.length !== 1 ? 's' : ''}
                            </div>
                        </div>
                        {AdminIcons.MessageSquare({ size: 24, color: '#9C27B0' })}
                    </div>

                    {/* Messages List */}
                    <div style={{
                        flex: 1,
                        overflowY: 'auto',
                        padding: '20px',
                        display: 'flex',
                        flexDirection: 'column',
                        gap: '16px',
                        background: '#f8f9fa'
                    }}>
                        {messages.length > 0 ? (
                            <>
                                {messages.map((message, i) => {
                                    const isSent = message.direction === 'sent' || message.senderId === currentUser?.id;
                                    const messageDate = message.createdAt?.toDate ? message.createdAt.toDate() : new Date(message.createdAt || 0);
                                    const showDateSeparator = i === 0 || (
                                        messageDate.toDateString() !== (messages[i-1]?.createdAt?.toDate ? messages[i-1].createdAt.toDate() : new Date(messages[i-1]?.createdAt || 0)).toDateString()
                                    );

                                    return (
                                        <React.Fragment key={message.id}>
                                            {showDateSeparator && (
                                                <div style={{
                                                    textAlign: 'center',
                                                    margin: '8px 0'
                                                }}>
                                                    <span style={{
                                                        background: '#e0e0e0',
                                                        padding: '4px 12px',
                                                        borderRadius: '10px',
                                                        fontSize: '12px',
                                                        color: '#666'
                                                    }}>
                                                        {messageDate.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}
                                                    </span>
                                                </div>
                                            )}
                                            <div style={{
                                                display: 'flex',
                                                justifyContent: isSent ? 'flex-end' : 'flex-start',
                                                alignItems: 'flex-end',
                                                gap: '8px'
                                            }}>
                                                {!isSent && (
                                                    <div style={{
                                                        width: '32px',
                                                        height: '32px',
                                                        borderRadius: '50%',
                                                        background: 'linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%)',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        justifyContent: 'center',
                                                        color: 'white',
                                                        fontWeight: 'bold',
                                                        fontSize: '14px',
                                                        flexShrink: 0
                                                    }}>
                                                        {pirInitial}
                                                    </div>
                                                )}
                                                <div style={{
                                                    maxWidth: '70%',
                                                    padding: '12px 16px',
                                                    borderRadius: isSent ? '18px 18px 4px 18px' : '18px 18px 18px 4px',
                                                    background: isSent
                                                        ? 'linear-gradient(135deg, #0077CC 0%, #005A9C 100%)'
                                                        : 'white',
                                                    color: isSent ? 'white' : '#333',
                                                    boxShadow: isSent ? 'none' : '0 1px 3px rgba(0,0,0,0.1)'
                                                }}>
                                                    {/* Image if present */}
                                                    {message.imageUrl && (
                                                        <img
                                                            src={message.imageUrl}
                                                            alt="Attachment"
                                                            style={{
                                                                maxWidth: '200px',
                                                                maxHeight: '200px',
                                                                borderRadius: '8px',
                                                                marginBottom: message.text ? '8px' : 0,
                                                                cursor: 'pointer'
                                                            }}
                                                            onClick={() => setSelectedImage(message.imageUrl)}
                                                        />
                                                    )}
                                                    {/* Message text */}
                                                    {message.text && (
                                                        <div style={{
                                                            fontSize: '14px',
                                                            lineHeight: '1.5',
                                                            wordBreak: 'break-word'
                                                        }}>
                                                            {message.text}
                                                        </div>
                                                    )}
                                                    {/* Timestamp */}
                                                    <div style={{
                                                        fontSize: '11px',
                                                        marginTop: '6px',
                                                        opacity: 0.7,
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        justifyContent: isSent ? 'flex-end' : 'flex-start',
                                                        gap: '6px'
                                                    }}>
                                                        {messageDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}
                                                        {isSent && message.status && (
                                                            <span style={{ display: 'flex', alignItems: 'center' }}>
                                                                {message.status === 'read'
                                                                    ? AdminIcons.CheckCircle({ size: 12, color: 'rgba(255,255,255,0.9)' })
                                                                    : AdminIcons.Check({ size: 12, color: 'rgba(255,255,255,0.7)' })
                                                                }
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                                {isSent && (
                                                    <div style={{
                                                        width: '32px',
                                                        height: '32px',
                                                        borderRadius: '50%',
                                                        background: 'linear-gradient(135deg, #0077CC 0%, #005A9C 100%)',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        justifyContent: 'center',
                                                        color: 'white',
                                                        fontWeight: 'bold',
                                                        fontSize: '14px',
                                                        flexShrink: 0
                                                    }}>
                                                        {coachInitial}
                                                    </div>
                                                )}
                                            </div>
                                        </React.Fragment>
                                    );
                                })}
                                <div ref={messagesEndRef} />
                            </>
                        ) : (
                            <div style={{
                                flex: 1,
                                display: 'flex',
                                flexDirection: 'column',
                                alignItems: 'center',
                                justifyContent: 'center',
                                color: '#666'
                            }}>
                                {AdminIcons.MessageSquare({ size: 64, color: '#ddd' })}
                                <div style={{ marginTop: '16px', fontSize: '16px' }}>No messages yet</div>
                                <div style={{ fontSize: '14px', color: '#999', marginTop: '4px' }}>
                                    Send a message to start the conversation
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Message Input */}
                    <div style={{
                        padding: '16px 20px',
                        borderTop: '1px solid #f0f0f0',
                        background: 'white',
                        display: 'flex',
                        alignItems: 'flex-end',
                        gap: '12px'
                    }}>
                        <textarea
                            value={newMessage}
                            onChange={(e) => setNewMessage(e.target.value)}
                            onKeyPress={handleKeyPress}
                            placeholder="Type a message..."
                            rows={1}
                            style={{
                                flex: 1,
                                padding: '12px 16px',
                                border: '1px solid #e0e0e0',
                                borderRadius: '24px',
                                fontSize: '14px',
                                resize: 'none',
                                outline: 'none',
                                maxHeight: '120px',
                                lineHeight: '1.4'
                            }}
                            onFocus={(e) => e.target.style.borderColor = '#0077CC'}
                            onBlur={(e) => e.target.style.borderColor = '#e0e0e0'}
                        />
                        <button
                            onClick={sendMessage}
                            disabled={!newMessage.trim() || sending}
                            style={{
                                width: '48px',
                                height: '48px',
                                borderRadius: '50%',
                                background: !newMessage.trim() || sending
                                    ? '#e0e0e0'
                                    : 'linear-gradient(135deg, #0077CC 0%, #005A9C 100%)',
                                border: 'none',
                                cursor: !newMessage.trim() || sending ? 'not-allowed' : 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                transition: 'all 0.2s'
                            }}
                        >
                            {sending ? (
                                <div style={{
                                    width: '20px',
                                    height: '20px',
                                    border: '2px solid rgba(255,255,255,0.3)',
                                    borderTop: '2px solid white',
                                    borderRadius: '50%',
                                    animation: 'spin 1s linear infinite'
                                }} />
                            ) : (
                                AdminIcons.Send({ size: 20, color: !newMessage.trim() ? '#999' : 'white' })
                            )}
                        </button>
                    </div>
                </div>

                {/* Image Lightbox */}
                {selectedImage && (
                    <div
                        style={{
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            background: 'rgba(0,0,0,0.9)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            zIndex: 1000,
                            cursor: 'pointer'
                        }}
                        onClick={() => setSelectedImage(null)}
                    >
                        <img
                            src={selectedImage}
                            alt="Full size"
                            style={{
                                maxWidth: '90%',
                                maxHeight: '90%',
                                objectFit: 'contain',
                                borderRadius: '8px'
                            }}
                        />
                        <button
                            style={{
                                position: 'absolute',
                                top: '20px',
                                right: '20px',
                                background: 'rgba(255,255,255,0.1)',
                                border: 'none',
                                borderRadius: '50%',
                                width: '40px',
                                height: '40px',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center'
                            }}
                        >
                            {AdminIcons.X({ size: 24, color: 'white' })}
                        </button>
                    </div>
                )}
            </div>
        );
    }

    function MeetingsTab({ meetings, savedMeetings, pirId, pirData, currentUser, formatDate, formatDateTime }) {
        const [activeSubTab, setActiveSubTab] = useState('today');
        const [allSavedMeetings, setAllSavedMeetings] = useState(savedMeetings || []);
        const [loading, setLoading] = useState(false);
        const [showAddModal, setShowAddModal] = useState(false);
        const [selectedMeeting, setSelectedMeeting] = useState(null);

        // Load saved meetings from Firestore
        useEffect(() => {
            if (!pirId) return;

            setLoading(true);
            db.collection('users').doc(pirId).collection('savedMeetings')
                .orderBy('savedAt', 'desc')
                .onSnapshot(snap => {
                    const saved = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setAllSavedMeetings(saved);
                    setLoading(false);
                }, err => {
                    console.error('Error loading saved meetings:', err);
                    setLoading(false);
                });
        }, [pirId]);

        // Get today's day name for filtering
        const today = new Date();
        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const todayDayName = dayNames[today.getDay()];

        // Filter meetings
        const todayMeetings = allSavedMeetings.filter(m => m.day === todayDayName);
        const upcomingMeetings = allSavedMeetings.filter(m => {
            const meetingDayIndex = dayNames.indexOf(m.day);
            const todayIndex = today.getDay();
            return meetingDayIndex > todayIndex || (meetingDayIndex === todayIndex && m.time > today.toLocaleTimeString('en-US', { hour12: false }).slice(0, 5));
        });

        // Check if meeting was added by staff (not by the PIR)
        const isAddedByStaff = (meeting) => {
            return meeting.addedBy && meeting.addedBy !== pirId;
        };

        // Remove saved meeting
        const removeMeeting = async (meeting) => {
            if (!confirm('Remove this meeting from saved list?')) return;
            try {
                await db.collection('users').doc(pirId).collection('savedMeetings').doc(meeting.id).delete();
            } catch (error) {
                console.error('Error removing meeting:', error);
                alert('Failed to remove meeting: ' + error.message);
            }
        };

        // Mark attendance
        const markAttendance = async (meeting, attended) => {
            try {
                await db.collection('users').doc(pirId).collection('savedMeetings').doc(meeting.id).update({
                    [`attendance.${today.toISOString().split('T')[0]}`]: attended,
                    lastAttendance: attended ? firebase.firestore.FieldValue.serverTimestamp() : null
                });
            } catch (error) {
                console.error('Error marking attendance:', error);
            }
        };

        // Get attendance status for today
        const getTodayAttendance = (meeting) => {
            const dateKey = today.toISOString().split('T')[0];
            return meeting.attendance?.[dateKey];
        };

        // Stats
        const stats = {
            total: allSavedMeetings.length,
            today: todayMeetings.length,
            staffAdded: allSavedMeetings.filter(m => isAddedByStaff(m)).length
        };

        const subTabs = [
            { id: 'today', label: "Today's Meetings", count: stats.today },
            { id: 'all', label: 'All Saved', count: stats.total },
            { id: 'staffAdded', label: 'Added by Staff', count: stats.staffAdded }
        ];

        // Filter based on sub-tab
        const getFilteredMeetings = () => {
            switch (activeSubTab) {
                case 'today': return todayMeetings;
                case 'staffAdded': return allSavedMeetings.filter(m => isAddedByStaff(m));
                default: return allSavedMeetings;
            }
        };

        const filteredMeetings = getFilteredMeetings();

        // Meeting card component
        const MeetingCard = ({ meeting, showAttendance = false }) => {
            const staffAdded = isAddedByStaff(meeting);
            const todayAttended = getTodayAttendance(meeting);

            return (
                <div style={{
                    padding: '20px',
                    background: 'white',
                    borderRadius: '12px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                    border: staffAdded ? '2px solid #9C27B0' : '1px solid #f0f0f0'
                }}>
                    <div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>
                        {/* Day Badge */}
                        <div style={{
                            minWidth: '60px',
                            padding: '12px 8px',
                            background: meeting.day === todayDayName
                                ? 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)'
                                : 'linear-gradient(135deg, #0077CC 0%, #005A9C 100%)',
                            borderRadius: '10px',
                            textAlign: 'center',
                            color: 'white'
                        }}>
                            <div style={{ fontSize: '11px', fontWeight: '500', textTransform: 'uppercase' }}>
                                {meeting.day?.slice(0, 3)}
                            </div>
                            <div style={{ fontSize: '16px', fontWeight: '700', marginTop: '2px' }}>
                                {meeting.time || '--:--'}
                            </div>
                        </div>

                        {/* Meeting Details */}
                        <div style={{ flex: 1 }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px', flexWrap: 'wrap', marginBottom: '6px' }}>
                                <span style={{ fontWeight: '600', color: '#333', fontSize: '15px' }}>
                                    {meeting.name || 'Unnamed Meeting'}
                                </span>
                                {/* Source Badge */}
                                <span style={{
                                    padding: '2px 8px',
                                    background: meeting.source === 'aa' ? '#e8f5e9' : '#fff3e0',
                                    color: meeting.source === 'aa' ? '#2e7d32' : '#e65100',
                                    borderRadius: '4px',
                                    fontSize: '10px',
                                    fontWeight: '600',
                                    textTransform: 'uppercase'
                                }}>
                                    {meeting.source || 'Meeting'}
                                </span>
                                {/* CRITICAL: Added by Staff Badge */}
                                {staffAdded && (
                                    <span style={{
                                        padding: '2px 8px',
                                        background: 'linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%)',
                                        color: 'white',
                                        borderRadius: '4px',
                                        fontSize: '10px',
                                        fontWeight: '600',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '4px'
                                    }}>
                                        {AdminIcons.UserPlus({ size: 10, color: 'white' })}
                                        Added by staff
                                    </span>
                                )}
                                {/* Virtual Badge */}
                                {meeting.isVirtual && (
                                    <span style={{
                                        padding: '2px 8px',
                                        background: '#e3f2fd',
                                        color: '#1565c0',
                                        borderRadius: '4px',
                                        fontSize: '10px',
                                        fontWeight: '600'
                                    }}>
                                        Virtual
                                    </span>
                                )}
                            </div>

                            {/* Location */}
                            {meeting.location && (
                                <div style={{ display: 'flex', alignItems: 'center', gap: '6px', color: '#666', fontSize: '13px', marginBottom: '4px' }}>
                                    {AdminIcons.Map({ size: 14, color: '#999' })}
                                    {meeting.location}
                                </div>
                            )}

                            {/* Address */}
                            {meeting.address && (
                                <div style={{ display: 'flex', alignItems: 'center', gap: '6px', color: '#999', fontSize: '12px', marginBottom: '4px' }}>
                                    {AdminIcons.MapPin({ size: 14, color: '#ccc' })}
                                    {meeting.address}
                                </div>
                            )}

                            {/* Types/Format */}
                            {meeting.types && meeting.types.length > 0 && (
                                <div style={{ display: 'flex', gap: '4px', flexWrap: 'wrap', marginTop: '8px' }}>
                                    {meeting.types.slice(0, 5).map((type, i) => (
                                        <span key={i} style={{
                                            padding: '2px 6px',
                                            background: '#f5f5f5',
                                            color: '#666',
                                            borderRadius: '4px',
                                            fontSize: '11px'
                                        }}>
                                            {type}
                                        </span>
                                    ))}
                                </div>
                            )}

                            {/* Saved info */}
                            {meeting.savedAt && (
                                <div style={{ fontSize: '11px', color: '#999', marginTop: '8px' }}>
                                    Saved {formatDate(meeting.savedAt)}
                                    {staffAdded && meeting.addedByName && ` by ${meeting.addedByName}`}
                                </div>
                            )}
                        </div>

                        {/* Actions */}
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', alignItems: 'flex-end' }}>
                            {/* Attendance buttons for today's meetings */}
                            {showAttendance && meeting.day === todayDayName && (
                                <div style={{ display: 'flex', gap: '4px' }}>
                                    <button
                                        onClick={() => markAttendance(meeting, true)}
                                        style={{
                                            padding: '6px 12px',
                                            background: todayAttended === true ? '#00A86B' : '#f5f7fa',
                                            color: todayAttended === true ? 'white' : '#666',
                                            border: 'none',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '12px',
                                            fontWeight: '500',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '4px'
                                        }}
                                    >
                                        {AdminIcons.Check({ size: 12 })} Attended
                                    </button>
                                    <button
                                        onClick={() => markAttendance(meeting, false)}
                                        style={{
                                            padding: '6px 12px',
                                            background: todayAttended === false ? '#DC143C' : '#f5f7fa',
                                            color: todayAttended === false ? 'white' : '#666',
                                            border: 'none',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '12px',
                                            fontWeight: '500',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '4px'
                                        }}
                                    >
                                        {AdminIcons.X({ size: 12 })} Missed
                                    </button>
                                </div>
                            )}

                            {/* Conference URL */}
                            {meeting.conferenceUrl && (
                                <a
                                    href={meeting.conferenceUrl}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    style={{
                                        padding: '6px 12px',
                                        background: '#e3f2fd',
                                        color: '#1565c0',
                                        border: 'none',
                                        borderRadius: '6px',
                                        textDecoration: 'none',
                                        fontSize: '12px',
                                        fontWeight: '500',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '4px'
                                    }}
                                >
                                    {AdminIcons.Globe({ size: 12 })} Join
                                </a>
                            )}

                            {/* Remove button */}
                            <button
                                onClick={() => removeMeeting(meeting)}
                                style={{
                                    padding: '6px',
                                    background: '#fff5f5',
                                    border: 'none',
                                    borderRadius: '6px',
                                    cursor: 'pointer'
                                }}
                                title="Remove meeting"
                            >
                                {AdminIcons.Trash2({ size: 14, color: '#DC143C' })}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        return (
            <div style={{ padding: '30px' }}>
                {/* Sub-tab Navigation */}
                <div style={{
                    display: 'flex',
                    gap: '8px',
                    marginBottom: '24px',
                    background: 'white',
                    padding: '8px',
                    borderRadius: '12px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                }}>
                    {subTabs.map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveSubTab(tab.id)}
                            style={{
                                flex: 1,
                                padding: '12px 16px',
                                background: activeSubTab === tab.id ? '#FF6B35' : 'transparent',
                                color: activeSubTab === tab.id ? 'white' : '#666',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '8px',
                                fontWeight: activeSubTab === tab.id ? '600' : '500',
                                transition: 'all 0.2s'
                            }}
                        >
                            {tab.label}
                            <span style={{
                                background: activeSubTab === tab.id ? 'rgba(255,255,255,0.2)' : '#e0e0e0',
                                padding: '2px 8px',
                                borderRadius: '10px',
                                fontSize: '12px'
                            }}>
                                {tab.count}
                            </span>
                        </button>
                    ))}
                </div>

                {/* Staff Added Info Banner */}
                {activeSubTab === 'staffAdded' && stats.staffAdded > 0 && (
                    <div style={{
                        padding: '16px 20px',
                        background: 'linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%)',
                        borderRadius: '10px',
                        marginBottom: '20px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px'
                    }}>
                        {AdminIcons.UserPlus({ size: 24, color: '#7B1FA2' })}
                        <div>
                            <div style={{ fontWeight: '600', color: '#4a148c' }}>
                                {stats.staffAdded} meeting{stats.staffAdded !== 1 ? 's' : ''} added by staff
                            </div>
                            <div style={{ fontSize: '13px', color: '#7B1FA2' }}>
                                These meetings were recommended by the recovery coach
                            </div>
                        </div>
                    </div>
                )}

                {/* Meetings List */}
                {loading ? (
                    <div style={{ textAlign: 'center', padding: '60px' }}>
                        <div style={{
                            width: '40px',
                            height: '40px',
                            border: '3px solid #f0f0f0',
                            borderTop: '3px solid #FF6B35',
                            borderRadius: '50%',
                            animation: 'spin 1s linear infinite',
                            margin: '0 auto 16px'
                        }} />
                        <div style={{ color: '#666' }}>Loading meetings...</div>
                    </div>
                ) : filteredMeetings.length > 0 ? (
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                        {filteredMeetings.map(meeting => (
                            <MeetingCard
                                key={meeting.id}
                                meeting={meeting}
                                showAttendance={activeSubTab === 'today'}
                            />
                        ))}
                    </div>
                ) : (
                    <div style={{
                        background: 'white',
                        borderRadius: '12px',
                        padding: '60px',
                        textAlign: 'center',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                    }}>
                        {AdminIcons.Calendar({ size: 64, color: '#ddd' })}
                        <div style={{ marginTop: '16px', color: '#666', fontSize: '16px' }}>
                            {activeSubTab === 'today'
                                ? 'No meetings scheduled for today'
                                : activeSubTab === 'staffAdded'
                                    ? 'No staff-recommended meetings'
                                    : 'No saved meetings'}
                        </div>
                        <div style={{ fontSize: '14px', color: '#999', marginTop: '8px' }}>
                            {activeSubTab === 'staffAdded'
                                ? 'Add meetings for this PIR to help their recovery'
                                : 'Browse AA/NA meetings and save them for this PIR'}
                        </div>
                    </div>
                )}

                {/* Meeting Stats Summary */}
                {allSavedMeetings.length > 0 && (
                    <div style={{
                        marginTop: '24px',
                        padding: '20px',
                        background: 'white',
                        borderRadius: '12px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                    }}>
                        <h4 style={{ margin: '0 0 16px', color: '#333', fontSize: '15px', fontWeight: '600' }}>
                            Meeting Summary
                        </h4>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px' }}>
                            {[
                                { label: 'Total Saved', value: stats.total, color: '#0077CC' },
                                { label: 'Today', value: stats.today, color: '#FF9800' },
                                { label: 'Staff Added', value: stats.staffAdded, color: '#9C27B0' },
                                { label: 'AA Meetings', value: allSavedMeetings.filter(m => m.source === 'aa').length, color: '#00A86B' }
                            ].map(stat => (
                                <div key={stat.label} style={{
                                    padding: '16px',
                                    background: '#f8f9fa',
                                    borderRadius: '10px',
                                    textAlign: 'center'
                                }}>
                                    <div style={{ fontSize: '28px', fontWeight: '700', color: stat.color }}>
                                        {stat.value}
                                    </div>
                                    <div style={{ fontSize: '12px', color: '#666', marginTop: '4px' }}>
                                        {stat.label}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}
            </div>
        );
    }

    function GuidesTab({ resources, assignedResources, resourceProgress, pirId, currentUser }) {
        const [activeSubTab, setActiveSubTab] = useState('assigned');
        const [coachNotes, setCoachNotes] = useState([]);
        const [loadingNotes, setLoadingNotes] = useState(true);
        const [showAddNote, setShowAddNote] = useState(false);
        const [editingNote, setEditingNote] = useState(null);
        const [noteText, setNoteText] = useState('');
        const [noteResourceId, setNoteResourceId] = useState('');
        const [saving, setSaving] = useState(false);
        const [assigning, setAssigning] = useState(null);
        const [selectedResource, setSelectedResource] = useState(null);
        const [searchQuery, setSearchQuery] = useState('');
        const [categoryFilter, setCategoryFilter] = useState('all');

        // Load coach notes for guides
        useEffect(() => {
            if (pirId) loadGuideNotes();
        }, [pirId]);

        const loadGuideNotes = async () => {
            try {
                setLoadingNotes(true);
                const snap = await db.collection('guideNotes')
                    .where('pirId', '==', pirId)
                    .orderBy('createdAt', 'desc')
                    .get();
                const notes = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setCoachNotes(notes);
            } catch (error) {
                console.error('Error loading guide notes:', error);
            } finally {
                setLoadingNotes(false);
            }
        };

        // Get available resources (not yet assigned)
        const availableResources = resources.filter(r =>
            !assignedResources.some(ar => ar.id === r.id)
        );

        // Get unique categories
        const categories = [...new Set(resources.map(r => r.category).filter(Boolean))];

        // Filter resources based on search and category
        const filterResources = (resourceList) => {
            return resourceList.filter(r => {
                const matchesSearch = !searchQuery ||
                    r.title?.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    r.description?.toLowerCase().includes(searchQuery.toLowerCase());
                const matchesCategory = categoryFilter === 'all' || r.category === categoryFilter;
                return matchesSearch && matchesCategory;
            });
        };

        // Get progress status for a resource
        const getProgressStatus = (resourceId) => {
            const progress = resourceProgress[resourceId];
            if (!progress) return { status: 'not-started', percent: 0 };
            return {
                status: progress.status || 'not-started',
                percent: progress.percentComplete || 0,
                lastViewed: progress.lastViewed,
                notes: progress.notes
            };
        };

        // Status styling
        const getStatusStyle = (status) => {
            switch(status) {
                case 'completed':
                    return { bg: '#00A86B20', color: '#00A86B', icon: 'CheckCircle', label: 'Completed' };
                case 'in-progress':
                    return { bg: '#0077CC20', color: '#0077CC', icon: 'Clock', label: 'In Progress' };
                default:
                    return { bg: '#66666620', color: '#666', icon: 'Circle', label: 'Not Started' };
            }
        };

        // Assign resource to PIR
        const handleAssignResource = async (resourceId) => {
            try {
                setAssigning(resourceId);
                await db.collection('resources').doc(resourceId).update({
                    assignedTo: firebase.firestore.FieldValue.arrayUnion(pirId)
                });

                // Create activity log
                await db.collection('activities').add({
                    userId: pirId,
                    type: 'resource_assigned',
                    resourceId: resourceId,
                    assignedBy: currentUser.id,
                    assignedByName: currentUser.displayName || currentUser.email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Refresh the page to show updated assignments
                window.location.reload();
            } catch (error) {
                console.error('Error assigning resource:', error);
                alert('Failed to assign resource: ' + error.message);
            } finally {
                setAssigning(null);
            }
        };

        // Unassign resource from PIR
        const handleUnassignResource = async (resourceId) => {
            if (!confirm('Are you sure you want to remove this assignment?')) return;
            try {
                setAssigning(resourceId);
                await db.collection('resources').doc(resourceId).update({
                    assignedTo: firebase.firestore.FieldValue.arrayRemove(pirId)
                });

                // Create activity log
                await db.collection('activities').add({
                    userId: pirId,
                    type: 'resource_unassigned',
                    resourceId: resourceId,
                    unassignedBy: currentUser.id,
                    unassignedByName: currentUser.displayName || currentUser.email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                window.location.reload();
            } catch (error) {
                console.error('Error unassigning resource:', error);
                alert('Failed to unassign resource: ' + error.message);
            } finally {
                setAssigning(null);
            }
        };

        // Save coach note
        const handleSaveNote = async () => {
            if (!noteText.trim()) return;
            try {
                setSaving(true);
                if (editingNote) {
                    await db.collection('guideNotes').doc(editingNote.id).update({
                        text: noteText.trim(),
                        resourceId: noteResourceId || null,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: currentUser.id
                    });
                    setCoachNotes(coachNotes.map(n =>
                        n.id === editingNote.id ? { ...n, text: noteText, resourceId: noteResourceId } : n
                    ));
                } else {
                    const docRef = await db.collection('guideNotes').add({
                        pirId,
                        text: noteText.trim(),
                        resourceId: noteResourceId || null,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: currentUser.id,
                        coachName: currentUser.displayName || currentUser.email
                    });
                    setCoachNotes([{
                        id: docRef.id,
                        text: noteText,
                        resourceId: noteResourceId,
                        createdAt: new Date(),
                        coachName: currentUser.displayName || currentUser.email
                    }, ...coachNotes]);
                }
                setNoteText('');
                setNoteResourceId('');
                setShowAddNote(false);
                setEditingNote(null);
            } catch (error) {
                console.error('Error saving note:', error);
                alert('Failed to save note: ' + error.message);
            } finally {
                setSaving(false);
            }
        };

        const handleDeleteNote = async (noteId) => {
            if (!confirm('Are you sure you want to delete this note?')) return;
            try {
                await db.collection('guideNotes').doc(noteId).delete();
                setCoachNotes(coachNotes.filter(n => n.id !== noteId));
            } catch (error) {
                console.error('Error deleting note:', error);
                alert('Failed to delete note: ' + error.message);
            }
        };

        // Get resource by ID
        const getResourceById = (id) => resources.find(r => r.id === id);

        // Sub-tab styles
        const subTabStyle = (isActive) => ({
            padding: '10px 20px',
            background: isActive ? '#0077CC' : 'transparent',
            color: isActive ? 'white' : '#666',
            border: 'none',
            borderRadius: '6px',
            cursor: 'pointer',
            fontSize: '14px',
            fontWeight: '500',
            transition: 'all 0.2s'
        });

        // Calculate stats
        const stats = {
            totalAssigned: assignedResources.length,
            completed: assignedResources.filter(r => getProgressStatus(r.id).status === 'completed').length,
            inProgress: assignedResources.filter(r => getProgressStatus(r.id).status === 'in-progress').length,
            notStarted: assignedResources.filter(r => getProgressStatus(r.id).status === 'not-started').length
        };

        const completionRate = stats.totalAssigned > 0
            ? Math.round((stats.completed / stats.totalAssigned) * 100)
            : 0;

        return (
            <div style={{ padding: '24px' }}>
                {/* Stats Summary */}
                <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(4, 1fr)',
                    gap: '16px',
                    marginBottom: '24px'
                }}>
                    <div style={{
                        background: 'white',
                        borderRadius: '12px',
                        padding: '20px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                        textAlign: 'center'
                    }}>
                        <div style={{ fontSize: '28px', fontWeight: '700', color: '#0077CC' }}>
                            {stats.totalAssigned}
                        </div>
                        <div style={{ fontSize: '13px', color: '#666' }}>Total Assigned</div>
                    </div>
                    <div style={{
                        background: 'white',
                        borderRadius: '12px',
                        padding: '20px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                        textAlign: 'center'
                    }}>
                        <div style={{ fontSize: '28px', fontWeight: '700', color: '#00A86B' }}>
                            {stats.completed}
                        </div>
                        <div style={{ fontSize: '13px', color: '#666' }}>Completed</div>
                    </div>
                    <div style={{
                        background: 'white',
                        borderRadius: '12px',
                        padding: '20px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                        textAlign: 'center'
                    }}>
                        <div style={{ fontSize: '28px', fontWeight: '700', color: '#FF6B35' }}>
                            {stats.inProgress}
                        </div>
                        <div style={{ fontSize: '13px', color: '#666' }}>In Progress</div>
                    </div>
                    <div style={{
                        background: 'white',
                        borderRadius: '12px',
                        padding: '20px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                        textAlign: 'center'
                    }}>
                        <div style={{ fontSize: '28px', fontWeight: '700', color: '#9C27B0' }}>
                            {completionRate}%
                        </div>
                        <div style={{ fontSize: '13px', color: '#666' }}>Completion Rate</div>
                    </div>
                </div>

                {/* Sub-tabs */}
                <div style={{
                    display: 'flex',
                    gap: '8px',
                    marginBottom: '24px',
                    background: '#f8f9fa',
                    padding: '6px',
                    borderRadius: '10px',
                    width: 'fit-content'
                }}>
                    {[
                        { id: 'assigned', label: 'Assigned', icon: 'CheckSquare', count: stats.totalAssigned },
                        { id: 'available', label: 'Available', icon: 'BookOpen', count: availableResources.length },
                        { id: 'notes', label: 'Coach Notes', icon: 'FileText', count: coachNotes.length }
                    ].map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveSubTab(tab.id)}
                            style={subTabStyle(activeSubTab === tab.id)}
                        >
                            <span style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                {AdminIcons[tab.icon]({ size: 16 })}
                                {tab.label}
                                <span style={{
                                    background: activeSubTab === tab.id ? 'rgba(255,255,255,0.3)' : '#e0e0e0',
                                    padding: '2px 8px',
                                    borderRadius: '10px',
                                    fontSize: '12px'
                                }}>
                                    {tab.count}
                                </span>
                            </span>
                        </button>
                    ))}
                </div>

                {/* Search and Filter Bar (for assigned and available tabs) */}
                {(activeSubTab === 'assigned' || activeSubTab === 'available') && (
                    <div style={{
                        display: 'flex',
                        gap: '12px',
                        marginBottom: '20px'
                    }}>
                        <div style={{ flex: 1, position: 'relative' }}>
                            <input
                                type="text"
                                placeholder="Search resources..."
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                style={{
                                    width: '100%',
                                    padding: '12px 16px 12px 40px',
                                    border: '1px solid #e0e0e0',
                                    borderRadius: '8px',
                                    fontSize: '14px'
                                }}
                            />
                            <div style={{ position: 'absolute', left: '12px', top: '50%', transform: 'translateY(-50%)' }}>
                                {AdminIcons.Search({ size: 18, color: '#999' })}
                            </div>
                        </div>
                        <select
                            value={categoryFilter}
                            onChange={(e) => setCategoryFilter(e.target.value)}
                            style={{
                                padding: '12px 16px',
                                border: '1px solid #e0e0e0',
                                borderRadius: '8px',
                                fontSize: '14px',
                                background: 'white',
                                minWidth: '150px'
                            }}
                        >
                            <option value="all">All Categories</option>
                            {categories.map(cat => (
                                <option key={cat} value={cat}>{cat}</option>
                            ))}
                        </select>
                    </div>
                )}

                {/* Assigned Resources Tab */}
                {activeSubTab === 'assigned' && (
                    <div>
                        {filterResources(assignedResources).length === 0 ? (
                            <div style={{
                                background: 'white',
                                borderRadius: '12px',
                                padding: '60px 40px',
                                textAlign: 'center',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                            }}>
                                {AdminIcons.BookOpen({ size: 48, color: '#ccc' })}
                                <h3 style={{ margin: '16px 0 8px', color: '#333' }}>No Assigned Resources</h3>
                                <p style={{ color: '#666', margin: 0, maxWidth: '400px', marginLeft: 'auto', marginRight: 'auto' }}>
                                    {searchQuery || categoryFilter !== 'all'
                                        ? 'No resources match your search criteria.'
                                        : 'Go to the Available tab to assign educational resources to this PIR.'}
                                </p>
                            </div>
                        ) : (
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                {filterResources(assignedResources).map(resource => {
                                    const progress = getProgressStatus(resource.id);
                                    const statusStyle = getStatusStyle(progress.status);

                                    return (
                                        <div
                                            key={resource.id}
                                            style={{
                                                background: 'white',
                                                borderRadius: '12px',
                                                padding: '20px',
                                                boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                                                border: '1px solid #f0f0f0'
                                            }}
                                        >
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                                <div style={{ flex: 1 }}>
                                                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '8px' }}>
                                                        <div style={{
                                                            width: '40px',
                                                            height: '40px',
                                                            borderRadius: '10px',
                                                            background: '#0077CC15',
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            justifyContent: 'center'
                                                        }}>
                                                            {AdminIcons.BookOpen({ size: 20, color: '#0077CC' })}
                                                        </div>
                                                        <div>
                                                            <h4 style={{ margin: 0, color: '#333', fontSize: '16px', fontWeight: '600' }}>
                                                                {resource.title || 'Untitled Resource'}
                                                            </h4>
                                                            {resource.category && (
                                                                <span style={{
                                                                    fontSize: '12px',
                                                                    color: '#666',
                                                                    background: '#f0f0f0',
                                                                    padding: '2px 8px',
                                                                    borderRadius: '4px',
                                                                    marginTop: '4px',
                                                                    display: 'inline-block'
                                                                }}>
                                                                    {resource.category}
                                                                </span>
                                                            )}
                                                        </div>
                                                    </div>

                                                    {resource.description && (
                                                        <p style={{ color: '#666', fontSize: '14px', margin: '12px 0', lineHeight: '1.5' }}>
                                                            {resource.description.substring(0, 150)}
                                                            {resource.description.length > 150 ? '...' : ''}
                                                        </p>
                                                    )}

                                                    {/* Progress Bar */}
                                                    <div style={{ marginTop: '12px' }}>
                                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '6px' }}>
                                                            <span style={{
                                                                display: 'inline-flex',
                                                                alignItems: 'center',
                                                                gap: '6px',
                                                                background: statusStyle.bg,
                                                                color: statusStyle.color,
                                                                padding: '4px 10px',
                                                                borderRadius: '12px',
                                                                fontSize: '12px',
                                                                fontWeight: '500'
                                                            }}>
                                                                {AdminIcons[statusStyle.icon]({ size: 14 })}
                                                                {statusStyle.label}
                                                            </span>
                                                            <span style={{ fontSize: '12px', color: '#666' }}>
                                                                {progress.percent}% complete
                                                            </span>
                                                        </div>
                                                        <div style={{
                                                            height: '6px',
                                                            background: '#f0f0f0',
                                                            borderRadius: '3px',
                                                            overflow: 'hidden'
                                                        }}>
                                                            <div style={{
                                                                height: '100%',
                                                                width: `${progress.percent}%`,
                                                                background: statusStyle.color,
                                                                borderRadius: '3px',
                                                                transition: 'width 0.3s'
                                                            }} />
                                                        </div>
                                                    </div>

                                                    {/* PIR Notes (if any) */}
                                                    {progress.notes && (
                                                        <div style={{
                                                            marginTop: '12px',
                                                            padding: '12px',
                                                            background: '#f8f9fa',
                                                            borderRadius: '8px',
                                                            borderLeft: '3px solid #0077CC'
                                                        }}>
                                                            <div style={{ display: 'flex', alignItems: 'center', gap: '6px', marginBottom: '4px' }}>
                                                                {AdminIcons.MessageSquare({ size: 14, color: '#0077CC' })}
                                                                <span style={{ fontSize: '12px', fontWeight: '600', color: '#0077CC' }}>PIR Notes</span>
                                                            </div>
                                                            <p style={{ margin: 0, fontSize: '13px', color: '#666', fontStyle: 'italic' }}>
                                                                "{progress.notes}"
                                                            </p>
                                                        </div>
                                                    )}

                                                    {/* Last Viewed */}
                                                    {progress.lastViewed && (
                                                        <div style={{ marginTop: '10px', fontSize: '12px', color: '#999' }}>
                                                            Last viewed: {progress.lastViewed?.toDate ?
                                                                progress.lastViewed.toDate().toLocaleDateString() :
                                                                new Date(progress.lastViewed).toLocaleDateString()}
                                                        </div>
                                                    )}
                                                </div>

                                                {/* Actions */}
                                                <div style={{ display: 'flex', gap: '8px', marginLeft: '16px' }}>
                                                    {resource.url && (
                                                        <a
                                                            href={resource.url}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            style={{
                                                                padding: '8px 12px',
                                                                background: '#0077CC',
                                                                color: 'white',
                                                                borderRadius: '6px',
                                                                fontSize: '13px',
                                                                textDecoration: 'none',
                                                                display: 'flex',
                                                                alignItems: 'center',
                                                                gap: '6px'
                                                            }}
                                                        >
                                                            {AdminIcons.ExternalLink({ size: 14 })}
                                                            View
                                                        </a>
                                                    )}
                                                    <button
                                                        onClick={() => handleUnassignResource(resource.id)}
                                                        disabled={assigning === resource.id}
                                                        style={{
                                                            padding: '8px 12px',
                                                            background: '#DC143C15',
                                                            color: '#DC143C',
                                                            border: 'none',
                                                            borderRadius: '6px',
                                                            cursor: assigning === resource.id ? 'not-allowed' : 'pointer',
                                                            fontSize: '13px',
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            gap: '6px',
                                                            opacity: assigning === resource.id ? 0.6 : 1
                                                        }}
                                                    >
                                                        {AdminIcons.X({ size: 14 })}
                                                        {assigning === resource.id ? 'Removing...' : 'Remove'}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                )}

                {/* Available Resources Tab */}
                {activeSubTab === 'available' && (
                    <div>
                        {filterResources(availableResources).length === 0 ? (
                            <div style={{
                                background: 'white',
                                borderRadius: '12px',
                                padding: '60px 40px',
                                textAlign: 'center',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                            }}>
                                {AdminIcons.CheckCircle({ size: 48, color: '#00A86B' })}
                                <h3 style={{ margin: '16px 0 8px', color: '#333' }}>All Resources Assigned</h3>
                                <p style={{ color: '#666', margin: 0 }}>
                                    {searchQuery || categoryFilter !== 'all'
                                        ? 'No resources match your search criteria.'
                                        : 'All available resources have been assigned to this PIR.'}
                                </p>
                            </div>
                        ) : (
                            <div style={{
                                display: 'grid',
                                gridTemplateColumns: 'repeat(2, 1fr)',
                                gap: '16px'
                            }}>
                                {filterResources(availableResources).map(resource => (
                                    <div
                                        key={resource.id}
                                        style={{
                                            background: 'white',
                                            borderRadius: '12px',
                                            padding: '20px',
                                            boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                                            border: '1px solid #f0f0f0',
                                            display: 'flex',
                                            flexDirection: 'column'
                                        }}
                                    >
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px' }}>
                                            <div style={{
                                                width: '40px',
                                                height: '40px',
                                                borderRadius: '10px',
                                                background: '#0077CC15',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center'
                                            }}>
                                                {AdminIcons.BookOpen({ size: 20, color: '#0077CC' })}
                                            </div>
                                            <div style={{ flex: 1 }}>
                                                <h4 style={{ margin: 0, color: '#333', fontSize: '15px', fontWeight: '600' }}>
                                                    {resource.title || 'Untitled Resource'}
                                                </h4>
                                                {resource.category && (
                                                    <span style={{
                                                        fontSize: '11px',
                                                        color: '#666',
                                                        background: '#f0f0f0',
                                                        padding: '2px 6px',
                                                        borderRadius: '4px'
                                                    }}>
                                                        {resource.category}
                                                    </span>
                                                )}
                                            </div>
                                        </div>

                                        {resource.description && (
                                            <p style={{ color: '#666', fontSize: '13px', margin: '0 0 12px 0', lineHeight: '1.5', flex: 1 }}>
                                                {resource.description.substring(0, 100)}
                                                {resource.description.length > 100 ? '...' : ''}
                                            </p>
                                        )}

                                        <button
                                            onClick={() => handleAssignResource(resource.id)}
                                            disabled={assigning === resource.id}
                                            style={{
                                                padding: '10px 16px',
                                                background: assigning === resource.id ? '#ccc' : 'linear-gradient(135deg, #0077CC 0%, #005A9C 100%)',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '8px',
                                                cursor: assigning === resource.id ? 'not-allowed' : 'pointer',
                                                fontSize: '14px',
                                                fontWeight: '500',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                gap: '8px'
                                            }}
                                        >
                                            {assigning === resource.id ? (
                                                <>Assigning...</>
                                            ) : (
                                                <>
                                                    {AdminIcons.Plus({ size: 16 })}
                                                    Assign to PIR
                                                </>
                                            )}
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                )}

                {/* Coach Notes Tab */}
                {activeSubTab === 'notes' && (
                    <div>
                        {/* Add Note Button */}
                        <div style={{ marginBottom: '20px' }}>
                            <button
                                onClick={() => {
                                    setShowAddNote(true);
                                    setEditingNote(null);
                                    setNoteText('');
                                    setNoteResourceId('');
                                }}
                                style={{
                                    padding: '12px 20px',
                                    background: 'linear-gradient(135deg, #0077CC 0%, #005A9C 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px'
                                }}
                            >
                                {AdminIcons.Plus({ size: 16 })}
                                Add Coach Note
                            </button>
                        </div>

                        {/* Add/Edit Note Form */}
                        {showAddNote && (
                            <div style={{
                                background: 'white',
                                borderRadius: '12px',
                                padding: '24px',
                                marginBottom: '20px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                                border: '2px solid #0077CC'
                            }}>
                                <h4 style={{ margin: '0 0 16px 0', color: '#333' }}>
                                    {editingNote ? 'Edit Note' : 'New Coach Note'}
                                </h4>

                                <div style={{ marginBottom: '16px' }}>
                                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', color: '#666', fontWeight: '500' }}>
                                        Related Resource (Optional)
                                    </label>
                                    <select
                                        value={noteResourceId}
                                        onChange={(e) => setNoteResourceId(e.target.value)}
                                        style={{
                                            width: '100%',
                                            padding: '10px 12px',
                                            border: '1px solid #e0e0e0',
                                            borderRadius: '8px',
                                            fontSize: '14px',
                                            background: 'white'
                                        }}
                                    >
                                        <option value="">No specific resource</option>
                                        {assignedResources.map(r => (
                                            <option key={r.id} value={r.id}>{r.title}</option>
                                        ))}
                                    </select>
                                </div>

                                <div style={{ marginBottom: '16px' }}>
                                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', color: '#666', fontWeight: '500' }}>
                                        Note
                                    </label>
                                    <textarea
                                        value={noteText}
                                        onChange={(e) => setNoteText(e.target.value)}
                                        placeholder="Enter your observations, recommendations, or notes about this PIR's progress with resources..."
                                        style={{
                                            width: '100%',
                                            minHeight: '120px',
                                            padding: '12px',
                                            border: '1px solid #e0e0e0',
                                            borderRadius: '8px',
                                            fontSize: '14px',
                                            resize: 'vertical',
                                            fontFamily: 'inherit'
                                        }}
                                    />
                                </div>

                                <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                                    <button
                                        onClick={() => {
                                            setShowAddNote(false);
                                            setEditingNote(null);
                                            setNoteText('');
                                            setNoteResourceId('');
                                        }}
                                        style={{
                                            padding: '10px 20px',
                                            background: '#f0f0f0',
                                            color: '#666',
                                            border: 'none',
                                            borderRadius: '8px',
                                            cursor: 'pointer',
                                            fontSize: '14px'
                                        }}
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={handleSaveNote}
                                        disabled={saving || !noteText.trim()}
                                        style={{
                                            padding: '10px 20px',
                                            background: saving || !noteText.trim() ? '#ccc' : '#0077CC',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '8px',
                                            cursor: saving || !noteText.trim() ? 'not-allowed' : 'pointer',
                                            fontSize: '14px',
                                            fontWeight: '500'
                                        }}
                                    >
                                        {saving ? 'Saving...' : (editingNote ? 'Update Note' : 'Save Note')}
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Notes List */}
                        {loadingNotes ? (
                            <div style={{ textAlign: 'center', padding: '40px', color: '#666' }}>
                                Loading notes...
                            </div>
                        ) : coachNotes.length === 0 ? (
                            <div style={{
                                background: 'white',
                                borderRadius: '12px',
                                padding: '60px 40px',
                                textAlign: 'center',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                            }}>
                                {AdminIcons.FileText({ size: 48, color: '#ccc' })}
                                <h3 style={{ margin: '16px 0 8px', color: '#333' }}>No Coach Notes Yet</h3>
                                <p style={{ color: '#666', margin: 0 }}>
                                    Add notes to track this PIR's progress with educational resources.
                                </p>
                            </div>
                        ) : (
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                {coachNotes.map(note => {
                                    const relatedResource = note.resourceId ? getResourceById(note.resourceId) : null;
                                    return (
                                        <div
                                            key={note.id}
                                            style={{
                                                background: 'white',
                                                borderRadius: '12px',
                                                padding: '20px',
                                                boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                                                border: '1px solid #f0f0f0'
                                            }}
                                        >
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                                <div style={{ flex: 1 }}>
                                                    {relatedResource && (
                                                        <div style={{
                                                            display: 'inline-flex',
                                                            alignItems: 'center',
                                                            gap: '6px',
                                                            background: '#0077CC15',
                                                            color: '#0077CC',
                                                            padding: '4px 10px',
                                                            borderRadius: '6px',
                                                            fontSize: '12px',
                                                            fontWeight: '500',
                                                            marginBottom: '10px'
                                                        }}>
                                                            {AdminIcons.BookOpen({ size: 12 })}
                                                            {relatedResource.title}
                                                        </div>
                                                    )}
                                                    <p style={{ margin: '0 0 12px 0', color: '#333', fontSize: '14px', lineHeight: '1.6' }}>
                                                        {note.text}
                                                    </p>
                                                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px', fontSize: '12px', color: '#999' }}>
                                                        <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                                            {AdminIcons.User({ size: 12 })}
                                                            {note.coachName || 'Coach'}
                                                        </span>
                                                        <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                                            {AdminIcons.Clock({ size: 12 })}
                                                            {note.createdAt?.toDate ?
                                                                note.createdAt.toDate().toLocaleDateString() :
                                                                new Date(note.createdAt).toLocaleDateString()}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div style={{ display: 'flex', gap: '8px' }}>
                                                    <button
                                                        onClick={() => {
                                                            setEditingNote(note);
                                                            setNoteText(note.text);
                                                            setNoteResourceId(note.resourceId || '');
                                                            setShowAddNote(true);
                                                        }}
                                                        style={{
                                                            padding: '6px 10px',
                                                            background: '#f0f0f0',
                                                            color: '#666',
                                                            border: 'none',
                                                            borderRadius: '6px',
                                                            cursor: 'pointer',
                                                            fontSize: '12px',
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            gap: '4px'
                                                        }}
                                                    >
                                                        {AdminIcons.Edit({ size: 12 })}
                                                        Edit
                                                    </button>
                                                    <button
                                                        onClick={() => handleDeleteNote(note.id)}
                                                        style={{
                                                            padding: '6px 10px',
                                                            background: '#DC143C15',
                                                            color: '#DC143C',
                                                            border: 'none',
                                                            borderRadius: '6px',
                                                            cursor: 'pointer',
                                                            fontSize: '12px',
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            gap: '4px'
                                                        }}
                                                    >
                                                        {AdminIcons.Trash2({ size: 12 })}
                                                        Delete
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                )}
            </div>
        );
    }

    // ==========================================
    // JOURNEY TAB - Phase 3 Implementation
    // Milestones, heatmap, timeline
    // ==========================================
    function JourneyTab({ journeyData, milestones, pirData, checkIns, activities, formatDate, formatTimeAgo }) {
        const [activeSubTab, setActiveSubTab] = useState('milestones');

        // Standard recovery milestones (days)
        const standardMilestones = [
            { days: 1, label: '24 Hours', icon: 'Sunrise', color: '#FFD93D' },
            { days: 7, label: '1 Week', icon: 'Calendar', color: '#6BCB77' },
            { days: 14, label: '2 Weeks', icon: 'Star', color: '#4D96FF' },
            { days: 30, label: '1 Month', icon: 'Award', color: '#9D65C9' },
            { days: 60, label: '2 Months', icon: 'Award', color: '#FF6B6B' },
            { days: 90, label: '3 Months', icon: 'Trophy', color: '#00A86B' },
            { days: 180, label: '6 Months', icon: 'Trophy', color: '#FF6B35' },
            { days: 365, label: '1 Year', icon: 'Crown', color: '#FFD700' },
            { days: 730, label: '2 Years', icon: 'Crown', color: '#E6B800' },
            { days: 1095, label: '3 Years', icon: 'Sparkles', color: '#9D65C9' },
            { days: 1825, label: '5 Years', icon: 'Sparkles', color: '#DC143C' }
        ];

        const sobrietyDays = pirData?.sobrietyDays || 0;

        // Calculate achieved and upcoming milestones
        const achievedMilestones = standardMilestones.filter(m => sobrietyDays >= m.days);
        const upcomingMilestones = standardMilestones.filter(m => sobrietyDays < m.days).slice(0, 3);
        const nextMilestone = upcomingMilestones[0];

        // Generate 90-day calendar heatmap data
        const generateHeatmapData = () => {
            const today = new Date();
            const days = [];
            const checkInDates = new Map();

            // Map check-ins to dates
            if (checkIns && checkIns.length > 0) {
                checkIns.forEach(checkin => {
                    const date = checkin.createdAt?.toDate ? checkin.createdAt.toDate() : new Date(checkin.createdAt);
                    const dateKey = date.toISOString().split('T')[0];
                    if (!checkInDates.has(dateKey)) {
                        checkInDates.set(dateKey, { count: 0, mood: 0 });
                    }
                    const entry = checkInDates.get(dateKey);
                    entry.count++;
                    const mood = checkin.morningData?.mood ?? checkin.mood ?? 5;
                    entry.mood = Math.max(entry.mood, mood);
                });
            }

            // Generate last 90 days
            for (let i = 89; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateKey = date.toISOString().split('T')[0];
                const data = checkInDates.get(dateKey);

                days.push({
                    date: dateKey,
                    dayOfWeek: date.getDay(),
                    dayOfMonth: date.getDate(),
                    month: date.getMonth(),
                    hasActivity: !!data,
                    count: data?.count || 0,
                    mood: data?.mood || 0
                });
            }

            return days;
        };

        const heatmapData = generateHeatmapData();
        const monthLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

        // Get heatmap intensity color
        const getHeatmapColor = (day) => {
            if (!day.hasActivity) return '#f0f0f0';
            if (day.mood >= 8) return '#00A86B';
            if (day.mood >= 6) return '#6BCB77';
            if (day.mood >= 4) return '#FFD93D';
            if (day.mood >= 2) return '#FF6B35';
            return '#DC143C';
        };

        // Combine journey timeline items
        const getTimelineItems = () => {
            const items = [];

            if (journeyData?.gratitudes) {
                journeyData.gratitudes.forEach(g => {
                    items.push({
                        id: g.id,
                        type: 'gratitude',
                        title: 'Gratitude',
                        content: g.text || g.content || g.gratitude,
                        date: g.createdAt,
                        icon: 'Heart',
                        color: '#FF6B6B'
                    });
                });
            }

            if (journeyData?.reflections) {
                journeyData.reflections.forEach(r => {
                    items.push({
                        id: r.id,
                        type: 'reflection',
                        title: 'Reflection',
                        content: r.text || r.content || r.reflection,
                        date: r.createdAt,
                        icon: 'Moon',
                        color: '#9C27B0'
                    });
                });
            }

            if (journeyData?.breakthroughs) {
                journeyData.breakthroughs.forEach(b => {
                    items.push({
                        id: b.id,
                        type: 'breakthrough',
                        title: 'Breakthrough',
                        content: b.text || b.content || b.breakthrough,
                        date: b.createdAt,
                        icon: 'Zap',
                        color: '#FFD700'
                    });
                });
            }

            // Sort by date descending
            return items.sort((a, b) => {
                const dateA = a.date?.toDate ? a.date.toDate() : new Date(a.date);
                const dateB = b.date?.toDate ? b.date.toDate() : new Date(b.date);
                return dateB - dateA;
            });
        };

        const timelineItems = getTimelineItems();

        // Stats
        const stats = {
            gratitudes: journeyData?.gratitudes?.length || 0,
            reflections: journeyData?.reflections?.length || 0,
            breakthroughs: journeyData?.breakthroughs?.length || 0,
            activeDays: heatmapData.filter(d => d.hasActivity).length
        };

        // Sub-tab styles
        const subTabStyle = (isActive) => ({
            padding: '10px 20px',
            background: isActive ? '#0077CC' : 'transparent',
            color: isActive ? 'white' : '#666',
            border: 'none',
            borderRadius: '6px',
            cursor: 'pointer',
            fontSize: '14px',
            fontWeight: '500',
            transition: 'all 0.2s'
        });

        return (
            <div style={{ padding: '24px' }}>
                {/* Sobriety Hero Banner */}
                <div style={{
                    background: 'linear-gradient(135deg, #0077CC 0%, #00A86B 100%)',
                    borderRadius: '16px',
                    padding: '32px',
                    marginBottom: '24px',
                    color: 'white',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center'
                }}>
                    <div>
                        <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '8px' }}>
                            Recovery Journey
                        </div>
                        <div style={{ fontSize: '48px', fontWeight: '700', lineHeight: 1 }}>
                            {sobrietyDays.toLocaleString()}
                        </div>
                        <div style={{ fontSize: '18px', opacity: 0.9, marginTop: '4px' }}>
                            Days Sober
                        </div>
                        {pirData?.sobrietyDate && (
                            <div style={{ fontSize: '13px', opacity: 0.7, marginTop: '12px' }}>
                                Since {formatDate(pirData.sobrietyDate)}
                            </div>
                        )}
                    </div>
                    {nextMilestone && (
                        <div style={{
                            textAlign: 'right',
                            background: 'rgba(255,255,255,0.15)',
                            borderRadius: '12px',
                            padding: '16px 24px'
                        }}>
                            <div style={{ fontSize: '13px', opacity: 0.9, marginBottom: '4px' }}>
                                Next Milestone
                            </div>
                            <div style={{ fontSize: '24px', fontWeight: '700' }}>
                                {nextMilestone.label}
                            </div>
                            <div style={{ fontSize: '14px', opacity: 0.9 }}>
                                {nextMilestone.days - sobrietyDays} days away
                            </div>
                        </div>
                    )}
                </div>

                {/* Sub-tabs */}
                <div style={{
                    display: 'flex',
                    gap: '8px',
                    marginBottom: '24px',
                    background: '#f8f9fa',
                    padding: '6px',
                    borderRadius: '10px',
                    width: 'fit-content'
                }}>
                    {[
                        { id: 'milestones', label: 'Milestones', icon: 'Trophy' },
                        { id: 'heatmap', label: 'Activity', icon: 'Calendar' },
                        { id: 'timeline', label: 'Timeline', icon: 'Clock' }
                    ].map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveSubTab(tab.id)}
                            style={subTabStyle(activeSubTab === tab.id)}
                        >
                            <span style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                {AdminIcons[tab.icon]({ size: 16 })}
                                {tab.label}
                            </span>
                        </button>
                    ))}
                </div>

                {/* Milestones Sub-tab */}
                {activeSubTab === 'milestones' && (
                    <div>
                        {/* Achieved Milestones */}
                        <div style={{
                            background: 'white',
                            borderRadius: '12px',
                            padding: '24px',
                            marginBottom: '24px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                        }}>
                            <h3 style={{ margin: '0 0 20px', color: '#333', fontSize: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                {AdminIcons.Check({ size: 20, color: '#00A86B' })}
                                Achieved Milestones ({achievedMilestones.length})
                            </h3>

                            {achievedMilestones.length > 0 ? (
                                <div style={{
                                    display: 'grid',
                                    gridTemplateColumns: 'repeat(auto-fill, minmax(140px, 1fr))',
                                    gap: '16px'
                                }}>
                                    {achievedMilestones.map((milestone, index) => (
                                        <div key={index} style={{
                                            background: `${milestone.color}15`,
                                            borderRadius: '12px',
                                            padding: '16px',
                                            textAlign: 'center',
                                            border: `2px solid ${milestone.color}30`
                                        }}>
                                            <div style={{
                                                width: '48px',
                                                height: '48px',
                                                borderRadius: '50%',
                                                background: milestone.color,
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                margin: '0 auto 12px'
                                            }}>
                                                {AdminIcons[milestone.icon] ?
                                                    AdminIcons[milestone.icon]({ size: 24, color: 'white' }) :
                                                    AdminIcons.Award({ size: 24, color: 'white' })
                                                }
                                            </div>
                                            <div style={{ fontWeight: '700', color: '#333', fontSize: '15px' }}>
                                                {milestone.label}
                                            </div>
                                            <div style={{ fontSize: '12px', color: '#666', marginTop: '4px' }}>
                                                {milestone.days} days
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <p style={{ color: '#999', textAlign: 'center', margin: '20px 0' }}>
                                    First milestone (24 hours) coming up!
                                </p>
                            )}
                        </div>

                        {/* Upcoming Milestones */}
                        {upcomingMilestones.length > 0 && (
                            <div style={{
                                background: 'white',
                                borderRadius: '12px',
                                padding: '24px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                            }}>
                                <h3 style={{ margin: '0 0 20px', color: '#333', fontSize: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                    {AdminIcons.Target({ size: 20, color: '#0077CC' })}
                                    Upcoming Milestones
                                </h3>

                                <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                    {upcomingMilestones.map((milestone, index) => {
                                        const daysRemaining = milestone.days - sobrietyDays;
                                        const progress = Math.min(100, Math.round((sobrietyDays / milestone.days) * 100));

                                        return (
                                            <div key={index} style={{
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '16px',
                                                padding: '16px',
                                                background: '#f8f9fa',
                                                borderRadius: '10px'
                                            }}>
                                                <div style={{
                                                    width: '48px',
                                                    height: '48px',
                                                    borderRadius: '50%',
                                                    background: '#e0e0e0',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    flexShrink: 0
                                                }}>
                                                    {AdminIcons[milestone.icon] ?
                                                        AdminIcons[milestone.icon]({ size: 24, color: '#999' }) :
                                                        AdminIcons.Award({ size: 24, color: '#999' })
                                                    }
                                                </div>
                                                <div style={{ flex: 1 }}>
                                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                                                        <span style={{ fontWeight: '600', color: '#333' }}>{milestone.label}</span>
                                                        <span style={{ color: '#666', fontSize: '13px' }}>{daysRemaining} days away</span>
                                                    </div>
                                                    <div style={{
                                                        height: '8px',
                                                        background: '#e0e0e0',
                                                        borderRadius: '4px',
                                                        overflow: 'hidden'
                                                    }}>
                                                        <div style={{
                                                            width: `${progress}%`,
                                                            height: '100%',
                                                            background: milestone.color,
                                                            borderRadius: '4px',
                                                            transition: 'width 0.3s'
                                                        }}></div>
                                                    </div>
                                                    <div style={{ fontSize: '12px', color: '#999', marginTop: '4px' }}>
                                                        {progress}% complete
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                    </div>
                )}

                {/* Activity Heatmap Sub-tab */}
                {activeSubTab === 'heatmap' && (
                    <div>
                        {/* Stats Cards */}
                        <div style={{
                            display: 'grid',
                            gridTemplateColumns: 'repeat(4, 1fr)',
                            gap: '16px',
                            marginBottom: '24px'
                        }}>
                            {[
                                { label: 'Active Days', value: stats.activeDays, sublabel: '/ 90 days', color: '#0077CC' },
                                { label: 'Gratitudes', value: stats.gratitudes, sublabel: 'entries', color: '#FF6B6B' },
                                { label: 'Reflections', value: stats.reflections, sublabel: 'entries', color: '#9C27B0' },
                                { label: 'Breakthroughs', value: stats.breakthroughs, sublabel: 'moments', color: '#FFD700' }
                            ].map((stat, index) => (
                                <div key={index} style={{
                                    background: 'white',
                                    borderRadius: '12px',
                                    padding: '20px',
                                    boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                                    textAlign: 'center'
                                }}>
                                    <div style={{ fontSize: '32px', fontWeight: '700', color: stat.color }}>
                                        {stat.value}
                                    </div>
                                    <div style={{ fontSize: '14px', color: '#333', fontWeight: '500' }}>
                                        {stat.label}
                                    </div>
                                    <div style={{ fontSize: '12px', color: '#999' }}>
                                        {stat.sublabel}
                                    </div>
                                </div>
                            ))}
                        </div>

                        {/* 90-Day Heatmap */}
                        <div style={{
                            background: 'white',
                            borderRadius: '12px',
                            padding: '24px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                        }}>
                            <h3 style={{ margin: '0 0 20px', color: '#333', fontSize: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                {AdminIcons.Calendar({ size: 20, color: '#0077CC' })}
                                90-Day Activity Heatmap
                            </h3>

                            {/* Legend */}
                            <div style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '16px',
                                marginBottom: '20px',
                                fontSize: '12px',
                                color: '#666'
                            }}>
                                <span>Less</span>
                                {['#f0f0f0', '#DC143C', '#FF6B35', '#FFD93D', '#6BCB77', '#00A86B'].map((color, i) => (
                                    <div key={i} style={{
                                        width: '16px',
                                        height: '16px',
                                        borderRadius: '3px',
                                        background: color
                                    }}></div>
                                ))}
                                <span>More / Better Mood</span>
                            </div>

                            {/* Heatmap Grid */}
                            <div style={{ overflowX: 'auto' }}>
                                <div style={{
                                    display: 'grid',
                                    gridTemplateColumns: 'repeat(13, 1fr)',
                                    gridTemplateRows: 'repeat(7, 1fr)',
                                    gap: '3px',
                                    minWidth: '650px'
                                }}>
                                    {/* Week day labels */}
                                    {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map((day, i) => (
                                        <div key={`label-${i}`} style={{
                                            fontSize: '10px',
                                            color: '#999',
                                            textAlign: 'right',
                                            paddingRight: '8px',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'flex-end'
                                        }}>
                                            {i % 2 === 1 ? day : ''}
                                        </div>
                                    ))}

                                    {/* Heatmap cells organized by week */}
                                    {Array.from({ length: 13 }).map((_, weekIndex) => (
                                        Array.from({ length: 7 }).map((_, dayIndex) => {
                                            const dataIndex = weekIndex * 7 + dayIndex;
                                            const day = heatmapData[dataIndex];

                                            if (!day) return <div key={`empty-${weekIndex}-${dayIndex}`}></div>;

                                            return (
                                                <div
                                                    key={`cell-${weekIndex}-${dayIndex}`}
                                                    title={`${day.date}: ${day.count} check-in(s), mood: ${day.mood || 'N/A'}`}
                                                    style={{
                                                        width: '14px',
                                                        height: '14px',
                                                        borderRadius: '3px',
                                                        background: getHeatmapColor(day),
                                                        cursor: 'pointer',
                                                        transition: 'transform 0.1s',
                                                        gridColumn: weekIndex + 2,
                                                        gridRow: dayIndex + 1
                                                    }}
                                                    onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.3)'}
                                                    onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
                                                ></div>
                                            );
                                        })
                                    ))}
                                </div>
                            </div>

                            <div style={{ marginTop: '16px', fontSize: '13px', color: '#666', textAlign: 'center' }}>
                                {stats.activeDays} of 90 days with activity ({Math.round((stats.activeDays / 90) * 100)}% engagement)
                            </div>
                        </div>
                    </div>
                )}

                {/* Timeline Sub-tab */}
                {activeSubTab === 'timeline' && (
                    <div>
                        {timelineItems.length > 0 ? (
                            <div style={{
                                background: 'white',
                                borderRadius: '12px',
                                padding: '24px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                            }}>
                                <h3 style={{ margin: '0 0 20px', color: '#333', fontSize: '16px' }}>
                                    Journey Timeline ({timelineItems.length} entries)
                                </h3>

                                <div style={{ position: 'relative', paddingLeft: '32px' }}>
                                    {/* Timeline line */}
                                    <div style={{
                                        position: 'absolute',
                                        left: '11px',
                                        top: '24px',
                                        bottom: '24px',
                                        width: '2px',
                                        background: '#e0e0e0'
                                    }}></div>

                                    {timelineItems.slice(0, 20).map((item, index) => {
                                        const itemDate = item.date?.toDate ? item.date.toDate() : new Date(item.date);
                                        return (
                                            <div key={item.id} style={{
                                                position: 'relative',
                                                marginBottom: index < timelineItems.length - 1 ? '24px' : '0',
                                                paddingLeft: '16px'
                                            }}>
                                                {/* Timeline dot */}
                                                <div style={{
                                                    position: 'absolute',
                                                    left: '-32px',
                                                    top: '4px',
                                                    width: '24px',
                                                    height: '24px',
                                                    borderRadius: '50%',
                                                    background: item.color,
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                                                }}>
                                                    {AdminIcons[item.icon]({ size: 12, color: 'white' })}
                                                </div>

                                                {/* Content */}
                                                <div style={{
                                                    background: '#f8f9fa',
                                                    borderRadius: '10px',
                                                    padding: '16px'
                                                }}>
                                                    <div style={{
                                                        display: 'flex',
                                                        justifyContent: 'space-between',
                                                        alignItems: 'center',
                                                        marginBottom: '8px'
                                                    }}>
                                                        <span style={{
                                                            padding: '4px 10px',
                                                            borderRadius: '12px',
                                                            fontSize: '12px',
                                                            fontWeight: '500',
                                                            background: item.color + '20',
                                                            color: item.color
                                                        }}>
                                                            {item.title}
                                                        </span>
                                                        <span style={{ fontSize: '12px', color: '#999' }}>
                                                            {itemDate.toLocaleDateString('en-US', {
                                                                month: 'short', day: 'numeric', year: 'numeric'
                                                            })}
                                                        </span>
                                                    </div>
                                                    <p style={{
                                                        margin: 0,
                                                        color: '#333',
                                                        fontSize: '14px',
                                                        lineHeight: '1.5',
                                                        whiteSpace: 'pre-wrap'
                                                    }}>
                                                        {item.content || 'No content'}
                                                    </p>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>

                                {timelineItems.length > 20 && (
                                    <div style={{
                                        textAlign: 'center',
                                        marginTop: '20px',
                                        paddingTop: '20px',
                                        borderTop: '1px solid #e0e0e0',
                                        color: '#666',
                                        fontSize: '13px'
                                    }}>
                                        Showing 20 of {timelineItems.length} entries
                                    </div>
                                )}
                            </div>
                        ) : (
                            <div style={{
                                background: 'white',
                                borderRadius: '12px',
                                padding: '60px',
                                textAlign: 'center',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                            }}>
                                {AdminIcons.Clock({ size: 48, color: '#ccc' })}
                                <h3 style={{ color: '#333', margin: '16px 0 8px' }}>No Journey Entries Yet</h3>
                                <p style={{ color: '#666', margin: 0 }}>
                                    Gratitudes, reflections, and breakthroughs will appear here.
                                </p>
                            </div>
                        )}
                    </div>
                )}
            </div>
        );
    }

    function CommunityTab({ supportGroups, topicRooms, pledges, dailyPosts, pirId, currentUser, formatTimeAgo }) {
        const [activeSubTab, setActiveSubTab] = useState('posts');
        const [posts, setPosts] = useState(dailyPosts || []);
        const [loading, setLoading] = useState(false);
        const [moderating, setModerating] = useState(null);
        const [expandedPost, setExpandedPost] = useState(null);
        const [postComments, setPostComments] = useState({});
        const [loadingComments, setLoadingComments] = useState({});

        // Update posts when dailyPosts prop changes
        useEffect(() => {
            setPosts(dailyPosts || []);
        }, [dailyPosts]);

        // Load comments for a post
        const loadComments = async (postId) => {
            if (postComments[postId]) return; // Already loaded
            try {
                setLoadingComments(prev => ({ ...prev, [postId]: true }));
                const snap = await db.collection('dailyPosts').doc(postId)
                    .collection('comments')
                    .orderBy('createdAt', 'desc')
                    .get();
                const comments = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setPostComments(prev => ({ ...prev, [postId]: comments }));
            } catch (error) {
                console.error('Error loading comments:', error);
            } finally {
                setLoadingComments(prev => ({ ...prev, [postId]: false }));
            }
        };

        // Toggle post visibility (hide/unhide)
        const handleToggleVisibility = async (postId, currentHidden) => {
            try {
                setModerating(postId);
                await db.collection('dailyPosts').doc(postId).update({
                    hidden: !currentHidden,
                    moderatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    moderatedBy: currentUser.id,
                    moderatorName: currentUser.displayName || currentUser.email
                });
                setPosts(posts.map(p =>
                    p.id === postId ? { ...p, hidden: !currentHidden } : p
                ));
            } catch (error) {
                console.error('Error toggling post visibility:', error);
                alert('Failed to moderate post: ' + error.message);
            } finally {
                setModerating(null);
            }
        };

        // Delete a comment (moderation action)
        const handleDeleteComment = async (postId, commentId) => {
            if (!confirm('Are you sure you want to delete this comment?')) return;
            try {
                await db.collection('dailyPosts').doc(postId)
                    .collection('comments').doc(commentId).delete();
                setPostComments(prev => ({
                    ...prev,
                    [postId]: prev[postId].filter(c => c.id !== commentId)
                }));
            } catch (error) {
                console.error('Error deleting comment:', error);
                alert('Failed to delete comment: ' + error.message);
            }
        };

        // Calculate stats
        const stats = {
            totalPosts: posts.length,
            reflections: posts.filter(p => p.type === 'reflection').length,
            wins: posts.filter(p => p.type === 'win').length,
            hidden: posts.filter(p => p.hidden).length,
            flagged: posts.filter(p => p.flagged).length,
            totalLikes: posts.reduce((sum, p) => sum + (p.likes?.length || 0), 0),
            totalComments: posts.reduce((sum, p) => sum + (p.commentCount || 0), 0)
        };

        // Sub-tab styles
        const subTabStyle = (isActive) => ({
            padding: '10px 20px',
            background: isActive ? '#4CAF50' : 'transparent',
            color: isActive ? 'white' : '#666',
            border: 'none',
            borderRadius: '6px',
            cursor: 'pointer',
            fontSize: '14px',
            fontWeight: '500',
            transition: 'all 0.2s'
        });

        // Get post type styling
        const getPostTypeStyle = (type) => {
            switch(type) {
                case 'win':
                    return { bg: '#FFD93D20', color: '#B8860B', icon: 'Trophy', label: 'Win' };
                case 'reflection':
                    return { bg: '#9C27B020', color: '#9C27B0', icon: 'Moon', label: 'Reflection' };
                default:
                    return { bg: '#0077CC20', color: '#0077CC', icon: 'MessageCircle', label: 'Post' };
            }
        };

        return (
            <div style={{ padding: '24px' }}>
                {/* Stats Summary */}
                <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(4, 1fr)',
                    gap: '16px',
                    marginBottom: '24px'
                }}>
                    <div style={{
                        background: 'white',
                        borderRadius: '12px',
                        padding: '20px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                        textAlign: 'center'
                    }}>
                        <div style={{ fontSize: '28px', fontWeight: '700', color: '#4CAF50' }}>
                            {stats.totalPosts}
                        </div>
                        <div style={{ fontSize: '13px', color: '#666' }}>Total Posts</div>
                    </div>
                    <div style={{
                        background: 'white',
                        borderRadius: '12px',
                        padding: '20px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                        textAlign: 'center'
                    }}>
                        <div style={{ fontSize: '28px', fontWeight: '700', color: '#FF6B35' }}>
                            {stats.totalLikes}
                        </div>
                        <div style={{ fontSize: '13px', color: '#666' }}>Total Likes</div>
                    </div>
                    <div style={{
                        background: 'white',
                        borderRadius: '12px',
                        padding: '20px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                        textAlign: 'center'
                    }}>
                        <div style={{ fontSize: '28px', fontWeight: '700', color: '#0077CC' }}>
                            {stats.totalComments}
                        </div>
                        <div style={{ fontSize: '13px', color: '#666' }}>Total Comments</div>
                    </div>
                    <div style={{
                        background: 'white',
                        borderRadius: '12px',
                        padding: '20px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                        textAlign: 'center'
                    }}>
                        <div style={{ fontSize: '28px', fontWeight: '700', color: stats.flagged > 0 ? '#DC143C' : '#666' }}>
                            {stats.flagged}
                        </div>
                        <div style={{ fontSize: '13px', color: '#666' }}>Flagged</div>
                    </div>
                </div>

                {/* Post Type Breakdown */}
                <div style={{
                    display: 'flex',
                    gap: '12px',
                    marginBottom: '24px'
                }}>
                    <div style={{
                        flex: 1,
                        background: '#9C27B015',
                        borderRadius: '10px',
                        padding: '16px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px'
                    }}>
                        {AdminIcons.Moon({ size: 24, color: '#9C27B0' })}
                        <div>
                            <div style={{ fontSize: '20px', fontWeight: '600', color: '#9C27B0' }}>{stats.reflections}</div>
                            <div style={{ fontSize: '12px', color: '#666' }}>Reflections</div>
                        </div>
                    </div>
                    <div style={{
                        flex: 1,
                        background: '#FFD93D15',
                        borderRadius: '10px',
                        padding: '16px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px'
                    }}>
                        {AdminIcons.Trophy({ size: 24, color: '#B8860B' })}
                        <div>
                            <div style={{ fontSize: '20px', fontWeight: '600', color: '#B8860B' }}>{stats.wins}</div>
                            <div style={{ fontSize: '12px', color: '#666' }}>Wins Shared</div>
                        </div>
                    </div>
                    <div style={{
                        flex: 1,
                        background: stats.hidden > 0 ? '#DC143C15' : '#f8f9fa',
                        borderRadius: '10px',
                        padding: '16px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px'
                    }}>
                        {AdminIcons.EyeOff({ size: 24, color: stats.hidden > 0 ? '#DC143C' : '#999' })}
                        <div>
                            <div style={{ fontSize: '20px', fontWeight: '600', color: stats.hidden > 0 ? '#DC143C' : '#999' }}>{stats.hidden}</div>
                            <div style={{ fontSize: '12px', color: '#666' }}>Hidden Posts</div>
                        </div>
                    </div>
                </div>

                {/* Sub-tabs */}
                <div style={{
                    display: 'flex',
                    gap: '8px',
                    marginBottom: '24px',
                    background: '#f8f9fa',
                    padding: '6px',
                    borderRadius: '10px',
                    width: 'fit-content'
                }}>
                    {[
                        { id: 'posts', label: 'My Day Posts', icon: 'MessageCircle', count: stats.totalPosts },
                        { id: 'flagged', label: 'Flagged Content', icon: 'Flag', count: stats.flagged },
                        { id: 'groups', label: 'Groups', icon: 'Users', count: supportGroups.length }
                    ].map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveSubTab(tab.id)}
                            style={subTabStyle(activeSubTab === tab.id)}
                        >
                            <span style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                {AdminIcons[tab.icon]({ size: 16 })}
                                {tab.label}
                                {tab.count > 0 && (
                                    <span style={{
                                        background: activeSubTab === tab.id ? 'rgba(255,255,255,0.3)' : (tab.id === 'flagged' && tab.count > 0 ? '#DC143C' : '#e0e0e0'),
                                        color: activeSubTab === tab.id ? 'white' : (tab.id === 'flagged' && tab.count > 0 ? 'white' : '#666'),
                                        padding: '2px 8px',
                                        borderRadius: '10px',
                                        fontSize: '12px'
                                    }}>
                                        {tab.count}
                                    </span>
                                )}
                            </span>
                        </button>
                    ))}
                </div>

                {/* My Day Posts Tab */}
                {activeSubTab === 'posts' && (
                    <div>
                        {posts.length === 0 ? (
                            <div style={{
                                background: 'white',
                                borderRadius: '12px',
                                padding: '60px 40px',
                                textAlign: 'center',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                            }}>
                                {AdminIcons.MessageCircle({ size: 48, color: '#ccc' })}
                                <h3 style={{ margin: '16px 0 8px', color: '#333' }}>No Posts Yet</h3>
                                <p style={{ color: '#666', margin: 0 }}>
                                    This PIR hasn't shared any "My Day" posts in the community.
                                </p>
                            </div>
                        ) : (
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                {posts.map(post => {
                                    const postStyle = getPostTypeStyle(post.type);
                                    const isExpanded = expandedPost === post.id;
                                    const comments = postComments[post.id] || [];
                                    const isLoadingComments = loadingComments[post.id];

                                    return (
                                        <div
                                            key={post.id}
                                            style={{
                                                background: 'white',
                                                borderRadius: '12px',
                                                padding: '20px',
                                                boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                                                border: post.hidden ? '2px solid #DC143C' : post.flagged ? '2px solid #FF6B35' : '1px solid #f0f0f0',
                                                opacity: post.hidden ? 0.7 : 1
                                            }}
                                        >
                                            {/* Post Header */}
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '12px' }}>
                                                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                                    <span style={{
                                                        display: 'inline-flex',
                                                        alignItems: 'center',
                                                        gap: '6px',
                                                        background: postStyle.bg,
                                                        color: postStyle.color,
                                                        padding: '4px 12px',
                                                        borderRadius: '12px',
                                                        fontSize: '12px',
                                                        fontWeight: '500'
                                                    }}>
                                                        {AdminIcons[postStyle.icon]({ size: 14 })}
                                                        {postStyle.label}
                                                    </span>
                                                    {post.anonymous && (
                                                        <span style={{
                                                            background: '#f0f0f0',
                                                            color: '#666',
                                                            padding: '4px 8px',
                                                            borderRadius: '6px',
                                                            fontSize: '11px'
                                                        }}>
                                                            Anonymous
                                                        </span>
                                                    )}
                                                    {post.hidden && (
                                                        <span style={{
                                                            background: '#DC143C',
                                                            color: 'white',
                                                            padding: '4px 8px',
                                                            borderRadius: '6px',
                                                            fontSize: '11px',
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            gap: '4px'
                                                        }}>
                                                            {AdminIcons.EyeOff({ size: 12 })}
                                                            Hidden
                                                        </span>
                                                    )}
                                                    {post.flagged && !post.hidden && (
                                                        <span style={{
                                                            background: '#FF6B35',
                                                            color: 'white',
                                                            padding: '4px 8px',
                                                            borderRadius: '6px',
                                                            fontSize: '11px',
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            gap: '4px'
                                                        }}>
                                                            {AdminIcons.Flag({ size: 12 })}
                                                            Flagged
                                                        </span>
                                                    )}
                                                </div>
                                                <div style={{ fontSize: '12px', color: '#999' }}>
                                                    {post.createdAt?.toDate ?
                                                        formatTimeAgo(post.createdAt.toDate()) :
                                                        formatTimeAgo(new Date(post.createdAt))}
                                                </div>
                                            </div>

                                            {/* Post Content */}
                                            <p style={{ margin: '0 0 16px 0', color: '#333', fontSize: '14px', lineHeight: '1.6' }}>
                                                {post.content}
                                            </p>

                                            {/* Engagement Stats */}
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '20px', marginBottom: '16px' }}>
                                                <span style={{ display: 'flex', alignItems: 'center', gap: '6px', color: '#666', fontSize: '13px' }}>
                                                    {AdminIcons.Heart({ size: 16, color: '#FF6B6B' })}
                                                    {post.likes?.length || 0} likes
                                                </span>
                                                <span style={{ display: 'flex', alignItems: 'center', gap: '6px', color: '#666', fontSize: '13px' }}>
                                                    {AdminIcons.MessageSquare({ size: 16, color: '#0077CC' })}
                                                    {post.commentCount || 0} comments
                                                </span>
                                            </div>

                                            {/* Action Buttons */}
                                            <div style={{ display: 'flex', gap: '8px', paddingTop: '12px', borderTop: '1px solid #f0f0f0' }}>
                                                <button
                                                    onClick={() => {
                                                        if (!isExpanded) loadComments(post.id);
                                                        setExpandedPost(isExpanded ? null : post.id);
                                                    }}
                                                    style={{
                                                        padding: '8px 12px',
                                                        background: '#f8f9fa',
                                                        color: '#666',
                                                        border: 'none',
                                                        borderRadius: '6px',
                                                        cursor: 'pointer',
                                                        fontSize: '13px',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: '6px'
                                                    }}
                                                >
                                                    {AdminIcons.MessageSquare({ size: 14 })}
                                                    {isExpanded ? 'Hide' : 'View'} Comments
                                                </button>
                                                <button
                                                    onClick={() => handleToggleVisibility(post.id, post.hidden)}
                                                    disabled={moderating === post.id}
                                                    style={{
                                                        padding: '8px 12px',
                                                        background: post.hidden ? '#00A86B15' : '#DC143C15',
                                                        color: post.hidden ? '#00A86B' : '#DC143C',
                                                        border: 'none',
                                                        borderRadius: '6px',
                                                        cursor: moderating === post.id ? 'not-allowed' : 'pointer',
                                                        fontSize: '13px',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: '6px',
                                                        opacity: moderating === post.id ? 0.6 : 1
                                                    }}
                                                >
                                                    {post.hidden ?
                                                        <>{AdminIcons.Eye({ size: 14 })} Unhide</> :
                                                        <>{AdminIcons.EyeOff({ size: 14 })} Hide</>
                                                    }
                                                </button>
                                            </div>

                                            {/* Comments Section */}
                                            {isExpanded && (
                                                <div style={{
                                                    marginTop: '16px',
                                                    paddingTop: '16px',
                                                    borderTop: '1px solid #f0f0f0'
                                                }}>
                                                    <h5 style={{ margin: '0 0 12px 0', color: '#333', fontSize: '14px' }}>
                                                        Comments ({comments.length})
                                                    </h5>
                                                    {isLoadingComments ? (
                                                        <div style={{ textAlign: 'center', padding: '20px', color: '#666' }}>
                                                            Loading comments...
                                                        </div>
                                                    ) : comments.length === 0 ? (
                                                        <div style={{ textAlign: 'center', padding: '20px', color: '#999', fontSize: '13px' }}>
                                                            No comments on this post
                                                        </div>
                                                    ) : (
                                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                                                            {comments.map(comment => (
                                                                <div
                                                                    key={comment.id}
                                                                    style={{
                                                                        background: '#f8f9fa',
                                                                        borderRadius: '8px',
                                                                        padding: '12px',
                                                                        display: 'flex',
                                                                        justifyContent: 'space-between',
                                                                        alignItems: 'flex-start'
                                                                    }}
                                                                >
                                                                    <div style={{ flex: 1 }}>
                                                                        <div style={{ fontSize: '12px', color: '#0077CC', fontWeight: '500', marginBottom: '4px' }}>
                                                                            {comment.authorName || 'Anonymous'}
                                                                        </div>
                                                                        <p style={{ margin: 0, fontSize: '13px', color: '#333' }}>
                                                                            {comment.text}
                                                                        </p>
                                                                        <div style={{ fontSize: '11px', color: '#999', marginTop: '6px' }}>
                                                                            {comment.createdAt?.toDate ?
                                                                                formatTimeAgo(comment.createdAt.toDate()) :
                                                                                formatTimeAgo(new Date(comment.createdAt))}
                                                                        </div>
                                                                    </div>
                                                                    <button
                                                                        onClick={() => handleDeleteComment(post.id, comment.id)}
                                                                        style={{
                                                                            padding: '4px 8px',
                                                                            background: '#DC143C15',
                                                                            color: '#DC143C',
                                                                            border: 'none',
                                                                            borderRadius: '4px',
                                                                            cursor: 'pointer',
                                                                            fontSize: '11px'
                                                                        }}
                                                                    >
                                                                        {AdminIcons.Trash2({ size: 12 })}
                                                                    </button>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                )}

                {/* Flagged Content Tab */}
                {activeSubTab === 'flagged' && (
                    <div>
                        {posts.filter(p => p.flagged || p.hidden).length === 0 ? (
                            <div style={{
                                background: 'white',
                                borderRadius: '12px',
                                padding: '60px 40px',
                                textAlign: 'center',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                            }}>
                                {AdminIcons.CheckCircle({ size: 48, color: '#00A86B' })}
                                <h3 style={{ margin: '16px 0 8px', color: '#333' }}>No Flagged Content</h3>
                                <p style={{ color: '#666', margin: 0 }}>
                                    No posts have been flagged or hidden for moderation.
                                </p>
                            </div>
                        ) : (
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                {posts.filter(p => p.flagged || p.hidden).map(post => {
                                    const postStyle = getPostTypeStyle(post.type);
                                    return (
                                        <div
                                            key={post.id}
                                            style={{
                                                background: 'white',
                                                borderRadius: '12px',
                                                padding: '20px',
                                                boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                                                border: post.hidden ? '2px solid #DC143C' : '2px solid #FF6B35'
                                            }}
                                        >
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '12px' }}>
                                                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                                    <span style={{
                                                        background: post.hidden ? '#DC143C' : '#FF6B35',
                                                        color: 'white',
                                                        padding: '4px 12px',
                                                        borderRadius: '6px',
                                                        fontSize: '12px',
                                                        fontWeight: '500',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: '6px'
                                                    }}>
                                                        {post.hidden ?
                                                            <>{AdminIcons.EyeOff({ size: 14 })} Hidden</> :
                                                            <>{AdminIcons.Flag({ size: 14 })} Flagged</>
                                                        }
                                                    </span>
                                                    {post.flagReason && (
                                                        <span style={{ fontSize: '12px', color: '#666' }}>
                                                            Reason: {post.flagReason}
                                                        </span>
                                                    )}
                                                </div>
                                                <div style={{ fontSize: '12px', color: '#999' }}>
                                                    {post.createdAt?.toDate ?
                                                        formatTimeAgo(post.createdAt.toDate()) :
                                                        formatTimeAgo(new Date(post.createdAt))}
                                                </div>
                                            </div>

                                            <p style={{ margin: '0 0 16px 0', color: '#333', fontSize: '14px', lineHeight: '1.6' }}>
                                                {post.content}
                                            </p>

                                            {post.moderatedAt && (
                                                <div style={{
                                                    background: '#f8f9fa',
                                                    borderRadius: '8px',
                                                    padding: '10px',
                                                    marginBottom: '12px',
                                                    fontSize: '12px',
                                                    color: '#666'
                                                }}>
                                                    Moderated by {post.moderatorName || 'Admin'} on{' '}
                                                    {post.moderatedAt?.toDate ?
                                                        post.moderatedAt.toDate().toLocaleDateString() :
                                                        new Date(post.moderatedAt).toLocaleDateString()}
                                                </div>
                                            )}

                                            <button
                                                onClick={() => handleToggleVisibility(post.id, post.hidden)}
                                                disabled={moderating === post.id}
                                                style={{
                                                    padding: '10px 16px',
                                                    background: post.hidden ? 'linear-gradient(135deg, #00A86B 0%, #008B6B 100%)' : '#DC143C',
                                                    color: 'white',
                                                    border: 'none',
                                                    borderRadius: '8px',
                                                    cursor: moderating === post.id ? 'not-allowed' : 'pointer',
                                                    fontSize: '14px',
                                                    fontWeight: '500',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '8px',
                                                    opacity: moderating === post.id ? 0.6 : 1
                                                }}
                                            >
                                                {post.hidden ?
                                                    <>{AdminIcons.Eye({ size: 16 })} Restore Post</> :
                                                    <>{AdminIcons.EyeOff({ size: 16 })} Hide Post</>
                                                }
                                            </button>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                )}

                {/* Groups Tab */}
                {activeSubTab === 'groups' && (
                    <div>
                        {supportGroups.length === 0 ? (
                            <div style={{
                                background: 'white',
                                borderRadius: '12px',
                                padding: '60px 40px',
                                textAlign: 'center',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                            }}>
                                {AdminIcons.Users({ size: 48, color: '#ccc' })}
                                <h3 style={{ margin: '16px 0 8px', color: '#333' }}>No Group Memberships</h3>
                                <p style={{ color: '#666', margin: 0 }}>
                                    This PIR is not a member of any support groups.
                                </p>
                            </div>
                        ) : (
                            <div style={{
                                display: 'grid',
                                gridTemplateColumns: 'repeat(2, 1fr)',
                                gap: '16px'
                            }}>
                                {supportGroups.map(group => (
                                    <div
                                        key={group.id}
                                        style={{
                                            background: 'white',
                                            borderRadius: '12px',
                                            padding: '20px',
                                            boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                                            border: '1px solid #f0f0f0'
                                        }}
                                    >
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px' }}>
                                            <div style={{
                                                width: '40px',
                                                height: '40px',
                                                borderRadius: '10px',
                                                background: '#4CAF5015',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center'
                                            }}>
                                                {AdminIcons.Users({ size: 20, color: '#4CAF50' })}
                                            </div>
                                            <div>
                                                <h4 style={{ margin: 0, color: '#333', fontSize: '15px', fontWeight: '600' }}>
                                                    {group.name || 'Unnamed Group'}
                                                </h4>
                                                <span style={{ fontSize: '12px', color: '#666' }}>
                                                    {group.memberCount || 0} members
                                                </span>
                                            </div>
                                        </div>
                                        {group.description && (
                                            <p style={{ color: '#666', fontSize: '13px', margin: 0, lineHeight: '1.5' }}>
                                                {group.description.substring(0, 100)}
                                                {group.description.length > 100 ? '...' : ''}
                                            </p>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                )}
            </div>
        );
    }

    function FinancialTab({ financialData, pirData, formatDate }) {
        const [activeSubTab, setActiveSubTab] = useState('overview');

        // Extract data
        const savingsItems = financialData?.savingsItems || [];
        const savingsGoals = financialData?.savingsGoals || [];
        const dailyCost = pirData?.dailyCost || 20;
        const sobrietyDays = pirData?.sobrietyDays || 0;

        // Calculate money saved
        const totalSaved = sobrietyDays * dailyCost;
        const weeklyRate = dailyCost * 7;
        const monthlyRate = dailyCost * 30;
        const yearlyRate = dailyCost * 365;

        // Calculate time-based savings
        const daysSober = sobrietyDays;
        const weeksSober = Math.floor(sobrietyDays / 7);
        const monthsSober = Math.floor(sobrietyDays / 30);

        // Format currency
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        };

        // Calculate savings items total
        const savingsItemsTotal = savingsItems.reduce((sum, item) => sum + (item.amount || 0), 0);

        // Calculate goals progress
        const getGoalProgress = (goal) => {
            const saved = goal.currentAmount || 0;
            const target = goal.targetAmount || 1;
            return Math.min(100, Math.round((saved / target) * 100));
        };

        // Sub-tab styles
        const subTabStyle = (isActive) => ({
            padding: '10px 20px',
            background: isActive ? '#00A86B' : 'transparent',
            color: isActive ? 'white' : '#666',
            border: 'none',
            borderRadius: '6px',
            cursor: 'pointer',
            fontSize: '14px',
            fontWeight: '500',
            transition: 'all 0.2s'
        });

        return (
            <div style={{ padding: '24px' }}>
                {/* Money Saved Hero */}
                <div style={{
                    background: 'linear-gradient(135deg, #00A86B 0%, #008B6B 100%)',
                    borderRadius: '16px',
                    padding: '32px',
                    marginBottom: '24px',
                    color: 'white',
                    textAlign: 'center'
                }}>
                    <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '8px' }}>
                        Total Money Saved
                    </div>
                    <div style={{ fontSize: '48px', fontWeight: '700', marginBottom: '8px' }}>
                        {formatCurrency(totalSaved)}
                    </div>
                    <div style={{ fontSize: '14px', opacity: 0.8 }}>
                        Based on ${dailyCost}/day over {sobrietyDays} days of sobriety
                    </div>
                </div>

                {/* Rate Cards */}
                <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(4, 1fr)',
                    gap: '16px',
                    marginBottom: '24px'
                }}>
                    <div style={{
                        background: 'white',
                        borderRadius: '12px',
                        padding: '20px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                        textAlign: 'center'
                    }}>
                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px', marginBottom: '8px' }}>
                            {AdminIcons.Calendar({ size: 20, color: '#0077CC' })}
                            <span style={{ fontSize: '12px', color: '#666' }}>Daily Rate</span>
                        </div>
                        <div style={{ fontSize: '24px', fontWeight: '700', color: '#0077CC' }}>
                            {formatCurrency(dailyCost)}
                        </div>
                    </div>
                    <div style={{
                        background: 'white',
                        borderRadius: '12px',
                        padding: '20px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                        textAlign: 'center'
                    }}>
                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px', marginBottom: '8px' }}>
                            {AdminIcons.Calendar({ size: 20, color: '#9C27B0' })}
                            <span style={{ fontSize: '12px', color: '#666' }}>Weekly</span>
                        </div>
                        <div style={{ fontSize: '24px', fontWeight: '700', color: '#9C27B0' }}>
                            {formatCurrency(weeklyRate)}
                        </div>
                    </div>
                    <div style={{
                        background: 'white',
                        borderRadius: '12px',
                        padding: '20px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                        textAlign: 'center'
                    }}>
                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px', marginBottom: '8px' }}>
                            {AdminIcons.Calendar({ size: 20, color: '#FF6B35' })}
                            <span style={{ fontSize: '12px', color: '#666' }}>Monthly</span>
                        </div>
                        <div style={{ fontSize: '24px', fontWeight: '700', color: '#FF6B35' }}>
                            {formatCurrency(monthlyRate)}
                        </div>
                    </div>
                    <div style={{
                        background: 'white',
                        borderRadius: '12px',
                        padding: '20px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                        textAlign: 'center'
                    }}>
                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px', marginBottom: '8px' }}>
                            {AdminIcons.Calendar({ size: 20, color: '#B8860B' })}
                            <span style={{ fontSize: '12px', color: '#666' }}>Yearly</span>
                        </div>
                        <div style={{ fontSize: '24px', fontWeight: '700', color: '#B8860B' }}>
                            {formatCurrency(yearlyRate)}
                        </div>
                    </div>
                </div>

                {/* Sub-tabs */}
                <div style={{
                    display: 'flex',
                    gap: '8px',
                    marginBottom: '24px',
                    background: '#f8f9fa',
                    padding: '6px',
                    borderRadius: '10px',
                    width: 'fit-content'
                }}>
                    {[
                        { id: 'overview', label: 'Overview', icon: 'PieChart' },
                        { id: 'goals', label: 'Savings Goals', icon: 'Target', count: savingsGoals.length },
                        { id: 'items', label: 'Savings Items', icon: 'Wallet', count: savingsItems.length }
                    ].map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveSubTab(tab.id)}
                            style={subTabStyle(activeSubTab === tab.id)}
                        >
                            <span style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                {AdminIcons[tab.icon]({ size: 16 })}
                                {tab.label}
                                {tab.count !== undefined && (
                                    <span style={{
                                        background: activeSubTab === tab.id ? 'rgba(255,255,255,0.3)' : '#e0e0e0',
                                        padding: '2px 8px',
                                        borderRadius: '10px',
                                        fontSize: '12px'
                                    }}>
                                        {tab.count}
                                    </span>
                                )}
                            </span>
                        </button>
                    ))}
                </div>

                {/* Overview Tab */}
                {activeSubTab === 'overview' && (
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(2, 1fr)',
                        gap: '20px'
                    }}>
                        {/* Savings Breakdown */}
                        <div style={{
                            background: 'white',
                            borderRadius: '12px',
                            padding: '24px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                        }}>
                            <h4 style={{ margin: '0 0 20px 0', color: '#333', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                {AdminIcons.TrendingUp({ size: 20, color: '#00A86B' })}
                                Savings Breakdown
                            </h4>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <span style={{ color: '#666' }}>Today</span>
                                    <span style={{ fontWeight: '600', color: '#333' }}>{formatCurrency(dailyCost)}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <span style={{ color: '#666' }}>This Week ({Math.min(sobrietyDays, 7)} days)</span>
                                    <span style={{ fontWeight: '600', color: '#333' }}>{formatCurrency(Math.min(sobrietyDays, 7) * dailyCost)}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <span style={{ color: '#666' }}>This Month ({Math.min(sobrietyDays, 30)} days)</span>
                                    <span style={{ fontWeight: '600', color: '#333' }}>{formatCurrency(Math.min(sobrietyDays, 30) * dailyCost)}</span>
                                </div>
                                <div style={{ height: '1px', background: '#f0f0f0', margin: '8px 0' }} />
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <span style={{ fontWeight: '600', color: '#333' }}>Total Lifetime Savings</span>
                                    <span style={{ fontWeight: '700', fontSize: '18px', color: '#00A86B' }}>{formatCurrency(totalSaved)}</span>
                                </div>
                            </div>
                        </div>

                        {/* Financial Impact */}
                        <div style={{
                            background: 'white',
                            borderRadius: '12px',
                            padding: '24px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                        }}>
                            <h4 style={{ margin: '0 0 20px 0', color: '#333', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                {AdminIcons.DollarSign({ size: 20, color: '#0077CC' })}
                                Financial Impact
                            </h4>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                <div style={{
                                    padding: '16px',
                                    background: '#0077CC10',
                                    borderRadius: '8px',
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center'
                                }}>
                                    <div>
                                        <div style={{ fontSize: '12px', color: '#666', marginBottom: '4px' }}>Projected 1 Year</div>
                                        <div style={{ fontSize: '20px', fontWeight: '700', color: '#0077CC' }}>{formatCurrency(yearlyRate)}</div>
                                    </div>
                                    {AdminIcons.TrendingUp({ size: 24, color: '#0077CC' })}
                                </div>
                                <div style={{
                                    padding: '16px',
                                    background: '#9C27B010',
                                    borderRadius: '8px',
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center'
                                }}>
                                    <div>
                                        <div style={{ fontSize: '12px', color: '#666', marginBottom: '4px' }}>Projected 5 Years</div>
                                        <div style={{ fontSize: '20px', fontWeight: '700', color: '#9C27B0' }}>{formatCurrency(yearlyRate * 5)}</div>
                                    </div>
                                    {AdminIcons.Award({ size: 24, color: '#9C27B0' })}
                                </div>
                            </div>
                        </div>

                        {/* Quick Stats */}
                        <div style={{
                            gridColumn: 'span 2',
                            background: 'white',
                            borderRadius: '12px',
                            padding: '24px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                        }}>
                            <h4 style={{ margin: '0 0 20px 0', color: '#333', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                {AdminIcons.Activity({ size: 20, color: '#FF6B35' })}
                                Recovery Progress Impact
                            </h4>
                            <div style={{
                                display: 'grid',
                                gridTemplateColumns: 'repeat(4, 1fr)',
                                gap: '16px'
                            }}>
                                <div style={{ textAlign: 'center', padding: '16px', background: '#f8f9fa', borderRadius: '10px' }}>
                                    <div style={{ fontSize: '28px', fontWeight: '700', color: '#00A86B' }}>{daysSober}</div>
                                    <div style={{ fontSize: '12px', color: '#666' }}>Days Sober</div>
                                </div>
                                <div style={{ textAlign: 'center', padding: '16px', background: '#f8f9fa', borderRadius: '10px' }}>
                                    <div style={{ fontSize: '28px', fontWeight: '700', color: '#0077CC' }}>{weeksSober}</div>
                                    <div style={{ fontSize: '12px', color: '#666' }}>Weeks Sober</div>
                                </div>
                                <div style={{ textAlign: 'center', padding: '16px', background: '#f8f9fa', borderRadius: '10px' }}>
                                    <div style={{ fontSize: '28px', fontWeight: '700', color: '#9C27B0' }}>{monthsSober}</div>
                                    <div style={{ fontSize: '12px', color: '#666' }}>Months Sober</div>
                                </div>
                                <div style={{ textAlign: 'center', padding: '16px', background: '#f8f9fa', borderRadius: '10px' }}>
                                    <div style={{ fontSize: '28px', fontWeight: '700', color: '#FF6B35' }}>{savingsGoals.filter(g => getGoalProgress(g) >= 100).length}</div>
                                    <div style={{ fontSize: '12px', color: '#666' }}>Goals Achieved</div>
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                {/* Savings Goals Tab */}
                {activeSubTab === 'goals' && (
                    <div>
                        {savingsGoals.length === 0 ? (
                            <div style={{
                                background: 'white',
                                borderRadius: '12px',
                                padding: '60px 40px',
                                textAlign: 'center',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                            }}>
                                {AdminIcons.Target({ size: 48, color: '#ccc' })}
                                <h3 style={{ margin: '16px 0 8px', color: '#333' }}>No Savings Goals</h3>
                                <p style={{ color: '#666', margin: 0 }}>
                                    This PIR hasn't set any savings goals yet. Goals are managed by the PIR in their app.
                                </p>
                            </div>
                        ) : (
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                {savingsGoals.map(goal => {
                                    const progress = getGoalProgress(goal);
                                    const isComplete = progress >= 100;
                                    return (
                                        <div
                                            key={goal.id}
                                            style={{
                                                background: 'white',
                                                borderRadius: '12px',
                                                padding: '24px',
                                                boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                                                border: isComplete ? '2px solid #00A86B' : '1px solid #f0f0f0'
                                            }}
                                        >
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '16px' }}>
                                                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                                    <div style={{
                                                        width: '48px',
                                                        height: '48px',
                                                        borderRadius: '12px',
                                                        background: isComplete ? '#00A86B' : '#0077CC15',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        justifyContent: 'center'
                                                    }}>
                                                        {isComplete ?
                                                            AdminIcons.CheckCircle({ size: 24, color: 'white' }) :
                                                            AdminIcons.Target({ size: 24, color: '#0077CC' })}
                                                    </div>
                                                    <div>
                                                        <h4 style={{ margin: 0, color: '#333', fontSize: '16px', fontWeight: '600' }}>
                                                            {goal.name || 'Unnamed Goal'}
                                                        </h4>
                                                        {goal.description && (
                                                            <p style={{ margin: '4px 0 0 0', fontSize: '13px', color: '#666' }}>
                                                                {goal.description}
                                                            </p>
                                                        )}
                                                    </div>
                                                </div>
                                                <div style={{ textAlign: 'right' }}>
                                                    <div style={{ fontSize: '20px', fontWeight: '700', color: isComplete ? '#00A86B' : '#333' }}>
                                                        {formatCurrency(goal.currentAmount || 0)}
                                                    </div>
                                                    <div style={{ fontSize: '13px', color: '#666' }}>
                                                        of {formatCurrency(goal.targetAmount || 0)}
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Progress Bar */}
                                            <div style={{ marginBottom: '12px' }}>
                                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '6px' }}>
                                                    <span style={{ fontSize: '12px', color: '#666' }}>Progress</span>
                                                    <span style={{ fontSize: '12px', fontWeight: '600', color: isComplete ? '#00A86B' : '#0077CC' }}>
                                                        {progress}%
                                                    </span>
                                                </div>
                                                <div style={{
                                                    height: '8px',
                                                    background: '#f0f0f0',
                                                    borderRadius: '4px',
                                                    overflow: 'hidden'
                                                }}>
                                                    <div style={{
                                                        height: '100%',
                                                        width: `${progress}%`,
                                                        background: isComplete ?
                                                            'linear-gradient(135deg, #00A86B 0%, #008B6B 100%)' :
                                                            'linear-gradient(135deg, #0077CC 0%, #005A9C 100%)',
                                                        borderRadius: '4px',
                                                        transition: 'width 0.3s'
                                                    }} />
                                                </div>
                                            </div>

                                            {/* Goal Metadata */}
                                            <div style={{ display: 'flex', gap: '16px', fontSize: '12px', color: '#999' }}>
                                                {goal.targetDate && (
                                                    <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                                        {AdminIcons.Calendar({ size: 14 })}
                                                        Target: {formatDate(goal.targetDate)}
                                                    </span>
                                                )}
                                                {goal.createdAt && (
                                                    <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                                        {AdminIcons.Clock({ size: 14 })}
                                                        Created: {formatDate(goal.createdAt)}
                                                    </span>
                                                )}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                )}

                {/* Savings Items Tab */}
                {activeSubTab === 'items' && (
                    <div>
                        {/* Total Summary */}
                        {savingsItems.length > 0 && (
                            <div style={{
                                background: '#0077CC10',
                                borderRadius: '12px',
                                padding: '16px 24px',
                                marginBottom: '20px',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center'
                            }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                    {AdminIcons.Wallet({ size: 24, color: '#0077CC' })}
                                    <span style={{ fontWeight: '500', color: '#333' }}>Total Saved in Items</span>
                                </div>
                                <span style={{ fontSize: '24px', fontWeight: '700', color: '#0077CC' }}>
                                    {formatCurrency(savingsItemsTotal)}
                                </span>
                            </div>
                        )}

                        {savingsItems.length === 0 ? (
                            <div style={{
                                background: 'white',
                                borderRadius: '12px',
                                padding: '60px 40px',
                                textAlign: 'center',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                            }}>
                                {AdminIcons.Wallet({ size: 48, color: '#ccc' })}
                                <h3 style={{ margin: '16px 0 8px', color: '#333' }}>No Savings Items</h3>
                                <p style={{ color: '#666', margin: 0 }}>
                                    This PIR hasn't logged any savings items. Items are managed by the PIR in their app.
                                </p>
                            </div>
                        ) : (
                            <div style={{
                                display: 'grid',
                                gridTemplateColumns: 'repeat(2, 1fr)',
                                gap: '16px'
                            }}>
                                {savingsItems.map(item => (
                                    <div
                                        key={item.id}
                                        style={{
                                            background: 'white',
                                            borderRadius: '12px',
                                            padding: '20px',
                                            boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                                            border: '1px solid #f0f0f0'
                                        }}
                                    >
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                                <div style={{
                                                    width: '40px',
                                                    height: '40px',
                                                    borderRadius: '10px',
                                                    background: '#00A86B15',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center'
                                                }}>
                                                    {AdminIcons.DollarSign({ size: 20, color: '#00A86B' })}
                                                </div>
                                                <div>
                                                    <h4 style={{ margin: 0, color: '#333', fontSize: '15px', fontWeight: '600' }}>
                                                        {item.name || item.description || 'Savings Entry'}
                                                    </h4>
                                                    {item.category && (
                                                        <span style={{
                                                            fontSize: '11px',
                                                            color: '#666',
                                                            background: '#f0f0f0',
                                                            padding: '2px 6px',
                                                            borderRadius: '4px'
                                                        }}>
                                                            {item.category}
                                                        </span>
                                                    )}
                                                </div>
                                            </div>
                                            <div style={{ fontSize: '18px', fontWeight: '700', color: '#00A86B' }}>
                                                {formatCurrency(item.amount || 0)}
                                            </div>
                                        </div>
                                        {item.notes && (
                                            <p style={{ margin: '12px 0 0 0', fontSize: '13px', color: '#666', lineHeight: '1.5' }}>
                                                {item.notes}
                                            </p>
                                        )}
                                        <div style={{ marginTop: '12px', fontSize: '12px', color: '#999' }}>
                                            {item.createdAt && (
                                                <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                                    {AdminIcons.Clock({ size: 12 })}
                                                    {formatDate(item.createdAt)}
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* Info Note */}
                        <div style={{
                            marginTop: '20px',
                            padding: '16px',
                            background: '#f8f9fa',
                            borderRadius: '8px',
                            display: 'flex',
                            alignItems: 'flex-start',
                            gap: '12px'
                        }}>
                            {AdminIcons.Info({ size: 20, color: '#666' })}
                            <div style={{ fontSize: '13px', color: '#666', lineHeight: '1.5' }}>
                                <strong>View Only:</strong> Savings items are managed by the PIR through their app.
                                Coaches can view financial progress but cannot add or modify savings entries.
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    function DocumentationTab({ documentationData, pirId, currentUser, formatDateTime }) {
        const [activeSubTab, setActiveSubTab] = useState('intake');

        // Document counts (placeholder for future data integration)
        const docCounts = {
            intake: documentationData?.intake?.length || 0,
            progressNotes: documentationData?.progressNotes?.length || 0,
            discharge: documentationData?.discharge?.length || 0,
            other: documentationData?.other?.length || 0
        };

        const subTabs = [
            { id: 'intake', label: 'Intake', icon: AdminIcons.FileText, count: docCounts.intake },
            { id: 'progressNotes', label: 'Progress Notes', icon: AdminIcons.ClipboardCheck, count: docCounts.progressNotes },
            { id: 'discharge', label: 'Discharge', icon: AdminIcons.FileCheck, count: docCounts.discharge },
            { id: 'other', label: 'Other', icon: AdminIcons.Folder, count: docCounts.other }
        ];

        // Placeholder component for document sections
        const DocumentPlaceholder = ({ type, icon: Icon, description }) => (
            <div style={{
                background: 'white',
                borderRadius: '12px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                overflow: 'hidden'
            }}>
                {/* Header */}
                <div style={{
                    padding: '20px 24px',
                    borderBottom: '1px solid #f0f0f0',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center'
                }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                        {Icon({ size: 20, color: '#0077CC' })}
                        <h3 style={{ margin: 0, fontSize: '16px', color: '#333', fontWeight: '600' }}>
                            {type} Documents
                        </h3>
                    </div>
                    <button
                        disabled
                        style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px',
                            padding: '8px 16px',
                            background: '#f5f5f5',
                            color: '#999',
                            border: '1px solid #e0e0e0',
                            borderRadius: '8px',
                            fontSize: '13px',
                            fontWeight: '500',
                            cursor: 'not-allowed'
                        }}
                    >
                        {AdminIcons.Upload({ size: 16, color: '#999' })}
                        Upload Document
                    </button>
                </div>

                {/* Empty State */}
                <div style={{
                    padding: '60px 40px',
                    textAlign: 'center'
                }}>
                    <div style={{
                        width: '80px',
                        height: '80px',
                        borderRadius: '50%',
                        background: '#f8f9fa',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        margin: '0 auto 20px'
                    }}>
                        {Icon({ size: 36, color: '#607D8B' })}
                    </div>
                    <h4 style={{ margin: '0 0 8px', color: '#333', fontSize: '16px', fontWeight: '600' }}>
                        No {type} Documents
                    </h4>
                    <p style={{ color: '#666', margin: '0 0 16px', fontSize: '14px', maxWidth: '400px', marginLeft: 'auto', marginRight: 'auto' }}>
                        {description}
                    </p>
                    <div style={{
                        display: 'inline-flex',
                        alignItems: 'center',
                        gap: '8px',
                        padding: '10px 20px',
                        background: 'linear-gradient(135deg, #E3F2FD 0%, #F3E5F5 100%)',
                        borderRadius: '8px',
                        color: '#5E35B1',
                        fontSize: '13px',
                        fontWeight: '500'
                    }}>
                        {AdminIcons.Clock({ size: 16, color: '#5E35B1' })}
                        Coming Soon - Document Upload & Templates
                    </div>
                </div>

                {/* Future Features Preview */}
                <div style={{
                    padding: '20px 24px',
                    borderTop: '1px solid #f0f0f0',
                    background: '#fafafa'
                }}>
                    <div style={{ fontSize: '12px', color: '#666', marginBottom: '12px', fontWeight: '500' }}>
                        Planned Features:
                    </div>
                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
                        {['Template Selection', 'Auto-fill from Profile', 'E-signature', 'PDF Export', 'Version History'].map(feature => (
                            <span key={feature} style={{
                                padding: '4px 10px',
                                background: 'white',
                                border: '1px solid #e0e0e0',
                                borderRadius: '12px',
                                fontSize: '11px',
                                color: '#666'
                            }}>
                                {feature}
                            </span>
                        ))}
                    </div>
                </div>
            </div>
        );

        // Document type descriptions
        const docDescriptions = {
            intake: 'Initial assessment forms, consent documents, and admission paperwork will appear here when the Templates system is integrated.',
            progressNotes: 'Session notes, treatment updates, and progress documentation will be organized chronologically here.',
            discharge: 'Discharge summaries, aftercare plans, and completion certificates will be stored in this section.',
            other: 'Additional documents, correspondence, and miscellaneous files can be uploaded and categorized here.'
        };

        return (
            <div style={{ padding: '30px' }}>
                {/* Sub-tab Navigation */}
                <div style={{
                    display: 'flex',
                    gap: '8px',
                    marginBottom: '24px',
                    background: 'white',
                    padding: '8px',
                    borderRadius: '12px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                }}>
                    {subTabs.map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveSubTab(tab.id)}
                            style={{
                                flex: 1,
                                padding: '12px 16px',
                                background: activeSubTab === tab.id ? '#0077CC' : 'transparent',
                                color: activeSubTab === tab.id ? 'white' : '#666',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '8px',
                                fontWeight: activeSubTab === tab.id ? '600' : '500',
                                transition: 'all 0.2s'
                            }}
                        >
                            {tab.icon({ size: 18, color: activeSubTab === tab.id ? 'white' : '#666' })}
                            {tab.label}
                            <span style={{
                                background: activeSubTab === tab.id ? 'rgba(255,255,255,0.2)' : '#e0e0e0',
                                padding: '2px 8px',
                                borderRadius: '10px',
                                fontSize: '12px'
                            }}>
                                {tab.count}
                            </span>
                        </button>
                    ))}
                </div>

                {/* INTAKE SUB-TAB */}
                {activeSubTab === 'intake' && (
                    <DocumentPlaceholder
                        type="Intake"
                        icon={AdminIcons.FileText}
                        description={docDescriptions.intake}
                    />
                )}

                {/* PROGRESS NOTES SUB-TAB */}
                {activeSubTab === 'progressNotes' && (
                    <DocumentPlaceholder
                        type="Progress Notes"
                        icon={AdminIcons.ClipboardCheck}
                        description={docDescriptions.progressNotes}
                    />
                )}

                {/* DISCHARGE SUB-TAB */}
                {activeSubTab === 'discharge' && (
                    <DocumentPlaceholder
                        type="Discharge"
                        icon={AdminIcons.FileCheck}
                        description={docDescriptions.discharge}
                    />
                )}

                {/* OTHER SUB-TAB */}
                {activeSubTab === 'other' && (
                    <DocumentPlaceholder
                        type="Other"
                        icon={AdminIcons.Folder}
                        description={docDescriptions.other}
                    />
                )}

                {/* Integration Info Card */}
                <div style={{
                    marginTop: '24px',
                    background: 'linear-gradient(135deg, #E8F5E9 0%, #E3F2FD 100%)',
                    borderRadius: '12px',
                    padding: '20px 24px',
                    border: '1px solid #C8E6C9'
                }}>
                    <div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>
                        <div style={{
                            width: '40px',
                            height: '40px',
                            borderRadius: '10px',
                            background: 'white',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            flexShrink: 0
                        }}>
                            {AdminIcons.Link({ size: 20, color: '#2E7D32' })}
                        </div>
                        <div>
                            <h4 style={{ margin: '0 0 6px', color: '#1B5E20', fontSize: '14px', fontWeight: '600' }}>
                                Templates Integration
                            </h4>
                            <p style={{ margin: 0, color: '#2E7D32', fontSize: '13px', lineHeight: '1.5' }}>
                                This Documentation tab will sync with the Templates system when built.
                                Templates created in Settings will be available for document generation here,
                                with auto-population of client data and e-signature capabilities.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    function ActivityTab({ activities, formatTimeAgo }) {
        const getActivityIcon = (type) => {
            const icons = {
                'check_in': AdminIcons.CheckCircle,
                'assignment_completed': AdminIcons.FileText,
                'goal_completed': AdminIcons.Target,
                'message_sent': AdminIcons.MessageSquare,
                'sos_triggered': AdminIcons.AlertTriangle,
                'login': AdminIcons.LogIn,
                'profile_updated': AdminIcons.User,
                'resource_viewed': AdminIcons.BookOpen,
                'milestone_achieved': AdminIcons.Trophy
            };
            const Icon = icons[type] || AdminIcons.Activity;
            return Icon;
        };

        const getActivityColor = (type) => {
            const colors = {
                'check_in': '#00A86B',
                'assignment_completed': '#0077CC',
                'goal_completed': '#FF9800',
                'message_sent': '#9C27B0',
                'sos_triggered': '#DC143C',
                'login': '#2196F3',
                'profile_updated': '#607D8B'
            };
            return colors[type] || '#999';
        };

        return (
            <div style={{ padding: '30px' }}>
                <div style={{
                    background: 'white',
                    borderRadius: '12px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                    overflow: 'hidden'
                }}>
                    <div style={{
                        padding: '20px 24px',
                        borderBottom: '1px solid #f0f0f0',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '10px'
                    }}>
                        {AdminIcons.Activity({ size: 20, color: '#0077CC' })}
                        <h3 style={{ margin: 0, fontSize: '16px', color: '#333', fontWeight: '600' }}>
                            Activity Log ({activities.length})
                        </h3>
                    </div>

                    {activities.length > 0 ? (
                        <div>
                            {activities.map((activity, i) => {
                                const Icon = getActivityIcon(activity.type);
                                const color = getActivityColor(activity.type);
                                return (
                                    <div key={activity.id} style={{
                                        padding: '16px 24px',
                                        borderBottom: i < activities.length - 1 ? '1px solid #f0f0f0' : 'none',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '16px'
                                    }}>
                                        <div style={{
                                            width: '40px',
                                            height: '40px',
                                            borderRadius: '50%',
                                            background: color + '15',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            flexShrink: 0
                                        }}>
                                            {Icon({ size: 18, color })}
                                        </div>
                                        <div style={{ flex: 1 }}>
                                            <div style={{ fontWeight: '500', color: '#333', marginBottom: '2px' }}>
                                                {activity.type?.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) || 'Activity'}
                                            </div>
                                            <div style={{ fontSize: '13px', color: '#666' }}>
                                                {activity.description || activity.message || 'No details'}
                                            </div>
                                        </div>
                                        <div style={{ fontSize: '13px', color: '#999', flexShrink: 0 }}>
                                            {formatTimeAgo(activity.createdAt)}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    ) : (
                        <div style={{ textAlign: 'center', padding: '60px', color: '#666' }}>
                            {AdminIcons.Inbox({ size: 48, color: '#ccc' })}
                            <div style={{ marginTop: '12px' }}>No activity recorded yet</div>
                        </div>
                    )}
                </div>
            </div>
        );
    }

    // Render the app
    ReactDOM.render(<UserDetailPage />, document.getElementById('root'));

})(); // End initPage
    </script>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</body>
</html>
