<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alerts - GLRS Admin Portal</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Shared Styles -->
    <link rel="stylesheet" href="/admin/shared/styles.css">
</head>
<body>
    <div id="root"></div>

    <!-- Shared Components -->
    <script src="/admin/shared/firebase.js"></script>
    <script src="/admin/shared/auth.js"></script>
    <script src="/admin/shared/permissions.js"></script>
    <script src="/admin/shared/utils.js"></script>
    <script src="/admin/shared/state.js?v=2"></script>
    <script src="/admin/shared/icons.js"></script>
    <script type="text/babel" src="/admin/shared/navigation.js?v=8"></script>
    <script type="text/babel" src="/admin/shared/header.js?v=1"></script>

    <!-- Page Component -->
    <script type="text/babel">
        // Wait for Firebase to initialize before running
(function initPage() {
    if (!window.FIREBASE_READY || !window.auth || !window.db) {
        console.log('Waiting for Firebase to initialize...');
        setTimeout(initPage, 50);
        return;
    }

    const { useState, useEffect, useRef, useMemo, useCallback } = React;
    const { auth, db, storage, CURRENT_TENANT, logAudit } = window;

        // ==================== PAGINATION COMPONENT ====================
        function Pagination({ currentPage, totalPages, onPageChange }) {
            return (
                <div className="pagination">
                    <button
                        className="page-btn"
                        onClick={() => onPageChange(currentPage - 1)}
                        disabled={currentPage === 1}
                    >
                        Previous
                    </button>

                    {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                        let pageNum;
                        if (totalPages <= 5) {
                            pageNum = i + 1;
                        } else if (currentPage <= 3) {
                            pageNum = i + 1;
                        } else if (currentPage >= totalPages - 2) {
                            pageNum = totalPages - 4 + i;
                        } else {
                            pageNum = currentPage - 2 + i;
                        }

                        return (
                            <button
                                key={pageNum}
                                className={`page-btn ${currentPage === pageNum ? 'active' : ''}`}
                                onClick={() => onPageChange(pageNum)}
                            >
                                {pageNum}
                            </button>
                        );
                    })}

                    <button
                        className="page-btn"
                        onClick={() => onPageChange(currentPage + 1)}
                        disabled={currentPage === totalPages}
                    >
                        Next
                    </button>
                </div>
            );
        }

        // ==================== ALERT DETAIL MODAL ====================
        function AlertDetailModal({ alert, onClose, onResolve, getPriorityColor }) {
            const [notes, setNotes] = useState('');
            const [resolving, setResolving] = useState(false);

            const handleResolve = async () => {
                setResolving(true);
                await onResolve(alert.id, notes);
                setResolving(false);
                onClose();
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">
                                {alert.type === 'sos' ? 'üö® SOS ALERT' : 'Alert Details'}
                            </div>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>

                        <div style={{marginBottom: '20px'}}>
                            <strong>User:</strong> {alert.userName}<br />
                            <strong>Type:</strong> {alert.type}<br />
                            <strong>Priority:</strong> {alert.priority || 'Normal'}<br />
                            <strong>Created:</strong> {formatDateTime(alert.createdAt)}<br />
                            <strong>Status:</strong> {alert.resolved ? 'Resolved' : 'Active'}
                        </div>

                        <div style={{marginBottom: '20px', padding: '15px', background: 'rgba(255,255,255,0.05)', borderRadius: '10px'}}>
                            <strong>Message:</strong><br />
                            {alert.message}
                        </div>

                        {alert.resolved && alert.resolutionNotes && (
                            <div style={{marginBottom: '20px', padding: '15px', background: 'rgba(76,175,80,0.1)', borderRadius: '10px'}}>
                                <strong>Resolution Notes:</strong><br />
                                {alert.resolutionNotes}<br />
                                <small>Resolved at: {formatDateTime(alert.resolvedAt)}</small>
                            </div>
                        )}

                        {!alert.resolved && (
                            <>
                                <div className="form-group">
                                    <label className="form-label">Resolution Notes (optional)</label>
                                    <textarea
                                        className="form-input"
                                        value={notes}
                                        onChange={(e) => setNotes(e.target.value)}
                                        rows="3"
                                    />
                                </div>

                                <button
                                    className="btn btn-success"
                                    onClick={handleResolve}
                                    disabled={resolving}
                                >
                                    {resolving ? 'Resolving...' : 'Mark as Resolved'}
                                </button>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        // ==================== ALERTS VIEW ====================
        function AlertsView({ searchQuery, user }) {
    const [alerts, setAlerts] = useState([]);
    const [filteredAlerts, setFilteredAlerts] = useState([]);
    const [loading, setLoading] = useState(true);
    const [currentPage, setCurrentPage] = useState(1);
    const [filterType, setFilterType] = useState('all');
    const [filterPriority, setFilterPriority] = useState('all');
    const [filterResolved, setFilterResolved] = useState('unresolved');
    const [selectedAlert, setSelectedAlert] = useState(null);
    const [stats, setStats] = useState({
        total: 0,
        active: 0,
        critical: 0,
        sos: { count: 0, avgResponseTime: 0 },
        missedCheckin: { count: 0, avgResponseTime: 0 },
        highCraving: { count: 0, avgResponseTime: 0 },
        customThreshold: { count: 0 }
    });
    const [frequencyData, setFrequencyData] = useState([]);
    const frequencyChartRef = useRef(null);
    const chartInstance = useRef(null);
    const itemsPerPage = 20;

    useEffect(() => {
        loadAlerts();

        // Real-time SOS listener
        const unsubscribe = db.collection('alerts')
            .where('type', '==', 'sos')
            .where('status', '==', 'active')
            .onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const alert = { id: change.doc.id, ...change.doc.data() };

                        const alertTime = alert.createdAt?.toDate ? alert.createdAt.toDate() : new Date(alert.createdAt);
                        const now = new Date();
                        const secondsAgo = (now - alertTime) / 1000;

                        if (secondsAgo < 10) {
                            console.log('üö® NEW SOS ALERT DETECTED:', alert.id);
                            handleNewSOSAlert(alert);
                        }
                    }
                });
            });

        return () => {
            unsubscribe();
            if (chartInstance.current) {
                chartInstance.current.destroy();
            }
        };
    }, []);

    useEffect(() => {
        filterAlerts();
        calculateStats();
        prepareFrequencyData();
    }, [alerts, filterType, filterPriority, filterResolved, searchQuery]);

    useEffect(() => {
        if (frequencyData.length > 0) {
            renderFrequencyChart();
        }
    }, [frequencyData]);

    const handleNewSOSAlert = async (alert) => {
        try {
            console.log('üö® Processing SOS alert for notifications...');
            showBrowserNotification(alert);

            const pirDoc = await db.collection('users').doc(alert.userId).get();
            if (!pirDoc.exists) {
                console.error('‚ùå PIR not found:', alert.userId);
                return;
            }

            const pirData = pirDoc.data();
            console.log('üë§ PIR data loaded:', pirData.email);

            if (pirData.assignedCoach !== user.uid) {
                console.log('‚ö†Ô∏è This PIR is not assigned to current coach - skipping email');
                return;
            }

            const coachDoc = await db.collection('users').doc(user.uid).get();
            const coachData = coachDoc.data();
            const coachEmail = coachData.email;

            console.log('üìß Sending SOS email via Firebase Extension to:', coachEmail);

            await db.collection('mail').add({
                to: [coachEmail],
                message: {
                    subject: 'üö® URGENT: SOS Alert from ' + (pirData.displayName || pirData.firstName || pirData.email),
                    html: `
                        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                            <div style="background: #dc2626; color: white; padding: 20px; border-radius: 8px 8px 0 0;">
                                <h1 style="margin: 0; font-size: 24px;">üö® SOS ALERT</h1>
                            </div>

                            <div style="background: #f9fafb; padding: 20px; border: 1px solid #e5e7eb;">
                                <h2 style="color: #dc2626; margin-top: 0;">Person in Recovery Needs Help</h2>

                                <div style="background: white; padding: 15px; border-radius: 8px; margin: 15px 0;">
                                    <p style="margin: 5px 0;"><strong>Name:</strong> ${pirData.displayName || pirData.firstName || 'Not provided'}</p>
                                    <p style="margin: 5px 0;"><strong>Email:</strong> ${pirData.email}</p>
                                    <p style="margin: 5px 0;"><strong>Phone:</strong> ${pirData.phone || 'Not provided'}</p>
                                    <p style="margin: 5px 0;"><strong>Time:</strong> ${new Date(alert.timestamp?.toDate ? alert.timestamp.toDate() : Date.now()).toLocaleString()}</p>
                                </div>

                                ${alert.message ? `
                                <div style="background: #fef2f2; padding: 15px; border-left: 4px solid #dc2626; margin: 15px 0;">
                                    <p style="margin: 0;"><strong>Message:</strong></p>
                                    <p style="margin: 10px 0 0 0;">${alert.message}</p>
                                </div>
                                ` : ''}

                                <div style="background: #fffbeb; padding: 15px; border-radius: 8px; margin: 15px 0;">
                                    <p style="margin: 0; color: #92400e;">
                                        <strong>‚ö†Ô∏è Action Required:</strong> Please contact this person immediately.
                                    </p>
                                </div>

                                <div style="text-align: center; margin-top: 20px;">
                                    <a href="app.glrecoveryservices.com/admin.html"
                                       style="background: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">
                                        View in Coach Portal
                                    </a>
                                </div>
                            </div>

                            <div style="background: #f3f4f6; padding: 15px; text-align: center; font-size: 12px; color: #6b7280; border-radius: 0 0 8px 8px;">
                                <p style="margin: 0;">Guiding Light Recovery Services</p>
                                <p style="margin: 5px 0 0 0;">Automated alert system</p>
                            </div>
                        </div>
                    `,
                    text: `üö® SOS ALERT - ${pirData.displayName || pirData.firstName || pirData.email}\n\nA person in recovery has triggered an SOS alert and needs immediate assistance.\n\nName: ${pirData.displayName || pirData.firstName || 'Not provided'}\nEmail: ${pirData.email}\nPhone: ${pirData.phone || 'Not provided'}\nTime: ${new Date(alert.timestamp?.toDate ? alert.timestamp.toDate() : Date.now()).toLocaleString()}\n${alert.message ? `\nMessage: ${alert.message}` : ''}\n\n‚ö†Ô∏è Please contact this person immediately.\n\nView details: app.glrecoveryservices.com/admin.html\n\n---\nGuiding Light Recovery Services\nAutomated alert system`
                }
            });

            console.log('‚úÖ SOS email queued successfully!');

            await db.collection('alerts').doc(alert.id).update({
                emailSent: true,
                emailSentAt: firebase.firestore.FieldValue.serverTimestamp(),
                emailSentTo: coachEmail
            });

            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('üö® SOS EMAIL SENT', {
                    body: `Emergency alert from ${pirData.displayName || pirData.email}\n\n‚úì Email notification sent to your inbox`,
                    icon: '/favicon.ico',
                    requireInteraction: true,
                    tag: 'sos-email-sent'
                });
            }

            await createInAppNotification(alert, pirData);

            console.log('‚úÖ SOS alert processing complete');

        } catch (error) {
            console.error('‚ùå Error handling SOS alert:', error);

            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('üö® SOS ALERT - Email Failed', {
                    body: `Emergency alert detected but email failed to send.\n\nError: ${error.message}\n\nCheck Alerts tab immediately!`,
                    icon: '/favicon.ico',
                    requireInteraction: true,
                    tag: 'sos-email-failed'
                });
            }
        }
    };

    const showBrowserNotification = (alert) => {
        if ('Notification' in window) {
            if (Notification.permission === 'granted') {
                new Notification('üö® SOS ALERT', {
                    body: `Emergency alert detected - Processing...`,
                    icon: '/favicon.ico',
                    requireInteraction: true,
                    tag: 'sos-alert'
                });
            } else if (Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }
    };

    const createInAppNotification = async (alert, pirData) => {
        await createNotificationWithPreferences({
            type: 'sos',
            title: 'üö® EMERGENCY: SOS Alert',
            message: `${pirData.displayName || pirData.email} has triggered an SOS alert`,
            recipientId: user.uid,
            relatedId: alert.id,
            urgent: true,
            read: false
        }, 'sos');
    };

    const loadAlerts = async () => {
        try {
            // üîê SCOPE FILTERING: First, get PIRs user can see
            let pirQuery = db.collection('users').where('role', '==', 'pir');
            pirQuery = window.applyScopeToPIRQuery(pirQuery, user, CURRENT_TENANT);
            const pirsSnap = await pirQuery.get();

            const allowedPIRIds = new Set();
            pirsSnap.forEach(doc => {
                allowedPIRIds.add(doc.id);
            });

            // Load all alerts (note: ideally alerts should have tenantId for better filtering)
            const alertsSnap = await db.collection('alerts')
                .orderBy('createdAt', 'desc')
                .get();

            const alertsData = [];
            const userIds = new Set();

            // üîê Filter alerts to only those for PIRs in scope
            alertsSnap.forEach(doc => {
                const alert = { id: doc.id, ...doc.data() };

                // Only include alerts for PIRs the user can see
                if (alert.userId && allowedPIRIds.has(alert.userId)) {
                    alertsData.push(alert);
                    userIds.add(alert.userId);
                }
            });

            if (userIds.size > 0) {
                const userResults = await batchQuery('users',
                    firebase.firestore.FieldPath.documentId(),
                    Array.from(userIds)
                );

                const userMap = {};
                userResults.forEach(user => {
                    userMap[user.id] = user.displayName || user.email;
                });

                alertsData.forEach(alert => {
                    alert.userName = userMap[alert.userId] || 'Unknown User';
                });
            }

            setAlerts(alertsData);
            setFilteredAlerts(alertsData);
        } catch (error) {
            console.error('Error loading alerts:', error);
            alert('Failed to load alerts');
        } finally {
            setLoading(false);
        }
    };

    const formatResponseTime = (minutes) => {
        if (minutes === 0) return '0m';
        const hours = Math.floor(minutes / 60);
        const mins = Math.round(minutes % 60);
        if (hours === 0) return `${mins}m`;
        if (mins === 0) return `${hours}h`;
        return `${hours}h ${mins}m`;
    };

    const calculateStats = () => {
        const total = alerts.length;
        const active = alerts.filter(a => a.status === 'active').length;
        const critical = alerts.filter(a => a.severity === 'critical' && a.status === 'active').length;

        const calculateTypeStats = (type) => {
            const typeAlerts = alerts.filter(a => a.type === type);
            const resolvedTypeAlerts = typeAlerts.filter(a => a.resolved && a.createdAt && a.resolvedAt);

            let totalMinutes = 0;
            resolvedTypeAlerts.forEach(alert => {
                const created = alert.createdAt.toDate ? alert.createdAt.toDate() : new Date(alert.createdAt);
                const resolved = alert.resolvedAt.toDate ? alert.resolvedAt.toDate() : new Date(alert.resolvedAt);
                const minutes = (resolved - created) / 1000 / 60;
                totalMinutes += minutes;
            });

            return {
                count: typeAlerts.length,
                avgResponseTime: resolvedTypeAlerts.length > 0
                    ? Math.round(totalMinutes / resolvedTypeAlerts.length)
                    : 0
            };
        };

        const sos = calculateTypeStats('sos');
        const missedCheckin = calculateTypeStats('missed_checkin');
        const highCraving = calculateTypeStats('high_craving');
        const customThreshold = { count: alerts.filter(a => a.type === 'custom' || a.type === 'system').length };

        setStats({
            total,
            active,
            critical,
            sos,
            missedCheckin,
            highCraving,
            customThreshold
        });
    };

    const prepareFrequencyData = () => {
        const last7Days = [];
        const counts = [];

        for (let i = 6; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            date.setHours(0, 0, 0, 0);

            const nextDay = new Date(date);
            nextDay.setDate(nextDay.getDate() + 1);

            const dayAlerts = alerts.filter(alert => {
                const alertDate = alert.createdAt?.toDate ? alert.createdAt.toDate() : new Date(alert.createdAt);
                return alertDate >= date && alertDate < nextDay;
            });

            last7Days.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
            counts.push(dayAlerts.length);
        }

        setFrequencyData({ labels: last7Days, data: counts });
    };

    const renderFrequencyChart = () => {
        if (chartInstance.current) {
            chartInstance.current.destroy();
        }

        const ctx = frequencyChartRef.current?.getContext('2d');
        if (ctx) {
            chartInstance.current = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: frequencyData.labels,
                    datasets: [{
                        label: 'Alerts',
                        data: frequencyData.data,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: '#0077CC',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
    };

    const filterAlerts = () => {
        let filtered = alerts;

        if (filterType !== 'all') {
            filtered = filtered.filter(alert => alert.type === filterType);
        }

        if (filterPriority !== 'all') {
            filtered = filtered.filter(alert => alert.priority === filterPriority);
        }

        if (filterResolved === 'resolved') {
            filtered = filtered.filter(alert => alert.resolved);
        } else if (filterResolved === 'unresolved') {
            filtered = filtered.filter(alert => !alert.resolved);
        }

        if (searchQuery) {
            const query = searchQuery.toLowerCase();
            filtered = filtered.filter(alert =>
                alert.userName?.toLowerCase().includes(query) ||
                alert.message?.toLowerCase().includes(query) ||
                alert.type?.toLowerCase().includes(query)
            );
        }

        setFilteredAlerts(filtered);
        setCurrentPage(1);
    };

    const handleQuickResolve = async (alertId) => {
        try {
            await db.collection('alerts').doc(alertId).update({
                resolved: true,
                status: 'resolved',
                resolvedBy: user.uid,
                resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                resolutionNotes: 'Quick resolved'
            });

            setAlerts(prev => prev.map(a =>
                a.id === alertId ? { ...a, resolved: true, status: 'resolved', resolutionNotes: 'Quick resolved' } : a
            ));
        } catch (error) {
            console.error('Error quick resolving:', error);
            alert('Failed to resolve alert');
        }
    };

    const handleResolve = async (alertId, notes = '') => {
        try {
            await db.collection('alerts').doc(alertId).update({
                resolved: true,
                status: 'resolved',
                resolvedBy: user.uid,
                resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                resolutionNotes: notes
            });

            setAlerts(prev => prev.map(a =>
                a.id === alertId ? { ...a, resolved: true, status: 'resolved', resolutionNotes: notes } : a
            ));

            alert('Alert resolved successfully');
        } catch (error) {
            console.error('Error resolving alert:', error);
            alert('Failed to resolve alert');
        }
    };

    const handleDelete = async (alertId) => {
        if (!confirm('Are you sure you want to delete this alert?')) return;

        try {
            await db.collection('alerts').doc(alertId).delete();
            setAlerts(prev => prev.filter(a => a.id !== alertId));
            alert('Alert deleted');
        } catch (error) {
            console.error('Error deleting alert:', error);
            alert('Failed to delete alert');
        }
    };

    const getPriorityColor = (priority) => {
        if (priority === 'critical') return '#f44336';
        if (priority === 'high') return '#FF9800';
        if (priority === 'medium') return '#FFC107';
        return '#00A86B';
    };

    const paginatedAlerts = useMemo(() => {
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        return filteredAlerts.slice(start, end);
    }, [filteredAlerts, currentPage]);

    const totalPages = Math.ceil(filteredAlerts.length / itemsPerPage);

    const handleExport = (format) => {
        const exportData = filteredAlerts.map(alert => ({
            user: alert.userName,
            type: alert.type,
            priority: alert.priority || 'Normal',
            message: alert.message,
            status: alert.resolved ? 'Resolved' : 'Active',
            createdAt: formatDateTime(alert.createdAt),
            resolvedAt: alert.resolvedAt ? formatDateTime(alert.resolvedAt) : 'N/A',
            resolutionNotes: alert.resolutionNotes || 'N/A',
            emailSent: alert.emailSent ? 'Yes' : 'No'
        }));

        if (format === 'json') {
            exportToJSON(exportData, 'alerts');
        } else if (format === 'csv') {
            exportToCSV(exportData, 'alerts');
        } else if (format === 'pdf') {
            exportToPDF(exportData, 'Alerts Report');
        }
    };

    if (loading) {
        return (
            <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                minHeight: '400px',
                gap: '20px'
            }}>
                <div style={{
                    width: '60px',
                    height: '60px',
                    border: '4px solid #f3f3f3',
                    borderTop: '4px solid #0077CC',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite'
                }}></div>
                <p style={{ color: '#666' }}>Loading alerts...</p>
            </div>
        );
    }

    return (
        <div style={{ padding: '20px', animation: 'fadeIn 0.5s' }}>
            {/* Stats Cards */}
            <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(240px, 1fr))',
                gap: '20px',
                marginBottom: '30px'
            }}>
                {/* Total Alerts */}
                <div style={{
                    background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(102, 126, 234, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Total Alerts</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.total}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>All time</div>
                </div>

                {/* Active Alerts */}
                <div style={{
                    background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(240, 147, 251, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Active Alerts</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.active}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Need attention</div>
                </div>

                {/* SOS Alerts */}
                <div style={{
                    background: 'linear-gradient(135deg, #ff4444 0%, #cc0000 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(255, 68, 68, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9, display: 'flex', alignItems: 'center', gap: '5px' }}>
                        <span>üö®</span> SOS Alerts
                    </div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.sos.count}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>
                        Avg response: {formatResponseTime(stats.sos.avgResponseTime)}
                    </div>
                </div>

                {/* Missed Check-ins */}
                <div style={{
                    background: 'linear-gradient(135deg, #FF9800 0%, #FF6B00 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(255, 152, 0, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9, display: 'flex', alignItems: 'center', gap: '5px' }}>
                        <span>‚è∞</span> Missed Check-ins
                    </div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.missedCheckin.count}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>
                        Avg response: {formatResponseTime(stats.missedCheckin.avgResponseTime)}
                    </div>
                </div>

                {/* High Craving Alerts */}
                <div style={{
                    background: 'linear-gradient(135deg, #FFC107 0%, #FFA000 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(255, 193, 7, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9, display: 'flex', alignItems: 'center', gap: '5px' }}>
                        <span>‚ö†Ô∏è</span> High Craving
                    </div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.highCraving.count}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>
                        Avg response: {formatResponseTime(stats.highCraving.avgResponseTime)}
                    </div>
                </div>

                {/* Custom Threshold Alerts */}
                <div style={{
                    background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(79, 172, 254, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9, display: 'flex', alignItems: 'center', gap: '5px' }}>
                        <span>üîî</span> Custom/System
                    </div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.customThreshold.count}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>
                        Other alert types
                    </div>
                </div>
            </div>

            {/* Alert Frequency Chart */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '25px',
                marginBottom: '30px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <h3 style={{ margin: '0 0 20px 0', color: '#333' }}>Alert Frequency - Last 7 Days</h3>
                <div style={{ height: '250px' }}>
                    <canvas ref={frequencyChartRef}></canvas>
                </div>
            </div>

            {/* SOS Alert Banner */}
            {filteredAlerts.filter(a => a.type === 'sos' && a.status === 'active').length > 0 && (
                <div style={{
                    background: 'linear-gradient(135deg, #ff4444, #cc0000)',
                    padding: '20px',
                    borderRadius: '15px',
                    marginBottom: '20px',
                    animation: 'pulse 2s infinite',
                    boxShadow: '0 4px 15px rgba(255, 68, 68, 0.4)'
                }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '15px', color: 'white' }}>
                        <span style={{ fontSize: '32px' }}>üö®</span>
                        <div>
                            <div style={{ fontSize: '18px', fontWeight: 'bold', marginBottom: '5px' }}>
                                {filteredAlerts.filter(a => a.type === 'sos' && a.status === 'active').length} Active SOS Alert(s)
                            </div>
                            <div style={{ fontSize: '14px', opacity: 0.9 }}>
                                Immediate attention required - Email notifications sent automatically
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Filters and Actions Bar */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                marginBottom: '20px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', flexWrap: 'wrap', gap: '15px' }}>
                    <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                        <select
                            value={filterType}
                            onChange={(e) => setFilterType(e.target.value)}
                            style={{
                                padding: '8px 12px',
                                borderRadius: '8px',
                                border: '1px solid #ddd',
                                background: 'white',
                                cursor: 'pointer',
                                fontSize: '14px'
                            }}
                        >
                            <option value="all">All Types</option>
                            <option value="sos">SOS Emergency</option>
                            <option value="missed_checkin">Missed Check-in</option>
                            <option value="low_mood">Low Mood</option>
                            <option value="high_craving">High Craving</option>
                            <option value="system">System Alert</option>
                        </select>

                        <select
                            value={filterPriority}
                            onChange={(e) => setFilterPriority(e.target.value)}
                            style={{
                                padding: '8px 12px',
                                borderRadius: '8px',
                                border: '1px solid #ddd',
                                background: 'white',
                                cursor: 'pointer',
                                fontSize: '14px'
                            }}
                        >
                            <option value="all">All Priorities</option>
                            <option value="critical">Critical</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>

                        <select
                            value={filterResolved}
                            onChange={(e) => setFilterResolved(e.target.value)}
                            style={{
                                padding: '8px 12px',
                                borderRadius: '8px',
                                border: '1px solid #ddd',
                                background: 'white',
                                cursor: 'pointer',
                                fontSize: '14px'
                            }}
                        >
                            <option value="all">All Status</option>
                            <option value="unresolved">Active</option>
                            <option value="resolved">Resolved</option>
                        </select>
                    </div>

                    <div style={{ display: 'flex', gap: '10px' }}>
                        <button
                            onClick={() => handleExport('csv')}
                            style={{
                                padding: '10px 16px',
                                background: '#6c757d',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '500'
                            }}
                        >
                            Export CSV
                        </button>
                    </div>
                </div>
            </div>

            {/* Enhanced Table */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                overflow: 'hidden',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                    <thead>
                        <tr style={{ background: '#f8f9fa', borderBottom: '2px solid #e9ecef' }}>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Priority</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>User</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Type</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Message</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Status</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Email</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Created</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {paginatedAlerts.map(alert => (
                            <tr key={alert.id} style={{
                                borderBottom: '1px solid #f0f0f0',
                                transition: 'all 0.2s',
                                background: alert.type === 'sos' && alert.status === 'active' ? 'rgba(244, 67, 54, 0.05)' : 'white',
                                borderLeft: `4px solid ${getPriorityColor(alert.severity || 'low')}`
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.background = '#f8f9fa';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.background = alert.type === 'sos' && alert.status === 'active' ? 'rgba(244, 67, 54, 0.05)' : 'white';
                            }}
                            >
                                <td style={{ padding: '15px' }}>
                                    <div style={{
                                        width: '12px',
                                        height: '12px',
                                        borderRadius: '50%',
                                        background: getPriorityColor(alert.severity || 'low')
                                    }}></div>
                                </td>
                                <td style={{ padding: '15px', fontWeight: '500', color: '#333' }}>
                                    {alert.userName}
                                </td>
                                <td style={{ padding: '15px' }}>
                                    <span style={{
                                        padding: '4px 12px',
                                        borderRadius: '20px',
                                        fontSize: '12px',
                                        fontWeight: '500',
                                        background: alert.type === 'sos' ? '#ffebee' : '#e3f2fd',
                                        color: alert.type === 'sos' ? '#c62828' : '#1565c0'
                                    }}>
                                        {alert.type === 'sos' ? 'üö® SOS' : alert.type?.replace('_', ' ')}
                                    </span>
                                </td>
                                <td style={{ padding: '15px', color: '#666', maxWidth: '200px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                    {alert.message}
                                </td>
                                <td style={{ padding: '15px' }}>
                                    <span style={{
                                        padding: '4px 12px',
                                        borderRadius: '20px',
                                        fontSize: '12px',
                                        fontWeight: '500',
                                        background: alert.status === 'resolved' ? '#d4edda' : '#f8d7da',
                                        color: alert.status === 'resolved' ? '#155724' : '#721c24'
                                    }}>
                                        {alert.status === 'resolved' ? 'Resolved' : 'Active'}
                                    </span>
                                </td>
                                <td style={{ padding: '15px' }}>
                                    {alert.emailSent ? (
                                        <span style={{ color: '#00A86B', fontSize: '16px' }} title="Email sent">‚úì</span>
                                    ) : (
                                        <span style={{ color: '#999', fontSize: '16px' }} title="No email sent">‚Äî</span>
                                    )}
                                </td>
                                <td style={{ padding: '15px', color: '#666' }}>{formatTimeAgo(alert.createdAt)}</td>
                                <td style={{ padding: '15px' }}>
                                    <div style={{ display: 'flex', gap: '8px' }}>
                                        <button
                                            onClick={() => setSelectedAlert(alert)}
                                            style={{
                                                padding: '6px 12px',
                                                background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '6px',
                                                cursor: 'pointer',
                                                fontSize: '13px',
                                                fontWeight: '500'
                                            }}
                                        >
                                            View
                                        </button>
                                        {alert.status !== 'resolved' && (
                                            <button
                                                onClick={() => handleQuickResolve(alert.id)}
                                                style={{
                                                    padding: '6px 12px',
                                                    background: '#00A86B',
                                                    color: 'white',
                                                    border: 'none',
                                                    borderRadius: '6px',
                                                    cursor: 'pointer',
                                                    fontSize: '13px',
                                                    fontWeight: '500'
                                                }}
                                            >
                                                Quick Resolve
                                            </button>
                                        )}
                                    </div>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>

                {filteredAlerts.length === 0 && (
                    <div style={{
                        padding: '60px 20px',
                        textAlign: 'center',
                        color: '#999'
                    }}>
                        <div style={{ fontSize: '48px', marginBottom: '15px' }}>üîî</div>
                        <div style={{ fontSize: '18px', fontWeight: '500', marginBottom: '8px' }}>
                            No alerts found
                        </div>
                        <div style={{ fontSize: '14px' }}>
                            {searchQuery ? 'Try adjusting your search terms' : 'Alerts will appear here when triggered'}
                        </div>
                    </div>
                )}
            </div>

            {totalPages > 1 && (
                <div style={{ marginTop: '20px' }}>
                    <Pagination
                        currentPage={currentPage}
                        totalPages={totalPages}
                        onPageChange={setCurrentPage}
                    />
                </div>
            )}

            {selectedAlert && (
                <AlertDetailModal
                    alert={selectedAlert}
                    onClose={() => setSelectedAlert(null)}
                    onResolve={handleResolve}
                    getPriorityColor={getPriorityColor}
                />
            )}
        </div>
    );
}

        // ==================== ROOT APP COMPONENT ====================
        function AlertsApp() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [searchQuery, setSearchQuery] = useState('');
            // Manage sidebar collapsed state
            const [sidebarCollapsed, setSidebarCollapsed] = useState(() => {
                return window.getPreference ? window.getPreference('sidebarCollapsed', false) : false;
            });

            // Responsive states
            const [isMobile, setIsMobile] = useState(window.innerWidth < 600);
            const [isTablet, setIsTablet] = useState(window.innerWidth >= 600 && window.innerWidth < 1024);
            const [showBottomNav, setShowBottomNav] = useState(window.innerWidth < 1024);

            // Notification state
            const [notifications, setNotifications] = useState([]);
            // Connection status
            const [isOnline, setIsOnline] = useState(navigator.onLine);

            useEffect(() => {
                const unsubscribe = firebase.auth().onAuthStateChanged(async (firebaseUser) => {
                    if (firebaseUser) {
                        const userDoc = await firebase.firestore()
                            .collection('users')
                            .doc(firebaseUser.uid)
                            .get();

                        if (userDoc.exists) {
                            const userData = { uid: firebaseUser.uid, ...userDoc.data() };
                            // üîê PAGE ACCESS CONTROL: Check if user has permission to access Alerts
                            if (!window.canAccessPage(userData, 'alerts')) {
                                alert('You do not have permission to access Alerts.');
                                window.location.href = '/admin/users'; // Redirect to My PIRs (default fallback)
                                return;
                            }

                            setUser(userData);
                        }
                    } else {
                        window.location.href = '/admin/login';
                    }
                    setLoading(false);
                });

                return () => unsubscribe();
            }, []);

            // Handle responsive resize
            useEffect(() => {
                const handleResize = () => {
                    const width = window.innerWidth;
                    setIsMobile(width < 600);
                    setIsTablet(width >= 600 && width < 1024);
                    setShowBottomNav(width < 1024);
                };
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            // Set up notification listener
            useEffect(() => {
                if (!user) return;
                const unsubscribe = firebase.firestore()
                    .collection('notifications')
                    .where('userId', '==', user.uid)
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .onSnapshot((snapshot) => {
                        const notifs = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setNotifications(notifs);
                    }, (error) => {
                        console.error('Error loading notifications:', error);
                    });
                return () => unsubscribe();
            }, [user]);

            // Set up connection status listener
            useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);

            // Clear notification handlers
            const handleClearNotification = async (notificationId) => {
                try {
                    await firebase.firestore().collection('notifications').doc(notificationId).delete();
                } catch (error) {
                    console.error('Error clearing notification:', error);
                }
            };

            const handleClearAllNotifications = async () => {
                try {
                    const batch = firebase.firestore().batch();
                    notifications.forEach(notif => {
                        const docRef = firebase.firestore().collection('notifications').doc(notif.id);
                        batch.delete(docRef);
                    });
                    await batch.commit();
                } catch (error) {
                    console.error('Error clearing all notifications:', error);
                }
            };

            if (loading) {
                return <div style={{ padding: '50px', textAlign: 'center' }}>Loading...</div>;
            }

            if (!user) {
                return null;
            }

            return (
                <>
                    {!isOnline && (
                        <div style={{
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            right: 0,
                            background: '#ff9800',
                            color: 'white',
                            padding: '10px',
                            textAlign: 'center',
                            zIndex: 10000,
                            fontSize: '14px',
                            fontWeight: '500'
                        }}>
                            You are currently offline. Some features may be unavailable.
                        </div>
                    )}
                    <div style={{ display: 'flex', minHeight: '100vh', background: '#f5f7fa' }}>
                        {/* Sidebar Component */}
                        <Sidebar
                            activePage="alerts"
                            user={user}
                            collapsed={sidebarCollapsed}
                            onCollapsedChange={setSidebarCollapsed}
                        />
                        {/* Main Content Wrapper - shifts with sidebar */}
                        <div style={{
                            flex: 1,
                            marginLeft: showBottomNav ? 0 : (sidebarCollapsed ? '80px' : '280px'),
                            width: showBottomNav ? '100%' : 'auto',
                            paddingBottom: showBottomNav ? '72px' : 0,
                            display: 'flex',
                            flexDirection: 'column',
                            transition: 'margin-left 0.3s ease'
                        }}>
                            <Header
                                user={user}
                                searchQuery={searchQuery}
                                setSearchQuery={setSearchQuery}
                                sidebarCollapsed={sidebarCollapsed}
                                notifications={notifications}
                                onClearNotification={handleClearNotification}
                                onClearAllNotifications={handleClearAllNotifications}
                            />
                            {/* Main Content */}
                            <main style={{ flex: 1, overflow: 'auto', padding: '20px' }}>
                                <AlertsView user={user} searchQuery={searchQuery} />
                            </main>
                        </div>
                    </div>
                </>
            );
        }

        // Render
        ReactDOM.render(<AlertsApp />, document.getElementById('root'));

})(); // End initPage
    </script>
</body>
</html>
