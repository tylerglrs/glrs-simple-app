<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meetings - GLRS Admin</title>

    <!-- Favicon - Lucide Calendar Icon -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24' fill='none' stroke='%230077CC' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect width='18' height='18' x='3' y='4' rx='2' ry='2'/%3E%3Cline x1='16' x2='16' y1='2' y2='6'/%3E%3Cline x1='8' x2='8' y1='2' y2='6'/%3E%3Cline x1='3' x2='21' y1='10' y2='10'/%3E%3C/svg%3E">

    <!-- Shared Styles -->
    <link rel="stylesheet" href="/admin/shared/styles.css">

    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- jsPDF for exports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- Lucide Icons (required by MeetingBrowser.js) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
    <div id="root"></div>

    <!-- Shared Components -->
    <script src="/admin/shared/firebase.js"></script>
    <script src="/admin/shared/auth.js"></script>
    <script src="/admin/shared/permissions.js?v=2"></script>
    <script src="/admin/shared/utils.js"></script>
    <script src="/admin/shared/state.js?v=2"></script>
    <script src="/admin/shared/icons.js"></script>
    <script type="text/babel" src="/admin/shared/navigation.js?v=10"></script>
    <script type="text/babel" src="/admin/shared/header.js?v=1"></script>

    <!-- MeetingBrowser Component (from PIR app - shared between PIR and Admin) -->
    <script type="text/babel" src="/Index/tabs/MeetingBrowser.js?v=admin-1"></script>

    <script type="text/babel">
(function initPage() {
    if (!window.FIREBASE_READY || !window.auth || !window.db) {
        console.log('Waiting for Firebase to initialize...');
        setTimeout(initPage, 50);
        return;
    }

    const { useState, useEffect, useRef, useMemo, useCallback } = React;
    const { auth, db, storage, CURRENT_TENANT, logAudit } = window;

    // ==========================================
    // HELPER FUNCTIONS
    // ==========================================

    const formatDate = (timestamp) => {
        if (!timestamp) return 'N/A';
        const date = timestamp?.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    };

    const formatDateTime = (timestamp) => {
        if (!timestamp) return 'N/A';
        const date = timestamp?.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleString('en-US', {
            month: 'short', day: 'numeric', year: 'numeric',
            hour: 'numeric', minute: '2-digit', hour12: true
        });
    };

    // ==========================================
    // HELPER FUNCTIONS (EXACT COPY FROM MeetingBrowser.js)
    // ==========================================
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const DAYS_OF_WEEK = days; // Alias for compatibility

    // Decode HTML entities (for meeting names like &quot;Our 12th Suggestion&quot;)
    const decodeHTMLEntities = (text) => {
        if (!text || typeof text !== 'string') return text;
        const textarea = document.createElement('textarea');
        textarea.innerHTML = text;
        return textarea.value;
    };

    // Safely extract string from potentially nested object
    const safeString = (value) => {
        if (value === null || value === undefined) return '';
        if (typeof value === 'string') return value.trim();
        if (typeof value === 'object') {
            // Try common string properties
            if (value.formatted && typeof value.formatted === 'string') return value.formatted.trim();
            if (value.name && typeof value.name === 'string') return value.name.trim();
            if (value.street && typeof value.street === 'string') return value.street.trim();
            return ''; // Don't return [object Object]
        }
        return String(value).trim();
    };

    // Code aliasing - maps duplicate/variant codes to primary codes
    const codeAliases = {
        'S': 'ES',        // Spanish
        'G': 'LGBTQ',     // Gay/Lesbian → LGBTQ
        'L': 'LGBTQ',     // Lesbian → LGBTQ
        'XB': 'X',        // Wheelchair + Bathroom → Wheelchair
        '12 STEP': '12x12', // Alternative notation
        'TWELVE STEP': '12x12'
    };

    // Normalize code using aliasing
    const normalizeCode = (code) => {
        const upperCode = String(code).toUpperCase().trim();
        return codeAliases[upperCode] || upperCode;
    };

    // Meeting type code decoder - COMPLETE 45+ CODE DEFINITIONS (TSML standard)
    const meetingTypeCodes = {
        // FORMAT TYPES (How the meeting is conducted)
        'D': 'Discussion',
        'B': 'Big Book Study',
        '12x12': '12 Steps & 12 Traditions',
        'LIT': 'Literature',
        'ST': 'Step Study',
        'SP': 'Speaker',
        'MED': 'Meditation',
        'CAN': 'Candlelight',
        'T': 'Tradition Study',
        'TR': 'Tradition Study',
        'POA': 'Format Varies',

        // MEETING ACCESS (Who can attend)
        'O': 'Open (Non-alcoholics welcome)',
        'C': 'Closed (Alcoholics only)',

        // DEMOGRAPHIC FOCUS (Target groups)
        'W': 'Women Only',
        'M': 'Men Only',
        'Y': 'Young People',
        'SEN': 'Seniors',
        'LGBTQ': 'LGBTQ+',
        'POC': 'People of Color',
        'G': 'Gay/Lesbian (LGBTQ+)',
        'L': 'Lesbian (LGBTQ+)',
        'NB': 'Non-Binary',

        // SPECIAL POPULATIONS (Specific needs)
        'BE': 'Beginners',
        'DD': 'Dual Diagnosis',
        'ABSI': 'Adult Children of Alcoholics',
        'AL-AN': 'Al-Anon Focus',
        'DB': 'Digital Basket (Venmo/PayPal)',
        'GR': 'Grapevine',
        'DR': 'Daily Reflections',
        '11': '11th Step Focus',
        'P': 'Professionals',
        'A': 'Atheist/Agnostic',
        'N': 'Native American',

        // ACCESSIBILITY FEATURES (Physical/virtual access)
        'X': 'Wheelchair Accessible',
        'XB': 'Wheelchair Accessible + Bathroom',
        'BA': 'Babysitting Available',
        'CF': 'Child-Friendly',
        'ASL': 'ASL Interpreted',
        'ONL': 'Online',
        'HY': 'Hybrid (In-person & Online)',
        'TC': 'Temporarily Closed',
        'FF': 'Fragrance Free',
        'XT': 'Cross-Talk Permitted',

        // LANGUAGE
        'EN': 'English',
        'ES': 'Spanish',
        'S': 'Spanish',
        'FR': 'French',

        // Default
        'DEFAULT': 'Meeting Type'
    };

    // Get full name for meeting type code
    const getTypeName = (code) => {
        const normalizedCode = normalizeCode(code);
        return meetingTypeCodes[normalizedCode] || code;
    };

    // Convert military time to 12-hour format with AM/PM (EXACT COPY)
    const formatTime = (timeStr) => {
        if (!timeStr) return 'Time not specified';

        const time = String(timeStr).toLowerCase().trim();

        // Handle special cases
        if (time.includes('noon') || time === '12:00') return '12:00 PM';
        if (time.includes('midnight')) return '12:00 AM';

        // Parse time (handles both 12:00 and 17:30 formats)
        const match = time.match(/(\d+):?(\d+)?\s*(am|pm)?/i);
        if (!match) return timeStr; // Return original if can't parse

        let hours = parseInt(match[1]);
        const minutes = match[2] ? parseInt(match[2]) : 0;
        const meridiem = match[3];

        // If already has AM/PM, just format nicely
        if (meridiem) {
            const isPM = meridiem.toLowerCase() === 'pm';
            if (isPM && hours !== 12) hours += 12;
            if (!isPM && hours === 12) hours = 0;
        }

        // Convert 24-hour to 12-hour
        const isPM = hours >= 12;
        const displayHours = hours === 0 ? 12 : hours > 12 ? hours - 12 : hours;
        const displayMinutes = minutes.toString().padStart(2, '0');
        const ampm = isPM ? 'PM' : 'AM';

        return `${displayHours}:${displayMinutes} ${ampm}`;
    };

    const exportToCSV = (data, filename) => {
        if (!data || data.length === 0) return;
        const headers = Object.keys(data[0]);
        const csvContent = [
            headers.join(','),
            ...data.map(row => headers.map(h => `"${(row[h] || '').toString().replace(/"/g, '""')}"`).join(','))
        ].join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
    };

    // ==========================================
    // GLRS MEETINGS TAB
    // ==========================================
    function GLRSMeetingsTab({ searchQuery, user }) {
        const [meetings, setMeetings] = useState([]);
        const [loading, setLoading] = useState(true);
        const [showCreateModal, setShowCreateModal] = useState(false);
        const [pirUsers, setPirUsers] = useState([]);

        useEffect(() => {
            loadMeetings();
            loadPirUsers();
        }, []);

        const loadMeetings = async () => {
            try {
                const meetingsSnap = await db.collection('meetings')
                    .where('tenantId', '==', CURRENT_TENANT)
                    .orderBy('createdAt', 'desc')
                    .limit(100)
                    .get();
                const meetingsData = meetingsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setMeetings(meetingsData);
            } catch (error) {
                console.error('Error loading meetings:', error);
            } finally {
                setLoading(false);
            }
        };

        const loadPirUsers = async () => {
            try {
                let pirQuery = db.collection('users').where('role', '==', 'pir');
                pirQuery = window.applyScopeToPIRQuery(pirQuery, user, CURRENT_TENANT);
                const usersSnap = await pirQuery.get();
                const users = usersSnap.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    name: `${doc.data().firstName || ''} ${doc.data().lastName || ''}`.trim() || doc.data().email
                }));
                setPirUsers(users);
            } catch (error) {
                console.error('Error loading PIR users:', error);
            }
        };

        const handleCreateMeeting = async (meetingData) => {
            try {
                await db.collection('meetings').add({
                    tenantId: CURRENT_TENANT,
                    ...meetingData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    coachId: user.uid,
                    status: 'scheduled'
                });
                setShowCreateModal(false);
                loadMeetings();
                alert('Meeting scheduled successfully!');
            } catch (error) {
                console.error('Error creating meeting:', error);
                alert('Failed to create meeting');
            }
        };

        const handleStatusChange = async (meetingId, newStatus) => {
            try {
                const updateData = { status: newStatus };
                if (newStatus === 'completed') {
                    updateData.completedAt = firebase.firestore.FieldValue.serverTimestamp();
                }
                await db.collection('meetings').doc(meetingId).update(updateData);
                loadMeetings();
            } catch (error) {
                console.error('Error updating meeting status:', error);
            }
        };

        const handleDeleteMeeting = async (meetingId) => {
            if (!confirm('Delete this meeting permanently?')) return;
            try {
                await db.collection('meetings').doc(meetingId).delete();
                loadMeetings();
            } catch (error) {
                console.error('Error deleting meeting:', error);
            }
        };

        const filteredMeetings = useMemo(() => {
            if (!searchQuery) return meetings;
            const query = searchQuery.toLowerCase();
            return meetings.filter(m =>
                m.meetingTitle?.toLowerCase().includes(query) ||
                m.type?.toLowerCase().includes(query)
            );
        }, [meetings, searchQuery]);

        if (loading) {
            return (
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', minHeight: '400px' }}>
                    <div style={{ textAlign: 'center' }}>
                        <div style={{ width: '40px', height: '40px', border: '3px solid #f3f3f3', borderTop: '3px solid #0077CC', borderRadius: '50%', animation: 'spin 1s linear infinite', margin: '0 auto 12px' }}></div>
                        <div>Loading meetings...</div>
                    </div>
                </div>
            );
        }

        return (
            <div>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                    <h3 style={{ margin: 0, color: '#333' }}>GLRS Group Meetings</h3>
                    <button
                        onClick={() => setShowCreateModal(true)}
                        style={{ padding: '10px 20px', background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)', color: 'white', border: 'none', borderRadius: '10px', cursor: 'pointer', fontSize: '14px', fontWeight: '600' }}
                    >
                        + Schedule Meeting
                    </button>
                </div>

                <div style={{ display: 'grid', gap: '20px' }}>
                    {filteredMeetings.map(meeting => (
                        <div key={meeting.id} style={{ background: 'white', borderRadius: '15px', padding: '25px', boxShadow: '0 2px 8px rgba(0,0,0,0.08)' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '15px' }}>
                                <div>
                                    <h4 style={{ margin: '0 0 10px 0', color: '#333', fontSize: '18px' }}>{meeting.meetingTitle || 'Group Session'}</h4>
                                    <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                                        <span style={{
                                            padding: '4px 12px', borderRadius: '20px', fontSize: '12px', fontWeight: '600',
                                            background: meeting.status === 'completed' ? '#d4edda' : meeting.status === 'scheduled' ? '#cfe2ff' : meeting.status === 'cancelled' ? '#f8d7da' : '#e2e3e5',
                                            color: meeting.status === 'completed' ? '#155724' : meeting.status === 'scheduled' ? '#084298' : meeting.status === 'cancelled' ? '#721c24' : '#41464b'
                                        }}>
                                            {meeting.status?.toUpperCase()}
                                        </span>
                                        <span style={{ padding: '4px 12px', background: '#e3f2fd', color: '#1976d2', borderRadius: '20px', fontSize: '12px' }}>
                                            {meeting.type || 'Group'}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '15px', padding: '15px', background: '#f8f9fa', borderRadius: '10px', marginBottom: '15px' }}>
                                <div>
                                    <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Date</div>
                                    <div style={{ fontWeight: '600', color: '#333' }}>{meeting.date || formatDate(meeting.scheduledTime)}</div>
                                </div>
                                <div>
                                    <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Time</div>
                                    <div style={{ fontWeight: '600', color: '#333' }}>{formatTime(meeting.time) || 'TBD'}</div>
                                </div>
                                <div>
                                    <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Duration</div>
                                    <div style={{ fontWeight: '600', color: '#333' }}>{meeting.duration || 60} min</div>
                                </div>
                            </div>

                            {meeting.meetingLink && (
                                <a href={meeting.meetingLink} target="_blank" rel="noopener noreferrer" style={{
                                    display: 'inline-flex', alignItems: 'center', gap: '8px', padding: '10px 16px',
                                    background: '#e3f2fd', color: '#1976d2', textDecoration: 'none', borderRadius: '8px',
                                    fontSize: '14px', marginBottom: '15px'
                                }}>
                                    <AdminIcons.ExternalLink size={16} />
                                    Join Meeting
                                </a>
                            )}

                            <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                                <button onClick={() => handleStatusChange(meeting.id, 'completed')} disabled={meeting.status === 'completed'} style={{
                                    padding: '8px 16px', background: meeting.status === 'completed' ? '#ccc' : '#00A86B',
                                    color: 'white', border: 'none', borderRadius: '8px', cursor: meeting.status === 'completed' ? 'not-allowed' : 'pointer', fontSize: '13px'
                                }}>
                                    Mark Complete
                                </button>
                                <button onClick={() => handleStatusChange(meeting.id, 'cancelled')} disabled={meeting.status === 'cancelled'} style={{
                                    padding: '8px 16px', background: meeting.status === 'cancelled' ? '#ccc' : '#FFC107',
                                    color: 'white', border: 'none', borderRadius: '8px', cursor: meeting.status === 'cancelled' ? 'not-allowed' : 'pointer', fontSize: '13px'
                                }}>
                                    Cancel
                                </button>
                                <button onClick={() => handleDeleteMeeting(meeting.id)} style={{
                                    padding: '8px 16px', background: '#DC143C', color: 'white', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '13px'
                                }}>
                                    Delete
                                </button>
                            </div>
                        </div>
                    ))}
                </div>

                {filteredMeetings.length === 0 && (
                    <div style={{ padding: '80px 20px', textAlign: 'center', background: 'white', borderRadius: '15px', boxShadow: '0 2px 8px rgba(0,0,0,0.08)' }}>
                        <AdminIcons.Calendar size={64} color="#ddd" />
                        <div style={{ fontSize: '20px', fontWeight: '600', color: '#333', marginTop: '20px' }}>No Meetings Scheduled</div>
                        <div style={{ fontSize: '16px', color: '#999', marginTop: '10px' }}>Schedule group meetings for PIRs</div>
                    </div>
                )}

                {showCreateModal && (
                    <CreateMeetingModal pirUsers={pirUsers} onSubmit={handleCreateMeeting} onClose={() => setShowCreateModal(false)} />
                )}
            </div>
        );
    }

    // ==========================================
    // CREATE MEETING MODAL
    // ==========================================
    function CreateMeetingModal({ pirUsers, onSubmit, onClose }) {
        const [meetingTitle, setMeetingTitle] = useState('');
        const [type, setType] = useState('Group Session');
        const [date, setDate] = useState('');
        const [time, setTime] = useState('10:00');
        const [duration, setDuration] = useState(60);
        const [meetingLink, setMeetingLink] = useState('');
        const [notes, setNotes] = useState('');
        const [isGlobal, setIsGlobal] = useState(true);
        const [selectedPIRs, setSelectedPIRs] = useState([]);

        const handleSubmit = () => {
            if (!meetingTitle.trim() || !date) {
                alert('Please enter meeting title and date');
                return;
            }
            onSubmit({ meetingTitle, type, date, time, duration, meetingLink, notes, isGlobal, pirIds: isGlobal ? [] : selectedPIRs });
        };

        return (
            <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>
                <div style={{ background: 'white', borderRadius: '15px', padding: '25px', width: '550px', maxHeight: '90vh', overflow: 'auto' }}>
                    <h3 style={{ margin: '0 0 20px 0' }}>Schedule Meeting</h3>

                    <div style={{ marginBottom: '15px' }}>
                        <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500' }}>Meeting Title *</label>
                        <input type="text" value={meetingTitle} onChange={(e) => setMeetingTitle(e.target.value)} placeholder="e.g., Weekly Check-In" style={{ width: '100%', padding: '10px', border: '2px solid #e0e0e0', borderRadius: '8px' }} />
                    </div>

                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px' }}>
                        <div>
                            <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500' }}>Type</label>
                            <select value={type} onChange={(e) => setType(e.target.value)} style={{ width: '100%', padding: '10px', border: '2px solid #e0e0e0', borderRadius: '8px' }}>
                                <option value="Group Session">Group Session</option>
                                <option value="One-on-One">One-on-One</option>
                                <option value="Workshop">Workshop</option>
                                <option value="Support Group">Support Group</option>
                            </select>
                        </div>
                        <div>
                            <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500' }}>Duration (min)</label>
                            <select value={duration} onChange={(e) => setDuration(parseInt(e.target.value))} style={{ width: '100%', padding: '10px', border: '2px solid #e0e0e0', borderRadius: '8px' }}>
                                <option value={30}>30 min</option>
                                <option value={45}>45 min</option>
                                <option value={60}>60 min</option>
                                <option value={90}>90 min</option>
                                <option value={120}>120 min</option>
                            </select>
                        </div>
                        <div>
                            <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500' }}>Date *</label>
                            <input type="date" value={date} onChange={(e) => setDate(e.target.value)} style={{ width: '100%', padding: '10px', border: '2px solid #e0e0e0', borderRadius: '8px' }} />
                        </div>
                        <div>
                            <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500' }}>Time</label>
                            <input type="time" value={time} onChange={(e) => setTime(e.target.value)} style={{ width: '100%', padding: '10px', border: '2px solid #e0e0e0', borderRadius: '8px' }} />
                        </div>
                    </div>

                    <div style={{ marginTop: '15px' }}>
                        <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500' }}>Meeting Link</label>
                        <input type="url" value={meetingLink} onChange={(e) => setMeetingLink(e.target.value)} placeholder="https://meet.google.com/..." style={{ width: '100%', padding: '10px', border: '2px solid #e0e0e0', borderRadius: '8px' }} />
                    </div>

                    <div style={{ marginTop: '15px' }}>
                        <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500' }}>Notes</label>
                        <textarea value={notes} onChange={(e) => setNotes(e.target.value)} rows={2} placeholder="Meeting agenda or notes..." style={{ width: '100%', padding: '10px', border: '2px solid #e0e0e0', borderRadius: '8px', resize: 'vertical' }} />
                    </div>

                    <div style={{ marginTop: '15px' }}>
                        <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer' }}>
                            <input type="checkbox" checked={isGlobal} onChange={(e) => setIsGlobal(e.target.checked)} />
                            <span style={{ fontWeight: '500' }}>Invite all PIRs</span>
                        </label>
                    </div>

                    {!isGlobal && (
                        <div style={{ marginTop: '15px' }}>
                            <label style={{ display: 'block', marginBottom: '10px', fontWeight: '500' }}>Select PIRs</label>
                            <div style={{ maxHeight: '150px', overflowY: 'auto', border: '1px solid #e0e0e0', borderRadius: '8px', padding: '10px' }}>
                                {pirUsers.map(pir => (
                                    <label key={pir.id} style={{ display: 'flex', alignItems: 'center', padding: '8px', cursor: 'pointer' }}>
                                        <input type="checkbox" checked={selectedPIRs.includes(pir.id)} onChange={() => setSelectedPIRs(prev => prev.includes(pir.id) ? prev.filter(id => id !== pir.id) : [...prev, pir.id])} style={{ marginRight: '10px' }} />
                                        {pir.name}
                                    </label>
                                ))}
                            </div>
                        </div>
                    )}

                    <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end', marginTop: '20px' }}>
                        <button onClick={onClose} style={{ padding: '10px 20px', background: '#f0f0f0', border: 'none', borderRadius: '8px', cursor: 'pointer' }}>Cancel</button>
                        <button onClick={handleSubmit} style={{ padding: '10px 20px', background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)', color: 'white', border: 'none', borderRadius: '8px', cursor: 'pointer', fontWeight: '600' }}>Schedule Meeting</button>
                    </div>
                </div>
            </div>
        );
    }

    // ==========================================
    // PIR SELECTOR MODAL
    // ==========================================
    function PIRSelectorModal({ user, onSelect, onClose }) {
        const [pirUsers, setPirUsers] = useState([]);
        const [loading, setLoading] = useState(true);
        const [searchTerm, setSearchTerm] = useState('');

        useEffect(() => {
            loadPirUsers();
        }, []);

        const loadPirUsers = async () => {
            try {
                let pirQuery = db.collection('users').where('role', '==', 'pir');
                pirQuery = window.applyScopeToPIRQuery(pirQuery, user, CURRENT_TENANT);
                const usersSnap = await pirQuery.get();
                const users = usersSnap.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    name: `${doc.data().firstName || ''} ${doc.data().lastName || ''}`.trim() || doc.data().email
                }));
                setPirUsers(users);
            } catch (error) {
                console.error('Error loading PIR users:', error);
            } finally {
                setLoading(false);
            }
        };

        const filteredPirs = useMemo(() => {
            if (!searchTerm) return pirUsers;
            const term = searchTerm.toLowerCase();
            return pirUsers.filter(p =>
                p.name?.toLowerCase().includes(term) ||
                p.email?.toLowerCase().includes(term)
            );
        }, [pirUsers, searchTerm]);

        return (
            <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>
                <div style={{ background: 'white', borderRadius: '15px', width: '450px', maxHeight: '80vh', display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>
                    <div style={{ padding: '20px', borderBottom: '1px solid #e0e0e0' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
                            <h3 style={{ margin: 0 }}>Select PIR</h3>
                            <button onClick={onClose} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: '#999' }}>&times;</button>
                        </div>
                        <input
                            type="text"
                            placeholder="Search PIRs..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            style={{ width: '100%', padding: '10px', border: '2px solid #e0e0e0', borderRadius: '8px', fontSize: '14px' }}
                        />
                    </div>

                    <div style={{ flex: 1, overflow: 'auto', padding: '10px' }}>
                        {loading ? (
                            <div style={{ padding: '40px', textAlign: 'center', color: '#666' }}>Loading PIRs...</div>
                        ) : filteredPirs.length === 0 ? (
                            <div style={{ padding: '40px', textAlign: 'center', color: '#666' }}>No PIRs found</div>
                        ) : (
                            filteredPirs.map(pir => (
                                <button
                                    key={pir.id}
                                    onClick={() => onSelect(pir)}
                                    style={{
                                        width: '100%', padding: '12px 15px', marginBottom: '8px',
                                        background: '#f8f9fa', border: '1px solid #e0e0e0', borderRadius: '10px',
                                        cursor: 'pointer', textAlign: 'left', display: 'flex', alignItems: 'center', gap: '12px',
                                        transition: 'all 0.2s'
                                    }}
                                    onMouseEnter={(e) => e.currentTarget.style.background = '#e8f4fc'}
                                    onMouseLeave={(e) => e.currentTarget.style.background = '#f8f9fa'}
                                >
                                    <div style={{ width: '40px', height: '40px', borderRadius: '50%', background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'white', fontWeight: '600', fontSize: '16px' }}>
                                        {pir.name?.charAt(0)?.toUpperCase() || '?'}
                                    </div>
                                    <div>
                                        <div style={{ fontWeight: '500', color: '#333' }}>{pir.name}</div>
                                        <div style={{ fontSize: '12px', color: '#666' }}>{pir.email}</div>
                                    </div>
                                </button>
                            ))
                        )}
                    </div>
                </div>
            </div>
        );
    }

    // ==========================================
    // WEEK SELECTOR MODAL
    // ==========================================
    function WeekSelectorModal({ meeting, selectedPir, onConfirm, onClose }) {
        const [weeks, setWeeks] = useState(4);
        const [saving, setSaving] = useState(false);

        // Calculate preview dates
        const previewDates = useMemo(() => {
            const dates = [];
            const dayIndex = DAYS_OF_WEEK.indexOf(meeting.day);
            if (dayIndex === -1) return dates;

            const today = new Date();
            const currentDayIndex = today.getDay();

            // Find next occurrence of this day
            let daysUntilNext = dayIndex - currentDayIndex;
            if (daysUntilNext <= 0) daysUntilNext += 7;

            for (let i = 0; i < Math.min(weeks, 5); i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + daysUntilNext + (i * 7));
                dates.push(date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }));
            }

            return dates;
        }, [meeting.day, weeks]);

        const handleConfirm = async () => {
            setSaving(true);
            try {
                await onConfirm(weeks);
            } finally {
                setSaving(false);
            }
        };

        return (
            <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>
                <div style={{ background: 'white', borderRadius: '15px', padding: '25px', width: '450px' }}>
                    <h3 style={{ margin: '0 0 5px 0', color: '#333' }}>Add to Schedule</h3>
                    <p style={{ margin: '0 0 20px 0', color: '#666', fontSize: '14px' }}>
                        Adding <strong>{meeting.name}</strong> for <strong>{selectedPir.name}</strong>
                    </p>

                    <div style={{ marginBottom: '20px' }}>
                        <label style={{ display: 'block', marginBottom: '8px', fontWeight: '500' }}>How many weeks?</label>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                            <input
                                type="range"
                                min="1"
                                max="30"
                                value={weeks}
                                onChange={(e) => setWeeks(parseInt(e.target.value))}
                                style={{ flex: 1 }}
                            />
                            <input
                                type="number"
                                min="1"
                                max="30"
                                value={weeks}
                                onChange={(e) => setWeeks(Math.min(30, Math.max(1, parseInt(e.target.value) || 1)))}
                                style={{ width: '60px', padding: '8px', border: '2px solid #e0e0e0', borderRadius: '8px', textAlign: 'center' }}
                            />
                            <span style={{ color: '#666' }}>weeks</span>
                        </div>
                    </div>

                    <div style={{ background: '#f8f9fa', borderRadius: '10px', padding: '15px', marginBottom: '20px' }}>
                        <div style={{ fontSize: '13px', fontWeight: '500', color: '#666', marginBottom: '8px' }}>
                            Preview (first {Math.min(weeks, 5)} of {weeks} meetings):
                        </div>
                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
                            {previewDates.map((date, i) => (
                                <span key={i} style={{ padding: '4px 10px', background: '#e8f4fc', borderRadius: '15px', fontSize: '12px', color: '#0077CC' }}>
                                    {date}
                                </span>
                            ))}
                            {weeks > 5 && <span style={{ padding: '4px 10px', color: '#666', fontSize: '12px' }}>+{weeks - 5} more</span>}
                        </div>
                    </div>

                    <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                        <button onClick={onClose} disabled={saving} style={{ padding: '10px 20px', background: '#f0f0f0', border: 'none', borderRadius: '8px', cursor: 'pointer' }}>
                            Cancel
                        </button>
                        <button
                            onClick={handleConfirm}
                            disabled={saving}
                            style={{ padding: '10px 20px', background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)', color: 'white', border: 'none', borderRadius: '8px', cursor: 'pointer', fontWeight: '600', minWidth: '120px' }}
                        >
                            {saving ? 'Adding...' : `Add ${weeks} Meetings`}
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // ==========================================
    // AA/NA MEETINGS TAB (Uses Shared MeetingBrowser.js)
    // ==========================================
    // NOTE: This tab now renders the shared MeetingBrowser component from /Index/tabs/MeetingBrowser.js
    // which is the same component used by the PIR app. The component detects admin context automatically
    // and shows "Add to PIR's Schedule" instead of "Add to My Schedule".
    function ExternalMeetingsTab({ searchQuery, user }) {
        const [meetings, setMeetings] = useState([]);
        const [loading, setLoading] = useState(true);
        const [isMobile, setIsMobile] = useState(window.innerWidth < 768);

        // Responsive listener
        useEffect(() => {
            const handleResize = () => setIsMobile(window.innerWidth < 768);
            window.addEventListener('resize', handleResize);
            return () => window.removeEventListener('resize', handleResize);
        }, []);

        // Load external meetings
        useEffect(() => {
            const loadMeetings = async () => {
                try {
                    const snapshot = await db.collection('externalMeetings').get();
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setMeetings(data);
                    console.log(`✅ Loaded ${data.length} external meetings for admin browser`);
                } catch (error) {
                    console.error('Error loading external meetings:', error);
                } finally {
                    setLoading(false);
                }
            };
            loadMeetings();
        }, []);

        // Initialize Lucide icons after render
        useEffect(() => {
            const timer = setTimeout(() => {
                if (window.lucide && typeof window.lucide.createIcons === 'function') {
                    window.lucide.createIcons();
                }
            }, 100);
            return () => clearTimeout(timer);
        }, [loading]);

        // Loading state
        if (loading) {
            return (
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', minHeight: '400px' }}>
                    <div style={{ textAlign: 'center' }}>
                        <div style={{ width: '40px', height: '40px', border: '3px solid #f3f3f3', borderTop: '3px solid #0077CC', borderRadius: '50%', animation: 'spin 1s linear infinite', margin: '0 auto 12px' }}></div>
                        <div>Loading AA/NA meetings...</div>
                    </div>
                </div>
            );
        }

        // Get MeetingBrowser from namespace (loaded from /Index/tabs/MeetingBrowser.js)
        const MeetingBrowser = window.GLRSApp?.components?.MeetingBrowser;

        if (!MeetingBrowser) {
            return (
                <div style={{ padding: '40px', textAlign: 'center', color: '#666' }}>
                    <div>MeetingBrowser component not loaded.</div>
                    <div style={{ fontSize: '12px', marginTop: '8px' }}>Check that /Index/tabs/MeetingBrowser.js is included.</div>
                </div>
            );
        }

        // Render MeetingBrowser with admin context
        // The component detects isAdminPortal via window.location.pathname
        // and shows PIR selector instead of adding to own schedule
        return (
            <div style={{ position: 'relative' }}>
                <MeetingBrowser
                    onBack={() => {}} // No back button needed in admin tab
                    externalMeetings={meetings}
                    onAddMeeting={(meeting) => console.log('Meeting added:', meeting)}
                    currentUserId={user?.uid}
                    isMobile={isMobile}
                    isAdmin={true}
                    currentUser={user}
                />
            </div>
        );
    }

    // ==========================================
    // ATTENDANCE TAB
    // ==========================================
    function AttendanceTab({ searchQuery, user }) {
        const [attendance, setAttendance] = useState([]);
        const [meetings, setMeetings] = useState([]);
        const [pirUsers, setPirUsers] = useState([]);
        const [loading, setLoading] = useState(true);
        const [showRecordModal, setShowRecordModal] = useState(false);

        useEffect(() => {
            loadData();
        }, []);

        const loadData = async () => {
            try {
                // Load attendance records
                const attendanceSnap = await db.collection('meetingAttendance')
                    .where('tenantId', '==', CURRENT_TENANT)
                    .orderBy('recordedAt', 'desc')
                    .limit(100)
                    .get();

                const attendanceData = [];
                for (const doc of attendanceSnap.docs) {
                    const data = { id: doc.id, ...doc.data() };
                    // Get PIR name
                    if (data.pirId) {
                        const pirDoc = await db.collection('users').doc(data.pirId).get();
                        if (pirDoc.exists) {
                            const pirData = pirDoc.data();
                            data.pirName = `${pirData.firstName || ''} ${pirData.lastName || ''}`.trim() || pirData.email;
                        }
                    }
                    attendanceData.push(data);
                }
                setAttendance(attendanceData);

                // Load meetings
                const meetingsSnap = await db.collection('meetings')
                    .where('tenantId', '==', CURRENT_TENANT)
                    .orderBy('createdAt', 'desc')
                    .limit(50)
                    .get();
                setMeetings(meetingsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })));

                // Load PIR users
                let pirQuery = db.collection('users').where('role', '==', 'pir');
                pirQuery = window.applyScopeToPIRQuery(pirQuery, user, CURRENT_TENANT);
                const usersSnap = await pirQuery.get();
                const users = usersSnap.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    name: `${doc.data().firstName || ''} ${doc.data().lastName || ''}`.trim() || doc.data().email
                }));
                setPirUsers(users);
            } catch (error) {
                console.error('Error loading attendance data:', error);
            } finally {
                setLoading(false);
            }
        };

        const handleRecordAttendance = async (data) => {
            try {
                await db.collection('meetingAttendance').add({
                    tenantId: CURRENT_TENANT,
                    ...data,
                    recordedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    recordedBy: user.uid
                });
                setShowRecordModal(false);
                loadData();
                alert('Attendance recorded successfully!');
            } catch (error) {
                console.error('Error recording attendance:', error);
                alert('Failed to record attendance');
            }
        };

        const filteredAttendance = useMemo(() => {
            if (!searchQuery) return attendance;
            const query = searchQuery.toLowerCase();
            return attendance.filter(a =>
                a.pirName?.toLowerCase().includes(query) ||
                a.meetingName?.toLowerCase().includes(query)
            );
        }, [attendance, searchQuery]);

        // Calculate stats
        const stats = useMemo(() => {
            const attendedCount = attendance.filter(a => a.status === 'attended').length;
            const missedCount = attendance.filter(a => a.status === 'missed').length;
            const excusedCount = attendance.filter(a => a.status === 'excused').length;
            return { attended: attendedCount, missed: missedCount, excused: excusedCount, total: attendance.length };
        }, [attendance]);

        if (loading) {
            return (
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', minHeight: '400px' }}>
                    <div style={{ textAlign: 'center' }}>
                        <div style={{ width: '40px', height: '40px', border: '3px solid #f3f3f3', borderTop: '3px solid #0077CC', borderRadius: '50%', animation: 'spin 1s linear infinite', margin: '0 auto 12px' }}></div>
                        <div>Loading attendance data...</div>
                    </div>
                </div>
            );
        }

        return (
            <div>
                {/* Stats */}
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', gap: '15px', marginBottom: '25px' }}>
                    <div style={{ background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)', borderRadius: '12px', padding: '20px', color: 'white' }}>
                        <div style={{ fontSize: '13px', opacity: 0.9 }}>Attended</div>
                        <div style={{ fontSize: '36px', fontWeight: 'bold', marginTop: '5px' }}>{stats.attended}</div>
                    </div>
                    <div style={{ background: 'linear-gradient(135deg, #f44336 0%, #e53935 100%)', borderRadius: '12px', padding: '20px', color: 'white' }}>
                        <div style={{ fontSize: '13px', opacity: 0.9 }}>Missed</div>
                        <div style={{ fontSize: '36px', fontWeight: 'bold', marginTop: '5px' }}>{stats.missed}</div>
                    </div>
                    <div style={{ background: 'linear-gradient(135deg, #FFC107 0%, #FFA000 100%)', borderRadius: '12px', padding: '20px', color: 'white' }}>
                        <div style={{ fontSize: '13px', opacity: 0.9 }}>Excused</div>
                        <div style={{ fontSize: '36px', fontWeight: 'bold', marginTop: '5px' }}>{stats.excused}</div>
                    </div>
                    <div style={{ background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)', borderRadius: '12px', padding: '20px', color: 'white' }}>
                        <div style={{ fontSize: '13px', opacity: 0.9 }}>Total Records</div>
                        <div style={{ fontSize: '36px', fontWeight: 'bold', marginTop: '5px' }}>{stats.total}</div>
                    </div>
                </div>

                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                    <h3 style={{ margin: 0, color: '#333' }}>Attendance Records</h3>
                    <button onClick={() => setShowRecordModal(true)} style={{
                        padding: '10px 20px', background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)', color: 'white',
                        border: 'none', borderRadius: '10px', cursor: 'pointer', fontSize: '14px', fontWeight: '600'
                    }}>
                        + Record Attendance
                    </button>
                </div>

                {/* Attendance Table */}
                <div style={{ background: 'white', borderRadius: '15px', boxShadow: '0 2px 8px rgba(0,0,0,0.08)', overflow: 'hidden' }}>
                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                        <thead>
                            <tr style={{ background: '#f8f9fa' }}>
                                <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#333' }}>PIR</th>
                                <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#333' }}>Meeting</th>
                                <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#333' }}>Status</th>
                                <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#333' }}>Date</th>
                                <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#333' }}>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {filteredAttendance.map(record => (
                                <tr key={record.id} style={{ borderTop: '1px solid #f0f0f0' }}>
                                    <td style={{ padding: '15px' }}>{record.pirName || 'Unknown'}</td>
                                    <td style={{ padding: '15px' }}>{record.meetingName || record.meetingType || 'Meeting'}</td>
                                    <td style={{ padding: '15px' }}>
                                        <span style={{
                                            padding: '4px 12px', borderRadius: '15px', fontSize: '12px', fontWeight: '600',
                                            background: record.status === 'attended' ? '#d4edda' : record.status === 'missed' ? '#f8d7da' : '#fff3cd',
                                            color: record.status === 'attended' ? '#155724' : record.status === 'missed' ? '#721c24' : '#856404'
                                        }}>
                                            {record.status?.charAt(0).toUpperCase() + record.status?.slice(1)}
                                        </span>
                                    </td>
                                    <td style={{ padding: '15px', color: '#666' }}>{formatDate(record.recordedAt)}</td>
                                    <td style={{ padding: '15px', color: '#666' }}>{record.notes || '-'}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>

                    {filteredAttendance.length === 0 && (
                        <div style={{ padding: '60px 20px', textAlign: 'center', color: '#999' }}>
                            <AdminIcons.ClipboardList size={48} color="#ddd" />
                            <div style={{ marginTop: '12px' }}>No attendance records yet</div>
                        </div>
                    )}
                </div>

                {showRecordModal && (
                    <RecordAttendanceModal meetings={meetings} pirUsers={pirUsers} onSubmit={handleRecordAttendance} onClose={() => setShowRecordModal(false)} />
                )}
            </div>
        );
    }

    // ==========================================
    // RECORD ATTENDANCE MODAL
    // ==========================================
    function RecordAttendanceModal({ meetings, pirUsers, onSubmit, onClose }) {
        const [pirId, setPirId] = useState('');
        const [meetingId, setMeetingId] = useState('');
        const [meetingType, setMeetingType] = useState('GLRS');
        const [status, setStatus] = useState('attended');
        const [notes, setNotes] = useState('');

        const handleSubmit = () => {
            if (!pirId) {
                alert('Please select a PIR');
                return;
            }
            const meeting = meetings.find(m => m.id === meetingId);
            onSubmit({
                pirId,
                meetingId: meetingId || null,
                meetingName: meeting?.meetingTitle || meetingType,
                meetingType,
                status,
                notes
            });
        };

        return (
            <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>
                <div style={{ background: 'white', borderRadius: '15px', padding: '25px', width: '450px' }}>
                    <h3 style={{ margin: '0 0 20px 0' }}>Record Attendance</h3>

                    <div style={{ marginBottom: '15px' }}>
                        <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500' }}>PIR *</label>
                        <select value={pirId} onChange={(e) => setPirId(e.target.value)} style={{ width: '100%', padding: '10px', border: '2px solid #e0e0e0', borderRadius: '8px' }}>
                            <option value="">Select PIR...</option>
                            {pirUsers.map(pir => <option key={pir.id} value={pir.id}>{pir.name}</option>)}
                        </select>
                    </div>

                    <div style={{ marginBottom: '15px' }}>
                        <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500' }}>Meeting Type</label>
                        <select value={meetingType} onChange={(e) => setMeetingType(e.target.value)} style={{ width: '100%', padding: '10px', border: '2px solid #e0e0e0', borderRadius: '8px' }}>
                            <option value="GLRS">GLRS Meeting</option>
                            <option value="AA">AA Meeting</option>
                            <option value="NA">NA Meeting</option>
                            <option value="Support Group">Support Group</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    {meetingType === 'GLRS' && meetings.length > 0 && (
                        <div style={{ marginBottom: '15px' }}>
                            <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500' }}>GLRS Meeting</label>
                            <select value={meetingId} onChange={(e) => setMeetingId(e.target.value)} style={{ width: '100%', padding: '10px', border: '2px solid #e0e0e0', borderRadius: '8px' }}>
                                <option value="">Select meeting...</option>
                                {meetings.map(m => <option key={m.id} value={m.id}>{m.meetingTitle} ({m.date})</option>)}
                            </select>
                        </div>
                    )}

                    <div style={{ marginBottom: '15px' }}>
                        <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500' }}>Status</label>
                        <select value={status} onChange={(e) => setStatus(e.target.value)} style={{ width: '100%', padding: '10px', border: '2px solid #e0e0e0', borderRadius: '8px' }}>
                            <option value="attended">Attended</option>
                            <option value="missed">Missed</option>
                            <option value="excused">Excused</option>
                        </select>
                    </div>

                    <div style={{ marginBottom: '20px' }}>
                        <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500' }}>Notes</label>
                        <textarea value={notes} onChange={(e) => setNotes(e.target.value)} rows={2} placeholder="Optional notes..." style={{ width: '100%', padding: '10px', border: '2px solid #e0e0e0', borderRadius: '8px', resize: 'vertical' }} />
                    </div>

                    <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                        <button onClick={onClose} style={{ padding: '10px 20px', background: '#f0f0f0', border: 'none', borderRadius: '8px', cursor: 'pointer' }}>Cancel</button>
                        <button onClick={handleSubmit} style={{ padding: '10px 20px', background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)', color: 'white', border: 'none', borderRadius: '8px', cursor: 'pointer', fontWeight: '600' }}>Record</button>
                    </div>
                </div>
            </div>
        );
    }

    // ==========================================
    // MAIN MEETINGS VIEW
    // ==========================================
    function MeetingsView({ searchQuery, user }) {
        const [activeTab, setActiveTab] = useState('glrs');

        const tabs = [
            { id: 'glrs', label: 'GLRS Meetings', icon: <AdminIcons.Users size={18} /> },
            { id: 'external', label: 'AA/NA Meetings', icon: <AdminIcons.ExternalLink size={18} /> },
            { id: 'attendance', label: 'Attendance', icon: <AdminIcons.ClipboardList size={18} /> }
        ];

        return (
            <div style={{ padding: '20px', animation: 'fadeIn 0.5s' }}>
                {/* Tab Navigation */}
                <div style={{
                    background: 'white', borderRadius: '15px', padding: '15px 20px', marginBottom: '20px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)', display: 'flex', gap: '10px', flexWrap: 'wrap'
                }}>
                    {tabs.map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveTab(tab.id)}
                            style={{
                                padding: '10px 20px',
                                background: activeTab === tab.id ? 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)' : '#f0f0f0',
                                color: activeTab === tab.id ? 'white' : '#666',
                                border: 'none', borderRadius: '10px', cursor: 'pointer',
                                fontSize: '14px', fontWeight: '500',
                                display: 'flex', alignItems: 'center', gap: '8px'
                            }}
                        >
                            {tab.icon}
                            {tab.label}
                        </button>
                    ))}
                </div>

                {/* Tab Content */}
                {activeTab === 'glrs' && <GLRSMeetingsTab searchQuery={searchQuery} user={user} />}
                {activeTab === 'external' && <ExternalMeetingsTab searchQuery={searchQuery} user={user} />}
                {activeTab === 'attendance' && <AttendanceTab searchQuery={searchQuery} user={user} />}
            </div>
        );
    }

    // ==========================================
    // MAIN APP
    // ==========================================
    function App() {
        const [user, setUser] = useState(null);
        const [loading, setLoading] = useState(true);
        const [searchQuery, setSearchQuery] = useState('');
        const [sidebarCollapsed, setSidebarCollapsed] = useState(() => {
            return window.getPreference ? window.getPreference('sidebarCollapsed', false) : false;
        });

        // Responsive states
        const [isMobile, setIsMobile] = useState(window.innerWidth < 600);
        const [isTablet, setIsTablet] = useState(window.innerWidth >= 600 && window.innerWidth < 1024);
        const [showBottomNav, setShowBottomNav] = useState(window.innerWidth < 1024);

        // Handle sidebar collapse change and persist preference
        const handleSidebarCollapse = (collapsed) => {
            setSidebarCollapsed(collapsed);
            if (window.savePreference) {
                window.savePreference('sidebarCollapsed', collapsed);
            }
        };

        useEffect(() => {
            const unsubscribe = auth.onAuthStateChanged(async (firebaseUser) => {
                if (firebaseUser) {
                    const userDoc = await db.collection('users').doc(firebaseUser.uid).get();
                    if (userDoc.exists) {
                        const userData = { uid: firebaseUser.uid, ...userDoc.data() };

                        // Check page access
                        if (!window.canAccessPage(userData, 'meetings')) {
                            window.location.href = '/admin/dashboard.html';
                            return;
                        }

                        setUser(userData);
                    }
                } else {
                    window.location.href = '/admin/index.html';
                }
                setLoading(false);
            });
            return () => unsubscribe();
        }, []);

        // Handle responsive resize
        useEffect(() => {
            const handleResize = () => {
                const width = window.innerWidth;
                setIsMobile(width < 600);
                setIsTablet(width >= 600 && width < 1024);
                setShowBottomNav(width < 1024);
            };
            window.addEventListener('resize', handleResize);
            return () => window.removeEventListener('resize', handleResize);
        }, []);

        if (loading) {
            return (
                <div style={{
                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                    minHeight: '100vh', background: '#f5f7fa'
                }}>
                    <div style={{ textAlign: 'center' }}>
                        <div style={{
                            width: '60px', height: '60px',
                            border: '4px solid #f3f3f3', borderTop: '4px solid #0077CC',
                            borderRadius: '50%', animation: 'spin 1s linear infinite',
                            margin: '0 auto 20px'
                        }}></div>
                        <div style={{ color: '#666' }}>Loading...</div>
                    </div>
                </div>
            );
        }

        return (
            <div style={{ display: 'flex', minHeight: '100vh', background: '#f5f7fa' }}>
                <Sidebar
                    activePage="meetings"
                    user={user}
                    collapsed={sidebarCollapsed}
                    onCollapsedChange={handleSidebarCollapse}
                />
                <div style={{
                    flex: 1,
                    marginLeft: showBottomNav ? 0 : (sidebarCollapsed ? '80px' : '280px'),
                    width: showBottomNav ? '100%' : 'auto',
                    paddingBottom: showBottomNav ? '72px' : 0,
                    display: 'flex',
                    flexDirection: 'column',
                    transition: 'margin-left 0.3s ease'
                }}>
                    <Header
                        title="Meetings"
                        searchQuery={searchQuery}
                        onSearchChange={setSearchQuery}
                        user={user}
                    />
                    <main style={{ flex: 1, overflow: 'auto' }}>
                        <MeetingsView searchQuery={searchQuery} user={user} />
                    </main>
                </div>
            </div>
        );
    }

    // Render
    ReactDOM.render(<App />, document.getElementById('root'));

})();
    </script>

    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</body>
</html>
