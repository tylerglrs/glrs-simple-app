<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Templates - GLRS Admin</title>

    <!-- Favicon - Lucide Copy Icon -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24' fill='none' stroke='%230077CC' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect width='14' height='14' x='8' y='8' rx='2' ry='2'/%3E%3Cpath d='M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2'/%3E%3C/svg%3E">

    <!-- Shared Styles -->
    <link rel="stylesheet" href="/admin/shared/styles.css">

    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- PDF Reading Library (for uploaded PDFs) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <!-- Word Document Conversion Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <!-- Shared Components -->
    <script src="/admin/shared/firebase.js"></script>
    <script src="/admin/shared/auth.js"></script>
    <script src="/admin/shared/permissions.js?v=2"></script>
    <script src="/admin/shared/utils.js"></script>
    <script src="/admin/shared/state.js?v=2"></script>
    <script src="/admin/shared/icons.js"></script>

    <!-- SHARED DOCUMENT CONSTANTS - Single source of truth for WYSIWYG -->
    <script src="/shared/document-constants.js"></script>
    <script src="/shared/block-styles.js"></script>
    <script src="/shared/block-renderer.js"></script>
    <script src="/shared/pagination.js"></script>

    <script type="text/babel" src="/admin/shared/navigation.js?v=10"></script>
    <script type="text/babel" src="/admin/shared/header.js?v=1"></script>

    <script type="text/babel">
(function initPage() {
    if (!window.FIREBASE_READY || !window.auth || !window.db) {
        console.log('Waiting for Firebase to initialize...');
        setTimeout(initPage, 50);
        return;
    }

    const { useState, useEffect, useCallback } = React;
    const { auth, db, CURRENT_TENANT } = window;

    // ==========================================
    // DESIGN CONSTANTS - Synchronized with sign.html for WYSIWYG
    // ==========================================
    const DESIGN = {
        // Primary brand colors (matches sign.html)
        primary: '#0077CC',
        primaryDark: '#005A9C',
        success: '#16A34A',
        successDark: '#15803D',
        error: '#DC2626',

        // Backgrounds
        bgPage: '#F8FAFC',
        bgCard: '#FFFFFF',
        bgSidebar: '#F1F5F9',

        // Gray scale (matches sign.html exactly)
        gray50: '#F9FAFB',
        gray100: '#F3F4F6',
        gray200: '#E5E7EB',
        gray300: '#D1D5DB',
        gray400: '#9CA3AF',
        gray500: '#6B7280',
        gray600: '#4B5563',
        gray700: '#374151',
        gray800: '#1F2937',
        gray900: '#111827',

        // Gradients (matches sign.html)
        gradient: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
        gradientSuccess: 'linear-gradient(135deg, #16A34A 0%, #15803D 100%)',

        // Status colors
        statusActive: { bg: '#DCFCE7', text: '#16A34A' },
        statusDraft: { bg: '#FEF3C7', text: '#D97706' },
        statusArchived: { bg: '#F3F4F6', text: '#6B7280' },

        // Template type colors
        typeColors: {
            cover: { bg: '#DBEAFE', text: '#2563EB', icon: '#3B82F6' },
            header: { bg: '#F3E8FF', text: '#7C3AED', icon: '#8B5CF6' },
            footer: { bg: '#FCE7F3', text: '#DB2777', icon: '#EC4899' },
            endPage: { bg: '#D1FAE5', text: '#059669', icon: '#10B981' },
            document: { bg: '#FEF3C7', text: '#D97706', icon: '#F59E0B' }
        },

        // Shadows (matches sign.html)
        shadow: '0 4px 6px rgba(0, 0, 0, 0.1)',
        shadowLg: '0 10px 25px rgba(0, 0, 0, 0.15)',
        shadowResting: '0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06)',
        shadowHover: '0 4px 6px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06)',
        shadowElevated: '0 10px 15px rgba(0,0,0,0.1), 0 4px 6px rgba(0,0,0,0.05)',

        // Spacing
        gridGap: '24px',
        cardPadding: '24px',
        sectionSpacing: '32px',

        // Border radius (matches sign.html naming)
        radiusSm: '6px',
        radiusMd: '12px',
        radiusLg: '16px',
        radiusInput: '6px',
        radiusCard: '12px',
        radiusModal: '16px',

        // Transitions
        transitionFast: '150ms ease-out',
        transitionStandard: '200ms ease-out',
        transitionSlow: '300ms ease-out',

        // Typography
        fontSizeCaption: '12px',
        fontSizeMetadata: '14px',
        fontSizeBody: '16px',
        fontSizeCardTitle: '18px',
        fontSizeSectionHeader: '24px'
    };

    // ==========================================
    // PAGE DIMENSIONS - FROM SHARED CONSTANTS (single source of truth)
    // See /shared/document-constants.js for all values
    // ==========================================
    const PAGE_WIDTH = GLRS_DOC.PAGE_WIDTH;
    const PAGE_HEIGHT = GLRS_DOC.PAGE_HEIGHT;
    const PAGE_MARGIN = GLRS_DOC.PAGE_MARGIN;
    const HEADER_HEIGHT = GLRS_DOC.HEADER_HEIGHT;
    const FOOTER_HEIGHT = GLRS_DOC.FOOTER_HEIGHT;
    const CONTENT_HEIGHT_PER_PAGE = GLRS_DOC.CONTENT_HEIGHT;
    const BLOCK_HEIGHTS = GLRS_DOC.BLOCKS;
    const SAFETY_MARGIN = GLRS_DOC.SAFETY_MARGIN;
    const USABLE_CONTENT_HEIGHT = GLRS_DOC.USABLE_HEIGHT;

    // Pagination functions from shared GLRS_PAGINATION module
    const getUsableContentHeight = GLRS_PAGINATION.getUsableContentHeight;
    const getParagraphHeight = GLRS_PAGINATION.getParagraphHeight;
    const getBulletListHeight = GLRS_PAGINATION.getBulletListHeight;
    const getBlockHeight = GLRS_PAGINATION.getBlockHeight;
    const paginateBlocks = GLRS_PAGINATION.paginateBlocks;
    const getPageStartIndex = GLRS_PAGINATION.getPageStartIndex;

    // Template type definitions
    const TEMPLATE_TYPES = [
        { key: 'all', label: 'All Templates', icon: AdminIcons.Folder },
        { key: 'cover', label: 'Cover Pages', icon: AdminIcons.FileText },
        { key: 'header', label: 'Headers', icon: AdminIcons.FileTemplate },
        { key: 'footer', label: 'Footers', icon: AdminIcons.FileTemplate },
        { key: 'endPage', label: 'End Pages', icon: AdminIcons.CheckSquare },
        { key: 'document', label: 'Documents', icon: AdminIcons.FileText },
        { key: 'uploaded', label: 'Uploaded', icon: AdminIcons.Upload }
    ];

    // Uploaded document data structure (for PDF/Word uploads)
    // Template with type: 'uploaded' will have:
    // {
    //   ...standardFields,
    //   uploadedFile: {
    //     type: 'pdf' | 'docx',
    //     originalName: string,
    //     pages: [{ imageUrl: string, width: number, height: number }]
    //   },
    //   overlayFields: [{
    //     id: string,
    //     type: 'signature' | 'initials' | 'date' | 'text' | 'checkbox',
    //     pageIndex: number,
    //     position: { x: number, y: number },  // percentage of page
    //     size: { width: number, height: number },  // percentage of page
    //     role: 'pir' | 'family' | 'glrs',
    //     label: string,
    //     required: boolean
    //   }]
    // }

    // ==========================================
    // PDF/DOCX CONVERSION FUNCTIONS
    // ==========================================

    // Convert PDF to array of page images using PDF.js
    async function convertPdfToImages(file, onProgress) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        const pages = [];
        const scale = 2; // Higher quality rendering

        for (let i = 1; i <= pdf.numPages; i++) {
            if (onProgress) onProgress(i, pdf.numPages);

            const page = await pdf.getPage(i);
            const viewport = page.getViewport({ scale });

            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            await page.render({ canvasContext: context, viewport }).promise;

            pages.push({
                imageData: canvas.toDataURL('image/png'),
                width: viewport.width,
                height: viewport.height,
                pageNumber: i
            });
        }

        return pages;
    }

    // Convert DOCX to images using mammoth.js + html2canvas
    async function convertDocxToImages(file, onProgress) {
        const arrayBuffer = await file.arrayBuffer();

        // Convert DOCX to HTML using mammoth
        const result = await mammoth.convertToHtml({ arrayBuffer });
        const html = result.value;

        // Create a hidden container for rendering
        const container = document.createElement('div');
        container.style.cssText = `
            position: absolute;
            left: -9999px;
            top: 0;
            width: 816px;
            padding: 60px;
            background: white;
            font-family: 'Times New Roman', serif;
            font-size: 12pt;
            line-height: 1.5;
        `;
        container.innerHTML = html;
        document.body.appendChild(container);

        // Wait for images to load
        await new Promise(resolve => setTimeout(resolve, 500));

        if (onProgress) onProgress(1, 1);

        // Capture as image
        const canvas = await html2canvas(container, {
            scale: 2,
            useCORS: true,
            logging: false
        });

        document.body.removeChild(container);

        // For Word docs, we'll treat it as a single page (simplification)
        // In production, you'd want to paginate based on content height
        const pages = [{
            imageData: canvas.toDataURL('image/png'),
            width: canvas.width,
            height: canvas.height,
            pageNumber: 1
        }];

        return pages;
    }

    // Upload page images to Firebase Storage and return URLs
    async function uploadPageImagesToStorage(pages, templateId) {
        const storage = firebase.storage();
        const uploadedPages = [];

        for (let i = 0; i < pages.length; i++) {
            const page = pages[i];
            const pageRef = storage.ref(`templates/${templateId}/page_${i + 1}.png`);

            // Convert base64 to blob
            const response = await fetch(page.imageData);
            const blob = await response.blob();

            // Upload to storage
            await pageRef.put(blob, { contentType: 'image/png' });

            // Get download URL
            const imageUrl = await pageRef.getDownloadURL();

            uploadedPages.push({
                imageUrl,
                width: page.width,
                height: page.height,
                pageNumber: page.pageNumber
            });
        }

        return uploadedPages;
    }

    // ==========================================
    // UPLOAD DOCUMENT MODAL
    // ==========================================
    function UploadDocumentModal({ onClose, onUploadComplete, user }) {
        const [file, setFile] = useState(null);
        const [converting, setConverting] = useState(false);
        const [progress, setProgress] = useState({ current: 0, total: 0 });
        const [error, setError] = useState(null);
        const [previewPages, setPreviewPages] = useState([]);
        const [templateName, setTemplateName] = useState('');

        const handleFileSelect = async (e) => {
            const selectedFile = e.target.files[0];
            if (!selectedFile) return;

            const extension = selectedFile.name.split('.').pop().toLowerCase();
            if (!['pdf', 'docx'].includes(extension)) {
                setError('Please select a PDF or Word (.docx) file');
                return;
            }

            setFile(selectedFile);
            setTemplateName(selectedFile.name.replace(/\.[^/.]+$/, ''));
            setError(null);
            setConverting(true);

            try {
                let pages;
                if (extension === 'pdf') {
                    pages = await convertPdfToImages(selectedFile, (current, total) => {
                        setProgress({ current, total });
                    });
                } else {
                    pages = await convertDocxToImages(selectedFile, (current, total) => {
                        setProgress({ current, total });
                    });
                }
                setPreviewPages(pages);
            } catch (err) {
                console.error('Conversion error:', err);
                setError('Failed to convert document. Please try again.');
            } finally {
                setConverting(false);
            }
        };

        const handleCreateTemplate = async () => {
            if (!templateName.trim() || previewPages.length === 0) return;

            setConverting(true);
            setError(null);

            try {
                // Create template document first to get ID
                const templateRef = db.collection('templates').doc();
                const templateId = templateRef.id;

                // Upload images to Storage
                const uploadedPages = await uploadPageImagesToStorage(previewPages, templateId);

                // Create the template document
                const templateData = {
                    id: templateId,
                    name: templateName.trim(),
                    type: 'uploaded',
                    status: 'draft',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: user.uid,
                    tenant: window.CURRENT_TENANT || 'default',
                    uploadedFile: {
                        type: file.name.split('.').pop().toLowerCase(),
                        originalName: file.name,
                        pages: uploadedPages
                    },
                    overlayFields: []
                };

                await templateRef.set(templateData);

                onUploadComplete(templateData);
            } catch (err) {
                console.error('Error creating template:', err);
                setError('Failed to create template. Please try again.');
                setConverting(false);
            }
        };

        return (
            <div style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0,0,0,0.5)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 1000,
                padding: '20px'
            }}>
                <div style={{
                    background: DESIGN.bgCard,
                    borderRadius: DESIGN.radiusModal,
                    width: '100%',
                    maxWidth: '700px',
                    maxHeight: '90vh',
                    overflow: 'hidden',
                    display: 'flex',
                    flexDirection: 'column'
                }}>
                    {/* Header */}
                    <div style={{
                        padding: '20px 24px',
                        borderBottom: `1px solid ${DESIGN.gray200}`,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'space-between'
                    }}>
                        <h2 style={{ margin: 0, fontSize: '20px', color: DESIGN.gray800, display: 'flex', alignItems: 'center', gap: '10px' }}>
                            <AdminIcons.Upload size={24} color={DESIGN.primary} />
                            Upload Document
                        </h2>
                        <button
                            onClick={onClose}
                            style={{
                                background: 'none',
                                border: 'none',
                                cursor: 'pointer',
                                padding: '8px'
                            }}
                        >
                            <AdminIcons.X size={20} color={DESIGN.gray500} />
                        </button>
                    </div>

                    {/* Content */}
                    <div style={{ padding: '24px', flex: 1, overflow: 'auto' }}>
                        {/* File Input */}
                        {!file && (
                            <div style={{
                                border: `2px dashed ${DESIGN.gray300}`,
                                borderRadius: DESIGN.radiusMd,
                                padding: '48px',
                                textAlign: 'center',
                                cursor: 'pointer',
                                transition: DESIGN.transitionFast
                            }}
                            onClick={() => document.getElementById('upload-file-input').click()}
                            onDragOver={(e) => { e.preventDefault(); e.currentTarget.style.borderColor = DESIGN.primary; }}
                            onDragLeave={(e) => { e.currentTarget.style.borderColor = DESIGN.gray300; }}
                            onDrop={(e) => {
                                e.preventDefault();
                                e.currentTarget.style.borderColor = DESIGN.gray300;
                                const droppedFile = e.dataTransfer.files[0];
                                if (droppedFile) {
                                    const input = document.getElementById('upload-file-input');
                                    const dataTransfer = new DataTransfer();
                                    dataTransfer.items.add(droppedFile);
                                    input.files = dataTransfer.files;
                                    handleFileSelect({ target: input });
                                }
                            }}
                            >
                                <AdminIcons.FileText size={48} color={DESIGN.gray400} />
                                <p style={{ margin: '16px 0 8px 0', fontSize: '16px', color: DESIGN.gray600, fontWeight: '500' }}>
                                    Drop your document here or click to browse
                                </p>
                                <p style={{ margin: 0, fontSize: '14px', color: DESIGN.gray400 }}>
                                    Supports PDF and Word (.docx) files
                                </p>
                                <input
                                    id="upload-file-input"
                                    type="file"
                                    accept=".pdf,.docx"
                                    onChange={handleFileSelect}
                                    style={{ display: 'none' }}
                                />
                            </div>
                        )}

                        {/* Converting Progress */}
                        {converting && (
                            <div style={{ textAlign: 'center', padding: '40px 0' }}>
                                <div style={{
                                    width: '48px',
                                    height: '48px',
                                    border: `3px solid ${DESIGN.gray200}`,
                                    borderTopColor: DESIGN.primary,
                                    borderRadius: '50%',
                                    animation: 'spin 1s linear infinite',
                                    margin: '0 auto 16px'
                                }} />
                                <p style={{ color: DESIGN.gray600, margin: 0 }}>
                                    {progress.total > 0 ? `Converting page ${progress.current} of ${progress.total}...` : 'Processing...'}
                                </p>
                                <style>{`@keyframes spin { to { transform: rotate(360deg); } }`}</style>
                            </div>
                        )}

                        {/* Error */}
                        {error && (
                            <div style={{
                                background: '#FEF2F2',
                                border: '1px solid #FECACA',
                                borderRadius: DESIGN.radiusSm,
                                padding: '12px 16px',
                                color: '#DC2626',
                                marginBottom: '16px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                            }}>
                                <AdminIcons.AlertCircle size={18} />
                                {error}
                            </div>
                        )}

                        {/* Preview */}
                        {previewPages.length > 0 && !converting && (
                            <div>
                                {/* Template Name */}
                                <div style={{ marginBottom: '20px' }}>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: DESIGN.gray600, marginBottom: '8px' }}>
                                        Template Name
                                    </label>
                                    <input
                                        type="text"
                                        value={templateName}
                                        onChange={(e) => setTemplateName(e.target.value)}
                                        style={{
                                            width: '100%',
                                            padding: '10px 12px',
                                            border: `1px solid ${DESIGN.gray300}`,
                                            borderRadius: DESIGN.radiusInput,
                                            fontSize: '14px'
                                        }}
                                    />
                                </div>

                                {/* Page Previews */}
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: DESIGN.gray600, marginBottom: '12px' }}>
                                    Preview ({previewPages.length} page{previewPages.length > 1 ? 's' : ''})
                                </label>
                                <div style={{
                                    display: 'grid',
                                    gridTemplateColumns: 'repeat(auto-fill, minmax(150px, 1fr))',
                                    gap: '12px'
                                }}>
                                    {previewPages.map((page, index) => (
                                        <div key={index} style={{
                                            border: `1px solid ${DESIGN.gray200}`,
                                            borderRadius: DESIGN.radiusSm,
                                            overflow: 'hidden',
                                            aspectRatio: `${page.width}/${page.height}`
                                        }}>
                                            <img
                                                src={page.imageData}
                                                alt={`Page ${index + 1}`}
                                                style={{ width: '100%', height: '100%', objectFit: 'cover' }}
                                            />
                                        </div>
                                    ))}
                                </div>

                                {/* Reset Button */}
                                <button
                                    onClick={() => { setFile(null); setPreviewPages([]); setTemplateName(''); }}
                                    style={{
                                        marginTop: '16px',
                                        padding: '8px 16px',
                                        background: 'none',
                                        border: `1px solid ${DESIGN.gray300}`,
                                        borderRadius: DESIGN.radiusSm,
                                        color: DESIGN.gray600,
                                        cursor: 'pointer',
                                        fontSize: '14px'
                                    }}
                                >
                                    Choose Different File
                                </button>
                            </div>
                        )}
                    </div>

                    {/* Footer */}
                    <div style={{
                        padding: '16px 24px',
                        borderTop: `1px solid ${DESIGN.gray200}`,
                        display: 'flex',
                        justifyContent: 'flex-end',
                        gap: '12px'
                    }}>
                        <button
                            onClick={onClose}
                            style={{
                                padding: '10px 20px',
                                background: 'none',
                                border: `1px solid ${DESIGN.gray300}`,
                                borderRadius: DESIGN.radiusSm,
                                color: DESIGN.gray600,
                                cursor: 'pointer',
                                fontWeight: '500'
                            }}
                        >
                            Cancel
                        </button>
                        <button
                            onClick={handleCreateTemplate}
                            disabled={!templateName.trim() || previewPages.length === 0 || converting}
                            style={{
                                padding: '10px 20px',
                                background: (!templateName.trim() || previewPages.length === 0 || converting) ? DESIGN.gray300 : DESIGN.gradient,
                                border: 'none',
                                borderRadius: DESIGN.radiusSm,
                                color: 'white',
                                cursor: (!templateName.trim() || previewPages.length === 0 || converting) ? 'not-allowed' : 'pointer',
                                fontWeight: '500'
                            }}
                        >
                            Create Template
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // ==========================================
    // DRAGGABLE FIELD COMPONENT
    // ==========================================
    function DraggableField({ field, pageWidth, pageHeight, isSelected, onSelect, onUpdate, onDelete }) {
        const [isDragging, setIsDragging] = useState(false);
        const [isResizing, setIsResizing] = useState(false);
        const [dragStart, setDragStart] = useState({ x: 0, y: 0 });

        const roleColor = SIGNER_ROLES[field.role] || SIGNER_ROLES.pir;

        // Convert percentage to pixels for display
        const pixelX = (field.position.x / 100) * pageWidth;
        const pixelY = (field.position.y / 100) * pageHeight;
        const pixelWidth = (field.size.width / 100) * pageWidth;
        const pixelHeight = (field.size.height / 100) * pageHeight;

        const handleMouseDown = (e) => {
            e.stopPropagation();
            onSelect();
            setIsDragging(true);
            setDragStart({ x: e.clientX - pixelX, y: e.clientY - pixelY });
        };

        const handleResizeMouseDown = (e) => {
            e.stopPropagation();
            setIsResizing(true);
            setDragStart({ x: e.clientX, y: e.clientY, width: pixelWidth, height: pixelHeight });
        };

        useEffect(() => {
            if (!isDragging && !isResizing) return;

            const handleMouseMove = (e) => {
                if (isDragging) {
                    const newX = Math.max(0, Math.min(pageWidth - pixelWidth, e.clientX - dragStart.x));
                    const newY = Math.max(0, Math.min(pageHeight - pixelHeight, e.clientY - dragStart.y));
                    onUpdate({
                        ...field,
                        position: {
                            x: (newX / pageWidth) * 100,
                            y: (newY / pageHeight) * 100
                        }
                    });
                } else if (isResizing) {
                    const deltaX = e.clientX - dragStart.x;
                    const deltaY = e.clientY - dragStart.y;
                    const newWidth = Math.max(50, dragStart.width + deltaX);
                    const newHeight = Math.max(30, dragStart.height + deltaY);
                    onUpdate({
                        ...field,
                        size: {
                            width: (newWidth / pageWidth) * 100,
                            height: (newHeight / pageHeight) * 100
                        }
                    });
                }
            };

            const handleMouseUp = () => {
                setIsDragging(false);
                setIsResizing(false);
            };

            window.addEventListener('mousemove', handleMouseMove);
            window.addEventListener('mouseup', handleMouseUp);

            return () => {
                window.removeEventListener('mousemove', handleMouseMove);
                window.removeEventListener('mouseup', handleMouseUp);
            };
        }, [isDragging, isResizing, dragStart, field, pageWidth, pageHeight, pixelWidth, pixelHeight, onUpdate]);

        const fieldTypeIcons = {
            signature: AdminIcons.Edit,
            initials: AdminIcons.User,
            date: AdminIcons.Calendar,
            text: AdminIcons.FileText,
            checkbox: AdminIcons.CheckSquare
        };
        const FieldIcon = fieldTypeIcons[field.type] || AdminIcons.Edit;

        return (
            <div
                style={{
                    position: 'absolute',
                    left: pixelX,
                    top: pixelY,
                    width: pixelWidth,
                    height: pixelHeight,
                    border: `2px solid ${roleColor.borderColor}`,
                    borderRadius: '4px',
                    background: roleColor.bgLight,
                    cursor: isDragging ? 'grabbing' : 'grab',
                    boxShadow: isSelected ? `0 0 0 2px ${roleColor.color}` : 'none',
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    justifyContent: 'center',
                    userSelect: 'none'
                }}
                onMouseDown={handleMouseDown}
            >
                {/* Field Content */}
                <FieldIcon size={16} color={roleColor.color} />
                <span style={{ fontSize: '10px', color: roleColor.color, fontWeight: '500', marginTop: '2px' }}>
                    {field.label || field.type}
                </span>
                <span style={{ fontSize: '8px', color: roleColor.color, opacity: 0.7 }}>
                    ({roleColor.label})
                </span>

                {/* Delete Button (visible when selected) */}
                {isSelected && (
                    <button
                        onClick={(e) => { e.stopPropagation(); onDelete(); }}
                        style={{
                            position: 'absolute',
                            top: '-10px',
                            right: '-10px',
                            width: '20px',
                            height: '20px',
                            borderRadius: '50%',
                            background: DESIGN.error,
                            border: 'none',
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center'
                        }}
                    >
                        <AdminIcons.X size={12} color="white" />
                    </button>
                )}

                {/* Resize Handle (visible when selected) */}
                {isSelected && (
                    <div
                        onMouseDown={handleResizeMouseDown}
                        style={{
                            position: 'absolute',
                            bottom: '-4px',
                            right: '-4px',
                            width: '12px',
                            height: '12px',
                            background: roleColor.color,
                            borderRadius: '2px',
                            cursor: 'se-resize'
                        }}
                    />
                )}
            </div>
        );
    }

    // ==========================================
    // UPLOADED DOCUMENT EDITOR
    // ==========================================
    function UploadedDocumentEditor({ template, user, onClose, onSave }) {
        const [overlayFields, setOverlayFields] = useState(template.overlayFields || []);
        const [selectedFieldId, setSelectedFieldId] = useState(null);
        const [currentPage, setCurrentPage] = useState(0);
        const [saving, setSaving] = useState(false);

        const pages = template.uploadedFile?.pages || [];
        const currentPageData = pages[currentPage];

        // Generate unique field ID
        const generateFieldId = () => `field_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

        // Add new overlay field
        const addField = (type) => {
            const newField = {
                id: generateFieldId(),
                type,
                pageIndex: currentPage,
                position: { x: 30, y: 30 },
                size: { width: 20, height: 8 },
                role: 'pir',
                label: type.charAt(0).toUpperCase() + type.slice(1),
                required: true
            };
            setOverlayFields([...overlayFields, newField]);
            setSelectedFieldId(newField.id);
        };

        // Update field
        const updateField = (updatedField) => {
            setOverlayFields(overlayFields.map(f => f.id === updatedField.id ? updatedField : f));
        };

        // Delete field
        const deleteField = (fieldId) => {
            setOverlayFields(overlayFields.filter(f => f.id !== fieldId));
            if (selectedFieldId === fieldId) setSelectedFieldId(null);
        };

        // Save changes
        const handleSave = async () => {
            setSaving(true);
            try {
                await db.collection('templates').doc(template.id).update({
                    overlayFields,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                onSave({ ...template, overlayFields });
            } catch (error) {
                console.error('Error saving:', error);
                alert('Failed to save changes');
            } finally {
                setSaving(false);
            }
        };

        const selectedField = overlayFields.find(f => f.id === selectedFieldId);
        const fieldsOnCurrentPage = overlayFields.filter(f => f.pageIndex === currentPage);

        // Calculate display dimensions (fit to container)
        const containerRef = React.useRef(null);
        const [displayDimensions, setDisplayDimensions] = useState({ width: 600, height: 800 });

        useEffect(() => {
            if (containerRef.current && currentPageData) {
                const containerWidth = containerRef.current.clientWidth - 40;
                const aspectRatio = currentPageData.width / currentPageData.height;
                const displayWidth = Math.min(containerWidth, 700);
                const displayHeight = displayWidth / aspectRatio;
                setDisplayDimensions({ width: displayWidth, height: displayHeight });
            }
        }, [currentPage, currentPageData]);

        return (
            <div style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: DESIGN.bgPage,
                zIndex: 1000,
                display: 'flex',
                flexDirection: 'column'
            }}>
                {/* Header */}
                <div style={{
                    background: DESIGN.bgCard,
                    borderBottom: `1px solid ${DESIGN.gray200}`,
                    padding: '12px 24px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between'
                }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                        <button
                            onClick={onClose}
                            style={{ background: 'none', border: 'none', cursor: 'pointer', padding: '8px' }}
                        >
                            <AdminIcons.ArrowLeft size={20} color={DESIGN.gray600} />
                        </button>
                        <h2 style={{ margin: 0, fontSize: '18px', color: DESIGN.gray800 }}>
                            {template.name}
                        </h2>
                        <span style={{
                            fontSize: '12px',
                            padding: '4px 8px',
                            background: DESIGN.typeColors.uploaded?.bg || '#E0E7FF',
                            color: DESIGN.typeColors.uploaded?.text || '#4338CA',
                            borderRadius: '4px'
                        }}>
                            Uploaded Document
                        </span>
                    </div>
                    <div style={{ display: 'flex', gap: '12px' }}>
                        <button
                            onClick={onClose}
                            style={{
                                padding: '8px 16px',
                                background: 'none',
                                border: `1px solid ${DESIGN.gray300}`,
                                borderRadius: DESIGN.radiusSm,
                                cursor: 'pointer'
                            }}
                        >
                            Cancel
                        </button>
                        <button
                            onClick={handleSave}
                            disabled={saving}
                            style={{
                                padding: '8px 16px',
                                background: DESIGN.gradient,
                                border: 'none',
                                borderRadius: DESIGN.radiusSm,
                                color: 'white',
                                cursor: saving ? 'wait' : 'pointer',
                                fontWeight: '500'
                            }}
                        >
                            {saving ? 'Saving...' : 'Save Changes'}
                        </button>
                    </div>
                </div>

                {/* Main Content */}
                <div style={{ flex: 1, display: 'flex', overflow: 'hidden' }}>
                    {/* Left Panel - Field Types */}
                    <div style={{
                        width: '200px',
                        background: DESIGN.bgCard,
                        borderRight: `1px solid ${DESIGN.gray200}`,
                        padding: '16px',
                        overflowY: 'auto'
                    }}>
                        <h3 style={{ fontSize: '14px', color: DESIGN.gray600, marginBottom: '16px' }}>Add Fields</h3>
                        {[
                            { type: 'signature', label: 'Signature', icon: AdminIcons.Edit },
                            { type: 'initials', label: 'Initials', icon: AdminIcons.User },
                            { type: 'date', label: 'Date', icon: AdminIcons.Calendar },
                            { type: 'text', label: 'Text Input', icon: AdminIcons.FileText },
                            { type: 'checkbox', label: 'Checkbox', icon: AdminIcons.CheckSquare }
                        ].map(({ type, label, icon: Icon }) => (
                            <button
                                key={type}
                                onClick={() => addField(type)}
                                style={{
                                    width: '100%',
                                    padding: '12px',
                                    marginBottom: '8px',
                                    background: DESIGN.gray50,
                                    border: `1px solid ${DESIGN.gray200}`,
                                    borderRadius: DESIGN.radiusSm,
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '10px',
                                    transition: DESIGN.transitionFast
                                }}
                                onMouseEnter={(e) => e.currentTarget.style.background = DESIGN.gray100}
                                onMouseLeave={(e) => e.currentTarget.style.background = DESIGN.gray50}
                            >
                                <Icon size={18} color={DESIGN.gray600} />
                                <span style={{ fontSize: '14px', color: DESIGN.gray700 }}>{label}</span>
                            </button>
                        ))}

                        {/* Page Navigation */}
                        {pages.length > 1 && (
                            <div style={{ marginTop: '24px' }}>
                                <h3 style={{ fontSize: '14px', color: DESIGN.gray600, marginBottom: '12px' }}>Pages</h3>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                    {pages.map((page, index) => (
                                        <button
                                            key={index}
                                            onClick={() => setCurrentPage(index)}
                                            style={{
                                                padding: '8px 12px',
                                                background: currentPage === index ? DESIGN.primary : DESIGN.gray50,
                                                color: currentPage === index ? 'white' : DESIGN.gray700,
                                                border: `1px solid ${currentPage === index ? DESIGN.primary : DESIGN.gray200}`,
                                                borderRadius: DESIGN.radiusSm,
                                                cursor: 'pointer',
                                                fontSize: '13px'
                                            }}
                                        >
                                            Page {index + 1}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Center - Document View */}
                    <div
                        ref={containerRef}
                        style={{
                            flex: 1,
                            overflow: 'auto',
                            padding: '20px',
                            display: 'flex',
                            justifyContent: 'center'
                        }}
                        onClick={() => setSelectedFieldId(null)}
                    >
                        {currentPageData && (
                            <div style={{
                                position: 'relative',
                                width: displayDimensions.width,
                                height: displayDimensions.height,
                                boxShadow: DESIGN.shadowLg,
                                background: 'white'
                            }}>
                                <img
                                    src={currentPageData.imageUrl}
                                    alt={`Page ${currentPage + 1}`}
                                    style={{
                                        width: '100%',
                                        height: '100%',
                                        objectFit: 'contain'
                                    }}
                                />
                                {/* Overlay Fields */}
                                {fieldsOnCurrentPage.map(field => (
                                    <DraggableField
                                        key={field.id}
                                        field={field}
                                        pageWidth={displayDimensions.width}
                                        pageHeight={displayDimensions.height}
                                        isSelected={selectedFieldId === field.id}
                                        onSelect={() => setSelectedFieldId(field.id)}
                                        onUpdate={updateField}
                                        onDelete={() => deleteField(field.id)}
                                    />
                                ))}
                            </div>
                        )}
                    </div>

                    {/* Right Panel - Field Properties */}
                    <div style={{
                        width: '280px',
                        background: DESIGN.bgCard,
                        borderLeft: `1px solid ${DESIGN.gray200}`,
                        padding: '16px',
                        overflowY: 'auto'
                    }}>
                        <h3 style={{ fontSize: '14px', color: DESIGN.gray600, marginBottom: '16px' }}>Field Properties</h3>

                        {selectedField ? (
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                {/* Label */}
                                <div>
                                    <label style={{ display: 'block', fontSize: '12px', color: DESIGN.gray500, marginBottom: '6px' }}>
                                        Label
                                    </label>
                                    <input
                                        type="text"
                                        value={selectedField.label}
                                        onChange={(e) => updateField({ ...selectedField, label: e.target.value })}
                                        style={{
                                            width: '100%',
                                            padding: '8px 10px',
                                            border: `1px solid ${DESIGN.gray300}`,
                                            borderRadius: DESIGN.radiusSm,
                                            fontSize: '14px'
                                        }}
                                    />
                                </div>

                                {/* Role */}
                                <div>
                                    <label style={{ display: 'block', fontSize: '12px', color: DESIGN.gray500, marginBottom: '6px' }}>
                                        Signer Role
                                    </label>
                                    <select
                                        value={selectedField.role}
                                        onChange={(e) => updateField({ ...selectedField, role: e.target.value })}
                                        style={{
                                            width: '100%',
                                            padding: '8px 10px',
                                            border: `1px solid ${DESIGN.gray300}`,
                                            borderRadius: DESIGN.radiusSm,
                                            fontSize: '14px'
                                        }}
                                    >
                                        {Object.entries(SIGNER_ROLES).map(([key, role]) => (
                                            <option key={key} value={key}>{role.fullLabel}</option>
                                        ))}
                                    </select>
                                </div>

                                {/* Required */}
                                <div>
                                    <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer' }}>
                                        <input
                                            type="checkbox"
                                            checked={selectedField.required}
                                            onChange={(e) => updateField({ ...selectedField, required: e.target.checked })}
                                        />
                                        <span style={{ fontSize: '14px', color: DESIGN.gray700 }}>Required field</span>
                                    </label>
                                </div>

                                {/* Position Info */}
                                <div style={{ padding: '12px', background: DESIGN.gray50, borderRadius: DESIGN.radiusSm }}>
                                    <div style={{ fontSize: '12px', color: DESIGN.gray500, marginBottom: '8px' }}>Position</div>
                                    <div style={{ fontSize: '13px', color: DESIGN.gray700 }}>
                                        X: {selectedField.position.x.toFixed(1)}% | Y: {selectedField.position.y.toFixed(1)}%
                                    </div>
                                    <div style={{ fontSize: '13px', color: DESIGN.gray700, marginTop: '4px' }}>
                                        Size: {selectedField.size.width.toFixed(1)}% x {selectedField.size.height.toFixed(1)}%
                                    </div>
                                </div>

                                {/* Delete Button */}
                                <button
                                    onClick={() => deleteField(selectedField.id)}
                                    style={{
                                        padding: '10px',
                                        background: '#FEF2F2',
                                        border: `1px solid #FECACA`,
                                        borderRadius: DESIGN.radiusSm,
                                        color: DESIGN.error,
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        gap: '8px'
                                    }}
                                >
                                    <AdminIcons.Trash size={16} />
                                    Delete Field
                                </button>
                            </div>
                        ) : (
                            <p style={{ fontSize: '14px', color: DESIGN.gray400, textAlign: 'center', padding: '20px 0' }}>
                                Select a field to edit its properties, or click a field type to add one.
                            </p>
                        )}
                    </div>
                </div>
            </div>
        );
    }

    // ==========================================
    // ICON PICKER COMPONENT
    // ==========================================
    // Available icons for template decoration
    const AVAILABLE_ICONS = [
        { key: 'none', label: 'No Icon' },
        { key: 'FileText', label: 'Document' },
        { key: 'Shield', label: 'Shield' },
        { key: 'Heart', label: 'Heart' },
        { key: 'Star', label: 'Star' },
        { key: 'Award', label: 'Award' },
        { key: 'CheckCircle', label: 'Check' },
        { key: 'Lock', label: 'Lock' },
        { key: 'Key', label: 'Key' },
        { key: 'Handshake', label: 'Handshake' },
        { key: 'User', label: 'User' },
        { key: 'Users', label: 'Users' },
        { key: 'Phone', label: 'Phone' },
        { key: 'Mail', label: 'Email' },
        { key: 'Globe', label: 'Globe' },
        { key: 'Building', label: 'Building' },
        { key: 'MapPin', label: 'Location' },
        { key: 'Calendar', label: 'Calendar' },
        { key: 'Clock', label: 'Clock' },
        { key: 'Lightbulb', label: 'Lightbulb' },
        { key: 'Target', label: 'Target' },
        { key: 'TrendingUp', label: 'Growth' },
        { key: 'Zap', label: 'Energy' },
        { key: 'Sparkles', label: 'Sparkles' },
        { key: 'Crown', label: 'Crown' },
        { key: 'Trophy', label: 'Trophy' },
        { key: 'GraduationCap', label: 'Education' },
        { key: 'Book', label: 'Book' },
        { key: 'BookOpen', label: 'Open Book' },
        { key: 'Info', label: 'Info' },
        { key: 'AlertCircle', label: 'Alert' }
    ];

    // Available icon colors
    const ICON_COLORS = [
        { key: '#0077CC', label: 'Blue', preview: '#0077CC' },
        { key: '#0D9488', label: 'Teal', preview: '#0D9488' },
        { key: '#7C3AED', label: 'Purple', preview: '#7C3AED' },
        { key: '#059669', label: 'Green', preview: '#059669' },
        { key: '#DC2626', label: 'Red', preview: '#DC2626' },
        { key: '#D97706', label: 'Orange', preview: '#D97706' },
        { key: '#EC4899', label: 'Pink', preview: '#EC4899' },
        { key: '#4A5A64', label: 'Gray', preview: '#4A5A64' },
        { key: '#FFFFFF', label: 'White', preview: '#FFFFFF' },
        { key: '#1F2937', label: 'Dark', preview: '#1F2937' }
    ];

    function IconPicker({ selectedIcon, selectedColor, onIconChange, onColorChange, label = 'Icon' }) {
        const [isExpanded, setIsExpanded] = useState(false);

        const renderIcon = (iconKey, size = 20, color = selectedColor) => {
            if (!iconKey || iconKey === 'none') return null;
            const IconComponent = AdminIcons[iconKey];
            if (!IconComponent) return null;
            return <IconComponent size={size} style={{ color: color }} />;
        };

        return (
            <div style={{ marginBottom: '20px' }}>
                <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: DESIGN.gray600, marginBottom: '10px' }}>
                    {label}
                </label>

                {/* Selected Icon Preview */}
                <div
                    onClick={() => setIsExpanded(!isExpanded)}
                    style={{
                        display: 'flex', alignItems: 'center', gap: '12px', padding: '12px',
                        border: `1px solid ${DESIGN.gray200}`, borderRadius: DESIGN.radiusInput,
                        cursor: 'pointer', background: isExpanded ? '#F0F7FF' : 'white',
                        transition: DESIGN.transitionFast
                    }}
                >
                    <div style={{
                        width: '40px', height: '40px', borderRadius: '8px',
                        background: selectedIcon && selectedIcon !== 'none' ? (selectedColor === '#FFFFFF' ? DESIGN.gray200 : '#F8FAFC') : DESIGN.gray100,
                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                        border: '1px solid rgba(0,0,0,0.05)'
                    }}>
                        {selectedIcon && selectedIcon !== 'none' ? renderIcon(selectedIcon, 24, selectedColor) : (
                            <span style={{ color: DESIGN.gray400, fontSize: '12px' }}>None</span>
                        )}
                    </div>
                    <div style={{ flex: 1 }}>
                        <div style={{ fontSize: '14px', fontWeight: '500', color: DESIGN.gray600 }}>
                            {selectedIcon && selectedIcon !== 'none' ? AVAILABLE_ICONS.find(i => i.key === selectedIcon)?.label || selectedIcon : 'No icon selected'}
                        </div>
                        {selectedIcon && selectedIcon !== 'none' && (
                            <div style={{ fontSize: '12px', color: DESIGN.gray400 }}>
                                {ICON_COLORS.find(c => c.key === selectedColor)?.label || 'Custom'} color
                            </div>
                        )}
                    </div>
                    <AdminIcons.ChevronRight size={18} style={{
                        color: DESIGN.gray400,
                        transform: isExpanded ? 'rotate(90deg)' : 'rotate(0deg)',
                        transition: DESIGN.transitionFast
                    }} />
                </div>

                {/* Expanded Picker */}
                {isExpanded && (
                    <div style={{
                        marginTop: '8px', padding: '16px',
                        background: DESIGN.bgCard, border: `1px solid ${DESIGN.gray200}`,
                        borderRadius: DESIGN.radiusInput, boxShadow: DESIGN.shadowResting
                    }}>
                        {/* Color Selection */}
                        <div style={{ marginBottom: '16px' }}>
                            <div style={{ fontSize: '12px', fontWeight: '600', color: DESIGN.gray500, marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                                Color
                            </div>
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
                                {ICON_COLORS.map(color => (
                                    <button
                                        key={color.key}
                                        onClick={() => onColorChange(color.key)}
                                        title={color.label}
                                        style={{
                                            width: '32px', height: '32px', borderRadius: '50%',
                                            background: color.preview,
                                            border: selectedColor === color.key ? '3px solid #0077CC' : (color.key === '#FFFFFF' ? '1px solid #E5E7EB' : '2px solid transparent'),
                                            cursor: 'pointer', outline: 'none',
                                            boxShadow: selectedColor === color.key ? '0 0 0 2px #BFDBFE' : 'none',
                                            transition: DESIGN.transitionFast
                                        }}
                                    />
                                ))}
                            </div>
                        </div>

                        {/* Icon Selection */}
                        <div>
                            <div style={{ fontSize: '12px', fontWeight: '600', color: DESIGN.gray500, marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                                Icon
                            </div>
                            <div style={{
                                display: 'grid', gridTemplateColumns: 'repeat(6, 1fr)', gap: '6px',
                                maxHeight: '200px', overflowY: 'auto', padding: '4px'
                            }}>
                                {AVAILABLE_ICONS.map(icon => (
                                    <button
                                        key={icon.key}
                                        onClick={() => { onIconChange(icon.key); if (icon.key === 'none') setIsExpanded(false); }}
                                        title={icon.label}
                                        style={{
                                            width: '44px', height: '44px', borderRadius: '8px',
                                            background: selectedIcon === icon.key ? '#EEF2FF' : 'white',
                                            border: selectedIcon === icon.key ? '2px solid #0077CC' : `1px solid ${DESIGN.gray200}`,
                                            cursor: 'pointer', outline: 'none',
                                            display: 'flex', alignItems: 'center', justifyContent: 'center',
                                            transition: DESIGN.transitionFast
                                        }}
                                    >
                                        {icon.key === 'none' ? (
                                            <AdminIcons.X size={18} style={{ color: DESIGN.gray400 }} />
                                        ) : renderIcon(icon.key, 20, selectedIcon === icon.key ? selectedColor : DESIGN.gray500)}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    // ==========================================
    // SKELETON LOADING COMPONENT
    // ==========================================
    function SkeletonCard() {
        return (
            <div style={{
                background: DESIGN.bgCard,
                borderRadius: DESIGN.radiusCard,
                overflow: 'hidden',
                boxShadow: DESIGN.shadowResting
            }}>
                {/* Preview area skeleton */}
                <div style={{
                    height: '160px',
                    background: 'linear-gradient(90deg, #E5E7EB 25%, #F3F4F6 50%, #E5E7EB 75%)',
                    backgroundSize: '200% 100%',
                    animation: 'shimmer 1.5s infinite'
                }} />

                {/* Content skeleton */}
                <div style={{ padding: DESIGN.cardPadding }}>
                    {/* Title skeleton */}
                    <div style={{
                        height: '20px',
                        width: '70%',
                        background: 'linear-gradient(90deg, #E5E7EB 25%, #F3F4F6 50%, #E5E7EB 75%)',
                        backgroundSize: '200% 100%',
                        animation: 'shimmer 1.5s infinite',
                        borderRadius: '4px',
                        marginBottom: '12px'
                    }} />

                    {/* Metadata skeleton */}
                    <div style={{
                        height: '14px',
                        width: '50%',
                        background: 'linear-gradient(90deg, #E5E7EB 25%, #F3F4F6 50%, #E5E7EB 75%)',
                        backgroundSize: '200% 100%',
                        animation: 'shimmer 1.5s infinite',
                        borderRadius: '4px',
                        marginBottom: '16px'
                    }} />

                    {/* Status badge skeleton */}
                    <div style={{
                        height: '24px',
                        width: '80px',
                        background: 'linear-gradient(90deg, #E5E7EB 25%, #F3F4F6 50%, #E5E7EB 75%)',
                        backgroundSize: '200% 100%',
                        animation: 'shimmer 1.5s infinite',
                        borderRadius: '12px'
                    }} />
                </div>
            </div>
        );
    }

    // ==========================================
    // EMPTY STATE COMPONENT
    // ==========================================
    function EmptyState({ filterCategory, onCreateNew, isMobile }) {
        const isFiltered = filterCategory !== 'all';
        const typeConfig = TEMPLATE_TYPES.find(t => t.key === filterCategory);
        const Icon = typeConfig?.icon || AdminIcons.FileText;

        return (
            <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                padding: isMobile ? '40px 20px' : '80px 40px',
                textAlign: 'center'
            }}>
                {/* Illustration */}
                <div style={{
                    width: isMobile ? '100px' : '120px',
                    height: isMobile ? '100px' : '120px',
                    borderRadius: '50%',
                    background: 'linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    marginBottom: '24px'
                }}>
                    <Icon size={isMobile ? 48 : 56} color="#6366F1" />
                </div>

                {/* Title */}
                <h3 style={{
                    fontSize: isMobile ? '18px' : '20px',
                    fontWeight: '600',
                    color: DESIGN.gray600,
                    margin: '0 0 8px 0'
                }}>
                    {isFiltered
                        ? `No ${typeConfig?.label || 'templates'} yet`
                        : 'No templates yet'
                    }
                </h3>

                {/* Description */}
                <p style={{
                    fontSize: DESIGN.fontSizeMetadata,
                    color: DESIGN.gray400,
                    margin: '0 0 24px 0',
                    maxWidth: '400px',
                    lineHeight: '1.6'
                }}>
                    {isFiltered
                        ? `Create your first ${typeConfig?.label?.toLowerCase() || 'template'} to get started.`
                        : 'Templates help you create consistent documents faster. Create cover pages, headers, footers, and full document templates.'
                    }
                </p>

                {/* CTA Button */}
                <button
                    onClick={onCreateNew}
                    style={{
                        padding: '12px 24px',
                        background: 'linear-gradient(135deg, #0077CC 0%, #005A9C 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: DESIGN.radiusInput,
                        fontSize: DESIGN.fontSizeMetadata,
                        fontWeight: '600',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px',
                        transition: DESIGN.transitionStandard
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.transform = 'translateY(-2px)';
                        e.currentTarget.style.boxShadow = DESIGN.shadowHover;
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = 'none';
                    }}
                >
                    <AdminIcons.Plus size={18} />
                    Create Template
                </button>
            </div>
        );
    }

    // ==========================================
    // TEMPLATE CARD COMPONENT
    // ==========================================
    function TemplateCard({ template, onEdit, onDelete, onDuplicate, onSend, isMobile }) {
        const [isHovered, setIsHovered] = useState(false);
        const typeColor = DESIGN.typeColors[template.type] || DESIGN.typeColors.document;
        const statusConfig = template.status === 'active' ? DESIGN.statusActive
            : template.status === 'draft' ? DESIGN.statusDraft
            : DESIGN.statusArchived;

        // Format relative date
        const formatRelativeDate = (timestamp) => {
            if (!timestamp) return 'Never';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
            return date.toLocaleDateString();
        };

        // Get type icon
        const TypeIcon = TEMPLATE_TYPES.find(t => t.key === template.type)?.icon || AdminIcons.FileText;

        return (
            <div
                onMouseEnter={() => setIsHovered(true)}
                onMouseLeave={() => setIsHovered(false)}
                onClick={() => onEdit(template)}
                style={{
                    background: DESIGN.bgCard,
                    borderRadius: DESIGN.radiusCard,
                    overflow: 'hidden',
                    boxShadow: isHovered ? DESIGN.shadowHover : DESIGN.shadowResting,
                    transform: isHovered ? 'translateY(-4px)' : 'translateY(0)',
                    transition: DESIGN.transitionStandard,
                    cursor: 'pointer',
                    position: 'relative'
                }}
            >
                {/* Preview thumbnail */}
                <div style={{
                    position: 'relative',
                    height: isMobile ? '140px' : '160px',
                    background: DESIGN.gray100,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                }}>
                    {/* Template preview placeholder */}
                    {template.thumbnailUrl ? (
                        <img
                            src={template.thumbnailUrl}
                            alt={template.name}
                            style={{
                                width: '100%',
                                height: '100%',
                                objectFit: 'cover'
                            }}
                        />
                    ) : (
                        <div style={{
                            width: '80px',
                            height: '100px',
                            background: DESIGN.bgCard,
                            borderRadius: '4px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center'
                        }}>
                            <TypeIcon size={32} color={typeColor.icon} />
                        </div>
                    )}

                    {/* Type badge - top left */}
                    <div style={{
                        position: 'absolute',
                        top: '12px',
                        left: '12px',
                        padding: '4px 10px',
                        background: typeColor.bg,
                        color: typeColor.text,
                        borderRadius: '12px',
                        fontSize: DESIGN.fontSizeCaption,
                        fontWeight: '600',
                        textTransform: 'capitalize'
                    }}>
                        {template.type === 'endPage' ? 'End Page' : template.type}
                    </div>

                    {/* Quick actions overlay - only visible on hover (desktop) */}
                    {isHovered && !isMobile && (
                        <div style={{
                            position: 'absolute',
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            background: 'rgba(0,0,0,0.4)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            gap: '12px',
                            animation: 'fadeIn 0.15s ease-out'
                        }}>
                            <button
                                onClick={(e) => { e.stopPropagation(); onEdit(template); }}
                                style={{
                                    padding: '10px 20px',
                                    background: DESIGN.bgCard,
                                    border: 'none',
                                    borderRadius: DESIGN.radiusInput,
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px',
                                    fontSize: DESIGN.fontSizeMetadata
                                }}
                            >
                                <AdminIcons.Edit size={16} /> Edit
                            </button>
                            <button
                                onClick={(e) => { e.stopPropagation(); onDuplicate(template); }}
                                style={{
                                    padding: '10px 16px',
                                    background: 'rgba(255,255,255,0.9)',
                                    border: 'none',
                                    borderRadius: DESIGN.radiusInput,
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center'
                                }}
                            >
                                <AdminIcons.Copy size={18} color={DESIGN.gray600} />
                            </button>
                            {/* Send for Signature - only for document templates with active status */}
                            {template.type === 'document' && template.status === 'active' && onSend && (
                                <button
                                    onClick={(e) => { e.stopPropagation(); onSend(template); }}
                                    style={{
                                        padding: '10px 20px',
                                        background: 'linear-gradient(135deg, #16A34A 0%, #15803D 100%)',
                                        border: 'none',
                                        borderRadius: DESIGN.radiusInput,
                                        color: 'white',
                                        fontWeight: '600',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '6px',
                                        fontSize: DESIGN.fontSizeMetadata
                                    }}
                                >
                                    <AdminIcons.Send size={16} /> Send
                                </button>
                            )}
                        </div>
                    )}

                    {/* Kebab menu - top right */}
                    {isHovered && !isMobile && (
                        <div
                            style={{
                                position: 'absolute',
                                top: '12px',
                                right: '12px',
                                zIndex: 10
                            }}
                            onClick={(e) => e.stopPropagation()}
                        >
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    if (confirm('Delete this template?')) {
                                        onDelete(template);
                                    }
                                }}
                                style={{
                                    padding: '6px',
                                    background: 'rgba(255,255,255,0.9)',
                                    border: 'none',
                                    borderRadius: '4px',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center'
                                }}
                            >
                                <AdminIcons.Trash2 size={16} color="#EF4444" />
                            </button>
                        </div>
                    )}
                </div>

                {/* Card content */}
                <div style={{ padding: isMobile ? '16px' : DESIGN.cardPadding }}>
                    <h3 style={{
                        fontSize: isMobile ? '16px' : DESIGN.fontSizeCardTitle,
                        fontWeight: '600',
                        margin: '0 0 8px 0',
                        color: DESIGN.gray600,
                        overflow: 'hidden',
                        textOverflow: 'ellipsis',
                        whiteSpace: 'nowrap'
                    }}>
                        {template.name}
                    </h3>
                    <p style={{
                        fontSize: isMobile ? '12px' : DESIGN.fontSizeMetadata,
                        color: DESIGN.gray400,
                        margin: '0 0 12px 0'
                    }}>
                        Updated {formatRelativeDate(template.updatedAt)}
                    </p>

                    {/* Status badge */}
                    <span style={{
                        display: 'inline-block',
                        padding: '4px 10px',
                        background: statusConfig.bg,
                        color: statusConfig.text,
                        borderRadius: '12px',
                        fontSize: DESIGN.fontSizeCaption,
                        fontWeight: '500',
                        textTransform: 'capitalize'
                    }}>
                        {template.status}
                    </span>
                </div>
            </div>
        );
    }

    // ==========================================
    // DELETE CONFIRM MODAL
    // ==========================================
    function DeleteConfirmModal({ template, onConfirm, onCancel, isMobile }) {
        const [deleting, setDeleting] = useState(false);

        const handleDelete = async () => {
            setDeleting(true);
            try {
                await onConfirm();
            } finally {
                setDeleting(false);
            }
        };

        // Handle Escape key
        useEffect(() => {
            const handleEscape = (e) => {
                if (e.key === 'Escape' && !deleting) onCancel();
            };
            window.addEventListener('keydown', handleEscape);
            return () => window.removeEventListener('keydown', handleEscape);
        }, [deleting]);

        return (
            <div
                style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0, 0, 0, 0.5)',
                    backdropFilter: 'blur(5px)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1100,
                    padding: '20px',
                    animation: 'fadeIn 0.2s ease-out'
                }}
                onClick={() => !deleting && onCancel()}
            >
                <div
                    style={{
                        background: DESIGN.bgCard,
                        borderRadius: DESIGN.radiusModal,
                        maxWidth: '400px',
                        width: '100%',
                        overflow: 'hidden',
                        boxShadow: DESIGN.shadowElevated,
                        animation: 'slideUp 0.2s ease-out'
                    }}
                    onClick={(e) => e.stopPropagation()}
                >
                    {/* Header */}
                    <div style={{
                        padding: '24px',
                        borderBottom: `1px solid ${DESIGN.gray200}`,
                        display: 'flex',
                        alignItems: 'flex-start',
                        gap: '16px'
                    }}>
                        <div style={{
                            width: '48px',
                            height: '48px',
                            borderRadius: '50%',
                            background: '#FEE2E2',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            flexShrink: 0
                        }}>
                            <AdminIcons.Trash2 size={24} color="#DC2626" />
                        </div>
                        <div>
                            <h3 style={{
                                margin: '0 0 4px 0',
                                fontSize: '18px',
                                fontWeight: '600',
                                color: DESIGN.gray600
                            }}>
                                Delete Template?
                            </h3>
                            <p style={{
                                margin: 0,
                                fontSize: DESIGN.fontSizeMetadata,
                                color: DESIGN.gray400,
                                lineHeight: '1.5'
                            }}>
                                Are you sure you want to delete "<strong>{template?.name}</strong>"? This action cannot be undone.
                            </p>
                        </div>
                    </div>

                    {/* Actions */}
                    <div style={{
                        padding: '16px 24px',
                        display: 'flex',
                        gap: '12px',
                        justifyContent: 'flex-end',
                        background: DESIGN.gray100
                    }}>
                        <button
                            onClick={onCancel}
                            disabled={deleting}
                            style={{
                                padding: '10px 20px',
                                background: DESIGN.bgCard,
                                border: `1px solid ${DESIGN.gray200}`,
                                borderRadius: DESIGN.radiusInput,
                                color: DESIGN.gray600,
                                fontSize: DESIGN.fontSizeMetadata,
                                fontWeight: '500',
                                cursor: deleting ? 'not-allowed' : 'pointer',
                                opacity: deleting ? 0.5 : 1
                            }}
                        >
                            Cancel
                        </button>
                        <button
                            onClick={handleDelete}
                            disabled={deleting}
                            style={{
                                padding: '10px 20px',
                                background: deleting ? DESIGN.gray400 : '#DC2626',
                                border: 'none',
                                borderRadius: DESIGN.radiusInput,
                                color: 'white',
                                fontSize: DESIGN.fontSizeMetadata,
                                fontWeight: '600',
                                cursor: deleting ? 'not-allowed' : 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                            }}
                        >
                            {deleting ? (
                                <React.Fragment>
                                    <span style={{
                                        display: 'inline-block',
                                        width: '14px',
                                        height: '14px',
                                        border: '2px solid white',
                                        borderTop: '2px solid transparent',
                                        borderRadius: '50%',
                                        animation: 'spin 0.8s linear infinite'
                                    }}></span>
                                    Deleting...
                                </React.Fragment>
                            ) : (
                                <React.Fragment>
                                    <AdminIcons.Trash2 size={16} />
                                    Delete Template
                                </React.Fragment>
                            )}
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // ==========================================
    // TEMPLATE CREATE MODAL
    // ==========================================
    function TemplateCreateModal({ user, preselectedType, onClose, onSuccess, isMobile }) {
        // Form state
        const [formData, setFormData] = useState({
            name: '',
            type: preselectedType || 'document',
            description: '',
            status: 'draft'
        });
        const [saving, setSaving] = useState(false);
        const [errors, setErrors] = useState({});

        // Handle Escape key
        useEffect(() => {
            const handleEscape = (e) => {
                if (e.key === 'Escape' && !saving) onClose();
            };
            window.addEventListener('keydown', handleEscape);
            return () => window.removeEventListener('keydown', handleEscape);
        }, [saving]);

        // Validation
        const validateForm = () => {
            const newErrors = {};
            if (!formData.name.trim()) {
                newErrors.name = 'Template name is required';
            } else if (formData.name.length < 3) {
                newErrors.name = 'Name must be at least 3 characters';
            } else if (formData.name.length > 100) {
                newErrors.name = 'Name must be less than 100 characters';
            }
            if (!formData.type) {
                newErrors.type = 'Please select a template type';
            }
            setErrors(newErrors);
            return Object.keys(newErrors).length === 0;
        };

        // Submit handler
        const handleSubmit = async (e) => {
            e.preventDefault();
            if (!validateForm()) return;

            setSaving(true);
            try {
                const templateData = {
                    name: formData.name.trim(),
                    type: formData.type,
                    description: formData.description.trim(),
                    status: formData.status,
                    content: formData.type === 'document' ? { blocks: [] } : {}, // Initialize content
                    components: formData.type === 'document' ? {
                        coverPageId: null,
                        headerId: null,
                        footerId: null,
                        endPageId: null
                    } : null,
                    tenantId: CURRENT_TENANT,
                    createdBy: user.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                const docRef = await db.collection('templates').add(templateData);

                // Pass the created template to onSuccess so it can open the appropriate editor
                onSuccess({
                    id: docRef.id,
                    ...templateData
                });
            } catch (error) {
                console.error('Error creating template:', error);
                alert('Failed to create template: ' + error.message);
            } finally {
                setSaving(false);
            }
        };

        const typeConfig = TEMPLATE_TYPES.find(t => t.key === formData.type);
        const TypeIcon = typeConfig?.icon || AdminIcons.FileText;
        const typeColor = DESIGN.typeColors[formData.type] || DESIGN.typeColors.document;

        return (
            <div
                style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0, 0, 0, 0.5)',
                    backdropFilter: 'blur(5px)',
                    display: 'flex',
                    alignItems: isMobile ? 'flex-end' : 'center',
                    justifyContent: 'center',
                    zIndex: 1000,
                    padding: isMobile ? 0 : '20px',
                    animation: 'fadeIn 0.3s ease-out'
                }}
                onClick={() => !saving && onClose()}
            >
                <div
                    style={{
                        background: DESIGN.bgCard,
                        borderRadius: isMobile ? '20px 20px 0 0' : DESIGN.radiusModal,
                        maxWidth: '600px',
                        width: '100%',
                        maxHeight: isMobile ? '90vh' : '85vh',
                        display: 'flex',
                        flexDirection: 'column',
                        overflow: 'hidden',
                        boxShadow: DESIGN.shadowElevated,
                        animation: isMobile ? 'slideUp 0.3s ease-out' : 'scaleIn 0.3s ease-out'
                    }}
                    onClick={(e) => e.stopPropagation()}
                >
                    {/* Header */}
                    <div style={{
                        background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                        padding: isMobile ? '20px' : '24px 28px',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center'
                    }}>
                        <div>
                            <h3 style={{
                                margin: '0 0 4px 0',
                                color: 'white',
                                fontSize: isMobile ? '20px' : '22px',
                                fontWeight: '600'
                            }}>
                                Create New Template
                            </h3>
                            <p style={{
                                margin: 0,
                                color: 'rgba(255,255,255,0.85)',
                                fontSize: DESIGN.fontSizeMetadata
                            }}>
                                Set up your template details
                            </p>
                        </div>
                        <button
                            onClick={onClose}
                            disabled={saving}
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                border: 'none',
                                color: 'white',
                                width: '36px',
                                height: '36px',
                                borderRadius: '50%',
                                cursor: saving ? 'not-allowed' : 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '24px',
                                fontWeight: '300',
                                transition: DESIGN.transitionFast,
                                opacity: saving ? 0.5 : 1
                            }}
                            onMouseEnter={(e) => !saving && (e.currentTarget.style.background = 'rgba(255,255,255,0.3)')}
                            onMouseLeave={(e) => !saving && (e.currentTarget.style.background = 'rgba(255,255,255,0.2)')}
                        >
                            
                        </button>
                    </div>

                    {/* Form */}
                    <form onSubmit={handleSubmit} style={{ flex: 1, display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>
                        <div style={{
                            flex: 1,
                            overflowY: 'auto',
                            padding: isMobile ? '20px' : '28px',
                            background: '#f8fafc'
                        }}>
                            {/* Template Name */}
                            <div style={{ marginBottom: '24px' }}>
                                <label style={{
                                    display: 'block',
                                    marginBottom: '8px',
                                    fontWeight: '600',
                                    fontSize: DESIGN.fontSizeMetadata,
                                    color: DESIGN.gray600
                                }}>
                                    Template Name *
                                </label>
                                <input
                                    type="text"
                                    value={formData.name}
                                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                                    placeholder="e.g., Service Agreement Cover Page"
                                    style={{
                                        width: '100%',
                                        padding: '12px 14px',
                                        border: errors.name ? '2px solid #DC2626' : `1px solid ${DESIGN.gray200}`,
                                        borderRadius: DESIGN.radiusInput,
                                        fontSize: DESIGN.fontSizeBody,
                                        color: DESIGN.gray600,
                                        background: DESIGN.bgCard,
                                        outline: 'none',
                                        transition: DESIGN.transitionFast
                                    }}
                                    onFocus={(e) => {
                                        if (!errors.name) e.target.style.borderColor = '#0077CC';
                                    }}
                                    onBlur={(e) => {
                                        if (!errors.name) e.target.style.borderColor = DESIGN.gray200;
                                    }}
                                />
                                {errors.name && (
                                    <div style={{
                                        marginTop: '6px',
                                        color: '#DC2626',
                                        fontSize: DESIGN.fontSizeCaption,
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '4px'
                                    }}>
                                        <AdminIcons.AlertTriangle size={12} />
                                        {errors.name}
                                    </div>
                                )}
                            </div>

                            {/* Template Type */}
                            <div style={{ marginBottom: '24px' }}>
                                <label style={{
                                    display: 'block',
                                    marginBottom: '8px',
                                    fontWeight: '600',
                                    fontSize: DESIGN.fontSizeMetadata,
                                    color: DESIGN.gray600
                                }}>
                                    Template Type *
                                </label>
                                <div style={{
                                    display: 'grid',
                                    gridTemplateColumns: isMobile ? 'repeat(2, 1fr)' : 'repeat(3, 1fr)',
                                    gap: '10px'
                                }}>
                                    {TEMPLATE_TYPES.filter(t => t.key !== 'all').map(type => {
                                        const Icon = type.icon;
                                        const color = DESIGN.typeColors[type.key];
                                        const isSelected = formData.type === type.key;
                                        return (
                                            <button
                                                key={type.key}
                                                type="button"
                                                onClick={() => setFormData({...formData, type: type.key})}
                                                style={{
                                                    padding: '14px 12px',
                                                    background: isSelected ? color.bg : DESIGN.bgCard,
                                                    border: isSelected ? `2px solid ${color.icon}` : `1px solid ${DESIGN.gray200}`,
                                                    borderRadius: DESIGN.radiusInput,
                                                    cursor: 'pointer',
                                                    display: 'flex',
                                                    flexDirection: 'column',
                                                    alignItems: 'center',
                                                    gap: '8px',
                                                    transition: DESIGN.transitionFast
                                                }}
                                            >
                                                <Icon size={20} color={isSelected ? color.icon : DESIGN.gray400} />
                                                <span style={{
                                                    fontSize: DESIGN.fontSizeCaption,
                                                    fontWeight: isSelected ? '600' : '500',
                                                    color: isSelected ? color.text : DESIGN.gray500
                                                }}>
                                                    {type.key === 'endPage' ? 'End Page' : type.label.replace(' Pages', '').replace('s', '')}
                                                </span>
                                            </button>
                                        );
                                    })}
                                </div>
                                {errors.type && (
                                    <div style={{
                                        marginTop: '6px',
                                        color: '#DC2626',
                                        fontSize: DESIGN.fontSizeCaption,
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '4px'
                                    }}>
                                        <AdminIcons.AlertTriangle size={12} />
                                        {errors.type}
                                    </div>
                                )}
                            </div>

                            {/* Description */}
                            <div style={{ marginBottom: '24px' }}>
                                <label style={{
                                    display: 'block',
                                    marginBottom: '8px',
                                    fontWeight: '600',
                                    fontSize: DESIGN.fontSizeMetadata,
                                    color: DESIGN.gray600
                                }}>
                                    Description
                                    <span style={{ fontWeight: '400', color: DESIGN.gray400, marginLeft: '4px' }}>(optional)</span>
                                </label>
                                <textarea
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                    placeholder="Brief description of what this template is for..."
                                    rows={3}
                                    style={{
                                        width: '100%',
                                        padding: '12px 14px',
                                        border: `1px solid ${DESIGN.gray200}`,
                                        borderRadius: DESIGN.radiusInput,
                                        fontSize: DESIGN.fontSizeMetadata,
                                        color: DESIGN.gray600,
                                        background: DESIGN.bgCard,
                                        resize: 'vertical',
                                        fontFamily: 'inherit',
                                        outline: 'none',
                                        transition: DESIGN.transitionFast
                                    }}
                                    onFocus={(e) => e.target.style.borderColor = '#0077CC'}
                                    onBlur={(e) => e.target.style.borderColor = DESIGN.gray200}
                                />
                            </div>

                            {/* Status */}
                            <div>
                                <label style={{
                                    display: 'block',
                                    marginBottom: '8px',
                                    fontWeight: '600',
                                    fontSize: DESIGN.fontSizeMetadata,
                                    color: DESIGN.gray600
                                }}>
                                    Status
                                </label>
                                <div style={{ display: 'flex', gap: '10px' }}>
                                    {[
                                        { key: 'draft', label: 'Draft', color: DESIGN.statusDraft },
                                        { key: 'active', label: 'Active', color: DESIGN.statusActive }
                                    ].map(status => (
                                        <button
                                            key={status.key}
                                            type="button"
                                            onClick={() => setFormData({...formData, status: status.key})}
                                            style={{
                                                padding: '10px 20px',
                                                background: formData.status === status.key ? status.color.bg : DESIGN.bgCard,
                                                border: formData.status === status.key
                                                    ? `2px solid ${status.color.text}`
                                                    : `1px solid ${DESIGN.gray200}`,
                                                borderRadius: DESIGN.radiusInput,
                                                color: formData.status === status.key ? status.color.text : DESIGN.gray500,
                                                fontSize: DESIGN.fontSizeMetadata,
                                                fontWeight: formData.status === status.key ? '600' : '500',
                                                cursor: 'pointer',
                                                transition: DESIGN.transitionFast
                                            }}
                                        >
                                            {status.label}
                                        </button>
                                    ))}
                                </div>
                                <p style={{
                                    margin: '8px 0 0 0',
                                    fontSize: DESIGN.fontSizeCaption,
                                    color: DESIGN.gray400
                                }}>
                                    Draft templates are only visible to admins. Active templates can be used in documents.
                                </p>
                            </div>
                        </div>

                        {/* Footer Actions */}
                        <div style={{
                            padding: isMobile ? '16px 20px' : '20px 28px',
                            borderTop: `1px solid ${DESIGN.gray200}`,
                            display: 'flex',
                            gap: '12px',
                            justifyContent: 'flex-end',
                            background: DESIGN.bgCard
                        }}>
                            <button
                                type="button"
                                onClick={onClose}
                                disabled={saving}
                                style={{
                                    padding: '12px 24px',
                                    background: '#f5f7fa',
                                    border: `1px solid ${DESIGN.gray200}`,
                                    borderRadius: DESIGN.radiusInput,
                                    color: DESIGN.gray600,
                                    fontSize: DESIGN.fontSizeMetadata,
                                    fontWeight: '500',
                                    cursor: saving ? 'not-allowed' : 'pointer',
                                    opacity: saving ? 0.5 : 1,
                                    transition: DESIGN.transitionFast
                                }}
                            >
                                Cancel
                            </button>
                            <button
                                type="submit"
                                disabled={saving}
                                style={{
                                    padding: '12px 28px',
                                    background: saving ? DESIGN.gray400 : 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                    border: 'none',
                                    borderRadius: DESIGN.radiusInput,
                                    color: 'white',
                                    fontSize: DESIGN.fontSizeMetadata,
                                    fontWeight: '600',
                                    cursor: saving ? 'not-allowed' : 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px',
                                    boxShadow: saving ? 'none' : '0 4px 12px rgba(0,119,204,0.3)',
                                    transition: DESIGN.transitionFast
                                }}
                            >
                                {saving ? (
                                    <React.Fragment>
                                        <span style={{
                                            display: 'inline-block',
                                            width: '16px',
                                            height: '16px',
                                            border: '2px solid white',
                                            borderTop: '2px solid transparent',
                                            borderRadius: '50%',
                                            animation: 'spin 0.8s linear infinite'
                                        }}></span>
                                        Creating...
                                    </React.Fragment>
                                ) : (
                                    <React.Fragment>
                                        <AdminIcons.Plus size={16} />
                                        Create Template
                                    </React.Fragment>
                                )}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        );
    }

    // ==========================================
    // TEMPLATE DETAIL MODAL (View/Edit)
    // ==========================================
    function TemplateDetailModal({ template, user, onClose, onUpdate, onDelete, onOpenEditor, onSend, isMobile }) {
        // Form state - initialized with template data
        const [formData, setFormData] = useState({
            name: template?.name || '',
            type: template?.type || 'document',
            description: template?.description || '',
            status: template?.status || 'draft'
        });
        const [saving, setSaving] = useState(false);
        const [errors, setErrors] = useState({});
        const [hasChanges, setHasChanges] = useState(false);

        // Track changes
        useEffect(() => {
            if (!template) return;
            const changed = formData.name !== template.name ||
                formData.type !== template.type ||
                formData.description !== (template.description || '') ||
                formData.status !== template.status;
            setHasChanges(changed);
        }, [formData, template]);

        // Handle Escape key
        useEffect(() => {
            const handleEscape = (e) => {
                if (e.key === 'Escape' && !saving) onClose();
            };
            window.addEventListener('keydown', handleEscape);
            return () => window.removeEventListener('keydown', handleEscape);
        }, [saving]);

        // Validation
        const validateForm = () => {
            const newErrors = {};
            if (!formData.name.trim()) {
                newErrors.name = 'Template name is required';
            } else if (formData.name.length < 3) {
                newErrors.name = 'Name must be at least 3 characters';
            }
            setErrors(newErrors);
            return Object.keys(newErrors).length === 0;
        };

        // Save handler
        const handleSave = async (e) => {
            e.preventDefault();
            if (!validateForm()) return;

            setSaving(true);
            try {
                await db.collection('templates').doc(template.id).update({
                    name: formData.name.trim(),
                    type: formData.type,
                    description: formData.description.trim(),
                    status: formData.status,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                onUpdate();
            } catch (error) {
                console.error('Error updating template:', error);
                alert('Failed to update template: ' + error.message);
            } finally {
                setSaving(false);
            }
        };

        // Format date
        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        };

        const typeConfig = TEMPLATE_TYPES.find(t => t.key === formData.type);
        const TypeIcon = typeConfig?.icon || AdminIcons.FileText;
        const typeColor = DESIGN.typeColors[formData.type] || DESIGN.typeColors.document;

        return (
            <div
                style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0, 0, 0, 0.5)',
                    backdropFilter: 'blur(5px)',
                    display: 'flex',
                    alignItems: isMobile ? 'flex-end' : 'center',
                    justifyContent: 'center',
                    zIndex: 1000,
                    padding: isMobile ? 0 : '20px',
                    animation: 'fadeIn 0.3s ease-out'
                }}
                onClick={() => !saving && onClose()}
            >
                <div
                    style={{
                        background: DESIGN.bgCard,
                        borderRadius: isMobile ? '20px 20px 0 0' : DESIGN.radiusModal,
                        maxWidth: '650px',
                        width: '100%',
                        maxHeight: isMobile ? '95vh' : '90vh',
                        display: 'flex',
                        flexDirection: 'column',
                        overflow: 'hidden',
                        boxShadow: DESIGN.shadowElevated,
                        animation: isMobile ? 'slideUp 0.3s ease-out' : 'scaleIn 0.3s ease-out'
                    }}
                    onClick={(e) => e.stopPropagation()}
                >
                    {/* Header */}
                    <div style={{
                        background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                        padding: isMobile ? '20px' : '24px 28px',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'flex-start'
                    }}>
                        <div style={{ flex: 1 }}>
                            <div style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px',
                                marginBottom: '8px'
                            }}>
                                <div style={{
                                    padding: '6px 12px',
                                    background: 'rgba(255,255,255,0.2)',
                                    borderRadius: '12px',
                                    fontSize: DESIGN.fontSizeCaption,
                                    fontWeight: '600',
                                    color: 'white',
                                    textTransform: 'capitalize'
                                }}>
                                    {formData.type === 'endPage' ? 'End Page' : formData.type}
                                </div>
                                <div style={{
                                    padding: '6px 12px',
                                    background: formData.status === 'active' ? 'rgba(34,197,94,0.2)' : 'rgba(255,255,255,0.15)',
                                    borderRadius: '12px',
                                    fontSize: DESIGN.fontSizeCaption,
                                    fontWeight: '500',
                                    color: 'white',
                                    textTransform: 'capitalize'
                                }}>
                                    {formData.status}
                                </div>
                            </div>
                            <h3 style={{
                                margin: 0,
                                color: 'white',
                                fontSize: isMobile ? '20px' : '22px',
                                fontWeight: '600'
                            }}>
                                Edit Template
                            </h3>
                        </div>
                        <button
                            onClick={onClose}
                            disabled={saving}
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                border: 'none',
                                color: 'white',
                                width: '36px',
                                height: '36px',
                                borderRadius: '50%',
                                cursor: saving ? 'not-allowed' : 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '24px',
                                fontWeight: '300',
                                transition: DESIGN.transitionFast,
                                opacity: saving ? 0.5 : 1
                            }}
                            onMouseEnter={(e) => !saving && (e.currentTarget.style.background = 'rgba(255,255,255,0.3)')}
                            onMouseLeave={(e) => !saving && (e.currentTarget.style.background = 'rgba(255,255,255,0.2)')}
                        >
                            
                        </button>
                    </div>

                    {/* Form */}
                    <form onSubmit={handleSave} style={{ flex: 1, display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>
                        <div style={{
                            flex: 1,
                            overflowY: 'auto',
                            padding: isMobile ? '20px' : '28px',
                            background: '#f8fafc'
                        }}>
                            {/* Template Name */}
                            <div style={{ marginBottom: '24px' }}>
                                <label style={{
                                    display: 'block',
                                    marginBottom: '8px',
                                    fontWeight: '600',
                                    fontSize: DESIGN.fontSizeMetadata,
                                    color: DESIGN.gray600
                                }}>
                                    Template Name *
                                </label>
                                <input
                                    type="text"
                                    value={formData.name}
                                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                                    style={{
                                        width: '100%',
                                        padding: '12px 14px',
                                        border: errors.name ? '2px solid #DC2626' : `1px solid ${DESIGN.gray200}`,
                                        borderRadius: DESIGN.radiusInput,
                                        fontSize: DESIGN.fontSizeBody,
                                        color: DESIGN.gray600,
                                        background: DESIGN.bgCard,
                                        outline: 'none',
                                        transition: DESIGN.transitionFast
                                    }}
                                    onFocus={(e) => {
                                        if (!errors.name) e.target.style.borderColor = '#0077CC';
                                    }}
                                    onBlur={(e) => {
                                        if (!errors.name) e.target.style.borderColor = DESIGN.gray200;
                                    }}
                                />
                                {errors.name && (
                                    <div style={{
                                        marginTop: '6px',
                                        color: '#DC2626',
                                        fontSize: DESIGN.fontSizeCaption,
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '4px'
                                    }}>
                                        <AdminIcons.AlertTriangle size={12} />
                                        {errors.name}
                                    </div>
                                )}
                            </div>

                            {/* Template Type */}
                            <div style={{ marginBottom: '24px' }}>
                                <label style={{
                                    display: 'block',
                                    marginBottom: '8px',
                                    fontWeight: '600',
                                    fontSize: DESIGN.fontSizeMetadata,
                                    color: DESIGN.gray600
                                }}>
                                    Template Type
                                </label>
                                <div style={{
                                    display: 'grid',
                                    gridTemplateColumns: isMobile ? 'repeat(2, 1fr)' : 'repeat(3, 1fr)',
                                    gap: '10px'
                                }}>
                                    {TEMPLATE_TYPES.filter(t => t.key !== 'all').map(type => {
                                        const Icon = type.icon;
                                        const color = DESIGN.typeColors[type.key];
                                        const isSelected = formData.type === type.key;
                                        return (
                                            <button
                                                key={type.key}
                                                type="button"
                                                onClick={() => setFormData({...formData, type: type.key})}
                                                style={{
                                                    padding: '14px 12px',
                                                    background: isSelected ? color.bg : DESIGN.bgCard,
                                                    border: isSelected ? `2px solid ${color.icon}` : `1px solid ${DESIGN.gray200}`,
                                                    borderRadius: DESIGN.radiusInput,
                                                    cursor: 'pointer',
                                                    display: 'flex',
                                                    flexDirection: 'column',
                                                    alignItems: 'center',
                                                    gap: '8px',
                                                    transition: DESIGN.transitionFast
                                                }}
                                            >
                                                <Icon size={20} color={isSelected ? color.icon : DESIGN.gray400} />
                                                <span style={{
                                                    fontSize: DESIGN.fontSizeCaption,
                                                    fontWeight: isSelected ? '600' : '500',
                                                    color: isSelected ? color.text : DESIGN.gray500
                                                }}>
                                                    {type.key === 'endPage' ? 'End Page' : type.label.replace(' Pages', '').replace('s', '')}
                                                </span>
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>

                            {/* Description */}
                            <div style={{ marginBottom: '24px' }}>
                                <label style={{
                                    display: 'block',
                                    marginBottom: '8px',
                                    fontWeight: '600',
                                    fontSize: DESIGN.fontSizeMetadata,
                                    color: DESIGN.gray600
                                }}>
                                    Description
                                </label>
                                <textarea
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                    placeholder="Brief description..."
                                    rows={3}
                                    style={{
                                        width: '100%',
                                        padding: '12px 14px',
                                        border: `1px solid ${DESIGN.gray200}`,
                                        borderRadius: DESIGN.radiusInput,
                                        fontSize: DESIGN.fontSizeMetadata,
                                        color: DESIGN.gray600,
                                        background: DESIGN.bgCard,
                                        resize: 'vertical',
                                        fontFamily: 'inherit',
                                        outline: 'none',
                                        transition: DESIGN.transitionFast
                                    }}
                                    onFocus={(e) => e.target.style.borderColor = '#0077CC'}
                                    onBlur={(e) => e.target.style.borderColor = DESIGN.gray200}
                                />
                            </div>

                            {/* Status */}
                            <div style={{ marginBottom: '24px' }}>
                                <label style={{
                                    display: 'block',
                                    marginBottom: '8px',
                                    fontWeight: '600',
                                    fontSize: DESIGN.fontSizeMetadata,
                                    color: DESIGN.gray600
                                }}>
                                    Status
                                </label>
                                <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                                    {[
                                        { key: 'draft', label: 'Draft', color: DESIGN.statusDraft },
                                        { key: 'active', label: 'Active', color: DESIGN.statusActive },
                                        { key: 'archived', label: 'Archived', color: DESIGN.statusArchived }
                                    ].map(status => (
                                        <button
                                            key={status.key}
                                            type="button"
                                            onClick={() => setFormData({...formData, status: status.key})}
                                            style={{
                                                padding: '10px 20px',
                                                background: formData.status === status.key ? status.color.bg : DESIGN.bgCard,
                                                border: formData.status === status.key
                                                    ? `2px solid ${status.color.text}`
                                                    : `1px solid ${DESIGN.gray200}`,
                                                borderRadius: DESIGN.radiusInput,
                                                color: formData.status === status.key ? status.color.text : DESIGN.gray500,
                                                fontSize: DESIGN.fontSizeMetadata,
                                                fontWeight: formData.status === status.key ? '600' : '500',
                                                cursor: 'pointer',
                                                transition: DESIGN.transitionFast
                                            }}
                                        >
                                            {status.label}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Metadata */}
                            <div style={{
                                background: DESIGN.bgCard,
                                border: `1px solid ${DESIGN.gray200}`,
                                borderRadius: DESIGN.radiusInput,
                                padding: '16px'
                            }}>
                                <h4 style={{
                                    margin: '0 0 12px 0',
                                    fontSize: DESIGN.fontSizeMetadata,
                                    fontWeight: '600',
                                    color: DESIGN.gray600,
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px'
                                }}>
                                    <AdminIcons.Info size={16} color={DESIGN.gray400} />
                                    Template Info
                                </h4>
                                <div style={{
                                    display: 'grid',
                                    gridTemplateColumns: isMobile ? '1fr' : 'repeat(2, 1fr)',
                                    gap: '12px',
                                    fontSize: DESIGN.fontSizeCaption,
                                    color: DESIGN.gray500
                                }}>
                                    <div>
                                        <strong>Created:</strong> {formatDate(template?.createdAt)}
                                    </div>
                                    <div>
                                        <strong>Last Updated:</strong> {formatDate(template?.updatedAt)}
                                    </div>
                                    <div>
                                        <strong>Template ID:</strong> {template?.id}
                                    </div>
                                </div>
                            </div>

                            {/* Open Editor Button (Placeholder for Phase 3) */}
                            <div style={{ marginTop: '24px' }}>
                                <button
                                    type="button"
                                    onClick={() => onOpenEditor && onOpenEditor(template)}
                                    style={{
                                        width: '100%',
                                        padding: '14px',
                                        background: 'linear-gradient(135deg, #6366F1 0%, #4F46E5 100%)',
                                        border: 'none',
                                        borderRadius: DESIGN.radiusInput,
                                        color: 'white',
                                        fontSize: DESIGN.fontSizeMetadata,
                                        fontWeight: '600',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        gap: '10px',
                                        boxShadow: '0 4px 12px rgba(99,102,241,0.3)',
                                        transition: DESIGN.transitionFast
                                    }}
                                >
                                    <AdminIcons.Edit size={18} />
                                    Open Content Editor
                                </button>

                                {/* Send for Signature button - only for active document templates */}
                                {template?.type === 'document' && template?.status === 'active' && onSend && (
                                    <button
                                        type="button"
                                        onClick={() => onSend(template)}
                                        style={{
                                            width: '100%',
                                            padding: '14px',
                                            marginTop: '12px',
                                            background: 'linear-gradient(135deg, #16A34A 0%, #15803D 100%)',
                                            border: 'none',
                                            borderRadius: DESIGN.radiusInput,
                                            color: 'white',
                                            fontSize: DESIGN.fontSizeMetadata,
                                            fontWeight: '600',
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            gap: '10px',
                                            boxShadow: '0 4px 12px rgba(22,163,74,0.3)',
                                            transition: DESIGN.transitionFast
                                        }}
                                    >
                                        <AdminIcons.Send size={18} />
                                        Send for Signature
                                    </button>
                                )}
                            </div>
                        </div>

                        {/* Footer Actions */}
                        <div style={{
                            padding: isMobile ? '16px 20px' : '20px 28px',
                            borderTop: `1px solid ${DESIGN.gray200}`,
                            display: 'flex',
                            gap: '12px',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            background: DESIGN.bgCard,
                            flexWrap: 'wrap'
                        }}>
                            {/* Delete button */}
                            <button
                                type="button"
                                onClick={onDelete}
                                disabled={saving}
                                style={{
                                    padding: '10px 16px',
                                    background: 'transparent',
                                    border: `1px solid #FCA5A5`,
                                    borderRadius: DESIGN.radiusInput,
                                    color: '#DC2626',
                                    fontSize: DESIGN.fontSizeMetadata,
                                    fontWeight: '500',
                                    cursor: saving ? 'not-allowed' : 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px',
                                    opacity: saving ? 0.5 : 1,
                                    transition: DESIGN.transitionFast
                                }}
                            >
                                <AdminIcons.Trash2 size={16} />
                                Delete
                            </button>

                            <div style={{ display: 'flex', gap: '12px' }}>
                                <button
                                    type="button"
                                    onClick={onClose}
                                    disabled={saving}
                                    style={{
                                        padding: '12px 24px',
                                        background: '#f5f7fa',
                                        border: `1px solid ${DESIGN.gray200}`,
                                        borderRadius: DESIGN.radiusInput,
                                        color: DESIGN.gray600,
                                        fontSize: DESIGN.fontSizeMetadata,
                                        fontWeight: '500',
                                        cursor: saving ? 'not-allowed' : 'pointer',
                                        opacity: saving ? 0.5 : 1
                                    }}
                                >
                                    Cancel
                                </button>
                                <button
                                    type="submit"
                                    disabled={saving || !hasChanges}
                                    style={{
                                        padding: '12px 28px',
                                        background: (saving || !hasChanges)
                                            ? DESIGN.gray300
                                            : 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                        border: 'none',
                                        borderRadius: DESIGN.radiusInput,
                                        color: 'white',
                                        fontSize: DESIGN.fontSizeMetadata,
                                        fontWeight: '600',
                                        cursor: (saving || !hasChanges) ? 'not-allowed' : 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px',
                                        boxShadow: (saving || !hasChanges) ? 'none' : '0 4px 12px rgba(0,119,204,0.3)'
                                    }}
                                >
                                    {saving ? (
                                        <React.Fragment>
                                            <span style={{
                                                display: 'inline-block',
                                                width: '16px',
                                                height: '16px',
                                                border: '2px solid white',
                                                borderTop: '2px solid transparent',
                                                borderRadius: '50%',
                                                animation: 'spin 0.8s linear infinite'
                                            }}></span>
                                            Saving...
                                        </React.Fragment>
                                    ) : (
                                        <React.Fragment>
                                            <AdminIcons.Check size={16} />
                                            Save Changes
                                        </React.Fragment>
                                    )}
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        );
    }

    // ==========================================
    // BLOCK TYPE DEFINITIONS
    // ==========================================
    const BLOCK_TYPES = [
        // Structure blocks
        {
            type: 'section',
            label: 'Section Header',
            icon: AdminIcons.FileText,
            category: 'structure',
            defaultProps: { title: 'Section Title', number: '1' }
        },
        {
            type: 'heading',
            label: 'Heading',
            icon: AdminIcons.FileText,
            category: 'structure',
            defaultProps: { content: 'Heading Text', level: 3 }
        },
        {
            type: 'pageBreak',
            label: 'Page Break',
            icon: AdminIcons.Scissors,
            category: 'structure',
            defaultProps: {}
        },
        // Content blocks
        {
            type: 'paragraph',
            label: 'Paragraph',
            icon: AdminIcons.FileText,
            category: 'content',
            defaultProps: { content: 'Enter your text here...' }
        },
        {
            type: 'bulletList',
            label: 'Bullet List',
            icon: AdminIcons.ClipboardList,
            category: 'content',
            defaultProps: { items: ['Item 1', 'Item 2', 'Item 3'] }
        },
        // Signature Field Types (Individual)
        {
            type: 'signatureField',
            label: 'Signature',
            icon: AdminIcons.Edit,
            category: 'signature',
            defaultProps: { label: 'Signature', role: 'pir', required: true, fieldType: 'signature' }
        },
        {
            type: 'initialsField',
            label: 'Initials',
            icon: AdminIcons.User,
            category: 'signature',
            defaultProps: { label: 'Initials', role: 'pir', required: true, fieldType: 'initials' }
        },
        {
            type: 'dateField',
            label: 'Date',
            icon: AdminIcons.Calendar,
            category: 'signature',
            defaultProps: { label: 'Date', role: 'pir', required: true, fieldType: 'date', autoFill: true }
        },
        {
            type: 'textInputField',
            label: 'Text Input',
            icon: AdminIcons.Edit,
            category: 'signature',
            defaultProps: { label: 'Text Input', role: 'pir', required: false, fieldType: 'textInput', placeholder: '', maxLength: 100 }
        },
        {
            type: 'checkboxField',
            label: 'Checkbox',
            icon: AdminIcons.CheckSquare,
            category: 'signature',
            defaultProps: { label: 'I agree', role: 'pir', required: true, fieldType: 'checkbox' }
        },
        {
            type: 'dropdownField',
            label: 'Dropdown',
            icon: AdminIcons.ChevronRight,
            category: 'signature',
            defaultProps: { label: 'Select', role: 'pir', required: true, fieldType: 'dropdown', options: ['Option 1', 'Option 2', 'Option 3'] }
        },
        // Legacy combo block (keeping for backward compatibility)
        {
            type: 'signatureBlock',
            label: 'Signature Block',
            icon: AdminIcons.Edit,
            category: 'legacy',
            defaultProps: { label: 'Signature', role: 'pir', required: true }
        },
        {
            type: 'acknowledgment',
            label: 'Acknowledgment',
            icon: AdminIcons.CheckSquare,
            category: 'legacy',
            defaultProps: { text: 'I acknowledge that I have read and understood the above.', required: true, role: 'pir' }
        }
    ];

    // Signer role definitions with colors
    const SIGNER_ROLES = {
        pir: {
            label: 'PIR',
            fullLabel: 'Person in Recovery',
            color: '#3B82F6',
            bgLight: 'rgba(59, 130, 246, 0.1)',
            bgMedium: 'rgba(59, 130, 246, 0.15)',
            borderColor: '#3B82F6'
        },
        family: {
            label: 'Family',
            fullLabel: 'Family Member / Guardian',
            color: '#22C55E',
            bgLight: 'rgba(34, 197, 94, 0.1)',
            bgMedium: 'rgba(34, 197, 94, 0.15)',
            borderColor: '#22C55E'
        },
        glrs: {
            label: 'GLRS',
            fullLabel: 'GLRS Representative',
            color: '#F97316',
            bgLight: 'rgba(249, 115, 22, 0.1)',
            bgMedium: 'rgba(249, 115, 22, 0.15)',
            borderColor: '#F97316'
        }
    };

    // Legacy ROLE_COLORS for backward compatibility
    const ROLE_COLORS = {
        pir: { bg: '#DBEAFE', border: '#3B82F6', text: '#1D4ED8', label: 'PIR (Blue)' },
        family: { bg: '#DCFCE7', border: '#22C55E', text: '#166534', label: 'Family (Green)' },
        glrs: { bg: '#FFEDD5', border: '#F97316', text: '#C2410C', label: 'GLRS (Orange)' }
    };

    // ==========================================
    // SERVICE AGREEMENT IMPORT UTILITY
    // ==========================================
    // Call window.importServiceAgreements() from console to import
    window.importServiceAgreements = async function() {
        const user = auth.currentUser;
        if (!user) {
            console.error('Must be logged in to import templates');
            return;
        }

        console.log('Starting Service Agreement Import...');

        // Helper to generate block ID
        let blockCounter = 0;
        const genId = () => `block_${Date.now()}_${blockCounter++}`;

        // ========================================
        // ADULT SERVICE AGREEMENT TEMPLATE
        // ========================================
        const adultBlocks = [
            // LEGAL TERMINOLOGY NOTICE
            { id: genId(), type: 'heading', content: 'Legal Terminology Notice', level: 1, order: 0 },
            { id: genId(), type: 'heading', content: 'Person in Recovery Designation', level: 2, order: 1 },
            { id: genId(), type: 'heading', content: 'Important Legal Notice Regarding Terminology', level: 3, order: 2 },
            { id: genId(), type: 'paragraph', content: 'For the purposes of this Service Agreement and all related documentation, releases, waivers, and legal instruments executed in connection with recovery coaching services provided by Guiding Light Recovery Services LLC, the individual receiving services shall be legally designated and referred to as "Person in Recovery" or by the abbreviated term "PIR" throughout all contractual documents.', order: 3 },
            { id: genId(), type: 'heading', content: 'Definitions and Legal Standing', level: 3, order: 4 },
            { id: genId(), type: 'paragraph', content: 'The term "Person in Recovery" as used herein shall mean and refer to the individual who has voluntarily entered into a contractual relationship with Guiding Light Recovery Services LLC for the purpose of receiving non-clinical recovery coaching services, peer support, and related assistance as outlined in the Service Agreement. This designation acknowledges the individual\'s active participation in their recovery journey and their voluntary engagement with recovery support services.\n\nThe abbreviated term "PIR" shall have the same legal meaning, force, and effect as the full term "Person in Recovery" and may be used interchangeably throughout all documentation for the convenience of reference and space considerations in legal forms and contracts.', order: 5 },
            { id: genId(), type: 'heading', content: 'Legal Acknowledgment', level: 3, order: 6 },
            { id: genId(), type: 'paragraph', content: 'By executing any agreement, release, waiver, or other legal document with Guiding Light Recovery Services LLC, the undersigned acknowledges and agrees that they understand and accept the designation as "Person in Recovery" or "PIR" as their legal identity for all purposes related to the provision of recovery coaching services. This terminology designation is made with respect for the individual\'s recovery journey and in recognition of their proactive engagement in seeking peer support services.\n\nThe undersigned further acknowledges that this terminology designation in no way diminishes their legal rights, responsibilities, or standing, but serves solely as a clear and consistent method of identification throughout all contractual documentation executed in connection with recovery coaching services provided by Guiding Light Recovery Services LLC.', order: 7 },
            { id: genId(), type: 'heading', content: 'Scope of Application', level: 3, order: 8 },
            { id: genId(), type: 'paragraph', content: 'This terminology designation shall apply to and be binding throughout all documents, forms, releases, waivers, agreements, and legal instruments related to the provision of recovery coaching services, including but not limited to: Service Agreements and Contracts, Release of Liability Forms, Payment and Financial Documentation, Confidentiality and Privacy Agreements, Emergency Contact and Crisis Procedures, and Professional Boundary and Termination Documentation.', order: 9 },
            { id: genId(), type: 'heading', content: 'Legal Binding Effect', level: 3, order: 10 },
            { id: genId(), type: 'paragraph', content: 'The undersigned expressly agrees that the foregoing terminology designation is intended to be as broad and inclusive as permitted by the laws of the State of California and that, if any portion thereof is held invalid, it is agreed that the balance shall, notwithstanding, continue in fully legal force and effect.\n\nThe undersigned has read and voluntarily agrees to the terminology designation set forth herein, and further agrees that no oral representations, statements, or inducements apart from the foregoing written designation have been made.', order: 11 },
            { id: genId(), type: 'heading', content: 'Acknowledgment and Agreement', level: 3, order: 12 },
            { id: genId(), type: 'paragraph', content: 'I affirm I am at least eighteen (18) years of age and am freely agreeing to this terminology designation. I have carefully read this notice and fully understand that by my signature below, I am acknowledging and accepting the legal designation as "Person in Recovery" or "PIR" for all purposes related to recovery coaching services provided by Guiding Light Recovery Services LLC.', order: 13 },
            { id: genId(), type: 'signatureBlock', label: 'PIR Acknowledgment', role: 'pir', required: true, order: 14 },
            { id: genId(), type: 'textField', label: 'PIR Name', role: 'pir', required: true, order: 15 },
            { id: genId(), type: 'signatureField', label: 'PIR Signature', role: 'pir', required: true, fieldType: 'signature', order: 16 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'pir', required: true, fieldType: 'date', autoFill: true, order: 17 },
            { id: genId(), type: 'divider', order: 18 },
            { id: genId(), type: 'textField', label: 'GLRS Representative Name', role: 'glrs', required: true, order: 19 },
            { id: genId(), type: 'textField', label: 'GLRS Representative Title', role: 'glrs', required: false, order: 20 },
            { id: genId(), type: 'signatureField', label: 'GLRS Representative Signature', role: 'glrs', required: true, fieldType: 'signature', order: 21 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'glrs', required: true, fieldType: 'date', autoFill: true, order: 22 },

            // CONSENT FOR RECOVERY COACHING SERVICES
            { id: genId(), type: 'section', number: '1', title: 'Consent for Recovery Coaching Services', order: 23 },
            { id: genId(), type: 'heading', content: 'Informed Consent and Acknowledgment', level: 3, order: 24 },
            { id: genId(), type: 'paragraph', content: 'The undersigned hereby provides informed consent to receive recovery coaching services from Guiding Light Recovery Services LLC and understands and acknowledges the following:', order: 25 },
            { id: genId(), type: 'heading', content: 'Service Understanding', level: 4, order: 26 },
            { id: genId(), type: 'paragraph', content: 'The undersigned understands that recovery coaching services provided by Guiding Light Recovery Services LLC are non-clinical peer support services based on lived experience and professional training in recovery coaching methodologies. The undersigned acknowledges that recovery coaches are not licensed therapists, counselors, medical doctors, psychiatrists, or mental health professionals and cannot provide clinical treatment, psychotherapy, medical advice, psychiatric care, or prescribe medications. The undersigned understands that recovery coaching focuses on peer support, accountability, practical recovery strategies, goal setting and achievement, resource connection, and life skills development to support the recovery journey.', order: 27 },
            { id: genId(), type: 'heading', content: 'Voluntary Participation', level: 4, order: 28 },
            { id: genId(), type: 'paragraph', content: 'The undersigned confirms that participation in recovery coaching services is completely voluntary and that no coercion, threats, or undue influence have been used to obtain this consent. The undersigned understands the right to discontinue services exists at any time by providing appropriate written notice as outlined in the Service Agreement. The undersigned acknowledges responsibility for personal recovery decisions and actions, and understands that recovery coaches provide support and guidance but do not direct or control choices.', order: 29 },
            { id: genId(), type: 'heading', content: 'Expected Benefits', level: 4, order: 30 },
            { id: genId(), type: 'paragraph', content: 'The undersigned understands that recovery coaching may provide benefits including increased accountability for maintaining recovery, peer support from individuals with lived experience in recovery, practical strategies and tools for daily recovery challenges, connection to community resources and support networks, assistance with goal setting and achievement, and encouragement during difficult periods of the recovery journey. The undersigned acknowledges that individual results vary and that success depends on many factors including personal engagement and effort.', order: 31 },
            { id: genId(), type: 'heading', content: 'Potential Risks', level: 4, order: 32 },
            { id: genId(), type: 'paragraph', content: 'The undersigned acknowledges that recovery coaching may involve certain risks including emotional discomfort when discussing difficult topics or past experiences, confronting challenging personal issues or behaviors, possible disagreement with coach suggestions or feedback, exposure to other PIRs who may be at different stages of recovery, and no guarantee of specific outcomes or continuous sobriety. The undersigned understands that recovery is a personal journey with individual challenges and results.', order: 33 },
            { id: genId(), type: 'heading', content: 'Alternative Services', level: 4, order: 34 },
            { id: genId(), type: 'paragraph', content: 'The undersigned understands that alternatives to recovery coaching include licensed clinical treatment programs, individual therapy or counseling with licensed professionals, medical addiction treatment and medication-assisted treatment, residential or inpatient treatment facilities, twelve-step or other peer support groups, and intensive outpatient programs. The undersigned acknowledges that recovery coaching may be used in conjunction with these services but does not replace the need for appropriate clinical care when indicated.', order: 35 },
            { id: genId(), type: 'heading', content: 'Confidentiality Understanding', level: 4, order: 36 },
            { id: genId(), type: 'paragraph', content: 'The undersigned understands that information shared during recovery coaching sessions will be kept confidential except in cases of imminent danger to self or others, valid court orders requiring disclosure, medical emergencies requiring information sharing, or when written consent is provided for specific information sharing. The undersigned acknowledges that many of Guiding Light Recovery Services coaches are mandated reporters, under California state law.', order: 37 },
            { id: genId(), type: 'heading', content: 'Safety and Compliance', level: 4, order: 38 },
            { id: genId(), type: 'paragraph', content: 'The undersigned agrees to maintain a safe environment during all recovery coaching activities by refraining from violence or threats, respecting professional boundaries, following safety rules during transportation services, and communicating any safety concerns immediately. The undersigned understands that failure to maintain safety standards may result in termination of services.', order: 39 },
            { id: genId(), type: 'heading', content: 'Financial Responsibility', level: 4, order: 40 },
            { id: genId(), type: 'paragraph', content: 'The undersigned acknowledges financial responsibility for the selected service package and understands the payment terms, late fee policies, and refund provisions as outlined in the Service Agreement. The undersigned agrees to provide timely payment and understands that services may be suspended for non-payment.', order: 41 },
            { id: genId(), type: 'heading', content: 'Acknowledgment of Understanding', level: 4, order: 42 },
            { id: genId(), type: 'paragraph', content: 'By signing below, the undersigned confirms: This consent form has been read and understood, the opportunity to ask questions about services was provided, all questions have been answered satisfactorily, understanding of what recovery coaching is and is not, consent to services is given voluntarily, and a copy of this consent form has been received.', order: 43 },
            { id: genId(), type: 'textField', label: 'PIR Name', role: 'pir', required: true, order: 44 },
            { id: genId(), type: 'signatureField', label: 'PIR Signature', role: 'pir', required: true, fieldType: 'signature', order: 45 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'pir', required: true, fieldType: 'date', autoFill: true, order: 46 },

            // SECTION 1: SCOPE OF SERVICES
            { id: genId(), type: 'section', number: '2', title: 'Scope of Services & Non-Clinical Disclaimer', order: 47 },
            { id: genId(), type: 'heading', content: '2.1 Services Provided', level: 3, order: 48 },
            { id: genId(), type: 'paragraph', content: 'Guiding Light Recovery Services LLC provides NON-CLINICAL recovery coaching services designed to support persons in recovery through peer-based guidance and practical assistance. Our services focus on engaging someone\'s motivation for long-term recovery by helping them develop and maintain momentum toward sustainable sobriety. We work collaboratively with persons in recovery to help them become oriented toward accomplishing both present and future goals that support their recovery journey. Our recovery coaches utilize their lived experience and professional training to provide encouragement, accountability, and practical support that complements clinical treatment. We offer Recovery Success Planning (RSP), recovery support meetings and accountability sessions, transportation assistance to recovery-related appointments (in designated service areas), recovery navigation and resource connection, and family support and education services.', order: 49 },
            { id: genId(), type: 'heading', content: '2.2 Important: What We Are Not', level: 3, order: 50 },
            { id: genId(), type: 'paragraph', content: 'Guiding Light Recovery Services LLC and its recovery coaches operate strictly within the boundaries of peer support services and are not licensed clinical professionals. We are not licensed therapists, counselors, psychologists, or mental health professionals who are qualified to provide clinical treatment or therapy. We are not medical doctors, psychiatrists, nurse practitioners, or healthcare providers who can diagnose medical conditions or prescribe medications. We are not clinical addiction treatment providers who offer medical detoxification, clinical assessments, or evidence-based therapeutic interventions. We are not emergency mental health crisis services or first responders trained to handle psychiatric emergencies or medical crises. Our role is to provide peer support, practical guidance, and encouragement based on lived experience in recovery, not to replace or substitute for professional clinical care.', order: 51 },
            { id: genId(), type: 'heading', content: '2.3 What We Cannot Do', level: 3, order: 52 },
            { id: genId(), type: 'paragraph', content: 'Guiding Light Recovery Services LLC coaches cannot and will not diagnose mental health conditions, substance use disorders, or any medical conditions as we are not licensed clinical professionals. We cannot provide clinical therapy, counseling, or treatment interventions that require professional licensure and clinical training. We cannot prescribe, recommend, or advise about medications, as this falls strictly within the scope of medical professionals. We cannot provide crisis intervention or emergency mental health services, as we are not trained emergency responders or clinicians. We cannot replace or substitute for professional medical or psychiatric care that may be essential for a person\'s recovery and overall health. However, when we recognize that a person in recovery has needs that fall outside our scope of practice, we are able to offer suggestions and referrals to appropriate licensed professionals, treatment facilities, or clinical services that can better address their specific clinical, medical, or emergency needs.', order: 53 },
            { id: genId(), type: 'heading', content: '2.4 What We Can Do', level: 3, order: 54 },
            { id: genId(), type: 'paragraph', content: 'Guiding Light Recovery Services LLC coaches provide comprehensive peer support services that draw from our lived experience in recovery and professional training in recovery coaching. We excel at helping persons in recovery set meaningful goals and develop accountability partnerships that support their long-term sobriety. We provide practical life skills coaching and guidance that helps individuals navigate the challenges of daily life while maintaining their recovery. We offer reliable transportation services to recovery-related activities, appointments, and community resources (in designated service areas), removing barriers that might otherwise impede someone\'s recovery progress. We specialize in recovery navigation and community connections, helping persons in recovery access resources, support groups, and services that strengthen their recovery foundation. We provide family education and support services that help loved ones understand the recovery process and learn how to provide effective support. Throughout all our services, we offer encouragement and mentorship based on our lived experience, providing hope and practical wisdom that comes from successfully navigating our own recovery journeys.', order: 55 },
            { id: genId(), type: 'paragraph', content: 'By signing below, I acknowledge that I understand the services that are and are not provided by Guiding Light Recovery Services LLC:', order: 56 },
            { id: genId(), type: 'textField', label: 'PIR Name', role: 'pir', required: true, order: 57 },
            { id: genId(), type: 'signatureField', label: 'PIR Signature', role: 'pir', required: true, fieldType: 'signature', order: 58 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'pir', required: true, fieldType: 'date', autoFill: true, order: 59 },

            // SECTION 2: SERVICE PACKAGE DETAILS
            { id: genId(), type: 'section', number: '3', title: 'Service Package Details', order: 60 },
            { id: genId(), type: 'heading', content: 'Understanding Our Service Packages', level: 3, order: 61 },
            { id: genId(), type: 'paragraph', content: 'Guiding Light Recovery Services LLC offers structured service packages designed to meet persons in recovery at different stages of their journey and provide varying levels of support based on individual needs. Our packages are comprehensive support systems that combine multiple elements of recovery coaching to create a holistic approach to sustainable recovery.', order: 62 },
            { id: genId(), type: 'paragraph', content: 'Each package includes Recovery Success Planning (RSP) sessions where we collaborate with you to set goals and develop action plans for your recovery journey. Individual coaching meetings provide regular accountability check-ins and peer guidance to help you stay motivated and on track. Transportation services remove barriers by providing reliable rides to recovery-related appointments, meetings, and activities (available in designated service areas only). Recovery navigation support helps you access community resources, connect with appropriate services, and navigate systems that can enhance your recovery. Family educational resources and support services help your loved ones understand the recovery process and learn how to provide effective support. All services may be provided in-person within our geographic service area or virtually via secure Google Meet video conferencing for all persons in recovery regardless of their location, providing flexibility and accessibility for comprehensive recovery support. The package structure allows you to choose the level of support that best fits your current needs while providing the flexibility to adjust your services as your recovery progresses.', order: 63 },
            { id: genId(), type: 'heading', content: 'IN-PERSON SERVICE PACKAGES (Bay Area)', level: 3, order: 64 },
            { id: genId(), type: 'paragraph', content: 'FOUNDATION PACKAGE - $1,000/month: 1 PRP (90 min one-time), 1 RSP session/month (60 min), 1 Support meeting/week (60 min), 1 Transportation ride/week, 2 Phone calls/week (30 min), Digital family education resources, Full GLRS Recovery Connect App access.\n\nGROWTH PACKAGE - $1,650/month: 1 PRP (90 min one-time), 1 RSP session/month (60 min), 2 Support meetings/week (60 min), 2 Transportation rides/week, 3 Phone calls/week (30 min), Family coaching sessions (monthly 60 min), Full App access.\n\nTRANSFORMATIVE PACKAGE - $2,200/month: 1 PRP (90 min one-time), 1 RSP session/month (60 min), 3 Support meetings/week (60 min), 2 Transportation rides/week, 4 Phone calls/week (30 min), Family coaching sessions (monthly 60 min), Monthly progress reports, Full App access.\n\nINTENSIVE PACKAGE - $3,000/month: 1 PRP (90 min one-time), 1 RSP session/month (60 min), 4 Support meetings/week (60 min), 3 Transportation rides/week, 5 Phone calls/week (30 min), Family coaching sessions (bi-weekly 60 min), Weekly progress reports, Priority response (4-hour), Full App access.', order: 65 },
            { id: genId(), type: 'heading', content: 'VIRTUAL SERVICE PACKAGES (Available Statewide)', level: 3, order: 66 },
            { id: genId(), type: 'paragraph', content: 'VIRTUAL FOUNDATION - $650/month: 1 PRP (90 min video one-time), 1 RSP session/month (60 min video), 1 Virtual support meeting/week (60 min), 2 Phone calls/week (30 min), Full App access.\n\nVIRTUAL GROWTH - $950/month: 1 PRP (90 min video one-time), 1 RSP session/month (60 min video), 2 Virtual support meetings/week (60 min), 3 Phone calls/week (30 min), Virtual family coaching (monthly 60 min), Full App access.\n\nVIRTUAL TRANSFORMATIVE - $1,300/month: 1 PRP (90 min video one-time), 1 RSP session/month (60 min video), 3 Virtual support meetings/week (60 min), 4 Phone calls/week (30 min), Virtual family coaching (monthly 60 min), Monthly progress reports, Full App access.', order: 67 },
            { id: genId(), type: 'dropdownField', label: 'Package Selected', role: 'pir', required: true, fieldType: 'dropdown', options: ['Foundation ($1,000/mo)', 'Growth ($1,650/mo)', 'Transformative ($2,200/mo)', 'Intensive ($3,000/mo)', 'Virtual Foundation ($650/mo)', 'Virtual Growth ($950/mo)', 'Virtual Transformative ($1,300/mo)'], order: 68 },
            { id: genId(), type: 'textField', label: 'PIR Name', role: 'pir', required: true, order: 69 },
            { id: genId(), type: 'signatureField', label: 'PIR Signature', role: 'pir', required: true, fieldType: 'signature', order: 70 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'pir', required: true, fieldType: 'date', autoFill: true, order: 71 },

            // SECTION 3: PAYMENT TERMS
            { id: genId(), type: 'section', number: '4', title: 'Payment Terms and Financial Responsibility', order: 72 },
            { id: genId(), type: 'heading', content: '4.1 Payment Schedule', level: 3, order: 73 },
            { id: genId(), type: 'paragraph', content: 'The undersigned acknowledges and agrees that they have selected the package indicated above for recovery coaching services, until canceled by the PIR. Payment will be due in full on the same calendar day each month as the Service Start Date to avoid confusion and eliminate the need for prorated billing calculations.\n\nPayment shall be made through the following accepted methods: cash, personal or business check made payable to Guiding Light Recovery Services LLC, Venmo electronic transfer, Zelle digital payment service, credit or debit card, or through the secure client portal on the Carepatron platform, with the undersigned bearing sole responsibility for ensuring timely payment delivery and processing regardless of the payment method selected. The undersigned understands that continued non-payment may result in suspension or termination of recovery coaching services as outlined in the termination provisions of this agreement, with services potentially suspended for payments more than fourteen (14) days past due.', order: 74 },
            { id: genId(), type: 'heading', content: '4.2 Refund Policy and Cancellation Terms', level: 3, order: 75 },
            { id: genId(), type: 'paragraph', content: 'The undersigned acknowledges and agrees that Guiding Light Recovery Services LLC operates on a monthly service delivery model with no refunds provided for partial months of service, incomplete service utilization, voluntary service reduction, or early termination for any reason, as services are considered delivered and available regardless of the extent to which the Person in Recovery chooses to utilize the offered support. The undersigned understands that cancellation of recovery coaching services requires written notice submitted at least fourteen (14) days prior to the intended cancellation date.', order: 76 },
            { id: genId(), type: 'textField', label: 'Monthly Fee', role: 'pir', required: true, placeholder: 'Enter monthly fee amount (e.g., $1,000)', order: 77 },
            { id: genId(), type: 'dateField', label: 'Service Start Date', role: 'pir', required: true, fieldType: 'date', autoFill: false, order: 78 },
            { id: genId(), type: 'textField', label: 'PIR Name', role: 'pir', required: true, order: 79 },
            { id: genId(), type: 'signatureField', label: 'PIR Signature', role: 'pir', required: true, fieldType: 'signature', order: 80 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'pir', required: true, fieldType: 'date', autoFill: true, order: 81 },

            // SECTION 4: SCHEDULING & CANCELLATION
            { id: genId(), type: 'section', number: '5', title: 'Scheduling & Cancellation Policies', order: 82 },
            { id: genId(), type: 'heading', content: '5.1 Session Scheduling and Cancellation Procedures', level: 3, order: 83 },
            { id: genId(), type: 'paragraph', content: 'The undersigned acknowledges and agrees that all recovery coaching sessions shall be scheduled by mutual agreement between the assigned recovery coach and the Person in Recovery. Cancellation of any scheduled session requires written notice provided at least twenty-four (24) hours prior to the scheduled appointment time. Sessions that are canceled without proper advance notice or sessions where the Person in Recovery fails to appear shall be considered completed sessions for package allocation purposes, with no makeup sessions provided and no credits applied to future service delivery.', order: 84 },
            { id: genId(), type: 'heading', content: '5.2 Geographic Service Areas', level: 3, order: 85 },
            { id: genId(), type: 'paragraph', content: 'Guiding Light Recovery Services LLC provides recovery coaching services throughout the San Francisco Bay Area (11 counties). Full In-Person Service Coverage: Alameda, Contra Costa, San Francisco, San Mateo, Santa Clara, Santa Cruz, and Monterey Counties. Limited Service Coverage: Marin, Sonoma, Napa, and Solano Counties. Virtual Services are available statewide.', order: 86 },
            { id: genId(), type: 'heading', content: 'Transportation Service Limitations', level: 3, order: 87 },
            { id: genId(), type: 'paragraph', content: 'All transportation services require advance scheduling at least forty-eight (48) hours prior. Each transportation service cannot exceed sixty (60) total miles round trip. Transportation is limited to recovery-related destinations approved by Guiding Light Recovery Services LLC.', order: 88 },
            { id: genId(), type: 'paragraph', content: 'By signing below, I acknowledge that I understand the scheduling policies, geographic coverage, and communication procedures outlined above:', order: 89 },
            { id: genId(), type: 'textField', label: 'PIR Name', role: 'pir', required: true, order: 90 },
            { id: genId(), type: 'signatureField', label: 'PIR Signature', role: 'pir', required: true, fieldType: 'signature', order: 91 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'pir', required: true, fieldType: 'date', autoFill: true, order: 92 },

            // SECTION 5: CRISIS & EMERGENCY
            { id: genId(), type: 'section', number: '6', title: 'Crisis & Emergency Procedures', order: 93 },
            { id: genId(), type: 'heading', content: '6.1 Crisis Situations', level: 3, order: 94 },
            { id: genId(), type: 'paragraph', content: 'In case of mental health crisis, suicidal thoughts, or medical emergency:\n- Call 911 for immediate medical emergencies\n- Call 988 for Suicide & Crisis Lifeline\n- Call your County crisis line', order: 95 },
            { id: genId(), type: 'heading', content: '6.2 Our Limitations and Emergency Response', level: 3, order: 96 },
            { id: genId(), type: 'paragraph', content: 'Guiding Light Recovery Services LLC is not licensed to handle medical or mental health emergencies. Our recovery coaches are peer support specialists, not licensed clinical professionals or emergency responders. When a person in recovery begins to experience an emergency while in our care, we will contact emergency services immediately, stay with the person until help arrives if safe to do so, and provide relevant information to emergency responders.', order: 97 },
            { id: genId(), type: 'paragraph', content: 'By signing below, I acknowledge that I have received the Crisis Resource Form from Guiding Light Recovery Services LLC, understand how to access emergency crisis support services, and understand the crisis and emergency procedures:', order: 98 },
            { id: genId(), type: 'textField', label: 'PIR Name', role: 'pir', required: true, order: 99 },
            { id: genId(), type: 'signatureField', label: 'PIR Signature', role: 'pir', required: true, fieldType: 'signature', order: 100 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'pir', required: true, fieldType: 'date', autoFill: true, order: 101 },

            // SECTION 6: CONFIDENTIALITY
            { id: genId(), type: 'section', number: '7', title: 'Confidentiality & Privacy', order: 102 },
            { id: genId(), type: 'heading', content: '7.1 Confidentiality Agreement', level: 3, order: 103 },
            { id: genId(), type: 'paragraph', content: 'All personal information, recovery-related discussions, and details shared during recovery coaching sessions will be kept strictly confidential by Guiding Light Recovery Services LLC and its coaches in accordance with professional standards.', order: 104 },
            { id: genId(), type: 'heading', content: '7.2 Limits to Confidentiality', level: 3, order: 105 },
            { id: genId(), type: 'paragraph', content: 'Confidentiality may be broken in the following circumstances: imminent danger of harm to self or others, suspected child abuse or neglect, suspected elder abuse, court orders or legal subpoenas, and with written consent for specific information sharing. Many of our coaches are mandated reporters under California law.', order: 106 },
            { id: genId(), type: 'heading', content: '7.3 Family Involvement', level: 3, order: 107 },
            { id: genId(), type: 'paragraph', content: 'When family support services are included, family members must sign separate confidentiality agreements. The Person in Recovery maintains control over what information is shared with their family members.', order: 108 },
            { id: genId(), type: 'paragraph', content: 'By signing below, I acknowledge that I understand the confidentiality policies, privacy protections, and information sharing limitations outlined above:', order: 109 },
            { id: genId(), type: 'textField', label: 'PIR Name', role: 'pir', required: true, order: 110 },
            { id: genId(), type: 'signatureField', label: 'PIR Signature', role: 'pir', required: true, fieldType: 'signature', order: 111 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'pir', required: true, fieldType: 'date', autoFill: true, order: 112 },

            // SECTION 7: LIABILITY WAIVER
            { id: genId(), type: 'section', number: '8', title: 'Comprehensive Liability Waiver and Release', order: 113 },
            { id: genId(), type: 'paragraph', content: 'The undersigned hereby acknowledges that participation in recovery coaching services involves certain inherent risks that cannot be eliminated regardless of the care taken to avoid injuries or complications.', order: 114 },
            { id: genId(), type: 'heading', content: 'Acknowledgment of Risks', level: 3, order: 115 },
            { id: genId(), type: 'paragraph', content: 'Participation in recovery coaching services may involve risks including: Transportation Risks (motor vehicle accidents, traffic incidents), Physical and Health Risks (stress from emotional discussions), Emotional and Psychological Risks (discomfort from discussing difficult topics), Virtual Service Risks (technology failures, connectivity issues), Property and Financial Risks (all decisions remain your responsibility), and Treatment Coordination Risks (potential scheduling conflicts with other treatment).', order: 116 },
            { id: genId(), type: 'heading', content: 'Limited Release of Liability', level: 3, order: 117 },
            { id: genId(), type: 'paragraph', content: 'TO THE MAXIMUM EXTENT PERMITTED BY CALIFORNIA LAW, THE UNDERSIGNED AGREES TO RELEASE, WAIVE, AND DISCHARGE GUIDING LIGHT RECOVERY SERVICES LLC FROM LIABILITY FOR ORDINARY NEGLIGENCE ONLY.\n\nThis Limited Release DOES NOT Cover: Gross Negligence, Willful or Intentional Misconduct, Criminal Acts, Sexual Misconduct, Driving Under the Influence, Reckless Driving, Breach of Confidentiality, or Professional Malpractice.', order: 118 },
            { id: genId(), type: 'heading', content: 'Insurance Acknowledgment', level: 3, order: 119 },
            { id: genId(), type: 'paragraph', content: 'Guiding Light Recovery Services LLC maintains: Commercial General Liability: $2,000,000 per occurrence; Professional Liability: $1,000,000 per occurrence.', order: 120 },
            { id: genId(), type: 'textField', label: 'PIR Name', role: 'pir', required: true, order: 121 },
            { id: genId(), type: 'signatureField', label: 'PIR Signature', role: 'pir', required: true, fieldType: 'signature', order: 122 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'pir', required: true, fieldType: 'date', autoFill: true, order: 123 },
            { id: genId(), type: 'divider', order: 124 },
            { id: genId(), type: 'textField', label: 'GLRS Representative Name', role: 'glrs', required: true, order: 125 },
            { id: genId(), type: 'textField', label: 'GLRS Representative Title', role: 'glrs', required: false, order: 126 },
            { id: genId(), type: 'signatureField', label: 'GLRS Representative Signature', role: 'glrs', required: true, fieldType: 'signature', order: 127 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'glrs', required: true, fieldType: 'date', autoFill: true, order: 128 },

            // SECTION 8: TERMINATION
            { id: genId(), type: 'section', number: '9', title: 'Termination of Services', order: 129 },
            { id: genId(), type: 'heading', content: '9.1 Voluntary Termination', level: 3, order: 130 },
            { id: genId(), type: 'paragraph', content: 'Either party may voluntarily terminate this agreement by providing written notice at least fourteen (14) calendar days prior to the intended termination date.', order: 131 },
            { id: genId(), type: 'heading', content: '9.2 Immediate Termination', level: 3, order: 132 },
            { id: genId(), type: 'paragraph', content: 'Guiding Light Recovery Services LLC reserves the right to immediately terminate services without advance notice for: non-payment of fees, violent or threatening behavior, failure to comply with safety requirements during transportation, violation of program rules, legal issues compromising safety, or any conduct that undermines the recovery-focused nature of services.', order: 133 },
            { id: genId(), type: 'paragraph', content: 'By signing below, I acknowledge that I understand the termination procedures and grounds for immediate termination outlined above:', order: 134 },
            { id: genId(), type: 'textField', label: 'PIR Name', role: 'pir', required: true, order: 135 },
            { id: genId(), type: 'signatureField', label: 'PIR Signature', role: 'pir', required: true, fieldType: 'signature', order: 136 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'pir', required: true, fieldType: 'date', autoFill: true, order: 137 },

            // SECTION 9: INFORMED CONSENT
            { id: genId(), type: 'section', number: '10', title: 'Informed Consent & Acknowledgments', order: 138 },
            { id: genId(), type: 'paragraph', content: 'The undersigned acknowledges and agrees that they fully understand that the services provided by Guiding Light Recovery Services LLC are peer support services, not clinical treatment. Recovery coaching is designed to complement and support other forms of professional treatment but does not replace clinical therapy, medical treatment, psychiatric care, or other licensed professional services.', order: 139 },
            { id: genId(), type: 'heading', content: 'Voluntary Participation', level: 3, order: 140 },
            { id: genId(), type: 'paragraph', content: 'Participation is entirely voluntary. The undersigned retains the right to ask questions, request changes, decline any specific services, and terminate services at any time with appropriate notice.', order: 141 },
            { id: genId(), type: 'paragraph', content: 'By signing below, I acknowledge that I understand my rights, the voluntary nature of services, and the limitations of recovery coaching outlined above:', order: 142 },
            { id: genId(), type: 'textField', label: 'PIR Name', role: 'pir', required: true, order: 143 },
            { id: genId(), type: 'signatureField', label: 'PIR Signature', role: 'pir', required: true, fieldType: 'signature', order: 144 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'pir', required: true, fieldType: 'date', autoFill: true, order: 145 },

            // SECTION 10: LEGAL PROVISIONS
            { id: genId(), type: 'section', number: '11', title: 'Legal Provisions', order: 146 },
            { id: genId(), type: 'heading', content: '11.1 Governing Law', level: 3, order: 147 },
            { id: genId(), type: 'paragraph', content: 'This agreement shall be governed by the laws of the State of California. Any legal proceedings shall be subject to the exclusive jurisdiction of courts located within California.', order: 148 },
            { id: genId(), type: 'heading', content: '11.2 Dispute Resolution', level: 3, order: 149 },
            { id: genId(), type: 'paragraph', content: 'Disputes shall first be addressed through direct discussion and good faith negotiation within thirty (30) days of written notice. If direct discussion fails, the parties agree to participate in mediation, with costs shared equally.', order: 150 },
            { id: genId(), type: 'heading', content: '11.3 Severability', level: 3, order: 151 },
            { id: genId(), type: 'paragraph', content: 'If any provision of this agreement is determined to be invalid or unenforceable, the remaining provisions shall continue in full force and effect.', order: 152 },
            { id: genId(), type: 'heading', content: '11.4 Entire Agreement', level: 3, order: 153 },
            { id: genId(), type: 'paragraph', content: 'This document represents the complete and entire agreement between the parties and supersedes all prior negotiations and understandings. No modifications shall be valid unless made in writing and signed by both parties.', order: 154 },
            { id: genId(), type: 'paragraph', content: 'By signing below, I acknowledge that I understand the legal provisions, arbitration agreement, and contract terms outlined above:', order: 155 },
            { id: genId(), type: 'textField', label: 'PIR Name', role: 'pir', required: true, order: 156 },
            { id: genId(), type: 'signatureField', label: 'PIR Signature', role: 'pir', required: true, fieldType: 'signature', order: 157 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'pir', required: true, fieldType: 'date', autoFill: true, order: 158 },

            // SECTION 11: FINAL SIGNATURES
            { id: genId(), type: 'section', number: '12', title: 'Final Signatures', order: 159 },
            { id: genId(), type: 'heading', content: 'Person in Recovery (PIR)', level: 3, order: 160 },
            { id: genId(), type: 'paragraph', content: 'I have read, understood, and agree to all terms of this Recovery Coaching Service Agreement. I understand the nature of recovery coaching services, the limitations of these services, and my rights and responsibilities.', order: 161 },
            { id: genId(), type: 'textField', label: 'PIR Full Legal Name', role: 'pir', required: true, order: 162 },
            { id: genId(), type: 'textField', label: 'PIR Email Address', role: 'pir', required: true, order: 163 },
            { id: genId(), type: 'textField', label: 'PIR Phone Number', role: 'pir', required: true, order: 164 },
            { id: genId(), type: 'textField', label: 'PIR Address', role: 'pir', required: true, order: 165 },
            { id: genId(), type: 'signatureField', label: 'PIR Final Signature', role: 'pir', required: true, fieldType: 'signature', order: 166 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'pir', required: true, fieldType: 'date', autoFill: true, order: 167 }
        ];

        // Create Adult Template
        const adultTemplate = {
            name: 'Service Agreement - Adult',
            type: 'document',
            status: 'active',
            description: 'Complete service agreement for adult persons in recovery (18+). Includes informed consent, scope of services, payment terms, confidentiality, liability waiver, and all required signatures.',
            content: {
                blocks: adultBlocks,
                coverPageId: null,
                headerId: null,
                footerId: null,
                endPageId: null
            },
            signerRoles: [
                { role: 'pir', label: 'Person in Recovery', order: 0, required: true },
                { role: 'glrs', label: 'GLRS Representative', order: 1, required: true }
            ],
            tenantId: CURRENT_TENANT || 'full-service',
            createdBy: user.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        console.log('Saving Adult Service Agreement template...');
        const adultRef = await db.collection('templates').add(adultTemplate);
        console.log('Adult template saved with ID:', adultRef.id);

        // Reset block counter for adolescent
        blockCounter = 0;

        // ========================================
        // ADOLESCENT SERVICE AGREEMENT TEMPLATE
        // ========================================
        const adolescentBlocks = [
            // LEGAL TERMINOLOGY NOTICE - ADOLESCENT
            { id: genId(), type: 'heading', content: 'Legal Terminology Notice', level: 1, order: 0 },
            { id: genId(), type: 'heading', content: 'Adolescent Person in Recovery Designation', level: 2, order: 1 },
            { id: genId(), type: 'heading', content: 'Important Legal Notice Regarding Terminology', level: 3, order: 2 },
            { id: genId(), type: 'paragraph', content: 'For the purposes of this Service Agreement and all related documentation, the minor individual receiving services shall be legally designated and referred to as "Adolescent Person in Recovery" or by the abbreviated term "Adolescent PIR" throughout all contractual documents.', order: 3 },
            { id: genId(), type: 'heading', content: 'Definitions and Legal Standing', level: 3, order: 4 },
            { id: genId(), type: 'paragraph', content: 'The term "Adolescent Person in Recovery" shall mean and refer to the minor individual (under 18 years of age) who will receive non-clinical recovery coaching services through parental/guardian consent and authorization. This designation acknowledges the minor\'s active participation in their recovery journey while recognizing parental authority, responsibility, and legal standing regarding all decisions related to the provision of recovery coaching services.', order: 5 },
            { id: genId(), type: 'heading', content: 'Parental Consent and Legal Authority', level: 3, order: 6 },
            { id: genId(), type: 'paragraph', content: 'By executing any agreement with Guiding Light Recovery Services LLC, the Parent/Guardian acknowledges and agrees that they have full legal authority to consent to recovery coaching services for their minor child.', order: 7 },
            { id: genId(), type: 'heading', content: 'Acknowledgment and Agreement', level: 3, order: 8 },
            { id: genId(), type: 'paragraph', content: 'I affirm I am the parent or legal guardian of the minor named below and have full legal authority to enter into this agreement. I have carefully read this notice and fully understand that by my signature below, I am acknowledging and accepting the legal designation as "Adolescent Person in Recovery" or "Adolescent PIR" for my minor child.', order: 9 },
            { id: genId(), type: 'textField', label: 'Adolescent PIR Name', role: 'pir', required: true, order: 10 },
            { id: genId(), type: 'textField', label: 'Parent/Guardian Name', role: 'family', required: true, order: 11 },
            { id: genId(), type: 'signatureField', label: 'Parent/Guardian Signature', role: 'family', required: true, fieldType: 'signature', order: 12 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'family', required: true, fieldType: 'date', autoFill: true, order: 13 },
            { id: genId(), type: 'divider', order: 14 },
            { id: genId(), type: 'textField', label: 'GLRS Representative Name', role: 'glrs', required: true, order: 15 },
            { id: genId(), type: 'textField', label: 'GLRS Representative Title', role: 'glrs', required: false, order: 16 },
            { id: genId(), type: 'signatureField', label: 'GLRS Representative Signature', role: 'glrs', required: true, fieldType: 'signature', order: 17 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'glrs', required: true, fieldType: 'date', autoFill: true, order: 18 },

            // CONSENT FOR ADOLESCENT SERVICES
            { id: genId(), type: 'section', number: '1', title: 'Consent for Adolescent Recovery Coaching Services', order: 19 },
            { id: genId(), type: 'heading', content: 'Informed Consent and Acknowledgment', level: 3, order: 20 },
            { id: genId(), type: 'paragraph', content: 'The undersigned Parent/Guardian hereby provides informed consent for their minor child to receive adolescent recovery coaching services from Guiding Light Recovery Services LLC.', order: 21 },
            { id: genId(), type: 'heading', content: 'Service Understanding', level: 4, order: 22 },
            { id: genId(), type: 'paragraph', content: 'Adolescent recovery coaching services are non-clinical peer support services adapted for youth ages 13-17. Recovery coaches are not licensed therapists, counselors, medical doctors, or mental health professionals. Coaching focuses on age-appropriate peer support, accountability, practical recovery strategies, goal setting, resource connection, life skills development, and family involvement.', order: 23 },
            { id: genId(), type: 'heading', content: 'Voluntary Participation', level: 4, order: 24 },
            { id: genId(), type: 'paragraph', content: 'Consent for the minor child\'s participation is given voluntarily. The Parent/Guardian understands the right to discontinue services exists at any time. While parental authority is maintained, the adolescent participant will be encouraged to engage willingly in services.', order: 25 },
            { id: genId(), type: 'heading', content: 'Expected Benefits', level: 4, order: 26 },
            { id: genId(), type: 'paragraph', content: 'Benefits may include increased accountability appropriate for teenage development, peer support, practical strategies for navigating recovery during teenage years, connection to youth-appropriate resources, positive adult mentorship, and enhanced family communication.', order: 27 },
            { id: genId(), type: 'heading', content: 'Confidentiality Understanding', level: 4, order: 28 },
            { id: genId(), type: 'paragraph', content: 'Parents/guardians will receive updates on attendance, participation, safety concerns, and progress. Information will be disclosed in cases of imminent danger, suspected abuse or neglect, court orders, or medical emergencies. Recovery coaches working with minors maintain mandatory reporting obligations for child safety.', order: 29 },
            { id: genId(), type: 'textField', label: 'Adolescent PIR Name', role: 'pir', required: true, order: 30 },
            { id: genId(), type: 'dateField', label: 'Adolescent Date of Birth', role: 'pir', required: true, fieldType: 'date', autoFill: false, order: 31 },
            { id: genId(), type: 'textField', label: 'Parent/Guardian Name', role: 'family', required: true, order: 32 },
            { id: genId(), type: 'signatureField', label: 'Parent/Guardian Signature', role: 'family', required: true, fieldType: 'signature', order: 33 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'family', required: true, fieldType: 'date', autoFill: true, order: 34 },

            // SCOPE OF SERVICES
            { id: genId(), type: 'section', number: '2', title: 'Scope of Services & Non-Clinical Disclaimer', order: 35 },
            { id: genId(), type: 'heading', content: '2.1 Services Provided for Adolescents', level: 3, order: 36 },
            { id: genId(), type: 'paragraph', content: 'Guiding Light Recovery Services LLC provides NON-CLINICAL adolescent recovery coaching services designed to support young people in recovery (ages 13-17) through age-appropriate peer-based guidance with enhanced parental involvement. Services include age-appropriate Recovery Success Planning (RSP), adolescent recovery support meetings, transportation assistance (with parental approval), recovery navigation, comprehensive family support and education, and coordination with educational institutions when authorized by parents.', order: 37 },
            { id: genId(), type: 'heading', content: '2.2 What We Are Not', level: 3, order: 38 },
            { id: genId(), type: 'paragraph', content: 'We are not licensed therapists, medical doctors, clinical addiction treatment providers, emergency mental health services, school counselors, or substitute parents. Our role is peer support based on lived experience, not clinical care or parental authority replacement.', order: 39 },
            { id: genId(), type: 'heading', content: '2.3 What We Can Do', level: 3, order: 40 },
            { id: genId(), type: 'paragraph', content: 'We help adolescents set age-appropriate goals, provide practical life skills coaching, offer transportation to recovery activities (with parental approval), specialize in youth-appropriate recovery navigation, provide comprehensive family education, and offer encouragement and mentorship.', order: 41 },
            { id: genId(), type: 'textField', label: 'Adolescent PIR Name', role: 'pir', required: true, order: 42 },
            { id: genId(), type: 'textField', label: 'Parent/Guardian Name', role: 'family', required: true, order: 43 },
            { id: genId(), type: 'signatureField', label: 'Parent/Guardian Signature', role: 'family', required: true, fieldType: 'signature', order: 44 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'family', required: true, fieldType: 'date', autoFill: true, order: 45 },

            // SERVICE PACKAGES
            { id: genId(), type: 'section', number: '3', title: 'Service Package Details', order: 46 },
            { id: genId(), type: 'heading', content: 'Teen Service Packages', level: 3, order: 47 },
            { id: genId(), type: 'paragraph', content: 'TEEN FOUNDATION - $1,400/month: 1 Teen Recovery Profile (90 min, parent present), 1 RSP session/month, 1 Teen support meeting/week, 1 Transportation ride/week, 2 Parent check-in calls/week, 1 Phone call/week with teen, School coordination support, Digital family education resources.\n\nTEEN GROWTH - $2,100/month: All Foundation features plus 2 Teen support meetings/week, 2 Transportation rides/week, 3 Parent check-in calls/week, 2 Phone calls/week with teen, Monthly parent coaching session, School/therapist coordination.\n\nTEEN TRANSFORMATIVE - $2,800/month: All Growth features plus 3 Teen support meetings/week, 4 Parent check-in calls/week, 3 Phone calls/week with teen, Bi-weekly family sessions, Weekly progress reports, School/IEP coordination.', order: 48 },
            { id: genId(), type: 'dropdownField', label: 'Package Selected', role: 'family', required: true, fieldType: 'dropdown', options: ['Teen Foundation ($1,400/mo)', 'Teen Growth ($2,100/mo)', 'Teen Transformative ($2,800/mo)'], order: 49 },
            { id: genId(), type: 'textField', label: 'Adolescent PIR Name', role: 'pir', required: true, order: 50 },
            { id: genId(), type: 'textField', label: 'Parent/Guardian Name', role: 'family', required: true, order: 51 },
            { id: genId(), type: 'signatureField', label: 'Parent/Guardian Signature', role: 'family', required: true, fieldType: 'signature', order: 52 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'family', required: true, fieldType: 'date', autoFill: true, order: 53 },

            // PAYMENT TERMS
            { id: genId(), type: 'section', number: '4', title: 'Payment Terms and Parental Financial Responsibility', order: 54 },
            { id: genId(), type: 'paragraph', content: 'The Parent/Guardian acknowledges and agrees to full financial responsibility for the selected adolescent service package. Payment is due monthly on the same calendar day as the Service Start Date. Cancellation requires written notice at least fourteen (14) days prior.', order: 55 },
            { id: genId(), type: 'textField', label: 'Monthly Fee', role: 'family', required: true, placeholder: 'Enter monthly fee amount (e.g., $1,400)', order: 56 },
            { id: genId(), type: 'dateField', label: 'Service Start Date', role: 'family', required: true, fieldType: 'date', autoFill: false, order: 57 },
            { id: genId(), type: 'textField', label: 'Adolescent PIR Name', role: 'pir', required: true, order: 58 },
            { id: genId(), type: 'textField', label: 'Parent/Guardian Name', role: 'family', required: true, order: 59 },
            { id: genId(), type: 'signatureField', label: 'Parent/Guardian Signature', role: 'family', required: true, fieldType: 'signature', order: 60 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'family', required: true, fieldType: 'date', autoFill: true, order: 61 },

            // SCHEDULING
            { id: genId(), type: 'section', number: '5', title: 'Scheduling & Cancellation Policies', order: 62 },
            { id: genId(), type: 'paragraph', content: 'Sessions shall be scheduled by mutual agreement. Cancellation requires 24 hours notice. Transportation requires 48 hours advance scheduling and individual written parental approval for each trip. Parents will receive notification of pickup/drop-off times and immediate notification of any delays or incidents.', order: 63 },
            { id: genId(), type: 'textField', label: 'Adolescent PIR Name', role: 'pir', required: true, order: 64 },
            { id: genId(), type: 'textField', label: 'Parent/Guardian Name', role: 'family', required: true, order: 65 },
            { id: genId(), type: 'signatureField', label: 'Parent/Guardian Signature', role: 'family', required: true, fieldType: 'signature', order: 66 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'family', required: true, fieldType: 'date', autoFill: true, order: 67 },

            // CRISIS PROCEDURES
            { id: genId(), type: 'section', number: '6', title: 'Crisis & Emergency Procedures', order: 68 },
            { id: genId(), type: 'paragraph', content: 'In case of emergency: Call 911, Call 988 for Suicide & Crisis Lifeline, IMMEDIATELY notify parent/guardian. Parents will be contacted immediately for ANY crisis situation. We are not licensed to handle emergencies involving minors but will contact emergency services and parents immediately.', order: 69 },
            { id: genId(), type: 'textField', label: 'Adolescent PIR Name', role: 'pir', required: true, order: 70 },
            { id: genId(), type: 'textField', label: 'Parent/Guardian Name', role: 'family', required: true, order: 71 },
            { id: genId(), type: 'signatureField', label: 'Parent/Guardian Signature', role: 'family', required: true, fieldType: 'signature', order: 72 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'family', required: true, fieldType: 'date', autoFill: true, order: 73 },

            // CONFIDENTIALITY
            { id: genId(), type: 'section', number: '7', title: 'Confidentiality & Privacy', order: 74 },
            { id: genId(), type: 'paragraph', content: 'Confidentiality for minors includes mandatory parental involvement. Parents will receive: general progress updates, attendance and engagement information, behavioral observations, safety issues, and recommendations. Mandatory reporting requirements apply for suspected abuse, self-harm risks, threats to others, and court-ordered disclosures.', order: 75 },
            { id: genId(), type: 'textField', label: 'Adolescent PIR Name', role: 'pir', required: true, order: 76 },
            { id: genId(), type: 'textField', label: 'Parent/Guardian Name', role: 'family', required: true, order: 77 },
            { id: genId(), type: 'signatureField', label: 'Parent/Guardian Signature', role: 'family', required: true, fieldType: 'signature', order: 78 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'family', required: true, fieldType: 'date', autoFill: true, order: 79 },

            // LIABILITY WAIVER
            { id: genId(), type: 'section', number: '8', title: 'Comprehensive Liability Waiver', order: 80 },
            { id: genId(), type: 'paragraph', content: 'The Parent/Guardian acknowledges that participation involves inherent risks. TO THE MAXIMUM EXTENT PERMITTED BY CALIFORNIA LAW, the Parent/Guardian agrees to release Guiding Light Recovery Services LLC from liability for ordinary negligence only. This release does NOT cover gross negligence, willful misconduct, criminal acts, sexual misconduct, DUI, reckless driving, breach of confidentiality, or professional malpractice.\n\nInsurance Coverage: Commercial General Liability $2,000,000, Professional Liability $1,000,000.', order: 81 },
            { id: genId(), type: 'textField', label: 'Adolescent PIR Name', role: 'pir', required: true, order: 82 },
            { id: genId(), type: 'textField', label: 'Parent/Guardian Name', role: 'family', required: true, order: 83 },
            { id: genId(), type: 'signatureField', label: 'Parent/Guardian Signature', role: 'family', required: true, fieldType: 'signature', order: 84 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'family', required: true, fieldType: 'date', autoFill: true, order: 85 },
            { id: genId(), type: 'divider', order: 86 },
            { id: genId(), type: 'textField', label: 'GLRS Representative Name', role: 'glrs', required: true, order: 87 },
            { id: genId(), type: 'textField', label: 'GLRS Representative Title', role: 'glrs', required: false, order: 88 },
            { id: genId(), type: 'signatureField', label: 'GLRS Representative Signature', role: 'glrs', required: true, fieldType: 'signature', order: 89 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'glrs', required: true, fieldType: 'date', autoFill: true, order: 90 },

            // TERMINATION
            { id: genId(), type: 'section', number: '9', title: 'Termination of Services', order: 91 },
            { id: genId(), type: 'paragraph', content: 'The Parent/Guardian may terminate this agreement at any time with fourteen (14) days written notice. The minor cannot independently terminate services without parental consent. Immediate termination may occur for non-payment, violent behavior, safety violations, lack of parental cooperation, or conduct that undermines the recovery-focused nature of services.', order: 92 },
            { id: genId(), type: 'textField', label: 'Adolescent PIR Name', role: 'pir', required: true, order: 93 },
            { id: genId(), type: 'textField', label: 'Parent/Guardian Name', role: 'family', required: true, order: 94 },
            { id: genId(), type: 'signatureField', label: 'Parent/Guardian Signature', role: 'family', required: true, fieldType: 'signature', order: 95 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'family', required: true, fieldType: 'date', autoFill: true, order: 96 },

            // INFORMED CONSENT
            { id: genId(), type: 'section', number: '10', title: 'Informed Consent & Acknowledgments', order: 97 },
            { id: genId(), type: 'paragraph', content: 'The Parent/Guardian acknowledges that services are peer support, not clinical treatment. They retain all parental rights including the right to seek clinical treatment, make educational decisions, terminate services, and maintain full decision-making authority regarding their child\'s care.', order: 98 },
            { id: genId(), type: 'textField', label: 'Adolescent PIR Name', role: 'pir', required: true, order: 99 },
            { id: genId(), type: 'textField', label: 'Parent/Guardian Name', role: 'family', required: true, order: 100 },
            { id: genId(), type: 'signatureField', label: 'Parent/Guardian Signature', role: 'family', required: true, fieldType: 'signature', order: 101 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'family', required: true, fieldType: 'date', autoFill: true, order: 102 },

            // LEGAL PROVISIONS
            { id: genId(), type: 'section', number: '11', title: 'Legal Provisions', order: 103 },
            { id: genId(), type: 'paragraph', content: 'This agreement is governed by California law including laws governing services to minors. Disputes shall first be addressed through negotiation within thirty (30) days, then mediation if needed. All modifications require parental consent and signature.', order: 104 },
            { id: genId(), type: 'textField', label: 'Adolescent PIR Name', role: 'pir', required: true, order: 105 },
            { id: genId(), type: 'textField', label: 'Parent/Guardian Name', role: 'family', required: true, order: 106 },
            { id: genId(), type: 'signatureField', label: 'Parent/Guardian Signature', role: 'family', required: true, fieldType: 'signature', order: 107 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'family', required: true, fieldType: 'date', autoFill: true, order: 108 },

            // FINAL SIGNATURES
            { id: genId(), type: 'section', number: '12', title: 'Final Signatures', order: 109 },
            { id: genId(), type: 'heading', content: 'Parent/Guardian Primary Signatory', level: 3, order: 110 },
            { id: genId(), type: 'paragraph', content: 'I have read, understood, and agree to all terms of this Adolescent Recovery Coaching Service Agreement. I am the parent or legal guardian with full legal authority and accept full financial responsibility.', order: 111 },
            { id: genId(), type: 'textField', label: 'Adolescent PIR Full Legal Name', role: 'pir', required: true, order: 112 },
            { id: genId(), type: 'dateField', label: 'Adolescent Date of Birth', role: 'pir', required: true, fieldType: 'date', autoFill: false, order: 113 },
            { id: genId(), type: 'textField', label: 'Adolescent Address', role: 'pir', required: true, order: 114 },
            { id: genId(), type: 'textField', label: 'Parent/Guardian Full Legal Name', role: 'family', required: true, order: 115 },
            { id: genId(), type: 'textField', label: 'Relationship to Adolescent', role: 'family', required: true, order: 116 },
            { id: genId(), type: 'textField', label: 'Parent/Guardian Email', role: 'family', required: true, order: 117 },
            { id: genId(), type: 'textField', label: 'Parent/Guardian Phone', role: 'family', required: true, order: 118 },
            { id: genId(), type: 'signatureField', label: 'Parent/Guardian Final Signature', role: 'family', required: true, fieldType: 'signature', order: 119 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'family', required: true, fieldType: 'date', autoFill: true, order: 120 },
            { id: genId(), type: 'divider', order: 121 },
            { id: genId(), type: 'textField', label: 'GLRS Representative Name', role: 'glrs', required: true, order: 122 },
            { id: genId(), type: 'textField', label: 'GLRS Representative Title', role: 'glrs', required: false, order: 123 },
            { id: genId(), type: 'signatureField', label: 'GLRS Representative Signature', role: 'glrs', required: true, fieldType: 'signature', order: 124 },
            { id: genId(), type: 'dateField', label: 'Date', role: 'glrs', required: true, fieldType: 'date', autoFill: true, order: 125 }
        ];

        // Create Adolescent Template
        const adolescentTemplate = {
            name: 'Service Agreement - Adolescent',
            type: 'document',
            status: 'active',
            description: 'Complete service agreement for adolescent persons in recovery (ages 13-17). Includes parental consent, informed consent, scope of services, payment terms, confidentiality with enhanced parental involvement, liability waiver, and all required signatures.',
            content: {
                blocks: adolescentBlocks,
                coverPageId: null,
                headerId: null,
                footerId: null,
                endPageId: null
            },
            signerRoles: [
                { role: 'family', label: 'Parent/Guardian', order: 0, required: true },
                { role: 'pir', label: 'Adolescent PIR (if 16+)', order: 1, required: false },
                { role: 'glrs', label: 'GLRS Representative', order: 2, required: true }
            ],
            tenantId: CURRENT_TENANT || 'full-service',
            createdBy: user.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        console.log('Saving Adolescent Service Agreement template...');
        const adolescentRef = await db.collection('templates').add(adolescentTemplate);
        console.log('Adolescent template saved with ID:', adolescentRef.id);

        console.log('=================================');
        console.log('SERVICE AGREEMENT IMPORT COMPLETE');
        console.log('=================================');
        console.log('Adult template ID:', adultRef.id);
        console.log('Adolescent template ID:', adolescentRef.id);
        console.log('Both templates are now ACTIVE and ready for use.');
        console.log('Refresh the Templates page to see them in the library.');

        return { adultId: adultRef.id, adolescentId: adolescentRef.id };
    };

    // ==========================================
    // TEMPLATE EDITOR MODAL (Three-Panel Layout)
    // ==========================================
    function TemplateEditorModal({ template, user, onClose, onSave, isMobile, isTablet }) {
        // Core state
        const [blocks, setBlocks] = useState(template?.content?.blocks || []);
        const [selectedBlockId, setSelectedBlockId] = useState(null);
        const [templateName, setTemplateName] = useState(template?.name || 'Untitled Template');
        const [templateDescription, setTemplateDescription] = useState(template?.description || '');
        const [templateStatus, setTemplateStatus] = useState(template?.status || 'draft');

        // Component references (for document templates)
        const [components, setComponents] = useState(template?.components || {
            coverPageId: null,
            headerId: null,
            footerId: null,
            endPageId: null
        });

        // Available components for dropdowns
        const [availableComponents, setAvailableComponents] = useState({
            covers: [],
            headers: [],
            footers: [],
            endPages: []
        });

        // Loaded component data for preview
        const [loadedComponents, setLoadedComponents] = useState({
            coverPage: null,
            header: null,
            footer: null,
            endPage: null
        });

        // UI state
        const [saveStatus, setSaveStatus] = useState('saved'); // saved, saving, unsaved
        const [leftPanelCollapsed, setLeftPanelCollapsed] = useState(false);
        const [rightPanelCollapsed, setRightPanelCollapsed] = useState(false);
        const [draggedBlockType, setDraggedBlockType] = useState(null);
        const [dragOverIndex, setDragOverIndex] = useState(null);
        const [draggedBlockId, setDraggedBlockId] = useState(null);

        // Track unsaved changes
        const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);

        // Preview mode state
        const [previewMode, setPreviewMode] = useState(false);
        const canvasScrollRef = React.useRef(null);
        const [savedScrollPosition, setSavedScrollPosition] = useState(0);

        // Toggle preview mode handler
        const handleTogglePreview = () => {
            if (hasUnsavedChanges && !previewMode) {
                const confirmSwitch = window.confirm('You have unsaved changes. Switch to preview anyway?');
                if (!confirmSwitch) return;
            }
            if (!previewMode) {
                // Entering preview - save scroll position
                setSavedScrollPosition(canvasScrollRef.current?.scrollTop || 0);
            } else {
                // Exiting preview - restore scroll position
                setTimeout(() => {
                    canvasScrollRef.current?.scrollTo(0, savedScrollPosition);
                }, 100);
            }
            setPreviewMode(!previewMode);
        };

        // Auto-save debounce ref
        const saveTimeoutRef = React.useRef(null);

        // Load available components on mount
        useEffect(() => {
            const loadAvailableComponents = async () => {
                try {
                    const snapshot = await db.collection('templates')
                        .where('tenantId', '==', CURRENT_TENANT)
                        .where('status', '==', 'active')
                        .get();

                    const comps = { covers: [], headers: [], footers: [], endPages: [] };
                    snapshot.docs.forEach(doc => {
                        const data = { id: doc.id, ...doc.data() };
                        switch (data.type) {
                            case 'cover': comps.covers.push(data); break;
                            case 'header': comps.headers.push(data); break;
                            case 'footer': comps.footers.push(data); break;
                            case 'endPage': comps.endPages.push(data); break;
                        }
                    });
                    setAvailableComponents(comps);
                } catch (error) {
                    console.error('Error loading components:', error);
                }
            };
            loadAvailableComponents();
        }, []);

        // Load referenced components for preview
        useEffect(() => {
            const loadReferencedComponents = async () => {
                const loaded = { coverPage: null, header: null, footer: null, endPage: null };
                const promises = [];

                if (components.coverPageId) {
                    promises.push(
                        db.collection('templates').doc(components.coverPageId).get()
                            .then(doc => { if (doc.exists) loaded.coverPage = { id: doc.id, ...doc.data() }; })
                            .catch(() => console.warn('Cover page not found'))
                    );
                }
                if (components.headerId) {
                    promises.push(
                        db.collection('templates').doc(components.headerId).get()
                            .then(doc => { if (doc.exists) loaded.header = { id: doc.id, ...doc.data() }; })
                            .catch(() => console.warn('Header not found'))
                    );
                }
                if (components.footerId) {
                    promises.push(
                        db.collection('templates').doc(components.footerId).get()
                            .then(doc => { if (doc.exists) loaded.footer = { id: doc.id, ...doc.data() }; })
                            .catch(() => console.warn('Footer not found'))
                    );
                }
                if (components.endPageId) {
                    promises.push(
                        db.collection('templates').doc(components.endPageId).get()
                            .then(doc => { if (doc.exists) loaded.endPage = { id: doc.id, ...doc.data() }; })
                            .catch(() => console.warn('End page not found'))
                    );
                }

                await Promise.all(promises);
                setLoadedComponents(loaded);
            };
            loadReferencedComponents();
        }, [components]);

        // Handle component change
        const handleComponentChange = useCallback((componentType, componentId) => {
            setComponents(prev => ({
                ...prev,
                [`${componentType}Id`]: componentId || null
            }));
            markUnsaved();
        }, []);

        // Get selected block
        const selectedBlock = blocks.find(b => b.id === selectedBlockId);

        // Generate unique block ID
        const generateBlockId = () => `block_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

        // Mark as unsaved and trigger auto-save
        const markUnsaved = useCallback(() => {
            setHasUnsavedChanges(true);
            setSaveStatus('unsaved');

            // Clear existing timeout
            if (saveTimeoutRef.current) {
                clearTimeout(saveTimeoutRef.current);
            }

            // Set new auto-save timeout (2 seconds)
            saveTimeoutRef.current = setTimeout(() => {
                handleSave();
            }, 2000);
        }, []);

        // Update block
        const updateBlock = useCallback((blockId, updates) => {
            setBlocks(prev => prev.map(b =>
                b.id === blockId ? { ...b, ...updates } : b
            ));
            markUnsaved();
        }, [markUnsaved]);

        // Add block from palette
        const addBlock = useCallback((blockType, insertIndex = null) => {
            const blockDef = BLOCK_TYPES.find(b => b.type === blockType);
            if (!blockDef) return;

            const newBlock = {
                id: generateBlockId(),
                type: blockType,
                ...blockDef.defaultProps,
                order: insertIndex !== null ? insertIndex : blocks.length
            };

            setBlocks(prev => {
                if (insertIndex !== null) {
                    const updated = [...prev];
                    updated.splice(insertIndex, 0, newBlock);
                    // Update order for all blocks
                    return updated.map((b, i) => ({ ...b, order: i }));
                }
                return [...prev, newBlock];
            });

            setSelectedBlockId(newBlock.id);
            markUnsaved();
        }, [blocks.length, markUnsaved]);

        // Delete block
        const deleteBlock = useCallback((blockId) => {
            setBlocks(prev => {
                const filtered = prev.filter(b => b.id !== blockId);
                return filtered.map((b, i) => ({ ...b, order: i }));
            });
            if (selectedBlockId === blockId) {
                setSelectedBlockId(null);
            }
            markUnsaved();
        }, [selectedBlockId, markUnsaved]);

        // Move block
        const moveBlock = useCallback((fromIndex, toIndex) => {
            if (fromIndex === toIndex) return;

            setBlocks(prev => {
                const updated = [...prev];
                const [movedBlock] = updated.splice(fromIndex, 1);
                updated.splice(toIndex, 0, movedBlock);
                return updated.map((b, i) => ({ ...b, order: i }));
            });
            markUnsaved();
        }, [markUnsaved]);

        // Save to Firestore
        const handleSave = async () => {
            setSaveStatus('saving');
            try {
                const contentData = {
                    blocks: blocks.map((b, i) => ({ ...b, order: i }))
                };

                await db.collection('templates').doc(template.id).update({
                    name: templateName,
                    description: templateDescription,
                    status: templateStatus,
                    content: contentData,
                    components: components, // Include component references
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                setSaveStatus('saved');
                setHasUnsavedChanges(false);
            } catch (error) {
                console.error('Error saving template:', error);
                setSaveStatus('unsaved');
                alert('Failed to save: ' + error.message);
            }
        };

        // Handle close with unsaved changes warning
        const handleClose = () => {
            if (hasUnsavedChanges) {
                if (confirm('You have unsaved changes. Are you sure you want to close?')) {
                    if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);
                    onClose();
                }
            } else {
                onClose();
            }
        };

        // Cleanup on unmount
        useEffect(() => {
            return () => {
                if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);
            };
        }, []);

        // Handle Escape key
        useEffect(() => {
            const handleKeyDown = (e) => {
                if (e.key === 'Escape') {
                    handleClose();
                }
            };
            window.addEventListener('keydown', handleKeyDown);
            return () => window.removeEventListener('keydown', handleKeyDown);
        }, [hasUnsavedChanges]);

        // Drag handlers for palette blocks
        const handlePaletteDragStart = (e, blockType) => {
            setDraggedBlockType(blockType);
            e.dataTransfer.effectAllowed = 'copy';
        };

        const handlePaletteDragEnd = () => {
            setDraggedBlockType(null);
            setDragOverIndex(null);
        };

        // SIMPLE DRAG-DROP: Drag a block, drop it on another block's position
        const handleCanvasBlockDragStart = (e, blockId, index) => {
            setDraggedBlockId(blockId);
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', blockId);
        };

        const handleCanvasBlockDragEnd = () => {
            setDraggedBlockId(null);
            setDragOverIndex(null);
        };

        // Helper: Find which page section an index belongs to (0-indexed sections separated by pageBreaks)
        const getPageSection = (blockIndex) => {
            let section = 0;
            for (let i = 0; i < blockIndex && i < blocks.length; i++) {
                if (blocks[i].type === 'pageBreak') {
                    section++;
                }
            }
            return section;
        };

        // Helper: Check if a drop position would cross a page break
        const wouldCrossPageBreak = (fromIndex, toIndex) => {
            if (fromIndex === -1 || fromIndex === toIndex) return false;
            return getPageSection(fromIndex) !== getPageSection(toIndex);
        };

        // SIMPLE DROP: Move block to new position
        const handleCanvasDrop = (e, toIndex) => {
            e.preventDefault();

            if (draggedBlockType) {
                // Adding new block from palette
                addBlock(draggedBlockType, toIndex);
            } else if (draggedBlockId) {
                // Reordering existing block
                const fromIndex = blocks.findIndex(b => b.id === draggedBlockId);
                if (fromIndex !== -1 && fromIndex !== toIndex) {
                    moveBlock(fromIndex, toIndex);
                }
            }

            setDraggedBlockType(null);
            setDraggedBlockId(null);
            setDragOverIndex(null);
        };

        // Mobile check - show message instead of editor
        if (isMobile) {
            return (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0,0,0,0.5)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1000,
                    padding: '20px'
                }}>
                    <div style={{
                        background: DESIGN.bgCard,
                        borderRadius: DESIGN.radiusModal,
                        padding: '32px',
                        maxWidth: '400px',
                        textAlign: 'center'
                    }}>
                        <AdminIcons.Monitor size={48} color={DESIGN.gray400} style={{ marginBottom: '16px' }} />
                        <h3 style={{ margin: '0 0 8px 0', color: DESIGN.gray600 }}>
                            Desktop Required
                        </h3>
                        <p style={{ margin: '0 0 20px 0', color: DESIGN.gray400, fontSize: DESIGN.fontSizeMetadata }}>
                            The template editor requires a larger screen. Please use a desktop or tablet device.
                        </p>
                        <button
                            onClick={onClose}
                            style={{
                                padding: '12px 24px',
                                background: 'linear-gradient(135deg, #0077CC 0%, #005A9C 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: DESIGN.radiusInput,
                                fontWeight: '600',
                                cursor: 'pointer'
                            }}
                        >
                            Go Back
                        </button>
                    </div>
                </div>
            );
        }

        return (
            <div style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: DESIGN.bgPage,
                zIndex: 1000,
                display: 'flex',
                flexDirection: 'column',
                animation: 'fadeIn 0.3s ease-out'
            }}>
                {/* TOP TOOLBAR */}
                <div style={{
                    height: '60px',
                    background: DESIGN.bgCard,
                    borderBottom: `1px solid ${DESIGN.gray200}`,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                    padding: '0 20px',
                    flexShrink: 0
                }}>
                    {/* Left: Back button and template name */}
                    <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                        <button
                            onClick={handleClose}
                            style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '6px',
                                padding: '8px 12px',
                                background: 'transparent',
                                border: `1px solid ${DESIGN.gray200}`,
                                borderRadius: DESIGN.radiusInput,
                                color: DESIGN.gray500,
                                fontSize: DESIGN.fontSizeMetadata,
                                cursor: 'pointer'
                            }}
                        >
                            <AdminIcons.ArrowLeft size={16} />
                            Back
                        </button>

                        <div style={{
                            height: '24px',
                            width: '1px',
                            background: DESIGN.gray200
                        }} />

                        <input
                            type="text"
                            value={templateName}
                            onChange={(e) => {
                                setTemplateName(e.target.value);
                                markUnsaved();
                            }}
                            style={{
                                border: 'none',
                                background: 'transparent',
                                fontSize: '18px',
                                fontWeight: '600',
                                color: DESIGN.gray600,
                                outline: 'none',
                                padding: '4px 8px',
                                borderRadius: '4px',
                                minWidth: '200px'
                            }}
                            onFocus={(e) => e.target.style.background = DESIGN.gray100}
                            onBlur={(e) => e.target.style.background = 'transparent'}
                        />
                    </div>

                    {/* Right: Save status and actions */}
                    <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                        {/* Preview/Edit toggle button */}
                        <button
                            onClick={handleTogglePreview}
                            style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '6px',
                                padding: '8px 16px',
                                background: previewMode ? DESIGN.primary : 'white',
                                color: previewMode ? 'white' : DESIGN.gray600,
                                border: `1px solid ${previewMode ? DESIGN.primary : DESIGN.gray300}`,
                                borderRadius: DESIGN.radiusInput,
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '500',
                                transition: 'all 200ms ease-out'
                            }}
                        >
                            {previewMode ? (
                                <React.Fragment>
                                    <AdminIcons.Edit size={16} />
                                    Edit
                                </React.Fragment>
                            ) : (
                                <React.Fragment>
                                    <AdminIcons.Eye size={16} />
                                    Preview
                                </React.Fragment>
                            )}
                        </button>

                        {/* Save status indicator */}
                        <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px',
                            fontSize: DESIGN.fontSizeCaption,
                            color: saveStatus === 'saved' ? '#16A34A'
                                : saveStatus === 'saving' ? DESIGN.gray400
                                : '#D97706'
                        }}>
                            {saveStatus === 'saving' ? (
                                <React.Fragment>
                                    <span style={{
                                        display: 'inline-block',
                                        width: '12px',
                                        height: '12px',
                                        border: '2px solid currentColor',
                                        borderTop: '2px solid transparent',
                                        borderRadius: '50%',
                                        animation: 'spin 0.8s linear infinite'
                                    }} />
                                    Saving...
                                </React.Fragment>
                            ) : saveStatus === 'saved' ? (
                                <React.Fragment>
                                    <AdminIcons.Check size={14} />
                                    Saved
                                </React.Fragment>
                            ) : (
                                <React.Fragment>
                                    <AdminIcons.AlertCircle size={14} />
                                    Unsaved changes
                                </React.Fragment>
                            )}
                        </div>

                        {/* Save button */}
                        <button
                            onClick={handleSave}
                            disabled={saveStatus === 'saving'}
                            style={{
                                padding: '8px 20px',
                                background: saveStatus === 'saving' ? DESIGN.gray300 : 'linear-gradient(135deg, #0077CC 0%, #005A9C 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: DESIGN.radiusInput,
                                fontSize: DESIGN.fontSizeMetadata,
                                fontWeight: '600',
                                cursor: saveStatus === 'saving' ? 'not-allowed' : 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '6px'
                            }}
                        >
                            <AdminIcons.Check size={16} />
                            Save
                        </button>
                    </div>
                </div>

                {/* THREE-PANEL LAYOUT */}
                <div style={{
                    flex: 1,
                    display: 'flex',
                    overflow: 'hidden'
                }}>
                    {/* LEFT PANEL - Block Palette (hidden in preview mode) */}
                    {!previewMode && (
                    <div style={{
                        width: leftPanelCollapsed ? '50px' : (isTablet ? '200px' : '260px'),
                        background: DESIGN.bgCard,
                        borderRight: `1px solid ${DESIGN.gray200}`,
                        display: 'flex',
                        flexDirection: 'column',
                        transition: 'all 300ms ease-out',
                        overflow: 'hidden'
                    }}>
                        {/* Panel header */}
                        <div style={{
                            padding: leftPanelCollapsed ? '12px' : '16px',
                            borderBottom: `1px solid ${DESIGN.gray200}`,
                            display: 'flex',
                            justifyContent: leftPanelCollapsed ? 'center' : 'space-between',
                            alignItems: 'center'
                        }}>
                            {!leftPanelCollapsed && (
                                <h3 style={{
                                    margin: 0,
                                    fontSize: DESIGN.fontSizeMetadata,
                                    fontWeight: '600',
                                    color: DESIGN.gray600
                                }}>
                                    Blocks
                                </h3>
                            )}
                            <button
                                onClick={() => setLeftPanelCollapsed(!leftPanelCollapsed)}
                                style={{
                                    background: 'transparent',
                                    border: 'none',
                                    cursor: 'pointer',
                                    padding: '4px',
                                    display: 'flex'
                                }}
                            >
                                {leftPanelCollapsed ? (
                                    <AdminIcons.ChevronRight size={18} color={DESIGN.gray400} />
                                ) : (
                                    <AdminIcons.ChevronLeft size={18} color={DESIGN.gray400} />
                                )}
                            </button>
                        </div>

                        {/* Block palette */}
                        {!leftPanelCollapsed && (
                            <div style={{
                                flex: 1,
                                overflowY: 'auto',
                                padding: '12px'
                            }}>
                                {/* Structure blocks */}
                                <div style={{ marginBottom: '16px' }}>
                                    <div style={{
                                        fontSize: DESIGN.fontSizeCaption,
                                        color: DESIGN.gray400,
                                        fontWeight: '600',
                                        textTransform: 'uppercase',
                                        letterSpacing: '0.5px',
                                        marginBottom: '8px'
                                    }}>
                                        Structure
                                    </div>
                                    {BLOCK_TYPES.filter(b => b.category === 'structure').map(blockType => (
                                        <PaletteBlock
                                            key={blockType.type}
                                            blockType={blockType}
                                            onDragStart={handlePaletteDragStart}
                                            onDragEnd={handlePaletteDragEnd}
                                            onClick={() => addBlock(blockType.type)}
                                        />
                                    ))}
                                </div>

                                {/* Content blocks */}
                                <div style={{ marginBottom: '16px' }}>
                                    <div style={{
                                        fontSize: DESIGN.fontSizeCaption,
                                        color: DESIGN.gray400,
                                        fontWeight: '600',
                                        textTransform: 'uppercase',
                                        letterSpacing: '0.5px',
                                        marginBottom: '8px'
                                    }}>
                                        Content
                                    </div>
                                    {BLOCK_TYPES.filter(b => b.category === 'content').map(blockType => (
                                        <PaletteBlock
                                            key={blockType.type}
                                            blockType={blockType}
                                            onDragStart={handlePaletteDragStart}
                                            onDragEnd={handlePaletteDragEnd}
                                            onClick={() => addBlock(blockType.type)}
                                        />
                                    ))}
                                </div>

                                {/* Signature Fields */}
                                <div style={{ marginBottom: '16px' }}>
                                    <div style={{
                                        fontSize: DESIGN.fontSizeCaption,
                                        color: DESIGN.gray400,
                                        fontWeight: '600',
                                        textTransform: 'uppercase',
                                        letterSpacing: '0.5px',
                                        marginBottom: '8px'
                                    }}>
                                        Signature Fields
                                    </div>
                                    {BLOCK_TYPES.filter(b => b.category === 'signature').map(blockType => (
                                        <PaletteBlock
                                            key={blockType.type}
                                            blockType={blockType}
                                            onDragStart={handlePaletteDragStart}
                                            onDragEnd={handlePaletteDragEnd}
                                            onClick={() => addBlock(blockType.type)}
                                        />
                                    ))}
                                </div>

                                {/* Legacy Blocks (for backward compatibility) */}
                                <div>
                                    <div style={{
                                        fontSize: DESIGN.fontSizeCaption,
                                        color: DESIGN.gray300,
                                        fontWeight: '600',
                                        textTransform: 'uppercase',
                                        letterSpacing: '0.5px',
                                        marginBottom: '8px',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '6px'
                                    }}>
                                        Legacy
                                        <span style={{
                                            fontSize: '10px',
                                            background: DESIGN.gray200,
                                            padding: '2px 6px',
                                            borderRadius: '4px',
                                            fontWeight: '500',
                                            letterSpacing: '0',
                                            textTransform: 'none'
                                        }}>old</span>
                                    </div>
                                    {BLOCK_TYPES.filter(b => b.category === 'legacy').map(blockType => (
                                        <PaletteBlock
                                            key={blockType.type}
                                            blockType={blockType}
                                            onDragStart={handlePaletteDragStart}
                                            onDragEnd={handlePaletteDragEnd}
                                            onClick={() => addBlock(blockType.type)}
                                        />
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                    )}

                    {/* CENTER PANEL - Paginated Canvas (matches sign.html WYSIWYG) */}
                    <div
                        ref={canvasScrollRef}
                        style={{
                            flex: 1,
                            background: DESIGN.gray100, // Gray background like sign.html
                            overflow: 'auto',
                            padding: previewMode ? '24px' : '32px',
                            display: 'flex',
                            flexDirection: 'column',
                            alignItems: 'center',
                            transition: 'all 300ms ease-out'
                        }}
                    >
                        {(() => {
                            // Pagination logic - split blocks into pages based on actual heights
                            const contentPages = paginateBlocks(blocks);

                            // Calculate total page count
                            const hasCoverPage = !!loadedComponents.coverPage;
                            const hasEndPage = !!loadedComponents.endPage;
                            const totalPages = (hasCoverPage ? 1 : 0) + contentPages.length + (hasEndPage ? 1 : 0);

                            // Track global block index for drag/drop
                            let globalBlockIndex = 0;

                            return (
                                <React.Fragment>
                                    {/* Cover Page - Full rendered page */}
                                    {hasCoverPage && (
                                        <EditorCoverPage
                                            coverTemplate={loadedComponents.coverPage}
                                            documentTitle={name}
                                            pageNum={1}
                                            totalPages={totalPages}
                                        />
                                    )}

                                    {/* Content Pages - Each is a white page box */}
                                    {contentPages.map((pageBlocks, pageIndex) => {
                                        const pageNum = (hasCoverPage ? 1 : 0) + pageIndex + 1;
                                        const isLastContentPage = pageIndex === contentPages.length - 1;
                                        const isLastPage = isLastContentPage && !hasEndPage;

                                        // Calculate start index for this page's blocks using shared pagination
                                        const pageStartIndex = getPageStartIndex(contentPages, pageIndex);

                                        return (
                                            <EditorContentPage
                                                key={pageIndex}
                                                pageNum={pageNum}
                                                totalPages={totalPages}
                                                documentTitle={name}
                                                headerTemplate={loadedComponents.header}
                                                footerTemplate={loadedComponents.footer}
                                                isLastPage={isLastPage}
                                            >
                                                {/* Canvas content for this page */}
                                                {pageBlocks.length === 0 && pageIndex === 0 ? (
                                                    <div
                                                        onDragOver={(e) => handleCanvasDragOver(e, 0)}
                                                        onDrop={(e) => handleCanvasDrop(e, 0)}
                                                        style={{
                                                            height: '100%',
                                                            minHeight: '200px',
                                                            display: 'flex',
                                                            flexDirection: 'column',
                                                            alignItems: 'center',
                                                            justifyContent: 'center',
                                                            border: draggedBlockType ? `2px dashed ${DESIGN.primary}` : `2px dashed ${DESIGN.gray300}`,
                                                            borderRadius: DESIGN.radiusCard,
                                                            background: draggedBlockType ? 'rgba(0,119,204,0.05)' : 'transparent',
                                                            transition: DESIGN.transitionFast
                                                        }}
                                                    >
                                                        <AdminIcons.FileText size={48} color={DESIGN.gray300} style={{ marginBottom: '16px' }} />
                                                        <p style={{
                                                            color: DESIGN.gray400,
                                                            fontSize: DESIGN.fontSizeMetadata,
                                                            textAlign: 'center',
                                                            margin: 0
                                                        }}>
                                                            {draggedBlockType
                                                                ? 'Drop block here'
                                                                : 'Drag blocks here to build your document'
                                                            }
                                                        </p>
                                                        <p style={{
                                                            color: DESIGN.gray300,
                                                            fontSize: DESIGN.fontSizeCaption,
                                                            textAlign: 'center',
                                                            margin: '8px 0 0 0'
                                                        }}>
                                                            Or click a block in the left panel to add it
                                                        </p>
                                                    </div>
                                                ) : (
                                                    <div style={{ display: 'flex', flexDirection: 'column', flex: 1, minHeight: 0 }}>
                                                        {pageBlocks.map((block, blockIndex) => {
                                                            const actualIndex = pageStartIndex + blockIndex;
                                                            return (
                                                                <React.Fragment key={block.id}>
                                                                    {/* Block wrapper - position:relative to anchor absolute drop zone */}
                                                                    <div style={{ position: 'relative' }}>
                                                                        {/* Drop zone - ABSOLUTE positioned, doesn't affect document flow */}
                                                                        {!previewMode && (
                                                                            <div
                                                                                onDragOver={(e) => { e.preventDefault(); setDragOverIndex(actualIndex); }}
                                                                                onDragLeave={() => setDragOverIndex(null)}
                                                                                onDrop={(e) => handleCanvasDrop(e, actualIndex)}
                                                                                style={{
                                                                                    position: 'absolute',
                                                                                    top: -12,
                                                                                    left: 0,
                                                                                    right: 0,
                                                                                    height: dragOverIndex === actualIndex ? GLRS_DOC.DROP_ZONE.active : GLRS_DOC.DROP_ZONE.resting,
                                                                                    background: dragOverIndex === actualIndex ? 'rgba(0, 119, 204, 0.15)' : 'transparent',
                                                                                    border: dragOverIndex === actualIndex ? `2px dashed ${DESIGN.primary}` : '2px dashed transparent',
                                                                                    borderRadius: 4,
                                                                                    transition: 'all 150ms ease',
                                                                                    display: 'flex',
                                                                                    alignItems: 'center',
                                                                                    justifyContent: 'center',
                                                                                    zIndex: 10,
                                                                                    pointerEvents: 'auto'
                                                                                }}
                                                                            >
                                                                                {dragOverIndex === actualIndex && (
                                                                                    <span style={{ color: DESIGN.primary, fontSize: '12px', fontWeight: 500 }}>
                                                                                        Drop here
                                                                                    </span>
                                                                                )}
                                                                            </div>
                                                                        )}

                                                                        {/* Block - renders at its natural height (WYSIWYG) */}
                                                                        <CanvasBlock
                                                                            block={block}
                                                                            index={actualIndex}
                                                                            isSelected={!previewMode && selectedBlockId === block.id}
                                                                            isDragging={draggedBlockId === block.id}
                                                                            onSelect={previewMode ? undefined : () => setSelectedBlockId(block.id)}
                                                                            onDelete={() => deleteBlock(block.id)}
                                                                            onDragStart={handleCanvasBlockDragStart}
                                                                            onDragEnd={handleCanvasBlockDragEnd}
                                                                            previewMode={previewMode}
                                                                        />
                                                                    </div>
                                                                </React.Fragment>
                                                            );
                                                        })}

                                                        {/* Trailing drop zone - fills remaining space, absolute indicator */}
                                                        {!previewMode && (
                                                            <div
                                                                onDragOver={(e) => { e.preventDefault(); setDragOverIndex(pageStartIndex + pageBlocks.length); }}
                                                                onDragLeave={() => setDragOverIndex(null)}
                                                                onDrop={(e) => handleCanvasDrop(e, pageStartIndex + pageBlocks.length)}
                                                                style={{
                                                                    position: 'relative',
                                                                    flex: 1,
                                                                    minHeight: 40
                                                                }}
                                                            >
                                                                {/* Visual indicator - only shows when dragging */}
                                                                <div style={{
                                                                    position: 'absolute',
                                                                    top: 0,
                                                                    left: 0,
                                                                    right: 0,
                                                                    bottom: 0,
                                                                    background: dragOverIndex === (pageStartIndex + pageBlocks.length) ? 'rgba(0, 119, 204, 0.1)' : 'transparent',
                                                                    border: dragOverIndex === (pageStartIndex + pageBlocks.length) ? `2px dashed ${DESIGN.primary}` : '2px dashed transparent',
                                                                    borderRadius: 4,
                                                                    transition: 'all 150ms ease',
                                                                    display: 'flex',
                                                                    alignItems: 'center',
                                                                    justifyContent: 'center'
                                                                }}>
                                                                    {dragOverIndex === (pageStartIndex + pageBlocks.length) && (
                                                                        <span style={{ color: DESIGN.primary, fontSize: '12px', fontWeight: 500 }}>
                                                                            Drop here to add at end
                                                                        </span>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </EditorContentPage>
                                        );
                                    })}

                                    {/* End Page - Full rendered page */}
                                    {hasEndPage && (
                                        <EditorEndPage
                                            endTemplate={loadedComponents.endPage}
                                            pageNum={totalPages}
                                            totalPages={totalPages}
                                        />
                                    )}
                                </React.Fragment>
                            );
                        })()}
                    </div>

                    {/* RIGHT PANEL - Properties (hidden in preview mode) */}
                    {!previewMode && (
                    <div style={{
                        width: rightPanelCollapsed ? '50px' : (isTablet ? '250px' : '300px'),
                        background: DESIGN.bgCard,
                        borderLeft: `1px solid ${DESIGN.gray200}`,
                        display: 'flex',
                        flexDirection: 'column',
                        transition: 'all 300ms ease-out',
                        overflow: 'hidden'
                    }}>
                        {/* Panel header */}
                        <div style={{
                            padding: rightPanelCollapsed ? '12px' : '16px',
                            borderBottom: `1px solid ${DESIGN.gray200}`,
                            display: 'flex',
                            justifyContent: rightPanelCollapsed ? 'center' : 'space-between',
                            alignItems: 'center'
                        }}>
                            <button
                                onClick={() => setRightPanelCollapsed(!rightPanelCollapsed)}
                                style={{
                                    background: 'transparent',
                                    border: 'none',
                                    cursor: 'pointer',
                                    padding: '4px',
                                    display: 'flex'
                                }}
                            >
                                {rightPanelCollapsed ? (
                                    <AdminIcons.ChevronLeft size={18} color={DESIGN.gray400} />
                                ) : (
                                    <AdminIcons.ChevronRight size={18} color={DESIGN.gray400} />
                                )}
                            </button>
                            {!rightPanelCollapsed && (
                                <h3 style={{
                                    margin: 0,
                                    fontSize: DESIGN.fontSizeMetadata,
                                    fontWeight: '600',
                                    color: DESIGN.gray600
                                }}>
                                    {selectedBlock ? 'Block Properties' : 'Document Properties'}
                                </h3>
                            )}
                        </div>

                        {/* Properties content */}
                        {!rightPanelCollapsed && (
                            <div style={{
                                flex: 1,
                                overflowY: 'auto',
                                padding: '16px'
                            }}>
                                {selectedBlock ? (
                                    <BlockPropertiesPanel
                                        block={selectedBlock}
                                        onUpdate={(updates) => updateBlock(selectedBlock.id, updates)}
                                        onDeselect={() => setSelectedBlockId(null)}
                                    />
                                ) : (
                                    <DocumentPropertiesPanel
                                        name={templateName}
                                        description={templateDescription}
                                        status={templateStatus}
                                        onNameChange={(v) => { setTemplateName(v); markUnsaved(); }}
                                        onDescriptionChange={(v) => { setTemplateDescription(v); markUnsaved(); }}
                                        onStatusChange={(v) => { setTemplateStatus(v); markUnsaved(); }}
                                        components={components}
                                        availableComponents={availableComponents}
                                        onComponentChange={handleComponentChange}
                                        templateType={template?.type}
                                    />
                                )}
                            </div>
                        )}
                    </div>
                    )}
                </div>
            </div>
        );
    }

    // ==========================================
    // COVER PAGE EDITOR
    // ==========================================
    function CoverPageEditorModal({ template, user, onClose, onSave, isMobile }) {
        // Form state
        const [formData, setFormData] = useState({
            logoUrl: template?.content?.logoUrl || '',
            title: template?.content?.title || '{{documentTitle}}',
            subtitle: template?.content?.subtitle || '',
            showDate: template?.content?.showDate !== false,
            backgroundStyle: template?.content?.backgroundStyle || 'gradient-blue',
            icon: template?.content?.icon || 'none',
            iconColor: template?.content?.iconColor || '#FFFFFF'
        });
        const [templateName, setTemplateName] = useState(template?.name || 'New Cover Page');
        const [templateStatus, setTemplateStatus] = useState(template?.status || 'draft');
        const [saving, setSaving] = useState(false);
        const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);

        // Background style options
        const backgroundOptions = [
            { value: 'gradient-blue', label: 'Blue Gradient', preview: 'linear-gradient(135deg, #0077CC 0%, #005A9C 100%)' },
            { value: 'gradient-teal', label: 'Teal Gradient', preview: 'linear-gradient(135deg, #0D9488 0%, #0F766E 100%)' },
            { value: 'gradient-purple', label: 'Purple Gradient', preview: 'linear-gradient(135deg, #7C3AED 0%, #6D28D9 100%)' },
            { value: 'solid-white', label: 'Solid White', preview: '#FFFFFF' },
            { value: 'solid-light', label: 'Light Gray', preview: '#F8FAFC' }
        ];

        // Mobile: show "Desktop Required" message
        if (isMobile) {
            return (
                <div style={{
                    position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                    background: DESIGN.bgPage, zIndex: 1000,
                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                    flexDirection: 'column', padding: '24px', textAlign: 'center'
                }}>
                    <AdminIcons.Monitor size={48} style={{ color: DESIGN.gray400, marginBottom: '16px' }} />
                    <h2 style={{ fontSize: '20px', fontWeight: '600', color: DESIGN.gray600, marginBottom: '8px' }}>
                        Desktop Required
                    </h2>
                    <p style={{ fontSize: '14px', color: DESIGN.gray400, marginBottom: '24px' }}>
                        The template editor requires a larger screen. Please use a desktop or tablet device.
                    </p>
                    <button onClick={onClose} style={{
                        padding: '12px 24px', background: 'linear-gradient(135deg, #0077CC 0%, #005A9C 100%)',
                        color: 'white', border: 'none', borderRadius: DESIGN.radiusInput,
                        fontWeight: '600', cursor: 'pointer'
                    }}>
                        Go Back
                    </button>
                </div>
            );
        }

        const handleFieldChange = (field, value) => {
            setFormData(prev => ({ ...prev, [field]: value }));
            setHasUnsavedChanges(true);
        };

        const handleSave = async () => {
            setSaving(true);
            try {
                const updateData = {
                    name: templateName,
                    status: templateStatus,
                    content: { ...formData }
                };
                await onSave(template?.id, updateData);
                setHasUnsavedChanges(false);
            } catch (error) {
                console.error('Error saving cover page:', error);
                alert('Failed to save: ' + error.message);
            } finally {
                setSaving(false);
            }
        };

        const handleClose = () => {
            if (hasUnsavedChanges) {
                if (!confirm('You have unsaved changes. Are you sure you want to close?')) return;
            }
            onClose();
        };

        const getBackgroundStyle = (styleValue) => {
            const option = backgroundOptions.find(o => o.value === styleValue);
            return option?.preview || '#FFFFFF';
        };

        return (
            <div style={{
                position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                background: DESIGN.bgPage, zIndex: 1000, display: 'flex', flexDirection: 'column'
            }}>
                {/* Top Toolbar */}
                <div style={{
                    height: '56px', background: DESIGN.bgCard, borderBottom: `1px solid ${DESIGN.gray200}`,
                    display: 'flex', alignItems: 'center', padding: '0 16px', gap: '16px'
                }}>
                    <button onClick={handleClose} style={{
                        display: 'flex', alignItems: 'center', gap: '6px', padding: '8px 12px',
                        background: 'transparent', border: 'none', color: DESIGN.gray500,
                        fontSize: '14px', cursor: 'pointer', borderRadius: DESIGN.radiusInput
                    }}>
                        <AdminIcons.ArrowLeft size={18} />
                        Back
                    </button>

                    <div style={{ flex: 1, display: 'flex', alignItems: 'center', gap: '12px' }}>
                        <AdminIcons.FileText size={20} style={{ color: DESIGN.typeColors.cover.icon }} />
                        <input
                            type="text"
                            value={templateName}
                            onChange={(e) => { setTemplateName(e.target.value); setHasUnsavedChanges(true); }}
                            style={{
                                fontSize: '16px', fontWeight: '600', border: 'none', background: 'transparent',
                                color: DESIGN.gray600, outline: 'none', width: '300px'
                            }}
                            placeholder="Cover Page Name"
                        />
                        <span style={{
                            fontSize: '12px', padding: '4px 8px', borderRadius: '12px',
                            background: hasUnsavedChanges ? '#FEF3C7' : '#DCFCE7',
                            color: hasUnsavedChanges ? '#D97706' : '#16A34A'
                        }}>
                            {saving ? 'Saving...' : hasUnsavedChanges ? 'Unsaved' : 'Saved'}
                        </span>
                    </div>

                    <button onClick={handleSave} disabled={saving || !hasUnsavedChanges} style={{
                        padding: '8px 16px', background: hasUnsavedChanges ? 'linear-gradient(135deg, #0077CC 0%, #005A9C 100%)' : DESIGN.gray200,
                        color: hasUnsavedChanges ? 'white' : DESIGN.gray400, border: 'none',
                        borderRadius: DESIGN.radiusInput, fontWeight: '600', cursor: hasUnsavedChanges ? 'pointer' : 'not-allowed',
                        display: 'flex', alignItems: 'center', gap: '6px'
                    }}>
                        <AdminIcons.Save size={16} />
                        Save
                    </button>
                </div>

                {/* Main Content - Two columns: Form and Preview */}
                <div style={{ flex: 1, display: 'flex', overflow: 'hidden' }}>
                    {/* Left Column - Form Fields */}
                    <div style={{
                        width: '360px', background: DESIGN.bgCard, borderRight: `1px solid ${DESIGN.gray200}`,
                        overflow: 'auto', padding: '24px'
                    }}>
                        <h3 style={{ fontSize: '14px', fontWeight: '600', color: DESIGN.gray600, marginBottom: '20px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                            Cover Page Settings
                        </h3>

                        {/* Logo URL */}
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: DESIGN.gray600, marginBottom: '6px' }}>
                                Logo URL
                            </label>
                            <input
                                type="text"
                                value={formData.logoUrl}
                                onChange={(e) => handleFieldChange('logoUrl', e.target.value)}
                                placeholder="https://example.com/logo.png"
                                style={{
                                    width: '100%', padding: '10px 12px', borderRadius: DESIGN.radiusInput,
                                    border: `1px solid ${DESIGN.gray200}`, fontSize: '14px'
                                }}
                            />
                            <p style={{ fontSize: '12px', color: DESIGN.gray400, marginTop: '4px' }}>
                                Leave empty to use default GLRS logo
                            </p>
                        </div>

                        {/* Title */}
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: DESIGN.gray600, marginBottom: '6px' }}>
                                Document Title
                            </label>
                            <input
                                type="text"
                                value={formData.title}
                                onChange={(e) => handleFieldChange('title', e.target.value)}
                                placeholder="{{documentTitle}}"
                                style={{
                                    width: '100%', padding: '10px 12px', borderRadius: DESIGN.radiusInput,
                                    border: `1px solid ${DESIGN.gray200}`, fontSize: '14px'
                                }}
                            />
                            <p style={{ fontSize: '12px', color: DESIGN.gray400, marginTop: '4px' }}>
                                Use {'{{documentTitle}}'} for dynamic title
                            </p>
                        </div>

                        {/* Subtitle */}
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: DESIGN.gray600, marginBottom: '6px' }}>
                                Subtitle
                            </label>
                            <input
                                type="text"
                                value={formData.subtitle}
                                onChange={(e) => handleFieldChange('subtitle', e.target.value)}
                                placeholder="Optional subtitle text"
                                style={{
                                    width: '100%', padding: '10px 12px', borderRadius: DESIGN.radiusInput,
                                    border: `1px solid ${DESIGN.gray200}`, fontSize: '14px'
                                }}
                            />
                        </div>

                        {/* Show Date Toggle */}
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{ display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer' }}>
                                <input
                                    type="checkbox"
                                    checked={formData.showDate}
                                    onChange={(e) => handleFieldChange('showDate', e.target.checked)}
                                    style={{ width: '18px', height: '18px', accentColor: '#0077CC' }}
                                />
                                <span style={{ fontSize: '14px', fontWeight: '500', color: DESIGN.gray600 }}>
                                    Show Date on Cover
                                </span>
                            </label>
                        </div>

                        {/* Background Style */}
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: DESIGN.gray600, marginBottom: '10px' }}>
                                Background Style
                            </label>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                {backgroundOptions.map(option => (
                                    <label
                                        key={option.value}
                                        style={{
                                            display: 'flex', alignItems: 'center', gap: '12px', padding: '10px 12px',
                                            border: `2px solid ${formData.backgroundStyle === option.value ? '#0077CC' : DESIGN.gray200}`,
                                            borderRadius: DESIGN.radiusInput, cursor: 'pointer',
                                            background: formData.backgroundStyle === option.value ? '#F0F7FF' : 'transparent'
                                        }}
                                    >
                                        <input
                                            type="radio"
                                            name="backgroundStyle"
                                            value={option.value}
                                            checked={formData.backgroundStyle === option.value}
                                            onChange={(e) => handleFieldChange('backgroundStyle', e.target.value)}
                                            style={{ display: 'none' }}
                                        />
                                        <div style={{
                                            width: '32px', height: '32px', borderRadius: '4px',
                                            background: option.preview, border: '1px solid rgba(0,0,0,0.1)'
                                        }} />
                                        <span style={{ fontSize: '14px', color: DESIGN.gray600 }}>{option.label}</span>
                                    </label>
                                ))}
                            </div>
                        </div>

                        {/* Icon Selection */}
                        <IconPicker
                            selectedIcon={formData.icon}
                            selectedColor={formData.iconColor}
                            onIconChange={(icon) => handleFieldChange('icon', icon)}
                            onColorChange={(color) => handleFieldChange('iconColor', color)}
                            label="Cover Page Icon"
                        />

                        {/* Status */}
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: DESIGN.gray600, marginBottom: '6px' }}>
                                Status
                            </label>
                            <select
                                value={templateStatus}
                                onChange={(e) => { setTemplateStatus(e.target.value); setHasUnsavedChanges(true); }}
                                style={{
                                    width: '100%', padding: '10px 12px', borderRadius: DESIGN.radiusInput,
                                    border: `1px solid ${DESIGN.gray200}`, fontSize: '14px'
                                }}
                            >
                                <option value="draft">Draft</option>
                                <option value="active">Active</option>
                                <option value="archived">Archived</option>
                            </select>
                        </div>
                    </div>

                    {/* Right Column - Preview */}
                    <div style={{
                        flex: 1, background: '#E5E7EB', display: 'flex', alignItems: 'center',
                        justifyContent: 'center', padding: '40px', overflow: 'auto'
                    }}>
                        {/* Cover Page Preview */}
                        <div style={{
                            width: '400px', height: '520px', background: getBackgroundStyle(formData.backgroundStyle),
                            borderRadius: '8px', boxShadow: DESIGN.shadowElevated,
                            display: 'flex', flexDirection: 'column', alignItems: 'center',
                            justifyContent: 'center', padding: '40px', textAlign: 'center',
                            color: formData.backgroundStyle.includes('gradient') ? 'white' : DESIGN.gray600
                        }}>
                            {/* Icon */}
                            {formData.icon && formData.icon !== 'none' && AdminIcons[formData.icon] && (
                                <div style={{ marginBottom: '16px' }}>
                                    {React.createElement(AdminIcons[formData.icon], { size: 48, style: { color: formData.iconColor } })}
                                </div>
                            )}

                            {/* Logo */}
                            {formData.logoUrl ? (
                                <img src={formData.logoUrl} alt="Logo" style={{ maxWidth: '120px', maxHeight: '60px', marginBottom: '24px' }} />
                            ) : (
                                <div style={{ width: '100px', height: '50px', background: 'rgba(255,255,255,0.2)', borderRadius: '8px', marginBottom: '24px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                                    <AdminIcons.Image size={24} style={{ opacity: 0.5 }} />
                                </div>
                            )}

                            {/* Title */}
                            <h1 style={{
                                fontSize: '28px', fontWeight: '700', marginBottom: '12px',
                                color: 'inherit'
                            }}>
                                {formData.title || 'Document Title'}
                            </h1>

                            {/* Subtitle */}
                            {formData.subtitle && (
                                <p style={{ fontSize: '16px', opacity: 0.9, marginBottom: '24px' }}>
                                    {formData.subtitle}
                                </p>
                            )}

                            {/* Date */}
                            {formData.showDate && (
                                <p style={{ fontSize: '14px', opacity: 0.8, marginTop: 'auto' }}>
                                    {new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
                                </p>
                            )}
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    // ==========================================
    // HEADER EDITOR
    // ==========================================
    function HeaderEditorModal({ template, user, onClose, onSave, isMobile }) {
        const [formData, setFormData] = useState({
            logoPosition: template?.content?.logoPosition || 'left',
            showTitle: template?.content?.showTitle !== false,
            showDate: template?.content?.showDate || false,
            height: template?.content?.height || 'standard',
            icon: template?.content?.icon || 'none',
            iconColor: template?.content?.iconColor || '#0077CC'
        });
        const [templateName, setTemplateName] = useState(template?.name || 'New Header');
        const [templateStatus, setTemplateStatus] = useState(template?.status || 'draft');
        const [saving, setSaving] = useState(false);
        const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);

        if (isMobile) {
            return (
                <div style={{
                    position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                    background: DESIGN.bgPage, zIndex: 1000,
                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                    flexDirection: 'column', padding: '24px', textAlign: 'center'
                }}>
                    <AdminIcons.Monitor size={48} style={{ color: DESIGN.gray400, marginBottom: '16px' }} />
                    <h2 style={{ fontSize: '20px', fontWeight: '600', color: DESIGN.gray600, marginBottom: '8px' }}>Desktop Required</h2>
                    <p style={{ fontSize: '14px', color: DESIGN.gray400, marginBottom: '24px' }}>
                        The template editor requires a larger screen.
                    </p>
                    <button onClick={onClose} style={{
                        padding: '12px 24px', background: 'linear-gradient(135deg, #0077CC 0%, #005A9C 100%)',
                        color: 'white', border: 'none', borderRadius: DESIGN.radiusInput, fontWeight: '600', cursor: 'pointer'
                    }}>
                        Go Back
                    </button>
                </div>
            );
        }

        const handleFieldChange = (field, value) => {
            setFormData(prev => ({ ...prev, [field]: value }));
            setHasUnsavedChanges(true);
        };

        const handleSave = async () => {
            setSaving(true);
            try {
                await onSave(template?.id, { name: templateName, status: templateStatus, content: { ...formData } });
                setHasUnsavedChanges(false);
            } catch (error) {
                alert('Failed to save: ' + error.message);
            } finally {
                setSaving(false);
            }
        };

        const handleClose = () => {
            if (hasUnsavedChanges && !confirm('You have unsaved changes. Close anyway?')) return;
            onClose();
        };

        return (
            <div style={{
                position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                background: DESIGN.bgPage, zIndex: 1000, display: 'flex', flexDirection: 'column'
            }}>
                {/* Top Toolbar */}
                <div style={{
                    height: '56px', background: DESIGN.bgCard, borderBottom: `1px solid ${DESIGN.gray200}`,
                    display: 'flex', alignItems: 'center', padding: '0 16px', gap: '16px'
                }}>
                    <button onClick={handleClose} style={{
                        display: 'flex', alignItems: 'center', gap: '6px', padding: '8px 12px',
                        background: 'transparent', border: 'none', color: DESIGN.gray500, fontSize: '14px', cursor: 'pointer'
                    }}>
                        <AdminIcons.ArrowLeft size={18} /> Back
                    </button>

                    <div style={{ flex: 1, display: 'flex', alignItems: 'center', gap: '12px' }}>
                        <AdminIcons.PanelTop size={20} style={{ color: DESIGN.typeColors.header.icon }} />
                        <input
                            type="text" value={templateName}
                            onChange={(e) => { setTemplateName(e.target.value); setHasUnsavedChanges(true); }}
                            style={{ fontSize: '16px', fontWeight: '600', border: 'none', background: 'transparent', color: DESIGN.gray600, outline: 'none', width: '300px' }}
                            placeholder="Header Name"
                        />
                        <span style={{
                            fontSize: '12px', padding: '4px 8px', borderRadius: '12px',
                            background: hasUnsavedChanges ? '#FEF3C7' : '#DCFCE7', color: hasUnsavedChanges ? '#D97706' : '#16A34A'
                        }}>
                            {saving ? 'Saving...' : hasUnsavedChanges ? 'Unsaved' : 'Saved'}
                        </span>
                    </div>

                    <button onClick={handleSave} disabled={saving || !hasUnsavedChanges} style={{
                        padding: '8px 16px', background: hasUnsavedChanges ? 'linear-gradient(135deg, #0077CC 0%, #005A9C 100%)' : DESIGN.gray200,
                        color: hasUnsavedChanges ? 'white' : DESIGN.gray400, border: 'none', borderRadius: DESIGN.radiusInput,
                        fontWeight: '600', cursor: hasUnsavedChanges ? 'pointer' : 'not-allowed', display: 'flex', alignItems: 'center', gap: '6px'
                    }}>
                        <AdminIcons.Save size={16} /> Save
                    </button>
                </div>

                {/* Main Content */}
                <div style={{ flex: 1, display: 'flex', overflow: 'hidden' }}>
                    {/* Left - Form */}
                    <div style={{ width: '360px', background: DESIGN.bgCard, borderRight: `1px solid ${DESIGN.gray200}`, overflow: 'auto', padding: '24px' }}>
                        <h3 style={{ fontSize: '14px', fontWeight: '600', color: DESIGN.gray600, marginBottom: '20px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                            Header Settings
                        </h3>

                        {/* Logo Position */}
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: DESIGN.gray600, marginBottom: '8px' }}>
                                Logo Position
                            </label>
                            <div style={{ display: 'flex', gap: '8px' }}>
                                {['left', 'center', 'right'].map(pos => (
                                    <button key={pos} onClick={() => handleFieldChange('logoPosition', pos)} style={{
                                        flex: 1, padding: '10px', border: `2px solid ${formData.logoPosition === pos ? '#0077CC' : DESIGN.gray200}`,
                                        borderRadius: DESIGN.radiusInput, background: formData.logoPosition === pos ? '#F0F7FF' : 'transparent',
                                        cursor: 'pointer', fontSize: '13px', fontWeight: '500', color: DESIGN.gray600, textTransform: 'capitalize'
                                    }}>
                                        {pos}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Show Title */}
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{ display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer' }}>
                                <input type="checkbox" checked={formData.showTitle} onChange={(e) => handleFieldChange('showTitle', e.target.checked)}
                                    style={{ width: '18px', height: '18px', accentColor: '#0077CC' }} />
                                <span style={{ fontSize: '14px', fontWeight: '500', color: DESIGN.gray600 }}>Show Document Title</span>
                            </label>
                        </div>

                        {/* Show Date */}
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{ display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer' }}>
                                <input type="checkbox" checked={formData.showDate} onChange={(e) => handleFieldChange('showDate', e.target.checked)}
                                    style={{ width: '18px', height: '18px', accentColor: '#0077CC' }} />
                                <span style={{ fontSize: '14px', fontWeight: '500', color: DESIGN.gray600 }}>Show Date</span>
                            </label>
                        </div>

                        {/* Height */}
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: DESIGN.gray600, marginBottom: '8px' }}>
                                Header Height
                            </label>
                            <div style={{ display: 'flex', gap: '8px' }}>
                                {[{ value: 'compact', label: 'Compact' }, { value: 'standard', label: 'Standard' }].map(opt => (
                                    <button key={opt.value} onClick={() => handleFieldChange('height', opt.value)} style={{
                                        flex: 1, padding: '10px', border: `2px solid ${formData.height === opt.value ? '#0077CC' : DESIGN.gray200}`,
                                        borderRadius: DESIGN.radiusInput, background: formData.height === opt.value ? '#F0F7FF' : 'transparent',
                                        cursor: 'pointer', fontSize: '13px', fontWeight: '500', color: DESIGN.gray600
                                    }}>
                                        {opt.label}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Icon Selection */}
                        <IconPicker
                            selectedIcon={formData.icon}
                            selectedColor={formData.iconColor}
                            onIconChange={(icon) => handleFieldChange('icon', icon)}
                            onColorChange={(color) => handleFieldChange('iconColor', color)}
                            label="Header Icon"
                        />

                        {/* Status */}
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: DESIGN.gray600, marginBottom: '6px' }}>Status</label>
                            <select value={templateStatus} onChange={(e) => { setTemplateStatus(e.target.value); setHasUnsavedChanges(true); }}
                                style={{ width: '100%', padding: '10px 12px', borderRadius: DESIGN.radiusInput, border: `1px solid ${DESIGN.gray200}`, fontSize: '14px' }}>
                                <option value="draft">Draft</option>
                                <option value="active">Active</option>
                                <option value="archived">Archived</option>
                            </select>
                        </div>
                    </div>

                    {/* Right - Preview */}
                    <div style={{ flex: 1, background: '#E5E7EB', display: 'flex', alignItems: 'flex-start', justifyContent: 'center', padding: '40px', overflow: 'auto' }}>
                        <div style={{ width: '600px', background: DESIGN.bgCard, borderRadius: '8px', boxShadow: DESIGN.shadowElevated, overflow: 'hidden' }}>
                            {/* Header Preview Strip */}
                            <div style={{
                                height: formData.height === 'compact' ? '48px' : '64px',
                                background: DESIGN.bgCard, borderBottom: `2px solid ${DESIGN.gray200}`,
                                display: 'flex', alignItems: 'center', padding: '0 24px',
                                justifyContent: formData.logoPosition === 'center' ? 'center' : formData.logoPosition === 'right' ? 'flex-end' : 'flex-start',
                                gap: '16px'
                            }}>
                                {/* Icon in header */}
                                {formData.icon && formData.icon !== 'none' && AdminIcons[formData.icon] && (
                                    React.createElement(AdminIcons[formData.icon], { size: formData.height === 'compact' ? 18 : 22, style: { color: formData.iconColor } })
                                )}
                                <div style={{ width: '80px', height: formData.height === 'compact' ? '28px' : '36px', background: '#E5E7EB', borderRadius: '4px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                                    <AdminIcons.Image size={16} style={{ color: DESIGN.gray400 }} />
                                </div>
                                {formData.showTitle && (
                                    <span style={{ fontSize: formData.height === 'compact' ? '14px' : '16px', fontWeight: '600', color: DESIGN.gray600 }}>
                                        Document Title
                                    </span>
                                )}
                                {formData.showDate && (
                                    <span style={{ fontSize: '12px', color: DESIGN.gray400, marginLeft: formData.logoPosition === 'center' ? 0 : 'auto' }}>
                                        {new Date().toLocaleDateString()}
                                    </span>
                                )}
                            </div>
                            {/* Content placeholder */}
                            <div style={{ padding: '40px', minHeight: '300px' }}>
                                <div style={{ background: '#F3F4F6', height: '16px', width: '80%', borderRadius: '4px', marginBottom: '12px' }} />
                                <div style={{ background: '#F3F4F6', height: '16px', width: '90%', borderRadius: '4px', marginBottom: '12px' }} />
                                <div style={{ background: '#F3F4F6', height: '16px', width: '70%', borderRadius: '4px' }} />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    // ==========================================
    // FOOTER EDITOR
    // ==========================================
    function FooterEditorModal({ template, user, onClose, onSave, isMobile }) {
        const [formData, setFormData] = useState({
            showPageNumbers: template?.content?.showPageNumbers !== false,
            pageNumberFormat: template?.content?.pageNumberFormat || 'pageX',
            confidentialityText: template?.content?.confidentialityText || 'CONFIDENTIAL',
            customText: template?.content?.customText || '',
            icon: template?.content?.icon || 'none',
            iconColor: template?.content?.iconColor || '#6B7280'
        });
        const [templateName, setTemplateName] = useState(template?.name || 'New Footer');
        const [templateStatus, setTemplateStatus] = useState(template?.status || 'draft');
        const [saving, setSaving] = useState(false);
        const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);

        if (isMobile) {
            return (
                <div style={{
                    position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                    background: DESIGN.bgPage, zIndex: 1000,
                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                    flexDirection: 'column', padding: '24px', textAlign: 'center'
                }}>
                    <AdminIcons.Monitor size={48} style={{ color: DESIGN.gray400, marginBottom: '16px' }} />
                    <h2 style={{ fontSize: '20px', fontWeight: '600', color: DESIGN.gray600, marginBottom: '8px' }}>Desktop Required</h2>
                    <p style={{ fontSize: '14px', color: DESIGN.gray400, marginBottom: '24px' }}>The template editor requires a larger screen.</p>
                    <button onClick={onClose} style={{
                        padding: '12px 24px', background: 'linear-gradient(135deg, #0077CC 0%, #005A9C 100%)',
                        color: 'white', border: 'none', borderRadius: DESIGN.radiusInput, fontWeight: '600', cursor: 'pointer'
                    }}>Go Back</button>
                </div>
            );
        }

        const handleFieldChange = (field, value) => {
            setFormData(prev => ({ ...prev, [field]: value }));
            setHasUnsavedChanges(true);
        };

        const handleSave = async () => {
            setSaving(true);
            try {
                await onSave(template?.id, { name: templateName, status: templateStatus, content: { ...formData } });
                setHasUnsavedChanges(false);
            } catch (error) {
                alert('Failed to save: ' + error.message);
            } finally {
                setSaving(false);
            }
        };

        const handleClose = () => {
            if (hasUnsavedChanges && !confirm('You have unsaved changes. Close anyway?')) return;
            onClose();
        };

        const formatPageNumber = (format) => {
            return format === 'pageXofY' ? 'Page 1 of 5' : 'Page 1';
        };

        return (
            <div style={{
                position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                background: DESIGN.bgPage, zIndex: 1000, display: 'flex', flexDirection: 'column'
            }}>
                {/* Top Toolbar */}
                <div style={{
                    height: '56px', background: DESIGN.bgCard, borderBottom: `1px solid ${DESIGN.gray200}`,
                    display: 'flex', alignItems: 'center', padding: '0 16px', gap: '16px'
                }}>
                    <button onClick={handleClose} style={{
                        display: 'flex', alignItems: 'center', gap: '6px', padding: '8px 12px',
                        background: 'transparent', border: 'none', color: DESIGN.gray500, fontSize: '14px', cursor: 'pointer'
                    }}>
                        <AdminIcons.ArrowLeft size={18} /> Back
                    </button>

                    <div style={{ flex: 1, display: 'flex', alignItems: 'center', gap: '12px' }}>
                        <AdminIcons.PanelBottom size={20} style={{ color: DESIGN.typeColors.footer.icon }} />
                        <input type="text" value={templateName}
                            onChange={(e) => { setTemplateName(e.target.value); setHasUnsavedChanges(true); }}
                            style={{ fontSize: '16px', fontWeight: '600', border: 'none', background: 'transparent', color: DESIGN.gray600, outline: 'none', width: '300px' }}
                            placeholder="Footer Name"
                        />
                        <span style={{
                            fontSize: '12px', padding: '4px 8px', borderRadius: '12px',
                            background: hasUnsavedChanges ? '#FEF3C7' : '#DCFCE7', color: hasUnsavedChanges ? '#D97706' : '#16A34A'
                        }}>
                            {saving ? 'Saving...' : hasUnsavedChanges ? 'Unsaved' : 'Saved'}
                        </span>
                    </div>

                    <button onClick={handleSave} disabled={saving || !hasUnsavedChanges} style={{
                        padding: '8px 16px', background: hasUnsavedChanges ? 'linear-gradient(135deg, #0077CC 0%, #005A9C 100%)' : DESIGN.gray200,
                        color: hasUnsavedChanges ? 'white' : DESIGN.gray400, border: 'none', borderRadius: DESIGN.radiusInput,
                        fontWeight: '600', cursor: hasUnsavedChanges ? 'pointer' : 'not-allowed', display: 'flex', alignItems: 'center', gap: '6px'
                    }}>
                        <AdminIcons.Save size={16} /> Save
                    </button>
                </div>

                {/* Main Content */}
                <div style={{ flex: 1, display: 'flex', overflow: 'hidden' }}>
                    {/* Left - Form */}
                    <div style={{ width: '360px', background: DESIGN.bgCard, borderRight: `1px solid ${DESIGN.gray200}`, overflow: 'auto', padding: '24px' }}>
                        <h3 style={{ fontSize: '14px', fontWeight: '600', color: DESIGN.gray600, marginBottom: '20px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                            Footer Settings
                        </h3>

                        {/* Page Numbers Toggle */}
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{ display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer' }}>
                                <input type="checkbox" checked={formData.showPageNumbers} onChange={(e) => handleFieldChange('showPageNumbers', e.target.checked)}
                                    style={{ width: '18px', height: '18px', accentColor: '#0077CC' }} />
                                <span style={{ fontSize: '14px', fontWeight: '500', color: DESIGN.gray600 }}>Show Page Numbers</span>
                            </label>
                        </div>

                        {/* Page Number Format */}
                        {formData.showPageNumbers && (
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: DESIGN.gray600, marginBottom: '8px' }}>
                                    Page Number Format
                                </label>
                                <div style={{ display: 'flex', gap: '8px' }}>
                                    {[{ value: 'pageX', label: 'Page X' }, { value: 'pageXofY', label: 'Page X of Y' }].map(opt => (
                                        <button key={opt.value} onClick={() => handleFieldChange('pageNumberFormat', opt.value)} style={{
                                            flex: 1, padding: '10px', border: `2px solid ${formData.pageNumberFormat === opt.value ? '#0077CC' : DESIGN.gray200}`,
                                            borderRadius: DESIGN.radiusInput, background: formData.pageNumberFormat === opt.value ? '#F0F7FF' : 'transparent',
                                            cursor: 'pointer', fontSize: '13px', fontWeight: '500', color: DESIGN.gray600
                                        }}>
                                            {opt.label}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Confidentiality Text */}
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: DESIGN.gray600, marginBottom: '6px' }}>
                                Confidentiality Statement
                            </label>
                            <input type="text" value={formData.confidentialityText}
                                onChange={(e) => handleFieldChange('confidentialityText', e.target.value)}
                                placeholder="CONFIDENTIAL"
                                style={{ width: '100%', padding: '10px 12px', borderRadius: DESIGN.radiusInput, border: `1px solid ${DESIGN.gray200}`, fontSize: '14px' }}
                            />
                            <p style={{ fontSize: '12px', color: DESIGN.gray400, marginTop: '4px' }}>Leave empty to hide</p>
                        </div>

                        {/* Custom Text */}
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: DESIGN.gray600, marginBottom: '6px' }}>
                                Custom Text
                            </label>
                            <input type="text" value={formData.customText}
                                onChange={(e) => handleFieldChange('customText', e.target.value)}
                                placeholder="Optional footer text"
                                style={{ width: '100%', padding: '10px 12px', borderRadius: DESIGN.radiusInput, border: `1px solid ${DESIGN.gray200}`, fontSize: '14px' }}
                            />
                        </div>

                        {/* Icon Selection */}
                        <IconPicker
                            selectedIcon={formData.icon}
                            selectedColor={formData.iconColor}
                            onIconChange={(icon) => handleFieldChange('icon', icon)}
                            onColorChange={(color) => handleFieldChange('iconColor', color)}
                            label="Footer Icon"
                        />

                        {/* Status */}
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: DESIGN.gray600, marginBottom: '6px' }}>Status</label>
                            <select value={templateStatus} onChange={(e) => { setTemplateStatus(e.target.value); setHasUnsavedChanges(true); }}
                                style={{ width: '100%', padding: '10px 12px', borderRadius: DESIGN.radiusInput, border: `1px solid ${DESIGN.gray200}`, fontSize: '14px' }}>
                                <option value="draft">Draft</option>
                                <option value="active">Active</option>
                                <option value="archived">Archived</option>
                            </select>
                        </div>
                    </div>

                    {/* Right - Preview */}
                    <div style={{ flex: 1, background: '#E5E7EB', display: 'flex', alignItems: 'flex-end', justifyContent: 'center', padding: '40px', overflow: 'auto' }}>
                        <div style={{ width: '600px', background: DESIGN.bgCard, borderRadius: '8px', boxShadow: DESIGN.shadowElevated, overflow: 'hidden' }}>
                            {/* Content placeholder */}
                            <div style={{ padding: '40px', minHeight: '250px' }}>
                                <div style={{ background: '#F3F4F6', height: '16px', width: '80%', borderRadius: '4px', marginBottom: '12px' }} />
                                <div style={{ background: '#F3F4F6', height: '16px', width: '90%', borderRadius: '4px', marginBottom: '12px' }} />
                                <div style={{ background: '#F3F4F6', height: '16px', width: '70%', borderRadius: '4px' }} />
                            </div>
                            {/* Footer Preview Strip */}
                            <div style={{
                                height: '48px', background: '#F8FAFC', borderTop: `1px solid ${DESIGN.gray200}`,
                                display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '0 24px'
                            }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                    {/* Icon in footer */}
                                    {formData.icon && formData.icon !== 'none' && AdminIcons[formData.icon] && (
                                        React.createElement(AdminIcons[formData.icon], { size: 14, style: { color: formData.iconColor } })
                                    )}
                                    {formData.confidentialityText && (
                                        <span style={{ fontSize: '11px', fontWeight: '600', color: '#DC2626', letterSpacing: '0.5px' }}>
                                            {formData.confidentialityText}
                                        </span>
                                    )}
                                </div>
                                {formData.customText && (
                                    <span style={{ fontSize: '11px', color: DESIGN.gray400, flex: 1, textAlign: 'center' }}>
                                        {formData.customText}
                                    </span>
                                )}
                                {formData.showPageNumbers && (
                                    <span style={{ fontSize: '11px', color: DESIGN.gray400 }}>
                                        {formatPageNumber(formData.pageNumberFormat)}
                                    </span>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    // ==========================================
    // END PAGE EDITOR
    // ==========================================
    function EndPageEditorModal({ template, user, onClose, onSave, isMobile }) {
        const [formData, setFormData] = useState({
            phone: template?.content?.phone || '',
            email: template?.content?.email || '',
            address: template?.content?.address || '',
            message: template?.content?.message || 'Thank you for choosing Guiding Light Recovery Services. If you have any questions, please contact us.',
            showSocialLinks: template?.content?.showSocialLinks || false,
            socialLinks: template?.content?.socialLinks || { website: '', facebook: '', instagram: '' },
            icon: template?.content?.icon || 'none',
            iconColor: template?.content?.iconColor || '#059669'
        });
        const [templateName, setTemplateName] = useState(template?.name || 'New End Page');
        const [templateStatus, setTemplateStatus] = useState(template?.status || 'draft');
        const [saving, setSaving] = useState(false);
        const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);

        if (isMobile) {
            return (
                <div style={{
                    position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                    background: DESIGN.bgPage, zIndex: 1000,
                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                    flexDirection: 'column', padding: '24px', textAlign: 'center'
                }}>
                    <AdminIcons.Monitor size={48} style={{ color: DESIGN.gray400, marginBottom: '16px' }} />
                    <h2 style={{ fontSize: '20px', fontWeight: '600', color: DESIGN.gray600, marginBottom: '8px' }}>Desktop Required</h2>
                    <p style={{ fontSize: '14px', color: DESIGN.gray400, marginBottom: '24px' }}>The template editor requires a larger screen.</p>
                    <button onClick={onClose} style={{
                        padding: '12px 24px', background: 'linear-gradient(135deg, #0077CC 0%, #005A9C 100%)',
                        color: 'white', border: 'none', borderRadius: DESIGN.radiusInput, fontWeight: '600', cursor: 'pointer'
                    }}>Go Back</button>
                </div>
            );
        }

        const handleFieldChange = (field, value) => {
            setFormData(prev => ({ ...prev, [field]: value }));
            setHasUnsavedChanges(true);
        };

        const handleSocialLinkChange = (platform, value) => {
            setFormData(prev => ({
                ...prev,
                socialLinks: { ...prev.socialLinks, [platform]: value }
            }));
            setHasUnsavedChanges(true);
        };

        const handleSave = async () => {
            setSaving(true);
            try {
                await onSave(template?.id, { name: templateName, status: templateStatus, content: { ...formData } });
                setHasUnsavedChanges(false);
            } catch (error) {
                alert('Failed to save: ' + error.message);
            } finally {
                setSaving(false);
            }
        };

        const handleClose = () => {
            if (hasUnsavedChanges && !confirm('You have unsaved changes. Close anyway?')) return;
            onClose();
        };

        return (
            <div style={{
                position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                background: DESIGN.bgPage, zIndex: 1000, display: 'flex', flexDirection: 'column'
            }}>
                {/* Top Toolbar */}
                <div style={{
                    height: '56px', background: DESIGN.bgCard, borderBottom: `1px solid ${DESIGN.gray200}`,
                    display: 'flex', alignItems: 'center', padding: '0 16px', gap: '16px'
                }}>
                    <button onClick={handleClose} style={{
                        display: 'flex', alignItems: 'center', gap: '6px', padding: '8px 12px',
                        background: 'transparent', border: 'none', color: DESIGN.gray500, fontSize: '14px', cursor: 'pointer'
                    }}>
                        <AdminIcons.ArrowLeft size={18} /> Back
                    </button>

                    <div style={{ flex: 1, display: 'flex', alignItems: 'center', gap: '12px' }}>
                        <AdminIcons.FileCheck size={20} style={{ color: DESIGN.typeColors.endPage.icon }} />
                        <input type="text" value={templateName}
                            onChange={(e) => { setTemplateName(e.target.value); setHasUnsavedChanges(true); }}
                            style={{ fontSize: '16px', fontWeight: '600', border: 'none', background: 'transparent', color: DESIGN.gray600, outline: 'none', width: '300px' }}
                            placeholder="End Page Name"
                        />
                        <span style={{
                            fontSize: '12px', padding: '4px 8px', borderRadius: '12px',
                            background: hasUnsavedChanges ? '#FEF3C7' : '#DCFCE7', color: hasUnsavedChanges ? '#D97706' : '#16A34A'
                        }}>
                            {saving ? 'Saving...' : hasUnsavedChanges ? 'Unsaved' : 'Saved'}
                        </span>
                    </div>

                    <button onClick={handleSave} disabled={saving || !hasUnsavedChanges} style={{
                        padding: '8px 16px', background: hasUnsavedChanges ? 'linear-gradient(135deg, #0077CC 0%, #005A9C 100%)' : DESIGN.gray200,
                        color: hasUnsavedChanges ? 'white' : DESIGN.gray400, border: 'none', borderRadius: DESIGN.radiusInput,
                        fontWeight: '600', cursor: hasUnsavedChanges ? 'pointer' : 'not-allowed', display: 'flex', alignItems: 'center', gap: '6px'
                    }}>
                        <AdminIcons.Save size={16} /> Save
                    </button>
                </div>

                {/* Main Content */}
                <div style={{ flex: 1, display: 'flex', overflow: 'hidden' }}>
                    {/* Left - Form */}
                    <div style={{ width: '360px', background: DESIGN.bgCard, borderRight: `1px solid ${DESIGN.gray200}`, overflow: 'auto', padding: '24px' }}>
                        <h3 style={{ fontSize: '14px', fontWeight: '600', color: DESIGN.gray600, marginBottom: '20px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                            End Page Settings
                        </h3>

                        {/* Contact Info */}
                        <div style={{ marginBottom: '24px' }}>
                            <h4 style={{ fontSize: '13px', fontWeight: '600', color: DESIGN.gray500, marginBottom: '12px' }}>Contact Information</h4>

                            <div style={{ marginBottom: '16px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: DESIGN.gray600, marginBottom: '6px' }}>Phone</label>
                                <input type="text" value={formData.phone} onChange={(e) => handleFieldChange('phone', e.target.value)}
                                    placeholder="(555) 123-4567"
                                    style={{ width: '100%', padding: '10px 12px', borderRadius: DESIGN.radiusInput, border: `1px solid ${DESIGN.gray200}`, fontSize: '14px' }} />
                            </div>

                            <div style={{ marginBottom: '16px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: DESIGN.gray600, marginBottom: '6px' }}>Email</label>
                                <input type="email" value={formData.email} onChange={(e) => handleFieldChange('email', e.target.value)}
                                    placeholder="contact@glrs.com"
                                    style={{ width: '100%', padding: '10px 12px', borderRadius: DESIGN.radiusInput, border: `1px solid ${DESIGN.gray200}`, fontSize: '14px' }} />
                            </div>

                            <div style={{ marginBottom: '16px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: DESIGN.gray600, marginBottom: '6px' }}>Address</label>
                                <textarea value={formData.address} onChange={(e) => handleFieldChange('address', e.target.value)}
                                    placeholder="123 Recovery Lane\nSan Mateo, CA 94401"
                                    rows={3}
                                    style={{ width: '100%', padding: '10px 12px', borderRadius: DESIGN.radiusInput, border: `1px solid ${DESIGN.gray200}`, fontSize: '14px', resize: 'vertical' }} />
                            </div>
                        </div>

                        {/* Message */}
                        <div style={{ marginBottom: '24px' }}>
                            <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: DESIGN.gray600, marginBottom: '6px' }}>
                                Message / Next Steps
                            </label>
                            <textarea value={formData.message} onChange={(e) => handleFieldChange('message', e.target.value)}
                                rows={4}
                                style={{ width: '100%', padding: '10px 12px', borderRadius: DESIGN.radiusInput, border: `1px solid ${DESIGN.gray200}`, fontSize: '14px', resize: 'vertical' }} />
                        </div>

                        {/* Social Links Toggle */}
                        <div style={{ marginBottom: '16px' }}>
                            <label style={{ display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer' }}>
                                <input type="checkbox" checked={formData.showSocialLinks} onChange={(e) => handleFieldChange('showSocialLinks', e.target.checked)}
                                    style={{ width: '18px', height: '18px', accentColor: '#0077CC' }} />
                                <span style={{ fontSize: '14px', fontWeight: '500', color: DESIGN.gray600 }}>Show Social Links</span>
                            </label>
                        </div>

                        {/* Social Links */}
                        {formData.showSocialLinks && (
                            <div style={{ marginBottom: '24px', paddingLeft: '28px' }}>
                                <div style={{ marginBottom: '12px' }}>
                                    <label style={{ display: 'block', fontSize: '13px', color: DESIGN.gray500, marginBottom: '4px' }}>Website</label>
                                    <input type="url" value={formData.socialLinks.website} onChange={(e) => handleSocialLinkChange('website', e.target.value)}
                                        placeholder="https://glrecoveryservices.com"
                                        style={{ width: '100%', padding: '8px 10px', borderRadius: DESIGN.radiusInput, border: `1px solid ${DESIGN.gray200}`, fontSize: '13px' }} />
                                </div>
                                <div style={{ marginBottom: '12px' }}>
                                    <label style={{ display: 'block', fontSize: '13px', color: DESIGN.gray500, marginBottom: '4px' }}>Facebook</label>
                                    <input type="url" value={formData.socialLinks.facebook} onChange={(e) => handleSocialLinkChange('facebook', e.target.value)}
                                        placeholder="https://facebook.com/glrs"
                                        style={{ width: '100%', padding: '8px 10px', borderRadius: DESIGN.radiusInput, border: `1px solid ${DESIGN.gray200}`, fontSize: '13px' }} />
                                </div>
                                <div>
                                    <label style={{ display: 'block', fontSize: '13px', color: DESIGN.gray500, marginBottom: '4px' }}>Instagram</label>
                                    <input type="url" value={formData.socialLinks.instagram} onChange={(e) => handleSocialLinkChange('instagram', e.target.value)}
                                        placeholder="https://instagram.com/glrs"
                                        style={{ width: '100%', padding: '8px 10px', borderRadius: DESIGN.radiusInput, border: `1px solid ${DESIGN.gray200}`, fontSize: '13px' }} />
                                </div>
                            </div>
                        )}

                        {/* Icon Selection */}
                        <IconPicker
                            selectedIcon={formData.icon}
                            selectedColor={formData.iconColor}
                            onIconChange={(icon) => handleFieldChange('icon', icon)}
                            onColorChange={(color) => handleFieldChange('iconColor', color)}
                            label="End Page Icon"
                        />

                        {/* Status */}
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: DESIGN.gray600, marginBottom: '6px' }}>Status</label>
                            <select value={templateStatus} onChange={(e) => { setTemplateStatus(e.target.value); setHasUnsavedChanges(true); }}
                                style={{ width: '100%', padding: '10px 12px', borderRadius: DESIGN.radiusInput, border: `1px solid ${DESIGN.gray200}`, fontSize: '14px' }}>
                                <option value="draft">Draft</option>
                                <option value="active">Active</option>
                                <option value="archived">Archived</option>
                            </select>
                        </div>
                    </div>

                    {/* Right - Preview */}
                    <div style={{ flex: 1, background: '#E5E7EB', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '40px', overflow: 'auto' }}>
                        <div style={{
                            width: '400px', minHeight: '520px', background: '#F8FAFC',
                            borderRadius: '8px', boxShadow: DESIGN.shadowElevated,
                            display: 'flex', flexDirection: 'column', alignItems: 'center',
                            justifyContent: 'center', padding: '48px', textAlign: 'center'
                        }}>
                            {/* Icon */}
                            {formData.icon && formData.icon !== 'none' && AdminIcons[formData.icon] && (
                                <div style={{ marginBottom: '24px' }}>
                                    {React.createElement(AdminIcons[formData.icon], { size: 48, style: { color: formData.iconColor } })}
                                </div>
                            )}

                            {/* Message */}
                            {formData.message && (
                                <p style={{ fontSize: '16px', color: DESIGN.gray600, marginBottom: '32px', lineHeight: '1.6' }}>
                                    {formData.message}
                                </p>
                            )}

                            {/* Contact Info */}
                            <div style={{ marginBottom: '32px' }}>
                                {formData.phone && (
                                    <p style={{ fontSize: '14px', color: DESIGN.gray500, marginBottom: '8px', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}>
                                        <AdminIcons.Phone size={16} /> {formData.phone}
                                    </p>
                                )}
                                {formData.email && (
                                    <p style={{ fontSize: '14px', color: DESIGN.gray500, marginBottom: '8px', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}>
                                        <AdminIcons.Mail size={16} /> {formData.email}
                                    </p>
                                )}
                                {formData.address && (
                                    <p style={{ fontSize: '14px', color: DESIGN.gray500, whiteSpace: 'pre-line', display: 'flex', alignItems: 'flex-start', justifyContent: 'center', gap: '8px' }}>
                                        <AdminIcons.MapPin size={16} style={{ marginTop: '2px', flexShrink: 0 }} /> {formData.address}
                                    </p>
                                )}
                            </div>

                            {/* Social Links */}
                            {formData.showSocialLinks && (
                                <div style={{ display: 'flex', gap: '16px' }}>
                                    {formData.socialLinks.website && <AdminIcons.Globe size={24} style={{ color: DESIGN.gray400 }} />}
                                    {formData.socialLinks.facebook && <AdminIcons.Facebook size={24} style={{ color: DESIGN.gray400 }} />}
                                    {formData.socialLinks.instagram && <AdminIcons.Instagram size={24} style={{ color: DESIGN.gray400 }} />}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    // ==========================================
    // PALETTE BLOCK (Draggable from left panel)
    // ==========================================
    function PaletteBlock({ blockType, onDragStart, onDragEnd, onClick }) {
        const Icon = blockType.icon;

        return (
            <div
                draggable
                onDragStart={(e) => onDragStart(e, blockType.type)}
                onDragEnd={onDragEnd}
                onClick={onClick}
                style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '10px',
                    padding: '10px 12px',
                    background: DESIGN.bgCard,
                    border: `1px solid ${DESIGN.gray200}`,
                    borderRadius: DESIGN.radiusInput,
                    marginBottom: '8px',
                    cursor: 'grab',
                    transition: DESIGN.transitionFast
                }}
                onMouseEnter={(e) => {
                    e.currentTarget.style.borderColor = '#0077CC';
                    e.currentTarget.style.background = DESIGN.gray100;
                }}
                onMouseLeave={(e) => {
                    e.currentTarget.style.borderColor = DESIGN.gray200;
                    e.currentTarget.style.background = DESIGN.bgCard;
                }}
            >
                {/* Drag handle */}
                <div style={{
                    display: 'flex',
                    flexDirection: 'column',
                    gap: '2px'
                }}>
                    <div style={{ display: 'flex', gap: '2px' }}>
                        <span style={{ width: '3px', height: '3px', borderRadius: '50%', background: DESIGN.gray400 }} />
                        <span style={{ width: '3px', height: '3px', borderRadius: '50%', background: DESIGN.gray400 }} />
                    </div>
                    <div style={{ display: 'flex', gap: '2px' }}>
                        <span style={{ width: '3px', height: '3px', borderRadius: '50%', background: DESIGN.gray400 }} />
                        <span style={{ width: '3px', height: '3px', borderRadius: '50%', background: DESIGN.gray400 }} />
                    </div>
                    <div style={{ display: 'flex', gap: '2px' }}>
                        <span style={{ width: '3px', height: '3px', borderRadius: '50%', background: DESIGN.gray400 }} />
                        <span style={{ width: '3px', height: '3px', borderRadius: '50%', background: DESIGN.gray400 }} />
                    </div>
                </div>

                <Icon size={18} color={DESIGN.gray500} />

                <span style={{
                    fontSize: DESIGN.fontSizeMetadata,
                    color: DESIGN.gray600,
                    fontWeight: '500'
                }}>
                    {blockType.label}
                </span>
            </div>
        );
    }

    // ==========================================
    // CANVAS BLOCK (Rendered in center panel)
    // ==========================================
    function CanvasBlock({ block, index, isSelected, isDragging = false, onSelect, onDelete, onDragStart, onDragEnd, previewMode = false }) {
        const roleColor = block.role ? ROLE_COLORS[block.role] : null;
        const [isHovered, setIsHovered] = React.useState(false);

        return (
            <div
                draggable={!previewMode}
                onDragStart={previewMode ? undefined : (e) => {
                    e.dataTransfer.effectAllowed = 'move';
                    onDragStart(e, block.id, index);
                }}
                onDragEnd={previewMode ? undefined : onDragEnd}
                onClick={previewMode ? undefined : onSelect}
                style={{
                    position: 'relative',
                    padding: 0,
                    border: 'none',
                    borderRadius: 0,
                    background: 'transparent',
                    cursor: previewMode ? 'default' : (isHovered ? 'grab' : 'pointer'),
                    transition: 'all 150ms ease',
                    marginBottom: 0,
                    userSelect: 'none',
                    WebkitUserSelect: 'none',
                    // Visual feedback when dragging
                    opacity: isDragging ? 0.5 : 1,
                    transform: isDragging ? 'scale(0.98)' : 'scale(1)',
                    boxShadow: isDragging ? '0 4px 12px rgba(0,0,0,0.15)' : 'none'
                }}
                onMouseEnter={previewMode ? undefined : () => setIsHovered(true)}
                onMouseLeave={previewMode ? undefined : () => setIsHovered(false)}
            >
                {/* Selection/Hover Overlay - visual chrome that doesn't affect content height */}
                {!previewMode && (
                    <div style={{
                        position: 'absolute',
                        top: -4,
                        left: -4,
                        right: -4,
                        bottom: -4,
                        border: isSelected ? `2px solid ${DESIGN.primary}` : (isHovered ? `2px solid ${DESIGN.gray300}` : '2px solid transparent'),
                        borderRadius: DESIGN.radiusInput,
                        background: isSelected ? 'rgba(0,119,204,0.02)' : (isHovered ? 'rgba(0,0,0,0.02)' : 'transparent'),
                        pointerEvents: 'none',
                        transition: DESIGN.transitionFast,
                        zIndex: -1  // Behind content so drag events work
                    }} />
                )}

                {/* Delete button (visible on selection, hidden in preview mode) */}
                {!previewMode && isSelected && (
                    <button
                        onClick={(e) => { e.stopPropagation(); onDelete(); }}
                        style={{
                            position: 'absolute',
                            top: -12,
                            right: -12,
                            width: 24,
                            height: 24,
                            borderRadius: '50%',
                            background: DESIGN.error,
                            border: 'none',
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            zIndex: 10
                        }}
                    >
                        <AdminIcons.X size={14} color="white" />
                    </button>
                )}

                {/* Block content based on type */}
                {/* Content blocks use shared GLRS_REACT renderer for WYSIWYG consistency */}
                {GLRS_REACT.isContentType(block.type) && block.type !== 'pageBreak' && (
                    GLRS_REACT.renderBlock(block, index, {})
                )}

                {/* Page Break - dashed red line with scissors icons */}
                {block.type === 'pageBreak' && (
                    <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        padding: '16px 0',
                        margin: '8px 0'
                    }}>
                        <AdminIcons.Scissors size={16} color={DESIGN.error} style={{ transform: 'rotate(90deg)' }} />
                        <div style={{
                            flex: 1,
                            height: '2px',
                            margin: '0 12px',
                            borderTop: `2px dashed ${DESIGN.error}`,
                            opacity: 0.6
                        }} />
                        <span style={{
                            fontSize: '11px',
                            color: DESIGN.error,
                            fontWeight: '600',
                            textTransform: 'uppercase',
                            letterSpacing: '0.5px'
                        }}>Page Break</span>
                        <div style={{
                            flex: 1,
                            height: '2px',
                            margin: '0 12px',
                            borderTop: `2px dashed ${DESIGN.error}`,
                            opacity: 0.6
                        }} />
                        <AdminIcons.Scissors size={16} color={DESIGN.error} style={{ transform: 'rotate(-90deg)' }} />
                    </div>
                )}

                {block.type === 'signatureBlock' && (
                    <div style={{
                        padding: '8px 10px',
                        border: `2px solid ${roleColor?.border || DESIGN.gray300}`,
                        borderRadius: '6px',
                        background: roleColor?.bg || DESIGN.gray100
                    }}>
                        <div style={{
                            fontSize: '11px',
                            color: roleColor?.text || DESIGN.gray500,
                            fontWeight: '600',
                            marginBottom: '6px',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px'
                        }}>
                            <AdminIcons.PenLine size={12} />
                            {block.label || 'Signature'}
                            {block.required && <span style={{ color: '#DC2626' }}>*</span>}
                        </div>
                        <div style={{
                            borderBottom: `2px solid ${roleColor?.border || DESIGN.gray400}`,
                            height: '28px',
                            marginBottom: '6px'
                        }} />
                        <div style={{
                            display: 'grid',
                            gridTemplateColumns: '1fr 1fr',
                            gap: '10px'
                        }}>
                            <div>
                                <div style={{ fontSize: '10px', color: DESIGN.gray400, marginBottom: '2px' }}>
                                    Printed Name
                                </div>
                                <div style={{ borderBottom: `1px solid ${DESIGN.gray300}`, height: '18px' }} />
                            </div>
                            <div>
                                <div style={{ fontSize: '10px', color: DESIGN.gray400, marginBottom: '2px' }}>
                                    Date
                                </div>
                                <div style={{ borderBottom: `1px solid ${DESIGN.gray300}`, height: '18px' }} />
                            </div>
                        </div>
                    </div>
                )}

                {block.type === 'acknowledgment' && (
                    <div style={{
                        display: 'flex',
                        gap: '8px',
                        alignItems: 'flex-start',
                        padding: '6px 10px',
                        border: `1px solid ${roleColor?.border || DESIGN.gray200}`,
                        borderRadius: '6px',
                        background: roleColor?.bg || DESIGN.gray100
                    }}>
                        <div style={{
                            width: '14px',
                            height: '14px',
                            border: `2px solid ${roleColor?.border || DESIGN.gray400}`,
                            borderRadius: '3px',
                            flexShrink: 0,
                            marginTop: '2px'
                        }} />
                        <div style={{
                            fontSize: '12px',
                            color: DESIGN.gray600,
                            lineHeight: '1.4'
                        }}>
                            {block.text || 'Acknowledgment text'}
                            {block.required && <span style={{ color: '#DC2626' }}> *</span>}
                        </div>
                    </div>
                )}

                {/* Signature Field - matches sign.html exactly with dashed border box */}
                {block.type === 'signatureField' && (
                    <div style={{
                        padding: '6px 10px',
                        borderLeft: `3px solid ${roleColor?.border || DESIGN.gray400}`,
                        background: roleColor?.bg || DESIGN.gray100,
                        borderRadius: '0 6px 6px 0',
                        marginBottom: '4px'
                    }}>
                        <div style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            marginBottom: '4px'
                        }}>
                            <div style={{
                                fontSize: '11px',
                                color: DESIGN.gray500,
                                display: 'flex',
                                alignItems: 'center',
                                gap: '4px'
                            }}>
                                {block.label || 'Signature'}
                                {block.required && <span style={{ color: DESIGN.error }}>*</span>}
                            </div>
                            <span style={{
                                padding: '1px 6px',
                                background: roleColor?.bg || DESIGN.gray200,
                                color: roleColor?.text || DESIGN.gray500,
                                borderRadius: '3px',
                                fontSize: '9px',
                                fontWeight: '600'
                            }}>
                                {SIGNER_ROLES[block.role]?.label || 'PIR'}
                            </span>
                        </div>
                        {/* Dashed border box matching sign.html */}
                        <div style={{
                            height: '36px',
                            border: `2px dashed ${DESIGN.gray300}`,
                            borderRadius: '4px',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            background: 'transparent'
                        }}>
                            <span style={{ color: DESIGN.gray400, fontSize: '12px' }}>
                                Click to sign
                            </span>
                        </div>
                    </div>
                )}

                {/* Initials Field - matches sign.html exactly with dashed border box */}
                {block.type === 'initialsField' && (
                    <div style={{
                        padding: '6px 10px',
                        borderLeft: `3px solid ${roleColor?.border || DESIGN.gray400}`,
                        background: roleColor?.bg || DESIGN.gray100,
                        borderRadius: '0 6px 6px 0',
                        marginBottom: '4px'
                    }}>
                        <div style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            marginBottom: '4px'
                        }}>
                            <div style={{
                                fontSize: '11px',
                                color: DESIGN.gray500,
                                display: 'flex',
                                alignItems: 'center',
                                gap: '4px'
                            }}>
                                {block.label || 'Initials'}
                                {block.required && <span style={{ color: DESIGN.error }}>*</span>}
                            </div>
                            <span style={{
                                padding: '1px 6px',
                                background: roleColor?.bg || DESIGN.gray200,
                                color: roleColor?.text || DESIGN.gray500,
                                borderRadius: '3px',
                                fontSize: '9px',
                                fontWeight: '600'
                            }}>
                                {SIGNER_ROLES[block.role]?.label || 'PIR'}
                            </span>
                        </div>
                        {/* Dashed border box matching sign.html (smaller for initials) */}
                        <div style={{
                            height: '28px',
                            border: `2px dashed ${DESIGN.gray300}`,
                            borderRadius: '4px',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            background: 'transparent'
                        }}>
                            <span style={{ color: DESIGN.gray400, fontSize: '12px' }}>
                                Click to sign
                            </span>
                        </div>
                    </div>
                )}

                {/* Date Field - matches sign.html input styling */}
                {block.type === 'dateField' && (
                    <div style={{
                        padding: '6px 10px',
                        borderLeft: `3px solid ${roleColor?.border || DESIGN.gray400}`,
                        background: roleColor?.bg || DESIGN.gray100,
                        borderRadius: '0 6px 6px 0',
                        marginBottom: '4px'
                    }}>
                        <div style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            marginBottom: '4px'
                        }}>
                            <div style={{
                                fontSize: '11px',
                                color: DESIGN.gray500,
                                display: 'flex',
                                alignItems: 'center',
                                gap: '4px'
                            }}>
                                {block.label || 'Date'}
                                {block.required && <span style={{ color: DESIGN.error }}>*</span>}
                            </div>
                            <span style={{
                                padding: '1px 6px',
                                background: roleColor?.bg || DESIGN.gray200,
                                color: roleColor?.text || DESIGN.gray500,
                                borderRadius: '3px',
                                fontSize: '9px',
                                fontWeight: '600'
                            }}>
                                {SIGNER_ROLES[block.role]?.label || 'PIR'}
                            </span>
                        </div>
                        {/* Input preview matching sign.html */}
                        <div style={{
                            width: '100%',
                            padding: '6px 10px',
                            border: `1px solid ${DESIGN.gray300}`,
                            borderRadius: '4px',
                            fontSize: '13px',
                            background: 'white',
                            color: DESIGN.gray400
                        }}>
                            {block.autoFill ? new Date().toLocaleDateString('en-US') : 'MM/DD/YYYY'}
                        </div>
                    </div>
                )}

                {/* Text Input Field - matches sign.html input styling */}
                {block.type === 'textInputField' && (
                    <div style={{
                        padding: '6px 10px',
                        borderLeft: `3px solid ${roleColor?.border || DESIGN.gray400}`,
                        background: roleColor?.bg || DESIGN.gray100,
                        borderRadius: '0 6px 6px 0',
                        marginBottom: '4px'
                    }}>
                        <div style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            marginBottom: '4px'
                        }}>
                            <div style={{
                                fontSize: '11px',
                                color: DESIGN.gray500,
                                display: 'flex',
                                alignItems: 'center',
                                gap: '4px'
                            }}>
                                {block.label || 'Text Input'}
                                {block.required && <span style={{ color: DESIGN.error }}>*</span>}
                            </div>
                            <span style={{
                                padding: '1px 6px',
                                background: roleColor?.bg || DESIGN.gray200,
                                color: roleColor?.text || DESIGN.gray500,
                                borderRadius: '3px',
                                fontSize: '9px',
                                fontWeight: '600'
                            }}>
                                {SIGNER_ROLES[block.role]?.label || 'PIR'}
                            </span>
                        </div>
                        {/* Input preview matching sign.html */}
                        <div style={{
                            width: '100%',
                            padding: '6px 10px',
                            border: `1px solid ${DESIGN.gray300}`,
                            borderRadius: '4px',
                            fontSize: '13px',
                            background: 'white',
                            color: DESIGN.gray400
                        }}>
                            {block.placeholder || 'Enter text...'}
                        </div>
                    </div>
                )}

                {/* Checkbox Field - matches sign.html styling */}
                {block.type === 'checkboxField' && (
                    <div style={{
                        display: 'flex',
                        gap: '8px',
                        alignItems: 'flex-start',
                        padding: '6px 10px',
                        borderLeft: `3px solid ${roleColor?.border || DESIGN.gray400}`,
                        background: roleColor?.bg || DESIGN.gray100,
                        borderRadius: '0 6px 6px 0',
                        marginBottom: '4px'
                    }}>
                        {/* Checkbox preview matching sign.html */}
                        <div style={{
                            width: '16px',
                            height: '16px',
                            border: `2px solid ${DESIGN.gray300}`,
                            borderRadius: '3px',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            background: 'white',
                            flexShrink: 0
                        }} />
                        <div style={{ flex: 1 }}>
                            <div style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'flex-start'
                            }}>
                                <span style={{
                                    fontSize: '12px',
                                    color: DESIGN.gray700,
                                    lineHeight: '1.4'
                                }}>
                                    {block.label || 'Checkbox label'}
                                    {block.required && <span style={{ color: DESIGN.error }}> *</span>}
                                </span>
                                <span style={{
                                    padding: '1px 6px',
                                    background: roleColor?.bg || DESIGN.gray200,
                                    color: roleColor?.text || DESIGN.gray500,
                                    borderRadius: '3px',
                                    fontSize: '9px',
                                    fontWeight: '600',
                                    marginLeft: '8px',
                                    flexShrink: 0
                                }}>
                                    {SIGNER_ROLES[block.role]?.label || 'PIR'}
                                </span>
                            </div>
                        </div>
                    </div>
                )}

                {/* Dropdown Field - matches sign.html select styling */}
                {block.type === 'dropdownField' && (
                    <div style={{
                        padding: '6px 10px',
                        borderLeft: `3px solid ${roleColor?.border || DESIGN.gray400}`,
                        background: roleColor?.bg || DESIGN.gray100,
                        borderRadius: '0 6px 6px 0',
                        marginBottom: '4px'
                    }}>
                        <div style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            marginBottom: '4px'
                        }}>
                            <div style={{
                                fontSize: '11px',
                                color: DESIGN.gray500,
                                display: 'flex',
                                alignItems: 'center',
                                gap: '4px'
                            }}>
                                {block.label || 'Dropdown'}
                                {block.required && <span style={{ color: DESIGN.error }}>*</span>}
                            </div>
                            <span style={{
                                padding: '1px 6px',
                                background: roleColor?.bg || DESIGN.gray200,
                                color: roleColor?.text || DESIGN.gray500,
                                borderRadius: '3px',
                                fontSize: '9px',
                                fontWeight: '600'
                            }}>
                                {SIGNER_ROLES[block.role]?.label || 'PIR'}
                            </span>
                        </div>
                        {/* Select preview matching sign.html */}
                        <div style={{
                            width: '100%',
                            padding: '6px 10px',
                            border: `1px solid ${DESIGN.gray300}`,
                            borderRadius: '4px',
                            fontSize: '13px',
                            background: 'white',
                            color: DESIGN.gray400,
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center'
                        }}>
                            <span>Select an option</span>
                            <AdminIcons.ChevronDown size={12} color={DESIGN.gray400} />
                        </div>
                        {block.options && block.options.length > 0 && (
                            <div style={{
                                marginTop: '4px',
                                fontSize: '10px',
                                color: DESIGN.gray400
                            }}>
                                Options: {block.options.join(', ')}
                            </div>
                        )}
                    </div>
                )}
            </div>
        );
    }

    // ==========================================
    // EDITOR PAGE COMPONENTS - Match sign.html for WYSIWYG
    // ==========================================

    // Cover Page - Full rendered cover matching sign.html
    function EditorCoverPage({ coverTemplate, documentTitle, pageNum, totalPages }) {
        const cBlock = coverTemplate?.content?.blocks?.[0] || {};
        return (
            <div style={{
                background: 'white',
                width: PAGE_WIDTH,
                minHeight: PAGE_HEIGHT,
                margin: '0 auto 24px',
                padding: PAGE_MARGIN,
                boxShadow: '0 4px 20px rgba(0,0,0,0.1)',
                borderRadius: '2px',
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                textAlign: 'center'
            }}>
                {cBlock.logoUrl ? (
                    <img src={cBlock.logoUrl} alt="Logo" style={{ maxHeight: '80px', marginBottom: '40px', objectFit: 'contain' }} />
                ) : (
                    <div style={{
                        width: '80px',
                        height: '80px',
                        background: DESIGN.gradient,
                        borderRadius: '16px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        marginBottom: '40px'
                    }}>
                        <AdminIcons.FileText size={40} color="white" />
                    </div>
                )}
                <h1 style={{
                    fontSize: '28px',
                    fontWeight: '700',
                    color: DESIGN.primary,
                    marginBottom: '16px',
                    margin: '0 0 16px 0'
                }}>
                    {documentTitle || 'Service Agreement'}
                </h1>
                {cBlock.subtitle && (
                    <p style={{ fontSize: '18px', color: DESIGN.gray600, marginBottom: '40px', margin: '0 0 40px 0' }}>
                        {cBlock.subtitle}
                    </p>
                )}
                <p style={{ color: DESIGN.gray500, margin: '0 0 60px 0' }}>
                    {cBlock.companyName || 'Guiding Light Recovery Services LLC'}
                </p>
                <p style={{ color: DESIGN.gray600, margin: '0 0 8px 0' }}>
                    Prepared for: <span style={{ fontWeight: '600' }}>[PIR Name]</span>
                </p>
                <p style={{ color: DESIGN.gray500, margin: 0 }}>
                    Date: {new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
                </p>
                <div style={{ marginTop: 'auto', paddingTop: '60px', fontSize: '11px', color: DESIGN.gray400 }}>
                    Page {pageNum} of {totalPages}
                </div>
            </div>
        );
    }

    // Page Header - Matches sign.html PageHeader
    function EditorPageHeader({ pageNum, totalPages, documentTitle, headerTemplate }) {
        const hBlock = headerTemplate?.content?.blocks?.[0] || {};
        return (
            <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                padding: '4px 0',  // Compact: was 12px 0
                borderBottom: `1px solid ${DESIGN.gray200}`,
                marginBottom: '8px',  // Compact: was 20px
                minHeight: HEADER_HEIGHT - 12  // Compact: was HEADER_HEIGHT - 20
            }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                    {hBlock.logoUrl ? (
                        <img src={hBlock.logoUrl} alt="Logo" style={{ height: '22px', maxWidth: '80px', objectFit: 'contain' }} />
                    ) : (
                        <div style={{
                            width: '22px',
                            height: '22px',
                            background: DESIGN.gradient,
                            borderRadius: '4px',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center'
                        }}>
                            <AdminIcons.FileText size={12} color="white" />
                        </div>
                    )}
                    <div>
                        <div style={{ fontSize: '11px', fontWeight: '600', color: DESIGN.gray900, lineHeight: 1.2 }}>
                            {hBlock.companyName || documentTitle || 'Document Title'}
                        </div>
                        <div style={{ fontSize: '9px', color: DESIGN.gray500, lineHeight: 1.2 }}>
                            {hBlock.tagline || 'Guiding Light Recovery Services LLC'}
                        </div>
                    </div>
                </div>
                <div style={{ fontSize: '9px', color: DESIGN.gray500 }}>
                    Page {pageNum} of {totalPages}
                </div>
            </div>
        );
    }

    // Page Footer - Matches sign.html PageFooter
    function EditorPageFooter({ pageNum, footerTemplate }) {
        const fBlock = footerTemplate?.content?.blocks?.[0] || {};
        return (
            <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                padding: '4px 0',  // Compact: was 12px 0
                borderTop: `1px solid ${DESIGN.gray200}`,
                marginTop: 0,  // WYSIWYG: Footer sits directly below content
                minHeight: FOOTER_HEIGHT - 8,  // Compact: was FOOTER_HEIGHT - 12
                fontSize: '10px',
                color: DESIGN.gray500
            }}>
                <div>{fBlock.leftText || new Date().toLocaleDateString()}</div>
                <div>{fBlock.centerText || 'CONFIDENTIAL'}</div>
                <div style={{ fontWeight: '500' }}>Page {pageNum}</div>
            </div>
        );
    }

    // End Page - Full rendered end page matching sign.html
    function EditorEndPage({ endTemplate, pageNum, totalPages }) {
        const eBlock = endTemplate?.content?.blocks?.[0] || {};
        return (
            <div style={{
                background: 'white',
                width: PAGE_WIDTH,
                minHeight: PAGE_HEIGHT,
                margin: '0 auto',
                padding: PAGE_MARGIN,
                boxShadow: '0 4px 20px rgba(0,0,0,0.1)',
                borderRadius: '2px',
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                textAlign: 'center'
            }}>
                <div style={{
                    width: '80px',
                    height: '80px',
                    background: DESIGN.gradientSuccess,
                    borderRadius: '50%',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    marginBottom: '24px'
                }}>
                    <AdminIcons.CheckCircle size={48} color="white" />
                </div>
                <h2 style={{
                    fontSize: '24px',
                    fontWeight: '700',
                    color: DESIGN.gray900,
                    margin: '0 0 16px 0'
                }}>
                    {eBlock.title || 'Thank You'}
                </h2>
                <p style={{
                    color: DESIGN.gray600,
                    maxWidth: '400px',
                    lineHeight: '1.6',
                    margin: '0 0 40px 0'
                }}>
                    {eBlock.message || 'Thank you for completing this agreement. A copy will be sent to all parties upon completion.'}
                </p>
                {eBlock.contactInfo && (
                    <div style={{ color: DESIGN.gray500, fontSize: '14px' }}>
                        {eBlock.contactInfo}
                    </div>
                )}
                <div style={{ marginTop: 'auto', paddingTop: '60px', fontSize: '11px', color: DESIGN.gray400 }}>
                    Page {pageNum} of {totalPages}
                </div>
            </div>
        );
    }

    // Content Page Wrapper - White page box for content
    function EditorContentPage({
        children,
        pageNum,
        totalPages,
        documentTitle,
        headerTemplate,
        footerTemplate,
        isLastPage
    }) {
        return (
            <div style={{
                background: 'white',
                width: PAGE_WIDTH,
                minHeight: PAGE_HEIGHT,
                margin: isLastPage ? '0 auto' : '0 auto 24px',
                padding: PAGE_MARGIN,
                boxShadow: '0 4px 20px rgba(0,0,0,0.1)',
                borderRadius: '2px',
                display: 'flex',
                flexDirection: 'column'
            }}>
                <EditorPageHeader
                    pageNum={pageNum}
                    totalPages={totalPages}
                    documentTitle={documentTitle}
                    headerTemplate={headerTemplate}
                />
                <div style={{
                    flex: 1,
                    display: 'flex',
                    flexDirection: 'column',
                    minHeight: 0  // Allow content to shrink - WYSIWYG fluid behavior
                }}>
                    {children}
                </div>
                <EditorPageFooter
                    pageNum={pageNum}
                    footerTemplate={footerTemplate}
                />
            </div>
        );
    }

    // ==========================================
    // BLOCK PROPERTIES PANEL
    // ==========================================
    function BlockPropertiesPanel({ block, onUpdate, onDeselect }) {
        return (
            <div>
                {/* Deselect button */}
                <button
                    onClick={onDeselect}
                    style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px',
                        padding: '6px 12px',
                        background: DESIGN.gray100,
                        border: 'none',
                        borderRadius: DESIGN.radiusInput,
                        color: DESIGN.gray500,
                        fontSize: DESIGN.fontSizeCaption,
                        cursor: 'pointer',
                        marginBottom: '16px'
                    }}
                >
                    <AdminIcons.X size={12} />
                    Deselect
                </button>

                {/* Block type indicator */}
                <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    padding: '10px 12px',
                    background: DESIGN.gray100,
                    borderRadius: DESIGN.radiusInput,
                    marginBottom: '20px'
                }}>
                    {(() => {
                        const blockDef = BLOCK_TYPES.find(b => b.type === block.type);
                        const Icon = blockDef?.icon || AdminIcons.FileText;
                        return (
                            <>
                                <Icon size={16} color={DESIGN.gray500} />
                                <span style={{ fontSize: DESIGN.fontSizeMetadata, color: DESIGN.gray600, fontWeight: '500' }}>
                                    {blockDef?.label || block.type}
                                </span>
                            </>
                        );
                    })()}
                </div>

                {/* Section Header properties */}
                {block.type === 'section' && (
                    <>
                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: DESIGN.fontSizeCaption,
                                color: DESIGN.gray500,
                                fontWeight: '600',
                                marginBottom: '6px'
                            }}>
                                Section Number
                            </label>
                            <input
                                type="text"
                                value={block.number || ''}
                                onChange={(e) => onUpdate({ number: e.target.value })}
                                placeholder="1"
                                style={{
                                    width: '100%',
                                    padding: '10px 12px',
                                    border: `1px solid ${DESIGN.gray200}`,
                                    borderRadius: DESIGN.radiusInput,
                                    fontSize: DESIGN.fontSizeMetadata
                                }}
                            />
                        </div>
                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: DESIGN.fontSizeCaption,
                                color: DESIGN.gray500,
                                fontWeight: '600',
                                marginBottom: '6px'
                            }}>
                                Section Title
                            </label>
                            <input
                                type="text"
                                value={block.title || ''}
                                onChange={(e) => onUpdate({ title: e.target.value })}
                                placeholder="Section Title"
                                style={{
                                    width: '100%',
                                    padding: '10px 12px',
                                    border: `1px solid ${DESIGN.gray200}`,
                                    borderRadius: DESIGN.radiusInput,
                                    fontSize: DESIGN.fontSizeMetadata
                                }}
                            />
                        </div>
                    </>
                )}

                {/* Heading properties */}
                {block.type === 'heading' && (
                    <React.Fragment>
                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: DESIGN.fontSizeCaption,
                                color: DESIGN.gray500,
                                fontWeight: '600',
                                marginBottom: '6px'
                            }}>
                                Heading Text
                            </label>
                            <input
                                type="text"
                                value={block.content || ''}
                                onChange={(e) => onUpdate({ content: e.target.value })}
                                placeholder="Heading text"
                                style={{
                                    width: '100%',
                                    padding: '10px 12px',
                                    border: `1px solid ${DESIGN.gray200}`,
                                    borderRadius: DESIGN.radiusInput,
                                    fontSize: DESIGN.fontSizeMetadata
                                }}
                            />
                        </div>
                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: DESIGN.fontSizeCaption,
                                color: DESIGN.gray500,
                                fontWeight: '600',
                                marginBottom: '6px'
                            }}>
                                Heading Level
                            </label>
                            <select
                                value={block.level || 3}
                                onChange={(e) => onUpdate({ level: parseInt(e.target.value) })}
                                style={{
                                    width: '100%',
                                    padding: '10px 12px',
                                    border: `1px solid ${DESIGN.gray200}`,
                                    borderRadius: DESIGN.radiusInput,
                                    fontSize: DESIGN.fontSizeMetadata,
                                    background: 'white'
                                }}
                            >
                                <option value={1}>Level 1 (Largest)</option>
                                <option value={2}>Level 2</option>
                                <option value={3}>Level 3</option>
                                <option value={4}>Level 4 (Smallest)</option>
                            </select>
                        </div>
                    </React.Fragment>
                )}

                {/* Paragraph properties */}
                {block.type === 'paragraph' && (
                    <div style={{ marginBottom: '16px' }}>
                        <label style={{
                            display: 'block',
                            fontSize: DESIGN.fontSizeCaption,
                            color: DESIGN.gray500,
                            fontWeight: '600',
                            marginBottom: '6px'
                        }}>
                            Content
                        </label>
                        <textarea
                            value={block.content || ''}
                            onChange={(e) => onUpdate({ content: e.target.value })}
                            placeholder="Enter paragraph text..."
                            rows={6}
                            style={{
                                width: '100%',
                                padding: '10px 12px',
                                border: `1px solid ${DESIGN.gray200}`,
                                borderRadius: DESIGN.radiusInput,
                                fontSize: DESIGN.fontSizeMetadata,
                                resize: 'vertical',
                                fontFamily: 'inherit',
                                lineHeight: '1.5'
                            }}
                        />
                    </div>
                )}

                {/* Bullet List properties */}
                {block.type === 'bulletList' && (
                    <div style={{ marginBottom: '16px' }}>
                        <label style={{
                            display: 'block',
                            fontSize: DESIGN.fontSizeCaption,
                            color: DESIGN.gray500,
                            fontWeight: '600',
                            marginBottom: '6px'
                        }}>
                            List Items
                        </label>
                        {(block.items || []).map((item, index) => (
                            <div key={index} style={{ display: 'flex', gap: '8px', marginBottom: '8px' }}>
                                <input
                                    type="text"
                                    value={item}
                                    onChange={(e) => {
                                        const newItems = [...(block.items || [])];
                                        newItems[index] = e.target.value;
                                        onUpdate({ items: newItems });
                                    }}
                                    style={{
                                        flex: 1,
                                        padding: '8px 12px',
                                        border: `1px solid ${DESIGN.gray200}`,
                                        borderRadius: DESIGN.radiusInput,
                                        fontSize: DESIGN.fontSizeMetadata
                                    }}
                                />
                                <button
                                    onClick={() => {
                                        const newItems = [...(block.items || [])];
                                        newItems.splice(index, 1);
                                        onUpdate({ items: newItems });
                                    }}
                                    style={{
                                        padding: '8px',
                                        background: 'transparent',
                                        border: `1px solid ${DESIGN.gray200}`,
                                        borderRadius: DESIGN.radiusInput,
                                        cursor: 'pointer'
                                    }}
                                >
                                    <AdminIcons.X size={14} color={DESIGN.gray500} />
                                </button>
                            </div>
                        ))}
                        <button
                            onClick={() => {
                                const newItems = [...(block.items || []), 'New item'];
                                onUpdate({ items: newItems });
                            }}
                            style={{
                                width: '100%',
                                padding: '8px',
                                background: DESIGN.gray100,
                                border: `1px dashed ${DESIGN.gray300}`,
                                borderRadius: DESIGN.radiusInput,
                                color: DESIGN.gray500,
                                fontSize: DESIGN.fontSizeCaption,
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '6px'
                            }}
                        >
                            <AdminIcons.Plus size={14} />
                            Add Item
                        </button>
                    </div>
                )}

                {/* Signature Block properties */}
                {block.type === 'signatureBlock' && (
                    <>
                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: DESIGN.fontSizeCaption,
                                color: DESIGN.gray500,
                                fontWeight: '600',
                                marginBottom: '6px'
                            }}>
                                Label
                            </label>
                            <input
                                type="text"
                                value={block.label || ''}
                                onChange={(e) => onUpdate({ label: e.target.value })}
                                placeholder="e.g., Client Signature"
                                style={{
                                    width: '100%',
                                    padding: '10px 12px',
                                    border: `1px solid ${DESIGN.gray200}`,
                                    borderRadius: DESIGN.radiusInput,
                                    fontSize: DESIGN.fontSizeMetadata
                                }}
                            />
                        </div>

                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: DESIGN.fontSizeCaption,
                                color: DESIGN.gray500,
                                fontWeight: '600',
                                marginBottom: '6px'
                            }}>
                                Signer Role
                            </label>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                {Object.entries(ROLE_COLORS).map(([role, colors]) => (
                                    <button
                                        key={role}
                                        onClick={() => onUpdate({ role })}
                                        style={{
                                            padding: '10px 12px',
                                            background: block.role === role ? colors.bg : DESIGN.bgCard,
                                            border: `2px solid ${block.role === role ? colors.border : DESIGN.gray200}`,
                                            borderRadius: DESIGN.radiusInput,
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '10px',
                                            textAlign: 'left'
                                        }}
                                    >
                                        <span style={{
                                            width: '16px',
                                            height: '16px',
                                            borderRadius: '50%',
                                            background: colors.border
                                        }} />
                                        <span style={{
                                            fontSize: DESIGN.fontSizeMetadata,
                                            color: block.role === role ? colors.text : DESIGN.gray600,
                                            fontWeight: block.role === role ? '600' : '400'
                                        }}>
                                            {colors.label}
                                        </span>
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div>
                            <label style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px',
                                cursor: 'pointer'
                            }}>
                                <input
                                    type="checkbox"
                                    checked={block.required || false}
                                    onChange={(e) => onUpdate({ required: e.target.checked })}
                                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                />
                                <span style={{ fontSize: DESIGN.fontSizeMetadata, color: DESIGN.gray600 }}>
                                    Required field
                                </span>
                            </label>
                        </div>
                    </>
                )}

                {/* Acknowledgment properties */}
                {block.type === 'acknowledgment' && (
                    <>
                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: DESIGN.fontSizeCaption,
                                color: DESIGN.gray500,
                                fontWeight: '600',
                                marginBottom: '6px'
                            }}>
                                Acknowledgment Text
                            </label>
                            <textarea
                                value={block.text || ''}
                                onChange={(e) => onUpdate({ text: e.target.value })}
                                placeholder="I acknowledge..."
                                rows={4}
                                style={{
                                    width: '100%',
                                    padding: '10px 12px',
                                    border: `1px solid ${DESIGN.gray200}`,
                                    borderRadius: DESIGN.radiusInput,
                                    fontSize: DESIGN.fontSizeMetadata,
                                    resize: 'vertical',
                                    fontFamily: 'inherit',
                                    lineHeight: '1.5'
                                }}
                            />
                        </div>

                        {/* Role selector for acknowledgment */}
                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: DESIGN.fontSizeCaption,
                                color: DESIGN.gray500,
                                fontWeight: '600',
                                marginBottom: '6px'
                            }}>
                                Signer Role
                            </label>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                {Object.entries(ROLE_COLORS).map(([role, colors]) => (
                                    <button
                                        key={role}
                                        onClick={() => onUpdate({ role })}
                                        style={{
                                            padding: '10px 12px',
                                            background: block.role === role ? colors.bg : DESIGN.bgCard,
                                            border: `2px solid ${block.role === role ? colors.border : DESIGN.gray200}`,
                                            borderRadius: DESIGN.radiusInput,
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '10px',
                                            textAlign: 'left'
                                        }}
                                    >
                                        <span style={{
                                            width: '16px',
                                            height: '16px',
                                            borderRadius: '50%',
                                            background: colors.border
                                        }} />
                                        <span style={{
                                            fontSize: DESIGN.fontSizeMetadata,
                                            color: block.role === role ? colors.text : DESIGN.gray600,
                                            fontWeight: block.role === role ? '600' : '400'
                                        }}>
                                            {colors.label}
                                        </span>
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div>
                            <label style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px',
                                cursor: 'pointer'
                            }}>
                                <input
                                    type="checkbox"
                                    checked={block.required || false}
                                    onChange={(e) => onUpdate({ required: e.target.checked })}
                                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                />
                                <span style={{ fontSize: DESIGN.fontSizeMetadata, color: DESIGN.gray600 }}>
                                    Required field
                                </span>
                            </label>
                        </div>
                    </>
                )}

                {/* ========================================== */}
                {/* NEW SIGNATURE FIELD PROPERTIES             */}
                {/* ========================================== */}

                {/* Signature Field properties */}
                {block.type === 'signatureField' && (
                    <>
                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: DESIGN.fontSizeCaption,
                                color: DESIGN.gray500,
                                fontWeight: '600',
                                marginBottom: '6px'
                            }}>
                                Field Label
                            </label>
                            <input
                                type="text"
                                value={block.label || ''}
                                onChange={(e) => onUpdate({ label: e.target.value })}
                                placeholder="e.g., Client Signature"
                                style={{
                                    width: '100%',
                                    padding: '10px 12px',
                                    border: `1px solid ${DESIGN.gray200}`,
                                    borderRadius: DESIGN.radiusInput,
                                    fontSize: DESIGN.fontSizeMetadata
                                }}
                            />
                        </div>

                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: DESIGN.fontSizeCaption,
                                color: DESIGN.gray500,
                                fontWeight: '600',
                                marginBottom: '6px'
                            }}>
                                Signer Role
                            </label>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                {Object.entries(SIGNER_ROLES).map(([role, roleData]) => (
                                    <button
                                        key={role}
                                        onClick={() => onUpdate({ role })}
                                        style={{
                                            padding: '10px 12px',
                                            background: block.role === role ? roleData.bgLight : DESIGN.bgCard,
                                            border: `2px solid ${block.role === role ? roleData.borderColor : DESIGN.gray200}`,
                                            borderRadius: DESIGN.radiusInput,
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '10px',
                                            textAlign: 'left'
                                        }}
                                    >
                                        <span style={{
                                            width: '16px',
                                            height: '16px',
                                            borderRadius: '50%',
                                            background: roleData.borderColor
                                        }} />
                                        <div>
                                            <span style={{
                                                fontSize: DESIGN.fontSizeMetadata,
                                                color: block.role === role ? roleData.color : DESIGN.gray600,
                                                fontWeight: block.role === role ? '600' : '400',
                                                display: 'block'
                                            }}>
                                                {roleData.label}
                                            </span>
                                            <span style={{
                                                fontSize: '11px',
                                                color: DESIGN.gray400
                                            }}>
                                                {roleData.fullLabel}
                                            </span>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div>
                            <label style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px',
                                cursor: 'pointer'
                            }}>
                                <input
                                    type="checkbox"
                                    checked={block.required || false}
                                    onChange={(e) => onUpdate({ required: e.target.checked })}
                                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                />
                                <span style={{ fontSize: DESIGN.fontSizeMetadata, color: DESIGN.gray600 }}>
                                    Required field
                                </span>
                            </label>
                        </div>
                    </>
                )}

                {/* Initials Field properties */}
                {block.type === 'initialsField' && (
                    <>
                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: DESIGN.fontSizeCaption,
                                color: DESIGN.gray500,
                                fontWeight: '600',
                                marginBottom: '6px'
                            }}>
                                Field Label
                            </label>
                            <input
                                type="text"
                                value={block.label || ''}
                                onChange={(e) => onUpdate({ label: e.target.value })}
                                placeholder="e.g., Initials"
                                style={{
                                    width: '100%',
                                    padding: '10px 12px',
                                    border: `1px solid ${DESIGN.gray200}`,
                                    borderRadius: DESIGN.radiusInput,
                                    fontSize: DESIGN.fontSizeMetadata
                                }}
                            />
                        </div>

                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: DESIGN.fontSizeCaption,
                                color: DESIGN.gray500,
                                fontWeight: '600',
                                marginBottom: '6px'
                            }}>
                                Signer Role
                            </label>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                {Object.entries(SIGNER_ROLES).map(([role, roleData]) => (
                                    <button
                                        key={role}
                                        onClick={() => onUpdate({ role })}
                                        style={{
                                            padding: '10px 12px',
                                            background: block.role === role ? roleData.bgLight : DESIGN.bgCard,
                                            border: `2px solid ${block.role === role ? roleData.borderColor : DESIGN.gray200}`,
                                            borderRadius: DESIGN.radiusInput,
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '10px',
                                            textAlign: 'left'
                                        }}
                                    >
                                        <span style={{
                                            width: '16px',
                                            height: '16px',
                                            borderRadius: '50%',
                                            background: roleData.borderColor
                                        }} />
                                        <div>
                                            <span style={{
                                                fontSize: DESIGN.fontSizeMetadata,
                                                color: block.role === role ? roleData.color : DESIGN.gray600,
                                                fontWeight: block.role === role ? '600' : '400',
                                                display: 'block'
                                            }}>
                                                {roleData.label}
                                            </span>
                                            <span style={{
                                                fontSize: '11px',
                                                color: DESIGN.gray400
                                            }}>
                                                {roleData.fullLabel}
                                            </span>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div>
                            <label style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px',
                                cursor: 'pointer'
                            }}>
                                <input
                                    type="checkbox"
                                    checked={block.required || false}
                                    onChange={(e) => onUpdate({ required: e.target.checked })}
                                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                />
                                <span style={{ fontSize: DESIGN.fontSizeMetadata, color: DESIGN.gray600 }}>
                                    Required field
                                </span>
                            </label>
                        </div>
                    </>
                )}

                {/* Date Field properties */}
                {block.type === 'dateField' && (
                    <>
                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: DESIGN.fontSizeCaption,
                                color: DESIGN.gray500,
                                fontWeight: '600',
                                marginBottom: '6px'
                            }}>
                                Field Label
                            </label>
                            <input
                                type="text"
                                value={block.label || ''}
                                onChange={(e) => onUpdate({ label: e.target.value })}
                                placeholder="e.g., Date Signed"
                                style={{
                                    width: '100%',
                                    padding: '10px 12px',
                                    border: `1px solid ${DESIGN.gray200}`,
                                    borderRadius: DESIGN.radiusInput,
                                    fontSize: DESIGN.fontSizeMetadata
                                }}
                            />
                        </div>

                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: DESIGN.fontSizeCaption,
                                color: DESIGN.gray500,
                                fontWeight: '600',
                                marginBottom: '6px'
                            }}>
                                Signer Role
                            </label>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                {Object.entries(SIGNER_ROLES).map(([role, roleData]) => (
                                    <button
                                        key={role}
                                        onClick={() => onUpdate({ role })}
                                        style={{
                                            padding: '10px 12px',
                                            background: block.role === role ? roleData.bgLight : DESIGN.bgCard,
                                            border: `2px solid ${block.role === role ? roleData.borderColor : DESIGN.gray200}`,
                                            borderRadius: DESIGN.radiusInput,
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '10px',
                                            textAlign: 'left'
                                        }}
                                    >
                                        <span style={{
                                            width: '16px',
                                            height: '16px',
                                            borderRadius: '50%',
                                            background: roleData.borderColor
                                        }} />
                                        <div>
                                            <span style={{
                                                fontSize: DESIGN.fontSizeMetadata,
                                                color: block.role === role ? roleData.color : DESIGN.gray600,
                                                fontWeight: block.role === role ? '600' : '400',
                                                display: 'block'
                                            }}>
                                                {roleData.label}
                                            </span>
                                            <span style={{
                                                fontSize: '11px',
                                                color: DESIGN.gray400
                                            }}>
                                                {roleData.fullLabel}
                                            </span>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px',
                                cursor: 'pointer'
                            }}>
                                <input
                                    type="checkbox"
                                    checked={block.autoFill || false}
                                    onChange={(e) => onUpdate({ autoFill: e.target.checked })}
                                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                />
                                <span style={{ fontSize: DESIGN.fontSizeMetadata, color: DESIGN.gray600 }}>
                                    Auto-fill with current date
                                </span>
                            </label>
                        </div>

                        <div>
                            <label style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px',
                                cursor: 'pointer'
                            }}>
                                <input
                                    type="checkbox"
                                    checked={block.required || false}
                                    onChange={(e) => onUpdate({ required: e.target.checked })}
                                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                />
                                <span style={{ fontSize: DESIGN.fontSizeMetadata, color: DESIGN.gray600 }}>
                                    Required field
                                </span>
                            </label>
                        </div>
                    </>
                )}

                {/* Text Input Field properties */}
                {block.type === 'textInputField' && (
                    <>
                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: DESIGN.fontSizeCaption,
                                color: DESIGN.gray500,
                                fontWeight: '600',
                                marginBottom: '6px'
                            }}>
                                Field Label
                            </label>
                            <input
                                type="text"
                                value={block.label || ''}
                                onChange={(e) => onUpdate({ label: e.target.value })}
                                placeholder="e.g., Full Name"
                                style={{
                                    width: '100%',
                                    padding: '10px 12px',
                                    border: `1px solid ${DESIGN.gray200}`,
                                    borderRadius: DESIGN.radiusInput,
                                    fontSize: DESIGN.fontSizeMetadata
                                }}
                            />
                        </div>

                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: DESIGN.fontSizeCaption,
                                color: DESIGN.gray500,
                                fontWeight: '600',
                                marginBottom: '6px'
                            }}>
                                Placeholder Text
                            </label>
                            <input
                                type="text"
                                value={block.placeholder || ''}
                                onChange={(e) => onUpdate({ placeholder: e.target.value })}
                                placeholder="e.g., Enter your full name"
                                style={{
                                    width: '100%',
                                    padding: '10px 12px',
                                    border: `1px solid ${DESIGN.gray200}`,
                                    borderRadius: DESIGN.radiusInput,
                                    fontSize: DESIGN.fontSizeMetadata
                                }}
                            />
                        </div>

                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: DESIGN.fontSizeCaption,
                                color: DESIGN.gray500,
                                fontWeight: '600',
                                marginBottom: '6px'
                            }}>
                                Max Length
                            </label>
                            <input
                                type="number"
                                value={block.maxLength || 100}
                                onChange={(e) => onUpdate({ maxLength: parseInt(e.target.value) || 100 })}
                                min={1}
                                max={500}
                                style={{
                                    width: '100%',
                                    padding: '10px 12px',
                                    border: `1px solid ${DESIGN.gray200}`,
                                    borderRadius: DESIGN.radiusInput,
                                    fontSize: DESIGN.fontSizeMetadata
                                }}
                            />
                        </div>

                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: DESIGN.fontSizeCaption,
                                color: DESIGN.gray500,
                                fontWeight: '600',
                                marginBottom: '6px'
                            }}>
                                Signer Role
                            </label>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                {Object.entries(SIGNER_ROLES).map(([role, roleData]) => (
                                    <button
                                        key={role}
                                        onClick={() => onUpdate({ role })}
                                        style={{
                                            padding: '10px 12px',
                                            background: block.role === role ? roleData.bgLight : DESIGN.bgCard,
                                            border: `2px solid ${block.role === role ? roleData.borderColor : DESIGN.gray200}`,
                                            borderRadius: DESIGN.radiusInput,
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '10px',
                                            textAlign: 'left'
                                        }}
                                    >
                                        <span style={{
                                            width: '16px',
                                            height: '16px',
                                            borderRadius: '50%',
                                            background: roleData.borderColor
                                        }} />
                                        <div>
                                            <span style={{
                                                fontSize: DESIGN.fontSizeMetadata,
                                                color: block.role === role ? roleData.color : DESIGN.gray600,
                                                fontWeight: block.role === role ? '600' : '400',
                                                display: 'block'
                                            }}>
                                                {roleData.label}
                                            </span>
                                            <span style={{
                                                fontSize: '11px',
                                                color: DESIGN.gray400
                                            }}>
                                                {roleData.fullLabel}
                                            </span>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div>
                            <label style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px',
                                cursor: 'pointer'
                            }}>
                                <input
                                    type="checkbox"
                                    checked={block.required || false}
                                    onChange={(e) => onUpdate({ required: e.target.checked })}
                                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                />
                                <span style={{ fontSize: DESIGN.fontSizeMetadata, color: DESIGN.gray600 }}>
                                    Required field
                                </span>
                            </label>
                        </div>
                    </>
                )}

                {/* Checkbox Field properties */}
                {block.type === 'checkboxField' && (
                    <>
                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: DESIGN.fontSizeCaption,
                                color: DESIGN.gray500,
                                fontWeight: '600',
                                marginBottom: '6px'
                            }}>
                                Checkbox Label
                            </label>
                            <textarea
                                value={block.label || ''}
                                onChange={(e) => onUpdate({ label: e.target.value })}
                                placeholder="e.g., I agree to the terms and conditions"
                                rows={3}
                                style={{
                                    width: '100%',
                                    padding: '10px 12px',
                                    border: `1px solid ${DESIGN.gray200}`,
                                    borderRadius: DESIGN.radiusInput,
                                    fontSize: DESIGN.fontSizeMetadata,
                                    resize: 'vertical',
                                    fontFamily: 'inherit',
                                    lineHeight: '1.5'
                                }}
                            />
                        </div>

                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: DESIGN.fontSizeCaption,
                                color: DESIGN.gray500,
                                fontWeight: '600',
                                marginBottom: '6px'
                            }}>
                                Signer Role
                            </label>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                {Object.entries(SIGNER_ROLES).map(([role, roleData]) => (
                                    <button
                                        key={role}
                                        onClick={() => onUpdate({ role })}
                                        style={{
                                            padding: '10px 12px',
                                            background: block.role === role ? roleData.bgLight : DESIGN.bgCard,
                                            border: `2px solid ${block.role === role ? roleData.borderColor : DESIGN.gray200}`,
                                            borderRadius: DESIGN.radiusInput,
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '10px',
                                            textAlign: 'left'
                                        }}
                                    >
                                        <span style={{
                                            width: '16px',
                                            height: '16px',
                                            borderRadius: '50%',
                                            background: roleData.borderColor
                                        }} />
                                        <div>
                                            <span style={{
                                                fontSize: DESIGN.fontSizeMetadata,
                                                color: block.role === role ? roleData.color : DESIGN.gray600,
                                                fontWeight: block.role === role ? '600' : '400',
                                                display: 'block'
                                            }}>
                                                {roleData.label}
                                            </span>
                                            <span style={{
                                                fontSize: '11px',
                                                color: DESIGN.gray400
                                            }}>
                                                {roleData.fullLabel}
                                            </span>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div>
                            <label style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px',
                                cursor: 'pointer'
                            }}>
                                <input
                                    type="checkbox"
                                    checked={block.required || false}
                                    onChange={(e) => onUpdate({ required: e.target.checked })}
                                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                />
                                <span style={{ fontSize: DESIGN.fontSizeMetadata, color: DESIGN.gray600 }}>
                                    Required field
                                </span>
                            </label>
                        </div>
                    </>
                )}

                {/* Dropdown Field properties */}
                {block.type === 'dropdownField' && (
                    <>
                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: DESIGN.fontSizeCaption,
                                color: DESIGN.gray500,
                                fontWeight: '600',
                                marginBottom: '6px'
                            }}>
                                Field Label
                            </label>
                            <input
                                type="text"
                                value={block.label || ''}
                                onChange={(e) => onUpdate({ label: e.target.value })}
                                placeholder="e.g., Relationship Type"
                                style={{
                                    width: '100%',
                                    padding: '10px 12px',
                                    border: `1px solid ${DESIGN.gray200}`,
                                    borderRadius: DESIGN.radiusInput,
                                    fontSize: DESIGN.fontSizeMetadata
                                }}
                            />
                        </div>

                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: DESIGN.fontSizeCaption,
                                color: DESIGN.gray500,
                                fontWeight: '600',
                                marginBottom: '6px'
                            }}>
                                Dropdown Options
                            </label>
                            {(block.options || []).map((option, index) => (
                                <div key={index} style={{ display: 'flex', gap: '8px', marginBottom: '8px' }}>
                                    <input
                                        type="text"
                                        value={option}
                                        onChange={(e) => {
                                            const newOptions = [...(block.options || [])];
                                            newOptions[index] = e.target.value;
                                            onUpdate({ options: newOptions });
                                        }}
                                        style={{
                                            flex: 1,
                                            padding: '8px 12px',
                                            border: `1px solid ${DESIGN.gray200}`,
                                            borderRadius: DESIGN.radiusInput,
                                            fontSize: DESIGN.fontSizeMetadata
                                        }}
                                    />
                                    <button
                                        onClick={() => {
                                            const newOptions = [...(block.options || [])];
                                            newOptions.splice(index, 1);
                                            onUpdate({ options: newOptions });
                                        }}
                                        style={{
                                            padding: '8px',
                                            background: 'transparent',
                                            border: `1px solid ${DESIGN.gray200}`,
                                            borderRadius: DESIGN.radiusInput,
                                            cursor: 'pointer'
                                        }}
                                    >
                                        <AdminIcons.X size={14} color={DESIGN.gray500} />
                                    </button>
                                </div>
                            ))}
                            <button
                                onClick={() => {
                                    const newOptions = [...(block.options || []), 'New option'];
                                    onUpdate({ options: newOptions });
                                }}
                                style={{
                                    width: '100%',
                                    padding: '8px',
                                    background: DESIGN.gray100,
                                    border: `1px dashed ${DESIGN.gray300}`,
                                    borderRadius: DESIGN.radiusInput,
                                    color: DESIGN.gray500,
                                    fontSize: DESIGN.fontSizeCaption,
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    gap: '6px'
                                }}
                            >
                                <AdminIcons.Plus size={14} />
                                Add Option
                            </button>
                        </div>

                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: DESIGN.fontSizeCaption,
                                color: DESIGN.gray500,
                                fontWeight: '600',
                                marginBottom: '6px'
                            }}>
                                Signer Role
                            </label>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                {Object.entries(SIGNER_ROLES).map(([role, roleData]) => (
                                    <button
                                        key={role}
                                        onClick={() => onUpdate({ role })}
                                        style={{
                                            padding: '10px 12px',
                                            background: block.role === role ? roleData.bgLight : DESIGN.bgCard,
                                            border: `2px solid ${block.role === role ? roleData.borderColor : DESIGN.gray200}`,
                                            borderRadius: DESIGN.radiusInput,
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '10px',
                                            textAlign: 'left'
                                        }}
                                    >
                                        <span style={{
                                            width: '16px',
                                            height: '16px',
                                            borderRadius: '50%',
                                            background: roleData.borderColor
                                        }} />
                                        <div>
                                            <span style={{
                                                fontSize: DESIGN.fontSizeMetadata,
                                                color: block.role === role ? roleData.color : DESIGN.gray600,
                                                fontWeight: block.role === role ? '600' : '400',
                                                display: 'block'
                                            }}>
                                                {roleData.label}
                                            </span>
                                            <span style={{
                                                fontSize: '11px',
                                                color: DESIGN.gray400
                                            }}>
                                                {roleData.fullLabel}
                                            </span>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div>
                            <label style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px',
                                cursor: 'pointer'
                            }}>
                                <input
                                    type="checkbox"
                                    checked={block.required || false}
                                    onChange={(e) => onUpdate({ required: e.target.checked })}
                                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                />
                                <span style={{ fontSize: DESIGN.fontSizeMetadata, color: DESIGN.gray600 }}>
                                    Required field
                                </span>
                            </label>
                        </div>
                    </>
                )}
            </div>
        );
    }

    // ==========================================
    // DOCUMENT PROPERTIES PANEL
    // ==========================================
    function DocumentPropertiesPanel({
        name, description, status, onNameChange, onDescriptionChange, onStatusChange,
        components, availableComponents, onComponentChange, templateType
    }) {
        // Component selector styles
        const selectStyle = {
            width: '100%',
            padding: '10px 12px',
            border: `1px solid ${DESIGN.gray200}`,
            borderRadius: DESIGN.radiusInput,
            fontSize: DESIGN.fontSizeMetadata,
            background: DESIGN.bgCard,
            cursor: 'pointer'
        };

        return (
            <div>
                <div style={{ marginBottom: '20px' }}>
                    <label style={{
                        display: 'block',
                        fontSize: DESIGN.fontSizeCaption,
                        color: DESIGN.gray500,
                        fontWeight: '600',
                        marginBottom: '6px'
                    }}>
                        Template Name
                    </label>
                    <input
                        type="text"
                        value={name}
                        onChange={(e) => onNameChange(e.target.value)}
                        style={{
                            width: '100%',
                            padding: '10px 12px',
                            border: `1px solid ${DESIGN.gray200}`,
                            borderRadius: DESIGN.radiusInput,
                            fontSize: DESIGN.fontSizeMetadata
                        }}
                    />
                </div>

                <div style={{ marginBottom: '20px' }}>
                    <label style={{
                        display: 'block',
                        fontSize: DESIGN.fontSizeCaption,
                        color: DESIGN.gray500,
                        fontWeight: '600',
                        marginBottom: '6px'
                    }}>
                        Description
                    </label>
                    <textarea
                        value={description}
                        onChange={(e) => onDescriptionChange(e.target.value)}
                        placeholder="Optional description..."
                        rows={3}
                        style={{
                            width: '100%',
                            padding: '10px 12px',
                            border: `1px solid ${DESIGN.gray200}`,
                            borderRadius: DESIGN.radiusInput,
                            fontSize: DESIGN.fontSizeMetadata,
                            resize: 'vertical',
                            fontFamily: 'inherit'
                        }}
                    />
                </div>

                <div style={{ marginBottom: '20px' }}>
                    <label style={{
                        display: 'block',
                        fontSize: DESIGN.fontSizeCaption,
                        color: DESIGN.gray500,
                        fontWeight: '600',
                        marginBottom: '6px'
                    }}>
                        Status
                    </label>
                    <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                        {[
                            { key: 'draft', label: 'Draft', color: DESIGN.statusDraft },
                            { key: 'active', label: 'Active', color: DESIGN.statusActive },
                            { key: 'archived', label: 'Archived', color: DESIGN.statusArchived }
                        ].map(s => (
                            <button
                                key={s.key}
                                onClick={() => onStatusChange(s.key)}
                                style={{
                                    padding: '8px 16px',
                                    background: status === s.key ? s.color.bg : DESIGN.bgCard,
                                    border: `1px solid ${status === s.key ? s.color.text : DESIGN.gray200}`,
                                    borderRadius: DESIGN.radiusInput,
                                    color: status === s.key ? s.color.text : DESIGN.gray500,
                                    fontSize: DESIGN.fontSizeCaption,
                                    fontWeight: status === s.key ? '600' : '500',
                                    cursor: 'pointer'
                                }}
                            >
                                {s.label}
                            </button>
                        ))}
                    </div>
                </div>

                {/* Component Selectors - Only show for document templates */}
                {templateType === 'document' && onComponentChange && (
                    <div style={{
                        marginTop: '24px',
                        paddingTop: '20px',
                        borderTop: `1px solid ${DESIGN.gray200}`
                    }}>
                        <h4 style={{
                            fontSize: DESIGN.fontSizeCaption,
                            fontWeight: '600',
                            color: DESIGN.gray500,
                            marginBottom: '16px',
                            textTransform: 'uppercase',
                            letterSpacing: '0.5px'
                        }}>
                            Document Components
                        </h4>

                        {/* Cover Page */}
                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: '13px',
                                color: DESIGN.gray500,
                                marginBottom: '6px'
                            }}>
                                Cover Page
                            </label>
                            <select
                                value={components?.coverPageId || ''}
                                onChange={(e) => onComponentChange('coverPage', e.target.value)}
                                style={selectStyle}
                            >
                                <option value="">No cover page</option>
                                {availableComponents?.covers?.map(cover => (
                                    <option key={cover.id} value={cover.id}>{cover.name}</option>
                                ))}
                            </select>
                        </div>

                        {/* Header */}
                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: '13px',
                                color: DESIGN.gray500,
                                marginBottom: '6px'
                            }}>
                                Header
                            </label>
                            <select
                                value={components?.headerId || ''}
                                onChange={(e) => onComponentChange('header', e.target.value)}
                                style={selectStyle}
                            >
                                <option value="">No header</option>
                                {availableComponents?.headers?.map(header => (
                                    <option key={header.id} value={header.id}>{header.name}</option>
                                ))}
                            </select>
                        </div>

                        {/* Footer */}
                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: '13px',
                                color: DESIGN.gray500,
                                marginBottom: '6px'
                            }}>
                                Footer
                            </label>
                            <select
                                value={components?.footerId || ''}
                                onChange={(e) => onComponentChange('footer', e.target.value)}
                                style={selectStyle}
                            >
                                <option value="">No footer</option>
                                {availableComponents?.footers?.map(footer => (
                                    <option key={footer.id} value={footer.id}>{footer.name}</option>
                                ))}
                            </select>
                        </div>

                        {/* End Page */}
                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: '13px',
                                color: DESIGN.gray500,
                                marginBottom: '6px'
                            }}>
                                End Page
                            </label>
                            <select
                                value={components?.endPageId || ''}
                                onChange={(e) => onComponentChange('endPage', e.target.value)}
                                style={selectStyle}
                            >
                                <option value="">No end page</option>
                                {availableComponents?.endPages?.map(endPage => (
                                    <option key={endPage.id} value={endPage.id}>{endPage.name}</option>
                                ))}
                            </select>
                        </div>

                        <p style={{
                            fontSize: '11px',
                            color: DESIGN.gray400,
                            marginTop: '12px',
                            fontStyle: 'italic'
                        }}>
                            Components must be set to "Active" status to appear here
                        </p>
                    </div>
                )}
            </div>
        );
    }

    // ==========================================
    // SECURE TOKEN GENERATION
    // ==========================================
    function generateSecureToken() {
        const array = new Uint8Array(24);
        crypto.getRandomValues(array);
        return Array.from(array, b => b.toString(16).padStart(2, '0')).join('');
    }

    // Calculate expiration date
    function calculateExpiration(days) {
        const date = new Date();
        date.setDate(date.getDate() + days);
        return firebase.firestore.Timestamp.fromDate(date);
    }

    // Get unique roles used in template blocks
    function getRolesFromTemplate(template) {
        const roles = new Set();
        const blocks = template?.content?.blocks || [];
        blocks.forEach(block => {
            if (block.role) {
                roles.add(block.role);
            }
        });
        // Always include PIR as minimum
        if (roles.size === 0) {
            roles.add('pir');
        }
        return Array.from(roles);
    }

    // Email validation
    function isValidEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    // ==========================================
    // EMAIL NOTIFICATION SYSTEM
    // ==========================================

    // Generate HTML email template for signing notifications
    function generateSigningEmailHTML(templateType, data) {
        const { recipientName, documentTitle, signingLink, senderName, expirationDate, completedDate, signersList } = data;

        // Common email styles
        const styles = {
            wrapper: 'font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 600px; margin: 0 auto; background: #ffffff;',
            header: 'background: linear-gradient(135deg, #0077CC 0%, #008B8B 100%); padding: 32px 24px; text-align: center;',
            logo: 'font-size: 24px; font-weight: 700; color: white; margin: 0;',
            tagline: 'color: rgba(255,255,255,0.9); font-size: 14px; margin: 8px 0 0 0;',
            content: 'padding: 32px 24px;',
            greeting: 'font-size: 18px; color: #1F2937; margin: 0 0 16px 0;',
            text: 'font-size: 15px; color: #4B5563; line-height: 1.6; margin: 0 0 16px 0;',
            docBox: 'background: #F3F4F6; border-radius: 8px; padding: 16px; margin: 24px 0;',
            docTitle: 'font-size: 16px; font-weight: 600; color: #1F2937; margin: 0 0 4px 0;',
            docMeta: 'font-size: 13px; color: #6B7280; margin: 0;',
            button: 'display: inline-block; background: linear-gradient(135deg, #0077CC 0%, #008B8B 100%); color: white; text-decoration: none; padding: 14px 32px; border-radius: 8px; font-weight: 600; font-size: 15px;',
            buttonWrap: 'text-align: center; margin: 24px 0;',
            footer: 'background: #F9FAFB; padding: 24px; border-top: 1px solid #E5E7EB;',
            footerText: 'font-size: 12px; color: #9CA3AF; text-align: center; margin: 0;',
            warning: 'background: #FEF3C7; border-left: 4px solid #F59E0B; padding: 12px 16px; margin: 16px 0; border-radius: 0 8px 8px 0;',
            warningText: 'font-size: 13px; color: #92400E; margin: 0;',
            success: 'background: #D1FAE5; border-left: 4px solid #10B981; padding: 16px; margin: 16px 0; border-radius: 0 8px 8px 0;',
            successText: 'font-size: 14px; color: #065F46; margin: 0;'
        };

        // Template content based on type
        const templates = {
            'signing-invitation': {
                subject: `Action Required: Please sign "${documentTitle}"`,
                html: `
                    <div style="${styles.wrapper}">
                        <div style="${styles.header}">
                            <h1 style="${styles.logo}">GLRS Lighthouse</h1>
                            <p style="${styles.tagline}">Guiding Light Recovery Services</p>
                        </div>
                        <div style="${styles.content}">
                            <h2 style="${styles.greeting}">Hello ${recipientName},</h2>
                            <p style="${styles.text}">
                                ${senderName} has sent you a document to review and sign. Please review the document carefully before signing.
                            </p>
                            <div style="${styles.docBox}">
                                <p style="${styles.docTitle}">${documentTitle}</p>
                                <p style="${styles.docMeta}">Expires: ${expirationDate}</p>
                            </div>
                            <div style="${styles.buttonWrap}">
                                <a href="${signingLink}" style="${styles.button}">Review & Sign Document</a>
                            </div>
                            <div style="${styles.warning}">
                                <p style="${styles.warningText}">
                                    <strong>Important:</strong> This link is unique to you and should not be shared.
                                    Please complete your signature before ${expirationDate}.
                                </p>
                            </div>
                            <p style="${styles.text}">
                                If you have any questions about this document, please contact GLRS directly.
                            </p>
                        </div>
                        <div style="${styles.footer}">
                            <p style="${styles.footerText}">
                                This email was sent by Guiding Light Recovery Services.<br>
                                If you did not expect this document, please contact us immediately.
                            </p>
                        </div>
                    </div>
                `
            },
            'signing-reminder-gentle': {
                subject: `Reminder: Document awaiting your signature - "${documentTitle}"`,
                html: `
                    <div style="${styles.wrapper}">
                        <div style="${styles.header}">
                            <h1 style="${styles.logo}">GLRS Lighthouse</h1>
                            <p style="${styles.tagline}">Guiding Light Recovery Services</p>
                        </div>
                        <div style="${styles.content}">
                            <h2 style="${styles.greeting}">Hello ${recipientName},</h2>
                            <p style="${styles.text}">
                                This is a friendly reminder that you have a document waiting for your signature.
                                We noticed you haven't had a chance to sign it yet.
                            </p>
                            <div style="${styles.docBox}">
                                <p style="${styles.docTitle}">${documentTitle}</p>
                                <p style="${styles.docMeta}">Expires: ${expirationDate}</p>
                            </div>
                            <div style="${styles.buttonWrap}">
                                <a href="${signingLink}" style="${styles.button}">Review & Sign Document</a>
                            </div>
                            <p style="${styles.text}">
                                If you have any questions or need assistance, please don't hesitate to reach out.
                            </p>
                        </div>
                        <div style="${styles.footer}">
                            <p style="${styles.footerText}">
                                Guiding Light Recovery Services<br>
                                Supporting your recovery journey
                            </p>
                        </div>
                    </div>
                `
            },
            'signing-reminder-urgent': {
                subject: `Urgent: Document expires soon - "${documentTitle}"`,
                html: `
                    <div style="${styles.wrapper}">
                        <div style="${styles.header}">
                            <h1 style="${styles.logo}">GLRS Lighthouse</h1>
                            <p style="${styles.tagline}">Guiding Light Recovery Services</p>
                        </div>
                        <div style="${styles.content}">
                            <h2 style="${styles.greeting}">Hello ${recipientName},</h2>
                            <p style="${styles.text}">
                                <strong>Your document requires immediate attention.</strong> The signing deadline is approaching soon,
                                and we want to ensure you have time to review and complete it.
                            </p>
                            <div style="${styles.docBox}">
                                <p style="${styles.docTitle}">${documentTitle}</p>
                                <p style="${styles.docMeta}; color: #DC2626; font-weight: 600;">Expires: ${expirationDate}</p>
                            </div>
                            <div style="${styles.buttonWrap}">
                                <a href="${signingLink}" style="${styles.button}; background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);">Sign Now - Urgent</a>
                            </div>
                            <div style="${styles.warning}">
                                <p style="${styles.warningText}">
                                    <strong>Action Required:</strong> If the document expires, a new signing request will need to be sent.
                                </p>
                            </div>
                        </div>
                        <div style="${styles.footer}">
                            <p style="${styles.footerText}">
                                Guiding Light Recovery Services<br>
                                Supporting your recovery journey
                            </p>
                        </div>
                    </div>
                `
            },
            'signing-next-turn': {
                subject: `It's your turn to sign: "${documentTitle}"`,
                html: `
                    <div style="${styles.wrapper}">
                        <div style="${styles.header}">
                            <h1 style="${styles.logo}">GLRS Lighthouse</h1>
                            <p style="${styles.tagline}">Guiding Light Recovery Services</p>
                        </div>
                        <div style="${styles.content}">
                            <h2 style="${styles.greeting}">Hello ${recipientName},</h2>
                            <p style="${styles.text}">
                                Good news! The previous signer has completed their portion, and it's now your turn to review and sign the document.
                            </p>
                            <div style="${styles.docBox}">
                                <p style="${styles.docTitle}">${documentTitle}</p>
                                <p style="${styles.docMeta}">Expires: ${expirationDate}</p>
                            </div>
                            <div style="${styles.buttonWrap}">
                                <a href="${signingLink}" style="${styles.button}">Review & Sign Document</a>
                            </div>
                            <p style="${styles.text}">
                                Please complete your signature at your earliest convenience to keep the process moving forward.
                            </p>
                        </div>
                        <div style="${styles.footer}">
                            <p style="${styles.footerText}">
                                Guiding Light Recovery Services<br>
                                Supporting your recovery journey
                            </p>
                        </div>
                    </div>
                `
            },
            'signing-complete': {
                subject: `Completed: All signatures collected for "${documentTitle}"`,
                html: `
                    <div style="${styles.wrapper}">
                        <div style="${styles.header}">
                            <h1 style="${styles.logo}">GLRS Lighthouse</h1>
                            <p style="${styles.tagline}">Guiding Light Recovery Services</p>
                        </div>
                        <div style="${styles.content}">
                            <h2 style="${styles.greeting}">Hello ${recipientName},</h2>
                            <div style="${styles.success}">
                                <p style="${styles.successText}">
                                    All parties have successfully signed the document. The agreement is now complete.
                                </p>
                            </div>
                            <div style="${styles.docBox}">
                                <p style="${styles.docTitle}">${documentTitle}</p>
                                <p style="${styles.docMeta}">Completed: ${completedDate}</p>
                            </div>
                            <p style="${styles.text}">
                                <strong>Signed by:</strong><br>
                                ${signersList || 'All required parties'}
                            </p>
                            <p style="${styles.text}">
                                A copy of the completed document has been saved to your GLRS account.
                                You can access it anytime through the GLRS portal.
                            </p>
                        </div>
                        <div style="${styles.footer}">
                            <p style="${styles.footerText}">
                                Guiding Light Recovery Services<br>
                                Thank you for using GLRS Lighthouse
                            </p>
                        </div>
                    </div>
                `
            }
        };

        return templates[templateType] || templates['signing-invitation'];
    }

    // Send signing email via Firebase mail collection (triggers Firebase Email Extension)
    async function sendSigningEmail(templateType, recipientEmail, recipientName, data, agreementId = null) {
        try {
            const emailContent = generateSigningEmailHTML(templateType, {
                recipientName,
                ...data
            });

            // Add to Firebase mail collection (picked up by Trigger Email extension)
            const mailDoc = {
                to: recipientEmail,
                message: {
                    subject: emailContent.subject,
                    html: emailContent.html
                },
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            await db.collection('mail').add(mailDoc);
            console.log(`Email sent: ${templateType} to ${recipientEmail}`);

            // Log to audit trail if agreementId provided
            if (agreementId) {
                await db.collection('agreements').doc(agreementId).update({
                    auditTrail: firebase.firestore.FieldValue.arrayUnion({
                        timestamp: new Date().toISOString(),
                        action: 'email_sent',
                        emailType: templateType,
                        recipient: recipientEmail,
                        actor: 'system'
                    })
                });
            }

            return true;
        } catch (error) {
            console.error('Error sending email:', error);
            return false;
        }
    }

    // Send reminder email to a signer
    async function sendSigningReminder(agreement, signer, reminderType = 'gentle') {
        const templateType = reminderType === 'urgent' ? 'signing-reminder-urgent' : 'signing-reminder-gentle';
        const signingLink = `https://app.glrecoveryservices.com/sign.html#${signer.token}`;
        const expirationDate = agreement.expiresAt?.toDate ?
            agreement.expiresAt.toDate().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) :
            'Soon';

        return await sendSigningEmail(
            templateType,
            signer.email,
            signer.name,
            {
                documentTitle: agreement.documentTitle,
                signingLink,
                expirationDate
            },
            agreement.id
        );
    }

    // ==========================================
    // PDF GENERATION SYSTEM
    // ==========================================

    // Generate SHA-256 document hash for tamper detection
    async function generateDocumentHash(agreement) {
        const content = JSON.stringify({
            agreementId: agreement.id,
            templateId: agreement.templateId,
            fieldValues: agreement.fieldValues,
            signers: agreement.signers.map(s => ({
                name: s.name,
                email: s.email,
                role: s.role,
                signedAt: s.signedAt
            }))
        });

        const encoder = new TextEncoder();
        const data = encoder.encode(content);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Format date/time for PDF display
    function formatDateTimeForPDF(timestamp) {
        if (!timestamp) return 'N/A';
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleString('en-US', {
            month: 'long',
            day: 'numeric',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            timeZoneName: 'short'
        });
    }

    // Get IP address from audit trail for a signer
    function getSignerIPFromAuditTrail(agreement, signer) {
        const signingEvent = agreement.auditTrail?.find(e =>
            e.action === 'signed' && e.actor === signer.name
        );
        return signingEvent?.ipAddress || 'N/A';
    }

    // Generate Certificate of Completion HTML
    async function generateCertificateHTML(agreement) {
        const documentHash = await generateDocumentHash(agreement);

        return `
            <div style="padding: 60px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: white; min-height: 100%;">
                <div style="text-align: center; margin-bottom: 40px;">
                    <div style="font-size: 32px; font-weight: 700; color: #0077CC; margin-bottom: 8px;">
                        GLRS Lighthouse
                    </div>
                    <div style="font-size: 14px; color: #6B7280;">
                        Guiding Light Recovery Services
                    </div>
                </div>

                <h1 style="text-align: center; color: #1F2937; font-size: 28px; margin-bottom: 40px; border-bottom: 3px solid #0077CC; padding-bottom: 20px;">
                    Certificate of Completion
                </h1>

                <div style="margin-bottom: 30px; background: #F9FAFB; padding: 20px; border-radius: 8px;">
                    <p style="margin: 0 0 12px; font-size: 15px;"><strong>Document ID:</strong> ${agreement.id}</p>
                    <p style="margin: 0 0 12px; font-size: 15px;"><strong>Document Title:</strong> ${agreement.documentTitle}</p>
                    <p style="margin: 0; font-size: 15px;"><strong>Completed:</strong> ${formatDateTimeForPDF(agreement.completedAt)}</p>
                </div>

                <h2 style="margin-top: 40px; margin-bottom: 20px; font-size: 20px; color: #1F2937;">Signers</h2>
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                    <thead>
                        <tr style="background: #F3F4F6;">
                            <th style="padding: 14px; text-align: left; border-bottom: 2px solid #D1D5DB; font-size: 13px; font-weight: 600; color: #374151;">Name</th>
                            <th style="padding: 14px; text-align: left; border-bottom: 2px solid #D1D5DB; font-size: 13px; font-weight: 600; color: #374151;">Role</th>
                            <th style="padding: 14px; text-align: left; border-bottom: 2px solid #D1D5DB; font-size: 13px; font-weight: 600; color: #374151;">Signed At</th>
                            <th style="padding: 14px; text-align: left; border-bottom: 2px solid #D1D5DB; font-size: 13px; font-weight: 600; color: #374151;">IP Address</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${agreement.signers.map(s => `
                            <tr>
                                <td style="padding: 14px; border-bottom: 1px solid #E5E7EB; font-size: 14px;">${s.name}</td>
                                <td style="padding: 14px; border-bottom: 1px solid #E5E7EB; font-size: 14px; text-transform: uppercase;">${SIGNER_ROLES[s.role]?.label || s.role}</td>
                                <td style="padding: 14px; border-bottom: 1px solid #E5E7EB; font-size: 14px;">${formatDateTimeForPDF(s.signedAt)}</td>
                                <td style="padding: 14px; border-bottom: 1px solid #E5E7EB; font-size: 14px;">${getSignerIPFromAuditTrail(agreement, s)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>

                <div style="margin-top: 40px; padding: 20px; background: #F8FAFC; border-radius: 8px; border: 1px solid #E5E7EB;">
                    <p style="margin: 0 0 12px; font-size: 13px; font-weight: 600; color: #374151;">Document Hash (SHA-256):</p>
                    <p style="font-family: 'Courier New', monospace; font-size: 11px; word-break: break-all; margin: 0; color: #6B7280; line-height: 1.6;">
                        ${documentHash}
                    </p>
                </div>

                <p style="margin-top: 30px; font-size: 12px; color: #6B7280; line-height: 1.6;">
                    This certificate confirms that the above document was electronically signed by all parties listed.
                    The document hash can be used to verify that the document has not been tampered with since completion.
                </p>

                <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #E5E7EB; text-align: center;">
                    <p style="font-size: 11px; color: #9CA3AF; margin: 0;">
                        Generated by GLRS Lighthouse E-Signature System<br>
                        ${new Date().toLocaleString()}
                    </p>
                </div>
            </div>
        `;
    }

    // Render document content to HTML for PDF generation
    function renderDocumentToHTML(agreement) {
        const blocks = agreement.content?.blocks || [];
        const fieldValues = agreement.fieldValues || {};
        const signers = agreement.signers || [];

        // Build HTML for each block
        let html = `<div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 40px; background: white;">`;

        // Add document title at top
        html += `<h1 style="text-align: center; color: #1F2937; font-size: 24px; margin-bottom: 30px;">${agreement.documentTitle}</h1>`;

        blocks.forEach(block => {
            switch (block.type) {
                case 'heading':
                    const headingSize = block.level === 1 ? '24px' : block.level === 2 ? '20px' : '18px';
                    html += `<h${block.level || 2} style="font-size: ${headingSize}; color: #1F2937; margin: 24px 0 12px;">${block.content || ''}</h${block.level || 2}>`;
                    break;

                case 'paragraph':
                    html += `<p style="font-size: 14px; line-height: 1.7; color: #374151; margin: 0 0 16px;">${block.content || ''}</p>`;
                    break;

                case 'section':
                    html += `<div style="margin: 24px 0 16px; padding-bottom: 8px; border-bottom: 2px solid #E5E7EB;">
                        <span style="font-size: 16px; font-weight: 600; color: #1F2937;">${block.number ? block.number + '. ' : ''}${block.title || ''}</span>
                    </div>`;
                    break;

                case 'textField':
                case 'dateField':
                    const fieldValue = fieldValues[block.id] || '_________________';
                    html += `<p style="font-size: 14px; margin: 12px 0;">
                        <strong>${block.label || 'Field'}:</strong> <span style="border-bottom: 1px solid #000; padding: 0 20px;">${fieldValue}</span>
                    </p>`;
                    break;

                case 'signatureField':
                case 'signatureBlock':
                    const sigValue = fieldValues[block.id];
                    const roleName = SIGNER_ROLES[block.role]?.label || block.role?.toUpperCase() || 'SIGNER';
                    const signerInfo = signers.find(s => s.role === block.role);

                    html += `<div style="margin: 30px 0; padding: 20px; background: #F9FAFB; border-radius: 8px; border: 1px solid #E5E7EB;">`;

                    if (sigValue) {
                        // Render actual signature
                        if (sigValue.startsWith('data:image')) {
                            html += `<img src="${sigValue}" style="max-width: 300px; max-height: 100px; display: block; margin-bottom: 10px;" />`;
                        } else {
                            // Typed signature
                            html += `<div style="font-family: 'Dancing Script', cursive, Georgia, serif; font-size: 32px; color: #1F2937; margin-bottom: 10px;">${sigValue}</div>`;
                        }
                    } else {
                        html += `<div style="border-bottom: 2px solid #000; width: 300px; height: 50px; margin-bottom: 10px;"></div>`;
                    }

                    html += `<div style="font-size: 12px; color: #6B7280;">
                        <strong>${roleName} Signature</strong>
                        ${signerInfo ? ` - ${signerInfo.name}` : ''}
                        ${signerInfo?.signedAt ? ` (Signed: ${formatDateTimeForPDF(signerInfo.signedAt)})` : ''}
                    </div>`;
                    html += `</div>`;
                    break;

                case 'initialsField':
                    const initValue = fieldValues[block.id];
                    html += `<span style="display: inline-block; margin: 8px 16px 8px 0;">
                        <span style="border: 1px solid #000; padding: 4px 12px; min-width: 50px; display: inline-block; text-align: center;">
                            ${initValue || '____'}
                        </span>
                        <span style="font-size: 12px; color: #6B7280; margin-left: 8px;">${block.label || 'Initials'}</span>
                    </span>`;
                    break;

                case 'acknowledgment':
                    const ackValue = fieldValues[block.id];
                    html += `<div style="margin: 12px 0; display: flex; align-items: flex-start; gap: 10px;">
                        <span style="width: 18px; height: 18px; border: 2px solid #000; display: inline-flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            ${ackValue ? '' : ''}
                        </span>
                        <span style="font-size: 14px; line-height: 1.5;">${block.text || ''}</span>
                    </div>`;
                    break;

                case 'divider':
                    html += `<hr style="border: none; border-top: 1px solid #E5E7EB; margin: 24px 0;" />`;
                    break;

                case 'spacer':
                    html += `<div style="height: ${block.height || 20}px;"></div>`;
                    break;

                default:
                    if (block.content) {
                        html += `<p style="font-size: 14px; margin: 12px 0;">${block.content}</p>`;
                    }
            }
        });

        html += `</div>`;
        return html;
    }

    // Generate complete PDF with document and certificate
    async function generateAgreementPDF(agreement, options = {}) {
        const { jsPDF } = window.jspdf;

        // Create PDF in letter size
        const pdf = new jsPDF('p', 'mm', 'letter');
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();

        // Create hidden container for rendering
        const container = document.createElement('div');
        container.style.width = '816px'; // 8.5" at 96 DPI
        container.style.position = 'absolute';
        container.style.left = '-9999px';
        container.style.background = 'white';
        document.body.appendChild(container);

        try {
            // Render main document
            container.innerHTML = renderDocumentToHTML(agreement);

            // Capture document as canvas
            const docCanvas = await html2canvas(container, {
                scale: 2,
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff'
            });

            // Calculate dimensions
            const imgWidth = pageWidth;
            const imgHeight = (docCanvas.height * imgWidth) / docCanvas.width;

            // Add document pages
            const docImgData = docCanvas.toDataURL('image/png');
            let position = 0;
            let pageNum = 1;

            while (position < docCanvas.height) {
                if (pageNum > 1) {
                    pdf.addPage();
                }

                // Calculate the portion of the image to show on this page
                const srcY = position;
                const srcHeight = Math.min(
                    docCanvas.height - position,
                    pageHeight * (docCanvas.width / imgWidth)
                );

                pdf.addImage(
                    docImgData,
                    'PNG',
                    0,
                    -(position * imgWidth / docCanvas.width),
                    imgWidth,
                    imgHeight
                );

                position += pageHeight * (docCanvas.width / imgWidth);
                pageNum++;
            }

            // Add Certificate of Completion as final page
            if (agreement.status === 'completed') {
                pdf.addPage();
                container.innerHTML = await generateCertificateHTML(agreement);

                const certCanvas = await html2canvas(container, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff'
                });

                const certImgData = certCanvas.toDataURL('image/png');
                const certImgHeight = (certCanvas.height * imgWidth) / certCanvas.width;

                pdf.addImage(certImgData, 'PNG', 0, 0, imgWidth, Math.min(certImgHeight, pageHeight));
            }

            return pdf;

        } finally {
            // Clean up
            document.body.removeChild(container);
        }
    }

    // Save PDF to Firebase Storage
    async function savePDFToStorage(pdf, agreement) {
        const storage = firebase.storage();
        const pdfBlob = pdf.output('blob');
        const storageRef = storage.ref();
        const pdfRef = storageRef.child(`agreements/${agreement.id}/signed-agreement.pdf`);

        await pdfRef.put(pdfBlob, { contentType: 'application/pdf' });
        const downloadUrl = await pdfRef.getDownloadURL();

        // Update agreement with PDF URL and log to audit trail
        await db.collection('agreements').doc(agreement.id).update({
            pdfUrl: downloadUrl,
            auditTrail: firebase.firestore.FieldValue.arrayUnion({
                timestamp: new Date().toISOString(),
                action: 'pdf_generated',
                actor: 'system',
                pdfUrl: downloadUrl
            })
        });

        return downloadUrl;
    }

    // Generate and download PDF
    async function generateAndDownloadPDF(agreement, saveToStorage = false) {
        try {
            const pdf = await generateAgreementPDF(agreement);

            if (saveToStorage && agreement.status === 'completed') {
                // Save to Firebase Storage
                await savePDFToStorage(pdf, agreement);
            }

            // Download the PDF
            pdf.save(`${agreement.documentTitle || 'agreement'}-signed.pdf`);

            return true;
        } catch (error) {
            console.error('Error generating PDF:', error);
            throw error;
        }
    }

    // Download PDF - check if already generated or generate on demand
    async function downloadAgreementPDF(agreement) {
        if (agreement.pdfUrl) {
            // Already generated, just open
            window.open(agreement.pdfUrl, '_blank');
            return true;
        } else if (agreement.status === 'completed') {
            // Generate on demand
            return await generateAndDownloadPDF(agreement, true);
        } else {
            alert('PDF is only available for completed agreements.');
            return false;
        }
    }

    // ==========================================
    // SEND FOR SIGNATURE MODAL
    // ==========================================
    function SendForSignatureModal({ template, user, onClose, onSuccess, isMobile }) {
        // Step state
        const [step, setStep] = useState(template ? 2 : 1); // Skip template selection if template is provided

        // Step 1: Template selection
        const [documentTemplates, setDocumentTemplates] = useState([]);
        const [selectedTemplate, setSelectedTemplate] = useState(template || null);
        const [loadingTemplates, setLoadingTemplates] = useState(!template);

        // Step 2: Signer info
        const [signers, setSigners] = useState({});
        const rolesNeeded = selectedTemplate ? getRolesFromTemplate(selectedTemplate) : [];

        // Step 3: Review & Send
        const [documentTitle, setDocumentTitle] = useState(template?.name || '');
        const [expirationDays, setExpirationDays] = useState(14);

        // General state
        const [sending, setSending] = useState(false);
        const [errors, setErrors] = useState({});

        // Load document templates for Step 1
        useEffect(() => {
            if (template) {
                // Template already provided, update document title
                setDocumentTitle(template.name);
                return;
            }

            const loadTemplates = async () => {
                setLoadingTemplates(true);
                try {
                    const snapshot = await db.collection('templates')
                        .where('tenantId', '==', CURRENT_TENANT)
                        .where('type', '==', 'document')
                        .where('status', '==', 'active')
                        .get();

                    const templates = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setDocumentTemplates(templates);
                } catch (error) {
                    console.error('Error loading templates:', error);
                }
                setLoadingTemplates(false);
            };
            loadTemplates();
        }, [template]);

        // Initialize signers when template is selected
        useEffect(() => {
            if (selectedTemplate) {
                const roles = getRolesFromTemplate(selectedTemplate);
                const initialSigners = {};
                roles.forEach((role, index) => {
                    initialSigners[role] = {
                        name: role === 'glrs' ? `${user.firstName || ''} ${user.lastName || ''}`.trim() : '',
                        email: role === 'glrs' ? null : '', // GLRS signs in portal, no email needed
                        order: role === 'pir' ? 0 : role === 'family' ? 1 : 2
                    };
                });
                setSigners(initialSigners);
                setDocumentTitle(selectedTemplate.name);
            }
        }, [selectedTemplate, user]);

        // Handle escape key
        useEffect(() => {
            const handleEscape = (e) => {
                if (e.key === 'Escape' && !sending) onClose();
            };
            window.addEventListener('keydown', handleEscape);
            return () => window.removeEventListener('keydown', handleEscape);
        }, [sending]);

        // Update signer field
        const updateSigner = (role, field, value) => {
            setSigners(prev => ({
                ...prev,
                [role]: { ...prev[role], [field]: value }
            }));
            // Clear error for this field
            setErrors(prev => {
                const newErrors = { ...prev };
                delete newErrors[`${role}_${field}`];
                return newErrors;
            });
        };

        // Validate step 2 (signers)
        const validateSigners = () => {
            const newErrors = {};
            rolesNeeded.forEach(role => {
                const signer = signers[role];
                if (!signer?.name?.trim()) {
                    newErrors[`${role}_name`] = `${SIGNER_ROLES[role]?.label || role} name is required`;
                }
                if (role !== 'glrs' && !signer?.email?.trim()) {
                    newErrors[`${role}_email`] = `${SIGNER_ROLES[role]?.label || role} email is required`;
                } else if (role !== 'glrs' && signer?.email && !isValidEmail(signer.email)) {
                    newErrors[`${role}_email`] = 'Invalid email format';
                }
            });
            setErrors(newErrors);
            return Object.keys(newErrors).length === 0;
        };

        // Validate step 3 (review)
        const validateReview = () => {
            const newErrors = {};
            if (!documentTitle.trim()) {
                newErrors.documentTitle = 'Document title is required';
            }
            // Check template has signature fields
            const blocks = selectedTemplate?.content?.blocks || [];
            const hasSignatureFields = blocks.some(b =>
                ['signatureField', 'signatureBlock', 'initialsField'].includes(b.type)
            );
            if (!hasSignatureFields) {
                newErrors.template = 'Template must have at least one signature field';
            }
            setErrors(newErrors);
            return Object.keys(newErrors).length === 0;
        };

        // Handle next step
        const handleNext = () => {
            if (step === 1) {
                if (!selectedTemplate) {
                    setErrors({ template: 'Please select a template' });
                    return;
                }
                setStep(2);
            } else if (step === 2) {
                if (validateSigners()) {
                    setStep(3);
                }
            }
        };

        // Handle send
        const handleSend = async () => {
            if (!validateReview()) return;

            setSending(true);
            try {
                // Generate tokens and build signers array
                const signerTokens = [];
                const signersArray = [];

                // Sort signers by order
                const sortedRoles = rolesNeeded.sort((a, b) =>
                    (signers[a]?.order || 0) - (signers[b]?.order || 0)
                );

                sortedRoles.forEach((role, index) => {
                    const signer = signers[role];
                    const token = generateSecureToken();
                    signerTokens.push(token);

                    signersArray.push({
                        role,
                        name: signer.name.trim(),
                        email: role === 'glrs' ? null : signer.email?.trim() || null,
                        token,
                        status: 'pending',
                        signedAt: null,
                        signedFields: [],
                        order: index
                    });
                });

                // Build agreement document
                const agreement = {
                    templateId: selectedTemplate.id,
                    documentTitle: documentTitle.trim(),
                    status: 'sent',

                    // Copy template content at time of sending (snapshot)
                    content: selectedTemplate.content || { blocks: [] },
                    components: selectedTemplate.components || {
                        coverPageId: selectedTemplate.content?.coverPageId || null,
                        headerId: selectedTemplate.content?.headerId || null,
                        footerId: selectedTemplate.content?.footerId || null,
                        endPageId: selectedTemplate.content?.endPageId || null
                    },

                    // Signers
                    signerTokens, // For querying
                    signers: signersArray,

                    // Field values (empty initially)
                    fieldValues: {},

                    // Audit trail
                    auditTrail: [{
                        timestamp: new Date().toISOString(),
                        action: 'sent',
                        actor: user.email || `${user.firstName} ${user.lastName}`,
                        actorRole: 'glrs',
                        recipients: signersArray.filter(s => s.email).map(s => s.email)
                    }],

                    // Metadata
                    expiresAt: calculateExpiration(expirationDays),
                    tenantId: CURRENT_TENANT,
                    createdBy: user.uid || user.odoo_uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    sentAt: firebase.firestore.FieldValue.serverTimestamp(),
                    completedAt: null
                };

                const docRef = await db.collection('agreements').add(agreement);

                // Send email to the first signer (if they have an email - not GLRS)
                const firstSigner = signersArray.find(s => s.order === 0);
                if (firstSigner && firstSigner.email) {
                    const expirationDate = new Date();
                    expirationDate.setDate(expirationDate.getDate() + expirationDays);
                    const expirationStr = expirationDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });

                    await sendSigningEmail(
                        'signing-invitation',
                        firstSigner.email,
                        firstSigner.name,
                        {
                            documentTitle: documentTitle.trim(),
                            signingLink: `https://app.glrecoveryservices.com/sign.html#${firstSigner.token}`,
                            senderName: `${user.firstName || ''} ${user.lastName || ''}`.trim() || 'GLRS',
                            expirationDate: expirationStr
                        },
                        docRef.id
                    );
                }

                // Success - return the agreement with signers and their tokens
                onSuccess({
                    id: docRef.id,
                    ...agreement,
                    signingLinks: signersArray.map(s => ({
                        role: s.role,
                        name: s.name,
                        email: s.email,
                        link: `https://app.glrecoveryservices.com/sign.html#${s.token}`
                    }))
                });

            } catch (error) {
                console.error('Error creating agreement:', error);
                alert('Failed to send document: ' + error.message);
            } finally {
                setSending(false);
            }
        };

        // Format date
        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        };

        return (
            <div
                style={{
                    position: 'fixed',
                    top: 0, left: 0, right: 0, bottom: 0,
                    background: 'rgba(0, 0, 0, 0.5)',
                    backdropFilter: 'blur(5px)',
                    display: 'flex',
                    alignItems: isMobile ? 'flex-end' : 'center',
                    justifyContent: 'center',
                    zIndex: 1000,
                    padding: isMobile ? 0 : '20px',
                    animation: 'fadeIn 0.3s ease-out'
                }}
                onClick={() => !sending && onClose()}
            >
                <div
                    style={{
                        background: DESIGN.bgCard,
                        borderRadius: isMobile ? '20px 20px 0 0' : DESIGN.radiusModal,
                        maxWidth: '600px',
                        width: '100%',
                        maxHeight: isMobile ? '95vh' : '90vh',
                        display: 'flex',
                        flexDirection: 'column',
                        overflow: 'hidden',
                        boxShadow: DESIGN.shadowElevated,
                        animation: isMobile ? 'slideUp 0.3s ease-out' : 'scaleIn 0.3s ease-out'
                    }}
                    onClick={(e) => e.stopPropagation()}
                >
                    {/* Header */}
                    <div style={{
                        background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                        padding: isMobile ? '20px' : '24px 28px',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center'
                    }}>
                        <div>
                            <h3 style={{
                                margin: '0 0 4px 0',
                                color: 'white',
                                fontSize: isMobile ? '20px' : '22px',
                                fontWeight: '600'
                            }}>
                                Send for Signature
                            </h3>
                            <p style={{
                                margin: 0,
                                color: 'rgba(255,255,255,0.85)',
                                fontSize: DESIGN.fontSizeMetadata
                            }}>
                                Step {step} of 3: {step === 1 ? 'Select Template' : step === 2 ? 'Add Signers' : 'Review & Send'}
                            </p>
                        </div>
                        <button
                            onClick={onClose}
                            disabled={sending}
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                border: 'none',
                                color: 'white',
                                width: '36px',
                                height: '36px',
                                borderRadius: '50%',
                                cursor: sending ? 'not-allowed' : 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '24px',
                                fontWeight: '300'
                            }}
                        >
                            
                        </button>
                    </div>

                    {/* Progress Steps */}
                    <div style={{
                        display: 'flex',
                        justifyContent: 'center',
                        gap: '8px',
                        padding: '16px',
                        borderBottom: `1px solid ${DESIGN.gray200}`
                    }}>
                        {[1, 2, 3].map(s => (
                            <div key={s} style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                            }}>
                                <div style={{
                                    width: '28px',
                                    height: '28px',
                                    borderRadius: '50%',
                                    background: s < step ? '#16A34A' : s === step ? '#0077CC' : DESIGN.gray200,
                                    color: s <= step ? 'white' : DESIGN.gray500,
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    fontSize: '14px',
                                    fontWeight: '600'
                                }}>
                                    {s < step ? <AdminIcons.Check size={16} /> : s}
                                </div>
                                {s < 3 && (
                                    <div style={{
                                        width: '40px',
                                        height: '2px',
                                        background: s < step ? '#16A34A' : DESIGN.gray200
                                    }} />
                                )}
                            </div>
                        ))}
                    </div>

                    {/* Content */}
                    <div style={{
                        flex: 1,
                        overflowY: 'auto',
                        padding: isMobile ? '20px' : '24px'
                    }}>
                        {/* Step 1: Select Template */}
                        {step === 1 && (
                            <div>
                                <h4 style={{
                                    margin: '0 0 16px 0',
                                    fontSize: '16px',
                                    fontWeight: '600',
                                    color: DESIGN.gray600
                                }}>
                                    Select a Document Template
                                </h4>

                                {loadingTemplates ? (
                                    <div style={{ textAlign: 'center', padding: '40px' }}>
                                        <div style={{
                                            width: '40px', height: '40px',
                                            border: '3px solid #f3f3f3',
                                            borderTop: '3px solid #0077CC',
                                            borderRadius: '50%',
                                            animation: 'spin 1s linear infinite',
                                            margin: '0 auto 16px'
                                        }} />
                                        <p style={{ color: DESIGN.gray400 }}>Loading templates...</p>
                                    </div>
                                ) : documentTemplates.length === 0 ? (
                                    <div style={{
                                        textAlign: 'center',
                                        padding: '40px',
                                        background: DESIGN.gray100,
                                        borderRadius: DESIGN.radiusCard
                                    }}>
                                        <AdminIcons.FileText size={40} color={DESIGN.gray400} />
                                        <p style={{ color: DESIGN.gray500, marginTop: '12px' }}>
                                            No active document templates found.
                                        </p>
                                    </div>
                                ) : (
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                        {documentTemplates.map(tmpl => (
                                            <button
                                                key={tmpl.id}
                                                onClick={() => setSelectedTemplate(tmpl)}
                                                style={{
                                                    padding: '16px',
                                                    background: selectedTemplate?.id === tmpl.id ? 'rgba(0,119,204,0.1)' : DESIGN.bgCard,
                                                    border: selectedTemplate?.id === tmpl.id ? '2px solid #0077CC' : `1px solid ${DESIGN.gray200}`,
                                                    borderRadius: DESIGN.radiusInput,
                                                    textAlign: 'left',
                                                    cursor: 'pointer',
                                                    transition: DESIGN.transitionFast
                                                }}
                                            >
                                                <div style={{
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'flex-start'
                                                }}>
                                                    <div>
                                                        <div style={{
                                                            fontSize: '16px',
                                                            fontWeight: '600',
                                                            color: DESIGN.gray600,
                                                            marginBottom: '4px'
                                                        }}>
                                                            {tmpl.name}
                                                        </div>
                                                        {tmpl.description && (
                                                            <div style={{
                                                                fontSize: DESIGN.fontSizeCaption,
                                                                color: DESIGN.gray400
                                                            }}>
                                                                {tmpl.description}
                                                            </div>
                                                        )}
                                                    </div>
                                                    {selectedTemplate?.id === tmpl.id && (
                                                        <AdminIcons.CheckCircle size={20} color="#0077CC" />
                                                    )}
                                                </div>
                                            </button>
                                        ))}
                                    </div>
                                )}

                                {errors.template && (
                                    <div style={{
                                        marginTop: '12px',
                                        color: '#DC2626',
                                        fontSize: DESIGN.fontSizeCaption,
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '4px'
                                    }}>
                                        <AdminIcons.AlertTriangle size={14} />
                                        {errors.template}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Step 2: Add Signers */}
                        {step === 2 && (
                            <div>
                                <h4 style={{
                                    margin: '0 0 8px 0',
                                    fontSize: '16px',
                                    fontWeight: '600',
                                    color: DESIGN.gray600
                                }}>
                                    Signer Information
                                </h4>
                                <p style={{
                                    margin: '0 0 20px 0',
                                    fontSize: DESIGN.fontSizeCaption,
                                    color: DESIGN.gray400
                                }}>
                                    Signing order: {rolesNeeded.map(r => SIGNER_ROLES[r]?.label || r).join('  ')}
                                </p>

                                <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>
                                    {rolesNeeded.sort((a, b) => (signers[a]?.order || 0) - (signers[b]?.order || 0)).map(role => {
                                        const roleConfig = SIGNER_ROLES[role];
                                        const signer = signers[role] || {};

                                        return (
                                            <div
                                                key={role}
                                                style={{
                                                    padding: '16px',
                                                    border: `2px solid ${roleConfig?.borderColor || DESIGN.gray200}`,
                                                    borderRadius: DESIGN.radiusInput,
                                                    background: roleConfig?.bgLight || DESIGN.gray100
                                                }}
                                            >
                                                <div style={{
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '8px',
                                                    marginBottom: '12px'
                                                }}>
                                                    <span style={{
                                                        width: '12px',
                                                        height: '12px',
                                                        borderRadius: '50%',
                                                        background: roleConfig?.color || DESIGN.gray400
                                                    }} />
                                                    <span style={{
                                                        fontSize: DESIGN.fontSizeMetadata,
                                                        fontWeight: '600',
                                                        color: roleConfig?.color || DESIGN.gray600
                                                    }}>
                                                        {roleConfig?.fullLabel || role}
                                                    </span>
                                                    <span style={{
                                                        fontSize: DESIGN.fontSizeCaption,
                                                        color: DESIGN.gray400,
                                                        marginLeft: 'auto'
                                                    }}>
                                                        Signs #{(signer.order || 0) + 1}
                                                    </span>
                                                </div>

                                                {/* Name field */}
                                                <div style={{ marginBottom: '12px' }}>
                                                    <label style={{
                                                        display: 'block',
                                                        fontSize: DESIGN.fontSizeCaption,
                                                        color: DESIGN.gray500,
                                                        marginBottom: '4px'
                                                    }}>
                                                        Full Name *
                                                    </label>
                                                    <input
                                                        type="text"
                                                        value={signer.name || ''}
                                                        onChange={(e) => updateSigner(role, 'name', e.target.value)}
                                                        placeholder={`Enter ${roleConfig?.label || role} name`}
                                                        style={{
                                                            width: '100%',
                                                            padding: '10px 12px',
                                                            border: errors[`${role}_name`] ? '2px solid #DC2626' : `1px solid ${DESIGN.gray200}`,
                                                            borderRadius: DESIGN.radiusInput,
                                                            fontSize: DESIGN.fontSizeMetadata,
                                                            background: 'white'
                                                        }}
                                                    />
                                                    {errors[`${role}_name`] && (
                                                        <div style={{
                                                            marginTop: '4px',
                                                            color: '#DC2626',
                                                            fontSize: DESIGN.fontSizeCaption
                                                        }}>
                                                            {errors[`${role}_name`]}
                                                        </div>
                                                    )}
                                                </div>

                                                {/* Email field (not for GLRS) */}
                                                {role !== 'glrs' ? (
                                                    <div>
                                                        <label style={{
                                                            display: 'block',
                                                            fontSize: DESIGN.fontSizeCaption,
                                                            color: DESIGN.gray500,
                                                            marginBottom: '4px'
                                                        }}>
                                                            Email Address *
                                                        </label>
                                                        <input
                                                            type="email"
                                                            value={signer.email || ''}
                                                            onChange={(e) => updateSigner(role, 'email', e.target.value)}
                                                            placeholder={`Enter ${roleConfig?.label || role} email`}
                                                            style={{
                                                                width: '100%',
                                                                padding: '10px 12px',
                                                                border: errors[`${role}_email`] ? '2px solid #DC2626' : `1px solid ${DESIGN.gray200}`,
                                                                borderRadius: DESIGN.radiusInput,
                                                                fontSize: DESIGN.fontSizeMetadata,
                                                                background: 'white'
                                                            }}
                                                        />
                                                        {errors[`${role}_email`] && (
                                                            <div style={{
                                                                marginTop: '4px',
                                                                color: '#DC2626',
                                                                fontSize: DESIGN.fontSizeCaption
                                                            }}>
                                                                {errors[`${role}_email`]}
                                                            </div>
                                                        )}
                                                    </div>
                                                ) : (
                                                    <div style={{
                                                        padding: '10px 12px',
                                                        background: 'rgba(255,255,255,0.5)',
                                                        borderRadius: DESIGN.radiusInput,
                                                        fontSize: DESIGN.fontSizeCaption,
                                                        color: DESIGN.gray500,
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: '8px'
                                                    }}>
                                                        <AdminIcons.Info size={14} />
                                                        GLRS representative signs in the admin portal
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* Step 3: Review & Send */}
                        {step === 3 && (
                            <div>
                                <h4 style={{
                                    margin: '0 0 20px 0',
                                    fontSize: '16px',
                                    fontWeight: '600',
                                    color: DESIGN.gray600
                                }}>
                                    Review & Send
                                </h4>

                                {/* Document Title */}
                                <div style={{ marginBottom: '20px' }}>
                                    <label style={{
                                        display: 'block',
                                        fontSize: DESIGN.fontSizeCaption,
                                        color: DESIGN.gray500,
                                        fontWeight: '600',
                                        marginBottom: '6px'
                                    }}>
                                        Document Title *
                                    </label>
                                    <input
                                        type="text"
                                        value={documentTitle}
                                        onChange={(e) => {
                                            setDocumentTitle(e.target.value);
                                            setErrors(prev => ({ ...prev, documentTitle: undefined }));
                                        }}
                                        style={{
                                            width: '100%',
                                            padding: '12px',
                                            border: errors.documentTitle ? '2px solid #DC2626' : `1px solid ${DESIGN.gray200}`,
                                            borderRadius: DESIGN.radiusInput,
                                            fontSize: DESIGN.fontSizeMetadata
                                        }}
                                    />
                                    {errors.documentTitle && (
                                        <div style={{
                                            marginTop: '4px',
                                            color: '#DC2626',
                                            fontSize: DESIGN.fontSizeCaption
                                        }}>
                                            {errors.documentTitle}
                                        </div>
                                    )}
                                </div>

                                {/* Summary */}
                                <div style={{
                                    padding: '16px',
                                    background: DESIGN.gray100,
                                    borderRadius: DESIGN.radiusInput,
                                    marginBottom: '20px'
                                }}>
                                    <div style={{
                                        fontSize: DESIGN.fontSizeCaption,
                                        color: DESIGN.gray500,
                                        fontWeight: '600',
                                        marginBottom: '12px'
                                    }}>
                                        This document will be sent to:
                                    </div>

                                    {rolesNeeded.sort((a, b) => (signers[a]?.order || 0) - (signers[b]?.order || 0)).map((role, index) => {
                                        const signer = signers[role];
                                        const roleConfig = SIGNER_ROLES[role];
                                        return (
                                            <div
                                                key={role}
                                                style={{
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '12px',
                                                    padding: '10px',
                                                    background: 'white',
                                                    borderRadius: DESIGN.radiusInput,
                                                    marginBottom: index < rolesNeeded.length - 1 ? '8px' : 0
                                                }}
                                            >
                                                <span style={{
                                                    width: '24px',
                                                    height: '24px',
                                                    borderRadius: '50%',
                                                    background: roleConfig?.color || DESIGN.gray400,
                                                    color: 'white',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    fontSize: '12px',
                                                    fontWeight: '600'
                                                }}>
                                                    {index + 1}
                                                </span>
                                                <div style={{ flex: 1 }}>
                                                    <div style={{
                                                        fontSize: DESIGN.fontSizeMetadata,
                                                        fontWeight: '500',
                                                        color: DESIGN.gray600
                                                    }}>
                                                        {signer?.name}
                                                    </div>
                                                    <div style={{
                                                        fontSize: DESIGN.fontSizeCaption,
                                                        color: DESIGN.gray400
                                                    }}>
                                                        {roleConfig?.label}  {role === 'glrs' ? 'Signs in portal' : signer?.email}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>

                                {/* Expiration */}
                                <div style={{ marginBottom: '20px' }}>
                                    <label style={{
                                        display: 'block',
                                        fontSize: DESIGN.fontSizeCaption,
                                        color: DESIGN.gray500,
                                        fontWeight: '600',
                                        marginBottom: '6px'
                                    }}>
                                        Expires After
                                    </label>
                                    <select
                                        value={expirationDays}
                                        onChange={(e) => setExpirationDays(parseInt(e.target.value))}
                                        style={{
                                            width: '100%',
                                            padding: '12px',
                                            border: `1px solid ${DESIGN.gray200}`,
                                            borderRadius: DESIGN.radiusInput,
                                            fontSize: DESIGN.fontSizeMetadata,
                                            background: 'white'
                                        }}
                                    >
                                        <option value={7}>7 days</option>
                                        <option value={14}>14 days</option>
                                        <option value={30}>30 days</option>
                                        <option value={60}>60 days</option>
                                    </select>
                                </div>

                                {errors.template && (
                                    <div style={{
                                        padding: '12px',
                                        background: '#FEE2E2',
                                        border: '1px solid #FECACA',
                                        borderRadius: DESIGN.radiusInput,
                                        color: '#DC2626',
                                        fontSize: DESIGN.fontSizeCaption,
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px'
                                    }}>
                                        <AdminIcons.AlertTriangle size={16} />
                                        {errors.template}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    {/* Footer */}
                    <div style={{
                        padding: isMobile ? '16px 20px' : '20px 24px',
                        borderTop: `1px solid ${DESIGN.gray200}`,
                        display: 'flex',
                        gap: '12px',
                        justifyContent: 'space-between'
                    }}>
                        <button
                            onClick={() => step > 1 ? setStep(step - 1) : onClose()}
                            disabled={sending}
                            style={{
                                padding: '12px 20px',
                                background: DESIGN.gray100,
                                border: `1px solid ${DESIGN.gray200}`,
                                borderRadius: DESIGN.radiusInput,
                                color: DESIGN.gray600,
                                fontSize: DESIGN.fontSizeMetadata,
                                fontWeight: '500',
                                cursor: 'pointer'
                            }}
                        >
                            {step > 1 ? 'Back' : 'Cancel'}
                        </button>

                        {step < 3 ? (
                            <button
                                onClick={handleNext}
                                disabled={step === 1 && !selectedTemplate}
                                style={{
                                    padding: '12px 24px',
                                    background: (step === 1 && !selectedTemplate) ? DESIGN.gray300 : 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                    border: 'none',
                                    borderRadius: DESIGN.radiusInput,
                                    color: 'white',
                                    fontSize: DESIGN.fontSizeMetadata,
                                    fontWeight: '600',
                                    cursor: (step === 1 && !selectedTemplate) ? 'not-allowed' : 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px'
                                }}
                            >
                                Next
                                <AdminIcons.ChevronRight size={18} />
                            </button>
                        ) : (
                            <button
                                onClick={handleSend}
                                disabled={sending}
                                style={{
                                    padding: '12px 24px',
                                    background: sending ? DESIGN.gray400 : 'linear-gradient(135deg, #16A34A 0%, #15803D 100%)',
                                    border: 'none',
                                    borderRadius: DESIGN.radiusInput,
                                    color: 'white',
                                    fontSize: DESIGN.fontSizeMetadata,
                                    fontWeight: '600',
                                    cursor: sending ? 'not-allowed' : 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px'
                                }}
                            >
                                {sending ? (
                                    <>
                                        <span style={{
                                            display: 'inline-block',
                                            width: '16px',
                                            height: '16px',
                                            border: '2px solid white',
                                            borderTop: '2px solid transparent',
                                            borderRadius: '50%',
                                            animation: 'spin 0.8s linear infinite'
                                        }} />
                                        Sending...
                                    </>
                                ) : (
                                    <>
                                        <AdminIcons.Send size={16} />
                                        Send for Signature
                                    </>
                                )}
                            </button>
                        )}
                    </div>
                </div>
            </div>
        );
    }

    // ==========================================
    // GLRS SIGNING MODAL (Admin Counter-Signature)
    // ==========================================
    function GLRSSigningModal({ agreement, user, onClose, onComplete, isMobile }) {
        const [fieldValues, setFieldValues] = useState(agreement?.fieldValues || {});
        const [showSignatureCapture, setShowSignatureCapture] = useState(false);
        const [currentField, setCurrentField] = useState(null);
        const [saving, setSaving] = useState(false);
        const [typedSignature, setTypedSignature] = useState('');

        // Get GLRS fields that need to be signed
        const glrsFields = (agreement?.content?.blocks || []).filter(block =>
            block.role === 'glrs' &&
            ['signatureField', 'signatureBlock', 'initialsField', 'dateField', 'textInputField', 'checkboxField'].includes(block.type)
        );

        const requiredFields = glrsFields.filter(f => f.required);
        const completedFields = requiredFields.filter(f => fieldValues[f.id]);
        const canSubmit = completedFields.length === requiredFields.length;

        // Handle escape key
        useEffect(() => {
            const handleEscape = (e) => {
                if (e.key === 'Escape' && !saving) onClose();
            };
            window.addEventListener('keydown', handleEscape);
            return () => window.removeEventListener('keydown', handleEscape);
        }, [saving]);

        // Handle field click
        const handleFieldClick = (field) => {
            if (['signatureField', 'signatureBlock', 'initialsField'].includes(field.type)) {
                setCurrentField(field);
                setShowSignatureCapture(true);
            }
        };

        // Handle signature capture
        const handleSignatureCapture = (signatureData) => {
            if (currentField) {
                setFieldValues(prev => ({ ...prev, [currentField.id]: signatureData }));
                setShowSignatureCapture(false);
                setCurrentField(null);
            }
        };

        // Handle submit
        const handleSubmit = async () => {
            if (!canSubmit) return;

            setSaving(true);
            try {
                // Find GLRS signer
                const glrsSigner = agreement.signers.find(s => s.role === 'glrs');
                if (!glrsSigner) throw new Error('GLRS signer not found');

                // Update signer status
                const updatedSigners = agreement.signers.map(s => {
                    if (s.role === 'glrs') {
                        return {
                            ...s,
                            status: 'signed',
                            signedAt: new Date().toISOString(),
                            signedFields: glrsFields.map(f => f.id)
                        };
                    }
                    return s;
                });

                // Check if all signers have signed
                const allSigned = updatedSigners.every(s => s.status === 'signed');

                // Update agreement
                await db.collection('agreements').doc(agreement.id).update({
                    fieldValues: { ...agreement.fieldValues, ...fieldValues },
                    signers: updatedSigners,
                    status: allSigned ? 'completed' : 'partial',
                    completedAt: allSigned ? firebase.firestore.FieldValue.serverTimestamp() : null,
                    auditTrail: firebase.firestore.FieldValue.arrayUnion({
                        timestamp: new Date().toISOString(),
                        action: 'signed',
                        actor: user.email || `${user.firstName} ${user.lastName}`,
                        actorRole: 'glrs',
                        fields: glrsFields.map(f => f.id)
                    })
                });

                onComplete();
            } catch (error) {
                console.error('Error signing document:', error);
                alert('Failed to sign document: ' + error.message);
            } finally {
                setSaving(false);
            }
        };

        // Generate typed signature image
        const generateTypedSignature = (name) => {
            const canvas = document.createElement('canvas');
            canvas.width = 400;
            canvas.height = 100;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'black';
            ctx.font = 'italic 48px "Brush Script MT", cursive';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(name, canvas.width / 2, canvas.height / 2);
            return canvas.toDataURL('image/png');
        };

        return (
            <div
                style={{
                    position: 'fixed',
                    top: 0, left: 0, right: 0, bottom: 0,
                    background: 'rgba(0, 0, 0, 0.5)',
                    backdropFilter: 'blur(5px)',
                    display: 'flex',
                    alignItems: isMobile ? 'flex-end' : 'center',
                    justifyContent: 'center',
                    zIndex: 1000,
                    padding: isMobile ? 0 : '20px'
                }}
                onClick={() => !saving && onClose()}
            >
                <div
                    style={{
                        background: DESIGN.bgCard,
                        borderRadius: isMobile ? '20px 20px 0 0' : DESIGN.radiusModal,
                        maxWidth: '700px',
                        width: '100%',
                        maxHeight: isMobile ? '95vh' : '90vh',
                        display: 'flex',
                        flexDirection: 'column',
                        overflow: 'hidden',
                        boxShadow: DESIGN.shadowElevated
                    }}
                    onClick={(e) => e.stopPropagation()}
                >
                    {/* Header */}
                    <div style={{
                        background: 'linear-gradient(135deg, #F97316 0%, #EA580C 100%)',
                        padding: isMobile ? '20px' : '24px',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center'
                    }}>
                        <div>
                            <h3 style={{
                                margin: '0 0 4px 0',
                                color: 'white',
                                fontSize: isMobile ? '20px' : '22px',
                                fontWeight: '600'
                            }}>
                                GLRS Counter-Signature
                            </h3>
                            <p style={{
                                margin: 0,
                                color: 'rgba(255,255,255,0.85)',
                                fontSize: DESIGN.fontSizeMetadata
                            }}>
                                {agreement?.documentTitle || 'Service Agreement'}
                            </p>
                        </div>
                        <button
                            onClick={onClose}
                            disabled={saving}
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                border: 'none',
                                color: 'white',
                                width: '36px',
                                height: '36px',
                                borderRadius: '50%',
                                cursor: saving ? 'not-allowed' : 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '24px'
                            }}
                        >
                            
                        </button>
                    </div>

                    {/* Previous Signers Status */}
                    <div style={{
                        padding: '12px 24px',
                        background: DESIGN.gray100,
                        borderBottom: `1px solid ${DESIGN.gray200}`
                    }}>
                        <div style={{
                            fontSize: DESIGN.fontSizeCaption,
                            color: DESIGN.gray500,
                            marginBottom: '8px'
                        }}>
                            Previous Signatures:
                        </div>
                        <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
                            {agreement?.signers?.filter(s => s.role !== 'glrs').map(signer => (
                                <div
                                    key={signer.role}
                                    style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '6px',
                                        padding: '6px 12px',
                                        background: signer.status === 'signed' ? '#DCFCE7' : '#FEF3C7',
                                        borderRadius: '12px',
                                        fontSize: DESIGN.fontSizeCaption
                                    }}
                                >
                                    {signer.status === 'signed' ? (
                                        <AdminIcons.CheckCircle size={14} color="#16A34A" />
                                    ) : (
                                        <AdminIcons.Clock size={14} color="#D97706" />
                                    )}
                                    <span style={{
                                        color: signer.status === 'signed' ? '#166534' : '#92400E',
                                        fontWeight: '500'
                                    }}>
                                        {signer.name} ({SIGNER_ROLES[signer.role]?.label})
                                    </span>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Content - GLRS Fields */}
                    <div style={{
                        flex: 1,
                        overflowY: 'auto',
                        padding: '24px'
                    }}>
                        <div style={{
                            fontSize: DESIGN.fontSizeMetadata,
                            color: DESIGN.gray500,
                            marginBottom: '20px'
                        }}>
                            Complete the following fields to finalize the document:
                        </div>

                        <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                            {glrsFields.map(field => {
                                const hasValue = !!fieldValues[field.id];
                                return (
                                    <div
                                        key={field.id}
                                        onClick={() => handleFieldClick(field)}
                                        style={{
                                            padding: '16px',
                                            border: `2px solid ${ROLE_COLORS.glrs.border}`,
                                            borderRadius: DESIGN.radiusInput,
                                            background: ROLE_COLORS.glrs.bg,
                                            cursor: ['signatureField', 'signatureBlock', 'initialsField'].includes(field.type) ? 'pointer' : 'default'
                                        }}
                                    >
                                        <div style={{
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            alignItems: 'center',
                                            marginBottom: '8px'
                                        }}>
                                            <span style={{
                                                fontSize: DESIGN.fontSizeCaption,
                                                fontWeight: '600',
                                                color: ROLE_COLORS.glrs.text
                                            }}>
                                                {field.label || field.type}
                                                {field.required && <span style={{ color: '#DC2626' }}> *</span>}
                                            </span>
                                            {hasValue && (
                                                <AdminIcons.CheckCircle size={16} color="#16A34A" />
                                            )}
                                        </div>

                                        {/* Signature/Initials Field */}
                                        {['signatureField', 'signatureBlock', 'initialsField'].includes(field.type) && (
                                            <div style={{
                                                height: field.type === 'initialsField' ? '50px' : '60px',
                                                border: `2px dashed ${hasValue ? '#16A34A' : ROLE_COLORS.glrs.border}`,
                                                borderRadius: '4px',
                                                background: 'white',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center'
                                            }}>
                                                {hasValue ? (
                                                    <img src={fieldValues[field.id]} alt="Signature" style={{ maxHeight: '50px' }} />
                                                ) : (
                                                    <span style={{ color: DESIGN.gray400 }}>Click to sign</span>
                                                )}
                                            </div>
                                        )}

                                        {/* Date Field */}
                                        {field.type === 'dateField' && (
                                            <input
                                                type="date"
                                                value={fieldValues[field.id] || new Date().toISOString().split('T')[0]}
                                                onChange={(e) => setFieldValues(prev => ({ ...prev, [field.id]: e.target.value }))}
                                                style={{
                                                    width: '100%',
                                                    padding: '10px 12px',
                                                    border: `1px solid ${DESIGN.gray200}`,
                                                    borderRadius: DESIGN.radiusInput,
                                                    fontSize: DESIGN.fontSizeMetadata,
                                                    background: 'white'
                                                }}
                                            />
                                        )}

                                        {/* Text Input Field */}
                                        {field.type === 'textInputField' && (
                                            <input
                                                type="text"
                                                value={fieldValues[field.id] || ''}
                                                onChange={(e) => setFieldValues(prev => ({ ...prev, [field.id]: e.target.value }))}
                                                placeholder={field.placeholder || 'Enter text...'}
                                                style={{
                                                    width: '100%',
                                                    padding: '10px 12px',
                                                    border: `1px solid ${DESIGN.gray200}`,
                                                    borderRadius: DESIGN.radiusInput,
                                                    fontSize: DESIGN.fontSizeMetadata,
                                                    background: 'white'
                                                }}
                                            />
                                        )}

                                        {/* Checkbox Field */}
                                        {field.type === 'checkboxField' && (
                                            <label style={{
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '10px',
                                                cursor: 'pointer'
                                            }}>
                                                <input
                                                    type="checkbox"
                                                    checked={!!fieldValues[field.id]}
                                                    onChange={(e) => setFieldValues(prev => ({ ...prev, [field.id]: e.target.checked }))}
                                                    style={{ width: '18px', height: '18px' }}
                                                />
                                                <span style={{ fontSize: DESIGN.fontSizeMetadata, color: DESIGN.gray600 }}>
                                                    {field.label}
                                                </span>
                                            </label>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* Footer */}
                    <div style={{
                        padding: '20px 24px',
                        borderTop: `1px solid ${DESIGN.gray200}`,
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center'
                    }}>
                        <div style={{
                            fontSize: DESIGN.fontSizeCaption,
                            color: DESIGN.gray400
                        }}>
                            {completedFields.length} of {requiredFields.length} required fields completed
                        </div>
                        <div style={{ display: 'flex', gap: '12px' }}>
                            <button
                                onClick={onClose}
                                disabled={saving}
                                style={{
                                    padding: '12px 20px',
                                    background: DESIGN.gray100,
                                    border: `1px solid ${DESIGN.gray200}`,
                                    borderRadius: DESIGN.radiusInput,
                                    color: DESIGN.gray600,
                                    fontSize: DESIGN.fontSizeMetadata,
                                    fontWeight: '500',
                                    cursor: 'pointer'
                                }}
                            >
                                Cancel
                            </button>
                            <button
                                onClick={handleSubmit}
                                disabled={!canSubmit || saving}
                                style={{
                                    padding: '12px 24px',
                                    background: (!canSubmit || saving) ? DESIGN.gray300 : 'linear-gradient(135deg, #16A34A 0%, #15803D 100%)',
                                    border: 'none',
                                    borderRadius: DESIGN.radiusInput,
                                    color: 'white',
                                    fontSize: DESIGN.fontSizeMetadata,
                                    fontWeight: '600',
                                    cursor: (!canSubmit || saving) ? 'not-allowed' : 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px'
                                }}
                            >
                                {saving ? (
                                    <>
                                        <span style={{
                                            display: 'inline-block',
                                            width: '16px',
                                            height: '16px',
                                            border: '2px solid white',
                                            borderTop: '2px solid transparent',
                                            borderRadius: '50%',
                                            animation: 'spin 0.8s linear infinite'
                                        }} />
                                        Signing...
                                    </>
                                ) : (
                                    <>
                                        <AdminIcons.Check size={16} />
                                        Sign & Complete
                                    </>
                                )}
                            </button>
                        </div>
                    </div>
                </div>

                {/* Signature Capture Mini-Modal */}
                {showSignatureCapture && currentField && (
                    <div
                        style={{
                            position: 'fixed',
                            top: 0, left: 0, right: 0, bottom: 0,
                            background: 'rgba(0, 0, 0, 0.7)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            zIndex: 1100
                        }}
                        onClick={() => setShowSignatureCapture(false)}
                    >
                        <div
                            style={{
                                background: 'white',
                                borderRadius: DESIGN.radiusModal,
                                padding: '24px',
                                width: '90%',
                                maxWidth: '450px'
                            }}
                            onClick={(e) => e.stopPropagation()}
                        >
                            <h4 style={{
                                margin: '0 0 16px 0',
                                fontSize: '18px',
                                fontWeight: '600',
                                color: DESIGN.gray600
                            }}>
                                {currentField.type === 'initialsField' ? 'Add Your Initials' : 'Add Your Signature'}
                            </h4>

                            {/* Type signature option */}
                            <div style={{ marginBottom: '16px' }}>
                                <label style={{
                                    display: 'block',
                                    fontSize: DESIGN.fontSizeCaption,
                                    color: DESIGN.gray500,
                                    marginBottom: '6px'
                                }}>
                                    Type your {currentField.type === 'initialsField' ? 'initials' : 'name'}:
                                </label>
                                <input
                                    type="text"
                                    value={typedSignature}
                                    onChange={(e) => setTypedSignature(e.target.value)}
                                    placeholder={currentField.type === 'initialsField' ? 'e.g., TR' : 'e.g., Tyler Roberts'}
                                    style={{
                                        width: '100%',
                                        padding: '12px',
                                        border: `1px solid ${DESIGN.gray200}`,
                                        borderRadius: DESIGN.radiusInput,
                                        fontSize: '18px',
                                        fontFamily: '"Brush Script MT", cursive'
                                    }}
                                />
                            </div>

                            {/* Preview */}
                            {typedSignature && (
                                <div style={{
                                    padding: '20px',
                                    background: DESIGN.gray100,
                                    borderRadius: DESIGN.radiusInput,
                                    textAlign: 'center',
                                    marginBottom: '16px'
                                }}>
                                    <div style={{
                                        fontSize: currentField.type === 'initialsField' ? '32px' : '28px',
                                        fontFamily: '"Brush Script MT", cursive',
                                        fontStyle: 'italic',
                                        color: DESIGN.gray600
                                    }}>
                                        {typedSignature}
                                    </div>
                                </div>
                            )}

                            <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                                <button
                                    onClick={() => {
                                        setShowSignatureCapture(false);
                                        setTypedSignature('');
                                    }}
                                    style={{
                                        padding: '10px 20px',
                                        background: DESIGN.gray100,
                                        border: `1px solid ${DESIGN.gray200}`,
                                        borderRadius: DESIGN.radiusInput,
                                        color: DESIGN.gray600,
                                        cursor: 'pointer'
                                    }}
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={() => {
                                        if (typedSignature.trim()) {
                                            const sigData = generateTypedSignature(typedSignature);
                                            handleSignatureCapture(sigData);
                                            setTypedSignature('');
                                        }
                                    }}
                                    disabled={!typedSignature.trim()}
                                    style={{
                                        padding: '10px 20px',
                                        background: typedSignature.trim() ? 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)' : DESIGN.gray300,
                                        border: 'none',
                                        borderRadius: DESIGN.radiusInput,
                                        color: 'white',
                                        fontWeight: '600',
                                        cursor: typedSignature.trim() ? 'pointer' : 'not-allowed'
                                    }}
                                >
                                    Apply Signature
                                </button>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    // ==========================================
    // SEND SUCCESS MODAL
    // ==========================================
    function SendSuccessModal({ agreement, onClose, isMobile }) {
        const [copiedLink, setCopiedLink] = useState(null);

        const copyToClipboard = async (link, role) => {
            try {
                await navigator.clipboard.writeText(link);
                setCopiedLink(role);
                setTimeout(() => setCopiedLink(null), 2000);
            } catch (err) {
                console.error('Failed to copy:', err);
            }
        };

        return (
            <div
                style={{
                    position: 'fixed',
                    top: 0, left: 0, right: 0, bottom: 0,
                    background: 'rgba(0, 0, 0, 0.5)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1000,
                    padding: '20px'
                }}
                onClick={onClose}
            >
                <div
                    style={{
                        background: 'white',
                        borderRadius: DESIGN.radiusModal,
                        padding: '32px',
                        maxWidth: '500px',
                        width: '100%',
                        textAlign: 'center'
                    }}
                    onClick={(e) => e.stopPropagation()}
                >
                    <div style={{
                        width: '64px',
                        height: '64px',
                        borderRadius: '50%',
                        background: '#DCFCE7',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        margin: '0 auto 20px'
                    }}>
                        <AdminIcons.CheckCircle size={32} color="#16A34A" />
                    </div>

                    <h3 style={{
                        margin: '0 0 8px 0',
                        fontSize: '22px',
                        fontWeight: '600',
                        color: DESIGN.gray600
                    }}>
                        Document Sent!
                    </h3>

                    <p style={{
                        margin: '0 0 24px 0',
                        fontSize: DESIGN.fontSizeMetadata,
                        color: DESIGN.gray400
                    }}>
                        Signing links have been generated. Share them with the signers.
                    </p>

                    {/* Signing Links */}
                    <div style={{
                        background: DESIGN.gray100,
                        borderRadius: DESIGN.radiusInput,
                        padding: '16px',
                        textAlign: 'left',
                        marginBottom: '24px'
                    }}>
                        {agreement?.signingLinks?.filter(s => s.email).map((signer, index) => (
                            <div
                                key={signer.role}
                                style={{
                                    padding: '12px',
                                    background: 'white',
                                    borderRadius: DESIGN.radiusInput,
                                    marginBottom: index < agreement.signingLinks.filter(s => s.email).length - 1 ? '8px' : 0
                                }}
                            >
                                <div style={{
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center',
                                    marginBottom: '8px'
                                }}>
                                    <span style={{
                                        fontSize: DESIGN.fontSizeMetadata,
                                        fontWeight: '600',
                                        color: DESIGN.gray600
                                    }}>
                                        {signer.name}
                                    </span>
                                    <span style={{
                                        padding: '2px 8px',
                                        background: SIGNER_ROLES[signer.role]?.bgLight || DESIGN.gray100,
                                        color: SIGNER_ROLES[signer.role]?.color || DESIGN.gray500,
                                        borderRadius: '8px',
                                        fontSize: DESIGN.fontSizeCaption,
                                        fontWeight: '500'
                                    }}>
                                        {SIGNER_ROLES[signer.role]?.label || signer.role}
                                    </span>
                                </div>
                                <div style={{
                                    display: 'flex',
                                    gap: '8px',
                                    alignItems: 'center'
                                }}>
                                    <input
                                        type="text"
                                        value={signer.link}
                                        readOnly
                                        style={{
                                            flex: 1,
                                            padding: '8px 10px',
                                            border: `1px solid ${DESIGN.gray200}`,
                                            borderRadius: DESIGN.radiusInput,
                                            fontSize: DESIGN.fontSizeCaption,
                                            color: DESIGN.gray500,
                                            background: DESIGN.gray100
                                        }}
                                    />
                                    <button
                                        onClick={() => copyToClipboard(signer.link, signer.role)}
                                        style={{
                                            padding: '8px 12px',
                                            background: copiedLink === signer.role ? '#DCFCE7' : '#0077CC',
                                            border: 'none',
                                            borderRadius: DESIGN.radiusInput,
                                            color: copiedLink === signer.role ? '#16A34A' : 'white',
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '4px',
                                            fontSize: DESIGN.fontSizeCaption,
                                            fontWeight: '500'
                                        }}
                                    >
                                        {copiedLink === signer.role ? (
                                            <>
                                                <AdminIcons.Check size={14} />
                                                Copied!
                                            </>
                                        ) : (
                                            <>
                                                <AdminIcons.Copy size={14} />
                                                Copy
                                            </>
                                        )}
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>

                    <p style={{
                        margin: '0 0 20px 0',
                        fontSize: DESIGN.fontSizeCaption,
                        color: DESIGN.gray400
                    }}>
                        Note: Email notifications will be added in a future update.
                    </p>

                    <button
                        onClick={onClose}
                        style={{
                            padding: '12px 32px',
                            background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                            border: 'none',
                            borderRadius: DESIGN.radiusInput,
                            color: 'white',
                            fontSize: DESIGN.fontSizeMetadata,
                            fontWeight: '600',
                            cursor: 'pointer'
                        }}
                    >
                        Done
                    </button>
                </div>
            </div>
        );
    }

    // ==========================================
    // AGREEMENT STATUS CONSTANTS
    // ==========================================
    const AGREEMENT_STATUS = {
        sent: { label: 'Sent', color: '#3B82F6', bg: 'rgba(59, 130, 246, 0.1)' },
        viewed: { label: 'Viewed', color: '#8B5CF6', bg: 'rgba(139, 92, 246, 0.1)' },
        partial: { label: 'Partially Signed', color: '#F59E0B', bg: 'rgba(245, 158, 11, 0.1)' },
        completed: { label: 'Completed', color: '#22C55E', bg: 'rgba(34, 197, 94, 0.1)' },
        declined: { label: 'Declined', color: '#EF4444', bg: 'rgba(239, 68, 68, 0.1)' },
        expired: { label: 'Expired', color: '#6B7280', bg: 'rgba(107, 114, 128, 0.1)' },
        voided: { label: 'Voided', color: '#6B7280', bg: 'rgba(107, 114, 128, 0.1)' }
    };

    // ==========================================
    // AGREEMENT ROW COMPONENT
    // ==========================================
    function AgreementRow({ agreement, onViewDetails, onCopyLink, onVoid, onSignAsGLRS, onDownloadPDF, isMobile }) {
        const [downloadingPDF, setDownloadingPDF] = useState(false);
        const [showMenu, setShowMenu] = useState(false);
        const menuRef = useRef(null);

        const statusConfig = AGREEMENT_STATUS[agreement.status] || AGREEMENT_STATUS.sent;

        // Close menu when clicking outside
        useEffect(() => {
            const handleClickOutside = (e) => {
                if (menuRef.current && !menuRef.current.contains(e.target)) {
                    setShowMenu(false);
                }
            };
            if (showMenu) {
                document.addEventListener('mousedown', handleClickOutside);
            }
            return () => document.removeEventListener('mousedown', handleClickOutside);
        }, [showMenu]);

        // Format relative date
        const formatRelativeDate = (timestamp) => {
            if (!timestamp) return '-';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        };

        const formatDate = (timestamp) => {
            if (!timestamp) return '-';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        };

        // Get primary signer (first non-GLRS signer)
        const primarySigner = agreement.signers?.find(s => s.role !== 'glrs') || agreement.signers?.[0];

        // Get next pending signer
        const nextPendingSigner = agreement.signers?.find(s => s.status === 'pending');

        // Check if GLRS can sign (all previous signers have signed)
        const glrsSigner = agreement.signers?.find(s => s.role === 'glrs');
        const canGLRSSign = glrsSigner?.status === 'pending' &&
            agreement.signers?.filter(s => s.role !== 'glrs').every(s => s.status === 'signed');

        // Check if expired
        const isExpired = agreement.expiresAt && agreement.expiresAt.toDate() < new Date();
        const effectiveStatus = isExpired && agreement.status !== 'completed' && agreement.status !== 'voided'
            ? 'expired' : agreement.status;
        const effectiveStatusConfig = AGREEMENT_STATUS[effectiveStatus] || statusConfig;

        if (isMobile) {
            // Mobile card view
            return (
                <div style={{
                    background: DESIGN.bgCard,
                    borderRadius: DESIGN.radiusCard,
                    padding: '16px',
                    marginBottom: '12px',
                    boxShadow: DESIGN.shadowResting
                }}>
                    <div style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'flex-start',
                        marginBottom: '12px'
                    }}>
                        <div style={{ flex: 1 }}>
                            <div style={{
                                fontSize: '16px',
                                fontWeight: '600',
                                color: DESIGN.gray600,
                                marginBottom: '4px'
                            }}>
                                {agreement.documentTitle}
                            </div>
                            <div style={{
                                fontSize: DESIGN.fontSizeCaption,
                                color: DESIGN.gray400
                            }}>
                                {primarySigner?.name || 'No signer'}
                            </div>
                        </div>
                        <span style={{
                            padding: '4px 10px',
                            background: effectiveStatusConfig.bg,
                            color: effectiveStatusConfig.color,
                            borderRadius: '12px',
                            fontSize: DESIGN.fontSizeCaption,
                            fontWeight: '600'
                        }}>
                            {effectiveStatusConfig.label}
                        </span>
                    </div>

                    {/* Signer indicators */}
                    <div style={{
                        display: 'flex',
                        gap: '6px',
                        marginBottom: '12px'
                    }}>
                        {agreement.signers?.map((signer, idx) => {
                            const roleConfig = SIGNER_ROLES[signer.role];
                            return (
                                <div
                                    key={idx}
                                    title={`${signer.name} (${roleConfig?.label || signer.role}): ${signer.status}`}
                                    style={{
                                        width: '24px',
                                        height: '24px',
                                        borderRadius: '50%',
                                        background: signer.status === 'signed' ? roleConfig?.color : 'transparent',
                                        border: `2px solid ${roleConfig?.color || DESIGN.gray400}`,
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center'
                                    }}
                                >
                                    {signer.status === 'signed' && (
                                        <AdminIcons.Check size={12} color="white" />
                                    )}
                                </div>
                            );
                        })}
                    </div>

                    <div style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        fontSize: DESIGN.fontSizeCaption,
                        color: DESIGN.gray400
                    }}>
                        <span>Sent {formatRelativeDate(agreement.sentAt)}</span>
                        <div style={{ display: 'flex', gap: '8px' }}>
                            <button
                                onClick={() => onViewDetails(agreement)}
                                style={{
                                    padding: '8px 12px',
                                    background: DESIGN.gray100,
                                    border: 'none',
                                    borderRadius: DESIGN.radiusInput,
                                    fontSize: DESIGN.fontSizeCaption,
                                    color: DESIGN.gray600,
                                    cursor: 'pointer'
                                }}
                            >
                                View
                            </button>
                            {canGLRSSign && (
                                <button
                                    onClick={() => onSignAsGLRS(agreement)}
                                    style={{
                                        padding: '8px 12px',
                                        background: 'linear-gradient(135deg, #F97316 0%, #EA580C 100%)',
                                        border: 'none',
                                        borderRadius: DESIGN.radiusInput,
                                        fontSize: DESIGN.fontSizeCaption,
                                        color: 'white',
                                        fontWeight: '600',
                                        cursor: 'pointer'
                                    }}
                                >
                                    Sign
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Desktop table row
        return (
            <tr style={{
                borderBottom: `1px solid ${DESIGN.gray200}`,
                transition: DESIGN.transitionFast
            }}>
                {/* Document Title */}
                <td style={{ padding: '16px', verticalAlign: 'middle' }}>
                    <div style={{
                        fontSize: DESIGN.fontSizeMetadata,
                        fontWeight: '600',
                        color: DESIGN.gray600
                    }}>
                        {agreement.documentTitle}
                    </div>
                </td>

                {/* Recipient */}
                <td style={{ padding: '16px', verticalAlign: 'middle' }}>
                    <div style={{ fontSize: DESIGN.fontSizeMetadata, color: DESIGN.gray600 }}>
                        {primarySigner?.name || '-'}
                    </div>
                    {agreement.signers?.length > 1 && (
                        <div style={{ fontSize: DESIGN.fontSizeCaption, color: DESIGN.gray400 }}>
                            +{agreement.signers.length - 1} more
                        </div>
                    )}
                </td>

                {/* Signer Status Indicators */}
                <td style={{ padding: '16px', verticalAlign: 'middle' }}>
                    <div style={{ display: 'flex', gap: '4px' }}>
                        {agreement.signers?.map((signer, idx) => {
                            const roleConfig = SIGNER_ROLES[signer.role];
                            return (
                                <div
                                    key={idx}
                                    title={`${signer.name} (${roleConfig?.label || signer.role}): ${signer.status === 'signed' ? 'Signed' : 'Pending'}`}
                                    style={{
                                        width: '20px',
                                        height: '20px',
                                        borderRadius: '50%',
                                        background: signer.status === 'signed' ? roleConfig?.color : 'transparent',
                                        border: `2px solid ${roleConfig?.color || DESIGN.gray400}`,
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        cursor: 'help'
                                    }}
                                >
                                    {signer.status === 'signed' && (
                                        <AdminIcons.Check size={10} color="white" />
                                    )}
                                </div>
                            );
                        })}
                    </div>
                </td>

                {/* Status */}
                <td style={{ padding: '16px', verticalAlign: 'middle' }}>
                    <span style={{
                        padding: '4px 10px',
                        background: effectiveStatusConfig.bg,
                        color: effectiveStatusConfig.color,
                        borderRadius: '12px',
                        fontSize: DESIGN.fontSizeCaption,
                        fontWeight: '600',
                        whiteSpace: 'nowrap'
                    }}>
                        {effectiveStatusConfig.label}
                    </span>
                </td>

                {/* Sent */}
                <td style={{ padding: '16px', verticalAlign: 'middle', fontSize: DESIGN.fontSizeMetadata, color: DESIGN.gray500 }}>
                    {formatRelativeDate(agreement.sentAt)}
                </td>

                {/* Expires */}
                <td style={{ padding: '16px', verticalAlign: 'middle', fontSize: DESIGN.fontSizeMetadata, color: DESIGN.gray500 }}>
                    {agreement.status === 'completed' || agreement.status === 'voided'
                        ? '-'
                        : formatDate(agreement.expiresAt)}
                </td>

                {/* Actions */}
                <td style={{ padding: '16px', verticalAlign: 'middle', position: 'relative' }}>
                    <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                        {/* Sign as GLRS button (if applicable) */}
                        {canGLRSSign && (
                            <button
                                onClick={() => onSignAsGLRS(agreement)}
                                style={{
                                    padding: '6px 12px',
                                    background: 'linear-gradient(135deg, #F97316 0%, #EA580C 100%)',
                                    border: 'none',
                                    borderRadius: DESIGN.radiusInput,
                                    fontSize: DESIGN.fontSizeCaption,
                                    color: 'white',
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '4px'
                                }}
                            >
                                <AdminIcons.Edit size={12} />
                                Sign
                            </button>
                        )}

                        {/* Kebab menu */}
                        <div ref={menuRef} style={{ position: 'relative' }}>
                            <button
                                onClick={() => setShowMenu(!showMenu)}
                                style={{
                                    padding: '6px',
                                    background: 'transparent',
                                    border: 'none',
                                    borderRadius: '4px',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center'
                                }}
                            >
                                <AdminIcons.MoreVertical size={18} color={DESIGN.gray500} />
                            </button>

                            {showMenu && (
                                <div style={{
                                    position: 'absolute',
                                    right: 0,
                                    top: '100%',
                                    background: DESIGN.bgCard,
                                    borderRadius: DESIGN.radiusInput,
                                    boxShadow: DESIGN.shadowElevated,
                                    minWidth: '180px',
                                    zIndex: 100,
                                    overflow: 'hidden'
                                }}>
                                    <button
                                        onClick={() => { setShowMenu(false); onViewDetails(agreement); }}
                                        style={{
                                            width: '100%',
                                            padding: '10px 16px',
                                            background: 'transparent',
                                            border: 'none',
                                            textAlign: 'left',
                                            cursor: 'pointer',
                                            fontSize: DESIGN.fontSizeMetadata,
                                            color: DESIGN.gray600,
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '10px'
                                        }}
                                        onMouseEnter={(e) => e.target.style.background = DESIGN.gray100}
                                        onMouseLeave={(e) => e.target.style.background = 'transparent'}
                                    >
                                        <AdminIcons.Eye size={16} />
                                        View Details
                                    </button>

                                    {nextPendingSigner && nextPendingSigner.role !== 'glrs' && (
                                        <button
                                            onClick={() => {
                                                setShowMenu(false);
                                                onCopyLink(agreement, nextPendingSigner);
                                            }}
                                            style={{
                                                width: '100%',
                                                padding: '10px 16px',
                                                background: 'transparent',
                                                border: 'none',
                                                textAlign: 'left',
                                                cursor: 'pointer',
                                                fontSize: DESIGN.fontSizeMetadata,
                                                color: DESIGN.gray600,
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '10px'
                                            }}
                                            onMouseEnter={(e) => e.target.style.background = DESIGN.gray100}
                                            onMouseLeave={(e) => e.target.style.background = 'transparent'}
                                        >
                                            <AdminIcons.Copy size={16} />
                                            Copy Signing Link
                                        </button>
                                    )}

                                    <button
                                        disabled
                                        style={{
                                            width: '100%',
                                            padding: '10px 16px',
                                            background: 'transparent',
                                            border: 'none',
                                            textAlign: 'left',
                                            cursor: 'not-allowed',
                                            fontSize: DESIGN.fontSizeMetadata,
                                            color: DESIGN.gray400,
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '10px'
                                        }}
                                    >
                                        <AdminIcons.Mail size={16} />
                                        Resend Reminder
                                        <span style={{ marginLeft: 'auto', fontSize: '10px' }}>Soon</span>
                                    </button>

                                    <button
                                        onClick={async () => {
                                            if (agreement.status !== 'completed') {
                                                alert('PDF is only available for completed agreements.');
                                                return;
                                            }
                                            setShowMenu(false);
                                            setDownloadingPDF(true);
                                            try {
                                                await onDownloadPDF(agreement);
                                            } finally {
                                                setDownloadingPDF(false);
                                            }
                                        }}
                                        disabled={downloadingPDF || agreement.status !== 'completed'}
                                        style={{
                                            width: '100%',
                                            padding: '10px 16px',
                                            background: 'transparent',
                                            border: 'none',
                                            textAlign: 'left',
                                            cursor: agreement.status === 'completed' ? 'pointer' : 'not-allowed',
                                            fontSize: DESIGN.fontSizeMetadata,
                                            color: agreement.status === 'completed' ? DESIGN.gray600 : DESIGN.gray400,
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '10px',
                                            opacity: downloadingPDF ? 0.7 : 1
                                        }}
                                        onMouseEnter={(e) => {
                                            if (agreement.status === 'completed') e.target.style.background = DESIGN.gray100;
                                        }}
                                        onMouseLeave={(e) => e.target.style.background = 'transparent'}
                                    >
                                        <AdminIcons.Download size={16} />
                                        {downloadingPDF ? 'Generating...' : 'Download PDF'}
                                        {agreement.status !== 'completed' && (
                                            <span style={{ marginLeft: 'auto', fontSize: '10px' }}>Completed only</span>
                                        )}
                                    </button>

                                    {agreement.status !== 'completed' && agreement.status !== 'voided' && (
                                        <>
                                            <div style={{ height: '1px', background: DESIGN.gray200, margin: '4px 0' }} />
                                            <button
                                                onClick={() => {
                                                    setShowMenu(false);
                                                    if (confirm('Are you sure you want to void this agreement? This cannot be undone.')) {
                                                        onVoid(agreement);
                                                    }
                                                }}
                                                style={{
                                                    width: '100%',
                                                    padding: '10px 16px',
                                                    background: 'transparent',
                                                    border: 'none',
                                                    textAlign: 'left',
                                                    cursor: 'pointer',
                                                    fontSize: DESIGN.fontSizeMetadata,
                                                    color: '#DC2626',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '10px'
                                                }}
                                                onMouseEnter={(e) => e.target.style.background = '#FEE2E2'}
                                                onMouseLeave={(e) => e.target.style.background = 'transparent'}
                                            >
                                                <AdminIcons.X size={16} />
                                                Void Agreement
                                            </button>
                                        </>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </td>
            </tr>
        );
    }

    // ==========================================
    // AGREEMENT DETAIL MODAL
    // ==========================================
    function AgreementDetailModal({ agreement, user, onClose, onSignAsGLRS, onCopyLink, onVoid, onResendReminder, onDownloadPDF, isMobile }) {
        const statusConfig = AGREEMENT_STATUS[agreement?.status] || AGREEMENT_STATUS.sent;
        const [sendingReminder, setSendingReminder] = useState(null);
        const [downloadingPDF, setDownloadingPDF] = useState(false);

        // Check if expired
        const isExpired = agreement?.expiresAt && agreement.expiresAt.toDate() < new Date();
        const effectiveStatus = isExpired && agreement?.status !== 'completed' && agreement?.status !== 'voided'
            ? 'expired' : agreement?.status;
        const effectiveStatusConfig = AGREEMENT_STATUS[effectiveStatus] || statusConfig;

        // Format date
        const formatDate = (timestamp) => {
            if (!timestamp) return '-';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('en-US', {
                month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit'
            });
        };

        // Check if GLRS can sign
        const glrsSigner = agreement?.signers?.find(s => s.role === 'glrs');
        const canGLRSSign = glrsSigner?.status === 'pending' &&
            agreement?.signers?.filter(s => s.role !== 'glrs').every(s => s.status === 'signed');

        // Get action icon
        const getActionIcon = (action) => {
            switch (action) {
                case 'sent': return AdminIcons.Send;
                case 'viewed': return AdminIcons.Eye;
                case 'signed': return AdminIcons.CheckCircle;
                case 'field_signed': return AdminIcons.Edit;
                case 'voided': return AdminIcons.X;
                case 'declined': return AdminIcons.X;
                default: return AdminIcons.Activity;
            }
        };

        // Handle escape key
        useEffect(() => {
            const handleEscape = (e) => {
                if (e.key === 'Escape') onClose();
            };
            window.addEventListener('keydown', handleEscape);
            return () => window.removeEventListener('keydown', handleEscape);
        }, []);

        return (
            <div
                style={{
                    position: 'fixed',
                    top: 0, left: 0, right: 0, bottom: 0,
                    background: 'rgba(0, 0, 0, 0.5)',
                    backdropFilter: 'blur(5px)',
                    display: 'flex',
                    alignItems: isMobile ? 'flex-end' : 'center',
                    justifyContent: 'center',
                    zIndex: 1000,
                    padding: isMobile ? 0 : '20px'
                }}
                onClick={onClose}
            >
                <div
                    style={{
                        background: DESIGN.bgCard,
                        borderRadius: isMobile ? '20px 20px 0 0' : DESIGN.radiusModal,
                        maxWidth: '700px',
                        width: '100%',
                        maxHeight: isMobile ? '95vh' : '90vh',
                        display: 'flex',
                        flexDirection: 'column',
                        overflow: 'hidden',
                        boxShadow: DESIGN.shadowElevated
                    }}
                    onClick={(e) => e.stopPropagation()}
                >
                    {/* Header */}
                    <div style={{
                        background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                        padding: isMobile ? '20px' : '24px',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'flex-start'
                    }}>
                        <div style={{ flex: 1 }}>
                            <h3 style={{
                                margin: '0 0 8px 0',
                                color: 'white',
                                fontSize: isMobile ? '20px' : '22px',
                                fontWeight: '600'
                            }}>
                                {agreement?.documentTitle}
                            </h3>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', flexWrap: 'wrap' }}>
                                <span style={{
                                    padding: '4px 12px',
                                    background: effectiveStatusConfig.bg,
                                    color: effectiveStatusConfig.color,
                                    borderRadius: '12px',
                                    fontSize: DESIGN.fontSizeCaption,
                                    fontWeight: '600'
                                }}>
                                    {effectiveStatusConfig.label}
                                </span>
                                <span style={{
                                    color: 'rgba(255,255,255,0.8)',
                                    fontSize: DESIGN.fontSizeCaption
                                }}>
                                    Sent {formatDate(agreement?.sentAt)}
                                </span>
                            </div>
                        </div>
                        <button
                            onClick={onClose}
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                border: 'none',
                                color: 'white',
                                width: '36px',
                                height: '36px',
                                borderRadius: '50%',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '24px'
                            }}
                        >
                            
                        </button>
                    </div>

                    {/* Content */}
                    <div style={{
                        flex: 1,
                        overflowY: 'auto',
                        padding: isMobile ? '20px' : '24px'
                    }}>
                        {/* Signers Section */}
                        <div style={{ marginBottom: '24px' }}>
                            <h4 style={{
                                margin: '0 0 16px 0',
                                fontSize: '16px',
                                fontWeight: '600',
                                color: DESIGN.gray600,
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                            }}>
                                <AdminIcons.Users size={18} />
                                Signers
                            </h4>

                            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                {agreement?.signers?.map((signer, idx) => {
                                    const roleConfig = SIGNER_ROLES[signer.role];
                                    const isPending = signer.status === 'pending';
                                    const isTheirTurn = isPending && agreement.signers
                                        .filter(s => s.order < signer.order)
                                        .every(s => s.status === 'signed');

                                    return (
                                        <div
                                            key={idx}
                                            style={{
                                                padding: '16px',
                                                background: roleConfig?.bgLight || DESIGN.gray100,
                                                border: `2px solid ${roleConfig?.borderColor || DESIGN.gray200}`,
                                                borderRadius: DESIGN.radiusInput
                                            }}
                                        >
                                            <div style={{
                                                display: 'flex',
                                                justifyContent: 'space-between',
                                                alignItems: isMobile ? 'flex-start' : 'center',
                                                flexDirection: isMobile ? 'column' : 'row',
                                                gap: '12px'
                                            }}>
                                                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                                    <div style={{
                                                        width: '36px',
                                                        height: '36px',
                                                        borderRadius: '50%',
                                                        background: signer.status === 'signed' ? roleConfig?.color : 'transparent',
                                                        border: `3px solid ${roleConfig?.color || DESIGN.gray400}`,
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        justifyContent: 'center'
                                                    }}>
                                                        {signer.status === 'signed' ? (
                                                            <AdminIcons.Check size={18} color="white" />
                                                        ) : (
                                                            <span style={{
                                                                fontSize: '14px',
                                                                fontWeight: '600',
                                                                color: roleConfig?.color
                                                            }}>
                                                                {idx + 1}
                                                            </span>
                                                        )}
                                                    </div>
                                                    <div>
                                                        <div style={{
                                                            fontSize: DESIGN.fontSizeMetadata,
                                                            fontWeight: '600',
                                                            color: DESIGN.gray600
                                                        }}>
                                                            {signer.name}
                                                        </div>
                                                        <div style={{
                                                            fontSize: DESIGN.fontSizeCaption,
                                                            color: DESIGN.gray400,
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            gap: '8px'
                                                        }}>
                                                            <span style={{
                                                                padding: '2px 6px',
                                                                background: roleConfig?.color,
                                                                color: 'white',
                                                                borderRadius: '4px',
                                                                fontSize: '10px',
                                                                fontWeight: '600'
                                                            }}>
                                                                {roleConfig?.label || signer.role}
                                                            </span>
                                                            {signer.email && <span>{signer.email}</span>}
                                                        </div>
                                                    </div>
                                                </div>

                                                <div style={{
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '12px',
                                                    width: isMobile ? '100%' : 'auto',
                                                    justifyContent: isMobile ? 'space-between' : 'flex-end'
                                                }}>
                                                    {signer.status === 'signed' ? (
                                                        <span style={{
                                                            fontSize: DESIGN.fontSizeCaption,
                                                            color: '#16A34A',
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            gap: '4px'
                                                        }}>
                                                            <AdminIcons.CheckCircle size={14} />
                                                            Signed {formatDate(signer.signedAt)}
                                                        </span>
                                                    ) : (
                                                        <span style={{
                                                            fontSize: DESIGN.fontSizeCaption,
                                                            color: DESIGN.gray400
                                                        }}>
                                                            {isTheirTurn ? 'Awaiting signature' : 'Waiting for previous signer'}
                                                        </span>
                                                    )}

                                                    {/* Actions for pending signers */}
                                                    {isPending && isTheirTurn && (
                                                        <>
                                                            {signer.role === 'glrs' ? (
                                                                <button
                                                                    onClick={() => onSignAsGLRS(agreement)}
                                                                    style={{
                                                                        padding: '8px 16px',
                                                                        background: 'linear-gradient(135deg, #F97316 0%, #EA580C 100%)',
                                                                        border: 'none',
                                                                        borderRadius: DESIGN.radiusInput,
                                                                        color: 'white',
                                                                        fontSize: DESIGN.fontSizeCaption,
                                                                        fontWeight: '600',
                                                                        cursor: 'pointer',
                                                                        display: 'flex',
                                                                        alignItems: 'center',
                                                                        gap: '6px'
                                                                    }}
                                                                >
                                                                    <AdminIcons.Edit size={14} />
                                                                    Sign Now
                                                                </button>
                                                            ) : (
                                                                <div style={{ display: 'flex', gap: '8px' }}>
                                                                    <button
                                                                        onClick={() => onCopyLink(agreement, signer)}
                                                                        style={{
                                                                            padding: '8px 16px',
                                                                            background: DESIGN.gray100,
                                                                            border: `1px solid ${DESIGN.gray200}`,
                                                                            borderRadius: DESIGN.radiusInput,
                                                                            color: DESIGN.gray600,
                                                                            fontSize: DESIGN.fontSizeCaption,
                                                                            fontWeight: '500',
                                                                            cursor: 'pointer',
                                                                            display: 'flex',
                                                                            alignItems: 'center',
                                                                            gap: '6px'
                                                                        }}
                                                                    >
                                                                        <AdminIcons.Copy size={14} />
                                                                        Copy Link
                                                                    </button>
                                                                    {signer.email && onResendReminder && (
                                                                        <button
                                                                            onClick={async () => {
                                                                                setSendingReminder(signer.token);
                                                                                await onResendReminder(agreement, signer);
                                                                                setSendingReminder(null);
                                                                            }}
                                                                            disabled={sendingReminder === signer.token}
                                                                            style={{
                                                                                padding: '8px 16px',
                                                                                background: sendingReminder === signer.token ? DESIGN.gray200 : 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                                                                border: 'none',
                                                                                borderRadius: DESIGN.radiusInput,
                                                                                color: 'white',
                                                                                fontSize: DESIGN.fontSizeCaption,
                                                                                fontWeight: '500',
                                                                                cursor: sendingReminder === signer.token ? 'wait' : 'pointer',
                                                                                display: 'flex',
                                                                                alignItems: 'center',
                                                                                gap: '6px',
                                                                                opacity: sendingReminder === signer.token ? 0.7 : 1
                                                                            }}
                                                                        >
                                                                            <AdminIcons.Mail size={14} />
                                                                            {sendingReminder === signer.token ? 'Sending...' : 'Resend'}
                                                                        </button>
                                                                    )}
                                                                </div>
                                                            )}
                                                        </>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        {/* Audit Trail Section */}
                        <div>
                            <h4 style={{
                                margin: '0 0 16px 0',
                                fontSize: '16px',
                                fontWeight: '600',
                                color: DESIGN.gray600,
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                            }}>
                                <AdminIcons.Activity size={18} />
                                Activity Timeline
                            </h4>

                            <div style={{
                                borderLeft: `2px solid ${DESIGN.gray200}`,
                                marginLeft: '10px',
                                paddingLeft: '20px'
                            }}>
                                {agreement?.auditTrail?.slice().reverse().map((entry, idx) => {
                                    const ActionIcon = getActionIcon(entry.action);
                                    return (
                                        <div
                                            key={idx}
                                            style={{
                                                position: 'relative',
                                                paddingBottom: idx < agreement.auditTrail.length - 1 ? '20px' : 0
                                            }}
                                        >
                                            <div style={{
                                                position: 'absolute',
                                                left: '-31px',
                                                top: '0',
                                                width: '24px',
                                                height: '24px',
                                                borderRadius: '50%',
                                                background: DESIGN.bgCard,
                                                border: `2px solid ${DESIGN.gray200}`,
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center'
                                            }}>
                                                <ActionIcon size={12} color={DESIGN.gray500} />
                                            </div>
                                            <div style={{
                                                fontSize: DESIGN.fontSizeMetadata,
                                                color: DESIGN.gray600
                                            }}>
                                                <strong style={{ textTransform: 'capitalize' }}>
                                                    {entry.action.replace('_', ' ')}
                                                </strong>
                                                {' by '}
                                                {entry.actor}
                                                {entry.actorRole && (
                                                    <span style={{
                                                        marginLeft: '6px',
                                                        padding: '2px 6px',
                                                        background: SIGNER_ROLES[entry.actorRole]?.bgLight || DESIGN.gray100,
                                                        color: SIGNER_ROLES[entry.actorRole]?.color || DESIGN.gray500,
                                                        borderRadius: '4px',
                                                        fontSize: '10px',
                                                        fontWeight: '600'
                                                    }}>
                                                        {SIGNER_ROLES[entry.actorRole]?.label || entry.actorRole}
                                                    </span>
                                                )}
                                            </div>
                                            <div style={{
                                                fontSize: DESIGN.fontSizeCaption,
                                                color: DESIGN.gray400,
                                                marginTop: '2px'
                                            }}>
                                                {formatDate(entry.timestamp)}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>

                    {/* Footer */}
                    <div style={{
                        padding: isMobile ? '16px 20px' : '20px 24px',
                        borderTop: `1px solid ${DESIGN.gray200}`,
                        display: 'flex',
                        gap: '12px',
                        justifyContent: 'space-between',
                        flexWrap: 'wrap'
                    }}>
                        {agreement?.status !== 'completed' && agreement?.status !== 'voided' && (
                            <button
                                onClick={() => {
                                    if (confirm('Are you sure you want to void this agreement? This cannot be undone.')) {
                                        onVoid(agreement);
                                        onClose();
                                    }
                                }}
                                style={{
                                    padding: '10px 16px',
                                    background: 'transparent',
                                    border: '1px solid #FCA5A5',
                                    borderRadius: DESIGN.radiusInput,
                                    color: '#DC2626',
                                    fontSize: DESIGN.fontSizeMetadata,
                                    fontWeight: '500',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px'
                                }}
                            >
                                <AdminIcons.X size={16} />
                                Void Agreement
                            </button>
                        )}

                        <div style={{ display: 'flex', gap: '12px', marginLeft: 'auto' }}>
                            <button
                                onClick={async () => {
                                    if (agreement.status !== 'completed') {
                                        alert('PDF is only available for completed agreements.');
                                        return;
                                    }
                                    setDownloadingPDF(true);
                                    try {
                                        await onDownloadPDF(agreement);
                                    } finally {
                                        setDownloadingPDF(false);
                                    }
                                }}
                                disabled={downloadingPDF || agreement?.status !== 'completed'}
                                style={{
                                    padding: '10px 16px',
                                    background: agreement?.status === 'completed' ? 'linear-gradient(135deg, #22C55E 0%, #16A34A 100%)' : DESIGN.gray100,
                                    border: agreement?.status === 'completed' ? 'none' : `1px solid ${DESIGN.gray200}`,
                                    borderRadius: DESIGN.radiusInput,
                                    color: agreement?.status === 'completed' ? 'white' : DESIGN.gray400,
                                    fontSize: DESIGN.fontSizeMetadata,
                                    fontWeight: '500',
                                    cursor: agreement?.status === 'completed' ? 'pointer' : 'not-allowed',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px',
                                    opacity: downloadingPDF ? 0.7 : 1
                                }}
                            >
                                <AdminIcons.Download size={16} />
                                {downloadingPDF ? 'Generating...' : 'Download PDF'}
                            </button>
                            <button
                                onClick={onClose}
                                style={{
                                    padding: '10px 20px',
                                    background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                    border: 'none',
                                    borderRadius: DESIGN.radiusInput,
                                    color: 'white',
                                    fontSize: DESIGN.fontSizeMetadata,
                                    fontWeight: '600',
                                    cursor: 'pointer'
                                }}
                            >
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    // ==========================================
    // AGREEMENTS VIEW COMPONENT
    // ==========================================
    function AgreementsView({ user, isMobile, isTablet, onSendNew, onSignAsGLRS }) {
        const [agreements, setAgreements] = useState([]);
        const [loading, setLoading] = useState(true);
        const [filterStatus, setFilterStatus] = useState('all');
        const [selectedAgreement, setSelectedAgreement] = useState(null);
        const [showDetailModal, setShowDetailModal] = useState(false);
        const [copiedId, setCopiedId] = useState(null);

        // Load agreements with real-time listener
        useEffect(() => {
            if (!user) return;

            setLoading(true);
            const unsubscribe = db.collection('agreements')
                .where('tenantId', '==', CURRENT_TENANT)
                .orderBy('sentAt', 'desc')
                .limit(50)
                .onSnapshot(snapshot => {
                    const agreementsList = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setAgreements(agreementsList);
                    setLoading(false);
                }, error => {
                    console.error('Error loading agreements:', error);
                    setLoading(false);
                });

            return () => unsubscribe();
        }, [user]);

        // Filter agreements
        const filteredAgreements = filterStatus === 'all'
            ? agreements
            : agreements.filter(a => {
                // Check for expired
                const isExpired = a.expiresAt && a.expiresAt.toDate() < new Date();
                const effectiveStatus = isExpired && a.status !== 'completed' && a.status !== 'voided'
                    ? 'expired' : a.status;
                return effectiveStatus === filterStatus;
            });

        // Status counts
        const statusCounts = agreements.reduce((acc, a) => {
            const isExpired = a.expiresAt && a.expiresAt.toDate() < new Date();
            const effectiveStatus = isExpired && a.status !== 'completed' && a.status !== 'voided'
                ? 'expired' : a.status;
            acc[effectiveStatus] = (acc[effectiveStatus] || 0) + 1;
            return acc;
        }, {});
        statusCounts.all = agreements.length;

        // Copy signing link
        const handleCopyLink = async (agreement, signer) => {
            const link = `https://app.glrecoveryservices.com/sign.html#${signer.token}`;
            try {
                await navigator.clipboard.writeText(link);
                setCopiedId(signer.token);
                setTimeout(() => setCopiedId(null), 2000);
            } catch (err) {
                console.error('Failed to copy:', err);
            }
        };

        // Void agreement
        const handleVoid = async (agreement) => {
            try {
                await db.collection('agreements').doc(agreement.id).update({
                    status: 'voided',
                    auditTrail: firebase.firestore.FieldValue.arrayUnion({
                        timestamp: new Date().toISOString(),
                        action: 'voided',
                        actor: user.email || `${user.firstName} ${user.lastName}`,
                        actorRole: 'glrs'
                    })
                });
            } catch (error) {
                console.error('Error voiding agreement:', error);
                alert('Failed to void agreement: ' + error.message);
            }
        };

        // Resend reminder email
        const handleResendReminder = async (agreement, signer) => {
            try {
                const success = await sendSigningReminder(agreement, signer, 'gentle');
                if (success) {
                    alert(`Reminder sent to ${signer.name} (${signer.email})`);
                } else {
                    alert('Failed to send reminder. Please try again.');
                }
            } catch (error) {
                console.error('Error sending reminder:', error);
                alert('Failed to send reminder: ' + error.message);
            }
        };

        // View details
        const handleViewDetails = (agreement) => {
            setSelectedAgreement(agreement);
            setShowDetailModal(true);
        };

        // Status filter tabs
        const statusTabs = [
            { key: 'all', label: 'All' },
            { key: 'sent', label: 'Sent' },
            { key: 'partial', label: 'Partial' },
            { key: 'completed', label: 'Completed' },
            { key: 'expired', label: 'Expired' }
        ];

        return (
            <div style={{
                padding: isMobile ? '16px' : '24px',
                animation: 'fadeIn 0.3s ease-out'
            }}>
                {/* Header */}
                <div style={{
                    display: 'flex',
                    flexDirection: isMobile ? 'column' : 'row',
                    justifyContent: 'space-between',
                    alignItems: isMobile ? 'stretch' : 'center',
                    gap: '16px',
                    marginBottom: '24px'
                }}>
                    <div>
                        <h2 style={{
                            fontSize: isMobile ? '24px' : '28px',
                            fontWeight: '700',
                            color: DESIGN.gray600,
                            margin: 0
                        }}>
                            Agreements
                        </h2>
                        <p style={{
                            fontSize: DESIGN.fontSizeMetadata,
                            color: DESIGN.gray400,
                            margin: '4px 0 0 0'
                        }}>
                            {agreements.length} total agreements
                        </p>
                    </div>

                    <button
                        onClick={onSendNew}
                        style={{
                            padding: isMobile ? '14px 20px' : '12px 20px',
                            background: 'linear-gradient(135deg, #16A34A 0%, #15803D 100%)',
                            color: 'white',
                            border: 'none',
                            borderRadius: DESIGN.radiusInput,
                            fontSize: DESIGN.fontSizeMetadata,
                            fontWeight: '600',
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            gap: '8px'
                        }}
                    >
                        <AdminIcons.Send size={18} />
                        Send New Agreement
                    </button>
                </div>

                {/* Status filter tabs */}
                <div style={{
                    display: 'flex',
                    gap: '8px',
                    marginBottom: '24px',
                    overflowX: 'auto',
                    paddingBottom: '8px'
                }}>
                    {statusTabs.map(tab => {
                        const isActive = filterStatus === tab.key;
                        const count = statusCounts[tab.key] || 0;
                        const tabConfig = tab.key === 'all' ? { color: '#0077CC', bg: 'rgba(0,119,204,0.1)' } : AGREEMENT_STATUS[tab.key];

                        return (
                            <button
                                key={tab.key}
                                onClick={() => setFilterStatus(tab.key)}
                                style={{
                                    padding: '8px 16px',
                                    background: isActive ? (tabConfig?.bg || DESIGN.gray100) : DESIGN.bgCard,
                                    border: isActive ? `2px solid ${tabConfig?.color || '#0077CC'}` : `1px solid ${DESIGN.gray200}`,
                                    borderRadius: '20px',
                                    color: isActive ? (tabConfig?.color || '#0077CC') : DESIGN.gray500,
                                    fontSize: DESIGN.fontSizeCaption,
                                    fontWeight: isActive ? '600' : '500',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px',
                                    whiteSpace: 'nowrap',
                                    transition: DESIGN.transitionFast
                                }}
                            >
                                {tab.label}
                                <span style={{
                                    padding: '2px 8px',
                                    background: isActive ? 'rgba(255,255,255,0.5)' : DESIGN.gray100,
                                    borderRadius: '10px',
                                    fontSize: '11px'
                                }}>
                                    {count}
                                </span>
                            </button>
                        );
                    })}
                </div>

                {/* Loading state */}
                {loading && (
                    <div style={{ textAlign: 'center', padding: '60px' }}>
                        <div style={{
                            width: '50px', height: '50px',
                            border: '4px solid #f3f3f3',
                            borderTop: '4px solid #0077CC',
                            borderRadius: '50%',
                            animation: 'spin 1s linear infinite',
                            margin: '0 auto 20px'
                        }} />
                        <p style={{ color: DESIGN.gray400 }}>Loading agreements...</p>
                    </div>
                )}

                {/* Empty state */}
                {!loading && filteredAgreements.length === 0 && (
                    <div style={{
                        textAlign: 'center',
                        padding: '60px 20px',
                        background: DESIGN.bgCard,
                        borderRadius: DESIGN.radiusCard,
                        border: `2px dashed ${DESIGN.gray200}`
                    }}>
                        <AdminIcons.FileText size={48} color={DESIGN.gray300} />
                        <h3 style={{
                            margin: '20px 0 8px',
                            fontSize: '20px',
                            fontWeight: '600',
                            color: DESIGN.gray600
                        }}>
                            {filterStatus === 'all' ? 'No agreements yet' : `No ${filterStatus} agreements`}
                        </h3>
                        <p style={{
                            margin: '0 0 24px',
                            fontSize: DESIGN.fontSizeMetadata,
                            color: DESIGN.gray400
                        }}>
                            {filterStatus === 'all'
                                ? 'Send your first agreement to get started'
                                : `You don't have any agreements with "${filterStatus}" status`}
                        </p>
                        {filterStatus === 'all' && (
                            <button
                                onClick={onSendNew}
                                style={{
                                    padding: '12px 24px',
                                    background: 'linear-gradient(135deg, #16A34A 0%, #15803D 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: DESIGN.radiusInput,
                                    fontSize: DESIGN.fontSizeMetadata,
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    display: 'inline-flex',
                                    alignItems: 'center',
                                    gap: '8px'
                                }}
                            >
                                <AdminIcons.Send size={18} />
                                Send First Agreement
                            </button>
                        )}
                    </div>
                )}

                {/* Agreements list */}
                {!loading && filteredAgreements.length > 0 && (
                    isMobile ? (
                        // Mobile card view
                        <div>
                            {filteredAgreements.map(agreement => (
                                <AgreementRow
                                    key={agreement.id}
                                    agreement={agreement}
                                    onViewDetails={handleViewDetails}
                                    onCopyLink={handleCopyLink}
                                    onVoid={handleVoid}
                                    onSignAsGLRS={onSignAsGLRS}
                                    onDownloadPDF={downloadAgreementPDF}
                                    isMobile={true}
                                />
                            ))}
                        </div>
                    ) : (
                        // Desktop table view
                        <div style={{
                            background: DESIGN.bgCard,
                            borderRadius: DESIGN.radiusCard,
                            boxShadow: DESIGN.shadowResting,
                            overflow: 'hidden'
                        }}>
                            <table style={{
                                width: '100%',
                                borderCollapse: 'collapse'
                            }}>
                                <thead>
                                    <tr style={{
                                        background: DESIGN.gray100,
                                        borderBottom: `2px solid ${DESIGN.gray200}`
                                    }}>
                                        <th style={{
                                            padding: '14px 16px',
                                            textAlign: 'left',
                                            fontSize: DESIGN.fontSizeCaption,
                                            fontWeight: '600',
                                            color: DESIGN.gray500,
                                            textTransform: 'uppercase',
                                            letterSpacing: '0.5px'
                                        }}>
                                            Document
                                        </th>
                                        <th style={{
                                            padding: '14px 16px',
                                            textAlign: 'left',
                                            fontSize: DESIGN.fontSizeCaption,
                                            fontWeight: '600',
                                            color: DESIGN.gray500,
                                            textTransform: 'uppercase',
                                            letterSpacing: '0.5px'
                                        }}>
                                            Recipient
                                        </th>
                                        <th style={{
                                            padding: '14px 16px',
                                            textAlign: 'left',
                                            fontSize: DESIGN.fontSizeCaption,
                                            fontWeight: '600',
                                            color: DESIGN.gray500,
                                            textTransform: 'uppercase',
                                            letterSpacing: '0.5px'
                                        }}>
                                            Signers
                                        </th>
                                        <th style={{
                                            padding: '14px 16px',
                                            textAlign: 'left',
                                            fontSize: DESIGN.fontSizeCaption,
                                            fontWeight: '600',
                                            color: DESIGN.gray500,
                                            textTransform: 'uppercase',
                                            letterSpacing: '0.5px'
                                        }}>
                                            Status
                                        </th>
                                        <th style={{
                                            padding: '14px 16px',
                                            textAlign: 'left',
                                            fontSize: DESIGN.fontSizeCaption,
                                            fontWeight: '600',
                                            color: DESIGN.gray500,
                                            textTransform: 'uppercase',
                                            letterSpacing: '0.5px'
                                        }}>
                                            Sent
                                        </th>
                                        <th style={{
                                            padding: '14px 16px',
                                            textAlign: 'left',
                                            fontSize: DESIGN.fontSizeCaption,
                                            fontWeight: '600',
                                            color: DESIGN.gray500,
                                            textTransform: 'uppercase',
                                            letterSpacing: '0.5px'
                                        }}>
                                            Expires
                                        </th>
                                        <th style={{
                                            padding: '14px 16px',
                                            textAlign: 'right',
                                            fontSize: DESIGN.fontSizeCaption,
                                            fontWeight: '600',
                                            color: DESIGN.gray500,
                                            textTransform: 'uppercase',
                                            letterSpacing: '0.5px'
                                        }}>
                                            Actions
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredAgreements.map(agreement => (
                                        <AgreementRow
                                            key={agreement.id}
                                            agreement={agreement}
                                            onViewDetails={handleViewDetails}
                                            onCopyLink={handleCopyLink}
                                            onVoid={handleVoid}
                                            onSignAsGLRS={onSignAsGLRS}
                                            onDownloadPDF={downloadAgreementPDF}
                                            isMobile={false}
                                        />
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )
                )}

                {/* Agreement Detail Modal */}
                {showDetailModal && selectedAgreement && (
                    <AgreementDetailModal
                        agreement={selectedAgreement}
                        user={user}
                        onClose={() => {
                            setShowDetailModal(false);
                            setSelectedAgreement(null);
                        }}
                        onSignAsGLRS={onSignAsGLRS}
                        onCopyLink={handleCopyLink}
                        onVoid={handleVoid}
                        onResendReminder={handleResendReminder}
                        onDownloadPDF={downloadAgreementPDF}
                        isMobile={isMobile}
                    />
                )}
            </div>
        );
    }

    // ==========================================
    // TEMPLATES VIEW - Main Component
    // ==========================================
    function TemplatesView({ user, isMobile, isTablet }) {
        // State management
        const [templates, setTemplates] = useState([]);
        const [loading, setLoading] = useState(true);
        const [filterCategory, setFilterCategory] = useState('all');
        const [searchQuery, setSearchQuery] = useState('');

        // Modal states
        const [showCreateModal, setShowCreateModal] = useState(false);
        const [createModalType, setCreateModalType] = useState(null);
        const [showDetailModal, setShowDetailModal] = useState(false);
        const [selectedTemplate, setSelectedTemplate] = useState(null);
        const [showDeleteModal, setShowDeleteModal] = useState(false);
        const [templateToDelete, setTemplateToDelete] = useState(null);
        const [showEditorModal, setShowEditorModal] = useState(false);
        const [editorTemplate, setEditorTemplate] = useState(null);

        // Component editor modal states
        const [showCoverEditor, setShowCoverEditor] = useState(false);
        const [showHeaderEditor, setShowHeaderEditor] = useState(false);
        const [showFooterEditor, setShowFooterEditor] = useState(false);
        const [showEndPageEditor, setShowEndPageEditor] = useState(false);
        const [componentEditorTemplate, setComponentEditorTemplate] = useState(null);

        // Send for Signature modal states
        const [showSendModal, setShowSendModal] = useState(false);
        const [sendModalTemplate, setSendModalTemplate] = useState(null);
        const [showSuccessModal, setShowSuccessModal] = useState(false);
        const [sentAgreement, setSentAgreement] = useState(null);

        // Upload Document modal states
        const [showUploadModal, setShowUploadModal] = useState(false);
        const [showUploadedEditor, setShowUploadedEditor] = useState(false);
        const [uploadedEditorTemplate, setUploadedEditorTemplate] = useState(null);

        // Load templates from Firestore
        useEffect(() => {
            if (!user) return;

            setLoading(true);

            let query = db.collection('templates')
                .where('tenantId', '==', CURRENT_TENANT)
                .orderBy('updatedAt', 'desc');

            const unsubscribe = query.onSnapshot(
                (snapshot) => {
                    const templateData = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setTemplates(templateData);
                    setLoading(false);
                },
                (error) => {
                    console.error('Error loading templates:', error);
                    setLoading(false);
                }
            );

            return () => unsubscribe();
        }, [user]);

        // Filter templates
        const filteredTemplates = templates.filter(template => {
            const matchesCategory = filterCategory === 'all' || template.type === filterCategory;
            const matchesSearch = !searchQuery ||
                template.name.toLowerCase().includes(searchQuery.toLowerCase());
            return matchesCategory && matchesSearch;
        });

        // Count templates by type
        const typeCounts = TEMPLATE_TYPES.reduce((acc, type) => {
            if (type.key === 'all') {
                acc[type.key] = templates.length;
            } else {
                acc[type.key] = templates.filter(t => t.type === type.key).length;
            }
            return acc;
        }, {});

        // Handlers
        const handleEdit = (template) => {
            setSelectedTemplate(template);
            setShowDetailModal(true);
        };

        const handleDelete = (template) => {
            setTemplateToDelete(template);
            setShowDeleteModal(true);
        };

        const handleConfirmDelete = async () => {
            if (!templateToDelete) return;
            try {
                await db.collection('templates').doc(templateToDelete.id).delete();
                setShowDeleteModal(false);
                setTemplateToDelete(null);
                // Also close detail modal if open
                if (showDetailModal && selectedTemplate?.id === templateToDelete.id) {
                    setShowDetailModal(false);
                    setSelectedTemplate(null);
                }
            } catch (error) {
                console.error('Error deleting template:', error);
                throw error; // Re-throw to let DeleteConfirmModal handle it
            }
        };

        const handleDuplicate = async (template) => {
            try {
                const { id, createdAt, updatedAt, ...templateData } = template;
                await db.collection('templates').add({
                    ...templateData,
                    name: `${template.name} (Copy)`,
                    createdBy: user.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error('Error duplicating template:', error);
                alert('Failed to duplicate template: ' + error.message);
            }
        };

        const handleCreateNew = () => {
            setCreateModalType(null);
            setShowCreateModal(true);
        };

        const handleCreateWithType = (type) => {
            setCreateModalType(type);
            setShowCreateModal(true);
        };

        const handleCreateSuccess = (newTemplate) => {
            setShowCreateModal(false);
            setCreateModalType(null);

            // Open the appropriate editor for the new template
            if (newTemplate) {
                handleOpenComponentEditor(newTemplate);
            }
        };

        const handleUpdateSuccess = () => {
            setShowDetailModal(false);
            setSelectedTemplate(null);
        };

        const handleOpenEditor = (template) => {
            setShowDetailModal(false);
            setSelectedTemplate(null);
            setEditorTemplate(template);
            setShowEditorModal(true);
        };

        const handleEditorClose = () => {
            setShowEditorModal(false);
            setEditorTemplate(null);
        };

        const handleEditorSave = async (templateId, updatedData) => {
            try {
                await db.collection('templates').doc(templateId).update({
                    ...updatedData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: user.uid
                });
                return true;
            } catch (error) {
                console.error('Error saving template:', error);
                throw error;
            }
        };

        // Open component editor based on template type
        const handleOpenComponentEditor = (template) => {
            setShowDetailModal(false);
            setSelectedTemplate(null);
            setComponentEditorTemplate(template);

            switch (template.type) {
                case 'cover':
                    setShowCoverEditor(true);
                    break;
                case 'header':
                    setShowHeaderEditor(true);
                    break;
                case 'footer':
                    setShowFooterEditor(true);
                    break;
                case 'endPage':
                    setShowEndPageEditor(true);
                    break;
                case 'uploaded':
                    // For uploaded documents, use the uploaded document editor
                    setUploadedEditorTemplate(template);
                    setShowUploadedEditor(true);
                    break;
                case 'document':
                default:
                    // For documents, use the block editor
                    setEditorTemplate(template);
                    setShowEditorModal(true);
                    break;
            }
        };

        const handleComponentEditorClose = () => {
            setShowCoverEditor(false);
            setShowHeaderEditor(false);
            setShowFooterEditor(false);
            setShowEndPageEditor(false);
            setShowUploadedEditor(false);
            setUploadedEditorTemplate(null);
            setComponentEditorTemplate(null);
        };

        const handleComponentEditorSave = async (templateId, updatedData) => {
            try {
                await db.collection('templates').doc(templateId).update({
                    ...updatedData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: user.uid
                });
                return true;
            } catch (error) {
                console.error('Error saving component:', error);
                throw error;
            }
        };

        // Send for Signature handlers
        const handleSendForSignature = (template = null) => {
            setShowDetailModal(false);
            setSelectedTemplate(null);
            setSendModalTemplate(template);
            setShowSendModal(true);
        };

        const handleSendSuccess = (agreement) => {
            setShowSendModal(false);
            setSendModalTemplate(null);
            setSentAgreement(agreement);
            setShowSuccessModal(true);
        };

        const handleSuccessClose = () => {
            setShowSuccessModal(false);
            setSentAgreement(null);
        };

        return (
            <div style={{
                padding: isMobile ? '16px' : '24px',
                animation: 'fadeIn 0.3s ease-out',
                minHeight: '100%'
            }}>
                {/* Header with title and create button */}
                <div style={{
                    display: 'flex',
                    flexDirection: isMobile ? 'column' : 'row',
                    justifyContent: 'space-between',
                    alignItems: isMobile ? 'stretch' : 'center',
                    gap: '16px',
                    marginBottom: DESIGN.sectionSpacing
                }}>
                    <div>
                        <h1 style={{
                            fontSize: isMobile ? '24px' : '30px',
                            fontWeight: '700',
                            color: DESIGN.gray600,
                            margin: 0
                        }}>
                            Template Library
                        </h1>
                        <p style={{
                            fontSize: DESIGN.fontSizeMetadata,
                            color: DESIGN.gray400,
                            margin: '4px 0 0 0'
                        }}>
                            Create and manage reusable document components
                        </p>
                    </div>

                    {/* Action buttons */}
                    <div style={{
                        display: 'flex',
                        gap: '12px',
                        flexWrap: isMobile ? 'wrap' : 'nowrap'
                    }}>
                        {/* Send Agreement button */}
                        <button
                            onClick={() => handleSendForSignature(null)}
                            style={{
                                padding: isMobile ? '14px 20px' : '12px 20px',
                                background: 'linear-gradient(135deg, #16A34A 0%, #15803D 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: DESIGN.radiusInput,
                                fontSize: DESIGN.fontSizeMetadata,
                                fontWeight: '600',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '8px',
                                transition: DESIGN.transitionStandard,
                                whiteSpace: 'nowrap',
                                flex: isMobile ? '1' : 'none'
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.transform = 'translateY(-2px)';
                                e.currentTarget.style.boxShadow = DESIGN.shadowHover;
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.transform = 'translateY(0)';
                                e.currentTarget.style.boxShadow = 'none';
                            }}
                        >
                            <AdminIcons.Send size={18} />
                            Send Agreement
                        </button>

                        {/* Create template button */}
                        {window.canPerformAction && window.canPerformAction(user, 'create_template') !== false && (
                            <React.Fragment>
                                {/* Upload Document Button */}
                                <button
                                    onClick={() => setShowUploadModal(true)}
                                    style={{
                                        padding: isMobile ? '14px 20px' : '12px 20px',
                                        background: 'white',
                                        color: DESIGN.primary,
                                        border: `2px solid ${DESIGN.primary}`,
                                        borderRadius: DESIGN.radiusInput,
                                        fontSize: DESIGN.fontSizeMetadata,
                                        fontWeight: '600',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        gap: '8px',
                                        transition: DESIGN.transitionStandard,
                                        whiteSpace: 'nowrap',
                                        flex: isMobile ? '1' : 'none'
                                    }}
                                    onMouseEnter={(e) => {
                                        e.currentTarget.style.background = DESIGN.gray50;
                                    }}
                                    onMouseLeave={(e) => {
                                        e.currentTarget.style.background = 'white';
                                    }}
                                >
                                    <AdminIcons.Upload size={18} />
                                    Upload PDF
                                </button>
                                {/* New Template Button */}
                                <button
                                    onClick={handleCreateNew}
                                    style={{
                                        padding: isMobile ? '14px 20px' : '12px 20px',
                                        background: 'linear-gradient(135deg, #0077CC 0%, #005A9C 100%)',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: DESIGN.radiusInput,
                                        fontSize: DESIGN.fontSizeMetadata,
                                        fontWeight: '600',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        gap: '8px',
                                        transition: DESIGN.transitionStandard,
                                        whiteSpace: 'nowrap',
                                        flex: isMobile ? '1' : 'none'
                                    }}
                                    onMouseEnter={(e) => {
                                        e.currentTarget.style.transform = 'translateY(-2px)';
                                        e.currentTarget.style.boxShadow = DESIGN.shadowHover;
                                    }}
                                    onMouseLeave={(e) => {
                                        e.currentTarget.style.transform = 'translateY(0)';
                                        e.currentTarget.style.boxShadow = 'none';
                                    }}
                                >
                                    <AdminIcons.Plus size={18} />
                                    New Template
                                </button>
                            </React.Fragment>
                        )}
                    </div>
                </div>

                {/* Filter tabs */}
                <div style={{
                    display: 'flex',
                    gap: isMobile ? '8px' : '12px',
                    marginBottom: '24px',
                    overflowX: 'auto',
                    paddingBottom: '8px',
                    WebkitOverflowScrolling: 'touch'
                }}>
                    {TEMPLATE_TYPES.map(type => {
                        const Icon = type.icon;
                        const isActive = filterCategory === type.key;
                        const count = typeCounts[type.key] || 0;

                        return (
                            <button
                                key={type.key}
                                onClick={() => setFilterCategory(type.key)}
                                style={{
                                    padding: isMobile ? '10px 14px' : '10px 16px',
                                    background: isActive ? '#0077CC' : DESIGN.bgCard,
                                    color: isActive ? 'white' : DESIGN.gray500,
                                    border: isActive ? 'none' : `1px solid ${DESIGN.gray200}`,
                                    borderRadius: '20px',
                                    fontSize: isMobile ? '13px' : DESIGN.fontSizeMetadata,
                                    fontWeight: '500',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px',
                                    transition: DESIGN.transitionFast,
                                    whiteSpace: 'nowrap',
                                    flexShrink: 0
                                }}
                            >
                                <Icon size={16} />
                                {!isMobile && type.label}
                                {isMobile && type.key === 'all' && 'All'}
                                <span style={{
                                    background: isActive ? 'rgba(255,255,255,0.2)' : DESIGN.gray100,
                                    padding: '2px 8px',
                                    borderRadius: '10px',
                                    fontSize: DESIGN.fontSizeCaption
                                }}>
                                    {count}
                                </span>
                            </button>
                        );
                    })}
                </div>

                {/* Search bar (for filtered views) */}
                {templates.length > 0 && (
                    <div style={{ marginBottom: '24px' }}>
                        <div style={{
                            position: 'relative',
                            maxWidth: isMobile ? '100%' : '320px'
                        }}>
                            <AdminIcons.Search
                                size={18}
                                color={DESIGN.gray400}
                                style={{
                                    position: 'absolute',
                                    left: '12px',
                                    top: '50%',
                                    transform: 'translateY(-50%)'
                                }}
                            />
                            <input
                                type="text"
                                placeholder="Search templates..."
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                style={{
                                    width: '100%',
                                    padding: '10px 12px 10px 40px',
                                    border: `1px solid ${DESIGN.gray200}`,
                                    borderRadius: DESIGN.radiusInput,
                                    fontSize: DESIGN.fontSizeMetadata,
                                    outline: 'none',
                                    transition: DESIGN.transitionFast
                                }}
                                onFocus={(e) => {
                                    e.target.style.borderColor = '#0077CC';
                                    e.target.style.boxShadow = '0 0 0 3px rgba(0,119,204,0.1)';
                                }}
                                onBlur={(e) => {
                                    e.target.style.borderColor = DESIGN.gray200;
                                    e.target.style.boxShadow = 'none';
                                }}
                            />
                        </div>
                    </div>
                )}

                {/* Loading state - skeleton cards */}
                {loading && (
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: isMobile
                            ? '1fr'
                            : isTablet
                                ? 'repeat(2, 1fr)'
                                : 'repeat(auto-fill, minmax(280px, 1fr))',
                        gap: DESIGN.gridGap
                    }}>
                        {[1, 2, 3, 4, 5, 6].map(i => (
                            <SkeletonCard key={i} />
                        ))}
                    </div>
                )}

                {/* Empty state */}
                {!loading && filteredTemplates.length === 0 && (
                    <EmptyState
                        filterCategory={filterCategory}
                        onCreateNew={handleCreateNew}
                        isMobile={isMobile}
                    />
                )}

                {/* Template grid */}
                {!loading && filteredTemplates.length > 0 && (
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: isMobile
                            ? '1fr'
                            : isTablet
                                ? 'repeat(2, 1fr)'
                                : 'repeat(auto-fill, minmax(280px, 1fr))',
                        gap: DESIGN.gridGap
                    }}>
                        {filteredTemplates.map(template => (
                            <TemplateCard
                                key={template.id}
                                template={template}
                                onEdit={handleEdit}
                                onDelete={handleDelete}
                                onDuplicate={handleDuplicate}
                                onSend={handleSendForSignature}
                                isMobile={isMobile}
                            />
                        ))}
                    </div>
                )}

                {/* Create Template Modal */}
                {showCreateModal && (
                    <TemplateCreateModal
                        user={user}
                        preselectedType={createModalType}
                        onClose={() => {
                            setShowCreateModal(false);
                            setCreateModalType(null);
                        }}
                        onSuccess={handleCreateSuccess}
                        isMobile={isMobile}
                    />
                )}

                {/* Template Detail Modal */}
                {showDetailModal && selectedTemplate && (
                    <TemplateDetailModal
                        template={selectedTemplate}
                        user={user}
                        onClose={() => {
                            setShowDetailModal(false);
                            setSelectedTemplate(null);
                        }}
                        onUpdate={handleUpdateSuccess}
                        onDelete={() => {
                            setTemplateToDelete(selectedTemplate);
                            setShowDeleteModal(true);
                        }}
                        onOpenEditor={handleOpenComponentEditor}
                        onSend={handleSendForSignature}
                        isMobile={isMobile}
                    />
                )}

                {/* Delete Confirmation Modal */}
                {showDeleteModal && templateToDelete && (
                    <DeleteConfirmModal
                        template={templateToDelete}
                        onConfirm={handleConfirmDelete}
                        onCancel={() => {
                            setShowDeleteModal(false);
                            setTemplateToDelete(null);
                        }}
                        isMobile={isMobile}
                    />
                )}

                {/* Template Editor Modal (Block-Based Content Editor) */}
                {showEditorModal && editorTemplate && (
                    <TemplateEditorModal
                        template={editorTemplate}
                        user={user}
                        onClose={handleEditorClose}
                        onSave={handleEditorSave}
                        isMobile={isMobile}
                        isTablet={isTablet}
                    />
                )}

                {/* Component Editor Modals */}
                {showCoverEditor && componentEditorTemplate && (
                    <CoverPageEditorModal
                        template={componentEditorTemplate}
                        user={user}
                        onClose={handleComponentEditorClose}
                        onSave={handleComponentEditorSave}
                        isMobile={isMobile}
                    />
                )}

                {showHeaderEditor && componentEditorTemplate && (
                    <HeaderEditorModal
                        template={componentEditorTemplate}
                        user={user}
                        onClose={handleComponentEditorClose}
                        onSave={handleComponentEditorSave}
                        isMobile={isMobile}
                    />
                )}

                {showFooterEditor && componentEditorTemplate && (
                    <FooterEditorModal
                        template={componentEditorTemplate}
                        user={user}
                        onClose={handleComponentEditorClose}
                        onSave={handleComponentEditorSave}
                        isMobile={isMobile}
                    />
                )}

                {showEndPageEditor && componentEditorTemplate && (
                    <EndPageEditorModal
                        template={componentEditorTemplate}
                        user={user}
                        onClose={handleComponentEditorClose}
                        onSave={handleComponentEditorSave}
                        isMobile={isMobile}
                    />
                )}

                {/* Send for Signature Modal */}
                {showSendModal && (
                    <SendForSignatureModal
                        template={sendModalTemplate}
                        user={user}
                        onClose={() => {
                            setShowSendModal(false);
                            setSendModalTemplate(null);
                        }}
                        onSuccess={handleSendSuccess}
                        isMobile={isMobile}
                    />
                )}

                {/* Send Success Modal */}
                {showSuccessModal && sentAgreement && (
                    <SendSuccessModal
                        agreement={sentAgreement}
                        onClose={handleSuccessClose}
                        isMobile={isMobile}
                    />
                )}

                {/* Upload Document Modal */}
                {showUploadModal && (
                    <UploadDocumentModal
                        user={user}
                        onClose={() => setShowUploadModal(false)}
                        onUploadComplete={(newTemplate) => {
                            setShowUploadModal(false);
                            // Open the uploaded document editor to add signature fields
                            setUploadedEditorTemplate(newTemplate);
                            setShowUploadedEditor(true);
                        }}
                    />
                )}

                {/* Uploaded Document Editor (for adding signature fields to uploaded PDFs) */}
                {showUploadedEditor && uploadedEditorTemplate && (
                    <UploadedDocumentEditor
                        template={uploadedEditorTemplate}
                        user={user}
                        onClose={() => {
                            setShowUploadedEditor(false);
                            setUploadedEditorTemplate(null);
                        }}
                        onSave={(updatedTemplate) => {
                            setShowUploadedEditor(false);
                            setUploadedEditorTemplate(null);
                            // Template is already saved - just close
                        }}
                    />
                )}
            </div>
        );
    }

    // ==========================================
    // MAIN APP
    // ==========================================
    function App() {
        const [user, setUser] = useState(null);
        const [loading, setLoading] = useState(true);
        const [searchQuery, setSearchQuery] = useState('');
        const [sidebarCollapsed, setSidebarCollapsed] = useState(() => {
            return window.getPreference ? window.getPreference('sidebarCollapsed', false) : false;
        });

        // Active view (templates or agreements)
        const [activeView, setActiveView] = useState(() => {
            const hash = window.location.hash.replace('#', '');
            return hash === 'agreements' ? 'agreements' : 'templates';
        });

        // GLRS Signing modal state
        const [showGLRSSigningModal, setShowGLRSSigningModal] = useState(false);
        const [signingAgreement, setSigningAgreement] = useState(null);

        // Send for Signature modal state (for opening from Agreements view)
        const [showSendModalFromAgreements, setShowSendModalFromAgreements] = useState(false);

        // Responsive states
        const [isMobile, setIsMobile] = useState(window.innerWidth < 600);
        const [isTablet, setIsTablet] = useState(window.innerWidth >= 600 && window.innerWidth < 1024);
        const [showBottomNav, setShowBottomNav] = useState(window.innerWidth < 1024);

        const handleSidebarCollapse = (collapsed) => {
            setSidebarCollapsed(collapsed);
            if (window.savePreference) window.savePreference('sidebarCollapsed', collapsed);
        };

        // Update URL hash when view changes
        const handleViewChange = (view) => {
            setActiveView(view);
            window.location.hash = view === 'agreements' ? 'agreements' : '';
        };

        // Handle GLRS signing
        const handleSignAsGLRS = (agreement) => {
            setSigningAgreement(agreement);
            setShowGLRSSigningModal(true);
        };

        const handleGLRSSigningComplete = () => {
            setShowGLRSSigningModal(false);
            setSigningAgreement(null);
        };

        useEffect(() => {
            const unsubscribe = auth.onAuthStateChanged(async (firebaseUser) => {
                if (firebaseUser) {
                    const userDoc = await db.collection('users').doc(firebaseUser.uid).get();
                    if (userDoc.exists) {
                        const userData = { uid: firebaseUser.uid, ...userDoc.data() };

                        // Check page access
                        if (!window.canAccessPage(userData, 'templates')) {
                            window.location.href = '/admin/dashboard.html';
                            return;
                        }

                        setUser(userData);
                    }
                } else {
                    window.location.href = '/admin/index.html';
                }
                setLoading(false);
            });
            return () => unsubscribe();
        }, []);

        // Handle responsive resize
        useEffect(() => {
            const handleResize = () => {
                const width = window.innerWidth;
                setIsMobile(width < 600);
                setIsTablet(width >= 600 && width < 1024);
                setShowBottomNav(width < 1024);
            };
            window.addEventListener('resize', handleResize);
            return () => window.removeEventListener('resize', handleResize);
        }, []);

        if (loading) {
            return (
                <div style={{
                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                    minHeight: '100vh', background: '#f5f7fa'
                }}>
                    <div style={{ textAlign: 'center' }}>
                        <div style={{
                            width: '60px', height: '60px',
                            border: '4px solid #f3f3f3', borderTop: '4px solid #0077CC',
                            borderRadius: '50%', animation: 'spin 1s linear infinite',
                            margin: '0 auto 20px'
                        }}></div>
                        <div style={{ color: '#666' }}>Loading...</div>
                    </div>
                </div>
            );
        }

        return (
            <div style={{ display: 'flex', minHeight: '100vh', background: '#f5f7fa' }}>
                <Sidebar
                    activePage="templates"
                    user={user}
                    collapsed={sidebarCollapsed}
                    onCollapsedChange={handleSidebarCollapse}
                />
                <div style={{
                    flex: 1,
                    marginLeft: showBottomNav ? 0 : (sidebarCollapsed ? '80px' : '280px'),
                    width: showBottomNav ? '100%' : 'auto',
                    paddingBottom: showBottomNav ? '72px' : 0,
                    display: 'flex',
                    flexDirection: 'column',
                    transition: 'margin-left 0.3s ease'
                }}>
                    <Header
                        title="Templates & Agreements"
                        searchQuery={searchQuery}
                        onSearchChange={setSearchQuery}
                        user={user}
                    />

                    {/* View Toggle Tabs */}
                    <div style={{
                        padding: isMobile ? '12px 16px' : '16px 24px',
                        background: DESIGN.bgCard,
                        borderBottom: `1px solid ${DESIGN.gray200}`,
                        display: 'flex',
                        gap: '8px'
                    }}>
                        <button
                            onClick={() => handleViewChange('templates')}
                            style={{
                                padding: isMobile ? '10px 16px' : '10px 20px',
                                background: activeView === 'templates' ? 'linear-gradient(135deg, #0077CC 0%, #005A9C 100%)' : 'transparent',
                                color: activeView === 'templates' ? 'white' : DESIGN.gray500,
                                border: activeView === 'templates' ? 'none' : `1px solid ${DESIGN.gray200}`,
                                borderRadius: DESIGN.radiusInput,
                                fontSize: DESIGN.fontSizeMetadata,
                                fontWeight: '600',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px',
                                transition: DESIGN.transitionFast
                            }}
                        >
                            <AdminIcons.FileText size={18} />
                            Templates
                        </button>
                        <button
                            onClick={() => handleViewChange('agreements')}
                            style={{
                                padding: isMobile ? '10px 16px' : '10px 20px',
                                background: activeView === 'agreements' ? 'linear-gradient(135deg, #0077CC 0%, #005A9C 100%)' : 'transparent',
                                color: activeView === 'agreements' ? 'white' : DESIGN.gray500,
                                border: activeView === 'agreements' ? 'none' : `1px solid ${DESIGN.gray200}`,
                                borderRadius: DESIGN.radiusInput,
                                fontSize: DESIGN.fontSizeMetadata,
                                fontWeight: '600',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px',
                                transition: DESIGN.transitionFast
                            }}
                        >
                            <AdminIcons.ClipboardList size={18} />
                            Agreements
                        </button>
                    </div>

                    <main style={{ flex: 1, overflow: 'auto' }}>
                        {activeView === 'templates' ? (
                            <TemplatesView user={user} isMobile={isMobile} isTablet={isTablet} />
                        ) : (
                            <AgreementsView
                                user={user}
                                isMobile={isMobile}
                                isTablet={isTablet}
                                onSendNew={() => setShowSendModalFromAgreements(true)}
                                onSignAsGLRS={handleSignAsGLRS}
                            />
                        )}
                    </main>
                </div>

                {/* GLRS Signing Modal */}
                {showGLRSSigningModal && signingAgreement && (
                    <GLRSSigningModal
                        agreement={signingAgreement}
                        user={user}
                        onClose={() => {
                            setShowGLRSSigningModal(false);
                            setSigningAgreement(null);
                        }}
                        onComplete={handleGLRSSigningComplete}
                        isMobile={isMobile}
                    />
                )}

                {/* Send for Signature Modal (from Agreements view) */}
                {showSendModalFromAgreements && (
                    <SendForSignatureModal
                        template={null}
                        user={user}
                        onClose={() => setShowSendModalFromAgreements(false)}
                        onSuccess={(agreement) => {
                            setShowSendModalFromAgreements(false);
                            // Could show success modal here if desired
                        }}
                        isMobile={isMobile}
                    />
                )}
            </div>
        );
    }

    // Render
    ReactDOM.render(<App />, document.getElementById('root'));

})();
    </script>

    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
</body>
</html>
