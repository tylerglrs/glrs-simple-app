<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My PIRs - GLRS Admin</title>

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ¯</text></svg>">

    <!-- Shared Styles -->
    <link rel="stylesheet" href="/admin/shared/styles.css">

    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

    <!-- Google Identity Services for Calendar Integration -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <div id="root"></div>

    <!-- Shared Components -->
    <script src="/admin/shared/firebase.js"></script>
    <script src="/admin/shared/auth.js"></script>
    <script src="/admin/shared/utils.js"></script>
    <script src="/admin/shared/state.js"></script>
    <script src="/admin/shared/navigation.js"></script>

    <script type="text/babel">
        // Wait for Firebase to initialize before running
(function initPage() {
    if (!window.FIREBASE_READY || !window.auth || !window.db) {
        console.log('Waiting for Firebase to initialize...');
        setTimeout(initPage, 50);
        return;
    }

    const { useState, useEffect, useRef, useMemo, useCallback } = React;
    const { auth, db, storage, CURRENT_TENANT, logAudit } = window;

        // ==========================================
        // TODO: ADD USER DETAIL MODAL
        // ==========================================
        // UserDetailModal component (admin.html lines 32839-37711, ~4,872 lines)
        // needs to be added here for full PIR detail functionality
        // ==========================================

        // Temporary UserDetailModal stub
        function UserDetailModal({ user, onClose, onUpdate, currentUserId }) {
            return (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0, 0, 0, 0.5)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1000
                }}>
                    <div style={{
                        background: 'white',
                        borderRadius: '12px',
                        padding: '30px',
                        maxWidth: '500px'
                    }}>
                        <h2>PIR Detail Modal</h2>
                        <p>UserDetailModal component (~4,872 lines) needs to be added.</p>
                        <p>Location: admin.html lines 32839-37711</p>
                        <p>PIR: {user.displayName || user.email}</p>
                        <button
                            onClick={onClose}
                            style={{
                                padding: '10px 20px',
                                background: 'var(--primary-color)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '6px',
                                cursor: 'pointer',
                                marginTop: '20px'
                            }}
                        >
                            Close
                        </button>
                    </div>
                </div>
            );
        }

        // ==========================================
        // PIR NOTES MODAL (Lines 6422-6535 from admin.html)
        // ==========================================
        function PIRNotesModal({ pir, existingNotes, onClose, onSave }) {
            const [notes, setNotes] = useState(existingNotes);

            return (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0, 0, 0, 0.5)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1000,
                    padding: '20px',
                    animation: 'fadeIn 0.2s'
                }}>
                    <div style={{
                        background: 'white',
                        borderRadius: '20px',
                        maxWidth: '600px',
                        width: '100%',
                        boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
                        animation: 'slideUp 0.3s'
                    }}>
                        {/* Header */}
                        <div style={{
                            background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                            padding: '25px 30px',
                            borderRadius: '20px 20px 0 0',
                            color: 'white'
                        }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <h2 style={{ margin: 0, fontSize: '24px' }}>
                                    Notes for {pir.displayName || pir.email}
                                </h2>
                                <button
                                    onClick={onClose}
                                    style={{
                                        background: 'rgba(255,255,255,0.2)',
                                        border: 'none',
                                        color: 'white',
                                        fontSize: '24px',
                                        width: '36px',
                                        height: '36px',
                                        borderRadius: '50%',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center'
                                    }}
                                >
                                    Ã—
                                </button>
                            </div>
                        </div>

                        {/* Content */}
                        <div style={{ padding: '30px' }}>
                            <textarea
                                value={notes}
                                onChange={(e) => setNotes(e.target.value)}
                                placeholder="Add private notes about this PIR..."
                                style={{
                                    width: '100%',
                                    minHeight: '200px',
                                    padding: '15px',
                                    border: '2px solid #e0e0e0',
                                    borderRadius: '10px',
                                    fontSize: '14px',
                                    fontFamily: 'inherit',
                                    resize: 'vertical',
                                    marginBottom: '20px'
                                }}
                            />

                            <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                                <button
                                    onClick={onClose}
                                    style={{
                                        padding: '12px 24px',
                                        background: '#6c757d',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '8px',
                                        cursor: 'pointer',
                                        fontSize: '14px',
                                        fontWeight: '500'
                                    }}
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={() => onSave(notes)}
                                    style={{
                                        padding: '12px 24px',
                                        background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '8px',
                                        cursor: 'pointer',
                                        fontSize: '14px',
                                        fontWeight: '500'
                                    }}
                                >
                                    Save Notes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // ==========================================
        // GOOGLE CALENDAR HELPER FUNCTIONS
        // ==========================================

        // AUTO-REFRESH: Silently refresh Google token if expired
const refreshGoogleToken = async () => {
    return new Promise((resolve, reject) => {
        try {
            console.log('Attempting to refresh Google token...');

            // Check if Google Identity Services is loaded
            if (typeof google === 'undefined' || !google.accounts) {
                reject(new Error('Google Identity Services not loaded'));
                return;
            }

            // Use token client to get new token silently
            const tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: '457406864879-k1sunucuqofe22m5rg93hvo6nngiqh0u.apps.googleusercontent.com',
                scope: [
                    'https://www.googleapis.com/auth/calendar.events',
                    'https://www.googleapis.com/auth/drive.file',
                    'https://www.googleapis.com/auth/gmail.send'
                ].join(' '),
                callback: async (tokenResponse) => {
                    try {
                        if (tokenResponse.error) {
                            reject(new Error(tokenResponse.error));
                            return;
                        }

                        if (tokenResponse.access_token) {
                            // Update Firebase with new token
                            await db.collection('users').doc(user.uid).update({
                                googleAccessToken: tokenResponse.access_token,
                                googleTokenExpiry: Date.now() + (tokenResponse.expires_in * 1000),
                                googleTokenRefreshedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });

                            console.log('âœ“ Token refreshed successfully');

                            // Update local user object
                            user.googleAccessToken = tokenResponse.access_token;
                            user.googleTokenExpiry = Date.now() + (tokenResponse.expires_in * 1000);

                            resolve(tokenResponse.access_token);
                        } else {
                            reject(new Error('No access token received'));
                        }
                    } catch (error) {
                        reject(error);
                    }
                },
            });

            // Request new token (will try silently first with prompt: '')
            tokenClient.requestAccessToken({ prompt: '' });

        } catch (error) {
            console.error('Failed to refresh token:', error);
            reject(error);
        }
    });
};

// Check if Google token is valid and auto-refresh if needed
const checkGoogleToken = async () => {
    // Check if user has Google connected
    if (!user.googleConnected || !user.googleAccessToken) {
        return {
            valid: false,
            error: 'Google Services not connected. Please connect Google in your Profile settings.'
        };
    }

    // Check if token is expired
    if (user.googleTokenExpiry) {
        const now = Date.now();
        const expiryTime = user.googleTokenExpiry;
        const fiveMinutes = 5 * 60 * 1000;

        if (now >= expiryTime - fiveMinutes) {
            // Token expired - try to refresh automatically
            try {
                console.log('âš ï¸ Token expired, attempting auto-refresh...');
                await refreshGoogleToken();
                console.log('âœ“ Token auto-refreshed successfully');
                return { valid: true };
            } catch (refreshError) {
                console.error('âŒ Auto-refresh failed:', refreshError);
                return {
                    valid: false,
                    error: 'Google token expired and could not be refreshed automatically.\n\nPlease:\n1. Go to Profile\n2. Click "Disconnect Google Services"\n3. Click "Connect Google Services" again\n\nThen try scheduling the meeting again.'
                };
            }
        }
    }

    return { valid: true };
};

// UPDATED: Simplified milestone calculation with calendar-based logic
const getRecoveryMilestones = (sobrietyDate) => {
    if (!sobrietyDate) return [];

    // Parse sobriety date in LOCAL timezone (Pacific)
    let startYear, startMonth, startDay;

    if (typeof sobrietyDate === 'string' && sobrietyDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
        [startYear, startMonth, startDay] = sobrietyDate.split('-').map(Number);
    } else if (sobrietyDate.toDate) {
        const d = sobrietyDate.toDate();
        startYear = d.getFullYear();
        startMonth = d.getMonth() + 1;
        startDay = d.getDate();
    } else if (sobrietyDate.seconds) {
        const d = new Date(sobrietyDate.seconds * 1000);
        startYear = d.getFullYear();
        startMonth = d.getMonth() + 1;
        startDay = d.getDate();
    } else {
        const d = new Date(sobrietyDate);
        startYear = d.getFullYear();
        startMonth = d.getMonth() + 1;
        startDay = d.getDate();
    }

    const startDate = new Date(startYear, startMonth - 1, startDay, 0, 0, 0, 0);
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // Calculate current days sober (matching calculateSobrietyDaysFixed logic with +2)
    const daysSober = Math.floor((today - startDate) / (1000 * 60 * 60 * 24)) + 2;

    const milestones = [];

    // DAY-BASED MILESTONES (count exact days)
    const dayBased = [
        { days: 1, title: '24 Hours Clean', icon: 'ðŸŒŸ' },
        { days: 7, title: '1 Week Clean', icon: 'ðŸ“…' },
        { days: 30, title: '1 Month Clean', icon: 'ðŸ†' },
        { days: 60, title: '2 Months Clean', icon: 'ðŸ’ª' },
        { days: 90, title: '3 Months Clean', icon: 'ðŸŽ¯' },
        { days: 100, title: '100 Days Clean', icon: 'ðŸ’¯' },
        { days: 200, title: '200 Days Clean', icon: 'âœ¨' },
        { days: 500, title: '500 Days Clean', icon: 'ðŸ†' },
        { days: 1000, title: '1000 Days Clean', icon: 'ðŸ…' }
    ];

    dayBased.forEach(milestone => {
        const targetDate = new Date(startDate);
        targetDate.setDate(targetDate.getDate() + milestone.days - 1);

        milestones.push({
            ...milestone,
            date: targetDate,
            targetDate: targetDate,
            achieved: daysSober >= milestone.days,
            isToday: daysSober === milestone.days,
            isTomorrow: daysSober === (milestone.days - 1),
            daysUntil: milestone.days - daysSober,
            type: 'recovery'
        });
    });

    // MONTHLY MILESTONES (same day of month)
    const monthBased = [
        { months: 4, title: '4 Months Clean', icon: 'â­' },
        { months: 5, title: '5 Months Clean', icon: 'ðŸŒˆ' },
        { months: 6, title: '6 Months Clean', icon: 'ðŸŽ‰' },
        { months: 7, title: '7 Months Clean', icon: 'ðŸŒŸ' },
        { months: 8, title: '8 Months Clean', icon: 'ðŸ…' },
        { months: 9, title: '9 Months Clean', icon: 'ðŸ’Ž' },
        { months: 10, title: '10 Months Clean', icon: 'ðŸŒº' },
        { months: 11, title: '11 Months Clean', icon: 'ðŸŽŠ' },
        { months: 12, title: '1 Year Clean', icon: 'ðŸŽ‚' },
        { months: 18, title: '18 Months Clean', icon: 'ðŸŒŸ' }
    ];

    monthBased.forEach(milestone => {
        const targetDate = new Date(startYear, (startMonth - 1) + milestone.months, startDay, 0, 0, 0, 0);
        const approxDays = Math.floor((targetDate - startDate) / (1000 * 60 * 60 * 24)) + 2;

        milestones.push({
            days: approxDays,
            title: milestone.title,
            icon: milestone.icon,
            date: targetDate,
            targetDate: targetDate,
            achieved: today >= targetDate,
            isToday: today.toDateString() === targetDate.toDateString(),
            isTomorrow: false,
            daysUntil: Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24)),
            type: 'recovery'
        });
    });

    // YEARLY MILESTONES (same month & day every year)
    const yearBased = [
        { years: 2, title: '2 Years Clean', icon: 'ðŸŽˆ' },
        { years: 3, title: '3 Years Clean', icon: 'ðŸŽ‰' },
        { years: 4, title: '4 Years Clean', icon: 'ðŸŒŸ' },
        { years: 5, title: '5 Years Clean', icon: 'ðŸ’«' }
    ];

    // Add 6-20 years dynamically
    for (let year = 6; year <= 20; year++) {
        yearBased.push({
            years: year,
            title: `${year} Years Clean`,
            icon: 'ðŸŒŸ'
        });
    }

    yearBased.forEach(milestone => {
        const targetDate = new Date(startYear + milestone.years, startMonth - 1, startDay, 0, 0, 0, 0);
        const approxDays = Math.floor((targetDate - startDate) / (1000 * 60 * 60 * 24)) + 2;

        milestones.push({
            days: approxDays,
            title: milestone.title,
            icon: milestone.icon,
            date: targetDate,
            targetDate: targetDate,
            achieved: today >= targetDate,
            isToday: today.toDateString() === targetDate.toDateString(),
            isTomorrow: false,
            daysUntil: Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24)),
            type: 'recovery'
        });
    });

    // Sort by target date
    milestones.sort((a, b) => a.targetDate - b.targetDate);

    return milestones;
};

// DELETE: Remove PIR's milestone events from Google Calendar
const deletePIRMilestones = async (pirId) => {
    try {
        // Check token first
        const tokenCheck = await checkGoogleToken();
        if (!tokenCheck.valid) {
            console.error('Cannot delete milestones - invalid token');
            return false;
        }

        const validToken = user.googleAccessToken;

        // Get stored milestone events from Firestore
        const pirDoc = await db.collection('users').doc(pirId).get();
        const events = pirDoc.data()?.milestoneCalendarEvents || [];

        if (events.length === 0) {
            console.log('No milestone events to delete');
            return true;
        }

        console.log(`Deleting ${events.length} milestone events...`);

        let successCount = 0;
        let failCount = 0;

        for (const event of events) {
            try {
                const response = await fetch(
                    `https://www.googleapis.com/calendar/v3/calendars/primary/events/${event.eventId}`,
                    {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${validToken}`
                        }
                    }
                );

                if (response.ok || response.status === 404) {
                    successCount++;
                    console.log(`âœ“ Deleted: ${event.eventId}`);
                } else {
                    failCount++;
                    console.error(`âœ— Failed to delete: ${event.eventId}`);
                }
            } catch (error) {
                failCount++;
                console.error('Error deleting event:', event.eventId, error);
            }
        }

        // Clear the array in Firestore
        await db.collection('users').doc(pirId).update({
            milestoneCalendarEvents: []
        });

        console.log(`Deletion complete: ${successCount} deleted, ${failCount} failed`);
        return true;

    } catch (error) {
        console.error('Error in deletePIRMilestones:', error);
        return false;
    }
};

// RECREATE: Delete old milestones and create new ones
const recreatePIRMilestones = async (pir) => {
    try {
        // Check token first
        const tokenCheck = await checkGoogleToken();
        if (!tokenCheck.valid) {
            alert('âŒ Cannot recreate milestones without Google Calendar\n\n' + tokenCheck.error);
            return false;
        }

        console.log('Recreating milestones for:', pir.displayName || pir.email);

        // Step 1: Delete old milestones
        const deleted = await deletePIRMilestones(pir.id);
        if (!deleted) {
            console.error('Failed to delete old milestones');
        }

        // Step 2: Create new milestones
        await addMilestonesToCoachCalendar(pir, user.googleAccessToken);

        return true;

    } catch (error) {
        console.error('Error recreating milestones:', error);
        alert('Failed to recreate milestones: ' + error.message);
        return false;
    }
};

// UPDATED: Add milestones WITH event tracking
const addMilestonesToCoachCalendar = async (pir, accessToken) => {
    try {
        if (!pir.sobrietyDate) {
            alert('PIR has no sobriety date set. Cannot calculate milestones.');
            return;
        }

        // âœ… CRITICAL: Check Google token FIRST (with auto-refresh)
        const tokenCheck = await checkGoogleToken();

        if (!tokenCheck.valid) {
            alert('âŒ Cannot add milestones without Google Calendar\n\n' + tokenCheck.error);
            return;
        }

        console.log('âœ“ Google token valid, proceeding with milestone creation...');

        // Use the refreshed token
        const validToken = user.googleAccessToken;

        console.log('Adding milestones to coach calendar for:', pir.displayName || pir.email);

        // Get all milestones
        const milestones = getRecoveryMilestones(pir.sobrietyDate);

        // Filter: Only upcoming milestones (not already achieved)
        const upcomingMilestones = milestones.filter(m => !m.achieved);

        if (upcomingMilestones.length === 0) {
            alert(`${pir.displayName || 'PIR'} has achieved all defined milestones! ðŸŽ‰`);
            return;
        }

        console.log(`Creating ${upcomingMilestones.length} milestone events...`);

        let successCount = 0;
        let failCount = 0;
        const createdEvents = []; // Track created events

        for (const milestone of upcomingMilestones) {
            try {
                // Create all-day event on milestone date
                const eventDate = milestone.targetDate.toISOString().split('T')[0]; // YYYY-MM-DD

                const event = {
                    summary: `${milestone.icon} ${pir.displayName || 'PIR'} - ${milestone.title}`,
                    description: `Celebrate ${pir.displayName || pir.email}'s milestone!\n\nDays Clean: ${milestone.days}\n\nRemember to acknowledge this achievement!`,
                    start: {
                        date: eventDate,
                        timeZone: 'America/Los_Angeles'
                    },
                    end: {
                        date: eventDate,
                        timeZone: 'America/Los_Angeles'
                    },
                    reminders: {
                        useDefault: false,
                        overrides: [
                            { method: 'email', minutes: 24 * 60 }, // 1 day before
                            { method: 'popup', minutes: 0 } // On the day
                        ]
                    },
                    colorId: '9' // Blue color for milestones
                };

                const response = await fetch(
                    'https://www.googleapis.com/calendar/v3/calendars/primary/events',
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${validToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(event)
                    }
                );

                if (response.ok) {
                    const createdEvent = await response.json();
                    successCount++;
                    console.log(`âœ“ Created: ${milestone.title}`);

                    // Track the event
                    createdEvents.push({
                        eventId: createdEvent.id,
                        milestoneDays: milestone.days,
                        milestoneTitle: milestone.title,
                        milestoneDate: eventDate,
                        createdAt: new Date().toISOString()
                    });
                } else {
                    failCount++;
                    const errorData = await response.json().catch(() => ({}));
                    console.error(`âœ— Failed: ${milestone.title}`, errorData);
                }

            } catch (error) {
                failCount++;
                console.error(`Error creating milestone event:`, error);
            }
        }

        // Save tracked events to Firestore
        if (createdEvents.length > 0) {
            try {
                await db.collection('users').doc(pir.id).update({
                    milestoneCalendarEvents: createdEvents,
                    milestonesLastSynced: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log(`âœ“ Saved ${createdEvents.length} event IDs to Firestore`);
            } catch (error) {
                console.error('Error saving event IDs to Firestore:', error);
            }
        }

        // Success message
        if (successCount > 0 && failCount === 0) {
            alert(
                `âœ… Success!\n\n` +
                `${successCount} milestone celebration${successCount > 1 ? 's' : ''} added to your calendar!\n\n` +
                `ðŸŽ‰ You'll be reminded to celebrate each milestone with ${pir.displayName || 'your PIR'}!`
            );
        } else if (successCount > 0 && failCount > 0) {
            alert(
                `âš ï¸ Partial Success\n\n` +
                `âœ… ${successCount} milestone${successCount > 1 ? 's' : ''} added\n` +
                `âŒ ${failCount} failed\n\n` +
                `Check console for details.`
            );
        } else {
            alert(
                `âŒ Failed to add milestones\n\n` +
                `Please check your Google Calendar connection and try again.`
            );
        }

    } catch (error) {
        console.error('Error adding milestones to calendar:', error);
        alert('Failed to add milestones: ' + error.message);
    }
};

        // ==========================================
        // MY PIRS VIEW - FULL IMPLEMENTATION
        // ==========================================

        function MyPIRsView({ searchQuery, user }) {
            const [myPIRs, setMyPIRs] = useState([]);
            const [filteredPIRs, setFilteredPIRs] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedPIR, setSelectedPIR] = useState(null);
            const [activeFilter, setActiveFilter] = useState('all');
            const [recentCheckIns, setRecentCheckIns] = useState([]);
            const [pendingAlerts, setPendingAlerts] = useState([]);
            const [showNotesModal, setShowNotesModal] = useState(false);
            const [selectedPIRForNotes, setSelectedPIRForNotes] = useState(null);
            const [pirNotes, setPirNotes] = useState({});
            const [sortBy, setSortBy] = useState('daysClean'); // daysClean, compliance, lastCheckIn
            const [viewMode, setViewMode] = useState('grid'); // grid or list

            const moodChartRefs = useRef({});
            const cravingChartRefs = useRef({});
            const chartInstances = useRef({});

            useEffect(() => {
                loadMyPIRs();
                loadPIRNotes();
            }, [user]);

            useEffect(() => {
                filterPIRs();
            }, [searchQuery, myPIRs, activeFilter, sortBy]);

            useEffect(() => {
                // Render mini charts when data is loaded
                if (myPIRs.length > 0 && viewMode === 'grid') {
                    myPIRs.forEach(pir => {
                        if (pir.moodTrend) renderMiniChart(pir.id, 'mood', pir.moodTrend);
                        if (pir.cravingTrend) renderMiniChart(pir.id, 'craving', pir.cravingTrend);
                    });
                }
            }, [myPIRs, viewMode]);

            const loadPIRNotes = async () => {
                try {
                    const notesSnap = await db.collection('pirNotes')
                        .where('tenantId', '==', CURRENT_TENANT)
                        .where('coachId', '==', user.uid)
                        .get();

                    const notes = {};
                    notesSnap.forEach(doc => {
                        notes[doc.data().pirId] = doc.data().notes;
                    });
                    setPirNotes(notes);
                } catch (error) {
                    console.error('Error loading PIR notes:', error);
                }
            };

            const loadMyPIRs = async () => {
                try {
                    setLoading(true);

                    const pirsSnap = await db.collection('users')
                        .where('tenantId', '==', CURRENT_TENANT)
                        .where('assignedCoach', '==', user.uid)
                        .where('role', '==', 'pir')
                        .get();

                    const pirsData = [];
                    const pirIds = [];

                    for (const doc of pirsSnap.docs) {
                        const pirData = { id: doc.id, ...doc.data() };
                        pirIds.push(doc.id);

                        // Get last check-in
                        const lastCheckInSnap = await db.collection('checkIns')
                            .where('tenantId', '==', CURRENT_TENANT)
                            .where('userId', '==', doc.id)
                            .orderBy('createdAt', 'desc')
                            .limit(1)
                            .get();

                        if (!lastCheckInSnap.empty) {
                            pirData.lastCheckIn = lastCheckInSnap.docs[0].data();
                            pirData.lastCheckInDate = lastCheckInSnap.docs[0].data().createdAt;
                        }

                        // Get last 7 days of check-ins for trend
                        const sevenDaysAgo = new Date();
                        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

                        const weekCheckInsSnap = await db.collection('checkIns')
                            .where('tenantId', '==', CURRENT_TENANT)
                            .where('userId', '==', doc.id)
                            .where('createdAt', '>=', sevenDaysAgo)
                            .orderBy('createdAt', 'asc')
                            .get();

                        const moodTrend = [];
                        const cravingTrend = [];

                        weekCheckInsSnap.forEach(checkInDoc => {
                            const data = checkInDoc.data();
                            if (data.morningData?.mood) moodTrend.push(data.morningData.mood);
                            if (data.morningData?.craving) cravingTrend.push(data.morningData.craving);
                        });

                        pirData.moodTrend = moodTrend;
                        pirData.cravingTrend = cravingTrend;

                        // Calculate days clean
                        if (pirData.sobrietyDate) {
                            const sobrietyDate = pirData.sobrietyDate.toDate ?
                                pirData.sobrietyDate.toDate() : new Date(pirData.sobrietyDate);
                            pirData.daysClean = Math.floor((new Date() - sobrietyDate) / (1000 * 60 * 60 * 24));
                        } else {
                            pirData.daysClean = 0;
                        }

                        // Check compliance
                        pirData.weeklyCheckIns = weekCheckInsSnap.size;
                        pirData.complianceRate = Math.min(Math.round((weekCheckInsSnap.size / 14) * 100), 100);

                        // Check for active alerts
                        const alertsSnap = await db.collection('alerts')
                            .where('tenantId', '==', CURRENT_TENANT)
                            .where('userId', '==', doc.id)
                            .where('resolved', '==', false)
                            .get();

                        pirData.activeAlerts = alertsSnap.size;

                        // Get milestone badge
                        pirData.milestone = getMilestone(pirData.daysClean);

                        pirsData.push(pirData);
                    }

                    // Load recent check-ins
                    if (pirIds.length > 0) {
                        const checkInsPromises = pirIds.map(id =>
                            db.collection('checkIns')
                                .where('tenantId', '==', CURRENT_TENANT)
                                .where('userId', '==', id)
                                .orderBy('createdAt', 'desc')
                                .limit(3)
                                .get()
                        );

                        const checkInsSnapshots = await Promise.all(checkInsPromises);
                        const allCheckIns = [];

                        checkInsSnapshots.forEach((snapshot, index) => {
                            snapshot.forEach(doc => {
                                const checkInData = { id: doc.id, ...doc.data() };
                                const pir = pirsData.find(p => p.id === pirIds[index]);
                                checkInData.pirName = pir?.displayName || pir?.email || 'Unknown';
                                checkInData.pirId = pirIds[index];
                                allCheckIns.push(checkInData);
                            });
                        });

                        allCheckIns.sort((a, b) => {
                            const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
                            const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
                            return dateB - dateA;
                        });

                        setRecentCheckIns(allCheckIns.slice(0, 10));

                        // Load pending alerts
                        const alertsPromises = pirIds.map(id =>
                            db.collection('alerts')
                                .where('tenantId', '==', CURRENT_TENANT)
                                .where('userId', '==', id)
                                .where('resolved', '==', false)
                                .get()
                        );

                        const alertsSnapshots = await Promise.all(alertsPromises);
                        const allAlerts = [];

                        alertsSnapshots.forEach((snapshot, index) => {
                            snapshot.forEach(doc => {
                                const alertData = { id: doc.id, ...doc.data() };
                                const pir = pirsData.find(p => p.id === pirIds[index]);
                                alertData.pirName = pir?.displayName || pir?.email || 'Unknown';
                                alertData.pirId = pirIds[index];
                                allAlerts.push(alertData);
                            });
                        });

                        setPendingAlerts(allAlerts);
                    }

                    setMyPIRs(pirsData);
                    setFilteredPIRs(pirsData);

                } catch (error) {
                    console.error('Error loading my PIRs:', error);
                } finally {
                    setLoading(false);
                }
            };

    const getMilestone = (days) => {
        if (days >= 365) return { label: '1 Year+', color: '#9C27B0', icon: 'ðŸ‘‘' };
        if (days >= 180) return { label: '6 Months', color: '#673AB7', icon: 'ðŸ’Ž' };
        if (days >= 90) return { label: '90 Days', color: '#3F51B5', icon: 'ðŸŒŸ' };
        if (days >= 60) return { label: '60 Days', color: '#4682B4', icon: 'â­' };
        if (days >= 30) return { label: '30 Days', color: '#00A86B', icon: 'ðŸŽ¯' };
        if (days >= 7) return { label: '1 Week', color: '#8BC34A', icon: 'âœ¨' };
        return null;
    };

    const renderMiniChart = (pirId, type, data) => {
        const refKey = `${type}-${pirId}`;
        const chartRef = type === 'mood' ? moodChartRefs.current[pirId] : cravingChartRefs.current[pirId];

        if (!chartRef) return;

        // Destroy existing chart
        if (chartInstances.current[refKey]) {
            chartInstances.current[refKey].destroy();
        }

        const ctx = chartRef.getContext('2d');
        chartInstances.current[refKey] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map((_, i) => ''),
                datasets: [{
                    data: data,
                    borderColor: type === 'mood' ? '#00A86B' : '#FF9800',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { display: false, min: 0, max: 10 },
                    x: { display: false }
                },
                plugins: { legend: { display: false } }
            }
        });
    };

    const filterPIRs = () => {
        let filtered = [...myPIRs];

        if (activeFilter === 'needsAttention') {
            filtered = filtered.filter(pir =>
                pir.complianceRate < 50 ||
                pir.activeAlerts > 0 ||
                !pir.lastCheckInDate ||
                (pir.lastCheckInDate && daysSince(pir.lastCheckInDate) > 2)
            );
        } else if (activeFilter === 'compliant') {
            filtered = filtered.filter(pir =>
                pir.complianceRate >= 70 &&
                pir.activeAlerts === 0
            );
        }

        if (searchQuery) {
            const query = searchQuery.toLowerCase();
            filtered = filtered.filter(pir =>
                pir.email?.toLowerCase().includes(query) ||
                pir.displayName?.toLowerCase().includes(query) ||
                pir.firstName?.toLowerCase().includes(query) ||
                pir.lastName?.toLowerCase().includes(query)
            );
        }

        // Sort
        filtered.sort((a, b) => {
            if (sortBy === 'daysClean') return b.daysClean - a.daysClean;
            if (sortBy === 'compliance') return b.complianceRate - a.complianceRate;
            if (sortBy === 'lastCheckIn') {
                const dateA = a.lastCheckInDate?.toDate ? a.lastCheckInDate.toDate() : new Date(0);
                const dateB = b.lastCheckInDate?.toDate ? b.lastCheckInDate.toDate() : new Date(0);
                return dateB - dateA;
            }
            return 0;
        });

        setFilteredPIRs(filtered);
    };

    const daysSince = (date) => {
        if (!date) return 999;
        const checkDate = date?.toDate ? date.toDate() : new Date(date);
        return Math.floor((new Date() - checkDate) / (1000 * 60 * 60 * 24));
    };

    const handleSaveNotes = async (pirId, notes) => {
        try {
            await db.collection('pirNotes').doc(`${user.uid}_${pirId}`).set({
                coachId: user.uid,
                pirId: pirId,
                tenantId: CURRENT_TENANT,
                notes: notes,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            setPirNotes(prev => ({ ...prev, [pirId]: notes }));
            alert('Notes saved successfully');
        } catch (error) {
            console.error('Error saving notes:', error);
            alert('Failed to save notes');
        }
    };

    const handleQuickAssignment = async (pirId) => {
        const title = prompt('Assignment Title:');
        if (title) {
            const description = prompt('Assignment Description:');
            const dueDate = prompt('Due Date (YYYY-MM-DD):');

            try {
                await db.collection('assignments').add({
                    tenantId: CURRENT_TENANT,
                    userId: pirId,
                    title: title,
                    description: description || '',
                    dueDate: dueDate || '',
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: user.uid
                });

                alert('Assignment created successfully!');
            } catch (error) {
                console.error('Error creating assignment:', error);
                alert('Failed to create assignment');
            }
        }
    };

    const handleResolveAlert = async (alertId) => {
        try {
            await db.collection('alerts').doc(alertId).update({
                resolved: true,
                resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                resolvedBy: user.uid
            });

            loadMyPIRs();
        } catch (error) {
            console.error('Error resolving alert:', error);
            alert('Failed to resolve alert');
        }
    };

    const handleExportPIRReport = (pir) => {
        const reportData = {
            name: pir.displayName || pir.email,
            email: pir.email,
            daysClean: pir.daysClean,
            complianceRate: `${pir.complianceRate}%`,
            weeklyCheckIns: pir.weeklyCheckIns,
            activeAlerts: pir.activeAlerts,
            lastCheckIn: pir.lastCheckInDate ? formatDateTime(pir.lastCheckInDate) : 'Never',
            lastMood: pir.lastCheckIn?.morningData?.mood || 'N/A',
            lastCraving: pir.lastCheckIn?.morningData?.craving || 'N/A',
            milestone: pir.milestone?.label || 'None',
            notes: pirNotes[pir.id] || 'No notes'
        };

        // Simple CSV export
        const csv = Object.entries(reportData).map(([key, value]) => `${key},${value}`).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${pir.displayName || 'PIR'}_Report.csv`;
        a.click();
    };

    const getStatusColor = (pir) => {
        if (pir.activeAlerts > 0) return '#f44336';
        if (pir.complianceRate < 50) return '#FF9800';
        if (pir.complianceRate >= 70) return '#00A86B';
        return '#FFC107';
    };

    const getStatusLabel = (pir) => {
        if (pir.activeAlerts > 0) return 'Alert';
        if (!pir.lastCheckInDate) return 'No Check-in';
        if (daysSince(pir.lastCheckInDate) > 2) return 'Overdue';
        if (pir.complianceRate >= 70) return 'Good';
        if (pir.complianceRate >= 50) return 'Fair';
        return 'Needs Attention';
    };

            if (loading) {
                return (
                    <div style={{
                        display: 'flex',
                        flexDirection: 'column',
                        alignItems: 'center',
                        justifyContent: 'center',
                        minHeight: '400px',
                        gap: '20px'
                    }}>
                        <div style={{
                            width: '60px',
                            height: '60px',
                            border: '4px solid #f3f3f3',
                            borderTop: '4px solid #0077CC',
                            borderRadius: '50%',
                            animation: 'spin 1s linear infinite'
                        }}></div>
                        <p style={{ color: '#666' }}>Loading your PIRs...</p>
                    </div>
                );
            }

  return (
    <div style={{ padding: '20px', animation: 'fadeIn 0.5s' }}>
        {/* Enhanced Stats Cards */}
        <div style={{
            display: 'grid',
            gridTemplateColumns: 'repeat(auto-fit, minmax(240px, 1fr))',
            gap: '20px',
            marginBottom: '30px'
        }}>
            <div style={{
                background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                borderRadius: '15px',
                padding: '25px',
                color: 'white',
                boxShadow: '0 4px 15px rgba(102, 126, 234, 0.3)',
                transition: 'transform 0.2s',
                cursor: 'pointer'
            }}
            onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
            onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
            >
                <div style={{ fontSize: '14px', opacity: 0.9 }}>Total PIRs</div>
                <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                    {myPIRs.length}
                </div>
                <div style={{ fontSize: '12px', opacity: 0.8 }}>In your caseload</div>
            </div>

            <div style={{
                background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                borderRadius: '15px',
                padding: '25px',
                color: 'white',
                boxShadow: '0 4px 15px rgba(240, 147, 251, 0.3)',
                transition: 'transform 0.2s',
                cursor: 'pointer'
            }}
            onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
            onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
            >
                <div style={{ fontSize: '14px', opacity: 0.9 }}>Active Alerts</div>
                <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                    {pendingAlerts.length}
                </div>
                <div style={{ fontSize: '12px', opacity: 0.8 }}>Need attention</div>
            </div>

            <div style={{
                background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                borderRadius: '15px',
                padding: '25px',
                color: 'white',
                boxShadow: '0 4px 15px rgba(79, 172, 254, 0.3)',
                transition: 'transform 0.2s',
                cursor: 'pointer'
            }}
            onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
            onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
            >
                <div style={{ fontSize: '14px', opacity: 0.9 }}>Compliant PIRs</div>
                <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                    {myPIRs.filter(p => p.complianceRate >= 70).length}
                </div>
                <div style={{ fontSize: '12px', opacity: 0.8 }}>70%+ compliance</div>
            </div>

            <div style={{
                background: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                borderRadius: '15px',
                padding: '25px',
                color: 'white',
                boxShadow: '0 4px 15px rgba(250, 112, 154, 0.3)',
                transition: 'transform 0.2s',
                cursor: 'pointer'
            }}
            onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
            onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
            >
                <div style={{ fontSize: '14px', opacity: 0.9 }}>Avg Days Clean</div>
                <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                    {Math.round(myPIRs.reduce((acc, p) => acc + p.daysClean, 0) / (myPIRs.length || 1))}
                </div>
                <div style={{ fontSize: '12px', opacity: 0.8 }}>All PIRs average</div>
            </div>
        </div>

        {/* Pending Alerts Banner */}
        {pendingAlerts.length > 0 && (
            <div style={{
                background: 'linear-gradient(135deg, #ff4444, #cc0000)',
                padding: '20px',
                borderRadius: '15px',
                marginBottom: '20px',
                boxShadow: '0 4px 15px rgba(255, 68, 68, 0.4)'
            }}>
                <div style={{ color: 'white', marginBottom: '15px', fontSize: '18px', fontWeight: 'bold', display: 'flex', alignItems: 'center', gap: '10px' }}>
                    <span style={{ fontSize: '24px' }}>âš ï¸</span>
                    {pendingAlerts.length} Pending Alert{pendingAlerts.length > 1 ? 's' : ''}
                </div>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                    {pendingAlerts.slice(0, 3).map(alert => (
                        <div key={alert.id} style={{
                            background: 'rgba(255,255,255,0.15)',
                            backdropFilter: 'blur(10px)',
                            borderRadius: '10px',
                            padding: '15px',
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            color: 'white'
                        }}>
                            <div>
                                <div style={{ fontWeight: '600', marginBottom: '5px' }}>
                                    {alert.pirName} - {alert.type?.replace('_', ' ')}
                                </div>
                                <div style={{ fontSize: '13px', opacity: 0.9 }}>
                                    {alert.message}
                                </div>
                                <div style={{ fontSize: '11px', opacity: 0.7, marginTop: '5px' }}>
                                    {formatTimeAgo(alert.createdAt)}
                                </div>
                            </div>
                            <button
                                onClick={() => handleResolveAlert(alert.id)}
                                style={{
                                    padding: '8px 16px',
                                    background: 'white',
                                    color: '#DC143C',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '13px',
                                    fontWeight: '600',
                                    transition: 'transform 0.2s'
                                }}
                                onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.05)'}
                                onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
                            >
                                Resolve
                            </button>
                        </div>
                    ))}
                    {pendingAlerts.length > 3 && (
                        <div style={{ color: 'white', fontSize: '13px', opacity: 0.9, textAlign: 'center' }}>
                            +{pendingAlerts.length - 3} more alerts
                        </div>
                    )}
                </div>
            </div>
        )}

        {/* Filters and Controls */}
        <div style={{
            background: 'white',
            borderRadius: '15px',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
        }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '15px' }}>
                <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                    <button
                        onClick={() => setActiveFilter('all')}
                        style={{
                            padding: '8px 16px',
                            background: activeFilter === 'all' ? 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)' : '#f0f0f0',
                            color: activeFilter === 'all' ? 'white' : '#666',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500',
                            transition: 'all 0.2s'
                        }}
                    >
                        All ({myPIRs.length})
                    </button>
                    <button
                        onClick={() => setActiveFilter('needsAttention')}
                        style={{
                            padding: '8px 16px',
                            background: activeFilter === 'needsAttention' ? 'linear-gradient(135deg, #f44336 0%, #e53935 100%)' : '#f0f0f0',
                            color: activeFilter === 'needsAttention' ? 'white' : '#666',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500',
                            transition: 'all 0.2s'
                        }}
                    >
                        Needs Attention ({myPIRs.filter(p =>
                            p.complianceRate < 50 || p.activeAlerts > 0 || daysSince(p.lastCheckInDate) > 2
                        ).length})
                    </button>
                    <button
                        onClick={() => setActiveFilter('compliant')}
                        style={{
                            padding: '8px 16px',
                            background: activeFilter === 'compliant' ? 'linear-gradient(135deg, #00A86B 0%, #008554 100%)' : '#f0f0f0',
                            color: activeFilter === 'compliant' ? 'white' : '#666',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500',
                            transition: 'all 0.2s'
                        }}
                    >
                        Compliant ({myPIRs.filter(p => p.complianceRate >= 70 && p.activeAlerts === 0).length})
                    </button>
                </div>

                <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>
                    <select
                        value={sortBy}
                        onChange={(e) => setSortBy(e.target.value)}
                        style={{
                            padding: '8px 12px',
                            borderRadius: '8px',
                            border: '1px solid #ddd',
                            background: 'white',
                            cursor: 'pointer',
                            fontSize: '14px'
                        }}
                    >
                        <option value="daysClean">Sort by Days Clean</option>
                        <option value="compliance">Sort by Compliance</option>
                        <option value="lastCheckIn">Sort by Last Check-in</option>
                    </select>

                    <button
                        onClick={() => setViewMode(viewMode === 'grid' ? 'list' : 'grid')}
                        style={{
                            padding: '8px 16px',
                            background: '#6c757d',
                            color: 'white',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500'
                        }}
                    >
                        {viewMode === 'grid' ? 'List View' : 'Grid View'}
                    </button>
                </div>
            </div>
        </div>

        {/* PIRs Grid/List */}
        <div style={{
            display: 'grid',
            gridTemplateColumns: viewMode === 'grid' ? 'repeat(auto-fill, minmax(350px, 1fr))' : '1fr',
            gap: '20px',
            marginBottom: '30px'
        }}>
            {filteredPIRs.map(pir => (
                <div key={pir.id} style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '20px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                    borderLeft: `4px solid ${getStatusColor(pir)}`,
                    transition: 'all 0.2s',
                    cursor: 'pointer'
                }}
                onMouseEnter={(e) => {
                    e.currentTarget.style.transform = 'translateY(-5px)';
                    e.currentTarget.style.boxShadow = '0 8px 20px rgba(0,0,0,0.15)';
                }}
                onMouseLeave={(e) => {
                    e.currentTarget.style.transform = 'translateY(0)';
                    e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
                }}
                >
                    {/* Header */}
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '15px' }}>
                        <div style={{ flex: 1 }}>
                            <h4 style={{ margin: '0 0 5px 0', fontSize: '18px', color: '#333' }}>
                                {pir.displayName || pir.email}
                            </h4>
                            <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                                <span style={{
                                    padding: '4px 12px',
                                    borderRadius: '20px',
                                    fontSize: '12px',
                                    fontWeight: '500',
                                    background: getStatusColor(pir),
                                    color: 'white'
                                }}>
                                    {getStatusLabel(pir)}
                                </span>
                                {pir.milestone && (
                                    <span style={{
                                        padding: '4px 12px',
                                        borderRadius: '20px',
                                        fontSize: '12px',
                                        fontWeight: '500',
                                        background: pir.milestone.color,
                                        color: 'white'
                                    }}>
                                        {pir.milestone.icon} {pir.milestone.label}
                                    </span>
                                )}
                            </div>
                        </div>
                        {pir.activeAlerts > 0 && (
                            <div style={{
                                background: '#DC143C',
                                color: 'white',
                                borderRadius: '50%',
                                width: '30px',
                                height: '30px',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '14px',
                                fontWeight: 'bold'
                            }}>
                                {pir.activeAlerts}
                            </div>
                        )}
                    </div>

                    {/* Stats Grid */}
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(2, 1fr)',
                        gap: '10px',
                        marginBottom: '15px',
                        padding: '15px',
                        background: '#f8f9fa',
                        borderRadius: '10px'
                    }}>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '3px' }}>Days Clean</div>
                            <div style={{ fontSize: '20px', fontWeight: 'bold', color: '#333' }}>{pir.daysClean}</div>
                        </div>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '3px' }}>Compliance</div>
                            <div style={{ fontSize: '20px', fontWeight: 'bold', color: getStatusColor(pir) }}>
                                {pir.complianceRate}%
                            </div>
                        </div>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '3px' }}>Last Check-in</div>
                            <div style={{ fontSize: '13px', fontWeight: '500', color: '#666' }}>
                                {pir.lastCheckInDate ? formatTimeAgo(pir.lastCheckInDate) : 'Never'}
                            </div>
                        </div>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '3px' }}>Weekly Check-ins</div>
                            <div style={{ fontSize: '13px', fontWeight: '500', color: '#666' }}>
                                {pir.weeklyCheckIns}/14
                            </div>
                        </div>
                    </div>

                    {/* Trend Charts */}
                    {viewMode === 'grid' && (pir.moodTrend?.length > 0 || pir.cravingTrend?.length > 0) && (
                        <div style={{
                            display: 'grid',
                            gridTemplateColumns: '1fr 1fr',
                            gap: '10px',
                            marginBottom: '15px'
                        }}>
                            {pir.moodTrend?.length > 0 && (
                                <div>
                                    <div style={{ fontSize: '11px', color: '#999', marginBottom: '5px' }}>Mood Trend</div>
                                    <canvas
                                        ref={el => moodChartRefs.current[pir.id] = el}
                                        style={{ height: '40px' }}
                                    ></canvas>
                                </div>
                            )}
                            {pir.cravingTrend?.length > 0 && (
                                <div>
                                    <div style={{ fontSize: '11px', color: '#999', marginBottom: '5px' }}>Craving Trend</div>
                                    <canvas
                                        ref={el => cravingChartRefs.current[pir.id] = el}
                                        style={{ height: '40px' }}
                                    ></canvas>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Quick Notes Preview */}
                    {pirNotes[pir.id] && (
                        <div style={{
                            padding: '10px',
                            background: '#fff3cd',
                            borderRadius: '8px',
                            fontSize: '12px',
                            color: '#856404',
                            marginBottom: '15px',
                            maxHeight: '40px',
                            overflow: 'hidden',
                            textOverflow: 'ellipsis'
                        }}>
                            ðŸ“ {pirNotes[pir.id]}
                        </div>
                    )}

                    {/* Actions */}
                    <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                        <button
                            onClick={() => setSelectedPIR(pir)}
                            style={{
                                flex: 1,
                                padding: '10px 16px',
                                background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '13px',
                                fontWeight: '500',
                                transition: 'transform 0.2s'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.02)'}
                            onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
                        >
                            View Details
                        </button>

                        <button
                            onClick={async () => {
                                if (!user.googleConnected || !user.googleAccessToken) {
                                    alert('âŒ Google Calendar Not Connected\n\nPlease connect Google Services in your Profile to sync milestones!');
                                    return;
                                }
                                await addMilestonesToCoachCalendar(pir, user.googleAccessToken);
                            }}
                            style={{
                                padding: '10px 16px',
                                background: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '13px',
                                fontWeight: '500',
                                transition: 'transform 0.2s'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.02)'}
                            onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
                        >
                            ðŸŽ‰ Calendar
                        </button>

                        <button
                            onClick={() => {
                                setSelectedPIRForNotes(pir);
                                setShowNotesModal(true);
                            }}
                            style={{
                                padding: '10px 16px',
                                background: '#6c757d',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '13px',
                                fontWeight: '500'
                            }}
                        >
                            Notes
                        </button>
                        <button
                            onClick={() => handleQuickAssignment(pir.id)}
                            style={{
                                padding: '10px 16px',
                                background: '#00A86B',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '13px',
                                fontWeight: '500'
                            }}
                        >
                            + Task
                        </button>
                        <button
                            onClick={() => handleExportPIRReport(pir)}
                            style={{
                                padding: '10px 16px',
                                background: '#FFA500',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '13px',
                                fontWeight: '500'
                            }}
                        >
                            Export
                        </button>
                    </div>
                </div>
            ))}
        </div>

        {filteredPIRs.length === 0 && (
            <div style={{
                padding: '60px 20px',
                textAlign: 'center',
                background: 'white',
                borderRadius: '15px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <div style={{ fontSize: '48px', marginBottom: '15px' }}>ðŸ‘¥</div>
                <div style={{ fontSize: '18px', fontWeight: '500', color: '#333', marginBottom: '8px' }}>
                    {myPIRs.length === 0 ? 'No PIRs Assigned' : 'No PIRs Match Filters'}
                </div>
                <div style={{ fontSize: '14px', color: '#999' }}>
                    {myPIRs.length === 0
                        ? 'PIRs will appear here when assigned to you'
                        : 'Try adjusting your filters'}
                </div>
            </div>
        )}

        {/* Recent Check-ins Section */}
        {recentCheckIns.length > 0 && (
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '25px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                marginTop: '30px'
            }}>
                <h3 style={{ margin: '0 0 20px 0', color: '#333' }}>Recent Check-ins</h3>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                    {recentCheckIns.map(checkIn => (
                        <div key={checkIn.id} style={{
                            padding: '15px',
                            background: '#f8f9fa',
                            borderRadius: '10px',
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center'
                        }}>
                            <div>
                                <div style={{ fontWeight: '600', color: '#333', marginBottom: '5px' }}>
                                    {checkIn.pirName}
                                </div>
                                <div style={{ fontSize: '13px', color: '#666', display: 'flex', gap: '15px' }}>
                                    <span>Mood: {checkIn.morningData?.mood || '--'}/10</span>
                                    <span>Craving: {checkIn.morningData?.craving || '--'}/10</span>
                                    {checkIn.attendedMeeting && <span style={{ color: '#00A86B' }}>âœ“ Meeting</span>}
                                </div>
                            </div>
                            <div style={{ fontSize: '12px', color: '#999' }}>
                                {formatTimeAgo(checkIn.createdAt)}
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        )}

        {/* Notes Modal */}
        {showNotesModal && selectedPIRForNotes && (
            <PIRNotesModal
                pir={selectedPIRForNotes}
                existingNotes={pirNotes[selectedPIRForNotes.id] || ''}
                onClose={() => {
                    setShowNotesModal(false);
                    setSelectedPIRForNotes(null);
                }}
                onSave={(notes) => {
                    handleSaveNotes(selectedPIRForNotes.id, notes);
                    setShowNotesModal(false);
                    setSelectedPIRForNotes(null);
                }}
            />
        )}

        {/* PIR Detail Modal */}
        {selectedPIR && (
            <UserDetailModal
                user={selectedPIR}
                onClose={() => setSelectedPIR(null)}
                onUpdate={() => {
                    setSelectedPIR(null);
                    loadMyPIRs();
                }}
                currentUserId={user.uid}
            />
        )}
    </div>
);
  }

        // ==========================================
        // ROOT APP COMPONENT
        // ==========================================
        function MyPIRsApp() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [searchQuery, setSearchQuery] = useState('');

            useEffect(() => {
                const unsubscribe = firebase.auth().onAuthStateChanged(async (firebaseUser) => {
                    if (firebaseUser) {
                        const userDoc = await firebase.firestore()
                            .collection('users')
                            .doc(firebaseUser.uid)
                            .get();

                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            // Check if user has coach or admin role
                            if (userData.role === 'coach' || userData.role === 'admin' || userData.role === 'superadmin') {
                                setUser({ uid: firebaseUser.uid, ...userData });
                            } else {
                                alert('Access denied. Coach access required for My PIRs.');
                                window.location.href = '/';
                            }
                        } else {
                            window.location.href = '/';
                        }
                    } else {
                        window.location.href = '/';
                    }
                    setLoading(false);
                });

                return () => unsubscribe();
            }, []);

            if (loading) {
                return (
                    <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        minHeight: '100vh',
                        background: '#f5f7fa'
                    }}>
                        <div style={{
                            width: '60px',
                            height: '60px',
                            border: '4px solid #f3f3f3',
                            borderTop: '4px solid var(--primary-color)',
                            borderRadius: '50%',
                            animation: 'spin 1s linear infinite'
                        }}></div>
                    </div>
                );
            }

            return (
                <div style={{ display: 'flex', minHeight: '100vh', background: '#f5f7fa' }}>
                    <Sidebar user={user} />
                    <div style={{
                        flex: 1,
                        marginLeft: '280px',
                        transition: 'margin-left 0.3s'
                    }}>
                        <MyPIRsView user={user} searchQuery={searchQuery} />
                    </div>
                </div>
            );
        }

        // Render the app
        ReactDOM.render(<MyPIRsApp />, document.getElementById('root'));

})(); // End initPage
    </script>

    <!-- NOTE: To complete this page, copy lines 4944-6420 from admin.html -->
    <!-- This includes the full MyPIRsView function with all features -->
</body>
</html>
