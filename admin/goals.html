<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goals Management - GLRS Admin</title>

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🏆</text></svg>">

    <!-- Shared Styles -->
    <link rel="stylesheet" href="/admin/shared/styles.css">

    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <!-- Shared Components -->
    <script src="/admin/shared/firebase.js"></script>
    <script src="/admin/shared/auth.js"></script>
    <script src="/admin/shared/utils.js"></script>
    <script src="/admin/shared/state.js"></script>
    <script src="/admin/shared/navigation.js"></script>

    <script type="text/babel">
        // Wait for Firebase to initialize before running
        (function initPage() {
            if (!window.FIREBASE_READY || !window.auth || !window.db) {
                console.log('Waiting for Firebase to initialize...');
                setTimeout(initPage, 50);
                return;
            }

            const { useState, useEffect, useRef, useMemo, useCallback } = React;
            const { auth, db, storage, CURRENT_TENANT, logAudit } = window;

        // ==========================================
        // GOALS VIEW - FULL IMPLEMENTATION
        // ==========================================

function GoalsView({ searchQuery, user }) {
    const [selectedPIR, setSelectedPIR] = useState(null);
    const [pirs, setPirs] = useState([]);
    const [loading, setLoading] = useState(true);
    const [expandedGoals, setExpandedGoals] = useState(new Set());
    const [expandedObjectives, setExpandedObjectives] = useState(new Set());
    const [showCreateModal, setShowCreateModal] = useState(false);
    const [modalType, setModalType] = useState('');
    const [selectedParent, setSelectedParent] = useState(null);
    const [pirGoalsData, setPirGoalsData] = useState({
        goals: [],
        objectives: [],
        assignments: [],
        milestones: [],
        customMilestones: []
    });
    const [activeTab, setActiveTab] = useState('overview');

    useEffect(() => {
        loadPIRsWithStats();
    }, []);

    useEffect(() => {
        if (selectedPIR) {
            loadPIRGoalsData(selectedPIR.id);
        }
    }, [selectedPIR]);

    const loadPIRsWithStats = async () => {
        try {
            setLoading(true);
            console.log('🎯 GoalsView: Loading PIRs for tenant:', CURRENT_TENANT);

            const pirsSnap = await db.collection('users')
                .where('tenantId', '==', CURRENT_TENANT)
                .where('role', '==', 'pir')
                .get();

            console.log('✓ GoalsView: Found', pirsSnap.size, 'total PIRs');

            const pirsData = [];

            for (const doc of pirsSnap.docs) {
                const pirData = { id: doc.id, ...doc.data() };

                if (pirData.active === false) {
                    console.log('  ⊘ Skipping inactive PIR:', pirData.displayName || pirData.email);
                    continue;
                }

                const goalsSnap = await db.collection('goals')
                    .where('tenantId', '==', CURRENT_TENANT)
                    .where('userId', '==', doc.id)
                    .get();

                let totalProgress = 0;
                let overdueCount = 0;
                let nearCompletion = 0;
                let activeGoalsCount = 0;
                let completedGoalsCount = 0;

                for (const goalDoc of goalsSnap.docs) {
                    const goalData = goalDoc.data();
                    if (goalData.status === 'active') activeGoalsCount++;
                    if (goalData.status === 'completed') completedGoalsCount++;

                    const assignmentsSnap = await db.collection('assignments')
                        .where('tenantId', '==', CURRENT_TENANT)
                        .where('goalId', '==', goalDoc.id)
                        .get();

                    let completed = 0;
                    let total = assignmentsSnap.size;

                    assignmentsSnap.forEach(assignDoc => {
                        const assignment = assignDoc.data();
                        if (assignment.status === 'completed') completed++;
                        if (assignment.dueDate && new Date(assignment.dueDate.toDate()) < new Date() && assignment.status !== 'completed') {
                            overdueCount++;
                        }
                    });

                    const goalProgress = total > 0 ? (completed / total) * 100 : 0;
                    totalProgress += goalProgress;
                    if (goalProgress >= 80 && goalData.status === 'active') nearCompletion++;
                }

                pirData.activeGoals = activeGoalsCount;
                pirData.completedGoals = completedGoalsCount;
                pirData.totalGoals = goalsSnap.size;
                pirData.overallProgress = goalsSnap.size > 0 ? Math.round(totalProgress / goalsSnap.size) : 0;
                pirData.overdueAssignments = overdueCount;
                pirData.nearCompletion = nearCompletion;

                pirsData.push(pirData);
            }

            console.log('✅ GoalsView: Loaded', pirsData.length, 'active PIRs with stats');
            setPirs(pirsData);
        } catch (error) {
            console.error('❌ GoalsView: Error loading PIRs:', error);
        } finally {
            setLoading(false);
        }
    };

    const loadPIRGoalsData = async (pirId) => {
        try {
            setLoading(true);

            const goalsSnap = await db.collection('goals')
                .where('tenantId', '==', CURRENT_TENANT)
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .get();

            const goalsData = [];
            const objectivesData = [];
            const assignmentsData = [];

            for (const goalDoc of goalsSnap.docs) {
                const goalData = { id: goalDoc.id, ...goalDoc.data() };

                const objectivesSnap = await db.collection('objectives')
                    .where('tenantId', '==', CURRENT_TENANT)
                    .where('goalId', '==', goalDoc.id)
                    .orderBy('order', 'asc')
                    .get();

                let goalAssignments = 0;
                let completedAssignments = 0;

                for (const objDoc of objectivesSnap.docs) {
                    const objData = { id: objDoc.id, ...objDoc.data() };
                    objectivesData.push(objData);

                    const assignmentsSnap = await db.collection('assignments')
                        .where('tenantId', '==', CURRENT_TENANT)
                        .where('objectiveId', '==', objDoc.id)
                        .orderBy('createdAt', 'desc')
                        .get();

                    assignmentsSnap.forEach(assignDoc => {
                        const assignData = { id: assignDoc.id, ...assignDoc.data() };
                        assignmentsData.push(assignData);
                        goalAssignments++;
                        if (assignData.status === 'completed') completedAssignments++;
                    });
                }

                goalData.progress = goalAssignments > 0
                    ? Math.round((completedAssignments / goalAssignments) * 100)
                    : 0;

                goalsData.push(goalData);
            }

            const recoveryMilestones = getRecoveryMilestones(selectedPIR.sobrietyDate);

            const customMilestonesSnap = await db.collection('milestones')
                .where('tenantId', '==', CURRENT_TENANT)
                .where('userId', '==', pirId)
                .where('type', '==', 'custom')
                .orderBy('targetDate', 'asc')
                .get();

            const customMilestonesData = [];
            customMilestonesSnap.forEach(doc => {
                customMilestonesData.push({ id: doc.id, ...doc.data() });
            });

            setPirGoalsData({
                goals: goalsData,
                objectives: objectivesData,
                assignments: assignmentsData,
                milestones: recoveryMilestones,
                customMilestones: customMilestonesData
            });

        } catch (error) {
            console.error('Error loading PIR goals:', error);
        } finally {
            setLoading(false);
        }
    };


    const toggleGoalExpand = (goalId) => {
        const newExpanded = new Set(expandedGoals);
        if (newExpanded.has(goalId)) {
            newExpanded.delete(goalId);
        } else {
            newExpanded.add(goalId);
        }
        setExpandedGoals(newExpanded);
    };

    const toggleObjectiveExpand = (objId) => {
        const newExpanded = new Set(expandedObjectives);
        if (newExpanded.has(objId)) {
            newExpanded.delete(objId);
        } else {
            newExpanded.add(objId);
        }
        setExpandedObjectives(newExpanded);
    };

    const handleCompleteGoal = async (goalId) => {
        if (!confirm('Mark this goal as complete? Only coaches can complete goals.')) return;

        try {
            await db.collection('goals').doc(goalId).update({
                status: 'completed',
                completedBy: user.uid,
                completedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            loadPIRGoalsData(selectedPIR.id);
        } catch (error) {
            console.error('Error completing goal:', error);
        }
    };

    const handleCompleteObjective = async (objectiveId) => {
        if (!confirm('Mark this objective as complete? Only coaches can complete objectives.')) return;

        try {
            await db.collection('objectives').doc(objectiveId).update({
                status: 'completed',
                completedBy: user.uid,
                completedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            loadPIRGoalsData(selectedPIR.id);
        } catch (error) {
            console.error('Error completing objective:', error);
        }
    };

    const handleCreateGoal = async (goalData) => {
        try {
            await db.collection('goals').add({
                tenantId: CURRENT_TENANT,
                userId: selectedPIR.id,
                title: goalData.title,
                description: goalData.description,
                dueDate: goalData.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(goalData.dueDate)) : null,
                status: 'active',
                createdBy: user.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            alert('Goal created successfully!');
            setShowCreateModal(false);
            loadPIRGoalsData(selectedPIR.id);
        } catch (error) {
            console.error('Error creating goal:', error);
            alert('Failed to create goal');
        }
    };

    const handleCreateObjective = async (objectiveData) => {
        try {
            const objectivesSnap = await db.collection('objectives')
                .where('tenantId', '==', CURRENT_TENANT)
                .where('goalId', '==', objectiveData.goalId)
                .get();

            await db.collection('objectives').add({
                tenantId: CURRENT_TENANT,
                goalId: objectiveData.goalId,
                userId: selectedPIR.id,
                title: objectiveData.title,
                order: objectivesSnap.size + 1,
                dueDate: objectiveData.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(objectiveData.dueDate)) : null,
                status: 'active',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            alert('Objective created successfully!');
            setShowCreateModal(false);
            loadPIRGoalsData(selectedPIR.id);
        } catch (error) {
            console.error('Error creating objective:', error);
            alert('Failed to create objective');
        }
    };

   const handleCreateAssignment = async (assignmentData) => {
    try {
        let dueDateTimestamp = null;
        if (assignmentData.dueDate) {
            const dateObj = new Date(assignmentData.dueDate);
            if (!isNaN(dateObj.getTime())) {
                dueDateTimestamp = firebase.firestore.Timestamp.fromDate(dateObj);
            }
        }

        await db.collection('assignments').add({
            tenantId: CURRENT_TENANT,
            goalId: assignmentData.goalId,
            objectiveId: assignmentData.objectiveId,
            userId: selectedPIR.id,
            pirName: selectedPIR.displayName || selectedPIR.email,
            coachId: user.uid,
            coachName: user.displayName || user.email,
            title: assignmentData.title,
            description: assignmentData.description,
            dueDate: dueDateTimestamp,
            status: 'pending',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        await createNotificationWithPreferences({
            tenantId: CURRENT_TENANT,
            userId: selectedPIR.id,
            recipientId: selectedPIR.id,
            type: 'assignment_created',
            title: 'New Assignment',
            message: `You have a new assignment: ${assignmentData.title}`,
            read: false
        }, 'assignment_created');

        await sendNewAssignmentEmail(
            selectedPIR.email,
            selectedPIR.displayName || selectedPIR.email,
            assignmentData,
            user.displayName || user.email
        );

        alert('Assignment created successfully!');
        setShowCreateModal(false);
        loadPIRGoalsData(selectedPIR.id);
    } catch (error) {
        console.error('Error creating assignment:', error);
        alert('Failed to create assignment');
    }
};

    const handleCreateMilestone = async (milestoneData) => {
        try {
            await db.collection('milestones').add({
                userId: selectedPIR.id,
                title: milestoneData.title,
                description: milestoneData.description,
                targetDate: firebase.firestore.Timestamp.fromDate(new Date(milestoneData.targetDate)),
                type: 'custom',
                achieved: false,
                icon: milestoneData.icon || '🎯',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            alert('Milestone created successfully!');
            setShowCreateModal(false);
            loadPIRGoalsData(selectedPIR.id);
        } catch (error) {
            console.error('Error creating milestone:', error);
            alert('Failed to create milestone');
        }
    };

    const PIRCard = ({ pir, onClick }) => (
        <div
            className="pir-card-enhanced"
            onClick={onClick}
            style={{
                background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                borderRadius: '12px',
                padding: '20px',
                marginBottom: '15px',
                cursor: 'pointer',
                transition: 'transform 0.2s, box-shadow 0.2s',
                color: 'white',
                boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
            }}
            onMouseEnter={(e) => {
                e.currentTarget.style.transform = 'translateY(-2px)';
                e.currentTarget.style.boxShadow = '0 6px 12px rgba(0,0,0,0.15)';
            }}
            onMouseLeave={(e) => {
                e.currentTarget.style.transform = 'translateY(0)';
                e.currentTarget.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
            }}
        >
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start' }}>
                <div>
                    <h3 style={{ margin: '0 0 10px 0', fontSize: '1.4em' }}>
                        👤 {pir.displayName || `${pir.firstName} ${pir.lastName}` || pir.email}
                    </h3>
                    <div style={{ display: 'flex', gap: '20px', fontSize: '0.95em', opacity: '0.95' }}>
                        <span>📊 {pir.activeGoals || 0} Active</span>
                        <span>✅ {pir.completedGoals || 0} Complete</span>
                        <span>📈 {pir.overallProgress || 0}% Progress</span>
                    </div>
                </div>
                <div style={{
                    background: 'rgba(255,255,255,0.2)',
                    borderRadius: '20px',
                    padding: '8px 16px',
                    fontSize: '2em',
                    fontWeight: 'bold'
                }}>
                    {pir.overallProgress || 0}%
                </div>
            </div>

            {(pir.overdueAssignments > 0 || pir.nearCompletion > 0) && (
                <div style={{
                    marginTop: '15px',
                    paddingTop: '15px',
                    borderTop: '1px solid rgba(255,255,255,0.2)'
                }}>
                    {pir.overdueAssignments > 0 && (
                        <span style={{
                            background: 'rgba(255,100,100,0.3)',
                            padding: '4px 12px',
                            borderRadius: '15px',
                            marginRight: '10px',
                            fontSize: '0.9em'
                        }}>
                            ⚠️ {pir.overdueAssignments} Overdue
                        </span>
                    )}
                    {pir.nearCompletion > 0 && (
                        <span style={{
                            background: 'rgba(100,255,100,0.3)',
                            padding: '4px 12px',
                            borderRadius: '15px',
                            fontSize: '0.9em'
                        }}>
                            🎯 {pir.nearCompletion} Near Completion
                        </span>
                    )}
                </div>
            )}
        </div>
    );

    const ActionButton = ({ icon, label, onClick, variant = 'primary' }) => {
        const colors = {
            primary: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
            success: 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)',
            warning: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
            info: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)'
        };

        return (
            <button
                onClick={onClick}
                style={{
                    background: colors[variant],
                    border: 'none',
                    borderRadius: '8px',
                    color: 'white',
                    padding: '10px 20px',
                    fontSize: '0.95em',
                    fontWeight: '500',
                    cursor: 'pointer',
                    transition: 'transform 0.2s',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.05)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
            >
                <span style={{ fontSize: '1.2em' }}>{icon}</span>
                {label}
            </button>
        );
    };

    const GoalItem = ({ goal }) => {
        const isExpanded = expandedGoals.has(goal.id);
        const objectives = pirGoalsData.objectives.filter(obj => obj.goalId === goal.id);
        const isCompleted = goal.status === 'completed';

        return (
            <div style={{
                background: isCompleted ? '#f0f8ff' : 'white',
                borderRadius: '10px',
                padding: '20px',
                marginBottom: '15px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                transition: 'all 0.3s',
                opacity: isCompleted ? 0.9 : 1
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <div
                        onClick={() => toggleGoalExpand(goal.id)}
                        style={{ cursor: 'pointer', flex: 1 }}
                    >
                        <h4 style={{ margin: 0, color: '#333', display: 'flex', alignItems: 'center', gap: '10px' }}>
                            <span>{isExpanded ? '▼' : '▶'}</span>
                            {goal.title}
                            <span style={{
                                background: isCompleted ? '#00A86B' : `linear-gradient(90deg, #0077CC ${goal.progress}%, #e0e0e0 ${goal.progress}%)`,
                                padding: '2px 10px',
                                borderRadius: '12px',
                                fontSize: '0.8em',
                                color: 'white'
                            }}>
                                {isCompleted ? 'Completed' : `${goal.progress}%`}
                            </span>
                        </h4>
                        <div style={{ marginTop: '5px', fontSize: '0.9em', color: '#666' }}>
                            Created: {formatDate(goal.createdAt)}
                            {goal.dueDate && ` • Due: ${formatDate(goal.dueDate)}`}
                            {goal.completedAt && ` • Completed: ${formatDate(goal.completedAt)}`}
                        </div>
                        {goal.description && (
                            <div style={{ marginTop: '8px', fontSize: '0.9em', color: '#555' }}>
                                {goal.description}
                            </div>
                        )}
                    </div>
                    <div style={{ display: 'flex', gap: '10px' }}>
                        {!isCompleted && (
                            <>
                                <button
                                    onClick={() => {
                                        setSelectedParent({ type: 'goal', id: goal.id, title: goal.title });
                                        setModalType('objective');
                                        setShowCreateModal(true);
                                    }}
                                    style={{
                                        background: '#00A86B',
                                        border: 'none',
                                        borderRadius: '6px',
                                        color: 'white',
                                        padding: '6px 12px',
                                        cursor: 'pointer',
                                        fontSize: '0.85em'
                                    }}
                                >
                                    + Objective
                                </button>
                                <button
                                    onClick={() => handleCompleteGoal(goal.id)}
                                    style={{
                                        background: '#4682B4',
                                        border: 'none',
                                        borderRadius: '6px',
                                        color: 'white',
                                        padding: '6px 12px',
                                        cursor: 'pointer',
                                        fontSize: '0.85em'
                                    }}
                                >
                                    Complete
                                </button>
                            </>
                        )}
                    </div>
                </div>

                {isExpanded && (
                    <div style={{ marginTop: '20px', paddingLeft: '30px' }}>
                        {objectives.map(objective => (
                            <ObjectiveItem key={objective.id} objective={objective} goal={goal} />
                        ))}
                        {objectives.length === 0 && (
                            <p style={{ color: '#999', fontSize: '0.9em' }}>No objectives yet</p>
                        )}
                    </div>
                )}
            </div>
        );
    };

    const ObjectiveItem = ({ objective, goal }) => {
        const isExpanded = expandedObjectives.has(objective.id);
        const assignments = pirGoalsData.assignments.filter(a => a.objectiveId === objective.id);
        const isCompleted = objective.status === 'completed';

        return (
            <div style={{
                background: isCompleted ? '#f5fff5' : '#f8f9fa',
                borderLeft: `3px solid ${isCompleted ? '#00A86B' : '#0077CC'}`,
                padding: '15px',
                marginBottom: '10px',
                borderRadius: '6px',
                opacity: isCompleted ? 0.9 : 1
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <div
                        onClick={() => toggleObjectiveExpand(objective.id)}
                        style={{ cursor: 'pointer', flex: 1 }}
                    >
                        <h5 style={{ margin: 0, color: '#555', display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <span>{isExpanded ? '▼' : '▶'}</span>
                            {objective.title}
                            <span style={{
                                background: isCompleted ? '#00A86B' : '#FFA726',
                                padding: '2px 8px',
                                borderRadius: '10px',
                                fontSize: '0.75em',
                                color: 'white'
                            }}>
                                {isCompleted ? 'completed' : 'active'}
                            </span>
                        </h5>
                        <div style={{ marginTop: '5px', fontSize: '0.85em', color: '#777' }}>
                            {objective.dueDate && `Due: ${formatDate(objective.dueDate)}`}
                            {objective.completedAt && ` • Completed: ${formatDate(objective.completedAt)}`}
                        </div>
                    </div>
                    <div style={{ display: 'flex', gap: '10px' }}>
                        {!isCompleted && (
                            <>
                                <button
                                    onClick={() => {
                                        setSelectedParent({
                                            type: 'objective',
                                            id: objective.id,
                                            goalId: goal.id,
                                            title: `${goal.title} > ${objective.title}`
                                        });
                                        setModalType('assignment');
                                        setShowCreateModal(true);
                                    }}
                                    style={{
                                        background: '#9C27B0',
                                        border: 'none',
                                        borderRadius: '6px',
                                        color: 'white',
                                        padding: '5px 10px',
                                        cursor: 'pointer',
                                        fontSize: '0.8em'
                                    }}
                                >
                                    + Assignment
                                </button>
                                <button
                                    onClick={() => handleCompleteObjective(objective.id)}
                                    style={{
                                        background: '#FFA500',
                                        border: 'none',
                                        borderRadius: '6px',
                                        color: 'white',
                                        padding: '5px 10px',
                                        cursor: 'pointer',
                                        fontSize: '0.8em'
                                    }}
                                >
                                    Complete
                                </button>
                            </>
                        )}
                    </div>
                </div>

                {isExpanded && (
                    <div style={{ marginTop: '15px', paddingLeft: '20px' }}>
                        {assignments.map(assignment => (
                            <AssignmentItem key={assignment.id} assignment={assignment} />
                        ))}
                        {assignments.length === 0 && (
                            <p style={{ color: '#999', fontSize: '0.9em' }}>No assignments yet</p>
                        )}
                    </div>
                )}
            </div>
        );
    };

    const AssignmentItem = ({ assignment }) => {
        const isCompleted = assignment.status === 'completed';

        return (
            <div style={{
                background: isCompleted ? '#f0fff0' : 'white',
                border: `1px solid ${isCompleted ? '#c8e6c9' : '#e0e0e0'}`,
                padding: '12px',
                marginBottom: '8px',
                borderRadius: '4px',
                display: 'flex',
                alignItems: 'flex-start',
                gap: '10px'
            }}>
                <span style={{ fontSize: '1.2em', marginTop: '2px' }}>
                    {isCompleted ? '✅' : '⏳'}
                </span>
                <div style={{ flex: 1 }}>
                    <div style={{ fontWeight: '500', color: '#333' }}>
                        {assignment.title}
                    </div>
                    {assignment.description && (
                        <div style={{ fontSize: '0.85em', color: '#666', marginTop: '4px' }}>
                            {assignment.description}
                        </div>
                    )}
                    {assignment.reflection && (
                        <div style={{
                            background: '#e3f2fd',
                            padding: '8px',
                            borderRadius: '4px',
                            marginTop: '8px',
                            fontSize: '0.85em',
                            borderLeft: '3px solid #2196F3'
                        }}>
                            <strong style={{ color: '#1565C0' }}>PIR Reflection:</strong>
                            <div style={{ marginTop: '4px', color: '#424242' }}>
                                {assignment.reflection}
                            </div>
                        </div>
                    )}
                    <div style={{ fontSize: '0.8em', color: '#999', marginTop: '6px' }}>
                        {assignment.createdAt && `Created: ${formatDate(assignment.createdAt)}`}
                        {assignment.dueDate && ` • Due: ${formatDate(assignment.dueDate)}`}
                        {assignment.completedAt && ` • Completed: ${formatDate(assignment.completedAt)}`}
                    </div>
                </div>
            </div>
        );
    };

    if (loading) {
        return (
            <div style={{
                display: 'flex',
                justifyContent: 'center',
                alignItems: 'center',
                height: '400px'
            }}>
                <div className="loading-spinner"></div>
            </div>
        );
    }

    if (selectedPIR) {
        return (
            <div style={{ padding: '20px' }}>
                <div style={{
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    marginBottom: '30px',
                    background: 'white',
                    padding: '20px',
                    borderRadius: '10px',
                    boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                }}>
                    <div>
                        <button
                            onClick={() => setSelectedPIR(null)}
                            style={{
                                background: 'none',
                                border: 'none',
                                color: '#0077CC',
                                cursor: 'pointer',
                                fontSize: '1em',
                                marginBottom: '10px',
                                padding: 0
                            }}
                        >
                            ← Back to PIR List
                        </button>
                        <h2 style={{ margin: 0, color: '#333' }}>
                            {selectedPIR.displayName || selectedPIR.email}'s Recovery Plan
                        </h2>
                        <div style={{
                            marginTop: '10px',
                            fontSize: '1.2em',
                            color: '#666'
                        }}>
                            Overall Progress: {Math.round(pirGoalsData.goals.reduce((acc, g) => acc + g.progress, 0) / (pirGoalsData.goals.length || 1))}%
                        </div>
                    </div>

                    <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                        <ActionButton
                            icon="🧵"
                            label="Golden Thread"
                            variant="primary"
                            onClick={() => {
                                setModalType('goldenThread');
                                setShowCreateModal(true);
                            }}
                        />
                        <ActionButton
                            icon="🎯"
                            label="Add Goal"
                            variant="success"
                            onClick={() => {
                                setModalType('goal');
                                setShowCreateModal(true);
                            }}
                        />
                        <ActionButton
                            icon="⭐"
                            label="Add Milestone"
                            variant="warning"
                            onClick={() => {
                                setModalType('milestone');
                                setShowCreateModal(true);
                            }}
                        />
                    </div>
                </div>

                <div style={{ marginTop: '20px' }}>
                    {pirGoalsData.goals.map(goal => (
                        <GoalItem key={goal.id} goal={goal} />
                    ))}

                    {pirGoalsData.goals.length === 0 && (
                        <div style={{
                            background: 'white',
                            borderRadius: '10px',
                            padding: '40px',
                            textAlign: 'center',
                            color: '#999'
                        }}>
                            <h3>No goals assigned yet</h3>
                            <p>Start with a Golden Thread to create a structured recovery plan</p>
                        </div>
                    )}
                </div>

                {showCreateModal && (
                    <CreateGoalModal
                        type={modalType}
                        selectedPIR={selectedPIR}
                        selectedParent={selectedParent}
                        currentUser={user}
                        onSubmit={(data) => {
                            if (modalType === 'goldenThread') {
                                return;
                            } else if (modalType === 'goal') {
                                handleCreateGoal(data);
                            } else if (modalType === 'objective') {
                                handleCreateObjective(data);
                            } else if (modalType === 'assignment') {
                                handleCreateAssignment(data);
                            } else if (modalType === 'milestone') {
                                handleCreateMilestone(data);
                            }
                        }}
                        onClose={() => {
                            setShowCreateModal(false);
                            setSelectedParent(null);
                        }}
                    />
                )}
            </div>
        );
    }

    return (
        <div style={{ padding: '20px' }}>
            <h2 style={{ marginBottom: '30px', color: '#333' }}>PIR Goals Management</h2>
            <div>
                {pirs.map(pir => (
                    <PIRCard
                        key={pir.id}
                        pir={pir}
                        onClick={() => setSelectedPIR(pir)}
                    />
                ))}

                {pirs.length === 0 && (
                    <div style={{
                        background: 'white',
                        borderRadius: '10px',
                        padding: '40px',
                        textAlign: 'center',
                        color: '#999'
                    }}>
                        <h3>No active PIRs found</h3>
                        <p>PIRs will appear here once they are added to the system</p>
                    </div>
                )}
            </div>

            {showCreateModal && (
                <CreateGoalModal
                    type={modalType}
                    selectedPIR={selectedPIR}
                    selectedParent={selectedParent}
                    currentUser={user}
                    onSubmit={(data) => {
                        if (modalType === 'goldenThread') {
                            return;
                        } else if (modalType === 'goal') {
                            handleCreateGoal(data);
                        } else if (modalType === 'objective') {
                            handleCreateObjective(data);
                        } else if (modalType === 'assignment') {
                            handleCreateAssignment(data);
                        } else if (modalType === 'milestone') {
                            handleCreateMilestone(data);
                        }
                    }}
                    onClose={() => {
                        setShowCreateModal(false);
                        setSelectedParent(null);
                    }}
                />
            )}
        </div>
    );
}

// Enhanced Golden Thread Modal - COMPLETE VERSION
function CreateGoalModal({ type, selectedPIR, selectedParent, currentUser, onSubmit, onClose }) {
    const [goldenThreadData, setGoldenThreadData] = useState({
        goals: [
            {
                title: '',
                description: '',
                dueDate: '',
                objectives: [
                    { title: '', dueDate: '', assignments: [{ title: '', description: '', dueDate: '' }] },
                    { title: '', dueDate: '', assignments: [{ title: '', description: '', dueDate: '' }] }
                ]
            },
            {
                title: '',
                description: '',
                dueDate: '',
                objectives: [
                    { title: '', dueDate: '', assignments: [{ title: '', description: '', dueDate: '' }] },
                    { title: '', dueDate: '', assignments: [{ title: '', description: '', dueDate: '' }] }
                ]
            }
        ]
    });

    const [singleFormData, setSingleFormData] = useState({
        title: '',
        description: '',
        dueDate: '',
        targetDate: '',
        icon: '🎯',
        goalId: selectedParent?.goalId || '',
        objectiveId: selectedParent?.id || ''
    });

    const addGoal = () => {
        setGoldenThreadData({
            ...goldenThreadData,
            goals: [...goldenThreadData.goals, {
                title: '',
                description: '',
                dueDate: '',
                objectives: [
                    { title: '', dueDate: '', assignments: [{ title: '', description: '', dueDate: '' }] }
                ]
            }]
        });
    };

    const addObjective = (goalIndex) => {
        const newGoals = [...goldenThreadData.goals];
        newGoals[goalIndex].objectives.push({
            title: '',
            dueDate: '',
            assignments: [{ title: '', description: '', dueDate: '' }]
        });
        setGoldenThreadData({ ...goldenThreadData, goals: newGoals });
    };

    const addAssignment = (goalIndex, objIndex) => {
        const newGoals = [...goldenThreadData.goals];
        newGoals[goalIndex].objectives[objIndex].assignments.push({
            title: '',
            description: '',
            dueDate: ''
        });
        setGoldenThreadData({ ...goldenThreadData, goals: newGoals });
    };

    const updateGoal = (index, field, value) => {
        const newGoals = [...goldenThreadData.goals];
        newGoals[index][field] = value;
        setGoldenThreadData({ ...goldenThreadData, goals: newGoals });
    };

    const updateObjective = (goalIndex, objIndex, field, value) => {
        const newGoals = [...goldenThreadData.goals];
        newGoals[goalIndex].objectives[objIndex][field] = value;
        setGoldenThreadData({ ...goldenThreadData, goals: newGoals });
    };

    const updateAssignment = (goalIndex, objIndex, assignIndex, field, value) => {
        const newGoals = [...goldenThreadData.goals];
        newGoals[goalIndex].objectives[objIndex].assignments[assignIndex][field] = value;
        setGoldenThreadData({ ...goldenThreadData, goals: newGoals });
    };

    const handleGoldenThreadSubmit = async () => {
        try {
            for (const goal of goldenThreadData.goals) {
                if (!goal.title) continue;

                const goalRef = await db.collection('goals').add({
                    userId: selectedPIR.id,
                    title: goal.title,
                    description: goal.description,
                    dueDate: goal.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(goal.dueDate)) : null,
                    status: 'active',
                    createdBy: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                for (let i = 0; i < goal.objectives.length; i++) {
                    const objective = goal.objectives[i];
                    if (!objective.title) continue;

                    const objectiveRef = await db.collection('objectives').add({
                        goalId: goalRef.id,
                        userId: selectedPIR.id,
                        title: objective.title,
                        order: i + 1,
                        dueDate: objective.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(objective.dueDate)) : null,
                        status: 'active',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    for (const assignment of objective.assignments) {
                        if (!assignment.title) continue;

                        await db.collection('assignments').add({
                            goalId: goalRef.id,
                            objectiveId: objectiveRef.id,
                            userId: selectedPIR.id,
                            pirName: selectedPIR.displayName || selectedPIR.email,
                            coachId: currentUser.uid,
                            coachName: currentUser.displayName || currentUser.email,
                            title: assignment.title,
                            description: assignment.description,
                            dueDate: assignment.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(assignment.dueDate)) : null,
                            status: 'pending',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }
            }

            alert('Golden Thread created successfully!');
            onClose();
            window.location.reload();
        } catch (error) {
            console.error('Error creating golden thread:', error);
            alert('Failed to create golden thread');
        }
    };

    if (type === 'goldenThread') {
        return (
            <div className="modal-overlay" style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0,0,0,0.5)',
                display: 'flex',
                justifyContent: 'center',
                alignItems: 'center',
                zIndex: 1000,
                overflow: 'auto'
            }}>
                <div style={{
                    background: 'white',
                    borderRadius: '12px',
                    width: '90%',
                    maxWidth: '900px',
                    maxHeight: '90vh',
                    overflow: 'auto',
                    padding: '30px'
                }}>
                    <div style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        marginBottom: '20px'
                    }}>
                        <h2 style={{ margin: 0 }}>Create Golden Thread</h2>
                        <button
                            onClick={onClose}
                            style={{
                                background: 'none',
                                border: 'none',
                                fontSize: '24px',
                                cursor: 'pointer'
                            }}
                        >
                            ×
                        </button>
                    </div>

                    {goldenThreadData.goals.map((goal, goalIndex) => (
                        <div key={goalIndex} style={{
                            background: '#f8f9fa',
                            borderRadius: '8px',
                            padding: '20px',
                            marginBottom: '20px'
                        }}>
                            <h3 style={{ color: '#0077CC', marginTop: 0 }}>Goal {goalIndex + 1}</h3>
                            <input
                                type="text"
                                placeholder="Goal Title"
                                value={goal.title}
                                onChange={(e) => updateGoal(goalIndex, 'title', e.target.value)}
                                style={{
                                    width: '100%',
                                    padding: '10px',
                                    marginBottom: '10px',
                                    border: '1px solid #ddd',
                                    borderRadius: '6px'
                                }}
                            />
                            <textarea
                                placeholder="Goal Description"
                                value={goal.description}
                                onChange={(e) => updateGoal(goalIndex, 'description', e.target.value)}
                                style={{
                                    width: '100%',
                                    padding: '10px',
                                    marginBottom: '10px',
                                    border: '1px solid #ddd',
                                    borderRadius: '6px',
                                    minHeight: '60px'
                                }}
                            />
                            <input
                                type="date"
                                value={goal.dueDate}
                                onChange={(e) => updateGoal(goalIndex, 'dueDate', e.target.value)}
                                style={{
                                    padding: '10px',
                                    marginBottom: '20px',
                                    border: '1px solid #ddd',
                                    borderRadius: '6px'
                                }}
                            />

                            {goal.objectives.map((objective, objIndex) => (
                                <div key={objIndex} style={{
                                    background: 'white',
                                    borderLeft: '3px solid #0077CC',
                                    padding: '15px',
                                    marginLeft: '20px',
                                    marginBottom: '15px',
                                    borderRadius: '4px'
                                }}>
                                    <h4 style={{ color: '#555', marginTop: 0 }}>Objective {objIndex + 1}</h4>
                                    <input
                                        type="text"
                                        placeholder="Objective Title"
                                        value={objective.title}
                                        onChange={(e) => updateObjective(goalIndex, objIndex, 'title', e.target.value)}
                                        style={{
                                            width: '100%',
                                            padding: '8px',
                                            marginBottom: '8px',
                                            border: '1px solid #ddd',
                                            borderRadius: '4px'
                                        }}
                                    />
                                    <input
                                        type="date"
                                        value={objective.dueDate}
                                        onChange={(e) => updateObjective(goalIndex, objIndex, 'dueDate', e.target.value)}
                                        style={{
                                            padding: '8px',
                                            marginBottom: '15px',
                                            border: '1px solid #ddd',
                                            borderRadius: '4px'
                                        }}
                                    />

                                    {objective.assignments.map((assignment, assignIndex) => (
                                        <div key={assignIndex} style={{
                                            background: '#f8f9fa',
                                            padding: '10px',
                                            marginLeft: '20px',
                                            marginBottom: '8px',
                                            borderRadius: '4px'
                                        }}>
                                            <div style={{ color: '#777', fontSize: '0.9em', marginBottom: '5px' }}>
                                                Assignment {assignIndex + 1}
                                            </div>
                                            <input
                                                type="text"
                                                placeholder="Assignment Title"
                                                value={assignment.title}
                                                onChange={(e) => updateAssignment(goalIndex, objIndex, assignIndex, 'title', e.target.value)}
                                                style={{
                                                    width: '100%',
                                                    padding: '6px',
                                                    marginBottom: '6px',
                                                    border: '1px solid #ddd',
                                                    borderRadius: '4px'
                                                }}
                                            />
                                            <input
                                                type="text"
                                                placeholder="Assignment Description"
                                                value={assignment.description}
                                                onChange={(e) => updateAssignment(goalIndex, objIndex, assignIndex, 'description', e.target.value)}
                                                style={{
                                                    width: '100%',
                                                    padding: '6px',
                                                    marginBottom: '6px',
                                                    border: '1px solid #ddd',
                                                    borderRadius: '4px'
                                                }}
                                            />
                                            <input
                                                type="date"
                                                value={assignment.dueDate}
                                                onChange={(e) => updateAssignment(goalIndex, objIndex, assignIndex, 'dueDate', e.target.value)}
                                                style={{
                                                    padding: '6px',
                                                    border: '1px solid #ddd',
                                                    borderRadius: '4px'
                                                }}
                                            />
                                        </div>
                                    ))}

                                    <button
                                        onClick={() => addAssignment(goalIndex, objIndex)}
                                        style={{
                                            marginLeft: '20px',
                                            marginTop: '5px',
                                            background: '#9C27B0',
                                            border: 'none',
                                            borderRadius: '4px',
                                            color: 'white',
                                            padding: '6px 12px',
                                            cursor: 'pointer',
                                            fontSize: '0.85em'
                                        }}
                                    >
                                        + Add Assignment
                                    </button>
                                </div>
                            ))}

                            <button
                                onClick={() => addObjective(goalIndex)}
                                style={{
                                    marginLeft: '20px',
                                    background: '#00A86B',
                                    border: 'none',
                                    borderRadius: '4px',
                                    color: 'white',
                                    padding: '8px 16px',
                                    cursor: 'pointer'
                                }}
                            >
                                + Add Objective
                            </button>
                        </div>
                    ))}

                    <button
                        onClick={addGoal}
                        style={{
                            background: '#4682B4',
                            border: 'none',
                            borderRadius: '6px',
                            color: 'white',
                            padding: '10px 20px',
                            cursor: 'pointer',
                            marginBottom: '20px'
                        }}
                    >
                        + Add Another Goal
                    </button>

                    <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                        <button
                            onClick={onClose}
                            style={{
                                background: '#e0e0e0',
                                border: 'none',
                                borderRadius: '6px',
                                padding: '12px 24px',
                                cursor: 'pointer'
                            }}
                        >
                            Cancel
                        </button>
                        <button
                            onClick={handleGoldenThreadSubmit}
                            style={{
                                background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                border: 'none',
                                borderRadius: '6px',
                                color: 'white',
                                padding: '12px 24px',
                                cursor: 'pointer',
                                fontWeight: 'bold'
                            }}
                        >
                            Create Golden Thread
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    return (
        <div className="modal-overlay" style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0,0,0,0.5)',
            display: 'flex',
            justifyContent: 'center',
            alignItems: 'center',
            zIndex: 1000
        }}>
            <div style={{
                background: 'white',
                borderRadius: '12px',
                width: '90%',
                maxWidth: '500px',
                padding: '30px'
            }}>
                <div style={{
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    marginBottom: '20px'
                }}>
                    <h2 style={{ margin: 0 }}>
                        {type === 'goal' && 'Add New Goal'}
                        {type === 'objective' && `Add Objective to: ${selectedParent?.title}`}
                        {type === 'assignment' && `Add Assignment to: ${selectedParent?.title}`}
                        {type === 'milestone' && 'Add Custom Milestone'}
                    </h2>
                    <button
                        onClick={onClose}
                        style={{
                            background: 'none',
                            border: 'none',
                            fontSize: '24px',
                            cursor: 'pointer'
                        }}
                    >
                        ×
                    </button>
                </div>

                <form onSubmit={(e) => {
                    e.preventDefault();
                    onSubmit({...singleFormData, ...selectedParent});
                }}>
                    <input
                        type="text"
                        placeholder="Title"
                        value={singleFormData.title}
                        onChange={(e) => setSingleFormData({...singleFormData, title: e.target.value})}
                        required
                        style={{
                            width: '100%',
                            padding: '10px',
                            marginBottom: '15px',
                            border: '1px solid #ddd',
                            borderRadius: '6px'
                        }}
                    />

                    {(type === 'goal' || type === 'assignment' || type === 'milestone') && (
                        <textarea
                            placeholder="Description"
                            value={singleFormData.description}
                            onChange={(e) => setSingleFormData({...singleFormData, description: e.target.value})}
                            style={{
                                width: '100%',
                                padding: '10px',
                                marginBottom: '15px',
                                border: '1px solid #ddd',
                                borderRadius: '6px',
                                minHeight: '80px'
                            }}
                        />
                    )}

                    <input
                        type="date"
                        value={singleFormData.dueDate || singleFormData.targetDate}
                        onChange={(e) => setSingleFormData({
                            ...singleFormData,
                            dueDate: e.target.value,
                            targetDate: e.target.value
                        })}
                        style={{
                            width: '100%',
                            padding: '10px',
                            marginBottom: '15px',
                            border: '1px solid #ddd',
                            borderRadius: '6px'
                        }}
                    />

                    <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                        <button
                            type="button"
                            onClick={onClose}
                            style={{
                                background: '#e0e0e0',
                                border: 'none',
                                borderRadius: '6px',
                                padding: '10px 20px',
                                cursor: 'pointer'
                            }}
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            style={{
                                background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                border: 'none',
                                borderRadius: '6px',
                                color: 'white',
                                padding: '10px 20px',
                                cursor: 'pointer',
                                fontWeight: 'bold'
                            }}
                        >
                            Create
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
}

        // ==========================================
        // ROOT APP COMPONENT
        // ==========================================
        function GoalsApp() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [searchQuery, setSearchQuery] = useState('');

            useEffect(() => {
                const unsubscribe = firebase.auth().onAuthStateChanged(async (firebaseUser) => {
                    if (firebaseUser) {
                        const userDoc = await firebase.firestore()
                            .collection('users')
                            .doc(firebaseUser.uid)
                            .get();

                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            // Allow coach, admin, superadmin
                            if (['coach', 'admin', 'superadmin'].includes(userData.role)) {
                                setUser({ uid: firebaseUser.uid, ...userData });
                            } else {
                                alert('Access denied. Coach/Admin access required for Goals Management.');
                                window.location.href = '/';
                            }
                        } else {
                            window.location.href = '/';
                        }
                    } else {
                        window.location.href = '/';
                    }
                    setLoading(false);
                });

                return () => unsubscribe();
            }, []);

            if (loading) {
                return (
                    <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        minHeight: '100vh',
                        background: '#f5f7fa'
                    }}>
                        <div style={{
                            width: '60px',
                            height: '60px',
                            border: '4px solid #f3f3f3',
                            borderTop: '4px solid var(--primary-color)',
                            borderRadius: '50%',
                            animation: 'spin 1s linear infinite'
                        }}></div>
                    </div>
                );
            }

            return (
                <div style={{ display: 'flex', minHeight: '100vh', background: '#f5f7fa' }}>
                    <Sidebar user={user} />
                    <div style={{
                        flex: 1,
                        marginLeft: '280px',
                        transition: 'margin-left 0.3s'
                    }}>
                        <GoalsView user={user} searchQuery={searchQuery} />
                    </div>
                </div>
            );
        }

        // Render the app
        ReactDOM.render(<GoalsApp />, document.getElementById('root'));

        })(); // End initPage
    </script>

    <!-- NOTE: To complete this page, copy lines 11104-12560 from admin.html -->
    <!-- This includes GoalsView and CreateGoalModal components (1,456 lines total) -->
</body>
</html>
