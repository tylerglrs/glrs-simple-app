  // Destructure React hooks for use in components
const { useState, useEffect, useMemo, useCallback, useRef } = React;

/**
 * @file ProfileTab.js - User profile display and account settings management
 * @description Provides comprehensive profile management with settings, stats, and modals:
 * - Profile display with avatar, stats, and coach info
 * - Account settings (personal info, recovery settings, password, notifications)
 * - Emergency contacts management
 * - Data export functionality
 * - Help, feedback, and legal document access
 * - Account deletion with confirmation
 *
 * @components
 * MAIN COMPONENT (1):
 * - ProfileView: Main profile manager with stats and settings menu
 *
 * MODAL ROUTER (1):
 * - ProfileModals: Routes to 11 different modal types
 *
 * MODAL COMPONENTS (11):
 * - AccountModal: Account settings form
 * - EmergencyModal: Emergency contacts manager
 * - PersonalInfoModal: Personal information editor
 * - RecoveryInfoModal: Recovery settings editor
 * - PasswordModal: Password change form
 * - NotificationSettingsModal: Notification preferences
 * - GoogleCalendarModal: Calendar integration (coming soon)
 * - HelpModal: Help & support information
 * - FeedbackModal: Feedback submission form
 * - ExportModal: Data export options
 * - DeleteAccountModal: Account deletion confirmation
 *
 * @architecture 3-Layer Direct Architecture (Component → Firebase → Component)
 * - ProfileView uses local useState hooks (7 total)
 * - Direct Firebase queries with proper error handling
 * - NO global state dependencies
 * - All modals are props-based with callbacks (NO Firebase)
 * - Modal handlers perform Firebase operations and reload data
 *
 * @firebase 8 Firestore queries:
 * - users: Get user profile data (3 queries)
 * - users: Update user settings (7 update operations in handlers)
 * - checkIns: Query for profile stats calculation
 * - assignments: Query for task completion stats
 * - streaks: Get current streak data
 * - feedback: Add user feedback
 *
 * @refactored November 2025 - Phase 7 complete (THE FINAL TAB)
 * @author GLRS Development Team
 */

/**
 * ProfileView Component
 * @description Main profile manager with stats, coach info, and comprehensive settings menu
 *
 * @features
 * - Profile avatar with upload functionality
 * - Profile completion percentage indicator
 * - Sobriety days counter with milestone display
 * - Stats grid: check-in rate, lifetime task completion, streak, avg mood
 * - Coach information display (if assigned)
 * - 14 settings buttons across 4 sections (Account, Support, About, Sign Out)
 * - Modal system for all 11 settings features
 * - Loading spinner during data fetch
 * - Error UI with retry functionality
 *
 * @state 7 useState hooks:
 * - user: object - Current authenticated user from Firebase Auth
 * - userData: object - User profile data from Firestore
 * - coachInfo: object - Assigned coach data from Firestore
 * - googleConnected: boolean - Google Calendar connection status
 * - loading: boolean - Loading state for Firebase queries
 * - error: string|null - Error message for display
 * - showModal: string|null - Currently displayed modal type
 * - profileStats: object - Calculated stats (5 metrics)
 *
 * @effects 4 useEffect hooks:
 * - Auth listener: Load user from Firebase auth (cleanup on unmount)
 * - User data loader: Load profile data when user changes
 * - Coach info loader: Load coach data when assignedCoach changes
 * - Profile stats loader: Calculate stats when user changes
 *
 * @firebase 3 direct Firestore queries:
 * - users: Get user profile data (with error handling, loading state)
 * - users: Get coach profile data (with error handling)
 * - Multiple queries in loadProfileStats() for stats calculation
 *
 * @modalHandlers 7 Firebase operation handlers:
 * - handleUpdatePersonalInfo: Update user personal data
 * - handleUpdateRecoveryInfo: Update recovery settings
 * - handleChangePassword: Firebase auth password change
 * - handleUpdateNotificationSettings: Update notification preferences
 * - handleSubmitFeedback: Add feedback to Firestore
 * - handleDeleteAccount: Delete Firestore data + Firebase auth account
 * - handleAddEmergencyContact: Add contact to emergencyContacts array
 *
 * @errorHandling
 * - All Firebase queries have try-catch with console.error + handleFirebaseError
 * - User-facing error messages with retry button
 * - Loading state prevents interaction during data fetch
 *
 * @returns {React.Element} Profile display with stats, settings menu, and modal system
 */
function ProfileView() {  // ✅ PHASE 7: Refactored with modals wired + error handling + JSDoc
    // Local state hooks
    const [user, setUser] = useState(null);
    const [userData, setUserData] = useState(null);
    const [coachInfo, setCoachInfo] = useState(null);
    const [googleConnected, setGoogleConnected] = useState(false);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    const [showModal, setShowModal] = useState(null);

    // Mobile responsiveness state
    const [isMobile, setIsMobile] = useState(window.innerWidth < 768);

    const [profileStats, setProfileStats] = useState({
        checkInRate: 0,
        assignmentRate: 0,
        currentStreak: 0,
        avgMood: 0,
        avgCraving: 0
    });

    // Load current user from Firebase auth
    useEffect(() => {
        const unsubscribeAuth = firebase.auth().onAuthStateChanged((authUser) => {
            if (authUser) {
                setUser(authUser);
            } else {
                setUser(null);
            }
        });

        return () => unsubscribeAuth();
    }, []);

    // Initialize Lucide icons on component mount (for always-visible icons)
    useEffect(() => {
        const timer = setTimeout(() => {
            if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') {
                lucide.createIcons();
                console.log('✅ ProfileTab: Initial Lucide icons initialized');
            }
        }, 100);

        return () => clearTimeout(timer);
    }, []);

    // Mobile responsiveness resize listener
    useEffect(() => {
        const handleResize = () => setIsMobile(window.innerWidth < 768);
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
    }, []);

    // Re-initialize Lucide icons when modals open
    useEffect(() => {
        if (showModal) {
            // Small delay to ensure DOM has updated
            const timer = setTimeout(() => {
                if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') {
                    lucide.createIcons();
                    console.log('✅ ProfileTab: Lucide icons initialized for modal');
                } else {
                    console.warn('⚠️ ProfileTab: Lucide library not available');
                }
            }, 150);

            return () => clearTimeout(timer);
        }
    }, [showModal]);

    // Load user profile data
    useEffect(() => {
        if (!user) return;

        const loadUserData = async () => {
            try {
                setLoading(true);

                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    const data = userDoc.data();
                    setUserData(data);
                    setGoogleConnected(!!data.googleCalendar?.connected);

                    // Auto-detect timezone if not set
                    if (!data.timezone) {
                        try {
                            const detectedTimezone = window.GLRSApp?.utils?.getUserTimezone() || 'America/Los_Angeles';
                            await db.collection('users').doc(user.uid).update({
                                timezone: detectedTimezone,
                                timezoneDetectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                timezoneManualOverride: false
                            });
                            console.log(`✅ Auto-detected timezone: ${detectedTimezone}`);
                            // Update local state with new timezone
                            setUserData(prev => ({
                                ...prev,
                                timezone: detectedTimezone,
                                timezoneManualOverride: false
                            }));
                        } catch (tzError) {
                            console.warn('Failed to auto-detect timezone:', tzError);
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                setError('Failed to load profile. Please check your connection and try again.');
                window.handleFirebaseError && window.handleFirebaseError(error, 'ProfileView.loadUserData');
            } finally {
                setLoading(false);
            }
        };

        loadUserData();
    }, [user]);

    // Load coach info
    useEffect(() => {
        if (!userData?.assignedCoach) return;

        const loadCoachInfo = async () => {
            try {
                const coachDoc = await db.collection('users').doc(userData.assignedCoach).get();
                if (coachDoc.exists) {
                    setCoachInfo(coachDoc.data());
                }
            } catch (error) {
                console.error('Error loading coach info:', error);
                window.handleFirebaseError && window.handleFirebaseError(error, 'ProfileView.loadCoachInfo');
                // Don't set error state for coach info - it's not critical for profile display
            }
        };

        loadCoachInfo();
    }, [userData?.assignedCoach]);

    // Calculate profile completion percentage
    const calculateProfileCompletion = () => {
        let completed = 0;
        let total = 10;

        if (userData?.firstName) completed++;
        if (userData?.lastName) completed++;
        if (userData?.phone) completed++;
        if (userData?.sobrietyDate) completed++;
        if (userData?.substance) completed++;
        if (userData?.dailyCost) completed++;
        if (userData?.emergencyContacts?.length > 0) completed++;
        if (userData?.address?.city) completed++;
        if (userData?.profileImageUrl) completed++;
        if (userData?.dateOfBirth) completed++;

        return Math.round((completed / total) * 100);
    };

    // Load profile stats
    useEffect(() => {
        if (!user) return;
        loadProfileStats();
    }, [user]);

    // STEP 1.7H: Initialize Lucide icons after render
    useEffect(() => {
        if (window.lucide && typeof window.lucide.createIcons === 'function') {
            setTimeout(() => {
                window.lucide.createIcons();
            }, 100);
        }
    }, [showModal, userData]);

    const loadProfileStats = async () => {
        if (!user?.uid) return;

        try {
            // Get user's account creation date
            const userDoc = await db.collection('users').doc(user.uid).get();
            const accountCreatedDate = userDoc.data()?.createdAt?.toDate() || new Date();

            // Calculate days since account creation (max 30 days for recent performance)
            const today = new Date();
            const daysSinceCreation = Math.floor((today - accountCreatedDate) / (1000 * 60 * 60 * 24));
            const daysToCheck = Math.min(daysSinceCreation, 30); // Cap at 30 days

            // Skip calculation if account is less than 1 day old
            if (daysToCheck < 1) {
                setProfileStats({
                    checkInRate: 0,
                    assignmentRate: 0,
                    currentStreak: 0,
                    avgMood: 0,
                    avgCraving: 0
                });
                return;
            }

            // Calculate check-in rate based on days since joining
            const dateToCheckFrom = new Date();
            dateToCheckFrom.setDate(dateToCheckFrom.getDate() - daysToCheck);

            const checkInsSnap = await db.collection('checkins')
                .where('userId', '==', user.uid)
                .where('createdAt', '>=', dateToCheckFrom)
                .get();
        
        // COUNT ONLY MORNING CHECK-INS
        let morningCheckInCount = 0;
        let totalMood = 0;
        let totalCraving = 0;
        let moodCount = 0;
        
        checkInsSnap.forEach(doc => {
            const data = doc.data();
            if (data.morningData) {
                morningCheckInCount++;
                
                // Calculate average mood (and craving for potential future use)
                if (data.morningData.mood) {
                    totalMood += data.morningData.mood;
                    moodCount++;
                }
                if (data.morningData.craving) {
                    totalCraving += data.morningData.craving;
                }
            }
        });
        
        // Calculate check-in rate - CAPPED AT 100%
        const checkInRate = Math.min(100, Math.round((morningCheckInCount / daysToCheck) * 100));
        
        // Calculate LIFETIME task completion (all check-ins + reflections + assignments)
const taskCompletion = await calculateLifetimeTaskCompletion(user.uid);

// Get current streak
const streakDoc = await db.collection('streaks').doc(user.uid).get();
const currentStreak = streakDoc.exists ? streakDoc.data().currentStreak || 0 : 0;

// Use the lifetime task completion rate instead of just assignment rate
const assignmentRate = taskCompletion.completionRate; // This is now ALL tasks, not just assignments

setProfileStats({
    checkInRate,
    assignmentRate,  // This now represents total task completion, not just assignments
    currentStreak,
    avgMood: moodCount > 0 ? (totalMood / moodCount).toFixed(1) : 0,
    avgCraving: moodCount > 0 ? (totalCraving / moodCount).toFixed(1) : 0
});
} catch (error) {
    console.error('Error loading profile stats:', error);
    window.handleFirebaseError && window.handleFirebaseError(error, 'ProfileView.loadProfileStats');
    // Set default stats on error so UI doesn't show incorrect 0%
    setProfileStats({
        checkInRate: 0,
        assignmentRate: 0,
        currentStreak: 0,
        avgMood: 0,
        avgCraving: 0
    });
}
};

/**
 * Helper: Calculate Lifetime Task Completion
 * @description Calculates overall task completion rate across all recovery activities
 * @param {string} userId - Firebase user ID
 * @returns {Promise<object>} Completion stats with rate, totals, and breakdown
 * @firebase 3 Firestore queries (users, checkIns, assignments)
 */
const calculateLifetimeTaskCompletion = async (userId) => {
    try {
        // Get user's account creation date
        const userDoc = await db.collection('users').doc(userId).get();
        const accountCreatedDate = userDoc.data()?.createdAt?.toDate() || new Date();
        
        // Calculate total days since joining
        const today = new Date();
        const daysSinceJoining = Math.floor((today - accountCreatedDate) / (1000 * 60 * 60 * 24)) + 1; // +1 to include today
        
        // Get ALL check-ins (no date filter for lifetime)
        const checkInsSnap = await db.collection('checkins')
            .where('userId', '==', userId)
            .get();
        
        // Count morning check-ins and evening reflections separately
        let morningCheckInsCompleted = 0;
        let eveningReflectionsCompleted = 0;
        
        checkInsSnap.forEach(doc => {
            const data = doc.data();
            if (data.morningData) {
                morningCheckInsCompleted++;
            }
            if (data.eveningData) {
                eveningReflectionsCompleted++;
            }
        });
        
        // Get ALL assignments (lifetime)
        const assignmentsSnap = await db.collection('assignments')
            .where('userId', '==', userId)
            .get();
        
        let totalAssignments = 0;
        let completedAssignments = 0;
        
        assignmentsSnap.forEach(doc => {
            totalAssignments++;
            if (doc.data().status === 'completed') {
                completedAssignments++;
            }
        });
        
        // Calculate totals
        const expectedDailyTasks = daysSinceJoining * 2; // Morning + Evening each day
        const totalExpectedTasks = expectedDailyTasks + totalAssignments;
        const totalCompletedTasks = morningCheckInsCompleted + eveningReflectionsCompleted + completedAssignments;
        
        // Calculate percentage
        const completionRate = totalExpectedTasks > 0 ? 
            Math.round((totalCompletedTasks / totalExpectedTasks) * 100) : 0;
        
        return {
            completionRate,
            totalCompleted: totalCompletedTasks,
            totalExpected: totalExpectedTasks,
            breakdown: {
                morningCheckIns: morningCheckInsCompleted,
                eveningReflections: eveningReflectionsCompleted,
                assignments: completedAssignments,
                expectedDailyTasks: expectedDailyTasks,
                totalAssignments: totalAssignments
            }
        };
    } catch (error) {
        return {
            completionRate: 0,
            totalCompleted: 0,
            totalExpected: 0
        };
    }
};

    const handleFileInputChange = (e) => {
    const file = e.target.files[0];
    if (file) {
        handleImageSelect(file);  // Call app object function
    }
};

// Modal callback handlers
const handleUpdatePersonalInfo = async (updates) => {
    try {
        await db.collection('users').doc(user.uid).update(updates);
        // Reload user data to reflect changes
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists) {
            setUserData(userDoc.data());
        }
    } catch (error) {
        console.error('Error updating personal info:', error);
        window.handleFirebaseError && window.handleFirebaseError(error, 'ProfileView.handleUpdatePersonalInfo');
        throw error; // Re-throw so modal can handle alert
    }
};

const handleUpdateRecoveryInfo = async (updates) => {
    try {
        await db.collection('users').doc(user.uid).update(updates);
        // Reload user data
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists) {
            setUserData(userDoc.data());
        }
    } catch (error) {
        console.error('Error updating recovery info:', error);
        window.handleFirebaseError && window.handleFirebaseError(error, 'ProfileView.handleUpdateRecoveryInfo');
        throw error;
    }
};

const handleChangePassword = async (currentPassword, newPassword) => {
    try {
        const credential = firebase.auth.EmailAuthProvider.credential(
            user.email,
            currentPassword
        );
        await user.reauthenticateWithCredential(credential);
        await user.updatePassword(newPassword);
    } catch (error) {
        console.error('Error changing password:', error);
        window.handleFirebaseError && window.handleFirebaseError(error, 'ProfileView.handleChangePassword');
        throw error;
    }
};

const handleUpdateNotificationSettings = async (updates) => {
    try {
        await db.collection('users').doc(user.uid).update(updates);
        // Reload user data
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists) {
            setUserData(userDoc.data());
        }
    } catch (error) {
        console.error('Error updating notification settings:', error);
        window.handleFirebaseError && window.handleFirebaseError(error, 'ProfileView.handleUpdateNotificationSettings');
        throw error;
    }
};

const handleSubmitFeedback = async (feedbackData) => {
    try {
        await db.collection('feedback').add({
            ...feedbackData,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (error) {
        console.error('Error submitting feedback:', error);
        window.handleFirebaseError && window.handleFirebaseError(error, 'ProfileView.handleSubmitFeedback');
        throw error;
    }
};

const handleDeleteAccount = async (userId) => {
    try {
        // Delete user data from Firestore
        await db.collection('users').doc(userId).delete();
        // Delete Firebase auth account
        await user.delete();
    } catch (error) {
        console.error('Error deleting account:', error);
        window.handleFirebaseError && window.handleFirebaseError(error, 'ProfileView.handleDeleteAccount');
        throw error;
    }
};

const handleAddEmergencyContact = async (newContact) => {
    try {
        const currentContacts = userData?.emergencyContacts || [];
        await db.collection('users').doc(user.uid).update({
            emergencyContacts: [...currentContacts, newContact]
        });
        // Reload user data
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists) {
            setUserData(userDoc.data());
        }
    } catch (error) {
        console.error('Error adding emergency contact:', error);
        window.handleFirebaseError && window.handleFirebaseError(error, 'ProfileView.handleAddEmergencyContact');
        throw error;
    }
};

// Handler for profile visibility settings (PHASE 5)
const handleUpdateProfileVisibility = async (visibilitySettings) => {
    try {
        await db.collection('users').doc(user.uid).update({
            profileVisibility: visibilitySettings
        });
        // Reload user data
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists) {
            setUserData(userDoc.data());
        }
    } catch (error) {
        console.error('Error updating profile visibility:', error);
        window.handleFirebaseError && window.handleFirebaseError(error, 'ProfileView.handleUpdateProfileVisibility');
        throw error;
    }
};

// Handler for privacy settings (Step 1.3)
const handleUpdatePrivacySettings = async (updates) => {
    try {
        await db.collection('users').doc(user.uid).update(updates);
        // Reload user data
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists) {
            setUserData(userDoc.data());
        }
    } catch (error) {
        console.error('Error updating privacy settings:', error);
        window.handleFirebaseError && window.handleFirebaseError(error, 'ProfileView.handleUpdatePrivacySettings');
        throw error;
    }
};

const profileCompletion = calculateProfileCompletion();

// Loading State UI
if (loading) {
    return (
        <div style={{
            textAlign: 'center',
            color: 'white',
            padding: isMobile ? '40px 12px' : '60px 20px',
            background: 'rgba(255,255,255,0.1)',
            borderRadius: isMobile ? '15px' : '20px',
            margin: isMobile ? '12px' : '20px'
        }}>
            <div className="spinner" style={{
                width: isMobile ? '40px' : '48px',
                height: isMobile ? '40px' : '48px',
                border: '4px solid rgba(255,255,255,0.3)',
                borderTop: '4px solid white',
                borderRadius: '50%',
                animation: 'spin 1s linear infinite',
                margin: '0 auto 20px auto'
            }}></div>
            <p style={{
                fontSize: isMobile ? '14px' : '16px',
                opacity: 0.9
            }}>Loading profile...</p>
        </div>
    );
}

// Error State UI
if (error) {
    return (
        <div style={{
            background: 'rgba(255,255,255,0.95)',
            borderRadius: isMobile ? '15px' : '20px',
            padding: isMobile ? '30px 20px' : '40px',
            textAlign: 'center',
            margin: isMobile ? '12px' : '20px'
        }}>
            <i data-lucide="alert-circle" style={{
                width: isMobile ? '48px' : '64px',
                height: isMobile ? '48px' : '64px',
                color: '#ef4444',
                marginBottom: isMobile ? '15px' : '20px'
            }}></i>
            <h3 style={{
                color: '#ef4444',
                margin: '0 0 12px 0',
                fontSize: isMobile ? '18px' : '20px'
            }}>
                Error Loading Profile
            </h3>
            <p style={{
                color: '#666',
                margin: '0 0 24px 0',
                fontSize: isMobile ? '14px' : '16px',
                lineHeight: '1.5'
            }}>
                {error}
            </p>
            <button
                onClick={() => {
                    setError(null);
                    setLoading(true);
                    // The useEffect will re-run and reload profile data
                }}
                style={{
                    padding: isMobile ? '10px 20px' : '12px 24px',
                    background: '#764ba2',
                    color: 'white',
                    border: 'none',
                    borderRadius: isMobile ? '8px' : '10px',
                    cursor: 'pointer',
                    fontSize: isMobile ? '14px' : '16px',
                    fontWeight: 'bold',
                    transition: 'all 0.3s',
                    minHeight: isMobile ? '44px' : 'auto'
                }}
            >
                Retry
            </button>
        </div>
    );
}

return (
    <>
        <div className="profile-menu">
            {/* STEP 1.7H: REDESIGNED HEADER - TEAL gradient with enhanced legibility */}
            <div className="profile-header" style={{
                background: 'linear-gradient(135deg, #058585 0%, #047272 100%)',
                padding: isMobile ? '20px 16px' : '32px 20px',
                borderRadius: '0',
                marginBottom: '0'
            }}>
                <div style={{
                    display: 'flex',
                    flexDirection: isMobile ? 'column' : 'row',
                    alignItems: isMobile ? 'center' : 'flex-start',
                    gap: '16px'
                }}>
                    {/* 96px Avatar with teal edit icon */}
                    <div style={{position: 'relative'}}>
                        <div
                            className="profile-avatar"
                            onClick={() => {
                                const fileInput = document.getElementById('profile-avatar-input');
                                if (fileInput) fileInput.click();
                            }}
                            style={{
                                width: '96px',
                                height: '96px',
                                fontSize: '36px',
                                cursor: 'pointer',
                                border: '4px solid white',
                                boxShadow: '0 4px 12px rgba(0,0,0,0.2)'
                            }}
                        >
                            {userData?.profileImageUrl ? (
                                <img src={userData.profileImageUrl} alt="Profile" style={{
                                    width: '100%',
                                    height: '100%',
                                    objectFit: 'cover',
                                    borderRadius: '50%'
                                }} />
                            ) : (
                                (userData?.displayName || userData?.firstName || user?.email || 'U').charAt(0).toUpperCase()
                            )}
                        </div>
                        {/* STEP 1.7F: Teal edit icon with shadow */}
                        <div style={{
                            position: 'absolute',
                            bottom: '0',
                            right: '0',
                            width: '32px',
                            height: '32px',
                            background: '#058585',
                            borderRadius: '50%',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            boxShadow: '0 2px 6px rgba(0,0,0,0.2)',
                            cursor: 'pointer'
                        }} onClick={() => {
                            const fileInput = document.getElementById('profile-avatar-input');
                            if (fileInput) fileInput.click();
                        }}>
                            <i data-lucide="edit-3" style={{width: '16px', height: '16px', color: '#ffffff'}}></i>
                        </div>
                        <input
                            id="profile-avatar-input"
                            type="file"
                            accept="image/*"
                            className="upload-input"
                            onChange={handleFileInputChange}
                            style={{display: 'none'}}
                        />
                    </div>

                    {/* Profile info section */}
                    <div style={{
                        flex: 1,
                        textAlign: isMobile ? 'center' : 'left',
                        color: '#ffffff'
                    }}>
                        {/* STEP 1.7F: User name with text shadow for legibility */}
                        <div style={{
                            fontSize: isMobile ? '22px' : '24px',
                            fontWeight: 'bold',
                            marginBottom: '4px',
                            textShadow: '0 2px 4px rgba(0,0,0,0.3)'
                        }}>
                            {userData?.displayName || userData?.firstName || 'User'}
                        </div>

                        {/* STEP 1.7F: Sobriety info with text shadow */}
                        {userData?.sobrietyDate && (
                            <div style={{
                                fontSize: '16px',
                                color: 'rgba(255,255,255,0.9)',
                                marginBottom: '8px',
                                textShadow: '0 1px 3px rgba(0,0,0,0.3)'
                            }}>
                                {window.getSobrietyDays(userData.sobrietyDate)} days sober • Since {new Date(userData.sobrietyDate).toLocaleDateString('en-US', {
                                    timeZone: 'UTC',
                                    month: 'short',
                                    day: 'numeric',
                                    year: 'numeric'
                                })}
                            </div>
                        )}

                        {/* STEP 1.7F: Coach info with user-check icon and text shadow */}
                        {coachInfo && (
                            <div style={{
                                fontSize: '14px',
                                color: 'rgba(255,255,255,0.85)',
                                marginBottom: '8px',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: isMobile ? 'center' : 'flex-start',
                                gap: '6px',
                                textShadow: '0 1px 3px rgba(0,0,0,0.3)'
                            }}>
                                <i data-lucide="user-check" style={{width: '16px', height: '16px'}}></i>
                                Coach: {coachInfo.displayName || coachInfo.firstName + ' ' + coachInfo.lastName}
                            </div>
                        )}

                        {/* STEP 1.7F: Status badges with solid backgrounds and shadows */}
                        <div style={{
                            display: 'flex',
                            gap: '8px',
                            marginTop: '16px',
                            flexWrap: 'wrap',
                            justifyContent: isMobile ? 'center' : 'flex-start'
                        }}>
                            {/* STEP 1.7H: Timezone badge - Clearer label */}
                            {userData?.timezone && (
                                <div style={{
                                    display: 'inline-flex',
                                    alignItems: 'center',
                                    gap: '6px',
                                    padding: '6px 12px',
                                    background: '#058585',
                                    color: 'white',
                                    borderRadius: '20px',
                                    fontSize: '12px',
                                    fontWeight: '600',
                                    boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
                                }}>
                                    <i data-lucide="globe" style={{width: '14px', height: '14px'}}></i>
                                    Timezone: {userData.timezone.split('/')[1]?.replace('_', ' ') || userData.timezone}
                                </div>
                            )}

                            {/* Calendar status badge - Green */}
                            {googleConnected && (
                                <div style={{
                                    display: 'inline-flex',
                                    alignItems: 'center',
                                    gap: '6px',
                                    padding: '6px 12px',
                                    background: '#10b981',
                                    color: 'white',
                                    borderRadius: '20px',
                                    fontSize: '12px',
                                    fontWeight: '600',
                                    boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
                                }}>
                                    <i data-lucide="calendar" style={{width: '14px', height: '14px'}}></i>
                                    Calendar Connected
                                </div>
                            )}

                            {/* Profile completion badge - Amber */}
                            {profileCompletion < 100 && (
                                <div style={{
                                    display: 'inline-flex',
                                    alignItems: 'center',
                                    gap: '6px',
                                    padding: '6px 12px',
                                    background: '#f59e0b',
                                    color: 'white',
                                    borderRadius: '20px',
                                    fontSize: '12px',
                                    fontWeight: '600',
                                    boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
                                }}>
                                    <i data-lucide="check-circle" style={{width: '14px', height: '14px'}}></i>
                                    {profileCompletion}% Complete
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            </div>  {/* Closing profile-header */}
            
            {/* REDESIGNED SETTINGS - 7 Organized Cards with 48px colored icon circles */}
            <div className="menu-section" style={{
                padding: isMobile ? '16px' : '20px'
            }}>
                <div className="menu-title" style={{
                    fontSize: '18px',
                    fontWeight: 'bold',
                    color: '#f4c430',
                    marginBottom: '16px',
                    paddingLeft: '0'
                }}>Settings</div>

                {/* STEP 1.7E: Settings Cards - Facebook Quality with Rounded Square Gradient Icons */}
                <div style={{
                    display: 'flex',
                    flexDirection: 'column',
                    gap: isMobile ? '12px' : '16px'
                }}>
                    {/* 1. Account Settings Card - Blue Gradient */}
                    <div onClick={() => setShowModal('personalInfo')} style={{
                        height: isMobile ? '72px' : '88px',
                        padding: '16px',
                        background: '#ffffff',
                        borderRadius: '16px',
                        border: '1px solid #e5e7eb',
                        boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '16px',
                        cursor: 'pointer',
                        transition: 'all 0.2s ease'
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.borderColor = '#058585';
                        e.currentTarget.style.boxShadow = '0 4px 12px rgba(5, 133, 133, 0.15)';
                        e.currentTarget.style.transform = 'translateY(-2px)';
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.borderColor = '#e5e7eb';
                        e.currentTarget.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.1)';
                        e.currentTarget.style.transform = 'translateY(0)';
                    }}>
                        <div style={{
                            width: isMobile ? '48px' : '56px',
                            height: isMobile ? '48px' : '56px',
                            borderRadius: '16px',
                            background: 'linear-gradient(135deg, #4A90E2 0%, #357ABD 100%)',
                            boxShadow: '0 2px 8px rgba(74, 144, 226, 0.25)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            flexShrink: 0
                        }}>
                            <i data-lucide="user" style={{
                                width: isMobile ? '24px' : '28px',
                                height: isMobile ? '24px' : '28px',
                                color: '#ffffff',
                                strokeWidth: 2
                            }}></i>
                        </div>
                        <div style={{flex: 1}}>
                            <div style={{fontSize: '16px', fontWeight: '700', marginBottom: '4px', color: '#111827'}}>Account</div>
                            <div style={{fontSize: '13px', color: '#6b7280'}}>Email, password, basic info</div>
                        </div>
                        <i data-lucide="chevron-right" style={{width: '20px', height: '20px', color: '#9ca3af'}}></i>
                    </div>

                    {/* 2. Recovery Settings Card - Green Gradient */}
                    <div onClick={() => setShowModal('recoveryInfo')} style={{
                        height: isMobile ? '72px' : '88px',
                        padding: '16px',
                        background: '#ffffff',
                        borderRadius: '16px',
                        border: '1px solid #e5e7eb',
                        boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '16px',
                        cursor: 'pointer',
                        transition: 'all 0.2s ease'
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.borderColor = '#058585';
                        e.currentTarget.style.boxShadow = '0 4px 12px rgba(5, 133, 133, 0.15)';
                        e.currentTarget.style.transform = 'translateY(-2px)';
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.borderColor = '#e5e7eb';
                        e.currentTarget.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.1)';
                        e.currentTarget.style.transform = 'translateY(0)';
                    }}>
                        <div style={{
                            width: isMobile ? '48px' : '56px',
                            height: isMobile ? '48px' : '56px',
                            borderRadius: '16px',
                            background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                            boxShadow: '0 2px 8px rgba(16, 185, 129, 0.25)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            flexShrink: 0
                        }}>
                            <i data-lucide="heart" style={{
                                width: isMobile ? '24px' : '28px',
                                height: isMobile ? '24px' : '28px',
                                color: '#ffffff',
                                strokeWidth: 2
                            }}></i>
                        </div>
                        <div style={{flex: 1}}>
                            <div style={{fontSize: '16px', fontWeight: '700', marginBottom: '4px', color: '#111827'}}>Recovery</div>
                            <div style={{fontSize: '13px', color: '#6b7280'}}>Sobriety date, substances, daily cost</div>
                        </div>
                        <i data-lucide="chevron-right" style={{width: '20px', height: '20px', color: '#9ca3af'}}></i>
                    </div>

                    {/* 3. Coach & Emergency Card - Purple Gradient */}
                    <div onClick={() => setShowModal('emergency')} style={{
                        height: isMobile ? '72px' : '88px',
                        padding: '16px',
                        background: '#ffffff',
                        borderRadius: '16px',
                        border: '1px solid #e5e7eb',
                        boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '16px',
                        cursor: 'pointer',
                        transition: 'all 0.2s ease'
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.borderColor = '#058585';
                        e.currentTarget.style.boxShadow = '0 4px 12px rgba(5, 133, 133, 0.15)';
                        e.currentTarget.style.transform = 'translateY(-2px)';
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.borderColor = '#e5e7eb';
                        e.currentTarget.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.1)';
                        e.currentTarget.style.transform = 'translateY(0)';
                    }}>
                        <div style={{
                            width: isMobile ? '48px' : '56px',
                            height: isMobile ? '48px' : '56px',
                            borderRadius: '16px',
                            background: 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)',
                            boxShadow: '0 2px 8px rgba(139, 92, 246, 0.25)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            flexShrink: 0
                        }}>
                            <i data-lucide="users" style={{
                                width: isMobile ? '24px' : '28px',
                                height: isMobile ? '24px' : '28px',
                                color: '#ffffff',
                                strokeWidth: 2
                            }}></i>
                        </div>
                        <div style={{flex: 1}}>
                            <div style={{fontSize: '16px', fontWeight: '700', marginBottom: '4px', color: '#111827'}}>Coach & Emergency</div>
                            <div style={{fontSize: '13px', color: '#6b7280'}}>Assigned coach, emergency contacts</div>
                        </div>
                        <i data-lucide="chevron-right" style={{width: '20px', height: '20px', color: '#9ca3af'}}></i>
                    </div>

                    {/* 4. Notifications Card - Orange Gradient */}
                    <div onClick={() => setShowModal('notificationSettings')} style={{
                        height: isMobile ? '72px' : '88px',
                        padding: '16px',
                        background: '#ffffff',
                        borderRadius: '16px',
                        border: '1px solid #e5e7eb',
                        boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '16px',
                        cursor: 'pointer',
                        transition: 'all 0.2s ease'
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.borderColor = '#058585';
                        e.currentTarget.style.boxShadow = '0 4px 12px rgba(5, 133, 133, 0.15)';
                        e.currentTarget.style.transform = 'translateY(-2px)';
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.borderColor = '#e5e7eb';
                        e.currentTarget.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.1)';
                        e.currentTarget.style.transform = 'translateY(0)';
                    }}>
                        <div style={{
                            width: isMobile ? '48px' : '56px',
                            height: isMobile ? '48px' : '56px',
                            borderRadius: '16px',
                            background: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
                            boxShadow: '0 2px 8px rgba(245, 158, 11, 0.25)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            flexShrink: 0
                        }}>
                            <i data-lucide="bell" style={{
                                width: isMobile ? '24px' : '28px',
                                height: isMobile ? '24px' : '28px',
                                color: '#ffffff',
                                strokeWidth: 2
                            }}></i>
                        </div>
                        <div style={{flex: 1}}>
                            <div style={{fontSize: '16px', fontWeight: '700', marginBottom: '4px', color: '#111827'}}>Notifications</div>
                            <div style={{fontSize: '13px', color: '#6b7280'}}>Alerts, reminders, quiet hours</div>
                        </div>
                        <i data-lucide="chevron-right" style={{width: '20px', height: '20px', color: '#9ca3af'}}></i>
                    </div>

                    {/* 5. Calendar Card - Teal Gradient */}
                    <div onClick={() => setShowModal('googleCalendar')} style={{
                        height: isMobile ? '72px' : '88px',
                        padding: '16px',
                        background: '#ffffff',
                        borderRadius: '16px',
                        border: '1px solid #e5e7eb',
                        boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '16px',
                        cursor: 'pointer',
                        transition: 'all 0.2s ease'
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.borderColor = '#058585';
                        e.currentTarget.style.boxShadow = '0 4px 12px rgba(5, 133, 133, 0.15)';
                        e.currentTarget.style.transform = 'translateY(-2px)';
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.borderColor = '#e5e7eb';
                        e.currentTarget.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.1)';
                        e.currentTarget.style.transform = 'translateY(0)';
                    }}>
                        <div style={{
                            width: isMobile ? '48px' : '56px',
                            height: isMobile ? '48px' : '56px',
                            borderRadius: '16px',
                            background: 'linear-gradient(135deg, #058585 0%, #047272 100%)',
                            boxShadow: '0 2px 8px rgba(5, 133, 133, 0.25)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            flexShrink: 0
                        }}>
                            <i data-lucide="calendar" style={{
                                width: isMobile ? '24px' : '28px',
                                height: isMobile ? '24px' : '28px',
                                color: '#ffffff',
                                strokeWidth: 2
                            }}></i>
                        </div>
                        <div style={{flex: 1}}>
                            <div style={{fontSize: '16px', fontWeight: '700', marginBottom: '4px', color: '#111827'}}>Calendar</div>
                            <div style={{fontSize: '13px', color: '#6b7280'}}>
                                Timezone, Google Calendar sync
                                {googleConnected && <span style={{color: '#10b981', marginLeft: '8px', fontWeight: '600'}}>• Connected</span>}
                            </div>
                        </div>
                        <i data-lucide="chevron-right" style={{width: '20px', height: '20px', color: '#9ca3af'}}></i>
                    </div>

                    {/* 6. Privacy Card - Red Gradient */}
                    <div onClick={() => setShowModal('privacySettings')} style={{
                        height: isMobile ? '72px' : '88px',
                        padding: '16px',
                        background: '#ffffff',
                        borderRadius: '16px',
                        border: '1px solid #e5e7eb',
                        boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '16px',
                        cursor: 'pointer',
                        transition: 'all 0.2s ease'
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.borderColor = '#058585';
                        e.currentTarget.style.boxShadow = '0 4px 12px rgba(5, 133, 133, 0.15)';
                        e.currentTarget.style.transform = 'translateY(-2px)';
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.borderColor = '#e5e7eb';
                        e.currentTarget.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.1)';
                        e.currentTarget.style.transform = 'translateY(0)';
                    }}>
                        <div style={{
                            width: isMobile ? '48px' : '56px',
                            height: isMobile ? '48px' : '56px',
                            borderRadius: '16px',
                            background: 'linear-gradient(135deg, #dc2626 0%, #b91c1c 100%)',
                            boxShadow: '0 2px 8px rgba(220, 38, 38, 0.25)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            flexShrink: 0
                        }}>
                            <i data-lucide="shield" style={{
                                width: isMobile ? '24px' : '28px',
                                height: isMobile ? '24px' : '28px',
                                color: '#ffffff',
                                strokeWidth: 2
                            }}></i>
                        </div>
                        <div style={{flex: 1}}>
                            <div style={{fontSize: '16px', fontWeight: '700', marginBottom: '4px', color: '#111827'}}>Privacy</div>
                            <div style={{fontSize: '13px', color: '#6b7280'}}>
                                Visibility, data sharing, blocked users
                                {userData?.privacy?.profileVisibility &&
                                    <span style={{color: '#6b7280', marginLeft: '8px', fontWeight: '600'}}>• {userData.privacy.profileVisibility}</span>
                                }
                            </div>
                        </div>
                        <i data-lucide="chevron-right" style={{width: '20px', height: '20px', color: '#9ca3af'}}></i>
                    </div>

                    {/* 7. Data & Account Card - Gray Gradient */}
                    <div onClick={() => setShowModal('dataManagement')} style={{
                        height: isMobile ? '72px' : '88px',
                        padding: '16px',
                        background: '#ffffff',
                        borderRadius: '16px',
                        border: '1px solid #e5e7eb',
                        boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '16px',
                        cursor: 'pointer',
                        transition: 'all 0.2s ease'
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.borderColor = '#058585';
                        e.currentTarget.style.boxShadow = '0 4px 12px rgba(5, 133, 133, 0.15)';
                        e.currentTarget.style.transform = 'translateY(-2px)';
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.borderColor = '#e5e7eb';
                        e.currentTarget.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.1)';
                        e.currentTarget.style.transform = 'translateY(0)';
                    }}>
                        <div style={{
                            width: isMobile ? '48px' : '56px',
                            height: isMobile ? '48px' : '56px',
                            borderRadius: '16px',
                            background: 'linear-gradient(135deg, #6b7280 0%, #4b5563 100%)',
                            boxShadow: '0 2px 8px rgba(107, 114, 128, 0.25)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            flexShrink: 0
                        }}>
                            <i data-lucide="download" style={{
                                width: isMobile ? '24px' : '28px',
                                height: isMobile ? '24px' : '28px',
                                color: '#ffffff',
                                strokeWidth: 2
                            }}></i>
                        </div>
                        <div style={{flex: 1}}>
                            <div style={{fontSize: '16px', fontWeight: '700', marginBottom: '4px', color: '#111827'}}>Data & Account</div>
                            <div style={{fontSize: '13px', color: '#6b7280'}}>Export data, delete account, cache</div>
                        </div>
                        <i data-lucide="chevron-right" style={{width: '20px', height: '20px', color: '#9ca3af'}}></i>
                    </div>
                </div>
            </div>

            {/* STEP 1.7H: ACCOUNT ACTIVITY - Compact teal-branded account metrics */}
            <div className="menu-section" style={{
                padding: isMobile ? '16px' : '20px'
            }}>
                {/* Section header */}
                <div className="menu-title" style={{
                    fontSize: '20px',
                    fontWeight: 'bold',
                    color: '#f4c430',
                    textTransform: 'uppercase',
                    letterSpacing: '1px',
                    textShadow: '0 1px 2px rgba(0,0,0,0.2)',
                    marginBottom: '16px',
                    paddingLeft: '0'
                }}>Account Activity</div>

                <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(2, 1fr)',
                    gap: '12px'
                }}>
                    {/* Account Age */}
                    <div style={{
                        height: '60px',
                        padding: '12px 16px',
                        background: 'linear-gradient(135deg, rgba(5,133,133,0.08) 0%, rgba(4,114,114,0.05) 100%)',
                        border: '1px solid rgba(5,133,133,0.2)',
                        borderRadius: '12px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px'
                    }}>
                        <div style={{
                            width: '36px',
                            height: '36px',
                            borderRadius: '8px',
                            background: '#058585',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            flexShrink: 0
                        }}>
                            <i data-lucide="calendar-days" style={{width: '20px', height: '20px', color: 'white', strokeWidth: 2}}></i>
                        </div>
                        <div style={{flex: 1, display: 'flex', flexDirection: 'column', gap: '2px'}}>
                            <div style={{fontSize: '18px', fontWeight: '700', color: '#058585'}}>
                                {userData?.createdAt ? Math.floor((Date.now() - new Date(userData.createdAt).getTime()) / (1000 * 60 * 60 * 24)) : 0}
                            </div>
                            <div style={{fontSize: '11px', color: '#6b7280', textTransform: 'uppercase', letterSpacing: '0.5px'}}>
                                DAYS ACTIVE
                            </div>
                        </div>
                    </div>

                    {/* Profile Completion */}
                    <div style={{
                        height: '60px',
                        padding: '12px 16px',
                        background: 'linear-gradient(135deg, rgba(5,133,133,0.08) 0%, rgba(4,114,114,0.05) 100%)',
                        border: '1px solid rgba(5,133,133,0.2)',
                        borderRadius: '12px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px'
                    }}>
                        <div style={{
                            width: '36px',
                            height: '36px',
                            borderRadius: '8px',
                            background: '#058585',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            flexShrink: 0
                        }}>
                            <i data-lucide="user-check" style={{width: '20px', height: '20px', color: 'white', strokeWidth: 2}}></i>
                        </div>
                        <div style={{flex: 1, display: 'flex', flexDirection: 'column', gap: '2px'}}>
                            <div style={{fontSize: '18px', fontWeight: '700', color: '#058585'}}>
                                {profileCompletion}%
                            </div>
                            <div style={{fontSize: '11px', color: '#6b7280', textTransform: 'uppercase', letterSpacing: '0.5px'}}>
                                PROFILE DONE
                            </div>
                        </div>
                    </div>

                    {/* Last Active */}
                    <div style={{
                        height: '60px',
                        padding: '12px 16px',
                        background: 'linear-gradient(135deg, rgba(5,133,133,0.08) 0%, rgba(4,114,114,0.05) 100%)',
                        border: '1px solid rgba(5,133,133,0.2)',
                        borderRadius: '12px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px'
                    }}>
                        <div style={{
                            width: '36px',
                            height: '36px',
                            borderRadius: '8px',
                            background: '#058585',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            flexShrink: 0
                        }}>
                            <i data-lucide="clock" style={{width: '20px', height: '20px', color: 'white', strokeWidth: 2}}></i>
                        </div>
                        <div style={{flex: 1, display: 'flex', flexDirection: 'column', gap: '2px'}}>
                            <div style={{fontSize: '18px', fontWeight: '700', color: '#058585'}}>
                                Today
                            </div>
                            <div style={{fontSize: '11px', color: '#6b7280', textTransform: 'uppercase', letterSpacing: '0.5px'}}>
                                LAST ACTIVE
                            </div>
                        </div>
                    </div>

                    {/* Settings Configured */}
                    <div style={{
                        height: '60px',
                        padding: '12px 16px',
                        background: 'linear-gradient(135deg, rgba(5,133,133,0.08) 0%, rgba(4,114,114,0.05) 100%)',
                        border: '1px solid rgba(5,133,133,0.2)',
                        borderRadius: '12px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px'
                    }}>
                        <div style={{
                            width: '36px',
                            height: '36px',
                            borderRadius: '8px',
                            background: '#058585',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            flexShrink: 0
                        }}>
                            <i data-lucide="settings" style={{width: '20px', height: '20px', color: 'white', strokeWidth: 2}}></i>
                        </div>
                        <div style={{flex: 1, display: 'flex', flexDirection: 'column', gap: '2px'}}>
                            <div style={{fontSize: '18px', fontWeight: '700', color: '#058585'}}>
                                {(userData?.timezone ? 1 : 0) + (userData?.notifications?.enabled ? 1 : 0) + (googleConnected ? 1 : 0)} / 7
                            </div>
                            <div style={{fontSize: '11px', color: '#6b7280', textTransform: 'uppercase', letterSpacing: '0.5px'}}>
                                SETTINGS SET
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {/* SIGN OUT & DANGER ZONE */}
            <div className="menu-section" style={{
                padding: isMobile ? '16px' : '20px',
                paddingTop: '24px'
            }}>
                <button
                    className="btn-danger"
                    onClick={window.GLRSApp.authUtils.handleLogout}
                    style={{
                        width: '100%',
                        padding: isMobile ? '12px' : '14px',
                        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        border: 'none',
                        borderRadius: '12px',
                        color: '#ffffff',
                        fontWeight: '600',
                        fontSize: isMobile ? '14px' : '16px',
                        cursor: 'pointer',
                        minHeight: isMobile ? '48px' : '50px',
                        transition: 'all 0.2s ease'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.opacity = '0.9'}
                    onMouseLeave={(e) => e.currentTarget.style.opacity = '1'}
                >
                    Sign Out
                </button>

                {/* Danger Zone */}
                <div style={{
                    marginTop: '24px',
                    padding: '16px',
                    border: '1px solid rgba(220, 38, 38, 0.3)',
                    borderRadius: '12px',
                    background: 'rgba(220, 38, 38, 0.05)'
                }}>
                    <div style={{
                        fontSize: '14px',
                        fontWeight: '600',
                        color: '#dc2626',
                        marginBottom: '8px'
                    }}>
                        Danger Zone
                    </div>
                    <div style={{
                        fontSize: '12px',
                        opacity: 0.7,
                        marginBottom: '12px'
                    }}>
                        Once you delete your account, there is no going back. Please be certain.
                    </div>
                    <button
                        style={{
                            width: '100%',
                            padding: isMobile ? '10px' : '12px',
                            background: 'transparent',
                            border: '1px solid #dc2626',
                            borderRadius: '8px',
                            color: '#dc2626',
                            fontWeight: '600',
                            fontSize: '14px',
                            cursor: 'pointer',
                            minHeight: isMobile ? '44px' : 'auto',
                            transition: 'all 0.2s ease'
                        }}
                        onClick={() => setShowModal('deleteAccount')}
                        onMouseEnter={(e) => {
                            e.currentTarget.style.background = '#dc2626';
                            e.currentTarget.style.color = '#ffffff';
                        }}
                        onMouseLeave={(e) => {
                            e.currentTarget.style.background = 'transparent';
                            e.currentTarget.style.color = '#dc2626';
                        }}
                    >
                        Delete Account
                    </button>
                </div>
            </div>
        </div>

            {/* Render Modals */}
            {showModal && (
                <ProfileModals
                    modalType={showModal}
                    userData={userData}
                    user={user}
                    onClose={() => setShowModal(null)}
                    onUpdatePersonalInfo={handleUpdatePersonalInfo}
                    onUpdateRecoveryInfo={handleUpdateRecoveryInfo}
                    onChangePassword={handleChangePassword}
                    onUpdateNotificationSettings={handleUpdateNotificationSettings}
                    onUpdatePrivacySettings={handleUpdatePrivacySettings}
                    onSubmitFeedback={handleSubmitFeedback}
                    onDeleteAccount={handleDeleteAccount}
                    onOpenModal={setShowModal}
                    onAddEmergencyContact={handleAddEmergencyContact}
                    onUpdateProfileVisibility={handleUpdateProfileVisibility}
                />
            )}
        </>
    );
}

// Expose ProfileView to global namespace
window.GLRSApp.components.ProfileView = ProfileView;

console.log('✅ PHASE 7: ProfileView component loaded - THE FINAL TAB complete!');

/**
 * ProfileModals Router Component
 * @description Routes to 11 different modal types based on modalType prop
 * @props All props passed through to child modals (userData, user, callbacks)
 * @architecture Props-based, NO Firebase (all operations via callbacks)
 */
function ProfileModals({
    modalType,
    userData,
    user,
    onClose,
    onUpdatePersonalInfo,
    onUpdateRecoveryInfo,
    onChangePassword,
    onUpdateNotificationSettings,
    onUpdatePrivacySettings,
    onSubmitFeedback,
    onDeleteAccount,
    onOpenModal,
    onAddEmergencyContact,
    onUpdateProfileVisibility
}) {
    // STEP 1.9: Add animation state for fade-in/scale-in effects
    const [isAnimating, setIsAnimating] = React.useState(false);

    // STEP 1.9: Animation timing - trigger fade-in after render
    React.useEffect(() => {
        if (modalType) {
            setTimeout(() => setIsAnimating(true), 10);
        } else {
            setIsAnimating(false);
        }
    }, [modalType]);

    // STEP 1.9: Body scroll lock when modal is open
    React.useEffect(() => {
        if (modalType) {
            document.body.style.overflow = 'hidden';
        }
        return () => {
            document.body.style.overflow = '';
        };
    }, [modalType]);

    // STEP 1.9: ESC key handler to close modal
    React.useEffect(() => {
        const handleEsc = (e) => {
            if (e.key === 'Escape' && modalType) {
                onClose();
            }
        };
        document.addEventListener('keydown', handleEsc);
        return () => document.removeEventListener('keydown', handleEsc);
    }, [modalType, onClose]);

    const renderModalContent = () => {
        switch(modalType) {
            case 'account':
                return <PersonalInfoModal userData={userData} user={user} onClose={onClose} onUpdate={onUpdatePersonalInfo} />;
            case 'activity':
                return <AccountActivityModal onClose={onClose} onOpenModal={onOpenModal} userData={userData} user={user} />;
            case 'emergency':
                return <EmergencyModal userData={userData} user={user} onClose={onClose} onAddEmergencyContact={onAddEmergencyContact} />;
            case 'personalInfo':
                return <PersonalInfoModal userData={userData} user={user} onClose={onClose} onUpdate={onUpdatePersonalInfo} />;
            case 'recoveryInfo':
                return <RecoveryInfoModal userData={userData} user={user} onClose={onClose} onUpdate={onUpdateRecoveryInfo} />;
            case 'password':
                return <PasswordModal user={user} onClose={onClose} onSubmit={onChangePassword} />;
            case 'notificationSettings':
                return <NotificationSettingsModal userData={userData} user={user} onClose={onClose} onUpdate={onUpdateNotificationSettings} />;
            case 'privacySettings':
                return <PrivacySettingsModal userData={userData} user={user} onClose={onClose} onUpdate={onUpdatePrivacySettings} />;
            case 'dataManagement':
                return <DataManagementModal userData={userData} user={user} onClose={onClose} />;
            case 'profileVisibility':
                return <ProfileVisibilityModal userData={userData} user={user} onClose={onClose} onUpdate={onUpdateProfileVisibility} />;
            case 'googleCalendar':
                return <GoogleCalendarModal userData={userData} user={user} onClose={onClose} />;
            case 'help':
                return <HelpModal onClose={onClose} />;
            case 'feedback':
                return <FeedbackModal userData={userData} user={user} onClose={onClose} onSubmit={onSubmitFeedback} />;
            case 'export':
                return <ExportModal onClose={onClose} />;
            case 'deleteAccount':
                return <DeleteAccountModal user={user} onClose={onClose} onDelete={onDeleteAccount} />;
            default:
                return null;
        }
    };

    // STEP 1.9: Don't render if no modal is active
    if (!modalType) return null;

    // STEP 1.9: Return modal with backdrop + container wrapper
    return (
        <div
            className="modal-backdrop"
            onClick={onClose}
            style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0, 0, 0, 0.5)',
                zIndex: 9998,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                opacity: isAnimating ? 1 : 0,
                transition: 'opacity 200ms ease-out'
            }}
        >
            <div
                className="modal-container"
                onClick={(e) => e.stopPropagation()}
                style={{
                    position: 'relative',
                    zIndex: 9999,
                    background: '#ffffff',
                    borderRadius: '16px',
                    maxWidth: '600px',
                    maxHeight: '90vh',
                    width: '90%',
                    boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
                    overflow: 'hidden',
                    transform: isAnimating ? 'scale(1)' : 'scale(0.95)',
                    opacity: isAnimating ? 1 : 0,
                    transition: 'all 200ms ease-out'
                }}
            >
                {renderModalContent()}
            </div>
        </div>
    );
}

/** AccountActivityModal - Display account activity stats and information */
function AccountActivityModal({ userData, user, onClose, onOpenModal }) {
    // STEP 1.10: Initialize form data with current userData
    const [formData, setFormData] = React.useState({
        firstName: userData?.firstName || '',
        lastName: userData?.lastName || '',
        phone: userData?.phone || '',
        email: userData?.email || user?.email || '',
        street: userData?.address?.street || '',
        city: userData?.address?.city || '',
        state: userData?.address?.state || '',
        zip: userData?.address?.zip || ''
    });

    const [saving, setSaving] = React.useState(false);

    // STEP 1.23: Mobile detection for responsive layout
    const [isMobile, setIsMobile] = React.useState(window.innerWidth < 768);

    React.useEffect(() => {
        const handleResize = () => setIsMobile(window.innerWidth < 768);
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
    }, []);

    // STEP 1.10: Save handler with direct Firestore update
    const handleSave = async () => {
        setSaving(true);
        try {
            const updates = {
                firstName: formData.firstName,
                lastName: formData.lastName,
                displayName: `${formData.firstName} ${formData.lastName}`,
                phone: formData.phone,
                address: {
                    street: formData.street,
                    city: formData.city,
                    state: formData.state,
                    zip: formData.zip
                }
            };

            await db.collection('users').doc(user.uid).update(updates);
            window.showNotification('Account updated successfully', 'success');
            onClose();
        } catch (error) {
            console.error('Error saving account:', error);
            window.handleFirebaseError && window.handleFirebaseError(error, 'AccountModal.handleSave');
            alert('Failed to save changes. Please try again.');
        } finally {
            setSaving(false);
        }
    };

    // STEP 1.10: Initialize Lucide icons after render
    React.useEffect(() => {
        if (window.lucide && typeof window.lucide.createIcons === 'function') {
            window.lucide.createIcons();
        }
    }, []);

    return (
        <>
            {/* STEP 1.10: HEADER - Title + Close Button */}
            <div style={{
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                padding: '24px',
                borderBottom: '1px solid #e5e7eb'
            }}>
                <h2 style={{
                    fontSize: '24px',
                    fontWeight: '700',
                    color: '#111827',
                    margin: 0
                }}>
                    Account Settings
                </h2>
                <button
                    onClick={onClose}
                    style={{
                        background: 'none',
                        border: 'none',
                        cursor: 'pointer',
                        padding: '8px',
                        borderRadius: '8px',
                        transition: 'background 0.2s',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.background = '#f3f4f6'}
                    onMouseLeave={(e) => e.currentTarget.style.background = 'none'}
                >
                    <i data-lucide="x" style={{width: '24px', height: '24px', color: '#6b7280'}}></i>
                </button>
            </div>

            {/* STEP 1.10: BODY - Scrollable Form */}
            <div style={{
                padding: '24px',
                overflowY: 'auto',
                maxHeight: 'calc(90vh - 160px)'
            }}>
                {/* Personal Info */}
                <div style={{ marginBottom: '20px' }}>
                    <label style={{
                        display: 'block',
                        fontSize: '14px',
                        fontWeight: '600',
                        color: '#374151',
                        marginBottom: '6px'
                    }}>
                        First Name
                    </label>
                    <input
                        type="text"
                        value={formData.firstName}
                        onChange={(e) => setFormData({...formData, firstName: e.target.value})}
                        style={{
                            width: '100%',
                            padding: '10px 14px',
                            border: '1px solid #d1d5db',
                            borderRadius: '8px',
                            fontSize: '15px',
                            color: '#111827',
                            transition: 'border-color 0.2s',
                            boxSizing: 'border-box'
                        }}
                        onFocus={(e) => e.currentTarget.style.borderColor = '#058585'}
                        onBlur={(e) => e.currentTarget.style.borderColor = '#d1d5db'}
                    />
                </div>

                <div style={{ marginBottom: '20px' }}>
                    <label style={{
                        display: 'block',
                        fontSize: '14px',
                        fontWeight: '600',
                        color: '#374151',
                        marginBottom: '6px'
                    }}>
                        Last Name
                    </label>
                    <input
                        type="text"
                        value={formData.lastName}
                        onChange={(e) => setFormData({...formData, lastName: e.target.value})}
                        style={{
                            width: '100%',
                            padding: '10px 14px',
                            border: '1px solid #d1d5db',
                            borderRadius: '8px',
                            fontSize: '15px',
                            color: '#111827',
                            transition: 'border-color 0.2s',
                            boxSizing: 'border-box'
                        }}
                        onFocus={(e) => e.currentTarget.style.borderColor = '#058585'}
                        onBlur={(e) => e.currentTarget.style.borderColor = '#d1d5db'}
                    />
                </div>

                <div style={{ marginBottom: '20px' }}>
                    <label style={{
                        display: 'block',
                        fontSize: '14px',
                        fontWeight: '600',
                        color: '#374151',
                        marginBottom: '6px'
                    }}>
                        Phone
                    </label>
                    <input
                        type="tel"
                        value={formData.phone}
                        onChange={(e) => setFormData({...formData, phone: e.target.value})}
                        placeholder="(555) 555-5555"
                        style={{
                            width: '100%',
                            padding: '10px 14px',
                            border: '1px solid #d1d5db',
                            borderRadius: '8px',
                            fontSize: '15px',
                            color: '#111827',
                            transition: 'border-color 0.2s',
                            boxSizing: 'border-box'
                        }}
                        onFocus={(e) => e.currentTarget.style.borderColor = '#058585'}
                        onBlur={(e) => e.currentTarget.style.borderColor = '#d1d5db'}
                    />
                </div>

                <div style={{ marginBottom: '20px' }}>
                    <label style={{
                        display: 'block',
                        fontSize: '14px',
                        fontWeight: '600',
                        color: '#374151',
                        marginBottom: '6px'
                    }}>
                        Email (Cannot be changed)
                    </label>
                    <input
                        type="email"
                        value={formData.email}
                        disabled
                        style={{
                            width: '100%',
                            padding: '10px 14px',
                            border: '1px solid #d1d5db',
                            borderRadius: '8px',
                            fontSize: '15px',
                            color: '#6b7280',
                            background: '#f9fafb',
                            cursor: 'not-allowed',
                            boxSizing: 'border-box'
                        }}
                    />
                </div>

                {/* Address Section */}
                <div style={{
                    marginTop: '32px',
                    marginBottom: '20px',
                    paddingTop: '20px',
                    borderTop: '1px solid #e5e7eb'
                }}>
                    <h3 style={{
                        fontSize: '16px',
                        fontWeight: '600',
                        color: '#111827',
                        marginBottom: '16px'
                    }}>
                        Address
                    </h3>

                    <div style={{ marginBottom: '20px' }}>
                        <label style={{
                            display: 'block',
                            fontSize: '14px',
                            fontWeight: '600',
                            color: '#374151',
                            marginBottom: '6px'
                        }}>
                            Street Address
                        </label>
                        <input
                            type="text"
                            value={formData.street}
                            onChange={(e) => setFormData({...formData, street: e.target.value})}
                            placeholder="123 Main St"
                            style={{
                                width: '100%',
                                padding: '10px 14px',
                                border: '1px solid #d1d5db',
                                borderRadius: '8px',
                                fontSize: '15px',
                                color: '#111827',
                                transition: 'border-color 0.2s',
                                boxSizing: 'border-box'
                            }}
                            onFocus={(e) => e.currentTarget.style.borderColor = '#058585'}
                            onBlur={(e) => e.currentTarget.style.borderColor = '#d1d5db'}
                        />
                    </div>

                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '12px' }}>
                        <div>
                            <label style={{
                                display: 'block',
                                fontSize: '14px',
                                fontWeight: '600',
                                color: '#374151',
                                marginBottom: '6px'
                            }}>
                                City
                            </label>
                            <input
                                type="text"
                                value={formData.city}
                                onChange={(e) => setFormData({...formData, city: e.target.value})}
                                placeholder="San Francisco"
                                style={{
                                    width: '100%',
                                    padding: '10px 14px',
                                    border: '1px solid #d1d5db',
                                    borderRadius: '8px',
                                    fontSize: '15px',
                                    color: '#111827',
                                    transition: 'border-color 0.2s',
                                    boxSizing: 'border-box'
                                }}
                                onFocus={(e) => e.currentTarget.style.borderColor = '#058585'}
                                onBlur={(e) => e.currentTarget.style.borderColor = '#d1d5db'}
                            />
                        </div>

                        <div>
                            <label style={{
                                display: 'block',
                                fontSize: '14px',
                                fontWeight: '600',
                                color: '#374151',
                                marginBottom: '6px'
                            }}>
                                State
                            </label>
                            <input
                                type="text"
                                value={formData.state}
                                onChange={(e) => setFormData({...formData, state: e.target.value.toUpperCase()})}
                                placeholder="CA"
                                maxLength="2"
                                style={{
                                    width: '100%',
                                    padding: '10px 14px',
                                    border: '1px solid #d1d5db',
                                    borderRadius: '8px',
                                    fontSize: '15px',
                                    color: '#111827',
                                    transition: 'border-color 0.2s',
                                    textTransform: 'uppercase',
                                    boxSizing: 'border-box'
                                }}
                                onFocus={(e) => e.currentTarget.style.borderColor = '#058585'}
                                onBlur={(e) => e.currentTarget.style.borderColor = '#d1d5db'}
                            />
                        </div>

                        <div>
                            <label style={{
                                display: 'block',
                                fontSize: '14px',
                                fontWeight: '600',
                                color: '#374151',
                                marginBottom: '6px'
                            }}>
                                ZIP
                            </label>
                            <input
                                type="text"
                                value={formData.zip}
                                onChange={(e) => setFormData({...formData, zip: e.target.value})}
                                placeholder="94102"
                                maxLength="10"
                                style={{
                                    width: '100%',
                                    padding: '10px 14px',
                                    border: '1px solid #d1d5db',
                                    borderRadius: '8px',
                                    fontSize: '15px',
                                    color: '#111827',
                                    transition: 'border-color 0.2s',
                                    boxSizing: 'border-box'
                                }}
                                onFocus={(e) => e.currentTarget.style.borderColor = '#058585'}
                                onBlur={(e) => e.currentTarget.style.borderColor = '#d1d5db'}
                            />
                        </div>
                    </div>
                </div>
            </div>

            {/* STEP 1.10: FOOTER - Cancel + Save Buttons */}
            {/* STEP 1.23: Responsive gap (8px mobile, 12px desktop) */}
            <div style={{
                display: 'flex',
                gap: isMobile ? '8px' : '12px',
                justifyContent: 'flex-end',
                padding: '20px 24px',
                borderTop: '1px solid #e5e7eb',
                background: '#f9fafb'
            }}>
                <button
                    onClick={onClose}
                    style={{
                        padding: '12px 24px',
                        background: '#e5e7eb',
                        border: 'none',
                        borderRadius: '8px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        color: '#374151',
                        fontSize: '15px',
                        transition: 'background 0.2s'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.background = '#d1d5db'}
                    onMouseLeave={(e) => e.currentTarget.style.background = '#e5e7eb'}
                >
                    Cancel
                </button>
                <button
                    onClick={handleSave}
                    disabled={saving}
                    style={{
                        padding: '12px 24px',
                        background: saving ? '#9ca3af' : '#058585',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        fontWeight: '600',
                        cursor: saving ? 'not-allowed' : 'pointer',
                        fontSize: '15px',
                        opacity: saving ? 0.6 : 1,
                        transition: 'all 0.2s'
                    }}
                    onMouseEnter={(e) => {
                        if (!saving) e.currentTarget.style.background = '#047272';
                    }}
                    onMouseLeave={(e) => {
                        if (!saving) e.currentTarget.style.background = '#058585';
                    }}
                >
                    {saving ? 'Saving...' : 'Save Changes'}
                </button>
            </div>
        </>
    );
}

/** EmergencyModal - Manage emergency contacts with add functionality */
/** EmergencyModal - Manage emergency contacts (add, edit, delete, set primary) */
function EmergencyModal({ userData, user, onClose, onAddEmergencyContact }) {
    // STEP 1.12: Initialize state
    const [contacts, setContacts] = React.useState(userData?.emergencyContacts || []);
    const [isAdding, setIsAdding] = React.useState(false);
    const [editingIndex, setEditingIndex] = React.useState(null);
    const [formData, setFormData] = React.useState({
        name: '',
        phone: '',
        relationship: '',
        isPrimary: false
    });
    const [saving, setSaving] = React.useState(false);

    // STEP 1.12: Save all contacts to Firestore
    const handleSaveContacts = async () => {
        setSaving(true);
        try {
            await db.collection('users').doc(user.uid).update({
                emergencyContacts: contacts
            });
            window.showNotification('Emergency contacts updated successfully', 'success');
            onClose();
        } catch (error) {
            console.error('Error saving emergency contacts:', error);
            window.handleFirebaseError && window.handleFirebaseError(error, 'EmergencyModal.handleSaveContacts');
            alert('Failed to save changes. Please try again.');
        } finally {
            setSaving(false);
        }
    };

    // STEP 1.12: Add new contact
    const handleAddContact = () => {
        if (!formData.name || !formData.phone) {
            alert('Name and phone are required');
            return;
        }

        const newContact = {
            name: formData.name,
            phone: formData.phone,
            relationship: formData.relationship,
            isPrimary: formData.isPrimary
        };

        // If setting as primary, remove primary from other contacts
        const updatedContacts = formData.isPrimary
            ? contacts.map(c => ({ ...c, isPrimary: false }))
            : contacts;

        setContacts([...updatedContacts, newContact]);
        setFormData({ name: '', phone: '', relationship: '', isPrimary: false });
        setIsAdding(false);
    };

    // STEP 1.12: Update existing contact
    const handleUpdateContact = () => {
        if (!formData.name || !formData.phone) {
            alert('Name and phone are required');
            return;
        }

        const updatedContact = {
            name: formData.name,
            phone: formData.phone,
            relationship: formData.relationship,
            isPrimary: formData.isPrimary
        };

        const updatedContacts = contacts.map((contact, idx) => {
            if (idx === editingIndex) {
                return updatedContact;
            }
            // If setting new primary, remove primary from others
            if (formData.isPrimary && contact.isPrimary) {
                return { ...contact, isPrimary: false };
            }
            return contact;
        });

        setContacts(updatedContacts);
        setFormData({ name: '', phone: '', relationship: '', isPrimary: false });
        setEditingIndex(null);
    };

    // STEP 1.12: Delete contact
    const handleDeleteContact = (index) => {
        if (confirm('Are you sure you want to delete this contact?')) {
            setContacts(contacts.filter((_, idx) => idx !== index));
        }
    };

    // STEP 1.12: Start editing contact
    const startEditing = (index) => {
        const contact = contacts[index];
        setFormData({
            name: contact.name,
            phone: contact.phone,
            relationship: contact.relationship || '',
            isPrimary: contact.isPrimary || false
        });
        setEditingIndex(index);
        setIsAdding(false);
    };

    // STEP 1.12: Cancel add/edit
    const cancelForm = () => {
        setFormData({ name: '', phone: '', relationship: '', isPrimary: false });
        setIsAdding(false);
        setEditingIndex(null);
    };

    // STEP 1.12: Initialize Lucide icons after render
    React.useEffect(() => {
        if (window.lucide && typeof window.lucide.createIcons === 'function') {
            window.lucide.createIcons();
        }
    }, [isAdding, editingIndex, contacts]);

    return (
        <>
            {/* STEP 1.12: HEADER - Title + Close Button */}
            <div style={{
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                padding: '24px',
                borderBottom: '1px solid #e5e7eb'
            }}>
                <h2 style={{
                    fontSize: '24px',
                    fontWeight: '700',
                    color: '#111827',
                    margin: 0
                }}>
                    Emergency Contacts
                </h2>
                <button
                    onClick={onClose}
                    style={{
                        background: 'none',
                        border: 'none',
                        cursor: 'pointer',
                        padding: '8px',
                        borderRadius: '8px',
                        transition: 'background 0.2s',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.background = '#f3f4f6'}
                    onMouseLeave={(e) => e.currentTarget.style.background = 'none'}
                >
                    <i data-lucide="x" style={{width: '24px', height: '24px', color: '#6b7280'}}></i>
                </button>
            </div>

            {/* STEP 1.12: BODY - Scrollable Contact List */}
            <div style={{
                padding: '24px',
                overflowY: 'auto',
                maxHeight: 'calc(90vh - 160px)'
            }}>
                {/* Assigned Coach Info (Read-Only) */}
                {userData?.assignedCoach && (
                    <div style={{
                        background: '#f0fdfa',
                        border: '1px solid #99f6e4',
                        borderRadius: '8px',
                        padding: '16px',
                        marginBottom: '24px'
                    }}>
                        <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px',
                            marginBottom: '8px'
                        }}>
                            <i data-lucide="user-check" style={{width: '18px', height: '18px', color: '#0d9488'}}></i>
                            <span style={{
                                fontSize: '14px',
                                fontWeight: '600',
                                color: '#0d9488'
                            }}>
                                Assigned Coach
                            </span>
                        </div>
                        <div style={{ fontSize: '15px', color: '#111827', fontWeight: '600' }}>
                            {userData.assignedCoachName || 'Your Coach'}
                        </div>
                        <div style={{ fontSize: '14px', color: '#6b7280', marginTop: '4px' }}>
                            Always available for support
                        </div>
                    </div>
                )}

                {/* Emergency Contacts List */}
                {!isAdding && editingIndex === null && (
                    <>
                        <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'space-between',
                            marginBottom: '16px'
                        }}>
                            <h3 style={{
                                fontSize: '16px',
                                fontWeight: '600',
                                color: '#111827',
                                margin: 0
                            }}>
                                Your Emergency Contacts
                            </h3>
                            <button
                                onClick={() => setIsAdding(true)}
                                style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px',
                                    padding: '8px 16px',
                                    background: '#058585',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    fontSize: '14px',
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    transition: 'background 0.2s'
                                }}
                                onMouseEnter={(e) => e.currentTarget.style.background = '#047272'}
                                onMouseLeave={(e) => e.currentTarget.style.background = '#058585'}
                            >
                                <i data-lucide="plus" style={{width: '16px', height: '16px'}}></i>
                                Add Contact
                            </button>
                        </div>

                        {contacts.length === 0 ? (
                            <div style={{
                                textAlign: 'center',
                                padding: '40px 20px',
                                color: '#6b7280'
                            }}>
                                <i data-lucide="user-plus" style={{width: '48px', height: '48px', margin: '0 auto 16px', opacity: 0.5}}></i>
                                <p style={{ margin: 0, fontSize: '15px' }}>No emergency contacts added yet</p>
                                <p style={{ margin: '8px 0 0', fontSize: '14px', opacity: 0.8 }}>Add someone you trust to contact in case of emergency</p>
                            </div>
                        ) : (
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                {contacts.map((contact, index) => (
                                    <div
                                        key={index}
                                        style={{
                                            background: '#f9fafb',
                                            border: '1px solid #e5e7eb',
                                            borderRadius: '8px',
                                            padding: '16px',
                                            position: 'relative'
                                        }}
                                    >
                                        {contact.isPrimary && (
                                            <div style={{
                                                position: 'absolute',
                                                top: '12px',
                                                right: '12px',
                                                background: '#fef3c7',
                                                color: '#92400e',
                                                padding: '4px 10px',
                                                borderRadius: '12px',
                                                fontSize: '12px',
                                                fontWeight: '600',
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '4px'
                                            }}>
                                                <i data-lucide="star" style={{width: '12px', height: '12px'}}></i>
                                                Primary
                                            </div>
                                        )}
                                        <div style={{
                                            fontSize: '16px',
                                            fontWeight: '600',
                                            color: '#111827',
                                            marginBottom: '6px',
                                            paddingRight: contact.isPrimary ? '100px' : '0'
                                        }}>
                                            {contact.name}
                                        </div>
                                        <div style={{
                                            fontSize: '14px',
                                            color: '#6b7280',
                                            marginBottom: '4px',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '6px'
                                        }}>
                                            <i data-lucide="phone" style={{width: '14px', height: '14px'}}></i>
                                            {contact.phone}
                                        </div>
                                        {contact.relationship && (
                                            <div style={{
                                                fontSize: '14px',
                                                color: '#6b7280',
                                                marginBottom: '12px',
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '6px'
                                            }}>
                                                <i data-lucide="users" style={{width: '14px', height: '14px'}}></i>
                                                {contact.relationship}
                                            </div>
                                        )}
                                        <div style={{
                                            display: 'flex',
                                            gap: '8px',
                                            marginTop: '12px',
                                            paddingTop: '12px',
                                            borderTop: '1px solid #e5e7eb'
                                        }}>
                                            <button
                                                onClick={() => startEditing(index)}
                                                style={{
                                                    flex: 1,
                                                    padding: '8px 16px',
                                                    background: 'white',
                                                    border: '1px solid #d1d5db',
                                                    borderRadius: '6px',
                                                    fontSize: '14px',
                                                    fontWeight: '600',
                                                    color: '#374151',
                                                    cursor: 'pointer',
                                                    transition: 'all 0.2s',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    gap: '6px'
                                                }}
                                                onMouseEnter={(e) => {
                                                    e.currentTarget.style.background = '#f9fafb';
                                                    e.currentTarget.style.borderColor = '#058585';
                                                    e.currentTarget.style.color = '#058585';
                                                }}
                                                onMouseLeave={(e) => {
                                                    e.currentTarget.style.background = 'white';
                                                    e.currentTarget.style.borderColor = '#d1d5db';
                                                    e.currentTarget.style.color = '#374151';
                                                }}
                                            >
                                                <i data-lucide="edit-2" style={{width: '14px', height: '14px'}}></i>
                                                Edit
                                            </button>
                                            <button
                                                onClick={() => handleDeleteContact(index)}
                                                style={{
                                                    flex: 1,
                                                    padding: '8px 16px',
                                                    background: 'white',
                                                    border: '1px solid #d1d5db',
                                                    borderRadius: '6px',
                                                    fontSize: '14px',
                                                    fontWeight: '600',
                                                    color: '#374151',
                                                    cursor: 'pointer',
                                                    transition: 'all 0.2s',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    gap: '6px'
                                                }}
                                                onMouseEnter={(e) => {
                                                    e.currentTarget.style.background = '#fef2f2';
                                                    e.currentTarget.style.borderColor = '#dc2626';
                                                    e.currentTarget.style.color = '#dc2626';
                                                }}
                                                onMouseLeave={(e) => {
                                                    e.currentTarget.style.background = 'white';
                                                    e.currentTarget.style.borderColor = '#d1d5db';
                                                    e.currentTarget.style.color = '#374151';
                                                }}
                                            >
                                                <i data-lucide="trash-2" style={{width: '14px', height: '14px'}}></i>
                                                Delete
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </>
                )}

                {/* Add/Edit Contact Form */}
                {(isAdding || editingIndex !== null) && (
                    <div style={{
                        background: '#f9fafb',
                        border: '2px solid #058585',
                        borderRadius: '8px',
                        padding: '20px'
                    }}>
                        <h3 style={{
                            fontSize: '16px',
                            fontWeight: '600',
                            color: '#111827',
                            marginBottom: '16px'
                        }}>
                            {editingIndex !== null ? 'Edit Contact' : 'Add New Contact'}
                        </h3>

                        {/* Name */}
                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: '14px',
                                fontWeight: '600',
                                color: '#374151',
                                marginBottom: '6px'
                            }}>
                                Name <span style={{color: '#dc2626'}}>*</span>
                            </label>
                            <input
                                type="text"
                                value={formData.name}
                                onChange={(e) => setFormData({...formData, name: e.target.value})}
                                placeholder="Jane Doe"
                                style={{
                                    width: '100%',
                                    padding: '10px 14px',
                                    border: '1px solid #d1d5db',
                                    borderRadius: '8px',
                                    fontSize: '15px',
                                    color: '#111827',
                                    transition: 'border-color 0.2s',
                                    boxSizing: 'border-box',
                                    background: 'white'
                                }}
                                onFocus={(e) => e.currentTarget.style.borderColor = '#058585'}
                                onBlur={(e) => e.currentTarget.style.borderColor = '#d1d5db'}
                            />
                        </div>

                        {/* Phone */}
                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: '14px',
                                fontWeight: '600',
                                color: '#374151',
                                marginBottom: '6px'
                            }}>
                                Phone <span style={{color: '#dc2626'}}>*</span>
                            </label>
                            <input
                                type="tel"
                                value={formData.phone}
                                onChange={(e) => setFormData({...formData, phone: e.target.value})}
                                placeholder="(555) 123-4567"
                                style={{
                                    width: '100%',
                                    padding: '10px 14px',
                                    border: '1px solid #d1d5db',
                                    borderRadius: '8px',
                                    fontSize: '15px',
                                    color: '#111827',
                                    transition: 'border-color 0.2s',
                                    boxSizing: 'border-box',
                                    background: 'white'
                                }}
                                onFocus={(e) => e.currentTarget.style.borderColor = '#058585'}
                                onBlur={(e) => e.currentTarget.style.borderColor = '#d1d5db'}
                            />
                        </div>

                        {/* Relationship */}
                        <div style={{ marginBottom: '16px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: '14px',
                                fontWeight: '600',
                                color: '#374151',
                                marginBottom: '6px'
                            }}>
                                Relationship (Optional)
                            </label>
                            <input
                                type="text"
                                value={formData.relationship}
                                onChange={(e) => setFormData({...formData, relationship: e.target.value})}
                                placeholder="Sister, Friend, Sponsor, etc."
                                style={{
                                    width: '100%',
                                    padding: '10px 14px',
                                    border: '1px solid #d1d5db',
                                    borderRadius: '8px',
                                    fontSize: '15px',
                                    color: '#111827',
                                    transition: 'border-color 0.2s',
                                    boxSizing: 'border-box',
                                    background: 'white'
                                }}
                                onFocus={(e) => e.currentTarget.style.borderColor = '#058585'}
                                onBlur={(e) => e.currentTarget.style.borderColor = '#d1d5db'}
                            />
                        </div>

                        {/* Primary Contact Toggle */}
                        <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '10px',
                            padding: '12px',
                            background: 'white',
                            border: '1px solid #e5e7eb',
                            borderRadius: '8px',
                            marginBottom: '16px'
                        }}>
                            <input
                                type="checkbox"
                                id="isPrimary"
                                checked={formData.isPrimary}
                                onChange={(e) => setFormData({...formData, isPrimary: e.target.checked})}
                                style={{
                                    width: '18px',
                                    height: '18px',
                                    cursor: 'pointer',
                                    accentColor: '#058585'
                                }}
                            />
                            <label htmlFor="isPrimary" style={{
                                fontSize: '14px',
                                fontWeight: '600',
                                color: '#374151',
                                cursor: 'pointer',
                                flex: 1,
                                display: 'flex',
                                alignItems: 'center',
                                gap: '6px'
                            }}>
                                <i data-lucide="star" style={{width: '14px', height: '14px', color: '#f59e0b'}}></i>
                                Set as Primary Contact
                            </label>
                        </div>

                        {/* Form Buttons */}
                        <div style={{ display: 'flex', gap: '12px' }}>
                            <button
                                onClick={cancelForm}
                                style={{
                                    flex: 1,
                                    padding: '10px 20px',
                                    background: 'white',
                                    border: '1px solid #d1d5db',
                                    borderRadius: '8px',
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    color: '#374151',
                                    fontSize: '15px',
                                    transition: 'all 0.2s'
                                }}
                                onMouseEnter={(e) => {
                                    e.currentTarget.style.background = '#f3f4f6';
                                }}
                                onMouseLeave={(e) => {
                                    e.currentTarget.style.background = 'white';
                                }}
                            >
                                Cancel
                            </button>
                            <button
                                onClick={editingIndex !== null ? handleUpdateContact : handleAddContact}
                                style={{
                                    flex: 1,
                                    padding: '10px 20px',
                                    background: '#058585',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    fontSize: '15px',
                                    transition: 'background 0.2s'
                                }}
                                onMouseEnter={(e) => e.currentTarget.style.background = '#047272'}
                                onMouseLeave={(e) => e.currentTarget.style.background = '#058585'}
                            >
                                {editingIndex !== null ? 'Update Contact' : 'Add Contact'}
                            </button>
                        </div>
                    </div>
                )}
            </div>

            {/* STEP 1.12: FOOTER - Cancel + Save Buttons */}
            {/* STEP 1.23: Responsive gap (8px mobile, 12px desktop) */}
            <div style={{
                display: 'flex',
                gap: isMobile ? '8px' : '12px',
                justifyContent: 'flex-end',
                padding: '20px 24px',
                borderTop: '1px solid #e5e7eb',
                background: '#f9fafb'
            }}>
                <button
                    onClick={onClose}
                    style={{
                        padding: '12px 24px',
                        background: '#e5e7eb',
                        border: 'none',
                        borderRadius: '8px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        color: '#374151',
                        fontSize: '15px',
                        transition: 'background 0.2s'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.background = '#d1d5db'}
                    onMouseLeave={(e) => e.currentTarget.style.background = '#e5e7eb'}
                >
                    Cancel
                </button>
                <button
                    onClick={handleSaveContacts}
                    disabled={saving}
                    style={{
                        padding: '12px 24px',
                        background: saving ? '#9ca3af' : '#058585',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        fontWeight: '600',
                        cursor: saving ? 'not-allowed' : 'pointer',
                        fontSize: '15px',
                        opacity: saving ? 0.6 : 1,
                        transition: 'all 0.2s'
                    }}
                    onMouseEnter={(e) => {
                        if (!saving) e.currentTarget.style.background = '#047272';
                    }}
                    onMouseLeave={(e) => {
                        if (!saving) e.currentTarget.style.background = '#058585';
                    }}
                >
                    {saving ? 'Saving...' : 'Save Changes'}
                </button>
            </div>
        </>
    );
}

/** PersonalInfoModal - Edit personal info (name, DOB, gender, address, insurance) */
function PersonalInfoModal({ userData, user, onClose, onUpdate }) {
    const [formData, setFormData] = React.useState({});

    // STEP 1.23: Mobile detection for responsive layout
    const [isMobile, setIsMobile] = React.useState(window.innerWidth < 768);

    React.useEffect(() => {
        const handleResize = () => setIsMobile(window.innerWidth < 768);
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
    }, []);

    return (
        <div>
            <h3 style={{marginBottom: '20px'}}>Personal Information</h3>
            <div className="form-group">
                <label className="form-label">First Name</label>
                <input
                    type="text"
                    className="form-input"
                    value={formData.firstName || userData?.firstName || ''}
                    onChange={(e) => setFormData({...formData, firstName: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">Last Name</label>
                <input
                    type="text"
                    className="form-input"
                    value={formData.lastName || userData?.lastName || ''}
                    onChange={(e) => setFormData({...formData, lastName: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">Display Name</label>
                <input
                    type="text"
                    className="form-input"
                    value={formData.displayName || userData?.displayName || ''}
                    onChange={(e) => setFormData({...formData, displayName: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">Phone</label>
                <input
                    type="tel"
                    className="form-input"
                    value={formData.phone || userData?.phone || ''}
                    onChange={(e) => setFormData({...formData, phone: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">Timezone</label>
                <select
                    className="form-select"
                    value={formData.timezone || userData?.timezone || window.GLRSApp?.utils?.getUserTimezone() || 'America/Los_Angeles'}
                    onChange={(e) => setFormData({...formData, timezone: e.target.value, timezoneManualOverride: true})}
                >
                    <optgroup label="US Mainland">
                        <option value="America/New_York">Eastern Time (ET)</option>
                        <option value="America/Chicago">Central Time (CT)</option>
                        <option value="America/Denver">Mountain Time (MT)</option>
                        <option value="America/Phoenix">Arizona (no DST)</option>
                        <option value="America/Los_Angeles">Pacific Time (PT)</option>
                    </optgroup>
                    <optgroup label="US Territories">
                        <option value="America/Anchorage">Alaska Time (AKT)</option>
                        <option value="Pacific/Honolulu">Hawaii Time (HT)</option>
                    </optgroup>
                    <optgroup label="Other">
                        <option value="America/Puerto_Rico">Puerto Rico</option>
                        <option value="Pacific/Guam">Guam</option>
                    </optgroup>
                </select>
                <small style={{color: '#666', fontSize: '12px', marginTop: '4px', display: 'block'}}>
                    {userData?.timezoneManualOverride ? 'Manually set' : 'Auto-detected'} • Used for timestamps and reminders
                </small>
            </div>
            <div className="form-group">
                <label className="form-label">Date of Birth</label>
                <input
                    type="date"
                    className="form-input"
                    value={formData.dateOfBirth || userData?.dateOfBirth || ''}
                    onChange={(e) => setFormData({...formData, dateOfBirth: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">Gender</label>
                <select
                    className="form-select"
                    value={formData.gender || userData?.gender || ''}
                    onChange={(e) => setFormData({...formData, gender: e.target.value})}
                >
                    <option value="">Select Gender</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="non-binary">Non-Binary</option>
                    <option value="prefer-not">Prefer Not to Say</option>
                </select>
            </div>
            <div className="form-group">
                <label className="form-label">Street Address</label>
                <input
                    type="text"
                    className="form-input"
                    value={formData.street || userData?.address?.street || ''}
                    onChange={(e) => setFormData({...formData, street: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">City</label>
                <input
                    type="text"
                    className="form-input"
                    value={formData.city || userData?.address?.city || ''}
                    onChange={(e) => setFormData({...formData, city: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">State</label>
                <input
                    type="text"
                    className="form-input"
                    value={formData.state || userData?.address?.state || ''}
                    onChange={(e) => setFormData({...formData, state: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">ZIP Code</label>
                <input
                    type="text"
                    className="form-input"
                    value={formData.zip || userData?.address?.zip || ''}
                    onChange={(e) => setFormData({...formData, zip: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">Insurance Provider (Optional)</label>
                <input
                    type="text"
                    className="form-input"
                    value={formData.insurance || userData?.insurance || ''}
                    onChange={(e) => setFormData({...formData, insurance: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">Insurance ID (Optional)</label>
                <input
                    type="text"
                    className="form-input"
                    value={formData.insuranceId || userData?.insuranceId || ''}
                    onChange={(e) => setFormData({...formData, insuranceId: e.target.value})}
                />
            </div>
            <button
                className="btn-primary"
                onClick={async () => {
                    try {
                        // Build update object with proper validation
                        const updates = {};

                        // Handle simple fields - only add if they have values
                        if (formData.firstName !== undefined && formData.firstName !== '') {
                            updates.firstName = formData.firstName;
                        }
                        if (formData.lastName !== undefined && formData.lastName !== '') {
                            updates.lastName = formData.lastName;
                        }
                        if (formData.displayName !== undefined && formData.displayName !== '') {
                            updates.displayName = formData.displayName;
                        }
                        if (formData.phone !== undefined && formData.phone !== '') {
                            updates.phone = formData.phone;
                        }
                        if (formData.timezone !== undefined && formData.timezone !== '') {
                            updates.timezone = formData.timezone;
                            updates.timezoneManualOverride = formData.timezoneManualOverride || true;
                            updates.timezoneDetectedAt = firebase.firestore.FieldValue.serverTimestamp();
                        }
                        if (formData.dateOfBirth !== undefined && formData.dateOfBirth !== '') {
                            updates.dateOfBirth = formData.dateOfBirth;
                        }
                        if (formData.gender !== undefined && formData.gender !== '') {
                            updates.gender = formData.gender;
                        }
                        if (formData.insurance !== undefined && formData.insurance !== '') {
                            updates.insurance = formData.insurance;
                        }
                        if (formData.insuranceId !== undefined && formData.insuranceId !== '') {
                            updates.insuranceId = formData.insuranceId;
                        }

                        // Handle address as a nested object - CRITICAL for admin.html sync
                        // Only update address if at least one field is provided
                        const addressFields = ['street', 'city', 'state', 'zip'];
                        const hasAddressData = addressFields.some(field =>
                            formData[field] !== undefined && formData[field] !== ''
                        );

                        if (hasAddressData) {
                            // Get existing address to merge with
                            const existingAddress = userData?.address || {};

                            updates.address = {
                                street: formData.street !== undefined ? formData.street : (existingAddress.street || ''),
                                city: formData.city !== undefined ? formData.city : (existingAddress.city || ''),
                                state: formData.state !== undefined ? formData.state : (existingAddress.state || ''),
                                zip: formData.zip !== undefined ? formData.zip : (existingAddress.zip || '')
                            };
                        }

                        // Only proceed if there are updates to make
                        if (Object.keys(updates).length === 0) {
                            alert('No changes to save');
                            return;
                        }

                        // Call parent callback with updates
                        await onUpdate(updates);

                        // Provide specific feedback
                        const savedFields = Object.keys(updates);
                        alert(`Successfully updated: ${savedFields.join(', ')}`);

                        onClose();
                    } catch (error) {
                        // Provide specific error feedback
                        if (error.code === 'permission-denied') {
                            alert('Permission denied. Please try logging out and back in.');
                        } else if (error.code === 'not-found') {
                            alert('User record not found. Please contact support.');
                        } else {
                            alert(`Failed to update information: ${error.message}`);
                        }
                    }
                }}
            >
                Save Changes
            </button>
        </div>
    );
}

/** RecoveryInfoModal - Edit recovery settings (sobriety date, substance, daily cost, sponsor) */
/** RecoveryInfoModal - Edit recovery information (sobriety date, substance, sponsor, etc.) */
function RecoveryInfoModal({ userData, user, onClose, onUpdate }) {
    // STEP 1.11: Initialize form data with current userData
    const [formData, setFormData] = React.useState({
        sobrietyDateTime: userData?.sobrietyDate ? new Date(userData.sobrietyDate).toISOString().slice(0, 16) : '',
        substance: userData?.substance || '',
        recoveryProgram: userData?.recoveryProgram || '',
        sponsorName: userData?.sponsorName || '',
        sponsorPhone: userData?.sponsorPhone || '',
        recoveryGoals: userData?.recoveryGoals || '',
        triggers: userData?.triggers || '',
        dailyCost: userData?.dailyCost || ''
    });

    const [saving, setSaving] = React.useState(false);

    // STEP 1.23: Mobile detection for responsive layout
    const [isMobile, setIsMobile] = React.useState(window.innerWidth < 768);

    React.useEffect(() => {
        const handleResize = () => setIsMobile(window.innerWidth < 768);
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
    }, []);

    // STEP 1.11: Save handler with Firestore update
    const handleSave = async () => {
        setSaving(true);
        try {
            const updates = {};

            // Convert datetime-local to ISO string for consistent storage
            if (formData.sobrietyDateTime) {
                const sobrietyDate = new Date(formData.sobrietyDateTime);
                updates.sobrietyDate = sobrietyDate.toISOString();
            }

            // Only add fields that have values
            if (formData.substance) {
                updates.substance = formData.substance;
            }
            if (formData.recoveryProgram) {
                updates.recoveryProgram = formData.recoveryProgram;
            }
            if (formData.sponsorName) {
                updates.sponsorName = formData.sponsorName;
            }
            if (formData.sponsorPhone) {
                updates.sponsorPhone = formData.sponsorPhone;
            }
            if (formData.recoveryGoals) {
                updates.recoveryGoals = formData.recoveryGoals;
            }
            if (formData.triggers) {
                updates.triggers = formData.triggers;
            }

            // Handle dailyCost change with edge case warning
            if (formData.dailyCost !== undefined && formData.dailyCost !== '') {
                const newDailyCost = parseFloat(formData.dailyCost);
                const oldDailyCost = userData.dailyCost || 0;

                // If dailyCost is changing and user has actualMoneySaved data
                if (oldDailyCost > 0 && newDailyCost !== oldDailyCost) {
                    const currentActualSaved = userData.actualMoneySaved || 0;
                    const ratio = newDailyCost / oldDailyCost;
                    const adjustedAmount = Math.round(currentActualSaved * ratio);

                    const warningMessage = `⚠️ Changing Daily Cost Impact:\n\n` +
                        `Old: $${oldDailyCost}/day → New: $${newDailyCost}/day\n\n` +
                        `This will change all your savings calculations.\n\n` +
                        `Your current actual savings: $${currentActualSaved.toLocaleString()}\n\n` +
                        `Would you like to adjust your actual savings proportionally?\n\n` +
                        `Adjusted amount: $${adjustedAmount.toLocaleString()}\n\n` +
                        `Click OK to adjust, Cancel to keep $${currentActualSaved.toLocaleString()}`;

                    const shouldAdjust = confirm(warningMessage);

                    if (shouldAdjust) {
                        // Adjust actualMoneySaved proportionally
                        updates.actualMoneySaved = adjustedAmount;
                    }
                }

                updates.dailyCost = newDailyCost;
            }

            // Only proceed if there are updates
            if (Object.keys(updates).length === 0) {
                alert('No changes to save');
                setSaving(false);
                return;
            }

            // Call parent callback with updates
            await onUpdate(updates);

            window.showNotification('Recovery information updated successfully', 'success');
            onClose();
        } catch (error) {
            console.error('Error updating recovery information:', error);
            window.handleFirebaseError && window.handleFirebaseError(error, 'RecoveryInfoModal.handleSave');
            alert('Failed to save changes. Please try again.');
        } finally {
            setSaving(false);
        }
    };

    // STEP 1.11: Initialize Lucide icons after render
    React.useEffect(() => {
        if (window.lucide && typeof window.lucide.createIcons === 'function') {
            window.lucide.createIcons();
        }
    }, []);

    return (
        <>
            {/* STEP 1.11: HEADER - Title + Close Button */}
            <div style={{
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                padding: '24px',
                borderBottom: '1px solid #e5e7eb'
            }}>
                <h2 style={{
                    fontSize: '24px',
                    fontWeight: '700',
                    color: '#111827',
                    margin: 0
                }}>
                    Recovery Information
                </h2>
                <button
                    onClick={onClose}
                    style={{
                        background: 'none',
                        border: 'none',
                        cursor: 'pointer',
                        padding: '8px',
                        borderRadius: '8px',
                        transition: 'background 0.2s',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.background = '#f3f4f6'}
                    onMouseLeave={(e) => e.currentTarget.style.background = 'none'}
                >
                    <i data-lucide="x" style={{width: '24px', height: '24px', color: '#6b7280'}}></i>
                </button>
            </div>

            {/* STEP 1.11: BODY - Scrollable Form */}
            <div style={{
                padding: '24px',
                overflowY: 'auto',
                maxHeight: 'calc(90vh - 160px)'
            }}>
                {/* Sobriety Date & Time */}
                <div style={{ marginBottom: '20px' }}>
                    <label style={{
                        display: 'block',
                        fontSize: '14px',
                        fontWeight: '600',
                        color: '#374151',
                        marginBottom: '6px'
                    }}>
                        Sobriety Date & Time <span style={{color: '#dc2626'}}>*</span>
                    </label>
                    <small style={{
                        display: 'block',
                        fontSize: '12px',
                        color: '#6b7280',
                        marginBottom: '8px'
                    }}>
                        Enter the date and time 24 hours after your last use
                    </small>
                    <input
                        type="datetime-local"
                        value={formData.sobrietyDateTime}
                        onChange={(e) => setFormData({...formData, sobrietyDateTime: e.target.value})}
                        style={{
                            width: '100%',
                            padding: '10px 14px',
                            border: '1px solid #d1d5db',
                            borderRadius: '8px',
                            fontSize: '15px',
                            color: '#111827',
                            transition: 'border-color 0.2s',
                            boxSizing: 'border-box'
                        }}
                        onFocus={(e) => e.currentTarget.style.borderColor = '#058585'}
                        onBlur={(e) => e.currentTarget.style.borderColor = '#d1d5db'}
                    />
                </div>

                {/* Primary Substance */}
                <div style={{ marginBottom: '20px' }}>
                    <label style={{
                        display: 'block',
                        fontSize: '14px',
                        fontWeight: '600',
                        color: '#374151',
                        marginBottom: '6px'
                    }}>
                        Primary Substance
                    </label>
                    <select
                        value={formData.substance}
                        onChange={(e) => setFormData({...formData, substance: e.target.value})}
                        style={{
                            width: '100%',
                            padding: '10px 14px',
                            border: '1px solid #d1d5db',
                            borderRadius: '8px',
                            fontSize: '15px',
                            color: '#111827',
                            transition: 'border-color 0.2s',
                            boxSizing: 'border-box',
                            background: 'white'
                        }}
                        onFocus={(e) => e.currentTarget.style.borderColor = '#058585'}
                        onBlur={(e) => e.currentTarget.style.borderColor = '#d1d5db'}
                    >
                        <option value="">Select Substance</option>
                        <option value="alcohol">Alcohol</option>
                        <option value="opioids">Opioids</option>
                        <option value="stimulants">Stimulants</option>
                        <option value="cannabis">Cannabis</option>
                        <option value="benzodiazepines">Benzodiazepines</option>
                        <option value="multiple">Multiple Substances</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                {/* Recovery Program */}
                <div style={{ marginBottom: '20px' }}>
                    <label style={{
                        display: 'block',
                        fontSize: '14px',
                        fontWeight: '600',
                        color: '#374151',
                        marginBottom: '6px'
                    }}>
                        Recovery Program
                    </label>
                    <select
                        value={formData.recoveryProgram}
                        onChange={(e) => setFormData({...formData, recoveryProgram: e.target.value})}
                        style={{
                            width: '100%',
                            padding: '10px 14px',
                            border: '1px solid #d1d5db',
                            borderRadius: '8px',
                            fontSize: '15px',
                            color: '#111827',
                            transition: 'border-color 0.2s',
                            boxSizing: 'border-box',
                            background: 'white'
                        }}
                        onFocus={(e) => e.currentTarget.style.borderColor = '#058585'}
                        onBlur={(e) => e.currentTarget.style.borderColor = '#d1d5db'}
                    >
                        <option value="">Select Program (Optional)</option>
                        <option value="aa">Alcoholics Anonymous (AA)</option>
                        <option value="na">Narcotics Anonymous (NA)</option>
                        <option value="smart">SMART Recovery</option>
                        <option value="celebrate">Celebrate Recovery</option>
                        <option value="refuge">Refuge Recovery</option>
                        <option value="lifering">LifeRing Secular Recovery</option>
                        <option value="women">Women for Sobriety</option>
                        <option value="other">Other Program</option>
                        <option value="none">Not in a program</option>
                    </select>
                </div>

                {/* Daily Cost of Use */}
                <div style={{ marginBottom: '20px' }}>
                    <label style={{
                        display: 'block',
                        fontSize: '14px',
                        fontWeight: '600',
                        color: '#374151',
                        marginBottom: '6px'
                    }}>
                        Daily Cost of Use ($)
                    </label>
                    <small style={{
                        display: 'block',
                        fontSize: '12px',
                        color: '#6b7280',
                        marginBottom: '8px'
                    }}>
                        Used to calculate money saved in recovery
                    </small>
                    <div style={{ position: 'relative' }}>
                        <span style={{
                            position: 'absolute',
                            left: '14px',
                            top: '50%',
                            transform: 'translateY(-50%)',
                            color: '#6b7280',
                            fontSize: '15px',
                            pointerEvents: 'none'
                        }}>
                            $
                        </span>
                        <input
                            type="number"
                            value={formData.dailyCost}
                            onChange={(e) => setFormData({...formData, dailyCost: e.target.value})}
                            placeholder="20"
                            min="0"
                            step="0.01"
                            style={{
                                width: '100%',
                                padding: '10px 14px 10px 28px',
                                border: '1px solid #d1d5db',
                                borderRadius: '8px',
                                fontSize: '15px',
                                color: '#111827',
                                transition: 'border-color 0.2s',
                                boxSizing: 'border-box'
                            }}
                            onFocus={(e) => e.currentTarget.style.borderColor = '#058585'}
                            onBlur={(e) => e.currentTarget.style.borderColor = '#d1d5db'}
                        />
                    </div>
                </div>

                {/* Sponsor Section */}
                <div style={{
                    marginTop: '32px',
                    marginBottom: '20px',
                    paddingTop: '20px',
                    borderTop: '1px solid #e5e7eb'
                }}>
                    <h3 style={{
                        fontSize: '16px',
                        fontWeight: '600',
                        color: '#111827',
                        marginBottom: '16px'
                    }}>
                        Sponsor Information
                    </h3>

                    {/* Sponsor Name */}
                    <div style={{ marginBottom: '20px' }}>
                        <label style={{
                            display: 'block',
                            fontSize: '14px',
                            fontWeight: '600',
                            color: '#374151',
                            marginBottom: '6px'
                        }}>
                            Sponsor Name (Optional)
                        </label>
                        <input
                            type="text"
                            value={formData.sponsorName}
                            onChange={(e) => setFormData({...formData, sponsorName: e.target.value})}
                            placeholder="John Doe"
                            style={{
                                width: '100%',
                                padding: '10px 14px',
                                border: '1px solid #d1d5db',
                                borderRadius: '8px',
                                fontSize: '15px',
                                color: '#111827',
                                transition: 'border-color 0.2s',
                                boxSizing: 'border-box'
                            }}
                            onFocus={(e) => e.currentTarget.style.borderColor = '#058585'}
                            onBlur={(e) => e.currentTarget.style.borderColor = '#d1d5db'}
                        />
                    </div>

                    {/* Sponsor Phone */}
                    <div style={{ marginBottom: '20px' }}>
                        <label style={{
                            display: 'block',
                            fontSize: '14px',
                            fontWeight: '600',
                            color: '#374151',
                            marginBottom: '6px'
                        }}>
                            Sponsor Phone (Optional)
                        </label>
                        <input
                            type="tel"
                            value={formData.sponsorPhone}
                            onChange={(e) => setFormData({...formData, sponsorPhone: e.target.value})}
                            placeholder="(555) 123-4567"
                            style={{
                                width: '100%',
                                padding: '10px 14px',
                                border: '1px solid #d1d5db',
                                borderRadius: '8px',
                                fontSize: '15px',
                                color: '#111827',
                                transition: 'border-color 0.2s',
                                boxSizing: 'border-box'
                            }}
                            onFocus={(e) => e.currentTarget.style.borderColor = '#058585'}
                            onBlur={(e) => e.currentTarget.style.borderColor = '#d1d5db'}
                        />
                    </div>
                </div>

                {/* Recovery Goals */}
                <div style={{ marginBottom: '20px' }}>
                    <label style={{
                        display: 'block',
                        fontSize: '14px',
                        fontWeight: '600',
                        color: '#374151',
                        marginBottom: '6px'
                    }}>
                        Recovery Goals (Optional)
                    </label>
                    <small style={{
                        display: 'block',
                        fontSize: '12px',
                        color: '#6b7280',
                        marginBottom: '8px'
                    }}>
                        What do you hope to achieve in your recovery?
                    </small>
                    <textarea
                        value={formData.recoveryGoals}
                        onChange={(e) => setFormData({...formData, recoveryGoals: e.target.value})}
                        placeholder="e.g., Rebuild relationships with family, get my job back, improve my health..."
                        rows="4"
                        style={{
                            width: '100%',
                            padding: '10px 14px',
                            border: '1px solid #d1d5db',
                            borderRadius: '8px',
                            fontSize: '15px',
                            color: '#111827',
                            transition: 'border-color 0.2s',
                            boxSizing: 'border-box',
                            resize: 'vertical',
                            fontFamily: 'inherit'
                        }}
                        onFocus={(e) => e.currentTarget.style.borderColor = '#058585'}
                        onBlur={(e) => e.currentTarget.style.borderColor = '#d1d5db'}
                    />
                </div>

                {/* Triggers */}
                <div style={{ marginBottom: '20px' }}>
                    <label style={{
                        display: 'block',
                        fontSize: '14px',
                        fontWeight: '600',
                        color: '#374151',
                        marginBottom: '6px'
                    }}>
                        Known Triggers (Optional)
                    </label>
                    <small style={{
                        display: 'block',
                        fontSize: '12px',
                        color: '#6b7280',
                        marginBottom: '8px'
                    }}>
                        Situations, people, or emotions that may trigger cravings
                    </small>
                    <textarea
                        value={formData.triggers}
                        onChange={(e) => setFormData({...formData, triggers: e.target.value})}
                        placeholder="e.g., Stress at work, certain social situations, specific locations..."
                        rows="4"
                        style={{
                            width: '100%',
                            padding: '10px 14px',
                            border: '1px solid #d1d5db',
                            borderRadius: '8px',
                            fontSize: '15px',
                            color: '#111827',
                            transition: 'border-color 0.2s',
                            boxSizing: 'border-box',
                            resize: 'vertical',
                            fontFamily: 'inherit'
                        }}
                        onFocus={(e) => e.currentTarget.style.borderColor = '#058585'}
                        onBlur={(e) => e.currentTarget.style.borderColor = '#d1d5db'}
                    />
                </div>
            </div>

            {/* STEP 1.11: FOOTER - Cancel + Save Buttons */}
            {/* STEP 1.23: Responsive gap (8px mobile, 12px desktop) */}
            <div style={{
                display: 'flex',
                gap: isMobile ? '8px' : '12px',
                justifyContent: 'flex-end',
                padding: '20px 24px',
                borderTop: '1px solid #e5e7eb',
                background: '#f9fafb'
            }}>
                <button
                    onClick={onClose}
                    style={{
                        padding: '12px 24px',
                        background: '#e5e7eb',
                        border: 'none',
                        borderRadius: '8px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        color: '#374151',
                        fontSize: '15px',
                        transition: 'background 0.2s'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.background = '#d1d5db'}
                    onMouseLeave={(e) => e.currentTarget.style.background = '#e5e7eb'}
                >
                    Cancel
                </button>
                <button
                    onClick={handleSave}
                    disabled={saving}
                    style={{
                        padding: '12px 24px',
                        background: saving ? '#9ca3af' : '#058585',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        fontWeight: '600',
                        cursor: saving ? 'not-allowed' : 'pointer',
                        fontSize: '15px',
                        opacity: saving ? 0.6 : 1,
                        transition: 'all 0.2s'
                    }}
                    onMouseEnter={(e) => {
                        if (!saving) e.currentTarget.style.background = '#047272';
                    }}
                    onMouseLeave={(e) => {
                        if (!saving) e.currentTarget.style.background = '#058585';
                    }}
                >
                    {saving ? 'Saving...' : 'Save Changes'}
                </button>
            </div>
        </>
    );
}

/** PasswordModal - Change password with current password verification + 2FA info */
function PasswordModal({ user, onClose, onSubmit }) {
    const [formData, setFormData] = React.useState({});

    return (
        <div>
            <h3 style={{marginBottom: '20px'}}>Password & Security</h3>
            <div className="form-group">
                <label className="form-label">Current Password</label>
                <input
                    type="password"
                    className="form-input"
                    value={formData.currentPassword || ''}
                    onChange={(e) => setFormData({...formData, currentPassword: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">New Password</label>
                <input
                    type="password"
                    className="form-input"
                    value={formData.newPassword || ''}
                    onChange={(e) => setFormData({...formData, newPassword: e.target.value})}
                />
            </div>
            <div className="form-group">
                <label className="form-label">Confirm New Password</label>
                <input
                    type="password"
                    className="form-input"
                    value={formData.confirmPassword || ''}
                    onChange={(e) => setFormData({...formData, confirmPassword: e.target.value})}
                />
            </div>
            <button
                className="btn-primary"
                onClick={async () => {
                    if (formData.newPassword !== formData.confirmPassword) {
                        alert('Passwords do not match');
                        return;
                    }
                    try {
                        await onSubmit(formData.currentPassword, formData.newPassword);
                        alert('Password updated successfully!');
                        onClose();
                    } catch (error) {
                        console.error('Error updating password:', error);
                        window.handleFirebaseError && window.handleFirebaseError(error, 'PasswordModal.handleUpdate');
                        alert('Failed to update password. Check current password.');
                    }
                }}
            >
                Update Password
            </button>

            <div style={{marginTop: '30px', paddingTop: '20px', borderTop: '1px solid rgba(255,255,255,0.1)'}}>
                <h4 style={{marginBottom: '15px'}}>Two-Factor Authentication</h4>
                <p style={{fontSize: '14px', opacity: 0.8, marginBottom: '15px'}}>
                    Add an extra layer of security to your account
                </p>
                <button className="btn-primary" style={{background: 'rgba(76, 175, 80, 0.2)', border: '1px solid #4CAF50'}}>
                    Enable 2FA (Coming Soon)
                </button>
            </div>
        </div>
    );
}

/** NotificationSettingsModal - Configure notification times, alert preferences */
/** NotificationSettingsModal - Configure notification preferences and reminders */
function NotificationSettingsModal({ userData, user, onClose, onUpdate }) {
    // STEP 1.13: Initialize form data with current userData
    const [formData, setFormData] = React.useState({
        notificationsEnabled: userData?.notifications?.enabled !== false,
        morningCheckInTime: userData?.notifications?.morningCheckIn || '08:00',
        eveningReflectionTime: userData?.notifications?.eveningReflection || '20:00',
        pledgeTime: userData?.notifications?.dailyPledge || '09:00',
        assignmentAlerts: userData?.notifications?.assignmentAlerts !== false,
        milestoneAlerts: userData?.notifications?.milestoneAlerts !== false,
        messageAlerts: userData?.notifications?.messageAlerts !== false,
        missedCheckInAlerts: userData?.notifications?.missedCheckInAlerts !== false,
        quietHoursEnabled: userData?.notifications?.quietHours?.enabled !== false,
        quietHoursStart: userData?.notifications?.quietHours?.start || '22:00',
        quietHoursEnd: userData?.notifications?.quietHours?.end || '08:00',
        notificationSounds: userData?.notifications?.sounds !== false,
        vibration: userData?.notifications?.vibration !== false,
        emailDigestEnabled: userData?.notifications?.emailDigest?.enabled !== false,
        emailDigestFrequency: userData?.notifications?.emailDigest?.frequency || 'weekly',
        weeklyReport: userData?.notifications?.weeklyReport !== false,
        communityActivity: userData?.notifications?.communityActivity !== false
    });

    const [saving, setSaving] = React.useState(false);

    // STEP 1.18K: Mobile detection for responsive layout
    const [isMobile, setIsMobile] = React.useState(window.innerWidth < 768);

    // STEP 1.13: Save handler with Firestore update
    const handleSave = async () => {
        setSaving(true);
        try {
            const updates = {
                notifications: {
                    enabled: formData.notificationsEnabled,
                    morningCheckIn: formData.morningCheckInTime,
                    eveningReflection: formData.eveningReflectionTime,
                    dailyPledge: formData.pledgeTime,
                    assignmentAlerts: formData.assignmentAlerts,
                    milestoneAlerts: formData.milestoneAlerts,
                    messageAlerts: formData.messageAlerts,
                    missedCheckInAlerts: formData.missedCheckInAlerts,
                    quietHours: {
                        enabled: formData.quietHoursEnabled,
                        start: formData.quietHoursStart,
                        end: formData.quietHoursEnd
                    },
                    sounds: formData.notificationSounds,
                    vibration: formData.vibration,
                    emailDigest: {
                        enabled: formData.emailDigestEnabled,
                        frequency: formData.emailDigestFrequency
                    },
                    weeklyReport: formData.weeklyReport,
                    communityActivity: formData.communityActivity
                }
            };
            await onUpdate(updates);
            window.showNotification('Notification settings updated successfully', 'success');
            onClose();
        } catch (error) {
            console.error('Error updating notification settings:', error);
            window.handleFirebaseError && window.handleFirebaseError(error, 'NotificationSettingsModal.handleSave');
            alert('Failed to save changes. Please try again.');
        } finally {
            setSaving(false);
        }
    };

    // STEP 1.13: Initialize Lucide icons after render
    // STEP 1.18K: Handle window resize for responsive layout
    React.useEffect(() => {
        if (window.lucide && typeof window.lucide.createIcons === 'function') {
            window.lucide.createIcons();
        }

        // Handle window resize for mobile detection
        const handleResize = () => {
            setIsMobile(window.innerWidth < 768);
        };
        window.addEventListener('resize', handleResize);

        // Cleanup
        return () => {
            window.removeEventListener('resize', handleResize);
        };
    }, []);

    return (
        <>
            {/* STEP 1.13: HEADER - Title + Close Button */}
            <div style={{
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                padding: '24px',
                borderBottom: '1px solid #e5e7eb'
            }}>
                <h2 style={{
                    fontSize: '24px',
                    fontWeight: '700',
                    color: '#111827',
                    margin: 0
                }}>
                    Notification Settings
                </h2>
                <button
                    onClick={onClose}
                    style={{
                        background: 'none',
                        border: 'none',
                        cursor: 'pointer',
                        padding: '8px',
                        borderRadius: '8px',
                        transition: 'background 0.2s',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.background = '#f3f4f6'}
                    onMouseLeave={(e) => e.currentTarget.style.background = 'none'}
                >
                    <i data-lucide="x" style={{width: '24px', height: '24px', color: '#6b7280'}}></i>
                </button>
            </div>

            {/* STEP 1.13: BODY - Scrollable Settings */}
            <div style={{
                padding: '24px',
                overflowY: 'auto',
                maxHeight: 'calc(90vh - 160px)'
            }}>
                {/* Master Toggle */}
                <div style={{
                    marginBottom: '24px',
                    paddingBottom: '20px',
                    borderBottom: '1px solid #e5e7eb'
                }}>
                    <label style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px',
                        cursor: 'pointer',
                        fontSize: '16px',
                        fontWeight: '600',
                        color: '#111827'
                    }}>
                        <input
                            type="checkbox"
                            checked={formData.notificationsEnabled}
                            onChange={(e) => setFormData({...formData, notificationsEnabled: e.target.checked})}
                            style={{
                                width: '18px',
                                height: '18px',
                                cursor: 'pointer',
                                accentColor: '#058585'
                            }}
                        />
                        Enable All Notifications
                    </label>
                    <small style={{
                        color: '#6b7280',
                        fontSize: '12px',
                        marginLeft: '30px',
                        display: 'block',
                        marginTop: '6px'
                    }}>
                        Master switch to control all notification types
                    </small>
                </div>

                {/* Daily Reminders Section */}
                <h3 style={{
                    fontSize: '16px',
                    fontWeight: '600',
                    color: '#111827',
                    marginBottom: '16px'
                }}>
                    Daily Reminders
                </h3>
                <div style={{ marginBottom: '20px' }}>
                    <label style={{
                        display: 'block',
                        fontSize: '14px',
                        fontWeight: '600',
                        color: '#374151',
                        marginBottom: '6px'
                    }}>
                        Morning Check-in Time
                    </label>
                    <input
                        type="time"
                        value={formData.morningCheckInTime}
                        onChange={(e) => setFormData({...formData, morningCheckInTime: e.target.value})}
                        style={{
                            width: '100%',
                            padding: '10px 14px',
                            border: '1px solid #d1d5db',
                            borderRadius: '8px',
                            fontSize: '15px',
                            color: '#111827',
                            transition: 'border-color 0.2s',
                            boxSizing: 'border-box'
                        }}
                        onFocus={(e) => e.currentTarget.style.borderColor = '#058585'}
                        onBlur={(e) => e.currentTarget.style.borderColor = '#d1d5db'}
                    />
                </div>

                <div style={{ marginBottom: '20px' }}>
                    <label style={{
                        display: 'block',
                        fontSize: '14px',
                        fontWeight: '600',
                        color: '#374151',
                        marginBottom: '6px'
                    }}>
                        Evening Reflection Time
                    </label>
                    <input
                        type="time"
                        value={formData.eveningReflectionTime}
                        onChange={(e) => setFormData({...formData, eveningReflectionTime: e.target.value})}
                        style={{
                            width: '100%',
                            padding: '10px 14px',
                            border: '1px solid #d1d5db',
                            borderRadius: '8px',
                            fontSize: '15px',
                            color: '#111827',
                            transition: 'border-color 0.2s',
                            boxSizing: 'border-box'
                        }}
                        onFocus={(e) => e.currentTarget.style.borderColor = '#058585'}
                        onBlur={(e) => e.currentTarget.style.borderColor = '#d1d5db'}
                    />
                </div>

                <div style={{ marginBottom: '24px' }}>
                    <label style={{
                        display: 'block',
                        fontSize: '14px',
                        fontWeight: '600',
                        color: '#374151',
                        marginBottom: '6px'
                    }}>
                        Daily Pledge Reminder
                    </label>
                    <input
                        type="time"
                        value={formData.pledgeTime}
                        onChange={(e) => setFormData({...formData, pledgeTime: e.target.value})}
                        style={{
                            width: '100%',
                            padding: '10px 14px',
                            border: '1px solid #d1d5db',
                            borderRadius: '8px',
                            fontSize: '15px',
                            color: '#111827',
                            transition: 'border-color 0.2s',
                            boxSizing: 'border-box'
                        }}
                        onFocus={(e) => e.currentTarget.style.borderColor = '#058585'}
                        onBlur={(e) => e.currentTarget.style.borderColor = '#d1d5db'}
                    />
                </div>

                {/* Alert Preferences Section */}
                <h3 style={{
                    fontSize: '16px',
                    fontWeight: '600',
                    color: '#111827',
                    marginTop: '32px',
                    marginBottom: '16px',
                    paddingTop: '20px',
                    borderTop: '1px solid #e5e7eb'
                }}>
                    Alert Preferences
                </h3>

                <div style={{ display: 'flex', flexDirection: 'column', gap: '12px', marginBottom: '24px' }}>
                    <label style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px',
                        cursor: 'pointer',
                        fontSize: '15px',
                        color: '#374151'
                    }}>
                        <input
                            type="checkbox"
                            checked={formData.assignmentAlerts}
                            onChange={(e) => setFormData({...formData, assignmentAlerts: e.target.checked})}
                            style={{
                                width: '18px',
                                height: '18px',
                                cursor: 'pointer',
                                accentColor: '#058585'
                            }}
                        />
                        Assignment due date reminders
                    </label>

                    <label style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px',
                        cursor: 'pointer',
                        fontSize: '15px',
                        color: '#374151'
                    }}>
                        <input
                            type="checkbox"
                            checked={formData.milestoneAlerts}
                            onChange={(e) => setFormData({...formData, milestoneAlerts: e.target.checked})}
                            style={{
                                width: '18px',
                                height: '18px',
                                cursor: 'pointer',
                                accentColor: '#058585'
                            }}
                        />
                        Milestone celebration alerts
                    </label>

                    <label style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px',
                        cursor: 'pointer',
                        fontSize: '15px',
                        color: '#374151'
                    }}>
                        <input
                            type="checkbox"
                            checked={formData.messageAlerts}
                            onChange={(e) => setFormData({...formData, messageAlerts: e.target.checked})}
                            style={{
                                width: '18px',
                                height: '18px',
                                cursor: 'pointer',
                                accentColor: '#058585'
                            }}
                        />
                        New message notifications
                    </label>

                    <label style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px',
                        cursor: 'pointer',
                        fontSize: '15px',
                        color: '#374151'
                    }}>
                        <input
                            type="checkbox"
                            checked={formData.missedCheckInAlerts}
                            onChange={(e) => setFormData({...formData, missedCheckInAlerts: e.target.checked})}
                            style={{
                                width: '18px',
                                height: '18px',
                                cursor: 'pointer',
                                accentColor: '#058585'
                            }}
                        />
                        Missed check-in reminders
                    </label>
                </div>

                {/* Delivery Settings Section */}
                <h3 style={{
                    fontSize: '16px',
                    fontWeight: '600',
                    color: '#111827',
                    marginTop: '32px',
                    marginBottom: '16px',
                    paddingTop: '20px',
                    borderTop: '1px solid #e5e7eb'
                }}>
                    Delivery Settings
                </h3>

                {/* Quiet Hours */}
                <div style={{
                    marginBottom: '20px',
                    padding: '16px',
                    background: '#f9fafb',
                    border: '1px solid #e5e7eb',
                    borderRadius: '8px'
                }}>
                    <label style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px',
                        marginBottom: '12px',
                        cursor: 'pointer',
                        fontSize: '15px',
                        color: '#374151',
                        fontWeight: '600'
                    }}>
                        <input
                            type="checkbox"
                            checked={formData.quietHoursEnabled}
                            onChange={(e) => setFormData({...formData, quietHoursEnabled: e.target.checked})}
                            style={{
                                width: '18px',
                                height: '18px',
                                cursor: 'pointer',
                                accentColor: '#058585'
                            }}
                        />
                        Enable Quiet Hours
                    </label>

                    {formData.quietHoursEnabled && (
                        <div style={{ marginLeft: '30px', display: 'grid', gridTemplateColumns: isMobile ? '1fr' : '1fr 1fr', gap: '12px' }}>
                            <div>
                                <label style={{
                                    display: 'block',
                                    fontSize: '13px',
                                    fontWeight: '600',
                                    color: '#374151',
                                    marginBottom: '6px'
                                }}>
                                    Start Time
                                </label>
                                <input
                                    type="time"
                                    value={formData.quietHoursStart}
                                    onChange={(e) => setFormData({...formData, quietHoursStart: e.target.value})}
                                    style={{
                                        width: '100%',
                                        padding: '8px 12px',
                                        border: '1px solid #d1d5db',
                                        borderRadius: '6px',
                                        fontSize: '14px',
                                        color: '#111827',
                                        boxSizing: 'border-box'
                                    }}
                                />
                            </div>
                            <div>
                                <label style={{
                                    display: 'block',
                                    fontSize: '13px',
                                    fontWeight: '600',
                                    color: '#374151',
                                    marginBottom: '6px'
                                }}>
                                    End Time
                                </label>
                                <input
                                    type="time"
                                    value={formData.quietHoursEnd}
                                    onChange={(e) => setFormData({...formData, quietHoursEnd: e.target.value})}
                                    style={{
                                        width: '100%',
                                        padding: '8px 12px',
                                        border: '1px solid #d1d5db',
                                        borderRadius: '6px',
                                        fontSize: '14px',
                                        color: '#111827',
                                        boxSizing: 'border-box'
                                    }}
                                />
                            </div>
                        </div>
                    )}
                    <small style={{
                        color: '#6b7280',
                        fontSize: '12px',
                        display: 'block',
                        marginTop: '10px'
                    }}>
                        No notifications will be sent during quiet hours
                    </small>
                </div>

                {/* Additional Delivery Settings */}
                <div style={{ display: 'flex', flexDirection: 'column', gap: '12px', marginBottom: '24px' }}>
                    <label style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px',
                        cursor: 'pointer',
                        fontSize: '15px',
                        color: '#374151'
                    }}>
                        <input
                            type="checkbox"
                            checked={formData.notificationSounds}
                            onChange={(e) => setFormData({...formData, notificationSounds: e.target.checked})}
                            style={{
                                width: '18px',
                                height: '18px',
                                cursor: 'pointer',
                                accentColor: '#058585'
                            }}
                        />
                        <div>
                            <div>Notification Sounds</div>
                            <small style={{ color: '#6b7280', fontSize: '12px' }}>Play sound when notifications arrive</small>
                        </div>
                    </label>

                    <label style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px',
                        cursor: 'pointer',
                        fontSize: '15px',
                        color: '#374151'
                    }}>
                        <input
                            type="checkbox"
                            checked={formData.vibration}
                            onChange={(e) => setFormData({...formData, vibration: e.target.checked})}
                            style={{
                                width: '18px',
                                height: '18px',
                                cursor: 'pointer',
                                accentColor: '#058585'
                            }}
                        />
                        <div>
                            <div>Vibration</div>
                            <small style={{ color: '#6b7280', fontSize: '12px' }}>Vibrate when notifications arrive</small>
                        </div>
                    </label>
                </div>

                {/* Email & Reports Section */}
                <h3 style={{
                    fontSize: '16px',
                    fontWeight: '600',
                    color: '#111827',
                    marginTop: '32px',
                    marginBottom: '16px',
                    paddingTop: '20px',
                    borderTop: '1px solid #e5e7eb'
                }}>
                    Email & Reports
                </h3>

                {/* Email Digest */}
                <div style={{ marginBottom: '20px' }}>
                    <label style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px',
                        marginBottom: '12px',
                        cursor: 'pointer',
                        fontSize: '15px',
                        color: '#374151',
                        fontWeight: '600'
                    }}>
                        <input
                            type="checkbox"
                            checked={formData.emailDigestEnabled}
                            onChange={(e) => setFormData({...formData, emailDigestEnabled: e.target.checked})}
                            style={{
                                width: '18px',
                                height: '18px',
                                cursor: 'pointer',
                                accentColor: '#058585'
                            }}
                        />
                        Email Digest
                    </label>

                    {formData.emailDigestEnabled && (
                        <div style={{ marginLeft: '30px', marginBottom: '10px' }}>
                            <label style={{
                                display: 'block',
                                fontSize: '13px',
                                fontWeight: '600',
                                color: '#374151',
                                marginBottom: '6px'
                            }}>
                                Frequency
                            </label>
                            <select
                                value={formData.emailDigestFrequency}
                                onChange={(e) => setFormData({...formData, emailDigestFrequency: e.target.value})}
                                style={{
                                    width: '200px',
                                    padding: '8px 12px',
                                    border: '1px solid #d1d5db',
                                    borderRadius: '6px',
                                    fontSize: '14px',
                                    color: '#111827',
                                    background: 'white'
                                }}
                            >
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                    )}
                    <small style={{
                        color: '#6b7280',
                        fontSize: '12px',
                        display: 'block',
                        marginLeft: '30px'
                    }}>
                        Receive email summary of your recovery progress
                    </small>
                </div>

                {/* Additional Report Options */}
                <div style={{ display: 'flex', flexDirection: 'column', gap: '12px', marginBottom: '24px' }}>
                    <label style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px',
                        cursor: 'pointer',
                        fontSize: '15px',
                        color: '#374151'
                    }}>
                        <input
                            type="checkbox"
                            checked={formData.weeklyReport}
                            onChange={(e) => setFormData({...formData, weeklyReport: e.target.checked})}
                            style={{
                                width: '18px',
                                height: '18px',
                                cursor: 'pointer',
                                accentColor: '#058585'
                            }}
                        />
                        <div>
                            <div>Weekly Progress Report</div>
                            <small style={{ color: '#6b7280', fontSize: '12px' }}>Receive weekly summary notification of your progress</small>
                        </div>
                    </label>

                    <label style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px',
                        cursor: 'pointer',
                        fontSize: '15px',
                        color: '#374151'
                    }}>
                        <input
                            type="checkbox"
                            checked={formData.communityActivity}
                            onChange={(e) => setFormData({...formData, communityActivity: e.target.checked})}
                            style={{
                                width: '18px',
                                height: '18px',
                                cursor: 'pointer',
                                accentColor: '#058585'
                            }}
                        />
                        <div>
                            <div>Community Activity</div>
                            <small style={{ color: '#6b7280', fontSize: '12px' }}>Get notified about replies and interactions in community discussions</small>
                        </div>
                    </label>
                </div>
            </div>

            {/* STEP 1.13: FOOTER - Cancel + Save Buttons */}
            {/* STEP 1.23: Responsive gap (8px mobile, 12px desktop) */}
            <div style={{
                display: 'flex',
                gap: isMobile ? '8px' : '12px',
                justifyContent: 'flex-end',
                padding: '20px 24px',
                borderTop: '1px solid #e5e7eb',
                background: '#f9fafb'
            }}>
                <button
                    onClick={onClose}
                    style={{
                        padding: '12px 24px',
                        background: '#e5e7eb',
                        border: 'none',
                        borderRadius: '8px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        color: '#374151',
                        fontSize: '15px',
                        transition: 'background 0.2s'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.background = '#d1d5db'}
                    onMouseLeave={(e) => e.currentTarget.style.background = '#e5e7eb'}
                >
                    Cancel
                </button>
                <button
                    onClick={handleSave}
                    disabled={saving}
                    style={{
                        padding: '12px 24px',
                        background: saving ? '#9ca3af' : '#058585',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        fontWeight: '600',
                        cursor: saving ? 'not-allowed' : 'pointer',
                        fontSize: '15px',
                        opacity: saving ? 0.6 : 1,
                        transition: 'all 0.2s'
                    }}
                    onMouseEnter={(e) => {
                        if (!saving) e.currentTarget.style.background = '#047272';
                    }}
                    onMouseLeave={(e) => {
                        if (!saving) e.currentTarget.style.background = '#058585';
                    }}
                >
                    {saving ? 'Saving...' : 'Save Changes'}
                </button>
            </div>
        </>
    );
}

/** PrivacySettingsModal - Control profile visibility and data sharing */
/** PrivacySettingsModal - Privacy settings and blocked users management */
function PrivacySettingsModal({ userData, user, onClose, onUpdate }) {
    // STEP 1.15: Initialize form data with current userData
    const [formData, setFormData] = React.useState({
        profileVisibility: userData?.privacy?.profileVisibility || 'coach_only',
        showSobrietyDate: userData?.privacy?.showSobrietyDate !== false,
        showProgressStats: userData?.privacy?.showProgressStats || false,
        communityParticipation: userData?.privacy?.communityParticipation !== false,
        allowDirectMessages: userData?.privacy?.allowDirectMessages !== false,
        anonymousPosting: userData?.privacy?.anonymousPosting || false
    });
    const [blockedUsers, setBlockedUsers] = React.useState(userData?.privacy?.blockedUsers || []);
    const [saving, setSaving] = React.useState(false);

    // STEP 1.23: Mobile detection for responsive layout
    const [isMobile, setIsMobile] = React.useState(window.innerWidth < 768);

    React.useEffect(() => {
        const handleResize = () => setIsMobile(window.innerWidth < 768);
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
    }, []);

    // STEP 1.15: Save handler
    const handleSave = async () => {
        setSaving(true);
        try {
            const updates = {
                privacy: {
                    profileVisibility: formData.profileVisibility,
                    showSobrietyDate: formData.showSobrietyDate,
                    showProgressStats: formData.showProgressStats,
                    communityParticipation: formData.communityParticipation,
                    allowDirectMessages: formData.allowDirectMessages,
                    anonymousPosting: formData.anonymousPosting,
                    shareProgressWithCoach: true, // Always true, locked
                    blockedUsers: blockedUsers
                }
            };
            await onUpdate(updates);
            window.showNotification('Privacy settings updated successfully', 'success');
            onClose();
        } catch (error) {
            console.error('Error updating privacy settings:', error);
            window.handleFirebaseError && window.handleFirebaseError(error, 'PrivacySettingsModal.handleSave');
            alert('Failed to update privacy settings. Please try again.');
        } finally {
            setSaving(false);
        }
    };

    React.useEffect(() => {
        window.lucide?.createIcons();
    }, [blockedUsers]);

    return (
        <>
            {/* STEP 1.15: HEADER */}
            <div style={{
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                padding: '24px',
                borderBottom: '1px solid #e5e7eb'
            }}>
                <h2 style={{
                    fontSize: '24px',
                    fontWeight: '700',
                    color: '#111827',
                    margin: 0,
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px'
                }}>
                    <i data-lucide="shield" style={{width: '28px', height: '28px', color: '#dc2626'}}></i>
                    Privacy Settings
                </h2>
                <button
                    onClick={onClose}
                    style={{
                        background: 'none',
                        border: 'none',
                        cursor: 'pointer',
                        padding: '8px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        borderRadius: '8px',
                        transition: 'all 0.2s'
                    }}
                >
                    <i data-lucide="x" style={{width: '24px', height: '24px', color: '#6b7280'}}></i>
                </button>
            </div>

            {/* STEP 1.15: BODY */}
            <div style={{
                padding: '24px',
                overflowY: 'auto',
                maxHeight: 'calc(90vh - 160px)'
            }}>
                {/* Profile Visibility Section */}
                <div style={{marginBottom: '32px'}}>
                    <h3 style={{
                        fontSize: '16px',
                        fontWeight: '600',
                        color: '#374151',
                        marginBottom: '16px',
                        paddingBottom: '8px',
                        borderBottom: '2px solid #e5e7eb'
                    }}>
                        Profile Visibility
                    </h3>

                    {/* Profile Visibility Dropdown */}
                    <div style={{marginBottom: '20px'}}>
                        <label style={{
                            display: 'block',
                            fontSize: '14px',
                            fontWeight: '600',
                            color: '#374151',
                            marginBottom: '8px',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px'
                        }}>
                            <i data-lucide="eye" style={{width: '16px', height: '16px', color: '#6b7280'}}></i>
                            Who can see your profile
                        </label>
                        <select
                            value={formData.profileVisibility}
                            onChange={(e) => setFormData({...formData, profileVisibility: e.target.value})}
                            style={{
                                width: '100%',
                                padding: '12px',
                                fontSize: '15px',
                                border: '1px solid #d1d5db',
                                borderRadius: '8px',
                                background: '#fff',
                                color: '#111827',
                                outline: 'none',
                                transition: 'border-color 0.2s'
                            }}
                            onFocus={(e) => e.target.style.borderColor = '#058585'}
                            onBlur={(e) => e.target.style.borderColor = '#d1d5db'}
                        >
                            <option value="everyone">Everyone</option>
                            <option value="coach_only">Coach Only</option>
                            <option value="private">Private</option>
                        </select>
                        <div style={{fontSize: '13px', color: '#6b7280', marginTop: '6px'}}>
                            Control who can see your profile information
                        </div>
                    </div>

                    {/* Show Sobriety Date */}
                    <label style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px',
                        marginBottom: '20px',
                        cursor: 'pointer'
                    }}>
                        <input
                            type="checkbox"
                            checked={formData.showSobrietyDate}
                            onChange={(e) => setFormData({...formData, showSobrietyDate: e.target.checked})}
                            style={{
                                width: '18px',
                                height: '18px',
                                accentColor: '#058585',
                                cursor: 'pointer'
                            }}
                        />
                        <div style={{flex: 1}}>
                            <div style={{fontSize: '15px', color: '#374151', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '8px'}}>
                                <i data-lucide="calendar" style={{width: '16px', height: '16px', color: '#6b7280'}}></i>
                                Show Sobriety Date
                            </div>
                            <div style={{fontSize: '13px', color: '#6b7280', marginTop: '4px'}}>
                                Display your sobriety start date on your profile
                            </div>
                        </div>
                    </label>

                    {/* Show Progress Stats */}
                    <label style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px',
                        cursor: 'pointer'
                    }}>
                        <input
                            type="checkbox"
                            checked={formData.showProgressStats}
                            onChange={(e) => setFormData({...formData, showProgressStats: e.target.checked})}
                            style={{
                                width: '18px',
                                height: '18px',
                                accentColor: '#058585',
                                cursor: 'pointer'
                            }}
                        />
                        <div style={{flex: 1}}>
                            <div style={{fontSize: '15px', color: '#374151', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '8px'}}>
                                <i data-lucide="bar-chart" style={{width: '16px', height: '16px', color: '#6b7280'}}></i>
                                Show Progress Stats
                            </div>
                            <div style={{fontSize: '13px', color: '#6b7280', marginTop: '4px'}}>
                                Display your milestone achievements and streaks publicly
                            </div>
                        </div>
                    </label>
                </div>

                {/* Community Privacy Section */}
                <div style={{marginBottom: '32px'}}>
                    <h3 style={{
                        fontSize: '16px',
                        fontWeight: '600',
                        color: '#374151',
                        marginBottom: '16px',
                        paddingBottom: '8px',
                        borderBottom: '2px solid #e5e7eb'
                    }}>
                        Community Privacy
                    </h3>

                    {/* Community Participation */}
                    <label style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px',
                        marginBottom: '20px',
                        cursor: 'pointer'
                    }}>
                        <input
                            type="checkbox"
                            checked={formData.communityParticipation}
                            onChange={(e) => setFormData({...formData, communityParticipation: e.target.checked})}
                            style={{
                                width: '18px',
                                height: '18px',
                                accentColor: '#058585',
                                cursor: 'pointer'
                            }}
                        />
                        <div style={{flex: 1}}>
                            <div style={{fontSize: '15px', color: '#374151', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '8px'}}>
                                <i data-lucide="users" style={{width: '16px', height: '16px', color: '#6b7280'}}></i>
                                Community Participation
                            </div>
                            <div style={{fontSize: '13px', color: '#6b7280', marginTop: '4px'}}>
                                Appear in community feed and topic rooms
                            </div>
                        </div>
                    </label>

                    {/* Allow Direct Messages */}
                    <label style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px',
                        marginBottom: '20px',
                        cursor: 'pointer'
                    }}>
                        <input
                            type="checkbox"
                            checked={formData.allowDirectMessages}
                            onChange={(e) => setFormData({...formData, allowDirectMessages: e.target.checked})}
                            style={{
                                width: '18px',
                                height: '18px',
                                accentColor: '#058585',
                                cursor: 'pointer'
                            }}
                        />
                        <div style={{flex: 1}}>
                            <div style={{fontSize: '15px', color: '#374151', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '8px'}}>
                                <i data-lucide="message-square" style={{width: '16px', height: '16px', color: '#6b7280'}}></i>
                                Allow Direct Messages
                            </div>
                            <div style={{fontSize: '13px', color: '#6b7280', marginTop: '4px'}}>
                                Let other PIRs send you private messages
                            </div>
                        </div>
                    </label>

                    {/* Anonymous Posting */}
                    <label style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px',
                        cursor: 'pointer'
                    }}>
                        <input
                            type="checkbox"
                            checked={formData.anonymousPosting}
                            onChange={(e) => setFormData({...formData, anonymousPosting: e.target.checked})}
                            style={{
                                width: '18px',
                                height: '18px',
                                accentColor: '#058585',
                                cursor: 'pointer'
                            }}
                        />
                        <div style={{flex: 1}}>
                            <div style={{fontSize: '15px', color: '#374151', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '8px'}}>
                                <i data-lucide="user-x" style={{width: '16px', height: '16px', color: '#6b7280'}}></i>
                                Anonymous Posting
                            </div>
                            <div style={{fontSize: '13px', color: '#6b7280', marginTop: '4px'}}>
                                Post in community without showing your name
                            </div>
                        </div>
                    </label>
                </div>

                {/* Data Sharing Section */}
                <div style={{marginBottom: '32px'}}>
                    <h3 style={{
                        fontSize: '16px',
                        fontWeight: '600',
                        color: '#374151',
                        marginBottom: '16px',
                        paddingBottom: '8px',
                        borderBottom: '2px solid #e5e7eb'
                    }}>
                        Data Sharing
                    </h3>

                    {/* Share Progress with Coach (Locked) */}
                    <label style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px',
                        opacity: 0.7
                    }}>
                        <input
                            type="checkbox"
                            checked={true}
                            disabled={true}
                            style={{
                                width: '18px',
                                height: '18px',
                                cursor: 'not-allowed'
                            }}
                        />
                        <div style={{flex: 1}}>
                            <div style={{fontSize: '15px', color: '#374151', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '8px'}}>
                                <i data-lucide="share-2" style={{width: '16px', height: '16px', color: '#6b7280'}}></i>
                                Share Progress with Coach
                            </div>
                            <div style={{fontSize: '13px', color: '#6b7280', marginTop: '4px'}}>
                                Your coach always has access to your progress (required for service)
                            </div>
                        </div>
                    </label>
                </div>

                {/* Blocked Users Section */}
                <div style={{
                    background: 'rgba(220, 38, 38, 0.1)',
                    border: '1px solid rgba(220, 38, 38, 0.3)',
                    borderRadius: '12px',
                    padding: '20px'
                }}>
                    <h3 style={{
                        fontSize: '16px',
                        fontWeight: '600',
                        color: '#dc2626',
                        marginBottom: '16px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                    }}>
                        <i data-lucide="ban" style={{width: '18px', height: '18px'}}></i>
                        Blocked Users
                    </h3>
                    {blockedUsers.length === 0 ? (
                        <p style={{fontSize: '14px', color: '#6b7280', margin: 0}}>
                            You haven't blocked any users yet.
                        </p>
                    ) : (
                        <div style={{display: 'flex', flexDirection: 'column', gap: '12px'}}>
                            {blockedUsers.map((userId, index) => (
                                <div key={index} style={{
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center',
                                    padding: '12px',
                                    background: 'rgba(0,0,0,0.1)',
                                    borderRadius: '8px'
                                }}>
                                    <span style={{fontSize: '14px', color: '#374151'}}>User ID: {userId}</span>
                                    <button
                                        onClick={() => {
                                            const updated = blockedUsers.filter((id) => id !== userId);
                                            setBlockedUsers(updated);
                                        }}
                                        style={{
                                            padding: '6px 16px',
                                            fontSize: '13px',
                                            fontWeight: '600',
                                            background: '#dc2626',
                                            color: '#fff',
                                            border: 'none',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            transition: 'all 0.2s'
                                        }}
                                    >
                                        Unblock
                                    </button>
                                </div>
                            ))}
                        </div>
                    )}
                    <div style={{fontSize: '13px', color: '#6b7280', marginTop: '12px'}}>
                        Users you've blocked cannot see your profile or message you
                    </div>
                </div>
            </div>

            {/* STEP 1.15: FOOTER */}
            {/* STEP 1.23: Responsive gap (8px mobile, 12px desktop) */}
            <div style={{
                display: 'flex',
                gap: isMobile ? '8px' : '12px',
                justifyContent: 'flex-end',
                padding: '20px 24px',
                borderTop: '1px solid #e5e7eb',
                background: '#f9fafb'
            }}>
                <button
                    onClick={onClose}
                    style={{
                        padding: '12px 24px',
                        fontSize: '15px',
                        fontWeight: '600',
                        color: '#6b7280',
                        background: '#fff',
                        border: '1px solid #d1d5db',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        transition: 'all 0.2s'
                    }}
                >
                    Cancel
                </button>
                <button
                    onClick={handleSave}
                    disabled={saving}
                    style={{
                        padding: '12px 24px',
                        fontSize: '15px',
                        fontWeight: '600',
                        color: '#fff',
                        background: saving ? '#6b7280' : '#058585',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: saving ? 'not-allowed' : 'pointer',
                        transition: 'all 0.2s'
                    }}
                >
                    {saving ? 'Saving...' : 'Save Changes'}
                </button>
            </div>
        </>
    );
}

/** DataManagementModal - GDPR data export and account management */
function DataManagementModal({ userData, user, onClose }) {
    // STEP 1.16: State management
    const [dateRange, setDateRange] = React.useState('all');
    const [exporting, setExporting] = React.useState(false);
    const [showPasswordModal, setShowPasswordModal] = React.useState(false);

    const exportUserData = async () => {
        setExporting(true);
        try {
            const exportData = {
                exportedAt: new Date().toISOString(),
                exportVersion: "1.0",
                dateRange: dateRange,
                user: {},
                checkIns: [],
                goals: [],
                objectives: [],
                assignments: [],
                messages: [],
                topicRoomMessages: [],
                gratitudes: [],
                reflections: [],
                habits: [],
                habitCompletions: [],
                quickReflections: [],
                todayWins: [],
                pledges: [],
                breakthroughs: []
            };

            // Calculate date filter
            let startDate = null;
            if (dateRange === '30days') {
                startDate = new Date();
                startDate.setDate(startDate.getDate() - 30);
            } else if (dateRange === '90days') {
                startDate = new Date();
                startDate.setDate(startDate.getDate() - 90);
            }

            // 1. Export user profile
            const userDoc = await db.collection('users').doc(user.uid).get();
            exportData.user = userDoc.data();

            // 2. Export check-ins
            let checkInsQuery = db.collection('checkins').where('userId', '==', user.uid);
            if (startDate) {
                checkInsQuery = checkInsQuery.where('timestamp', '>=', startDate);
            }
            const checkInsSnap = await checkInsQuery.orderBy('timestamp', 'desc').limit(1000).get();
            checkInsSnap.forEach(doc => {
                exportData.checkIns.push({ id: doc.id, ...doc.data() });
            });

            // 3. Export goals
            const goalsSnap = await db.collection('goals')
                .where('userId', '==', user.uid)
                .orderBy('createdAt', 'desc')
                .limit(500)
                .get();
            goalsSnap.forEach(doc => {
                exportData.goals.push({ id: doc.id, ...doc.data() });
            });

            // 4. Export objectives
            const objectivesSnap = await db.collection('objectives')
                .where('userId', '==', user.uid)
                .orderBy('createdAt', 'desc')
                .limit(500)
                .get();
            objectivesSnap.forEach(doc => {
                exportData.objectives.push({ id: doc.id, ...doc.data() });
            });

            // 5. Export assignments
            let assignmentsQuery = db.collection('assignments').where('userId', '==', user.uid);
            if (startDate) {
                assignmentsQuery = assignmentsQuery.where('createdAt', '>=', startDate);
            }
            const assignmentsSnap = await assignmentsQuery.orderBy('createdAt', 'desc').limit(500).get();
            assignmentsSnap.forEach(doc => {
                exportData.assignments.push({ id: doc.id, ...doc.data() });
            });

            // 6. Export messages
            let messagesQuery = db.collection('messages').where('senderId', '==', user.uid);
            if (startDate) {
                messagesQuery = messagesQuery.where('createdAt', '>=', startDate);
            }
            const messagesSnap = await messagesQuery.orderBy('createdAt', 'desc').limit(1000).get();
            messagesSnap.forEach(doc => {
                exportData.messages.push({ id: doc.id, ...doc.data() });
            });

            // 7. Export topic room messages
            let topicMessagesQuery = db.collection('communityMessages').where('userId', '==', user.uid);
            if (startDate) {
                topicMessagesQuery = topicMessagesQuery.where('createdAt', '>=', startDate);
            }
            const topicMessagesSnap = await topicMessagesQuery.orderBy('createdAt', 'desc').limit(1000).get();
            topicMessagesSnap.forEach(doc => {
                exportData.topicRoomMessages.push({ id: doc.id, ...doc.data() });
            });

            // 8. Export gratitudes
            let gratitudesQuery = db.collection('gratitudes').where('userId', '==', user.uid);
            if (startDate) {
                gratitudesQuery = gratitudesQuery.where('date', '>=', startDate);
            }
            const gratitudesSnap = await gratitudesQuery.orderBy('date', 'desc').limit(500).get();
            gratitudesSnap.forEach(doc => {
                exportData.gratitudes.push({ id: doc.id, ...doc.data() });
            });

            // 9. Export reflections
            let reflectionsQuery = db.collection('reflections').where('userId', '==', user.uid);
            if (startDate) {
                reflectionsQuery = reflectionsQuery.where('date', '>=', startDate);
            }
            const reflectionsSnap = await reflectionsQuery.orderBy('date', 'desc').limit(500).get();
            reflectionsSnap.forEach(doc => {
                exportData.reflections.push({ id: doc.id, ...doc.data() });
            });

            // 10. Export habits
            const habitsSnap = await db.collection('habits')
                .where('userId', '==', user.uid)
                .orderBy('createdAt', 'desc')
                .limit(200).get();
            habitsSnap.forEach(doc => {
                exportData.habits.push({ id: doc.id, ...doc.data() });
            });

            // 11. Export habit completions
            let habitCompletionsQuery = db.collection('habitCompletions').where('userId', '==', user.uid);
            if (startDate) {
                habitCompletionsQuery = habitCompletionsQuery.where('completedAt', '>=', startDate);
            }
            const habitCompletionsSnap = await habitCompletionsQuery.orderBy('completedAt', 'desc').limit(1000).get();
            habitCompletionsSnap.forEach(doc => {
                exportData.habitCompletions.push({ id: doc.id, ...doc.data() });
            });

            // 12. Export quick reflections
            let quickReflectionsQuery = db.collection('quickReflections').where('userId', '==', user.uid);
            if (startDate) {
                quickReflectionsQuery = quickReflectionsQuery.where('createdAt', '>=', startDate);
            }
            const quickReflectionsSnap = await quickReflectionsQuery.orderBy('createdAt', 'desc').limit(500).get();
            quickReflectionsSnap.forEach(doc => {
                exportData.quickReflections.push({ id: doc.id, ...doc.data() });
            });

            // 13. Export today wins
            let todayWinsQuery = db.collection('todayWins').where('userId', '==', user.uid);
            if (startDate) {
                todayWinsQuery = todayWinsQuery.where('date', '>=', startDate);
            }
            const todayWinsSnap = await todayWinsQuery.orderBy('date', 'desc').limit(500).get();
            todayWinsSnap.forEach(doc => {
                exportData.todayWins.push({ id: doc.id, ...doc.data() });
            });

            // 14. Export pledges
            let pledgesQuery = db.collection('pledges').where('userId', '==', user.uid);
            if (startDate) {
                pledgesQuery = pledgesQuery.where('createdAt', '>=', startDate);
            }
            const pledgesSnap = await pledgesQuery.orderBy('createdAt', 'desc').limit(500).get();
            pledgesSnap.forEach(doc => {
                exportData.pledges.push({ id: doc.id, ...doc.data() });
            });

            // 15. Export breakthroughs
            let breakthroughsQuery = db.collection('breakthroughs').where('userId', '==', user.uid);
            if (startDate) {
                breakthroughsQuery = breakthroughsQuery.where('createdAt', '>=', startDate);
            }
            const breakthroughsSnap = await breakthroughsQuery.orderBy('createdAt', 'desc').limit(500).get();
            breakthroughsSnap.forEach(doc => {
                exportData.breakthroughs.push({ id: doc.id, ...doc.data() });
            });

            // Calculate total records
            const totalRecords = exportData.checkIns.length + exportData.goals.length +
                exportData.objectives.length + exportData.assignments.length +
                exportData.messages.length + exportData.topicRoomMessages.length +
                exportData.gratitudes.length + exportData.reflections.length +
                exportData.habits.length + exportData.habitCompletions.length +
                exportData.quickReflections.length + exportData.todayWins.length +
                exportData.pledges.length + exportData.breakthroughs.length;

            exportData.totalRecords = totalRecords;

            // Convert to JSON string
            const jsonString = JSON.stringify(exportData, null, 2);

            // Create blob and download
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `glrs-data-export-${user.uid}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert(`Export successful! ${totalRecords} records exported.`);
        } catch (error) {
            console.error('Export error:', error);
            window.handleFirebaseError && window.handleFirebaseError(error, 'DataManagementModal.exportUserData');
            alert('Failed to export data: ' + error.message);
        } finally {
            setExporting(false);
        }
    };

    const handleClearCache = () => {
        if (confirm('This will log you out and clear all cached data. Continue?')) {
            try {
                localStorage.clear();
                sessionStorage.clear();
                firebase.auth().signOut();
                window.location.reload();
            } catch (error) {
                alert('Failed to clear cache: ' + error.message);
            }
        }
    };

    const handleDeleteAccount = async () => {
        const password = prompt(
            'WARNING: This will permanently delete your account and ALL data.\n\n' +
            'This action CANNOT be undone.\n\n' +
            'To confirm, enter your password:'
        );

        if (!password) return;

        try {
            const credential = firebase.auth.EmailAuthProvider.credential(
                user.email,
                password
            );

            await user.reauthenticateWithCredential(credential);

            const finalConfirm = confirm(
                'FINAL WARNING: All your recovery data, messages, and progress will be permanently deleted. Continue?'
            );

            if (!finalConfirm) return;

            // Delete Firestore data first
            await db.collection('users').doc(user.uid).delete();

            // Delete auth account
            await user.delete();

            alert('Your account has been deleted.');
            window.location.href = '/';
        } catch (error) {
            if (error.code === 'auth/wrong-password') {
                alert('Incorrect password. Account deletion cancelled.');
            } else {
                console.error('Delete account error:', error);
                window.handleFirebaseError && window.handleFirebaseError(error, 'DataManagementModal.handleDeleteAccount');
                alert('Failed to delete account: ' + error.message);
            }
        }
    };

    React.useEffect(() => {
        window.lucide?.createIcons();
    }, []);

    return (
        <>
            {/* STEP 1.16: HEADER */}
            <div style={{
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                padding: '24px',
                borderBottom: '1px solid #e5e7eb'
            }}>
                <h2 style={{
                    fontSize: '24px',
                    fontWeight: '700',
                    color: '#111827',
                    margin: 0,
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px'
                }}>
                    <i data-lucide="file-text" style={{width: '28px', height: '28px', color: '#6b7280'}}></i>
                    Data & Account Management
                </h2>
                <button
                    onClick={onClose}
                    style={{
                        background: 'none',
                        border: 'none',
                        cursor: 'pointer',
                        padding: '8px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        borderRadius: '8px',
                        transition: 'all 0.2s'
                    }}
                >
                    <i data-lucide="x" style={{width: '24px', height: '24px', color: '#6b7280'}}></i>
                </button>
            </div>

            {/* STEP 1.16: BODY */}
            <div style={{
                padding: '24px',
                overflowY: 'auto',
                maxHeight: 'calc(90vh - 160px)'
            }}>
                {/* Data Export Section */}
                <div style={{marginBottom: '32px'}}>
                    <h3 style={{
                        fontSize: '16px',
                        fontWeight: '600',
                        color: '#374151',
                        marginBottom: '16px',
                        paddingBottom: '8px',
                        borderBottom: '2px solid #e5e7eb'
                    }}>
                        Export Your Data
                    </h3>
                    <p style={{fontSize: '14px', color: '#6b7280', marginBottom: '16px', lineHeight: '1.6'}}>
                        Download all your recovery data in JSON format (GDPR compliant). Includes check-ins, goals, messages, and more.
                    </p>

                    <div style={{marginBottom: '16px'}}>
                        <label style={{
                            display: 'block',
                            fontSize: '14px',
                            fontWeight: '600',
                            color: '#374151',
                            marginBottom: '8px'
                        }}>
                            Time Period
                        </label>
                        <select
                            value={dateRange}
                            onChange={(e) => setDateRange(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '12px',
                                fontSize: '15px',
                                border: '1px solid #d1d5db',
                                borderRadius: '8px',
                                background: '#fff',
                                color: '#111827',
                                outline: 'none',
                                transition: 'border-color 0.2s'
                            }}
                            onFocus={(e) => e.target.style.borderColor = '#058585'}
                            onBlur={(e) => e.target.style.borderColor = '#d1d5db'}
                        >
                            <option value="all">All Time</option>
                            <option value="30days">Last 30 Days</option>
                            <option value="90days">Last 90 Days</option>
                        </select>
                    </div>

                    <button
                        onClick={exportUserData}
                        disabled={exporting}
                        style={{
                            width: '100%',
                            padding: '12px 24px',
                            fontSize: '15px',
                            fontWeight: '600',
                            color: '#fff',
                            background: exporting ? '#6b7280' : '#058585',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: exporting ? 'not-allowed' : 'pointer',
                            transition: 'all 0.2s',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            gap: '8px'
                        }}
                    >
                        <i data-lucide="download" style={{width: '18px', height: '18px'}}></i>
                        {exporting ? 'Exporting Data...' : 'Export All Data (JSON)'}
                    </button>
                </div>

                {/* Cache Management Section */}
                <div style={{marginBottom: '32px'}}>
                    <h3 style={{
                        fontSize: '16px',
                        fontWeight: '600',
                        color: '#374151',
                        marginBottom: '16px',
                        paddingBottom: '8px',
                        borderBottom: '2px solid #e5e7eb'
                    }}>
                        Clear Cache
                    </h3>
                    <p style={{fontSize: '14px', color: '#6b7280', marginBottom: '16px', lineHeight: '1.6'}}>
                        Clear all locally stored data and reload the app. Use this if the app is behaving unexpectedly or showing outdated information.
                    </p>

                    <button
                        onClick={handleClearCache}
                        style={{
                            width: '100%',
                            padding: '12px 24px',
                            fontSize: '15px',
                            fontWeight: '600',
                            color: '#374151',
                            background: '#fff',
                            border: '1px solid #d1d5db',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            transition: 'all 0.2s',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            gap: '8px'
                        }}
                    >
                        <i data-lucide="refresh-cw" style={{width: '18px', height: '18px'}}></i>
                        Clear Cache & Reload
                    </button>
                </div>

                {/* Account Management Section */}
                <div style={{marginBottom: '32px'}}>
                    <h3 style={{
                        fontSize: '16px',
                        fontWeight: '600',
                        color: '#374151',
                        marginBottom: '16px',
                        paddingBottom: '8px',
                        borderBottom: '2px solid #e5e7eb'
                    }}>
                        Account Security
                    </h3>

                    <button
                        onClick={() => setShowPasswordModal(true)}
                        style={{
                            width: '100%',
                            padding: '12px 24px',
                            fontSize: '15px',
                            fontWeight: '600',
                            color: '#374151',
                            background: '#fff',
                            border: '1px solid #d1d5db',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            transition: 'all 0.2s',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            gap: '8px'
                        }}
                    >
                        <i data-lucide="lock" style={{width: '18px', height: '18px'}}></i>
                        Change Password
                    </button>
                </div>

                {/* Danger Zone */}
                <div style={{
                    background: 'rgba(220, 38, 38, 0.1)',
                    border: '1px solid rgba(220, 38, 38, 0.3)',
                    borderRadius: '12px',
                    padding: '20px'
                }}>
                    <h3 style={{
                        fontSize: '16px',
                        fontWeight: '600',
                        color: '#dc2626',
                        marginBottom: '12px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                    }}>
                        <i data-lucide="alert-triangle" style={{width: '18px', height: '18px'}}></i>
                        Danger Zone
                    </h3>
                    <p style={{fontSize: '14px', color: '#6b7280', marginBottom: '16px', lineHeight: '1.6'}}>
                        Permanently delete your account and all associated data. This action cannot be undone. Your recovery progress, messages, and goals will be lost forever.
                    </p>
                    <button
                        onClick={handleDeleteAccount}
                        style={{
                            width: '100%',
                            padding: '12px 24px',
                            fontSize: '15px',
                            fontWeight: '600',
                            background: '#dc2626',
                            color: '#fff',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            transition: 'all 0.2s',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            gap: '8px'
                        }}
                    >
                        <i data-lucide="trash-2" style={{width: '18px', height: '18px'}}></i>
                        Delete Account Permanently
                    </button>
                </div>
            </div>

            {/* STEP 1.16: FOOTER */}
            {/* STEP 1.23: Responsive gap (8px mobile, 12px desktop) */}
            <div style={{
                display: 'flex',
                gap: isMobile ? '8px' : '12px',
                justifyContent: 'flex-end',
                padding: '20px 24px',
                borderTop: '1px solid #e5e7eb',
                background: '#f9fafb'
            }}>
                <button
                    onClick={onClose}
                    style={{
                        padding: '12px 24px',
                        fontSize: '15px',
                        fontWeight: '600',
                        color: '#6b7280',
                        background: '#fff',
                        border: '1px solid #d1d5db',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        transition: 'all 0.2s'
                    }}
                >
                    Close
                </button>
            </div>

            {/* Password Change Modal (nested) */}
            {showPasswordModal && (
                <PasswordChangeModal
                    user={user}
                    onClose={() => setShowPasswordModal(false)}
                />
            )}
        </>
    );
}

/** PasswordChangeModal - Change account password */
function PasswordChangeModal({ user, onClose }) {
    const [passwords, setPasswords] = React.useState({
        current: '',
        new: '',
        confirm: ''
    });
    const [error, setError] = React.useState('');
    const [loading, setLoading] = React.useState(false);

    const handleChangePassword = async () => {
        // Validation
        if (!passwords.current || !passwords.new || !passwords.confirm) {
            setError('All fields are required');
            return;
        }
        if (passwords.new !== passwords.confirm) {
            setError('New passwords do not match');
            return;
        }
        if (passwords.new.length < 8) {
            setError('Password must be at least 8 characters');
            return;
        }

        setLoading(true);
        setError('');

        try {
            const credential = firebase.auth.EmailAuthProvider.credential(
                user.email,
                passwords.current
            );

            // Re-authenticate user
            await user.reauthenticateWithCredential(credential);

            // Update password
            await user.updatePassword(passwords.new);

            alert('Password updated successfully');
            onClose();
        } catch (error) {
            if (error.code === 'auth/wrong-password') {
                setError('Current password is incorrect');
            } else {
                console.error('Password change error:', error);
                window.handleFirebaseError && window.handleFirebaseError(error, 'PasswordChangeModal.handleChangePassword');
                setError('Failed to update password: ' + error.message);
            }
        } finally {
            setLoading(false);
        }
    };

    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0,0,0,0.7)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 10000
        }} onClick={onClose}>
            <div style={{
                background: '#1a1a2e',
                borderRadius: '12px',
                padding: '24px',
                maxWidth: '500px',
                width: '90%',
                maxHeight: '90vh',
                overflow: 'auto'
            }} onClick={(e) => e.stopPropagation()}>
                <h3 style={{marginBottom: '20px', display: 'flex', alignItems: 'center', gap: '10px'}}>
                    <i data-lucide="lock" style={{width: '24px', height: '24px', color: '#6b7280'}}></i>
                    Change Password
                </h3>

                {error && (
                    <div style={{
                        background: 'rgba(220, 38, 38, 0.1)',
                        border: '1px solid rgba(220, 38, 38, 0.3)',
                        padding: '12px',
                        borderRadius: '8px',
                        color: '#dc2626',
                        marginBottom: '16px',
                        fontSize: '13px'
                    }}>
                        {error}
                    </div>
                )}

                <div className="form-group" style={{marginBottom: '16px'}}>
                    <label className="form-label">Current Password</label>
                    <input
                        type="password"
                        className="form-input"
                        value={passwords.current}
                        onChange={(e) => setPasswords({...passwords, current: e.target.value})}
                        placeholder="Enter current password"
                    />
                </div>

                <div className="form-group" style={{marginBottom: '16px'}}>
                    <label className="form-label">New Password</label>
                    <input
                        type="password"
                        className="form-input"
                        value={passwords.new}
                        onChange={(e) => setPasswords({...passwords, new: e.target.value})}
                        placeholder="Enter new password (min 8 characters)"
                    />
                </div>

                <div className="form-group" style={{marginBottom: '20px'}}>
                    <label className="form-label">Confirm New Password</label>
                    <input
                        type="password"
                        className="form-input"
                        value={passwords.confirm}
                        onChange={(e) => setPasswords({...passwords, confirm: e.target.value})}
                        placeholder="Re-enter new password"
                    />
                </div>

                <div style={{display: 'flex', gap: '12px'}}>
                    <button
                        className="btn-primary"
                        onClick={handleChangePassword}
                        disabled={loading}
                        style={{flex: 1}}
                    >
                        {loading ? 'Updating...' : 'Update Password'}
                    </button>
                    <button
                        className="btn-secondary"
                        onClick={onClose}
                        style={{flex: 1}}
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    );
}

/** GoogleCalendarModal - Google Calendar OAuth integration */
/** GoogleCalendarModal - Google Calendar integration with OAuth and sync settings */
function GoogleCalendarModal({ userData, user, onClose }) {
    // STEP 1.14: OAuth state (preserve existing functionality)
    const [connecting, setConnecting] = React.useState(false);
    const [disconnecting, setDisconnecting] = React.useState(false);
    const [error, setError] = React.useState('');

    const isConnected = userData?.googleCalendar?.connected || false;
    const connectedAt = userData?.googleCalendar?.connectedAt;

    // STEP 1.14: Settings form state
    const [formData, setFormData] = React.useState({
        timezone: userData?.timezone || 'America/Los_Angeles',
        dateFormat: userData?.dateFormat || 'MM/DD/YYYY',
        timeFormat: userData?.timeFormat || '12h',
        autoRefresh: userData?.autoRefresh || 60,
        syncMilestones: userData?.syncMilestones !== false,
        syncMeetings: userData?.syncMeetings !== false,
        syncAssignments: userData?.syncAssignments !== false
    });
    const [saving, setSaving] = React.useState(false);

    // STEP 1.23: Mobile detection for responsive layout
    const [isMobile, setIsMobile] = React.useState(window.innerWidth < 768);

    React.useEffect(() => {
        const handleResize = () => setIsMobile(window.innerWidth < 768);
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
    }, []);

    // STEP 1.14: OAuth connect handler (preserve existing)
    const handleConnectCalendar = async () => {
        // Safety check: Ensure user is available
        if (!user || !user.uid) {
            console.error('User not available for OAuth flow');
            setError('Authentication error. Please refresh the page and try again.');
            return;
        }

        setConnecting(true);
        setError('');

        try {
            const scopes = [
                'https://www.googleapis.com/auth/calendar',
                'https://www.googleapis.com/auth/calendar.events'
            ].join(' ');

            const redirectUri = window.location.origin + '/oauth-callback';
            // STEP 1.24: Updated OAuth credentials (November 22, 2025)
            const clientId = '830378577655-ms2vopfhcr5ld21hlv318ov8r22pq224.apps.googleusercontent.com';

            const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                `client_id=${clientId}&` +
                `redirect_uri=${encodeURIComponent(redirectUri)}&` +
                `response_type=code&` +
                `scope=${encodeURIComponent(scopes)}&` +
                `access_type=offline&` +
                `prompt=consent&` +
                `state=${user.uid}`;

            window.location.href = authUrl;
        } catch (error) {
            console.error('Failed to initiate OAuth:', error);
            setError('Failed to connect to Google Calendar: ' + error.message);
            setConnecting(false);
        }
    };

    // STEP 1.14: OAuth disconnect handler (preserve existing)
    const handleDisconnectCalendar = async () => {
        // Safety check: Ensure user is available
        if (!user || !user.uid) {
            console.error('User not available for disconnect');
            setError('Authentication error. Please refresh the page and try again.');
            return;
        }

        if (!confirm('Are you sure you want to disconnect Google Calendar? Your calendar events will no longer sync.')) {
            return;
        }

        setDisconnecting(true);
        setError('');

        try {
            await db.collection('users').doc(user.uid).update({
                'googleCalendar.connected': false,
                'googleCalendar.disconnectedAt': firebase.firestore.FieldValue.serverTimestamp(),
                'googleCalendar.accessToken': firebase.firestore.FieldValue.delete(),
                'googleCalendar.refreshToken': firebase.firestore.FieldValue.delete(),
                'googleCalendar.expiresAt': firebase.firestore.FieldValue.delete()
            });

            window.showNotification('Google Calendar disconnected successfully', 'success');
            onClose();
        } catch (error) {
            console.error('Failed to disconnect calendar:', error);
            setError('Failed to disconnect: ' + error.message);
        } finally {
            setDisconnecting(false);
        }
    };

    // STEP 1.14: Save settings handler
    const handleSave = async () => {
        // Safety check: Ensure user is available
        if (!user || !user.uid) {
            console.error('User not available for save');
            alert('Authentication error. Please refresh the page and try again.');
            return;
        }

        setSaving(true);
        try {
            await db.collection('users').doc(user.uid).update({
                timezone: formData.timezone,
                dateFormat: formData.dateFormat,
                timeFormat: formData.timeFormat,
                autoRefresh: parseInt(formData.autoRefresh),
                syncMilestones: formData.syncMilestones,
                syncMeetings: formData.syncMeetings,
                syncAssignments: formData.syncAssignments
            });
            window.showNotification('Calendar settings updated successfully', 'success');
            onClose();
        } catch (error) {
            console.error('Error saving calendar settings:', error);
            window.handleFirebaseError && window.handleFirebaseError(error, 'GoogleCalendarModal.handleSave');
            alert('Failed to save changes. Please try again.');
        } finally {
            setSaving(false);
        }
    };

    React.useEffect(() => {
        window.lucide?.createIcons();
    }, []);

    return (
        <>
            {/* STEP 1.14: HEADER */}
            <div style={{
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                padding: '24px',
                borderBottom: '1px solid #e5e7eb'
            }}>
                <h2 style={{
                    fontSize: '24px',
                    fontWeight: '700',
                    color: '#111827',
                    margin: 0,
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px'
                }}>
                    <i data-lucide="calendar" style={{width: '28px', height: '28px', color: '#2196F3'}}></i>
                    Google Calendar Integration
                </h2>
                <button
                    onClick={onClose}
                    style={{
                        background: 'none',
                        border: 'none',
                        cursor: 'pointer',
                        padding: '8px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        borderRadius: '8px',
                        transition: 'all 0.2s'
                    }}
                >
                    <i data-lucide="x" style={{width: '24px', height: '24px', color: '#6b7280'}}></i>
                </button>
            </div>

            {/* STEP 1.14: BODY */}
            <div style={{
                padding: '24px',
                overflowY: 'auto',
                maxHeight: 'calc(90vh - 160px)'
            }}>
                {/* Error Message */}
                {error && (
                    <div style={{
                        background: 'rgba(220, 38, 38, 0.1)',
                        border: '1px solid rgba(220, 38, 38, 0.3)',
                        borderRadius: '8px',
                        padding: '12px',
                        marginBottom: '20px',
                        color: '#dc2626',
                        fontSize: '14px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                    }}>
                        <i data-lucide="alert-circle" style={{width: '16px', height: '16px'}}></i>
                        {error}
                    </div>
                )}

                {/* Connection Status */}
                {isConnected ? (
                    <div style={{
                        background: 'rgba(34, 197, 94, 0.1)',
                        border: '1px solid rgba(34, 197, 94, 0.3)',
                        borderRadius: '12px',
                        padding: '20px',
                        marginBottom: '24px'
                    }}>
                        <div style={{display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '10px'}}>
                            <i data-lucide="check-circle" style={{width: '20px', height: '20px', color: '#22c55e'}}></i>
                            <span style={{fontSize: '16px', fontWeight: '600', color: '#22c55e'}}>Connected</span>
                        </div>
                        <div style={{fontSize: '14px', color: '#374151', lineHeight: '1.5'}}>
                            Your Google Calendar is connected. Recovery milestones and GLRS meetings will automatically sync to your calendar.
                        </div>
                        {connectedAt && (
                            <div style={{fontSize: '13px', color: '#6b7280', marginTop: '10px'}}>
                                Connected on {new Date(connectedAt.seconds * 1000).toLocaleDateString()}
                            </div>
                        )}
                    </div>
                ) : (
                    <div style={{
                        background: 'rgba(107, 114, 128, 0.1)',
                        border: '1px dashed rgba(107, 114, 128, 0.3)',
                        borderRadius: '12px',
                        padding: '24px',
                        marginBottom: '24px',
                        textAlign: 'center'
                    }}>
                        <div style={{marginBottom: '15px'}}>
                            <i data-lucide="calendar-off" style={{width: '48px', height: '48px', color: '#6b7280'}}></i>
                        </div>
                        <div style={{fontSize: '16px', fontWeight: '600', color: '#374151', marginBottom: '8px'}}>
                            Not Connected
                        </div>
                        <div style={{fontSize: '14px', color: '#6b7280', lineHeight: '1.5'}}>
                            Connect your Google Calendar to automatically sync recovery milestones and GLRS meetings.
                        </div>
                    </div>
                )}

                {/* Timezone Settings */}
                <div style={{marginBottom: '24px'}}>
                    <label style={{
                        display: 'block',
                        fontSize: '14px',
                        fontWeight: '600',
                        color: '#374151',
                        marginBottom: '8px'
                    }}>
                        Timezone
                    </label>
                    <select
                        value={formData.timezone}
                        onChange={(e) => setFormData({...formData, timezone: e.target.value})}
                        style={{
                            width: '100%',
                            padding: '12px',
                            fontSize: '15px',
                            border: '1px solid #d1d5db',
                            borderRadius: '8px',
                            background: '#fff',
                            color: '#111827',
                            outline: 'none',
                            transition: 'border-color 0.2s'
                        }}
                        onFocus={(e) => e.target.style.borderColor = '#058585'}
                        onBlur={(e) => e.target.style.borderColor = '#d1d5db'}
                    >
                        <option value="America/Los_Angeles">Pacific Time (PT)</option>
                        <option value="America/Denver">Mountain Time (MT)</option>
                        <option value="America/Chicago">Central Time (CT)</option>
                        <option value="America/New_York">Eastern Time (ET)</option>
                        <option value="America/Phoenix">Arizona (MST - No DST)</option>
                        <option value="America/Anchorage">Alaska Time (AKT)</option>
                        <option value="Pacific/Honolulu">Hawaii Time (HST)</option>
                    </select>
                    <div style={{fontSize: '13px', color: '#6b7280', marginTop: '6px'}}>
                        Calendar events will use this timezone
                    </div>
                </div>

                {/* Display Settings */}
                <div style={{
                    display: 'grid',
                    gridTemplateColumns: '1fr 1fr',
                    gap: '16px',
                    marginBottom: '24px'
                }}>
                    <div>
                        <label style={{
                            display: 'block',
                            fontSize: '14px',
                            fontWeight: '600',
                            color: '#374151',
                            marginBottom: '8px'
                        }}>
                            Date Format
                        </label>
                        <select
                            value={formData.dateFormat}
                            onChange={(e) => setFormData({...formData, dateFormat: e.target.value})}
                            style={{
                                width: '100%',
                                padding: '12px',
                                fontSize: '15px',
                                border: '1px solid #d1d5db',
                                borderRadius: '8px',
                                background: '#fff',
                                color: '#111827',
                                outline: 'none',
                                transition: 'border-color 0.2s'
                            }}
                            onFocus={(e) => e.target.style.borderColor = '#058585'}
                            onBlur={(e) => e.target.style.borderColor = '#d1d5db'}
                        >
                            <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                            <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                            <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                        </select>
                    </div>

                    <div>
                        <label style={{
                            display: 'block',
                            fontSize: '14px',
                            fontWeight: '600',
                            color: '#374151',
                            marginBottom: '8px'
                        }}>
                            Time Format
                        </label>
                        <select
                            value={formData.timeFormat}
                            onChange={(e) => setFormData({...formData, timeFormat: e.target.value})}
                            style={{
                                width: '100%',
                                padding: '12px',
                                fontSize: '15px',
                                border: '1px solid #d1d5db',
                                borderRadius: '8px',
                                background: '#fff',
                                color: '#111827',
                                outline: 'none',
                                transition: 'border-color 0.2s'
                            }}
                            onFocus={(e) => e.target.style.borderColor = '#058585'}
                            onBlur={(e) => e.target.style.borderColor = '#d1d5db'}
                        >
                            <option value="12h">12-hour (AM/PM)</option>
                            <option value="24h">24-hour (Military)</option>
                        </select>
                    </div>
                </div>

                {/* Auto-refresh Interval */}
                <div style={{marginBottom: '24px'}}>
                    <label style={{
                        display: 'block',
                        fontSize: '14px',
                        fontWeight: '600',
                        color: '#374151',
                        marginBottom: '8px'
                    }}>
                        Auto-refresh Interval
                    </label>
                    <select
                        value={formData.autoRefresh}
                        onChange={(e) => setFormData({...formData, autoRefresh: e.target.value})}
                        style={{
                            width: '100%',
                            padding: '12px',
                            fontSize: '15px',
                            border: '1px solid #d1d5db',
                            borderRadius: '8px',
                            background: '#fff',
                            color: '#111827',
                            outline: 'none',
                            transition: 'border-color 0.2s'
                        }}
                        onFocus={(e) => e.target.style.borderColor = '#058585'}
                        onBlur={(e) => e.target.style.borderColor = '#d1d5db'}
                    >
                        <option value="15">Every 15 minutes</option>
                        <option value="30">Every 30 minutes</option>
                        <option value="60">Every hour</option>
                        <option value="120">Every 2 hours</option>
                        <option value="240">Every 4 hours</option>
                    </select>
                    <div style={{fontSize: '13px', color: '#6b7280', marginTop: '6px'}}>
                        How often to check for calendar updates
                    </div>
                </div>

                {/* Sync Settings (only show when connected) */}
                {isConnected && (
                    <div style={{
                        background: '#f9fafb',
                        borderRadius: '12px',
                        padding: '20px',
                        marginBottom: '24px'
                    }}>
                        <h3 style={{
                            fontSize: '16px',
                            fontWeight: '600',
                            color: '#374151',
                            marginBottom: '16px',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px'
                        }}>
                            <i data-lucide="refresh-cw" style={{width: '18px', height: '18px', color: '#058585'}}></i>
                            Sync Preferences
                        </h3>

                        <label style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '12px',
                            marginBottom: '12px',
                            cursor: 'pointer'
                        }}>
                            <input
                                type="checkbox"
                                checked={formData.syncMilestones}
                                onChange={(e) => setFormData({...formData, syncMilestones: e.target.checked})}
                                style={{
                                    width: '18px',
                                    height: '18px',
                                    accentColor: '#058585',
                                    cursor: 'pointer'
                                }}
                            />
                            <span style={{fontSize: '15px', color: '#374151'}}>
                                Sync recovery milestones (7, 30, 60, 90+ days)
                            </span>
                        </label>

                        <label style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '12px',
                            marginBottom: '12px',
                            cursor: 'pointer'
                        }}>
                            <input
                                type="checkbox"
                                checked={formData.syncMeetings}
                                onChange={(e) => setFormData({...formData, syncMeetings: e.target.checked})}
                                style={{
                                    width: '18px',
                                    height: '18px',
                                    accentColor: '#058585',
                                    cursor: 'pointer'
                                }}
                            />
                            <span style={{fontSize: '15px', color: '#374151'}}>
                                Sync GLRS coaching meetings
                            </span>
                        </label>

                        <label style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '12px',
                            cursor: 'pointer'
                        }}>
                            <input
                                type="checkbox"
                                checked={formData.syncAssignments}
                                onChange={(e) => setFormData({...formData, syncAssignments: e.target.checked})}
                                style={{
                                    width: '18px',
                                    height: '18px',
                                    accentColor: '#058585',
                                    cursor: 'pointer'
                                }}
                            />
                            <span style={{fontSize: '15px', color: '#374151'}}>
                                Sync coach assignments with due dates
                            </span>
                        </label>
                    </div>
                )}

                {/* Features Info */}
                <div style={{
                    background: 'rgba(33, 150, 243, 0.1)',
                    border: '1px solid rgba(33, 150, 243, 0.3)',
                    borderRadius: '12px',
                    padding: '20px'
                }}>
                    <h4 style={{
                        color: '#2196F3',
                        marginBottom: '12px',
                        fontSize: '16px',
                        fontWeight: '600',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                    }}>
                        <i data-lucide="sparkles" style={{width: '18px', height: '18px'}}></i>
                        What Gets Synced
                    </h4>
                    <ul style={{
                        fontSize: '14px',
                        color: '#374151',
                        paddingLeft: '20px',
                        margin: '0',
                        lineHeight: '1.8'
                    }}>
                        <li>Recovery milestones (7, 30, 60, 90, 180, 365+ days) as all-day events</li>
                        <li>GLRS coaching meetings with your assigned coach</li>
                        <li>Automatic updates when meetings are rescheduled</li>
                        <li>Events use your selected timezone</li>
                    </ul>
                </div>
            </div>

            {/* STEP 1.14: FOOTER */}
            {/* STEP 1.23: Responsive gap (8px mobile, 12px desktop) */}
            <div style={{
                display: 'flex',
                gap: isMobile ? '8px' : '12px',
                justifyContent: 'flex-end',
                padding: '20px 24px',
                borderTop: '1px solid #e5e7eb',
                background: '#f9fafb'
            }}>
                <button
                    onClick={onClose}
                    style={{
                        padding: '12px 24px',
                        fontSize: '15px',
                        fontWeight: '600',
                        color: '#6b7280',
                        background: '#fff',
                        border: '1px solid #d1d5db',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        transition: 'all 0.2s'
                    }}
                >
                    Cancel
                </button>

                {isConnected ? (
                    <>
                        <button
                            onClick={handleDisconnectCalendar}
                            disabled={disconnecting}
                            style={{
                                padding: '12px 24px',
                                fontSize: '15px',
                                fontWeight: '600',
                                color: '#dc2626',
                                background: 'rgba(220, 38, 38, 0.1)',
                                border: '1px solid rgba(220, 38, 38, 0.3)',
                                borderRadius: '8px',
                                cursor: disconnecting ? 'not-allowed' : 'pointer',
                                opacity: disconnecting ? 0.6 : 1,
                                transition: 'all 0.2s',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                            }}
                        >
                            <i data-lucide="x-circle" style={{width: '16px', height: '16px'}}></i>
                            {disconnecting ? 'Disconnecting...' : 'Disconnect'}
                        </button>
                        <button
                            onClick={handleSave}
                            disabled={saving}
                            style={{
                                padding: '12px 24px',
                                fontSize: '15px',
                                fontWeight: '600',
                                color: '#fff',
                                background: saving ? '#6b7280' : '#058585',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: saving ? 'not-allowed' : 'pointer',
                                transition: 'all 0.2s'
                            }}
                        >
                            {saving ? 'Saving...' : 'Save Changes'}
                        </button>
                    </>
                ) : (
                    <button
                        onClick={handleConnectCalendar}
                        disabled={connecting}
                        style={{
                            padding: '12px 24px',
                            fontSize: '15px',
                            fontWeight: '600',
                            color: '#fff',
                            background: connecting ? '#6b7280' : 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: connecting ? 'not-allowed' : 'pointer',
                            transition: 'all 0.2s',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px'
                        }}
                    >
                        <i data-lucide="link" style={{width: '16px', height: '16px'}}></i>
                        {connecting ? 'Connecting...' : 'Connect Google Calendar'}
                    </button>
                )}
            </div>
        </>
    );
}

/** HelpModal - Help & support with crisis lines, contact info, FAQs */
function HelpModal({ onClose }) {
    return (
        <div>
            <h3 style={{marginBottom: '20px'}}>Help & Support</h3>

            <div style={{
                background: 'rgba(244, 196, 48, 0.1)',
                border: '1px solid rgba(244, 196, 48, 0.3)',
                borderRadius: '10px',
                padding: '15px',
                marginBottom: '20px'
            }}>
                <h4 style={{color: '#f4c430', marginBottom: '10px'}}>Need Immediate Help?</h4>
                <div style={{marginBottom: '10px'}}>
                    <strong>Crisis Line:</strong> <a href="tel:988" style={{color: '#f4c430'}}>988</a>
                </div>
                <div>
                    <strong>SAMHSA Helpline:</strong> <a href="tel:1-800-662-4357" style={{color: '#f4c430'}}>1-800-662-HELP</a>
                </div>
            </div>

            <h4 style={{marginBottom: '15px'}}>Contact Support</h4>
            <div style={{marginBottom: '15px'}}>
                <strong>Email:</strong> info@glrecoveryservices.com
            </div>
            <div style={{marginBottom: '15px'}}>
                <strong>Phone:</strong> Contact Your Coach
            </div>
            <div style={{marginBottom: '20px'}}>
                <strong>Hours:</strong> Monday - Friday, 9am - 5pm PST
            </div>

            <h4 style={{marginBottom: '15px'}}>Frequently Asked Questions</h4>
            <div style={{display: 'flex', flexDirection: 'column', gap: '15px'}}>
                <details style={{cursor: 'pointer'}}>
                    <summary style={{fontWeight: 'bold', marginBottom: '5px'}}>How do I complete a check-in?</summary>
                    <p style={{fontSize: '14px', opacity: 0.8, paddingLeft: '15px'}}>
                        Navigate to the Tasks tab and tap on Morning Check-in or Evening Reflection.
                    </p>
                </details>
                <details style={{cursor: 'pointer'}}>
                    <summary style={{fontWeight: 'bold', marginBottom: '5px'}}>How do I contact my coach?</summary>
                    <p style={{fontSize: '14px', opacity: 0.8, paddingLeft: '15px'}}>
                        Your coach's contact information is displayed in your profile. You can call or message them directly.
                    </p>
                </details>
                <details style={{cursor: 'pointer'}}>
                    <summary style={{fontWeight: 'bold', marginBottom: '5px'}}>What if I miss a check-in?</summary>
                    <p style={{fontSize: '14px', opacity: 0.8, paddingLeft: '15px'}}>
                        Missing occasional check-ins is okay. Focus on building consistency over time. Your coach will be notified of patterns.
                    </p>
                </details>
            </div>

            <button className="btn-primary" style={{marginTop: '20px'}} onClick={onClose}>
                Close
            </button>
        </div>
    );
}

/** FeedbackModal - Submit feedback (bug report, feature request, praise, concern) */
function FeedbackModal({ userData, user, onClose, onSubmit }) {
    const [formData, setFormData] = React.useState({});

    // STEP 1.23: Mobile detection for responsive layout
    const [isMobile, setIsMobile] = React.useState(window.innerWidth < 768);

    React.useEffect(() => {
        const handleResize = () => setIsMobile(window.innerWidth < 768);
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
    }, []);

    return (
        <div>
            <h3 style={{marginBottom: '20px'}}>Send Feedback</h3>
            <p style={{fontSize: '14px', opacity: 0.8, marginBottom: '20px'}}>
                Your feedback helps us improve the recovery experience for everyone.
            </p>
            <div className="form-group">
                <label className="form-label">Feedback Type</label>
                <select
                    className="form-select"
                    value={formData.feedbackType || ''}
                    onChange={(e) => setFormData({...formData, feedbackType: e.target.value})}
                >
                    <option value="">Select Type</option>
                    <option value="bug">Bug Report</option>
                    <option value="feature">Feature Request</option>
                    <option value="praise">Positive Feedback</option>
                    <option value="concern">Concern</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div className="form-group">
                <label className="form-label">Your Feedback</label>
                <textarea
                    className="textarea"
                    placeholder="Tell us what's on your mind..."
                    value={formData.feedbackText || ''}
                    onChange={(e) => setFormData({...formData, feedbackText: e.target.value})}
                    style={{minHeight: '150px'}}
                />
            </div>
            <button
                className="btn-primary"
                onClick={async () => {
                    if (!formData.feedbackType || !formData.feedbackText) {
                        alert('Please select a type and enter feedback');
                        return;
                    }
                    try {
                        await onSubmit({
                            userId: user.uid,
                            userName: userData?.displayName || userData?.firstName || 'Anonymous',
                            type: formData.feedbackType,
                            message: formData.feedbackText
                        });
                        alert('Thank you for your feedback!');
                        onClose();
                    } catch (error) {
                        console.error('Error submitting feedback:', error);
                        window.handleFirebaseError && window.handleFirebaseError(error, 'FeedbackModal.handleSubmit');
                        alert('Failed to send feedback');
                    }
                }}
            >
                Send Feedback
            </button>
        </div>
    );
}

/** ExportModal - Export user data as JSON or PDF */
function ExportModal({ onClose }) {
    return (
        <div>
            <h3 style={{marginBottom: '20px'}}>Export Your Data</h3>
            <p style={{fontSize: '14px', opacity: 0.8, marginBottom: '20px'}}>
                Download all your recovery data in your preferred format.
            </p>
            <div style={{display: 'flex', flexDirection: 'column', gap: '10px'}}>
                <button
                    className="btn-primary"
                    onClick={() => {
                        window.triggerHaptic && window.triggerHaptic('light');
                        window.GLRSApp.handlers.exportDataAsJSON();
                    }}
                    style={{display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px'}}
                >
                    <i data-lucide="download" style={{width: '18px', height: '18px'}}></i>
                    Export as JSON (Technical Format)
                </button>
                <button
                    className="btn-primary"
                    onClick={() => {
                        window.triggerHaptic && window.triggerHaptic('light');
                        window.GLRSApp.handlers.exportDataAsPDF();
                    }}
                    style={{display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px'}}
                >
                    <i data-lucide="file-text" style={{width: '18px', height: '18px'}}></i>
                    Export as PDF (Report Format)
                </button>
            </div>
            <small style={{display: 'block', marginTop: '20px', opacity: 0.6}}>
                Your export will include all check-ins, goals, assignments, and progress data.
            </small>
        </div>
    );
}

/** DeleteAccountModal - Delete account with confirmation and warning */
function DeleteAccountModal({ user, onClose, onDelete }) {
    const [formData, setFormData] = React.useState({});

    return (
        <div>
            <h3 style={{marginBottom: '20px', color: '#ff4757'}}>Delete Account</h3>
            <div style={{
                background: 'rgba(255, 71, 87, 0.1)',
                border: '1px solid rgba(255, 71, 87, 0.3)',
                borderRadius: '10px',
                padding: '15px',
                marginBottom: '20px'
            }}>
                <strong style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                    <i data-lucide="alert-triangle" style={{width: '18px', height: '18px', color: '#ff4757'}}></i>
                    This action cannot be undone!
                </strong>
                <p style={{marginTop: '10px', fontSize: '14px'}}>
                    Deleting your account will permanently remove:
                </p>
                <ul style={{fontSize: '14px', marginTop: '10px', paddingLeft: '20px'}}>
                    <li>All your check-ins and progress data</li>
                    <li>Goals and assignments</li>
                    <li>Messages and community posts</li>
                    <li>Your profile and settings</li>
                </ul>
            </div>
            <div className="form-group">
                <label className="form-label">Type "DELETE" to confirm:</label>
                <input
                    type="text"
                    className="form-input"
                    placeholder="Type DELETE"
                    value={formData.deleteConfirm || ''}
                    onChange={(e) => setFormData({...formData, deleteConfirm: e.target.value})}
                />
            </div>
            <button
                className="btn-danger"
                disabled={formData.deleteConfirm !== 'DELETE'}
                onClick={async () => {
                    if (confirm('Are you absolutely sure? This cannot be undone.')) {
                        try {
                            await onDelete(user.uid);
                            alert('Account deleted. We wish you the best in your recovery journey.');
                        } catch (error) {
                            console.error('Error deleting account:', error);
                            window.handleFirebaseError && window.handleFirebaseError(error, 'DeleteAccountModal.handleDelete');
                            alert('Failed to delete account. You may need to sign in again.');
                        }
                    }
                }}
            >
                Permanently Delete Account
            </button>
            <button
                style={{
                    width: '100%',
                    padding: '14px',
                    background: 'transparent',
                    border: '1px solid rgba(255,255,255,0.3)',
                    borderRadius: '10px',
                    color: 'white',
                    cursor: 'pointer',
                    marginTop: '10px'
                }}
                onClick={onClose}
            >
                Cancel
            </button>
        </div>
    );
}

/** ProfileVisibilityModal - Configure what others see in your profile (PHASE 5) */
function ProfileVisibilityModal({ userData, user, onClose, onUpdate }) {
    // Get existing visibility settings or use defaults (all true)
    const existingVisibility = userData?.profileVisibility || {
        memberSince: true,
        sobrietyDate: true,
        recoveryGoals: true,
        completedGoals: true,
        timezone: true
    };

    const [formData, setFormData] = React.useState(existingVisibility);

    return (
        <div>
            <h3 style={{marginBottom: '20px'}}>Profile Visibility</h3>
            <p style={{fontSize: '14px', opacity: 0.8, marginBottom: '20px'}}>
                Control what other users can see when they view your profile.
                <strong style={{display: 'block', marginTop: '8px', color: '#f4c430'}}>
                    Note: Coaches and administrators can always see all fields.
                </strong>
            </p>

            <div style={{display: 'flex', flexDirection: 'column', gap: '15px'}}>
                <label style={{
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                    padding: '12px',
                    background: 'rgba(255,255,255,0.05)',
                    borderRadius: '10px',
                    cursor: 'pointer'
                }}>
                    <div style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                        <span style={{fontSize: '20px'}}>📅</span>
                        <span>Member Since Date</span>
                    </div>
                    <input
                        type="checkbox"
                        checked={formData.memberSince !== false}
                        onChange={(e) => setFormData({...formData, memberSince: e.target.checked})}
                        style={{
                            width: '20px',
                            height: '20px',
                            cursor: 'pointer'
                        }}
                    />
                </label>

                <label style={{
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                    padding: '12px',
                    background: 'rgba(255,255,255,0.05)',
                    borderRadius: '10px',
                    cursor: 'pointer'
                }}>
                    <div style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                        <span style={{fontSize: '20px'}}>🎖️</span>
                        <span>Sobriety Date</span>
                    </div>
                    <input
                        type="checkbox"
                        checked={formData.sobrietyDate !== false}
                        onChange={(e) => setFormData({...formData, sobrietyDate: e.target.checked})}
                        style={{
                            width: '20px',
                            height: '20px',
                            cursor: 'pointer'
                        }}
                    />
                </label>

                <label style={{
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                    padding: '12px',
                    background: 'rgba(255,255,255,0.05)',
                    borderRadius: '10px',
                    cursor: 'pointer'
                }}>
                    <div style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                        <span style={{fontSize: '20px'}}>🎯</span>
                        <span>Recovery Goals</span>
                    </div>
                    <input
                        type="checkbox"
                        checked={formData.recoveryGoals !== false}
                        onChange={(e) => setFormData({...formData, recoveryGoals: e.target.checked})}
                        style={{
                            width: '20px',
                            height: '20px',
                            cursor: 'pointer'
                        }}
                    />
                </label>

                <label style={{
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                    padding: '12px',
                    background: 'rgba(255,255,255,0.05)',
                    borderRadius: '10px',
                    cursor: 'pointer'
                }}>
                    <div style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                        <span style={{fontSize: '20px'}}>✅</span>
                        <span>Completed Goals</span>
                    </div>
                    <input
                        type="checkbox"
                        checked={formData.completedGoals !== false}
                        onChange={(e) => setFormData({...formData, completedGoals: e.target.checked})}
                        style={{
                            width: '20px',
                            height: '20px',
                            cursor: 'pointer'
                        }}
                    />
                </label>

                <label style={{
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                    padding: '12px',
                    background: 'rgba(255,255,255,0.05)',
                    borderRadius: '10px',
                    cursor: 'pointer'
                }}>
                    <div style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                        <span style={{fontSize: '20px'}}>🌍</span>
                        <span>Timezone</span>
                    </div>
                    <input
                        type="checkbox"
                        checked={formData.timezone !== false}
                        onChange={(e) => setFormData({...formData, timezone: e.target.checked})}
                        style={{
                            width: '20px',
                            height: '20px',
                            cursor: 'pointer'
                        }}
                    />
                </label>
            </div>

            <button
                className="btn-primary"
                onClick={async () => {
                    try {
                        await onUpdate(formData);
                        alert('Privacy settings updated!');
                        onClose();
                    } catch (error) {
                        console.error('Error updating visibility settings:', error);
                        window.handleFirebaseError && window.handleFirebaseError(error, 'ProfileVisibilityModal.handleSave');
                        alert('Failed to update settings: ' + error.message);
                    }
                }}
                style={{marginTop: '20px'}}
            >
                Save Settings
            </button>
        </div>
    );
}

// Register all components in global namespace
window.GLRSApp = window.GLRSApp || {};
window.GLRSApp.modals = window.GLRSApp.modals || {};
window.GLRSApp.modals.ProfileModals = ProfileModals;

// Register all 12 modal components for consistency
window.GLRSApp.modals.AccountActivityModal = AccountActivityModal;
window.GLRSApp.modals.EmergencyModal = EmergencyModal;
window.GLRSApp.modals.PersonalInfoModal = PersonalInfoModal;
window.GLRSApp.modals.RecoveryInfoModal = RecoveryInfoModal;
window.GLRSApp.modals.PasswordModal = PasswordModal;
window.GLRSApp.modals.NotificationSettingsModal = NotificationSettingsModal;
window.GLRSApp.modals.PrivacySettingsModal = PrivacySettingsModal;
window.GLRSApp.modals.DataManagementModal = DataManagementModal;
window.GLRSApp.modals.PasswordChangeModal = PasswordChangeModal;
window.GLRSApp.modals.ProfileVisibilityModal = ProfileVisibilityModal;
window.GLRSApp.modals.GoogleCalendarModal = GoogleCalendarModal;
window.GLRSApp.modals.HelpModal = HelpModal;
window.GLRSApp.modals.FeedbackModal = FeedbackModal;
window.GLRSApp.modals.ExportModal = ExportModal;
window.GLRSApp.modals.DeleteAccountModal = DeleteAccountModal;

console.log('✅ PHASE 5 & 7: ProfileTab.js complete - All 14 components registered (12 modals + ProfileView + ProfileModals)!');
