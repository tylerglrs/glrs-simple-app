// Destructure React hooks for use in components (updated timestamp: 2025-11-19-05:20)
const { useState, useEffect, useMemo, useCallback, useRef } = React;

/**
 * Image Compression Utility (PHASE 1)
 * @description Compresses images before upload to prevent "file too large" errors
 * @param {File} file - Image file to compress
 * @param {number} maxWidth - Maximum width (default 1920px)
 * @param {number} quality - JPEG quality 0-1 (default 0.8)
 * @returns {Promise<Blob>} Compressed image blob
 */
async function compressImage(file, maxWidth = 1920, quality = 0.8) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                // Resize if width exceeds max
                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }

                canvas.width = width;
                canvas.height = height;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                // Convert to blob (JPEG for better compression)
                canvas.toBlob(
                    (blob) => {
                        if (blob) {
                            console.log(`ðŸ“¦ Image compressed: ${(file.size / 1024).toFixed(1)}KB â†’ ${(blob.size / 1024).toFixed(1)}KB`);
                            resolve(blob);
                        } else {
                            reject(new Error('Image compression failed'));
                        }
                    },
                    'image/jpeg',
                    quality
                );
            };
            img.onerror = () => reject(new Error('Failed to load image'));
            img.src = e.target.result;
        };
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
    });
}

/**
 * @file CommunityTab.js - Community features and peer-to-peer support
 * @description Contains community chat, topic rooms, support groups, meetings, and emergency resources
 *
 * @components
 * MAIN COMPONENT (1):
 * - CommunityTab: Main community features with tabbed interface
 *
 * SUB-COMPONENT (1):
 * - CommunityChat: Chat/feed UI component for displaying and sending messages
 *
 * @features
 * COMMUNITY TAB:
 * - Tabbed interface: Main chat, Topic Rooms, Support Groups, Meetings
 * - Real-time community message feed
 * - Topic rooms for specific recovery topics
 * - Support group listings with meeting schedules
 * - Upcoming meetings calendar
 * - Emergency resources list
 * - SOS emergency button
 *
 * COMMUNITY CHAT:
 * - Message feed with auto-scroll
 * - Image upload support
 * - Like/comment functionality
 * - Flag content for moderation
 * - Full-screen image viewing
 *
 * @architecture 3-Layer Direct Architecture (Component â†’ Firebase â†’ Component)
 * - CommunityTab uses local useState hooks
 * - Direct Firebase Firestore queries
 * - Real-time listeners with cleanup
 * - NO global state dependencies
 * - CommunityChat is props-based with callbacks (NO Firebase)
 *
 * @refactored November 2025 - Phase 4 complete
 * @author GLRS Development Team
 */

// Index/CommunityTab.js
window.GLRSApp = window.GLRSApp || {};
window.GLRSApp.components = window.GLRSApp.components || {};

/**
 * CommunityTab Component
 * @description Main community features with multi-tab interface for peer support
 *
 * @features
 * - Tab 1: GLRS Community - Main message feed for all users
 * - Tab 2: Topic Rooms - Specialized discussion rooms (relapse prevention, family support, etc.)
 * - Tab 3: Support Groups - Weekly support group meetings with schedules
 * - Tab 4: Meetings - Upcoming meeting calendar
 * - Emergency resources section with crisis hotlines
 * - SOS emergency button for immediate coach notification
 *
 * @state 8 useState hooks:
 * - user: Firebase auth user object
 * - activeChat: Current tab ('main'|'rooms'|'groups'|'meetings')
 * - communityMessages: Array of community messages (real-time)
 * - topicRooms: Array of active topic rooms
 * - supportGroups: Array of active support groups
 * - meetings: Array of scheduled/completed meetings
 * - emergencyResources: Array of emergency resources
 * - loading: Loading state for initial data fetch
 * - error: Error state for user-facing error messages
 *
 * @firebase 6 Firestore queries:
 * 1. onAuthStateChanged: Monitor auth state
 * 2. loadCommunityMessages: Real-time listener for community messages
 * 3. loadTopicRooms: Fetch active topic rooms
 * 4. loadSupportGroups: Fetch active support groups
 * 5. loadMeetings: Fetch scheduled/completed meetings
 * 6. loadEmergencyResources: Fetch emergency resources
 * 7. sendCommunityMessage: Write new message to Firestore
 *
 * @props (optional callbacks for functionality)
 * - onUploadChatImage: function - Callback to upload chat image
 * - onFlagContent: function - Callback to flag content for moderation
 * - onSetModalImage: function - Callback to show full-screen image
 * - onEnterTopicRoom: function - Callback to navigate to topic room
 * - onTriggerSOS: function - Callback to trigger emergency SOS
 *
 * @utilities
 * - window.snapshotToArray: Convert Firestore snapshot to array
 * - window.handleFirebaseError: Centralized error logging
 *
 * @returns {React.Element} Community tab with tabbed interface
 */
function CommunityTab({
    onUploadChatImage,
    onFlagContent,
    onSetModalImage,
    onEnterTopicRoom,
    onTriggerSOS
} = {}) {  // âœ… PHASE 4: Added JSDoc + error handling + optional props
    // Local state hooks
    const [user, setUser] = useState(null);
    const [activeChat, setActiveChat] = useState('main');
    const [communityMessages, setCommunityMessages] = useState([]);
    const [topicRooms, setTopicRooms] = useState([]);
    const [supportGroups, setSupportGroups] = useState([]);
    const [emergencyResources, setEmergencyResources] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);

    // Phase 6: Removed meetings state - functionality moved to MeetingsTab
    const [showSidebar, setShowSidebar] = useState(false); // Connect tools sidebar

    // My Day feature state
    const [showMyDayModal, setShowMyDayModal] = useState(false);
    const [myDayPostType, setMyDayPostType] = useState('reflection');
    const [myDayContent, setMyDayContent] = useState('');
    const [myDayAnonymous, setMyDayAnonymous] = useState(false);
    const [myDaySubmitting, setMyDaySubmitting] = useState(false);

    // My Day feed state
    const [myDayPosts, setMyDayPosts] = useState([]);
    const [myDayLoading, setMyDayLoading] = useState(true);
    const [myDayFilter, setMyDayFilter] = useState('all');
    const [currentUserData, setCurrentUserData] = useState(null);

    // Post menu state (three-dot menu)
    const [openPostMenu, setOpenPostMenu] = useState(null); // postId or null

    // Comments state
    const [showComments, setShowComments] = useState({});
    const [commentText, setCommentText] = useState({});
    const [postComments, setPostComments] = useState({});
    const [submittingComment, setSubmittingComment] = useState(false);
    const [loadingComments, setLoadingComments] = useState({});

    // Reply functionality state (nested comments)
    const [replyingTo, setReplyingTo] = useState(null); // commentId being replied to, or null
    const [replyText, setReplyText] = useState('');
    const [expandedReplies, setExpandedReplies] = useState({}); // { commentId: boolean }
    const [commentReplies, setCommentReplies] = useState({}); // { commentId: [replies] }
    const [loadingReplies, setLoadingReplies] = useState({}); // { commentId: boolean }

    // Image upload state
    const [myDayImage, setMyDayImage] = useState(null);
    const [myDayImagePreview, setMyDayImagePreview] = useState(null);
    const [uploadProgress, setUploadProgress] = useState(0); // PHASE 5: Upload progress (0-100)
    const [uploadingImage, setUploadingImage] = useState(false);
    const [viewingImage, setViewingImage] = useState(null);

    // Community message comments state (same as My Day)
    const [communityShowComments, setCommunityShowComments] = useState({});
    const [communityCommentText, setCommunityCommentText] = useState({});
    const [communityComments, setCommunityComments] = useState({});
    const [communitySubmittingComment, setCommunitySubmittingComment] = useState(false);
    const [communityLoadingComments, setCommunityLoadingComments] = useState({});

    // Community anonymous posting state
    const [communityAnonymous, setCommunityAnonymous] = useState(false);

    // Blocked users state (PHASE 3)
    const [blockedUserIds, setBlockedUserIds] = useState([]);

    // Profile modal state (PHASE 2 & 4) - Shared across My Day and Community Chat
    const [showProfileModal, setShowProfileModal] = useState(false);
    const [selectedUserId, setSelectedUserId] = useState(null);
    const [profileData, setProfileData] = useState(null);
    const [profileLoading, setProfileLoading] = useState(false);
    const [profileError, setProfileError] = useState(null);

    // UserProfileView state (PHASE 4 - Integration)
    const [viewingUserProfile, setViewingUserProfile] = useState(null);


    // Mobile detection for responsive layout (breakpoint: 768px)
    const [isMobile, setIsMobile] = useState(window.innerWidth < 768);

    useEffect(() => {
        const handleResize = () => {
            setIsMobile(window.innerWidth < 768);
        };
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
    }, []);

    // Calendar navigation for single-day mobile view (Phase 5)
    const [selectedCalendarDate, setSelectedCalendarDate] = useState(new Date());

    // Upcoming meetings time filter
    const [upcomingFilter, setUpcomingFilter] = useState('7days'); // 'today' | '7days' | '14days' | '30days' | 'all'

    // Code aliasing - maps duplicate/variant codes to primary codes
    const codeAliases = {
        'S': 'ES',        // Spanish
        'G': 'LGBTQ',     // Gay/Lesbian â†’ LGBTQ
        'L': 'LGBTQ',     // Lesbian â†’ LGBTQ
        'XB': 'X',        // Wheelchair + Bathroom â†’ Wheelchair
        '12 STEP': '12x12', // Alternative notation
        'TWELVE STEP': '12x12'
    };

    // Normalize code using aliasing
    const normalizeCode = (code) => {
        const upperCode = String(code).toUpperCase().trim();
        return codeAliases[upperCode] || upperCode;
    };

    // Meeting type code decoder - COMPLETE 45+ CODE DEFINITIONS (TSML standard)
    const meetingTypeCodes = {
        // FORMAT TYPES (How the meeting is conducted)
        'D': 'Discussion',
        'B': 'Big Book Study',
        '12x12': '12 Steps & 12 Traditions',
        'LIT': 'Literature',
        'ST': 'Step Study',
        'SP': 'Speaker',
        'MED': 'Meditation',
        'CAN': 'Candlelight',
        'T': 'Tradition Study', // Context-dependent (could also be Transgender)
        'TR': 'Tradition Study',
        'POA': 'Format Varies',

        // MEETING ACCESS (Who can attend)
        'O': 'Open (Non-alcoholics welcome)',
        'C': 'Closed (Alcoholics only)',

        // DEMOGRAPHIC FOCUS (Target groups)
        'W': 'Women Only',
        'M': 'Men Only',
        'Y': 'Young People',
        'SEN': 'Seniors',
        'LGBTQ': 'LGBTQ+',
        'POC': 'People of Color',
        'G': 'Gay/Lesbian (LGBTQ+)', // Older code, maps to LGBTQ
        'L': 'Lesbian (LGBTQ+)', // Older code, maps to LGBTQ
        'NB': 'Non-Binary',

        // SPECIAL POPULATIONS (Specific needs)
        'BE': 'Beginners',
        'DD': 'Dual Diagnosis',
        'ABSI': 'Adult Children of Alcoholics',
        'AL-AN': 'Al-Anon Focus',
        'DB': 'Digital Basket (Venmo/PayPal)',
        'GR': 'Grapevine',
        'DR': 'Daily Reflections',
        '11': '11th Step Focus',
        'P': 'Professionals',
        'A': 'Atheist/Agnostic',
        'N': 'Native American',

        // ACCESSIBILITY FEATURES (Physical/virtual access)
        'X': 'Wheelchair Accessible',
        'XB': 'Wheelchair Accessible + Bathroom',
        'BA': 'Babysitting Available',
        'CF': 'Child-Friendly',
        'ASL': 'ASL Interpreted',
        'ONL': 'Online',
        'HY': 'Hybrid (In-person & Online)',
        'TC': 'Temporarily Closed',
        'FF': 'Fragrance Free',
        'XT': 'Cross-Talk Permitted',

        // LANGUAGE
        'EN': 'English',
        'ES': 'Spanish',
        'S': 'Spanish', // Alias for ES
        'FR': 'French',

        // Default
        'DEFAULT': 'Meeting Type'
    };

    // Get full name for meeting type code
    const getTypeName = (code) => {
        const normalizedCode = normalizeCode(code);
        return meetingTypeCodes[normalizedCode] || code;
    };

    // Scroll to top when component mounts (when tab is opened)
    useEffect(() => {
        window.scrollTo(0, 0);
    }, []);

    // Close post menu when clicking outside
    useEffect(() => {
        const handleClickOutside = (event) => {
            // If a menu is open and click is outside, close it
            if (openPostMenu) {
                // Check if click is on a menu button or menu content
                const menuButton = event.target.closest('[data-post-menu-button]');
                const menuDropdown = event.target.closest('[data-post-menu-dropdown]');

                if (!menuButton && !menuDropdown) {
                    setOpenPostMenu(null);
                }
            }
        };

        document.addEventListener('click', handleClickOutside);
        return () => document.removeEventListener('click', handleClickOutside);
    }, [openPostMenu]);

    // Load current user from Firebase auth
    useEffect(() => {
        const unsubscribeAuth = firebase.auth().onAuthStateChanged((authUser) => {
            if (authUser) {
                setUser(authUser);
            } else {
                setUser(null);
            }
        });

        return () => unsubscribeAuth();
    }, []);

    // Initialize Lucide icons on component mount (for always-visible icons)
    useEffect(() => {
        const timer = setTimeout(() => {
            if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') {
                lucide.createIcons();
                console.log('âœ… CommunityTab: Initial Lucide icons initialized');
            }
        }, 100);

        return () => clearTimeout(timer);
    }, []);

    // Initialize Lucide icons when My Day modal opens
    useEffect(() => {
        if (showMyDayModal) {
            const timer = setTimeout(() => {
                if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') {
                    lucide.createIcons();
                    console.log('âœ… CommunityTab: My Day modal icons initialized');
                }
            }, 100);

            return () => clearTimeout(timer);
        }
    }, [showMyDayModal]);

    // Initialize Lucide icons when sidebar opens
    useEffect(() => {
        if (showSidebar) {
            const timer = setTimeout(() => {
                if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') {
                    lucide.createIcons();
                    console.log('âœ… CommunityTab: Sidebar icons initialized');
                }
            }, 100);

            return () => clearTimeout(timer);
        }
    }, [showSidebar]);

    // Load current user data (for coach role check)
    useEffect(() => {
        if (!user) return;

        const loadUserData = async () => {
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    setCurrentUserData(userDoc.data());
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                window.handleFirebaseError && window.handleFirebaseError(error, 'CommunityTab.loadUserData');
            }
        };

        loadUserData();
    }, [user]);

    // Load blocked users (PHASE 3)
    useEffect(() => {
        if (!user) return;

        console.log('ðŸ“› Loading blocked users for current user...');

        const unsubscribe = db.collection('blockedUsers')
            .where('blockedBy', '==', user.uid)
            .onSnapshot((snapshot) => {
                const blockedIds = snapshot.docs.map(doc => doc.data().blockedUserId);
                setBlockedUserIds(blockedIds);
                console.log(`ðŸ“› Blocked users loaded: ${blockedIds.length} blocked`);
            }, (error) => {
                console.error('âŒ Error loading blocked users:', error);
                window.handleFirebaseError && window.handleFirebaseError(error, 'CommunityTab.loadBlockedUsers');
            });

        return () => unsubscribe();
    }, [user]);

    // Real-time listener for My Day posts
    useEffect(() => {
        if (!user || activeChat !== 'myday') return;

        setMyDayLoading(true);

        const unsubscribe = db.collection('dailyPosts')
            .where('hidden', '==', false)
            .orderBy('createdAt', 'desc')
            .limit(50)
            .onSnapshot((snapshot) => {
                const posts = window.snapshotToArray(snapshot);
                setMyDayPosts(posts);
                setMyDayLoading(false);
            }, (error) => {
                console.error('Error loading My Day posts:', error);
                window.handleFirebaseError && window.handleFirebaseError(error, 'CommunityTab.loadMyDayPosts');
                setMyDayLoading(false);
            });

        return () => unsubscribe();
    }, [user, activeChat]);

    // Real-time listener for comments (per expanded post)
    useEffect(() => {
        const unsubscribers = [];

        Object.keys(showComments).forEach(postId => {
            if (showComments[postId] && !postComments[postId]) {
                setLoadingComments(prev => ({ ...prev, [postId]: true }));

                const unsubscribe = db.collection('dailyPosts')
                    .doc(postId)
                    .collection('comments')
                    .orderBy('createdAt', 'asc')
                    .limit(50)
                    .onSnapshot((snapshot) => {
                        const comments = window.snapshotToArray(snapshot);
                        setPostComments(prev => ({ ...prev, [postId]: comments }));
                        setLoadingComments(prev => ({ ...prev, [postId]: false }));
                    }, (error) => {
                        console.error('Error loading comments:', error);
                        window.handleFirebaseError && window.handleFirebaseError(error, 'CommunityTab.loadComments');
                        setLoadingComments(prev => ({ ...prev, [postId]: false }));
                    });

                unsubscribers.push(unsubscribe);
            }
        });

        return () => {
            unsubscribers.forEach(unsub => unsub());
        };
    }, [showComments]);

    // Real-time listener for community message comments (per expanded message)
    useEffect(() => {
        const unsubscribers = [];

        Object.keys(communityShowComments).forEach(messageId => {
            if (communityShowComments[messageId] && !communityComments[messageId]) {
                setCommunityLoadingComments(prev => ({ ...prev, [messageId]: true }));

                const unsubscribe = db.collection('messages')
                    .doc(messageId)
                    .collection('comments')
                    .orderBy('createdAt', 'asc')
                    .limit(50)
                    .onSnapshot((snapshot) => {
                        const comments = window.snapshotToArray(snapshot);
                        setCommunityComments(prev => ({ ...prev, [messageId]: comments }));
                        setCommunityLoadingComments(prev => ({ ...prev, [messageId]: false }));
                    }, (error) => {
                        console.error('Error loading community comments:', error);
                        window.handleFirebaseError && window.handleFirebaseError(error, 'CommunityTab.loadCommunityComments');
                        setCommunityLoadingComments(prev => ({ ...prev, [messageId]: false }));
                    });

                unsubscribers.push(unsubscribe);
            }
        });

        return () => {
            unsubscribers.forEach(unsub => unsub());
        };
    }, [communityShowComments]);

    // Real-time listener for community messages
    useEffect(() => {
        if (!user) return;

        const unsubscribe = db.collection('messages')
            .where('type', '==', 'community')
            .orderBy('createdAt', 'desc')
            .limit(50)
            .onSnapshot((snapshot) => {
                const msgs = window.snapshotToArray(snapshot);
                setCommunityMessages(msgs);
                setError(null); // Clear any previous errors
                setLoading(false);
            }, (error) => {
                console.error('Error loading community messages:', error);
                setError('Failed to load community messages. Please check your connection and try again.');
                window.handleFirebaseError && window.handleFirebaseError(error, 'CommunityTab.loadCommunityMessages');
                setLoading(false);
            });

        return () => unsubscribe();
    }, [user]);

    // Load topic rooms
    useEffect(() => {
        if (!user) return;

        const loadTopicRooms = async () => {
            try {
                const roomsSnap = await db.collection('topicRooms')
                    .where('status', '==', 'active')
                    .orderBy('name', 'asc')
                    .get();

                const rooms = window.snapshotToArray(roomsSnap);
                setTopicRooms(rooms);
            } catch (error) {
                console.error('Error loading topic rooms:', error);
                // Non-critical error - topic rooms are optional, don't show error UI
                window.handleFirebaseError && window.handleFirebaseError(error, 'CommunityTab.loadTopicRooms');
            }
        };

        loadTopicRooms();
    }, [user]);

    // Load support groups
    useEffect(() => {
        if (!user) return;

        const loadSupportGroups = async () => {
            try {
                const groupsSnap = await db.collection('supportGroups')
                    .where('status', '==', 'active')
                    .orderBy('day', 'asc')
                    .get();

                const groups = window.snapshotToArray(groupsSnap);
                setSupportGroups(groups);
            } catch (error) {
                console.error('Error loading support groups:', error);
                // Non-critical error - support groups are optional, don't show error UI
                window.handleFirebaseError && window.handleFirebaseError(error, 'CommunityTab.loadSupportGroups');
            }
        };

        loadSupportGroups();
    }, [user]);

    // Load scheduled meetings
    const loadMeetings = React.useCallback(async () => {
        if (!user) return;

        try {
            const meetingsSnap = await db.collection('meetings')
                .where('userId', '==', user.uid)  // Only load current user's meetings
                .where('status', 'in', ['scheduled', 'completed'])
                .orderBy('scheduledTime', 'desc')
                .limit(100)  // Support up to 100 meetings (was 10)
                .get();

            const mtgs = window.snapshotToArray(meetingsSnap);
            setMeetings(mtgs);
        } catch (error) {
            console.error('Error loading meetings:', error);
            // Non-critical error - meetings are optional, don't show error UI
            window.handleFirebaseError && window.handleFirebaseError(error, 'CommunityTab.loadMeetings');
        } finally {
            setLoading(false);
        }
    }, [user]);

    useEffect(() => {
        loadMeetings();
    }, [loadMeetings]);

    // Load external AA/NA meetings (Phase 2)
    useEffect(() => {
        const loadExternalMeetings = async () => {
            try {
                const externalMeetingsSnap = await db.collection('externalMeetings')
                    .limit(5000) // Load all meetings (3,138 total)
                    .get();

                const extMtgs = window.snapshotToArray(externalMeetingsSnap);
                setExternalMeetings(extMtgs);
                console.log(`âœ… Loaded ${extMtgs.length} external AA/NA meetings`);
            } catch (error) {
                console.error('Error loading external meetings:', error);
                window.handleFirebaseError && window.handleFirebaseError(error, 'CommunityTab.loadExternalMeetings');
            }
        };

        loadExternalMeetings();
    }, []);

    // Handle select mode toggle
    const handleToggleSelectMode = () => {
        setSelectMode(!selectMode);
        setSelectedMeetings([]); // Clear selections when toggling
    };

    // Handle meeting selection toggle
    const handleToggleSelection = (meetingId) => {
        if (selectedMeetings.includes(meetingId)) {
            setSelectedMeetings(selectedMeetings.filter(id => id !== meetingId));
        } else {
            setSelectedMeetings([...selectedMeetings, meetingId]);
        }
    };

    // Handle delete selected meetings
    const handleDeleteSelected = async () => {
        if (selectedMeetings.length === 0) return;

        if (!confirm(`Delete ${selectedMeetings.length} selected meeting${selectedMeetings.length > 1 ? 's' : ''}?`)) {
            return;
        }

        try {
            const batch = db.batch();
            selectedMeetings.forEach(meetingId => {
                const docRef = db.collection('meetings').doc(meetingId);
                batch.delete(docRef);
            });

            await batch.commit();

            if (window.showNotification) {
                window.showNotification(`Deleted ${selectedMeetings.length} meeting${selectedMeetings.length > 1 ? 's' : ''}`, 'success');
            }

            // Reset state
            setSelectedMeetings([]);
            setSelectMode(false);

            // Reload meetings
            const updatedMeetings = meetings.filter(m => !selectedMeetings.includes(m.id));
            setMeetings(updatedMeetings);
        } catch (error) {
            console.error('Error deleting meetings:', error);
            if (window.showNotification) {
                window.showNotification('Failed to delete meetings', 'error');
            }
        }
    };

    // Apply filters to meetings (Phase 2)
    useEffect(() => {
        if (activeFilter === 'all') {
            // All = GLRS + AA + NA (everything)
            setFilteredMeetings([...meetings, ...externalMeetings]);
        } else if (activeFilter === 'glrs') {
            // GLRS Virtual only (meetings without type or with type 'GLRS')
            setFilteredMeetings(meetings.filter(m => !m.type || m.type === 'GLRS'));
        } else if (activeFilter === 'aa') {
            // AA only - includes both scheduled AA meetings AND browseable external AA meetings
            const scheduledAA = meetings.filter(m => m.type === 'AA');
            const externalAA = externalMeetings.filter(m => m.type === 'AA');
            setFilteredMeetings([...scheduledAA, ...externalAA]);
        } else if (activeFilter === 'na') {
            // NA only - includes both scheduled NA meetings AND browseable external NA meetings
            const scheduledNA = meetings.filter(m => m.type === 'NA');
            const externalNA = externalMeetings.filter(m => m.type === 'NA');
            setFilteredMeetings([...scheduledNA, ...externalNA]);
        } else if (activeFilter === 'recovery') {
            // All Recovery = AA + NA (no GLRS)
            const scheduledRecovery = meetings.filter(m => m.type === 'AA' || m.type === 'NA');
            setFilteredMeetings([...scheduledRecovery, ...externalMeetings]);
        }
    }, [activeFilter, meetings, externalMeetings]);

    // Load emergency resources
    useEffect(() => {
        const loadEmergencyResources = async () => {
            try {
                const resourcesSnap = await db.collection('emergencyResources')
                    .where('status', '==', 'active')
                    .orderBy('priority', 'asc')
                    .get();

                const resources = window.snapshotToArray(resourcesSnap);
                setEmergencyResources(resources);
            } catch (error) {
                console.error('Error loading emergency resources:', error);
                // Non-critical error - emergency resources are optional, don't show error UI
                window.handleFirebaseError && window.handleFirebaseError(error, 'CommunityTab.loadEmergencyResources');
            }
        };

        loadEmergencyResources();
    }, []);

    // Send community message function
    const sendCommunityMessage = async (messageText, imageUrl = null, isAnonymous = false) => {
        if (!user) return;

        try {
            // Get user's full name from userData
            const displayName = currentUserData?.firstName
                ? `${currentUserData.firstName} ${currentUserData.lastName || ''}`.trim()
                : user.displayName || user.email;

            await db.collection('messages').add({
                type: 'community',
                content: messageText,
                imageUrl: imageUrl,
                senderId: user.uid,
                senderName: isAnonymous ? 'Anonymous' : displayName,
                senderProfileImageUrl: isAnonymous ? null : (currentUserData?.profileImageUrl || null),
                isAnonymous: isAnonymous,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                reactions: {
                    heart: [],
                    support: [],
                    celebrate: []
                },
                reactedBy: {},
                commentCount: 0
            });

            // Reset anonymous checkbox after sending
            setCommunityAnonymous(false);
        } catch (error) {
            console.error('Error sending community message:', error);
            window.handleFirebaseError && window.handleFirebaseError(error, 'CommunityTab.sendCommunityMessage');
            throw error; // Re-throw so calling code can handle
        }
    };

    // Upload chat image function (Community Chat & Topic Rooms)
    const uploadChatImage = async (file, type, roomId) => {
        if (!file || !user) {
            console.warn('Upload chat image: No file or user provided');
            return null;
        }

        try {
            // STEP 1: Compress image
            console.log(`ðŸ“¦ Compressing chat image: ${file.name} (${(file.size / 1024).toFixed(1)}KB)`);
            const compressedBlob = await compressImage(file);

            // STEP 2: Convert Blob to File (workaround for Firebase SDK)
            const timestamp = Date.now();
            const filename = `${timestamp}_${file.name}`;
            const compressedFile = new File([compressedBlob], filename, {
                type: 'image/jpeg',
                lastModified: Date.now()
            });

            console.log(`ðŸ“¦ Converted blob to file: ${compressedFile.name}, size: ${(compressedFile.size / 1024).toFixed(1)}KB, type: ${compressedFile.type}`);

            // STEP 3: Choose storage path based on type
            let storagePath;
            if (type === 'community') {
                storagePath = `communityImages/${user.uid}/${filename}`;
            } else if (type === 'topic') {
                storagePath = `topicRoomImages/${user.uid}/${filename}`;
            } else {
                storagePath = `communityImages/${user.uid}/${filename}`; // Default
            }

            const storageRef = firebase.storage().ref();
            const imageRef = storageRef.child(storagePath);

            console.log(`ðŸ“¤ Uploading chat image to: ${storagePath}`);

            // STEP 4: Upload with resumable upload
            const uploadTask = imageRef.put(compressedFile, {
                contentType: 'image/jpeg',
                cacheControl: 'public, max-age=31536000'
            });

            return new Promise((resolve, reject) => {
                uploadTask.on('state_changed',
                    // Progress callback (optional for chat)
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log(`ðŸ“Š Chat image upload: ${Math.round(progress)}%`);
                    },

                    // Error callback
                    (error) => {
                        console.error('âŒ Chat image upload error:', error);
                        if (error.code === 'storage/unauthorized') {
                            reject(new Error('Permission denied. Storage rules may not be configured.'));
                        } else if (error.code === 'storage/quota-exceeded') {
                            reject(new Error('Storage quota exceeded.'));
                        } else {
                            reject(new Error(`Upload failed: ${error.message}`));
                        }
                    },

                    // Success callback
                    async () => {
                        try {
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            console.log(`âœ… Chat image upload complete: ${downloadURL}`);
                            resolve(downloadURL);
                        } catch (error) {
                            console.error('âŒ Failed to get download URL:', error);
                            reject(new Error(`Failed to get download URL: ${error.message}`));
                        }
                    }
                );
            });

        } catch (error) {
            console.error('âŒ Error in uploadChatImage:', error);
            throw error;
        }
    };

    // Flag content function
    const flagContent = (contentType, contentData) => {
        if (onFlagContent) {
            onFlagContent(contentType, contentData);
        } else {
            console.warn('Flag content: No callback provided. Pass onFlagContent prop to CommunityTab.');
        }
    };

    // Set modal image function
    const setModalImage = (imageUrl) => {
        if (onSetModalImage) {
            onSetModalImage(imageUrl);
        } else {
            console.warn('Set modal image: No callback provided. Pass onSetModalImage prop to CommunityTab.');
        }
    };

    // Enter topic room function
    const enterTopicRoom = (room) => {
        if (onEnterTopicRoom) {
            onEnterTopicRoom(room);
        } else {
            console.warn('Enter topic room: No callback provided. Pass onEnterTopicRoom prop to CommunityTab.');
        }
    };

    // Trigger SOS function
    const triggerSOS = () => {
        if (onTriggerSOS) {
            onTriggerSOS();
        } else {
            console.warn('Trigger SOS: No callback provided. Pass onTriggerSOS prop to CommunityTab.');
            alert('SOS alert sent! Your coach has been notified.');
        }
    };

    // Format timestamp for My Day posts
    const formatMyDayTimestamp = (timestamp) => {
        if (!timestamp?.toDate) return 'Just now';

        const date = timestamp.toDate();
        const seconds = Math.floor((new Date() - date) / 1000);

        if (seconds < 60) return 'Just now';
        if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
        if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
        if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;

        // Format as "Nov 16, 2025"
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    };

    // ============================================================
    // PROFILE MODAL HANDLERS (PHASE 2 & 4)
    // ============================================================

    // Smart avatar click handler (PHASE 2)
    const handleAvatarClick = async (userId, isAnonymous) => {
        // Don't open for anonymous posts
        if (isAnonymous || !userId) {
            return;
        }

        // PHASE 4: Open UserProfileView component instead of modal
        setViewingUserProfile(userId);
    };

    // Open user profile modal
    const handleOpenProfile = async (userId, isAnonymous) => {
        // Don't open profile for anonymous posts
        if (isAnonymous || !userId) {
            return;
        }

        // Don't open if already loading
        if (profileLoading) {
            return;
        }

        setSelectedUserId(userId);
        setShowProfileModal(true);
        setProfileLoading(true);
        setProfileError(null);
        setProfileData(null);

        try {
            console.log(`ðŸ“– Loading profile for user: ${userId}`);

            // Fetch user data from Firestore
            const userDoc = await db.collection('users').doc(userId).get();

            if (!userDoc.exists) {
                throw new Error('User not found');
            }

            const userData = userDoc.data();

            // Check if current user is coach or admin
            const isCoach = currentUserData?.role === 'coach' || currentUserData?.role === 'admin' || currentUserData?.role === 'superadmin';

            // Check if viewing own profile
            const isOwnProfile = userId === user?.uid;

            // Get profile visibility settings (default all true if not set)
            const visibility = userData.profileVisibility || {
                memberSince: true,
                sobrietyDate: true,
                recoveryGoals: true,
                completedGoals: true,
                timezone: true
            };

            // Build profile data respecting visibility (coaches override, own profile shows all)
            const profile = {
                userId: userId,
                displayName: userData.firstName ? `${userData.firstName} ${userData.lastName || ''}`.trim() : 'User',
                firstName: userData.firstName,
                lastName: userData.lastName,
                email: userData.email,
                role: userData.role || 'pir',
                isOwnProfile: isOwnProfile,

                // Conditional fields based on visibility, coach override, or own profile
                memberSince: (visibility.memberSince || isCoach || isOwnProfile) ? userData.createdAt : null,
                sobrietyDate: (visibility.sobrietyDate || isCoach || isOwnProfile) ? userData.sobrietyDate : null,
                recoveryGoals: (visibility.recoveryGoals || isCoach || isOwnProfile) ? userData.recoveryGoals : null,
                completedGoals: (visibility.completedGoals || isCoach || isOwnProfile) ? userData.completedGoals : null,
                timezone: (visibility.timezone || isCoach || isOwnProfile) ? userData.timezone : null,

                // Always show these
                profilePhoto: userData.profilePhoto || null
            };

            console.log('âœ… Profile loaded successfully');
            setProfileData(profile);

        } catch (error) {
            console.error('âŒ Error loading profile:', error);
            setProfileError(error.message || 'Failed to load profile');
        } finally {
            setProfileLoading(false);
        }
    };

    // Close profile modal
    const handleCloseProfile = () => {
        setShowProfileModal(false);
        setSelectedUserId(null);
        setProfileData(null);
        setProfileError(null);
    };

    // Filter My Day posts based on current filter
    const getFilteredPosts = () => {
        if (!myDayPosts) return [];

        // First, filter by type based on selected filter
        let filtered;
        switch (myDayFilter) {
            case 'reflections':
                filtered = myDayPosts.filter(post => post.type === 'reflection');
                break;
            case 'wins':
                filtered = myDayPosts.filter(post => post.type === 'win');
                break;
            case 'mine':
                filtered = myDayPosts.filter(post => post.userId === user?.uid);
                break;
            default: // 'all'
                filtered = myDayPosts;
        }

        // Then, filter out blocked users (PHASE 3)
        if (blockedUserIds.length > 0) {
            filtered = filtered.filter(post => !blockedUserIds.includes(post.userId));
        }

        return filtered;
    };

    // Check if current user is coach or admin
    const isCoachOrAdmin = () => {
        return currentUserData?.role === 'coach' || currentUserData?.role === 'admin';
    };

    // Toggle comments section
    const toggleComments = (postId) => {
        setShowComments(prev => ({
            ...prev,
            [postId]: !prev[postId]
        }));
    };

    // Add comment to post
    const handleAddComment = async (postId) => {
        const content = commentText[postId]?.trim();

        if (!user || !content || submittingComment) return;

        // Validate length
        if (content.length > 280) {
            alert('Comment must be 280 characters or less.');
            return;
        }

        setSubmittingComment(true);

        try {
            // Get user data for display name
            const userDoc = await db.collection('users').doc(user.uid).get();
            const userData = userDoc.data();
            const displayName = userData?.firstName ?
                `${userData.firstName} ${userData.lastName || ''}`.trim() :
                user.displayName || user.email;

            // Add comment to subcollection
            await db.collection('dailyPosts').doc(postId).collection('comments').add({
                userId: user.uid,
                userDisplayName: displayName,
                userAvatar: null,
                content: content,
                isAnonymous: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                reactions: { heart: 0 },
                flagged: false
            });

            // Increment comment count on post
            await db.collection('dailyPosts').doc(postId).update({
                commentCount: firebase.firestore.FieldValue.increment(1)
            });

            // Clear input
            setCommentText(prev => ({ ...prev, [postId]: '' }));

            // Haptic feedback
            if (window.GLRSApp?.utils?.triggerHaptic) {
                window.GLRSApp.utils.triggerHaptic('light');
            }

        } catch (error) {
            console.error('Error adding comment:', error);
            window.handleFirebaseError && window.handleFirebaseError(error, 'CommunityTab.handleAddComment');
            alert('Failed to add comment. Please try again.');
        } finally {
            setSubmittingComment(false);
        }
    };

    // Delete comment
    const handleDeleteComment = async (postId, commentId, commentUserId) => {
        // Verify ownership or coach/admin
        if (commentUserId !== user?.uid && !isCoachOrAdmin()) {
            alert('You can only delete your own comments.');
            return;
        }

        if (!confirm('Delete this comment?')) return;

        try {
            // Delete comment document
            await db.collection('dailyPosts').doc(postId).collection('comments').doc(commentId).delete();

            // Decrement comment count on post
            await db.collection('dailyPosts').doc(postId).update({
                commentCount: firebase.firestore.FieldValue.increment(-1)
            });

            // Haptic feedback
            if (window.GLRSApp?.utils?.triggerHaptic) {
                window.GLRSApp.utils.triggerHaptic('light');
            }

        } catch (error) {
            console.error('Error deleting comment:', error);
            window.handleFirebaseError && window.handleFirebaseError(error, 'CommunityTab.handleDeleteComment');
            alert('Failed to delete comment. Please try again.');
        }
    };

    // ============================================================
    // POST MENU HANDLERS (Delete, Report, Block)
    // ============================================================

    // Handle delete post
    const handleDeletePost = async (postId, post) => {
        // Determine if this is a dailyPost or message
        const isMessage = post.senderId || post.type === 'community';
        const collection = isMessage ? 'messages' : 'dailyPosts';
        const userIdField = isMessage ? post.senderId : post.userId;

        // Debug logging
        console.log('ðŸ” Delete post debug:', {
            postId,
            isMessage,
            collection,
            userIdField,
            currentUserId: user?.uid,
            isCoach: isCoachOrAdmin(),
            post
        });

        // Verify ownership or coach/admin
        if (userIdField !== user?.uid && !isCoachOrAdmin()) {
            console.error('âŒ Permission denied:', {
                userIdField,
                currentUserId: user?.uid,
                match: userIdField === user?.uid
            });
            alert('You can only delete your own posts.');
            return;
        }

        if (!confirm('Delete this post? This cannot be undone.')) return;

        try {
            // Close menu first
            setOpenPostMenu(null);

            // Delete image from storage if exists
            if (post.imageUrl && post.imageName) {
                try {
                    const storageRef = firebase.storage().ref();
                    // Determine storage path based on collection
                    const storagePath = isMessage
                        ? `communityImages/${userIdField}/${post.imageName}`
                        : `dailyPosts/${userIdField}/${post.imageName}`;
                    const imageRef = storageRef.child(storagePath);
                    await imageRef.delete();
                    console.log('ðŸ—‘ï¸ Image deleted from storage');
                } catch (storageError) {
                    console.warn('âš ï¸ Could not delete image from storage:', storageError);
                    // Continue with post deletion even if image delete fails
                }
            }

            // Delete all comments (subcollection)
            const commentsSnapshot = await db.collection(collection).doc(postId).collection('comments').get();
            const batch = db.batch();
            commentsSnapshot.docs.forEach(doc => {
                batch.delete(doc.ref);
            });
            await batch.commit();

            // Delete post document
            await db.collection(collection).doc(postId).delete();

            console.log(`âœ… Post deleted successfully from ${collection}`);

            // Show success notification
            if (window.GLRSApp?.utils?.showNotification) {
                window.GLRSApp.utils.showNotification('Post deleted successfully', 'success');
            }

        } catch (error) {
            console.error('âŒ Error deleting post:', error);
            window.handleFirebaseError && window.handleFirebaseError(error, 'CommunityTab.handleDeletePost');
            alert('Failed to delete post. Please try again.');
        }
    };

    // Handle report post
    const handleReportPost = async (postId, post) => {
        setOpenPostMenu(null);

        // Show reason selection
        const reasons = [
            '1. Spam or misleading',
            '2. Harassment or hate speech',
            '3. Violence or dangerous content',
            '4. Inappropriate content',
            '5. Other'
        ];

        const reasonChoice = prompt(
            'Please select a reason for reporting this post:\n\n' + reasons.join('\n') + '\n\nEnter the number (1-5):'
        );

        if (!reasonChoice) return; // User cancelled

        const reasonIndex = parseInt(reasonChoice) - 1;
        if (reasonIndex < 0 || reasonIndex > 4) {
            alert('Invalid selection. Please enter a number between 1 and 5.');
            return;
        }

        const selectedReason = reasons[reasonIndex].split('. ')[1];

        // Optional: Ask for additional details
        const details = prompt('Optional: Provide additional details about this report:');

        try {
            // Create report document
            await db.collection('reportedContent').add({
                reportedBy: user.uid,
                reportedByName: currentUserData?.firstName
                    ? `${currentUserData.firstName} ${currentUserData.lastName || ''}`.trim()
                    : user.displayName || user.email,
                contentType: 'post',
                contentId: postId,
                postId: postId,
                authorId: post.userId,
                authorName: post.displayName,
                content: post.content.substring(0, 200), // First 200 chars
                reason: selectedReason,
                details: details || null,
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                reviewedAt: null,
                reviewedBy: null,
                actionTaken: null
            });

            alert('Thank you for your report. Our team will review it shortly.');

        } catch (error) {
            console.error('âŒ Error reporting post:', error);
            window.handleFirebaseError && window.handleFirebaseError(error, 'CommunityTab.handleReportPost');
            alert('Failed to submit report. Please try again.');
        }
    };

    // Handle block user
    const handleBlockUser = async (post) => {
        setOpenPostMenu(null);

        // Can't block yourself or anonymous posts
        if (post.userId === user.uid) {
            alert('You cannot block yourself.');
            return;
        }

        if (post.anonymous) {
            alert('Cannot block anonymous users.');
            return;
        }

        const userName = post.displayName || 'this user';

        if (!confirm(`Block ${userName}? You won't see their posts or comments anymore.`)) return;

        try {
            // Check if already blocked (prevent duplicates) - PHASE 3
            const existingBlock = await db.collection('blockedUsers')
                .where('blockedBy', '==', user.uid)
                .where('blockedUserId', '==', post.userId)
                .get();

            if (!existingBlock.empty) {
                alert('You have already blocked this user.');
                return;
            }

            // Create block document (PHASE 3)
            await db.collection('blockedUsers').add({
                blockedBy: user.uid, // Changed from userId to match listener query
                blockedUserId: post.userId,
                blockedUserName: userName,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            alert(`${userName} has been blocked. Their posts will no longer appear in your feed.`);

            // Feed will automatically update via blockedUsers real-time listener (PHASE 3)

        } catch (error) {
            console.error('âŒ Error blocking user:', error);
            window.handleFirebaseError && window.handleFirebaseError(error, 'CommunityTab.handleBlockUser');
            alert('Failed to block user. Please try again.');
        }
    };

    // ============================================================
    // NESTED COMMENT REPLY HANDLERS
    // ============================================================

    // Start replying to a comment
    const handleStartReply = (commentId, userDisplayName) => {
        setReplyingTo(commentId);
        setReplyText('');
        // Auto-focus will happen in UI with useEffect
    };

    // Cancel reply
    const handleCancelReply = () => {
        setReplyingTo(null);
        setReplyText('');
    };

    // Submit reply to a comment
    const handleAddReply = async (postId, parentCommentId, parentComment) => {
        const content = replyText.trim();

        if (!user || !content || submittingComment) return;

        // Validate length
        if (content.length > 280) {
            alert('Reply must be 280 characters or less.');
            return;
        }

        setSubmittingComment(true);

        try {
            // Get user data for display name
            const userDoc = await db.collection('users').doc(user.uid).get();
            const userData = userDoc.data();
            const displayName = userData?.firstName ?
                `${userData.firstName} ${userData.lastName || ''}`.trim() :
                user.displayName || user.email;

            // Add reply to comments subcollection with parent reference
            await db.collection('dailyPosts').doc(postId).collection('comments').add({
                userId: user.uid,
                userDisplayName: displayName,
                userAvatar: null,
                content: content,
                isAnonymous: false,
                parentCommentId: parentCommentId, // Link to parent comment
                replyToUserId: parentComment.userId,
                replyToDisplayName: parentComment.userDisplayName,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                reactions: { heart: 0 },
                flagged: false
            });

            // Increment comment count AND reply count on post
            await db.collection('dailyPosts').doc(postId).update({
                commentCount: firebase.firestore.FieldValue.increment(1),
                replyCount: firebase.firestore.FieldValue.increment(1)
            });

            // Clear reply state
            setReplyingTo(null);
            setReplyText('');

            // Ensure replies are expanded for this comment
            setExpandedReplies(prev => ({ ...prev, [parentCommentId]: true }));

            // Haptic feedback
            if (window.GLRSApp?.utils?.triggerHaptic) {
                window.GLRSApp.utils.triggerHaptic('light');
            }

        } catch (error) {
            console.error('Error adding reply:', error);
            window.handleFirebaseError && window.handleFirebaseError(error, 'CommunityTab.handleAddReply');
            alert('Failed to add reply. Please try again.');
        } finally {
            setSubmittingComment(false);
        }
    };

    // Toggle replies visibility and load if needed
    const handleToggleReplies = (postId, commentId) => {
        const isCurrentlyExpanded = expandedReplies[commentId];

        // Toggle expanded state
        setExpandedReplies(prev => ({
            ...prev,
            [commentId]: !isCurrentlyExpanded
        }));

        // If expanding and replies not loaded yet, load them
        if (!isCurrentlyExpanded && !commentReplies[commentId]) {
            handleLoadReplies(postId, commentId);
        }
    };

    // Load replies for a comment
    const handleLoadReplies = (postId, commentId) => {
        setLoadingReplies(prev => ({ ...prev, [commentId]: true }));

        // Set up real-time listener for replies
        const unsubscribe = db.collection('dailyPosts')
            .doc(postId)
            .collection('comments')
            .where('parentCommentId', '==', commentId)
            .orderBy('createdAt', 'asc')
            .onSnapshot((snapshot) => {
                const replies = window.snapshotToArray(snapshot);
                setCommentReplies(prev => ({ ...prev, [commentId]: replies }));
                setLoadingReplies(prev => ({ ...prev, [commentId]: false }));
            }, (error) => {
                console.error('Error loading replies:', error);
                window.handleFirebaseError && window.handleFirebaseError(error, 'CommunityTab.handleLoadReplies');
                setLoadingReplies(prev => ({ ...prev, [commentId]: false }));
            });

        // Store unsubscribe function (we'll clean up when replies collapse - TODO: implement cleanup)
        // For now, listener stays active (will be cleaned up on component unmount via existing listeners)
    };

    // Calculate depth of a comment (for indentation)
    const getCommentDepth = (comment, allComments) => {
        let depth = 0;
        let current = comment;

        while (current.parentCommentId && depth < 3) {
            const parent = allComments.find(c => c.id === current.parentCommentId);
            if (!parent) break;
            depth++;
            current = parent;
        }

        return Math.min(depth, 3); // Max depth 3
    };

    // Handle image selection
    const handleImageSelect = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // Validate file type
        const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        if (!validTypes.includes(file.type)) {
            alert('Please select a valid image file (JPG, PNG, GIF, or WebP).');
            return;
        }

        // Validate file size (5MB max)
        const maxSize = 5 * 1024 * 1024; // 5MB in bytes
        if (file.size > maxSize) {
            alert('Image must be less than 5MB. Please select a smaller file.');
            return;
        }

        // Create preview
        const reader = new FileReader();
        reader.onloadend = () => {
            setMyDayImagePreview(reader.result);
            setMyDayImage(file);
        };
        reader.readAsDataURL(file);
    };

    // Remove selected image
    const handleRemoveImage = () => {
        setMyDayImage(null);
        setMyDayImagePreview(null);
        // Reset file input
        const fileInput = document.getElementById('myday-image-input');
        if (fileInput) fileInput.value = '';
    };

    // Toggle community message comments
    const toggleCommunityComments = (messageId) => {
        setCommunityShowComments(prev => ({
            ...prev,
            [messageId]: !prev[messageId]
        }));
    };

    // Add comment to community message
    const handleAddCommunityComment = async (messageId) => {
        const content = communityCommentText[messageId]?.trim();

        if (!user || !content || communitySubmittingComment) return;

        if (content.length > 280) {
            alert('Comment must be 280 characters or less.');
            return;
        }

        setCommunitySubmittingComment(true);

        try {
            const userDoc = await db.collection('users').doc(user.uid).get();
            const userData = userDoc.data();
            const displayName = userData?.firstName ?
                `${userData.firstName} ${userData.lastName || ''}`.trim() :
                user.displayName || user.email;

            await db.collection('messages').doc(messageId).collection('comments').add({
                userId: user.uid,
                userDisplayName: displayName,
                userAvatar: null,
                content: content,
                isAnonymous: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                reactions: { heart: 0 },
                flagged: false
            });

            await db.collection('messages').doc(messageId).update({
                commentCount: firebase.firestore.FieldValue.increment(1)
            });

            setCommunityCommentText(prev => ({ ...prev, [messageId]: '' }));

            if (window.GLRSApp?.utils?.triggerHaptic) {
                window.GLRSApp.utils.triggerHaptic('light');
            }

        } catch (error) {
            console.error('Error adding community comment:', error);
            window.handleFirebaseError && window.handleFirebaseError(error, 'CommunityTab.handleAddCommunityComment');
            alert('Failed to add comment. Please try again.');
        } finally {
            setCommunitySubmittingComment(false);
        }
    };

    // Delete community message comment
    const handleDeleteCommunityComment = async (messageId, commentId, commentUserId) => {
        if (commentUserId !== user?.uid && !isCoachOrAdmin()) {
            alert('You can only delete your own comments.');
            return;
        }

        if (!confirm('Delete this comment?')) return;

        try {
            await db.collection('messages').doc(messageId).collection('comments').doc(commentId).delete();
            await db.collection('messages').doc(messageId).update({
                commentCount: firebase.firestore.FieldValue.increment(-1)
            });

            if (window.GLRSApp?.utils?.triggerHaptic) {
                window.GLRSApp.utils.triggerHaptic('light');
            }

        } catch (error) {
            console.error('Error deleting community comment:', error);
            window.handleFirebaseError && window.handleFirebaseError(error, 'CommunityTab.handleDeleteCommunityComment');
            alert('Failed to delete comment. Please try again.');
        }
    };

    // Upload image with automatic retry logic (PHASE 4)
    const uploadImageWithRetry = async (file, onProgress, maxRetries = 3) => {
        let lastError;

        for (let attempt = 0; attempt < maxRetries; attempt++) {
            try {
                if (attempt > 0) {
                    console.log(`ðŸ”„ Retry attempt ${attempt + 1}/${maxRetries}...`);
                }

                // Attempt upload
                const result = await uploadImage(file, onProgress);

                // Success!
                if (attempt > 0) {
                    console.log(`âœ… Upload succeeded on retry ${attempt + 1}`);
                }
                return result;

            } catch (error) {
                lastError = error;
                console.error(`âŒ Upload attempt ${attempt + 1} failed:`, error.message);

                // Don't retry on certain errors (fatal errors)
                if (error.message.includes('Permission denied') ||
                    error.message.includes('canceled') ||
                    error.message.includes('unauthorized') ||
                    error.message.includes('quota')) {
                    console.log('â›” Fatal error - not retrying');
                    throw error;
                }

                // If not last attempt, wait before retry
                if (attempt < maxRetries - 1) {
                    // Exponential backoff: 1s â†’ 2s â†’ 4s (with random jitter)
                    const baseDelay = 1000; // 1 second
                    const exponentialDelay = baseDelay * Math.pow(2, attempt);
                    const jitter = Math.random() * 1000; // 0-1 second random
                    const totalDelay = exponentialDelay + jitter;

                    console.log(`â³ Waiting ${Math.round(totalDelay / 1000)}s before retry...`);
                    await new Promise(resolve => setTimeout(resolve, totalDelay));
                }
            }
        }

        // All retries failed
        console.error(`âŒ Upload failed after ${maxRetries} attempts`);
        throw new Error(`Upload failed after ${maxRetries} attempts: ${lastError.message}`);
    };

    // Upload image to Firebase Storage with progress tracking (PHASE 3)
    const uploadImage = async (file, onProgress) => {
        if (!file || !user) {
            return { url: null, name: null };
        }

        try {
            // STEP 1: Compress image
            console.log(`ðŸ“¦ Compressing image: ${file.name}...`);
            const compressedBlob = await compressImage(file);

            // STEP 2: Convert Blob to File (workaround for Firebase SDK)
            const timestamp = Date.now();
            const filename = `${timestamp}_${file.name}`;
            const compressedFile = new File([compressedBlob], filename, {
                type: 'image/jpeg',
                lastModified: Date.now()
            });

            console.log(`ðŸ“¦ Converted blob to file: ${compressedFile.name}, size: ${(compressedFile.size / 1024).toFixed(1)}KB, type: ${compressedFile.type}`);

            // STEP 3: Prepare Firebase Storage reference
            const storageRef = firebase.storage().ref();
            const imageRef = storageRef.child(`dailyPosts/${user.uid}/${filename}`);

            console.log(`ðŸ“¤ Uploading compressed file: ${filename}`);

            // STEP 4: Upload with progress tracking (resumable)
            const uploadTask = imageRef.put(compressedFile, {
                contentType: 'image/jpeg',
                cacheControl: 'public, max-age=31536000' // 1 year CDN cache
            });

            // STEP 4: Track progress and handle completion
            return new Promise((resolve, reject) => {
                uploadTask.on('state_changed',
                    // Progress callback
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log(`ðŸ“Š Upload progress: ${Math.round(progress)}%`);
                        if (onProgress) onProgress(progress);
                    },

                    // Error callback
                    (error) => {
                        console.error('âŒ Upload error:', error);
                        console.error('Error code:', error.code);
                        console.error('Error message:', error.message);
                        console.error('Full error object:', JSON.stringify(error, null, 2));

                        // Try to get server response details
                        if (error.serverResponse) {
                            console.error('Server response:', error.serverResponse);
                        }
                        if (error.customData) {
                            console.error('Custom data:', error.customData);
                        }

                        // Handle specific Firebase Storage errors
                        if (error.code === 'storage/unauthorized') {
                            reject(new Error('Permission denied. Firebase Storage rules may not be configured correctly.'));
                        } else if (error.code === 'storage/canceled') {
                            reject(new Error('Upload was canceled'));
                        } else if (error.code === 'storage/quota-exceeded') {
                            reject(new Error('Storage quota exceeded. Please contact support.'));
                        } else if (error.code === 'storage/retry-limit-exceeded') {
                            reject(new Error('Upload failed after multiple retries. Please check your connection.'));
                        } else {
                            reject(new Error(`Upload failed: ${error.message}`));
                        }
                    },

                    // Success callback
                    async () => {
                        try {
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            console.log(`âœ… Upload complete!`);
                            console.log(`ðŸ”— Download URL: ${downloadURL}`);
                            resolve({ url: downloadURL, name: file.name });
                        } catch (error) {
                            console.error('âŒ Failed to get download URL:', error);
                            reject(new Error(`Failed to get download URL: ${error.message}`));
                        }
                    }
                );
            });

        } catch (error) {
            console.error('âŒ Error in uploadImage function:', error);
            throw error;
        }
    };

    // Handle reaction to My Day post (with Firestore transaction)
    const handleReaction = async (postId, reactionType) => {
        if (!user) {
            alert('Please sign in to react to posts.');
            return;
        }

        try {
            const postRef = db.collection('dailyPosts').doc(postId);

            await db.runTransaction(async (transaction) => {
                const postDoc = await transaction.get(postRef);

                if (!postDoc.exists) {
                    throw new Error('Post not found');
                }

                const postData = postDoc.data();
                const currentReaction = postData.reactedBy?.[user.uid];

                // Initialize reactions object if it doesn't exist
                const reactions = postData.reactions || { heart: [], support: [], celebrate: [] };
                const reactedBy = postData.reactedBy || {};

                if (currentReaction === reactionType) {
                    // Scenario 2: Remove reaction (toggle off)
                    // Remove user from reaction array
                    reactions[reactionType] = (reactions[reactionType] || []).filter(uid => uid !== user.uid);
                    delete reactedBy[user.uid];
                } else if (currentReaction) {
                    // Scenario 3: Change reaction
                    // Remove from old reaction array
                    reactions[currentReaction] = (reactions[currentReaction] || []).filter(uid => uid !== user.uid);
                    // Add to new reaction array
                    if (!reactions[reactionType].includes(user.uid)) {
                        reactions[reactionType].push(user.uid);
                    }
                    reactedBy[user.uid] = reactionType;
                } else {
                    // Scenario 1: Add new reaction
                    if (!reactions[reactionType].includes(user.uid)) {
                        reactions[reactionType].push(user.uid);
                    }
                    reactedBy[user.uid] = reactionType;
                }

                // Update post with new reactions
                transaction.update(postRef, {
                    reactions,
                    reactedBy
                });
            });

            // Haptic feedback (utility function handles Safari iOS detection)
            if (window.GLRSApp?.utils?.triggerHaptic) {
                window.GLRSApp.utils.triggerHaptic('light');
            }

        } catch (error) {
            console.error('Error handling reaction:', error);
            window.handleFirebaseError && window.handleFirebaseError(error, 'CommunityTab.handleReaction');
            alert('Failed to update reaction. Please try again.');
        }
    };

    // Handle reaction to Community message (same logic as My Day)
    const handleCommunityReaction = async (messageId, reactionType) => {
        if (!user) {
            alert('Please sign in to react to messages.');
            return;
        }

        try {
            const messageRef = db.collection('messages').doc(messageId);

            await db.runTransaction(async (transaction) => {
                const messageDoc = await transaction.get(messageRef);

                if (!messageDoc.exists) {
                    throw new Error('Message not found');
                }

                const messageData = messageDoc.data();
                const currentReaction = messageData.reactedBy?.[user.uid];

                const reactions = messageData.reactions || { heart: [], support: [], celebrate: [] };
                const reactedBy = messageData.reactedBy || {};

                if (currentReaction === reactionType) {
                    reactions[reactionType] = (reactions[reactionType] || []).filter(uid => uid !== user.uid);
                    delete reactedBy[user.uid];
                } else if (currentReaction) {
                    reactions[currentReaction] = (reactions[currentReaction] || []).filter(uid => uid !== user.uid);
                    if (!reactions[reactionType].includes(user.uid)) {
                        reactions[reactionType].push(user.uid);
                    }
                    reactedBy[user.uid] = reactionType;
                } else {
                    if (!reactions[reactionType].includes(user.uid)) {
                        reactions[reactionType].push(user.uid);
                    }
                    reactedBy[user.uid] = reactionType;
                }

                transaction.update(messageRef, {
                    reactions,
                    reactedBy
                });
            });

            if (window.GLRSApp?.utils?.triggerHaptic) {
                window.GLRSApp.utils.triggerHaptic('light');
            }

        } catch (error) {
            console.error('Error handling community reaction:', error);
            window.handleFirebaseError && window.handleFirebaseError(error, 'CommunityTab.handleCommunityReaction');
            alert('Failed to update reaction. Please try again.');
        }
    };

    // Submit My Day post
    const handleMyDaySubmit = async () => {
        if (!user || !myDayContent.trim() || myDaySubmitting) return;

        // Validate content length
        if (myDayContent.length > 500) {
            alert('Post content must be 500 characters or less.');
            return;
        }

        setMyDaySubmitting(true);
        let uploadedImageRef = null; // PHASE 6: Track uploaded file for cleanup

        try {
            // STEP 1: Get user data for display name
            console.log('ðŸ“ Step 1: Loading user data...');
            const userDoc = await db.collection('users').doc(user.uid).get();
            const userData = userDoc.data();

            // STEP 2: Upload image FIRST (if present) - CRITICAL: Must complete before post creation
            let imageData = { url: null, name: null };
            if (myDayImage) {
                console.log('ðŸ“¤ Step 2: Uploading image...');
                setUploadingImage(true);

                try {
                    // PHASE 5: Use retry logic with progress tracking
                    imageData = await uploadImageWithRetry(
                        myDayImage,
                        (progress) => {
                            setUploadProgress(progress);
                        },
                        3 // maxRetries
                    );

                    // PHASE 6: Store Firebase Storage reference for potential cleanup
                    uploadedImageRef = firebase.storage().refFromURL(imageData.url);

                    console.log('âœ… Image upload complete:', imageData);
                } catch (uploadError) {
                    // If image upload fails, abort post creation
                    console.error('âŒ Image upload failed:', uploadError);
                    setUploadingImage(false);
                    setMyDaySubmitting(false);
                    setUploadProgress(0); // PHASE 5: Reset progress on error

                    // PHASE 6: User-friendly error messages based on error type
                    let errorMessage = 'Image upload failed. ';
                    if (uploadError.message.includes('Permission denied')) {
                        errorMessage += 'Storage permissions are not configured. Please contact support.';
                    } else if (uploadError.message.includes('quota')) {
                        errorMessage += 'Storage limit reached. Please try a smaller image.';
                    } else if (uploadError.message.includes('canceled')) {
                        errorMessage += 'Upload was canceled.';
                    } else {
                        errorMessage += 'Please check your connection and try again.';
                    }

                    alert(errorMessage);
                    return; // ABORT - don't create post without image
                }

                setUploadingImage(false);
            }

            // STEP 3: Create post document (with cleanup on failure) - PHASE 6
            console.log('ðŸ’¾ Step 3: Creating post document...');

            try {
                await db.collection('dailyPosts').add({
                    userId: user.uid,
                    displayName: myDayAnonymous ? 'Anonymous' : (userData?.firstName ? `${userData.firstName} ${userData.lastName || ''}`.trim() : user.displayName || user.email),
                    content: myDayContent.trim(),
                    type: myDayPostType,
                    anonymous: myDayAnonymous,
                    hidden: false,
                    imageUrl: imageData.url,
                    imageName: imageData.name,
                    reactions: {
                        heart: [],
                        support: [],
                        celebrate: []
                    },
                    reactedBy: {},
                    commentCount: 0,
                    replyCount: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

            console.log('âœ… Post created successfully');

            // STEP 4: Success - reset form and close modal
            setMyDayContent('');
            setMyDayPostType('reflection');
            setMyDayAnonymous(false);
            setMyDayImage(null);
            setMyDayImagePreview(null);
            setShowMyDayModal(false);

            // Show success notification
            if (window.GLRSApp?.utils?.showNotification) {
                window.GLRSApp.utils.showNotification('Post shared successfully!', 'success');
            }

            } catch (firestoreError) {
                // PHASE 6: CLEANUP - Delete uploaded image if post creation failed
                console.error('âŒ Firestore write failed:', firestoreError);

                if (uploadedImageRef) {
                    console.log('ðŸ—‘ï¸ Attempting to clean up orphaned image...');
                    try {
                        await uploadedImageRef.delete();
                        console.log('âœ… Cleaned up orphaned image successfully');
                    } catch (cleanupError) {
                        console.error('âš ï¸ Cleanup failed - image orphaned in Storage:', cleanupError);
                        console.error('Orphaned file path:', uploadedImageRef.fullPath);
                        console.error('Orphaned file URL:', await uploadedImageRef.getDownloadURL().catch(() => 'URL unavailable'));
                    }
                }

                // Re-throw to hit outer catch block for user notification
                throw new Error(`Failed to create post: ${firestoreError.message}`);
            }

        } catch (error) {
            console.error('âŒ Error creating My Day post:', error);
            window.handleFirebaseError && window.handleFirebaseError(error, 'CommunityTab.handleMyDaySubmit');
            alert(`Failed to create post: ${error.message}`);
        } finally {
            setMyDaySubmitting(false);
            setUploadingImage(false);
            setUploadProgress(0); // PHASE 5: Reset progress
        }
    };

    // Show loading state
    if (loading && !user) {
        return (
            <div style={{
                display: 'flex',
                justifyContent: 'center',
                alignItems: 'center',
                height: '100vh',
                flexDirection: 'column',
                gap: '16px'
            }}>
                <div className="spinner" style={{
                    width: '40px',
                    height: '40px',
                    border: '4px solid #f3f3f3',
                    borderTop: '4px solid #058585',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite'
                }}></div>
                <p style={{ color: '#666', fontSize: '14px' }}>Loading Community...</p>
            </div>
        );
    }

    // Show error state
    if (error) {
        return (
            <div style={{
                display: 'flex',
                justifyContent: 'center',
                alignItems: 'center',
                height: '100vh',
                flexDirection: 'column',
                gap: '16px',
                padding: '20px'
            }}>
                <i data-lucide="alert-circle" style={{ width: '48px', height: '48px', color: '#ef4444' }}></i>
                <p style={{ color: '#ef4444', fontSize: '16px', fontWeight: 'bold' }}>Error</p>
                <p style={{ color: '#666', fontSize: '14px', textAlign: 'center' }}>{error}</p>
                <button
                    onClick={() => window.location.reload()}
                    style={{
                        padding: '10px 20px',
                        background: '#058585',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontSize: '14px'
                    }}
                >
                    Retry
                </button>
            </div>
        );
    }

    // PHASE 4: Show UserProfileView if viewing a user's profile
    if (viewingUserProfile) {
        const UserProfileView = window.UserProfileView;

        if (!UserProfileView) {
            console.error('âŒ UserProfileView component not loaded');
            setViewingUserProfile(null);
            return null;
        }

        return (
            <UserProfileView
                userId={viewingUserProfile}
                currentUser={user}
                userData={currentUserData}
                onBack={() => setViewingUserProfile(null)}
            />
        );
    }

    return (
        <div className="section-content">
            {/* Connect Header - Fixed at top */}
            <div style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                height: '48px',
                background: '#058585',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                padding: '0 12px',
                zIndex: 100,
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
            }}>
                {/* LEFT: Hamburger Menu + Connect Title */}
                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                    <button
                        onClick={() => {
                            if (window.GLRSApp?.utils?.triggerHaptic) window.GLRSApp.utils.triggerHaptic('light');
                            setShowSidebar(true);
                        }}
                        style={{
                            background: 'transparent',
                            border: 'none',
                            cursor: 'pointer',
                            padding: '8px',
                            borderRadius: '50%',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            transition: 'background 0.2s',
                            minWidth: '40px',
                            minHeight: '40px'
                        }}
                        onMouseOver={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.1)'}
                        onMouseOut={(e) => e.currentTarget.style.background = 'transparent'}
                    >
                        <i data-lucide="menu" style={{ width: '24px', height: '24px', color: '#FFFFFF' }}></i>
                    </button>

                    <h1 style={{
                        color: '#FFFFFF',
                        fontSize: '18px',
                        fontWeight: 'bold',
                        margin: 0
                    }}>
                        Connect
                    </h1>
                </div>

                {/* RIGHT: Search Icon + Profile Icon */}
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                    {/* Search Button */}
                    <button
                        onClick={() => setShowBrowser(true)}
                        style={{
                            background: 'transparent',
                            border: 'none',
                            cursor: 'pointer',
                            padding: '8px',
                            borderRadius: '50%',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            transition: 'background 0.2s',
                            minWidth: '40px',
                            minHeight: '40px'
                        }}
                        onMouseOver={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.1)'}
                        onMouseOut={(e) => e.currentTarget.style.background = 'transparent'}
                    >
                        <i data-lucide="search" style={{ width: '24px', height: '24px', color: '#FFFFFF' }}></i>
                    </button>

                    {/* Profile Button */}
                    <button
                        onClick={() => {
                            if (window.GLRSApp?.utils?.triggerHaptic) window.GLRSApp.utils.triggerHaptic('light');
                            if (window.navigateToTab) {
                                window.navigateToTab('profile');
                            }
                        }}
                        style={{
                            background: 'transparent',
                            border: 'none',
                            cursor: 'pointer',
                            padding: '8px',
                            borderRadius: '50%',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            transition: 'background 0.2s',
                            minWidth: '40px',
                            minHeight: '40px'
                        }}
                        onMouseOver={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.1)'}
                        onMouseOut={(e) => e.currentTarget.style.background = 'transparent'}
                    >
                        <i data-lucide="user" style={{ width: '24px', height: '24px', color: '#FFFFFF' }}></i>
                    </button>
                </div>
            </div>

            {/* Tab Navigation - Fixed position, below Community header */}
            <div style={{
                background: '#058585',
                display: 'flex',
                justifyContent: 'space-around',
                alignItems: 'center',
                height: '48px',
                position: 'fixed',
                top: '48px',
                left: 0,
                right: 0,
                zIndex: 99,
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
            }}>
                <button
                    onClick={() => {
                        if (window.GLRSApp?.utils?.triggerHaptic) window.GLRSApp.utils.triggerHaptic('light');
                        setActiveChat('main');
                    }}
                    style={{
                        flex: 1,
                        height: '100%',
                        background: 'none',
                        border: 'none',
                        color: activeChat === 'main' ? '#FFFFFF' : 'rgba(255,255,255,0.7)',
                        fontSize: '14px',
                        fontWeight: activeChat === 'main' ? 'bold' : '400',
                        cursor: 'pointer',
                        position: 'relative',
                        transition: 'all 0.2s'
                    }}
                >
                    GLRS Community
                    {activeChat === 'main' && (
                        <div style={{
                            position: 'absolute',
                            bottom: 0,
                            left: '50%',
                            transform: 'translateX(-50%)',
                            width: '60%',
                            height: '2px',
                            background: '#FFFFFF'
                        }} />
                    )}
                </button>

                <button
                    onClick={() => {
                        if (window.GLRSApp?.utils?.triggerHaptic) window.GLRSApp.utils.triggerHaptic('light');
                        setActiveChat('myday');
                    }}
                    style={{
                        flex: 1,
                        height: '100%',
                        background: 'none',
                        border: 'none',
                        color: activeChat === 'myday' ? '#FFFFFF' : 'rgba(255,255,255,0.7)',
                        fontSize: '14px',
                        fontWeight: activeChat === 'myday' ? 'bold' : '400',
                        cursor: 'pointer',
                        position: 'relative',
                        transition: 'all 0.2s'
                    }}
                >
                    My Day
                    {activeChat === 'myday' && (
                        <div style={{
                            position: 'absolute',
                            bottom: 0,
                            left: '50%',
                            transform: 'translateX(-50%)',
                            width: '60%',
                            height: '2px',
                            background: '#FFFFFF'
                        }} />
                    )}
                </button>

                <button
                    onClick={() => {
                        if (window.GLRSApp?.utils?.triggerHaptic) window.GLRSApp.utils.triggerHaptic('light');
                        setActiveChat('groups');
                    }}
                    style={{
                        flex: 1,
                        height: '100%',
                        background: 'none',
                        border: 'none',
                        color: activeChat === 'groups' ? '#FFFFFF' : 'rgba(255,255,255,0.7)',
                        fontSize: '14px',
                        fontWeight: activeChat === 'groups' ? 'bold' : '400',
                        cursor: 'pointer',
                        position: 'relative',
                        transition: 'all 0.2s'
                    }}
                >
                    Support Groups
                    {activeChat === 'groups' && (
                        <div style={{
                            position: 'absolute',
                            bottom: 0,
                            left: '50%',
                            transform: 'translateX(-50%)',
                            width: '60%',
                            height: '2px',
                            background: '#FFFFFF'
                        }} />
                    )}
                </button>

                {/* Phase 6: Meetings button removed - functionality moved to MeetingsTab */}
            </div>

            {/* Content wrapper with top padding to account for fixed header */}
            <div style={{paddingTop: '68px'}}>

            {activeChat === 'main' && (
                <CommunityChat
                    messages={communityMessages}
                    onSendMessage={sendCommunityMessage}
                    currentUserId={user?.uid}
                    uploadChatImage={uploadChatImage}
                    flagContent={flagContent}
                    setModalImage={setModalImage}
                    onReaction={handleCommunityReaction}
                    currentUser={user}
                    currentUserData={currentUserData}
                    showComments={communityShowComments}
                    toggleComments={toggleCommunityComments}
                    commentText={communityCommentText}
                    setCommentText={setCommunityCommentText}
                    postComments={communityComments}
                    loadingComments={communityLoadingComments}
                    submittingComment={communitySubmittingComment}
                    handleAddComment={handleAddCommunityComment}
                    handleDeleteComment={handleDeleteCommunityComment}
                    handleDeletePost={handleDeletePost}
                    handleReportPost={handleReportPost}
                    isCoachOrAdmin={isCoachOrAdmin}
                    formatMyDayTimestamp={formatMyDayTimestamp}
                    isAnonymous={communityAnonymous}
                    setIsAnonymous={setCommunityAnonymous}
                    handleAvatarClick={handleAvatarClick}
                    isMobile={isMobile}
                />
            )}

            {activeChat === 'myday' && (
                <div style={{ background: '#F0F2F5', padding: '0 20px', minHeight: 'calc(100vh - 140px)' }}>
                    {/* Create Post Card */}
                    <div style={{
                        background: '#FFFFFF',
                        borderRadius: '8px',
                        padding: '16px',
                        marginBottom: '12px',
                        boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                        textAlign: 'center'
                    }}>
                        <h3 style={{ color: '#333', marginBottom: '8px', fontSize: '16px', fontWeight: 'bold' }}>Share Your Day</h3>
                        <p style={{ color: '#666', fontSize: '13px', marginBottom: '16px', lineHeight: '1.4' }}>
                            Share reflections on your recovery journey or celebrate daily wins with the community.
                        </p>
                        <button
                            onClick={() => setShowMyDayModal(true)}
                            style={{
                                padding: '10px 24px',
                                background: 'linear-gradient(135deg, #058585, #069494)',
                                border: 'none',
                                borderRadius: '8px',
                                color: '#fff',
                                fontSize: '14px',
                                fontWeight: 'bold',
                                cursor: 'pointer',
                                display: 'inline-flex',
                                alignItems: 'center',
                                gap: '8px',
                                boxShadow: '0 2px 8px rgba(5,133,133,0.3)',
                                transition: 'transform 0.2s ease'
                            }}
                            onMouseOver={(e) => e.currentTarget.style.transform = 'translateY(-1px)'}
                            onMouseOut={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                        >
                            <i data-lucide="plus-circle" style={{ width: '18px', height: '18px' }}></i>
                            Create Post
                        </button>
                    </div>

                    {/* Filter Chips */}
                    <div style={{
                        display: 'flex',
                        gap: '12px',
                        marginBottom: '12px',
                        overflowX: 'auto',
                        paddingBottom: '4px'
                    }}>
                        <button
                            onClick={() => setMyDayFilter('all')}
                            style={{
                                padding: '8px 16px',
                                background: myDayFilter === 'all' ? '#069494' : '#FFFFFF',
                                color: myDayFilter === 'all' ? '#FFFFFF' : '#65676B',
                                border: myDayFilter === 'all' ? 'none' : '1px solid #CCD0D5',
                                borderRadius: '20px',
                                fontSize: '13px',
                                fontWeight: '600',
                                cursor: 'pointer',
                                whiteSpace: 'nowrap',
                                transition: 'all 0.2s ease',
                                boxShadow: myDayFilter === 'all' ? '0 2px 4px rgba(6,148,148,0.3)' : 'none'
                            }}
                        >
                            Show All
                        </button>
                        <button
                            onClick={() => setMyDayFilter('reflections')}
                            style={{
                                padding: '8px 16px',
                                background: myDayFilter === 'reflections' ? '#069494' : '#FFFFFF',
                                color: myDayFilter === 'reflections' ? '#FFFFFF' : '#65676B',
                                border: myDayFilter === 'reflections' ? 'none' : '1px solid #CCD0D5',
                                borderRadius: '20px',
                                fontSize: '13px',
                                fontWeight: '600',
                                cursor: 'pointer',
                                whiteSpace: 'nowrap',
                                transition: 'all 0.2s ease',
                                boxShadow: myDayFilter === 'reflections' ? '0 2px 4px rgba(6,148,148,0.3)' : 'none'
                            }}
                        >
                            ðŸ’­ Reflections
                        </button>
                        <button
                            onClick={() => setMyDayFilter('wins')}
                            style={{
                                padding: '8px 16px',
                                background: myDayFilter === 'wins' ? '#069494' : '#FFFFFF',
                                color: myDayFilter === 'wins' ? '#FFFFFF' : '#65676B',
                                border: myDayFilter === 'wins' ? 'none' : '1px solid #CCD0D5',
                                borderRadius: '20px',
                                fontSize: '13px',
                                fontWeight: '600',
                                cursor: 'pointer',
                                whiteSpace: 'nowrap',
                                transition: 'all 0.2s ease',
                                boxShadow: myDayFilter === 'wins' ? '0 2px 4px rgba(6,148,148,0.3)' : 'none'
                            }}
                        >
                            ðŸŽ‰ Wins
                        </button>
                        <button
                            onClick={() => setMyDayFilter('mine')}
                            style={{
                                padding: '8px 16px',
                                background: myDayFilter === 'mine' ? '#069494' : '#FFFFFF',
                                color: myDayFilter === 'mine' ? '#FFFFFF' : '#65676B',
                                border: myDayFilter === 'mine' ? 'none' : '1px solid #CCD0D5',
                                borderRadius: '20px',
                                fontSize: '13px',
                                fontWeight: '600',
                                cursor: 'pointer',
                                whiteSpace: 'nowrap',
                                transition: 'all 0.2s ease',
                                boxShadow: myDayFilter === 'mine' ? '0 2px 4px rgba(6,148,148,0.3)' : 'none'
                            }}
                        >
                            My Posts
                        </button>
                    </div>

                    {/* Loading State */}
                    {myDayLoading && (
                        <div style={{
                            background: '#FFFFFF',
                            borderRadius: '8px',
                            padding: '40px',
                            textAlign: 'center',
                            boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
                        }}>
                            <div style={{
                                width: '40px',
                                height: '40px',
                                border: '4px solid #f3f3f3',
                                borderTop: '4px solid #069494',
                                borderRadius: '50%',
                                animation: 'spin 1s linear infinite',
                                margin: '0 auto 16px'
                            }}></div>
                            <p style={{ color: '#65676B', fontSize: '14px', margin: 0 }}>Loading posts...</p>
                        </div>
                    )}

                    {/* Feed - Empty State */}
                    {!myDayLoading && getFilteredPosts().length === 0 && (
                        <div style={{
                            background: '#FFFFFF',
                            borderRadius: '8px',
                            padding: '40px',
                            textAlign: 'center',
                            boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
                        }}>
                            <div style={{ fontSize: '48px', marginBottom: '12px' }}>ðŸ’­</div>
                            <h4 style={{ color: '#333', fontSize: '16px', fontWeight: 'bold', marginBottom: '8px' }}>
                                No posts yet
                            </h4>
                            <p style={{ color: '#65676B', fontSize: '13px', margin: 0 }}>
                                Be the first to share your reflection or win!
                            </p>
                        </div>
                    )}

                    {/* Feed - Post Cards */}
                    {!myDayLoading && getFilteredPosts().map(post => {
                        const isAnonymous = post.anonymous;
                        const showRealName = isCoachOrAdmin();
                        const displayName = (isAnonymous && !showRealName) ? 'Anonymous' : post.displayName;
                        const isOwnPost = post.userId === user?.uid;

                        return (
                            <div
                                key={post.id}
                                style={{
                                    background: '#FFFFFF',
                                    borderRadius: '8px',
                                    padding: isMobile ? '12px' : '16px',
                                    marginBottom: '12px',
                                    boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
                                }}
                            >
                                {/* Post Header */}
                                <div style={{
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: isMobile ? 'flex-start' : 'center',
                                    flexDirection: isMobile ? 'column' : 'row',
                                    gap: isMobile ? '8px' : '0',
                                    marginBottom: '12px'
                                }}>
                                    {/* Left: Avatar + User Info */}
                                    <div style={{
                                        display: 'flex',
                                        alignItems: 'flex-start',
                                        gap: isMobile ? '8px' : '12px',
                                        flex: isMobile ? 1 : 'unset',
                                        width: isMobile ? '100%' : 'auto',
                                        minWidth: 0
                                    }}>
                                        {/* Avatar - CLICKABLE (PHASE 4) */}
                                        <div
                                            onClick={() => handleAvatarClick(post.userId, isAnonymous && !showRealName)}
                                            style={{
                                                width: isMobile ? '36px' : '40px',
                                                height: isMobile ? '36px' : '40px',
                                                borderRadius: '50%',
                                                background: isAnonymous && !showRealName
                                                    ? '#CCD0D5'
                                                    : 'linear-gradient(135deg, #069494, #058585)',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                color: '#fff',
                                                fontSize: isMobile ? '16px' : '18px',
                                                fontWeight: 'bold',
                                                flexShrink: 0,
                                                cursor: (isAnonymous && !showRealName) ? 'default' : 'pointer',
                                                transition: 'transform 0.2s ease'
                                            }}
                                            onMouseEnter={(e) => {
                                                if (!(isAnonymous && !showRealName)) {
                                                    e.currentTarget.style.transform = 'scale(1.05)';
                                                }
                                            }}
                                            onMouseLeave={(e) => {
                                                e.currentTarget.style.transform = 'scale(1)';
                                            }}
                                        >
                                            {isAnonymous && !showRealName ? 'ðŸ‘¤' : (displayName?.[0] || '?').toUpperCase()}
                                        </div>

                                        {/* User Info */}
                                        <div style={{ flex: 1, minWidth: 0 }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '4px' }}>
                                            {/* Display Name - CLICKABLE (PHASE 4) */}
                                            <span
                                                onClick={() => handleAvatarClick(post.userId, isAnonymous && !showRealName)}
                                                style={{
                                                    color: '#050505',
                                                    fontSize: '15px',
                                                    fontWeight: '600',
                                                    overflow: 'hidden',
                                                    textOverflow: 'ellipsis',
                                                    whiteSpace: 'nowrap',
                                                    cursor: (isAnonymous && !showRealName) ? 'default' : 'pointer',
                                                    transition: 'color 0.2s ease'
                                                }}
                                                onMouseEnter={(e) => {
                                                    if (!(isAnonymous && !showRealName)) {
                                                        e.currentTarget.style.color = '#069494';
                                                    }
                                                }}
                                                onMouseLeave={(e) => {
                                                    e.currentTarget.style.color = '#050505';
                                                }}
                                            >
                                                {displayName}
                                            </span>
                                            {isAnonymous && showRealName && (
                                                <span style={{
                                                    fontSize: '11px',
                                                    color: '#65676B',
                                                    background: '#F0F2F5',
                                                    padding: '2px 6px',
                                                    borderRadius: '4px',
                                                    display: 'inline-flex',
                                                    alignItems: 'center',
                                                    gap: '4px'
                                                }}>
                                                    ðŸ”’ Real: {post.displayName}
                                                </span>
                                            )}
                                        </div>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            {/* Type Badge */}
                                            <span style={{
                                                fontSize: '12px',
                                                fontWeight: '600',
                                                padding: '2px 6px',
                                                borderRadius: '12px',
                                                background: post.type === 'reflection' ? '#E7F3FF' : '#FFF4E6',
                                                color: post.type === 'reflection' ? '#1877F2' : '#E67E22',
                                                display: 'inline-flex',
                                                alignItems: 'center',
                                                gap: '4px'
                                            }}>
                                                {post.type === 'reflection' ? 'ðŸ’­' : 'ðŸŽ‰'}
                                                {post.type === 'reflection' ? 'Reflection' : 'Win'}
                                            </span>
                                            {/* Timestamp */}
                                            <span style={{ fontSize: '12px', color: '#65676B' }}>
                                                {formatMyDayTimestamp(post.createdAt)}
                                            </span>
                                        </div>
                                    </div>
                                    </div>

                                    {/* Three-Dot Menu */}
                                    <div style={{ position: 'relative' }}>
                                        <button
                                            data-post-menu-button
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                setOpenPostMenu(openPostMenu === post.id ? null : post.id);
                                            }}
                                            style={{
                                                background: 'transparent',
                                                border: 'none',
                                                cursor: 'pointer',
                                                padding: '8px',
                                                color: '#65676B',
                                                fontSize: '20px',
                                                lineHeight: 1,
                                                alignSelf: isMobile ? 'flex-end' : 'auto'
                                            }}
                                            title="More options"
                                        >
                                            â‹¯
                                        </button>

                                        {/* Dropdown Menu */}
                                        {openPostMenu === post.id && (
                                            <div
                                                data-post-menu-dropdown
                                                style={{
                                                    position: 'absolute',
                                                    top: '100%',
                                                    right: 0,
                                                    background: '#FFFFFF',
                                                    border: '1px solid #CCD0D5',
                                                    borderRadius: '8px',
                                                    boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                                                    minWidth: '180px',
                                                    zIndex: 1000,
                                                    overflow: 'hidden'
                                                }}
                                            >
                                                {/* Delete Post - Show if own post OR coach/admin */}
                                                {(post.userId === user?.uid || isCoachOrAdmin()) && (
                                                    <button
                                                        onClick={() => handleDeletePost(post.id, post)}
                                                        style={{
                                                            width: '100%',
                                                            padding: '12px 16px',
                                                            background: 'transparent',
                                                            border: 'none',
                                                            textAlign: 'left',
                                                            cursor: 'pointer',
                                                            color: '#F02849',
                                                            fontSize: '15px',
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            gap: '12px'
                                                        }}
                                                        onMouseEnter={(e) => e.target.style.background = '#F0F2F5'}
                                                        onMouseLeave={(e) => e.target.style.background = 'transparent'}
                                                    >
                                                        <i data-lucide="trash-2" style={{width: '18px', height: '18px'}}></i>
                                                        Delete Post
                                                    </button>
                                                )}

                                                {/* Report Post - Show for everyone */}
                                                <button
                                                    onClick={() => handleReportPost(post.id, post)}
                                                    style={{
                                                        width: '100%',
                                                        padding: '12px 16px',
                                                        background: 'transparent',
                                                        border: 'none',
                                                        textAlign: 'left',
                                                        cursor: 'pointer',
                                                        color: '#050505',
                                                        fontSize: '15px',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: '12px'
                                                    }}
                                                    onMouseEnter={(e) => e.target.style.background = '#F0F2F5'}
                                                    onMouseLeave={(e) => e.target.style.background = 'transparent'}
                                                >
                                                    <i data-lucide="alert-triangle" style={{width: '18px', height: '18px'}}></i>
                                                    Report Post
                                                </button>

                                                {/* Block User - Show if not own post AND not anonymous */}
                                                {post.userId !== user?.uid && !post.anonymous && (
                                                    <button
                                                        onClick={() => handleBlockUser(post)}
                                                        style={{
                                                            width: '100%',
                                                            padding: '12px 16px',
                                                            background: 'transparent',
                                                            border: 'none',
                                                            textAlign: 'left',
                                                            cursor: 'pointer',
                                                            color: '#F02849',
                                                            fontSize: '15px',
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            gap: '12px'
                                                        }}
                                                        onMouseEnter={(e) => e.target.style.background = '#F0F2F5'}
                                                        onMouseLeave={(e) => e.target.style.background = 'transparent'}
                                                    >
                                                        <i data-lucide="ban" style={{width: '18px', height: '18px'}}></i>
                                                        Block User
                                                    </button>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* Post Content */}
                                <div style={{
                                    color: '#050505',
                                    fontSize: '15px',
                                    lineHeight: '20px',
                                    marginBottom: post.imageUrl ? '12px' : '12px',
                                    whiteSpace: 'pre-wrap',
                                    wordBreak: 'break-word'
                                }}>
                                    {post.content}
                                </div>

                                {/* Post Image */}
                                {post.imageUrl && (
                                    <div style={{ marginBottom: '12px' }}>
                                        <img
                                            src={post.imageUrl}
                                            alt="Post image"
                                            onClick={() => setViewingImage(post.imageUrl)}
                                            style={{
                                                width: '100%',
                                                maxWidth: isMobile ? 'none' : '600px',
                                                maxHeight: '500px',
                                                objectFit: 'contain',
                                                borderRadius: '8px',
                                                cursor: 'pointer',
                                                transition: 'opacity 0.2s ease',
                                                display: 'block'
                                            }}
                                            onMouseOver={(e) => { e.currentTarget.style.opacity = '0.9'; }}
                                            onMouseOut={(e) => { e.currentTarget.style.opacity = '1'; }}
                                        />
                                    </div>
                                )}

                                {/* Reactions Section */}
                                <div style={{
                                    paddingTop: '12px',
                                    borderTop: '1px solid #E4E6EB'
                                }}>
                                    {/* Reaction Buttons */}
                                    <div style={{
                                        display: 'flex',
                                        gap: '8px',
                                        marginBottom: '8px'
                                    }}>
                                        {/* Heart Button */}
                                        <button
                                            onClick={() => handleReaction(post.id, 'heart')}
                                            style={{
                                                flex: 1,
                                                padding: '8px',
                                                background: post.reactedBy?.[user?.uid] === 'heart' ? '#F0F2F5' : 'transparent',
                                                color: post.reactedBy?.[user?.uid] === 'heart' ? '#F02849' : '#65676B',
                                                border: 'none',
                                                borderRadius: '6px',
                                                fontSize: '15px',
                                                fontWeight: post.reactedBy?.[user?.uid] === 'heart' ? '600' : '400',
                                                cursor: 'pointer',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                gap: '6px',
                                                transition: 'all 0.2s ease',
                                                minHeight: '36px'
                                            }}
                                            onMouseOver={(e) => { e.currentTarget.style.background = '#F0F2F5'; }}
                                            onMouseOut={(e) => {
                                                e.currentTarget.style.background = post.reactedBy?.[user?.uid] === 'heart' ? '#F0F2F5' : 'transparent';
                                            }}
                                        >
                                            <span>â¤ï¸</span>
                                            <span>Heart</span>
                                            {(post.reactions?.heart?.length || 0) > 0 && (
                                                <span style={{ fontSize: '13px', opacity: 0.8 }}>
                                                    ({post.reactions.heart.length})
                                                </span>
                                            )}
                                        </button>

                                        {/* Support Button */}
                                        <button
                                            onClick={() => handleReaction(post.id, 'support')}
                                            style={{
                                                flex: 1,
                                                padding: '8px',
                                                background: post.reactedBy?.[user?.uid] === 'support' ? '#F0F2F5' : 'transparent',
                                                color: post.reactedBy?.[user?.uid] === 'support' ? '#069494' : '#65676B',
                                                border: 'none',
                                                borderRadius: '6px',
                                                fontSize: '15px',
                                                fontWeight: post.reactedBy?.[user?.uid] === 'support' ? '600' : '400',
                                                cursor: 'pointer',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                gap: '6px',
                                                transition: 'all 0.2s ease',
                                                minHeight: '36px'
                                            }}
                                            onMouseOver={(e) => { e.currentTarget.style.background = '#F0F2F5'; }}
                                            onMouseOut={(e) => {
                                                e.currentTarget.style.background = post.reactedBy?.[user?.uid] === 'support' ? '#F0F2F5' : 'transparent';
                                            }}
                                        >
                                            <span>ðŸ¤</span>
                                            <span>Support</span>
                                            {(post.reactions?.support?.length || 0) > 0 && (
                                                <span style={{ fontSize: '13px', opacity: 0.8 }}>
                                                    ({post.reactions.support.length})
                                                </span>
                                            )}
                                        </button>

                                        {/* Celebrate Button */}
                                        <button
                                            onClick={() => handleReaction(post.id, 'celebrate')}
                                            style={{
                                                flex: 1,
                                                padding: '8px',
                                                background: post.reactedBy?.[user?.uid] === 'celebrate' ? '#F0F2F5' : 'transparent',
                                                color: post.reactedBy?.[user?.uid] === 'celebrate' ? '#FFA500' : '#65676B',
                                                border: 'none',
                                                borderRadius: '6px',
                                                fontSize: '15px',
                                                fontWeight: post.reactedBy?.[user?.uid] === 'celebrate' ? '600' : '400',
                                                cursor: 'pointer',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                gap: '6px',
                                                transition: 'all 0.2s ease',
                                                minHeight: '36px'
                                            }}
                                            onMouseOver={(e) => { e.currentTarget.style.background = '#F0F2F5'; }}
                                            onMouseOut={(e) => {
                                                e.currentTarget.style.background = post.reactedBy?.[user?.uid] === 'celebrate' ? '#F0F2F5' : 'transparent';
                                            }}
                                        >
                                            <span>ðŸŽ‰</span>
                                            <span>Celebrate</span>
                                            {(post.reactions?.celebrate?.length || 0) > 0 && (
                                                <span style={{ fontSize: '13px', opacity: 0.8 }}>
                                                    ({post.reactions.celebrate.length})
                                                </span>
                                            )}
                                        </button>
                                    </div>

                                    {/* Comment Count - Clickable */}
                                    <div
                                        onClick={() => toggleComments(post.id)}
                                        style={{
                                            fontSize: '13px',
                                            color: '#069494',
                                            paddingTop: '8px',
                                            cursor: 'pointer',
                                            fontWeight: '500',
                                            display: 'inline-flex',
                                            alignItems: 'center',
                                            gap: '4px'
                                        }}
                                    >
                                        ðŸ’¬ {post.commentCount || 0} comments
                                        {showComments[post.id] ? ' â–²' : ' â–¼'}
                                    </div>
                                </div>

                                {/* Comments Section (Expandable) */}
                                {showComments[post.id] && (
                                    <div style={{
                                        paddingTop: '12px',
                                        borderTop: '1px solid #E4E6EB',
                                        marginTop: '8px'
                                    }}>
                                        {/* Comments List - TikTok-Style Threading */}
                                        {loadingComments[post.id] ? (
                                            <div style={{ padding: '20px', textAlign: 'center', color: '#65676B', fontSize: '13px' }}>
                                                Loading comments...
                                            </div>
                                        ) : (postComments[post.id] || []).length === 0 ? (
                                            <div style={{ padding: '20px', textAlign: 'center', color: '#65676B', fontSize: '13px' }}>
                                                No comments yet. Be the first to comment!
                                            </div>
                                        ) : (
                                            // Filter to show only TOP-LEVEL comments (no parent)
                                            (postComments[post.id] || [])
                                                .filter(comment => !comment.parentCommentId)
                                                .map(comment => {
                                                    const depth = 0; // Top-level = depth 0
                                                    const indentPx = depth * 32; // 32px per level
                                                    const replies = commentReplies[comment.id] || [];
                                                    const replyCount = replies.length;

                                                    return (
                                                        <div key={comment.id}>
                                                            {/* Top-Level Comment */}
                                                            <div style={{
                                                                background: '#F0F2F5',
                                                                borderRadius: '16px',
                                                                padding: '8px 12px',
                                                                marginBottom: '8px',
                                                                marginLeft: `${indentPx}px`
                                                            }}>
                                                                {/* Comment Header */}
                                                                <div style={{ display: 'flex', alignItems: 'center', marginBottom: '4px' }}>
                                                                    {/* Avatar - CLICKABLE (PHASE 4) */}
                                                                    <div
                                                                        onClick={() => handleAvatarClick(comment.userId, comment.isAnonymous)}
                                                                        style={{
                                                                            width: '24px',
                                                                            height: '24px',
                                                                            borderRadius: '50%',
                                                                            background: 'linear-gradient(135deg, #069494, #058585)',
                                                                            display: 'flex',
                                                                            alignItems: 'center',
                                                                            justifyContent: 'center',
                                                                            color: '#fff',
                                                                            fontSize: '12px',
                                                                            fontWeight: 'bold',
                                                                            marginRight: '8px',
                                                                            cursor: comment.isAnonymous ? 'default' : 'pointer',
                                                                            transition: 'transform 0.2s ease'
                                                                        }}
                                                                        onMouseEnter={(e) => {
                                                                            if (!comment.isAnonymous) {
                                                                                e.currentTarget.style.transform = 'scale(1.1)';
                                                                            }
                                                                        }}
                                                                        onMouseLeave={(e) => {
                                                                            e.currentTarget.style.transform = 'scale(1)';
                                                                        }}
                                                                    >
                                                                        {(comment.userDisplayName?.[0] || '?').toUpperCase()}
                                                                    </div>
                                                                    <div style={{ flex: 1 }}>
                                                                        {/* Display Name - CLICKABLE (PHASE 4) */}
                                                                        <span
                                                                            onClick={() => handleAvatarClick(comment.userId, comment.isAnonymous)}
                                                                            style={{
                                                                                fontSize: '13px',
                                                                                fontWeight: '600',
                                                                                color: '#050505',
                                                                                cursor: comment.isAnonymous ? 'default' : 'pointer',
                                                                                transition: 'color 0.2s ease'
                                                                            }}
                                                                            onMouseEnter={(e) => {
                                                                                if (!comment.isAnonymous) {
                                                                                    e.currentTarget.style.color = '#069494';
                                                                                }
                                                                            }}
                                                                            onMouseLeave={(e) => {
                                                                                e.currentTarget.style.color = '#050505';
                                                                            }}
                                                                        >
                                                                            {comment.userDisplayName}
                                                                        </span>
                                                                        <span style={{ fontSize: '11px', color: '#65676B', marginLeft: '8px' }}>
                                                                            {formatMyDayTimestamp(comment.createdAt)}
                                                                        </span>
                                                                    </div>
                                                                    {(comment.userId === user?.uid || isCoachOrAdmin()) && (
                                                                        <button
                                                                            onClick={() => handleDeleteComment(post.id, comment.id, comment.userId)}
                                                                            style={{
                                                                                background: 'transparent',
                                                                                border: 'none',
                                                                                color: '#65676B',
                                                                                fontSize: '16px',
                                                                                cursor: 'pointer',
                                                                                padding: '0 4px'
                                                                            }}
                                                                            title="Delete comment"
                                                                        >
                                                                            Ã—
                                                                        </button>
                                                                    )}
                                                                </div>

                                                                {/* Comment Content */}
                                                                <div style={{
                                                                    fontSize: '14px',
                                                                    lineHeight: '18px',
                                                                    color: '#050505',
                                                                    whiteSpace: 'pre-wrap',
                                                                    wordBreak: 'break-word',
                                                                    paddingLeft: '32px',
                                                                    marginBottom: '4px'
                                                                }}>
                                                                    {comment.content}
                                                                </div>

                                                                {/* Reply Button */}
                                                                <div style={{ paddingLeft: '32px' }}>
                                                                    <button
                                                                        onClick={() => handleStartReply(comment.id, comment.userDisplayName)}
                                                                        style={{
                                                                            background: 'transparent',
                                                                            border: 'none',
                                                                            color: '#65676B',
                                                                            fontSize: '12px',
                                                                            fontWeight: '600',
                                                                            cursor: 'pointer',
                                                                            padding: '4px 0'
                                                                        }}
                                                                    >
                                                                        Reply
                                                                    </button>
                                                                </div>
                                                            </div>

                                                            {/* Inline Reply Input */}
                                                            {replyingTo === comment.id && (
                                                                <div style={{
                                                                    marginLeft: `${indentPx + 32}px`,
                                                                    marginBottom: '8px',
                                                                    display: 'flex',
                                                                    gap: '8px',
                                                                    alignItems: 'center'
                                                                }}>
                                                                    <input
                                                                        type="text"
                                                                        value={replyText}
                                                                        onChange={(e) => setReplyText(e.target.value)}
                                                                        onKeyPress={(e) => {
                                                                            if (e.key === 'Enter' && !e.shiftKey) {
                                                                                e.preventDefault();
                                                                                handleAddReply(post.id, comment.id, comment);
                                                                            }
                                                                        }}
                                                                        placeholder={`Reply to ${comment.userDisplayName}...`}
                                                                        autoFocus
                                                                        style={{
                                                                            flex: 1,
                                                                            padding: '8px 12px',
                                                                            borderRadius: '16px',
                                                                            border: '1px solid #CCD0D5',
                                                                            fontSize: '14px',
                                                                            outline: 'none'
                                                                        }}
                                                                    />
                                                                    <button
                                                                        onClick={() => handleAddReply(post.id, comment.id, comment)}
                                                                        disabled={!replyText.trim() || submittingComment}
                                                                        style={{
                                                                            padding: '8px 16px',
                                                                            background: replyText.trim() && !submittingComment ? '#069494' : '#CCD0D5',
                                                                            color: '#fff',
                                                                            border: 'none',
                                                                            borderRadius: '16px',
                                                                            fontSize: '13px',
                                                                            fontWeight: '600',
                                                                            cursor: replyText.trim() && !submittingComment ? 'pointer' : 'not-allowed'
                                                                        }}
                                                                    >
                                                                        Post
                                                                    </button>
                                                                    <button
                                                                        onClick={handleCancelReply}
                                                                        style={{
                                                                            padding: '8px 16px',
                                                                            background: 'transparent',
                                                                            color: '#65676B',
                                                                            border: 'none',
                                                                            borderRadius: '16px',
                                                                            fontSize: '13px',
                                                                            fontWeight: '600',
                                                                            cursor: 'pointer'
                                                                        }}
                                                                    >
                                                                        Cancel
                                                                    </button>
                                                                </div>
                                                            )}

                                                            {/* View Replies Toggle */}
                                                            {replyCount > 0 && (
                                                                <div style={{ marginLeft: `${indentPx + 32}px`, marginBottom: '8px' }}>
                                                                    <button
                                                                        onClick={() => handleToggleReplies(post.id, comment.id)}
                                                                        style={{
                                                                            background: 'transparent',
                                                                            border: 'none',
                                                                            color: '#069494',
                                                                            fontSize: '13px',
                                                                            fontWeight: '600',
                                                                            cursor: 'pointer',
                                                                            padding: '4px 0'
                                                                        }}
                                                                    >
                                                                        {expandedReplies[comment.id] ? 'â–²' : 'â–¼'} {replyCount} {replyCount === 1 ? 'reply' : 'replies'}
                                                                    </button>
                                                                </div>
                                                            )}

                                                            {/* Nested Replies */}
                                                            {expandedReplies[comment.id] && (
                                                                <div>
                                                                    {loadingReplies[comment.id] ? (
                                                                        <div style={{ marginLeft: `${indentPx + 32}px`, padding: '8px', color: '#65676B', fontSize: '13px' }}>
                                                                            Loading replies...
                                                                        </div>
                                                                    ) : (
                                                                        replies.map(reply => (
                                                                            <div key={reply.id} style={{
                                                                                marginLeft: `${indentPx + 32}px`,
                                                                                marginBottom: '8px',
                                                                                paddingLeft: '12px',
                                                                                borderLeft: '2px solid #E4E6EB'
                                                                            }}>
                                                                                <div style={{
                                                                                    background: '#F0F2F5',
                                                                                    borderRadius: '16px',
                                                                                    padding: '8px 12px'
                                                                                }}>
                                                                                    {/* Reply Header */}
                                                                                    <div style={{ display: 'flex', alignItems: 'center', marginBottom: '4px' }}>
                                                                                        {/* Avatar - CLICKABLE (PHASE 4) */}
                                                                                        <div
                                                                                            onClick={() => handleAvatarClick(reply.userId, reply.isAnonymous)}
                                                                                            style={{
                                                                                                width: '20px',
                                                                                                height: '20px',
                                                                                                borderRadius: '50%',
                                                                                                background: 'linear-gradient(135deg, #069494, #058585)',
                                                                                                display: 'flex',
                                                                                                alignItems: 'center',
                                                                                                justifyContent: 'center',
                                                                                                color: '#fff',
                                                                                                fontSize: '10px',
                                                                                                fontWeight: 'bold',
                                                                                                marginRight: '6px',
                                                                                                cursor: reply.isAnonymous ? 'default' : 'pointer',
                                                                                                transition: 'transform 0.2s ease'
                                                                                            }}
                                                                                            onMouseEnter={(e) => {
                                                                                                if (!reply.isAnonymous) {
                                                                                                    e.currentTarget.style.transform = 'scale(1.1)';
                                                                                                }
                                                                                            }}
                                                                                            onMouseLeave={(e) => {
                                                                                                e.currentTarget.style.transform = 'scale(1)';
                                                                                            }}
                                                                                        >
                                                                                            {(reply.userDisplayName?.[0] || '?').toUpperCase()}
                                                                                        </div>
                                                                                        <div style={{ flex: 1 }}>
                                                                                            {/* Display Name - CLICKABLE (PHASE 4) */}
                                                                                            <span
                                                                                                onClick={() => handleAvatarClick(reply.userId, reply.isAnonymous)}
                                                                                                style={{
                                                                                                    fontSize: '12px',
                                                                                                    fontWeight: '600',
                                                                                                    color: '#050505',
                                                                                                    cursor: reply.isAnonymous ? 'default' : 'pointer',
                                                                                                    transition: 'color 0.2s ease'
                                                                                                }}
                                                                                                onMouseEnter={(e) => {
                                                                                                    if (!reply.isAnonymous) {
                                                                                                        e.currentTarget.style.color = '#069494';
                                                                                                    }
                                                                                                }}
                                                                                                onMouseLeave={(e) => {
                                                                                                    e.currentTarget.style.color = '#050505';
                                                                                                }}
                                                                                            >
                                                                                                {reply.userDisplayName}
                                                                                            </span>
                                                                                            <span style={{ fontSize: '10px', color: '#65676B', marginLeft: '6px' }}>
                                                                                                {formatMyDayTimestamp(reply.createdAt)}
                                                                                            </span>
                                                                                        </div>
                                                                                        {(reply.userId === user?.uid || isCoachOrAdmin()) && (
                                                                                            <button
                                                                                                onClick={() => handleDeleteComment(post.id, reply.id, reply.userId)}
                                                                                                style={{
                                                                                                    background: 'transparent',
                                                                                                    border: 'none',
                                                                                                    color: '#65676B',
                                                                                                    fontSize: '14px',
                                                                                                    cursor: 'pointer',
                                                                                                    padding: '0 4px'
                                                                                                }}
                                                                                                title="Delete reply"
                                                                                            >
                                                                                                Ã—
                                                                                            </button>
                                                                                        )}
                                                                                    </div>

                                                                                    {/* Reply Content */}
                                                                                    <div style={{
                                                                                        fontSize: '13px',
                                                                                        lineHeight: '16px',
                                                                                        color: '#050505',
                                                                                        whiteSpace: 'pre-wrap',
                                                                                        wordBreak: 'break-word',
                                                                                        paddingLeft: '26px'
                                                                                    }}>
                                                                                        {reply.content}
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        ))
                                                                    )}
                                                                </div>
                                                            )}
                                                        </div>
                                                    );
                                                })
                                        )}

                                        {/* Comment Input */}
                                        <div style={{
                                            display: 'flex',
                                            gap: '8px',
                                            marginTop: '12px',
                                            alignItems: 'flex-start'
                                        }}>
                                            {/* Current User Avatar */}
                                            <div style={{
                                                width: '32px',
                                                height: '32px',
                                                borderRadius: '50%',
                                                background: 'linear-gradient(135deg, #069494, #058585)',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                color: '#fff',
                                                fontSize: '14px',
                                                fontWeight: 'bold',
                                                flexShrink: 0
                                            }}>
                                                {(currentUserData?.firstName?.[0] || user?.displayName?.[0] || '?').toUpperCase()}
                                            </div>
                                            {/* Input & Submit */}
                                            <div style={{ flex: 1 }}>
                                                <input
                                                    type="text"
                                                    value={commentText[post.id] || ''}
                                                    onChange={(e) => setCommentText(prev => ({ ...prev, [post.id]: e.target.value }))}
                                                    onKeyPress={(e) => {
                                                        if (e.key === 'Enter' && !e.shiftKey) {
                                                            e.preventDefault();
                                                            handleAddComment(post.id);
                                                        }
                                                    }}
                                                    disabled={submittingComment}
                                                    placeholder="Write a comment..."
                                                    style={{
                                                        width: '100%',
                                                        padding: '8px 12px',
                                                        border: '1px solid #CCD0D5',
                                                        borderRadius: '20px',
                                                        fontSize: '14px',
                                                        outline: 'none',
                                                        fontFamily: 'inherit'
                                                    }}
                                                />
                                                {/* Character counter */}
                                                {(commentText[post.id]?.length || 0) > 250 && (
                                                    <div style={{
                                                        fontSize: '11px',
                                                        color: (commentText[post.id]?.length || 0) > 280 ? '#F02849' : '#65676B',
                                                        textAlign: 'right',
                                                        marginTop: '4px',
                                                        marginRight: '4px'
                                                    }}>
                                                        {commentText[post.id]?.length || 0}/280
                                                    </div>
                                                )}
                                                {/* Submit button (shows when text entered) */}
                                                {(commentText[post.id]?.trim()?.length || 0) > 0 && (
                                                    <button
                                                        onClick={() => handleAddComment(post.id)}
                                                        disabled={submittingComment || (commentText[post.id]?.length || 0) > 280}
                                                        style={{
                                                            marginTop: '4px',
                                                            padding: '6px 16px',
                                                            background: (submittingComment || (commentText[post.id]?.length || 0) > 280)
                                                                ? '#CCD0D5'
                                                                : '#069494',
                                                            color: '#fff',
                                                            border: 'none',
                                                            borderRadius: '16px',
                                                            fontSize: '13px',
                                                            fontWeight: '600',
                                                            cursor: (submittingComment || (commentText[post.id]?.length || 0) > 280)
                                                                ? 'not-allowed'
                                                                : 'pointer',
                                                            float: 'right'
                                                        }}
                                                    >
                                                        {submittingComment ? 'Posting...' : 'Post'}
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        );
                    })}
                </div>
            )}

            {/* Full-Size Image Modal */}
            {viewingImage && (
                <div
                    onClick={() => setViewingImage(null)}
                    style={{
                        position: 'fixed',
                        top: 0,
                        left: 0,
                        right: 0,
                        bottom: 0,
                        background: 'rgba(0,0,0,0.9)',
                        zIndex: 9999,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        padding: '20px'
                    }}
                >
                    {/* Close Button */}
                    <button
                        onClick={() => setViewingImage(null)}
                        style={{
                            position: 'absolute',
                            top: '20px',
                            right: '20px',
                            width: '40px',
                            height: '40px',
                            background: 'transparent',
                            border: 'none',
                            color: '#fff',
                            fontSize: '40px',
                            cursor: 'pointer',
                            lineHeight: '40px',
                            fontWeight: '300'
                        }}
                    >
                        Ã—
                    </button>
                    {/* Image */}
                    <img
                        src={viewingImage}
                        alt="Full size"
                        onClick={(e) => e.stopPropagation()}
                        style={{
                            maxWidth: '90vw',
                            maxHeight: '90vh',
                            objectFit: 'contain'
                        }}
                    />
                </div>
            )}

            {activeChat === 'groups' && (
                <div style={{ background: '#F0F2F5', padding: isMobile ? '12px' : '20px', minHeight: 'calc(100vh - 140px)' }}>
                    <h3 style={{ color: '#333', marginBottom: '20px', fontSize: '20px', fontWeight: 'bold' }}>Support Groups</h3>
                    {supportGroups?.length > 0 ? (
                        supportGroups.map(group => (
                            <div key={group.id} style={{
                                background: '#FFFFFF',
                                borderRadius: '8px',
                                padding: isMobile ? '12px' : '16px',
                                marginBottom: '12px',
                                boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
                            }}>
                                <div style={{
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'flex-start',
                                    marginBottom: '12px'
                                }}>
                                    <h4 style={{ color: '#333', margin: 0, fontSize: '16px', fontWeight: 'bold' }}>{group.name}</h4>
                                    <span style={{
                                        padding: '4px 12px',
                                        borderRadius: '20px',
                                        fontSize: '12px',
                                        fontWeight: '600',
                                        background: group.type === 'AA' ? '#E7F3FF' :
                                                   group.type === 'NA' ? '#FFF4E6' :
                                                   group.type === 'SMART' ? '#E8F5E9' :
                                                   '#F0F2F5',
                                        color: group.type === 'AA' ? '#1877F2' :
                                               group.type === 'NA' ? '#E67E22' :
                                               group.type === 'SMART' ? '#43A047' :
                                               '#65676B'
                                    }}>
                                        {group.type}
                                    </span>
                                </div>

                                {group.description && (
                                    <p style={{ color: '#65676B', marginBottom: '12px', fontSize: '14px', lineHeight: '1.5' }}>
                                        {group.description}
                                    </p>
                                )}

                                <div style={{ fontSize: '14px', color: '#65676B', display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                        <i data-lucide="calendar" style={{ width: '16px', height: '16px', color: '#058585' }}></i>
                                        <span>{group.day}</span>
                                    </div>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                        <i data-lucide="clock" style={{ width: '16px', height: '16px', color: '#058585' }}></i>
                                        <span>{group.time}</span>
                                    </div>
                                    {group.location && (
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            <i data-lucide="map-pin" style={{ width: '16px', height: '16px', color: '#058585' }}></i>
                                            <span>{group.location}</span>
                                        </div>
                                    )}
                                    {!group.location && group.link && (
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            <i data-lucide="video" style={{ width: '16px', height: '16px', color: '#058585' }}></i>
                                            <span>Virtual Meeting</span>
                                        </div>
                                    )}
                                </div>

                                {group.link && (
                                    <button
                                        onClick={() => window.open(group.link, '_blank')}
                                        style={{
                                            marginTop: '12px',
                                            padding: '10px 20px',
                                            background: 'linear-gradient(135deg, #058585, #069494)',
                                            border: 'none',
                                            borderRadius: '8px',
                                            color: '#fff',
                                            fontSize: '14px',
                                            fontWeight: 'bold',
                                            cursor: 'pointer',
                                            display: 'inline-flex',
                                            alignItems: 'center',
                                            gap: '8px',
                                            boxShadow: '0 2px 8px rgba(5,133,133,0.3)',
                                            transition: 'transform 0.2s ease'
                                        }}
                                        onMouseOver={(e) => e.currentTarget.style.transform = 'translateY(-1px)'}
                                        onMouseOut={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                                    >
                                        <i data-lucide="video" style={{ width: '16px', height: '16px' }}></i>
                                        Join Virtual Meeting
                                    </button>
                                )}
                            </div>
                        ))
                    ) : (
                        <div style={{
                            textAlign: 'center',
                            padding: '60px 20px',
                            background: '#FFFFFF',
                            borderRadius: '8px',
                            boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
                        }}>
                            <i data-lucide="users" style={{ width: '48px', height: '48px', color: '#058585', marginBottom: '16px' }}></i>
                            <div style={{ color: '#65676B', fontSize: '15px' }}>
                                No support groups available yet.
                            </div>
                        </div>
                    )}
                </div>
            )}

            {activeChat === 'meetings' && (
                <div style={{ background: '#F0F2F5', minHeight: 'calc(100vh - 140px)' }}>
                    {/* Sticky Header - Professional Filter System */}
                    <div style={{
                        position: 'sticky',
                        top: 0,
                        background: '#FFFFFF',
                        padding: '16px 20px',
                        borderBottom: '1px solid #E4E6EB',
                        zIndex: 10,
                        boxShadow: '0 2px 4px rgba(0,0,0,0.05)'
                    }}>
                        {/* Row 1: Title + Action Buttons */}
                        <div style={{
                            display: 'flex',
                            flexDirection: isMobile ? 'column' : 'row',
                            justifyContent: 'space-between',
                            alignItems: isMobile ? 'stretch' : 'center',
                            marginBottom: '12px',
                            gap: isMobile ? '12px' : '0'
                        }}>
                            <h3 style={{
                                color: '#333',
                                margin: 0,
                                fontSize: isMobile ? '18px' : '20px',
                                fontWeight: 'bold'
                            }}>
                                My Meetings
                            </h3>

                            {/* MOBILE: Stack all action buttons vertically */}
                            {isMobile ? (
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                    {/* Row 1: View Mode + Browse */}
                                    <div style={{ display: 'flex', gap: '8px' }}>
                                        <select
                                            value={viewMode}
                                            onChange={(e) => setViewMode(e.target.value)}
                                            style={{
                                                flex: 1,
                                                padding: '10px 12px',
                                                borderRadius: '6px',
                                                border: '2px solid #E0E0E0',
                                                fontSize: '14px',
                                                fontWeight: '600',
                                                color: '#333',
                                                background: '#FFFFFF',
                                                cursor: 'pointer',
                                                outline: 'none'
                                            }}
                                        >
                                            <option value="list">ðŸ“‹ List</option>
                                            <option value="calendar">ðŸ“… Calendar</option>
                                        </select>

                                        <button
                                            onClick={() => setShowBrowser(true)}
                                            style={{
                                                flex: 1,
                                                padding: '10px 12px',
                                                borderRadius: '6px',
                                                border: '2px solid #E0E0E0',
                                                fontSize: '14px',
                                                fontWeight: '600',
                                                color: '#333',
                                                background: '#FFFFFF',
                                                cursor: 'pointer',
                                                outline: 'none',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                gap: '6px'
                                            }}
                                        >
                                            <i data-lucide="search" style={{ width: '16px', height: '16px' }}></i>
                                            Browse
                                        </button>
                                    </div>

                                    {/* Row 2: Select + Select All (conditional) */}
                                    <div style={{ display: 'flex', gap: '8px' }}>
                                        <button
                                            onClick={handleToggleSelectMode}
                                            style={{
                                                flex: selectMode ? 1 : 2,
                                                padding: '10px 12px',
                                                borderRadius: '6px',
                                                border: 'none',
                                                fontSize: '14px',
                                                fontWeight: '600',
                                                color: '#FFFFFF',
                                                background: selectMode ? '#E53935' : '#058585',
                                                cursor: 'pointer',
                                                outline: 'none',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                gap: '6px'
                                            }}
                                        >
                                            <i data-lucide={selectMode ? "x" : "check-square"} style={{ width: '16px', height: '16px' }}></i>
                                            {selectMode ? 'Cancel' : 'Select'}
                                        </button>

                                        {selectMode && (
                                            <button
                                                onClick={() => {
                                                    const allMeetingIds = filteredMeetings.map(m => m.id);
                                                    if (selectedMeetings.length === allMeetingIds.length) {
                                                        setSelectedMeetings([]);
                                                    } else {
                                                        setSelectedMeetings(allMeetingIds);
                                                    }
                                                }}
                                                style={{
                                                    flex: 1,
                                                    padding: '10px 12px',
                                                    borderRadius: '6px',
                                                    border: '2px solid #E0E0E0',
                                                    fontSize: '14px',
                                                    fontWeight: '600',
                                                    color: '#333',
                                                    background: '#FFFFFF',
                                                    cursor: 'pointer',
                                                    outline: 'none',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    gap: '6px'
                                                }}
                                            >
                                                <i data-lucide={selectedMeetings.length === filteredMeetings.length ? "square" : "check-square"}
                                                   style={{ width: '16px', height: '16px' }}></i>
                                                {selectedMeetings.length === filteredMeetings.length ? 'Deselect' : 'Select All'}
                                            </button>
                                        )}
                                    </div>

                                    {/* Row 3: Delete (conditional - only when meetings selected) */}
                                    {selectMode && selectedMeetings.length > 0 && (
                                        <button
                                            onClick={handleDeleteSelected}
                                            style={{
                                                padding: '10px 12px',
                                                borderRadius: '6px',
                                                border: 'none',
                                                fontSize: '14px',
                                                fontWeight: '600',
                                                color: '#FFFFFF',
                                                background: '#E53935',
                                                cursor: 'pointer',
                                                outline: 'none',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                gap: '6px'
                                            }}
                                        >
                                            <i data-lucide="trash-2" style={{ width: '16px', height: '16px' }}></i>
                                            Delete {selectedMeetings.length} Meeting{selectedMeetings.length > 1 ? 's' : ''}
                                        </button>
                                    )}
                                </div>
                            ) : (
                                // DESKTOP: Original horizontal layout (UNCHANGED)
                                <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                                    <select
                                        value={viewMode}
                                        onChange={(e) => setViewMode(e.target.value)}
                                        style={{
                                            minWidth: '120px',
                                            padding: '8px 12px',
                                            borderRadius: '6px',
                                            border: '2px solid #E0E0E0',
                                            fontSize: '13px',
                                            fontWeight: '600',
                                            color: '#333',
                                            background: '#FFFFFF',
                                            cursor: 'pointer',
                                            outline: 'none'
                                        }}
                                    >
                                        <option value="list">ðŸ“‹ List</option>
                                        <option value="calendar">ðŸ“… Calendar</option>
                                    </select>

                                    <button
                                        onClick={() => setShowBrowser(true)}
                                        style={{
                                            minWidth: '120px',
                                            padding: '8px 12px',
                                            borderRadius: '6px',
                                            border: '2px solid #E0E0E0',
                                            fontSize: '13px',
                                            fontWeight: '600',
                                            color: '#333',
                                            background: '#FFFFFF',
                                            cursor: 'pointer',
                                            outline: 'none',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            gap: '6px'
                                        }}
                                    >
                                        <i data-lucide="search" style={{ width: '14px', height: '14px' }}></i>
                                        Browse
                                    </button>

                                    <button
                                        onClick={handleToggleSelectMode}
                                        style={{
                                            minWidth: '120px',
                                            padding: '8px 12px',
                                            borderRadius: '6px',
                                            border: 'none',
                                            fontSize: '13px',
                                            fontWeight: '600',
                                            color: '#FFFFFF',
                                            background: selectMode ? '#E53935' : '#058585',
                                            cursor: 'pointer',
                                            outline: 'none',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            gap: '6px'
                                        }}
                                    >
                                        <i data-lucide={selectMode ? "x" : "check-square"} style={{ width: '14px', height: '14px' }}></i>
                                        {selectMode ? 'Cancel' : 'Select'}
                                    </button>

                                    {selectMode && (
                                        <button
                                            onClick={() => {
                                                const allMeetingIds = filteredMeetings.map(m => m.id);
                                                if (selectedMeetings.length === allMeetingIds.length) {
                                                    setSelectedMeetings([]);
                                                } else {
                                                    setSelectedMeetings(allMeetingIds);
                                                }
                                            }}
                                            style={{
                                                minWidth: '120px',
                                                padding: '8px 12px',
                                                borderRadius: '6px',
                                                border: '2px solid #E0E0E0',
                                                fontSize: '13px',
                                                fontWeight: '600',
                                                color: '#333',
                                                background: '#FFFFFF',
                                                cursor: 'pointer',
                                                outline: 'none',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                gap: '6px'
                                            }}
                                        >
                                            <i data-lucide={selectedMeetings.length === filteredMeetings.length ? "square" : "check-square"}
                                               style={{ width: '14px', height: '14px' }}></i>
                                            {selectedMeetings.length === filteredMeetings.length ? 'Deselect All' : 'Select All'}
                                        </button>
                                    )}

                                    {selectMode && selectedMeetings.length > 0 && (
                                        <button
                                            onClick={handleDeleteSelected}
                                            style={{
                                                minWidth: '120px',
                                                padding: '8px 12px',
                                                borderRadius: '6px',
                                                border: 'none',
                                                fontSize: '13px',
                                                fontWeight: '600',
                                                color: '#FFFFFF',
                                                background: '#E53935',
                                                cursor: 'pointer',
                                                outline: 'none',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                gap: '6px'
                                            }}
                                        >
                                            <i data-lucide="trash-2" style={{ width: '14px', height: '14px' }}></i>
                                            Delete ({selectedMeetings.length})
                                        </button>
                                    )}
                                </div>
                            )}
                        </div>

                        {/* Row 2: Meeting Type Filters (Uniform Buttons) */}
                        <div style={{
                            display: 'flex',
                            gap: '8px',
                            flexWrap: isMobile ? 'nowrap' : 'wrap',
                            alignItems: 'center',
                            overflowX: isMobile ? 'auto' : 'visible',
                            paddingBottom: isMobile ? '4px' : '0',
                            WebkitOverflowScrolling: 'touch'
                        }}>
                            <button
                                onClick={() => setActiveFilter('glrs')}
                                style={{
                                    padding: '8px 12px',
                                    borderRadius: '6px',
                                    border: '2px solid #E0E0E0',
                                    fontSize: '13px',
                                    fontWeight: '600',
                                    color: activeFilter === 'glrs' ? '#FFFFFF' : '#333',
                                    background: activeFilter === 'glrs' ? '#058585' : '#FFFFFF',
                                    cursor: 'pointer',
                                    outline: 'none',
                                    minWidth: isMobile ? '110px' : '120px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    gap: '6px',
                                    whiteSpace: 'nowrap',
                                    flexShrink: 0
                                }}
                            >
                                <i data-lucide="video" style={{ width: '14px', height: '14px' }}></i>
                                GLRS Virtual
                            </button>
                            <button
                                onClick={() => setActiveFilter('aa')}
                                style={{
                                    padding: '8px 12px',
                                    borderRadius: '6px',
                                    border: '2px solid #E0E0E0',
                                    fontSize: '13px',
                                    fontWeight: '600',
                                    color: activeFilter === 'aa' ? '#FFFFFF' : '#333',
                                    background: activeFilter === 'aa' ? '#058585' : '#FFFFFF',
                                    cursor: 'pointer',
                                    outline: 'none',
                                    minWidth: isMobile ? '110px' : '120px',
                                    whiteSpace: 'nowrap',
                                    flexShrink: 0
                                }}
                            >
                                AA
                            </button>
                            <button
                                onClick={() => setActiveFilter('na')}
                                style={{
                                    padding: '8px 12px',
                                    borderRadius: '6px',
                                    border: '2px solid #E0E0E0',
                                    fontSize: '13px',
                                    fontWeight: '600',
                                    color: activeFilter === 'na' ? '#FFFFFF' : '#333',
                                    background: activeFilter === 'na' ? '#058585' : '#FFFFFF',
                                    cursor: 'pointer',
                                    outline: 'none',
                                    minWidth: isMobile ? '110px' : '120px',
                                    whiteSpace: 'nowrap',
                                    flexShrink: 0
                                }}
                            >
                                NA
                            </button>
                            <button
                                onClick={() => setActiveFilter('recovery')}
                                style={{
                                    padding: '8px 12px',
                                    borderRadius: '6px',
                                    border: '2px solid #E0E0E0',
                                    fontSize: '13px',
                                    fontWeight: '600',
                                    color: activeFilter === 'recovery' ? '#FFFFFF' : '#333',
                                    background: activeFilter === 'recovery' ? '#058585' : '#FFFFFF',
                                    cursor: 'pointer',
                                    outline: 'none',
                                    minWidth: isMobile ? '110px' : '120px',
                                    whiteSpace: 'nowrap',
                                    flexShrink: 0
                                }}
                            >
                                All Recovery
                            </button>
                            <button
                                onClick={() => setActiveFilter('all')}
                                style={{
                                    padding: '8px 12px',
                                    borderRadius: '6px',
                                    border: '2px solid #E0E0E0',
                                    fontSize: '13px',
                                    fontWeight: '600',
                                    color: activeFilter === 'all' ? '#FFFFFF' : '#333',
                                    background: activeFilter === 'all' ? '#058585' : '#FFFFFF',
                                    cursor: 'pointer',
                                    outline: 'none',
                                    minWidth: isMobile ? '110px' : '120px',
                                    whiteSpace: 'nowrap',
                                    flexShrink: 0
                                }}
                            >
                                All
                            </button>
                        </div>
                    </div>

                    {/* Scrollable Content Area */}
                    <div style={{ padding: '20px' }}>
                        
                        {/* List View */}
                        {viewMode === 'list' && (
                        <>
                            {/* Upcoming Meetings Section */}
                            <div style={{ marginBottom: '30px' }}>
                        {/* Section Header with Time Filter */}
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px', flexWrap: 'wrap', gap: '12px' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                <h4 style={{ color: '#333', margin: 0, fontSize: '16px', fontWeight: 'bold', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                    <i data-lucide="calendar-plus" style={{ width: '18px', height: '18px', color: '#058585' }}></i>
                                    Upcoming Meetings
                                </h4>
                                {/* Time Range Filter Dropdown */}
                                <select
                                    value={upcomingFilter}
                                    onChange={(e) => setUpcomingFilter(e.target.value)}
                                    style={{
                                        padding: '6px 10px',
                                        borderRadius: '6px',
                                        border: '2px solid #E0E0E0',
                                        fontSize: '13px',
                                        fontWeight: '600',
                                        color: '#333',
                                        background: '#FFFFFF',
                                        cursor: 'pointer',
                                        outline: 'none',
                                        minWidth: '110px'
                                    }}
                                >
                                    <option value="today">Today</option>
                                    <option value="7days">Next 7 Days</option>
                                    <option value="14days">Next 14 Days</option>
                                    <option value="30days">Next 30 Days</option>
                                    <option value="all">All Upcoming</option>
                                </select>
                            </div>
                        </div>
                        {filteredMeetings?.filter(m => {
                            const meetingDate = m.scheduledTime?.toDate ? m.scheduledTime.toDate() : new Date(m.scheduledTime);
                            const now = new Date();
                            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

                            // Check if meeting is in the future
                            if (meetingDate < now) return false;

                            // Apply time range filter
                            if (upcomingFilter === 'today') {
                                const tomorrow = new Date(today);
                                tomorrow.setDate(tomorrow.getDate() + 1);
                                return meetingDate >= today && meetingDate < tomorrow;
                            } else if (upcomingFilter === '7days') {
                                const endDate = new Date(now);
                                endDate.setDate(endDate.getDate() + 7);
                                return meetingDate <= endDate;
                            } else if (upcomingFilter === '14days') {
                                const endDate = new Date(now);
                                endDate.setDate(endDate.getDate() + 14);
                                return meetingDate <= endDate;
                            } else if (upcomingFilter === '30days') {
                                const endDate = new Date(now);
                                endDate.setDate(endDate.getDate() + 30);
                                return meetingDate <= endDate;
                            } else { // 'all'
                                return true;
                            }
                        }).length > 0 ? (
                        filteredMeetings.filter(m => {
                            const meetingDate = m.scheduledTime?.toDate ? m.scheduledTime.toDate() : new Date(m.scheduledTime);
                            const now = new Date();
                            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

                            // Check if meeting is in the future
                            if (meetingDate < now) return false;

                            // Apply time range filter
                            if (upcomingFilter === 'today') {
                                const tomorrow = new Date(today);
                                tomorrow.setDate(tomorrow.getDate() + 1);
                                return meetingDate >= today && meetingDate < tomorrow;
                            } else if (upcomingFilter === '7days') {
                                const endDate = new Date(now);
                                endDate.setDate(endDate.getDate() + 7);
                                return meetingDate <= endDate;
                            } else if (upcomingFilter === '14days') {
                                const endDate = new Date(now);
                                endDate.setDate(endDate.getDate() + 14);
                                return meetingDate <= endDate;
                            } else if (upcomingFilter === '30days') {
                                const endDate = new Date(now);
                                endDate.setDate(endDate.getDate() + 30);
                                return meetingDate <= endDate;
                            } else { // 'all'
                                return true;
                            }
                        }).sort((a, b) => {
                            const dateA = a.scheduledTime?.toDate ? a.scheduledTime.toDate() : new Date(a.scheduledTime);
                            const dateB = b.scheduledTime?.toDate ? b.scheduledTime.toDate() : new Date(b.scheduledTime);
                            return dateA - dateB; // Ascending order (soonest first)
                        }).map(meeting => {
                            const meetingDate = meeting.scheduledTime?.toDate ?
                                meeting.scheduledTime.toDate() :
                                new Date(meeting.scheduledTime);

                            return (
                                <div key={meeting.id} style={{
                                    background: '#FFFFFF',
                                    borderRadius: '8px',
                                    padding: '16px',
                                    marginBottom: '12px',
                                    boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                                    border: selectMode && selectedMeetings.includes(meeting.id) ? '2px solid #058585' : 'none'
                                }}>
                                    <div style={{
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'flex-start',
                                        marginBottom: '12px'
                                    }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '12px', flex: 1 }}>
                                            {/* Checkbox (shown in select mode) */}
                                            {selectMode && (
                                                <input
                                                    type="checkbox"
                                                    checked={selectedMeetings.includes(meeting.id)}
                                                    onChange={() => handleToggleSelection(meeting.id)}
                                                    style={{
                                                        width: '18px',
                                                        height: '18px',
                                                        cursor: 'pointer',
                                                        accentColor: '#058585'
                                                    }}
                                                />
                                            )}
                                            <h4 style={{ color: '#333', margin: 0, fontSize: '16px', fontWeight: 'bold' }}>
                                                {meeting.meetingTitle || 'Group Recovery Session'}
                                            </h4>
                                        </div>
                                        <span style={{
                                            padding: '4px 12px',
                                            borderRadius: '20px',
                                            fontSize: '12px',
                                            fontWeight: '600',
                                            background: meeting.status === 'scheduled' ? '#E7F3FF' :
                                                       meeting.status === 'completed' ? '#E8F5E9' :
                                                       '#FFEBEE',
                                            color: meeting.status === 'scheduled' ? '#1877F2' :
                                                   meeting.status === 'completed' ? '#43A047' :
                                                   '#E53935'
                                        }}>
                                            {meeting.status}
                                        </span>
                                    </div>

                                    <div style={{
                                        fontSize: '13px',
                                        color: '#058585',
                                        fontWeight: '600',
                                        marginBottom: '12px'
                                    }}>
                                        {meeting.type || 'Group Session'}
                                    </div>

                                    <div style={{ fontSize: '14px', color: '#65676B', display: 'flex', flexDirection: 'column', gap: '8px', marginBottom: '12px' }}>
                                        {/* Day of Week + Date */}
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            <i data-lucide="calendar" style={{ width: '16px', height: '16px', color: '#058585' }}></i>
                                            <span>
                                                <strong>{meetingDate.toLocaleDateString('en-US', {weekday: 'short'})}</strong>
                                                {' '}{meetingDate.toLocaleDateString()}
                                            </span>
                                        </div>

                                        {/* Time */}
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            <i data-lucide="clock" style={{ width: '16px', height: '16px', color: '#058585' }}></i>
                                            <span>{meetingDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                        </div>

                                        {/* Duration */}
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            <i data-lucide="timer" style={{ width: '16px', height: '16px', color: '#058585' }}></i>
                                            <span>Duration: {meeting.duration || '60'} minutes</span>
                                        </div>

                                        {/* Address (clickable map link) */}
                                        {(meeting.location || meeting.address || meeting.city) && (() => {
                                            // Parse JSON strings if needed
                                            const parseIfJSON = (value) => {
                                                if (!value) return null;
                                                if (typeof value === 'object') return value;
                                                try {
                                                    return JSON.parse(value);
                                                } catch (e) {
                                                    return value;
                                                }
                                            };

                                            const locationData = parseIfJSON(meeting.location);
                                            const addressData = parseIfJSON(meeting.address);
                                            const cityData = parseIfJSON(meeting.city);
                                            const stateData = parseIfJSON(meeting.state);
                                            const zipData = parseIfJSON(meeting.zip);

                                            // Extract values
                                            const locationName = typeof locationData === 'object' ? locationData.name || locationData.location : locationData;

                                            // Extract street - handle full address in street field
                                            let street = typeof addressData === 'object' ? addressData.street : addressData;
                                            if (street && typeof street === 'string' && street.includes(',')) {
                                                // Street contains full address like "20307 Marshall St, Castro Valley, CA 94546, USA"
                                                // Extract just the street part (before first comma)
                                                street = street.split(',')[0].trim();
                                            }

                                            const city = typeof addressData === 'object' ? addressData.city : (typeof cityData === 'object' ? cityData.city : cityData);
                                            const state = typeof addressData === 'object' ? addressData.state : (typeof stateData === 'object' ? stateData.state : stateData);
                                            const zip = typeof addressData === 'object' ? addressData.zip : (typeof zipData === 'object' ? zipData.zip : zipData);

                                            // Build clean address parts
                                            const addressParts = [];
                                            if (locationName) addressParts.push(locationName);
                                            if (street) addressParts.push(street);

                                            const cityStateZip = [city, state, zip].filter(Boolean).join(', ');
                                            if (cityStateZip) addressParts.push(cityStateZip);

                                            const fullAddress = addressParts.join(', ');

                                            // Build map URL
                                            let mapUrl = '';
                                            if (meeting.latitude && meeting.longitude) {
                                                // Use geo: protocol for native map apps
                                                mapUrl = `geo:${meeting.latitude},${meeting.longitude}`;
                                            } else if (fullAddress) {
                                                // Use Google Maps search
                                                mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(fullAddress)}`;
                                            }

                                            return mapUrl ? (
                                                <div style={{ display: 'flex', alignItems: 'flex-start', gap: '8px' }}>
                                                    <i data-lucide="map-pin" style={{ width: '16px', height: '16px', marginTop: '2px', color: '#058585' }}></i>
                                                    <a
                                                        href={mapUrl}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        style={{
                                                            color: '#058585',
                                                            textDecoration: 'none',
                                                            cursor: 'pointer',
                                                            lineHeight: '1.4',
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            gap: '4px'
                                                        }}
                                                        onMouseOver={(e) => e.currentTarget.style.textDecoration = 'underline'}
                                                        onMouseOut={(e) => e.currentTarget.style.textDecoration = 'none'}
                                                    >
                                                        <span>{fullAddress}</span>
                                                        <i data-lucide="external-link" style={{ width: '12px', height: '12px' }}></i>
                                                    </a>
                                                </div>
                                            ) : null;
                                        })()}

                                        {/* Global Meeting Indicator */}
                                        {meeting.isGlobal && (
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                <i data-lucide="globe" style={{ width: '16px', height: '16px', color: '#058585' }}></i>
                                                <span>All PIRs Invited</span>
                                            </div>
                                        )}
                                    </div>

                                    {meeting.notes && (
                                        <div style={{
                                            display: 'flex',
                                            alignItems: 'flex-start',
                                            gap: '8px',
                                            padding: '12px',
                                            background: '#F0F2F5',
                                            borderRadius: '8px',
                                            marginBottom: '12px'
                                        }}>
                                            <i data-lucide="file-text" style={{ width: '16px', height: '16px', marginTop: '2px', color: '#058585' }}></i>
                                            <span style={{ fontSize: '14px', color: '#65676B', lineHeight: '1.5' }}>{meeting.notes}</span>
                                        </div>
                                    )}

                                    {/* Meeting Types/Codes */}
                                    {(() => {
                                        // Get meeting type codes from the types field
                                        const typeString = meeting.types || '';
                                        const hasTypes = typeString && typeString.length > 0;
                                        const isVirtual = meeting.isVirtual || false;

                                        // Don't render if no types and not virtual
                                        if (!hasTypes && !isVirtual) return null;

                                        const typeList = hasTypes
                                            ? (Array.isArray(typeString)
                                                ? typeString
                                                : String(typeString).split(',').map(t => t.trim()).filter(Boolean))
                                            : [];

                                        return (
                                            <div style={{
                                                display: 'flex',
                                                gap: '6px',
                                                flexWrap: 'wrap',
                                                marginBottom: '12px'
                                            }}>
                                                {/* Virtual badge */}
                                                {isVirtual && (
                                                    <span style={{
                                                        padding: '4px 10px',
                                                        borderRadius: '12px',
                                                        fontSize: '11px',
                                                        fontWeight: '600',
                                                        background: '#E7F3FF',
                                                        color: '#1877F2',
                                                        display: 'inline-flex',
                                                        alignItems: 'center',
                                                        gap: '4px'
                                                    }}>
                                                        <i data-lucide="video" style={{ width: '10px', height: '10px' }}></i>
                                                        Virtual
                                                    </span>
                                                )}
                                                {/* Type codes */}
                                                {typeList.map((type, idx) => {
                                                    const code = String(type).trim();
                                                    const fullName = getTypeName(code);
                                                    const isKnownType = meetingTypeCodes[code.toUpperCase()];

                                                    return (
                                                        <span
                                                            key={idx}
                                                            title={isKnownType ? fullName : undefined}
                                                            style={{
                                                                padding: '4px 10px',
                                                                borderRadius: '12px',
                                                                fontSize: '11px',
                                                                fontWeight: '600',
                                                                background: isKnownType ? '#E8F5E9' : '#F0F2F5',
                                                                color: isKnownType ? '#2E7D32' : '#65676B',
                                                                cursor: isKnownType ? 'help' : 'default',
                                                                transition: 'all 0.2s',
                                                                display: 'inline-block'
                                                            }}
                                                        >
                                                            {isKnownType ? `${code} - ${fullName}` : code}
                                                        </span>
                                                    );
                                                })}
                                            </div>
                                        );
                                    })()}

                                    {meeting.meetingLink && (
                                        <button
                                            onClick={() => window.open(meeting.meetingLink, '_blank')}
                                            style={{
                                                padding: '10px 20px',
                                                background: 'linear-gradient(135deg, #058585, #069494)',
                                                border: 'none',
                                                borderRadius: '8px',
                                                color: '#fff',
                                                fontSize: '14px',
                                                fontWeight: 'bold',
                                                cursor: 'pointer',
                                                display: 'inline-flex',
                                                alignItems: 'center',
                                                gap: '8px',
                                                boxShadow: '0 2px 8px rgba(5,133,133,0.3)',
                                                transition: 'transform 0.2s ease'
                                            }}
                                            onMouseOver={(e) => e.currentTarget.style.transform = 'translateY(-1px)'}
                                            onMouseOut={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                                        >
                                            <i data-lucide="video" style={{ width: '16px', height: '16px' }}></i>
                                            Join Virtual Meeting
                                        </button>
                                    )}
                                </div>
                            );
                        })
                    ) : (
                        <div style={{
                            textAlign: 'center',
                            padding: '60px 20px',
                            background: '#FFFFFF',
                            borderRadius: '8px',
                            boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
                        }}>
                            <i data-lucide="calendar" style={{ width: '48px', height: '48px', color: '#058585', marginBottom: '16px' }}></i>
                            <div style={{ color: '#65676B', fontSize: '15px' }}>
                                No group meetings scheduled.
                            </div>
                        </div>
                    )}
                </div>

                {/* Past Meetings Section */}
                <div>
                    <h4 style={{ color: '#333', marginBottom: '16px', fontSize: '16px', fontWeight: 'bold', display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <i data-lucide="history" style={{ width: '18px', height: '18px', color: '#058585' }}></i>
                        Past Meetings
                    </h4>
                    {filteredMeetings?.filter(m => {
                        const meetingDate = m.scheduledTime?.toDate ? m.scheduledTime.toDate() : new Date(m.scheduledTime);
                        return meetingDate < new Date();
                    }).length > 0 ? (
                        filteredMeetings.filter(m => {
                            const meetingDate = m.scheduledTime?.toDate ? m.scheduledTime.toDate() : new Date(m.scheduledTime);
                            return meetingDate < new Date();
                        }).map(meeting => {
                            const meetingDate = meeting.scheduledTime?.toDate ?
                                meeting.scheduledTime.toDate() :
                                new Date(meeting.scheduledTime);

                            return (
                                <div key={meeting.id} style={{
                                    background: '#FFFFFF',
                                    borderRadius: '8px',
                                    padding: '16px',
                                    marginBottom: '12px',
                                    boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                                    opacity: '0.9'
                                }}>
                                    <div style={{
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'flex-start',
                                        marginBottom: '12px'
                                    }}>
                                        <h4 style={{ color: '#333', margin: 0, fontSize: '16px', fontWeight: 'bold' }}>
                                            {meeting.meetingTitle || 'Group Recovery Session'}
                                        </h4>
                                        <span style={{
                                            padding: '4px 12px',
                                            borderRadius: '20px',
                                            fontSize: '12px',
                                            fontWeight: '600',
                                            background: meeting.attended ? '#E8F5E9' : '#FFEBEE',
                                            color: meeting.attended ? '#43A047' : '#E53935'
                                        }}>
                                            {meeting.attended ? 'Attended' : 'Missed'}
                                        </span>
                                    </div>

                                    <div style={{
                                        fontSize: '13px',
                                        color: '#058585',
                                        fontWeight: '600',
                                        marginBottom: '12px'
                                    }}>
                                        {meeting.type || 'Group Session'}
                                    </div>

                                    <div style={{ fontSize: '14px', color: '#65676B', display: 'flex', flexDirection: 'column', gap: '8px', marginBottom: '12px' }}>
                                        {/* Day of Week + Date */}
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            <i data-lucide="calendar" style={{ width: '16px', height: '16px', color: '#058585' }}></i>
                                            <span>
                                                <strong>{meetingDate.toLocaleDateString('en-US', {weekday: 'short'})}</strong>
                                                {' '}{meetingDate.toLocaleDateString()}
                                            </span>
                                        </div>

                                        {/* Time */}
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            <i data-lucide="clock" style={{ width: '16px', height: '16px', color: '#058585' }}></i>
                                            <span>{meetingDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                        </div>

                                        {/* Duration */}
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            <i data-lucide="timer" style={{ width: '16px', height: '16px', color: '#058585' }}></i>
                                            <span>Duration: {meeting.duration || '60'} minutes</span>
                                        </div>

                                        {/* Address (clickable map link) */}
                                        {(meeting.location || meeting.address || meeting.city) && (() => {
                                            // Parse JSON strings if needed
                                            const parseIfJSON = (value) => {
                                                if (!value) return null;
                                                if (typeof value === 'object') return value;
                                                try {
                                                    return JSON.parse(value);
                                                } catch (e) {
                                                    return value;
                                                }
                                            };

                                            const locationData = parseIfJSON(meeting.location);
                                            const addressData = parseIfJSON(meeting.address);
                                            const cityData = parseIfJSON(meeting.city);
                                            const stateData = parseIfJSON(meeting.state);
                                            const zipData = parseIfJSON(meeting.zip);

                                            // Extract values
                                            const locationName = typeof locationData === 'object' ? locationData.name || locationData.location : locationData;

                                            // Extract street - handle full address in street field
                                            let street = typeof addressData === 'object' ? addressData.street : addressData;
                                            if (street && typeof street === 'string' && street.includes(',')) {
                                                // Street contains full address like "20307 Marshall St, Castro Valley, CA 94546, USA"
                                                // Extract just the street part (before first comma)
                                                street = street.split(',')[0].trim();
                                            }

                                            const city = typeof addressData === 'object' ? addressData.city : (typeof cityData === 'object' ? cityData.city : cityData);
                                            const state = typeof addressData === 'object' ? addressData.state : (typeof stateData === 'object' ? stateData.state : stateData);
                                            const zip = typeof addressData === 'object' ? addressData.zip : (typeof zipData === 'object' ? zipData.zip : zipData);

                                            // Build clean address parts
                                            const addressParts = [];
                                            if (locationName) addressParts.push(locationName);
                                            if (street) addressParts.push(street);

                                            const cityStateZip = [city, state, zip].filter(Boolean).join(', ');
                                            if (cityStateZip) addressParts.push(cityStateZip);

                                            const fullAddress = addressParts.join(', ');

                                            // Build map URL
                                            let mapUrl = '';
                                            if (meeting.latitude && meeting.longitude) {
                                                // Use geo: protocol for native map apps
                                                mapUrl = `geo:${meeting.latitude},${meeting.longitude}`;
                                            } else if (fullAddress) {
                                                // Use Google Maps search
                                                mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(fullAddress)}`;
                                            }

                                            return mapUrl ? (
                                                <div style={{ display: 'flex', alignItems: 'flex-start', gap: '8px' }}>
                                                    <i data-lucide="map-pin" style={{ width: '16px', height: '16px', marginTop: '2px', color: '#058585' }}></i>
                                                    <a
                                                        href={mapUrl}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        style={{
                                                            color: '#058585',
                                                            textDecoration: 'none',
                                                            cursor: 'pointer',
                                                            lineHeight: '1.4',
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            gap: '4px'
                                                        }}
                                                        onMouseOver={(e) => e.currentTarget.style.textDecoration = 'underline'}
                                                        onMouseOut={(e) => e.currentTarget.style.textDecoration = 'none'}
                                                    >
                                                        <span>{fullAddress}</span>
                                                        <i data-lucide="external-link" style={{ width: '12px', height: '12px' }}></i>
                                                    </a>
                                                </div>
                                            ) : null;
                                        })()}
                                    </div>

                                    {/* Attendance Tracking Checkbox */}
                                    <label style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '12px',
                                        padding: '12px',
                                        background: '#F0F2F5',
                                        borderRadius: '8px',
                                        cursor: 'pointer',
                                        transition: 'background 0.2s ease'
                                    }}
                                    onMouseOver={(e) => e.currentTarget.style.background = '#E4E6EB'}
                                    onMouseOut={(e) => e.currentTarget.style.background = '#F0F2F5'}
                                    >
                                        <input
                                            type="checkbox"
                                            checked={meeting.attended || false}
                                            onChange={async (e) => {
                                                try {
                                                    await db.collection('meetings').doc(meeting.id).update({
                                                        attended: e.target.checked,
                                                        attendedAt: e.target.checked ? firebase.firestore.FieldValue.serverTimestamp() : null
                                                    });
                                                } catch (error) {
                                                    console.error('Error updating attendance:', error);
                                                    window.handleFirebaseError && window.handleFirebaseError(error, 'CommunityTab.updateAttendance');
                                                }
                                            }}
                                            style={{
                                                width: '20px',
                                                height: '20px',
                                                cursor: 'pointer',
                                                accentColor: '#058585'
                                            }}
                                        />
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            <i data-lucide="check-circle" style={{ width: '16px', height: '16px', color: '#058585' }}></i>
                                            <span style={{ fontSize: '14px', color: '#333', fontWeight: '600' }}>
                                                I attended this meeting
                                            </span>
                                        </div>
                                    </label>
                                </div>
                            );
                        })
                    ) : (
                        <div style={{
                            textAlign: 'center',
                            padding: '60px 20px',
                            background: '#FFFFFF',
                            borderRadius: '8px',
                            boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
                        }}>
                            <i data-lucide="history" style={{ width: '48px', height: '48px', color: '#058585', marginBottom: '16px' }}></i>
                            <div style={{ color: '#65676B', fontSize: '15px' }}>
                                No past meetings to show.
                            </div>
                        </div>
                    )}
                            </div>
                        </>
                    )}

                    {/* Calendar View */}
                    {viewMode === 'calendar' && (
                        <div>
                            {isMobile ? (
                                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                // MOBILE: SINGLE-DAY VIEW WITH NAVIGATION
                                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                <>
                                    {/* Day Navigation Header */}
                                    <div style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'space-between',
                                        marginBottom: '12px',
                                        background: '#FFFFFF',
                                        padding: '12px',
                                        borderRadius: '8px',
                                        boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
                                    }}>
                                        {/* Previous Day Button */}
                                        <button
                                            onClick={() => {
                                                const newDate = new Date(selectedCalendarDate);
                                                newDate.setDate(newDate.getDate() - 1);
                                                setSelectedCalendarDate(newDate);
                                            }}
                                            style={{
                                                background: 'transparent',
                                                border: 'none',
                                                cursor: 'pointer',
                                                padding: '8px',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                minWidth: '44px',
                                                minHeight: '44px'
                                            }}
                                        >
                                            <i data-lucide="chevron-left" style={{
                                                width: '24px',
                                                height: '24px',
                                                color: '#058585'
                                            }}></i>
                                        </button>

                                        {/* Current Date Display */}
                                        <div style={{ textAlign: 'center', flex: 1 }}>
                                            <div style={{
                                                fontSize: '16px',
                                                fontWeight: 'bold',
                                                color: '#058585',
                                                marginBottom: '4px'
                                            }}>
                                                {selectedCalendarDate.toLocaleDateString('en-US', { weekday: 'long' })}
                                            </div>
                                            <div style={{
                                                fontSize: '24px',
                                                fontWeight: 'bold',
                                                color: '#333'
                                            }}>
                                                {selectedCalendarDate.toLocaleDateString('en-US', {
                                                    month: 'short',
                                                    day: 'numeric',
                                                    year: 'numeric'
                                                })}
                                            </div>
                                        </div>

                                        {/* Next Day Button */}
                                        <button
                                            onClick={() => {
                                                const newDate = new Date(selectedCalendarDate);
                                                newDate.setDate(newDate.getDate() + 1);
                                                setSelectedCalendarDate(newDate);
                                            }}
                                            style={{
                                                background: 'transparent',
                                                border: 'none',
                                                cursor: 'pointer',
                                                padding: '8px',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                minWidth: '44px',
                                                minHeight: '44px'
                                            }}
                                        >
                                            <i data-lucide="chevron-right" style={{
                                                width: '24px',
                                                height: '24px',
                                                color: '#058585'
                                            }}></i>
                                        </button>
                                    </div>

                                    {/* Single Day Card */}
                                    <div style={{
                                        background: '#FFFFFF',
                                        borderRadius: '8px',
                                        padding: '16px',
                                        boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                                        minHeight: '300px',
                                        marginBottom: '12px'
                                    }}>
                                        {(() => {
                                            // Get meetings for selected date
                                            const dayMeetings = filteredMeetings.filter(m => {
                                                const meetingDate = m.scheduledTime?.toDate ?
                                                    m.scheduledTime.toDate() :
                                                    new Date(m.scheduledTime);
                                                return meetingDate.toDateString() === selectedCalendarDate.toDateString();
                                            });

                                            return dayMeetings.length > 0 ? (
                                                <div style={{
                                                    display: 'flex',
                                                    flexDirection: 'column',
                                                    gap: '12px'
                                                }}>
                                                    {dayMeetings.map((meeting, idx) => {
                                                        const meetingDate = meeting.scheduledTime?.toDate ?
                                                            meeting.scheduledTime.toDate() :
                                                            new Date(meeting.scheduledTime);

                                                        return (
                                                            <div key={idx} style={{
                                                                background: '#F0F2F5',
                                                                borderRadius: '8px',
                                                                padding: '16px',
                                                                borderLeft: '4px solid #058585'
                                                            }}>
                                                                {/* Meeting Time */}
                                                                <div style={{
                                                                    fontWeight: 'bold',
                                                                    color: '#058585',
                                                                    marginBottom: '8px',
                                                                    fontSize: '18px'
                                                                }}>
                                                                    {meetingDate.toLocaleTimeString([], {
                                                                        hour: '2-digit',
                                                                        minute: '2-digit'
                                                                    })}
                                                                </div>

                                                                {/* Meeting Title */}
                                                                <div style={{
                                                                    color: '#333',
                                                                    fontSize: '16px',
                                                                    fontWeight: '600',
                                                                    marginBottom: '4px'
                                                                }}>
                                                                    {meeting.meetingTitle || 'Meeting'}
                                                                </div>

                                                                {/* Meeting Type */}
                                                                {meeting.type && (
                                                                    <div style={{
                                                                        marginTop: '8px',
                                                                        fontSize: '13px',
                                                                        color: '#65676B'
                                                                    }}>
                                                                        {meeting.type}
                                                                    </div>
                                                                )}

                                                                {/* Additional meeting details if available */}
                                                                {meeting.location && (
                                                                    <div style={{
                                                                        marginTop: '4px',
                                                                        fontSize: '13px',
                                                                        color: '#65676B'
                                                                    }}>
                                                                        ðŸ“ {meeting.location}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            ) : (
                                                <div style={{
                                                    textAlign: 'center',
                                                    color: '#CED0D4',
                                                    fontSize: '15px',
                                                    paddingTop: '80px'
                                                }}>
                                                    <i data-lucide="calendar" style={{
                                                        width: '48px',
                                                        height: '48px',
                                                        color: '#CED0D4',
                                                        marginBottom: '12px',
                                                        display: 'block',
                                                        margin: '0 auto 12px'
                                                    }}></i>
                                                    No meetings scheduled
                                                </div>
                                            );
                                        })()}
                                    </div>

                                    {/* Jump to Today Button */}
                                    <button
                                        onClick={() => setSelectedCalendarDate(new Date())}
                                        style={{
                                            marginBottom: '16px',
                                            padding: '12px',
                                            background: '#FFFFFF',
                                            border: '2px solid #E0E0E0',
                                            borderRadius: '8px',
                                            color: '#058585',
                                            fontSize: '14px',
                                            fontWeight: '600',
                                            cursor: 'pointer',
                                            width: '100%',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            gap: '8px'
                                        }}
                                    >
                                        <i data-lucide="calendar-days" style={{
                                            width: '16px',
                                            height: '16px'
                                        }}></i>
                                        Jump to Today
                                    </button>
                                </>
                            ) : (
                                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                // DESKTOP: ORIGINAL 7-COLUMN WEEK GRID (UNCHANGED)
                                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                <div style={{
                                    display: 'grid',
                                    gridTemplateColumns: 'repeat(7, 1fr)',
                                    gap: '8px',
                                    marginBottom: '20px'
                                }}>
                                    {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map((day, index) => {
                                        const today = new Date();
                                        const currentDay = new Date(today);
                                        currentDay.setDate(today.getDate() - today.getDay() + index);

                                        const dayMeetings = filteredMeetings.filter(m => {
                                            const meetingDate = m.scheduledTime?.toDate ? m.scheduledTime.toDate() : new Date(m.scheduledTime);
                                            return meetingDate.toDateString() === currentDay.toDateString();
                                        });

                                        return (
                                            <div key={index} style={{
                                                background: '#FFFFFF',
                                                borderRadius: '8px',
                                                padding: '12px',
                                                minHeight: '200px',
                                                boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                                                border: currentDay.toDateString() === today.toDateString() ? '2px solid #058585' : 'none'
                                            }}>
                                                <div style={{
                                                    fontSize: '12px',
                                                    fontWeight: 'bold',
                                                    color: '#058585',
                                                    marginBottom: '8px',
                                                    textAlign: 'center'
                                                }}>
                                                    {day}
                                                </div>
                                                <div style={{
                                                    fontSize: '18px',
                                                    fontWeight: 'bold',
                                                    color: currentDay.toDateString() === today.toDateString() ? '#058585' : '#333',
                                                    marginBottom: '12px',
                                                    textAlign: 'center'
                                                }}>
                                                    {currentDay.getDate()}
                                                </div>

                                                <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
                                                    {dayMeetings.length > 0 ? (
                                                        dayMeetings.map((meeting, idx) => {
                                                            const meetingDate = meeting.scheduledTime?.toDate ? meeting.scheduledTime.toDate() : new Date(meeting.scheduledTime);
                                                            return (
                                                                <div key={idx} style={{
                                                                    background: '#F0F2F5',
                                                                    borderRadius: '6px',
                                                                    padding: '8px',
                                                                    fontSize: '11px',
                                                                    cursor: 'pointer',
                                                                    transition: 'background 0.2s',
                                                                    borderLeft: '3px solid #058585'
                                                                }}
                                                                onMouseOver={(e) => e.currentTarget.style.background = '#E4E6EB'}
                                                                onMouseOut={(e) => e.currentTarget.style.background = '#F0F2F5'}
                                                                >
                                                                    <div style={{ fontWeight: 'bold', color: '#333', marginBottom: '4px' }}>
                                                                        {meetingDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                                                    </div>
                                                                    <div style={{ color: '#65676B', lineHeight: '1.3' }}>
                                                                        {meeting.meetingTitle || 'Meeting'}
                                                                    </div>
                                                                    {meeting.type && (
                                                                        <div style={{
                                                                            marginTop: '4px',
                                                                            fontSize: '10px',
                                                                            color: '#058585',
                                                                            fontWeight: '600'
                                                                        }}>
                                                                            {meeting.type}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            );
                                                        })
                                                    ) : (
                                                        <div style={{
                                                            textAlign: 'center',
                                                            color: '#CED0D4',
                                                            fontSize: '11px',
                                                            marginTop: '20px'
                                                        }}>
                                                            No meetings
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}

                            {/* Calendar Legend - Same for Mobile & Desktop */}
                            <div style={{
                                background: '#FFFFFF',
                                borderRadius: '8px',
                                padding: isMobile ? '12px' : '16px',
                                boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                                display: 'flex',
                                gap: isMobile ? '12px' : '20px',
                                flexWrap: 'wrap',
                                justifyContent: 'center',
                                alignItems: 'center'
                            }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px', fontSize: '13px', color: '#65676B' }}>
                                    <div style={{ width: '20px', height: '20px', border: '2px solid #058585', borderRadius: '4px' }}></div>
                                    <span>Today</span>
                                </div>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px', fontSize: '13px', color: '#65676B' }}>
                                    <div style={{ width: '20px', height: '4px', background: '#058585', borderRadius: '2px' }}></div>
                                    <span>Scheduled Meeting</span>
                                </div>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px', fontSize: '13px', color: '#65676B' }}>
                                    <i data-lucide="calendar" style={{ width: '16px', height: '16px', color: '#058585' }}></i>
                                    <span>{isMobile ? 'Selected day' : 'Showing current week'}</span>
                                </div>
                            </div>
                        </div>
                    )}
                        
                    </div>
                </div>
            )}

            {/* My Day Post Creation Modal */}
            {showMyDayModal && (
                <>
                    {/* Backdrop */}
                    <div
                        onClick={() => !myDaySubmitting && setShowMyDayModal(false)}
                        style={{
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            backgroundColor: 'rgba(0, 0, 0, 0.6)',
                            zIndex: 999,
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            padding: 'var(--space-4)',
                            animation: 'fadeIn 0.2s ease'
                        }}
                    >
                        {/* Modal */}
                        <div
                            onClick={(e) => e.stopPropagation()}
                            style={{
                                background: '#fff',
                                borderRadius: 'var(--radius-lg)',
                                width: '100%',
                                maxWidth: '500px',
                                maxHeight: '90vh',
                                overflow: 'auto',
                                boxShadow: '0 8px 32px rgba(0,0,0,0.2)',
                                animation: 'slideUp 0.3s ease'
                            }}
                        >
                            {/* Modal Header */}
                            <div style={{
                                padding: 'var(--space-4)',
                                borderBottom: '1px solid #eee',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'space-between'
                            }}>
                                <h3 style={{ color: '#333', margin: 0, fontSize: 'var(--font-lg)', fontWeight: 'bold' }}>
                                    Share Your Day
                                </h3>
                                <button
                                    onClick={() => !myDaySubmitting && setShowMyDayModal(false)}
                                    disabled={myDaySubmitting}
                                    style={{
                                        background: 'transparent',
                                        border: 'none',
                                        cursor: myDaySubmitting ? 'not-allowed' : 'pointer',
                                        padding: 'var(--space-2)',
                                        opacity: myDaySubmitting ? 0.5 : 1
                                    }}
                                >
                                    <i data-lucide="x" style={{ width: '24px', height: '24px', color: '#666' }}></i>
                                </button>
                            </div>

                            {/* Modal Body */}
                            <div style={{ padding: 'var(--space-4)' }}>
                                {/* Post Type Toggle */}
                                <div style={{ marginBottom: 'var(--space-4)' }}>
                                    <label style={{
                                        display: 'block',
                                        color: '#333',
                                        fontSize: 'var(--font-sm)',
                                        fontWeight: '600',
                                        marginBottom: 'var(--space-2)'
                                    }}>
                                        Post Type
                                    </label>
                                    <div style={{ display: 'flex', gap: 'var(--space-2)' }}>
                                        <button
                                            onClick={() => !myDaySubmitting && setMyDayPostType('reflection')}
                                            disabled={myDaySubmitting}
                                            style={{
                                                flex: 1,
                                                padding: 'var(--space-3)',
                                                background: myDayPostType === 'reflection'
                                                    ? 'linear-gradient(135deg, #667eea, #764ba2)'
                                                    : '#f3f4f6',
                                                color: myDayPostType === 'reflection' ? '#fff' : '#666',
                                                border: 'none',
                                                borderRadius: 'var(--radius-md)',
                                                cursor: myDaySubmitting ? 'not-allowed' : 'pointer',
                                                fontSize: 'var(--font-sm)',
                                                fontWeight: '600',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                gap: 'var(--space-2)',
                                                transition: 'all 0.2s ease',
                                                opacity: myDaySubmitting ? 0.5 : 1
                                            }}
                                        >
                                            <i data-lucide="message-circle" style={{ width: '18px', height: '18px' }}></i>
                                            Reflection
                                        </button>
                                        <button
                                            onClick={() => !myDaySubmitting && setMyDayPostType('win')}
                                            disabled={myDaySubmitting}
                                            style={{
                                                flex: 1,
                                                padding: 'var(--space-3)',
                                                background: myDayPostType === 'win'
                                                    ? 'linear-gradient(135deg, #f093fb, #f5576c)'
                                                    : '#f3f4f6',
                                                color: myDayPostType === 'win' ? '#fff' : '#666',
                                                border: 'none',
                                                borderRadius: 'var(--radius-md)',
                                                cursor: myDaySubmitting ? 'not-allowed' : 'pointer',
                                                fontSize: 'var(--font-sm)',
                                                fontWeight: '600',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                gap: 'var(--space-2)',
                                                transition: 'all 0.2s ease',
                                                opacity: myDaySubmitting ? 0.5 : 1
                                            }}
                                        >
                                            <i data-lucide="trophy" style={{ width: '18px', height: '18px' }}></i>
                                            Today's Win
                                        </button>
                                    </div>
                                </div>

                                {/* Content Input */}
                                <div style={{ marginBottom: 'var(--space-4)' }}>
                                    <label style={{
                                        display: 'block',
                                        color: '#333',
                                        fontSize: 'var(--font-sm)',
                                        fontWeight: '600',
                                        marginBottom: 'var(--space-2)'
                                    }}>
                                        {myDayPostType === 'reflection' ? 'Your Reflection' : 'Your Win'}
                                    </label>
                                    <textarea
                                        value={myDayContent}
                                        onChange={(e) => setMyDayContent(e.target.value)}
                                        disabled={myDaySubmitting}
                                        placeholder={myDayPostType === 'reflection'
                                            ? "Share your thoughts, feelings, or insights from today..."
                                            : "What positive thing happened today? Celebrate your progress!"}
                                        style={{
                                            width: '100%',
                                            minHeight: '120px',
                                            padding: 'var(--space-3)',
                                            border: `2px solid ${myDayContent.length > 500 ? '#ef4444' : '#e5e7eb'}`,
                                            borderRadius: 'var(--radius-md)',
                                            fontSize: 'var(--font-base)',
                                            fontFamily: 'inherit',
                                            resize: 'vertical',
                                            outline: 'none',
                                            transition: 'border-color 0.2s ease',
                                            opacity: myDaySubmitting ? 0.5 : 1
                                        }}
                                        onFocus={(e) => {
                                            if (!myDaySubmitting) {
                                                e.target.style.borderColor = 'var(--color-primary)';
                                            }
                                        }}
                                        onBlur={(e) => {
                                            e.target.style.borderColor = myDayContent.length > 500 ? '#ef4444' : '#e5e7eb';
                                        }}
                                    />
                                    {/* Character Counter */}
                                    <div style={{
                                        marginTop: 'var(--space-2)',
                                        fontSize: 'var(--font-xs)',
                                        color: myDayContent.length > 500 ? '#ef4444' :
                                               myDayContent.length > 450 ? '#f59e0b' : '#666',
                                        textAlign: 'right',
                                        fontWeight: myDayContent.length > 450 ? '600' : '400'
                                    }}>
                                        {myDayContent.length}/500 characters
                                        {myDayContent.length > 500 && ' (limit exceeded)'}
                                        {myDayContent.length > 450 && myDayContent.length <= 500 && ' (approaching limit)'}
                                    </div>
                                </div>

                                {/* Image Upload Section */}
                                <div style={{ marginBottom: 'var(--space-4)' }}>
                                    <input
                                        type="file"
                                        id="myday-image-input"
                                        accept="image/*"
                                        style={{ display: 'none' }}
                                        onChange={handleImageSelect}
                                        disabled={myDaySubmitting || uploadingImage}
                                    />

                                    {!myDayImagePreview ? (
                                        <button
                                            onClick={() => document.getElementById('myday-image-input').click()}
                                            disabled={myDaySubmitting || uploadingImage}
                                            style={{
                                                width: '100%',
                                                padding: '12px',
                                                background: 'transparent',
                                                border: '2px dashed #CCD0D5',
                                                borderRadius: 'var(--radius-md)',
                                                color: '#65676B',
                                                fontSize: '14px',
                                                fontWeight: '500',
                                                cursor: (myDaySubmitting || uploadingImage) ? 'not-allowed' : 'pointer',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                gap: '8px',
                                                transition: 'all 0.2s ease',
                                                opacity: (myDaySubmitting || uploadingImage) ? 0.5 : 1
                                            }}
                                            onMouseOver={(e) => {
                                                if (!myDaySubmitting && !uploadingImage) {
                                                    e.currentTarget.style.borderColor = '#069494';
                                                    e.currentTarget.style.color = '#069494';
                                                }
                                            }}
                                            onMouseOut={(e) => {
                                                e.currentTarget.style.borderColor = '#CCD0D5';
                                                e.currentTarget.style.color = '#65676B';
                                            }}
                                        >
                                            <i data-lucide="image" style={{ width: '20px', height: '20px' }}></i>
                                            Add Photo (optional)
                                        </button>
                                    ) : (
                                        <div style={{ position: 'relative' }}>
                                            <img
                                                src={myDayImagePreview}
                                                alt="Preview"
                                                style={{
                                                    width: '100%',
                                                    maxHeight: '300px',
                                                    objectFit: 'contain',
                                                    borderRadius: '8px',
                                                    border: '1px solid #e5e7eb'
                                                }}
                                            />
                                            <button
                                                onClick={handleRemoveImage}
                                                disabled={myDaySubmitting || uploadingImage}
                                                style={{
                                                    position: 'absolute',
                                                    top: '8px',
                                                    right: '8px',
                                                    width: '32px',
                                                    height: '32px',
                                                    borderRadius: '50%',
                                                    background: 'rgba(0,0,0,0.6)',
                                                    border: 'none',
                                                    color: '#fff',
                                                    fontSize: '18px',
                                                    cursor: (myDaySubmitting || uploadingImage) ? 'not-allowed' : 'pointer',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    transition: 'background 0.2s ease'
                                                }}
                                                onMouseOver={(e) => {
                                                    if (!myDaySubmitting && !uploadingImage) {
                                                        e.currentTarget.style.background = 'rgba(0,0,0,0.8)';
                                                    }
                                                }}
                                                onMouseOut={(e) => {
                                                    e.currentTarget.style.background = 'rgba(0,0,0,0.6)';
                                                }}
                                            >
                                                Ã—
                                            </button>
                                            {uploadingImage && (
                                                <div style={{
                                                    marginTop: '12px',
                                                    padding: '12px',
                                                    background: '#F0F2F5',
                                                    borderRadius: '8px'
                                                }}>
                                                    <div style={{
                                                        display: 'flex',
                                                        justifyContent: 'space-between',
                                                        alignItems: 'center',
                                                        marginBottom: '8px'
                                                    }}>
                                                        <span style={{ fontSize: '14px', color: '#050505', fontWeight: 500 }}>
                                                            Uploading image...
                                                        </span>
                                                        <span style={{ fontSize: '14px', color: '#069494', fontWeight: 600 }}>
                                                            {Math.round(uploadProgress)}%
                                                        </span>
                                                    </div>
                                                    <div style={{
                                                        width: '100%',
                                                        height: '6px',
                                                        background: '#E4E6EB',
                                                        borderRadius: '3px',
                                                        overflow: 'hidden'
                                                    }}>
                                                        <div style={{
                                                            width: `${uploadProgress}%`,
                                                            height: '100%',
                                                            background: 'linear-gradient(90deg, #069494 0%, #048080 100%)',
                                                            transition: 'width 0.3s ease',
                                                            borderRadius: '3px'
                                                        }} />
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>

                                {/* Anonymous Posting Toggle */}
                                <div style={{
                                    marginBottom: 'var(--space-4)',
                                    padding: 'var(--space-3)',
                                    background: '#f9fafb',
                                    borderRadius: 'var(--radius-md)',
                                    border: '1px solid #e5e7eb'
                                }}>
                                    <label style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: 'var(--space-2)',
                                        cursor: myDaySubmitting ? 'not-allowed' : 'pointer',
                                        opacity: myDaySubmitting ? 0.5 : 1
                                    }}>
                                        <input
                                            type="checkbox"
                                            checked={myDayAnonymous}
                                            onChange={(e) => !myDaySubmitting && setMyDayAnonymous(e.target.checked)}
                                            disabled={myDaySubmitting}
                                            style={{
                                                width: '18px',
                                                height: '18px',
                                                cursor: myDaySubmitting ? 'not-allowed' : 'pointer'
                                            }}
                                        />
                                        <span style={{ color: '#333', fontSize: 'var(--font-sm)', fontWeight: '500' }}>
                                            Post anonymously
                                        </span>
                                    </label>
                                    <p style={{
                                        margin: '0',
                                        marginTop: 'var(--space-2)',
                                        marginLeft: '26px',
                                        fontSize: 'var(--font-xs)',
                                        color: '#666',
                                        lineHeight: '1.4'
                                    }}>
                                        Your post will appear as "Anonymous" to other community members.
                                        Coaches can still see your identity.
                                    </p>
                                </div>

                                {/* Community Notice */}
                                <div style={{
                                    padding: 'var(--space-3)',
                                    background: '#eff6ff',
                                    borderRadius: 'var(--radius-md)',
                                    border: '1px solid #bfdbfe',
                                    marginBottom: 'var(--space-4)'
                                }}>
                                    <div style={{ display: 'flex', alignItems: 'flex-start', gap: 'var(--space-2)' }}>
                                        <i data-lucide="info" style={{ width: '16px', height: '16px', color: '#3b82f6', marginTop: '2px', flexShrink: 0 }}></i>
                                        <p style={{
                                            margin: 0,
                                            fontSize: 'var(--font-xs)',
                                            color: '#1e40af',
                                            lineHeight: '1.4'
                                        }}>
                                            Your post will be visible to all community members. Share authentically and respectfully.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            {/* Modal Footer */}
                            <div style={{
                                padding: 'var(--space-4)',
                                borderTop: '1px solid #eee',
                                display: 'flex',
                                gap: 'var(--space-3)',
                                justifyContent: 'flex-end'
                            }}>
                                <button
                                    onClick={() => setShowMyDayModal(false)}
                                    disabled={myDaySubmitting}
                                    style={{
                                        padding: 'var(--space-3) var(--space-4)',
                                        background: 'transparent',
                                        border: '1px solid #d1d5db',
                                        borderRadius: 'var(--radius-md)',
                                        color: '#666',
                                        fontSize: 'var(--font-sm)',
                                        fontWeight: '600',
                                        cursor: myDaySubmitting ? 'not-allowed' : 'pointer',
                                        opacity: myDaySubmitting ? 0.5 : 1
                                    }}
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={handleMyDaySubmit}
                                    disabled={myDaySubmitting || !myDayContent.trim() || myDayContent.length > 500}
                                    style={{
                                        padding: 'var(--space-3) var(--space-4)',
                                        background: (myDaySubmitting || !myDayContent.trim() || myDayContent.length > 500)
                                            ? '#d1d5db'
                                            : 'linear-gradient(135deg, var(--color-primary), var(--color-secondary))',
                                        border: 'none',
                                        borderRadius: 'var(--radius-md)',
                                        color: '#fff',
                                        fontSize: 'var(--font-sm)',
                                        fontWeight: 'bold',
                                        cursor: (myDaySubmitting || !myDayContent.trim() || myDayContent.length > 500)
                                            ? 'not-allowed'
                                            : 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: 'var(--space-2)',
                                        boxShadow: (myDaySubmitting || !myDayContent.trim() || myDayContent.length > 500)
                                            ? 'none'
                                            : '0 2px 8px rgba(5,133,133,0.3)'
                                    }}
                                >
                                    {myDaySubmitting ? (
                                        <>
                                            <i data-lucide="loader" style={{ width: '16px', height: '16px', animation: 'spin 1s linear infinite' }}></i>
                                            Posting...
                                        </>
                                    ) : (
                                        <>
                                            <i data-lucide="send" style={{ width: '16px', height: '16px' }}></i>
                                            Share Post
                                        </>
                                    )}
                                </button>
                            </div>
                        </div>
                    </div>
                </>
            )}

            {/* PROFILE MODAL (Shared across My Day and Community Chat) */}
            {showProfileModal && (
                <div
                    onClick={handleCloseProfile}
                    style={{
                        position: 'fixed',
                        top: 0,
                        left: 0,
                        right: 0,
                        bottom: 0,
                        background: 'rgba(0, 0, 0, 0.6)',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        zIndex: 10000,
                        padding: '20px'
                    }}
                >
                    <div
                        onClick={(e) => e.stopPropagation()}
                        style={{
                            background: '#FFFFFF',
                            borderRadius: '12px',
                            maxWidth: '500px',
                            width: '100%',
                            maxHeight: '90vh',
                            overflow: 'auto',
                            boxShadow: '0 8px 32px rgba(0, 0, 0, 0.2)',
                            position: 'relative'
                        }}
                    >
                        <button
                            onClick={handleCloseProfile}
                            style={{
                                position: 'absolute',
                                top: '16px',
                                right: '16px',
                                background: 'transparent',
                                border: 'none',
                                fontSize: '28px',
                                color: '#65676B',
                                cursor: 'pointer',
                                lineHeight: 1,
                                padding: '4px',
                                zIndex: 1
                            }}
                            title="Close"
                        >
                            Ã—
                        </button>

                        {profileLoading && (
                            <div style={{ padding: '60px 40px', textAlign: 'center' }}>
                                <div style={{
                                    width: '48px',
                                    height: '48px',
                                    border: '4px solid #f3f3f3',
                                    borderTop: '4px solid #069494',
                                    borderRadius: '50%',
                                    animation: 'spin 1s linear infinite',
                                    margin: '0 auto 16px'
                                }}></div>
                                <p style={{ color: '#65676B', fontSize: '14px', margin: 0 }}>Loading profile...</p>
                            </div>
                        )}

                        {profileError && !profileLoading && (
                            <div style={{ padding: '60px 40px', textAlign: 'center' }}>
                                <div style={{ fontSize: '48px', marginBottom: '16px' }}>âš ï¸</div>
                                <h3 style={{ color: '#333', fontSize: '18px', fontWeight: 'bold', marginBottom: '8px' }}>
                                    Failed to load profile
                                </h3>
                                <p style={{ color: '#65676B', fontSize: '14px', marginBottom: '24px' }}>
                                    {profileError}
                                </p>
                                <button
                                    onClick={handleCloseProfile}
                                    style={{
                                        padding: '10px 24px',
                                        background: '#069494',
                                        color: '#FFFFFF',
                                        border: 'none',
                                        borderRadius: '8px',
                                        fontSize: '14px',
                                        fontWeight: '600',
                                        cursor: 'pointer'
                                    }}
                                >
                                    Close
                                </button>
                            </div>
                        )}

                        {profileData && !profileLoading && !profileError && (
                            <div style={{ padding: '24px' }}>
                                <div style={{ textAlign: 'center', marginBottom: '24px', paddingTop: '12px' }}>
                                    <h3 style={{ fontSize: '20px', fontWeight: 'bold', color: '#050505', marginBottom: '4px' }}>
                                        {profileData.displayName}
                                    </h3>
                                    <div style={{ fontSize: '13px', color: '#65676B', textTransform: 'capitalize' }}>
                                        {profileData.role || 'Member'}
                                    </div>
                                </div>

                                <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                    {profileData.memberSince && (
                                        <div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>
                                            <div style={{ fontSize: '20px', flexShrink: 0 }}>ðŸ“…</div>
                                            <div style={{ flex: 1 }}>
                                                <div style={{ fontSize: '13px', color: '#65676B', marginBottom: '4px' }}>
                                                    Member Since
                                                </div>
                                                <div style={{ fontSize: '15px', color: '#050505', fontWeight: '600' }}>
                                                    {new Date(profileData.memberSince.seconds * 1000).toLocaleDateString()}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {profileData.sobrietyDate && (
                                        <div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>
                                            <div style={{ fontSize: '20px', flexShrink: 0 }}>ðŸŒŸ</div>
                                            <div style={{ flex: 1 }}>
                                                <div style={{ fontSize: '13px', color: '#65676B', marginBottom: '4px' }}>
                                                    Sobriety Date
                                                </div>
                                                <div style={{ fontSize: '15px', color: '#050505', fontWeight: '600' }}>
                                                    {profileData.sobrietyDate}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {profileData.recoveryGoals && (
                                        <div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>
                                            <div style={{ fontSize: '20px', flexShrink: 0 }}>ðŸŽ¯</div>
                                            <div style={{ flex: 1 }}>
                                                <div style={{ fontSize: '13px', color: '#65676B', marginBottom: '4px' }}>
                                                    Recovery Goals
                                                </div>
                                                <div style={{ fontSize: '15px', color: '#050505', fontWeight: '600' }}>
                                                    {profileData.recoveryGoals}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {profileData.completedGoals !== null && profileData.completedGoals !== undefined && (
                                        <div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>
                                            <div style={{ fontSize: '20px', flexShrink: 0 }}>âœ…</div>
                                            <div style={{ flex: 1 }}>
                                                <div style={{ fontSize: '13px', color: '#65676B', marginBottom: '4px' }}>
                                                    Completed Goals
                                                </div>
                                                <div style={{ fontSize: '15px', color: '#050505', fontWeight: '600' }}>
                                                    {profileData.completedGoals}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {profileData.timezone && (
                                        <div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>
                                            <div style={{ fontSize: '20px', flexShrink: 0 }}>ðŸŒ</div>
                                            <div style={{ flex: 1 }}>
                                                <div style={{ fontSize: '13px', color: '#65676B', marginBottom: '4px' }}>
                                                    Timezone
                                                </div>
                                                <div style={{ fontSize: '15px', color: '#050505', fontWeight: '600' }}>
                                                    {profileData.timezone}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {!profileData.memberSince && !profileData.sobrietyDate && !profileData.recoveryGoals &&
                                     profileData.completedGoals === null && !profileData.timezone && (
                                        <div style={{
                                            textAlign: 'center',
                                            padding: '32px 16px',
                                            color: '#65676B',
                                            fontSize: '14px'
                                        }}>
                                            <div style={{ fontSize: '36px', marginBottom: '12px' }}>ðŸ”’</div>
                                            This user has hidden their profile information.
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            )}

            {/* Meeting Browser - Full Page View */}
            {showBrowser && window.GLRSApp?.components?.MeetingBrowser &&
                React.createElement(window.GLRSApp.components.MeetingBrowser, {
                    onBack: () => setShowBrowser(false),
                    externalMeetings: externalMeetings,
                    onAddMeeting: (meeting) => {
                        // Reload meetings after adding
                        loadMeetings();
                    },
                    currentUserId: user?.uid,
                    isMobile: isMobile
                })
            }

            {/* Connect Tools Sidebar */}
            {showSidebar && (
                <>
                    {/* Backdrop */}
                    <div
                        style={{
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            backgroundColor: 'rgba(0, 0, 0, 0.5)',
                            zIndex: 999,
                            transition: 'opacity 0.3s ease'
                        }}
                        onClick={() => {
                            if (window.GLRSApp?.utils?.triggerHaptic) window.GLRSApp.utils.triggerHaptic('light');
                            setShowSidebar(false);
                        }}
                    />

                    {/* Sidebar Panel */}
                    <div style={{
                        position: 'fixed',
                        top: 0,
                        left: 0,
                        bottom: 0,
                        width: '280px',
                        backgroundColor: '#FFFFFF',
                        boxShadow: '2px 0 8px rgba(0, 0, 0, 0.15)',
                        zIndex: 1000,
                        display: 'flex',
                        flexDirection: 'column',
                        transition: 'transform 0.3s ease',
                        transform: 'translateX(0)'
                    }}>
                        {/* Sidebar Header */}
                        <div style={{
                            padding: '20px',
                            borderBottom: '1px solid #E5E5E5',
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            background: 'linear-gradient(135deg, #058585 0%, #047373 100%)'
                        }}>
                            <h2 style={{
                                margin: 0,
                                fontSize: '18px',
                                fontWeight: 'bold',
                                color: '#FFFFFF'
                            }}>
                                ðŸŒ Connect Tools
                            </h2>
                            <button
                                onClick={() => {
                                    if (window.GLRSApp?.utils?.triggerHaptic) window.GLRSApp.utils.triggerHaptic('light');
                                    setShowSidebar(false);
                                }}
                                style={{
                                    background: 'rgba(255, 255, 255, 0.2)',
                                    border: 'none',
                                    cursor: 'pointer',
                                    padding: '8px',
                                    borderRadius: '6px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center'
                                }}
                            >
                                <i data-lucide="x" style={{ width: '20px', height: '20px', color: '#FFFFFF' }}></i>
                            </button>
                        </div>

                        {/* Sidebar Content */}
                        <div style={{
                            flex: 1,
                            overflowY: 'auto',
                            padding: '20px'
                        }}>
                            {/* In Progress Message */}
                            <div style={{
                                background: 'linear-gradient(135deg, rgba(5, 133, 133, 0.1) 0%, rgba(4, 115, 115, 0.05) 100%)',
                                borderRadius: '12px',
                                padding: '24px',
                                border: '2px solid rgba(5, 133, 133, 0.3)',
                                textAlign: 'center'
                            }}>
                                <i data-lucide="construction" style={{
                                    width: '48px',
                                    height: '48px',
                                    color: '#058585',
                                    marginBottom: '16px',
                                    strokeWidth: 2,
                                    display: 'block',
                                    margin: '0 auto 16px'
                                }}></i>
                                <h3 style={{
                                    fontSize: '18px',
                                    color: '#2c3e50',
                                    marginBottom: '12px',
                                    fontWeight: '700'
                                }}>
                                    Connect Tools In Progress
                                </h3>
                                <p style={{
                                    fontSize: '14px',
                                    color: '#666',
                                    lineHeight: '1.6',
                                    margin: 0
                                }}>
                                    We're currently developing additional tools and features to enhance your ability to connect with peers and attend meetings. Check back soon for updates!
                                </p>
                            </div>
                        </div>
                    </div>
                </>
            )}
        </div>
</div>
    );
}

/**
 * CommunityChat Component
 * @description Chat/feed UI component for displaying and sending community messages
 *
 * @features
 * - Auto-scrolling message feed
 * - Message composition with text and image support
 * - Image preview before sending
 * - Like/comment functionality (UI only - logic in parent)
 * - Flag content button for moderation
 * - Full-screen image viewing
 * - Upload indicator during image upload
 *
 * @props
 * - messages: array - Array of message objects to display
 * - onSendMessage: function - Callback to send new message (text, imageUrl)
 * - currentUserId: string - Current user's ID to identify own messages
 * - uploadChatImage: function - Callback to upload image and return URL
 * - flagContent: function - Callback to flag content for moderation
 * - setModalImage: function - Callback to show full-screen image
 *
 * @state 5 useState hooks:
 * - message: string - Message input text
 * - selectedImage: File - Selected image file
 * - uploading: boolean - Upload in progress
 * - likes: object - Like counts (UI only)
 * - showComments: object - Comment visibility state
 *
 * @architecture Props-based component (NO Firebase queries)
 * - All data comes from props
 * - All actions use callbacks
 * - Pure UI component
 *
 * @returns {React.Element} Chat feed UI with message list and input
 */
function CommunityChat({
    messages, onSendMessage, currentUserId, uploadChatImage, flagContent, setModalImage, onReaction, currentUser, currentUserData,
    showComments, toggleComments, commentText, setCommentText, postComments, loadingComments, submittingComment,
    handleAddComment, handleDeleteComment, handleDeletePost, handleReportPost, isCoachOrAdmin, formatMyDayTimestamp, isAnonymous, setIsAnonymous,
    handleAvatarClick, isMobile
}) {
    // PHASE 2: Profile modal props from parent
    const [message, setMessage] = useState('');
    const [selectedImage, setSelectedImage] = useState(null);
    const [uploading, setUploading] = useState(false);
    const messagesEndRef = useRef(null);

    // PHASE 3: Three-dot menu state
    const [openPostMenu, setOpenPostMenu] = useState(null);

    // PHASE 3: Nested reply state
    const [replyingTo, setReplyingTo] = useState(null);
    const [replyText, setReplyText] = useState('');
    const [expandedReplies, setExpandedReplies] = useState({});
    const [commentReplies, setCommentReplies] = useState({});
    const [loadingReplies, setLoadingReplies] = useState({});

    useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
    }, [messages]);

    // PHASE 3: Click-outside handler for three-dot menu
    useEffect(() => {
        const handleClickOutside = (event) => {
            if (openPostMenu) {
                const menuButton = event.target.closest('[data-post-menu-button]');
                const menuDropdown = event.target.closest('[data-post-menu-dropdown]');
                if (!menuButton && !menuDropdown) {
                    setOpenPostMenu(null);
                }
            }
        };
        document.addEventListener('click', handleClickOutside);
        return () => document.removeEventListener('click', handleClickOutside);
    }, [openPostMenu]);

    const handleImageSelect = (e) => {
        const file = e.target.files[0];
        if (file) {
            setSelectedImage(file);
        }
    };

    const handleSend = async () => {
        if ((message.trim() || selectedImage) && !uploading) {
            setUploading(true);

            try {
                let imageUrl = null;

                if (selectedImage && uploadChatImage) {
                    imageUrl = await uploadChatImage(selectedImage, 'community', 'main');
                }

                await onSendMessage(message, imageUrl, isAnonymous);

                setMessage('');
                setSelectedImage(null);
                const fileInput = document.getElementById('community-image-input');
                if (fileInput) fileInput.value = '';

            } catch (error) {
                alert('Failed to send message');
            } finally {
                setUploading(false);
            }
        }
    };

    // PHASE 3: Three-dot menu handlers (Delete/Report/Block)
    // handleDeletePost and handleReportPost are now passed as props from parent

    const handleBlockUser = async (msg) => {
        setOpenPostMenu(null);
        if (msg.senderId === currentUserId) {
            alert('You cannot block yourself.');
            return;
        }
        if (msg.isAnonymous) {
            alert('Cannot block anonymous users.');
            return;
        }

        if (!confirm(`Block ${msg.senderName}? Their posts will no longer appear in your feed.`)) return;

        alert(`${msg.senderName} has been blocked.`);
        // TODO: Add actual block implementation
    };

    // PHASE 3: Reply handlers (simplified for Community Chat)
    const handleStartReply = (commentId, userDisplayName) => {
        setReplyingTo(commentId);
        setReplyText(`@${userDisplayName} `);
    };

    const handleCancelReply = () => {
        setReplyingTo(null);
        setReplyText('');
    };

    const handleAddReply = async (messageId, parentCommentId, parentComment) => {
        const content = replyText.trim();
        if (!currentUser || !content) return;

        alert('Reply functionality coming soon');
        handleCancelReply();
    };

    const handleToggleReplies = (commentId) => {
        setExpandedReplies(prev => ({ ...prev, [commentId]: !prev[commentId] }));
    };

    const getInitials = (name) => {
        if (!name) return 'A';
        const parts = name.split(' ');
        return parts.length > 1
            ? parts[0][0] + parts[1][0]
            : parts[0][0];
    };

    const formatTimeAgo = (timestamp) => {
        if (!timestamp?.toDate) return 'now';
        const date = timestamp.toDate();
        const seconds = Math.floor((new Date() - date) / 1000);

        if (seconds < 60) return 'just now';
        if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
        if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
        return `${Math.floor(seconds / 86400)}d ago`;
    };

    return (
        <div style={{marginBottom: 'var(--space-4)'}}>
            {/* Create Post Card */}
            <div style={{
                background: 'rgba(255,255,255,0.95)',
                borderRadius: 'var(--radius-lg)',
                padding: 'var(--space-4)',
                marginBottom: 'var(--space-4)',
                boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
            }}>
                <div style={{display: 'flex', gap: 'var(--space-3)', alignItems: 'flex-start'}}>
                    <div style={{
                        width: isMobile ? '36px' : '40px',
                        height: isMobile ? '36px' : '40px',
                        borderRadius: '50%',
                        background: currentUserData?.profileImageUrl ? 'transparent' : 'linear-gradient(135deg, var(--color-primary), var(--color-secondary))',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        color: '#fff',
                        fontSize: isMobile ? '13px' : 'var(--font-sm)',
                        fontWeight: 'bold',
                        flexShrink: 0,
                        overflow: 'hidden'
                    }}>
                        {currentUserData?.profileImageUrl ? (
                            <img src={currentUserData.profileImageUrl} alt="Profile"
                                 style={{width: '100%', height: '100%', objectFit: 'cover'}} />
                        ) : (
                            getInitials('You')
                        )}
                    </div>
                    <div style={{flex: 1}}>
                        <input
                            type="text"
                            placeholder="What's on your mind?"
                            value={message}
                            onChange={(e) => setMessage(e.target.value)}
                            onKeyPress={(e) => e.key === 'Enter' && handleSend()}
                            style={{
                                width: '100%',
                                padding: 'var(--space-3)',
                                border: '1px solid #ddd',
                                borderRadius: 'var(--radius-lg)',
                                fontSize: 'var(--font-base)',
                                background: '#f8f9fa',
                                outline: 'none'
                            }}
                        />
                        {selectedImage && (
                            <div style={{
                                marginTop: 'var(--space-2)',
                                padding: 'var(--space-2)',
                                background: '#e7f5ff',
                                borderRadius: 'var(--radius-md)',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'space-between'
                            }}>
                                <span style={{fontSize: 'var(--font-sm)', color: '#333'}}>
                                    <i data-lucide="image" style={{width: '16px', height: '16px', marginRight: '8px'}}></i>
                                    {selectedImage.name}
                                </span>
                                <button
                                    onClick={() => setSelectedImage(null)}
                                    style={{
                                        background: 'transparent',
                                        border: 'none',
                                        cursor: 'pointer',
                                        padding: '4px'
                                    }}
                                >
                                    <i data-lucide="x" style={{width: '16px', height: '16px', color: '#666'}}></i>
                                </button>
                            </div>
                        )}
                        {/* Anonymous posting checkbox */}
                        <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: 'var(--space-2)',
                            marginTop: 'var(--space-3)',
                            fontSize: 'var(--font-sm)',
                            color: '#666'
                        }}>
                            <input
                                type="checkbox"
                                id="community-anonymous"
                                checked={isAnonymous}
                                onChange={(e) => setIsAnonymous(e.target.checked)}
                                style={{
                                    width: '16px',
                                    height: '16px',
                                    cursor: 'pointer'
                                }}
                            />
                            <label htmlFor="community-anonymous" style={{cursor: 'pointer'}}>
                                Post anonymously
                            </label>
                        </div>
                        <div style={{
                            display: 'flex',
                            gap: 'var(--space-2)',
                            marginTop: 'var(--space-3)',
                            paddingTop: 'var(--space-3)',
                            borderTop: '1px solid #eee'
                        }}>
                            <input
                                type="file"
                                id="community-image-input"
                                accept="image/*"
                                style={{display: 'none'}}
                                onChange={handleImageSelect}
                            />
                            <button
                                onClick={() => document.getElementById('community-image-input').click()}
                                style={{
                                    flex: 1,
                                    padding: 'var(--space-2)',
                                    background: 'transparent',
                                    border: 'none',
                                    borderRadius: 'var(--radius-md)',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    gap: 'var(--space-1)',
                                    fontSize: 'var(--font-sm)',
                                    color: '#666',
                                    fontWeight: '500'
                                }}
                            >
                                <i data-lucide="image" style={{width: '20px', height: '20px'}}></i>
                                Photo
                            </button>
                            <button
                                onClick={handleSend}
                                disabled={uploading || (!message.trim() && !selectedImage)}
                                style={{
                                    padding: 'var(--space-2) var(--space-4)',
                                    background: (uploading || (!message.trim() && !selectedImage))
                                        ? '#ccc'
                                        : 'linear-gradient(135deg, var(--color-primary), var(--color-secondary))',
                                    border: 'none',
                                    borderRadius: 'var(--radius-md)',
                                    color: '#fff',
                                    fontSize: 'var(--font-sm)',
                                    fontWeight: 'bold',
                                    cursor: (uploading || (!message.trim() && !selectedImage)) ? 'not-allowed' : 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: 'var(--space-1)'
                                }}
                            >
                                {uploading ? (
                                    <>
                                        <i data-lucide="loader" style={{width: '16px', height: '16px', animation: 'spin 1s linear infinite'}}></i>
                                        Posting...
                                    </>
                                ) : (
                                    <>
                                        <i data-lucide="send" style={{width: '16px', height: '16px'}}></i>
                                        Post
                                    </>
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            {/* Feed Posts */}
            <div>
                {messages?.length > 0 ? (
                    messages.slice().reverse().map(msg => (
                        <div key={msg.id} style={{
                            background: 'rgba(255,255,255,0.95)',
                            borderRadius: 'var(--radius-lg)',
                            padding: 'var(--space-4)',
                            marginBottom: 'var(--space-4)',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                        }}>
                            {/* Post Header */}
                            <div style={{display: 'flex', alignItems: 'center', marginBottom: 'var(--space-3)'}}>
                                {/* Avatar - CLICKABLE (PHASE 3) */}
                                <div
                                    onClick={() => handleAvatarClick && handleAvatarClick(msg.senderId, msg.isAnonymous)}
                                    style={{
                                        width: isMobile ? '36px' : '40px',
                                        height: isMobile ? '36px' : '40px',
                                        borderRadius: '50%',
                                        background: (msg.isAnonymous || !msg.senderProfileImageUrl) ? 'linear-gradient(135deg, var(--color-secondary), var(--color-accent))' : 'transparent',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        color: '#fff',
                                        fontSize: isMobile ? '13px' : 'var(--font-sm)',
                                        fontWeight: 'bold',
                                        marginRight: 'var(--space-3)',
                                        overflow: 'hidden',
                                        cursor: msg.isAnonymous ? 'default' : 'pointer',
                                        transition: 'transform 0.2s ease'
                                    }}
                                    onMouseEnter={(e) => { if (!msg.isAnonymous) e.currentTarget.style.transform = 'scale(1.05)'; }}
                                    onMouseLeave={(e) => { e.currentTarget.style.transform = 'scale(1)'; }}
                                >
                                    {msg.isAnonymous ? (
                                        'A'
                                    ) : msg.senderProfileImageUrl ? (
                                        <img src={msg.senderProfileImageUrl} alt="Profile"
                                             style={{width: '100%', height: '100%', objectFit: 'cover'}} />
                                    ) : (
                                        getInitials(msg.senderName)
                                    )}
                                </div>
                                <div style={{flex: 1}}>
                                    {/* Display Name - CLICKABLE (PHASE 3) */}
                                    <div
                                        onClick={() => handleAvatarClick && handleAvatarClick(msg.senderId, msg.isAnonymous)}
                                        style={{
                                            fontWeight: '600',
                                            color: '#333',
                                            fontSize: 'var(--font-base)',
                                            cursor: msg.isAnonymous ? 'default' : 'pointer',
                                            transition: 'color 0.2s ease',
                                            display: 'inline-block'
                                        }}
                                        onMouseEnter={(e) => { if (!msg.isAnonymous) e.currentTarget.style.color = '#069494'; }}
                                        onMouseLeave={(e) => { e.currentTarget.style.color = '#333'; }}
                                    >
                                        {msg.senderName || 'Anonymous'}
                                    </div>
                                    <div style={{fontSize: 'var(--font-xs)', color: '#666'}}>
                                        {formatTimeAgo(msg.createdAt)}
                                    </div>
                                </div>

                                {/* Three-Dot Menu (PHASE 3) */}
                                <div style={{ position: 'relative' }}>
                                    <button
                                        data-post-menu-button
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            setOpenPostMenu(openPostMenu === msg.id ? null : msg.id);
                                        }}
                                        style={{
                                            background: 'transparent',
                                            border: 'none',
                                            cursor: 'pointer',
                                            padding: '8px',
                                            color: '#65676B',
                                            fontSize: '20px',
                                            lineHeight: 1
                                        }}
                                        title="More options"
                                    >
                                        â‹¯
                                    </button>

                                    {/* Dropdown Menu (PHASE 3 & 4) */}
                                    {openPostMenu === msg.id && (
                                        <div
                                            data-post-menu-dropdown
                                            style={{
                                                position: 'absolute',
                                                top: '100%',
                                                right: 0,
                                                background: '#FFFFFF',
                                                border: '1px solid #CCD0D5',
                                                borderRadius: '8px',
                                                boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                                                minWidth: '180px',
                                                zIndex: 1000,
                                                overflow: 'hidden'
                                            }}
                                        >
                                            {(msg.senderId === currentUserId || isCoachOrAdmin()) && (
                                                <button
                                                    onClick={() => handleDeletePost(msg.id, msg)}
                                                    style={{
                                                        width: '100%',
                                                        padding: '12px 16px',
                                                        background: 'transparent',
                                                        border: 'none',
                                                        textAlign: 'left',
                                                        cursor: 'pointer',
                                                        fontSize: '15px',
                                                        color: '#E4405F',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: '12px',
                                                        transition: 'background 0.2s ease'
                                                    }}
                                                    onMouseOver={(e) => { e.currentTarget.style.background = '#F0F2F5'; }}
                                                    onMouseOut={(e) => { e.currentTarget.style.background = 'transparent'; }}
                                                >
                                                    <i data-lucide="trash-2" style={{width: '18px', height: '18px'}}></i>
                                                    Delete Post
                                                </button>
                                            )}
                                            <button
                                                onClick={() => handleReportPost(msg.id, msg)}
                                                style={{
                                                    width: '100%',
                                                    padding: '12px 16px',
                                                    background: 'transparent',
                                                    border: 'none',
                                                    textAlign: 'left',
                                                    cursor: 'pointer',
                                                    fontSize: '15px',
                                                    color: '#050505',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '12px',
                                                    transition: 'background 0.2s ease'
                                                }}
                                                onMouseOver={(e) => { e.currentTarget.style.background = '#F0F2F5'; }}
                                                onMouseOut={(e) => { e.currentTarget.style.background = 'transparent'; }}
                                            >
                                                <i data-lucide="alert-triangle" style={{width: '18px', height: '18px'}}></i>
                                                Report Post
                                            </button>
                                            {msg.senderId !== currentUserId && !msg.isAnonymous && (
                                                <button
                                                    onClick={() => handleBlockUser(msg)}
                                                    style={{
                                                        width: '100%',
                                                        padding: '12px 16px',
                                                        background: 'transparent',
                                                        border: 'none',
                                                        textAlign: 'left',
                                                        cursor: 'pointer',
                                                        fontSize: '15px',
                                                        color: '#E4405F',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: '12px',
                                                        transition: 'background 0.2s ease'
                                                    }}
                                                    onMouseOver={(e) => { e.currentTarget.style.background = '#F0F2F5'; }}
                                                    onMouseOut={(e) => { e.currentTarget.style.background = 'transparent'; }}
                                                >
                                                    <i data-lucide="ban" style={{width: '18px', height: '18px'}}></i>
                                                    Block User
                                                </button>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Post Content */}
                            {msg.content && (
                                <div style={{
                                    color: '#333',
                                    fontSize: 'var(--font-base)',
                                    lineHeight: '1.5',
                                    marginBottom: msg.imageUrl ? 'var(--space-3)' : 0
                                }}>
                                    {msg.content}
                                </div>
                            )}

                            {/* Post Image */}
                            {msg.imageUrl && (
                                <img
                                    src={msg.imageUrl}
                                    alt="Post content"
                                    style={{
                                        width: '100%',
                                        maxWidth: isMobile ? 'none' : '500px',
                                        borderRadius: 'var(--radius-md)',
                                        cursor: 'pointer',
                                        display: 'block'
                                    }}
                                    onClick={() => setModalImage(msg.imageUrl)}
                                />
                            )}

                            {/* Reactions Section */}
                            <div style={{
                                paddingTop: '12px',
                                borderTop: '1px solid #E4E6EB'
                            }}>
                                {/* Reaction Buttons */}
                                <div style={{
                                    display: 'flex',
                                    gap: '8px',
                                    marginBottom: '8px'
                                }}>
                                    {/* Heart Button */}
                                    <button
                                        onClick={() => onReaction && onReaction(msg.id, 'heart')}
                                        style={{
                                            flex: 1,
                                            padding: '8px',
                                            background: msg.reactedBy?.[currentUserId] === 'heart' ? '#F0F2F5' : 'transparent',
                                            color: msg.reactedBy?.[currentUserId] === 'heart' ? '#F02849' : '#65676B',
                                            border: 'none',
                                            borderRadius: '6px',
                                            fontSize: '15px',
                                            fontWeight: msg.reactedBy?.[currentUserId] === 'heart' ? '600' : '400',
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            gap: '6px',
                                            transition: 'all 0.2s ease',
                                            minHeight: '36px'
                                        }}
                                        onMouseOver={(e) => { e.currentTarget.style.background = '#F0F2F5'; }}
                                        onMouseOut={(e) => {
                                            e.currentTarget.style.background = msg.reactedBy?.[currentUserId] === 'heart' ? '#F0F2F5' : 'transparent';
                                        }}
                                    >
                                        <span>â¤ï¸</span>
                                        <span>Heart</span>
                                        {(msg.reactions?.heart?.length || 0) > 0 && (
                                            <span style={{ fontSize: '13px', opacity: 0.8 }}>
                                                ({msg.reactions.heart.length})
                                            </span>
                                        )}
                                    </button>

                                    {/* Support Button */}
                                    <button
                                        onClick={() => onReaction && onReaction(msg.id, 'support')}
                                        style={{
                                            flex: 1,
                                            padding: '8px',
                                            background: msg.reactedBy?.[currentUserId] === 'support' ? '#F0F2F5' : 'transparent',
                                            color: msg.reactedBy?.[currentUserId] === 'support' ? '#1877F2' : '#65676B',
                                            border: 'none',
                                            borderRadius: '6px',
                                            fontSize: '15px',
                                            fontWeight: msg.reactedBy?.[currentUserId] === 'support' ? '600' : '400',
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            gap: '6px',
                                            transition: 'all 0.2s ease',
                                            minHeight: '36px'
                                        }}
                                        onMouseOver={(e) => { e.currentTarget.style.background = '#F0F2F5'; }}
                                        onMouseOut={(e) => {
                                            e.currentTarget.style.background = msg.reactedBy?.[currentUserId] === 'support' ? '#F0F2F5' : 'transparent';
                                        }}
                                    >
                                        <span>ðŸ¤</span>
                                        <span>Support</span>
                                        {(msg.reactions?.support?.length || 0) > 0 && (
                                            <span style={{ fontSize: '13px', opacity: 0.8 }}>
                                                ({msg.reactions.support.length})
                                            </span>
                                        )}
                                    </button>

                                    {/* Celebrate Button */}
                                    <button
                                        onClick={() => onReaction && onReaction(msg.id, 'celebrate')}
                                        style={{
                                            flex: 1,
                                            padding: '8px',
                                            background: msg.reactedBy?.[currentUserId] === 'celebrate' ? '#F0F2F5' : 'transparent',
                                            color: msg.reactedBy?.[currentUserId] === 'celebrate' ? '#FFA500' : '#65676B',
                                            border: 'none',
                                            borderRadius: '6px',
                                            fontSize: '15px',
                                            fontWeight: msg.reactedBy?.[currentUserId] === 'celebrate' ? '600' : '400',
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            gap: '6px',
                                            transition: 'all 0.2s ease',
                                            minHeight: '36px'
                                        }}
                                        onMouseOver={(e) => { e.currentTarget.style.background = '#F0F2F5'; }}
                                        onMouseOut={(e) => {
                                            e.currentTarget.style.background = msg.reactedBy?.[currentUserId] === 'celebrate' ? '#F0F2F5' : 'transparent';
                                        }}
                                    >
                                        <span>ðŸŽ‰</span>
                                        <span>Celebrate</span>
                                        {(msg.reactions?.celebrate?.length || 0) > 0 && (
                                            <span style={{ fontSize: '13px', opacity: 0.8 }}>
                                                ({msg.reactions.celebrate.length})
                                            </span>
                                        )}
                                    </button>
                                </div>

                                {/* Comment Count - Clickable (Copied from My Day) */}
                                <div
                                    onClick={() => toggleComments(msg.id)}
                                    style={{
                                        fontSize: '13px',
                                        color: '#069494',
                                        paddingTop: '8px',
                                        cursor: 'pointer',
                                        fontWeight: '500',
                                        display: 'inline-flex',
                                        alignItems: 'center',
                                        gap: '4px'
                                    }}
                                >
                                    ðŸ’¬ {msg.commentCount || 0} comments
                                    {showComments[msg.id] ? ' â–²' : ' â–¼'}
                                </div>
                            </div>

                            {/* Comments Section (Expandable) - Copied from My Day */}
                            {showComments[msg.id] && (
                                <div style={{
                                    paddingTop: '12px',
                                    borderTop: '1px solid #E4E6EB',
                                    marginTop: '8px'
                                }}>
                                    {/* Comments List */}
                                    {loadingComments[msg.id] ? (
                                        <div style={{ padding: '20px', textAlign: 'center', color: '#65676B', fontSize: '13px' }}>
                                            Loading comments...
                                        </div>
                                    ) : (postComments[msg.id] || []).length === 0 ? (
                                        <div style={{ padding: '20px', textAlign: 'center', color: '#65676B', fontSize: '13px' }}>
                                            No comments yet. Be the first to comment!
                                        </div>
                                    ) : (
                                        (postComments[msg.id] || []).map(comment => (
                                            <div key={comment.id} style={{
                                                background: '#F0F2F5',
                                                borderRadius: '16px',
                                                padding: '8px 12px',
                                                marginBottom: '8px'
                                            }}>
                                                {/* Comment Header */}
                                                <div style={{ display: 'flex', alignItems: 'center', marginBottom: '4px' }}>
                                                    {/* Avatar */}
                                                    <div style={{
                                                        width: '24px',
                                                        height: '24px',
                                                        borderRadius: '50%',
                                                        background: 'linear-gradient(135deg, #069494, #058585)',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        justifyContent: 'center',
                                                        color: '#fff',
                                                        fontSize: '12px',
                                                        fontWeight: 'bold',
                                                        marginRight: '8px'
                                                    }}>
                                                        {(comment.userDisplayName?.[0] || '?').toUpperCase()}
                                                    </div>
                                                    {/* Name & Time */}
                                                    <div style={{ flex: 1 }}>
                                                        <span style={{ fontSize: '13px', fontWeight: '600', color: '#050505' }}>
                                                            {comment.userDisplayName}
                                                        </span>
                                                        <span style={{ fontSize: '11px', color: '#65676B', marginLeft: '8px' }}>
                                                            {formatMyDayTimestamp(comment.createdAt)}
                                                        </span>
                                                    </div>
                                                    {/* Delete Button (own comments only) */}
                                                    {(comment.userId === currentUserId || isCoachOrAdmin()) && (
                                                        <button
                                                            onClick={() => handleDeleteComment(msg.id, comment.id, comment.userId)}
                                                            style={{
                                                                background: 'transparent',
                                                                border: 'none',
                                                                color: '#65676B',
                                                                fontSize: '16px',
                                                                cursor: 'pointer',
                                                                padding: '0 4px'
                                                            }}
                                                            title="Delete comment"
                                                        >
                                                            Ã—
                                                        </button>
                                                    )}
                                                </div>
                                                {/* Comment Content */}
                                                <div style={{
                                                    fontSize: '14px',
                                                    lineHeight: '18px',
                                                    color: '#050505',
                                                    whiteSpace: 'pre-wrap',
                                                    wordBreak: 'break-word',
                                                    paddingLeft: '32px'
                                                }}>
                                                    {comment.content}
                                                </div>
                                            </div>
                                        ))
                                    )}

                                    {/* Comment Input */}
                                    <div style={{
                                        display: 'flex',
                                        gap: '8px',
                                        marginTop: '12px',
                                        alignItems: 'flex-start'
                                    }}>
                                        {/* Current User Avatar */}
                                        <div style={{
                                            width: '32px',
                                            height: '32px',
                                            borderRadius: '50%',
                                            background: 'linear-gradient(135deg, #069494, #058585)',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            color: '#fff',
                                            fontSize: '14px',
                                            fontWeight: 'bold',
                                            flexShrink: 0
                                        }}>
                                            {(currentUserData?.firstName?.[0] || currentUser?.displayName?.[0] || '?').toUpperCase()}
                                        </div>
                                        {/* Input & Submit */}
                                        <div style={{ flex: 1 }}>
                                            <input
                                                type="text"
                                                value={commentText[msg.id] || ''}
                                                onChange={(e) => setCommentText(prev => ({ ...prev, [msg.id]: e.target.value }))}
                                                onKeyPress={(e) => {
                                                    if (e.key === 'Enter' && !e.shiftKey) {
                                                        e.preventDefault();
                                                        handleAddComment(msg.id);
                                                    }
                                                }}
                                                disabled={submittingComment}
                                                placeholder="Write a comment..."
                                                style={{
                                                    width: '100%',
                                                    padding: '8px 12px',
                                                    border: '1px solid #CCD0D5',
                                                    borderRadius: '20px',
                                                    fontSize: '14px',
                                                    outline: 'none',
                                                    fontFamily: 'inherit'
                                                }}
                                            />
                                            {/* Character counter */}
                                            {(commentText[msg.id]?.length || 0) > 250 && (
                                                <div style={{
                                                    fontSize: '11px',
                                                    color: (commentText[msg.id]?.length || 0) > 280 ? '#F02849' : '#65676B',
                                                    textAlign: 'right',
                                                    marginTop: '4px',
                                                    marginRight: '4px'
                                                }}>
                                                    {commentText[msg.id]?.length || 0}/280
                                                </div>
                                            )}
                                            {/* Submit button (shows when text entered) */}
                                            {(commentText[msg.id]?.trim()?.length || 0) > 0 && (
                                                <button
                                                    onClick={() => handleAddComment(msg.id)}
                                                    disabled={submittingComment || (commentText[msg.id]?.length || 0) > 280}
                                                    style={{
                                                        marginTop: '4px',
                                                        padding: '6px 16px',
                                                        background: (submittingComment || (commentText[msg.id]?.length || 0) > 280)
                                                            ? '#CCD0D5'
                                                            : '#069494',
                                                        color: '#fff',
                                                        border: 'none',
                                                        borderRadius: '16px',
                                                        fontSize: '13px',
                                                        fontWeight: '600',
                                                        cursor: (submittingComment || (commentText[msg.id]?.length || 0) > 280)
                                                            ? 'not-allowed'
                                                            : 'pointer',
                                                        float: 'right'
                                                    }}
                                                >
                                                    {submittingComment ? 'Posting...' : 'Post'}
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    ))
                ) : (
                    <div style={{
                        textAlign: 'center',
                        padding: 'var(--space-8)',
                        background: 'rgba(255,255,255,0.95)',
                        borderRadius: 'var(--radius-lg)',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                    }}>
                        <i data-lucide="users" style={{width: '48px', height: '48px', color: '#ccc', marginBottom: 'var(--space-3)'}}></i>
                        <div style={{color: '#666', fontSize: 'var(--font-base)'}}>
                            No posts yet. Be the first to share!
                        </div>
                    </div>
                )}
                <div ref={messagesEndRef} />
            </div>
        </div>
    );
}


// Register components
window.GLRSApp.components.CommunityTab = CommunityTab;
window.GLRSApp.components.CommunityChat = CommunityChat;

console.log('âœ… PHASE 4: CommunityTab component loaded with JSDoc + error handling + loading/error UI');
