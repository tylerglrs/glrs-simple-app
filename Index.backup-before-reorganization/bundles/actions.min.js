const completeAssignment=async({assignmentId:e,goalId:t,reflection:a,user:o,db:s,firebase:r,loadAssignments:n,loadGoals:l,loadComplianceRates:d,updateGoalProgress:i})=>{try{await s.collection("assignments").doc(e).update({status:"completed",completedAt:r.firestore.FieldValue.serverTimestamp(),reflection:a||""}),await s.collection("activities").add({userId:o.uid,type:"assignment_completion",description:"Completed assignment",assignmentId:e,reflection:a,createdAt:r.firestore.FieldValue.serverTimestamp()}),await s.collection("notifications").add({userId:o.uid,type:"assignment",title:"Assignment Completed",message:"Great job completing your assignment!",read:!1,createdAt:r.firestore.FieldValue.serverTimestamp()}),t&&await i({goalId:t,user:o,db:s,firebase:r}),await n(),await l(),await d()}catch(c){throw console.error("Error completing assignment:",c),c}},updateGoalProgress=async({goalId:e,user:t,db:a,firebase:o})=>{try{const s=await a.collection("assignments").where("goalId","==",e).where("userId","==",t.uid).get();let r=0,n=0;s.forEach(d=>{r++,d.data().status==="completed"&&n++});const l=r>0?Math.round(n/r*100):0;if(await a.collection("goals").doc(e).update({progress:l,updatedAt:o.firestore.FieldValue.serverTimestamp()}),l===100){const d=await a.collection("goals").doc(e).get();d.exists&&d.data().status!=="completed"&&(await a.collection("goals").doc(e).update({status:"completed",completedAt:o.firestore.FieldValue.serverTimestamp()}),await a.collection("notifications").add({userId:t.uid,type:"goal_completed",title:"Goal Completed!",message:`Congratulations! You've completed the goal: ${d.data().title}`,goalId:e,read:!1,createdAt:o.firestore.FieldValue.serverTimestamp()}))}}catch(s){throw console.error("Error updating goal progress:",s),s}};window.GLRSApp=window.GLRSApp||{shared:{}},window.GLRSApp.shared=window.GLRSApp.shared||{},window.GLRSApp.shared.assignmentActions={completeAssignment,updateGoalProgress},console.log("\u2705 Assignment actions loaded");const sendCommunityMessage=async({message:e,imageUrl:t,user:a,userData:o,db:s,firebase:r})=>{try{const n={roomId:"main",senderId:a.uid,senderName:o?.displayName||o?.firstName||"Anonymous",content:e,createdAt:r.firestore.FieldValue.serverTimestamp()};t&&(n.imageUrl=t),await s.collection("messages").add(n)}catch(n){throw console.error("Error sending community message:",n),n}},sendTopicRoomMessage=async({roomId:e,content:t,imageFile:a=null,user:o,userData:s,db:r,firebase:n,setTopicRoomMessages:l})=>{if(!(!t&&!a))try{const d={roomId:e,userId:o.uid,senderId:o.uid,senderName:s?.displayName||s?.firstName||"Anonymous",message:t||"",createdAt:n.firestore.FieldValue.serverTimestamp()};if(a&&a instanceof File)try{const p=document.createElement("canvas"),A=p.getContext("2d"),m=new Image,h=new FileReader,f=await new Promise((u,S)=>{h.onload=y=>{m.onload=()=>{let g=m.width,w=m.height;g>w?g>500&&(w=Math.round(w*500/g),g=500):w>500&&(g=Math.round(g*500/w),w=500),p.width=g,p.height=w,A.drawImage(m,0,0,g,w);const R=p.toDataURL("image/jpeg",.7);u(R)},m.onerror=()=>S(new Error("Failed to load image")),m.src=y.target.result},h.onerror=()=>S(new Error("Failed to read file")),h.readAsDataURL(a)});d.imageUrl=f}catch{window.GLRSApp.utils.showNotification("Failed to process image, sending message only","warning")}await r.collection("messages").add(d);const i=await r.collection("messages").where("roomId","==",e).orderBy("createdAt","desc").limit(50).get(),c=[];i.forEach(p=>{c.push({id:p.id,...p.data()})}),l(c.reverse())}catch(d){throw console.error("Error sending topic room message:",d),window.GLRSApp.utils.showNotification("Failed to send message","error"),d}},enterTopicRoom=async({room:e,db:t,setActiveTopicRoom:a,setTopicRoomMessages:o,setShowModal:s})=>{a(e);try{const r=await t.collection("messages").where("roomId","==",e.id).orderBy("createdAt","desc").limit(50).get(),n=[];r.forEach(l=>{n.push({id:l.id,...l.data()})}),o(n.reverse())}catch(r){console.error("Error loading topic room messages:",r)}s("topicRoom")};window.GLRSApp=window.GLRSApp||{shared:{}},window.GLRSApp.shared=window.GLRSApp.shared||{},window.GLRSApp.shared.messagingActions={sendCommunityMessage,sendTopicRoomMessage,enterTopicRoom},console.log("\u2705 Messaging actions loaded");const triggerSOS=async({user:e,userData:t,db:a,firebase:o})=>{if(confirm("This will send an emergency alert to your coach. Continue?"))try{await a.collection("alerts").add({userId:e.uid,type:"sos",status:"active",severity:"critical",message:"Emergency SOS triggered",createdAt:o.firestore.FieldValue.serverTimestamp()}),t?.assignedCoach&&await a.collection("notifications").add({userId:t.assignedCoach,type:"emergency",title:"EMERGENCY SOS",message:`${t.displayName||e.email} has triggered an emergency alert!`,pirId:e.uid,severity:"critical",read:!1,createdAt:o.firestore.FieldValue.serverTimestamp()}),alert("Emergency alert sent. Your coach has been notified.")}catch(s){console.error("Error triggering SOS:",s),alert("Failed to send alert. Please call 988 for immediate help.")}};window.GLRSApp=window.GLRSApp||{shared:{}},window.GLRSApp.shared=window.GLRSApp.shared||{},window.GLRSApp.shared.emergencyActions={triggerSOS},console.log("\u2705 Emergency actions loaded");const exportDataAsJSON=({userData:e,checkIns:t,goals:a,assignments:o,sobrietyDays:s,checkInStreak:r,complianceRate:n})=>{const l={userData:e,checkIns:t,goals:a,assignments:o,sobrietyDays:s,streak:r,complianceRates:n,exportedAt:new Date().toISOString()},d=JSON.stringify(l,null,2),i="data:application/json;charset=utf-8,"+encodeURIComponent(d),c=document.createElement("a");c.setAttribute("href",i),c.setAttribute("download",`recovery_data_${new Date().toISOString().split("T")[0]}.json`),c.click()},exportDataAsPDF=({userData:e,user:t,sobrietyDays:a,moneySaved:o,checkInStreak:s,complianceRate:r,checkIns:n,goals:l})=>{const{jsPDF:d}=window.jspdf,i=new d;i.setFontSize(20),i.text("Recovery Progress Report",20,20),i.setFontSize(12),i.text(`Name: ${e?.displayName||e?.firstName||t.email}`,20,40),i.text(`Days Clean: ${a}`,20,50),i.text(`Money Saved: $${o.toLocaleString()}`,20,60),i.text(`Check-in Streak: ${s} days`,20,70),i.text(`Check-in Compliance: ${r.checkIn}%`,20,80),i.text(`Assignment Completion: ${r.assignment}%`,20,90),i.text(`Export Date: ${new Date().toLocaleDateString()}`,20,100),n.length>0&&(i.text("Recent Check-ins:",20,120),n.slice(0,5).forEach((c,p)=>{const A=c.createdAt?.toDate?c.createdAt.toDate().toLocaleDateString():"Unknown",m=c.morningData?.mood||"N/A",h=c.morningData?.craving||"N/A";i.text(`${A} - Mood: ${m}/5, Craving: ${h}/5`,30,130+p*10)})),l.length>0&&(i.addPage(),i.text("Active Goals:",20,20),l.forEach((c,p)=>{i.text(`${c.title} - ${c.progress}% complete`,30,30+p*10)})),i.save(`recovery_report_${new Date().toISOString().split("T")[0]}.pdf`)};window.GLRSApp=window.GLRSApp||{shared:{}},window.GLRSApp.shared=window.GLRSApp.shared||{},window.GLRSApp.shared.exportActions={exportDataAsJSON,exportDataAsPDF},console.log("\u2705 Export actions loaded");const markNotificationAsRead=async({notificationId:e,db:t,firebase:a})=>{try{await t.collection("notifications").doc(e).update({read:!0,readAt:a.firestore.FieldValue.serverTimestamp()})}catch(o){console.error("Error marking notification as read:",o)}},markAllNotificationsAsRead=async({notifications:e,db:t,firebase:a})=>{try{const o=t.batch();e.forEach(s=>{if(!s.read){const r=t.collection("notifications").doc(s.id);o.update(r,{read:!0,readAt:a.firestore.FieldValue.serverTimestamp()})}}),await o.commit()}catch(o){console.error("Error marking all notifications as read:",o)}};window.GLRSApp=window.GLRSApp||{shared:{}},window.GLRSApp.shared=window.GLRSApp.shared||{},window.GLRSApp.shared.notificationActions={markNotificationAsRead,markAllNotificationsAsRead},console.log("\u2705 Notification actions loaded");const handleImageSelect=e=>{const t=e.target.files[0];if(t){if(!t.type.startsWith("image/")){window.GLRSApp.utils.showNotification("Please select an image file","error");return}window.GLRSApp.handlers.handleProfileImageUpload(t)}},dismissBroadcast=({setBroadcastDismissed:e,setActiveBroadcast:t})=>{e(!0),t(null)};window.GLRSApp=window.GLRSApp||{shared:{}},window.GLRSApp.shared=window.GLRSApp.shared||{},window.GLRSApp.shared.uiActions={handleImageSelect,dismissBroadcast},console.log("\u2705 UI actions loaded");
