window.GLRSApp=window.GLRSApp||{},window.GLRSApp.hooks=window.GLRSApp.hooks||{};const useLoaders=()=>{const{user:r,setLoading:v,setUserData:M,setProfileImage:ie,setCoachInfo:z,setTopicRooms:Y,setMeetings:ce,setSupportGroups:O,setEmergencyResources:j,setGoals:le,setAssignments:Q,setHabits:de,setTodayHabits:X,setQuickReflections:J,setTodayWins:ee,setCheckInStatus:te,setDailyQuote:ae,setDailyQuotes:Z,setMilestones:he,setNextMilestone:ue,setActiveBroadcast:oe,setResources:se,setCheckIns:ne,setStreakCheckIns:B,setPledgeMade:re,setCheckInStreak:I,setCoachNotes:b,setCalendarHeatmapData:U,setMoodWeekData:V,setOverallDayWeekData:q,setGratitudeJournalData:me,setGratitudeInsights:ge,setChallengesHistoryData:pe,setChallengesInsights:k,setTomorrowGoalsData:C,setGoalHistory:De,setYesterdayGoal:ye,setGoalStatus:Ae,setGoalNotes:ve,setReflectionData:Ie,setStreakReflections:ke,setComplianceRate:fe,setMoodChartData:Se,setCravingChartData:Ce,setAnxietyChartData:Te,setSleepChartData:f,userData:h,sobrietyDays:L,checkInStatus:A,setTotalCheckIns:T,setChallengeCheckInStatus:N,setChallengeCheckInNotes:K,setCheckInData:H,setGoalStats:_}=useAppContext(),d=window.db,S=window.firebase,Re=window.auth,P=async()=>{try{v(!0),await Le(),await Promise.all([Ge(),be(),Fe(),Me(),xe(),Ue(),He(),Pe(),$e(),Ee(),Be(),Ve(),_e(),ze(),We(),qe(),window.GLRSApp.calculations.calculateMilestones(),Je(),Ne(),window.GLRSApp.calculations.calculateTotalCheckIns().then(t=>T(t)),window.GLRSApp.calculations.calculateStreaks(),window.GLRSApp.calculations.calculateReflectionStreaks()])}catch{}finally{v(!1)}},Le=async()=>{try{const t=await d.collection("users").doc(r.uid).get();if(t.exists){const a=t.data();if(M(a),a.profileImageUrl&&ie(a.profileImageUrl),a.assignedCoach){const e=await d.collection("users").doc(a.assignedCoach).get();e.exists&&z(e.data())}}}catch{}},Ge=async()=>{try{const t=await d.collection("topicRooms").where("active","==",!0).get(),a=[];t.forEach(e=>{a.push({id:e.id,...e.data()})}),Y(a)}catch{}},be=async()=>{try{const t=Re.currentUser?.uid;if(!t)return;const a=await d.collection("meetings").where("assignedPIRs","array-contains",t).where("status","==","scheduled").get(),e=await d.collection("meetings").where("isGlobal","==",!0).where("status","==","scheduled").get(),o=new Map;a.forEach(s=>{o.set(s.id,{id:s.id,...s.data()})}),e.forEach(s=>{o.has(s.id)||o.set(s.id,{id:s.id,...s.data()})});const n=Array.from(o.values()).sort((s,c)=>{const i=s.scheduledTime?.toDate?s.scheduledTime.toDate():new Date(s.scheduledTime),l=c.scheduledTime?.toDate?c.scheduledTime.toDate():new Date(c.scheduledTime);return i-l});ce(n)}catch{}},Ee=async()=>{try{const t=await d.collection("supportGroups").where("active","==",!0).orderBy("day").get(),a=[];t.forEach(e=>{a.push({id:e.id,...e.data()})}),O(a)}catch{}},Fe=async()=>{try{const t=await d.collection("resources").where("category","==","emergency").where("active","==",!0).get(),a=[];t.forEach(e=>{a.push({id:e.id,...e.data()})}),j(a)}catch{}},Me=async()=>{try{const t=await d.collection("goals").where("userId","==",r.uid).orderBy("createdAt","desc").get(),a=[];for(const e of t.docs){const o={id:e.id,...e.data()},n=await d.collection("assignments").where("goalId","==",e.id).where("userId","==",r.uid).get(),s=[];n.forEach(i=>{s.push({id:i.id,...i.data()})}),o.assignments=s;const c=s.filter(i=>i.status==="completed").length;o.progress=s.length>0?Math.round(c/s.length*100):0,a.push(o)}le(a),Qe(a)}catch{}},xe=async()=>{try{const t=await d.collection("assignments").where("userId","==",r.uid).orderBy("createdAt","desc").get(),a=[];t.forEach(o=>{const n={id:o.id,...o.data()};a.push(n)}),Q(a);const e=a.filter(o=>o.status==="completed").length;Xe(e)}catch{}},Ke=async()=>{try{const t=await d.collection("habits").where("userId","==",r.uid).orderBy("createdAt","desc").get(),a=[];t.forEach(e=>{a.push({id:e.id,...e.data()})}),de(a)}catch{}},Ye=async()=>{try{const t=r.timezone||"America/Los_Angeles",a=new Date(new Date().toLocaleString("en-US",{timeZone:t})),e=new Date(a);e.setHours(0,0,0,0);const o=new Date(e);o.setDate(o.getDate()+1);const n=await d.collection("habitCompletions").where("userId","==",r.uid).where("completedAt",">=",S.firestore.Timestamp.fromDate(e)).where("completedAt","<",S.firestore.Timestamp.fromDate(o)).get(),s=[];n.forEach(c=>{s.push({id:c.id,...c.data()})}),X(s)}catch{}},Oe=async()=>{try{const t=await d.collection("quickReflections").where("userId","==",r.uid).orderBy("createdAt","desc").limit(50).get(),a=[];t.forEach(e=>{a.push({id:e.id,...e.data()})}),J(a)}catch{}},je=async()=>{try{const t=r.timezone||"America/Los_Angeles",a=new Date(new Date().toLocaleString("en-US",{timeZone:t})),e=new Date(a);e.setHours(0,0,0,0);const o=new Date(e);o.setDate(o.getDate()+1);const n=await d.collection("wins").where("userId","==",r.uid).where("createdAt",">=",S.firestore.Timestamp.fromDate(e)).where("createdAt","<",S.firestore.Timestamp.fromDate(o)).orderBy("createdAt","desc").get(),s=[];n.forEach(c=>{s.push({id:c.id,...c.data()})}),ee(s)}catch{}},gt=async(t,a,e,o)=>{try{return await d.collection("communityPosts").add({userId:r.uid,userName:`${h.firstName||""} ${h.lastName||""}`.trim()||"Anonymous",userAvatar:h.photoURL||null,postType:t,content:a,sourceCollection:e,sourceId:o,likes:0,likedBy:[],commentCount:0,createdAt:S.firestore.FieldValue.serverTimestamp(),sharedAt:S.firestore.FieldValue.serverTimestamp(),tenantId:r.tenantId||"glrs",isPublic:!0,isPinned:!1}),{success:!0}}catch(n){return{success:!1,error:n}}},Ne=async()=>{try{const t=r.timezone||"America/Los_Angeles",a=new Date(new Date().toLocaleString("en-US",{timeZone:t})),e=new Date(a);e.setHours(0,0,0,0);const o=new Date(e);o.setDate(o.getDate()+1);const n=await d.collection("checkIns").where("userId","==",r.uid).where("createdAt",">=",e).where("createdAt","<",o).get();let s=!1,c=!1;n.forEach(w=>{const G=w.data();G.morningData&&(s=!0),G.eveningData&&(c=!0)});const i=await d.collection("assignments").where("userId","==",r.uid).get(),l=[];let u=0;i.forEach(w=>{const G=w.data(),x=G.dueDate?.toDate?G.dueDate.toDate():null,R=G.completedAt?.toDate?G.completedAt.toDate():null;let F=!1;if(x){const W=x.toDateString(),$=e.toDateString();(W===$||x<e&&(!R||R>=e))&&(F=!0)}else!G.dueDate&&(!R||R>=e)&&(F=!0);F&&(l.push({id:w.id,...G}),R&&R>=e&&R<o&&u++)});const m=l.filter(w=>w.status!=="completed"),D=2,g=(s?1:0)+(c?1:0),y=D+m.length+u,E=g+u,p=document.querySelector(".tasks-stat");return p&&(p.textContent=`${E}/${y} Today`),te({morning:s,evening:c}),{totalTasks:y,completedTasks:E,morningDone:s,eveningDone:c,assignments:m,completedAssignmentsToday:u}}catch{return{totalTasks:2,completedTasks:0,morningDone:!1,eveningDone:!1,assignments:[],completedAssignmentsToday:0}}},Qe=t=>{if(!t)return;const a=t.filter(s=>s.status==="completed").length,e=t.filter(s=>s.status==="active").length,o=t.length,n=document.querySelector(".goals-stat");n&&(e===0?n.textContent="0 Active":n.textContent=`${e} Active / ${a} Complete`)},Xe=t=>{const a=document.querySelector(".lifetime-tasks-stat");a&&(a.textContent=t)},ht=async(t,a,e)=>t?new Promise((o,n)=>{const s=new FileReader;s.onload=c=>{const i=new Image;i.onload=()=>{const l=document.createElement("canvas"),u=l.getContext("2d"),m=800,D=800;let g=i.width,y=i.height;g>y?g>m&&(y=m/g*y,g=m):y>D&&(g=D/y*g,y=D),l.width=g,l.height=y,u.drawImage(i,0,0,g,y);const E=l.toDataURL("image/jpeg",.6);if(E.length>9e5){alert("Image too large. Please choose a smaller image."),n(new Error("Image too large after compression"));return}o(E)},i.onerror=()=>n(new Error("Failed to load image")),i.src=c.target.result},s.onerror=n,s.readAsDataURL(t)}):null,mt=async(t,a)=>{const e=prompt("Please describe why you are flagging this content:");if(!e)return!1;try{return await d.collection("flaggedContent").add({contentType:t,...a,flaggedBy:r.uid,flaggedByName:h?.displayName||h?.firstName||"PIR",reason:e,status:"pending",createdAt:S.firestore.FieldValue.serverTimestamp()}),alert("Thank you. This content has been flagged for review."),!0}catch{return alert("Failed to flag content"),!1}},Je=async()=>{if(!h?.sobrietyDate)return;const t=window.GLRSApp.utils.getRecoveryMilestones(h.sobrietyDate),a=new Date;a.setHours(0,0,0,0);for(const e of t)(await d.collection("notifications").where("recipientId","==",r.uid).where("type","in",["milestone_today","milestone_tomorrow"]).where("milestoneTitle","==",e.title).where("createdAt",">=",a).limit(1).get()).empty&&(e.isToday&&(await d.collection("notifications").add({recipientId:r.uid,type:"milestone_today",message:`Congratulations! You've reached ${e.title}!`,milestoneTitle:e.title,icon:e.icon,read:!1,urgent:!0,createdAt:S.firestore.FieldValue.serverTimestamp()}),h.assignedCoach&&await d.collection("notifications").add({recipientId:h.assignedCoach,senderId:r.uid,senderName:h.displayName||h.firstName||"PIR",type:"pir_milestone_achieved",message:`${h.displayName||"PIR"} reached ${e.title}!`,milestoneTitle:e.title,icon:e.icon,read:!1,createdAt:S.firestore.FieldValue.serverTimestamp()})),e.isTomorrow&&(await d.collection("notifications").add({recipientId:r.uid,type:"milestone_tomorrow",message:`Tomorrow you'll reach ${e.title}! Keep going!`,milestoneTitle:e.title,icon:e.icon,read:!1,urgent:!1,createdAt:S.firestore.FieldValue.serverTimestamp()}),h.assignedCoach&&await d.collection("notifications").add({recipientId:h.assignedCoach,senderId:r.uid,senderName:h.displayName||h.firstName||"PIR",type:"pir_milestone_upcoming",message:`${h.displayName||"PIR"} will reach ${e.title} tomorrow`,milestoneTitle:e.title,icon:e.icon,read:!1,createdAt:S.firestore.FieldValue.serverTimestamp()})))},Ue=async()=>{try{const t=await d.collection("dailyInspirations").where("active","==",!0).get();if(t.empty)ae({quote:"One day at a time.",author:"Recovery Wisdom"});else{const a=[];t.forEach(n=>{a.push({id:n.id,...n.data()})});const o=Math.floor((new Date-new Date(new Date().getFullYear(),0,0))/864e5)%a.length;ae(a[o])}}catch{ae({quote:"Progress, not perfection.",author:"Recovery Wisdom"})}},He=async()=>{try{const t=await d.collection("milestones").orderBy("daysRequired","asc").get(),a=[];if(t.forEach(e=>{a.push({id:e.id,...e.data()})}),he(a),h?.sobrietyDate){const e=window.GLRSApp.utils.calculateSobrietyDays(h.sobrietyDate),o=a.find(n=>n.daysRequired>e);ue(o)}}catch{}},Pe=async()=>{try{const t=await d.collection("broadcasts").where("active","==",!0).orderBy("createdAt","desc").limit(1).get();if(!t.empty&&!broadcastDismissed){const a=t.docs[0].data();oe(a)}}catch{}},$e=async()=>{try{const t=await d.collection("resources").where("active","==",!0).get(),a={videos:[],articles:[],tools:[],worksheets:[]};t.forEach(e=>{const o={id:e.id,...e.data()};o.category==="emergency"||!(o.isGlobal===!0||o.assignedPIRs&&o.assignedPIRs.includes(r.uid)||o.userId===r.uid)||(o.type==="video"?a.videos.push(o):o.type==="article"?a.articles.push(o):o.type==="tool"?a.tools.push(o):o.type==="worksheet"&&a.worksheets.push(o))}),se(a)}catch{}},Be=async()=>{try{const t=await d.collection("checkIns").where("userId","==",r.uid).orderBy("createdAt","desc").limit(30).get(),a=[];t.forEach(s=>{a.push({id:s.id,...s.data()})}),ne(a);const e=new Date;e.setHours(0,0,0,0);const o=new Date(e);o.setDate(o.getDate()+1);const n=a.find(s=>{const c=s.createdAt?.toDate?s.createdAt.toDate():new Date(s.createdAt);return c>=e&&c<o});n&&te({morning:!!n.morningData,evening:!!n.eveningData}),tt(a)}catch{}},et=async()=>{try{const t=await d.collection("checkIns").where("userId","==",r.uid).orderBy("createdAt","desc").limit(90).get(),a=[];t.forEach(u=>{a.push({id:u.id,...u.data()})});const e=[],o=r.timezone||"America/Los_Angeles",n=new Date(new Date().toLocaleString("en-US",{timeZone:o})),s=new Date(n);s.setHours(0,0,0,0);let c=new Date(s),i=!0,l=0;for(;i&&l<365;){const u=new Date(c);u.setDate(u.getDate()+1);const m=a.find(D=>{const g=D.createdAt?.toDate?D.createdAt.toDate():new Date(D.createdAt),y=new Date(g.toLocaleString("en-US",{timeZone:o}));return y.setHours(0,0,0,0),y.getTime()===c.getTime()});if(m)e.push(m),c.setDate(c.getDate()-1),l++;else{if(l===0&&n.getHours()<18){c.setDate(c.getDate()-1),l++;continue}i=!1}}B(e)}catch{}},tt=t=>{const a=[],e=[],o=[],n=[],s=[];for(let c=29;c>=0;c--){const i=new Date;i.setDate(i.getDate()-c);const l=i.toLocaleDateString("en-US",{month:"short",day:"numeric"});a.push(l);const u=t.find(m=>(m.createdAt?.toDate?m.createdAt.toDate():new Date(m.createdAt)).toDateString()===i.toDateString());u?.morningData?(e.push(u.morningData.mood??null),o.push(u.morningData.craving??null),n.push(u.morningData.anxiety??u.morningData.anxietyLevel??null),s.push(u.morningData.sleep??u.morningData.sleepQuality??null)):(e.push(null),o.push(null),n.push(null),s.push(null))}Se({labels:a,datasets:[{label:"Mood",data:e,borderColor:"#4caf50",backgroundColor:"rgba(76, 175, 80, 0.1)",tension:.4,spanGaps:!1}]}),Ce({labels:a,datasets:[{label:"Cravings",data:o,borderColor:"#ff9800",backgroundColor:"rgba(255, 152, 0, 0.1)",tension:.4,spanGaps:!1}]}),Te({labels:a,datasets:[{label:"Anxiety",data:n,borderColor:"#f44336",backgroundColor:"rgba(244, 67, 54, 0.1)",tension:.4,spanGaps:!1}]}),f({labels:a,datasets:[{label:"Sleep Quality",data:s,borderColor:"#9c27b0",backgroundColor:"rgba(156, 39, 176, 0.1)",tension:.4,spanGaps:!1}]})};useEffect(()=>{currentView==="progress"&&moodChartData&&cravingChartData&&anxietyChartData&&sleepChartData&&setTimeout(()=>{const t=document.getElementById("moodChart"),a=document.getElementById("cravingChart"),e=document.getElementById("anxietyChart"),o=document.getElementById("sleepChart");chartRef.current&&chartRef.current.destroy(),cravingChartRef.current&&cravingChartRef.current.destroy(),anxietyChartRef.current&&anxietyChartRef.current.destroy(),sleepChartRef.current&&sleepChartRef.current.destroy();const n={type:"line",options:{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!0,position:"top"},tooltip:{enabled:!0,callbacks:{label:function(s){return s.parsed.y===null?"No data":`${s.dataset.label}: ${s.parsed.y}/10`}}},zoom:{zoom:{wheel:{enabled:!0},pinch:{enabled:!0},mode:"x"},pan:{enabled:!0,mode:"x"}}},scales:{y:{beginAtZero:!0,max:10,ticks:{stepSize:1},title:{display:!0,text:"Level (0-10)"}},x:{ticks:{maxRotation:45,minRotation:45}}}}};if(t){const s=t.getContext("2d");chartRef.current=new Chart(s,{...n,data:moodChartData})}if(a){const s=a.getContext("2d");cravingChartRef.current=new Chart(s,{...n,data:cravingChartData})}if(e){const s=e.getContext("2d");anxietyChartRef.current=new Chart(s,{...n,data:anxietyChartData})}if(o){const s=o.getContext("2d");sleepChartRef.current=new Chart(s,{...n,data:sleepChartData})}},100)},[currentView,moodChartData,cravingChartData,anxietyChartData,sleepChartData]);const Ve=async()=>{try{const t=new Date;t.setHours(0,0,0,0);const a=new Date(t);a.setDate(a.getDate()+1);const e=await d.collection("pledges").where("userId","==",r.uid).where("createdAt",">=",t).where("createdAt","<",a).get();re(!e.empty)}catch{}},_e=async()=>{try{const t=new Date;t.setDate(t.getDate()-90);const a=await d.collection("checkIns").where("userId","==",r.uid).where("createdAt",">=",t).orderBy("createdAt","desc").get(),e=[];a.forEach(p=>{e.push({id:p.id,...p.data()})}),H(e);let o=0;const n=r.timezone||"America/Los_Angeles",s=new Date(new Date().toLocaleString("en-US",{timeZone:n})),c=new Date(s);c.setHours(0,0,0,0);for(let p=0;p<365;p++){const w=new Date(c);w.setDate(w.getDate()-p),w.setHours(0,0,0,0);const G=new Date(w);if(G.setDate(G.getDate()+1),e.some(R=>{const F=R.createdAt?.toDate?R.createdAt.toDate():new Date(R.createdAt),W=new Date(F.toLocaleString("en-US",{timeZone:n}));return W.setHours(0,0,0,0),W.getTime()===w.getTime()}))o++;else{if(p===0&&s.getHours()<18)continue;break}}I(o);const i=new Date;i.setDate(i.getDate()-7);const l=e.filter(p=>(p.createdAt?.toDate?p.createdAt.toDate():new Date(p.createdAt))>=i),u=new Date;u.setDate(u.getDate()-30);const m=e.filter(p=>(p.createdAt?.toDate?p.createdAt.toDate():new Date(p.createdAt))>=u),D=Math.round(m.length/30*100),g=m.filter(p=>p.morningData?.mood).map(p=>p.morningData.mood),y=g.length>0?(g.reduce((p,w)=>p+w,0)/g.length).toFixed(1):0,E=Math.round(l.length/7*100);setWeeklyStats({checkRate:D,avgMood:parseFloat(y),thisWeekCompletion:E})}catch{}},ze=async()=>{try{const t=await d.collection("coachNotes").where("userId","==",r.uid).orderBy("createdAt","desc").limit(5).get(),a=[];t.forEach(e=>{a.push({id:e.id,...e.data()})}),b(a)}catch{}},at=async()=>{try{const t=r.timezone||"America/Los_Angeles",a=new Date;a.setDate(a.getDate()-365);const e=await d.collection("checkIns").where("userId","==",r.uid).where("createdAt",">=",a).orderBy("createdAt","desc").get(),o={};e.docs.forEach(s=>{const c=s.data(),i=c.createdAt?.toDate?c.createdAt.toDate():new Date(c.createdAt),l=new Date(i.toLocaleString("en-US",{timeZone:t})),u=l.getFullYear(),m=String(l.getMonth()+1).padStart(2,"0"),D=String(l.getDate()).padStart(2,"0"),g=`${u}-${m}-${D}`;o[g]||(o[g]={date:l,dateKey:g,morningCheckIn:null,eveningCheckIn:null,count:0}),c.morningData&&!o[g].morningCheckIn&&(o[g].morningCheckIn=c.morningData,o[g].count++),c.eveningData&&!o[g].eveningCheckIn&&(o[g].eveningCheckIn=c.eveningData,o[g].count++)});const n=Object.values(o).sort((s,c)=>new Date(s.dateKey)-new Date(c.dateKey));U(n)}catch{}},ot=async()=>{try{const t=r.timezone||"America/Los_Angeles",a=await d.collection("checkIns").where("userId","==",r.uid).orderBy("createdAt","desc").get(),e={};a.docs.forEach(p=>{const w=p.data(),G=w.createdAt?.toDate?w.createdAt.toDate():new Date(w.createdAt),x=new Date(G.toLocaleString("en-US",{timeZone:t})),R=x.getFullYear(),F=String(x.getMonth()+1).padStart(2,"0"),W=String(x.getDate()).padStart(2,"0"),$=`${R}-${F}-${W}`,we=w.morningData?.mood;we&&(!e[$]||we>e[$].mood)&&(e[$]={dateKey:$,date:x,mood:we})});const o=Object.values(e).sort((p,w)=>new Date(p.dateKey)-new Date(w.dateKey)),n=new Date,s=new Date;s.setDate(n.getDate()-7);const c=`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")}`,i=new Date;i.setDate(n.getDate()-14);const l=`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}-${String(i.getDate()).padStart(2,"0")}`,u=o.filter(p=>p.dateKey>=c),m=o.filter(p=>p.dateKey>=l&&p.dateKey<c),D=u.length>0?u.reduce((p,w)=>p+w.mood,0)/u.length:0,g=m.length>0?m.reduce((p,w)=>p+w.mood,0)/m.length:0,y=[],E=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];for(let p=6;p>=0;p--){const w=new Date;w.setDate(w.getDate()-p);const G=w.getFullYear(),x=String(w.getMonth()+1).padStart(2,"0"),R=String(w.getDate()).padStart(2,"0"),F=`${G}-${x}-${R}`,W=E[w.getDay()],$=e[F];y.push({dateKey:F,dayName:W,mood:$?$.mood:null,hasMood:!!$})}V({thisWeekAvg:parseFloat(D.toFixed(1)),lastWeekAvg:parseFloat(g.toFixed(1)),difference:parseFloat((D-g).toFixed(1)),weekData:y})}catch{}},st=async()=>{try{const t=r.timezone||"America/Los_Angeles",a=await d.collection("checkIns").where("userId","==",r.uid).orderBy("createdAt","desc").get(),e={};a.docs.forEach(g=>{const y=g.data(),E=y.createdAt?.toDate?y.createdAt.toDate():new Date(y.createdAt),p=new Date(E.toLocaleString("en-US",{timeZone:t})),w=p.getFullYear(),G=String(p.getMonth()+1).padStart(2,"0"),x=String(p.getDate()).padStart(2,"0"),R=`${w}-${G}-${x}`,F=y.eveningData?.overallDay;F&&(!e[R]||F>e[R].overallDay)&&(e[R]={dateKey:R,date:p,overallDay:F})});const n=Object.values(e).sort((g,y)=>new Date(g.dateKey)-new Date(y.dateKey)).slice(-14),s=n.slice(-7),c=n.slice(0,7),i=s.length>0?s.reduce((g,y)=>g+y.overallDay,0)/s.length:0,l=c.length>0?c.reduce((g,y)=>g+y.overallDay,0)/c.length:0,u=[],m=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];Object.keys(e).sort((g,y)=>new Date(y)-new Date(g)).slice(0,7).reverse().forEach(g=>{const y=new Date(g),E=m[y.getDay()],p=e[g];u.push({dateKey:g,dayName:E,date:y,overallDay:p.overallDay,hasOverallDay:!0})}),q({thisWeekAvg:parseFloat(i.toFixed(1)),lastWeekAvg:parseFloat(l.toFixed(1)),difference:parseFloat((i-l).toFixed(1)),weekData:u})}catch{}},nt=async()=>{try{const t=r.timezone||"America/Los_Angeles",a=await d.collection("checkIns").where("userId","==",r.uid).orderBy("createdAt","desc").get(),e=[];a.docs.forEach(o=>{const n=o.data();if(n.eveningData?.gratitude&&n.eveningData.gratitude.trim()){const s=n.createdAt?.toDate?n.createdAt.toDate():new Date(n.createdAt),c=new Date(s.toLocaleString("en-US",{timeZone:t}));e.push({id:o.id,date:c,gratitude:n.eveningData.gratitude,overallDay:n.eveningData.overallDay||null})}}),me(e)}catch{}},rt=async()=>{try{const a=await d.collection("users").doc(r.uid).collection("insights").doc("gratitude").get();if(a.exists){const e=a.data();ge(e)}else ge(null)}catch{ge(null)}},it=async()=>{try{const t=await d.collection("dailyQuotes").orderBy("order","asc").get();if(t.empty)Z([{quote:"One day at a time.",author:"Anonymous",order:1},{quote:"Progress, not perfection.",author:"Anonymous",order:2},{quote:"You are stronger than you think.",author:"Anonymous",order:3},{quote:"Every day is a new beginning.",author:"Anonymous",order:4},{quote:"Believe in yourself and all that you are.",author:"Anonymous",order:5}]);else{const a=t.docs.map(e=>({id:e.id,...e.data()}));Z(a)}}catch{Z([{quote:"One day at a time.",author:"Anonymous",order:1},{quote:"Progress, not perfection.",author:"Anonymous",order:2},{quote:"You are stronger than you think.",author:"Anonymous",order:3},{quote:"Every day is a new beginning.",author:"Anonymous",order:4},{quote:"Believe in yourself and all that you are.",author:"Anonymous",order:5}])}},ct=async()=>{try{const t=r.timezone||"America/Los_Angeles",a=await d.collection("checkIns").where("userId","==",r.uid).orderBy("createdAt","desc").get(),e=[];a.docs.forEach(o=>{const n=o.data();if(n.eveningData?.challenges&&n.eveningData.challenges.trim()){const s=n.createdAt?.toDate?n.createdAt.toDate():new Date(n.createdAt),c=new Date(s.toLocaleString("en-US",{timeZone:t}));e.push({id:o.id,date:c,challenges:n.eveningData.challenges,overallDay:n.eveningData.overallDay||null})}}),pe(e)}catch{}},pt=async()=>{if(!selectedChallenge||!challengeCheckInStatus){alert("Please select a status");return}if(!challengeCheckInNotes.trim()){alert("Please add notes about your progress");return}try{await d.collection("challenges_tracking").doc(selectedChallenge.id).update({status:challengeCheckInStatus==="resolved"?"resolved":"ongoing",lastCheckInDate:S.firestore.FieldValue.serverTimestamp(),checkIns:S.firestore.FieldValue.arrayUnion({date:S.firestore.FieldValue.serverTimestamp(),status:challengeCheckInStatus,notes:challengeCheckInNotes})}),challengeCheckInStatus==="resolved"&&await d.collection("notifications").add({userId:r.uid,type:"breakthrough",title:"\u{1F389} Breakthrough Moment!",message:`You've resolved a challenge: ${selectedChallenge.challengeText.substring(0,50)}...`,challengeId:selectedChallenge.id,read:!1,createdAt:S.firestore.FieldValue.serverTimestamp()}),setShowChallengeCheckInModal(!1),setSelectedChallenge(null),N(""),K(""),alert(challengeCheckInStatus==="resolved"?"\u{1F389} Congratulations on resolving this challenge!":"\u2705 Check-in saved")}catch{alert("Error saving check-in. Please try again.")}},lt=async()=>{try{const t=r.timezone||"America/Los_Angeles",a=await d.collection("checkIns").where("userId","==",r.uid).orderBy("createdAt","desc").get(),e=[];a.docs.forEach(o=>{const n=o.data();if(n.eveningData?.tomorrowGoal&&n.eveningData.tomorrowGoal.trim()){const s=n.createdAt?.toDate?n.createdAt.toDate():new Date(n.createdAt),c=new Date(s.toLocaleString("en-US",{timeZone:t})),i=new Date(c);i.setDate(i.getDate()+1),e.push({id:o.id,setOnDate:c,goalDate:i,goal:n.eveningData.tomorrowGoal,overallDay:n.eveningData.overallDay||null})}}),C(e)}catch{}},Ze=async()=>{try{const t=r.timezone||"America/Los_Angeles",a=new Date;a.setDate(a.getDate()-1),a.setHours(0,0,0,0);const e=new Date(a);e.setHours(23,59,59,999);const o=await d.collection("checkIns").where("userId","==",r.uid).where("createdAt",">=",a).where("createdAt","<=",e).get();let n=null;o.docs.forEach(i=>{const l=i.data();l.eveningData?.tomorrowGoal&&l.eveningData.tomorrowGoal.trim()&&(n={id:i.id,goal:l.eveningData.tomorrowGoal,setDate:l.createdAt.toDate()})}),ye(n);const c=(await d.collection("goals_tracking").where("userId","==",r.uid).orderBy("checkedInAt","desc").limit(30).get()).docs.map(i=>({id:i.id,...i.data(),checkedInAt:i.data().checkedInAt?.toDate()}));De(c),window.GLRSApp.calculations.calculateGoalStats(c)}catch{}},yt=async()=>{if(!yesterdayGoal||!goalStatus){alert("Please select how you did with your goal");return}try{await d.collection("goals_tracking").add({userId:r.uid,goal:yesterdayGoal.goal,goalSetDate:S.firestore.Timestamp.fromDate(yesterdayGoal.setDate),status:goalStatus,notes:goalNotes.trim(),checkedInAt:S.firestore.FieldValue.serverTimestamp()}),await Ze(),Ae(""),ve(""),ye(null),alert(goalStatus==="yes"?"\u{1F389} Awesome! Keep up the great work!":"\u2705 Goal check-in saved")}catch{alert("Error saving check-in. Please try again.")}},ft=async()=>{try{if(window.GLRSApp.utils.triggerHaptic("medium"),console.log("\u{1F50D} Share Reflections - Auth Check:"),console.log("  - user object:",r),console.log("  - user.uid:",r?.uid),console.log("  - Firebase auth:",S.auth().currentUser),console.log("  - Auth UID:",S.auth().currentUser?.uid),!r||!r.uid){alert("\u274C You must be logged in to share reflections");return}const t=new Date;t.setDate(t.getDate()-30),console.log("\u{1F50D} Querying checkIns for userId:",r.uid);const a=await d.collection("checkIns").where("userId","==",r.uid).where("createdAt",">=",t).orderBy("createdAt","desc").get(),e=[];if(a.docs.forEach(i=>{const l=i.data();if(l.eveningData&&(l.eveningData.gratitude||l.eveningData.overallDay)){const u=l.createdAt?.toDate?l.createdAt.toDate():new Date(l.createdAt);e.push({date:u,overallDay:l.eveningData.overallDay,gratitude:l.eveningData.gratitude,challenges:l.eveningData.challenges})}}),e.length===0){alert("No reflections to share yet. Start your evening reflections to build your journal!");return}const o=e.filter(i=>i.overallDay).reduce((i,l)=>i+l.overallDay,0)/e.filter(i=>i.overallDay).length,n=e.filter(i=>i.gratitude&&i.gratitude.trim()).length,s=e.filter(i=>i.gratitude&&i.gratitude.trim()).slice(0,5),c=`\u{1F31F} My Recovery Reflections (Last 30 Days)

\u{1F4CA} ${e.length} reflections completed
\u2B50 ${o?o.toFixed(1):"\u2014"}/10 average daily score
\u{1F49A} ${n} gratitudes expressed

Recent Gratitudes:
${s.map((i,l)=>`${l+1}. ${i.gratitude.length>100?i.gratitude.substring(0,100)+"...":i.gratitude}`).join(`
`)}

Staying committed to my recovery journey! \u{1F64F}

\u2014
Shared from GLRS Lighthouse Recovery App`;navigator.share?(await navigator.share({title:"My Recovery Reflections",text:c}),window.GLRSApp.utils.triggerHaptic("success")):(await navigator.clipboard.writeText(c),window.GLRSApp.utils.triggerHaptic("success"),alert(`\u2705 Reflections summary copied to clipboard!

You can now paste and share via text, email, or social media.`))}catch(t){console.error("\u274C Share reflections error:",t),console.error("   - Error code:",t.code),console.error("   - Error message:",t.message),console.error("   - Error name:",t.name),t.name==="AbortError"?console.log("\u2139\uFE0F Share cancelled by user"):t.code==="permission-denied"?(window.GLRSApp.utils.triggerHaptic("error"),alert(`\u274C Permission denied: You don't have access to your check-in data.

Please try logging out and logging back in.`)):(window.GLRSApp.utils.triggerHaptic("error"),alert(`\u274C Error sharing reflections:

`+t.message+`

Please check console for details.`))}},We=async()=>{try{const t=await d.collection("checkIns").where("userId","==",r.uid).orderBy("createdAt","desc").get(),a=[];t.forEach(u=>{const m=u.data();m.eveningData&&a.push({id:u.id,createdAt:m.createdAt,updatedAt:m.updatedAt,overallDay:m.eveningData.overallDay,challenges:m.eveningData.challenges,gratitude:m.eveningData.gratitude,tomorrowGoal:m.eveningData.tomorrowGoal,promptResponse:m.eveningData.promptResponse||"",eveningData:m.eveningData})}),Ie(a);let e=0;const o=new Date;o.setHours(0,0,0,0);for(let u=0;u<365;u++){const m=new Date(o);if(m.setDate(m.getDate()-u),m.setHours(0,0,0,0),a.some(g=>{const y=g.createdAt?.toDate?g.createdAt.toDate():new Date(g.createdAt);return y.setHours(0,0,0,0),y.getTime()===m.getTime()}))e++;else{if(u===0&&new Date().getHours()<21)continue;break}}setReflectionStreak(e);const n=a.length,s=a.filter(u=>u.overallDay!==void 0&&u.overallDay!==null).map(u=>u.overallDay),c=s.length>0?parseFloat((s.reduce((u,m)=>u+m,0)/s.length).toFixed(1)):0;let i="",l=[];try{const m=await d.collection("users").doc(r.uid).collection("insights").doc("gratitude").get();if(m.exists){const D=m.data();D.computed?.topThemes&&D.computed.topThemes.length>0&&(l=D.computed.topThemes.map(g=>({theme:g.theme,count:Math.round(g.percentage/100*D.totalCount)||1,percentage:g.percentage,emotionalWeight:g.emotionalWeight})),i=l[0].theme)}}catch{}setReflectionStats({totalThisMonth:n,avgDailyScore:c,topGratitudeTheme:i,gratitudeThemes:l})}catch{}},dt=async()=>{try{const t=new Date;t.setDate(t.getDate()-90);const a=await d.collection("checkIns").where("userId","==",r.uid).where("createdAt",">=",t).orderBy("createdAt","desc").get(),e=[];a.forEach(i=>{const l=i.data();l.eveningData&&e.push({id:i.id,createdAt:l.createdAt,updatedAt:l.updatedAt,overallDay:l.eveningData.overallDay,challenges:l.eveningData.challenges,gratitude:l.eveningData.gratitude,tomorrowGoal:l.eveningData.tomorrowGoal,promptResponse:l.eveningData.promptResponse||"",eveningData:l.eveningData})});const o=[],n=new Date;n.setHours(0,0,0,0);let s=new Date(n),c=!0;for(;c;){const i=e.find(l=>{const u=l.createdAt?.toDate?l.createdAt.toDate():new Date(l.createdAt);return u.setHours(0,0,0,0),u.getTime()===s.getTime()});if(i)o.push(i),s.setDate(s.getDate()-1);else{if(s.getTime()===n.getTime()&&new Date().getHours()<21){s.setDate(s.getDate()-1);continue}c=!1}}ke(o)}catch{}},ut=async()=>{try{const a=await d.collection("users").doc(r.uid).collection("insights").doc("challenges").get();if(a.exists){const e=a.data();k(e)}else k(null)}catch{k(null)}},qe=async()=>{try{const a=(await d.collection("users").doc(r.uid).get()).data()?.createdAt?.toDate()||new Date,o=Math.floor((new Date-a)/(1e3*60*60*24)),n=Math.min(o,30);if(n<1){fe({checkIn:0,assignment:0});return}const s=new Date;s.setDate(s.getDate()-n);const c=await d.collection("checkIns").where("userId","==",r.uid).where("createdAt",">=",s).get();let i=0;c.forEach(y=>{y.data().morningData&&i++});const l=Math.min(100,Math.round(i/n*100)),u=await d.collection("assignments").where("userId","==",r.uid).get();let m=0,D=0;u.forEach(y=>{m++,y.data().status==="completed"&&D++});const g=m>0?Math.round(D/m*100):0;fe({checkIn:l,assignment:g})}catch{}};return{loadAllData:P,loadUserData:Le,loadTopicRooms:Ge,loadMeetings:be,loadGoals:Me,loadAssignments:xe,loadHabits:Ke,loadTodayHabits:Ye,loadQuickReflections:Oe,loadTodayWins:je,loadDailyTasksStatus:Ne,loadDailyInspiration:Ue,loadMilestones:He,loadBroadcasts:Pe,loadResources:$e,loadCheckIns:Be,loadStreakCheckIns:et,loadTodaysPledge:Ve,loadStreak:_e,loadCoachNotes:ze,loadCalendarHeatmapData:at,loadMoodWeekData:ot,loadOverallDayWeekData:st,loadGratitudeJournal:nt,loadGratitudeInsights:rt,loadDailyQuotes:it,loadChallengesHistory:ct,loadTomorrowGoals:lt,loadGoalAchievementData:Ze,loadReflections:We,loadStreakReflections:dt,loadChallengesInsights:ut,loadComplianceRates:qe,loadSupportGroups:Ee,loadEmergencyResources:Fe,updateStreak:async()=>{try{const t=await d.collection("streaks").doc(r.uid).get();if(t.exists){const a=t.data(),e=a.lastCheckIn?.toDate?a.lastCheckIn.toDate():new Date(a.lastCheckIn),n=Math.floor((new Date-e)/(1e3*60*60*24));n===1?(await d.collection("streaks").doc(r.uid).update({currentStreak:a.currentStreak+1,lastCheckIn:S.firestore.FieldValue.serverTimestamp()}),I(a.currentStreak+1)):n>1?(await d.collection("streaks").doc(r.uid).update({currentStreak:1,lastCheckIn:S.firestore.FieldValue.serverTimestamp()}),I(1)):I(a.currentStreak)}else await d.collection("streaks").doc(r.uid).set({currentStreak:1,lastCheckIn:S.firestore.FieldValue.serverTimestamp()}),I(1)}catch(t){console.error("Error updating streak:",t)}}}};window.GLRSApp.hooks.useLoaders=useLoaders,console.log("\u2705 loaders.js loaded - useLoaders hook available with 35 functions"),window.GLRSApp=window.GLRSApp||{};const setupRealtimeListeners=(r,v,M,ie,z,Y)=>{const{setNotifications:ce,setUnreadCount:O,setCommunityMessages:j,setActiveBroadcast:le}=z,{loadGoals:Q,loadAssignments:de,loadHabits:X,loadTodayHabits:J,loadQuickReflections:ee,loadTodayWins:te}=Y,ae=r.collection("notifications").where("userId","==",v.uid).orderBy("createdAt","desc").limit(20).onSnapshot(I=>{const b=[];let U=0;I.forEach(V=>{const q={id:V.id,...V.data()};b.push(q),q.read||U++}),ce(b),O(U)});M.current.push(ae);const Z=r.collection("messages").where("roomId","==","main").orderBy("createdAt","desc").limit(50).onSnapshot(I=>{const b=[];I.forEach(U=>{b.push({id:U.id,...U.data()})}),j(b.reverse())});M.current.push(Z);const he=r.collection("goals").where("userId","==",v.uid).where("status","==","active").onSnapshot(I=>{Q()});M.current.push(he);const ue=r.collection("assignments").where("userId","==",v.uid).onSnapshot(I=>{de()});M.current.push(ue);const oe=r.collection("habits").where("userId","==",v.uid).onSnapshot(I=>{X(),J()});M.current.push(oe);const se=r.collection("habitCompletions").where("userId","==",v.uid).onSnapshot(I=>{J()});M.current.push(se);const ne=r.collection("quickReflections").where("userId","==",v.uid).onSnapshot(I=>{ee()});M.current.push(ne);const B=r.collection("wins").where("userId","==",v.uid).onSnapshot(I=>{te()});M.current.push(B);const re=r.collection("broadcasts").where("active","==",!0).orderBy("createdAt","desc").limit(1).onSnapshot(I=>{if(!I.empty&&!ie){const b=I.docs[0].data();le(b)}});M.current.push(re)};window.GLRSApp.listeners={setupRealtimeListeners},console.log("\u2705 listeners.js loaded - setupRealtimeListeners function available"),window.GLRSApp=window.GLRSApp||{},window.GLRSApp.hooks=window.GLRSApp.hooks||{};const useHandlers=()=>{const{user:r,userData:v,pledgeMade:M,setPledgeMade:ie,selectedImage:z,setSelectedImage:Y,uploading:ce,setUploading:O,topicMessage:j,setTopicMessage:le,gratitudeTheme:Q,setGratitudeTheme:de,gratitudeText:X,setGratitudeText:J,setShowGratitudeModal:ee,assignments:te,checkInStatus:ae,setCheckInStatus:Z,eveningReflectionData:he,setEveningReflectionData:ue,setProfileImage:oe,setUserData:se,setTopicRoomMessages:ne,activeTopicRoom:B,updateGoalProgress:re,loadAssignments:I,loadGoals:b,updateStreak:U,loadReflections:V,loadCheckIns:q,loadDailyTasksStatus:me,uploadChatImage:ge,flagContent:pe}=useAppContext(),k=window.db,C=window.firebase;return{handleTopicImageSelect:f=>{const h=f.target.files[0];h&&Y(h)},handleSendMessage:async()=>{if(!(!j.trim()&&!z||ce))try{O(!0);const f={senderId:r.uid,senderName:v?.displayName||v?.firstName||"Anonymous",content:j,createdAt:C.firestore.FieldValue.serverTimestamp(),roomId:B?.id};if(z){const L=await ge(z,"topic",B?.id);f.imageUrl=L,f.imageName=z.name}await k.collection("topicRooms").doc(B?.id).collection("messages").add(f),le(""),Y(null);const h=document.getElementById("topic-image-input");h&&(h.value="")}catch(f){alert(f.message||"Failed to send message")}finally{O(!1)}},handleFlagTopicMessage:async f=>{const h={roomId:B?.id,roomName:B?.name,messageId:f.id,messageContent:f.message,messageImageUrl:f.imageUrl||null,authorId:f.userId,authorName:f.userName};await pe("topic_message",h)&&typeof ne=="function"&&ne(A=>A.filter(T=>T.id!==f.id))},handleAssignmentComplete:async(f,h)=>{try{const L=await k.collection("assignments").doc(f).get(),A=L.exists?{id:L.id,...L.data()}:null;if(!A)throw new Error("Assignment not found");const T={status:h?"completed":"pending",updatedAt:C.firestore.FieldValue.serverTimestamp()};h?T.completedAt=C.firestore.FieldValue.serverTimestamp():(T.completedAt=null,T.reflection=null),await k.collection("assignments").doc(f).update(T),A.goalId&&typeof re=="function"&&await re(A.goalId),typeof I=="function"&&await I(),typeof b=="function"&&await b(),window.goalsTasksViewInstance&&window.goalsTasksViewInstance.forceUpdate(),h&&v?.assignedCoach&&await k.collection("notifications").add({userId:v.assignedCoach,senderId:r.uid,senderName:v.displayName||v.firstName||"PIR",type:"assignment_completed",title:"Assignment Completed",message:`${v.displayName||"PIR"} completed: ${A.title}`,assignmentId:f,read:!1,urgent:!1,createdAt:C.firestore.FieldValue.serverTimestamp()});const N=h?"Assignment marked complete!":"Assignment marked incomplete";window.GLRSApp.utils.showNotification(N,"success")}catch{window.GLRSApp.utils.showNotification("Failed to update assignment","error")}},handleReflectionSave:async(f,h)=>{try{await k.collection("assignments").doc(f).update({status:"completed",reflection:h,completedAt:C.firestore.FieldValue.serverTimestamp(),updatedAt:C.firestore.FieldValue.serverTimestamp()}),typeof I=="function"&&await I(),typeof b=="function"&&await b();const L=te?.find(A=>A.id===f);L&&v?.assignedCoach&&await k.collection("notifications").add({userId:v.assignedCoach,senderId:r.uid,senderName:v.displayName||v.firstName||"PIR",type:"assignment_reflection",title:"Assignment Completed with Reflection",message:`${v.displayName||"PIR"} completed with reflection: ${L.title}`,reflection:h,assignmentId:f,read:!1,urgent:!1,createdAt:C.firestore.FieldValue.serverTimestamp()}),window.GLRSApp.utils.showNotification("Assignment completed with reflection!","success")}catch{window.GLRSApp.utils.showNotification("Failed to save reflection","error")}},saveGratitude:async()=>{try{if(!Q){alert("Please select a theme");return}if(!X.trim()){alert("Please write what you're grateful for");return}await k.collection("gratitudes").add({userId:r.uid,theme:Q,text:X.trim(),createdAt:C.firestore.FieldValue.serverTimestamp()}),de(""),J(""),typeof ee=="function"&&ee(!1),alert("Gratitude saved! \u{1F64F}"),typeof V=="function"&&await V()}catch{alert("Error saving gratitude. Please try again.")}},handlePledge:async()=>{if(!M)try{await k.collection("pledges").add({userId:r.uid,createdAt:C.firestore.FieldValue.serverTimestamp()}),ie(!0),await k.collection("notifications").add({userId:r.uid,type:"pledge",title:"Daily Pledge Made",message:"You've committed to your recovery today!",read:!1,createdAt:C.firestore.FieldValue.serverTimestamp()}),await k.collection("activities").add({userId:r.uid,type:"pledge",description:"Made daily pledge",createdAt:C.firestore.FieldValue.serverTimestamp()})}catch(f){console.error("Error saving pledge:",f)}},handleMorningCheckIn:async f=>{try{const h=r.timezone||"America/Los_Angeles",L=new Date(new Date().toLocaleString("en-US",{timeZone:h})),A=new Date(L);A.setHours(0,0,0,0);const T=new Date(A);T.setDate(T.getDate()+1);const N=await k.collection("checkIns").where("userId","==",r.uid).where("createdAt",">=",A).where("createdAt","<",T).get();N.empty?await k.collection("checkIns").add({userId:r.uid,morningData:f,createdAt:C.firestore.FieldValue.serverTimestamp()}):await k.collection("checkIns").doc(N.docs[0].id).update({morningData:f,updatedAt:C.firestore.FieldValue.serverTimestamp()}),Z(K=>({...K,morning:!0})),typeof U=="function"&&await U(),f.mood<=3&&await k.collection("alerts").add({userId:r.uid,type:"low_mood",status:"active",severity:"high",message:`Low mood detected (${f.mood}/10)`,createdAt:C.firestore.FieldValue.serverTimestamp()}),f.craving>=7&&await k.collection("alerts").add({userId:r.uid,type:"high_craving",status:"active",severity:"high",message:`High craving intensity detected (${f.craving}/10)`,createdAt:C.firestore.FieldValue.serverTimestamp()})}catch{alert("Failed to save check-in")}},handleEveningReflection:async f=>{try{const h=r.timezone||"America/Los_Angeles",L=new Date(new Date().toLocaleString("en-US",{timeZone:h})),A=new Date(L);A.setHours(0,0,0,0);const T=new Date(A);T.setDate(T.getDate()+1);const N=await k.collection("checkIns").where("userId","==",r.uid).where("createdAt",">=",A).where("createdAt","<",T).get();N.empty?await k.collection("checkIns").add({userId:r.uid,tenantId:r.tenantId||"glrs",eveningData:f,createdAt:C.firestore.FieldValue.serverTimestamp()}):await k.collection("checkIns").doc(N.docs[0].id).update({eveningData:f,updatedAt:C.firestore.FieldValue.serverTimestamp()}),Z(K=>({...K,evening:!0})),ue({promptResponse:"",overallDay:5,challenges:"",gratitude:"",tomorrowGoal:""}),typeof V=="function"&&await V(),typeof q=="function"&&await q(),typeof me=="function"&&await me(),alert("Evening reflection complete!")}catch{alert("Failed to save reflection")}},handleProfileImageUpload:async f=>{try{if(f.size>5*1024*1024){window.GLRSApp.utils.showNotification("Image size must be less than 5MB","error");return}window.GLRSApp.utils.showNotification("Processing image...","info");const h=document.createElement("canvas"),L=h.getContext("2d"),A=new Image,T=new FileReader;T.onload=async N=>{A.onload=async()=>{try{let H=A.width,_=A.height;H>_?H>300&&(_=Math.round(_*300/H),H=300):_>300&&(H=Math.round(H*300/_),_=300),h.width=H,h.height=_,L.drawImage(A,0,0,H,_);let d=h.toDataURL("image/jpeg",.7);if(d.length*.75>500*1024){const P=h.toDataURL("image/jpeg",.5);if(P.length*.75>500*1024){window.GLRSApp.utils.showNotification("Image is too large even after compression. Please choose a smaller image.","error");return}d=P}await k.collection("users").doc(r.uid).update({profileImageUrl:d,updatedAt:C.firestore.FieldValue.serverTimestamp()}),typeof oe=="function"&&oe(d),typeof se=="function"&&se(P=>({...P,profileImageUrl:d})),document.querySelectorAll(".profile-image, #profileImage, .user-avatar").forEach(P=>{P.tagName==="IMG"?P.src=d:P.style.backgroundImage=`url(${d})`}),window.GLRSApp.utils.showNotification("Profile image updated successfully!","success")}catch{window.GLRSApp.utils.showNotification("Failed to process image","error")}},A.onerror=()=>{window.GLRSApp.utils.showNotification("Failed to load image","error")},A.src=N.target.result},T.onerror=()=>{window.GLRSApp.utils.showNotification("Failed to read file","error")},T.readAsDataURL(f)}catch{window.GLRSApp.utils.showNotification("Failed to upload image","error")}}}};window.GLRSApp.hooks.useHandlers=useHandlers,window.GLRSApp.handlers=window.GLRSApp.handlers||{},console.log("\u2705 handlers.js loaded - useHandlers hook available");
