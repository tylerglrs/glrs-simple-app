window.GLRSApp=window.GLRSApp||{};const firebaseConfig={apiKey:"AIzaSyAufSTHtCTFSEIeZ9YzvrULCnji5I-SMi0",authDomain:"glrs-pir-system.firebaseapp.com",projectId:"glrs-pir-system",storageBucket:"glrs-pir-system.appspot.com",messagingSenderId:"830378577655",appId:"1:830378577655:web:8a9ea644b8e3c5a9f15c42"};firebase.apps.length?console.log("\u2705 Firebase already initialized"):(firebase.initializeApp(firebaseConfig),console.log("\u2705 Firebase initialized from config.js")),window.GLRSApp.auth=firebase.auth(),window.GLRSApp.db=firebase.firestore(),window.GLRSApp.storage=firebase.storage(),window.auth=window.GLRSApp.auth,window.db=window.GLRSApp.db,window.storage=window.GLRSApp.storage,window.firebase=firebase,console.log("\u2705 config.js loaded - Firebase services available"),window.GLRSApp=window.GLRSApp||{},window.GLRSApp.utils=window.GLRSApp.utils||{},window.GLRSApp.utils.constants={},console.log("\u2705 Constants loaded"),window.GLRSApp=window.GLRSApp||{},window.GLRSApp.utils=window.GLRSApp.utils||{},window.GLRSApp.utils.getSobrietyDays=r=>{if(!r)return 0;const[e,t,o]=r.split("-"),a=new Date(parseInt(e),parseInt(t)-1,parseInt(o),0,0,0,0),c=new Date;c.setHours(0,0,0,0);const l=Date.UTC(a.getFullYear(),a.getMonth(),a.getDate()),n=Date.UTC(c.getFullYear(),c.getMonth(),c.getDate())-l,w=Math.floor(n/(1e3*60*60*24))+1;return Math.max(1,w)},window.GLRSApp.utils.triggerHaptic=(r="light")=>{if(navigator.vibrate)switch(r){case"light":navigator.vibrate(10);break;case"medium":navigator.vibrate(20);break;case"heavy":navigator.vibrate(50);break;case"success":navigator.vibrate([10,50,10]);break;case"error":navigator.vibrate([50,100,50]);break;default:navigator.vibrate(10)}},window.GLRSApp.utils.showNotification=(r,e="info")=>{navigator.vibrate&&navigator.vibrate(e==="success"?[10,50,10]:e==="error"?[50,100,50]:10);const t=document.createElement("div");t.style.cssText=`
        position: fixed;
        top: var(--space-4);
        right: var(--space-4);
        background: ${e==="success"?"var(--color-success)":e==="error"?"var(--color-danger)":"var(--color-info)"};
        color: white;
        padding: var(--space-4) var(--space-6);
        border-radius: var(--radius-lg);
        box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        z-index: 10000;
        animation: slideIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        display: flex;
        align-items: center;
        gap: var(--space-3);
        max-width: 400px;
        backdrop-filter: blur(10px);
    `;const o=document.createElement("i");o.setAttribute("data-lucide",e==="success"?"check-circle":e==="error"?"alert-circle":"info"),o.style.cssText="width: 20px; height: 20px; flex-shrink: 0;";const a=document.createElement("span");a.textContent=r,a.style.cssText="font-size: var(--font-sm); font-weight: 500;",t.appendChild(o),t.appendChild(a),document.body.appendChild(t),window.lucide&&window.lucide.createIcons(),setTimeout(()=>{t.style.animation="slideOut 0.3s ease",setTimeout(()=>{t.parentNode&&document.body.removeChild(t)},300)},3e3)},window.getSobrietyDays=window.GLRSApp.utils.getSobrietyDays,window.triggerHaptic=window.GLRSApp.utils.triggerHaptic,window.showNotification=window.GLRSApp.utils.showNotification,console.log("\u2705 helpers.js loaded - Utility functions available"),window.GLRSApp=window.GLRSApp||{},window.GLRSApp.services=window.GLRSApp.services||{},!window.GLRSApp.db&&!window.db&&console.error("\u274C Firestore not initialized! Ensure config.js loads before firestore.js"),window.GLRSApp.services.firestore={getUser:async r=>{try{const e=await window.GLRSApp.db.collection("users").doc(r).get();return e.exists?{id:e.id,...e.data()}:null}catch(e){return console.error("Error getting user:",e),null}},createUser:async(r,e)=>{try{return await window.GLRSApp.db.collection("users").doc(r).set({...e,createdAt:firebase.firestore.FieldValue.serverTimestamp(),updatedAt:firebase.firestore.FieldValue.serverTimestamp()}),!0}catch(t){return console.error("Error creating user:",t),!1}},updateUser:async(r,e)=>{try{return await window.GLRSApp.db.collection("users").doc(r).update({...e,updatedAt:firebase.firestore.FieldValue.serverTimestamp()}),!0}catch(t){return console.error("Error updating user:",t),!1}},getCheckIns:async(r,e=30)=>{try{return(await window.GLRSApp.db.collection("checkIns").where("userId","==",r).orderBy("createdAt","desc").limit(e).get()).docs.map(o=>({id:o.id,...o.data()}))}catch(t){return console.error("Error getting check-ins:",t),[]}},createCheckIn:async r=>{try{return(await window.GLRSApp.db.collection("checkIns").add({...r,createdAt:firebase.firestore.FieldValue.serverTimestamp()})).id}catch(e){return console.error("Error creating check-in:",e),null}},getCheckIn:async r=>{try{const e=await window.GLRSApp.db.collection("checkIns").doc(r).get();return e.exists?{id:e.id,...e.data()}:null}catch(e){return console.error("Error getting check-in:",e),null}},updateCheckIn:async(r,e)=>{try{return await window.GLRSApp.db.collection("checkIns").doc(r).update({...e,updatedAt:firebase.firestore.FieldValue.serverTimestamp()}),!0}catch(t){return console.error("Error updating check-in:",t),!1}},getNotifications:async(r,e=20)=>{try{return(await window.GLRSApp.db.collection("notifications").where("userId","==",r).orderBy("createdAt","desc").limit(e).get()).docs.map(o=>({id:o.id,...o.data()}))}catch(t){return console.error("Error getting notifications:",t),[]}},createNotification:async r=>{try{return(await window.GLRSApp.db.collection("notifications").add({...r,read:!1,createdAt:firebase.firestore.FieldValue.serverTimestamp()})).id}catch(e){return console.error("Error creating notification:",e),null}},markNotificationRead:async r=>{try{return await window.GLRSApp.db.collection("notifications").doc(r).update({read:!0,readAt:firebase.firestore.FieldValue.serverTimestamp()}),!0}catch(e){return console.error("Error marking notification read:",e),!1}},getAssignments:async r=>{try{return(await window.GLRSApp.db.collection("assignments").where("userId","==",r).orderBy("dueDate","asc").get()).docs.map(t=>({id:t.id,...t.data()}))}catch(e){return console.error("Error getting assignments:",e),[]}},createAssignment:async r=>{try{return(await window.GLRSApp.db.collection("assignments").add({...r,status:"pending",createdAt:firebase.firestore.FieldValue.serverTimestamp()})).id}catch(e){return console.error("Error creating assignment:",e),null}},updateAssignment:async(r,e)=>{try{return await window.GLRSApp.db.collection("assignments").doc(r).update({...e,updatedAt:firebase.firestore.FieldValue.serverTimestamp()}),!0}catch(t){return console.error("Error updating assignment:",t),!1}},getGoals:async r=>{try{return(await window.GLRSApp.db.collection("goals").where("userId","==",r).orderBy("createdAt","desc").get()).docs.map(t=>({id:t.id,...t.data()}))}catch(e){return console.error("Error getting goals:",e),[]}},createGoal:async r=>{try{return(await window.GLRSApp.db.collection("goals").add({...r,status:"active",createdAt:firebase.firestore.FieldValue.serverTimestamp()})).id}catch(e){return console.error("Error creating goal:",e),null}},updateGoal:async(r,e)=>{try{return await window.GLRSApp.db.collection("goals").doc(r).update({...e,updatedAt:firebase.firestore.FieldValue.serverTimestamp()}),!0}catch(t){return console.error("Error updating goal:",t),!1}},getMessages:async(r,e=50)=>{try{return(await window.GLRSApp.db.collection("messages").where("participants","array-contains",r).orderBy("createdAt","desc").limit(e).get()).docs.map(o=>({id:o.id,...o.data()}))}catch(t){return console.error("Error getting messages:",t),[]}},sendMessage:async r=>{try{return(await window.GLRSApp.db.collection("messages").add({...r,createdAt:firebase.firestore.FieldValue.serverTimestamp()})).id}catch(e){return console.error("Error sending message:",e),null}},getResources:async(r=null)=>{try{let e=window.GLRSApp.db.collection("resources");return r&&(e=e.where("userId","==",r)),(await e.orderBy("createdAt","desc").get()).docs.map(o=>({id:o.id,...o.data()}))}catch(e){return console.error("Error getting resources:",e),[]}},createResource:async r=>{try{return(await window.GLRSApp.db.collection("resources").add({...r,createdAt:firebase.firestore.FieldValue.serverTimestamp()})).id}catch(e){return console.error("Error creating resource:",e),null}},getHabits:async r=>{try{return(await window.GLRSApp.db.collection("habits").where("userId","==",r).orderBy("createdAt","desc").get()).docs.map(t=>({id:t.id,...t.data()}))}catch(e){return console.error("Error getting habits:",e),[]}},createHabit:async r=>{try{return(await window.GLRSApp.db.collection("habits").add({...r,createdAt:firebase.firestore.FieldValue.serverTimestamp()})).id}catch(e){return console.error("Error creating habit:",e),null}},listenToUser:(r,e)=>window.GLRSApp.db.collection("users").doc(r).onSnapshot(t=>{t.exists&&e({id:t.id,...t.data()})}),listenToNotifications:(r,e)=>window.GLRSApp.db.collection("notifications").where("userId","==",r).orderBy("createdAt","desc").limit(20).onSnapshot(t=>{const o=t.docs.map(a=>({id:a.id,...a.data()}));e(o)}),listenToCheckIns:(r,e)=>window.GLRSApp.db.collection("checkIns").where("userId","==",r).orderBy("createdAt","desc").limit(30).onSnapshot(t=>{const o=t.docs.map(a=>({id:a.id,...a.data()}));e(o)})},Object.keys(window.GLRSApp.services.firestore).forEach(r=>{window[r]=window.GLRSApp.services.firestore[r]}),console.log("\u2705 firestore.js loaded - Database service available"),window.GLRSApp=window.GLRSApp||{},window.GLRSApp.services=window.GLRSApp.services||{},!window.GLRSApp.storage&&!window.storage&&console.warn("\u26A0\uFE0F Firebase Storage not initialized"),window.GLRSApp.services.storage={uploadChatImage:async(r,e,t)=>r?new Promise((o,a)=>{const c=new FileReader;c.onload=l=>{const s=new Image;s.onload=()=>{const n=document.createElement("canvas"),w=n.getContext("2d"),u=800,d=800;let i=s.width,p=s.height;i>p?i>u&&(p=u/i*p,i=u):p>d&&(i=d/p*i,p=d),n.width=i,n.height=p,w.drawImage(s,0,0,i,p);const g=n.toDataURL("image/jpeg",.6);if(g.length>9e5){alert("Image too large. Please choose a smaller image."),a(new Error("Image too large after compression"));return}o(g)},s.onerror=()=>a(new Error("Failed to load image")),s.src=l.target.result},c.onerror=a,c.readAsDataURL(r)}):null,uploadFile:async(r,e,t)=>{if(!window.GLRSApp.storage&&!window.storage)throw new Error("Firebase Storage not initialized");const a=window.GLRSApp.storage.ref(e).put(r);return new Promise((c,l)=>{a.on("state_changed",s=>{const n=s.bytesTransferred/s.totalBytes*100;t&&t(n)},s=>l(s),async()=>{const s=await a.snapshot.ref.getDownloadURL();c(s)})})},uploadDataURL:async(r,e)=>{if(!window.GLRSApp.storage&&!window.storage)throw new Error("Firebase Storage not initialized");const t=window.GLRSApp.storage.ref(e);return await t.putString(r,"data_url"),await t.getDownloadURL()},deleteFile:async r=>{if(!window.GLRSApp.storage&&!window.storage)throw new Error("Firebase Storage not initialized");return await window.GLRSApp.storage.ref(r).delete(),!0},getDownloadURL:async r=>{if(!window.GLRSApp.storage&&!window.storage)throw new Error("Firebase Storage not initialized");return await window.GLRSApp.storage.ref(r).getDownloadURL()},compressImage:async(r,e=800,t=800,o=.6)=>r?new Promise((a,c)=>{const l=new FileReader;l.onload=s=>{const n=new Image;n.onload=()=>{const w=document.createElement("canvas"),u=w.getContext("2d");let d=n.width,i=n.height;d>i?d>e&&(i=e/d*i,d=e):i>t&&(d=t/i*d,i=t),w.width=d,w.height=i,u.drawImage(n,0,0,d,i),a(w.toDataURL("image/jpeg",o))},n.onerror=()=>c(new Error("Failed to load image")),n.src=s.target.result},l.onerror=c,l.readAsDataURL(r)}):null},window.uploadChatImage=window.GLRSApp.services.storage.uploadChatImage,window.uploadFile=window.GLRSApp.services.storage.uploadFile,window.compressImage=window.GLRSApp.services.storage.compressImage,console.log("\u2705 storage.js loaded - Storage service available"),window.GLRSApp=window.GLRSApp||{},window.GLRSApp.services=window.GLRSApp.services||{};let functions=null;typeof firebase<"u"&&firebase.apps.length&&firebase.functions?(functions=firebase.functions(),window.GLRSApp.functions=functions,window.functions=functions,console.log("\u2705 Firebase Functions initialized")):console.warn("\u26A0\uFE0F Firebase Functions not available"),window.GLRSApp.services.functions={callFunction:async(r,e={})=>{if(!functions)throw new Error("Firebase Functions not initialized");try{return(await functions.httpsCallable(r)(e)).data}catch(t){throw console.error(`Error calling function ${r}:`,t),t}}},window.callFunction=window.GLRSApp.services.functions.callFunction,console.log("\u2705 functions.js loaded - Cloud Functions service available"),window.GLRSApp=window.GLRSApp||{},window.GLRSApp.authUtils={getCurrentUserId:()=>{const r=firebase.auth().currentUser;return r?r.uid:null},isAuthenticated:()=>firebase.auth().currentUser!==null,getCurrentUser:()=>firebase.auth().currentUser,handleLogout:async()=>{if(confirm("Are you sure you want to sign out?"))try{await firebase.auth().signOut(),console.log(" User signed out")}catch(r){console.error("L Logout error:",r),alert("Error signing out. Please try again.")}},getCurrentUserEmail:()=>{const r=firebase.auth().currentUser;return r?r.email:null},isEmailVerified:()=>{const r=firebase.auth().currentUser;return r?r.emailVerified:!1}},console.log("\u2705 auth.js loaded - Authentication utilities available at window.GLRSApp.authUtils");
