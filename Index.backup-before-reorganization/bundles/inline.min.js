const{useState,useEffect,useRef}=React,auth=window.GLRSApp.auth||window.auth,db=window.GLRSApp.db||window.db,storage=window.GLRSApp.storage||window.storage;function LighthouseLogo({size:a=100}){return React.createElement("svg",{width:a,height:a,viewBox:"0 0 200 200",fill:"none",xmlns:"http://www.w3.org/2000/svg"},React.createElement("circle",{cx:"100",cy:"100",r:"95",stroke:"#1e3c72",strokeWidth:"3",fill:"rgba(30, 60, 114, 0.1)"}),React.createElement("path",{d:"M100 140 L85 180 L115 180 Z",fill:"#ffffff"}),React.createElement("rect",{x:"92",y:"100",width:"16",height:"40",fill:"#ffffff"}),React.createElement("rect",{x:"88",y:"90",width:"24",height:"10",fill:"#1e3c72"}),React.createElement("path",{d:"M100 70 L90 90 L110 90 Z",fill:"#1e3c72"}),React.createElement("rect",{x:"95",y:"70",width:"10",height:"20",fill:"#1e3c72"}),React.createElement("path",{d:"M100 80 L60 70",stroke:"#f4c430",strokeWidth:"3",opacity:"0.8"}),React.createElement("path",{d:"M100 80 L140 70",stroke:"#f4c430",strokeWidth:"3",opacity:"0.8"}),React.createElement("path",{d:"M100 80 L50 85",stroke:"#f4c430",strokeWidth:"3",opacity:"0.6"}),React.createElement("path",{d:"M100 80 L150 85",stroke:"#f4c430",strokeWidth:"3",opacity:"0.6"}),React.createElement("circle",{cx:"100",cy:"80",r:"8",fill:"#f4c430"}),React.createElement("path",{d:"M 60 170 Q 80 165, 100 170 T 140 170",stroke:"#4a90e2",strokeWidth:"2",fill:"none"}),React.createElement("path",{d:"M 50 175 Q 75 170, 100 175 T 150 175",stroke:"#4a90e2",strokeWidth:"2",fill:"none",opacity:"0.6"}))}function firestoreWithTimeout(a,i=1e4){let o;const g=new Promise((e,t)=>{o=setTimeout(()=>{t(new Error(`Firestore query timeout after ${i}ms`))},i)});return Promise.race([a,g]).finally(()=>clearTimeout(o))}function App(){const[a,i]=useState(null),[o,g]=useState(!0);return useEffect(()=>{console.log("\u{1F50D} DEBUG: Setting up auth listener"),console.log("\u{1F50D} DEBUG: auth object:",auth),console.log("\u{1F50D} DEBUG: auth.onAuthStateChanged:",typeof auth?.onAuthStateChanged);const e=auth.onAuthStateChanged(async t=>{if(console.log("\u{1F50D} DEBUG: Auth state changed, user:",t?t.email:"null"),t)try{console.log("\u{1F50D} DEBUG: Verifying auth token..."),await t.getIdToken(!1),await new Promise(d=>setTimeout(d,100)),console.log("\u{1F50D} DEBUG: Token verified, querying user document...");let s=await firestoreWithTimeout(db.collection("users").doc(t.uid).get(),1e4);s.exists||(await db.collection("users").doc(t.uid).set({email:t.email,role:"pir",createdAt:firebase.firestore.FieldValue.serverTimestamp(),updatedAt:firebase.firestore.FieldValue.serverTimestamp(),active:!0,sobrietyDate:new Date().toISOString(),profileComplete:!1}),s=await db.collection("users").doc(t.uid).get());const n=s.data();n&&!n.createdAt&&await db.collection("users").doc(t.uid).update({createdAt:firebase.firestore.FieldValue.serverTimestamp()}),n&&n.role!=="pir"?(await auth.signOut(),alert("This portal is for PIRs only. Coaches should use admin.html"),i(null)):i(t)}catch{i(null)}else console.log("\u{1F50D} DEBUG: No Firebase user, setting user to null"),i(null);console.log("\u{1F50D} DEBUG: Setting loading to false"),g(!1)});return()=>e()},[]),o?React.createElement("div",{className:"loading-container"},React.createElement("div",{className:"loading-spinner"})):a?React.createElement(PIRApp,{user:a}):React.createElement(LoginScreen,null)}function LoginScreen(){const[a,i]=useState(""),[o,g]=useState(""),[e,t]=useState(""),[s,n]=useState(!1),[d,r]=useState(""),l=async c=>{if(c.preventDefault(),t(""),r(""),!a||!o){t("Please enter both email and password");return}n(!0);try{await auth.signInWithEmailAndPassword(a,o),r("Login successful! Redirecting...")}catch(u){switch(u.code){case"auth/user-not-found":t("No account found with this email");break;case"auth/wrong-password":t("Incorrect password");break;case"auth/invalid-email":t("Invalid email address");break;default:t("Failed to sign in. Please try again.")}}finally{n(!1)}};return React.createElement("div",{className:"login-container"},React.createElement("div",{className:"login-card"},React.createElement("h1",{className:"app-title",style:{marginTop:"40px"}},"Guiding Light"),React.createElement("p",{className:"app-subtitle"},"Recovery Services"),React.createElement("form",{onSubmit:l},React.createElement("div",{className:"form-group"},React.createElement("label",{className:"form-label"},"Email"),React.createElement("input",{type:"email",className:"form-input",placeholder:"Enter your email",value:a,onChange:c=>i(c.target.value),disabled:s,autoComplete:"email"})),React.createElement("div",{className:"form-group"},React.createElement("label",{className:"form-label"},"Password"),React.createElement("input",{type:"password",className:"form-input",placeholder:"Enter your password",value:o,onChange:c=>g(c.target.value),disabled:s,autoComplete:"current-password"})),React.createElement("button",{type:"submit",className:"btn-primary",disabled:s},s?"Signing in...":"Sign In"),e&&React.createElement("div",{className:"error-message"},e),d&&React.createElement("div",{className:"success-message"},d))))}const exportGraphsToPDF=async(a,i)=>{try{console.log("\u{1F4C4} Starting PDF export...");const o=document.querySelector('canvas[id*="mood"]')||document.querySelector(".wellness-graph canvas");if(!o){alert("\u274C Could not find wellness graphs to export. Please ensure graphs are visible on screen.");return}const{jsPDF:g}=window.jspdf,e=new g("p","mm","a4"),t=e.internal.pageSize.getWidth(),s=e.internal.pageSize.getHeight();if(e.setFontSize(20),e.setTextColor(0,119,204),e.text("Wellness Graphs Report",t/2,20,{align:"center"}),e.setFontSize(12),e.setTextColor(51,51,51),e.text(`Generated: ${new Date().toLocaleDateString()}`,20,30),a&&a.start){const r=`Period: ${a.start.toLocaleDateString()} - ${(a.end||new Date).toLocaleDateString()}`;e.text(r,20,36)}const n=document.querySelector(".wellness-graphs-container")||document.querySelector('[style*="wellness"]')||o.closest("div");if(n){console.log("\u{1F4CA} Capturing graphs container with html2canvas...");const r=await html2canvas(n,{scale:2,logging:!1,backgroundColor:"#ffffff",windowWidth:n.scrollWidth,windowHeight:n.scrollHeight}),l=r.toDataURL("image/png"),c=t-40,u=r.height*c/r.width;if(u>s-50){const h=s-50,m=r.width*h/r.height;e.addImage(l,"PNG",(t-m)/2,45,m,h)}else e.addImage(l,"PNG",20,45,c,u);console.log("\u2705 Image added to PDF")}e.setFontSize(10),e.setTextColor(102,102,102),e.text("Generated with GLRS Lighthouse Recovery App",t/2,s-10,{align:"center"});const d=`wellness-graphs-${new Date().toISOString().split("T")[0]}.pdf`;e.save(d),console.log("\u2705 PDF saved successfully:",d),alert("\u2705 PDF downloaded successfully!")}catch(o){console.error("\u274C PDF export error:",o),alert(`\u274C Error creating PDF. Please try again.

`+o.message)}},shareGraphsPDF=async(a,i)=>{try{console.log("\u{1F4C4} Creating PDF for sharing...");const o=document.querySelector('canvas[id*="mood"]')||document.querySelector(".wellness-graph canvas");if(!o){alert("\u274C Could not find wellness graphs to share. Please ensure graphs are visible on screen.");return}const{jsPDF:g}=window.jspdf,e=new g("p","mm","a4"),t=e.internal.pageSize.getWidth(),s=e.internal.pageSize.getHeight();if(e.setFontSize(20),e.setTextColor(0,119,204),e.text("Wellness Graphs Report",t/2,20,{align:"center"}),e.setFontSize(12),e.setTextColor(51,51,51),e.text(`Generated: ${new Date().toLocaleDateString()}`,20,30),a&&a.start){const l=`Period: ${a.start.toLocaleDateString()} - ${(a.end||new Date).toLocaleDateString()}`;e.text(l,20,36)}const n=document.querySelector(".wellness-graphs-container")||document.querySelector('[style*="wellness"]')||o.closest("div");if(n){console.log("\u{1F4CA} Capturing graphs for sharing...");const l=await html2canvas(n,{scale:2,logging:!1,backgroundColor:"#ffffff",windowWidth:n.scrollWidth,windowHeight:n.scrollHeight}),c=l.toDataURL("image/png"),u=t-40,h=l.height*u/l.width;if(h>s-50){const m=s-50,p=l.width*m/l.height;e.addImage(c,"PNG",(t-p)/2,45,p,m)}else e.addImage(c,"PNG",20,45,u,h)}e.setFontSize(10),e.setTextColor(102,102,102),e.text("Generated with GLRS Lighthouse Recovery App",t/2,s-10,{align:"center"});const d=e.output("blob"),r=`wellness-graphs-${new Date().toISOString().split("T")[0]}.pdf`;if(navigator.share&&navigator.canShare&&navigator.canShare({files:[new File([d],r,{type:"application/pdf"})]})){const l=new File([d],r,{type:"application/pdf"});await navigator.share({title:"Wellness Graphs Report",text:"My wellness progress graphs from GLRS Lighthouse",files:[l]}),console.log("\u2705 PDF shared successfully")}else e.save(r),alert("\u2705 PDF downloaded! (File sharing not supported on this device)")}catch(o){o.name!=="AbortError"&&(console.error("\u274C PDF share error:",o),alert(`\u274C Error sharing PDF. Please try again.

`+o.message))}};window.GLRSApp.exportGraphsToPDF=exportGraphsToPDF,window.GLRSApp.shareGraphsPDF=shareGraphsPDF,ReactDOM.render(React.createElement(App,null),document.getElementById("root"));
