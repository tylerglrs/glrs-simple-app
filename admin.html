<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://apis.google.com https://accounts.google.com https://www.gstatic.com https://www.googleapis.com https://cdn.jsdelivr.net https://unpkg.com https://cdnjs.cloudflare.com; frame-src 'self' https://accounts.google.com https://content.googleapis.com; connect-src 'self' https://*.googleapis.com https://*.google.com https://accounts.google.com https://*.firebaseio.com https://firestore.googleapis.com https://content.googleapis.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:;">
    <title>GLRS Admin Portal</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Google Identity Services (NEW API) -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- jsPDF for PDF exports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1f3a 0%, #0d1117 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }

        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Connection Status Bar */
        .connection-status {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 5px;
            text-align: center;
            font-size: 12px;
            z-index: 2000;
            transition: all 0.3s ease;
        }

        .connection-status.online {
            background: #4caf50;
            transform: translateY(-100%);
        }

        .connection-status.offline {
            background: #f44336;
            transform: translateY(0);
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            color: #000;
            font-weight: bold;
            font-size: 18px;
            text-align: center;
        }

        .nav-section {
            padding: 10px;
        }

        .nav-section-title {
            font-size: 11px;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.5);
            padding: 10px;
            letter-spacing: 1px;
        }

        .nav-item {
            padding: 12px 15px;
            margin: 5px 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            color: #000;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            padding: 20px 30px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .search-bar {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            color: white;
            width: 300px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-bar:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #f4c430;
        }

        .refresh-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
            padding: 10px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .notification-bell:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .notification-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
        }

        .content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        /* Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .stat-label {
            font-size: 12px;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .stat-change {
            font-size: 12px;
            color: #4caf50;
        }

        /* Tables */
        .table-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        th {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.8);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        td {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.9);
        }

        tr:hover td {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
            outline: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            color: #000;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 196, 48, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: #1a1f3a;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #f4c430;
        }

        select.form-input {
            cursor: pointer;
        }

        textarea.form-input {
            resize: vertical;
            min-height: 100px;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
        }

        .page-btn {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .page-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.2);
        }

        .page-btn.active {
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            color: #000;
            border: none;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Loading */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #f4c430;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 50px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-container {
            text-align: center;
            padding: 50px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 50px;
            color: rgba(255, 255, 255, 0.5);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .empty-state-text {
            font-size: 16px;
        }

        /* User Avatar */
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            color: white;
        }

        /* Status Badges */
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .badge-success {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
            border: 1px solid #4caf50;
        }

        .badge-warning {
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
            border: 1px solid #ff9800;
        }

        .badge-danger {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
            border: 1px solid #f44336;
        }

        .badge-info {
            background: rgba(33, 150, 243, 0.2);
            color: #2196f3;
            border: 1px solid #2196f3;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-btn:hover {
            color: rgba(255, 255, 255, 0.9);
        }

        .tab-btn.active {
            color: #f4c430;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
        }

        /* Notification Dropdown */
        .notification-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            width: 400px;
            background: #1a1f3a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin-top: 10px;
            max-height: 500px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .notification-header {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-item {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .notification-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .notification-item.unread {
            background: rgba(244, 196, 48, 0.1);
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            transition: width 0.3s ease;
        }

        /* File Upload */
        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #f4c430;
            background: rgba(244, 196, 48, 0.05);
        }

        .upload-area.dragging {
            border-color: #f4c430;
            background: rgba(244, 196, 48, 0.1);
        }

        /* Charts Container */
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            height: 400px;
            position: relative;
        }

        /* Messages */
        .message-bubble {
            padding: 10px 15px;
            border-radius: 15px;
            margin-bottom: 10px;
            max-width: 70%;
        }

        .message-bubble.sent {
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            color: #000;
            align-self: flex-end;
            margin-left: auto;
        }

        .message-bubble.received {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
        }

        /* Groups */
        .group-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .group-title {
            font-size: 18px;
            font-weight: 600;
        }

        .group-members {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .member-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            border: 2px solid #1a1f3a;
        }

        /* Resources */
        .resource-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .resource-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .resource-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .resource-type {
            display: inline-block;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            font-size: 11px;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .resource-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .resource-description {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 15px;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1f3a 0%, #0d1117 100%);
        }

        .login-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-title {
            font-size: 32px;
            font-weight: bold;
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .error-message {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid #f44336;
            color: #f44336;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .success-message {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid #4caf50;
            color: #4caf50;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        /* Checkbox */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        /* Filters */
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            font-size: 12px;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.6);
            letter-spacing: 1px;
        }

        .filter-select {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            outline: none;
            transition: all 0.3s ease;
        }

        .filter-select:focus {
            border-color: #f4c430;
            background: rgba(255, 255, 255, 0.15);
        }

        /* Date Range Picker */
        .date-range {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .date-input {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            outline: none;
        }

        /* Mood Rating Display */
        .mood-scale {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .mood-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .mood-1 { background: #ff4444; }
        .mood-2 { background: #ff6b44; }
        .mood-3 { background: #ff9944; }
        .mood-4 { background: #ffaa44; }
        .mood-5 { background: #ffcc44; }
        .mood-6 { background: #eedd44; }
        .mood-7 { background: #bbdd44; }
        .mood-8 { background: #99dd44; }
        .mood-9 { background: #66dd44; }
        .mood-10 { background: #44dd44; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAufSTHtCTFSEIeZ9YzvrULCnji5I-SMi0",
            authDomain: "glrs-pir-system.firebaseapp.com",
            projectId: "glrs-pir-system",
            storageBucket: "glrs-pir-system.appspot.com",
            messagingSenderId: "830378577655",
            appId: "1:830378577655:web:your-app-id"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        const { useState, useEffect, useRef, useMemo, useCallback } = React;

       function formatDate(date) {
    if (!date) return '';
    const d = date?.toDate ? date.toDate() : new Date(date);
    return d.toLocaleDateString('en-US', { timeZone: 'UTC' });
}
       

        function formatDateTime(date) {
            if (!date) return '-';
            const d = date?.toDate ? date.toDate() : new Date(date);
            if (isNaN(d.getTime())) return '-';
            return d.toLocaleString();
        }

        function formatTimeAgo(date) {
            if (!date) return '-';
            const d = date?.toDate ? date.toDate() : new Date(date);
            if (isNaN(d.getTime())) return '-';
            const now = new Date();
            const seconds = Math.floor((now - d) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)} mins ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)} days ago`;
            return d.toLocaleDateString();
        }

        // Debounce utility
        function useDebounce(value, delay) {
            const [debouncedValue, setDebouncedValue] = useState(value);
            
            useEffect(() => {
                const handler = setTimeout(() => {
                    setDebouncedValue(value);
                }, delay);
                
                return () => clearTimeout(handler);
            }, [value, delay]);
            
            return debouncedValue;
        }

        // Connection Status Hook
        function useConnectionStatus() {
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            
            useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);
                
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);
            
            return isOnline;
        }

        // Batch query utility - handles Firestore's 10-item 'in' query limit
        async function batchQuery(collection, field, values, additionalConstraints = []) {
            if (values.length === 0) return [];
            
            const results = [];
            const chunks = [];
            
            // Split into chunks of 10
            for (let i = 0; i < values.length; i += 10) {
                chunks.push(values.slice(i, i + 10));
            }
            
            // Query each chunk
            for (const chunk of chunks) {
                let query = db.collection(collection).where(field, 'in', chunk);
                
                // Add additional constraints
                for (const constraint of additionalConstraints) {
                    query = query[constraint.method](...constraint.args);
                }
                
                const snapshot = await query.get();
                snapshot.forEach(doc => {
                    results.push({ id: doc.id, ...doc.data() });
                });
            }
            
            return results;
        }

        // Export utilities
        function exportToJSON(data, filename) {
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportToCSV(data, filename) {
            if (!data || data.length === 0) {
                alert('No data to export');
                return;
            }
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => 
                    headers.map(header => {
                        const cell = row[header];
                        const value = cell === null || cell === undefined ? '' : String(cell);
                        return value.includes(',') || value.includes('"') || value.includes('\n') 
                            ? `"${value.replace(/"/g, '""')}"` 
                            : value;
                    }).join(',')
                )
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportToPDF(data, title) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.text(title, 20, 20);
            
            if (Array.isArray(data) && data.length > 0) {
                const headers = Object.keys(data[0]);
                const rows = data.map(item => headers.map(header => String(item[header] || '')));
                
                doc.autoTable({
                    head: [headers],
                    body: rows,
                    startY: 30,
                });
            } else {
                doc.setFontSize(12);
                doc.text(JSON.stringify(data, null, 2), 20, 40);
            }
            
            doc.save(`${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // Main App Component
function AdminApp() {
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(true);
    const [currentView, setCurrentView] = useState('dashboard');
    const [searchQuery, setSearchQuery] = useState('');
    const [notifications, setNotifications] = useState([]);
    const [showNotifications, setShowNotifications] = useState(false);
    const isOnline = useConnectionStatus();
    
    // FIX: Move useDebounce here at component level
    const debouncedSearchQuery = useDebounce(searchQuery, 300);
    
    // Firestore listeners cleanup
    const unsubscribers = useRef([]);

    useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged(async (authUser) => {
            if (authUser) {
                try {
                    const userDoc = await db.collection('users').doc(authUser.uid).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        if (userData.role === 'admin') {
                            setUser({ uid: authUser.uid, ...userData });
                            setupRealtimeListeners(authUser.uid);
                        } else {
                            auth.signOut();
                            alert('Access denied. Admin access required.');
                        }
                    } else {
                        auth.signOut();
                        alert('User profile not found.');
                    }
                } catch (error) {
                    console.error('Error loading user:', error);
                    auth.signOut();
                }
            } else {
                setUser(null);
                cleanupListeners();
            }
            setLoading(false);
        });

        return () => {
            unsubscribe();
            cleanupListeners();
        };
    }, []);

    const setupRealtimeListeners = (userId) => {
        // Clean up existing listeners
        cleanupListeners();
        
        // Listen to notifications
        try {
            const notifQuery = db.collection('notifications')
                .where('recipientId', '==', userId)
                .orderBy('createdAt', 'desc')
                .limit(50);
            
            const unsubNotif = notifQuery.onSnapshot(
                snapshot => {
                    const notifs = [];
                    snapshot.forEach(doc => {
                        notifs.push({ id: doc.id, ...doc.data() });
                    });
                    setNotifications(notifs);
                },
                error => {
                    console.error('Error loading notifications:', error);
                }
            );
            
            unsubscribers.current.push(unsubNotif);
        } catch (error) {
            console.error('Error setting up listeners:', error);
        }
    };

    const cleanupListeners = () => {
        unsubscribers.current.forEach(unsub => {
            try {
                unsub();
            } catch (error) {
                console.error('Error cleaning up listener:', error);
            }
        });
        unsubscribers.current = [];
    };

    const handleLogout = async () => {
        try {
            cleanupListeners();
            await auth.signOut();
            setUser(null);
            setCurrentView('dashboard');
        } catch (error) {
            console.error('Logout error:', error);
            alert('Error logging out. Please try again.');
        }
    };

    const handleImpersonate = (targetUser) => {
        // Open PIR view in new tab/window
        const pirViewUrl = `pir-view.html?userId=${targetUser.id}`;
        window.open(pirViewUrl, '_blank');
    };

    if (loading) {
        return (
            <div className="loading-container">
                <div className="loading-spinner"></div>
                <p style={{marginTop: '20px'}}>Loading Admin Portal...</p>
            </div>
        );
    }

    if (!user) {
        return <LoginScreen />;
    }

   return (
    <>
        <div className={`connection-status ${isOnline ? 'online' : 'offline'}`}>
            {!isOnline && '‚ö†Ô∏è Offline - Some features may be limited'}
        </div>
        
        <div style={{ display: 'flex', flexDirection: 'column', minHeight: '100vh' }}>
            {/* Header FIRST */}
            <Header 
                currentView={currentView}
                searchQuery={searchQuery}
                setSearchQuery={setSearchQuery}
                notifications={notifications}
                showNotifications={showNotifications}
                setShowNotifications={setShowNotifications}
                onLogout={handleLogout}
                user={user}
            />
            
            {/* TopNav SECOND */}
            <TopNav 
                currentView={currentView}
                setCurrentView={setCurrentView}
            />
            
          <div className="content" style={{ flex: 1, background: '#c4c9cf' }}>
                {renderView(currentView, debouncedSearchQuery, user, handleImpersonate)}
            </div>
        </div>
    </>
);
}

// View Renderer - NO HOOKS HERE
function renderView(view, searchQuery, user, onImpersonate) {
    // REMOVED: const debouncedSearchQuery = useDebounce(searchQuery, 300);
    // Now searchQuery is already debounced when passed in
    
    switch(view) {
        case 'dashboard':
            return <DashboardView user={user} />;
        case 'users':
            return <UsersView searchQuery={searchQuery} user={user} onImpersonate={onImpersonate} />;
        case 'profile':
            return <ProfileView user={user} />;
            case 'mypirs':
    return <MyPIRsView searchQuery={searchQuery} user={user} />;
        case 'feedback':
            return <FeedbackView searchQuery={searchQuery} user={user} />;
        case 'resources':
            return <ResourcesView user={user} searchQuery={searchQuery} />;
        case 'groups':
            return <GroupsView user={user} searchQuery={searchQuery} />;
            case 'community':
    return <CommunityView searchQuery={searchQuery} user={user} />;
        case 'checkins':
            return <CheckInsView searchQuery={searchQuery} />;
        case 'assignments':
            return <AssignmentsView searchQuery={searchQuery} user={user} />;
            case 'goals':
    return <GoalsView searchQuery={searchQuery} user={user} />;
        case 'alerts':
            return <AlertsView searchQuery={searchQuery} user={user} />;
        case 'reports':
            return <ReportsView user={user} />;
        case 'settings':
            return <SettingsView user={user} />;
        default:
            return <div className="empty-state">View not found</div>;
    }
}

// Top Navigation Component with Full-Height Profile Card
function TopNav({ currentView, setCurrentView }) {
    const [user, setUser] = useState(null);
    const [showCreateUserModal, setShowCreateUserModal] = useState(false);
    const [createUserRole, setCreateUserRole] = useState('pir');

    useEffect(() => {
        const currentUser = auth.currentUser;
        if (currentUser) {
            db.collection('users').doc(currentUser.uid).get()
                .then(doc => {
                    if (doc.exists) {
                        setUser({ uid: currentUser.uid, ...doc.data() });
                    }
                })
                .catch(err => console.error('Error loading user:', err));
        }
    }, []);

    const handleCreatePIR = () => {
        setCreateUserRole('pir');
        setShowCreateUserModal(true);
    };

    const handleAddCoach = () => {
        setCreateUserRole('coach');
        setShowCreateUserModal(true);
    };

    const handleAddResource = () => {
        setCurrentView('resources');
    };

    const handleCreateGroup = () => {
        setCurrentView('groups');
    };

    const menuItems = [
        { id: 'dashboard', label: 'Dashboard', icon: 'üìä' },
        { id: 'users', label: 'Users', icon: 'üë•' },
        { id: 'mypirs', label: 'My PIRs', icon: 'üéØ' },
        { id: 'profile', label: 'My Profile', icon: 'üë§' },
        { id: 'feedback', label: 'Feedback', icon: 'üìù' },
        { id: 'resources', label: 'Resources', icon: 'üìö' },
        { id: 'groups', label: 'Groups', icon: 'üë´' },
        { id: 'goals', label: 'Goals', icon: 'üéØ' },
        { id: 'community', label: 'Community', icon: 'üí¨' },
        { id: 'checkins', label: 'Check-ins', icon: '‚úÖ' },
        { id: 'assignments', label: 'Assignments', icon: 'üìã' },
        { id: 'alerts', label: 'Alerts', icon: 'üö®' },
        { id: 'reports', label: 'Reports', icon: 'üìà' },
        { id: 'settings', label: 'Settings', icon: '‚öôÔ∏è' }
    ];

    const row1 = [menuItems[0], menuItems[1], menuItems[2], menuItems[3]];
    const row2 = [menuItems[4], menuItems[5], menuItems[6], menuItems[7]];
    const row3 = [menuItems[8], menuItems[9], menuItems[10], menuItems[11]];
    const row4 = [menuItems[12], menuItems[13]];

    return (
        <>
            <div style={{
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                padding: '10px 20px',
                boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                position: 'sticky',
                top: 0,
                zIndex: 100,
                display: 'flex',
                gap: '20px',
                minHeight: '140px'
            }}>
                {/* Left Side - Logo and Navigation */}
                <div style={{ flex: 1, display: 'flex', flexDirection: 'column', gap: '8px' }}>
                    {/* Logo */}
                    <div style={{
                        color: 'white',
                        fontSize: '18px',
                        fontWeight: 'bold',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px',
                        marginBottom: '4px'
                    }}>
                        üõ°Ô∏è GLRS Admin
                    </div>

                    {/* Navigation Buttons - Staggered */}
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
                        {/* Row 1 */}
                        <div style={{ display: 'flex', gap: '10px', paddingLeft: '0px' }}>
                            {row1.map(item => (
                                <button
                                    key={item.id}
                                    onClick={() => setCurrentView(item.id)}
                                    style={{
                                        padding: '6px 16px',
                                        background: currentView === item.id ? 'white' : 'rgba(255,255,255,0.1)',
                                        border: currentView === item.id 
                                            ? '2px solid rgba(255,255,255,0.8)' 
                                            : '2px solid transparent',
                                        borderRadius: '8px',
                                        color: currentView === item.id ? '#667eea' : 'white',
                                        cursor: 'pointer',
                                        fontSize: '13px',
                                        fontWeight: currentView === item.id ? '600' : '500',
                                        transition: 'all 0.3s',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '6px',
                                        backdropFilter: 'blur(10px)',
                                        boxShadow: currentView === item.id 
                                            ? '0 4px 12px rgba(0,0,0,0.2)' 
                                            : 'none',
                                        whiteSpace: 'nowrap'
                                    }}
                                    onMouseEnter={(e) => {
                                        if (currentView !== item.id) {
                                            e.currentTarget.style.background = 'rgba(255,255,255,0.2)';
                                            e.currentTarget.style.transform = 'translateY(-2px)';
                                        }
                                    }}
                                    onMouseLeave={(e) => {
                                        if (currentView !== item.id) {
                                            e.currentTarget.style.background = 'rgba(255,255,255,0.1)';
                                            e.currentTarget.style.transform = 'translateY(0)';
                                        }
                                    }}
                                >
                                    <span style={{ fontSize: '15px' }}>{item.icon}</span>
                                    {item.label}
                                </button>
                            ))}
                        </div>

                        {/* Row 2 - Offset */}
                        <div style={{ display: 'flex', gap: '10px', paddingLeft: '70px' }}>
                            {row2.map(item => (
                                <button
                                    key={item.id}
                                    onClick={() => setCurrentView(item.id)}
                                    style={{
                                        padding: '6px 16px',
                                        background: currentView === item.id ? 'white' : 'rgba(255,255,255,0.1)',
                                        border: currentView === item.id 
                                            ? '2px solid rgba(255,255,255,0.8)' 
                                            : '2px solid transparent',
                                        borderRadius: '8px',
                                        color: currentView === item.id ? '#667eea' : 'white',
                                        cursor: 'pointer',
                                        fontSize: '13px',
                                        fontWeight: currentView === item.id ? '600' : '500',
                                        transition: 'all 0.3s',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '6px',
                                        backdropFilter: 'blur(10px)',
                                        boxShadow: currentView === item.id 
                                            ? '0 4px 12px rgba(0,0,0,0.2)' 
                                            : 'none',
                                        whiteSpace: 'nowrap'
                                    }}
                                    onMouseEnter={(e) => {
                                        if (currentView !== item.id) {
                                            e.currentTarget.style.background = 'rgba(255,255,255,0.2)';
                                            e.currentTarget.style.transform = 'translateY(-2px)';
                                        }
                                    }}
                                    onMouseLeave={(e) => {
                                        if (currentView !== item.id) {
                                            e.currentTarget.style.background = 'rgba(255,255,255,0.1)';
                                            e.currentTarget.style.transform = 'translateY(0)';
                                        }
                                    }}
                                >
                                    <span style={{ fontSize: '15px' }}>{item.icon}</span>
                                    {item.label}
                                </button>
                            ))}
                        </div>

                        {/* Row 3 - Offset */}
                        <div style={{ display: 'flex', gap: '10px', paddingLeft: '35px' }}>
                            {row3.map(item => (
                                <button
                                    key={item.id}
                                    onClick={() => setCurrentView(item.id)}
                                    style={{
                                        padding: '6px 16px',
                                        background: currentView === item.id ? 'white' : 'rgba(255,255,255,0.1)',
                                        border: currentView === item.id 
                                            ? '2px solid rgba(255,255,255,0.8)' 
                                            : '2px solid transparent',
                                        borderRadius: '8px',
                                        color: currentView === item.id ? '#667eea' : 'white',
                                        cursor: 'pointer',
                                        fontSize: '13px',
                                        fontWeight: currentView === item.id ? '600' : '500',
                                        transition: 'all 0.3s',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '6px',
                                        backdropFilter: 'blur(10px)',
                                        boxShadow: currentView === item.id 
                                            ? '0 4px 12px rgba(0,0,0,0.2)' 
                                            : 'none',
                                        whiteSpace: 'nowrap'
                                    }}
                                    onMouseEnter={(e) => {
                                        if (currentView !== item.id) {
                                            e.currentTarget.style.background = 'rgba(255,255,255,0.2)';
                                            e.currentTarget.style.transform = 'translateY(-2px)';
                                        }
                                    }}
                                    onMouseLeave={(e) => {
                                        if (currentView !== item.id) {
                                            e.currentTarget.style.background = 'rgba(255,255,255,0.1)';
                                            e.currentTarget.style.transform = 'translateY(0)';
                                        }
                                    }}
                                >
                                    <span style={{ fontSize: '15px' }}>{item.icon}</span>
                                    {item.label}
                                </button>
                            ))}
                        </div>

                        {/* Row 4 - Offset */}
                        <div style={{ display: 'flex', gap: '10px', paddingLeft: '105px' }}>
                            {row4.map(item => (
                                <button
                                    key={item.id}
                                    onClick={() => setCurrentView(item.id)}
                                    style={{
                                        padding: '6px 16px',
                                        background: currentView === item.id ? 'white' : 'rgba(255,255,255,0.1)',
                                        border: currentView === item.id 
                                            ? '2px solid rgba(255,255,255,0.8)' 
                                            : '2px solid transparent',
                                        borderRadius: '8px',
                                        color: currentView === item.id ? '#667eea' : 'white',
                                        cursor: 'pointer',
                                        fontSize: '13px',
                                        fontWeight: currentView === item.id ? '600' : '500',
                                        transition: 'all 0.3s',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '6px',
                                        backdropFilter: 'blur(10px)',
                                        boxShadow: currentView === item.id 
                                            ? '0 4px 12px rgba(0,0,0,0.2)' 
                                            : 'none',
                                        whiteSpace: 'nowrap'
                                    }}
                                    onMouseEnter={(e) => {
                                        if (currentView !== item.id) {
                                            e.currentTarget.style.background = 'rgba(255,255,255,0.2)';
                                            e.currentTarget.style.transform = 'translateY(-2px)';
                                        }
                                    }}
                                    onMouseLeave={(e) => {
                                        if (currentView !== item.id) {
                                            e.currentTarget.style.background = 'rgba(255,255,255,0.1)';
                                            e.currentTarget.style.transform = 'translateY(0)';
                                        }
                                    }}
                                >
                                    <span style={{ fontSize: '15px' }}>{item.icon}</span>
                                    {item.label}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>

                {/* Right Side - User Profile Card (Full Height) */}
                <div style={{
                    background: 'rgba(255,255,255,0.15)',
                    backdropFilter: 'blur(10px)',
                    borderRadius: '12px',
                    padding: '15px',
                    width: '250px',
                    border: '1px solid rgba(255,255,255,0.2)',
                    display: 'flex',
                    flexDirection: 'column',
                    justifyContent: 'center',
                    gap: '12px'
                }}>
                    {/* User Info */}
                    <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '10px'
                    }}>
                        <div style={{
                            width: '40px',
                            height: '40px',
                            borderRadius: '50%',
                            background: 'white',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            color: '#667eea',
                            fontWeight: 'bold',
                            fontSize: '18px',
                            flexShrink: 0
                        }}>
                            {user?.displayName?.charAt(0) || user?.email?.charAt(0) || 'A'}
                        </div>
                        <div style={{ flex: 1, minWidth: 0 }}>
                            <div style={{
                                color: 'white',
                                fontWeight: '600',
                                fontSize: '13px',
                                marginBottom: '3px',
                                whiteSpace: 'nowrap',
                                overflow: 'hidden',
                                textOverflow: 'ellipsis'
                            }}>
                                {user?.displayName || user?.email || 'Admin User'}
                            </div>
                            <div style={{
                                color: 'rgba(255,255,255,0.8)',
                                fontSize: '11px',
                                textTransform: 'capitalize'
                            }}>
                                {user?.role || 'Admin'} ‚Ä¢ Online
                            </div>
                        </div>
                    </div>

                    {/* Quick Action Buttons */}
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: '1fr 1fr',
                        gap: '8px'
                    }}>
                        <button
                            onClick={handleCreatePIR}
                            style={{
                                padding: '8px 10px',
                                background: 'white',
                                border: 'none',
                                borderRadius: '6px',
                                color: '#667eea',
                                cursor: 'pointer',
                                fontSize: '11px',
                                fontWeight: '600',
                                transition: 'all 0.2s',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '4px'
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.transform = 'translateY(-2px)';
                                e.currentTarget.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.transform = 'translateY(0)';
                                e.currentTarget.style.boxShadow = 'none';
                            }}
                        >
                            + Create PIR
                        </button>

                        <button
                            onClick={handleAddCoach}
                            style={{
                                padding: '8px 10px',
                                background: 'white',
                                border: 'none',
                                borderRadius: '6px',
                                color: '#667eea',
                                cursor: 'pointer',
                                fontSize: '11px',
                                fontWeight: '600',
                                transition: 'all 0.2s',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '4px'
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.transform = 'translateY(-2px)';
                                e.currentTarget.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.transform = 'translateY(0)';
                                e.currentTarget.style.boxShadow = 'none';
                            }}
                        >
                            + Add Coach
                        </button>

                        <button
                            onClick={handleAddResource}
                            style={{
                                padding: '8px 10px',
                                background: 'white',
                                border: 'none',
                                borderRadius: '6px',
                                color: '#667eea',
                                cursor: 'pointer',
                                fontSize: '11px',
                                fontWeight: '600',
                                transition: 'all 0.2s',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '4px'
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.transform = 'translateY(-2px)';
                                e.currentTarget.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.transform = 'translateY(0)';
                                e.currentTarget.style.boxShadow = 'none';
                            }}
                        >
                            + Add Resource
                        </button>

                        <button
                            onClick={handleCreateGroup}
                            style={{
                                padding: '8px 10px',
                                background: 'white',
                                border: 'none',
                                borderRadius: '6px',
                                color: '#667eea',
                                cursor: 'pointer',
                                fontSize: '11px',
                                fontWeight: '600',
                                transition: 'all 0.2s',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '4px'
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.transform = 'translateY(-2px)';
                                e.currentTarget.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.transform = 'translateY(0)';
                                e.currentTarget.style.boxShadow = 'none';
                            }}
                        >
                            + Create Group
                        </button>
                    </div>
                </div>
            </div>

            {/* Create User Modal */}
            {showCreateUserModal && (
                <CreateUserModal 
                    onClose={() => setShowCreateUserModal(false)}
                    onSuccess={() => {
                        setShowCreateUserModal(false);
                        if (currentView === 'users') {
                            window.location.reload();
                        }
                    }}
                    defaultRole={createUserRole}
                />
            )}
        </>
    );
}
      // Enhanced Header Component  
function Header({ currentView, searchQuery, setSearchQuery, notifications, showNotifications, setShowNotifications, onLogout, user }) {
    const [refreshing, setRefreshing] = useState(false);
    const notificationRef = useRef(null);
    
    const unreadCount = notifications.filter(n => !n.read).length;

    const handleRefresh = () => {
        setRefreshing(true);
        setTimeout(() => {
            window.location.reload();
        }, 500);
    };

    const clearNotification = async (notifId) => {
        try {
            await db.collection('notifications').doc(notifId).update({ read: true });
        } catch (error) {
            console.error('Error clearing notification:', error);
        }
    };

    const clearAllNotifications = async () => {
        try {
            const batch = db.batch();
            notifications.forEach(notif => {
                if (!notif.read) {
                    batch.update(db.collection('notifications').doc(notif.id), { read: true });
                }
            });
            await batch.commit();
        } catch (error) {
            console.error('Error clearing all notifications:', error);
        }
    };

    const handleNotificationClick = (notif) => {
        clearNotification(notif.id);
        setShowNotifications(false);
    };

    useEffect(() => {
        const handleClickOutside = (event) => {
            if (notificationRef.current && !notificationRef.current.contains(event.target)) {
                setShowNotifications(false);
            }
        };
        
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, []);

    return (
        <div style={{
            background: 'white',
            padding: '15px 30px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            position: 'sticky',
            top: 0,
            zIndex: 99
        }}>
            <div style={{
                fontSize: '18px',
                fontWeight: '600',
                color: '#333'
            }}>
                {user.displayName || user.email}
            </div>
            
            <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                <input
                    type="text"
                    placeholder="Search users, messages, resources..."
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    style={{
                        padding: '10px 20px',
                        borderRadius: '25px',
                        border: '2px solid #e0e0e0',
                        width: '350px',
                        fontSize: '14px',
                        transition: 'all 0.3s'
                    }}
                    onFocus={(e) => e.currentTarget.style.borderColor = '#667eea'}
                    onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                />
                
                <button 
                    onClick={handleRefresh}
                    disabled={refreshing}
                    style={{
                        padding: '10px 20px',
                        background: refreshing ? '#e0e0e0' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: refreshing ? 'not-allowed' : 'pointer',
                        fontSize: '14px',
                        fontWeight: '500',
                        transition: 'all 0.2s',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px'
                    }}
                    onMouseEnter={(e) => {
                        if (!refreshing) {
                            e.currentTarget.style.transform = 'translateY(-2px)';
                            e.currentTarget.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.4)';
                        }
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = 'none';
                    }}
                >
                    {refreshing ? '‚ü≥' : '‚Üª'} Refresh
                </button>
                
                <div style={{ position: 'relative' }} ref={notificationRef}>
                    <button
                        onClick={() => setShowNotifications(!showNotifications)}
                        style={{
                            background: 'transparent',
                            border: 'none',
                            cursor: 'pointer',
                            fontSize: '24px',
                            position: 'relative',
                            padding: '8px'
                        }}
                    >
                        üîî
                        {unreadCount > 0 && (
                            <div style={{
                                position: 'absolute',
                                top: '4px',
                                right: '4px',
                                background: '#f44336',
                                color: 'white',
                                borderRadius: '50%',
                                width: '20px',
                                height: '20px',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '10px',
                                fontWeight: 'bold'
                            }}>
                                {unreadCount > 99 ? '99+' : unreadCount}
                            </div>
                        )}
                    </button>
                    
                    {showNotifications && (
                        <div style={{
                            position: 'absolute',
                            top: '100%',
                            right: 0,
                            marginTop: '10px',
                            background: 'white',
                            borderRadius: '10px',
                            boxShadow: '0 4px 20px rgba(0,0,0,0.15)',
                            width: '350px',
                            maxHeight: '400px',
                            overflowY: 'auto',
                            zIndex: 1000
                        }}>
                            <div style={{
                                padding: '15px',
                                borderBottom: '1px solid #f0f0f0',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                position: 'sticky',
                                top: 0,
                                background: 'white'
                            }}>
                                <span style={{ fontWeight: '600', color: '#333' }}>
                                    Notifications ({unreadCount})
                                </span>
                                <button 
                                    onClick={clearAllNotifications}
                                    style={{
                                        padding: '5px 10px',
                                        fontSize: '12px',
                                        background: '#f0f0f0',
                                        border: 'none',
                                        borderRadius: '5px',
                                        cursor: 'pointer'
                                    }}
                                >
                                    Clear All
                                </button>
                            </div>
                            
                            {notifications.length === 0 ? (
                                <div style={{ padding: '30px', textAlign: 'center', color: '#999' }}>
                                    No notifications
                                </div>
                            ) : (
                                notifications.slice(0, 20).map(notif => (
                                    <div 
                                        key={notif.id}
                                        onClick={() => handleNotificationClick(notif)}
                                        style={{
                                            padding: '15px',
                                            borderBottom: '1px solid #f0f0f0',
                                            cursor: 'pointer',
                                            background: notif.read ? 'white' : '#f0f4ff',
                                            transition: 'background 0.2s'
                                        }}
                                        onMouseEnter={(e) => e.currentTarget.style.background = '#f8f9fa'}
                                        onMouseLeave={(e) => e.currentTarget.style.background = notif.read ? 'white' : '#f0f4ff'}
                                    >
                                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '5px' }}>
                                            <span style={{ fontSize: '14px', color: '#333' }}>{notif.message}</span>
                                            {notif.urgent && (
                                                <span style={{
                                                    background: '#f44336',
                                                    color: 'white',
                                                    padding: '2px 6px',
                                                    borderRadius: '10px',
                                                    fontSize: '10px'
                                                }}>
                                                    Urgent
                                                </span>
                                            )}
                                        </div>
                                        <div style={{ fontSize: '11px', color: '#999' }}>
                                            {formatTimeAgo(notif.createdAt)}
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    )}
                </div>
                
                <button 
                    onClick={onLogout}
                    style={{
                        padding: '10px 20px',
                        background: '#6c757d',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontSize: '14px',
                        fontWeight: '500',
                        transition: 'all 0.2s'
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.background = '#5a6268';
                        e.currentTarget.style.transform = 'translateY(-2px)';
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.background = '#6c757d';
                        e.currentTarget.style.transform = 'translateY(0)';
                    }}
                >
                    Logout
                </button>
            </div>
        </div>
    );
}

        // Login Screen
        function LoginScreen() {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    setError(error.message);
                    setLoading(false);
                }
            };

            return (
                <div className="login-container">
                    <div className="login-card">
                        <div className="login-header">
                            <div className="login-title">GLRS Admin Portal</div>
                            <p style={{color: 'rgba(255,255,255,0.7)'}}>Administrator Access Only</p>
                        </div>
                        
                        {error && <div className="error-message">{error}</div>}
                        
                        <form onSubmit={handleLogin}>
                            <div className="form-group">
                                <label className="form-label">Email</label>
                                <input
                                    type="email"
                                    className="form-input"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    required
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Password</label>
                                <input
                                    type="password"
                                    className="form-input"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    required
                                />
                            </div>
                            
                            <button 
                                type="submit"
                                className="btn btn-primary"
                                style={{width: '100%'}}
                                disabled={loading}
                            >
                                {loading ? 'Logging in...' : 'Login'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

       
        // Enhanced Dashboard View with Charts and Stats
function DashboardView({ user }) {
    const [stats, setStats] = useState({
        totalPirs: 0,
        totalCoaches: 0,
        alertsToday: 0,
        avgCompliance: 0
    });
    const [chartData, setChartData] = useState({
        mood: { labels: [], data: [], average: 0 },
        craving: { labels: [], data: [], average: 0 },
        anxiety: { labels: [], data: [], average: 0 },
        sleep: { labels: [], data: [], average: 0 }
    });
    const [sobrietyData, setSobrietyData] = useState({ labels: [], data: [], average: 0 });
    const [recentActivity, setRecentActivity] = useState([]);
    const [loading, setLoading] = useState(true);

    // Chart refs
    const moodChartRef = useRef(null);
    const cravingChartRef = useRef(null);
    const anxietyChartRef = useRef(null);
    const sleepChartRef = useRef(null);
    const sobrietyChartRef = useRef(null);

    // Chart instances
    const chartInstances = useRef({});

    useEffect(() => {
        loadDashboardData();

        return () => {
            // Cleanup all charts
            Object.values(chartInstances.current).forEach(chart => {
                if (chart) chart.destroy();
            });
        };
    }, []);

    useEffect(() => {
        if (!loading) {
            renderAllCharts();
        }
    }, [chartData, sobrietyData, loading]);

    const loadDashboardData = async () => {
        try {
            // Load basic stats
            const usersSnap = await db.collection('users').get();
            let totalPirs = 0;
            let totalCoaches = 0;
            const pirIds = [];

            usersSnap.forEach(doc => {
                const data = doc.data();
                if (data.role === 'pir') {
                    totalPirs++;
                    pirIds.push(doc.id);
                }
                if (data.role === 'coach') totalCoaches++;
            });

            // Get today's alerts
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const alertsSnap = await db.collection('alerts')
                .where('createdAt', '>=', today)
                .get();

            // Calculate 30-day trends for all PIRs
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            const checkInsSnap = await db.collection('checkIns')
                .where('createdAt', '>=', thirtyDaysAgo)
                .get();

            // Process check-ins data
            const last30Days = [];
            const moodData = [];
            const cravingData = [];
            const anxietyData = [];
            const sleepData = [];

            // All-time data for averages
            const allCheckInsSnap = await db.collection('checkIns').get();
            let allTimeMood = [];
            let allTimeCraving = [];
            let allTimeAnxiety = [];
            let allTimeSleep = [];

            allCheckInsSnap.forEach(doc => {
                const data = doc.data();
                if (data.morningData) {
                    if (data.morningData.mood) allTimeMood.push(data.morningData.mood);
                    if (data.morningData.craving) allTimeCraving.push(data.morningData.craving);
                    if (data.morningData.anxietyLevel) allTimeAnxiety.push(data.morningData.anxietyLevel);
                    if (data.morningData.sleepQuality) allTimeSleep.push(data.morningData.sleepQuality);
                }
                if (data.eveningData) {
                    if (data.eveningData.mood) allTimeMood.push(data.eveningData.mood);
                    if (data.eveningData.craving) allTimeCraving.push(data.eveningData.craving);
                }
            });

            // Calculate all-time averages
            const avgMood = allTimeMood.length > 0 
                ? (allTimeMood.reduce((a, b) => a + b, 0) / allTimeMood.length).toFixed(1)
                : 0;
            const avgCraving = allTimeCraving.length > 0 
                ? (allTimeCraving.reduce((a, b) => a + b, 0) / allTimeCraving.length).toFixed(1)
                : 0;
            const avgAnxiety = allTimeAnxiety.length > 0 
                ? (allTimeAnxiety.reduce((a, b) => a + b, 0) / allTimeAnxiety.length).toFixed(1)
                : 0;
            const avgSleep = allTimeSleep.length > 0 
                ? (allTimeSleep.reduce((a, b) => a + b, 0) / allTimeSleep.length).toFixed(1)
                : 0;

            // Build 30-day data
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                last30Days.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));

                const dayCheckIns = [];
                checkInsSnap.forEach(doc => {
                    const checkInDate = doc.data().createdAt?.toDate 
                        ? doc.data().createdAt.toDate() 
                        : new Date(doc.data().createdAt);
                    if (checkInDate.toDateString() === date.toDateString()) {
                        dayCheckIns.push(doc.data());
                    }
                });

                // Calculate averages for the day
                const dayMoods = [];
                const dayCravings = [];
                const dayAnxiety = [];
                const daySleep = [];

                dayCheckIns.forEach(checkIn => {
                    if (checkIn.morningData) {
                        if (checkIn.morningData.mood) dayMoods.push(checkIn.morningData.mood);
                        if (checkIn.morningData.craving) dayCravings.push(checkIn.morningData.craving);
                        if (checkIn.morningData.anxietyLevel) dayAnxiety.push(checkIn.morningData.anxietyLevel);
                        if (checkIn.morningData.sleepQuality) daySleep.push(checkIn.morningData.sleepQuality);
                    }
                    if (checkIn.eveningData) {
                        if (checkIn.eveningData.mood) dayMoods.push(checkIn.eveningData.mood);
                        if (checkIn.eveningData.craving) dayCravings.push(checkIn.eveningData.craving);
                    }
                });

                moodData.push(dayMoods.length > 0 ? dayMoods.reduce((a, b) => a + b) / dayMoods.length : null);
                cravingData.push(dayCravings.length > 0 ? dayCravings.reduce((a, b) => a + b) / dayCravings.length : null);
                anxietyData.push(dayAnxiety.length > 0 ? dayAnxiety.reduce((a, b) => a + b) / dayAnxiety.length : null);
                sleepData.push(daySleep.length > 0 ? daySleep.reduce((a, b) => a + b) / daySleep.length : null);
            }

            setChartData({
                mood: { labels: last30Days, data: moodData, average: avgMood },
                craving: { labels: last30Days, data: cravingData, average: avgCraving },
                anxiety: { labels: last30Days, data: anxietyData, average: avgAnxiety },
                sleep: { labels: last30Days, data: sleepData, average: avgSleep }
            });

            // Load sobriety data
            const sobrietyLabels = [];
            const sobrietyDays = [];
            let totalSobrietyDays = 0;

            for (const pirId of pirIds.slice(0, 20)) { // Limit to 20 PIRs for readability
                const pirDoc = await db.collection('users').doc(pirId).get();
                if (pirDoc.exists) {
                    const pirData = pirDoc.data();
                    if (pirData.sobrietyDate) {
                        const sobrietyDate = pirData.sobrietyDate.toDate 
                            ? pirData.sobrietyDate.toDate() 
                            : new Date(pirData.sobrietyDate);
                        const today = new Date();
                        const days = Math.floor((today - sobrietyDate) / (1000 * 60 * 60 * 24));
                        
                        sobrietyLabels.push(pirData.displayName || pirData.email?.split('@')[0] || 'PIR');
                        sobrietyDays.push(days);
                        totalSobrietyDays += days;
                    }
                }
            }

            const avgSobriety = sobrietyDays.length > 0 
                ? Math.round(totalSobrietyDays / sobrietyDays.length)
                : 0;

            setSobrietyData({
                labels: sobrietyLabels,
                data: sobrietyDays,
                average: avgSobriety
            });

            // Calculate compliance
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const recentCheckIns = await db.collection('checkIns')
                .where('createdAt', '>=', sevenDaysAgo)
                .get();

            const avgCompliance = totalPirs > 0 
                ? Math.round((recentCheckIns.size / (totalPirs * 14)) * 100)
                : 0;

            setStats({
                totalPirs,
                totalCoaches,
                alertsToday: alertsSnap.size,
                avgCompliance: Math.min(avgCompliance, 100)
            });

            // Load recent activity
            const activityData = [];
            
            // Recent check-ins
            const recentCheckInsSnap = await db.collection('checkIns')
                .orderBy('createdAt', 'desc')
                .limit(5)
                .get();
            
            recentCheckInsSnap.forEach(doc => {
                const data = doc.data();
                activityData.push({
                    type: 'check-in',
                    message: `${data.userName || 'PIR'} completed check-in`,
                    time: data.createdAt
                });
            });

            // Recent alerts
            const recentAlertsSnap = await db.collection('alerts')
                .orderBy('createdAt', 'desc')
                .limit(3)
                .get();
            
            recentAlertsSnap.forEach(doc => {
                const data = doc.data();
                activityData.push({
                    type: 'alert',
                    message: `Alert: ${data.message || 'New alert triggered'}`,
                    time: data.createdAt
                });
            });

            // Sort by time and limit
            activityData.sort((a, b) => {
                const timeA = a.time?.toDate ? a.time.toDate() : new Date(a.time);
                const timeB = b.time?.toDate ? b.time.toDate() : new Date(b.time);
                return timeB - timeA;
            });

            setRecentActivity(activityData.slice(0, 10));

        } catch (error) {
            console.error('Error loading dashboard data:', error);
        } finally {
            setLoading(false);
        }
    };

    const renderAllCharts = () => {
        // Destroy existing charts
        Object.values(chartInstances.current).forEach(chart => {
            if (chart) chart.destroy();
        });

        const chartConfig = {
            type: 'line',
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 10,
                        ticks: { stepSize: 1 }
                    }
                },
                plugins: {
                    legend: { display: true }
                }
            }
        };

        // Mood Chart
        if (moodChartRef.current) {
            chartInstances.current.mood = new Chart(moodChartRef.current, {
                ...chartConfig,
                data: {
                    labels: chartData.mood.labels,
                    datasets: [{
                        label: 'Mood',
                        data: chartData.mood.data,
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4,
                        spanGaps: true
                    }]
                }
            });
        }

        // Craving Chart
        if (cravingChartRef.current) {
            chartInstances.current.craving = new Chart(cravingChartRef.current, {
                ...chartConfig,
                data: {
                    labels: chartData.craving.labels,
                    datasets: [{
                        label: 'Craving',
                        data: chartData.craving.data,
                        borderColor: '#FF9800',
                        backgroundColor: 'rgba(255, 152, 0, 0.1)',
                        tension: 0.4,
                        spanGaps: true
                    }]
                }
            });
        }

        // Anxiety Chart
        if (anxietyChartRef.current) {
            chartInstances.current.anxiety = new Chart(anxietyChartRef.current, {
                ...chartConfig,
                data: {
                    labels: chartData.anxiety.labels,
                    datasets: [{
                        label: 'Anxiety',
                        data: chartData.anxiety.data,
                        borderColor: '#f44336',
                        backgroundColor: 'rgba(244, 67, 54, 0.1)',
                        tension: 0.4,
                        spanGaps: true
                    }]
                }
            });
        }

        // Sleep Chart
        if (sleepChartRef.current) {
            chartInstances.current.sleep = new Chart(sleepChartRef.current, {
                ...chartConfig,
                data: {
                    labels: chartData.sleep.labels,
                    datasets: [{
                        label: 'Sleep Quality',
                        data: chartData.sleep.data,
                        borderColor: '#9C27B0',
                        backgroundColor: 'rgba(156, 39, 176, 0.1)',
                        tension: 0.4,
                        spanGaps: true
                    }]
                }
            });
        }

        // Sobriety Bar Chart
        if (sobrietyChartRef.current) {
            chartInstances.current.sobriety = new Chart(sobrietyChartRef.current, {
                type: 'bar',
                data: {
                    labels: sobrietyData.labels,
                    datasets: [{
                        label: 'Sobriety Days',
                        data: sobrietyData.data,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: '#667eea',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 30 }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    },
                    plugins: {
                        legend: { display: true }
                    }
                }
            });
        }
    };

    if (loading) {
        return (
            <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                minHeight: '400px',
                gap: '20px'
            }}>
                <div style={{
                    width: '60px',
                    height: '60px',
                    border: '4px solid #f3f3f3',
                    borderTop: '4px solid #667eea',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite'
                }}></div>
                <p style={{ color: '#666' }}>Loading dashboard...</p>
            </div>
        );
    }

    return (
        <div style={{ padding: '30px', animation: 'fadeIn 0.5s' }}>
            {/* Stats Cards */}
            <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))',
                gap: '20px',
                marginBottom: '40px'
            }}>
                <div style={{
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(102, 126, 234, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Total PIRs</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.totalPirs}
                    </div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(240, 147, 251, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Total Coaches</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.totalCoaches}
                    </div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(79, 172, 254, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Alerts Today</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.alertsToday}
                    </div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(250, 112, 154, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Avg Compliance</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.avgCompliance}%
                    </div>
                </div>
            </div>

            {/* Trend Charts */}
            <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(400px, 1fr))',
                gap: '25px',
                marginBottom: '40px'
            }}>
                {/* Mood Chart */}
                <div style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '25px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                }}>
                    <h3 style={{ marginBottom: '15px', color: '#333' }}>30-Day Mood Trend</h3>
                    <div style={{ height: '250px' }}>
                        <canvas ref={moodChartRef}></canvas>
                    </div>
                    <div style={{
                        marginTop: '15px',
                        padding: '15px',
                        background: '#f8f9fa',
                        borderRadius: '10px',
                        textAlign: 'center'
                    }}>
                        <div style={{ fontSize: '12px', color: '#666', marginBottom: '5px' }}>
                            All-Time Average
                        </div>
                        <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#4CAF50' }}>
                            {chartData.mood.average}/10
                        </div>
                    </div>
                </div>

                {/* Craving Chart */}
                <div style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '25px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                }}>
                    <h3 style={{ marginBottom: '15px', color: '#333' }}>30-Day Craving Trend</h3>
                    <div style={{ height: '250px' }}>
                        <canvas ref={cravingChartRef}></canvas>
                    </div>
                    <div style={{
                        marginTop: '15px',
                        padding: '15px',
                        background: '#f8f9fa',
                        borderRadius: '10px',
                        textAlign: 'center'
                    }}>
                        <div style={{ fontSize: '12px', color: '#666', marginBottom: '5px' }}>
                            All-Time Average
                        </div>
                        <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#FF9800' }}>
                            {chartData.craving.average}/10
                        </div>
                    </div>
                </div>

                {/* Anxiety Chart */}
                <div style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '25px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                }}>
                    <h3 style={{ marginBottom: '15px', color: '#333' }}>30-Day Anxiety Trend</h3>
                    <div style={{ height: '250px' }}>
                        <canvas ref={anxietyChartRef}></canvas>
                    </div>
                    <div style={{
                        marginTop: '15px',
                        padding: '15px',
                        background: '#f8f9fa',
                        borderRadius: '10px',
                        textAlign: 'center'
                    }}>
                        <div style={{ fontSize: '12px', color: '#666', marginBottom: '5px' }}>
                            All-Time Average
                        </div>
                        <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#f44336' }}>
                            {chartData.anxiety.average}/10
                        </div>
                    </div>
                </div>

                {/* Sleep Chart */}
                <div style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '25px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                }}>
                    <h3 style={{ marginBottom: '15px', color: '#333' }}>30-Day Sleep Quality Trend</h3>
                    <div style={{ height: '250px' }}>
                        <canvas ref={sleepChartRef}></canvas>
                    </div>
                    <div style={{
                        marginTop: '15px',
                        padding: '15px',
                        background: '#f8f9fa',
                        borderRadius: '10px',
                        textAlign: 'center'
                    }}>
                        <div style={{ fontSize: '12px', color: '#666', marginBottom: '5px' }}>
                            All-Time Average
                        </div>
                        <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#9C27B0' }}>
                            {chartData.sleep.average}/10
                        </div>
                    </div>
                </div>
            </div>

            {/* Sobriety Bar Chart */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '25px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
                marginBottom: '40px'
            }}>
                <h3 style={{ marginBottom: '15px', color: '#333' }}>PIR Sobriety Days</h3>
                <div style={{ height: '350px' }}>
                    <canvas ref={sobrietyChartRef}></canvas>
                </div>
                <div style={{
                    marginTop: '20px',
                    padding: '20px',
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    borderRadius: '10px',
                    textAlign: 'center',
                    color: 'white'
                }}>
                    <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '5px' }}>
                        Average Sobriety Days (All PIRs)
                    </div>
                    <div style={{ fontSize: '36px', fontWeight: 'bold' }}>
                        {sobrietyData.average} days
                    </div>
                </div>
            </div>

            {/* Recent Activity */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '25px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
            }}>
                <h3 style={{ marginBottom: '20px', color: '#333' }}>Recent Activity</h3>
                {recentActivity.length === 0 ? (
                    <div style={{
                        padding: '40px',
                        textAlign: 'center',
                        color: '#999'
                    }}>
                        No recent activity
                    </div>
                ) : (
                    <div>
                        {recentActivity.map((activity, index) => (
                            <div key={index} style={{
                                padding: '15px',
                                borderBottom: index < recentActivity.length - 1 ? '1px solid #f0f0f0' : 'none',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center'
                            }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                                    <div style={{
                                        width: '40px',
                                        height: '40px',
                                        borderRadius: '50%',
                                        background: activity.type === 'check-in' 
                                            ? 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)' 
                                            : 'linear-gradient(135deg, #f44336 0%, #e53935 100%)',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        color: 'white',
                                        fontSize: '18px'
                                    }}>
                                        {activity.type === 'check-in' ? '‚úì' : '‚ö†'}
                                    </div>
                                    <div>
                                        <div style={{ fontWeight: '500', color: '#333' }}>
                                            {activity.message}
                                        </div>
                                        <div style={{ fontSize: '12px', color: '#999', marginTop: '4px' }}>
                                            {formatTimeAgo(activity.time)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        </div>
    );
}

     // Enhanced Users View with Full Features
function UsersView({ searchQuery, user, onImpersonate }) {
    const [users, setUsers] = useState([]);
    const [filteredUsers, setFilteredUsers] = useState([]);
    const [loading, setLoading] = useState(true);
    const [currentPage, setCurrentPage] = useState(1);
    const [showCreateModal, setShowCreateModal] = useState(false);
    const [selectedUser, setSelectedUser] = useState(null);
    const [activeTab, setActiveTab] = useState('pir');
    
    // New state for enhancements
    const [stats, setStats] = useState({
        totalPIRs: 0,
        activePIRs: 0,
        avgCompliance: 0,
        criticalAlerts: 0,
        newThisWeek: 0
    });
    const [selectedUsers, setSelectedUsers] = useState(new Set());
    const [showBulkActions, setShowBulkActions] = useState(false);
    const [statusFilter, setStatusFilter] = useState('all'); // 'all', 'active', 'inactive', 'critical'
    const [complianceFilter, setComplianceFilter] = useState('all'); // 'all', 'high', 'medium', 'low'
    const [pirHealthData, setPirHealthData] = useState({}); // Store compliance and last check-in per PIR
    
    const itemsPerPage = 20;

    // Separate users by role
    const pirUsers = useMemo(() => users.filter(u => u.role === 'pir'), [users]);
    const coachUsers = useMemo(() => users.filter(u => u.role === 'coach'), [users]);
    const adminUsers = useMemo(() => users.filter(u => u.role === 'admin'), [users]);

    useEffect(() => {
        loadUsers();
    }, []);

    useEffect(() => {
        if (activeTab === 'pir') {
            loadPIRHealthData();
            calculateStats();
        }
    }, [users, activeTab]);

    useEffect(() => {
        filterUsers();
        setCurrentPage(1);
    }, [users, searchQuery, activeTab, statusFilter, complianceFilter]);

    const loadUsers = async () => {
        try {
            setLoading(true);
            
            const usersSnap = await db.collection('users')
                .orderBy('createdAt', 'desc')
                .get();
            
            const usersData = [];
            const coachIds = new Set();
            
            usersSnap.forEach(doc => {
                const userData = { id: doc.id, ...doc.data() };
                usersData.push(userData);
                if (userData.assignedCoach) {
                    coachIds.add(userData.assignedCoach);
                }
            });
            
            // Batch load coaches
            const coachesMap = {};
            if (coachIds.size > 0) {
                const coachResults = await batchQuery('users', 
                    firebase.firestore.FieldPath.documentId(), 
                    Array.from(coachIds)
                );
                
                coachResults.forEach(coach => {
                    coachesMap[coach.id] = coach.displayName || coach.email;
                });
            }
            
            usersData.forEach(user => {
                if (user.assignedCoach && coachesMap[user.assignedCoach]) {
                    user.coachName = coachesMap[user.assignedCoach];
                }
            });
            
            setUsers(usersData);
            
        } catch (error) {
            console.error('Error loading users:', error);
            alert('Failed to load users. Please refresh the page.');
        } finally {
            setLoading(false);
        }
    };

    const loadPIRHealthData = async () => {
        try {
            const healthData = {};
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            // Load check-ins for all PIRs from last 7 days
            const checkInsSnap = await db.collection('checkIns')
                .where('createdAt', '>=', sevenDaysAgo)
                .get();
            
            const pirCheckIns = {};
            checkInsSnap.forEach(doc => {
                const data = doc.data();
                if (!pirCheckIns[data.userId]) {
                    pirCheckIns[data.userId] = [];
                }
                pirCheckIns[data.userId].push(data);
            });
            
            // Calculate compliance and last check-in for each PIR
            pirUsers.forEach(pir => {
                const checkIns = pirCheckIns[pir.id] || [];
                const compliance = Math.round((checkIns.length / 14) * 100); // 2 check-ins per day * 7 days
                
                const lastCheckIn = checkIns.length > 0 
                    ? checkIns.reduce((latest, current) => {
                        const currentDate = current.createdAt?.toDate ? current.createdAt.toDate() : new Date(current.createdAt);
                        const latestDate = latest.createdAt?.toDate ? latest.createdAt.toDate() : new Date(latest.createdAt);
                        return currentDate > latestDate ? current : latest;
                    }).createdAt
                    : null;
                
                healthData[pir.id] = {
                    compliance: Math.min(compliance, 100),
                    lastCheckIn,
                    checkInCount: checkIns.length,
                    status: compliance >= 70 ? 'good' : compliance >= 40 ? 'moderate' : 'critical'
                };
            });
            
            setPirHealthData(healthData);
            
        } catch (error) {
            console.error('Error loading PIR health data:', error);
        }
    };

    const calculateStats = async () => {
        try {
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            // Count active PIRs
            const activePIRs = pirUsers.filter(p => p.active !== false).length;
            
            // Calculate average compliance
            const complianceValues = Object.values(pirHealthData).map(h => h.compliance || 0);
            const avgCompliance = complianceValues.length > 0 
                ? Math.round(complianceValues.reduce((a, b) => a + b, 0) / complianceValues.length)
                : 0;
            
            // Count critical alerts
            const alertsSnap = await db.collection('alerts')
                .where('resolved', '==', false)
                .where('priority', '==', 'critical')
                .get();
            
            // Count new PIRs this week
            const newThisWeek = pirUsers.filter(p => {
                const createdAt = p.createdAt?.toDate ? p.createdAt.toDate() : new Date(p.createdAt);
                return createdAt >= oneWeekAgo;
            }).length;
            
            setStats({
                totalPIRs: pirUsers.length,
                activePIRs,
                avgCompliance,
                criticalAlerts: alertsSnap.size,
                newThisWeek
            });
            
        } catch (error) {
            console.error('Error calculating stats:', error);
        }
    };

    const filterUsers = () => {
        let tabFiltered = [];
        if (activeTab === 'pir') {
            tabFiltered = pirUsers;
        } else if (activeTab === 'coach') {
            tabFiltered = coachUsers;
        } else if (activeTab === 'admin') {
            tabFiltered = adminUsers;
        }

        // Apply status filter
        if (statusFilter !== 'all') {
            if (statusFilter === 'active') {
                tabFiltered = tabFiltered.filter(u => u.active !== false);
            } else if (statusFilter === 'inactive') {
                tabFiltered = tabFiltered.filter(u => u.active === false);
            } else if (statusFilter === 'critical') {
                tabFiltered = tabFiltered.filter(u => pirHealthData[u.id]?.status === 'critical');
            }
        }

        // Apply compliance filter (PIRs only)
        if (activeTab === 'pir' && complianceFilter !== 'all') {
            if (complianceFilter === 'high') {
                tabFiltered = tabFiltered.filter(u => (pirHealthData[u.id]?.compliance || 0) >= 70);
            } else if (complianceFilter === 'medium') {
                tabFiltered = tabFiltered.filter(u => {
                    const comp = pirHealthData[u.id]?.compliance || 0;
                    return comp >= 40 && comp < 70;
                });
            } else if (complianceFilter === 'low') {
                tabFiltered = tabFiltered.filter(u => (pirHealthData[u.id]?.compliance || 0) < 40);
            }
        }

        // Apply search filter
        if (searchQuery) {
            const query = searchQuery.toLowerCase();
            tabFiltered = tabFiltered.filter(user => 
                user.email?.toLowerCase().includes(query) ||
                user.displayName?.toLowerCase().includes(query) ||
                user.firstName?.toLowerCase().includes(query) ||
                user.lastName?.toLowerCase().includes(query) ||
                user.phone?.toLowerCase().includes(query) ||
                user.coachName?.toLowerCase().includes(query)
            );
        }
        
        setFilteredUsers(tabFiltered);
    };

    const paginatedUsers = useMemo(() => {
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        return filteredUsers.slice(start, end);
    }, [filteredUsers, currentPage]);

    const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);

    const handleSelectAll = () => {
        if (selectedUsers.size === paginatedUsers.length) {
            setSelectedUsers(new Set());
        } else {
            setSelectedUsers(new Set(paginatedUsers.map(u => u.id)));
        }
    };

    const handleSelectUser = (userId) => {
        const newSelected = new Set(selectedUsers);
        if (newSelected.has(userId)) {
            newSelected.delete(userId);
        } else {
            newSelected.add(userId);
        }
        setSelectedUsers(newSelected);
    };

    const handleBulkAssignCoach = async () => {
        const coachId = prompt('Enter coach ID to assign:');
        if (!coachId) return;
        
        try {
            const batch = db.batch();
            selectedUsers.forEach(userId => {
                const userRef = db.collection('users').doc(userId);
                batch.update(userRef, { assignedCoach: coachId });
            });
            
            await batch.commit();
            alert(`Assigned coach to ${selectedUsers.size} users`);
            setSelectedUsers(new Set());
            loadUsers();
        } catch (error) {
            console.error('Error in bulk assign:', error);
            alert('Failed to assign coach');
        }
    };

    const handleBulkToggleStatus = async () => {
        try {
            const batch = db.batch();
            selectedUsers.forEach(userId => {
                const user = users.find(u => u.id === userId);
                const userRef = db.collection('users').doc(userId);
                batch.update(userRef, { active: user.active === false });
            });
            
            await batch.commit();
            alert(`Updated status for ${selectedUsers.size} users`);
            setSelectedUsers(new Set());
            loadUsers();
        } catch (error) {
            console.error('Error in bulk status toggle:', error);
            alert('Failed to update status');
        }
    };

    const handleExport = (format) => {
        const exportData = filteredUsers.map(user => ({
            name: user.displayName || 'N/A',
            email: user.email,
            role: user.role,
            status: user.active !== false ? 'Active' : 'Inactive',
            coach: user.coachName || 'N/A',
            compliance: activeTab === 'pir' ? `${pirHealthData[user.id]?.compliance || 0}%` : 'N/A',
            phone: user.phone || 'N/A',
            joined: formatDate(user.createdAt)
        }));

        if (format === 'json') {
            exportToJSON(exportData, `${activeTab}_users`);
        } else if (format === 'csv') {
            exportToCSV(exportData, `${activeTab}_users`);
        } else if (format === 'pdf') {
            exportToPDF(exportData, `${activeTab.toUpperCase()} Users Report`);
        }
    };

    const getHealthBadgeColor = (status) => {
        if (status === 'good') return '#4CAF50';
        if (status === 'moderate') return '#FF9800';
        return '#f44336';
    };

    if (loading) {
        return (
            <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                minHeight: '400px',
                gap: '20px'
            }}>
                <div style={{
                    width: '60px',
                    height: '60px',
                    border: '4px solid #f3f3f3',
                    borderTop: '4px solid #667eea',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite'
                }}></div>
                <p style={{ color: '#666', fontSize: '16px' }}>Loading users...</p>
            </div>
        );
    }

    return (
        <div style={{ animation: 'fadeIn 0.3s ease-in' }}>
            {/* Stats Cards - PIRs Only */}
            {activeTab === 'pir' && (
                <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                    gap: '20px',
                    marginBottom: '30px'
                }}>
                    <div style={{
                        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        borderRadius: '15px',
                        padding: '25px',
                        color: 'white',
                        boxShadow: '0 4px 15px rgba(102, 126, 234, 0.3)',
                        transition: 'transform 0.2s',
                        cursor: 'pointer'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                    onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                    >
                        <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '10px' }}>Total PIRs</div>
                        <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{stats.totalPIRs}</div>
                        <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '10px' }}>
                            {stats.activePIRs} active
                        </div>
                    </div>

                    <div style={{
                        background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                        borderRadius: '15px',
                        padding: '25px',
                        color: 'white',
                        boxShadow: '0 4px 15px rgba(240, 147, 251, 0.3)',
                        transition: 'transform 0.2s',
                        cursor: 'pointer'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                    onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                    >
                        <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '10px' }}>Avg Compliance</div>
                        <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{stats.avgCompliance}%</div>
                        <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '10px' }}>
                            Last 7 days
                        </div>
                    </div>

                    <div style={{
                        background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                        borderRadius: '15px',
                        padding: '25px',
                        color: 'white',
                        boxShadow: '0 4px 15px rgba(79, 172, 254, 0.3)',
                        transition: 'transform 0.2s',
                        cursor: 'pointer'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                    onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                    >
                        <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '10px' }}>Critical Alerts</div>
                        <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{stats.criticalAlerts}</div>
                        <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '10px' }}>
                            Require attention
                        </div>
                    </div>

                    <div style={{
                        background: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                        borderRadius: '15px',
                        padding: '25px',
                        color: 'white',
                        boxShadow: '0 4px 15px rgba(250, 112, 154, 0.3)',
                        transition: 'transform 0.2s',
                        cursor: 'pointer'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                    onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                    >
                        <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '10px' }}>New This Week</div>
                        <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{stats.newThisWeek}</div>
                        <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '10px' }}>
                            Recent additions
                        </div>
                    </div>
                </div>
            )}

            {/* Tab Navigation with enhanced design */}
            <div style={{
                display: 'flex',
                gap: '10px',
                marginBottom: '25px',
                borderBottom: '2px solid #e9ecef',
                paddingBottom: '5px'
            }}>
                <button 
                    onClick={() => setActiveTab('pir')}
                    style={{
                        padding: '12px 24px',
                        border: 'none',
                        background: activeTab === 'pir' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'transparent',
                        color: activeTab === 'pir' ? 'white' : '#666',
                        borderRadius: '10px 10px 0 0',
                        cursor: 'pointer',
                        fontSize: '15px',
                        fontWeight: activeTab === 'pir' ? '600' : '500',
                        transition: 'all 0.3s',
                        boxShadow: activeTab === 'pir' ? '0 -2px 10px rgba(102, 126, 234, 0.3)' : 'none',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                    }}
                    onMouseEnter={(e) => {
                        if (activeTab !== 'pir') {
                            e.currentTarget.style.background = '#f8f9fa';
                            e.currentTarget.style.color = '#333';
                        }
                    }}
                    onMouseLeave={(e) => {
                        if (activeTab !== 'pir') {
                            e.currentTarget.style.background = 'transparent';
                            e.currentTarget.style.color = '#666';
                        }
                    }}
                >
                    <span style={{ fontSize: '18px' }}>üë•</span>
                    PIRs ({pirUsers.length})
                </button>
                <button 
                    onClick={() => setActiveTab('coach')}
                    style={{
                        padding: '12px 24px',
                        border: 'none',
                        background: activeTab === 'coach' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'transparent',
                        color: activeTab === 'coach' ? 'white' : '#666',
                        borderRadius: '10px 10px 0 0',
                        cursor: 'pointer',
                        fontSize: '15px',
                        fontWeight: activeTab === 'coach' ? '600' : '500',
                        transition: 'all 0.3s',
                        boxShadow: activeTab === 'coach' ? '0 -2px 10px rgba(102, 126, 234, 0.3)' : 'none',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                    }}
                    onMouseEnter={(e) => {
                        if (activeTab !== 'coach') {
                            e.currentTarget.style.background = '#f8f9fa';
                            e.currentTarget.style.color = '#333';
                        }
                    }}
                    onMouseLeave={(e) => {
                        if (activeTab !== 'coach') {
                            e.currentTarget.style.background = 'transparent';
                            e.currentTarget.style.color = '#666';
                        }
                    }}
                >
                    <span style={{ fontSize: '18px' }}>üéì</span>
                    Coaches ({coachUsers.length})
                </button>
                <button 
                    onClick={() => setActiveTab('admin')}
                    style={{
                        padding: '12px 24px',
                        border: 'none',
                        background: activeTab === 'admin' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'transparent',
                        color: activeTab === 'admin' ? 'white' : '#666',
                        borderRadius: '10px 10px 0 0',
                        cursor: 'pointer',
                        fontSize: '15px',
                        fontWeight: activeTab === 'admin' ? '600' : '500',
                        transition: 'all 0.3s',
                        boxShadow: activeTab === 'admin' ? '0 -2px 10px rgba(102, 126, 234, 0.3)' : 'none',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                    }}
                    onMouseEnter={(e) => {
                        if (activeTab !== 'admin') {
                            e.currentTarget.style.background = '#f8f9fa';
                            e.currentTarget.style.color = '#333';
                        }
                    }}
                    onMouseLeave={(e) => {
                        if (activeTab !== 'admin') {
                            e.currentTarget.style.background = 'transparent';
                            e.currentTarget.style.color = '#666';
                        }
                    }}
                >
                    <span style={{ fontSize: '18px' }}>‚öôÔ∏è</span>
                    Admins ({adminUsers.length})
                </button>
            </div>

            {/* Filters and Actions Bar */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                marginBottom: '20px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                flexWrap: 'wrap',
                gap: '15px'
            }}>
                <div style={{ display: 'flex', gap: '10px', alignItems: 'center', flexWrap: 'wrap' }}>
                    {/* Status Filter */}
                    <select 
                        value={statusFilter}
                        onChange={(e) => setStatusFilter(e.target.value)}
                        style={{
                            padding: '8px 12px',
                            borderRadius: '8px',
                            border: '1px solid #ddd',
                            background: 'white',
                            cursor: 'pointer',
                            fontSize: '14px'
                        }}
                    >
                        <option value="all">All Status</option>
                        <option value="active">Active Only</option>
                        <option value="inactive">Inactive Only</option>
                        {activeTab === 'pir' && <option value="critical">Critical Status</option>}
                    </select>

                    {/* Compliance Filter - PIRs only */}
                    {activeTab === 'pir' && (
                        <select 
                            value={complianceFilter}
                            onChange={(e) => setComplianceFilter(e.target.value)}
                            style={{
                                padding: '8px 12px',
                                borderRadius: '8px',
                                border: '1px solid #ddd',
                                background: 'white',
                                cursor: 'pointer',
                                fontSize: '14px'
                            }}
                        >
                            <option value="all">All Compliance</option>
                            <option value="high">High (70%+)</option>
                            <option value="medium">Medium (40-70%)</option>
                            <option value="low">Low (&lt;40%)</option>
                        </select>
                    )}

                    <div style={{ 
                        fontSize: '14px', 
                        color: '#666',
                        padding: '8px 12px',
                        background: '#f8f9fa',
                        borderRadius: '8px'
                    }}>
                        Showing {paginatedUsers.length} of {filteredUsers.length} {activeTab}s
                        {searchQuery && ' (filtered)'}
                    </div>
                </div>

                <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                    {/* Bulk Actions - PIRs only */}
                    {activeTab === 'pir' && selectedUsers.size > 0 && (
                        <>
                            <button 
                                onClick={handleBulkAssignCoach}
                                style={{
                                    padding: '10px 16px',
                                    background: 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500',
                                    transition: 'transform 0.2s',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px'
                                }}
                                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                            >
                                Assign Coach ({selectedUsers.size})
                            </button>
                            <button 
                                onClick={handleBulkToggleStatus}
                                style={{
                                    padding: '10px 16px',
                                    background: 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500',
                                    transition: 'transform 0.2s',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px'
                                }}
                                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                            >
                                Toggle Status ({selectedUsers.size})
                            </button>
                        </>
                    )}

                    {/* Export Buttons */}
                    <button 
                        onClick={() => handleExport('csv')}
                        style={{
                            padding: '10px 16px',
                            background: '#6c757d',
                            color: 'white',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500',
                            transition: 'all 0.2s'
                        }}
                        onMouseEnter={(e) => {
                            e.currentTarget.style.background = '#5a6268';
                            e.currentTarget.style.transform = 'translateY(-2px)';
                        }}
                        onMouseLeave={(e) => {
                            e.currentTarget.style.background = '#6c757d';
                            e.currentTarget.style.transform = 'translateY(0)';
                        }}
                    >
                        Export CSV
                    </button>
                    
                    <button 
                        onClick={() => setShowCreateModal(true)}
                        style={{
                            padding: '10px 20px',
                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            color: 'white',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '600',
                            transition: 'all 0.2s',
                            boxShadow: '0 4px 12px rgba(102, 126, 234, 0.4)',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px'
                        }}
                        onMouseEnter={(e) => {
                            e.currentTarget.style.transform = 'translateY(-2px)';
                            e.currentTarget.style.boxShadow = '0 6px 16px rgba(102, 126, 234, 0.5)';
                        }}
                        onMouseLeave={(e) => {
                            e.currentTarget.style.transform = 'translateY(0)';
                            e.currentTarget.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.4)';
                        }}
                    >
                        <span style={{ fontSize: '16px' }}>+</span> Create User
                    </button>
                </div>
            </div>
            
            {/* Enhanced Table */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                overflow: 'hidden',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                    <thead>
                        <tr style={{ background: '#f8f9fa', borderBottom: '2px solid #e9ecef' }}>
                            {activeTab === 'pir' && (
                                <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>
                                    <input 
                                        type="checkbox"
                                        checked={selectedUsers.size === paginatedUsers.length && paginatedUsers.length > 0}
                                        onChange={handleSelectAll}
                                        style={{ cursor: 'pointer', width: '16px', height: '16px' }}
                                    />
                                </th>
                            )}
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Name</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Email</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Status</th>
                            {activeTab === 'pir' && <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Health</th>}
                            {activeTab === 'pir' && <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Assigned Coach</th>}
                            {activeTab === 'pir' && <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Last Check-in</th>}
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Phone</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Joined</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {paginatedUsers.map((user, index) => (
                            <tr key={user.id} style={{
                                borderBottom: '1px solid #f0f0f0',
                                transition: 'all 0.2s',
                                background: selectedUsers.has(user.id) ? '#f0f4ff' : 'white'
                            }}
                            onMouseEnter={(e) => {
                                if (!selectedUsers.has(user.id)) {
                                    e.currentTarget.style.background = '#f8f9fa';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (!selectedUsers.has(user.id)) {
                                    e.currentTarget.style.background = 'white';
                                }
                            }}
                            >
                                {activeTab === 'pir' && (
                                    <td style={{ padding: '15px' }}>
                                        <input 
                                            type="checkbox"
                                            checked={selectedUsers.has(user.id)}
                                            onChange={() => handleSelectUser(user.id)}
                                            style={{ cursor: 'pointer', width: '16px', height: '16px' }}
                                        />
                                    </td>
                                )}
                                <td style={{ padding: '15px' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                        <div style={{
                                            width: '40px',
                                            height: '40px',
                                            borderRadius: '50%',
                                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            color: 'white',
                                            fontWeight: '600',
                                            fontSize: '16px'
                                        }}>
                                            {(user.displayName || user.email || 'U').charAt(0).toUpperCase()}
                                        </div>
                                        <span style={{ fontWeight: '500', color: '#333' }}>
                                            {user.displayName || 'N/A'}
                                        </span>
                                    </div>
                                </td>
                                <td style={{ padding: '15px', color: '#666' }}>{user.email}</td>
                                <td style={{ padding: '15px' }}>
                                    <span style={{
                                        padding: '4px 12px',
                                        borderRadius: '20px',
                                        fontSize: '12px',
                                        fontWeight: '500',
                                        background: user.active !== false ? '#d4edda' : '#f8d7da',
                                        color: user.active !== false ? '#155724' : '#721c24'
                                    }}>
                                        {user.active !== false ? 'Active' : 'Inactive'}
                                    </span>
                                </td>
                                {activeTab === 'pir' && (
                                    <td style={{ padding: '15px' }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            <div style={{
                                                width: '8px',
                                                height: '8px',
                                                borderRadius: '50%',
                                                background: getHealthBadgeColor(pirHealthData[user.id]?.status)
                                            }}></div>
                                            <span style={{ 
                                                fontSize: '13px',
                                                fontWeight: '500',
                                                color: '#666'
                                            }}>
                                                {pirHealthData[user.id]?.compliance || 0}%
                                            </span>
                                        </div>
                                    </td>
                                )}
                                {activeTab === 'pir' && <td style={{ padding: '15px', color: '#666' }}>{user.coachName || '-'}</td>}
                                {activeTab === 'pir' && (
                                    <td style={{ padding: '15px', color: '#666' }}>
                                        {pirHealthData[user.id]?.lastCheckIn ? formatTimeAgo(pirHealthData[user.id].lastCheckIn) : 'Never'}
                                    </td>
                                )}
                                <td style={{ padding: '15px', color: '#666' }}>{user.phone || '-'}</td>
                                <td style={{ padding: '15px', color: '#666' }}>{formatDate(user.createdAt)}</td>
                                <td style={{ padding: '15px' }}>
                                    <div style={{ display: 'flex', gap: '8px' }}>
                                        <button 
                                            onClick={() => setSelectedUser(user)}
                                            style={{
                                                padding: '6px 12px',
                                                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '6px',
                                                cursor: 'pointer',
                                                fontSize: '13px',
                                                fontWeight: '500',
                                                transition: 'transform 0.2s'
                                            }}
                                            onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.05)'}
                                            onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
                                        >
                                            View
                                        </button>
                                        {user.role === 'pir' && (
                                            <button 
                                                onClick={() => onImpersonate(user)}
                                                style={{
                                                    padding: '6px 12px',
                                                    background: '#6c757d',
                                                    color: 'white',
                                                    border: 'none',
                                                    borderRadius: '6px',
                                                    cursor: 'pointer',
                                                    fontSize: '13px',
                                                    fontWeight: '500',
                                                    transition: 'all 0.2s'
                                                }}
                                                onMouseEnter={(e) => {
                                                    e.currentTarget.style.background = '#5a6268';
                                                    e.currentTarget.style.transform = 'scale(1.05)';
                                                }}
                                                onMouseLeave={(e) => {
                                                    e.currentTarget.style.background = '#6c757d';
                                                    e.currentTarget.style.transform = 'scale(1)';
                                                }}
                                            >
                                                View As
                                            </button>
                                        )}
                                    </div>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
                
                {filteredUsers.length === 0 && (
                    <div style={{
                        padding: '60px 20px',
                        textAlign: 'center',
                        color: '#999'
                    }}>
                        <div style={{ fontSize: '48px', marginBottom: '15px' }}>üîç</div>
                        <div style={{ fontSize: '18px', fontWeight: '500', marginBottom: '8px' }}>
                            {searchQuery ? `No ${activeTab}s found matching your search` : `No ${activeTab}s found`}
                        </div>
                        <div style={{ fontSize: '14px' }}>
                            {searchQuery ? 'Try adjusting your search terms' : `Click "Create User" to add a new ${activeTab}`}
                        </div>
                    </div>
                )}
            </div>
            
            {totalPages > 1 && (
                <div style={{ marginTop: '20px' }}>
                    <Pagination 
                        currentPage={currentPage}
                        totalPages={totalPages}
                        onPageChange={setCurrentPage}
                    />
                </div>
            )}
            
            {showCreateModal && (
                <CreateUserModal 
                    onClose={() => setShowCreateModal(false)}
                    onSuccess={() => {
                        setShowCreateModal(false);
                        loadUsers();
                    }}
                />
            )}
            
            {selectedUser && (
                selectedUser.role === 'coach' || selectedUser.role === 'admin' ? (
                    <CoachDetailModal 
                        coach={selectedUser}
                        onClose={() => setSelectedUser(null)}
                        onUpdate={() => {
                            setSelectedUser(null);
                            loadUsers();
                        }}
                        currentUserId={user.uid}
                    />
                ) : (
                    <UserDetailModal 
                        user={selectedUser}
                        onClose={() => setSelectedUser(null)}
                        onUpdate={() => {
                            setSelectedUser(null);
                            loadUsers();
                        }}
                        currentUserId={user.uid}
                    />
                )
            )}
        </div>
    );
}
       // FULLY ENHANCED MyPIRsView with All Features
function MyPIRsView({ searchQuery, user }) {
    const [myPIRs, setMyPIRs] = useState([]);
    const [filteredPIRs, setFilteredPIRs] = useState([]);
    const [loading, setLoading] = useState(true);
    const [selectedPIR, setSelectedPIR] = useState(null);
    const [activeFilter, setActiveFilter] = useState('all');
    const [recentCheckIns, setRecentCheckIns] = useState([]);
    const [pendingAlerts, setPendingAlerts] = useState([]);
    const [showNotesModal, setShowNotesModal] = useState(false);
    const [selectedPIRForNotes, setSelectedPIRForNotes] = useState(null);
    const [pirNotes, setPirNotes] = useState({});
    const [sortBy, setSortBy] = useState('daysClean'); // daysClean, compliance, lastCheckIn
    const [viewMode, setViewMode] = useState('grid'); // grid or list
    
    const moodChartRefs = useRef({});
    const cravingChartRefs = useRef({});
    const chartInstances = useRef({});

    useEffect(() => {
        loadMyPIRs();
        loadPIRNotes();
    }, [user]);

    useEffect(() => {
        filterPIRs();
    }, [searchQuery, myPIRs, activeFilter, sortBy]);

    useEffect(() => {
        // Render mini charts when data is loaded
        if (myPIRs.length > 0 && viewMode === 'grid') {
            myPIRs.forEach(pir => {
                if (pir.moodTrend) renderMiniChart(pir.id, 'mood', pir.moodTrend);
                if (pir.cravingTrend) renderMiniChart(pir.id, 'craving', pir.cravingTrend);
            });
        }
    }, [myPIRs, viewMode]);

    const loadPIRNotes = async () => {
        try {
            const notesSnap = await db.collection('pirNotes')
                .where('coachId', '==', user.uid)
                .get();
            
            const notes = {};
            notesSnap.forEach(doc => {
                notes[doc.data().pirId] = doc.data().notes;
            });
            setPirNotes(notes);
        } catch (error) {
            console.error('Error loading PIR notes:', error);
        }
    };

    const loadMyPIRs = async () => {
        try {
            setLoading(true);
            
            const pirsSnap = await db.collection('users')
                .where('assignedCoach', '==', user.uid)
                .where('role', '==', 'pir')
                .get();

            const pirsData = [];
            const pirIds = [];
            
            for (const doc of pirsSnap.docs) {
                const pirData = { id: doc.id, ...doc.data() };
                pirIds.push(doc.id);
                
                // Get last check-in
                const lastCheckInSnap = await db.collection('checkIns')
                    .where('userId', '==', doc.id)
                    .orderBy('createdAt', 'desc')
                    .limit(1)
                    .get();
                
                if (!lastCheckInSnap.empty) {
                    pirData.lastCheckIn = lastCheckInSnap.docs[0].data();
                    pirData.lastCheckInDate = lastCheckInSnap.docs[0].data().createdAt;
                }
                
                // Get last 7 days of check-ins for trend
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                
                const weekCheckInsSnap = await db.collection('checkIns')
                    .where('userId', '==', doc.id)
                    .where('createdAt', '>=', sevenDaysAgo)
                    .orderBy('createdAt', 'asc')
                    .get();
                
                const moodTrend = [];
                const cravingTrend = [];
                
                weekCheckInsSnap.forEach(checkInDoc => {
                    const data = checkInDoc.data();
                    if (data.morningData?.mood) moodTrend.push(data.morningData.mood);
                    if (data.morningData?.craving) cravingTrend.push(data.morningData.craving);
                });
                
                pirData.moodTrend = moodTrend;
                pirData.cravingTrend = cravingTrend;
                
                // Calculate days clean
                if (pirData.sobrietyDate) {
                    const sobrietyDate = pirData.sobrietyDate.toDate ? 
                        pirData.sobrietyDate.toDate() : new Date(pirData.sobrietyDate);
                    pirData.daysClean = Math.floor((new Date() - sobrietyDate) / (1000 * 60 * 60 * 24));
                } else {
                    pirData.daysClean = 0;
                }
                
                // Check compliance
                pirData.weeklyCheckIns = weekCheckInsSnap.size;
                pirData.complianceRate = Math.min(Math.round((weekCheckInsSnap.size / 14) * 100), 100);
                
                // Check for active alerts
                const alertsSnap = await db.collection('alerts')
                    .where('userId', '==', doc.id)
                    .where('resolved', '==', false)
                    .get();
                
                pirData.activeAlerts = alertsSnap.size;
                
                // Get milestone badge
                pirData.milestone = getMilestone(pirData.daysClean);
                
                pirsData.push(pirData);
            }
            
            // Load recent check-ins
            if (pirIds.length > 0) {
                const checkInsPromises = pirIds.map(id =>
                    db.collection('checkIns')
                        .where('userId', '==', id)
                        .orderBy('createdAt', 'desc')
                        .limit(3)
                        .get()
                );
                
                const checkInsSnapshots = await Promise.all(checkInsPromises);
                const allCheckIns = [];
                
                checkInsSnapshots.forEach((snapshot, index) => {
                    snapshot.forEach(doc => {
                        const checkInData = { id: doc.id, ...doc.data() };
                        const pir = pirsData.find(p => p.id === pirIds[index]);
                        checkInData.pirName = pir?.displayName || pir?.email || 'Unknown';
                        checkInData.pirId = pirIds[index];
                        allCheckIns.push(checkInData);
                    });
                });
                
                allCheckIns.sort((a, b) => {
                    const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
                    const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
                    return dateB - dateA;
                });
                
                setRecentCheckIns(allCheckIns.slice(0, 10));
                
                // Load pending alerts
                const alertsPromises = pirIds.map(id =>
                    db.collection('alerts')
                        .where('userId', '==', id)
                        .where('resolved', '==', false)
                        .get()
                );
                
                const alertsSnapshots = await Promise.all(alertsPromises);
                const allAlerts = [];
                
                alertsSnapshots.forEach((snapshot, index) => {
                    snapshot.forEach(doc => {
                        const alertData = { id: doc.id, ...doc.data() };
                        const pir = pirsData.find(p => p.id === pirIds[index]);
                        alertData.pirName = pir?.displayName || pir?.email || 'Unknown';
                        alertData.pirId = pirIds[index];
                        allAlerts.push(alertData);
                    });
                });
                
                setPendingAlerts(allAlerts);
            }
            
            setMyPIRs(pirsData);
            setFilteredPIRs(pirsData);
            
        } catch (error) {
            console.error('Error loading my PIRs:', error);
        } finally {
            setLoading(false);
        }
    };
     // UPDATED: Comprehensive Recovery Milestones (matches index.html)
const getRecoveryMilestones = (sobrietyDate) => {
    if (!sobrietyDate) return [];
    
    const startDate = sobrietyDate.toDate ? sobrietyDate.toDate() : new Date(sobrietyDate);
    
    const milestones = [
        { days: 1, title: '24 Hours Clean', icon: 'üåü' },
        { days: 7, title: '1 Week Clean', icon: 'üìÖ' },
        { days: 30, title: '1 Month Clean', icon: 'üèÜ' },
        { days: 60, title: '2 Months Clean', icon: 'üí™' },
        { days: 90, title: '3 Months Clean', icon: 'üéØ' },
        { days: 100, title: '100 Days Clean', icon: 'üíØ' },
        { days: 120, title: '4 Months Clean', icon: '‚≠ê' },
        { days: 150, title: '5 Months Clean', icon: 'üåà' },
        { days: 180, title: '6 Months Clean', icon: 'üéâ' },
        { days: 200, title: '200 Days Clean', icon: '‚ú®' },
        { days: 210, title: '7 Months Clean', icon: 'üåü' },
        { days: 240, title: '8 Months Clean', icon: 'üèÖ' },
        { days: 270, title: '9 Months Clean', icon: 'üíé' },
        { days: 300, title: '10 Months Clean', icon: 'üå∫' },
        { days: 330, title: '11 Months Clean', icon: 'üéä' },
        { days: 365, title: '1 Year Clean', icon: 'üéÇ' },
        { days: 500, title: '500 Days Clean', icon: 'üèÜ' },
        { days: 548, title: '18 Months Clean', icon: 'üåü' },
        { days: 730, title: '2 Years Clean', icon: 'üéà' },
        { days: 1000, title: '1000 Days Clean', icon: 'üèÖ' },
        { days: 1095, title: '3 Years Clean', icon: 'üéâ' },
        { days: 1460, title: '4 Years Clean', icon: 'üåü' },
        { days: 1825, title: '5 Years Clean', icon: 'üí´' }
    ];
    
    // Add yearly milestones dynamically up to 20 years
    for (let year = 6; year <= 20; year++) {
        milestones.push({
            days: year * 365,
            title: `${year} Years Clean`,
            icon: 'üåü'
        });
    }
    
    const today = new Date();
    const daysSober = Math.floor((today - startDate) / (1000 * 60 * 60 * 24)) + 1;
    
    return milestones.map(milestone => {
        const milestoneDate = new Date(startDate);
        milestoneDate.setDate(milestoneDate.getDate() + milestone.days - 1);
        
        return {
            ...milestone,
            date: milestoneDate,
            achieved: daysSober >= milestone.days,
            isToday: daysSober === milestone.days,
            isTomorrow: daysSober === (milestone.days - 1),
            daysUntil: milestone.days - daysSober,
            targetDate: milestoneDate,
            type: 'recovery'
        };
    });
};
    const addMilestonesToCoachCalendar = async (pir, accessToken) => {
    try {
        if (!pir.sobrietyDate) {
            alert('PIR has no sobriety date set. Cannot calculate milestones.');
            return;
        }
        
        // ‚úÖ CRITICAL: Check Google token FIRST (with auto-refresh)
        const tokenCheck = await checkGoogleToken();
        
        if (!tokenCheck.valid) {
            alert('‚ùå Cannot add milestones without Google Calendar\n\n' + tokenCheck.error);
            return;
        }
        
        console.log('‚úì Google token valid, proceeding with milestone creation...');
        
        // Use the refreshed token (not the passed-in one)
        const validToken = user.googleAccessToken;
        
        console.log('Adding milestones to coach calendar for:', pir.displayName || pir.email);
        
        // Get all milestones
        const milestones = getRecoveryMilestones(pir.sobrietyDate);
        
        // Filter: Only upcoming milestones (not already achieved)
        const upcomingMilestones = milestones.filter(m => !m.achieved);
        
        if (upcomingMilestones.length === 0) {
            alert(`${pir.displayName || 'PIR'} has achieved all defined milestones! üéâ`);
            return;
        }
        
        console.log(`Creating ${upcomingMilestones.length} milestone events...`);
        
        let successCount = 0;
        let failCount = 0;
        
        for (const milestone of upcomingMilestones) {
            try {
                // Create all-day event on milestone date
                const eventDate = milestone.targetDate.toISOString().split('T')[0]; // YYYY-MM-DD
                
                const event = {
                    summary: `${milestone.icon} ${pir.displayName || 'PIR'} - ${milestone.title}`,
                    description: `Celebrate ${pir.displayName || pir.email}'s milestone!\n\nDays Clean: ${milestone.days}\n\nRemember to acknowledge this achievement!`,
                    start: {
                        date: eventDate,
                        timeZone: 'America/Los_Angeles'
                    },
                    end: {
                        date: eventDate,
                        timeZone: 'America/Los_Angeles'
                    },
                    reminders: {
                        useDefault: false,
                        overrides: [
                            { method: 'email', minutes: 24 * 60 }, // 1 day before
                            { method: 'popup', minutes: 0 } // On the day
                        ]
                    },
                    colorId: '9' // Blue color for milestones
                };
                
                const response = await fetch(
                    'https://www.googleapis.com/calendar/v3/calendars/primary/events',
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${validToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(event)
                    }
                );
                
                if (response.ok) {
                    successCount++;
                    console.log(`‚úì Created: ${milestone.title}`);
                } else {
                    failCount++;
                    const errorData = await response.json().catch(() => ({}));
                    console.error(`‚úó Failed: ${milestone.title}`, errorData);
                }
                
            } catch (error) {
                failCount++;
                console.error(`Error creating milestone event:`, error);
            }
        }
        
        // Success message
        if (successCount > 0 && failCount === 0) {
            alert(
                `‚úÖ Success!\n\n` +
                `${successCount} milestone celebration${successCount > 1 ? 's' : ''} added to your calendar!\n\n` +
                `üéâ You'll be reminded to celebrate each milestone with ${pir.displayName || 'your PIR'}!`
            );
        } else if (successCount > 0 && failCount > 0) {
            alert(
                `‚ö†Ô∏è Partial Success\n\n` +
                `‚úÖ ${successCount} milestone${successCount > 1 ? 's' : ''} added\n` +
                `‚ùå ${failCount} failed\n\n` +
                `Check console for details.`
            );
        } else {
            alert(
                `‚ùå Failed to add milestones\n\n` +
                `Please check your Google Calendar connection and try again.`
            );
        }
        
    } catch (error) {
        console.error('Error adding milestones to calendar:', error);
        alert('Failed to add milestones: ' + error.message);
    }
};

    // DELETE: Remove PIR's milestone events from Google Calendar
const deletePIRMilestones = async (pirId) => {
    try {
        // Check token first
        const tokenCheck = await checkGoogleToken();
        if (!tokenCheck.valid) {
            console.error('Cannot delete milestones - invalid token');
            return false;
        }
        
        const validToken = user.googleAccessToken;
        
        // Get stored milestone events from Firestore
        const pirDoc = await db.collection('users').doc(pirId).get();
        const events = pirDoc.data()?.milestoneCalendarEvents || [];
        
        if (events.length === 0) {
            console.log('No milestone events to delete');
            return true;
        }
        
        console.log(`Deleting ${events.length} milestone events...`);
        
        let successCount = 0;
        let failCount = 0;
        
        for (const event of events) {
            try {
                const response = await fetch(
                    `https://www.googleapis.com/calendar/v3/calendars/primary/events/${event.eventId}`,
                    {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${validToken}`
                        }
                    }
                );
                
                if (response.ok || response.status === 404) {
                    successCount++;
                    console.log(`‚úì Deleted: ${event.eventId}`);
                } else {
                    failCount++;
                    console.error(`‚úó Failed to delete: ${event.eventId}`);
                }
            } catch (error) {
                failCount++;
                console.error('Error deleting event:', event.eventId, error);
            }
        }
        
        // Clear the array in Firestore
        await db.collection('users').doc(pirId).update({
            milestoneCalendarEvents: []
        });
        
        console.log(`Deletion complete: ${successCount} deleted, ${failCount} failed`);
        return true;
        
    } catch (error) {
        console.error('Error in deletePIRMilestones:', error);
        return false;
    }
};

// RECREATE: Delete old milestones and create new ones
const recreatePIRMilestones = async (pir) => {
    try {
        // Check token first
        const tokenCheck = await checkGoogleToken();
        if (!tokenCheck.valid) {
            alert('‚ùå Cannot recreate milestones without Google Calendar\n\n' + tokenCheck.error);
            return false;
        }
        
        console.log('Recreating milestones for:', pir.displayName || pir.email);
        
        // Step 1: Delete old milestones
        const deleted = await deletePIRMilestones(pir.id);
        if (!deleted) {
            console.error('Failed to delete old milestones');
        }
        
        // Step 2: Create new milestones
        await addMilestonesToCoachCalendar(pir, user.googleAccessToken);
        
        return true;
        
    } catch (error) {
        console.error('Error recreating milestones:', error);
        alert('Failed to recreate milestones: ' + error.message);
        return false;
    }
};

// UPDATED: Add milestones WITH event tracking
const addMilestonesToCoachCalendar = async (pir, accessToken) => {
    try {
        if (!pir.sobrietyDate) {
            alert('PIR has no sobriety date set. Cannot calculate milestones.');
            return;
        }
        
        // ‚úÖ CRITICAL: Check Google token FIRST (with auto-refresh)
        const tokenCheck = await checkGoogleToken();
        
        if (!tokenCheck.valid) {
            alert('‚ùå Cannot add milestones without Google Calendar\n\n' + tokenCheck.error);
            return;
        }
        
        console.log('‚úì Google token valid, proceeding with milestone creation...');
        
        // Use the refreshed token
        const validToken = user.googleAccessToken;
        
        console.log('Adding milestones to coach calendar for:', pir.displayName || pir.email);
        
        // Get all milestones
        const milestones = getRecoveryMilestones(pir.sobrietyDate);
        
        // Filter: Only upcoming milestones (not already achieved)
        const upcomingMilestones = milestones.filter(m => !m.achieved);
        
        if (upcomingMilestones.length === 0) {
            alert(`${pir.displayName || 'PIR'} has achieved all defined milestones! üéâ`);
            return;
        }
        
        console.log(`Creating ${upcomingMilestones.length} milestone events...`);
        
        let successCount = 0;
        let failCount = 0;
        const createdEvents = []; // Track created events
        
        for (const milestone of upcomingMilestones) {
            try {
                // Create all-day event on milestone date
                const eventDate = milestone.targetDate.toISOString().split('T')[0]; // YYYY-MM-DD
                
                const event = {
                    summary: `${milestone.icon} ${pir.displayName || 'PIR'} - ${milestone.title}`,
                    description: `Celebrate ${pir.displayName || pir.email}'s milestone!\n\nDays Clean: ${milestone.days}\n\nRemember to acknowledge this achievement!`,
                    start: {
                        date: eventDate,
                        timeZone: 'America/Los_Angeles'
                    },
                    end: {
                        date: eventDate,
                        timeZone: 'America/Los_Angeles'
                    },
                    reminders: {
                        useDefault: false,
                        overrides: [
                            { method: 'email', minutes: 24 * 60 }, // 1 day before
                            { method: 'popup', minutes: 0 } // On the day
                        ]
                    },
                    colorId: '9' // Blue color for milestones
                };
                
                const response = await fetch(
                    'https://www.googleapis.com/calendar/v3/calendars/primary/events',
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${validToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(event)
                    }
                );
                
                if (response.ok) {
                    const createdEvent = await response.json();
                    successCount++;
                    console.log(`‚úì Created: ${milestone.title}`);
                    
                    // Track the event
                    createdEvents.push({
                        eventId: createdEvent.id,
                        milestoneDays: milestone.days,
                        milestoneTitle: milestone.title,
                        milestoneDate: eventDate,
                        createdAt: new Date().toISOString()
                    });
                } else {
                    failCount++;
                    const errorData = await response.json().catch(() => ({}));
                    console.error(`‚úó Failed: ${milestone.title}`, errorData);
                }
                
            } catch (error) {
                failCount++;
                console.error(`Error creating milestone event:`, error);
            }
        }
        
        // Save tracked events to Firestore
        if (createdEvents.length > 0) {
            try {
                await db.collection('users').doc(pir.id).update({
                    milestoneCalendarEvents: createdEvents,
                    milestonesLastSynced: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log(`‚úì Saved ${createdEvents.length} event IDs to Firestore`);
            } catch (error) {
                console.error('Error saving event IDs to Firestore:', error);
            }
        }
        
        // Success message
        if (successCount > 0 && failCount === 0) {
            alert(
                `‚úÖ Success!\n\n` +
                `${successCount} milestone celebration${successCount > 1 ? 's' : ''} added to your calendar!\n\n` +
                `üéâ You'll be reminded to celebrate each milestone with ${pir.displayName || 'your PIR'}!`
            );
        } else if (successCount > 0 && failCount > 0) {
            alert(
                `‚ö†Ô∏è Partial Success\n\n` +
                `‚úÖ ${successCount} milestone${successCount > 1 ? 's' : ''} added\n` +
                `‚ùå ${failCount} failed\n\n` +
                `Check console for details.`
            );
        } else {
            alert(
                `‚ùå Failed to add milestones\n\n` +
                `Please check your Google Calendar connection and try again.`
            );
        }
        
    } catch (error) {
        console.error('Error adding milestones to calendar:', error);
        alert('Failed to add milestones: ' + error.message);
    }
};
    const getMilestone = (days) => {
        if (days >= 365) return { label: '1 Year+', color: '#9C27B0', icon: 'üëë' };
        if (days >= 180) return { label: '6 Months', color: '#673AB7', icon: 'üíé' };
        if (days >= 90) return { label: '90 Days', color: '#3F51B5', icon: 'üåü' };
        if (days >= 60) return { label: '60 Days', color: '#2196F3', icon: '‚≠ê' };
        if (days >= 30) return { label: '30 Days', color: '#4CAF50', icon: 'üéØ' };
        if (days >= 7) return { label: '1 Week', color: '#8BC34A', icon: '‚ú®' };
        return null;
    };

    const renderMiniChart = (pirId, type, data) => {
        const refKey = `${type}-${pirId}`;
        const chartRef = type === 'mood' ? moodChartRefs.current[pirId] : cravingChartRefs.current[pirId];
        
        if (!chartRef) return;
        
        // Destroy existing chart
        if (chartInstances.current[refKey]) {
            chartInstances.current[refKey].destroy();
        }
        
        const ctx = chartRef.getContext('2d');
        chartInstances.current[refKey] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map((_, i) => ''),
                datasets: [{
                    data: data,
                    borderColor: type === 'mood' ? '#4CAF50' : '#FF9800',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { display: false, min: 0, max: 10 },
                    x: { display: false }
                },
                plugins: { legend: { display: false } }
            }
        });
    };

    const filterPIRs = () => {
        let filtered = [...myPIRs];
        
        if (activeFilter === 'needsAttention') {
            filtered = filtered.filter(pir => 
                pir.complianceRate < 50 || 
                pir.activeAlerts > 0 ||
                !pir.lastCheckInDate ||
                (pir.lastCheckInDate && daysSince(pir.lastCheckInDate) > 2)
            );
        } else if (activeFilter === 'compliant') {
            filtered = filtered.filter(pir => 
                pir.complianceRate >= 70 && 
                pir.activeAlerts === 0
            );
        }
        
        if (searchQuery) {
            const query = searchQuery.toLowerCase();
            filtered = filtered.filter(pir =>
                pir.email?.toLowerCase().includes(query) ||
                pir.displayName?.toLowerCase().includes(query) ||
                pir.firstName?.toLowerCase().includes(query) ||
                pir.lastName?.toLowerCase().includes(query)
            );
        }
        
        // Sort
        filtered.sort((a, b) => {
            if (sortBy === 'daysClean') return b.daysClean - a.daysClean;
            if (sortBy === 'compliance') return b.complianceRate - a.complianceRate;
            if (sortBy === 'lastCheckIn') {
                const dateA = a.lastCheckInDate?.toDate ? a.lastCheckInDate.toDate() : new Date(0);
                const dateB = b.lastCheckInDate?.toDate ? b.lastCheckInDate.toDate() : new Date(0);
                return dateB - dateA;
            }
            return 0;
        });
        
        setFilteredPIRs(filtered);
    };

    const daysSince = (date) => {
        if (!date) return 999;
        const checkDate = date?.toDate ? date.toDate() : new Date(date);
        return Math.floor((new Date() - checkDate) / (1000 * 60 * 60 * 24));
    };

    const handleSaveNotes = async (pirId, notes) => {
        try {
            await db.collection('pirNotes').doc(`${user.uid}_${pirId}`).set({
                coachId: user.uid,
                pirId: pirId,
                notes: notes,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            setPirNotes(prev => ({ ...prev, [pirId]: notes }));
            alert('Notes saved successfully');
        } catch (error) {
            console.error('Error saving notes:', error);
            alert('Failed to save notes');
        }
    };

    const handleQuickAssignment = async (pirId) => {
        const title = prompt('Assignment Title:');
        if (title) {
            const description = prompt('Assignment Description:');
            const dueDate = prompt('Due Date (YYYY-MM-DD):');
            
            try {
                await db.collection('assignments').add({
                    userId: pirId,
                    title: title,
                    description: description || '',
                    dueDate: dueDate || '',
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: user.uid
                });
                
                alert('Assignment created successfully!');
            } catch (error) {
                console.error('Error creating assignment:', error);
                alert('Failed to create assignment');
            }
        }
    };

    const handleResolveAlert = async (alertId) => {
        try {
            await db.collection('alerts').doc(alertId).update({
                resolved: true,
                resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                resolvedBy: user.uid
            });
            
            loadMyPIRs();
        } catch (error) {
            console.error('Error resolving alert:', error);
            alert('Failed to resolve alert');
        }
    };

    const handleExportPIRReport = (pir) => {
        const reportData = {
            name: pir.displayName || pir.email,
            email: pir.email,
            daysClean: pir.daysClean,
            complianceRate: `${pir.complianceRate}%`,
            weeklyCheckIns: pir.weeklyCheckIns,
            activeAlerts: pir.activeAlerts,
            lastCheckIn: pir.lastCheckInDate ? formatDateTime(pir.lastCheckInDate) : 'Never',
            lastMood: pir.lastCheckIn?.morningData?.mood || 'N/A',
            lastCraving: pir.lastCheckIn?.morningData?.craving || 'N/A',
            milestone: pir.milestone?.label || 'None',
            notes: pirNotes[pir.id] || 'No notes'
        };
        
        exportToPDF([reportData], `${pir.displayName || 'PIR'} Report`);
    };

    const getStatusColor = (pir) => {
        if (pir.activeAlerts > 0) return '#f44336';
        if (pir.complianceRate < 50) return '#FF9800';
        if (pir.complianceRate >= 70) return '#4CAF50';
        return '#FFC107';
    };

    const getStatusLabel = (pir) => {
        if (pir.activeAlerts > 0) return 'Alert';
        if (!pir.lastCheckInDate) return 'No Check-in';
        if (daysSince(pir.lastCheckInDate) > 2) return 'Overdue';
        if (pir.complianceRate >= 70) return 'Good';
        if (pir.complianceRate >= 50) return 'Fair';
        return 'Needs Attention';
    };

    if (loading) {
        return (
            <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                minHeight: '400px',
                gap: '20px'
            }}>
                <div style={{
                    width: '60px',
                    height: '60px',
                    border: '4px solid #f3f3f3',
                    borderTop: '4px solid #667eea',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite'
                }}></div>
                <p style={{ color: '#666' }}>Loading your PIRs...</p>
            </div>
        );
    }

  return (
    <div style={{ padding: '20px', animation: 'fadeIn 0.5s' }}>
        {/* Enhanced Stats Cards */}
        <div style={{
            display: 'grid',
            gridTemplateColumns: 'repeat(auto-fit, minmax(240px, 1fr))',
            gap: '20px',
            marginBottom: '30px'
        }}>
            <div style={{
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                borderRadius: '15px',
                padding: '25px',
                color: 'white',
                boxShadow: '0 4px 15px rgba(102, 126, 234, 0.3)',
                transition: 'transform 0.2s',
                cursor: 'pointer'
            }}
            onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
            onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
            >
                <div style={{ fontSize: '14px', opacity: 0.9 }}>Total PIRs</div>
                <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                    {myPIRs.length}
                </div>
                <div style={{ fontSize: '12px', opacity: 0.8 }}>In your caseload</div>
            </div>

            <div style={{
                background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                borderRadius: '15px',
                padding: '25px',
                color: 'white',
                boxShadow: '0 4px 15px rgba(240, 147, 251, 0.3)',
                transition: 'transform 0.2s',
                cursor: 'pointer'
            }}
            onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
            onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
            >
                <div style={{ fontSize: '14px', opacity: 0.9 }}>Active Alerts</div>
                <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                    {pendingAlerts.length}
                </div>
                <div style={{ fontSize: '12px', opacity: 0.8 }}>Need attention</div>
            </div>

            <div style={{
                background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                borderRadius: '15px',
                padding: '25px',
                color: 'white',
                boxShadow: '0 4px 15px rgba(79, 172, 254, 0.3)',
                transition: 'transform 0.2s',
                cursor: 'pointer'
            }}
            onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
            onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
            >
                <div style={{ fontSize: '14px', opacity: 0.9 }}>Compliant PIRs</div>
                <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                    {myPIRs.filter(p => p.complianceRate >= 70).length}
                </div>
                <div style={{ fontSize: '12px', opacity: 0.8 }}>70%+ compliance</div>
            </div>

            <div style={{
                background: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                borderRadius: '15px',
                padding: '25px',
                color: 'white',
                boxShadow: '0 4px 15px rgba(250, 112, 154, 0.3)',
                transition: 'transform 0.2s',
                cursor: 'pointer'
            }}
            onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
            onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
            >
                <div style={{ fontSize: '14px', opacity: 0.9 }}>Avg Days Clean</div>
                <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                    {Math.round(myPIRs.reduce((acc, p) => acc + p.daysClean, 0) / (myPIRs.length || 1))}
                </div>
                <div style={{ fontSize: '12px', opacity: 0.8 }}>All PIRs average</div>
            </div>
        </div>

        {/* Pending Alerts Banner */}
        {pendingAlerts.length > 0 && (
            <div style={{
                background: 'linear-gradient(135deg, #ff4444, #cc0000)',
                padding: '20px',
                borderRadius: '15px',
                marginBottom: '20px',
                boxShadow: '0 4px 15px rgba(255, 68, 68, 0.4)'
            }}>
                <div style={{ color: 'white', marginBottom: '15px', fontSize: '18px', fontWeight: 'bold', display: 'flex', alignItems: 'center', gap: '10px' }}>
                    <span style={{ fontSize: '24px' }}>‚ö†Ô∏è</span>
                    {pendingAlerts.length} Pending Alert{pendingAlerts.length > 1 ? 's' : ''}
                </div>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                    {pendingAlerts.slice(0, 3).map(alert => (
                        <div key={alert.id} style={{
                            background: 'rgba(255,255,255,0.15)',
                            backdropFilter: 'blur(10px)',
                            borderRadius: '10px',
                            padding: '15px',
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            color: 'white'
                        }}>
                            <div>
                                <div style={{ fontWeight: '600', marginBottom: '5px' }}>
                                    {alert.pirName} - {alert.type?.replace('_', ' ')}
                                </div>
                                <div style={{ fontSize: '13px', opacity: 0.9 }}>
                                    {alert.message}
                                </div>
                                <div style={{ fontSize: '11px', opacity: 0.7, marginTop: '5px' }}>
                                    {formatTimeAgo(alert.createdAt)}
                                </div>
                            </div>
                            <button 
                                onClick={() => handleResolveAlert(alert.id)}
                                style={{
                                    padding: '8px 16px',
                                    background: 'white',
                                    color: '#f44336',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '13px',
                                    fontWeight: '600',
                                    transition: 'transform 0.2s'
                                }}
                                onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.05)'}
                                onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
                            >
                                Resolve
                            </button>
                        </div>
                    ))}
                    {pendingAlerts.length > 3 && (
                        <div style={{ color: 'white', fontSize: '13px', opacity: 0.9, textAlign: 'center' }}>
                            +{pendingAlerts.length - 3} more alerts
                        </div>
                    )}
                </div>
            </div>
        )}

        {/* Filters and Controls */}
        <div style={{
            background: 'white',
            borderRadius: '15px',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
        }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '15px' }}>
                <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                    <button 
                        onClick={() => setActiveFilter('all')}
                        style={{
                            padding: '8px 16px',
                            background: activeFilter === 'all' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#f0f0f0',
                            color: activeFilter === 'all' ? 'white' : '#666',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500',
                            transition: 'all 0.2s'
                        }}
                    >
                        All ({myPIRs.length})
                    </button>
                    <button 
                        onClick={() => setActiveFilter('needsAttention')}
                        style={{
                            padding: '8px 16px',
                            background: activeFilter === 'needsAttention' ? 'linear-gradient(135deg, #f44336 0%, #e53935 100%)' : '#f0f0f0',
                            color: activeFilter === 'needsAttention' ? 'white' : '#666',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500',
                            transition: 'all 0.2s'
                        }}
                    >
                        Needs Attention ({myPIRs.filter(p => 
                            p.complianceRate < 50 || p.activeAlerts > 0 || daysSince(p.lastCheckInDate) > 2
                        ).length})
                    </button>
                    <button 
                        onClick={() => setActiveFilter('compliant')}
                        style={{
                            padding: '8px 16px',
                            background: activeFilter === 'compliant' ? 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)' : '#f0f0f0',
                            color: activeFilter === 'compliant' ? 'white' : '#666',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500',
                            transition: 'all 0.2s'
                        }}
                    >
                        Compliant ({myPIRs.filter(p => p.complianceRate >= 70 && p.activeAlerts === 0).length})
                    </button>
                </div>
                
                <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>
                    <select
                        value={sortBy}
                        onChange={(e) => setSortBy(e.target.value)}
                        style={{
                            padding: '8px 12px',
                            borderRadius: '8px',
                            border: '1px solid #ddd',
                            background: 'white',
                            cursor: 'pointer',
                            fontSize: '14px'
                        }}
                    >
                        <option value="daysClean">Sort by Days Clean</option>
                        <option value="compliance">Sort by Compliance</option>
                        <option value="lastCheckIn">Sort by Last Check-in</option>
                    </select>
                    
                    <button
                        onClick={() => setViewMode(viewMode === 'grid' ? 'list' : 'grid')}
                        style={{
                            padding: '8px 16px',
                            background: '#6c757d',
                            color: 'white',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500'
                        }}
                    >
                        {viewMode === 'grid' ? 'List View' : 'Grid View'}
                    </button>
                </div>
            </div>
        </div>

        {/* PIRs Grid/List */}
        <div style={{
            display: 'grid',
            gridTemplateColumns: viewMode === 'grid' ? 'repeat(auto-fill, minmax(350px, 1fr))' : '1fr',
            gap: '20px',
            marginBottom: '30px'
        }}>
            {filteredPIRs.map(pir => (
                <div key={pir.id} style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '20px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                    borderLeft: `4px solid ${getStatusColor(pir)}`,
                    transition: 'all 0.2s',
                    cursor: 'pointer'
                }}
                onMouseEnter={(e) => {
                    e.currentTarget.style.transform = 'translateY(-5px)';
                    e.currentTarget.style.boxShadow = '0 8px 20px rgba(0,0,0,0.15)';
                }}
                onMouseLeave={(e) => {
                    e.currentTarget.style.transform = 'translateY(0)';
                    e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
                }}
                >
                    {/* Header */}
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '15px' }}>
                        <div style={{ flex: 1 }}>
                            <h4 style={{ margin: '0 0 5px 0', fontSize: '18px', color: '#333' }}>
                                {pir.displayName || pir.email}
                            </h4>
                            <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                                <span style={{
                                    padding: '4px 12px',
                                    borderRadius: '20px',
                                    fontSize: '12px',
                                    fontWeight: '500',
                                    background: getStatusColor(pir),
                                    color: 'white'
                                }}>
                                    {getStatusLabel(pir)}
                                </span>
                                {pir.milestone && (
                                    <span style={{
                                        padding: '4px 12px',
                                        borderRadius: '20px',
                                        fontSize: '12px',
                                        fontWeight: '500',
                                        background: pir.milestone.color,
                                        color: 'white'
                                    }}>
                                        {pir.milestone.icon} {pir.milestone.label}
                                    </span>
                                )}
                            </div>
                        </div>
                        {pir.activeAlerts > 0 && (
                            <div style={{
                                background: '#f44336',
                                color: 'white',
                                borderRadius: '50%',
                                width: '30px',
                                height: '30px',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '14px',
                                fontWeight: 'bold'
                            }}>
                                {pir.activeAlerts}
                            </div>
                        )}
                    </div>

                    {/* Stats Grid */}
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(2, 1fr)',
                        gap: '10px',
                        marginBottom: '15px',
                        padding: '15px',
                        background: '#f8f9fa',
                        borderRadius: '10px'
                    }}>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '3px' }}>Days Clean</div>
                            <div style={{ fontSize: '20px', fontWeight: 'bold', color: '#333' }}>{pir.daysClean}</div>
                        </div>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '3px' }}>Compliance</div>
                            <div style={{ fontSize: '20px', fontWeight: 'bold', color: getStatusColor(pir) }}>
                                {pir.complianceRate}%
                            </div>
                        </div>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '3px' }}>Last Check-in</div>
                            <div style={{ fontSize: '13px', fontWeight: '500', color: '#666' }}>
                                {pir.lastCheckInDate ? formatTimeAgo(pir.lastCheckInDate) : 'Never'}
                            </div>
                        </div>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '3px' }}>Weekly Check-ins</div>
                            <div style={{ fontSize: '13px', fontWeight: '500', color: '#666' }}>
                                {pir.weeklyCheckIns}/14
                            </div>
                        </div>
                    </div>

                    {/* Trend Charts */}
                    {viewMode === 'grid' && (pir.moodTrend?.length > 0 || pir.cravingTrend?.length > 0) && (
                        <div style={{
                            display: 'grid',
                            gridTemplateColumns: '1fr 1fr',
                            gap: '10px',
                            marginBottom: '15px'
                        }}>
                            {pir.moodTrend?.length > 0 && (
                                <div>
                                    <div style={{ fontSize: '11px', color: '#999', marginBottom: '5px' }}>Mood Trend</div>
                                    <canvas 
                                        ref={el => moodChartRefs.current[pir.id] = el}
                                        style={{ height: '40px' }}
                                    ></canvas>
                                </div>
                            )}
                            {pir.cravingTrend?.length > 0 && (
                                <div>
                                    <div style={{ fontSize: '11px', color: '#999', marginBottom: '5px' }}>Craving Trend</div>
                                    <canvas 
                                        ref={el => cravingChartRefs.current[pir.id] = el}
                                        style={{ height: '40px' }}
                                    ></canvas>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Quick Notes Preview */}
                    {pirNotes[pir.id] && (
                        <div style={{
                            padding: '10px',
                            background: '#fff3cd',
                            borderRadius: '8px',
                            fontSize: '12px',
                            color: '#856404',
                            marginBottom: '15px',
                            maxHeight: '40px',
                            overflow: 'hidden',
                            textOverflow: 'ellipsis'
                        }}>
                            üìù {pirNotes[pir.id]}
                        </div>
                    )}

                    {/* Actions */}
                    <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                        <button
                            onClick={() => setSelectedPIR(pir)}
                            style={{
                                flex: 1,
                                padding: '10px 16px',
                                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '13px',
                                fontWeight: '500',
                                transition: 'transform 0.2s'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.02)'}
                            onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
                        >
                            View Details
                        </button>
                        
                        <button
                            onClick={async () => {
                                if (!user.googleConnected || !user.googleAccessToken) {
                                    alert('‚ùå Google Calendar Not Connected\n\nPlease connect Google Services in your Profile to sync milestones!');
                                    return;
                                }
                                await addMilestonesToCoachCalendar(pir, user.googleAccessToken);
                            }}
                            style={{
                                padding: '10px 16px',
                                background: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '13px',
                                fontWeight: '500',
                                transition: 'transform 0.2s'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.02)'}
                            onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
                        >
                            üéâ Calendar
                        </button>
                        
                        <button
                            onClick={() => {
                                setSelectedPIRForNotes(pir);
                                setShowNotesModal(true);
                            }}
                            style={{
                                padding: '10px 16px',
                                background: '#6c757d',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '13px',
                                fontWeight: '500'
                            }}
                        >
                            Notes
                        </button>
                        <button
                            onClick={() => handleQuickAssignment(pir.id)}
                            style={{
                                padding: '10px 16px',
                                background: '#4CAF50',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '13px',
                                fontWeight: '500'
                            }}
                        >
                            + Task
                        </button>
                        <button
                            onClick={() => handleExportPIRReport(pir)}
                            style={{
                                padding: '10px 16px',
                                background: '#FF9800',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '13px',
                                fontWeight: '500'
                            }}
                        >
                            Export
                        </button>
                    </div>
                </div>
            ))}
        </div>

        {filteredPIRs.length === 0 && (
            <div style={{
                padding: '60px 20px',
                textAlign: 'center',
                background: 'white',
                borderRadius: '15px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <div style={{ fontSize: '48px', marginBottom: '15px' }}>üë•</div>
                <div style={{ fontSize: '18px', fontWeight: '500', color: '#333', marginBottom: '8px' }}>
                    {myPIRs.length === 0 ? 'No PIRs Assigned' : 'No PIRs Match Filters'}
                </div>
                <div style={{ fontSize: '14px', color: '#999' }}>
                    {myPIRs.length === 0 
                        ? 'PIRs will appear here when assigned to you' 
                        : 'Try adjusting your filters'}
                </div>
            </div>
        )}

        {/* Recent Check-ins Section */}
        {recentCheckIns.length > 0 && (
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '25px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                marginTop: '30px'
            }}>
                <h3 style={{ margin: '0 0 20px 0', color: '#333' }}>Recent Check-ins</h3>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                    {recentCheckIns.map(checkIn => (
                        <div key={checkIn.id} style={{
                            padding: '15px',
                            background: '#f8f9fa',
                            borderRadius: '10px',
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center'
                        }}>
                            <div>
                                <div style={{ fontWeight: '600', color: '#333', marginBottom: '5px' }}>
                                    {checkIn.pirName}
                                </div>
                                <div style={{ fontSize: '13px', color: '#666', display: 'flex', gap: '15px' }}>
                                    <span>Mood: {checkIn.morningData?.mood || '--'}/10</span>
                                    <span>Craving: {checkIn.morningData?.craving || '--'}/10</span>
                                    {checkIn.attendedMeeting && <span style={{ color: '#4CAF50' }}>‚úì Meeting</span>}
                                </div>
                            </div>
                            <div style={{ fontSize: '12px', color: '#999' }}>
                                {formatTimeAgo(checkIn.createdAt)}
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        )}

        {/* Notes Modal */}
        {showNotesModal && selectedPIRForNotes && (
            <PIRNotesModal
                pir={selectedPIRForNotes}
                existingNotes={pirNotes[selectedPIRForNotes.id] || ''}
                onClose={() => {
                    setShowNotesModal(false);
                    setSelectedPIRForNotes(null);
                }}
                onSave={(notes) => {
                    handleSaveNotes(selectedPIRForNotes.id, notes);
                    setShowNotesModal(false);
                    setSelectedPIRForNotes(null);
                }}
            />
        )}

        {/* PIR Detail Modal */}
        {selectedPIR && (
            <UserDetailModal
                user={selectedPIR}
                onClose={() => setSelectedPIR(null)}
                onUpdate={() => {
                    setSelectedPIR(null);
                    loadMyPIRs();
                }}
                currentUserId={user.uid}
            />
        )}
    </div>
);
  }  
// PIR Notes Modal Component
function PIRNotesModal({ pir, existingNotes, onClose, onSave }) {
    const [notes, setNotes] = useState(existingNotes);

    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000,
            padding: '20px',
            animation: 'fadeIn 0.2s'
        }}>
            <div style={{
                background: 'white',
                borderRadius: '20px',
                maxWidth: '600px',
                width: '100%',
                boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
                animation: 'slideUp 0.3s'
            }}>
                {/* Header */}
                <div style={{
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    padding: '25px 30px',
                    borderRadius: '20px 20px 0 0',
                    color: 'white'
                }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <h2 style={{ margin: 0, fontSize: '24px' }}>
                            Notes for {pir.displayName || pir.email}
                        </h2>
                        <button 
                            onClick={onClose}
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                border: 'none',
                                color: 'white',
                                fontSize: '24px',
                                width: '36px',
                                height: '36px',
                                borderRadius: '50%',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center'
                            }}
                        >
                            √ó
                        </button>
                    </div>
                </div>

                {/* Content */}
                <div style={{ padding: '30px' }}>
                    <textarea
                        value={notes}
                        onChange={(e) => setNotes(e.target.value)}
                        placeholder="Add private notes about this PIR..."
                        style={{
                            width: '100%',
                            minHeight: '200px',
                            padding: '15px',
                            border: '2px solid #e0e0e0',
                            borderRadius: '10px',
                            fontSize: '14px',
                            fontFamily: 'inherit',
                            resize: 'vertical',
                            marginBottom: '20px'
                        }}
                    />

                    <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                        <button
                            onClick={onClose}
                            style={{
                                padding: '12px 24px',
                                background: '#6c757d',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '500'
                            }}
                        >
                            Cancel
                        </button>
                        <button
                            onClick={() => onSave(notes)}
                            style={{
                                padding: '12px 24px',
                                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '500'
                            }}
                        >
                            Save Notes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
}
// COMPLETE ENHANCED CommunityView - WITH SUPPORT GROUP CALENDAR INTEGRATION
function CommunityView({ searchQuery, user }) {
    const [activeTab, setActiveTab] = useState('analytics');
    const [loading, setLoading] = useState(true);
    const [createType, setCreateType] = useState('room');
    const [messages, setMessages] = useState([]);
    const [topicRooms, setTopicRooms] = useState([]);
    const [flaggedMessages, setFlaggedMessages] = useState([]);
    const [supportGroups, setSupportGroups] = useState([]);
    const [meetings, setMeetings] = useState([]);
    const [selectedRoom, setSelectedRoom] = useState('main');
    const [newMessage, setNewMessage] = useState('');
    const [showCreateModal, setShowCreateModal] = useState(false);
    const [selectedItem, setSelectedItem] = useState(null);
    const [selectedImage, setSelectedImage] = useState(null);
    const [messageListener, setMessageListener] = useState(null);
    const [pinnedMessages, setPinnedMessages] = useState([]);
    const [messageReactions, setMessageReactions] = useState({});
    const [chatSearch, setChatSearch] = useState('');
    const [filteredMessages, setFilteredMessages] = useState([]);
    const [onlineUsers, setOnlineUsers] = useState(new Set());
    const [typingUsers, setTypingUsers] = useState(new Set());
    const [moderationKeywords, setModerationKeywords] = useState([]);
    const [userWarnings, setUserWarnings] = useState({});
    const [moderationHistory, setModerationHistory] = useState([]);
    const [selectedMeeting, setSelectedMeeting] = useState(null);
    const [attendanceData, setAttendanceData] = useState({});
    const [showAttendanceModal, setShowAttendanceModal] = useState(false);
    const [viewMode, setViewMode] = useState('messages');
    const [selectedThread, setSelectedThread] = useState(null);
    
    const activityChartRef = useRef(null);
    const sentimentChartRef = useRef(null);
    const engagementChartRef = useRef(null);
    const chartInstances = useRef({});
    
    const [stats, setStats] = useState({
        totalMessages: 0,
        activeUsers: 0,
        flaggedCount: 0,
        roomsCount: 0,
        supportGroupsCount: 0,
        meetingsCount: 0,
        todayMessages: 0,
        weekMessages: 0,
        avgMessagesPerUser: 0,
        topContributors: [],
        sentimentScore: 0,
        engagementRate: 0
    });

    const [analyticsData, setAnalyticsData] = useState({
        activityByHour: [],
        activityByDay: [],
        roomEngagement: [],
        sentimentTrend: [],
        topContributors: [],
        messageVolume: []
    });

    useEffect(() => {
        loadCommunityData();
        loadModerationKeywords();
        setupPresenceListener();
        
        return () => {
            if (messageListener) messageListener();
            if (chartInstances.current.activity) chartInstances.current.activity.destroy();
            if (chartInstances.current.sentiment) chartInstances.current.sentiment.destroy();
            if (chartInstances.current.engagement) chartInstances.current.engagement.destroy();
        };
    }, []);

    useEffect(() => {
        if (selectedRoom) {
            loadMessages(selectedRoom);
            loadPinnedMessages(selectedRoom);
        }
    }, [selectedRoom]);

    useEffect(() => {
        filterMessages();
    }, [messages, chatSearch]);

    useEffect(() => {
        if (analyticsData.activityByHour.length > 0) {
            renderAnalyticsCharts();
        }
    }, [analyticsData]);

    const setupPresenceListener = () => {
        const presenceRef = db.collection('presence');
        
        presenceRef.where('online', '==', true).onSnapshot(snapshot => {
            const online = new Set();
            snapshot.forEach(doc => {
                online.add(doc.id);
            });
            setOnlineUsers(online);
        });
    };

    const loadModerationKeywords = async () => {
        try {
            const keywordsDoc = await db.collection('settings').doc('moderation').get();
            if (keywordsDoc.exists) {
                setModerationKeywords(keywordsDoc.data().keywords || []);
            }
        } catch (error) {
            console.error('Error loading moderation keywords:', error);
        }
    };

    const loadCommunityData = async () => {
        try {
            setLoading(true);

            // Load rooms
            const roomsSnap = await db.collection('topicRooms').get();
            const roomsData = [];
            for (const doc of roomsSnap.docs) {
                const roomData = { id: doc.id, ...doc.data() };
                
                // Get message count
                const messagesCount = await db.collection('messages')
                    .where('roomId', '==', doc.id)
                    .get();
                roomData.messageCount = messagesCount.size;
                
                roomsData.push(roomData);
            }
            setTopicRooms(roomsData);

            // Load support groups
            const supportGroupsSnap = await db.collection('supportGroups')
                .orderBy('createdAt', 'desc')
                .get();
            const supportGroupsData = [];
            supportGroupsSnap.forEach(doc => {
                supportGroupsData.push({ id: doc.id, ...doc.data() });
            });
            setSupportGroups(supportGroupsData);

            // Load meetings
            const meetingsSnap = await db.collection('meetings')
                .where('coachId', '==', user.uid)
                .orderBy('scheduledTime', 'desc')
                .limit(50)
                .get();
            
            const meetingsData = [];
            for (const doc of meetingsSnap.docs) {
                const meetingData = { id: doc.id, ...doc.data() };
                
                if (meetingData.assignedPIRs && meetingData.assignedPIRs.length > 0) {
                    const pirNames = [];
                    for (const pirId of meetingData.assignedPIRs) {
                        const pirDoc = await db.collection('users').doc(pirId).get();
                        if (pirDoc.exists) {
                            const pirData = pirDoc.data();
                            pirNames.push(pirData.displayName || pirData.email);
                        }
                    }
                    meetingData.pirNames = pirNames;
                }
                
                // Load attendance data
                const attendanceSnap = await db.collection('meetingAttendance')
                    .where('meetingId', '==', doc.id)
                    .get();
                meetingData.attendanceCount = attendanceSnap.size;
                
                meetingsData.push(meetingData);
            }
            setMeetings(meetingsData);

            // Load flagged messages
            const flaggedSnap = await db.collection('messages')
                .where('flagged', '==', true)
                .where('resolved', '==', false)
                .orderBy('flaggedAt', 'desc')
                .limit(20)
                .get();

            const flaggedData = [];
            for (const doc of flaggedSnap.docs) {
                const messageData = { id: doc.id, ...doc.data() };
                
                if (messageData.userId) {
                    const userDoc = await db.collection('users').doc(messageData.userId).get();
                    if (userDoc.exists) {
                        messageData.userName = userDoc.data().displayName || userDoc.data().email;
                    }
                }
                
                flaggedData.push(messageData);
            }
            setFlaggedMessages(flaggedData);

            // Load moderation history
            const moderationSnap = await db.collection('moderationActions')
                .orderBy('timestamp', 'desc')
                .limit(50)
                .get();
            
            const moderationData = [];
            moderationSnap.forEach(doc => {
                moderationData.push({ id: doc.id, ...doc.data() });
            });
            setModerationHistory(moderationData);

            // Load user warnings
            const warningsSnap = await db.collection('userWarnings').get();
            const warnings = {};
            warningsSnap.forEach(doc => {
                warnings[doc.id] = doc.data().warnings || [];
            });
            setUserWarnings(warnings);

            // Calculate comprehensive stats
            await calculateStats(roomsData, supportGroupsData, meetingsData);
            await calculateAnalytics();

        } catch (error) {
            console.error('Error loading community data:', error);
        } finally {
            setLoading(false);
        }
    };

    const calculateStats = async (rooms, groups, meets) => {
        try {
            // Get all messages for analysis
            const allMessagesSnap = await db.collection('messages')
                .orderBy('createdAt', 'desc')
                .limit(1000)
                .get();

            const allMessages = [];
            const uniqueUsers = new Set();
            const userMessageCounts = {};
            
            const now = new Date();
            const todayStart = new Date(now.setHours(0, 0, 0, 0));
            const weekStart = new Date(now.setDate(now.getDate() - 7));
            
            let todayCount = 0;
            let weekCount = 0;
            let positiveCount = 0;
            let negativeCount = 0;

            allMessagesSnap.forEach(doc => {
                const msg = doc.data();
                allMessages.push(msg);
                
                if (msg.userId) {
                    uniqueUsers.add(msg.userId);
                    userMessageCounts[msg.userId] = (userMessageCounts[msg.userId] || 0) + 1;
                }
                
                const msgDate = msg.createdAt?.toDate ? msg.createdAt.toDate() : new Date(msg.createdAt);
                if (msgDate >= todayStart) todayCount++;
                if (msgDate >= weekStart) weekCount++;
                
                // Simple sentiment analysis
                const content = (msg.content || '').toLowerCase();
                const positive = ['great', 'good', 'thanks', 'helpful', 'love', 'appreciate', 'wonderful'];
                const negative = ['bad', 'worst', 'hate', 'terrible', 'awful', 'struggling'];
                
                if (positive.some(word => content.includes(word))) positiveCount++;
                if (negative.some(word => content.includes(word))) negativeCount++;
            });

            // Top contributors
            const topContributors = Object.entries(userMessageCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([userId, count]) => ({ userId, count }));

            // Load user names for top contributors
            for (const contributor of topContributors) {
                const userDoc = await db.collection('users').doc(contributor.userId).get();
                if (userDoc.exists) {
                    contributor.userName = userDoc.data().displayName || userDoc.data().email;
                }
            }

            const totalMessages = allMessages.length;
            const sentimentScore = totalMessages > 0 
                ? Math.round(((positiveCount - negativeCount) / totalMessages) * 100) 
                : 50;
            
            const engagementRate = uniqueUsers.size > 0 
                ? Math.round((totalMessages / uniqueUsers.size) * 10) / 10 
                : 0;

            setStats({
                totalMessages: totalMessages,
                activeUsers: uniqueUsers.size,
                flaggedCount: flaggedMessages.length,
                roomsCount: rooms.length,
                supportGroupsCount: groups.length,
                meetingsCount: meets.length,
                todayMessages: todayCount,
                weekMessages: weekCount,
                avgMessagesPerUser: engagementRate,
                topContributors: topContributors,
                sentimentScore: sentimentScore,
                engagementRate: engagementRate
            });

        } catch (error) {
            console.error('Error calculating stats:', error);
        }
    };

    const calculateAnalytics = async () => {
        try {
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

            const messagesSnap = await db.collection('messages')
                .where('createdAt', '>=', sevenDaysAgo)
                .get();

            // Activity by hour (0-23)
            const hourlyActivity = new Array(24).fill(0);
            
            // Activity by day
            const dailyActivity = {};
            
            // Room engagement
            const roomEngagement = {};
            
            // Sentiment trend
            const sentimentByDay = {};

            messagesSnap.forEach(doc => {
                const msg = doc.data();
                const date = msg.createdAt?.toDate ? msg.createdAt.toDate() : new Date(msg.createdAt);
                
                // Hour analysis
                hourlyActivity[date.getHours()]++;
                
                // Day analysis
                const dayKey = date.toISOString().split('T')[0];
                dailyActivity[dayKey] = (dailyActivity[dayKey] || 0) + 1;
                
                // Room engagement
                roomEngagement[msg.roomId] = (roomEngagement[msg.roomId] || 0) + 1;
                
                // Sentiment by day
                const content = (msg.content || '').toLowerCase();
                const isPositive = ['great', 'good', 'thanks', 'helpful', 'love'].some(w => content.includes(w));
                const isNegative = ['bad', 'worst', 'hate', 'terrible', 'awful'].some(w => content.includes(w));
                
                if (!sentimentByDay[dayKey]) sentimentByDay[dayKey] = { positive: 0, negative: 0, neutral: 0 };
                if (isPositive) sentimentByDay[dayKey].positive++;
                else if (isNegative) sentimentByDay[dayKey].negative++;
                else sentimentByDay[dayKey].neutral++;
            });

            setAnalyticsData({
                activityByHour: hourlyActivity,
                activityByDay: Object.entries(dailyActivity).map(([day, count]) => ({ day, count })),
                roomEngagement: Object.entries(roomEngagement).map(([room, count]) => ({ room, count })),
                sentimentTrend: Object.entries(sentimentByDay).map(([day, data]) => ({ day, ...data })),
                messageVolume: Object.entries(dailyActivity).map(([day, count]) => ({ day, count }))
            });

        } catch (error) {
            console.error('Error calculating analytics:', error);
        }
    };

    const renderAnalyticsCharts = () => {
        // Activity by Hour Chart
        if (activityChartRef.current) {
            if (chartInstances.current.activity) {
                chartInstances.current.activity.destroy();
            }
            
            const ctx = activityChartRef.current.getContext('2d');
            chartInstances.current.activity = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: [{
                        label: 'Messages',
                        data: analyticsData.activityByHour,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: '#667eea',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // Sentiment Trend Chart
        if (sentimentChartRef.current && analyticsData.sentimentTrend.length > 0) {
            if (chartInstances.current.sentiment) {
                chartInstances.current.sentiment.destroy();
            }
            
            const ctx = sentimentChartRef.current.getContext('2d');
            chartInstances.current.sentiment = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: analyticsData.sentimentTrend.map(d => new Date(d.day).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                    datasets: [
                        {
                            label: 'Positive',
                            data: analyticsData.sentimentTrend.map(d => d.positive),
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Negative',
                            data: analyticsData.sentimentTrend.map(d => d.negative),
                            borderColor: '#f44336',
                            backgroundColor: 'rgba(244, 67, 54, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Room Engagement Chart
        if (engagementChartRef.current && analyticsData.roomEngagement.length > 0) {
            if (chartInstances.current.engagement) {
                chartInstances.current.engagement.destroy();
            }
            
            const ctx = engagementChartRef.current.getContext('2d');
            const roomNames = analyticsData.roomEngagement.map(r => {
                if (r.room === 'main') return 'Main Chat';
                const room = topicRooms.find(tr => tr.id === r.room);
                return room?.name || 'Unknown';
            });
            
            chartInstances.current.engagement = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: roomNames,
                    datasets: [{
                        data: analyticsData.roomEngagement.map(r => r.count),
                        backgroundColor: [
                            '#667eea',
                            '#f093fb',
                            '#4facfe',
                            '#fa709a',
                            '#43e97b',
                            '#38f9d7'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
    };

    const loadMessages = async (roomId) => {
        if (messageListener) {
            messageListener();
        }

        const listener = db.collection('messages')
            .where('roomId', '==', roomId)
            .orderBy('createdAt', 'desc')
            .limit(100)
            .onSnapshot(async snapshot => {
                const messagesData = [];
                
                for (const doc of snapshot.docs) {
                    const messageData = { id: doc.id, ...doc.data() };
                    
                    if (messageData.userId) {
                        const userDoc = await db.collection('users').doc(messageData.userId).get();
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            messageData.userName = userData.displayName || userData.email;
                            messageData.userRole = userData.role;
                        }
                    }
                    
                    // Load reactions
                    const reactionsSnap = await db.collection('messageReactions')
                        .where('messageId', '==', doc.id)
                        .get();
                    
                    const reactions = {};
                    reactionsSnap.forEach(reactionDoc => {
                        const data = reactionDoc.data();
                        if (!reactions[data.emoji]) {
                            reactions[data.emoji] = [];
                        }
                        reactions[data.emoji].push(data.userId);
                    });
                    messageData.reactions = reactions;
                    
                    // Load replies count
                    const repliesSnap = await db.collection('messages')
                        .where('parentId', '==', doc.id)
                        .get();
                    messageData.repliesCount = repliesSnap.size;
                    
                    messagesData.push(messageData);
                }
                
                setMessages(messagesData);
            });

        setMessageListener(() => listener);
    };

    const loadPinnedMessages = async (roomId) => {
        try {
            const pinnedSnap = await db.collection('messages')
                .where('roomId', '==', roomId)
                .where('pinned', '==', true)
                .orderBy('pinnedAt', 'desc')
                .get();
            
            const pinned = [];
            for (const doc of pinnedSnap.docs) {
                const msgData = { id: doc.id, ...doc.data() };
                
                if (msgData.userId) {
                    const userDoc = await db.collection('users').doc(msgData.userId).get();
                    if (userDoc.exists) {
                        msgData.userName = userDoc.data().displayName || userDoc.data().email;
                    }
                }
                
                pinned.push(msgData);
            }
            setPinnedMessages(pinned);
        } catch (error) {
            console.error('Error loading pinned messages:', error);
        }
    };

    const filterMessages = () => {
        if (!chatSearch) {
            setFilteredMessages(messages);
            return;
        }
        
        const query = chatSearch.toLowerCase();
        const filtered = messages.filter(msg =>
            msg.content?.toLowerCase().includes(query) ||
            msg.userName?.toLowerCase().includes(query)
        );
        setFilteredMessages(filtered);
    };

    const handleSendMessage = async () => {
        if (!newMessage.trim()) return;

        try {
            // Check for moderation keywords
            const lowerMessage = newMessage.toLowerCase();
            const hasBlockedKeyword = moderationKeywords.some(keyword => 
                lowerMessage.includes(keyword.toLowerCase())
            );

            if (hasBlockedKeyword) {
                alert('Your message contains inappropriate content and cannot be sent.');
                return;
            }

            await db.collection('messages').add({
                roomId: selectedRoom,
                userId: user.uid,
                content: newMessage,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                edited: false,
                flagged: false,
                resolved: false,
                fromAdmin: true,
                pinned: false,
                parentId: selectedThread
            });

            setNewMessage('');
            setSelectedThread(null);
        } catch (error) {
            console.error('Error sending message:', error);
            alert('Failed to send message');
        }
    };

    const handleReaction = async (messageId, emoji) => {
        try {
            const reactionRef = db.collection('messageReactions')
                .doc(`${messageId}_${user.uid}_${emoji}`);
            
            const reactionDoc = await reactionRef.get();
            
            if (reactionDoc.exists) {
                await reactionRef.delete();
            } else {
                await reactionRef.set({
                    messageId: messageId,
                    userId: user.uid,
                    emoji: emoji,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        } catch (error) {
            console.error('Error handling reaction:', error);
        }
    };

    const handlePinMessage = async (messageId, isPinned) => {
        try {
            await db.collection('messages').doc(messageId).update({
                pinned: !isPinned,
                pinnedAt: !isPinned ? firebase.firestore.FieldValue.serverTimestamp() : null,
                pinnedBy: !isPinned ? user.uid : null
            });
            
            loadPinnedMessages(selectedRoom);
        } catch (error) {
            console.error('Error pinning message:', error);
        }
    };

    const handleDeleteMessage = async (messageId) => {
        if (confirm('Delete this message permanently?')) {
            try {
                await db.collection('messages').doc(messageId).delete();
                
                // Log moderation action
                await db.collection('moderationActions').add({
                    action: 'delete',
                    messageId: messageId,
                    moderatorId: user.uid,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('Message deleted');
            } catch (error) {
                console.error('Error deleting message:', error);
                alert('Failed to delete message');
            }
        }
    };

    const handleWarnUser = async (userId, reason) => {
        try {
            const warningData = {
                userId: userId,
                reason: reason,
                issuedBy: user.uid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection('userWarnings').doc(userId).set({
                warnings: firebase.firestore.FieldValue.arrayUnion(warningData)
            }, { merge: true });
            
            // Log moderation action
            await db.collection('moderationActions').add({
                action: 'warn',
                userId: userId,
                reason: reason,
                moderatorId: user.uid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            alert('Warning issued');
            loadCommunityData();
        } catch (error) {
            console.error('Error warning user:', error);
            alert('Failed to issue warning');
        }
    };

    const handleFlagResolve = async (messageId, action) => {
        try {
            if (action === 'delete') {
                await db.collection('messages').doc(messageId).delete();
            } else if (action === 'unflag') {
                await db.collection('messages').doc(messageId).update({
                    flagged: false,
                    resolved: true,
                    resolvedBy: user.uid,
                    resolvedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            // Log action
            await db.collection('moderationActions').add({
                action: action,
                messageId: messageId,
                moderatorId: user.uid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            loadCommunityData();
        } catch (error) {
            console.error('Error resolving flag:', error);
            alert('Failed to resolve flag');
        }
    };

    const handleCreateRoom = async (roomData) => {
        try {
            await db.collection('topicRooms').add({
                ...roomData,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: user.uid,
                active: true,
                messageCount: 0
            });

            alert('Topic room created successfully!');
            setShowCreateModal(false);
            setSelectedItem(null);
            loadCommunityData();
        } catch (error) {
            console.error('Error creating room:', error);
            alert('Failed to create room');
        }
    };

    const handleToggleRoom = async (roomId, currentStatus) => {
        try {
            await db.collection('topicRooms').doc(roomId).update({
                active: !currentStatus
            });
            loadCommunityData();
        } catch (error) {
            console.error('Error toggling room:', error);
        }
    };

    const handleDeleteRoom = async (roomId) => {
        if (confirm('Delete this topic room?')) {
            try {
                await db.collection('topicRooms').doc(roomId).delete();
                alert('Room deleted');
                loadCommunityData();
            } catch (error) {
                console.error('Error deleting room:', error);
            }
        }
    };

    // NEW: Helper to calculate next occurrence of a day
    const getNextDayOfWeek = (dayName, time) => {
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const targetDay = days.indexOf(dayName);
        
        if (targetDay === -1) {
            throw new Error('Invalid day name');
        }
        
        const now = new Date();
        const currentDay = now.getDay();
        
        // Calculate days until target day
        let daysUntilTarget = targetDay - currentDay;
        if (daysUntilTarget <= 0) {
            daysUntilTarget += 7; // Next week
        }
        
        // Create date for next occurrence
        const nextDate = new Date(now);
        nextDate.setDate(now.getDate() + daysUntilTarget);
        
        // Set time
        const [hours, minutes] = time.split(':');
        nextDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
        
        return nextDate;
    };

    // NEW: Create Google Calendar event for Support Group
    const createSupportGroupCalendarEvent = async (groupData, pirId, accessToken) => {
        try {
            // Calculate next occurrence
            const startDateTime = getNextDayOfWeek(groupData.day, groupData.time);
            
            // End time is 1 hour after start (default for support groups)
            const endDateTime = new Date(startDateTime);
            endDateTime.setHours(endDateTime.getHours() + 1);
            
            // Build description
            let description = groupData.description || '';
            if (groupData.location) {
                description += `\n\nLocation: ${groupData.location}`;
            }
            if (groupData.link) {
                description += `\n\nVirtual Meeting Link: ${groupData.link}`;
            }
            
            const event = {
                summary: `${groupData.type} - ${groupData.name}`,
                description: description,
                location: groupData.location || '',
                start: {
                    dateTime: startDateTime.toISOString(),
                    timeZone: 'America/Los_Angeles'
                },
                end: {
                    dateTime: endDateTime.toISOString(),
                    timeZone: 'America/Los_Angeles'
                },
                recurrence: [
                    'RRULE:FREQ=WEEKLY' // Repeats weekly
                ],
                reminders: {
                    useDefault: false,
                    overrides: [
                        { method: 'popup', minutes: 30 },
                        { method: 'email', minutes: 60 }
                    ]
                }
            };
            
            console.log('Creating support group calendar event for PIR:', pirId);
            
            // Get PIR's Google access token
            const pirDoc = await db.collection('users').doc(pirId).get();
            if (!pirDoc.exists) {
                throw new Error('PIR not found');
            }
            
            const pirData = pirDoc.data();
            const pirAccessToken = pirData.googleAccessToken || accessToken;
            
            if (!pirAccessToken) {
                console.warn('PIR does not have Google connected, skipping calendar event');
                return null;
            }
            
            // Make API request to PIR's calendar
            const response = await fetch(
                'https://www.googleapis.com/calendar/v3/calendars/primary/events',
                {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${pirAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(event)
                }
            );
            
            if (!response.ok) {
                const error = await response.json();
                console.error('Google Calendar API error for PIR:', error);
                throw new Error('Failed to create calendar event for PIR');
            }
            
            const createdEvent = await response.json();
            console.log('‚úì Calendar event created for PIR:', pirId);
            
            return {
                eventId: createdEvent.id,
                htmlLink: createdEvent.htmlLink,
                pirId: pirId
            };
            
        } catch (error) {
            console.error('Error creating support group calendar event:', error);
            return null;
        }
    };

    // UPDATED: Handle Create Support Group with Calendar Integration
    const handleCreateSupportGroup = async (groupData) => {
        try {
            console.log('Creating support group with data:', groupData);
            
            // Save support group to Firebase first
            const groupDoc = await db.collection('supportGroups').add({
                ...groupData,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: user.uid,
                active: true
            });
            
            console.log('‚úì Support group saved to Firebase:', groupDoc.id);
            
            // If there are assigned PIRs and coach has Google connected, create calendar events
            if (groupData.assignedPIRs && groupData.assignedPIRs.length > 0 && user.googleConnected) {
                console.log(`Creating calendar events for ${groupData.assignedPIRs.length} PIRs...`);
                
                const calendarEvents = [];
                let successCount = 0;
                let failCount = 0;
                
                for (const pirId of groupData.assignedPIRs) {
                    try {
                        const eventData = await createSupportGroupCalendarEvent(
                            groupData,
                            pirId,
                            user.googleAccessToken
                        );
                        
                        if (eventData) {
                            calendarEvents.push(eventData);
                            successCount++;
                        } else {
                            failCount++;
                        }
                    } catch (error) {
                        console.error(`Failed to create calendar event for PIR ${pirId}:`, error);
                        failCount++;
                    }
                }
                
                // Save calendar event IDs to the support group document
                if (calendarEvents.length > 0) {
                    await db.collection('supportGroups').doc(groupDoc.id).update({
                        googleCalendarEvents: calendarEvents
                    });
                    
                    console.log(`‚úì Created ${successCount} calendar events`);
                }
                
                // Show summary
                if (successCount > 0 && failCount === 0) {
                    alert(
                        `‚úÖ Support group created successfully!\n\n` +
                        `üìÖ Added to ${successCount} PIR calendar(s)\n` +
                        `üîÅ Repeats: Weekly on ${groupData.day}s\n` +
                        `üïê Time: ${groupData.time} PT`
                    );
                } else if (successCount > 0 && failCount > 0) {
                    alert(
                        `‚ö†Ô∏è Support group created!\n\n` +
                        `‚úÖ Added to ${successCount} calendar(s)\n` +
                        `‚ùå Failed for ${failCount} PIR(s)\n\n` +
                        `(Some PIRs may not have Google Calendar connected)`
                    );
                } else if (failCount > 0) {
                    alert(
                        `‚úÖ Support group created!\n\n` +
                        `‚ö†Ô∏è Calendar events could not be created.\n` +
                        `PIRs may need to connect their Google Calendar.`
                    );
                }
            } else {
                // No calendar integration
                if (!user.googleConnected) {
                    alert(
                        `‚úÖ Support group created!\n\n` +
                        `‚ö†Ô∏è Connect Google Services in your Profile to automatically\n` +
                        `add support groups to PIR calendars.`
                    );
                } else {
                    alert('‚úÖ Support group created successfully!');
                }
            }
            
            setShowCreateModal(false);
            setSelectedItem(null);
            loadCommunityData();
            
        } catch (error) {
            console.error('Error creating support group:', error);
            alert('Failed to create support group: ' + error.message);
        }
    };

    // AUTO-REFRESH: Silently refresh Google token if expired
    const refreshGoogleToken = async () => {
        return new Promise((resolve, reject) => {
            try {
                console.log('Attempting to refresh Google token...');
                
                // Check if Google Identity Services is loaded
                if (typeof google === 'undefined' || !google.accounts) {
                    reject(new Error('Google Identity Services not loaded'));
                    return;
                }
                
                // Use token client to get new token silently
                const tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: '457406864879-k1sunucuqofe22m5rg93hvo6nngiqh0u.apps.googleusercontent.com',
                    scope: [
                        'https://www.googleapis.com/auth/calendar.events',
                        'https://www.googleapis.com/auth/drive.file',
                        'https://www.googleapis.com/auth/gmail.send'
                    ].join(' '),
                    callback: async (tokenResponse) => {
                        try {
                            if (tokenResponse.error) {
                                reject(new Error(tokenResponse.error));
                                return;
                            }
                            
                            if (tokenResponse.access_token) {
                                // Update Firebase with new token
                                await db.collection('users').doc(user.uid).update({
                                    googleAccessToken: tokenResponse.access_token,
                                    googleTokenExpiry: Date.now() + (tokenResponse.expires_in * 1000),
                                    googleTokenRefreshedAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                
                                console.log('‚úì Token refreshed successfully');
                                
                                // Update local user object
                                user.googleAccessToken = tokenResponse.access_token;
                                user.googleTokenExpiry = Date.now() + (tokenResponse.expires_in * 1000);
                                
                                resolve(tokenResponse.access_token);
                            } else {
                                reject(new Error('No access token received'));
                            }
                        } catch (error) {
                            reject(error);
                        }
                    },
                });
                
                // Request new token (will try silently first with prompt: '')
                tokenClient.requestAccessToken({ prompt: '' });
                
            } catch (error) {
                console.error('Failed to refresh token:', error);
                reject(error);
            }
        });
    };

    // Check if Google token is valid and auto-refresh if needed
    const checkGoogleToken = async () => {
        // Check if user has Google connected
        if (!user.googleConnected || !user.googleAccessToken) {
            return {
                valid: false,
                error: 'Google Services not connected. Please connect Google in your Profile settings.'
            };
        }
        
        // Check if token is expired
        if (user.googleTokenExpiry) {
            const now = Date.now();
            const expiryTime = user.googleTokenExpiry;
            const fiveMinutes = 5 * 60 * 1000;
            
            if (now >= expiryTime - fiveMinutes) {
                // Token expired - try to refresh automatically
                try {
                    console.log('‚ö†Ô∏è Token expired, attempting auto-refresh...');
                    await refreshGoogleToken();
                    console.log('‚úì Token auto-refreshed successfully');
                    return { valid: true };
                } catch (refreshError) {
                    console.error('‚ùå Auto-refresh failed:', refreshError);
                    return {
                        valid: false,
                        error: 'Google token expired and could not be refreshed automatically.\n\nPlease:\n1. Go to Profile\n2. Click "Disconnect Google Services"\n3. Click "Connect Google Services" again\n\nThen try scheduling the meeting again.'
                    };
                }
            }
        }
        
        return { valid: true };
    };

  // PERMANENT FIX: Google Calendar Helper - Timezone-Safe Meeting Creation
const createGoogleMeeting = async (meetingData, accessToken) => {
    try {
        // BUILD DATETIME STRING DIRECTLY IN PACIFIC TIMEZONE (NO CONVERSIONS!)
        const date = meetingData.date; // Already in YYYY-MM-DD format
        const time = meetingData.time; // Already in HH:MM format
        
        // Construct RFC3339 datetime in Pacific timezone (no Date object conversions)
        const startDateTimeString = `${date}T${time}:00`; // e.g., "2025-10-08T14:30:00"
        
        console.log('Meeting datetime (Pacific):', startDateTimeString);
        
        // Calculate end time
        const [startHours, startMinutes] = time.split(':').map(Number);
        const durationMinutes = parseInt(meetingData.duration || 60);
        
        let endHours = startHours;
        let endMinutes = startMinutes + durationMinutes;
        
        // Handle minute overflow
        if (endMinutes >= 60) {
            endHours += Math.floor(endMinutes / 60);
            endMinutes = endMinutes % 60;
        }
        
        // Handle hour overflow (next day)
        let endDate = date;
        if (endHours >= 24) {
            endHours = endHours % 24;
            const dateParts = date.split('-');
            const nextDay = new Date(
                parseInt(dateParts[0]),
                parseInt(dateParts[1]) - 1,
                parseInt(dateParts[2]) + 1
            );
            endDate = nextDay.toISOString().split('T')[0];
        }
        
        const endDateTimeString = `${endDate}T${String(endHours).padStart(2, '0')}:${String(endMinutes).padStart(2, '0')}:00`;
        
        console.log('End datetime (Pacific):', endDateTimeString);
        
        // BUILD RECURRENCE RULE WITH PROPER END CONDITIONS
        let recurrence = [];
        let estimatedOccurrences = 1;
        
        if (meetingData.recurring && meetingData.recurring !== 'none') {
            const freq = meetingData.recurring.toUpperCase();
            
            if (meetingData.recurringEnd === 'count') {
                // After X occurrences
                recurrence = [`RRULE:FREQ=${freq};COUNT=${meetingData.recurringCount}`];
                estimatedOccurrences = parseInt(meetingData.recurringCount);
            } else if (meetingData.recurringEnd === 'until') {
                // Until specific date - use 23:59:59 on that day in Pacific
                const untilDateString = `${meetingData.recurringUntil}T23:59:59`;
                // Convert to RRULE format (basic ISO string without separators + Z)
                const untilStr = untilDateString.replace(/[-:]/g, '') + 'Z';
                recurrence = [`RRULE:FREQ=${freq};UNTIL=${untilStr}`];
                
                // Calculate estimated occurrences
                const startDate = new Date(date);
                const untilDate = new Date(meetingData.recurringUntil);
                const daysBetween = Math.floor((untilDate - startDate) / (1000 * 60 * 60 * 24));
                
                if (meetingData.recurring === 'daily') {
                    estimatedOccurrences = daysBetween + 1;
                } else if (meetingData.recurring === 'weekly') {
                    estimatedOccurrences = Math.floor(daysBetween / 7) + 1;
                } else if (meetingData.recurring === 'monthly') {
                    estimatedOccurrences = Math.floor(daysBetween / 30) + 1;
                }
            } else if (meetingData.recurringEnd === 'never') {
                // Infinite - no COUNT or UNTIL
                recurrence = [`RRULE:FREQ=${freq}`];
                estimatedOccurrences = '‚àû';
            }
        }
        
        // Create event with Meet link - PACIFIC TIME (NO CONVERSIONS!)
        const event = {
            summary: meetingData.title || meetingData.meetingTitle,
            description: meetingData.description || meetingData.notes || '',
            start: {
                dateTime: startDateTimeString,
                timeZone: 'America/Los_Angeles'
            },
            end: {
                dateTime: endDateTimeString,
                timeZone: 'America/Los_Angeles'
            },
            conferenceData: {
                createRequest: {
                    requestId: `meet-${Date.now()}`,
                    conferenceSolutionKey: { type: 'hangoutsMeet' }
                }
            },
            reminders: {
                useDefault: false,
                overrides: [
                    { method: 'email', minutes: 24 * 60 },
                    { method: 'popup', minutes: 30 }
                ]
            }
        };
        
        if (recurrence.length > 0) {
            event.recurrence = recurrence;
        }
        
        console.log('Sending request to Google Calendar API...');
        console.log('Event payload:', JSON.stringify(event, null, 2));
        
        // Make API request
        const response = await fetch(
            'https://www.googleapis.com/calendar/v3/calendars/primary/events?conferenceDataVersion=1',
            {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(event)
            }
        );
        
        console.log('Google Calendar API response status:', response.status);
        
        if (!response.ok) {
            const error = await response.json();
            console.error('Google Calendar API error:', error);
            
            if (response.status === 401) {
                throw new Error('TOKEN_EXPIRED');
            }
            
            throw new Error(error.error?.message || 'Failed to create calendar event');
        }
        
        const createdEvent = await response.json();
        console.log('Calendar event created successfully:', createdEvent.id);
        
        return {
            eventId: createdEvent.id,
            meetLink: createdEvent.hangoutLink,
            htmlLink: createdEvent.htmlLink,
            occurrences: estimatedOccurrences
        };
        
    } catch (error) {
        console.error('Error creating Google Calendar event:', error);
        throw error;
    }
};
   // UPDATED: Handle Create Meeting with Occurrence Count Display
const handleCreateMeeting = async (meetingData) => {
    try {
        // CRITICAL: Check Google token FIRST (now async with auto-refresh)
        const tokenCheck = await checkGoogleToken();
        
        if (!tokenCheck.valid) {
            alert('‚ùå Cannot create meeting without Google Calendar\n\n' + tokenCheck.error);
            return;
        }
        
        console.log('‚úì Google token valid, proceeding with meeting creation...');
        
        let googleEventData = null;
        let occurrenceCount = 1;
        
        try {
            console.log('Creating Google Calendar event with Meet link...');
            googleEventData = await createGoogleMeeting(meetingData, user.googleAccessToken);
            console.log('‚úì Google event created:', googleEventData);
            
            // Get occurrence count
            occurrenceCount = googleEventData.occurrences || 1;
            
            // Update meeting data with generated Meet link
            if (googleEventData.meetLink) {
                meetingData.meetingLink = googleEventData.meetLink;
            }
        } catch (googleError) {
            console.error('‚ùå Google Calendar integration failed:', googleError);
            
            // If token expired during creation, show reconnect message
            if (googleError.message === 'TOKEN_EXPIRED') {
                alert('‚ùå Google token expired during creation!\n\nPlease:\n1. Go to Profile\n2. Disconnect Google Services\n3. Connect Google Services again\n4. Try scheduling the meeting again');
                return;
            }
            
            // Other Google errors - let user decide
            const continueWithoutGoogle = confirm(
                '‚ö†Ô∏è Google Calendar sync failed!\n\n' +
                'Error: ' + googleError.message + '\n\n' +
                'Do you want to create the meeting WITHOUT a Google Meet link?\n\n' +
                '(You can add the link manually later)'
            );
            
            if (!continueWithoutGoogle) {
                return;
            }
        }
        
        // Only reach here if Google Calendar succeeded OR user chose to continue
        console.log('Saving meeting to Firebase...');
        
        // Save to Firebase
        const meetingDoc = await db.collection('meetings').add({
            ...meetingData,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            coachId: user.uid,
            status: 'scheduled',
            googleCalendarEventId: googleEventData?.eventId || null,
            googleCalendarLink: googleEventData?.htmlLink || null,
            recurring: meetingData.recurring || 'none',
            recurringEnd: meetingData.recurringEnd || 'never',
            recurringCount: meetingData.recurringCount || null,
            recurringUntil: meetingData.recurringUntil || null,
            timezone: 'America/Los_Angeles'
        });
        
        console.log('‚úì Meeting saved to Firebase:', meetingDoc.id);
        
        // ENHANCED SUCCESS MESSAGE WITH OCCURRENCE COUNT
        let successMessage = '‚úÖ Meeting scheduled successfully!\n\n';
        
        if (meetingData.recurring && meetingData.recurring !== 'none') {
            if (occurrenceCount === '‚àû') {
                successMessage += `üìÖ Recurring ${meetingData.recurring} (infinite)\n`;
                successMessage += '‚ö†Ô∏è This meeting will repeat forever until manually deleted\n\n';
            } else {
                const startDate = new Date(
                    parseInt(meetingData.date.split('-')[0]),
                    parseInt(meetingData.date.split('-')[1]) - 1,
                    parseInt(meetingData.date.split('-')[2])
                ).toLocaleDateString();
                
                successMessage += `üìÖ ${occurrenceCount} occurrences created\n`;
                successMessage += `üìÜ Starting ${startDate}\n\n`;
            }
        } else {
            const meetingDateTime = new Date(
                parseInt(meetingData.date.split('-')[0]),
                parseInt(meetingData.date.split('-')[1]) - 1,
                parseInt(meetingData.date.split('-')[2]),
                parseInt(meetingData.time.split(':')[0]),
                parseInt(meetingData.time.split(':')[1])
            );
            successMessage += `üìÖ ${meetingDateTime.toLocaleString()}\n\n`;
        }
        
        if (googleEventData?.meetLink) {
            successMessage += `üîó Meet link: ${googleEventData.meetLink}\n`;
        }
        
        if (googleEventData?.htmlLink) {
            successMessage += `üìÜ View in Calendar: ${googleEventData.htmlLink}\n`;
        }
        
        successMessage += 'üïê Time: Pacific Time (PT)';
        
        alert(successMessage);
        
        setShowCreateModal(false);
        setSelectedItem(null);
        loadCommunityData();
        
    } catch (error) {
        console.error('‚ùå Error creating meeting:', error);
        alert('Failed to create meeting: ' + error.message);
    }
};

    const handleRecordAttendance = async (meetingId, pirId, status) => {
        try {
            await db.collection('meetingAttendance').doc(`${meetingId}_${pirId}`).set({
                meetingId: meetingId,
                pirId: pirId,
                status: status,
                recordedAt: firebase.firestore.FieldValue.serverTimestamp(),
                recordedBy: user.uid
            });
            
            alert('Attendance recorded');
            loadCommunityData();
        } catch (error) {
            console.error('Error recording attendance:', error);
        }
    };

    const exportData = (type, format) => {
        let data = [];
        let filename = '';
        
        if (type === 'messages') {
            data = messages.map(msg => ({
                room: selectedRoom,
                user: msg.userName,
                message: msg.content,
                timestamp: formatDateTime(msg.createdAt),
                flagged: msg.flagged ? 'Yes' : 'No'
            }));
            filename = 'chat-messages';
        } else if (type === 'analytics') {
            data = [
                { metric: 'Total Messages', value: stats.totalMessages },
                { metric: 'Active Users', value: stats.activeUsers },
                { metric: 'Flagged Messages', value: stats.flaggedCount },
                { metric: 'Sentiment Score', value: stats.sentimentScore },
                { metric: 'Engagement Rate', value: stats.engagementRate }
            ];
            filename = 'community-analytics';
        } else if (type === 'moderation') {
            data = moderationHistory.map(action => ({
                action: action.action,
                moderator: action.moderatorId,
                timestamp: formatDateTime(action.timestamp),
                details: action.reason || 'N/A'
            }));
            filename = 'moderation-history';
        }
        
        if (format === 'csv') {
            exportToCSV(data, filename);
        } else if (format === 'pdf') {
            exportToPDF(data, `${filename} Report`);
        } else {
            exportToJSON(data, filename);
        }
    };

    if (loading) {
        return (
            <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                minHeight: '400px',
                gap: '20px'
            }}>
                <div style={{
                    width: '60px',
                    height: '60px',
                    border: '4px solid #f3f3f3',
                    borderTop: '4px solid #667eea',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite'
                }}></div>
                <p style={{ color: '#666' }}>Loading community data...</p>
            </div>
        );
    }

    return (
        <div style={{ padding: '20px', animation: 'fadeIn 0.5s' }}>
            {/* Enhanced Navigation */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '15px 20px',
                marginBottom: '20px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                display: 'flex',
                gap: '10px',
                flexWrap: 'wrap',
                overflowX: 'auto'
            }}>
                {[
                    { id: 'analytics', label: 'Analytics', icon: 'üìä' },
                    { id: 'chat', label: 'Chat', icon: 'üí¨' },
                    { id: 'rooms', label: `Rooms (${topicRooms.length})`, icon: 'üè†' },
                    { id: 'supportGroups', label: `Support Groups (${supportGroups.length})`, icon: 'ü§ù' },
                    { id: 'meetings', label: `Meetings (${meetings.length})`, icon: 'üìÖ' },
                    { id: 'moderation', label: `Moderation ${flaggedMessages.length > 0 ? `(${flaggedMessages.length})` : ''}`, icon: 'üõ°Ô∏è' }
                ].map(tab => (
                    <button
                        key={tab.id}
                        onClick={() => setActiveTab(tab.id)}
                        style={{
                            padding: '10px 20px',
                            background: activeTab === tab.id 
                                ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' 
                                : '#f0f0f0',
                            color: activeTab === tab.id ? 'white' : '#666',
                            border: 'none',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500',
                            transition: 'all 0.2s',
                            whiteSpace: 'nowrap'
                        }}
                    >
                        {tab.icon} {tab.label}
                    </button>
                ))}
            </div>

            {/* Render Active Tab */}
            {activeTab === 'analytics' && (
                <AnalyticsTab 
                    stats={stats}
                    analyticsData={analyticsData}
                    activityChartRef={activityChartRef}
                    sentimentChartRef={sentimentChartRef}
                    engagementChartRef={engagementChartRef}
                    exportData={exportData}
                />
            )}

            {activeTab === 'chat' && (
                <EnhancedChatTab
                    messages={filteredMessages}
                    selectedRoom={selectedRoom}
                    setSelectedRoom={setSelectedRoom}
                    topicRooms={topicRooms}
                    newMessage={newMessage}
                    setNewMessage={setNewMessage}
                    handleSendMessage={handleSendMessage}
                    handleReaction={handleReaction}
                    handlePinMessage={handlePinMessage}
                    handleDeleteMessage={handleDeleteMessage}
                    handleWarnUser={handleWarnUser}
                    pinnedMessages={pinnedMessages}
                    chatSearch={chatSearch}
                    setChatSearch={setChatSearch}
                    onlineUsers={onlineUsers}
                    setSelectedImage={setSelectedImage}
                    viewMode={viewMode}
                    setViewMode={setViewMode}
                    selectedThread={selectedThread}
                    setSelectedThread={setSelectedThread}
                    user={user}
                    exportData={exportData}
                />
            )}

            {activeTab === 'rooms' && (
                <RoomsTab
                    topicRooms={topicRooms}
                    handleToggleRoom={handleToggleRoom}
                    handleDeleteRoom={handleDeleteRoom}
                    setShowCreateModal={setShowCreateModal}
                    setCreateType={setCreateType}
                />
            )}

            {activeTab === 'supportGroups' && (
                <SupportGroupsTab
                    supportGroups={supportGroups}
                    setShowCreateModal={setShowCreateModal}
                    setCreateType={setCreateType}
                    loadCommunityData={loadCommunityData}
                />
            )}

            {activeTab === 'meetings' && (
                <MeetingsTab
                    meetings={meetings}
                    setShowCreateModal={setShowCreateModal}
                    setCreateType={setCreateType}
                    setSelectedMeeting={setSelectedMeeting}
                    setShowAttendanceModal={setShowAttendanceModal}
                    loadCommunityData={loadCommunityData}
                />
            )}

            {activeTab === 'moderation' && (
                <ModerationTab
                    flaggedMessages={flaggedMessages}
                    moderationHistory={moderationHistory}
                    userWarnings={userWarnings}
                    moderationKeywords={moderationKeywords}
                    setModerationKeywords={setModerationKeywords}
                    handleFlagResolve={handleFlagResolve}
                    stats={stats}
                    exportData={exportData}
                />
            )}

            {/* Modals */}
            {selectedImage && (
                <ImageModal image={selectedImage} onClose={() => setSelectedImage(null)} />
            )}

            {showCreateModal && (
                <CommunityCreateModal
                    type={createType}
                    item={selectedItem}
                    onSubmit={(data) => {
                        if (createType === 'meeting') {
                            handleCreateMeeting(data);
                        } else if (createType === 'room') {
                            handleCreateRoom(data);
                        } else if (createType === 'supportGroup') {
                            handleCreateSupportGroup(data);
                        }
                    }}
                    onClose={() => {
                        setShowCreateModal(false);
                        setSelectedItem(null);
                    }}
                    user={user}
                />
            )}

            {showAttendanceModal && selectedMeeting && (
                <AttendanceModal
                    meeting={selectedMeeting}
                    onClose={() => {
                        setShowAttendanceModal(false);
                        setSelectedMeeting(null);
                    }}
                    handleRecordAttendance={handleRecordAttendance}
                />
            )}
        </div>
    );
}
        // ANALYTICS TAB
function AnalyticsTab({ stats, analyticsData, activityChartRef, sentimentChartRef, engagementChartRef, exportData }) {
    return (
        <div style={{ animation: 'fadeIn 0.5s' }}>
            {/* Stats Cards */}
            <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                gap: '20px',
                marginBottom: '30px'
            }}>
                <div style={{
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(102, 126, 234, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Total Messages</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.totalMessages}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>All time</div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(240, 147, 251, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Active Users</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.activeUsers}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Community members</div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(79, 172, 254, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Sentiment Score</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.sentimentScore}%
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Community mood</div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(250, 112, 154, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Today's Activity</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.todayMessages}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Messages today</div>
                </div>
            </div>

            {/* Charts */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(400px, 1fr))', gap: '20px', marginBottom: '30px' }}>
                <div style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '25px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                }}>
                    <h3 style={{ margin: '0 0 20px 0', color: '#333' }}>Activity by Hour</h3>
                    <div style={{ height: '300px' }}>
                        <canvas ref={activityChartRef}></canvas>
                    </div>
                </div>

                <div style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '25px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                }}>
                    <h3 style={{ margin: '0 0 20px 0', color: '#333' }}>Sentiment Trend</h3>
                    <div style={{ height: '300px' }}>
                        <canvas ref={sentimentChartRef}></canvas>
                    </div>
                </div>

                <div style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '25px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                }}>
                    <h3 style={{ margin: '0 0 20px 0', color: '#333' }}>Room Engagement</h3>
                    <div style={{ height: '300px' }}>
                        <canvas ref={engagementChartRef}></canvas>
                    </div>
                </div>
            </div>

            {/* Top Contributors */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '25px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                marginBottom: '20px'
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                    <h3 style={{ margin: 0, color: '#333' }}>Top Contributors</h3>
                    <button
                        onClick={() => exportData('analytics', 'csv')}
                        style={{
                            padding: '8px 16px',
                            background: '#6c757d',
                            color: 'white',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500'
                        }}
                    >
                        Export Analytics
                    </button>
                </div>
                <div style={{ display: 'grid', gap: '10px' }}>
                    {stats.topContributors.slice(0, 10).map((contributor, index) => (
                        <div key={contributor.userId} style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            padding: '15px',
                            background: '#f8f9fa',
                            borderRadius: '10px'
                        }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                                <div style={{
                                    width: '40px',
                                    height: '40px',
                                    borderRadius: '50%',
                                    background: index < 3 ? 'linear-gradient(135deg, #FFD700, #FFA500)' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                    color: 'white',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    fontSize: '18px',
                                    fontWeight: 'bold'
                                }}>
                                    {index + 1}
                                </div>
                                <div>
                                    <div style={{ fontWeight: '600', color: '#333' }}>
                                        {contributor.userName || 'Unknown User'}
                                    </div>
                                    <div style={{ fontSize: '13px', color: '#666' }}>
                                        {contributor.count} messages
                                    </div>
                                </div>
                            </div>
                            <div style={{
                                padding: '6px 16px',
                                background: 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)',
                                color: 'white',
                                borderRadius: '20px',
                                fontSize: '13px',
                                fontWeight: '600'
                            }}>
                                Active
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
}

// ENHANCED CHAT TAB
function EnhancedChatTab({ 
    messages, 
    selectedRoom, 
    setSelectedRoom, 
    topicRooms, 
    newMessage, 
    setNewMessage, 
    handleSendMessage,
    handleReaction,
    handlePinMessage,
    handleDeleteMessage,
    handleWarnUser,
    pinnedMessages,
    chatSearch,
    setChatSearch,
    onlineUsers,
    setSelectedImage,
    viewMode,
    setViewMode,
    selectedThread,
    setSelectedThread,
    user,
    exportData
}) {
    const reactions = ['üëç', '‚ù§Ô∏è', 'üòä', 'üéâ', 'üí™', 'üôè'];

    return (
        <div style={{ display: 'grid', gridTemplateColumns: '250px 1fr', gap: '20px', height: '700px' }}>
            {/* Sidebar */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                overflowY: 'auto'
            }}>
                <h4 style={{ margin: '0 0 15px 0', color: '#333' }}>Chat Rooms</h4>
                
                <div 
                    onClick={() => setSelectedRoom('main')}
                    style={{
                        padding: '12px',
                        background: selectedRoom === 'main' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#f8f9fa',
                        color: selectedRoom === 'main' ? 'white' : '#333',
                        borderRadius: '10px',
                        cursor: 'pointer',
                        marginBottom: '8px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '10px',
                        transition: 'all 0.2s'
                    }}
                >
                    <span style={{ fontSize: '20px' }}>üè†</span>
                    <span style={{ fontWeight: '500' }}>Main Chat</span>
                </div>
                
                {topicRooms.filter(room => room.active).map(room => (
                    <div 
                        key={room.id}
                        onClick={() => setSelectedRoom(room.id)}
                        style={{
                            padding: '12px',
                            background: selectedRoom === room.id ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#f8f9fa',
                            color: selectedRoom === room.id ? 'white' : '#333',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            marginBottom: '8px',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '10px',
                            transition: 'all 0.2s'
                        }}
                    >
                        <span style={{ fontSize: '20px' }}>{room.icon || 'üí¨'}</span>
                        <div style={{ flex: 1 }}>
                            <div style={{ fontWeight: '500', fontSize: '14px' }}>{room.name}</div>
                            <div style={{ fontSize: '11px', opacity: 0.8 }}>{room.messageCount || 0} msgs</div>
                        </div>
                    </div>
                ))}
            </div>

            {/* Main Chat Area */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                display: 'flex',
                flexDirection: 'column',
                overflow: 'hidden'
            }}>
                {/* Header */}
                <div style={{
                    padding: '20px',
                    borderBottom: '1px solid #f0f0f0',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center'
                }}>
                    <div>
                        <h3 style={{ margin: 0, color: '#333' }}>
                            {selectedRoom === 'main' ? 'GLRS Community Chat' : 
                             topicRooms.find(r => r.id === selectedRoom)?.name || 'Chat'}
                        </h3>
                        <div style={{ fontSize: '13px', color: '#666', marginTop: '5px' }}>
                            {messages.length} messages ‚Ä¢ {onlineUsers.size} online
                        </div>
                    </div>
                    <div style={{ display: 'flex', gap: '10px' }}>
                        <input
                            type="text"
                            placeholder="Search messages..."
                            value={chatSearch}
                            onChange={(e) => setChatSearch(e.target.value)}
                            style={{
                                padding: '8px 12px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '8px',
                                fontSize: '14px',
                                width: '200px'
                            }}
                        />
                        <button
                            onClick={() => exportData('messages', 'csv')}
                            style={{
                                padding: '8px 16px',
                                background: '#6c757d',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '500'
                            }}
                        >
                            Export
                        </button>
                    </div>
                </div>

                {/* Pinned Messages */}
                {pinnedMessages.length > 0 && (
                    <div style={{
                        padding: '15px 20px',
                        background: '#fff3cd',
                        borderBottom: '1px solid #f0f0f0'
                    }}>
                        <div style={{ fontWeight: '600', color: '#856404', marginBottom: '10px', fontSize: '13px' }}>
                            üìå Pinned Messages
                        </div>
                        {pinnedMessages.map(msg => (
                            <div key={msg.id} style={{
                                padding: '8px',
                                background: 'rgba(255,255,255,0.5)',
                                borderRadius: '6px',
                                marginBottom: '5px',
                                fontSize: '13px',
                                color: '#856404'
                            }}>
                                <strong>{msg.userName}:</strong> {msg.content}
                            </div>
                        ))}
                    </div>
                )}

                {/* Messages */}
                <div style={{
                    flex: 1,
                    overflowY: 'auto',
                    padding: '20px',
                    display: 'flex',
                    flexDirection: 'column-reverse'
                }}>
                    {messages.map(message => (
                        <div key={message.id} style={{
                            marginBottom: '20px',
                            padding: '15px',
                            background: message.fromAdmin ? 'rgba(102, 126, 234, 0.1)' : '#f8f9fa',
                            borderRadius: '10px',
                            borderLeft: message.flagged ? '4px solid #f44336' : 'none'
                        }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '8px' }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                    <div style={{
                                        width: '36px',
                                        height: '36px',
                                        borderRadius: '50%',
                                        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                        color: 'white',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        fontSize: '16px',
                                        fontWeight: 'bold'
                                    }}>
                                        {message.userName?.charAt(0).toUpperCase() || '?'}
                                    </div>
                                    <div>
                                        <div style={{ fontWeight: '600', color: '#333', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            {message.userName || 'Unknown'}
                                            {message.userRole === 'admin' && <span>üõ°Ô∏è</span>}
                                            {message.userRole === 'coach' && <span>üë§</span>}
                                            {onlineUsers.has(message.userId) && (
                                                <span style={{
                                                    width: '8px',
                                                    height: '8px',
                                                    borderRadius: '50%',
                                                    background: '#4CAF50',
                                                    display: 'inline-block'
                                                }}></span>
                                            )}
                                        </div>
                                        <div style={{ fontSize: '12px', color: '#999' }}>
                                            {formatTimeAgo(message.createdAt)}
                                        </div>
                                    </div>
                                </div>
                                <div style={{ display: 'flex', gap: '5px' }}>
                                    <button
                                        onClick={() => handlePinMessage(message.id, message.pinned)}
                                        style={{
                                            padding: '4px 8px',
                                            background: message.pinned ? '#FFC107' : 'transparent',
                                            border: '1px solid #ddd',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '12px'
                                        }}
                                        title={message.pinned ? 'Unpin' : 'Pin message'}
                                    >
                                        üìå
                                    </button>
                                    <button
                                        onClick={() => {
                                            const reason = prompt('Warning reason:');
                                            if (reason) handleWarnUser(message.userId, reason);
                                        }}
                                        style={{
                                            padding: '4px 8px',
                                            background: 'transparent',
                                            border: '1px solid #ddd',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '12px'
                                        }}
                                        title="Warn user"
                                    >
                                        ‚ö†Ô∏è
                                    </button>
                                    <button
                                        onClick={() => handleDeleteMessage(message.id)}
                                        style={{
                                            padding: '4px 8px',
                                            background: 'transparent',
                                            border: '1px solid #ddd',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '12px'
                                        }}
                                        title="Delete message"
                                    >
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                            
                            <div style={{ color: '#333', marginBottom: '10px', lineHeight: '1.6' }}>
                                {message.content}
                            </div>

                            {message.imageUrl && (
                                <img 
                                    src={message.imageUrl}
                                    alt="Shared"
                                    onClick={() => setSelectedImage(message.imageUrl)}
                                    style={{
                                        maxWidth: '300px',
                                        borderRadius: '8px',
                                        cursor: 'pointer',
                                        marginBottom: '10px'
                                    }}
                                />
                            )}

                            {/* Reactions */}
                            <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap', marginBottom: '8px' }}>
                                {reactions.map(emoji => {
                                    const count = message.reactions?.[emoji]?.length || 0;
                                    const hasReacted = message.reactions?.[emoji]?.includes(user.uid);
                                    
                                    return (
                                        <button
                                            key={emoji}
                                            onClick={() => handleReaction(message.id, emoji)}
                                            style={{
                                                padding: '4px 10px',
                                                background: hasReacted ? '#e3f2fd' : 'white',
                                                border: '1px solid #ddd',
                                                borderRadius: '20px',
                                                cursor: 'pointer',
                                                fontSize: '14px',
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '4px'
                                            }}
                                        >
                                            {emoji} {count > 0 && <span style={{ fontSize: '12px' }}>{count}</span>}
                                        </button>
                                    );
                                })}
                            </div>

                            {message.repliesCount > 0 && (
                                <button
                                    onClick={() => setSelectedThread(message.id)}
                                    style={{
                                        padding: '6px 12px',
                                        background: '#e3f2fd',
                                        border: 'none',
                                        borderRadius: '6px',
                                        cursor: 'pointer',
                                        fontSize: '12px',
                                        color: '#1976d2',
                                        fontWeight: '500'
                                    }}
                                >
                                    {message.repliesCount} {message.repliesCount === 1 ? 'reply' : 'replies'}
                                </button>
                            )}

                            {message.flagged && (
                                <div style={{
                                    marginTop: '10px',
                                    padding: '8px',
                                    background: '#ffebee',
                                    borderRadius: '6px',
                                    color: '#c62828',
                                    fontSize: '12px',
                                    fontWeight: '500'
                                }}>
                                    üö© This message has been flagged
                                </div>
                            )}
                        </div>
                    ))}
                    
                    {messages.length === 0 && (
                        <div style={{
                            textAlign: 'center',
                            padding: '60px 20px',
                            color: '#999'
                        }}>
                            <div style={{ fontSize: '48px', marginBottom: '15px' }}>üí¨</div>
                            <div>No messages yet. Start the conversation!</div>
                        </div>
                    )}
                </div>

                {/* Input */}
                <div style={{
                    padding: '20px',
                    borderTop: '1px solid #f0f0f0'
                }}>
                    {selectedThread && (
                        <div style={{
                            padding: '8px 12px',
                            background: '#e3f2fd',
                            borderRadius: '8px',
                            marginBottom: '10px',
                            fontSize: '13px',
                            color: '#1976d2',
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center'
                        }}>
                            <span>Replying to thread...</span>
                            <button
                                onClick={() => setSelectedThread(null)}
                                style={{
                                    background: 'none',
                                    border: 'none',
                                    color: '#1976d2',
                                    cursor: 'pointer',
                                    fontSize: '16px'
                                }}
                            >
                                √ó
                            </button>
                        </div>
                    )}
                    <div style={{ display: 'flex', gap: '10px' }}>
                        <input
                            type="text"
                            placeholder="Type a message..."
                            value={newMessage}
                            onChange={(e) => setNewMessage(e.target.value)}
                            onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                            style={{
                                flex: 1,
                                padding: '12px 16px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '10px',
                                fontSize: '14px'
                            }}
                        />
                        <button
                            onClick={handleSendMessage}
                            style={{
                                padding: '12px 24px',
                                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '10px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '600'
                            }}
                        >
                            Send
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
}

// ROOMS TAB
function RoomsTab({ topicRooms, handleToggleRoom, handleDeleteRoom, setShowCreateModal, setModalType }) {
    return (
        <div style={{ animation: 'fadeIn 0.5s' }}>
            <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                marginBottom: '20px'
            }}>
                <h3 style={{ margin: 0, color: '#333' }}>Topic Rooms Management</h3>
                <button
                    onClick={() => {
                        setModalType('room');
                        setShowCreateModal(true);
                    }}
                    style={{
                        padding: '10px 20px',
                        background: 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '10px',
                        cursor: 'pointer',
                        fontSize: '14px',
                        fontWeight: '600'
                    }}
                >
                    + Create Room
                </button>
            </div>

            <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))',
                gap: '20px'
            }}>
                {topicRooms.map(room => (
                    <div key={room.id} style={{
                        background: 'white',
                        borderRadius: '15px',
                        padding: '20px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                        transition: 'all 0.2s'
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.transform = 'translateY(-5px)';
                        e.currentTarget.style.boxShadow = '0 8px 20px rgba(0,0,0,0.15)';
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
                    }}
                    >
                        <div style={{ fontSize: '48px', textAlign: 'center', marginBottom: '15px' }}>
                            {room.icon || 'üí¨'}
                        </div>
                        <h4 style={{ margin: '0 0 10px 0', textAlign: 'center', color: '#333' }}>
                            {room.name}
                        </h4>
                        <p style={{ fontSize: '14px', color: '#666', textAlign: 'center', marginBottom: '15px' }}>
                            {room.description}
                        </p>
                        <div style={{
                            display: 'flex',
                            justifyContent: 'center',
                            gap: '8px',
                            marginBottom: '15px'
                        }}>
                            <span style={{
                                padding: '4px 12px',
                                background: room.active ? '#d4edda' : '#f8d7da',
                                color: room.active ? '#155724' : '#721c24',
                                borderRadius: '20px',
                                fontSize: '12px',
                                fontWeight: '500'
                            }}>
                                {room.active ? 'Active' : 'Inactive'}
                            </span>
                            <span style={{
                                padding: '4px 12px',
                                background: '#e3f2fd',
                                color: '#1976d2',
                                borderRadius: '20px',
                                fontSize: '12px',
                                fontWeight: '500'
                            }}>
                                {room.messageCount || 0} messages
                            </span>
                        </div>
                        <div style={{ display: 'flex', gap: '8px' }}>
                            <button
                                onClick={() => handleToggleRoom(room.id, room.active)}
                                style={{
                                    flex: 1,
                                    padding: '8px',
                                    background: room.active ? '#FFC107' : '#4CAF50',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '13px',
                                    fontWeight: '500'
                                }}
                            >
                                {room.active ? 'Deactivate' : 'Activate'}
                            </button>
                            <button
                                onClick={() => handleDeleteRoom(room.id)}
                                style={{
                                    flex: 1,
                                    padding: '8px',
                                    background: '#f44336',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '13px',
                                    fontWeight: '500'
                                }}
                            >
                                Delete
                            </button>
                        </div>
                    </div>
                ))}
            </div>

            {topicRooms.length === 0 && (
                <div style={{
                    padding: '80px 20px',
                    textAlign: 'center',
                    background: 'white',
                    borderRadius: '15px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                }}>
                    <div style={{ fontSize: '64px', marginBottom: '20px' }}>üè†</div>
                    <div style={{ fontSize: '20px', fontWeight: '600', color: '#333', marginBottom: '10px' }}>
                        No Topic Rooms Yet
                    </div>
                    <div style={{ fontSize: '16px', color: '#999' }}>
                        Create topic-specific rooms for focused discussions
                    </div>
                </div>
            )}
        </div>
    );
}
     // SUPPORT GROUPS TAB - CORRECTED
function SupportGroupsTab({ supportGroups, setShowCreateModal, setModalType, loadCommunityData }) {
    return (
        <div style={{ animation: 'fadeIn 0.5s' }}>
            <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                marginBottom: '20px'
            }}>
                <h3 style={{ margin: 0, color: '#333' }}>Support Groups</h3>
                <button
                    onClick={() => {
                        setModalType('supportGroup');
                        setShowCreateModal(true);
                    }}
                    style={{
                        padding: '10px 20px',
                        background: 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '10px',
                        cursor: 'pointer',
                        fontSize: '14px',
                        fontWeight: '600'
                    }}
                >
                    + Add Support Group
                </button>
            </div>

            <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fill, minmax(350px, 1fr))',
                gap: '20px'
            }}>
                {supportGroups.map(group => (
                    <div key={group.id} style={{
                        background: 'white',
                        borderRadius: '15px',
                        padding: '20px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                        transition: 'all 0.2s'
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.transform = 'translateY(-5px)';
                        e.currentTarget.style.boxShadow = '0 8px 20px rgba(0,0,0,0.15)';
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
                    }}
                    >
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '15px' }}>
                            <h4 style={{ margin: 0, color: '#333' }}>{group.name}</h4>
                            <span style={{
                                padding: '4px 12px',
                                background: group.type === 'AA' ? '#667eea' :
                                           group.type === 'NA' ? '#f093fb' :
                                           group.type === 'SMART' ? '#4facfe' : '#fa709a',
                                color: 'white',
                                borderRadius: '20px',
                                fontSize: '12px',
                                fontWeight: '600'
                            }}>
                                {group.type}
                            </span>
                        </div>

                        {group.description && (
                            <p style={{ fontSize: '14px', color: '#666', marginBottom: '15px' }}>
                                {group.description}
                            </p>
                        )}

                        <div style={{
                            display: 'grid',
                            gap: '10px',
                            marginBottom: '15px',
                            padding: '15px',
                            background: '#f8f9fa',
                            borderRadius: '10px'
                        }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px', fontSize: '14px' }}>
                                <span>üìÖ</span>
                                <span style={{ fontWeight: '600' }}>{group.day}</span>
                            </div>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px', fontSize: '14px' }}>
                                <span>üïê</span>
                                <span style={{ fontWeight: '600' }}>{group.time}</span>
                            </div>
                            {group.location && (
                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px', fontSize: '14px' }}>
                                    <span>üìç</span>
                                    <span>{group.location}</span>
                                </div>
                            )}
                            {group.link && (
                                <a
                                    href={group.link}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px',
                                        color: '#1976d2',
                                        textDecoration: 'none',
                                        fontSize: '14px',
                                        fontWeight: '500'
                                    }}
                                >
                                    <span>üîó</span>
                                    <span>Join Meeting</span>
                                </a>
                            )}
                        </div>

                        <div style={{ display: 'flex', gap: '8px' }}>
                            <button
                                onClick={async () => {
                                    await db.collection('supportGroups').doc(group.id).update({
                                        active: !group.active
                                    });
                                    loadCommunityData();
                                }}
                                style={{
                                    flex: 1,
                                    padding: '8px',
                                    background: group.active ? '#4CAF50' : '#6c757d',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '13px',
                                    fontWeight: '500'
                                }}
                            >
                                {group.active ? 'Active' : 'Inactive'}
                            </button>
                            <button
                                onClick={async () => {
                                    if (confirm('Delete this support group?')) {
                                        await db.collection('supportGroups').doc(group.id).delete();
                                        loadCommunityData();
                                    }
                                }}
                                style={{
                                    flex: 1,
                                    padding: '8px',
                                    background: '#f44336',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '13px',
                                    fontWeight: '500'
                                }}
                            >
                                Delete
                            </button>
                        </div>
                    </div>
                ))}
            </div>

            {supportGroups.length === 0 && (
                <div style={{
                    padding: '80px 20px',
                    textAlign: 'center',
                    background: 'white',
                    borderRadius: '15px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                }}>
                    <div style={{ fontSize: '64px', marginBottom: '20px' }}>ü§ù</div>
                    <div style={{ fontSize: '20px', fontWeight: '600', color: '#333', marginBottom: '10px' }}>
                        No Support Groups Yet
                    </div>
                    <div style={{ fontSize: '16px', color: '#999' }}>
                        Add support groups for PIRs to join
                    </div>
                </div>
            )}
        </div>
    );
}
// MEETINGS TAB
function MeetingsTab({ meetings, setShowCreateModal, setCreateType, setSelectedMeeting, setShowAttendanceModal, loadCommunityData }) {
    return (
        <div style={{ animation: 'fadeIn 0.5s' }}>
            <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                marginBottom: '20px'
            }}>
                <h3 style={{ margin: 0, color: '#333' }}>Group Meetings</h3>
                <button
                    onClick={() => {
                        setCreateType('meeting');
                        setShowCreateModal(true);
                    }}
                    style={{
                        padding: '10px 20px',
                        background: 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '10px',
                        cursor: 'pointer',
                        fontSize: '14px',
                        fontWeight: '600'
                    }}
                >
                    + Schedule Meeting
                </button>
            </div>

            <div style={{ display: 'grid', gap: '20px' }}>
                {meetings.map(meeting => (
                    <div key={meeting.id} style={{
                        background: 'white',
                        borderRadius: '15px',
                        padding: '25px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                        transition: 'all 0.2s'
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.transform = 'translateY(-2px)';
                        e.currentTarget.style.boxShadow = '0 8px 20px rgba(0,0,0,0.15)';
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
                    }}
                    >
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '15px' }}>
                            <div style={{ flex: 1 }}>
                                <h4 style={{ margin: '0 0 10px 0', color: '#333', fontSize: '20px' }}>
                                    {meeting.meetingTitle || 'Group Recovery Session'}
                                </h4>
                                <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap', marginBottom: '10px' }}>
                                    <span style={{
                                        padding: '4px 12px',
                                        background: meeting.status === 'completed' ? '#d4edda' :
                                                   meeting.status === 'scheduled' ? '#cfe2ff' :
                                                   meeting.status === 'cancelled' ? '#f8d7da' : '#e2e3e5',
                                        color: meeting.status === 'completed' ? '#155724' :
                                               meeting.status === 'scheduled' ? '#084298' :
                                               meeting.status === 'cancelled' ? '#721c24' : '#41464b',
                                        borderRadius: '20px',
                                        fontSize: '12px',
                                        fontWeight: '600',
                                        textTransform: 'uppercase'
                                    }}>
                                        {meeting.status}
                                    </span>
                                    <span style={{
                                        padding: '4px 12px',
                                        background: '#e3f2fd',
                                        color: '#1976d2',
                                        borderRadius: '20px',
                                        fontSize: '12px',
                                        fontWeight: '500'
                                    }}>
                                        {meeting.type || 'Group Session'}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div style={{
                            display: 'grid',
                            gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                            gap: '15px',
                            marginBottom: '15px',
                            padding: '15px',
                            background: '#f8f9fa',
                            borderRadius: '10px'
                        }}>
                            <div>
                                <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Date & Time</div>
                                <div style={{ fontSize: '14px', fontWeight: '600', color: '#333' }}>
                                    {formatDate(meeting.scheduledTime)}
                                </div>
                                <div style={{ fontSize: '13px', color: '#666' }}>
                                    {new Date(meeting.scheduledTime?.toDate ? meeting.scheduledTime.toDate() : meeting.scheduledTime).toLocaleTimeString()}
                                </div>
                            </div>
                            <div>
                                <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Duration</div>
                                <div style={{ fontSize: '14px', fontWeight: '600', color: '#333' }}>
                                    {meeting.duration || 60} minutes
                                </div>
                            </div>
                            {meeting.attendanceCount !== undefined && (
                                <div>
                                    <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Attendance</div>
                                    <div style={{ fontSize: '14px', fontWeight: '600', color: '#333' }}>
                                        {meeting.attendanceCount} recorded
                                    </div>
                                </div>
                            )}
                        </div>

                        {meeting.isGlobal ? (
                            <div style={{
                                padding: '12px',
                                background: '#e8f5e9',
                                borderRadius: '10px',
                                marginBottom: '15px'
                            }}>
                                <div style={{ fontSize: '14px', fontWeight: '600', color: '#2e7d32' }}>
                                    üåç All PIRs Invited
                                </div>
                            </div>
                        ) : meeting.pirNames && meeting.pirNames.length > 0 && (
                            <div style={{ marginBottom: '15px' }}>
                                <div style={{ fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '10px' }}>
                                    Participants ({meeting.pirNames.length})
                                </div>
                                <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                                    {meeting.pirNames.slice(0, 5).map((name, idx) => (
                                        <span key={idx} style={{
                                            padding: '6px 12px',
                                            background: '#e3f2fd',
                                            color: '#1976d2',
                                            borderRadius: '20px',
                                            fontSize: '13px'
                                        }}>
                                            {name}
                                        </span>
                                    ))}
                                    {meeting.pirNames.length > 5 && (
                                        <span style={{
                                            padding: '6px 12px',
                                            background: '#f0f0f0',
                                            color: '#666',
                                            borderRadius: '20px',
                                            fontSize: '13px',
                                            fontWeight: '600'
                                        }}>
                                            +{meeting.pirNames.length - 5} more
                                        </span>
                                    )}
                                </div>
                            </div>
                        )}

                        {meeting.meetingLink && (
                            <a
                                href={meeting.meetingLink}
                                target="_blank"
                                rel="noopener noreferrer"
                                style={{
                                    display: 'inline-flex',
                                    alignItems: 'center',
                                    gap: '8px',
                                    padding: '10px 16px',
                                    background: '#e3f2fd',
                                    color: '#1976d2',
                                    textDecoration: 'none',
                                    borderRadius: '8px',
                                    fontSize: '14px',
                                    fontWeight: '500',
                                    marginBottom: '15px'
                                }}
                            >
                                üîó Join Meeting
                            </a>
                        )}

                        {meeting.notes && (
                            <div style={{
                                padding: '12px',
                                background: '#fff3cd',
                                borderRadius: '10px',
                                marginBottom: '15px'
                            }}>
                                <div style={{ fontSize: '12px', fontWeight: '600', color: '#856404', marginBottom: '5px' }}>
                                    Notes
                                </div>
                                <div style={{ fontSize: '14px', color: '#856404' }}>
                                    {meeting.notes}
                                </div>
                            </div>
                        )}

                        <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                            <button
                                onClick={() => {
                                    setSelectedMeeting(meeting);
                                    setShowAttendanceModal(true);
                                }}
                                style={{
                                    padding: '8px 16px',
                                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '13px',
                                    fontWeight: '500'
                                }}
                            >
                                Attendance
                            </button>
                            <button
                                onClick={async () => {
                                    await db.collection('meetings').doc(meeting.id).update({
                                        status: 'completed',
                                        completedAt: firebase.firestore.FieldValue.serverTimestamp()
                                    });
                                    loadCommunityData();
                                }}
                                disabled={meeting.status === 'completed'}
                                style={{
                                    padding: '8px 16px',
                                    background: meeting.status === 'completed' ? '#ccc' : '#4CAF50',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: meeting.status === 'completed' ? 'not-allowed' : 'pointer',
                                    fontSize: '13px',
                                    fontWeight: '500'
                                }}
                            >
                                Mark Complete
                            </button>
                            <button
                                onClick={async () => {
                                    if (confirm('Cancel this meeting?')) {
                                        await db.collection('meetings').doc(meeting.id).update({
                                            status: 'cancelled'
                                        });
                                        loadCommunityData();
                                    }
                                }}
                                disabled={meeting.status === 'cancelled'}
                                style={{
                                    padding: '8px 16px',
                                    background: meeting.status === 'cancelled' ? '#ccc' : '#FFC107',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: meeting.status === 'cancelled' ? 'not-allowed' : 'pointer',
                                    fontSize: '13px',
                                    fontWeight: '500'
                                }}
                            >
                                Cancel
                            </button>
                            <button
                                onClick={async () => {
                                    if (confirm('Delete this meeting permanently?')) {
                                        await db.collection('meetings').doc(meeting.id).delete();
                                        loadCommunityData();
                                    }
                                }}
                                style={{
                                    padding: '8px 16px',
                                    background: '#f44336',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '13px',
                                    fontWeight: '500'
                                }}
                            >
                                Delete
                            </button>
                        </div>
                    </div>
                ))}
            </div>

            {meetings.length === 0 && (
                <div style={{
                    padding: '80px 20px',
                    textAlign: 'center',
                    background: 'white',
                    borderRadius: '15px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                }}>
                    <div style={{ fontSize: '64px', marginBottom: '20px' }}>üìÖ</div>
                    <div style={{ fontSize: '20px', fontWeight: '600', color: '#333', marginBottom: '10px' }}>
                        No Meetings Scheduled
                    </div>
                    <div style={{ fontSize: '16px', color: '#999' }}>
                        Schedule group meetings for PIRs
                    </div>
                </div>
            )}
        </div>
    );
}

// MODERATION TAB
function ModerationTab({ 
    flaggedMessages, 
    moderationHistory, 
    userWarnings, 
    moderationKeywords, 
    setModerationKeywords, 
    handleFlagResolve, 
    stats,
    exportData 
}) {
    const [newKeyword, setNewKeyword] = useState('');
    const [showKeywordManager, setShowKeywordManager] = useState(false);

    const handleAddKeyword = async () => {
        if (!newKeyword.trim()) return;
        
        try {
            const updated = [...moderationKeywords, newKeyword.toLowerCase()];
            await db.collection('settings').doc('moderation').set({
                keywords: updated
            });
            setModerationKeywords(updated);
            setNewKeyword('');
            alert('Keyword added');
        } catch (error) {
            console.error('Error adding keyword:', error);
        }
    };

    const handleRemoveKeyword = async (keyword) => {
        try {
            const updated = moderationKeywords.filter(k => k !== keyword);
            await db.collection('settings').doc('moderation').set({
                keywords: updated
            });
            setModerationKeywords(updated);
        } catch (error) {
            console.error('Error removing keyword:', error);
        }
    };

    return (
        <div style={{ animation: 'fadeIn 0.5s' }}>
            {/* Stats Row */}
            <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                gap: '20px',
                marginBottom: '30px'
            }}>
                <div style={{
                    background: 'linear-gradient(135deg, #f44336 0%, #e53935 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(244, 67, 54, 0.3)'
                }}>
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Flagged Messages</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {flaggedMessages.length}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Pending review</div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #FFC107 0%, #FFA000 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(255, 193, 7, 0.3)'
                }}>
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Total Warnings</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {Object.values(userWarnings).reduce((acc, warnings) => acc + warnings.length, 0)}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Issued to users</div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(102, 126, 234, 0.3)'
                }}>
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Moderation Actions</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {moderationHistory.length}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>All time</div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(79, 172, 254, 0.3)'
                }}>
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Blocked Keywords</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {moderationKeywords.length}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Auto-filtered</div>
                </div>
            </div>

            {/* Keyword Manager */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '25px',
                marginBottom: '20px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
                    <h3 style={{ margin: 0, color: '#333' }}>Keyword Filtering</h3>
                    <button
                        onClick={() => setShowKeywordManager(!showKeywordManager)}
                        style={{
                            padding: '8px 16px',
                            background: '#667eea',
                            color: 'white',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500'
                        }}
                    >
                        {showKeywordManager ? 'Hide' : 'Manage Keywords'}
                    </button>
                </div>

                {showKeywordManager && (
                    <>
                        <div style={{ display: 'flex', gap: '10px', marginBottom: '15px' }}>
                            <input
                                type="text"
                                placeholder="Add keyword to block..."
                                value={newKeyword}
                                onChange={(e) => setNewKeyword(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && handleAddKeyword()}
                                style={{
                                    flex: 1,
                                    padding: '10px 15px',
                                    border: '2px solid #e0e0e0',
                                    borderRadius: '8px',
                                    fontSize: '14px'
                                }}
                            />
                            <button
                                onClick={handleAddKeyword}
                                style={{
                                    padding: '10px 20px',
                                    background: '#4CAF50',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500'
                                }}
                            >
                                Add
                            </button>
                        </div>

                        <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                            {moderationKeywords.map(keyword => (
                                <div key={keyword} style={{
                                    padding: '6px 12px',
                                    background: '#ffebee',
                                    color: '#c62828',
                                    borderRadius: '20px',
                                    fontSize: '13px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px'
                                }}>
                                    <span>{keyword}</span>
                                    <button
                                        onClick={() => handleRemoveKeyword(keyword)}
                                        style={{
                                            background: 'none',
                                            border: 'none',
                                            color: '#c62828',
                                            cursor: 'pointer',
                                            fontSize: '16px',
                                            padding: 0,
                                            lineHeight: 1
                                        }}
                                    >
                                        √ó
                                    </button>
                                </div>
                            ))}
                            {moderationKeywords.length === 0 && (
                                <div style={{ color: '#999', fontSize: '14px' }}>
                                    No keywords set. Messages will not be auto-filtered.
                                </div>
                            )}
                        </div>
                    </>
                )}
            </div>

            {/* Flagged Messages */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '25px',
                marginBottom: '20px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                    <h3 style={{ margin: 0, color: '#333' }}>
                        Flagged Messages ({flaggedMessages.length})
                    </h3>
                    {flaggedMessages.length > 0 && (
                        <button
                            onClick={() => exportData('moderation', 'csv')}
                            style={{
                                padding: '8px 16px',
                                background: '#6c757d',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '500'
                            }}
                        >
                            Export Report
                        </button>
                    )}
                </div>

                {flaggedMessages.length > 0 ? (
                    <div style={{ display: 'grid', gap: '15px' }}>
                        {flaggedMessages.map(message => (
                            <div key={message.id} style={{
                                padding: '20px',
                                background: '#fff3cd',
                                border: '2px solid #f44336',
                                borderRadius: '10px'
                            }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px' }}>
                                    <div>
                                        <div style={{ fontWeight: '600', color: '#333' }}>
                                            {message.userName || 'Unknown User'}
                                        </div>
                                        <div style={{ fontSize: '12px', color: '#666' }}>
                                            {formatTimeAgo(message.flaggedAt)}
                                        </div>
                                    </div>
                                    <span style={{
                                        padding: '6px 12px',
                                        background: '#f44336',
                                        color: 'white',
                                        borderRadius: '20px',
                                        fontSize: '12px',
                                        fontWeight: '600'
                                    }}>
                                        FLAGGED
                                    </span>
                                </div>

                                <div style={{
                                    padding: '15px',
                                    background: 'white',
                                    borderRadius: '8px',
                                    marginBottom: '10px',
                                    color: '#333'
                                }}>
                                    {message.content}
                                </div>

                                {message.imageUrl && (
                                    <img
                                        src={message.imageUrl}
                                        alt="Flagged content"
                                        style={{
                                            maxWidth: '200px',
                                            borderRadius: '8px',
                                            marginBottom: '10px'
                                        }}
                                    />
                                )}

                                {message.flagReason && (
                                    <div style={{
                                        padding: '10px',
                                        background: 'rgba(244, 67, 54, 0.1)',
                                        borderRadius: '8px',
                                        fontSize: '14px',
                                        color: '#c62828',
                                        marginBottom: '10px'
                                    }}>
                                        <strong>Reason:</strong> {message.flagReason}
                                    </div>
                                )}

                                <div style={{ display: 'flex', gap: '10px' }}>
                                    <button
                                        onClick={() => handleFlagResolve(message.id, 'delete')}
                                        style={{
                                            padding: '8px 16px',
                                            background: '#f44336',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '8px',
                                            cursor: 'pointer',
                                            fontSize: '14px',
                                            fontWeight: '500'
                                        }}
                                    >
                                        Delete Message
                                    </button>
                                    <button
                                        onClick={() => handleFlagResolve(message.id, 'unflag')}
                                        style={{
                                            padding: '8px 16px',
                                            background: '#4CAF50',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '8px',
                                            cursor: 'pointer',
                                            fontSize: '14px',
                                            fontWeight: '500'
                                        }}
                                    >
                                        Unflag & Keep
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                ) : (
                    <div style={{
                        padding: '60px 20px',
                        textAlign: 'center',
                        color: '#999'
                    }}>
                        <div style={{ fontSize: '48px', marginBottom: '15px' }}>‚úÖ</div>
                        <div style={{ fontSize: '18px', fontWeight: '500', marginBottom: '8px' }}>
                            No Flagged Messages
                        </div>
                        <div style={{ fontSize: '14px' }}>
                            Community is clean!
                        </div>
                    </div>
                )}
            </div>

            {/* Moderation History */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '25px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <h3 style={{ margin: '0 0 20px 0', color: '#333' }}>
                    Recent Moderation Actions
                </h3>

                {moderationHistory.length > 0 ? (
                    <div style={{ display: 'grid', gap: '10px' }}>
                        {moderationHistory.slice(0, 20).map(action => (
                            <div key={action.id} style={{
                                padding: '15px',
                                background: '#f8f9fa',
                                borderRadius: '10px',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center'
                            }}>
                                <div>
                                    <div style={{ fontWeight: '600', color: '#333', marginBottom: '5px' }}>
                                        {action.action === 'delete' && 'üóëÔ∏è Message Deleted'}
                                        {action.action === 'warn' && '‚ö†Ô∏è User Warned'}
                                        {action.action === 'unflag' && '‚úÖ Message Unflagged'}
                                    </div>
                                    <div style={{ fontSize: '13px', color: '#666' }}>
                                        {formatTimeAgo(action.timestamp)}
                                        {action.reason && ` ‚Ä¢ ${action.reason}`}
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                ) : (
                    <div style={{ textAlign: 'center', padding: '40px', color: '#999' }}>
                        No moderation actions yet
                    </div>
                )}
            </div>
        </div>
    );
}
            // IMAGE MODAL
function ImageModal({ image, onClose }) {
    return (
        <div 
            onClick={onClose}
            style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0, 0, 0, 0.9)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 2000,
                cursor: 'pointer',
                animation: 'fadeIn 0.2s'
            }}
        >
            <img 
                src={image}
                alt="Full size"
                onClick={(e) => e.stopPropagation()}
                style={{
                    maxWidth: '90vw',
                    maxHeight: '90vh',
                    objectFit: 'contain',
                    borderRadius: '10px',
                    boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5)'
                }}
            />
            <button
                onClick={onClose}
                style={{
                    position: 'absolute',
                    top: '20px',
                    right: '20px',
                    background: 'rgba(255,255,255,0.2)',
                    border: 'none',
                    color: 'white',
                    fontSize: '32px',
                    width: '48px',
                    height: '48px',
                    borderRadius: '50%',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    backdropFilter: 'blur(10px)',
                    transition: 'background 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.3)'}
                onMouseLeave={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.2)'}
            >
                √ó
            </button>
        </div>
    );
}

// COMMUNITY CREATE MODAL - WITH RECURRING END OPTIONS
function CommunityCreateModal({ type, item, onSubmit, onClose, user }) {
    const [formData, setFormData] = useState(() => {
        if (item) {
            return {
                ...item,
                assignedPIRs: item.assignedPIRs || [],
                recurring: item.recurring || 'none',
                recurringEnd: item.recurringEnd || 'never',
                recurringCount: item.recurringCount || 10,
                recurringUntil: item.recurringUntil || ''
            };
        }
        
        if (type === 'room') {
            return {
                name: '',
                description: '',
                icon: 'üí¨',
                rules: ''
            };
        } else if (type === 'supportGroup') {
            return {
                name: '',
                type: 'AA',
                day: 'Monday',
                time: '',
                link: '',
                location: '',
                description: '',
                active: true
            };
        } else if (type === 'meeting') {
            return {
                meetingTitle: '',
                scheduledTime: '',
                type: 'Group Session',
                meetingLink: '',
                duration: '60',
                isGlobal: false,
                assignedPIRs: [],
                notes: '',
                sendReminder: true,
                status: 'scheduled',
                recurring: 'none',
                recurringEnd: 'never',
                recurringCount: 10,
                recurringUntil: ''
            };
        }
    });

    const [allPIRs, setAllPIRs] = useState([]);
    const [selectedPIRs, setSelectedPIRs] = useState(item?.assignedPIRs || []);
    const [loading, setLoading] = useState(true);

    const icons = ['üí¨', 'üéØ', 'üí™', 'üßò', 'üìñ', 'üåü', '‚ù§Ô∏è', 'üôè', 'üé®', 'üéµ'];

    useEffect(() => {
        if (type === 'meeting' || type === 'supportGroup') {
            loadPIRs();
        } else {
            setLoading(false);
        }
    }, []);

    const loadPIRs = async () => {
        try {
            const pirsSnap = await db.collection('users')
                .where('role', '==', 'pir')
                .where('active', '!=', false)
                .get();
            
            const pirsData = [];
            pirsSnap.forEach(doc => {
                const data = doc.data();
                pirsData.push({
                    id: doc.id,
                    name: data.displayName || `${data.firstName} ${data.lastName}` || data.email,
                    email: data.email
                });
            });
            setAllPIRs(pirsData);
        } catch (error) {
            console.error('Error loading PIRs:', error);
        } finally {
            setLoading(false);
        }
    };

    const handleSubmit = (e) => {
        e.preventDefault();
        
        if (type === 'room') {
            if (!formData.name || !formData.description) {
                alert('Please fill in all required fields');
                return;
            }
        } else if (type === 'supportGroup') {
            if (!formData.name || !formData.day || !formData.time) {
                alert('Please fill in all required fields');
                return;
            }
            
            const finalData = {
                ...formData,
                assignedPIRs: selectedPIRs
            };
            
            onSubmit(finalData);
            return;
        } else if (type === 'meeting') {
            if (!formData.meetingTitle || !formData.scheduledTime) {
                alert('Please provide a meeting title and scheduled time');
                return;
            }
            
            // Validate recurring end options
            if (formData.recurring !== 'none') {
                if (formData.recurringEnd === 'count' && (!formData.recurringCount || formData.recurringCount < 1)) {
                    alert('Please specify how many times the meeting should repeat');
                    return;
                }
                if (formData.recurringEnd === 'until' && !formData.recurringUntil) {
                    alert('Please specify when the recurring meetings should end');
                    return;
                }
            }
            
            const scheduledDate = new Date(formData.scheduledTime);
            const dateStr = scheduledDate.toISOString().split('T')[0];
            const timeStr = formData.scheduledTime.split('T')[1];
            
            const finalData = {
                ...formData,
                scheduledTime: firebase.firestore.Timestamp.fromDate(scheduledDate),
                assignedPIRs: formData.isGlobal ? [] : selectedPIRs,
                date: dateStr,
                time: timeStr,
                title: formData.meetingTitle,
                description: formData.notes || ''
            };
            
            onSubmit(finalData);
            return;
        }
        
        onSubmit(formData);
    };

    const handlePIRSelection = (pirId) => {
        if (selectedPIRs.includes(pirId)) {
            setSelectedPIRs(selectedPIRs.filter(id => id !== pirId));
        } else {
            setSelectedPIRs([...selectedPIRs, pirId]);
        }
    };

    const selectAllPIRs = () => {
        setSelectedPIRs(allPIRs.map(pir => pir.id));
    };

    const clearSelection = () => {
        setSelectedPIRs([]);
    };

    const getCurrentDateTime = () => {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        return now.toISOString().slice(0, 16);
    };

    const getMinRecurringEndDate = () => {
        if (!formData.scheduledTime) return '';
        const scheduledDate = new Date(formData.scheduledTime);
        scheduledDate.setDate(scheduledDate.getDate() + 1); // At least 1 day after start
        return scheduledDate.toISOString().split('T')[0];
    };

    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1500,
            padding: '20px',
            animation: 'fadeIn 0.2s'
        }}>
            <div style={{
                background: 'white',
                borderRadius: '20px',
                maxWidth: '700px',
                width: '100%',
                maxHeight: '90vh',
                overflow: 'auto',
                boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
                animation: 'slideUp 0.3s'
            }}>
                {/* Header */}
                <div style={{
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    padding: '25px 30px',
                    borderRadius: '20px 20px 0 0',
                    color: 'white',
                    position: 'sticky',
                    top: 0,
                    zIndex: 1
                }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <h3 style={{ margin: 0, fontSize: '24px' }}>
                            {item ? 'Edit' : 'Create'} {
                                type === 'room' ? 'Topic Room' :
                                type === 'supportGroup' ? 'Support Group' :
                                'Group Meeting'
                            }
                        </h3>
                        <button 
                            onClick={onClose}
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                border: 'none',
                                color: 'white',
                                fontSize: '24px',
                                width: '36px',
                                height: '36px',
                                borderRadius: '50%',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center'
                            }}
                        >
                            √ó
                        </button>
                    </div>
                </div>

                {/* Form Content */}
                <form onSubmit={handleSubmit} style={{ padding: '30px' }}>
                    {/* TIMEZONE BANNER */}
                    {(type === 'meeting' || type === 'supportGroup') && (
                        <div style={{
                            marginBottom: '25px',
                            padding: '15px 20px',
                            background: 'linear-gradient(135deg, #667eea15 0%, #764ba215 100%)',
                            border: '2px solid #667eea',
                            borderRadius: '12px',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '12px'
                        }}>
                            <span style={{ fontSize: '24px' }}>üïê</span>
                            <div>
                                <div style={{ fontWeight: '600', color: '#667eea', fontSize: '15px', marginBottom: '4px' }}>
                                    Pacific Time Zone (PT)
                                </div>
                                <div style={{ fontSize: '13px', color: '#666' }}>
                                    All times are in Pacific Time. Calendar events will be created in PT timezone.
                                </div>
                            </div>
                        </div>
                    )}

                    {type === 'room' && (
                        <>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Room Name *
                                </label>
                                <input
                                    type="text"
                                    value={formData.name}
                                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                                    placeholder="e.g., Daily Reflections"
                                    required
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px'
                                    }}
                                />
                            </div>

                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Description *
                                </label>
                                <textarea
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                    placeholder="What is this room about?"
                                    rows="3"
                                    required
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px',
                                        fontFamily: 'inherit',
                                        resize: 'vertical'
                                    }}
                                />
                            </div>

                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Icon
                                </label>
                                <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                                    {icons.map(icon => (
                                        <button
                                            key={icon}
                                            type="button"
                                            onClick={() => setFormData({...formData, icon})}
                                            style={{
                                                padding: '10px 15px',
                                                background: formData.icon === icon ? '#e3f2fd' : '#f0f0f0',
                                                border: formData.icon === icon ? '2px solid #1976d2' : '2px solid transparent',
                                                borderRadius: '8px',
                                                cursor: 'pointer',
                                                fontSize: '24px',
                                                transition: 'all 0.2s'
                                            }}
                                        >
                                            {icon}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Room Rules (optional)
                                </label>
                                <textarea
                                    value={formData.rules}
                                    onChange={(e) => setFormData({...formData, rules: e.target.value})}
                                    placeholder="Any specific guidelines for this room?"
                                    rows="2"
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px',
                                        fontFamily: 'inherit',
                                        resize: 'vertical'
                                    }}
                                />
                            </div>
                        </>
                    )}

                    {type === 'supportGroup' && (
                        <>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Group Name *
                                </label>
                                <input
                                    type="text"
                                    value={formData.name}
                                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                                    placeholder="e.g., Wednesday Night NA Meeting"
                                    required
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px'
                                    }}
                                />
                            </div>
                            
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px', marginBottom: '20px' }}>
                                <div>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        Type *
                                    </label>
                                    <select
                                        value={formData.type}
                                        onChange={(e) => setFormData({...formData, type: e.target.value})}
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '10px',
                                            fontSize: '14px',
                                            background: 'white'
                                        }}
                                    >
                                        <option value="AA">AA</option>
                                        <option value="NA">NA</option>
                                        <option value="Al-Anon">Al-Anon</option>
                                        <option value="SMART">SMART Recovery</option>
                                        <option value="Celebrate Recovery">Celebrate Recovery</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        Day *
                                    </label>
                                    <select
                                        value={formData.day}
                                        onChange={(e) => setFormData({...formData, day: e.target.value})}
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '10px',
                                            fontSize: '14px',
                                            background: 'white'
                                        }}
                                    >
                                        <option value="Monday">Monday</option>
                                        <option value="Tuesday">Tuesday</option>
                                        <option value="Wednesday">Wednesday</option>
                                        <option value="Thursday">Thursday</option>
                                        <option value="Friday">Friday</option>
                                        <option value="Saturday">Saturday</option>
                                        <option value="Sunday">Sunday</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Time (PT) *
                                </label>
                                <input
                                    type="time"
                                    value={formData.time}
                                    onChange={(e) => setFormData({...formData, time: e.target.value})}
                                    required
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px'
                                    }}
                                />
                            </div>
                            
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Meeting Link (for virtual meetings)
                                </label>
                                <input
                                    type="url"
                                    value={formData.link}
                                    onChange={(e) => setFormData({...formData, link: e.target.value})}
                                    placeholder="https://zoom.us/j/..."
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px'
                                    }}
                                />
                            </div>
                            
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Location (for in-person meetings)
                                </label>
                                <input
                                    type="text"
                                    value={formData.location || ''}
                                    onChange={(e) => setFormData({...formData, location: e.target.value})}
                                    placeholder="e.g., Community Center, 123 Main St"
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px'
                                    }}
                                />
                            </div>
                            
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Description
                                </label>
                                <textarea
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                    placeholder="Additional details about this support group"
                                    rows="3"
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px',
                                        fontFamily: 'inherit',
                                        resize: 'vertical'
                                    }}
                                />
                            </div>

                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Assign PIRs to This Support Group
                                </label>
                                <div style={{
                                    marginBottom: '10px',
                                    padding: '10px 12px',
                                    background: '#f0f9ff',
                                    borderRadius: '8px',
                                    fontSize: '13px',
                                    color: '#0369a1'
                                }}>
                                    ‚ÑπÔ∏è Selected PIRs will have this support group added to their calendars
                                </div>
                                <div style={{ display: 'flex', gap: '10px', marginBottom: '10px' }}>
                                    <button 
                                        type="button"
                                        onClick={selectAllPIRs}
                                        style={{
                                            padding: '6px 12px',
                                            background: '#667eea',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            fontWeight: '500'
                                        }}
                                    >
                                        Select All
                                    </button>
                                    <button 
                                        type="button"
                                        onClick={clearSelection}
                                        style={{
                                            padding: '6px 12px',
                                            background: '#6c757d',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            fontWeight: '500'
                                        }}
                                    >
                                        Clear All
                                    </button>
                                    <span style={{ fontSize: '13px', color: '#666', lineHeight: '32px' }}>
                                        {selectedPIRs.length} selected
                                    </span>
                                </div>
                                <div style={{
                                    maxHeight: '200px',
                                    overflowY: 'auto',
                                    border: '2px solid #e0e0e0',
                                    borderRadius: '10px',
                                    padding: '10px'
                                }}>
                                    {loading ? (
                                        <div style={{ textAlign: 'center', padding: '20px', color: '#999' }}>
                                            Loading PIRs...
                                        </div>
                                    ) : allPIRs.length > 0 ? (
                                        allPIRs.map(pir => (
                                            <label key={pir.id} style={{
                                                display: 'block',
                                                padding: '8px',
                                                cursor: 'pointer',
                                                background: selectedPIRs.includes(pir.id) ? '#e3f2fd' : 'transparent',
                                                borderRadius: '6px',
                                                marginBottom: '4px',
                                                transition: 'background 0.2s'
                                            }}>
                                                <input
                                                    type="checkbox"
                                                    checked={selectedPIRs.includes(pir.id)}
                                                    onChange={() => handlePIRSelection(pir.id)}
                                                    style={{ marginRight: '10px', width: '16px', height: '16px', cursor: 'pointer' }}
                                                />
                                                <span style={{ fontSize: '14px' }}>
                                                    {pir.name} <span style={{ color: '#999', fontSize: '12px' }}>({pir.email})</span>
                                                </span>
                                            </label>
                                        ))
                                    ) : (
                                        <div style={{ color: '#999', textAlign: 'center', padding: '20px' }}>
                                            No PIRs available
                                        </div>
                                    )}
                                </div>
                            </div>
                        </>
                    )}

                    {type === 'meeting' && (
                        <>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Meeting Title *
                                </label>
                                <input
                                    type="text"
                                    value={formData.meetingTitle}
                                    onChange={(e) => setFormData({...formData, meetingTitle: e.target.value})}
                                    placeholder="e.g., Weekly Progress Review, Drop-In Hours"
                                    required
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px'
                                    }}
                                />
                            </div>
                            
                            <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr', gap: '15px', marginBottom: '20px' }}>
                                <div>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        Date & Time (PT) *
                                    </label>
                                    <input
                                        type="datetime-local"
                                        value={formData.scheduledTime}
                                        onChange={(e) => setFormData({...formData, scheduledTime: e.target.value})}
                                        min={getCurrentDateTime()}
                                        required
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '10px',
                                            fontSize: '14px'
                                        }}
                                    />
                                </div>
                                
                                <div>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        Duration
                                    </label>
                                    <select
                                        value={formData.duration}
                                        onChange={(e) => setFormData({...formData, duration: e.target.value})}
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '10px',
                                            fontSize: '14px',
                                            background: 'white'
                                        }}
                                    >
                                        <option value="30">30 min</option>
                                        <option value="60">60 min</option>
                                        <option value="90">90 min</option>
                                        <option value="120">2 hours</option>
                                    </select>
                                </div>
                            </div>

                            {/* RECURRING OPTIONS */}
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Recurring Schedule
                                </label>
                                <select
                                    value={formData.recurring}
                                    onChange={(e) => setFormData({...formData, recurring: e.target.value})}
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px',
                                        background: 'white'
                                    }}
                                >
                                    <option value="none">One-time meeting</option>
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>

                            {/* RECURRING END OPTIONS - NEW! */}
                            {formData.recurring !== 'none' && (
                                <div style={{ 
                                    marginBottom: '20px',
                                    padding: '20px',
                                    background: '#f8f9fa',
                                    borderRadius: '12px',
                                    border: '2px solid #e0e0e0'
                                }}>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '12px' }}>
                                        When should this recurring meeting end?
                                    </label>
                                    
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                        {/* After X occurrences */}
                                        <label style={{ display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer' }}>
                                            <input
                                                type="radio"
                                                name="recurringEnd"
                                                value="count"
                                                checked={formData.recurringEnd === 'count'}
                                                onChange={(e) => setFormData({...formData, recurringEnd: e.target.value})}
                                                style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                            />
                                            <span style={{ fontSize: '14px', fontWeight: '500', color: '#333' }}>
                                                After
                                            </span>
                                            <select
                                                value={formData.recurringCount}
                                                onChange={(e) => setFormData({...formData, recurringEnd: 'count', recurringCount: e.target.value})}
                                                disabled={formData.recurringEnd !== 'count'}
                                                style={{
                                                    padding: '8px 12px',
                                                    border: '2px solid #e0e0e0',
                                                    borderRadius: '8px',
                                                    fontSize: '14px',
                                                    background: 'white',
                                                    cursor: formData.recurringEnd !== 'count' ? 'not-allowed' : 'pointer',
                                                    opacity: formData.recurringEnd !== 'count' ? 0.5 : 1
                                                }}
                                            >
                                                <option value="5">5</option>
                                                <option value="10">10</option>
                                                <option value="15">15</option>
                                                <option value="20">20</option>
                                                <option value="25">25</option>
                                                <option value="30">30</option>
                                            </select>
                                            <span style={{ fontSize: '14px', fontWeight: '500', color: '#333' }}>
                                                occurrences
                                            </span>
                                        </label>

                                        {/* Until specific date */}
                                        <label style={{ display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer' }}>
                                            <input
                                                type="radio"
                                                name="recurringEnd"
                                                value="until"
                                                checked={formData.recurringEnd === 'until'}
                                                onChange={(e) => setFormData({...formData, recurringEnd: e.target.value})}
                                                style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                            />
                                            <span style={{ fontSize: '14px', fontWeight: '500', color: '#333' }}>
                                                Until
                                            </span>
                                            <input
                                                type="date"
                                                value={formData.recurringUntil}
                                                onChange={(e) => setFormData({...formData, recurringEnd: 'until', recurringUntil: e.target.value})}
                                                min={getMinRecurringEndDate()}
                                                disabled={formData.recurringEnd !== 'until'}
                                                style={{
                                                    padding: '8px 12px',
                                                    border: '2px solid #e0e0e0',
                                                    borderRadius: '8px',
                                                    fontSize: '14px',
                                                    cursor: formData.recurringEnd !== 'until' ? 'not-allowed' : 'pointer',
                                                    opacity: formData.recurringEnd !== 'until' ? 0.5 : 1
                                                }}
                                            />
                                        </label>

                                        {/* Never (infinite) */}
                                        <label style={{ display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer' }}>
                                            <input
                                                type="radio"
                                                name="recurringEnd"
                                                value="never"
                                                checked={formData.recurringEnd === 'never'}
                                                onChange={(e) => setFormData({...formData, recurringEnd: e.target.value})}
                                                style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                            />
                                            <span style={{ fontSize: '14px', fontWeight: '500', color: '#333' }}>
                                                Never (infinite)
                                            </span>
                                        </label>
                                    </div>

                                    {/* Warning for "Never" */}
                                    {formData.recurringEnd === 'never' && (
                                        <div style={{
                                            marginTop: '12px',
                                            padding: '12px',
                                            background: '#fff3cd',
                                            border: '2px solid #ffc107',
                                            borderRadius: '8px',
                                            fontSize: '13px',
                                            color: '#856404',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '8px'
                                        }}>
                                            <span>‚ö†Ô∏è</span>
                                            <span>This meeting will repeat forever until manually deleted. Consider setting an end date or occurrence limit.</span>
                                        </div>
                                    )}

                                    {/* Info for selected option */}
                                    {formData.recurringEnd === 'count' && formData.recurringCount && (
                                        <div style={{
                                            marginTop: '12px',
                                            padding: '10px 12px',
                                            background: '#f0f9ff',
                                            borderRadius: '8px',
                                            fontSize: '13px',
                                            color: '#0369a1'
                                        }}>
                                            ‚ÑπÔ∏è This meeting will repeat {formData.recurring} {formData.recurringCount} times
                                        </div>
                                    )}

                                    {formData.recurringEnd === 'until' && formData.recurringUntil && (
                                        <div style={{
                                            marginTop: '12px',
                                            padding: '10px 12px',
                                            background: '#f0f9ff',
                                            borderRadius: '8px',
                                            fontSize: '13px',
                                            color: '#0369a1'
                                        }}>
                                            ‚ÑπÔ∏è This meeting will repeat {formData.recurring} until {new Date(formData.recurringUntil).toLocaleDateString()}
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Meeting Type
                                </label>
                                <select
                                    value={formData.type}
                                    onChange={(e) => setFormData({...formData, type: e.target.value})}
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px',
                                        background: 'white'
                                    }}
                                >
                                    <option value="Group Session">Group Session</option>
                                    <option value="Progress Review">Progress Review</option>
                                    <option value="Educational">Educational</option>
                                    <option value="Group Therapy">Group Therapy</option>
                                    <option value="Special Topic">Special Topic</option>
                                    <option value="Check-in">Check-in</option>
                                </select>
                            </div>
                            
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Meeting Link
                                </label>
                                <input
                                    type="url"
                                    value={formData.meetingLink}
                                    onChange={(e) => setFormData({...formData, meetingLink: e.target.value})}
                                    placeholder={user?.googleConnected ? "Will auto-generate Google Meet link" : "https://zoom.us/j/..."}
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px'
                                    }}
                                />
                                {user?.googleConnected ? (
                                    <div style={{
                                        marginTop: '8px',
                                        padding: '10px 12px',
                                        background: '#f0fdf4',
                                        borderRadius: '8px',
                                        fontSize: '13px',
                                        color: '#166534',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px'
                                    }}>
                                        <span>‚úì</span>
                                        <span>Google Meet link will be generated automatically when you save</span>
                                    </div>
                                ) : (
                                    <div style={{
                                        marginTop: '8px',
                                        padding: '10px 12px',
                                        background: '#fef9c3',
                                        borderRadius: '8px',
                                        fontSize: '13px',
                                        color: '#854d0e',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px'
                                    }}>
                                        <span>‚ö†Ô∏è</span>
                                        <span>Connect Google Services in your Profile to auto-generate Meet links</span>
                                    </div>
                                )}
                            </div>
                            
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer' }}>
                                    <input
                                        type="checkbox"
                                        checked={formData.isGlobal}
                                        onChange={(e) => setFormData({...formData, isGlobal: e.target.checked})}
                                        style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                    />
                                    <span style={{ fontSize: '14px', fontWeight: '500', color: '#333' }}>
                                        Invite all PIRs (Global Meeting / Drop-In Hours)
                                    </span>
                                </label>
                            </div>
                            
                            {!formData.isGlobal && (
                                <div style={{ marginBottom: '20px' }}>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        Select PIRs to Invite
                                    </label>
                                    <div style={{ display: 'flex', gap: '10px', marginBottom: '10px' }}>
                                        <button 
                                            type="button"
                                            onClick={selectAllPIRs}
                                            style={{
                                                padding: '6px 12px',
                                                background: '#667eea',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '6px',
                                                cursor: 'pointer',
                                                fontSize: '13px',
                                                fontWeight: '500'
                                            }}
                                        >
                                            Select All
                                        </button>
                                        <button 
                                            type="button"
                                            onClick={clearSelection}
                                            style={{
                                                padding: '6px 12px',
                                                background: '#6c757d',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '6px',
                                                cursor: 'pointer',
                                                fontSize: '13px',
                                                fontWeight: '500'
                                            }}
                                        >
                                            Clear All
                                        </button>
                                        <span style={{ fontSize: '13px', color: '#666', lineHeight: '32px' }}>
                                            {selectedPIRs.length} selected
                                        </span>
                                    </div>
                                    <div style={{
                                        maxHeight: '200px',
                                        overflowY: 'auto',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        padding: '10px'
                                    }}>
                                        {loading ? (
                                            <div style={{ textAlign: 'center', padding: '20px', color: '#999' }}>
                                                Loading PIRs...
                                            </div>
                                        ) : allPIRs.length > 0 ? (
                                            allPIRs.map(pir => (
                                                <label key={pir.id} style={{
                                                    display: 'block',
                                                    padding: '8px',
                                                    cursor: 'pointer',
                                                    background: selectedPIRs.includes(pir.id) ? '#e3f2fd' : 'transparent',
                                                    borderRadius: '6px',
                                                    marginBottom: '4px',
                                                    transition: 'background 0.2s'
                                                }}>
                                                    <input
                                                        type="checkbox"
                                                        checked={selectedPIRs.includes(pir.id)}
                                                        onChange={() => handlePIRSelection(pir.id)}
                                                        style={{ marginRight: '10px', width: '16px', height: '16px', cursor: 'pointer' }}
                                                    />
                                                    <span style={{ fontSize: '14px' }}>
                                                        {pir.name} <span style={{ color: '#999', fontSize: '12px' }}>({pir.email})</span>
                                                    </span>
                                                </label>
                                            ))
                                        ) : (
                                            <div style={{ color: '#999', textAlign: 'center', padding: '20px' }}>
                                                No PIRs available
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                            
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Meeting Notes
                                </label>
                                <textarea
                                    value={formData.notes}
                                    onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                    placeholder="Topics to cover, preparation needed, etc."
                                    rows="3"
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px',
                                        fontFamily: 'inherit',
                                        resize: 'vertical'
                                    }}
                                />
                            </div>
                        </>
                    )}
                    
                    <div style={{ display: 'flex', gap: '10px', marginTop: '25px' }}>
                        <button
                            type="button"
                            onClick={onClose}
                            style={{
                                flex: 1,
                                padding: '12px',
                                background: '#6c757d',
                                color: 'white',
                                border: 'none',
                                borderRadius: '10px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '600'
                            }}
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            style={{
                                flex: 2,
                                padding: '12px',
                                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '10px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '600'
                            }}
                        >
                            {item ? 'Update' : 'Create'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
}

// ATTENDANCE MODAL
function AttendanceModal({ meeting, onClose, handleRecordAttendance }) {
    const [attendanceData, setAttendanceData] = useState({});
    const [loading, setLoading] = useState(true);
    const [participants, setParticipants] = useState([]);

    useEffect(() => {
        loadAttendance();
    }, []);

    const loadAttendance = async () => {
        try {
            // Load PIRs
            let pirIds = meeting.assignedPIRs || [];
            
            if (meeting.isGlobal) {
                const pirsSnap = await db.collection('users')
                    .where('role', '==', 'pir')
                    .get();
                pirIds = pirsSnap.docs.map(doc => doc.id);
            }

            const pirData = [];
            for (const pirId of pirIds) {
                const pirDoc = await db.collection('users').doc(pirId).get();
                if (pirDoc.exists) {
                    const data = pirDoc.data();
                    pirData.push({
                        id: pirId,
                        name: data.displayName || data.email
                    });
                }
            }
            setParticipants(pirData);

            // Load existing attendance
            const attendanceSnap = await db.collection('meetingAttendance')
                .where('meetingId', '==', meeting.id)
                .get();

            const attendance = {};
            attendanceSnap.forEach(doc => {
                const data = doc.data();
                attendance[data.pirId] = data.status;
            });
            setAttendanceData(attendance);

        } catch (error) {
            console.error('Error loading attendance:', error);
        } finally {
            setLoading(false);
        }
    };

    const handleStatusChange = async (pirId, status) => {
        try {
            await handleRecordAttendance(meeting.id, pirId, status);
            setAttendanceData(prev => ({ ...prev, [pirId]: status }));
        } catch (error) {
            console.error('Error updating attendance:', error);
        }
    };

    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1500,
            padding: '20px',
            animation: 'fadeIn 0.2s'
        }}>
            <div style={{
                background: 'white',
                borderRadius: '20px',
                maxWidth: '600px',
                width: '100%',
                maxHeight: '90vh',
                overflow: 'auto',
                boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
                animation: 'slideUp 0.3s'
            }}>
                {/* Header */}
                <div style={{
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    padding: '25px 30px',
                    borderRadius: '20px 20px 0 0',
                    color: 'white',
                    position: 'sticky',
                    top: 0,
                    zIndex: 1
                }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div>
                            <h3 style={{ margin: '0 0 5px 0', fontSize: '24px' }}>Meeting Attendance</h3>
                            <div style={{ fontSize: '14px', opacity: 0.9 }}>
                                {meeting.meetingTitle}
                            </div>
                        </div>
                        <button 
                            onClick={onClose}
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                border: 'none',
                                color: 'white',
                                fontSize: '24px',
                                width: '36px',
                                height: '36px',
                                borderRadius: '50%',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center'
                            }}
                        >
                            √ó
                        </button>
                    </div>
                </div>

                {/* Content */}
                <div style={{ padding: '30px' }}>
                    {loading ? (
                        <div style={{ textAlign: 'center', padding: '40px', color: '#999' }}>
                            Loading participants...
                        </div>
                    ) : participants.length > 0 ? (
                        <div style={{ display: 'grid', gap: '12px' }}>
                            {participants.map(pir => (
                                <div key={pir.id} style={{
                                    padding: '15px',
                                    background: '#f8f9fa',
                                    borderRadius: '10px',
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center'
                                }}>
                                    <div style={{ fontWeight: '600', color: '#333' }}>
                                        {pir.name}
                                    </div>
                                    <div style={{ display: 'flex', gap: '8px' }}>
                                        <button
                                            onClick={() => handleStatusChange(pir.id, 'present')}
                                            style={{
                                                padding: '6px 12px',
                                                background: attendanceData[pir.id] === 'present' ? '#4CAF50' : 'white',
                                                color: attendanceData[pir.id] === 'present' ? 'white' : '#333',
                                                border: '2px solid #4CAF50',
                                                borderRadius: '6px',
                                                cursor: 'pointer',
                                                fontSize: '13px',
                                                fontWeight: '500'
                                            }}
                                        >
                                            Present
                                        </button>
                                        <button
                                            onClick={() => handleStatusChange(pir.id, 'absent')}
                                            style={{
                                                padding: '6px 12px',
                                                background: attendanceData[pir.id] === 'absent' ? '#f44336' : 'white',
                                                color: attendanceData[pir.id] === 'absent' ? 'white' : '#333',
                                                border: '2px solid #f44336',
                                                borderRadius: '6px',
                                                cursor: 'pointer',
                                                fontSize: '13px',
                                                fontWeight: '500'
                                            }}
                                        >
                                            Absent
                                        </button>
                                        <button
                                            onClick={() => handleStatusChange(pir.id, 'excused')}
                                            style={{
                                                padding: '6px 12px',
                                                background: attendanceData[pir.id] === 'excused' ? '#FFC107' : 'white',
                                                color: attendanceData[pir.id] === 'excused' ? 'white' : '#333',
                                                border: '2px solid #FFC107',
                                                borderRadius: '6px',
                                                cursor: 'pointer',
                                                fontSize: '13px',
                                                fontWeight: '500'
                                            }}
                                        >
                                            Excused
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div style={{ textAlign: 'center', padding: '40px', color: '#999' }}>
                            No participants for this meeting
                        </div>
                    )}

                    <button
                        onClick={onClose}
                        style={{
                            width: '100%',
                            marginTop: '20px',
                            padding: '12px',
                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            color: 'white',
                            border: 'none',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '600'
                        }}
                    >
                        Done
                    </button>
                </div>
            </div>
        </div>
    );
}
     // PIR-Centric Goals & Objectives Management View with Enhanced UI - FIXED VERSION
function GoalsView({ searchQuery, user }) {
    const [selectedPIR, setSelectedPIR] = useState(null);
    const [pirs, setPirs] = useState([]);
    const [loading, setLoading] = useState(true);
    const [expandedGoals, setExpandedGoals] = useState(new Set());
    const [expandedObjectives, setExpandedObjectives] = useState(new Set());
    const [showCreateModal, setShowCreateModal] = useState(false);
    const [modalType, setModalType] = useState('');
    const [selectedParent, setSelectedParent] = useState(null);
    const [pirGoalsData, setPirGoalsData] = useState({
        goals: [],
        objectives: [],
        assignments: [],
        milestones: [],
        customMilestones: []
    });
    const [activeTab, setActiveTab] = useState('overview');

    useEffect(() => {
        loadPIRsWithStats();
    }, []);

    useEffect(() => {
        if (selectedPIR) {
            loadPIRGoalsData(selectedPIR.id);
        }
    }, [selectedPIR]);

    const loadPIRsWithStats = async () => {
        try {
            setLoading(true);
            const pirsSnap = await db.collection('users')
                .where('role', '==', 'pir')
                .where('active', '!=', false)
                .get();
            
            const pirsData = [];
            
            for (const doc of pirsSnap.docs) {
                const pirData = { id: doc.id, ...doc.data() };
                
                // Get ALL goals (both active and completed) for stats
                const goalsSnap = await db.collection('goals')
                    .where('userId', '==', doc.id)
                    .get();
                
                let totalProgress = 0;
                let overdueCount = 0;
                let nearCompletion = 0;
                let activeGoalsCount = 0;
                let completedGoalsCount = 0;
                
                for (const goalDoc of goalsSnap.docs) {
                    const goalData = goalDoc.data();
                    if (goalData.status === 'active') activeGoalsCount++;
                    if (goalData.status === 'completed') completedGoalsCount++;
                    
                    // Get assignments for this goal
                    const assignmentsSnap = await db.collection('assignments')
                        .where('goalId', '==', goalDoc.id)
                        .get();
                    
                    let completed = 0;
                    let total = assignmentsSnap.size;
                    
                    assignmentsSnap.forEach(assignDoc => {
                        const assignment = assignDoc.data();
                        if (assignment.status === 'completed') completed++;
                        if (assignment.dueDate && new Date(assignment.dueDate.toDate()) < new Date() && assignment.status !== 'completed') {
                            overdueCount++;
                        }
                    });
                    
                    const goalProgress = total > 0 ? (completed / total) * 100 : 0;
                    totalProgress += goalProgress;
                    if (goalProgress >= 80 && goalData.status === 'active') nearCompletion++;
                }
                
                pirData.activeGoals = activeGoalsCount;
                pirData.completedGoals = completedGoalsCount;
                pirData.totalGoals = goalsSnap.size;
                pirData.overallProgress = goalsSnap.size > 0 ? Math.round(totalProgress / goalsSnap.size) : 0;
                pirData.overdueAssignments = overdueCount;
                pirData.nearCompletion = nearCompletion;
                
                pirsData.push(pirData);
            }
            
            setPirs(pirsData);
        } catch (error) {
            console.error('Error loading PIRs:', error);
        } finally {
            setLoading(false);
        }
    };

    const loadPIRGoalsData = async (pirId) => {
        try {
            setLoading(true);
            
            // Get ALL goals, not just active ones
            const goalsSnap = await db.collection('goals')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .get();

            const goalsData = [];
            const objectivesData = [];
            const assignmentsData = [];

            for (const goalDoc of goalsSnap.docs) {
                const goalData = { id: goalDoc.id, ...goalDoc.data() };
                
                // Get ALL objectives for this goal
                const objectivesSnap = await db.collection('objectives')
                    .where('goalId', '==', goalDoc.id)
                    .orderBy('order', 'asc')
                    .get();
                
                let goalAssignments = 0;
                let completedAssignments = 0;
                
                for (const objDoc of objectivesSnap.docs) {
                    const objData = { id: objDoc.id, ...objDoc.data() };
                    objectivesData.push(objData);
                    
                    // Get ALL assignments for this objective
                    const assignmentsSnap = await db.collection('assignments')
                        .where('objectiveId', '==', objDoc.id)
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    assignmentsSnap.forEach(assignDoc => {
                        const assignData = { id: assignDoc.id, ...assignDoc.data() };
                        assignmentsData.push(assignData);
                        goalAssignments++;
                        if (assignData.status === 'completed') completedAssignments++;
                    });
                }
                
                goalData.progress = goalAssignments > 0 
                    ? Math.round((completedAssignments / goalAssignments) * 100)
                    : 0;
                
                goalsData.push(goalData);
            }

            const recoveryMilestones = getRecoveryMilestones(selectedPIR.sobrietyDate);
            
            const customMilestonesSnap = await db.collection('milestones')
                .where('userId', '==', pirId)
                .where('type', '==', 'custom')
                .orderBy('targetDate', 'asc')
                .get();
            
            const customMilestonesData = [];
            customMilestonesSnap.forEach(doc => {
                customMilestonesData.push({ id: doc.id, ...doc.data() });
            });

            setPirGoalsData({
                goals: goalsData,
                objectives: objectivesData,
                assignments: assignmentsData,
                milestones: recoveryMilestones,
                customMilestones: customMilestonesData
            });

        } catch (error) {
            console.error('Error loading PIR goals:', error);
        } finally {
            setLoading(false);
        }
    };

  
    const toggleGoalExpand = (goalId) => {
        const newExpanded = new Set(expandedGoals);
        if (newExpanded.has(goalId)) {
            newExpanded.delete(goalId);
        } else {
            newExpanded.add(goalId);
        }
        setExpandedGoals(newExpanded);
    };

    const toggleObjectiveExpand = (objId) => {
        const newExpanded = new Set(expandedObjectives);
        if (newExpanded.has(objId)) {
            newExpanded.delete(objId);
        } else {
            newExpanded.add(objId);
        }
        setExpandedObjectives(newExpanded);
    };

    const handleCompleteGoal = async (goalId) => {
        if (!confirm('Mark this goal as complete? Only coaches can complete goals.')) return;
        
        try {
            await db.collection('goals').doc(goalId).update({
                status: 'completed',
                completedBy: user.uid,
                completedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            loadPIRGoalsData(selectedPIR.id);
        } catch (error) {
            console.error('Error completing goal:', error);
        }
    };

    const handleCompleteObjective = async (objectiveId) => {
        if (!confirm('Mark this objective as complete? Only coaches can complete objectives.')) return;
        
        try {
            await db.collection('objectives').doc(objectiveId).update({
                status: 'completed',
                completedBy: user.uid,
                completedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            loadPIRGoalsData(selectedPIR.id);
        } catch (error) {
            console.error('Error completing objective:', error);
        }
    };

    const handleCreateGoal = async (goalData) => {
        try {
            await db.collection('goals').add({
                userId: selectedPIR.id,
                title: goalData.title,
                description: goalData.description,
                dueDate: goalData.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(goalData.dueDate)) : null,
                status: 'active',
                createdBy: user.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            alert('Goal created successfully!');
            setShowCreateModal(false);
            loadPIRGoalsData(selectedPIR.id);
        } catch (error) {
            console.error('Error creating goal:', error);
            alert('Failed to create goal');
        }
    };

    const handleCreateObjective = async (objectiveData) => {
        try {
            const objectivesSnap = await db.collection('objectives')
                .where('goalId', '==', objectiveData.goalId)
                .get();
            
            await db.collection('objectives').add({
                goalId: objectiveData.goalId,
                userId: selectedPIR.id,
                title: objectiveData.title,
                order: objectivesSnap.size + 1,
                dueDate: objectiveData.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(objectiveData.dueDate)) : null,
                status: 'active',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            alert('Objective created successfully!');
            setShowCreateModal(false);
            loadPIRGoalsData(selectedPIR.id);
        } catch (error) {
            console.error('Error creating objective:', error);
            alert('Failed to create objective');
        }
    };

    const handleCreateAssignment = async (assignmentData) => {
        try {
            await db.collection('assignments').add({
                goalId: assignmentData.goalId,
                objectiveId: assignmentData.objectiveId,
                userId: selectedPIR.id,  // CHANGED FROM pirId to userId
                pirName: selectedPIR.displayName || selectedPIR.email,
                coachId: user.uid,
                coachName: user.displayName || user.email,
                title: assignmentData.title,
                description: assignmentData.description,
                dueDate: assignmentData.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(assignmentData.dueDate)) : null,
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Send notification to PIR
            await db.collection('notifications').add({
                userId: selectedPIR.id,
                type: 'assignment_created',
                title: 'New Assignment',
                message: `You have a new assignment: ${assignmentData.title}`,
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            alert('Assignment created successfully!');
            setShowCreateModal(false);
            loadPIRGoalsData(selectedPIR.id);
        } catch (error) {
            console.error('Error creating assignment:', error);
            alert('Failed to create assignment');
        }
    };

    const handleCreateMilestone = async (milestoneData) => {
        try {
            await db.collection('milestones').add({
                userId: selectedPIR.id,
                title: milestoneData.title,
                description: milestoneData.description,
                targetDate: firebase.firestore.Timestamp.fromDate(new Date(milestoneData.targetDate)),
                type: 'custom',
                achieved: false,
                icon: milestoneData.icon || 'üéØ',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            alert('Milestone created successfully!');
            setShowCreateModal(false);
            loadPIRGoalsData(selectedPIR.id);
        } catch (error) {
            console.error('Error creating milestone:', error);
            alert('Failed to create milestone');
        }
    };

    const PIRCard = ({ pir, onClick }) => (
        <div 
            className="pir-card-enhanced"
            onClick={onClick}
            style={{
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                borderRadius: '12px',
                padding: '20px',
                marginBottom: '15px',
                cursor: 'pointer',
                transition: 'transform 0.2s, box-shadow 0.2s',
                color: 'white',
                boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
            }}
            onMouseEnter={(e) => {
                e.currentTarget.style.transform = 'translateY(-2px)';
                e.currentTarget.style.boxShadow = '0 6px 12px rgba(0,0,0,0.15)';
            }}
            onMouseLeave={(e) => {
                e.currentTarget.style.transform = 'translateY(0)';
                e.currentTarget.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
            }}
        >
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start' }}>
                <div>
                    <h3 style={{ margin: '0 0 10px 0', fontSize: '1.4em' }}>
                        üë§ {pir.displayName || `${pir.firstName} ${pir.lastName}` || pir.email}
                    </h3>
                    <div style={{ display: 'flex', gap: '20px', fontSize: '0.95em', opacity: '0.95' }}>
                        <span>üìä {pir.activeGoals || 0} Active</span>
                        <span>‚úÖ {pir.completedGoals || 0} Complete</span>
                        <span>üìà {pir.overallProgress || 0}% Progress</span>
                    </div>
                </div>
                <div style={{ 
                    background: 'rgba(255,255,255,0.2)', 
                    borderRadius: '20px', 
                    padding: '8px 16px',
                    fontSize: '2em',
                    fontWeight: 'bold'
                }}>
                    {pir.overallProgress || 0}%
                </div>
            </div>
            
            {(pir.overdueAssignments > 0 || pir.nearCompletion > 0) && (
                <div style={{ 
                    marginTop: '15px', 
                    paddingTop: '15px', 
                    borderTop: '1px solid rgba(255,255,255,0.2)'
                }}>
                    {pir.overdueAssignments > 0 && (
                        <span style={{ 
                            background: 'rgba(255,100,100,0.3)', 
                            padding: '4px 12px', 
                            borderRadius: '15px',
                            marginRight: '10px',
                            fontSize: '0.9em'
                        }}>
                            ‚ö†Ô∏è {pir.overdueAssignments} Overdue
                        </span>
                    )}
                    {pir.nearCompletion > 0 && (
                        <span style={{ 
                            background: 'rgba(100,255,100,0.3)', 
                            padding: '4px 12px', 
                            borderRadius: '15px',
                            fontSize: '0.9em'
                        }}>
                            üéØ {pir.nearCompletion} Near Completion
                        </span>
                    )}
                </div>
            )}
        </div>
    );

    const ActionButton = ({ icon, label, onClick, variant = 'primary' }) => {
        const colors = {
            primary: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            success: 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)',
            warning: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
            info: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)'
        };

        return (
            <button
                onClick={onClick}
                style={{
                    background: colors[variant],
                    border: 'none',
                    borderRadius: '8px',
                    color: 'white',
                    padding: '10px 20px',
                    fontSize: '0.95em',
                    fontWeight: '500',
                    cursor: 'pointer',
                    transition: 'transform 0.2s',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.05)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
            >
                <span style={{ fontSize: '1.2em' }}>{icon}</span>
                {label}
            </button>
        );
    };

    const GoalItem = ({ goal }) => {
        const isExpanded = expandedGoals.has(goal.id);
        const objectives = pirGoalsData.objectives.filter(obj => obj.goalId === goal.id);
        const isCompleted = goal.status === 'completed';
        
        return (
            <div style={{
                background: isCompleted ? '#f0f8ff' : 'white',
                borderRadius: '10px',
                padding: '20px',
                marginBottom: '15px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                transition: 'all 0.3s',
                opacity: isCompleted ? 0.9 : 1
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <div 
                        onClick={() => toggleGoalExpand(goal.id)}
                        style={{ cursor: 'pointer', flex: 1 }}
                    >
                        <h4 style={{ margin: 0, color: '#333', display: 'flex', alignItems: 'center', gap: '10px' }}>
                            <span>{isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                            {goal.title}
                            <span style={{
                                background: isCompleted ? '#4CAF50' : `linear-gradient(90deg, #667eea ${goal.progress}%, #e0e0e0 ${goal.progress}%)`,
                                padding: '2px 10px',
                                borderRadius: '12px',
                                fontSize: '0.8em',
                                color: 'white'
                            }}>
                                {isCompleted ? 'Completed' : `${goal.progress}%`}
                            </span>
                        </h4>
                        <div style={{ marginTop: '5px', fontSize: '0.9em', color: '#666' }}>
                            Created: {formatDate(goal.createdAt)} 
                            {goal.dueDate && ` ‚Ä¢ Due: ${formatDate(goal.dueDate)}`}
                            {goal.completedAt && ` ‚Ä¢ Completed: ${formatDate(goal.completedAt)}`}
                        </div>
                        {goal.description && (
                            <div style={{ marginTop: '8px', fontSize: '0.9em', color: '#555' }}>
                                {goal.description}
                            </div>
                        )}
                    </div>
                    <div style={{ display: 'flex', gap: '10px' }}>
                        {!isCompleted && (
                            <>
                                <button
                                    onClick={() => {
                                        setSelectedParent({ type: 'goal', id: goal.id, title: goal.title });
                                        setModalType('objective');
                                        setShowCreateModal(true);
                                    }}
                                    style={{
                                        background: '#4CAF50',
                                        border: 'none',
                                        borderRadius: '6px',
                                        color: 'white',
                                        padding: '6px 12px',
                                        cursor: 'pointer',
                                        fontSize: '0.85em'
                                    }}
                                >
                                    + Objective
                                </button>
                                <button
                                    onClick={() => handleCompleteGoal(goal.id)}
                                    style={{
                                        background: '#2196F3',
                                        border: 'none',
                                        borderRadius: '6px',
                                        color: 'white',
                                        padding: '6px 12px',
                                        cursor: 'pointer',
                                        fontSize: '0.85em'
                                    }}
                                >
                                    Complete
                                </button>
                            </>
                        )}
                    </div>
                </div>
                
                {isExpanded && (
                    <div style={{ marginTop: '20px', paddingLeft: '30px' }}>
                        {objectives.map(objective => (
                            <ObjectiveItem key={objective.id} objective={objective} goal={goal} />
                        ))}
                        {objectives.length === 0 && (
                            <p style={{ color: '#999', fontSize: '0.9em' }}>No objectives yet</p>
                        )}
                    </div>
                )}
            </div>
        );
    };

    const ObjectiveItem = ({ objective, goal }) => {
        const isExpanded = expandedObjectives.has(objective.id);
        const assignments = pirGoalsData.assignments.filter(a => a.objectiveId === objective.id);
        const isCompleted = objective.status === 'completed';
        
        return (
            <div style={{
                background: isCompleted ? '#f5fff5' : '#f8f9fa',
                borderLeft: `3px solid ${isCompleted ? '#4CAF50' : '#667eea'}`,
                padding: '15px',
                marginBottom: '10px',
                borderRadius: '6px',
                opacity: isCompleted ? 0.9 : 1
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <div 
                        onClick={() => toggleObjectiveExpand(objective.id)}
                        style={{ cursor: 'pointer', flex: 1 }}
                    >
                        <h5 style={{ margin: 0, color: '#555', display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <span>{isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                            {objective.title}
                            <span style={{
                                background: isCompleted ? '#4CAF50' : '#FFA726',
                                padding: '2px 8px',
                                borderRadius: '10px',
                                fontSize: '0.75em',
                                color: 'white'
                            }}>
                                {isCompleted ? 'completed' : 'active'}
                            </span>
                        </h5>
                        <div style={{ marginTop: '5px', fontSize: '0.85em', color: '#777' }}>
                            {objective.dueDate && `Due: ${formatDate(objective.dueDate)}`}
                            {objective.completedAt && ` ‚Ä¢ Completed: ${formatDate(objective.completedAt)}`}
                        </div>
                    </div>
                    <div style={{ display: 'flex', gap: '10px' }}>
                        {!isCompleted && (
                            <>
                                <button
                                    onClick={() => {
                                        setSelectedParent({
                                            type: 'objective',
                                            id: objective.id,
                                            goalId: goal.id,
                                            title: `${goal.title} > ${objective.title}`
                                        });
                                        setModalType('assignment');
                                        setShowCreateModal(true);
                                    }}
                                    style={{
                                        background: '#9C27B0',
                                        border: 'none',
                                        borderRadius: '6px',
                                        color: 'white',
                                        padding: '5px 10px',
                                        cursor: 'pointer',
                                        fontSize: '0.8em'
                                    }}
                                >
                                    + Assignment
                                </button>
                                <button
                                    onClick={() => handleCompleteObjective(objective.id)}
                                    style={{
                                        background: '#FF9800',
                                        border: 'none',
                                        borderRadius: '6px',
                                        color: 'white',
                                        padding: '5px 10px',
                                        cursor: 'pointer',
                                        fontSize: '0.8em'
                                    }}
                                >
                                    Complete
                                </button>
                            </>
                        )}
                    </div>
                </div>
                
                {isExpanded && (
                    <div style={{ marginTop: '15px', paddingLeft: '20px' }}>
                        {assignments.map(assignment => (
                            <AssignmentItem key={assignment.id} assignment={assignment} />
                        ))}
                        {assignments.length === 0 && (
                            <p style={{ color: '#999', fontSize: '0.9em' }}>No assignments yet</p>
                        )}
                    </div>
                )}
            </div>
        );
    };

    const AssignmentItem = ({ assignment }) => {
        const isCompleted = assignment.status === 'completed';
        
        return (
            <div style={{
                background: isCompleted ? '#f0fff0' : 'white',
                border: `1px solid ${isCompleted ? '#c8e6c9' : '#e0e0e0'}`,
                padding: '12px',
                marginBottom: '8px',
                borderRadius: '4px',
                display: 'flex',
                alignItems: 'flex-start',
                gap: '10px'
            }}>
                <span style={{ fontSize: '1.2em', marginTop: '2px' }}>
                    {isCompleted ? '‚úÖ' : '‚è≥'}
                </span>
                <div style={{ flex: 1 }}>
                    <div style={{ fontWeight: '500', color: '#333' }}>
                        {assignment.title}
                    </div>
                    {assignment.description && (
                        <div style={{ fontSize: '0.85em', color: '#666', marginTop: '4px' }}>
                            {assignment.description}
                        </div>
                    )}
                    {assignment.reflection && (
                        <div style={{
                            background: '#e3f2fd',
                            padding: '8px',
                            borderRadius: '4px',
                            marginTop: '8px',
                            fontSize: '0.85em',
                            borderLeft: '3px solid #2196F3'
                        }}>
                            <strong style={{ color: '#1565C0' }}>PIR Reflection:</strong>
                            <div style={{ marginTop: '4px', color: '#424242' }}>
                                {assignment.reflection}
                            </div>
                        </div>
                    )}
                    <div style={{ fontSize: '0.8em', color: '#999', marginTop: '6px' }}>
                        {assignment.createdAt && `Created: ${formatDate(assignment.createdAt)}`}
                        {assignment.dueDate && ` ‚Ä¢ Due: ${formatDate(assignment.dueDate)}`}
                        {assignment.completedAt && ` ‚Ä¢ Completed: ${formatDate(assignment.completedAt)}`}
                    </div>
                </div>
            </div>
        );
    };

    // Rest of component remains the same...
    if (loading) {
        return (
            <div style={{ 
                display: 'flex', 
                justifyContent: 'center', 
                alignItems: 'center', 
                height: '400px' 
            }}>
                <div className="loading-spinner"></div>
            </div>
        );
    }

    if (selectedPIR) {
        return (
            <div style={{ padding: '20px' }}>
                <div style={{ 
                    display: 'flex', 
                    justifyContent: 'space-between', 
                    alignItems: 'center',
                    marginBottom: '30px',
                    background: 'white',
                    padding: '20px',
                    borderRadius: '10px',
                    boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                }}>
                    <div>
                        <button
                            onClick={() => setSelectedPIR(null)}
                            style={{
                                background: 'none',
                                border: 'none',
                                color: '#667eea',
                                cursor: 'pointer',
                                fontSize: '1em',
                                marginBottom: '10px',
                                padding: 0
                            }}
                        >
                            ‚Üê Back to PIR List
                        </button>
                        <h2 style={{ margin: 0, color: '#333' }}>
                            {selectedPIR.displayName || selectedPIR.email}'s Recovery Plan
                        </h2>
                        <div style={{ 
                            marginTop: '10px',
                            fontSize: '1.2em',
                            color: '#666'
                        }}>
                            Overall Progress: {Math.round(pirGoalsData.goals.reduce((acc, g) => acc + g.progress, 0) / (pirGoalsData.goals.length || 1))}%
                        </div>
                    </div>
                    
                    <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                        <ActionButton 
                            icon="üßµ" 
                            label="Golden Thread" 
                            variant="primary"
                            onClick={() => {
                                setModalType('goldenThread');
                                setShowCreateModal(true);
                            }}
                        />
                        <ActionButton 
                            icon="üéØ" 
                            label="Add Goal" 
                            variant="success"
                            onClick={() => {
                                setModalType('goal');
                                setShowCreateModal(true);
                            }}
                        />
                        <ActionButton 
                            icon="‚≠ê" 
                            label="Add Milestone" 
                            variant="warning"
                            onClick={() => {
                                setModalType('milestone');
                                setShowCreateModal(true);
                            }}
                        />
                    </div>
                </div>

                <div style={{ marginTop: '20px' }}>
                    {pirGoalsData.goals.map(goal => (
                        <GoalItem key={goal.id} goal={goal} />
                    ))}
                    
                    {pirGoalsData.goals.length === 0 && (
                        <div style={{
                            background: 'white',
                            borderRadius: '10px',
                            padding: '40px',
                            textAlign: 'center',
                            color: '#999'
                        }}>
                            <h3>No goals assigned yet</h3>
                            <p>Start with a Golden Thread to create a structured recovery plan</p>
                        </div>
                    )}
                </div>

                {/* MODAL RENDERING */}
                {showCreateModal && (
                    <CreateGoalModal
                        type={modalType}
                        selectedPIR={selectedPIR}
                        selectedParent={selectedParent}
                        onSubmit={(data) => {
                            if (modalType === 'goldenThread') {
                                // Golden thread handles its own submit
                                return;
                            } else if (modalType === 'goal') {
                                handleCreateGoal(data);
                            } else if (modalType === 'objective') {
                                handleCreateObjective(data);
                            } else if (modalType === 'assignment') {
                                handleCreateAssignment(data);
                            } else if (modalType === 'milestone') {
                                handleCreateMilestone(data);
                            }
                        }}
                        onClose={() => {
                            setShowCreateModal(false);
                            setSelectedParent(null);
                        }}
                    />
                )}
            </div>
        );
    }

    return (
        <div style={{ padding: '20px' }}>
            <h2 style={{ marginBottom: '30px', color: '#333' }}>PIR Goals Management</h2>
            <div>
                {pirs.map(pir => (
                    <PIRCard 
                        key={pir.id} 
                        pir={pir} 
                        onClick={() => setSelectedPIR(pir)}
                    />
                ))}
                
                {pirs.length === 0 && (
                    <div style={{
                        background: 'white',
                        borderRadius: '10px',
                        padding: '40px',
                        textAlign: 'center',
                        color: '#999'
                    }}>
                        <h3>No active PIRs found</h3>
                        <p>PIRs will appear here once they are added to the system</p>
                    </div>
                )}
            </div>

            {/* MODAL RENDERING FOR MAIN VIEW */}
            {showCreateModal && (
                <CreateGoalModal
                    type={modalType}
                    selectedPIR={selectedPIR}
                    selectedParent={selectedParent}
                    onSubmit={(data) => {
                        if (modalType === 'goldenThread') {
                            // Golden thread handles its own submit
                            return;
                        } else if (modalType === 'goal') {
                            handleCreateGoal(data);
                        } else if (modalType === 'objective') {
                            handleCreateObjective(data);
                        } else if (modalType === 'assignment') {
                            handleCreateAssignment(data);
                        } else if (modalType === 'milestone') {
                            handleCreateMilestone(data);
                        }
                    }}
                    onClose={() => {
                        setShowCreateModal(false);
                        setSelectedParent(null);
                    }}
                />
            )}
        </div>
    );
}

// Enhanced Golden Thread Modal with FIXED userId field
function CreateGoalModal({ type, selectedPIR, selectedParent, onSubmit, onClose }) {
    const [goldenThreadData, setGoldenThreadData] = useState({
        goals: [
            {
                title: '',
                description: '',
                dueDate: '',
                objectives: [
                    { title: '', dueDate: '', assignments: [{ title: '', description: '', dueDate: '' }] },
                    { title: '', dueDate: '', assignments: [{ title: '', description: '', dueDate: '' }] }
                ]
            },
            {
                title: '',
                description: '',
                dueDate: '',
                objectives: [
                    { title: '', dueDate: '', assignments: [{ title: '', description: '', dueDate: '' }] },
                    { title: '', dueDate: '', assignments: [{ title: '', description: '', dueDate: '' }] }
                ]
            }
        ]
    });

    const [singleFormData, setSingleFormData] = useState({
        title: '',
        description: '',
        dueDate: '',
        targetDate: '',
        icon: 'üéØ',
        goalId: selectedParent?.goalId || '',
        objectiveId: selectedParent?.id || ''
    });

    const addGoal = () => {
        setGoldenThreadData({
            ...goldenThreadData,
            goals: [...goldenThreadData.goals, {
                title: '',
                description: '',
                dueDate: '',
                objectives: [
                    { title: '', dueDate: '', assignments: [{ title: '', description: '', dueDate: '' }] }
                ]
            }]
        });
    };

    const addObjective = (goalIndex) => {
        const newGoals = [...goldenThreadData.goals];
        newGoals[goalIndex].objectives.push({
            title: '',
            dueDate: '',
            assignments: [{ title: '', description: '', dueDate: '' }]
        });
        setGoldenThreadData({ ...goldenThreadData, goals: newGoals });
    };

    const addAssignment = (goalIndex, objIndex) => {
        const newGoals = [...goldenThreadData.goals];
        newGoals[goalIndex].objectives[objIndex].assignments.push({
            title: '',
            description: '',
            dueDate: ''
        });
        setGoldenThreadData({ ...goldenThreadData, goals: newGoals });
    };

    const updateGoal = (index, field, value) => {
        const newGoals = [...goldenThreadData.goals];
        newGoals[index][field] = value;
        setGoldenThreadData({ ...goldenThreadData, goals: newGoals });
    };

    const updateObjective = (goalIndex, objIndex, field, value) => {
        const newGoals = [...goldenThreadData.goals];
        newGoals[goalIndex].objectives[objIndex][field] = value;
        setGoldenThreadData({ ...goldenThreadData, goals: newGoals });
    };

    const updateAssignment = (goalIndex, objIndex, assignIndex, field, value) => {
        const newGoals = [...goldenThreadData.goals];
        newGoals[goalIndex].objectives[objIndex].assignments[assignIndex][field] = value;
        setGoldenThreadData({ ...goldenThreadData, goals: newGoals });
    };

    const handleGoldenThreadSubmit = async () => {
        try {
            for (const goal of goldenThreadData.goals) {
                if (!goal.title) continue;
                
                const goalRef = await db.collection('goals').add({
                    userId: selectedPIR.id,
                    title: goal.title,
                    description: goal.description,
                    dueDate: goal.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(goal.dueDate)) : null,
                    status: 'active',
                    createdBy: auth.currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                for (let i = 0; i < goal.objectives.length; i++) {
                    const objective = goal.objectives[i];
                    if (!objective.title) continue;
                    
                    const objectiveRef = await db.collection('objectives').add({
                        goalId: goalRef.id,
                        userId: selectedPIR.id,
                        title: objective.title,
                        order: i + 1,
                        dueDate: objective.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(objective.dueDate)) : null,
                        status: 'active',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    for (const assignment of objective.assignments) {
                        if (!assignment.title) continue;
                        
                        await db.collection('assignments').add({
                            goalId: goalRef.id,
                            objectiveId: objectiveRef.id,
                            userId: selectedPIR.id,  // CHANGED FROM pirId to userId
                            pirName: selectedPIR.displayName || selectedPIR.email,
                            coachId: auth.currentUser.uid,
                            coachName: auth.currentUser.displayName || auth.currentUser.email,
                            title: assignment.title,
                            description: assignment.description,
                            dueDate: assignment.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(assignment.dueDate)) : null,
                            status: 'pending',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }
            }

            alert('Golden Thread created successfully!');
            onClose();
            window.location.reload(); // Reload to show new data
        } catch (error) {
            console.error('Error creating golden thread:', error);
            alert('Failed to create golden thread');
        }
    };

    if (type === 'goldenThread') {
        return (
            <div className="modal-overlay" style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0,0,0,0.5)',
                display: 'flex',
                justifyContent: 'center',
                alignItems: 'center',
                zIndex: 1000,
                overflow: 'auto'
            }}>
                <div style={{
                    background: 'white',
                    borderRadius: '12px',
                    width: '90%',
                    maxWidth: '900px',
                    maxHeight: '90vh',
                    overflow: 'auto',
                    padding: '30px'
                }}>
                    <div style={{ 
                        display: 'flex', 
                        justifyContent: 'space-between', 
                        alignItems: 'center',
                        marginBottom: '20px'
                    }}>
                        <h2 style={{ margin: 0 }}>Create Golden Thread</h2>
                        <button 
                            onClick={onClose}
                            style={{
                                background: 'none',
                                border: 'none',
                                fontSize: '24px',
                                cursor: 'pointer'
                            }}
                        >
                            √ó
                        </button>
                    </div>

                    {goldenThreadData.goals.map((goal, goalIndex) => (
                        <div key={goalIndex} style={{
                            background: '#f8f9fa',
                            borderRadius: '8px',
                            padding: '20px',
                            marginBottom: '20px'
                        }}>
                            <h3 style={{ color: '#667eea', marginTop: 0 }}>Goal {goalIndex + 1}</h3>
                            <input
                                type="text"
                                placeholder="Goal Title"
                                value={goal.title}
                                onChange={(e) => updateGoal(goalIndex, 'title', e.target.value)}
                                style={{
                                    width: '100%',
                                    padding: '10px',
                                    marginBottom: '10px',
                                    border: '1px solid #ddd',
                                    borderRadius: '6px'
                                }}
                            />
                            <textarea
                                placeholder="Goal Description"
                                value={goal.description}
                                onChange={(e) => updateGoal(goalIndex, 'description', e.target.value)}
                                style={{
                                    width: '100%',
                                    padding: '10px',
                                    marginBottom: '10px',
                                    border: '1px solid #ddd',
                                    borderRadius: '6px',
                                    minHeight: '60px'
                                }}
                            />
                            <input
                                type="date"
                                value={goal.dueDate}
                                onChange={(e) => updateGoal(goalIndex, 'dueDate', e.target.value)}
                                style={{
                                    padding: '10px',
                                    marginBottom: '20px',
                                    border: '1px solid #ddd',
                                    borderRadius: '6px'
                                }}
                            />

                            {goal.objectives.map((objective, objIndex) => (
                                <div key={objIndex} style={{
                                    background: 'white',
                                    borderLeft: '3px solid #667eea',
                                    padding: '15px',
                                    marginLeft: '20px',
                                    marginBottom: '15px',
                                    borderRadius: '4px'
                                }}>
                                    <h4 style={{ color: '#555', marginTop: 0 }}>Objective {objIndex + 1}</h4>
                                    <input
                                        type="text"
                                        placeholder="Objective Title"
                                        value={objective.title}
                                        onChange={(e) => updateObjective(goalIndex, objIndex, 'title', e.target.value)}
                                        style={{
                                            width: '100%',
                                            padding: '8px',
                                            marginBottom: '8px',
                                            border: '1px solid #ddd',
                                            borderRadius: '4px'
                                        }}
                                    />
                                    <input
                                        type="date"
                                        value={objective.dueDate}
                                        onChange={(e) => updateObjective(goalIndex, objIndex, 'dueDate', e.target.value)}
                                        style={{
                                            padding: '8px',
                                            marginBottom: '15px',
                                            border: '1px solid #ddd',
                                            borderRadius: '4px'
                                        }}
                                    />

                                    {objective.assignments.map((assignment, assignIndex) => (
                                        <div key={assignIndex} style={{
                                            background: '#f8f9fa',
                                            padding: '10px',
                                            marginLeft: '20px',
                                            marginBottom: '8px',
                                            borderRadius: '4px'
                                        }}>
                                            <div style={{ color: '#777', fontSize: '0.9em', marginBottom: '5px' }}>
                                                Assignment {assignIndex + 1}
                                            </div>
                                            <input
                                                type="text"
                                                placeholder="Assignment Title"
                                                value={assignment.title}
                                                onChange={(e) => updateAssignment(goalIndex, objIndex, assignIndex, 'title', e.target.value)}
                                                style={{
                                                    width: '100%',
                                                    padding: '6px',
                                                    marginBottom: '6px',
                                                    border: '1px solid #ddd',
                                                    borderRadius: '4px'
                                                }}
                                            />
                                            <input
                                                type="text"
                                                placeholder="Assignment Description"
                                                value={assignment.description}
                                                onChange={(e) => updateAssignment(goalIndex, objIndex, assignIndex, 'description', e.target.value)}
                                                style={{
                                                    width: '100%',
                                                    padding: '6px',
                                                    marginBottom: '6px',
                                                    border: '1px solid #ddd',
                                                    borderRadius: '4px'
                                                }}
                                            />
                                            <input
                                                type="date"
                                                value={assignment.dueDate}
                                                onChange={(e) => updateAssignment(goalIndex, objIndex, assignIndex, 'dueDate', e.target.value)}
                                                style={{
                                                    padding: '6px',
                                                    border: '1px solid #ddd',
                                                    borderRadius: '4px'
                                                }}
                                            />
                                        </div>
                                    ))}
                                    
                                    <button
                                        onClick={() => addAssignment(goalIndex, objIndex)}
                                        style={{
                                            marginLeft: '20px',
                                            marginTop: '5px',
                                            background: '#9C27B0',
                                            border: 'none',
                                            borderRadius: '4px',
                                            color: 'white',
                                            padding: '6px 12px',
                                            cursor: 'pointer',
                                            fontSize: '0.85em'
                                        }}
                                    >
                                        + Add Assignment
                                    </button>
                                </div>
                            ))}
                            
                            <button
                                onClick={() => addObjective(goalIndex)}
                                style={{
                                    marginLeft: '20px',
                                    background: '#4CAF50',
                                    border: 'none',
                                    borderRadius: '4px',
                                    color: 'white',
                                    padding: '8px 16px',
                                    cursor: 'pointer'
                                }}
                            >
                                + Add Objective
                            </button>
                        </div>
                    ))}
                    
                    <button
                        onClick={addGoal}
                        style={{
                            background: '#2196F3',
                            border: 'none',
                            borderRadius: '6px',
                            color: 'white',
                            padding: '10px 20px',
                            cursor: 'pointer',
                            marginBottom: '20px'
                        }}
                    >
                        + Add Another Goal
                    </button>
                    
                    <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                        <button
                            onClick={onClose}
                            style={{
                                background: '#e0e0e0',
                                border: 'none',
                                borderRadius: '6px',
                                padding: '12px 24px',
                                cursor: 'pointer'
                            }}
                        >
                            Cancel
                        </button>
                        <button
                            onClick={handleGoldenThreadSubmit}
                            style={{
                                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                border: 'none',
                                borderRadius: '6px',
                                color: 'white',
                                padding: '12px 24px',
                                cursor: 'pointer',
                                fontWeight: 'bold'
                            }}
                        >
                            Create Golden Thread
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // Regular single item creation forms
    return (
        <div className="modal-overlay" style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0,0,0,0.5)',
            display: 'flex',
            justifyContent: 'center',
            alignItems: 'center',
            zIndex: 1000
        }}>
            <div style={{
                background: 'white',
                borderRadius: '12px',
                width: '90%',
                maxWidth: '500px',
                padding: '30px'
            }}>
                <div style={{ 
                    display: 'flex', 
                    justifyContent: 'space-between', 
                    alignItems: 'center',
                    marginBottom: '20px'
                }}>
                    <h2 style={{ margin: 0 }}>
                        {type === 'goal' && 'Add New Goal'}
                        {type === 'objective' && `Add Objective to: ${selectedParent?.title}`}
                        {type === 'assignment' && `Add Assignment to: ${selectedParent?.title}`}
                        {type === 'milestone' && 'Add Custom Milestone'}
                    </h2>
                    <button 
                        onClick={onClose}
                        style={{
                            background: 'none',
                            border: 'none',
                            fontSize: '24px',
                            cursor: 'pointer'
                        }}
                    >
                        √ó
                    </button>
                </div>

                <form onSubmit={(e) => {
                    e.preventDefault();
                    onSubmit({...singleFormData, ...selectedParent});
                }}>
                    <input
                        type="text"
                        placeholder="Title"
                        value={singleFormData.title}
                        onChange={(e) => setSingleFormData({...singleFormData, title: e.target.value})}
                        required
                        style={{
                            width: '100%',
                            padding: '10px',
                            marginBottom: '15px',
                            border: '1px solid #ddd',
                            borderRadius: '6px'
                        }}
                    />
                    
                    {(type === 'goal' || type === 'assignment' || type === 'milestone') && (
                        <textarea
                            placeholder="Description"
                            value={singleFormData.description}
                            onChange={(e) => setSingleFormData({...singleFormData, description: e.target.value})}
                            style={{
                                width: '100%',
                                padding: '10px',
                                marginBottom: '15px',
                                border: '1px solid #ddd',
                                borderRadius: '6px',
                                minHeight: '80px'
                            }}
                        />
                    )}
                    
                    <input
                        type="date"
                        value={singleFormData.dueDate || singleFormData.targetDate}
                        onChange={(e) => setSingleFormData({
                            ...singleFormData, 
                            dueDate: e.target.value,
                            targetDate: e.target.value
                        })}
                        style={{
                            width: '100%',
                            padding: '10px',
                            marginBottom: '15px',
                            border: '1px solid #ddd',
                            borderRadius: '6px'
                        }}
                    />
                    
                    <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                        <button
                            type="button"
                            onClick={onClose}
                            style={{
                                background: '#e0e0e0',
                                border: 'none',
                                borderRadius: '6px',
                                padding: '10px 20px',
                                cursor: 'pointer'
                            }}
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            style={{
                                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                border: 'none',
                                borderRadius: '6px',
                                color: 'white',
                                padding: '10px 20px',
                                cursor: 'pointer',
                                fontWeight: 'bold'
                            }}
                        >
                            Create
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
}
       // ENHANCED ProfileView
function ProfileView({ user }) {
    const [editing, setEditing] = useState(false);
    const [profileData, setProfileData] = useState({
        displayName: user.displayName || '',
        firstName: user.firstName || '',
        lastName: user.lastName || '',
        phone: user.phone || '',
        email: user.email
    });
    const [saving, setSaving] = useState(false);
    const [passwordData, setPasswordData] = useState({
        currentPassword: '',
        newPassword: '',
        confirmPassword: ''
    });
    const [showPassword, setShowPassword] = useState({
        current: false,
        new: false,
        confirm: false
    });
    const [passwordStrength, setPasswordStrength] = useState(0);

    const calculatePasswordStrength = (password) => {
        let strength = 0;
        if (password.length >= 8) strength += 25;
        if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength += 25;
        if (password.match(/[0-9]/)) strength += 25;
        if (password.match(/[^a-zA-Z0-9]/)) strength += 25;
        return strength;
    };

    const handlePasswordChange = (value) => {
        setPasswordData({...passwordData, newPassword: value});
        setPasswordStrength(calculatePasswordStrength(value));
    };

    const getPasswordStrengthColor = () => {
        if (passwordStrength <= 25) return '#f44336';
        if (passwordStrength <= 50) return '#FF9800';
        if (passwordStrength <= 75) return '#FFC107';
        return '#4CAF50';
    };

    const getPasswordStrengthLabel = () => {
        if (passwordStrength <= 25) return 'Weak';
        if (passwordStrength <= 50) return 'Fair';
        if (passwordStrength <= 75) return 'Good';
        return 'Strong';
    };

   const handleSaveProfile = async () => {
    try {
        // Check if sobriety date changed
        const sobrietyDateChanged = editData.sobrietyDate !== pirData.sobrietyDate;
        
        const updates = {
            ...editData,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Track coach assignment changes
        if (editData.assignedCoach !== pirData.assignedCoach) {
            const newCoach = availableCoaches.find(c => c.id === editData.assignedCoach);
            const oldCoach = availableCoaches.find(c => c.id === pirData.assignedCoach);
            
            // Add to assignment history
            const historyEntry = {
                assignedAt: new Date().toISOString(),
                assignedBy: user.uid,
                coachId: editData.assignedCoach,
                coachName: newCoach?.displayName || newCoach?.email || 'Unknown',
                previousCoachId: pirData.assignedCoach || null,
                previousCoachName: oldCoach?.displayName || oldCoach?.email || 'None'
            };
            
            updates.coachAssignmentHistory = firebase.firestore.FieldValue.arrayUnion(historyEntry);
            
            // Create notification for new coach
            if (editData.assignedCoach) {
                await db.collection('notifications').add({
                    recipientId: editData.assignedCoach,
                    type: 'pir_assigned',
                    message: `${pirData.displayName || pirData.email} has been assigned to you`,
                    pirId: pirId,
                    pirName: pirData.displayName || pirData.email,
                    read: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            // Create notification for PIR
            await db.collection('notifications').add({
                recipientId: pirId,
                type: 'coach_changed',
                message: `Your coach has been updated to ${newCoach?.displayName || 'a new coach'}`,
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        // Save profile updates
        await db.collection('users').doc(pirId).update(updates);
        
        // Log activity
        await db.collection('activities').add({
            userId: pirId,
            type: 'profile_updated',
            description: 'Profile information updated' + 
                (editData.assignedCoach !== pirData.assignedCoach ? ' - Coach assignment changed' : '') +
                (sobrietyDateChanged ? ' - Sobriety date changed' : ''),
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Handle sobriety date change
        if (sobrietyDateChanged) {
            const hasGoogleCalendar = user.googleConnected && user.googleAccessToken;
            
            if (hasGoogleCalendar) {
                const shouldRecreate = confirm(
                    '‚ö†Ô∏è Sobriety Date Changed!\n\n' +
                    'The milestone celebrations in your calendar are now outdated.\n\n' +
                    'Would you like to:\n' +
                    '‚úì Delete old milestone events\n' +
                    '‚úì Create new milestone events based on the new date?\n\n' +
                    '(Recommended: Yes)'
                );
                
                if (shouldRecreate) {
                    // Use the updated PIR data with new sobriety date
                    const updatedPIR = { ...pirData, ...editData };
                    
                    // This will delete old and create new milestones
                    await recreatePIRMilestones(updatedPIR);
                }
            } else {
                alert(
                    '‚ÑπÔ∏è Sobriety Date Updated\n\n' +
                    'Connect Google Calendar in your Profile to automatically sync milestone celebrations!'
                );
            }
        }
        
        setPirData(editData);
        setEditing(false);
        
        let successMessage = 'Profile updated successfully';
        if (editData.assignedCoach !== pirData.assignedCoach) {
            successMessage += '\n\nCoach assignment changed and notifications sent!';
        }
        if (sobrietyDateChanged) {
            successMessage += '\n\nSobriety date updated!';
        }
        
        alert(successMessage);
        
        if (onUpdate) onUpdate();
    } catch (error) {
        console.error('Error updating profile:', error);
        alert('Failed to update profile: ' + error.message);
    }
};
    const handleChangePassword = async () => {
        if (passwordData.newPassword !== passwordData.confirmPassword) {
            alert('New passwords do not match');
            return;
        }
        
        if (passwordData.newPassword.length < 6) {
            alert('Password must be at least 6 characters');
            return;
        }
        
        setSaving(true);
        try {
            const credential = firebase.auth.EmailAuthProvider.credential(
                user.email,
                passwordData.currentPassword
            );
            
            await auth.currentUser.reauthenticateWithCredential(credential);
            await auth.currentUser.updatePassword(passwordData.newPassword);
            
            alert('Password changed successfully!');
            setPasswordData({
                currentPassword: '',
                newPassword: '',
                confirmPassword: ''
            });
            setPasswordStrength(0);
        } catch (error) {
            console.error('Error changing password:', error);
            alert('Failed to change password: ' + error.message);
        } finally {
            setSaving(false);
        }
    };
const connectGoogleServices = async () => {
    setSaving(true);
    try {
        console.log('Starting Google OAuth...');
        
        // Check if Google Identity Services loaded
        if (typeof google === 'undefined' || !google.accounts) {
            throw new Error('Google Identity Services not loaded. Please refresh the page.');
        }
        
        // Initialize token client (NEW method)
        const tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: '457406864879-k1sunucuqofe22m5rg93hvo6nngiqh0u.apps.googleusercontent.com',
            scope: [
                'https://www.googleapis.com/auth/calendar.events',
                'https://www.googleapis.com/auth/drive.file',
                'https://www.googleapis.com/auth/gmail.send'
            ].join(' '),
            callback: async (tokenResponse) => {
                try {
                    console.log('Token received:', tokenResponse);
                    
                    if (tokenResponse.error) {
                        throw new Error(tokenResponse.error);
                    }
                    
                    if (!tokenResponse.access_token) {
                        throw new Error('No access token received');
                    }
                    
                    console.log('Saving to Firebase...');
                    
                    // Save to Firebase
                    await db.collection('users').doc(user.uid).update({
                        googleConnected: true,
                        googleAccessToken: tokenResponse.access_token,
                        googleTokenExpiry: Date.now() + (tokenResponse.expires_in * 1000),
                        googleConnectedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    console.log('Success!');
                    alert('‚úì Google Services connected successfully!\n\nCalendar, Drive, and Gmail are now integrated.');
                    setTimeout(() => window.location.reload(), 1000);
                    
                } catch (error) {
                    console.error('Error saving token:', error);
                    alert('Failed to save connection: ' + error.message);
                } finally {
                    setSaving(false);
                }
            },
        });
        
        // Request access token
        console.log('Requesting token...');
        tokenClient.requestAccessToken({ prompt: 'consent' });
        
    } catch (error) {
        console.error('Error connecting Google:', error);
        alert('Failed to connect Google Services.\n\nError: ' + error.message);
        setSaving(false);
    }
};

const disconnectGoogleServices = async () => {
    if (!confirm('Disconnect Google Services? This will disable Calendar sync, Drive integration, and email notifications.')) {
        return;
    }
    
    setSaving(true);
    try {
        console.log('Disconnecting Google Services...');
        
        // Revoke token if available
        if (user.googleAccessToken && typeof google !== 'undefined' && google.accounts) {
            google.accounts.oauth2.revoke(user.googleAccessToken, () => {
                console.log('Token revoked');
            });
        }
        
        // Remove from Firebase
        await db.collection('users').doc(user.uid).update({
            googleConnected: false,
            googleAccessToken: firebase.firestore.FieldValue.delete(),
            googleTokenExpiry: firebase.firestore.FieldValue.delete(),
            googleDisconnectedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert('Google Services disconnected.');
        setTimeout(() => window.location.reload(), 500);
        
    } catch (error) {
        console.error('Error disconnecting Google:', error);
        alert('Failed to disconnect. Please try again.');
    } finally {
        setSaving(false);
    }
};
    return (
        <div style={{ padding: '20px', animation: 'fadeIn 0.5s' }}>
            {/* Header Card */}
            <div style={{
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                borderRadius: '20px',
                padding: '40px',
                color: 'white',
                marginBottom: '30px',
                boxShadow: '0 8px 32px rgba(102, 126, 234, 0.3)'
            }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '30px' }}>
                    <div style={{
                        width: '100px',
                        height: '100px',
                        borderRadius: '50%',
                        background: 'rgba(255,255,255,0.2)',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontSize: '42px',
                        fontWeight: 'bold',
                        border: '4px solid rgba(255,255,255,0.3)'
                    }}>
                        {(user.firstName || user.email).charAt(0).toUpperCase()}
                    </div>
                    <div>
                        <h1 style={{ margin: '0 0 10px 0', fontSize: '32px' }}>
                            {user.displayName || user.email}
                        </h1>
                        <div style={{ fontSize: '16px', opacity: 0.9 }}>
                            {user.email}
                        </div>
                        <div style={{
                            marginTop: '10px',
                            padding: '6px 16px',
                            background: 'rgba(255,255,255,0.2)',
                            borderRadius: '20px',
                            display: 'inline-block',
                            fontSize: '14px',
                            fontWeight: '600'
                        }}>
                            ADMINISTRATOR
                        </div>
                    </div>
                </div>
            </div>

            {/* Profile Information Card */}
            <div style={{
                background: 'white',
                borderRadius: '20px',
                padding: '30px',
                marginBottom: '30px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '25px' }}>
                    <h3 style={{ margin: 0, fontSize: '20px', color: '#333' }}>Profile Information</h3>
                    <button 
                        onClick={() => editing ? handleSaveProfile() : setEditing(true)}
                        disabled={saving}
                        style={{
                            padding: '10px 24px',
                            background: editing 
                                ? 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)' 
                                : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            color: 'white',
                            border: 'none',
                            borderRadius: '10px',
                            cursor: saving ? 'not-allowed' : 'pointer',
                            fontSize: '14px',
                            fontWeight: '600',
                            transition: 'transform 0.2s'
                        }}
                        onMouseEnter={(e) => {
                            if (!saving) e.currentTarget.style.transform = 'translateY(-2px)';
                        }}
                        onMouseLeave={(e) => {
                            e.currentTarget.style.transform = 'translateY(0)';
                        }}
                    >
                        {saving ? 'Saving...' : editing ? 'Save Changes' : 'Edit Profile'}
                    </button>
                </div>
                
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '20px' }}>
                    <div>
                        <label style={{ 
                            display: 'block', 
                            fontSize: '14px', 
                            fontWeight: '600', 
                            color: '#333', 
                            marginBottom: '8px' 
                        }}>
                            First Name
                        </label>
                        <input
                            type="text"
                            value={profileData.firstName}
                            onChange={(e) => setProfileData({...profileData, firstName: e.target.value})}
                            disabled={!editing}
                            style={{
                                width: '100%',
                                padding: '12px 15px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '10px',
                                fontSize: '14px',
                                background: editing ? 'white' : '#f8f9fa',
                                transition: 'all 0.2s'
                            }}
                            onFocus={(e) => {
                                if (editing) e.currentTarget.style.borderColor = '#667eea';
                            }}
                            onBlur={(e) => {
                                e.currentTarget.style.borderColor = '#e0e0e0';
                            }}
                        />
                    </div>
                    
                    <div>
                        <label style={{ 
                            display: 'block', 
                            fontSize: '14px', 
                            fontWeight: '600', 
                            color: '#333', 
                            marginBottom: '8px' 
                        }}>
                            Last Name
                        </label>
                        <input
                            type="text"
                            value={profileData.lastName}
                            onChange={(e) => setProfileData({...profileData, lastName: e.target.value})}
                            disabled={!editing}
                            style={{
                                width: '100%',
                                padding: '12px 15px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '10px',
                                fontSize: '14px',
                                background: editing ? 'white' : '#f8f9fa',
                                transition: 'all 0.2s'
                            }}
                            onFocus={(e) => {
                                if (editing) e.currentTarget.style.borderColor = '#667eea';
                            }}
                            onBlur={(e) => {
                                e.currentTarget.style.borderColor = '#e0e0e0';
                            }}
                        />
                    </div>
                    
                    <div>
                        <label style={{ 
                            display: 'block', 
                            fontSize: '14px', 
                            fontWeight: '600', 
                            color: '#333', 
                            marginBottom: '8px' 
                        }}>
                            Email Address
                        </label>
                        <input
                            type="email"
                            value={profileData.email}
                            disabled
                            style={{
                                width: '100%',
                                padding: '12px 15px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '10px',
                                fontSize: '14px',
                                background: '#f8f9fa',
                                color: '#999'
                            }}
                        />
                    </div>
                    
                    <div>
                        <label style={{ 
                            display: 'block', 
                            fontSize: '14px', 
                            fontWeight: '600', 
                            color: '#333', 
                            marginBottom: '8px' 
                        }}>
                            Phone Number
                        </label>
                        <input
                            type="tel"
                            value={profileData.phone}
                            onChange={(e) => setProfileData({...profileData, phone: e.target.value})}
                            disabled={!editing}
                            style={{
                                width: '100%',
                                padding: '12px 15px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '10px',
                                fontSize: '14px',
                                background: editing ? 'white' : '#f8f9fa',
                                transition: 'all 0.2s'
                            }}
                            onFocus={(e) => {
                                if (editing) e.currentTarget.style.borderColor = '#667eea';
                            }}
                            onBlur={(e) => {
                                e.currentTarget.style.borderColor = '#e0e0e0';
                            }}
                        />
                    </div>
                </div>
                
                {editing && (
                    <button 
                        onClick={() => {
                            setEditing(false);
                            setProfileData({
                                displayName: user.displayName || '',
                                firstName: user.firstName || '',
                                lastName: user.lastName || '',
                                phone: user.phone || '',
                                email: user.email
                            });
                        }}
                        style={{
                            marginTop: '20px',
                            padding: '10px 24px',
                            background: '#6c757d',
                            color: 'white',
                            border: 'none',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '600'
                        }}
                    >
                        Cancel
                    </button>
                )}
            </div>
            
            {/* Change Password Card */}
            <div style={{
                background: 'white',
                borderRadius: '20px',
                padding: '30px',
                marginBottom: '30px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <h3 style={{ margin: '0 0 25px 0', fontSize: '20px', color: '#333' }}>Change Password</h3>
                
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '20px', marginBottom: '20px' }}>
                    <div>
                        <label style={{ 
                            display: 'block', 
                            fontSize: '14px', 
                            fontWeight: '600', 
                            color: '#333', 
                            marginBottom: '8px' 
                        }}>
                            Current Password
                        </label>
                        <div style={{ position: 'relative' }}>
                            <input
                                type={showPassword.current ? 'text' : 'password'}
                                value={passwordData.currentPassword}
                                onChange={(e) => setPasswordData({...passwordData, currentPassword: e.target.value})}
                                style={{
                                    width: '100%',
                                    padding: '12px 45px 12px 15px',
                                    border: '2px solid #e0e0e0',
                                    borderRadius: '10px',
                                    fontSize: '14px',
                                    transition: 'border-color 0.2s'
                                }}
                                onFocus={(e) => e.currentTarget.style.borderColor = '#667eea'}
                                onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                            />
                            <button
                                type="button"
                                onClick={() => setShowPassword({...showPassword, current: !showPassword.current})}
                                style={{
                                    position: 'absolute',
                                    right: '10px',
                                    top: '50%',
                                    transform: 'translateY(-50%)',
                                    background: 'none',
                                    border: 'none',
                                    cursor: 'pointer',
                                    fontSize: '18px'
                                }}
                            >
                                {showPassword.current ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <label style={{ 
                            display: 'block', 
                            fontSize: '14px', 
                            fontWeight: '600', 
                            color: '#333', 
                            marginBottom: '8px' 
                        }}>
                            New Password
                        </label>
                        <div style={{ position: 'relative' }}>
                            <input
                                type={showPassword.new ? 'text' : 'password'}
                                value={passwordData.newPassword}
                                onChange={(e) => handlePasswordChange(e.target.value)}
                                style={{
                                    width: '100%',
                                    padding: '12px 45px 12px 15px',
                                    border: '2px solid #e0e0e0',
                                    borderRadius: '10px',
                                    fontSize: '14px',
                                    transition: 'border-color 0.2s'
                                }}
                                onFocus={(e) => e.currentTarget.style.borderColor = '#667eea'}
                                onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                            />
                            <button
                                type="button"
                                onClick={() => setShowPassword({...showPassword, new: !showPassword.new})}
                                style={{
                                    position: 'absolute',
                                    right: '10px',
                                    top: '50%',
                                    transform: 'translateY(-50%)',
                                    background: 'none',
                                    border: 'none',
                                    cursor: 'pointer',
                                    fontSize: '18px'
                                }}
                            >
                                {showPassword.new ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}
                            </button>
                        </div>
                        {passwordData.newPassword && (
                            <div style={{ marginTop: '8px' }}>
                                <div style={{
                                    height: '4px',
                                    background: '#e0e0e0',
                                    borderRadius: '2px',
                                    overflow: 'hidden'
                                }}>
                                    <div style={{
                                        height: '100%',
                                        width: `${passwordStrength}%`,
                                        background: getPasswordStrengthColor(),
                                        transition: 'all 0.3s'
                                    }}></div>
                                </div>
                                <div style={{
                                    fontSize: '12px',
                                    color: getPasswordStrengthColor(),
                                    marginTop: '4px'
                                }}>
                                    {getPasswordStrengthLabel()}
                                </div>
                            </div>
                        )}
                    </div>
                    
                    <div>
                        <label style={{ 
                            display: 'block', 
                            fontSize: '14px', 
                            fontWeight: '600', 
                            color: '#333', 
                            marginBottom: '8px' 
                        }}>
                            Confirm New Password
                        </label>
                        <div style={{ position: 'relative' }}>
                            <input
                                type={showPassword.confirm ? 'text' : 'password'}
                                value={passwordData.confirmPassword}
                                onChange={(e) => setPasswordData({...passwordData, confirmPassword: e.target.value})}
                                style={{
                                    width: '100%',
                                    padding: '12px 45px 12px 15px',
                                    border: `2px solid ${passwordData.confirmPassword && passwordData.confirmPassword !== passwordData.newPassword ? '#f44336' : '#e0e0e0'}`,
                                    borderRadius: '10px',
                                    fontSize: '14px',
                                    transition: 'border-color 0.2s'
                                }}
                                onFocus={(e) => {
                                    if (!(passwordData.confirmPassword && passwordData.confirmPassword !== passwordData.newPassword)) {
                                        e.currentTarget.style.borderColor = '#667eea';
                                    }
                                }}
                                onBlur={(e) => {
                                    if (!(passwordData.confirmPassword && passwordData.confirmPassword !== passwordData.newPassword)) {
                                        e.currentTarget.style.borderColor = '#e0e0e0';
                                    }
                                }}
                            />
                            <button
                                type="button"
                                onClick={() => setShowPassword({...showPassword, confirm: !showPassword.confirm})}
                                style={{
                                    position: 'absolute',
                                    right: '10px',
                                    top: '50%',
                                    transform: 'translateY(-50%)',
                                    background: 'none',
                                    border: 'none',
                                    cursor: 'pointer',
                                    fontSize: '18px'
                                }}
                            >
                                {showPassword.confirm ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}
                            </button>
                        </div>
                        {passwordData.confirmPassword && passwordData.confirmPassword !== passwordData.newPassword && (
                            <div style={{ fontSize: '12px', color: '#f44336', marginTop: '4px' }}>
                                Passwords do not match
                            </div>
                        )}
                    </div>
                </div>
                
                <button 
                    onClick={handleChangePassword}
                    disabled={saving || !passwordData.currentPassword || !passwordData.newPassword || passwordData.newPassword !== passwordData.confirmPassword}
                    style={{
                        padding: '12px 32px',
                        background: (saving || !passwordData.currentPassword || !passwordData.newPassword || passwordData.newPassword !== passwordData.confirmPassword)
                            ? '#ccc'
                            : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '10px',
                        cursor: (saving || !passwordData.currentPassword || !passwordData.newPassword || passwordData.newPassword !== passwordData.confirmPassword)
                            ? 'not-allowed'
                            : 'pointer',
                        fontSize: '14px',
                        fontWeight: '600',
                        transition: 'transform 0.2s'
                    }}
                    onMouseEnter={(e) => {
                        if (!saving && passwordData.currentPassword && passwordData.newPassword && passwordData.newPassword === passwordData.confirmPassword) {
                            e.currentTarget.style.transform = 'translateY(-2px)';
                        }
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.transform = 'translateY(0)';
                    }}
                >
                    {saving ? 'Changing Password...' : 'Change Password'}
                </button>
            </div>
            
           {/* Account Information Card */}
<div style={{
    background: 'white',
    borderRadius: '20px',
    padding: '30px',
    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
}}>
    <h3 style={{ margin: '0 0 20px 0', fontSize: '20px', color: '#333' }}>Account Information</h3>
    <div style={{ display: 'grid', gap: '15px' }}>
        <div style={{
            padding: '15px',
            background: '#f8f9fa',
            borderRadius: '10px',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center'
        }}>
            <span style={{ fontWeight: '600', color: '#666' }}>User ID:</span>
            <span style={{ fontFamily: 'monospace', color: '#333' }}>{user.uid}</span>
        </div>
        <div style={{
            padding: '15px',
            background: '#f8f9fa',
            borderRadius: '10px',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center'
        }}>
            <span style={{ fontWeight: '600', color: '#666' }}>Role:</span>
            <span style={{
                padding: '6px 16px',
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                color: 'white',
                borderRadius: '20px',
                fontSize: '13px',
                fontWeight: '600'
            }}>
                ADMINISTRATOR
            </span>
        </div>
        <div style={{
            padding: '15px',
            background: '#f8f9fa',
            borderRadius: '10px',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center'
        }}>
            <span style={{ fontWeight: '600', color: '#666' }}>Account Created:</span>
            <span style={{ color: '#333' }}>{formatDate(user.createdAt)}</span>
        </div>
        <div style={{
            padding: '15px',
            background: '#f8f9fa',
            borderRadius: '10px',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center'
        }}>
            <span style={{ fontWeight: '600', color: '#666' }}>Last Updated:</span>
            <span style={{ color: '#333' }}>{formatDate(user.updatedAt)}</span>
        </div>
    </div>
</div>

{/* Google Services Integration Card */}
<div style={{
    background: 'white',
    borderRadius: '20px',
    padding: '30px',
    marginTop: '30px',
    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
}}>
    <h3 style={{ margin: '0 0 15px 0', fontSize: '20px', color: '#333' }}>Google Services</h3>
    <p style={{ fontSize: '14px', color: '#666', marginBottom: '20px' }}>
        Connect your Google account to enable Calendar sync, Drive integration, and automated emails.
    </p>
    
    {user.googleConnected ? (
        <>
            <div style={{ 
                padding: '20px', 
                background: '#f0f9ff', 
                borderRadius: '12px',
                marginBottom: '20px',
                border: '2px solid #0ea5e9'
            }}>
                <div style={{ 
                    display: 'flex', 
                    alignItems: 'center', 
                    gap: '10px',
                    marginBottom: '15px'
                }}>
                    <span style={{ fontSize: '24px' }}>‚úì</span>
                    <span style={{ fontSize: '16px', fontWeight: '600', color: '#0c4a6e' }}>
                        Google Services Connected
                    </span>
                </div>
                <div style={{ display: 'grid', gap: '10px', fontSize: '14px', color: '#0c4a6e' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <span>‚úì</span>
                        <span>Google Calendar - Meeting sync enabled</span>
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <span>‚úì</span>
                        <span>Google Drive - File storage enabled</span>
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <span>‚úì</span>
                        <span>Gmail - Email notifications enabled</span>
                    </div>
                </div>
                <div style={{ fontSize: '12px', color: '#64748b', marginTop: '10px' }}>
                    Connected: {formatDate(user.googleConnectedAt)}
                </div>
            </div>
            
            <button 
                onClick={disconnectGoogleServices}
                disabled={saving}
                style={{
                    padding: '10px 24px',
                    background: '#dc2626',
                    color: 'white',
                    border: 'none',
                    borderRadius: '10px',
                    cursor: saving ? 'not-allowed' : 'pointer',
                    fontSize: '14px',
                    fontWeight: '600',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => {
                    if (!saving) e.currentTarget.style.transform = 'translateY(-2px)';
                }}
                onMouseLeave={(e) => {
                    e.currentTarget.style.transform = 'translateY(0)';
                }}
            >
                {saving ? 'Disconnecting...' : 'Disconnect Google Services'}
            </button>
        </>
    ) : (
        <>
            <div style={{ 
                padding: '20px', 
                background: '#fef9c3', 
                borderRadius: '12px',
                marginBottom: '20px',
                border: '2px solid #fbbf24'
            }}>
                <div style={{ fontSize: '14px', color: '#78350f', marginBottom: '12px' }}>
                    <strong>Not Connected</strong>
                </div>
                <div style={{ fontSize: '13px', color: '#92400e' }}>
                    Connect Google to enable:
                </div>
                <ul style={{ fontSize: '13px', color: '#92400e', margin: '8px 0', paddingLeft: '20px' }}>
                    <li>Automatic meeting sync to your calendar</li>
                    <li>Organized file storage in Google Drive</li>
                    <li>Professional email notifications</li>
                </ul>
            </div>
            
            <button 
                onClick={connectGoogleServices}
                disabled={saving}
                style={{
                    padding: '12px 32px',
                    background: saving ? '#ccc' : 'linear-gradient(135deg, #4285f4 0%, #34a853 100%)',
                    color: 'white',
                    border: 'none',
                    borderRadius: '10px',
                    cursor: saving ? 'not-allowed' : 'pointer',
                    fontSize: '14px',
                    fontWeight: '600',
                    transition: 'transform 0.2s',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '10px'
                }}
                onMouseEnter={(e) => {
                    if (!saving) e.currentTarget.style.transform = 'translateY(-2px)';
                }}
                onMouseLeave={(e) => {
                    e.currentTarget.style.transform = 'translateY(0)';
                }}
            >
                <svg width="18" height="18" viewBox="0 0 48 48">
                    <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/>
                    <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/>
                    <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/>
                    <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/>
                </svg>
                {saving ? 'Connecting...' : 'Connect Google Services'}
            </button>
        </>
    )}
</div>
        </div>
    );
}

// ENHANCED GroupsView
function GroupsView({ user, searchQuery }) {
    const [groups, setGroups] = useState([]);
    const [filteredGroups, setFilteredGroups] = useState([]);
    const [loading, setLoading] = useState(true);
    const [showCreateModal, setShowCreateModal] = useState(false);
    const [selectedGroup, setSelectedGroup] = useState(null);
    const [viewMode, setViewMode] = useState('all');
    
    const daysOfWeek = ['all', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

    useEffect(() => {
        loadGroups();
    }, []);

    useEffect(() => {
        filterGroups();
    }, [groups, viewMode, searchQuery]);

    const loadGroups = async () => {
        try {
            const groupsSnap = await db.collection('groups')
                .orderBy('createdAt', 'desc')
                .get();
            
            const groupsData = [];
            
            for (const doc of groupsSnap.docs) {
                const groupData = { id: doc.id, ...doc.data() };
                
                if (groupData.members && groupData.members.length > 0) {
                    const memberResults = await batchQuery('users',
                        firebase.firestore.FieldPath.documentId(),
                        groupData.members
                    );
                    
                    groupData.membersData = memberResults.map(member => ({
                        id: member.id,
                        name: member.displayName || member.email
                    }));
                } else {
                    groupData.membersData = [];
                }
                
                groupsData.push(groupData);
            }
            
            setGroups(groupsData);
            setFilteredGroups(groupsData);
        } catch (error) {
            console.error('Error loading groups:', error);
        } finally {
            setLoading(false);
        }
    };

    const filterGroups = () => {
        let filtered = groups;
        
        if (viewMode !== 'all') {
            filtered = filtered.filter(group => 
                group.dayOfWeek?.toLowerCase() === viewMode.toLowerCase()
            );
        }
        
        if (searchQuery) {
            const query = searchQuery.toLowerCase();
            filtered = filtered.filter(group =>
                group.name?.toLowerCase().includes(query) ||
                group.description?.toLowerCase().includes(query)
            );
        }
        
        setFilteredGroups(filtered);
    };

    const getDayIcon = (day) => {
        const icons = {
            all: 'üìÖ',
            monday: '1Ô∏è‚É£',
            tuesday: '2Ô∏è‚É£',
            wednesday: '3Ô∏è‚É£',
            thursday: '4Ô∏è‚É£',
            friday: '5Ô∏è‚É£',
            saturday: '6Ô∏è‚É£',
            sunday: '7Ô∏è‚É£'
        };
        return icons[day] || 'üìÖ';
    };

    if (loading) {
        return (
            <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                minHeight: '400px',
                gap: '20px'
            }}>
                <div style={{
                    width: '60px',
                    height: '60px',
                    border: '4px solid #f3f3f3',
                    borderTop: '4px solid #667eea',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite'
                }}></div>
                <p style={{ color: '#666' }}>Loading groups...</p>
            </div>
        );
    }

    return (
        <div style={{ padding: '20px', animation: 'fadeIn 0.5s' }}>
            {/* Header Stats */}
            <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                gap: '20px',
                marginBottom: '30px'
            }}>
                <div style={{
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(102, 126, 234, 0.3)'
                }}>
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Total Groups</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {groups.length}
                    </div>
                </div>
                <div style={{
                    background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(240, 147, 251, 0.3)'
                }}>
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Total Members</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {groups.reduce((acc, g) => acc + (g.membersData?.length || 0), 0)}
                    </div>
                </div>
            </div>

            {/* Day Filters */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                marginBottom: '20px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '10px' }}>
                    <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                        {daysOfWeek.map(day => (
                            <button
                                key={day}
                                onClick={() => setViewMode(day)}
                                style={{
                                    padding: '8px 16px',
                                    background: viewMode === day 
                                        ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' 
                                        : '#f0f0f0',
                                    color: viewMode === day ? 'white' : '#666',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500',
                                    textTransform: 'capitalize',
                                    transition: 'all 0.2s'
                                }}
                            >
                                {getDayIcon(day)} {day}
                            </button>
                        ))}
                    </div>
                    
                    <button 
                        onClick={() => setShowCreateModal(true)}
                        style={{
                            padding: '10px 20px',
                            background: 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)',
                            color: 'white',
                            border: 'none',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '600',
                            transition: 'transform 0.2s'
                        }}
                        onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                        onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                    >
                        + Create Group
                    </button>
                </div>
            </div>
            
            {/* Groups Grid */}
            {filteredGroups.length === 0 ? (
                <div style={{
                    padding: '80px 20px',
                    textAlign: 'center',
                    background: 'white',
                    borderRadius: '20px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                }}>
                    <div style={{ fontSize: '64px', marginBottom: '20px' }}>üë•</div>
                    <div style={{ fontSize: '24px', fontWeight: '600', color: '#333', marginBottom: '10px' }}>
                        No Groups Found
                    </div>
                    <div style={{ fontSize: '16px', color: '#999' }}>
                        {viewMode === 'all' ? 'Create your first group to get started' : `No groups scheduled for ${viewMode}`}
                    </div>
                </div>
            ) : (
                <div style={{ display: 'grid', gap: '20px' }}>
                    {filteredGroups.map(group => (
                        <div key={group.id} style={{
                            background: 'white',
                            borderRadius: '20px',
                            padding: '30px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                            transition: 'all 0.2s',
                            cursor: 'pointer'
                        }}
                        onMouseEnter={(e) => {
                            e.currentTarget.style.transform = 'translateY(-5px)';
                            e.currentTarget.style.boxShadow = '0 8px 20px rgba(0,0,0,0.15)';
                        }}
                        onMouseLeave={(e) => {
                            e.currentTarget.style.transform = 'translateY(0)';
                            e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
                        }}
                        >
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '15px' }}>
                                <div style={{ flex: 1 }}>
                                    <h3 style={{ margin: '0 0 10px 0', fontSize: '22px', color: '#333' }}>
                                        {group.name}
                                    </h3>
                                    <div style={{ display: 'flex', gap: '15px', alignItems: 'center', fontSize: '14px', color: '#666' }}>
                                        <span style={{
                                            padding: '4px 12px',
                                            background: '#e3f2fd',
                                            color: '#1976d2',
                                            borderRadius: '20px',
                                            fontWeight: '500',
                                            textTransform: 'capitalize'
                                        }}>
                                            {group.dayOfWeek}
                                        </span>
                                        <span>{group.time}</span>
                                        <span style={{
                                            padding: '4px 12px',
                                            background: group.recurring ? '#d4edda' : '#fff3cd',
                                            color: group.recurring ? '#155724' : '#856404',
                                            borderRadius: '20px',
                                            fontSize: '12px',
                                            fontWeight: '500'
                                        }}>
                                            {group.recurring ? 'Recurring' : 'One-time'}
                                        </span>
                                    </div>
                                </div>
                                <button 
                                    onClick={() => setSelectedGroup(group)}
                                    style={{
                                        padding: '10px 20px',
                                        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '10px',
                                        cursor: 'pointer',
                                        fontSize: '14px',
                                        fontWeight: '600',
                                        transition: 'transform 0.2s'
                                    }}
                                    onMouseEnter={(e) => {
                                        e.stopPropagation();
                                        e.currentTarget.style.transform = 'scale(1.05)';
                                    }}
                                    onMouseLeave={(e) => {
                                        e.currentTarget.style.transform = 'scale(1)';
                                    }}
                                >
                                    View Details
                                </button>
                            </div>
                            
                            <p style={{ margin: '15px 0', color: '#666', lineHeight: '1.6' }}>
                                {group.description}
                            </p>
                            
                            {group.link && (
                                <a 
                                    href={group.link}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    onClick={(e) => e.stopPropagation()}
                                    style={{
                                        display: 'inline-flex',
                                        alignItems: 'center',
                                        gap: '8px',
                                        padding: '8px 16px',
                                        background: '#e3f2fd',
                                        color: '#1976d2',
                                        textDecoration: 'none',
                                        borderRadius: '8px',
                                        fontSize: '14px',
                                        fontWeight: '500',
                                        marginBottom: '15px',
                                        transition: 'background 0.2s'
                                    }}
                                    onMouseEnter={(e) => e.currentTarget.style.background = '#bbdefb'}
                                    onMouseLeave={(e) => e.currentTarget.style.background = '#e3f2fd'}
                                >
                                    üîó Join Meeting
                                </a>
                            )}
                            
                            <div style={{ marginTop: '20px', paddingTop: '20px', borderTop: '1px solid #f0f0f0' }}>
                                <div style={{ fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '12px' }}>
                                    Members ({group.membersData?.length || 0})
                                </div>
                                <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                                    {group.membersData?.slice(0, 10).map(member => (
                                        <div 
                                            key={member.id} 
                                            title={member.name}
                                            style={{
                                                width: '40px',
                                                height: '40px',
                                                borderRadius: '50%',
                                                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                                color: 'white',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontSize: '16px',
                                                fontWeight: 'bold',
                                                border: '2px solid white',
                                                boxShadow: '0 2px 8px rgba(0,0,0,0.15)'
                                            }}
                                        >
                                            {member.name.charAt(0).toUpperCase()}
                                        </div>
                                    ))}
                                    {group.membersData?.length > 10 && (
                                        <div style={{
                                            width: '40px',
                                            height: '40px',
                                            borderRadius: '50%',
                                            background: '#f0f0f0',
                                            color: '#666',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            fontSize: '12px',
                                            fontWeight: 'bold',
                                            border: '2px solid white'
                                        }}>
                                            +{group.membersData.length - 10}
                                        </div>
                                    )}
                                    {(!group.membersData || group.membersData.length === 0) && (
                                        <span style={{ fontSize: '14px', color: '#999', fontStyle: 'italic' }}>
                                            No members yet
                                        </span>
                                    )}
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            )}
            
            {showCreateModal && (
                <CreateGroupModal 
                    onClose={() => setShowCreateModal(false)}
                    onSuccess={() => {
                        setShowCreateModal(false);
                        loadGroups();
                    }}
                    adminId={user.uid}
                />
            )}
            
            {selectedGroup && (
                <GroupDetailModal 
                    group={selectedGroup}
                    onClose={() => setSelectedGroup(null)}
                    onUpdate={() => loadGroups()}
                />
            )}
        </div>
    );
}
       // Modern Enhanced Resources Management View - Resources Only
function ResourcesView({ user, searchQuery }) {
    const [loading, setLoading] = useState(true);
    const [resources, setResources] = useState([]);
    const [filteredItems, setFilteredItems] = useState([]);
    const [showCreateModal, setShowCreateModal] = useState(false);
    const [selectedItem, setSelectedItem] = useState(null);
    const [filterCategory, setFilterCategory] = useState('all');
    const [allPIRs, setAllPIRs] = useState([]);
    const [stats, setStats] = useState({
        activeResources: 0,
        pirAssignments: 0,
        completionRate: 0,
        engagementScore: 0,
        categoryBreakdown: {}
    });
    const [topResources, setTopResources] = useState([]);

    useEffect(() => {
        loadResourcesData();
        loadPIRs();
    }, []);

    useEffect(() => {
        filterItems();
    }, [searchQuery, resources, filterCategory]);

    const loadPIRs = async () => {
        try {
            const pirsSnap = await db.collection('users')
                .where('role', '==', 'pir')
                .get();
            
            const pirsData = [];
            pirsSnap.forEach(doc => {
                const data = doc.data();
                pirsData.push({
                    id: doc.id,
                    name: data.displayName || `${data.firstName} ${data.lastName}` || data.email,
                    email: data.email
                });
            });
            setAllPIRs(pirsData);
        } catch (error) {
            console.error('Error loading PIRs:', error);
        }
    };

    const loadResourcesData = async () => {
        try {
            setLoading(true);

            // Load all resources
            const resourcesSnap = await db.collection('resources')
                .orderBy('addedAt', 'desc')
                .get();
            
            const resourcesData = [];
            let activeCount = 0;
            let assignedCount = 0;
            let totalViews = 0;
            let completedCount = 0;
            let totalAssigned = 0;
            const categoryCount = {
                coping: 0,
                relapse: 0,
                daily: 0,
                education: 0,
                support: 0,
                life: 0
            };
            const resourceViewCounts = [];
            
            for (const doc of resourcesSnap.docs) {
                const data = { id: doc.id, ...doc.data() };
                
                // Count active resources
                if (data.active) activeCount++;
                
                // Count PIR assignments
                if (data.assignedTo && data.assignedTo.length > 0) {
                    assignedCount += data.assignedTo.length;
                    totalAssigned++;
                }
                
                // Category breakdown
                if (data.category && categoryCount[data.category] !== undefined) {
                    categoryCount[data.category]++;
                }
                
                // Count views from subcollections
                try {
                    const viewsSnap = await db.collectionGroup('resourceViews')
                        .where('resourceId', '==', doc.id)
                        .get();
                    data.viewCount = viewsSnap.size;
                    totalViews += data.viewCount;
                    
                    resourceViewCounts.push({
                        id: doc.id,
                        title: data.title,
                        viewCount: data.viewCount,
                        category: data.category
                    });
                } catch (error) {
                    data.viewCount = 0;
                }
                
                // Count completions
                try {
                    const progressSnap = await db.collectionGroup('resourceProgress')
                        .where('resourceId', '==', doc.id)
                        .where('status', '==', 'completed')
                        .get();
                    data.completionCount = progressSnap.size;
                    completedCount += data.completionCount;
                } catch (error) {
                    data.completionCount = 0;
                }
                
                resourcesData.push(data);
            }
            
            // Sort for top resources
            const sortedByViews = resourceViewCounts.sort((a, b) => b.viewCount - a.viewCount);
            setTopResources(sortedByViews.slice(0, 5));
            
            // Calculate stats
            const completionRate = totalAssigned > 0 ? 
                Math.round((completedCount / assignedCount) * 100) : 0;
            
            const engagementScore = activeCount > 0 ? 
                Math.round((totalViews / activeCount) * 10) : 0;
            
            setStats({
                activeResources: activeCount,
                pirAssignments: assignedCount,
                completionRate: completionRate,
                engagementScore: Math.min(engagementScore, 100),
                categoryBreakdown: categoryCount
            });
            
            setResources(resourcesData);

        } catch (error) {
            console.error('Error loading resources:', error);
        } finally {
            setLoading(false);
        }
    };

    const filterItems = () => {
        let items = filterCategory === 'all' ? 
            resources : 
            resources.filter(r => r.category === filterCategory);

        if (searchQuery) {
            const query = searchQuery.toLowerCase();
            items = items.filter(item =>
                item.title?.toLowerCase().includes(query) ||
                item.description?.toLowerCase().includes(query)
            );
        }

        setFilteredItems(items);
    };

    const handleCreateResource = async (resourceData) => {
        try {
            await db.collection('resources').add({
                ...resourceData,
                addedAt: firebase.firestore.FieldValue.serverTimestamp(),
                addedBy: user.uid,
                active: true
            });

            alert('Resource created successfully!');
            setShowCreateModal(false);
            loadResourcesData();
        } catch (error) {
            console.error('Error creating resource:', error);
            alert('Failed to create resource');
        }
    };

    const handleToggleActive = async (itemId, currentStatus) => {
        try {
            await db.collection('resources').doc(itemId).update({
                active: !currentStatus
            });
            loadResourcesData();
        } catch (error) {
            console.error('Error updating status:', error);
        }
    };

    const handleDelete = async (itemId, itemName) => {
        if (confirm(`Delete "${itemName}"? This cannot be undone.`)) {
            try {
                await db.collection('resources').doc(itemId).delete();
                alert('Resource deleted successfully');
                loadResourcesData();
            } catch (error) {
                console.error('Error deleting resource:', error);
                alert('Failed to delete resource');
            }
        }
    };

    const handleEdit = (item) => {
        setSelectedItem(item);
        setShowCreateModal(true);
    };

    const formatDate = (date) => {
        if (!date) return 'N/A';
        const d = date?.toDate ? date.toDate() : new Date(date);
        return d.toLocaleDateString();
    };

    return (
        <div className="resources-view">
            {/* Modern Stats Section */}
            <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                gap: '20px',
                marginBottom: '30px'
            }}>
                <div style={{
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    borderRadius: '15px',
                    padding: '20px',
                    color: 'white',
                    boxShadow: '0 10px 30px rgba(0,0,0,0.2)',
                    transform: 'translateY(0)',
                    transition: 'transform 0.3s ease',
                    cursor: 'pointer'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}>
                    <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{stats.activeResources}</div>
                    <div style={{ fontSize: '14px', opacity: 0.9, marginTop: '5px' }}>Active Resources</div>
                    <div style={{ fontSize: '12px', opacity: 0.7, marginTop: '5px' }}>
                        Currently available
                    </div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    borderRadius: '15px',
                    padding: '20px',
                    color: 'white',
                    boxShadow: '0 10px 30px rgba(0,0,0,0.2)',
                    transform: 'translateY(0)',
                    transition: 'transform 0.3s ease',
                    cursor: 'pointer'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}>
                    <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{stats.pirAssignments}</div>
                    <div style={{ fontSize: '14px', opacity: 0.9, marginTop: '5px' }}>PIR Assignments</div>
                    <div style={{ fontSize: '12px', opacity: 0.7, marginTop: '5px' }}>
                        Total assigned
                    </div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    borderRadius: '15px',
                    padding: '20px',
                    color: 'white',
                    boxShadow: '0 10px 30px rgba(0,0,0,0.2)',
                    transform: 'translateY(0)',
                    transition: 'transform 0.3s ease',
                    cursor: 'pointer'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}>
                    <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{stats.completionRate}%</div>
                    <div style={{ fontSize: '14px', opacity: 0.9, marginTop: '5px' }}>Completion Rate</div>
                    <div style={{ fontSize: '12px', opacity: 0.7, marginTop: '5px' }}>
                        Resource effectiveness
                    </div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    borderRadius: '15px',
                    padding: '20px',
                    color: 'white',
                    boxShadow: '0 10px 30px rgba(0,0,0,0.2)',
                    transform: 'translateY(0)',
                    transition: 'transform 0.3s ease',
                    cursor: 'pointer'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}>
                    <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{stats.engagementScore}</div>
                    <div style={{ fontSize: '14px', opacity: 0.9, marginTop: '5px' }}>Engagement Score</div>
                    <div style={{ fontSize: '12px', opacity: 0.7, marginTop: '5px' }}>
                        Average views/resource
                    </div>
                </div>
            </div>

            {/* Category Distribution */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                marginBottom: '20px',
                boxShadow: '0 5px 15px rgba(0,0,0,0.1)'
            }}>
                <h4 style={{ marginBottom: '15px', color: '#333' }}>Category Distribution</h4>
                <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                    {Object.entries(stats.categoryBreakdown).map(([category, count]) => (
                        <div key={category} style={{
                            background: count > 0 ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#e0e0e0',
                            color: count > 0 ? 'white' : '#666',
                            padding: '8px 16px',
                            borderRadius: '20px',
                            fontSize: '14px',
                            fontWeight: '500'
                        }}>
                            {category}: {count}
                        </div>
                    ))}
                </div>
            </div>

            {/* Top Resources */}
            {topResources.length > 0 && (
                <div style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '20px',
                    marginBottom: '20px',
                    boxShadow: '0 5px 15px rgba(0,0,0,0.1)'
                }}>
                    <h4 style={{ marginBottom: '15px', color: '#333' }}>Most Viewed Resources</h4>
                    <div style={{ display: 'grid', gap: '10px' }}>
                        {topResources.map((resource, index) => (
                            <div key={resource.id} style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                padding: '10px',
                                background: '#f5f5f5',
                                borderRadius: '8px'
                            }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                    <span style={{
                                        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                        color: 'white',
                                        width: '25px',
                                        height: '25px',
                                        borderRadius: '50%',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        fontSize: '12px',
                                        fontWeight: 'bold'
                                    }}>
                                        {index + 1}
                                    </span>
                                    <span style={{ fontSize: '14px', color: '#333' }}>{resource.title}</span>
                                </div>
                                <span style={{
                                    background: '#667eea',
                                    color: 'white',
                                    padding: '2px 8px',
                                    borderRadius: '12px',
                                    fontSize: '12px'
                                }}>
                                    {resource.viewCount} views
                                </span>
                            </div>
                        ))}
                    </div>
                </div>
            )}

            {/* Resources Section */}
            <div className="resources-container">
                <div style={{
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    marginBottom: '20px'
                }}>
                    <h3 style={{ margin: 0, color: '#333' }}>Recovery Resources</h3>
                    <button 
                        onClick={() => {
                            setSelectedItem(null);
                            setShowCreateModal(true);
                        }}
                        style={{
                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            color: 'white',
                            border: 'none',
                            padding: '12px 24px',
                            borderRadius: '25px',
                            cursor: 'pointer',
                            fontWeight: '500',
                            boxShadow: '0 5px 15px rgba(102, 126, 234, 0.4)',
                            transition: 'all 0.3s ease',
                            fontSize: '14px'
                        }}
                        onMouseEnter={(e) => {
                            e.target.style.transform = 'translateY(-2px)';
                            e.target.style.boxShadow = '0 8px 20px rgba(102, 126, 234, 0.5)';
                        }}
                        onMouseLeave={(e) => {
                            e.target.style.transform = 'translateY(0)';
                            e.target.style.boxShadow = '0 5px 15px rgba(102, 126, 234, 0.4)';
                        }}
                    >
                        + Add Resource
                    </button>
                </div>

                <div className="filter-row" style={{
                    display: 'flex',
                    gap: '10px',
                    marginBottom: '20px',
                    flexWrap: 'wrap'
                }}>
                    <button 
                        className={`filter-btn ${filterCategory === 'all' ? 'active' : ''}`}
                        onClick={() => setFilterCategory('all')}
                        style={{
                            padding: '8px 16px',
                            borderRadius: '20px',
                            border: filterCategory === 'all' ? 'none' : '1px solid #ddd',
                            background: filterCategory === 'all' ? 
                                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'white',
                            color: filterCategory === 'all' ? 'white' : '#666',
                            cursor: 'pointer',
                            transition: 'all 0.3s ease'
                        }}
                    >
                        All ({resources.length})
                    </button>
                    {['coping', 'relapse', 'daily', 'education', 'support', 'life'].map(category => (
                        <button 
                            key={category}
                            className={`filter-btn ${filterCategory === category ? 'active' : ''}`}
                            onClick={() => setFilterCategory(category)}
                            style={{
                                padding: '8px 16px',
                                borderRadius: '20px',
                                border: filterCategory === category ? 'none' : '1px solid #ddd',
                                background: filterCategory === category ? 
                                    'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'white',
                                color: filterCategory === category ? 'white' : '#666',
                                cursor: 'pointer',
                                transition: 'all 0.3s ease',
                                textTransform: 'capitalize'
                            }}
                        >
                            {category === 'coping' ? 'Coping Skills' :
                             category === 'relapse' ? 'Relapse Prevention' :
                             category === 'daily' ? 'Daily Recovery' :
                             category === 'education' ? 'Education' :
                             category === 'support' ? 'Support' :
                             'Life Skills'}
                        </button>
                    ))}
                </div>

                <div className="resources-grid" style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(auto-fill, minmax(350px, 1fr))',
                    gap: '20px'
                }}>
                    {filteredItems.map(resource => (
                        <div key={resource.id} style={{
                            background: 'white',
                            borderRadius: '15px',
                            padding: '20px',
                            boxShadow: '0 5px 15px rgba(0,0,0,0.1)',
                            transition: 'all 0.3s ease',
                            cursor: 'pointer'
                        }}
                        onMouseEnter={(e) => {
                            e.currentTarget.style.transform = 'translateY(-5px)';
                            e.currentTarget.style.boxShadow = '0 10px 30px rgba(0,0,0,0.15)';
                        }}
                        onMouseLeave={(e) => {
                            e.currentTarget.style.transform = 'translateY(0)';
                            e.currentTarget.style.boxShadow = '0 5px 15px rgba(0,0,0,0.1)';
                        }}>
                            <div style={{ marginBottom: '15px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start' }}>
                                    <h4 style={{ margin: 0, color: '#333' }}>{resource.title}</h4>
                                    <div style={{ display: 'flex', gap: '5px', alignItems: 'center' }}>
                                        {resource.isGlobal && (
                                            <span style={{
                                                background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                                                color: 'white',
                                                padding: '4px 8px',
                                                borderRadius: '12px',
                                                fontSize: '10px'
                                            }}>üåç Global</span>
                                        )}
                                        <span style={{
                                            background: resource.category === 'coping' ? '#4CAF50' :
                                                       resource.category === 'relapse' ? '#ff9500' :
                                                       resource.category === 'daily' ? '#2196F3' :
                                                       resource.category === 'education' ? '#9c27b0' :
                                                       resource.category === 'support' ? '#00bcd4' :
                                                       '#ff5722',
                                            color: 'white',
                                            padding: '4px 8px',
                                            borderRadius: '12px',
                                            fontSize: '10px',
                                            textTransform: 'capitalize'
                                        }}>
                                            {resource.category}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <p style={{ color: '#666', fontSize: '14px', marginBottom: '15px' }}>
                                {resource.description}
                            </p>

                            {resource.url && (
                                <a href={resource.url} target="_blank" rel="noopener noreferrer" 
                                   style={{ color: '#667eea', fontSize: '13px', textDecoration: 'none' }}>
                                    üîó External Link
                                </a>
                            )}
                            
                            {resource.fileURL && (
                                <a href={resource.fileURL} target="_blank" rel="noopener noreferrer"
                                   style={{ color: '#667eea', fontSize: '13px', textDecoration: 'none', marginLeft: '10px' }}>
                                    üìÑ Download
                                </a>
                            )}

                            <div style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                marginTop: '15px',
                                paddingTop: '15px',
                                borderTop: '1px solid #eee'
                            }}>
                                <div style={{ display: 'flex', gap: '15px', fontSize: '12px', color: '#999' }}>
                                    <span>üëÅÔ∏è {resource.viewCount || 0}</span>
                                    <span>‚úÖ {resource.completionCount || 0}</span>
                                    <span>üìÖ {formatDate(resource.addedAt)}</span>
                                </div>
                                
                                <div style={{ display: 'flex', gap: '5px' }}>
                                    <button 
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            handleToggleActive(resource.id, resource.active);
                                        }}
                                        style={{
                                            background: resource.active ? '#4CAF50' : '#999',
                                            color: 'white',
                                            border: 'none',
                                            padding: '5px 10px',
                                            borderRadius: '5px',
                                            fontSize: '11px',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        {resource.active ? 'Active' : 'Inactive'}
                                    </button>
                                    <button 
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            handleEdit(resource);
                                        }}
                                        style={{
                                            background: '#2196F3',
                                            color: 'white',
                                            border: 'none',
                                            padding: '5px 10px',
                                            borderRadius: '5px',
                                            fontSize: '11px',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        Edit
                                    </button>
                                    <button 
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            handleDelete(resource.id, resource.title);
                                        }}
                                        style={{
                                            background: '#f44336',
                                            color: 'white',
                                            border: 'none',
                                            padding: '5px 10px',
                                            borderRadius: '5px',
                                            fontSize: '11px',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        Delete
                                    </button>
                                </div>
                            </div>

                            {!resource.isGlobal && resource.assignedTo && resource.assignedTo.length > 0 && (
                                <div style={{
                                    marginTop: '10px',
                                    padding: '8px',
                                    background: '#f5f5f5',
                                    borderRadius: '8px',
                                    fontSize: '12px',
                                    color: '#666'
                                }}>
                                    Assigned to {resource.assignedTo.length} PIR(s)
                                </div>
                            )}
                        </div>
                    ))}
                </div>

                {filteredItems.length === 0 && (
                    <div style={{
                        textAlign: 'center',
                        padding: '60px 20px',
                        color: '#999'
                    }}>
                        {resources.length === 0 ? 
                            'No resources added yet. Click "Add Resource" to create your first resource.' : 
                            'No resources match your filter.'}
                    </div>
                )}
            </div>

            {loading && (
                <div style={{
                    position: 'absolute',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(255,255,255,0.9)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                }}>
                    <div className="loading-spinner"></div>
                </div>
            )}

            {showCreateModal && (
                <ResourceModal
                    resource={selectedItem}
                    allPIRs={allPIRs}
                    onSave={handleCreateResource}
                    onClose={() => {
                        setShowCreateModal(false);
                        setSelectedItem(null);
                    }}
                />
            )}
        </div>
    );
}

// Keep the existing ResourceModal component as-is but remove meeting functionality
function ResourceModal({ resource, allPIRs, onSave, onClose }) {
    // Keep only the resource part of the modal, same as before
    const [formData, setFormData] = useState(() => {
        if (resource) {
            return {
                ...resource,
                assignedTo: resource.assignedTo || []
            };
        }
        
        return {
            title: '',
            description: '',
            category: 'coping',
            contentType: 'link',
            url: '',
            content: '',
            fileURL: '',
            embedUrl: '',
            isGlobal: false,
            assignedTo: [],
            active: true
        };
    });

    const [selectedPIRs, setSelectedPIRs] = useState(resource?.assignedTo || []);

    const handleSubmit = (e) => {
        e.preventDefault();
        
        if (!formData.title || !formData.description || !formData.category) {
            alert('Please fill in all required fields');
            return;
        }
        
        // Validate content based on type
        if (formData.contentType === 'link' && !formData.url) {
            alert('Please provide a URL');
            return;
        }
        if (formData.contentType === 'text' && !formData.content) {
            alert('Please provide content');
            return;
        }
        
        // Set assignedTo based on global status
        const finalData = {
            ...formData,
            assignedTo: formData.isGlobal ? [] : selectedPIRs
        };
        
        onSave(finalData);
    };

    const handlePIRSelection = (pirId) => {
        if (selectedPIRs.includes(pirId)) {
            setSelectedPIRs(selectedPIRs.filter(id => id !== pirId));
        } else {
            setSelectedPIRs([...selectedPIRs, pirId]);
        }
    };

    const selectAllPIRs = () => {
        setSelectedPIRs(allPIRs.map(pir => pir.id));
    };

    const clearSelection = () => {
        setSelectedPIRs([]);
    };

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{maxWidth: '700px', maxHeight: '90vh', overflowY: 'auto'}}>
                <div className="modal-header">
                    <h3>{resource ? 'Edit' : 'Create'} Resource</h3>
                    <button className="close-btn" onClick={onClose}>√ó</button>
                </div>
                
                <form onSubmit={handleSubmit} className="modal-body">
                    <div className="form-group">
                        <label>Title *</label>
                        <input
                            type="text"
                            value={formData.title}
                            onChange={(e) => setFormData({...formData, title: e.target.value})}
                            placeholder="Resource title"
                            required
                        />
                    </div>
                    
                    <div className="form-group">
                        <label>Description *</label>
                        <textarea
                            value={formData.description}
                            onChange={(e) => setFormData({...formData, description: e.target.value})}
                            placeholder="Describe this resource"
                            rows="3"
                            required
                        />
                    </div>
                    
                    <div className="form-row">
                        <div className="form-group">
                            <label>Category *</label>
                            <select
                                value={formData.category}
                                onChange={(e) => setFormData({...formData, category: e.target.value})}
                            >
                                <option value="coping">Coping Skills</option>
                                <option value="relapse">Relapse Prevention</option>
                                <option value="daily">Daily Recovery</option>
                                <option value="education">Education</option>
                                <option value="support">Support</option>
                                <option value="life">Life Skills</option>
                            </select>
                        </div>
                        
                        <div className="form-group">
                            <label>Content Type</label>
                            <select
                                value={formData.contentType}
                                onChange={(e) => setFormData({...formData, contentType: e.target.value})}
                            >
                                <option value="link">External Link</option>
                                <option value="text">Text Content</option>
                                <option value="file">File Upload</option>
                                <option value="embed">Embedded Content</option>
                            </select>
                        </div>
                    </div>
                    
                    {formData.contentType === 'link' && (
                        <div className="form-group">
                            <label>URL</label>
                            <input
                                type="url"
                                value={formData.url}
                                onChange={(e) => setFormData({...formData, url: e.target.value})}
                                placeholder="https://..."
                            />
                        </div>
                    )}
                    
                    {formData.contentType === 'text' && (
                        <div className="form-group">
                            <label>Content</label>
                            <textarea
                                value={formData.content}
                                onChange={(e) => setFormData({...formData, content: e.target.value})}
                                placeholder="Enter content"
                                rows="6"
                            />
                        </div>
                    )}
                    
                    {formData.contentType === 'file' && (
                        <div className="form-group">
                            <label>File URL</label>
                            <input
                                type="url"
                                value={formData.fileURL}
                                onChange={(e) => setFormData({...formData, fileURL: e.target.value})}
                                placeholder="URL to downloadable file"
                            />
                        </div>
                    )}
                    
                    {formData.contentType === 'embed' && (
                        <div className="form-group">
                            <label>Embed URL</label>
                            <input
                                type="url"
                                value={formData.embedUrl}
                                onChange={(e) => setFormData({...formData, embedUrl: e.target.value})}
                                placeholder="YouTube, Vimeo, etc."
                            />
                        </div>
                    )}
                    
                    <div className="form-group">
                        <label style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                            <input
                                type="checkbox"
                                checked={formData.isGlobal}
                                onChange={(e) => setFormData({...formData, isGlobal: e.target.checked})}
                            />
                            <span>Make this a global resource (available to all PIRs)</span>
                        </label>
                    </div>
                    
                    {!formData.isGlobal && (
                        <div className="form-group">
                            <label>Assign to PIRs</label>
                            <div style={{marginBottom: '10px'}}>
                                <button type="button" className="btn btn-sm" onClick={selectAllPIRs}>
                                    Select All
                                </button>
                                <button type="button" className="btn btn-sm" onClick={clearSelection} style={{marginLeft: '10px'}}>
                                    Clear All
                                </button>
                                <span style={{marginLeft: '10px'}}>
                                    {selectedPIRs.length} selected
                                </span>
                            </div>
                            <div style={{
                                maxHeight: '200px',
                                overflowY: 'auto',
                                border: '1px solid #ddd',
                                borderRadius: '4px',
                                padding: '10px'
                            }}>
                                {allPIRs.map(pir => (
                                    <label key={pir.id} style={{
                                        display: 'block',
                                        padding: '5px',
                                        cursor: 'pointer',
                                        backgroundColor: selectedPIRs.includes(pir.id) ? '#e3f2fd' : 'transparent'
                                    }}>
                                        <input
                                            type="checkbox"
                                            checked={selectedPIRs.includes(pir.id)}
                                            onChange={() => handlePIRSelection(pir.id)}
                                            style={{marginRight: '10px'}}
                                        />
                                        {pir.name} ({pir.email})
                                    </label>
                                ))}
                                {allPIRs.length === 0 && (
                                    <div style={{color: '#999', textAlign: 'center'}}>
                                        No PIRs available
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                    
                    <div className="form-group">
                        <label style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                            <input
                                type="checkbox"
                                checked={formData.active}
                                onChange={(e) => setFormData({...formData, active: e.target.checked})}
                            />
                            <span>Resource is active</span>
                        </label>
                    </div>
                    
                    <div className="modal-footer">
                        <button type="submit" className="btn btn-primary">
                            {resource ? 'Update' : 'Create'}
                        </button>
                        <button type="button" className="btn btn-secondary" onClick={onClose}>
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
}
      // COMPLETE ENHANCED CHECK-INS VIEW - ALL FEATURES WITH ANALYTICS
function CheckInsView({ searchQuery }) {
    const [checkIns, setCheckIns] = useState([]);
    const [filteredCheckIns, setFilteredCheckIns] = useState([]);
    const [loading, setLoading] = useState(true);
    const [currentPage, setCurrentPage] = useState(1);
    const [filterUser, setFilterUser] = useState('all');
    const [filterMood, setFilterMood] = useState('all');
    const [filterCraving, setFilterCraving] = useState('all');
    const [filterAnxiety, setFilterAnxiety] = useState('all');
    const [filterSleep, setFilterSleep] = useState('all');
    const [filterDate, setFilterDate] = useState('all');
    const [filterCompletion, setFilterCompletion] = useState('all');
    const [filterRisk, setFilterRisk] = useState('all');
    const [users, setUsers] = useState([]);
    const [selectedCheckIn, setSelectedCheckIn] = useState(null);
    const [activeTab, setActiveTab] = useState('all');
    const [sortBy, setSortBy] = useState('date');
    const [selectedCheckIns, setSelectedCheckIns] = useState(new Set());
    const [showCharts, setShowCharts] = useState(false);
    const [coachNotes, setCoachNotes] = useState({});
    const [reviewedCheckIns, setReviewedCheckIns] = useState(new Set());
    const [analyticsData, setAnalyticsData] = useState(null);
    const [showAnalytics, setShowAnalytics] = useState(false);
    const [selectedPIRForReport, setSelectedPIRForReport] = useState(null);
    
    const moodChartRef = useRef(null);
    const cravingChartRef = useRef(null);
    const anxietyChartRef = useRef(null);
    const sleepChartRef = useRef(null);
    const completionChartRef = useRef(null);
    const chartInstances = useRef({});
    
    const itemsPerPage = 20;

    useEffect(() => {
        loadCheckInsAndUsers();
        loadCoachData();
    }, []);

    useEffect(() => {
        filterCheckIns();
    }, [checkIns, filterUser, filterMood, filterCraving, filterAnxiety, filterSleep, filterDate, filterCompletion, filterRisk, searchQuery, activeTab, sortBy]);

    useEffect(() => {
        if (showCharts && filteredCheckIns.length > 0) {
            renderCharts();
        }
        
        return () => {
            Object.values(chartInstances.current).forEach(chart => {
                if (chart) chart.destroy();
            });
        };
    }, [showCharts, filteredCheckIns]);

    useEffect(() => {
        if (checkIns.length > 0) {
            calculateAnalytics();
        }
    }, [checkIns]);

    const loadCheckInsAndUsers = async () => {
        try {
            const usersSnap = await db.collection('users')
                .where('role', '==', 'pir')
                .get();
            
            const usersData = [];
            const userMap = {};
            
            usersSnap.forEach(doc => {
                const user = { id: doc.id, ...doc.data() };
                usersData.push(user);
                userMap[doc.id] = user.displayName || user.email;
            });
            
            setUsers(usersData);

            const checkInsSnap = await db.collection('checkIns')
                .orderBy('createdAt', 'desc')
                .limit(1000)
                .get();
            
            const checkInsData = [];
            checkInsSnap.forEach(doc => {
                const checkIn = { id: doc.id, ...doc.data() };
                checkIn.userName = userMap[checkIn.userId] || 'Unknown User';
                checkIn.riskLevel = calculateRiskLevel(checkIn);
                checkIn.completionStatus = getCompletionStatus(checkIn);
                checkInsData.push(checkIn);
            });
            
            setCheckIns(checkInsData);
        } catch (error) {
            console.error('Error loading check-ins:', error);
            alert('Failed to load check-ins');
        } finally {
            setLoading(false);
        }
    };

    const loadCoachData = async () => {
        try {
            const notesSnap = await db.collection('coachNotes')
                .where('type', '==', 'checkin')
                .get();
            
            const notes = {};
            notesSnap.forEach(doc => {
                notes[doc.data().checkInId] = doc.data();
            });
            setCoachNotes(notes);

            const reviewedSnap = await db.collection('checkInReviews')
                .get();
            
            const reviewed = new Set();
            reviewedSnap.forEach(doc => {
                reviewed.add(doc.data().checkInId);
            });
            setReviewedCheckIns(reviewed);
        } catch (error) {
            console.error('Error loading coach data:', error);
        }
    };

    const calculateRiskLevel = (checkIn) => {
        const morningMood = checkIn.morningData?.mood ?? 10;
        const morningCraving = checkIn.morningData?.craving ?? 0;
        const anxiety = checkIn.eveningData?.anxiety ?? 0;
        
        if (morningMood <= 3 && morningCraving >= 7) return 'critical';
        if (morningMood <= 4 && morningCraving >= 6) return 'high';
        if (morningMood <= 5 || morningCraving >= 5 || anxiety >= 7) return 'moderate';
        return 'low';
    };

    const getCompletionStatus = (checkIn) => {
        const hasMorning = checkIn.morningData && Object.keys(checkIn.morningData).length > 0;
        const hasEvening = checkIn.eveningData && Object.keys(checkIn.eveningData).length > 0;
        
        if (hasMorning && hasEvening) return 'complete';
        if (hasMorning && !hasEvening) return 'morning-only';
        if (!hasMorning && hasEvening) return 'evening-only';
        return 'incomplete';
    };

    const calculateAnalytics = () => {
        const pirStats = {};
        const allPIRsData = {
            totalCheckIns: checkIns.length,
            avgMood: 0,
            avgCraving: 0,
            avgAnxiety: 0,
            avgSleep: 0,
            completionRate: 0,
            last30Days: {
                avgMood: 0,
                avgCraving: 0,
                avgAnxiety: 0,
                avgSleep: 0,
                completionRate: 0
            }
        };

        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

        // Calculate per-PIR stats
        checkIns.forEach(checkIn => {
            if (!pirStats[checkIn.userId]) {
                pirStats[checkIn.userId] = {
                    userName: checkIn.userName,
                    userId: checkIn.userId,
                    totalCheckIns: 0,
                    completeCheckIns: 0,
                    moodSum: 0,
                    moodCount: 0,
                    cravingSum: 0,
                    cravingCount: 0,
                    anxietySum: 0,
                    anxietyCount: 0,
                    sleepSum: 0,
                    sleepCount: 0,
                    last30: {
                        totalCheckIns: 0,
                        completeCheckIns: 0,
                        moodSum: 0,
                        moodCount: 0,
                        cravingSum: 0,
                        cravingCount: 0,
                        anxietySum: 0,
                        anxietyCount: 0,
                        sleepSum: 0,
                        sleepCount: 0
                    }
                };
            }

            const stat = pirStats[checkIn.userId];
            const checkInDate = checkIn.createdAt?.toDate ? checkIn.createdAt.toDate() : new Date(checkIn.createdAt);
            const isLast30 = checkInDate >= thirtyDaysAgo;

            stat.totalCheckIns++;
            if (checkIn.completionStatus === 'complete') stat.completeCheckIns++;

            if (checkIn.morningData?.mood != null) {
                stat.moodSum += checkIn.morningData.mood;
                stat.moodCount++;
            }
            if (checkIn.morningData?.craving != null) {
                stat.cravingSum += checkIn.morningData.craving;
                stat.cravingCount++;
            }
           if (checkIn.morningData?.anxietyLevel != null) {
    stat.anxietySum += checkIn.morningData.anxietyLevel;
    stat.anxietyCount++;
}
if (checkIn.morningData?.sleepQuality != null) {
    stat.sleepSum += checkIn.morningData.sleepQuality;
    stat.sleepCount++;
}

            if (isLast30) {
                stat.last30.totalCheckIns++;
                if (checkIn.completionStatus === 'complete') stat.last30.completeCheckIns++;
                
                if (checkIn.morningData?.mood != null) {
                    stat.last30.moodSum += checkIn.morningData.mood;
                    stat.last30.moodCount++;
                }
                if (checkIn.morningData?.craving != null) {
                    stat.last30.cravingSum += checkIn.morningData.craving;
                    stat.last30.cravingCount++;
                }
                if (checkIn.morningData?.anxietyLevel != null) {
    stat.last30.anxietySum += checkIn.morningData.anxietyLevel;
    stat.last30.anxietyCount++;
}
if (checkIn.morningData?.sleepQuality != null) {
    stat.last30.sleepSum += checkIn.morningData.sleepQuality;
    stat.last30.sleepCount++;
}
            }
        });

        // Calculate averages
        Object.values(pirStats).forEach(stat => {
            stat.avgMood = stat.moodCount > 0 ? (stat.moodSum / stat.moodCount).toFixed(1) : 'N/A';
            stat.avgCraving = stat.cravingCount > 0 ? (stat.cravingSum / stat.cravingCount).toFixed(1) : 'N/A';
            stat.avgAnxiety = stat.anxietyCount > 0 ? (stat.anxietySum / stat.anxietyCount).toFixed(1) : 'N/A';
            stat.avgSleep = stat.sleepCount > 0 ? (stat.sleepSum / stat.sleepCount).toFixed(1) : 'N/A';
            stat.completionRate = stat.totalCheckIns > 0 ? Math.round((stat.completeCheckIns / stat.totalCheckIns) * 100) : 0;

            stat.last30.avgMood = stat.last30.moodCount > 0 ? (stat.last30.moodSum / stat.last30.moodCount).toFixed(1) : 'N/A';
            stat.last30.avgCraving = stat.last30.cravingCount > 0 ? (stat.last30.cravingSum / stat.last30.cravingCount).toFixed(1) : 'N/A';
            stat.last30.avgAnxiety = stat.last30.anxietyCount > 0 ? (stat.last30.anxietySum / stat.last30.anxietyCount).toFixed(1) : 'N/A';
            stat.last30.avgSleep = stat.last30.sleepCount > 0 ? (stat.last30.sleepSum / stat.last30.sleepCount).toFixed(1) : 'N/A';
            stat.last30.completionRate = stat.last30.totalCheckIns > 0 ? Math.round((stat.last30.completeCheckIns / stat.last30.totalCheckIns) * 100) : 0;
        });

        // Calculate all-PIRs aggregate
        let totalMood = 0, totalCraving = 0, totalAnxiety = 0, totalSleep = 0;
        let moodCount = 0, cravingCount = 0, anxietyCount = 0, sleepCount = 0;
        let completeCount = 0;
        let last30Mood = 0, last30Craving = 0, last30Anxiety = 0, last30Sleep = 0;
        let last30MoodCount = 0, last30CravingCount = 0, last30AnxietyCount = 0, last30SleepCount = 0;
        let last30Complete = 0, last30Total = 0;

        checkIns.forEach(checkIn => {
            const checkInDate = checkIn.createdAt?.toDate ? checkIn.createdAt.toDate() : new Date(checkIn.createdAt);
            const isLast30 = checkInDate >= thirtyDaysAgo;

            if (checkIn.completionStatus === 'complete') completeCount++;
            
            if (checkIn.morningData?.mood != null) {
                totalMood += checkIn.morningData.mood;
                moodCount++;
            }
            if (checkIn.morningData?.craving != null) {
                totalCraving += checkIn.morningData.craving;
                cravingCount++;
            }
            if (checkIn.morningData?.anxietyLevel != null) {
    totalAnxiety += checkIn.morningData.anxietyLevel;
    anxietyCount++;
}
if (checkIn.morningData?.sleepQuality != null) {
    totalSleep += checkIn.morningData.sleepQuality;
    sleepCount++;
}

            if (isLast30) {
                last30Total++;
                if (checkIn.completionStatus === 'complete') last30Complete++;
                
                if (checkIn.morningData?.mood != null) {
                    last30Mood += checkIn.morningData.mood;
                    last30MoodCount++;
                }
                if (checkIn.morningData?.craving != null) {
                    last30Craving += checkIn.morningData.craving;
                    last30CravingCount++;
                }
               if (checkIn.morningData?.anxietyLevel != null) {
    last30Anxiety += checkIn.morningData.anxietyLevel;
    last30AnxietyCount++;
}
if (checkIn.morningData?.sleepQuality != null) {
    last30Sleep += checkIn.morningData.sleepQuality;
    last30SleepCount++;
}
            }
        });

        allPIRsData.avgMood = moodCount > 0 ? (totalMood / moodCount).toFixed(1) : 'N/A';
        allPIRsData.avgCraving = cravingCount > 0 ? (totalCraving / cravingCount).toFixed(1) : 'N/A';
        allPIRsData.avgAnxiety = anxietyCount > 0 ? (totalAnxiety / anxietyCount).toFixed(1) : 'N/A';
        allPIRsData.avgSleep = sleepCount > 0 ? (totalSleep / sleepCount).toFixed(1) : 'N/A';
        allPIRsData.completionRate = checkIns.length > 0 ? Math.round((completeCount / checkIns.length) * 100) : 0;

        allPIRsData.last30Days.avgMood = last30MoodCount > 0 ? (last30Mood / last30MoodCount).toFixed(1) : 'N/A';
        allPIRsData.last30Days.avgCraving = last30CravingCount > 0 ? (last30Craving / last30CravingCount).toFixed(1) : 'N/A';
        allPIRsData.last30Days.avgAnxiety = last30AnxietyCount > 0 ? (last30Anxiety / last30AnxietyCount).toFixed(1) : 'N/A';
        allPIRsData.last30Days.avgSleep = last30SleepCount > 0 ? (last30Sleep / last30SleepCount).toFixed(1) : 'N/A';
        allPIRsData.last30Days.completionRate = last30Total > 0 ? Math.round((last30Complete / last30Total) * 100) : 0;

        setAnalyticsData({ pirStats, allPIRsData });
    };

    const detectPatterns = () => {
        const patterns = [];
        const pirCheckIns = {};
        
        checkIns.forEach(checkIn => {
            if (!pirCheckIns[checkIn.userId]) {
                pirCheckIns[checkIn.userId] = [];
            }
            pirCheckIns[checkIn.userId].push(checkIn);
        });

        Object.entries(pirCheckIns).forEach(([userId, userCheckIns]) => {
            const sorted = userCheckIns.sort((a, b) => {
                const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt);
                const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt);
                return dateB - dateA;
            });

            if (sorted.length >= 3) {
                const recent = sorted.slice(0, 3);
                const moods = recent.map(c => c.morningData?.mood ?? 10);
                
                if (moods[0] < moods[1] && moods[1] < moods[2]) {
                    patterns.push({
                        userId,
                        userName: recent[0].userName,
                        type: 'declining-mood',
                        message: `${recent[0].userName}'s mood declining over 3 days`
                    });
                }

                const cravings = recent.map(c => c.morningData?.craving ?? 0);
                if (cravings[0] > 6 && cravings[1] > 6 && cravings[2] > 6) {
                    patterns.push({
                        userId,
                        userName: recent[0].userName,
                        type: 'high-cravings',
                        message: `${recent[0].userName} has high cravings for 3+ days`
                    });
                }

                const anxiety = recent.map(c => c.eveningData?.anxiety ?? 0);
                if (anxiety[0] > 7 && anxiety[1] > 7) {
                    patterns.push({
                        userId,
                        userName: recent[0].userName,
                        type: 'high-anxiety',
                        message: `${recent[0].userName} reporting high anxiety`
                    });
                }
            }

            const incomplete = userCheckIns.filter(c => c.completionStatus !== 'complete');
            if (incomplete.length >= 3) {
                patterns.push({
                    userId,
                    userName: userCheckIns[0].userName,
                    type: 'incomplete-pattern',
                    message: `${userCheckIns[0].userName} has ${incomplete.length} incomplete check-ins`
                });
            }

            // Keyword detection
            const recentNotes = sorted.slice(0, 5);
            const concerningWords = ['relapse', 'using', 'hopeless', 'giving up', 'cant cope', 'want to use'];
            recentNotes.forEach(checkIn => {
                const allText = [
                    checkIn.morningData?.notes,
                    checkIn.eveningData?.gratitude,
                    checkIn.eveningData?.challenges,
                    checkIn.eveningData?.tomorrowGoal
                ].filter(Boolean).join(' ').toLowerCase();

                concerningWords.forEach(word => {
                    if (allText.includes(word)) {
                        patterns.push({
                            userId,
                            userName: checkIn.userName,
                            type: 'keyword-alert',
                            message: `${checkIn.userName} mentioned "${word}" in check-in`
                        });
                    }
                });
            });
        });

        return patterns;
    };

    const filterCheckIns = () => {
        let filtered = checkIns;
        
        if (activeTab === 'at-risk') {
            filtered = filtered.filter(c => c.riskLevel === 'critical' || c.riskLevel === 'high');
        } else if (activeTab === 'incomplete') {
            filtered = filtered.filter(c => c.completionStatus !== 'complete');
        } else if (activeTab === 'week') {
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            filtered = filtered.filter(c => {
                const date = c.createdAt?.toDate ? c.createdAt.toDate() : new Date(c.createdAt);
                return date >= weekAgo;
            });
        } else if (activeTab === 'needs-review') {
            filtered = filtered.filter(c => !reviewedCheckIns.has(c.id));
        }
        
        if (filterUser !== 'all') {
            filtered = filtered.filter(c => c.userId === filterUser);
        }
        
        if (filterMood !== 'all') {
            const moodValue = parseInt(filterMood);
            if (moodValue === 1) {
                filtered = filtered.filter(c => (c.morningData?.mood ?? 10) <= 3);
            } else if (moodValue === 2) {
                filtered = filtered.filter(c => {
                    const mood = c.morningData?.mood ?? 10;
                    return mood >= 4 && mood <= 6;
                });
            } else if (moodValue === 3) {
                filtered = filtered.filter(c => (c.morningData?.mood ?? 10) >= 7);
            }
        }

        if (filterCraving !== 'all') {
            const cravingValue = parseInt(filterCraving);
            if (cravingValue === 1) {
                filtered = filtered.filter(c => (c.morningData?.craving ?? 0) <= 3);
            } else if (cravingValue === 2) {
                filtered = filtered.filter(c => {
                    const craving = c.morningData?.craving ?? 0;
                    return craving >= 4 && craving <= 6;
                });
            } else if (cravingValue === 3) {
                filtered = filtered.filter(c => (c.morningData?.craving ?? 0) >= 7);
            }
        }

       if (filterAnxiety !== 'all') {
    const anxietyValue = parseInt(filterAnxiety);
    if (anxietyValue === 1) {
        filtered = filtered.filter(c => (c.morningData?.anxietyLevel ?? 0) <= 3);
    } else if (anxietyValue === 2) {
        filtered = filtered.filter(c => {
            const anxiety = c.morningData?.anxietyLevel ?? 0;
            return anxiety >= 4 && anxiety <= 6;
        });
    } else if (anxietyValue === 3) {
        filtered = filtered.filter(c => (c.morningData?.anxietyLevel ?? 0) >= 7);
    }
}

if (filterSleep !== 'all') {
    const sleepValue = parseInt(filterSleep);
    if (sleepValue === 1) {
        filtered = filtered.filter(c => (c.morningData?.sleepQuality ?? 0) <= 3);
    } else if (sleepValue === 2) {
        filtered = filtered.filter(c => {
            const sleep = c.morningData?.sleepQuality ?? 0;
            return sleep >= 4 && sleep <= 6;
        });
    } else if (sleepValue === 3) {
        filtered = filtered.filter(c => (c.morningData?.sleepQuality ?? 0) >= 7);
    }
}
        
        if (filterDate !== 'all') {
            const now = new Date();
            const startDate = new Date();
            
            if (filterDate === 'today') {
                startDate.setHours(0, 0, 0, 0);
            } else if (filterDate === 'week') {
                startDate.setDate(now.getDate() - 7);
            } else if (filterDate === 'month') {
                startDate.setMonth(now.getMonth() - 1);
            }
            
            filtered = filtered.filter(c => {
                const date = c.createdAt?.toDate ? c.createdAt.toDate() : new Date(c.createdAt);
                return date >= startDate;
            });
        }

        if (filterCompletion !== 'all') {
            filtered = filtered.filter(c => c.completionStatus === filterCompletion);
        }

        if (filterRisk !== 'all') {
            filtered = filtered.filter(c => c.riskLevel === filterRisk);
        }
        
        if (searchQuery) {
            const query = searchQuery.toLowerCase();
            filtered = filtered.filter(c =>
                c.userName?.toLowerCase().includes(query) ||
                c.morningData?.notes?.toLowerCase().includes(query) ||
                c.eveningData?.gratitude?.toLowerCase().includes(query) ||
                c.eveningData?.challenges?.toLowerCase().includes(query) ||
                c.eveningData?.tomorrowGoal?.toLowerCase().includes(query)
            );
        }

        // Sorting
        filtered.sort((a, b) => {
            if (sortBy === 'date') {
                const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt);
                const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt);
                return dateB - dateA;
            } else if (sortBy === 'user') {
                return a.userName.localeCompare(b.userName);
            } else if (sortBy === 'risk') {
                const riskOrder = { critical: 0, high: 1, moderate: 2, low: 3 };
                return riskOrder[a.riskLevel] - riskOrder[b.riskLevel];
            } else if (sortBy === 'mood') {
                return (a.morningData?.mood ?? 10) - (b.morningData?.mood ?? 10);
            }
            return 0;
        });
        
        setFilteredCheckIns(filtered);
        setCurrentPage(1);
    };

    const renderCharts = () => {
        if (moodChartRef.current) {
            if (chartInstances.current.mood) chartInstances.current.mood.destroy();
            
            const ctx = moodChartRef.current.getContext('2d');
            const last30 = filteredCheckIns.slice(0, 30).reverse();
            
            chartInstances.current.mood = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last30.map(c => formatDate(c.createdAt)),
                    datasets: [{
                        label: 'Morning Mood',
                        data: last30.map(c => c.morningData?.mood ?? null),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 10 }
                    }
                }
            });
        }

        if (cravingChartRef.current) {
            if (chartInstances.current.craving) chartInstances.current.craving.destroy();
            
            const ctx = cravingChartRef.current.getContext('2d');
            const last30 = filteredCheckIns.slice(0, 30).reverse();
            
            chartInstances.current.craving = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last30.map(c => formatDate(c.createdAt)),
                    datasets: [{
                        label: 'Cravings',
                        data: last30.map(c => c.morningData?.craving ?? null),
                        borderColor: '#f44336',
                        backgroundColor: 'rgba(244, 67, 54, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 10 }
                    }
                }
            });
        }

        if (anxietyChartRef.current) {
            if (chartInstances.current.anxiety) chartInstances.current.anxiety.destroy();
            
            const ctx = anxietyChartRef.current.getContext('2d');
            const last30 = filteredCheckIns.slice(0, 30).reverse();
            
            chartInstances.current.anxiety = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last30.map(c => formatDate(c.createdAt)),
                   datasets: [{
    label: 'Anxiety',
    data: last30.map(c => c.morningData?.anxietyLevel ?? null),
    borderColor: '#FF9800',
    backgroundColor: 'rgba(255, 152, 0, 0.1)',
    tension: 0.4,
    fill: true
}]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 10 }
                    }
                }
            });
        }

        if (sleepChartRef.current) {
            if (chartInstances.current.sleep) chartInstances.current.sleep.destroy();
            
            const ctx = sleepChartRef.current.getContext('2d');
            const last30 = filteredCheckIns.slice(0, 30).reverse();
            
            chartInstances.current.sleep = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last30.map(c => formatDate(c.createdAt)),
                    datasets: [{
    label: 'Sleep Quality',
    data: last30.map(c => c.morningData?.sleepQuality ?? null),
    borderColor: '#9C27B0',
    backgroundColor: 'rgba(156, 39, 176, 0.1)',
    tension: 0.4,
    fill: true
}]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 10 }
                    }
                }
            });
        }

        if (completionChartRef.current) {
            if (chartInstances.current.completion) chartInstances.current.completion.destroy();
            
            const ctx = completionChartRef.current.getContext('2d');
            const statusCounts = {
                complete: filteredCheckIns.filter(c => c.completionStatus === 'complete').length,
                'morning-only': filteredCheckIns.filter(c => c.completionStatus === 'morning-only').length,
                'evening-only': filteredCheckIns.filter(c => c.completionStatus === 'evening-only').length,
                incomplete: filteredCheckIns.filter(c => c.completionStatus === 'incomplete').length
            };
            
            chartInstances.current.completion = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Both Complete', 'Morning Only', 'Evening Only', 'Incomplete'],
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['#4CAF50', '#FFC107', '#FF9800', '#f44336']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
    };

    const handleExport = (format, selectedOnly = false) => {
        const dataToExport = selectedOnly 
            ? filteredCheckIns.filter(c => selectedCheckIns.has(c.id))
            : filteredCheckIns;

        if (format === 'pdf') {
            exportCheckInsToPDF(dataToExport);
        } else {
            const exportData = dataToExport.map(checkIn => ({
                user: checkIn.userName,
                date: formatDateTime(checkIn.createdAt),
                morningMood: checkIn.morningData?.mood ?? '-',
                morningCraving: checkIn.morningData?.craving ?? '-',
                morningNotes: checkIn.morningData?.notes ?? '-',
                eveningAnxiety: checkIn.eveningData?.anxiety ?? '-',
                eveningSleep: checkIn.eveningData?.sleepQuality ?? '-',
                eveningOverallDay: checkIn.eveningData?.overallDay ?? '-',
                eveningGratitude: checkIn.eveningData?.gratitude ?? '-',
                eveningChallenges: checkIn.eveningData?.challenges ?? '-',
                eveningTomorrowGoal: checkIn.eveningData?.tomorrowGoal ?? '-',
                completionStatus: checkIn.completionStatus,
                riskLevel: checkIn.riskLevel,
                reviewed: reviewedCheckIns.has(checkIn.id) ? 'Yes' : 'No'
            }));

            if (format === 'json') {
                exportToJSON(exportData, 'checkins');
            } else if (format === 'csv') {
                exportToCSV(exportData, 'checkins');
            }
        }
    };

    const exportCheckInsToPDF = (data) => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('landscape');
        
        let yPos = 20;
        
        // Title
        doc.setFontSize(18);
        doc.text('Check-ins Report', 14, yPos);
        yPos += 10;
        
        doc.setFontSize(10);
        doc.text(`Generated: ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}`, 14, yPos);
        doc.text(`Total Records: ${data.length}`, 200, yPos);
        yPos += 15;

        // Morning Data Table
        doc.setFontSize(14);
        doc.text('Morning Check-ins', 14, yPos);
        yPos += 5;

        const morningData = data.map(c => [
            c.userName,
            formatDate(c.createdAt),
            c.morningData?.mood ?? '-',
            c.morningData?.craving ?? '-',
            (c.morningData?.notes ?? '-').substring(0, 50) + (c.morningData?.notes?.length > 50 ? '...' : ''),
            c.completionStatus.replace('-', ' ')
        ]);

        doc.autoTable({
            startY: yPos,
            head: [['PIR', 'Date', 'Mood', 'Craving', 'Notes', 'Status']],
            body: morningData,
            theme: 'grid',
            headStyles: { fillColor: [102, 126, 234] },
            styles: { fontSize: 8 },
            columnStyles: {
                0: { cellWidth: 40 },
                1: { cellWidth: 35 },
                2: { cellWidth: 20 },
                3: { cellWidth: 20 },
                4: { cellWidth: 80 },
                5: { cellWidth: 35 }
            }
        });

        // Evening Data Table (new page)
        doc.addPage();
        yPos = 20;
        
        doc.setFontSize(14);
        doc.text('Evening Reflections', 14, yPos);
        yPos += 5;

        const eveningData = data.map(c => [
            c.userName,
            formatDate(c.createdAt),
            c.eveningData?.overallDay ?? '-',
           c.morningData?.anxietyLevel ?? '-',
c.morningData?.sleepQuality ?? '-',
            (c.eveningData?.gratitude ?? '-').substring(0, 40) + (c.eveningData?.gratitude?.length > 40 ? '...' : '')
        ]);

        doc.autoTable({
            startY: yPos,
            head: [['PIR', 'Date', 'Overall', 'Anxiety', 'Sleep', 'Gratitude']],
            body: eveningData,
            theme: 'grid',
            headStyles: { fillColor: [118, 75, 162] },
            styles: { fontSize: 8 },
            columnStyles: {
                0: { cellWidth: 40 },
                1: { cellWidth: 35 },
                2: { cellWidth: 20 },
                3: { cellWidth: 20 },
                4: { cellWidth: 20 },
                5: { cellWidth: 95 }
            }
        });

        // Challenges & Goals (new page if many records)
        if (data.length > 10) {
            doc.addPage();
            yPos = 20;
        } else {
            yPos = doc.lastAutoTable.finalY + 15;
        }

        doc.setFontSize(14);
        doc.text('Challenges & Tomorrow Goals', 14, yPos);
        yPos += 5;

        const detailsData = data.map(c => [
            c.userName,
            formatDate(c.createdAt),
            (c.eveningData?.challenges ?? '-').substring(0, 60) + (c.eveningData?.challenges?.length > 60 ? '...' : ''),
            (c.eveningData?.tomorrowGoal ?? '-').substring(0, 60) + (c.eveningData?.tomorrowGoal?.length > 60 ? '...' : '')
        ]);

        doc.autoTable({
            startY: yPos,
            head: [['PIR', 'Date', 'Challenges', 'Tomorrow\'s Goal']],
            body: detailsData,
            theme: 'grid',
            headStyles: { fillColor: [255, 152, 0] },
            styles: { fontSize: 8 },
            columnStyles: {
                0: { cellWidth: 40 },
                1: { cellWidth: 35 },
                2: { cellWidth: 90 },
                3: { cellWidth: 90 }
            }
        });

        doc.save(`Check-ins_Report_${new Date().toISOString().split('T')[0]}.pdf`);
    };

    const handleBulkReview = async () => {
        if (selectedCheckIns.size === 0) {
            alert('No check-ins selected');
            return;
        }

        try {
            const batch = db.batch();
            selectedCheckIns.forEach(checkInId => {
                const reviewRef = db.collection('checkInReviews').doc();
                batch.set(reviewRef, {
                    checkInId: checkInId,
                    reviewedBy: auth.currentUser.uid,
                    reviewedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            });
            
            await batch.commit();
            setReviewedCheckIns(new Set([...reviewedCheckIns, ...selectedCheckIns]));
            setSelectedCheckIns(new Set());
            alert(`${selectedCheckIns.size} check-ins marked as reviewed`);
        } catch (error) {
            console.error('Error bulk reviewing:', error);
            alert('Failed to mark as reviewed');
        }
    };

    const handleToggleSelect = (checkInId) => {
        const newSelected = new Set(selectedCheckIns);
        if (newSelected.has(checkInId)) {
            newSelected.delete(checkInId);
        } else {
            newSelected.add(checkInId);
        }
        setSelectedCheckIns(newSelected);
    };

    const handleSelectAll = () => {
        if (selectedCheckIns.size === paginatedCheckIns.length) {
            setSelectedCheckIns(new Set());
        } else {
            setSelectedCheckIns(new Set(paginatedCheckIns.map(c => c.id)));
        }
    };

    const paginatedCheckIns = useMemo(() => {
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        return filteredCheckIns.slice(start, end);
    }, [filteredCheckIns, currentPage]);

    const totalPages = Math.ceil(filteredCheckIns.length / itemsPerPage);
    const patterns = detectPatterns();

    const getRiskBadgeStyle = (level) => {
        const styles = {
            critical: { background: '#f44336', color: 'white' },
            high: { background: '#FF9800', color: 'white' },
            moderate: { background: '#FFC107', color: '#333' },
            low: { background: '#4CAF50', color: 'white' }
        };
        return styles[level] ?? styles.low;
    };

    const getCompletionBadgeStyle = (status) => {
        const styles = {
            complete: { background: '#4CAF50', color: 'white', text: 'Both Complete' },
            'morning-only': { background: '#FFC107', color: '#333', text: 'Morning Only' },
            'evening-only': { background: '#FF9800', color: 'white', text: 'Evening Only' },
            incomplete: { background: '#f44336', color: 'white', text: 'Incomplete' }
        };
        return styles[status] ?? styles.incomplete;
    };

    const getRowStyle = (checkIn) => {
        if (checkIn.riskLevel === 'critical') {
            return { background: 'rgba(244, 67, 54, 0.1)', borderLeft: '4px solid #f44336' };
        } else if (checkIn.riskLevel === 'high') {
            return { background: 'rgba(255, 152, 0, 0.1)', borderLeft: '4px solid #FF9800' };
        } else if (checkIn.completionStatus !== 'complete') {
            return { background: 'rgba(255, 193, 7, 0.05)', borderLeft: '4px solid #FFC107' };
        }
        return {};
    };

    if (loading) {
        return (
            <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                minHeight: '400px',
                gap: '20px'
            }}>
                <div style={{
                    width: '60px',
                    height: '60px',
                    border: '4px solid #f3f3f3',
                    borderTop: '4px solid #667eea',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite'
                }}></div>
                <p style={{ color: '#666' }}>Loading check-ins...</p>
            </div>
        );
    }

    // Main view tabs
    if (showAnalytics) {
        return <AnalyticsView 
            analyticsData={analyticsData} 
            checkIns={checkIns}
            users={users}
            onClose={() => setShowAnalytics(false)}
            onSelectPIR={setSelectedPIRForReport}
        />;
    }

    if (selectedPIRForReport) {
        return <IndividualPIRReport
            pirId={selectedPIRForReport}
            checkIns={checkIns.filter(c => c.userId === selectedPIRForReport)}
            analyticsData={analyticsData}
            onClose={() => setSelectedPIRForReport(null)}
        />;
    }

    return (
        <div style={{ padding: '20px', animation: 'fadeIn 0.5s' }}>
            {/* Action Bar */}
            <div style={{ display: 'flex', gap: '10px', marginBottom: '20px' }}>
                <button
                    onClick={() => setShowAnalytics(true)}
                    style={{
                        padding: '12px 24px',
                        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '10px',
                        cursor: 'pointer',
                        fontSize: '14px',
                        fontWeight: '600'
                    }}
                >
                    View Analytics & Reports
                </button>
            </div>

            {/* Pattern Alerts */}
            {patterns.length > 0 && (
                <div style={{
                    background: '#fff3cd',
                    border: '1px solid #ffc107',
                    borderRadius: '10px',
                    padding: '15px',
                    marginBottom: '20px'
                }}>
                    <div style={{ fontWeight: '600', color: '#856404', marginBottom: '10px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <span style={{ fontSize: '20px' }}>‚ö†Ô∏è</span>
                        Pattern Alerts Detected
                    </div>
                    {patterns.slice(0, 3).map((pattern, idx) => (
                        <div key={idx} style={{ fontSize: '14px', color: '#856404', marginBottom: '5px' }}>
                            ‚Ä¢ {pattern.message}
                        </div>
                    ))}
                    {patterns.length > 3 && (
                        <div style={{ fontSize: '13px', color: '#856404', marginTop: '8px' }}>
                            +{patterns.length - 3} more patterns detected
                        </div>
                    )}
                </div>
            )}

            {/* Tabs */}
            <div style={{
                display: 'flex',
                gap: '10px',
                marginBottom: '20px',
                borderBottom: '2px solid #f0f0f0',
                flexWrap: 'wrap'
            }}>
                {[
                    { id: 'all', label: 'All Check-ins', count: checkIns.length },
                    { id: 'at-risk', label: 'At-Risk', count: checkIns.filter(c => c.riskLevel === 'critical' || c.riskLevel === 'high').length },
                    { id: 'incomplete', label: 'Incomplete', count: checkIns.filter(c => c.completionStatus !== 'complete').length },
                    { id: 'week', label: 'This Week', count: checkIns.filter(c => {
                        const date = c.createdAt?.toDate ? c.createdAt.toDate() : new Date(c.createdAt);
                        const weekAgo = new Date();
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        return date >= weekAgo;
                    }).length },
                    { id: 'needs-review', label: 'Needs Review', count: checkIns.filter(c => !reviewedCheckIns.has(c.id)).length }
                ].map(tab => (
                    <button
                        key={tab.id}
                        onClick={() => setActiveTab(tab.id)}
                        style={{
                            padding: '10px 20px',
                            background: activeTab === tab.id ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'transparent',
                            color: activeTab === tab.id ? 'white' : '#666',
                            border: 'none',
                            borderBottom: activeTab === tab.id ? 'none' : '2px solid transparent',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500',
                            borderRadius: activeTab === tab.id ? '10px 10px 0 0' : '0',
                            transition: 'all 0.2s',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px'
                        }}
                    >
                        {tab.label}
                        {tab.count > 0 && (
                            <span style={{
                                background: activeTab === tab.id ? 'rgba(255,255,255,0.3)' : '#e0e0e0',
                                padding: '2px 8px',
                                borderRadius: '12px',
                                fontSize: '12px',
                                fontWeight: '600'
                            }}>
                                {tab.count}
                            </span>
                        )}
                    </button>
                ))}
            </div>

            {/* Filters Bar */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                marginBottom: '20px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '15px', marginBottom: '15px' }}>
                    <div>
                        <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#666', marginBottom: '5px' }}>
                            Sort By
                        </label>
                        <select 
                            value={sortBy}
                            onChange={(e) => setSortBy(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '8px 12px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '8px',
                                fontSize: '14px',
                                background: 'white'
                            }}
                        >
                            <option value="date">Date (Newest)</option>
                            <option value="user">PIR Name (A-Z)</option>
                            <option value="risk">Risk Level</option>
                            <option value="mood">Mood (Low to High)</option>
                        </select>
                    </div>

                    <div>
                        <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#666', marginBottom: '5px' }}>
                            PIR
                        </label>
                        <select 
                            value={filterUser}
                            onChange={(e) => setFilterUser(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '8px 12px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '8px',
                                fontSize: '14px',
                                background: 'white'
                            }}
                        >
                            <option value="all">All PIRs</option>
                            {users.map(user => (
                                <option key={user.id} value={user.id}>
                                    {user.displayName || user.email}
                                </option>
                            ))}
                        </select>
                    </div>
                    
                    <div>
                        <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#666', marginBottom: '5px' }}>
                            Mood Level
                        </label>
                        <select 
                            value={filterMood}
                            onChange={(e) => setFilterMood(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '8px 12px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '8px',
                                fontSize: '14px',
                                background: 'white'
                            }}
                        >
                            <option value="all">All Moods</option>
                            <option value="1">Low (1-3)</option>
                            <option value="2">Medium (4-6)</option>
                            <option value="3">High (7-10)</option>
                        </select>
                    </div>

                    <div>
                        <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#666', marginBottom: '5px' }}>
                            Craving Level
                        </label>
                        <select 
                            value={filterCraving}
                            onChange={(e) => setFilterCraving(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '8px 12px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '8px',
                                fontSize: '14px',
                                background: 'white'
                            }}
                        >
                            <option value="all">All Levels</option>
                            <option value="1">Low (1-3)</option>
                            <option value="2">Medium (4-6)</option>
                            <option value="3">High (7-10)</option>
                        </select>
                    </div>

                    <div>
                        <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#666', marginBottom: '5px' }}>
                            Anxiety Level
                        </label>
                        <select 
                            value={filterAnxiety}
                            onChange={(e) => setFilterAnxiety(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '8px 12px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '8px',
                                fontSize: '14px',
                                background: 'white'
                            }}
                        >
                            <option value="all">All Levels</option>
                            <option value="1">Low (1-3)</option>
                            <option value="2">Medium (4-6)</option>
                            <option value="3">High (7-10)</option>
                        </select>
                    </div>

                    <div>
                        <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#666', marginBottom: '5px' }}>
                            Sleep Quality
                        </label>
                        <select 
                            value={filterSleep}
                            onChange={(e) => setFilterSleep(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '8px 12px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '8px',
                                fontSize: '14px',
                                background: 'white'
                            }}
                        >
                            <option value="all">All Levels</option>
                            <option value="1">Poor (1-3)</option>
                            <option value="2">Fair (4-6)</option>
                            <option value="3">Good (7-10)</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#666', marginBottom: '5px' }}>
                            Time Period
                        </label>
                        <select 
                            value={filterDate}
                            onChange={(e) => setFilterDate(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '8px 12px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '8px',
                                fontSize: '14px',
                                background: 'white'
                            }}
                        >
                            <option value="all">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">Last 7 Days</option>
                            <option value="month">Last 30 Days</option>
                        </select>
                    </div>

                    <div>
                        <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#666', marginBottom: '5px' }}>
                            Completion
                        </label>
                        <select 
                            value={filterCompletion}
                            onChange={(e) => setFilterCompletion(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '8px 12px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '8px',
                                fontSize: '14px',
                                background: 'white'
                            }}
                        >
                            <option value="all">All Status</option>
                            <option value="complete">Both Complete</option>
                            <option value="morning-only">Morning Only</option>
                            <option value="evening-only">Evening Only</option>
                            <option value="incomplete">Incomplete</option>
                        </select>
                    </div>

                    <div>
                        <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#666', marginBottom: '5px' }}>
                            Risk Level
                        </label>
                        <select 
                            value={filterRisk}
                            onChange={(e) => setFilterRisk(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '8px 12px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '8px',
                                fontSize: '14px',
                                background: 'white'
                            }}
                        >
                            <option value="all">All Levels</option>
                            <option value="critical">Critical</option>
                            <option value="high">High</option>
                            <option value="moderate">Moderate</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                </div>

                <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                    <button 
                        onClick={() => setShowCharts(!showCharts)}
                        style={{
                            padding: '8px 16px',
                            background: showCharts ? '#667eea' : '#6c757d',
                            color: 'white',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500'
                        }}
                    >
                        {showCharts ? 'Hide Charts' : 'Show Charts'}
                    </button>

                    {selectedCheckIns.size > 0 && (
                        <>
                            <button 
                                onClick={handleBulkReview}
                                style={{
                                    padding: '8px 16px',
                                    background: '#4CAF50',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500'
                                }}
                            >
                                Mark {selectedCheckIns.size} as Reviewed
                            </button>
                            <button 
                                onClick={() => handleExport('pdf', true)}
                                style={{
                                    padding: '8px 16px',
                                    background: '#FF9800',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500'
                                }}
                            >
                                Export Selected PDF
                            </button>
                        </>
                    )}

                    <button onClick={() => handleExport('csv')} style={{
                        padding: '8px 16px',
                        background: '#6c757d',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontSize: '14px',
                        fontWeight: '500'
                    }}>
                        Export All CSV
                    </button>
                    <button onClick={() => handleExport('json')} style={{
                        padding: '8px 16px',
                        background: '#6c757d',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontSize: '14px',
                        fontWeight: '500'
                    }}>
                        Export All JSON
                    </button>
                    <button onClick={() => handleExport('pdf')} style={{
                        padding: '8px 16px',
                        background: '#6c757d',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontSize: '14px',
                        fontWeight: '500'
                    }}>
                        Export All PDF
                    </button>
                </div>
            </div>

            {/* Charts Section */}
            {showCharts && (
                <div style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '25px',
                    marginBottom: '20px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                }}>
                    <h3 style={{ margin: '0 0 20px 0', color: '#333' }}>Check-in Analytics</h3>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '20px' }}>
                        <div>
                            <h4 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#666' }}>Mood Trend</h4>
                            <div style={{ height: '250px' }}>
                                <canvas ref={moodChartRef}></canvas>
                            </div>
                        </div>
                        <div>
                            <h4 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#666' }}>Craving Intensity</h4>
                            <div style={{ height: '250px' }}>
                                <canvas ref={cravingChartRef}></canvas>
                            </div>
                        </div>
                        <div>
                            <h4 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#666' }}>Anxiety Levels</h4>
                            <div style={{ height: '250px' }}>
                                <canvas ref={anxietyChartRef}></canvas>
                            </div>
                        </div>
                        <div>
                            <h4 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#666' }}>Sleep Quality</h4>
                            <div style={{ height: '250px' }}>
                                <canvas ref={sleepChartRef}></canvas>
                            </div>
                        </div>
                        <div>
                            <h4 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#666' }}>Completion Status</h4>
                            <div style={{ height: '250px' }}>
                                <canvas ref={completionChartRef}></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Table */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                overflow: 'hidden',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <div style={{ overflowX: 'auto' }}>
                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                        <thead style={{ background: '#f8f9fa' }}>
                            <tr>
                                <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#333', fontSize: '14px' }}>
                                    <input
                                        type="checkbox"
                                        checked={selectedCheckIns.size === paginatedCheckIns.length && paginatedCheckIns.length > 0}
                                        onChange={handleSelectAll}
                                        style={{ cursor: 'pointer' }}
                                    />
                                </th>
                                <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#333', fontSize: '14px' }}>PIR</th>
                                <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#333', fontSize: '14px' }}>Date/Time</th>
                                <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Mood</th>
                                <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Craving</th>
                                <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Anxiety</th>
                                <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Sleep</th>
                                <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Overall</th>
                                <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#333', fontSize: '14px' }}>Status</th>
                                <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#333', fontSize: '14px' }}>Risk</th>
                                <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {paginatedCheckIns.map(checkIn => {
                                const completionBadge = getCompletionBadgeStyle(checkIn.completionStatus);
                                const riskBadge = getRiskBadgeStyle(checkIn.riskLevel);
                                
                                return (
                                    <tr key={checkIn.id} style={getRowStyle(checkIn)}>
                                        <td style={{ padding: '15px' }}>
                                            <input
                                                type="checkbox"
                                                checked={selectedCheckIns.has(checkIn.id)}
                                                onChange={() => handleToggleSelect(checkIn.id)}
                                                style={{ cursor: 'pointer' }}
                                            />
                                        </td>
                                        <td style={{ padding: '15px', fontWeight: '500', color: '#333' }}>
                                            {checkIn.userName}
                                            {reviewedCheckIns.has(checkIn.id) && (
                                                <span style={{ marginLeft: '8px', fontSize: '16px' }} title="Reviewed">‚úì</span>
                                            )}
                                        </td>
                                        <td style={{ padding: '15px', color: '#666', fontSize: '14px' }}>
                                            {formatDateTime(checkIn.createdAt)}
                                        </td>
                                        <td style={{ padding: '15px', textAlign: 'center' }}>
                                            <div style={{
                                                width: '40px',
                                                height: '40px',
                                                borderRadius: '50%',
                                                background: checkIn.morningData?.mood != null
                                                    ? `linear-gradient(135deg, ${checkIn.morningData.mood <= 3 ? '#f44336' : checkIn.morningData.mood <= 6 ? '#FF9800' : '#4CAF50'}, ${checkIn.morningData.mood <= 3 ? '#d32f2f' : checkIn.morningData.mood <= 6 ? '#F57C00' : '#388E3C'})`
                                                    : '#e0e0e0',
                                                color: 'white',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontWeight: 'bold',
                                                margin: '0 auto'
                                            }}>
                                                {checkIn.morningData?.mood ?? '-'}
                                            </div>
                                        </td>
                                        <td style={{ padding: '15px', textAlign: 'center' }}>
                                            <div style={{
                                                width: '40px',
                                                height: '40px',
                                                borderRadius: '50%',
                                                background: checkIn.morningData?.craving != null
                                                    ? `linear-gradient(135deg, ${checkIn.morningData.craving >= 7 ? '#f44336' : checkIn.morningData.craving >= 4 ? '#FF9800' : '#4CAF50'}, ${checkIn.morningData.craving >= 7 ? '#d32f2f' : checkIn.morningData.craving >= 4 ? '#F57C00' : '#388E3C'})`
                                                    : '#e0e0e0',
                                                color: 'white',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontWeight: 'bold',
                                                margin: '0 auto'
                                            }}>
                                                {checkIn.morningData?.craving ?? '-'}
                                            </div>
                                        </td>
                                       <td style={{ padding: '15px', textAlign: 'center' }}>
    <div style={{
        width: '40px',
        height: '40px',
        borderRadius: '50%',
        background: checkIn.morningData?.anxietyLevel != null
            ? `linear-gradient(135deg, ${checkIn.morningData.anxietyLevel >= 7 ? '#f44336' : checkIn.morningData.anxietyLevel >= 4 ? '#FF9800' : '#4CAF50'}, ${checkIn.morningData.anxietyLevel >= 7 ? '#d32f2f' : checkIn.morningData.anxietyLevel >= 4 ? '#F57C00' : '#388E3C'})`
            : '#e0e0e0',
        color: 'white',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        fontWeight: 'bold',
        margin: '0 auto'
    }}>
        {checkIn.morningData?.anxietyLevel ?? '-'}
    </div>
</td>
                                        <td style={{ padding: '15px', textAlign: 'center' }}>
    <div style={{
        width: '40px',
        height: '40px',
        borderRadius: '50%',
        background: checkIn.morningData?.sleepQuality != null
            ? `linear-gradient(135deg, ${checkIn.morningData.sleepQuality <= 3 ? '#f44336' : checkIn.morningData.sleepQuality <= 6 ? '#FF9800' : '#4CAF50'}, ${checkIn.morningData.sleepQuality <= 3 ? '#d32f2f' : checkIn.morningData.sleepQuality <= 6 ? '#F57C00' : '#388E3C'})`
            : '#e0e0e0',
        color: 'white',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        fontWeight: 'bold',
        margin: '0 auto'
    }}>
        {checkIn.morningData?.sleepQuality ?? '-'}
    </div>
</td>
                                        <td style={{ padding: '15px', textAlign: 'center' }}>
                                            <div style={{
                                                width: '40px',
                                                height: '40px',
                                                borderRadius: '50%',
                                                background: checkIn.eveningData?.overallDay != null
                                                    ? `linear-gradient(135deg, ${checkIn.eveningData.overallDay <= 3 ? '#f44336' : checkIn.eveningData.overallDay <= 6 ? '#FF9800' : '#4CAF50'}, ${checkIn.eveningData.overallDay <= 3 ? '#d32f2f' : checkIn.eveningData.overallDay <= 6 ? '#F57C00' : '#388E3C'})`
                                                    : '#e0e0e0',
                                                color: 'white',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontWeight: 'bold',
                                                margin: '0 auto'
                                            }}>
                                                {checkIn.eveningData?.overallDay ?? '-'}
                                            </div>
                                        </td>
                                        <td style={{ padding: '15px' }}>
                                            <span style={{
                                                padding: '4px 12px',
                                                borderRadius: '20px',
                                                fontSize: '12px',
                                                fontWeight: '600',
                                                ...completionBadge
                                            }}>
                                                {completionBadge.text}
                                            </span>
                                        </td>
                                        <td style={{ padding: '15px' }}>
                                            <span style={{
                                                padding: '4px 12px',
                                                borderRadius: '20px',
                                                fontSize: '12px',
                                                fontWeight: '600',
                                                textTransform: 'capitalize',
                                                ...riskBadge
                                            }}>
                                                {checkIn.riskLevel}
                                            </span>
                                        </td>
                                        <td style={{ padding: '15px', textAlign: 'center' }}>
                                            <button 
                                                onClick={() => setSelectedCheckIn(checkIn)}
                                                style={{
                                                    padding: '6px 16px',
                                                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                                    color: 'white',
                                                    border: 'none',
                                                    borderRadius: '6px',
                                                    cursor: 'pointer',
                                                    fontSize: '13px',
                                                    fontWeight: '500'
                                                }}
                                            >
                                                View Details
                                            </button>
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                    
                    {filteredCheckIns.length === 0 && (
                        <div style={{
                            padding: '60px 20px',
                            textAlign: 'center',
                            color: '#999'
                        }}>
                            <div style={{ fontSize: '48px', marginBottom: '15px' }}>üìã</div>
                            <div style={{ fontSize: '18px', fontWeight: '500', marginBottom: '8px' }}>
                                No check-ins found
                            </div>
                            <div style={{ fontSize: '14px' }}>
                                {searchQuery ? 'Try adjusting your search or filters' : 'Check-ins will appear here'}
                            </div>
                        </div>
                    )}
                </div>
            </div>
            
            {totalPages > 1 && (
                <Pagination 
                    currentPage={currentPage}
                    totalPages={totalPages}
                    onPageChange={setCurrentPage}
                />
            )}
            
            {selectedCheckIn && (
                <EnhancedCheckInDetailModal 
                    checkIn={selectedCheckIn}
                    checkIns={checkIns.filter(c => c.userId === selectedCheckIn.userId)}
                    coachNote={coachNotes[selectedCheckIn.id]}
                    isReviewed={reviewedCheckIns.has(selectedCheckIn.id)}
                    onClose={() => setSelectedCheckIn(null)}
                    onNoteAdd={async (note) => {
                        await db.collection('coachNotes').add({
                            type: 'checkin',
                            checkInId: selectedCheckIn.id,
                            note: note,
                            createdBy: auth.currentUser.uid,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        loadCoachData();
                    }}
                    onMarkReviewed={async () => {
                        await db.collection('checkInReviews').add({
                            checkInId: selectedCheckIn.id,
                            reviewedBy: auth.currentUser.uid,
                            reviewedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        setReviewedCheckIns(new Set([...reviewedCheckIns, selectedCheckIn.id]));
                    }}
                    onFlagForSession={async () => {
                        await db.collection('sessionFlags').add({
                            type: 'checkin',
                            checkInId: selectedCheckIn.id,
                            userId: selectedCheckIn.userId,
                            flaggedBy: auth.currentUser.uid,
                            flaggedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        alert('Flagged for next session');
                    }}
                />
            )}
        </div>
    );
}
        // ENHANCED CHECK-IN DETAIL MODAL - COMPLETE VIEW WITH ALL FIELDS (FIXED ZEROS)
function EnhancedCheckInDetailModal({ 
    checkIn, 
    checkIns, 
    coachNote, 
    isReviewed, 
    onClose, 
    onNoteAdd, 
    onMarkReviewed, 
    onFlagForSession 
}) {
    const [newNote, setNewNote] = useState('');
    const [showNoteInput, setShowNoteInput] = useState(false);
    const [saving, setSaving] = useState(false);

    const recentCheckIns = checkIns
        .filter(c => c.id !== checkIn.id)
        .sort((a, b) => {
            const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt);
            const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt);
            return dateB - dateA;
        })
        .slice(0, 5);

    const handleSaveNote = async () => {
        if (!newNote.trim()) return;
        
        setSaving(true);
        try {
            await onNoteAdd(newNote);
            setNewNote('');
            setShowNoteInput(false);
        } catch (error) {
            console.error('Error saving note:', error);
            alert('Failed to save note');
        } finally {
            setSaving(false);
        }
    };

    const getMoodColor = (mood) => {
        if (mood == null) return '#e0e0e0';
        if (mood <= 3) return '#f44336';
        if (mood <= 6) return '#FF9800';
        return '#4CAF50';
    };

    const getCravingColor = (craving) => {
        if (craving == null) return '#e0e0e0';
        if (craving >= 7) return '#f44336';
        if (craving >= 4) return '#FF9800';
        return '#4CAF50';
    };

    const getAnxietyColor = (anxiety) => {
        if (anxiety == null) return '#e0e0e0';
        if (anxiety >= 7) return '#f44336';
        if (anxiety >= 4) return '#FF9800';
        return '#4CAF50';
    };

    const getSleepColor = (sleep) => {
        if (sleep == null) return '#e0e0e0';
        if (sleep <= 3) return '#f44336';
        if (sleep <= 6) return '#FF9800';
        return '#4CAF50';
    };

    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000,
            padding: '20px',
            animation: 'fadeIn 0.2s'
        }}>
            <div style={{
                background: 'white',
                borderRadius: '20px',
                maxWidth: '1400px',
                width: '100%',
                maxHeight: '90vh',
                overflow: 'auto',
                boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
                animation: 'slideUp 0.3s'
            }}>
                {/* Header */}
                <div style={{
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    padding: '25px 30px',
                    borderRadius: '20px 20px 0 0',
                    color: 'white',
                    position: 'sticky',
                    top: 0,
                    zIndex: 1
                }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div>
                            <h3 style={{ margin: '0 0 5px 0', fontSize: '24px' }}>
                                {checkIn.userName}'s Check-in
                            </h3>
                            <div style={{ fontSize: '14px', opacity: 0.9 }}>
                                {formatDateTime(checkIn.createdAt)}
                            </div>
                        </div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                            <div style={{
                                padding: '6px 16px',
                                background: 'rgba(255,255,255,0.2)',
                                borderRadius: '20px',
                                fontSize: '13px',
                                fontWeight: '600'
                            }}>
                                Risk: {checkIn.riskLevel.toUpperCase()}
                            </div>
                            {isReviewed && (
                                <div style={{
                                    padding: '6px 16px',
                                    background: 'rgba(76, 175, 80, 0.3)',
                                    borderRadius: '20px',
                                    fontSize: '13px',
                                    fontWeight: '600'
                                }}>
                                    ‚úì Reviewed
                                </div>
                            )}
                            <button 
                                onClick={onClose}
                                style={{
                                    background: 'rgba(255,255,255,0.2)',
                                    border: 'none',
                                    color: 'white',
                                    fontSize: '24px',
                                    width: '36px',
                                    height: '36px',
                                    borderRadius: '50%',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center'
                                }}
                            >
                                √ó
                            </button>
                        </div>
                    </div>
                </div>

                {/* Main Content */}
                <div style={{ padding: '30px' }}>
                    {/* Split View - Morning & Evening */}
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px', marginBottom: '30px' }}>
                        {/* Morning Check-in */}
                        <div style={{
                            background: '#f8f9fa',
                            borderRadius: '15px',
                            padding: '20px',
                            border: '2px solid #e0e0e0'
                        }}>
                            <h4 style={{ margin: '0 0 20px 0', color: '#667eea', fontSize: '18px', fontWeight: '600' }}>
                                ‚òÄÔ∏è Morning Check-in
                            </h4>
                            
                            <div style={{ display: 'grid', gap: '15px' }}>
                                <div>
                                    <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px' }}>Mood</div>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                                        <div style={{
                                            width: '60px',
                                            height: '60px',
                                            borderRadius: '50%',
                                            background: checkIn.morningData?.mood != null
                                                ? `linear-gradient(135deg, ${getMoodColor(checkIn.morningData.mood)}, ${getMoodColor(checkIn.morningData.mood)}dd)`
                                                : '#e0e0e0',
                                            color: 'white',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            fontSize: '24px',
                                            fontWeight: 'bold'
                                        }}>
                                            {checkIn.morningData?.mood ?? '-'}
                                        </div>
                                        <div style={{ flex: 1 }}>
                                            <div style={{ 
                                                height: '8px', 
                                                background: '#e0e0e0', 
                                                borderRadius: '4px',
                                                overflow: 'hidden'
                                            }}>
                                                <div style={{
                                                    height: '100%',
                                                    width: `${(checkIn.morningData?.mood ?? 0) * 10}%`,
                                                    background: getMoodColor(checkIn.morningData?.mood),
                                                    transition: 'width 0.3s'
                                                }}></div>
                                            </div>
                                            <div style={{ fontSize: '12px', color: '#666', marginTop: '4px' }}>
                                                {checkIn.morningData?.mood == null ? 'Not reported' : 
                                                 checkIn.morningData.mood <= 3 ? 'Low' : 
                                                 checkIn.morningData.mood <= 6 ? 'Moderate' : 'Good'}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px' }}>Cravings</div>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                                        <div style={{
                                            width: '60px',
                                            height: '60px',
                                            borderRadius: '50%',
                                            background: checkIn.morningData?.craving != null
                                                ? `linear-gradient(135deg, ${getCravingColor(checkIn.morningData.craving)}, ${getCravingColor(checkIn.morningData.craving)}dd)`
                                                : '#e0e0e0',
                                            color: 'white',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            fontSize: '24px',
                                            fontWeight: 'bold'
                                        }}>
                                            {checkIn.morningData?.craving ?? '-'}
                                        </div>
                                        <div style={{ flex: 1 }}>
                                            <div style={{ 
                                                height: '8px', 
                                                background: '#e0e0e0', 
                                                borderRadius: '4px',
                                                overflow: 'hidden'
                                            }}>
                                                <div style={{
                                                    height: '100%',
                                                    width: `${(checkIn.morningData?.craving ?? 0) * 10}%`,
                                                    background: getCravingColor(checkIn.morningData?.craving),
                                                    transition: 'width 0.3s'
                                                }}></div>
                                            </div>
                                            <div style={{ fontSize: '12px', color: '#666', marginTop: '4px' }}>
                                                {checkIn.morningData?.craving == null ? 'Not reported' :
                                                 checkIn.morningData.craving >= 7 ? 'High' : 
                                                 checkIn.morningData.craving >= 4 ? 'Moderate' : 'Low'}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {checkIn.morningData?.notes && (
                                    <div>
                                        <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px', fontWeight: '600' }}>Notes</div>
                                        <div style={{
                                            padding: '12px',
                                            background: 'white',
                                            borderRadius: '8px',
                                            color: '#333',
                                            fontSize: '14px',
                                            lineHeight: '1.6'
                                        }}>
                                            {checkIn.morningData.notes}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Evening Reflection */}
                        <div style={{
                            background: '#f8f9fa',
                            borderRadius: '15px',
                            padding: '20px',
                            border: '2px solid #e0e0e0'
                        }}>
                            <h4 style={{ margin: '0 0 20px 0', color: '#764ba2', fontSize: '18px', fontWeight: '600' }}>
                                üåô Evening Reflection
                            </h4>
                            
                            {checkIn.eveningData ? (
                                <div style={{ display: 'grid', gap: '15px' }}>
                                    <div>
                                        <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px' }}>Overall Day</div>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                                            <div style={{
                                                width: '60px',
                                                height: '60px',
                                                borderRadius: '50%',
                                                background: checkIn.eveningData.overallDay != null
                                                    ? `linear-gradient(135deg, ${getMoodColor(checkIn.eveningData.overallDay)}, ${getMoodColor(checkIn.eveningData.overallDay)}dd)`
                                                    : '#e0e0e0',
                                                color: 'white',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontSize: '24px',
                                                fontWeight: 'bold'
                                            }}>
                                                {checkIn.eveningData.overallDay ?? '-'}
                                            </div>
                                            <div style={{ flex: 1 }}>
                                                <div style={{ 
                                                    height: '8px', 
                                                    background: '#e0e0e0', 
                                                    borderRadius: '4px',
                                                    overflow: 'hidden'
                                                }}>
                                                    <div style={{
                                                        height: '100%',
                                                        width: `${(checkIn.eveningData.overallDay ?? 0) * 10}%`,
                                                        background: getMoodColor(checkIn.eveningData.overallDay),
                                                        transition: 'width 0.3s'
                                                    }}></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                   <div>
    <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px' }}>Anxiety Level</div>
    <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
        <div style={{
            width: '60px',
            height: '60px',
            borderRadius: '50%',
            background: checkIn.morningData?.anxietyLevel != null
                ? `linear-gradient(135deg, ${getAnxietyColor(checkIn.morningData.anxietyLevel)}, ${getAnxietyColor(checkIn.morningData.anxietyLevel)}dd)`
                : '#e0e0e0',
            color: 'white',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            fontSize: '24px',
            fontWeight: 'bold'
        }}>
            {checkIn.morningData?.anxietyLevel ?? '-'}
        </div>
        <div style={{ flex: 1 }}>
            <div style={{ 
                height: '8px', 
                background: '#e0e0e0', 
                borderRadius: '4px',
                overflow: 'hidden'
            }}>
                <div style={{
                    height: '100%',
                    width: `${(checkIn.morningData?.anxietyLevel ?? 0) * 10}%`,
                    background: getAnxietyColor(checkIn.morningData?.anxietyLevel),
                    transition: 'width 0.3s'
                }}></div>
            </div>
            <div style={{ fontSize: '12px', color: '#666', marginTop: '4px' }}>
                {checkIn.morningData?.anxietyLevel == null ? 'Not reported' :
                 checkIn.morningData.anxietyLevel >= 7 ? 'High' : 
                 checkIn.morningData.anxietyLevel >= 4 ? 'Moderate' : 'Low'}
            </div>
        </div>
    </div>
</div>

<div>
    <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px' }}>Sleep Quality (Last Night)</div>
    <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
        <div style={{
            width: '60px',
            height: '60px',
            borderRadius: '50%',
            background: checkIn.morningData?.sleepQuality != null
                ? `linear-gradient(135deg, ${getSleepColor(checkIn.morningData.sleepQuality)}, ${getSleepColor(checkIn.morningData.sleepQuality)}dd)`
                : '#e0e0e0',
            color: 'white',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            fontSize: '24px',
            fontWeight: 'bold'
        }}>
            {checkIn.morningData?.sleepQuality ?? '-'}
        </div>
        <div style={{ flex: 1 }}>
            <div style={{ 
                height: '8px', 
                background: '#e0e0e0', 
                borderRadius: '4px',
                overflow: 'hidden'
            }}>
                <div style={{
                    height: '100%',
                    width: `${(checkIn.morningData?.sleepQuality ?? 0) * 10}%`,
                    background: getSleepColor(checkIn.morningData?.sleepQuality),
                    transition: 'width 0.3s'
                }}></div>
            </div>
            <div style={{ fontSize: '12px', color: '#666', marginTop: '4px' }}>
                {checkIn.morningData?.sleepQuality == null ? 'Not reported' :
                 checkIn.morningData.sleepQuality <= 3 ? 'Poor' : 
                 checkIn.morningData.sleepQuality <= 6 ? 'Fair' : 'Good'}
            </div>
        </div>
    </div>
</div>

                                    {checkIn.eveningData.gratitude && (
                                        <div>
                                            <div style={{ fontSize: '13px', color: '#4CAF50', marginBottom: '8px', fontWeight: '600' }}>
                                                üíö Gratitude
                                            </div>
                                            <div style={{
                                                padding: '12px',
                                                background: 'white',
                                                borderRadius: '8px',
                                                color: '#333',
                                                fontSize: '14px',
                                                lineHeight: '1.6'
                                            }}>
                                                {checkIn.eveningData.gratitude}
                                            </div>
                                        </div>
                                    )}

                                    {checkIn.eveningData.challenges && (
                                        <div>
                                            <div style={{ fontSize: '13px', color: '#FF9800', marginBottom: '8px', fontWeight: '600' }}>
                                                ‚ö†Ô∏è Challenges
                                            </div>
                                            <div style={{
                                                padding: '12px',
                                                background: 'white',
                                                borderRadius: '8px',
                                                color: '#333',
                                                fontSize: '14px',
                                                lineHeight: '1.6'
                                            }}>
                                                {checkIn.eveningData.challenges}
                                            </div>
                                        </div>
                                    )}

                                    {checkIn.eveningData.tomorrowGoal && (
                                        <div>
                                            <div style={{ fontSize: '13px', color: '#9C27B0', marginBottom: '8px', fontWeight: '600' }}>
                                                üéØ Tomorrow's Goal
                                            </div>
                                            <div style={{
                                                padding: '12px',
                                                background: 'white',
                                                borderRadius: '8px',
                                                color: '#333',
                                                fontSize: '14px',
                                                lineHeight: '1.6'
                                            }}>
                                                {checkIn.eveningData.tomorrowGoal}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <div style={{
                                    padding: '40px',
                                    textAlign: 'center',
                                    color: '#999'
                                }}>
                                    <div style={{ fontSize: '48px', marginBottom: '10px' }}>üåô</div>
                                    <div>No evening reflection submitted</div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Historical Context */}
                    {recentCheckIns.length > 0 && (
                        <div style={{
                            background: '#f8f9fa',
                            borderRadius: '15px',
                            padding: '20px',
                            marginBottom: '20px'
                        }}>
                            <h4 style={{ margin: '0 0 15px 0', color: '#333', fontSize: '16px', fontWeight: '600' }}>
                                üìä Recent History (Last 5 Check-ins)
                            </h4>
                            <div style={{ display: 'grid', gap: '10px' }}>
                                {recentCheckIns.map(prevCheckIn => (
                                    <div key={prevCheckIn.id} style={{
                                        padding: '12px',
                                        background: 'white',
                                        borderRadius: '8px',
                                        display: 'grid',
                                        gridTemplateColumns: '100px repeat(5, 1fr)',
                                        gap: '12px',
                                        alignItems: 'center',
                                        fontSize: '13px'
                                    }}>
                                        <div style={{ color: '#666', fontSize: '12px' }}>
                                            {formatDate(prevCheckIn.createdAt)}
                                        </div>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                            <span style={{ color: '#666', fontSize: '11px' }}>Mood:</span>
                                            <div style={{
                                                width: '28px',
                                                height: '28px',
                                                borderRadius: '50%',
                                                background: getMoodColor(prevCheckIn.morningData?.mood),
                                                color: 'white',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontWeight: 'bold',
                                                fontSize: '12px'
                                            }}>
                                                {prevCheckIn.morningData?.mood ?? '-'}
                                            </div>
                                        </div>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                            <span style={{ color: '#666', fontSize: '11px' }}>Craving:</span>
                                            <div style={{
                                                width: '28px',
                                                height: '28px',
                                                borderRadius: '50%',
                                                background: getCravingColor(prevCheckIn.morningData?.craving),
                                                color: 'white',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontWeight: 'bold',
                                                fontSize: '12px'
                                            }}>
                                                {prevCheckIn.morningData?.craving ?? '-'}
                                            </div>
                                        </div>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
    <span style={{ color: '#666', fontSize: '11px' }}>Anxiety:</span>
    <div style={{
        width: '28px',
        height: '28px',
        borderRadius: '50%',
        background: getAnxietyColor(prevCheckIn.morningData?.anxietyLevel),
        color: 'white',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        fontWeight: 'bold',
        fontSize: '12px'
    }}>
        {prevCheckIn.morningData?.anxietyLevel ?? '-'}
    </div>
</div>
<div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
    <span style={{ color: '#666', fontSize: '11px' }}>Sleep:</span>
    <div style={{
        width: '28px',
        height: '28px',
        borderRadius: '50%',
        background: getSleepColor(prevCheckIn.morningData?.sleepQuality),
        color: 'white',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        fontWeight: 'bold',
        fontSize: '12px'
    }}>
        {prevCheckIn.morningData?.sleepQuality ?? '-'}
    </div>
</div>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                            <span style={{ color: '#666', fontSize: '11px' }}>Overall:</span>
                                            <div style={{
                                                width: '28px',
                                                height: '28px',
                                                borderRadius: '50%',
                                                background: prevCheckIn.eveningData?.overallDay != null
                                                    ? getMoodColor(prevCheckIn.eveningData.overallDay)
                                                    : '#e0e0e0',
                                                color: 'white',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontWeight: 'bold',
                                                fontSize: '12px'
                                            }}>
                                                {prevCheckIn.eveningData?.overallDay ?? '-'}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                 {/* Coach Notes Section */}
                    <div style={{
                        background: '#fff3cd',
                        borderRadius: '15px',
                        padding: '20px',
                        marginBottom: '20px'
                    }}>
                        <h4 style={{ margin: '0 0 15px 0', color: '#856404', fontSize: '16px', fontWeight: '600' }}>
                            üìù Coach Notes (Private)
                        </h4>
                        
                        {coachNote ? (
                            <div style={{
                                padding: '12px',
                                background: 'white',
                                borderRadius: '8px',
                                color: '#333',
                                fontSize: '14px',
                                lineHeight: '1.6',
                                marginBottom: '10px'
                            }}>
                                {coachNote.note}
                                <div style={{ fontSize: '12px', color: '#666', marginTop: '8px' }}>
                                    Added {formatTimeAgo(coachNote.createdAt)}
                                </div>
                            </div>
                        ) : (
                            <div style={{ color: '#856404', fontSize: '14px', marginBottom: '10px' }}>
                                No coach notes yet
                            </div>
                        )}

                        {showNoteInput ? (
                            <div>
                                <textarea
                                    value={newNote}
                                    onChange={(e) => setNewNote(e.target.value)}
                                    placeholder="Add your private observations..."
                                    style={{
                                        width: '100%',
                                        minHeight: '80px',
                                        padding: '12px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '8px',
                                        fontSize: '14px',
                                        fontFamily: 'inherit',
                                        resize: 'vertical',
                                        marginBottom: '10px'
                                    }}
                                />
                                <div style={{ display: 'flex', gap: '10px' }}>
                                    <button
                                        onClick={handleSaveNote}
                                        disabled={saving}
                                        style={{
                                            padding: '8px 16px',
                                            background: '#4CAF50',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            cursor: saving ? 'not-allowed' : 'pointer',
                                            fontSize: '14px',
                                            fontWeight: '500',
                                            opacity: saving ? 0.6 : 1
                                        }}
                                    >
                                        {saving ? 'Saving...' : 'Save Note'}
                                    </button>
                                    <button
                                        onClick={() => {
                                            setShowNoteInput(false);
                                            setNewNote('');
                                        }}
                                        style={{
                                            padding: '8px 16px',
                                            background: '#6c757d',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '14px',
                                            fontWeight: '500'
                                        }}
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <button
                                onClick={() => setShowNoteInput(true)}
                                style={{
                                    padding: '8px 16px',
                                    background: '#667eea',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '6px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500'
                                }}
                            >
                                {coachNote ? '+ Add Another Note' : '+ Add Coach Note'}
                            </button>
                        )}
                    </div>

                    {/* Action Buttons */}
                    <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                        {!isReviewed && (
                            <button
                                onClick={onMarkReviewed}
                                style={{
                                    padding: '12px 24px',
                                    background: 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '10px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '600',
                                    transition: 'transform 0.2s'
                                }}
                                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                            >
                                ‚úì Mark as Reviewed
                            </button>
                        )}
                        
                        <button
                            onClick={onFlagForSession}
                            style={{
                                padding: '12px 24px',
                                background: 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '10px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '600',
                                transition: 'transform 0.2s'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                            onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                        >
                            üö© Flag for Session
                        </button>

                        <button
                            onClick={onClose}
                            style={{
                                padding: '12px 24px',
                                background: '#6c757d',
                                color: 'white',
                                border: 'none',
                                borderRadius: '10px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '600',
                                transition: 'transform 0.2s',
                                marginLeft: 'auto'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                            onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                        >
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
}
        // ANALYTICS VIEW - COMPREHENSIVE STATS FOR ALL PIRS
function AnalyticsView({ analyticsData, checkIns, users, onClose, onSelectPIR }) {
    const [selectedTab, setSelectedTab] = useState('aggregate');
    const [sortBy, setSortBy] = useState('name');

    if (!analyticsData) return null;

    const { pirStats, allPIRsData } = analyticsData;

    const sortedPIRs = Object.values(pirStats).sort((a, b) => {
        if (sortBy === 'name') return a.userName.localeCompare(b.userName);
        if (sortBy === 'avgMood') return parseFloat(b.avgMood) - parseFloat(a.avgMood);
        if (sortBy === 'avgCraving') return parseFloat(a.avgCraving) - parseFloat(b.avgCraving);
        if (sortBy === 'completion') return b.completionRate - a.completionRate;
        return 0;
    });

    const exportAggregateAnalytics = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('landscape');
        
        let yPos = 20;
        
        // Title
        doc.setFontSize(20);
        doc.text('Check-ins Analytics Report - All PIRs', 14, yPos);
        yPos += 15;
        
        doc.setFontSize(10);
        doc.text(`Generated: ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}`, 14, yPos);
        yPos += 15;

        // Aggregate Stats
        doc.setFontSize(16);
        doc.text('Overall Program Statistics', 14, yPos);
        yPos += 10;

        const aggregateStats = [
            ['Metric', 'Lifetime Average', 'Last 30 Days'],
            ['Average Mood', allPIRsData.avgMood, allPIRsData.last30Days.avgMood],
            ['Average Cravings', allPIRsData.avgCraving, allPIRsData.last30Days.avgCraving],
            ['Average Anxiety', allPIRsData.avgAnxiety, allPIRsData.last30Days.avgAnxiety],
            ['Average Sleep Quality', allPIRsData.avgSleep, allPIRsData.last30Days.avgSleep],
            ['Completion Rate', `${allPIRsData.completionRate}%`, `${allPIRsData.last30Days.completionRate}%`],
            ['Total Check-ins', allPIRsData.totalCheckIns, '-']
        ];

        doc.autoTable({
            startY: yPos,
            head: [aggregateStats[0]],
            body: aggregateStats.slice(1),
            theme: 'grid',
            headStyles: { fillColor: [102, 126, 234] },
            styles: { fontSize: 10 }
        });

        // Individual PIR Stats
        doc.addPage();
        yPos = 20;
        
        doc.setFontSize(16);
        doc.text('Individual PIR Statistics - Lifetime', 14, yPos);
        yPos += 10;

        const pirLifetimeData = sortedPIRs.map(pir => [
            pir.userName,
            pir.totalCheckIns,
            pir.avgMood,
            pir.avgCraving,
            pir.avgAnxiety,
            pir.avgSleep,
            `${pir.completionRate}%`
        ]);

        doc.autoTable({
            startY: yPos,
            head: [['PIR', 'Check-ins', 'Avg Mood', 'Avg Craving', 'Avg Anxiety', 'Avg Sleep', 'Completion']],
            body: pirLifetimeData,
            theme: 'grid',
            headStyles: { fillColor: [102, 126, 234] },
            styles: { fontSize: 9 },
            columnStyles: {
                0: { cellWidth: 60 },
                1: { cellWidth: 30 },
                2: { cellWidth: 30 },
                3: { cellWidth: 35 },
                4: { cellWidth: 30 },
                5: { cellWidth: 30 },
                6: { cellWidth: 35 }
            }
        });

        // 30-Day Stats
        doc.addPage();
        yPos = 20;
        
        doc.setFontSize(16);
        doc.text('Individual PIR Statistics - Last 30 Days', 14, yPos);
        yPos += 10;

        const pir30DayData = sortedPIRs.map(pir => [
            pir.userName,
            pir.last30.totalCheckIns,
            pir.last30.avgMood,
            pir.last30.avgCraving,
            pir.last30.avgAnxiety,
            pir.last30.avgSleep,
            `${pir.last30.completionRate}%`
        ]);

        doc.autoTable({
            startY: yPos,
            head: [['PIR', 'Check-ins', 'Avg Mood', 'Avg Craving', 'Avg Anxiety', 'Avg Sleep', 'Completion']],
            body: pir30DayData,
            theme: 'grid',
            headStyles: { fillColor: [118, 75, 162] },
            styles: { fontSize: 9 },
            columnStyles: {
                0: { cellWidth: 60 },
                1: { cellWidth: 30 },
                2: { cellWidth: 30 },
                3: { cellWidth: 35 },
                4: { cellWidth: 30 },
                5: { cellWidth: 30 },
                6: { cellWidth: 35 }
            }
        });

        doc.save(`Analytics_Report_${new Date().toISOString().split('T')[0]}.pdf`);
    };

    return (
        <div style={{ padding: '20px', animation: 'fadeIn 0.5s' }}>
            {/* Header */}
            <div style={{ 
                display: 'flex', 
                justifyContent: 'space-between', 
                alignItems: 'center',
                marginBottom: '30px'
            }}>
                <div>
                    <h2 style={{ margin: '0 0 10px 0', fontSize: '28px', color: '#333' }}>
                        Analytics & Reports
                    </h2>
                    <p style={{ margin: 0, color: '#666', fontSize: '14px' }}>
                        Comprehensive check-in statistics and trends
                    </p>
                </div>
                <div style={{ display: 'flex', gap: '10px' }}>
                    <button
                        onClick={exportAggregateAnalytics}
                        style={{
                            padding: '12px 24px',
                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            color: 'white',
                            border: 'none',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '600'
                        }}
                    >
                        Export Analytics PDF
                    </button>
                    <button
                        onClick={onClose}
                        style={{
                            padding: '12px 24px',
                            background: '#6c757d',
                            color: 'white',
                            border: 'none',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '600'
                        }}
                    >
                        Back to Check-ins
                    </button>
                </div>
            </div>

            {/* Tabs */}
            <div style={{
                display: 'flex',
                gap: '10px',
                marginBottom: '30px',
                borderBottom: '2px solid #f0f0f0'
            }}>
                {[
                    { id: 'aggregate', label: 'All PIRs Aggregate' },
                    { id: 'individual', label: 'Individual PIR Stats' }
                ].map(tab => (
                    <button
                        key={tab.id}
                        onClick={() => setSelectedTab(tab.id)}
                        style={{
                            padding: '12px 24px',
                            background: selectedTab === tab.id ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'transparent',
                            color: selectedTab === tab.id ? 'white' : '#666',
                            border: 'none',
                            borderBottom: selectedTab === tab.id ? 'none' : '2px solid transparent',
                            cursor: 'pointer',
                            fontSize: '15px',
                            fontWeight: '600',
                            borderRadius: selectedTab === tab.id ? '10px 10px 0 0' : '0',
                            transition: 'all 0.2s'
                        }}
                    >
                        {tab.label}
                    </button>
                ))}
            </div>

            {/* Aggregate View */}
            {selectedTab === 'aggregate' && (
                <div>
                    <div style={{
                        background: 'white',
                        borderRadius: '15px',
                        padding: '30px',
                        marginBottom: '30px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                    }}>
                        <h3 style={{ margin: '0 0 20px 0', fontSize: '20px', color: '#333' }}>
                            Overall Program Statistics
                        </h3>
                        
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '20px' }}>
                            <div style={{
                                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                padding: '20px',
                                borderRadius: '12px',
                                color: 'white'
                            }}>
                                <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '8px' }}>Total Check-ins</div>
                                <div style={{ fontSize: '32px', fontWeight: 'bold' }}>{allPIRsData.totalCheckIns}</div>
                            </div>

                            <div style={{
                                background: 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)',
                                padding: '20px',
                                borderRadius: '12px',
                                color: 'white'
                            }}>
                                <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '8px' }}>Completion Rate</div>
                                <div style={{ fontSize: '32px', fontWeight: 'bold' }}>{allPIRsData.completionRate}%</div>
                                <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '4px' }}>
                                    30-day: {allPIRsData.last30Days.completionRate}%
                                </div>
                            </div>

                            <div style={{
                                background: 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)',
                                padding: '20px',
                                borderRadius: '12px',
                                color: 'white'
                            }}>
                                <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '8px' }}>Average Mood</div>
                                <div style={{ fontSize: '32px', fontWeight: 'bold' }}>{allPIRsData.avgMood}/10</div>
                                <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '4px' }}>
                                    30-day: {allPIRsData.last30Days.avgMood}/10
                                </div>
                            </div>

                            <div style={{
                                background: 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)',
                                padding: '20px',
                                borderRadius: '12px',
                                color: 'white'
                            }}>
                                <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '8px' }}>Average Cravings</div>
                                <div style={{ fontSize: '32px', fontWeight: 'bold' }}>{allPIRsData.avgCraving}/10</div>
                                <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '4px' }}>
                                    30-day: {allPIRsData.last30Days.avgCraving}/10
                                </div>
                            </div>

                            <div style={{
                                background: 'linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%)',
                                padding: '20px',
                                borderRadius: '12px',
                                color: 'white'
                            }}>
                                <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '8px' }}>Average Anxiety</div>
                                <div style={{ fontSize: '32px', fontWeight: 'bold' }}>{allPIRsData.avgAnxiety}/10</div>
                                <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '4px' }}>
                                    30-day: {allPIRsData.last30Days.avgAnxiety}/10
                                </div>
                            </div>

                            <div style={{
                                background: 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)',
                                padding: '20px',
                                borderRadius: '12px',
                                color: 'white'
                            }}>
                                <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '8px' }}>Average Sleep Quality</div>
                                <div style={{ fontSize: '32px', fontWeight: 'bold' }}>{allPIRsData.avgSleep}/10</div>
                                <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '4px' }}>
                                    30-day: {allPIRsData.last30Days.avgSleep}/10
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Trend Comparison */}
                    <div style={{
                        background: 'white',
                        borderRadius: '15px',
                        padding: '30px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                    }}>
                        <h3 style={{ margin: '0 0 20px 0', fontSize: '20px', color: '#333' }}>
                            30-Day Trend vs Lifetime Average
                        </h3>
                        
                        <div style={{ display: 'grid', gap: '20px' }}>
                            {[
                                { label: 'Mood', lifetime: allPIRsData.avgMood, recent: allPIRsData.last30Days.avgMood, color: '#667eea' },
                                { label: 'Cravings', lifetime: allPIRsData.avgCraving, recent: allPIRsData.last30Days.avgCraving, color: '#f44336', inverse: true },
                                { label: 'Anxiety', lifetime: allPIRsData.avgAnxiety, recent: allPIRsData.last30Days.avgAnxiety, color: '#FF9800', inverse: true },
                                { label: 'Sleep Quality', lifetime: allPIRsData.avgSleep, recent: allPIRsData.last30Days.avgSleep, color: '#2196F3' },
                                { label: 'Completion Rate', lifetime: `${allPIRsData.completionRate}`, recent: `${allPIRsData.last30Days.completionRate}`, color: '#4CAF50', isPercent: true }
                            ].map(metric => {
                                const lifetimeVal = parseFloat(metric.lifetime);
                                const recentVal = parseFloat(metric.recent);
                                const diff = recentVal - lifetimeVal;
                                const isImproving = metric.inverse ? diff < 0 : diff > 0;
                                
                                return (
                                    <div key={metric.label} style={{
                                        padding: '20px',
                                        background: '#f8f9fa',
                                        borderRadius: '10px'
                                    }}>
                                        <div style={{ 
                                            display: 'flex', 
                                            justifyContent: 'space-between', 
                                            alignItems: 'center',
                                            marginBottom: '15px'
                                        }}>
                                            <div style={{ fontSize: '16px', fontWeight: '600', color: '#333' }}>
                                                {metric.label}
                                            </div>
                                            <div style={{
                                                padding: '4px 12px',
                                                background: isImproving ? '#d4edda' : '#f8d7da',
                                                color: isImproving ? '#155724' : '#721c24',
                                                borderRadius: '20px',
                                                fontSize: '13px',
                                                fontWeight: '600'
                                            }}>
                                                {diff > 0 ? '+' : ''}{diff.toFixed(1)}{metric.isPercent ? '%' : ''} {isImproving ? '‚Üë' : '‚Üì'}
                                            </div>
                                        </div>
                                        <div style={{ display: 'flex', gap: '20px', alignItems: 'center' }}>
                                            <div style={{ flex: 1 }}>
                                                <div style={{ fontSize: '12px', color: '#666', marginBottom: '5px' }}>
                                                    Lifetime: {metric.lifetime}{metric.isPercent ? '%' : '/10'}
                                                </div>
                                                <div style={{
                                                    height: '10px',
                                                    background: '#e0e0e0',
                                                    borderRadius: '5px',
                                                    overflow: 'hidden'
                                                }}>
                                                    <div style={{
                                                        height: '100%',
                                                        width: `${metric.isPercent ? lifetimeVal : lifetimeVal * 10}%`,
                                                        background: metric.color,
                                                        opacity: 0.6
                                                    }}></div>
                                                </div>
                                            </div>
                                            <div style={{ flex: 1 }}>
                                                <div style={{ fontSize: '12px', color: '#666', marginBottom: '5px' }}>
                                                    Last 30 Days: {metric.recent}{metric.isPercent ? '%' : '/10'}
                                                </div>
                                                <div style={{
                                                    height: '10px',
                                                    background: '#e0e0e0',
                                                    borderRadius: '5px',
                                                    overflow: 'hidden'
                                                }}>
                                                    <div style={{
                                                        height: '100%',
                                                        width: `${metric.isPercent ? recentVal : recentVal * 10}%`,
                                                        background: metric.color
                                                    }}></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            )}

            {/* Individual PIR Stats View */}
            {selectedTab === 'individual' && (
                <div style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '30px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                }}>
                    <div style={{ 
                        display: 'flex', 
                        justifyContent: 'space-between', 
                        alignItems: 'center',
                        marginBottom: '20px'
                    }}>
                        <h3 style={{ margin: 0, fontSize: '20px', color: '#333' }}>
                            Individual PIR Statistics
                        </h3>
                        <div>
                            <label style={{ marginRight: '10px', color: '#666', fontSize: '14px' }}>Sort by:</label>
                            <select
                                value={sortBy}
                                onChange={(e) => setSortBy(e.target.value)}
                                style={{
                                    padding: '8px 12px',
                                    border: '2px solid #e0e0e0',
                                    borderRadius: '8px',
                                    fontSize: '14px',
                                    background: 'white'
                                }}
                            >
                                <option value="name">PIR Name</option>
                                <option value="avgMood">Avg Mood</option>
                                <option value="avgCraving">Avg Cravings</option>
                                <option value="completion">Completion Rate</option>
                            </select>
                        </div>
                    </div>

                    <div style={{ overflowX: 'auto' }}>
                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead style={{ background: '#f8f9fa' }}>
                                <tr>
                                    <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#333', fontSize: '14px' }}>PIR</th>
                                    <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Check-ins<br/>(Total / 30d)</th>
                                    <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Avg Mood<br/>(Life / 30d)</th>
                                    <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Avg Craving<br/>(Life / 30d)</th>
                                    <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Avg Anxiety<br/>(Life / 30d)</th>
                                    <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Avg Sleep<br/>(Life / 30d)</th>
                                    <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Completion<br/>(Life / 30d)</th>
                                    <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {sortedPIRs.map(pir => (
                                    <tr key={pir.userId} style={{ borderBottom: '1px solid #f0f0f0' }}>
                                        <td style={{ padding: '15px', fontWeight: '500', color: '#333' }}>
                                            {pir.userName}
                                        </td>
                                        <td style={{ padding: '15px', textAlign: 'center', color: '#666' }}>
                                            {pir.totalCheckIns} / {pir.last30.totalCheckIns}
                                        </td>
                                        <td style={{ padding: '15px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '15px', fontWeight: '600', color: '#667eea' }}>
                                                {pir.avgMood}
                                            </div>
                                            <div style={{ fontSize: '12px', color: '#999', marginTop: '2px' }}>
                                                {pir.last30.avgMood}
                                            </div>
                                        </td>
                                        <td style={{ padding: '15px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '15px', fontWeight: '600', color: '#f44336' }}>
                                                {pir.avgCraving}
                                            </div>
                                            <div style={{ fontSize: '12px', color: '#999', marginTop: '2px' }}>
                                                {pir.last30.avgCraving}
                                            </div>
                                        </td>
                                        <td style={{ padding: '15px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '15px', fontWeight: '600', color: '#FF9800' }}>
                                                {pir.avgAnxiety}
                                            </div>
                                            <div style={{ fontSize: '12px', color: '#999', marginTop: '2px' }}>
                                                {pir.last30.avgAnxiety}
                                            </div>
                                        </td>
                                        <td style={{ padding: '15px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '15px', fontWeight: '600', color: '#2196F3' }}>
                                                {pir.avgSleep}
                                            </div>
                                            <div style={{ fontSize: '12px', color: '#999', marginTop: '2px' }}>
                                                {pir.last30.avgSleep}
                                            </div>
                                        </td>
                                        <td style={{ padding: '15px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '15px', fontWeight: '600', color: '#4CAF50' }}>
                                                {pir.completionRate}%
                                            </div>
                                            <div style={{ fontSize: '12px', color: '#999', marginTop: '2px' }}>
                                                {pir.last30.completionRate}%
                                            </div>
                                        </td>
                                        <td style={{ padding: '15px', textAlign: 'center' }}>
                                            <button
                                                onClick={() => onSelectPIR(pir.userId)}
                                                style={{
                                                    padding: '6px 16px',
                                                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                                    color: 'white',
                                                    border: 'none',
                                                    borderRadius: '6px',
                                                    cursor: 'pointer',
                                                    fontSize: '13px',
                                                    fontWeight: '500'
                                                }}
                                            >
                                                View Report
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}
        </div>
    );
}
        // INDIVIDUAL PIR REPORT - DETAILED ANALYSIS
function IndividualPIRReport({ pirId, checkIns, analyticsData, onClose }) {
    const pirStats = analyticsData?.pirStats[pirId];
    const pirCheckIns = checkIns.filter(c => c.userId === pirId).sort((a, b) => {
        const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt);
        const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt);
        return dateB - dateA;
    });

    const moodChartRef = useRef(null);
    const cravingChartRef = useRef(null);
    const anxietyChartRef = useRef(null);
    const sleepChartRef = useRef(null);
    const chartInstances = useRef({});

    useEffect(() => {
        renderIndividualCharts();
        
        return () => {
            Object.values(chartInstances.current).forEach(chart => {
                if (chart) chart.destroy();
            });
        };
    }, [pirCheckIns]);

    const renderIndividualCharts = () => {
        const last30 = pirCheckIns.slice(0, 30).reverse();

        if (moodChartRef.current) {
            if (chartInstances.current.mood) chartInstances.current.mood.destroy();
            
            const ctx = moodChartRef.current.getContext('2d');
            chartInstances.current.mood = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last30.map(c => formatDate(c.createdAt)),
                    datasets: [{
                        label: 'Morning Mood',
                        data: last30.map(c => c.morningData?.mood ?? null),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 10 }
                    }
                }
            });
        }

        if (cravingChartRef.current) {
            if (chartInstances.current.craving) chartInstances.current.craving.destroy();
            
            const ctx = cravingChartRef.current.getContext('2d');
            chartInstances.current.craving = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last30.map(c => formatDate(c.createdAt)),
                    datasets: [{
                        label: 'Cravings',
                        data: last30.map(c => c.morningData?.craving ?? null),
                        borderColor: '#f44336',
                        backgroundColor: 'rgba(244, 67, 54, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 10 }
                    }
                }
            });
        }

        if (anxietyChartRef.current) {
            if (chartInstances.current.anxiety) chartInstances.current.anxiety.destroy();
            
            const ctx = anxietyChartRef.current.getContext('2d');
            chartInstances.current.anxiety = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last30.map(c => formatDate(c.createdAt)),
                    datasets: [{
    label: 'Anxiety',
    data: last30.map(c => c.morningData?.anxietyLevel ?? null),
    borderColor: '#FF9800',
    backgroundColor: 'rgba(255, 152, 0, 0.1)',
    tension: 0.4,
    fill: true
}]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 10 }
                    }
                }
            });
        }

        if (sleepChartRef.current) {
            if (chartInstances.current.sleep) chartInstances.current.sleep.destroy();
            
            const ctx = sleepChartRef.current.getContext('2d');
            chartInstances.current.sleep = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last30.map(c => formatDate(c.createdAt)),
                    datasets: [{
    label: 'Sleep Quality',
    data: last30.map(c => c.morningData?.sleepQuality ?? null),
    borderColor: '#9C27B0',
    backgroundColor: 'rgba(156, 39, 176, 0.1)',
    tension: 0.4,
    fill: true
}]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 10 }
                    }
                }
            });
        }
    };

    const exportIndividualReport = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        let yPos = 20;
        
        // Title
        doc.setFontSize(20);
        doc.text(`Check-in Report: ${pirStats.userName}`, 14, yPos);
        yPos += 15;
        
        doc.setFontSize(10);
        doc.text(`Generated: ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}`, 14, yPos);
        yPos += 15;

        // Summary Stats
        doc.setFontSize(14);
        doc.text('Summary Statistics', 14, yPos);
        yPos += 5;

        const summaryData = [
            ['Metric', 'Lifetime', 'Last 30 Days'],
            ['Total Check-ins', pirStats.totalCheckIns, pirStats.last30.totalCheckIns],
            ['Average Mood', pirStats.avgMood, pirStats.last30.avgMood],
            ['Average Cravings', pirStats.avgCraving, pirStats.last30.avgCraving],
            ['Average Anxiety', pirStats.avgAnxiety, pirStats.last30.avgAnxiety],
            ['Average Sleep Quality', pirStats.avgSleep, pirStats.last30.avgSleep],
            ['Completion Rate', `${pirStats.completionRate}%`, `${pirStats.last30.completionRate}%`]
        ];

        doc.autoTable({
            startY: yPos,
            head: [summaryData[0]],
            body: summaryData.slice(1),
            theme: 'grid',
            headStyles: { fillColor: [102, 126, 234] }
        });

        // Recent Check-ins
        doc.addPage();
        yPos = 20;
        
        doc.setFontSize(14);
        doc.text('Recent Check-ins (Last 10)', 14, yPos);
        yPos += 5;

        const recentData = pirCheckIns.slice(0, 10).map(c => [
            formatDate(c.createdAt),
            c.morningData?.mood ?? '-',
            c.morningData?.craving ?? '-',
           c.morningData?.anxietyLevel ?? '-',
c.morningData?.sleepQuality ?? '-',
            c.eveningData?.overallDay ?? '-',
            c.completionStatus === 'complete' ? 'Yes' : 'No'
        ]);

        doc.autoTable({
            startY: yPos,
            head: [['Date', 'Mood', 'Craving', 'Anxiety', 'Sleep', 'Overall', 'Complete']],
            body: recentData,
            theme: 'grid',
            headStyles: { fillColor: [102, 126, 234] },
            styles: { fontSize: 9 }
        });

        // Gratitude & Challenges
        doc.addPage();
        yPos = 20;
        
        doc.setFontSize(14);
        doc.text('Recent Gratitude & Challenges', 14, yPos);
        yPos += 10;

        pirCheckIns.slice(0, 5).forEach((c, idx) => {
            if (yPos > 250) {
                doc.addPage();
                yPos = 20;
            }
            
            doc.setFontSize(12);
            doc.text(`${formatDate(c.createdAt)}`, 14, yPos);
            yPos += 7;
            
            doc.setFontSize(10);
            if (c.eveningData?.gratitude) {
                doc.text('Gratitude:', 14, yPos);
                yPos += 5;
                const gratitudeLines = doc.splitTextToSize(c.eveningData.gratitude, 180);
                doc.text(gratitudeLines, 20, yPos);
                yPos += gratitudeLines.length * 5 + 3;
            }
            
            if (c.eveningData?.challenges) {
                doc.text('Challenges:', 14, yPos);
                yPos += 5;
                const challengeLines = doc.splitTextToSize(c.eveningData.challenges, 180);
                doc.text(challengeLines, 20, yPos);
                yPos += challengeLines.length * 5 + 3;
            }
            
            yPos += 5;
        });

        doc.save(`${pirStats.userName.replace(/\s+/g, '_')}_Report_${new Date().toISOString().split('T')[0]}.pdf`);
    };

    if (!pirStats) return null;

    return (
        <div style={{ padding: '20px', animation: 'fadeIn 0.5s' }}>
            {/* Header */}
            <div style={{ 
                display: 'flex', 
                justifyContent: 'space-between', 
                alignItems: 'center',
                marginBottom: '30px'
            }}>
                <div>
                    <h2 style={{ margin: '0 0 10px 0', fontSize: '28px', color: '#333' }}>
                        {pirStats.userName} - Detailed Report
                    </h2>
                    <p style={{ margin: 0, color: '#666', fontSize: '14px' }}>
                        Comprehensive check-in analysis and trends
                    </p>
                </div>
                <div style={{ display: 'flex', gap: '10px' }}>
                    <button
                        onClick={exportIndividualReport}
                        style={{
                            padding: '12px 24px',
                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            color: 'white',
                            border: 'none',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '600'
                        }}
                    >
                        Export PDF Report
                    </button>
                    <button
                        onClick={onClose}
                        style={{
                            padding: '12px 24px',
                            background: '#6c757d',
                            color: 'white',
                            border: 'none',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '600'
                        }}
                    >
                        Back to Analytics
                    </button>
                </div>
            </div>

            {/* Summary Cards */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '20px', marginBottom: '30px' }}>
                <div style={{
                    background: 'white',
                    padding: '20px',
                    borderRadius: '12px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                    borderLeft: '4px solid #667eea'
                }}>
                    <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px' }}>Total Check-ins</div>
                    <div style={{ fontSize: '28px', fontWeight: 'bold', color: '#333' }}>{pirStats.totalCheckIns}</div>
                    <div style={{ fontSize: '12px', color: '#999', marginTop: '4px' }}>
                        Last 30 days: {pirStats.last30.totalCheckIns}
                    </div>
                </div>

                <div style={{
                    background: 'white',
                    padding: '20px',
                    borderRadius: '12px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                    borderLeft: '4px solid #4CAF50'
                }}>
                    <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px' }}>Completion Rate</div>
                    <div style={{ fontSize: '28px', fontWeight: 'bold', color: '#4CAF50' }}>{pirStats.completionRate}%</div>
                    <div style={{ fontSize: '12px', color: '#999', marginTop: '4px' }}>
                        Last 30 days: {pirStats.last30.completionRate}%
                    </div>
                </div>

                <div style={{
                    background: 'white',
                    padding: '20px',
                    borderRadius: '12px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                    borderLeft: '4px solid #667eea'
                }}>
                    <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px' }}>Avg Mood</div>
                    <div style={{ fontSize: '28px', fontWeight: 'bold', color: '#667eea' }}>{pirStats.avgMood}/10</div>
                    <div style={{ fontSize: '12px', color: '#999', marginTop: '4px' }}>
                        Last 30 days: {pirStats.last30.avgMood}/10
                    </div>
                </div>

                <div style={{
                    background: 'white',
                    padding: '20px',
                    borderRadius: '12px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                    borderLeft: '4px solid #f44336'
                }}>
                    <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px' }}>Avg Cravings</div>
                    <div style={{ fontSize: '28px', fontWeight: 'bold', color: '#f44336' }}>{pirStats.avgCraving}/10</div>
                    <div style={{ fontSize: '12px', color: '#999', marginTop: '4px' }}>
                        Last 30 days: {pirStats.last30.avgCraving}/10
                    </div>
                </div>

                <div style={{
                    background: 'white',
                    padding: '20px',
                    borderRadius: '12px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                    borderLeft: '4px solid #FF9800'
                }}>
                    <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px' }}>Avg Anxiety</div>
                    <div style={{ fontSize: '28px', fontWeight: 'bold', color: '#FF9800' }}>{pirStats.avgAnxiety}/10</div>
                    <div style={{ fontSize: '12px', color: '#999', marginTop: '4px' }}>
                        Last 30 days: {pirStats.last30.avgAnxiety}/10
                    </div>
                </div>

                <div style={{
                    background: 'white',
                    padding: '20px',
                    borderRadius: '12px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                    borderLeft: '4px solid #9C27B0'
                }}>
                    <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px' }}>Avg Sleep</div>
                    <div style={{ fontSize: '28px', fontWeight: 'bold', color: '#9C27B0' }}>{pirStats.avgSleep}/10</div>
                    <div style={{ fontSize: '12px', color: '#999', marginTop: '4px' }}>
                        Last 30 days: {pirStats.last30.avgSleep}/10
                    </div>
                </div>
            </div>

            {/* Charts */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '30px',
                marginBottom: '30px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <h3 style={{ margin: '0 0 25px 0', fontSize: '20px', color: '#333' }}>
                    Trend Analysis (Last 30 Check-ins)
                </h3>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(350px, 1fr))', gap: '30px' }}>
                    <div>
                        <h4 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#666' }}>Mood Trend</h4>
                        <div style={{ height: '250px' }}>
                            <canvas ref={moodChartRef}></canvas>
                        </div>
                    </div>
                    <div>
                        <h4 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#666' }}>Craving Intensity</h4>
                        <div style={{ height: '250px' }}>
                            <canvas ref={cravingChartRef}></canvas>
                        </div>
                    </div>
                    <div>
                        <h4 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#666' }}>Anxiety Levels</h4>
                        <div style={{ height: '250px' }}>
                            <canvas ref={anxietyChartRef}></canvas>
                        </div>
                    </div>
                    <div>
                        <h4 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#666' }}>Sleep Quality</h4>
                        <div style={{ height: '250px' }}>
                            <canvas ref={sleepChartRef}></canvas>
                        </div>
                    </div>
                </div>
            </div>

            {/* Recent Check-ins Table */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '30px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <h3 style={{ margin: '0 0 20px 0', fontSize: '20px', color: '#333' }}>
                    Recent Check-ins (Last 10)
                </h3>
                <div style={{ overflowX: 'auto' }}>
                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                        <thead style={{ background: '#f8f9fa' }}>
                            <tr>
                                <th style={{ padding: '12px', textAlign: 'left', fontWeight: '600', color: '#333', fontSize: '13px' }}>Date</th>
                                <th style={{ padding: '12px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '13px' }}>Mood</th>
                                <th style={{ padding: '12px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '13px' }}>Craving</th>
                                <th style={{ padding: '12px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '13px' }}>Anxiety</th>
                                <th style={{ padding: '12px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '13px' }}>Sleep</th>
                                <th style={{ padding: '12px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '13px' }}>Overall</th>
                                <th style={{ padding: '12px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '13px' }}>Complete</th>
                            </tr>
                        </thead>
                        <tbody>
                            {pirCheckIns.slice(0, 10).map(checkIn => (
                                <tr key={checkIn.id} style={{ borderBottom: '1px solid #f0f0f0' }}>
                                    <td style={{ padding: '12px', fontSize: '13px', color: '#666' }}>
                                        {formatDate(checkIn.createdAt)}
                                    </td>
                                    <td style={{ padding: '12px', textAlign: 'center', fontSize: '14px', fontWeight: '600', color: '#667eea' }}>
                                        {checkIn.morningData?.mood ?? '-'}
                                    </td>
                                    <td style={{ padding: '12px', textAlign: 'center', fontSize: '14px', fontWeight: '600', color: '#f44336' }}>
                                        {checkIn.morningData?.craving ?? '-'}
                                    </td>
                                    <td style={{ padding: '12px', textAlign: 'center', fontSize: '14px', fontWeight: '600', color: '#FF9800' }}>
                                        {checkIn.eveningData?.anxiety ?? '-'}
                                    </td>
                                    <td style={{ padding: '12px', textAlign: 'center', fontSize: '14px', fontWeight: '600', color: '#9C27B0' }}>
                                        {checkIn.eveningData?.sleepQuality ?? '-'}
                                    </td>
                                    <td style={{ padding: '12px', textAlign: 'center', fontSize: '14px', fontWeight: '600', color: '#2196F3' }}>
                                        {checkIn.eveningData?.overallDay ?? '-'}
                                    </td>
                                    <td style={{ padding: '12px', textAlign: 'center' }}>
                                        <span style={{
                                            padding: '4px 10px',
                                            borderRadius: '12px',
                                            fontSize: '11px',
                                            fontWeight: '600',
                                            background: checkIn.completionStatus === 'complete' ? '#d4edda' : '#f8d7da',
                                            color: checkIn.completionStatus === 'complete' ? '#155724' : '#721c24'
                                        }}>
                                            {checkIn.completionStatus === 'complete' ? 'Yes' : 'No'}
                                        </span>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
}

        // FULLY FUNCTIONAL AssignmentsView
        function AssignmentsView({ searchQuery, user }) {
            const [assignments, setAssignments] = useState([]);
            const [filteredAssignments, setFilteredAssignments] = useState([]);
            const [loading, setLoading] = useState(true);
            const [currentPage, setCurrentPage] = useState(1);
            const [filterStatus, setFilterStatus] = useState('all');
            const [filterUser, setFilterUser] = useState('all');
            const [showCreateModal, setShowCreateModal] = useState(false);
            const [selectedAssignment, setSelectedAssignment] = useState(null);
            const [users, setUsers] = useState([]);
            const itemsPerPage = 20;

            useEffect(() => {
                loadAssignmentsAndUsers();
            }, []);

            useEffect(() => {
                filterAssignments();
            }, [assignments, filterStatus, filterUser, searchQuery]);

            const loadAssignmentsAndUsers = async () => {
                try {
                    // Load PIRs for filter and assignment
                    const usersSnap = await db.collection('users')
                        .where('role', '==', 'pir')
                        .get();
                    
                    const usersData = [];
                    const userMap = {};
                    
                    usersSnap.forEach(doc => {
                        const user = { id: doc.id, ...doc.data() };
                        usersData.push(user);
                        userMap[doc.id] = user.displayName || user.email;
                    });
                    
                    setUsers(usersData);

                    // Load assignments
                    const assignmentsSnap = await db.collection('assignments')
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    const assignmentsData = [];
                    assignmentsSnap.forEach(doc => {
                        const assignment = { id: doc.id, ...doc.data() };
                        assignment.userName = userMap[assignment.userId] || 'Unknown User';
                        
                        // Check if overdue
                        if (assignment.dueDate && assignment.status !== 'completed') {
                            const dueDate = assignment.dueDate.toDate ? assignment.dueDate.toDate() : new Date(assignment.dueDate);
                            if (dueDate < new Date()) {
                                assignment.overdue = true;
                            }
                        }
                        
                        assignmentsData.push(assignment);
                    });
                    
                    setAssignments(assignmentsData);
                    setFilteredAssignments(assignmentsData);
                } catch (error) {
                    console.error('Error loading assignments:', error);
                    alert('Failed to load assignments');
                } finally {
                    setLoading(false);
                }
            };

            const filterAssignments = () => {
                let filtered = assignments;
                
                // Filter by status
                if (filterStatus !== 'all') {
                    if (filterStatus === 'overdue') {
                        filtered = filtered.filter(assignment => assignment.overdue);
                    } else {
                        filtered = filtered.filter(assignment => assignment.status === filterStatus);
                    }
                }
                
                // Filter by user
                if (filterUser !== 'all') {
                    filtered = filtered.filter(assignment => assignment.userId === filterUser);
                }
                
                // Filter by search
                if (searchQuery) {
                    const query = searchQuery.toLowerCase();
                    filtered = filtered.filter(assignment =>
                        assignment.userName?.toLowerCase().includes(query) ||
                        assignment.title?.toLowerCase().includes(query) ||
                        assignment.description?.toLowerCase().includes(query)
                    );
                }
                
                setFilteredAssignments(filtered);
                setCurrentPage(1);
            };

            const handleStatusUpdate = async (assignmentId, newStatus) => {
                try {
                    await db.collection('assignments').doc(assignmentId).update({
                        status: newStatus,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Update local state
                    setAssignments(prev => prev.map(a => 
                        a.id === assignmentId ? { ...a, status: newStatus } : a
                    ));
                    
                    alert('Assignment status updated');
                } catch (error) {
                    console.error('Error updating assignment:', error);
                    alert('Failed to update assignment');
                }
            };

            const handleDelete = async (assignmentId) => {
                if (!confirm('Are you sure you want to delete this assignment?')) return;
                
                try {
                    await db.collection('assignments').doc(assignmentId).delete();
                    setAssignments(prev => prev.filter(a => a.id !== assignmentId));
                    alert('Assignment deleted');
                } catch (error) {
                    console.error('Error deleting assignment:', error);
                    alert('Failed to delete assignment');
                }
            };

            const paginatedAssignments = useMemo(() => {
                const start = (currentPage - 1) * itemsPerPage;
                const end = start + itemsPerPage;
                return filteredAssignments.slice(start, end);
            }, [filteredAssignments, currentPage]);

            const totalPages = Math.ceil(filteredAssignments.length / itemsPerPage);

            const handleExport = (format) => {
                const exportData = filteredAssignments.map(assignment => ({
                    user: assignment.userName,
                    title: assignment.title,
                    description: assignment.description,
                    status: assignment.status,
                    dueDate: assignment.dueDate ? formatDate(assignment.dueDate) : 'N/A',
                    createdAt: formatDate(assignment.createdAt),
                    overdue: assignment.overdue ? 'Yes' : 'No'
                }));

                if (format === 'json') {
                    exportToJSON(exportData, 'assignments');
                } else if (format === 'csv') {
                    exportToCSV(exportData, 'assignments');
                } else if (format === 'pdf') {
                    exportToPDF(exportData, 'Assignments Report');
                }
            };

            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="loading-spinner"></div>
                    </div>
                );
            }

            return (
                <div>
                    <div className="filter-bar">
                        <div className="filter-group">
                            <label className="filter-label">Status</label>
                            <select 
                                className="filter-select"
                                value={filterStatus}
                                onChange={(e) => setFilterStatus(e.target.value)}
                            >
                                <option value="all">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="in_progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="overdue">Overdue</option>
                            </select>
                        </div>
                        
                        <div className="filter-group">
                            <label className="filter-label">User</label>
                            <select 
                                className="filter-select"
                                value={filterUser}
                                onChange={(e) => setFilterUser(e.target.value)}
                            >
                                <option value="all">All Users</option>
                                {users.map(user => (
                                    <option key={user.id} value={user.id}>
                                        {user.displayName || user.email}
                                    </option>
                                ))}
                            </select>
                        </div>
                        
                        <div style={{marginLeft: 'auto', display: 'flex', gap: '10px'}}>
                            <button className="btn btn-secondary" onClick={() => handleExport('csv')}>
                                Export CSV
                            </button>
                            <button className="btn btn-secondary" onClick={() => handleExport('json')}>
                                Export JSON
                            </button>
                            <button className="btn btn-primary" onClick={() => setShowCreateModal(true)}>
                                + Create Assignment
                            </button>
                        </div>
                    </div>
                    
                    <div className="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Title</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th>Due Date</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {paginatedAssignments.map(assignment => (
                                    <tr key={assignment.id}>
                                        <td>{assignment.userName}</td>
                                        <td>{assignment.title}</td>
                                        <td style={{maxWidth: '200px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>
                                            {assignment.description}
                                        </td>
                                        <td>
                                            <span className={`badge ${
                                                assignment.overdue ? 'badge-danger' :
                                                assignment.status === 'completed' ? 'badge-success' :
                                                assignment.status === 'in_progress' ? 'badge-warning' :
                                                'badge-info'
                                            }`}>
                                                {assignment.overdue ? 'Overdue' : assignment.status?.replace('_', ' ')}
                                            </span>
                                        </td>
                                        <td>{assignment.dueDate ? formatDate(assignment.dueDate) : '-'}</td>
                                        <td>{formatDate(assignment.createdAt)}</td>
                                        <td>
                                            <div className="action-buttons">
                                                <button 
                                                    className="action-btn"
                                                    onClick={() => setSelectedAssignment(assignment)}
                                                >
                                                    View
                                                </button>
                                                {assignment.status !== 'completed' && (
                                                    <button 
                                                        className="action-btn"
                                                        onClick={() => handleStatusUpdate(assignment.id, 
                                                            assignment.status === 'pending' ? 'in_progress' : 'completed'
                                                        )}
                                                    >
                                                        {assignment.status === 'pending' ? 'Start' : 'Complete'}
                                                    </button>
                                                )}
                                                <button 
                                                    className="action-btn"
                                                    onClick={() => handleDelete(assignment.id)}
                                                    style={{color: '#f44336'}}
                                                >
                                                    Delete
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        
                        {filteredAssignments.length === 0 && (
                            <div className="empty-state">
                                <div className="empty-state-text">
                                    {searchQuery ? 'No assignments found matching your search' : 'No assignments found'}
                                </div>
                            </div>
                        )}
                    </div>
                    
                    {totalPages > 1 && (
                        <Pagination 
                            currentPage={currentPage}
                            totalPages={totalPages}
                            onPageChange={setCurrentPage}
                        />
                    )}
                    
                    {showCreateModal && (
                        <CreateAssignmentModal 
                            onClose={() => setShowCreateModal(false)}
                            onSuccess={() => {
                                setShowCreateModal(false);
                                loadAssignmentsAndUsers();
                            }}
                            users={users}
                            createdBy={user.uid}
                        />
                    )}
                    
                    {selectedAssignment && (
                        <AssignmentDetailModal 
                            assignment={selectedAssignment}
                            onClose={() => setSelectedAssignment(null)}
                            onUpdate={() => loadAssignmentsAndUsers()}
                        />
                    )}
                </div>
            );
        }

      

// FULLY ENHANCED FeedbackView with All Features
function FeedbackView({ searchQuery, user }) {
    const [feedbacks, setFeedbacks] = useState([]);
    const [filteredFeedbacks, setFilteredFeedbacks] = useState([]);
    const [loading, setLoading] = useState(true);
    const [currentPage, setCurrentPage] = useState(1);
    const [filterStatus, setFilterStatus] = useState('all');
    const [filterType, setFilterType] = useState('all');
    const [filterSentiment, setFilterSentiment] = useState('all');
    const [selectedFeedback, setSelectedFeedback] = useState(null);
    const [selectedFeedbacks, setSelectedFeedbacks] = useState(new Set());
    const [stats, setStats] = useState({
        total: 0,
        pending: 0,
        avgRating: 0,
        responseRate: 0
    });
    const itemsPerPage = 20;

    useEffect(() => {
        loadFeedbacks();
    }, []);

    useEffect(() => {
        filterFeedbacks();
        calculateStats();
    }, [feedbacks, filterStatus, filterType, filterSentiment, searchQuery]);

    const analyzeSentiment = (feedback) => {
        const text = (feedback.message + ' ' + feedback.subject).toLowerCase();
        const positiveWords = ['great', 'excellent', 'amazing', 'love', 'perfect', 'fantastic', 'wonderful', 'helpful', 'thank'];
        const negativeWords = ['bad', 'terrible', 'awful', 'hate', 'worst', 'horrible', 'disappointed', 'frustrated', 'angry', 'useless'];
        
        let score = 0;
        positiveWords.forEach(word => { if (text.includes(word)) score++; });
        negativeWords.forEach(word => { if (text.includes(word)) score--; });
        
        if (score > 1) return 'positive';
        if (score < -1) return 'negative';
        return 'neutral';
    };

    const loadFeedbacks = async () => {
        try {
            const feedbacksSnap = await db.collection('feedback')
                .orderBy('createdAt', 'desc')
                .get();
            
            const feedbacksData = [];
            const userIds = new Set();
            
            feedbacksSnap.forEach(doc => {
                const feedback = { id: doc.id, ...doc.data() };
                feedback.sentiment = analyzeSentiment(feedback);
                feedbacksData.push(feedback);
                if (feedback.userId) userIds.add(feedback.userId);
            });
            
            if (userIds.size > 0) {
                const userResults = await batchQuery('users',
                    firebase.firestore.FieldPath.documentId(),
                    Array.from(userIds)
                );
                
                const userMap = {};
                userResults.forEach(user => {
                    userMap[user.id] = user.displayName || user.email;
                });
                
                feedbacksData.forEach(feedback => {
                    feedback.userName = userMap[feedback.userId] || 'Anonymous';
                });
            }
            
            setFeedbacks(feedbacksData);
            setFilteredFeedbacks(feedbacksData);
        } catch (error) {
            console.error('Error loading feedback:', error);
            alert('Failed to load feedback');
        } finally {
            setLoading(false);
        }
    };

    const calculateStats = () => {
        const total = feedbacks.length;
        const pending = feedbacks.filter(f => !f.reviewed).length;
        const ratings = feedbacks.filter(f => f.rating).map(f => f.rating);
        const avgRating = ratings.length > 0 ? (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1) : 0;
        const responded = feedbacks.filter(f => f.response).length;
        const responseRate = total > 0 ? Math.round((responded / total) * 100) : 0;
        
        setStats({ total, pending, avgRating, responseRate });
    };

    const filterFeedbacks = () => {
        let filtered = feedbacks;
        
        if (filterStatus !== 'all') {
            filtered = filtered.filter(feedback => 
                filterStatus === 'reviewed' ? feedback.reviewed : !feedback.reviewed
            );
        }
        
        if (filterType !== 'all') {
            filtered = filtered.filter(feedback => feedback.type === filterType);
        }
        
        if (filterSentiment !== 'all') {
            filtered = filtered.filter(feedback => feedback.sentiment === filterSentiment);
        }
        
        if (searchQuery) {
            const query = searchQuery.toLowerCase();
            filtered = filtered.filter(feedback =>
                feedback.userName?.toLowerCase().includes(query) ||
                feedback.subject?.toLowerCase().includes(query) ||
                feedback.message?.toLowerCase().includes(query)
            );
        }
        
        setFilteredFeedbacks(filtered);
        setCurrentPage(1);
    };

    const quickFilter = (type) => {
        if (type === 'urgent') {
            setFilterType('complaint');
            setFilterStatus('pending');
        } else if (type === 'high-priority') {
            setFilterSentiment('negative');
            setFilterStatus('pending');
        } else if (type === 'needs-response') {
            setFilterStatus('pending');
        }
    };

    const handleSelectAll = () => {
        if (selectedFeedbacks.size === paginatedFeedbacks.length) {
            setSelectedFeedbacks(new Set());
        } else {
            setSelectedFeedbacks(new Set(paginatedFeedbacks.map(f => f.id)));
        }
    };

    const handleSelectFeedback = (feedbackId) => {
        const newSelected = new Set(selectedFeedbacks);
        if (newSelected.has(feedbackId)) {
            newSelected.delete(feedbackId);
        } else {
            newSelected.add(feedbackId);
        }
        setSelectedFeedbacks(newSelected);
    };

    const handleBulkMarkReviewed = async () => {
        try {
            const batch = db.batch();
            selectedFeedbacks.forEach(feedbackId => {
                const feedbackRef = db.collection('feedback').doc(feedbackId);
                batch.update(feedbackRef, {
                    reviewed: true,
                    reviewedBy: user.uid,
                    reviewedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            });
            
            await batch.commit();
            
            setFeedbacks(prev => prev.map(f => 
                selectedFeedbacks.has(f.id) ? { ...f, reviewed: true } : f
            ));
            setSelectedFeedbacks(new Set());
            alert(`Marked ${selectedFeedbacks.size} feedbacks as reviewed`);
        } catch (error) {
            console.error('Error bulk updating:', error);
            alert('Failed to update feedbacks');
        }
    };

    const handleMarkReviewed = async (feedbackId, reviewed = true) => {
        try {
            await db.collection('feedback').doc(feedbackId).update({
                reviewed: reviewed,
                reviewedBy: user.uid,
                reviewedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            setFeedbacks(prev => prev.map(f => 
                f.id === feedbackId ? { ...f, reviewed } : f
            ));
            
            alert('Feedback marked as ' + (reviewed ? 'reviewed' : 'unreviewed'));
        } catch (error) {
            console.error('Error updating feedback:', error);
            alert('Failed to update feedback');
        }
    };

    const handleRespond = async (feedbackId, response) => {
        try {
            await db.collection('feedback').doc(feedbackId).update({
                response: response,
                respondedBy: user.uid,
                respondedAt: firebase.firestore.FieldValue.serverTimestamp(),
                reviewed: true
            });
            
            setFeedbacks(prev => prev.map(f => 
                f.id === feedbackId ? { ...f, response, reviewed: true } : f
            ));
            
            alert('Response sent successfully');
        } catch (error) {
            console.error('Error responding to feedback:', error);
            alert('Failed to send response');
        }
    };

    const handleDelete = async (feedbackId) => {
        if (!confirm('Are you sure you want to delete this feedback?')) return;
        
        try {
            await db.collection('feedback').doc(feedbackId).delete();
            setFeedbacks(prev => prev.filter(f => f.id !== feedbackId));
            alert('Feedback deleted');
        } catch (error) {
            console.error('Error deleting feedback:', error);
            alert('Failed to delete feedback');
        }
    };

    const renderStars = (rating) => {
        if (!rating) return '-';
        return (
            <div style={{ display: 'flex', gap: '2px' }}>
                {[1, 2, 3, 4, 5].map(star => (
                    <span key={star} style={{ 
                        color: star <= rating ? '#FFD700' : '#ddd',
                        fontSize: '16px'
                    }}>
                        ‚òÖ
                    </span>
                ))}
            </div>
        );
    };

    const getSentimentColor = (sentiment) => {
        if (sentiment === 'positive') return '#4CAF50';
        if (sentiment === 'negative') return '#f44336';
        return '#9E9E9E';
    };

    const paginatedFeedbacks = useMemo(() => {
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        return filteredFeedbacks.slice(start, end);
    }, [filteredFeedbacks, currentPage]);

    const totalPages = Math.ceil(filteredFeedbacks.length / itemsPerPage);

    const handleExport = (format) => {
        const exportData = filteredFeedbacks.map(feedback => ({
            user: feedback.userName,
            type: feedback.type,
            subject: feedback.subject,
            message: feedback.message,
            rating: feedback.rating || 'N/A',
            sentiment: feedback.sentiment,
            status: feedback.reviewed ? 'Reviewed' : 'Pending',
            createdAt: formatDate(feedback.createdAt),
            response: feedback.response || 'No response yet'
        }));

        if (format === 'json') {
            exportToJSON(exportData, 'feedback');
        } else if (format === 'csv') {
            exportToCSV(exportData, 'feedback');
        } else if (format === 'pdf') {
            exportToPDF(exportData, 'Feedback Report');
        }
    };

    if (loading) {
        return (
            <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                minHeight: '400px',
                gap: '20px'
            }}>
                <div style={{
                    width: '60px',
                    height: '60px',
                    border: '4px solid #f3f3f3',
                    borderTop: '4px solid #667eea',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite'
                }}></div>
                <p style={{ color: '#666' }}>Loading feedback...</p>
            </div>
        );
    }

    return (
        <div style={{ padding: '20px', animation: 'fadeIn 0.5s' }}>
            {/* Stats Cards */}
            <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(240px, 1fr))',
                gap: '20px',
                marginBottom: '30px'
            }}>
                <div style={{
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(102, 126, 234, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Total Feedback</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.total}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>All time</div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(240, 147, 251, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Pending Reviews</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.pending}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Awaiting action</div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(79, 172, 254, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Average Rating</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.avgRating}/5
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>From rated feedback</div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(250, 112, 154, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Response Rate</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.responseRate}%
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Responded to</div>
                </div>
            </div>

            {/* Quick Filters */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '15px 20px',
                marginBottom: '20px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                display: 'flex',
                gap: '10px',
                flexWrap: 'wrap',
                alignItems: 'center'
            }}>
                <span style={{ fontWeight: '600', color: '#333', marginRight: '10px' }}>Quick Filters:</span>
                <button
                    onClick={() => quickFilter('urgent')}
                    style={{
                        padding: '8px 16px',
                        background: 'linear-gradient(135deg, #f44336 0%, #e53935 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontSize: '13px',
                        fontWeight: '500',
                        transition: 'transform 0.2s'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                    onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    Urgent Complaints
                </button>
                <button
                    onClick={() => quickFilter('high-priority')}
                    style={{
                        padding: '8px 16px',
                        background: 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontSize: '13px',
                        fontWeight: '500',
                        transition: 'transform 0.2s'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                    onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    High Priority
                </button>
                <button
                    onClick={() => quickFilter('needs-response')}
                    style={{
                        padding: '8px 16px',
                        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontSize: '13px',
                        fontWeight: '500',
                        transition: 'transform 0.2s'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                    onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    Needs Response
                </button>
            </div>

            {/* Filters and Actions Bar */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                marginBottom: '20px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', flexWrap: 'wrap', gap: '15px' }}>
                    <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                        <select 
                            value={filterStatus}
                            onChange={(e) => setFilterStatus(e.target.value)}
                            style={{
                                padding: '8px 12px',
                                borderRadius: '8px',
                                border: '1px solid #ddd',
                                background: 'white',
                                cursor: 'pointer',
                                fontSize: '14px'
                            }}
                        >
                            <option value="all">All Status</option>
                            <option value="pending">Pending Review</option>
                            <option value="reviewed">Reviewed</option>
                        </select>
                        
                        <select 
                            value={filterType}
                            onChange={(e) => setFilterType(e.target.value)}
                            style={{
                                padding: '8px 12px',
                                borderRadius: '8px',
                                border: '1px solid #ddd',
                                background: 'white',
                                cursor: 'pointer',
                                fontSize: '14px'
                            }}
                        >
                            <option value="all">All Types</option>
                            <option value="bug">Bug Report</option>
                            <option value="feature">Feature Request</option>
                            <option value="general">General Feedback</option>
                            <option value="complaint">Complaint</option>
                            <option value="praise">Praise</option>
                        </select>

                        <select 
                            value={filterSentiment}
                            onChange={(e) => setFilterSentiment(e.target.value)}
                            style={{
                                padding: '8px 12px',
                                borderRadius: '8px',
                                border: '1px solid #ddd',
                                background: 'white',
                                cursor: 'pointer',
                                fontSize: '14px'
                            }}
                        >
                            <option value="all">All Sentiments</option>
                            <option value="positive">Positive</option>
                            <option value="neutral">Neutral</option>
                            <option value="negative">Negative</option>
                        </select>
                    </div>
                    
                    <div style={{ display: 'flex', gap: '10px' }}>
                        {selectedFeedbacks.size > 0 && (
                            <button 
                                onClick={handleBulkMarkReviewed}
                                style={{
                                    padding: '10px 16px',
                                    background: 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500'
                                }}
                            >
                                Mark {selectedFeedbacks.size} as Reviewed
                            </button>
                        )}
                        <button 
                            onClick={() => handleExport('csv')}
                            style={{
                                padding: '10px 16px',
                                background: '#6c757d',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '500'
                            }}
                        >
                            Export CSV
                        </button>
                    </div>
                </div>
            </div>
            
            {/* Enhanced Table */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                overflow: 'hidden',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                    <thead>
                        <tr style={{ background: '#f8f9fa', borderBottom: '2px solid #e9ecef' }}>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>
                                <input 
                                    type="checkbox"
                                    checked={selectedFeedbacks.size === paginatedFeedbacks.length && paginatedFeedbacks.length > 0}
                                    onChange={handleSelectAll}
                                    style={{ cursor: 'pointer', width: '16px', height: '16px' }}
                                />
                            </th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>User</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Type</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Subject</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Rating</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Sentiment</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Status</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Date</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {paginatedFeedbacks.map(feedback => (
                            <tr key={feedback.id} style={{
                                borderBottom: '1px solid #f0f0f0',
                                transition: 'all 0.2s',
                                background: selectedFeedbacks.has(feedback.id) ? '#f0f4ff' : 'white'
                            }}
                            onMouseEnter={(e) => {
                                if (!selectedFeedbacks.has(feedback.id)) {
                                    e.currentTarget.style.background = '#f8f9fa';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (!selectedFeedbacks.has(feedback.id)) {
                                    e.currentTarget.style.background = 'white';
                                }
                            }}
                            >
                                <td style={{ padding: '15px' }}>
                                    <input 
                                        type="checkbox"
                                        checked={selectedFeedbacks.has(feedback.id)}
                                        onChange={() => handleSelectFeedback(feedback.id)}
                                        style={{ cursor: 'pointer', width: '16px', height: '16px' }}
                                    />
                                </td>
                                <td style={{ padding: '15px', fontWeight: '500', color: '#333' }}>
                                    {feedback.userName}
                                </td>
                                <td style={{ padding: '15px' }}>
                                    <span style={{
                                        padding: '4px 12px',
                                        borderRadius: '20px',
                                        fontSize: '12px',
                                        fontWeight: '500',
                                        background: '#e3f2fd',
                                        color: '#1976d2'
                                    }}>
                                        {feedback.type}
                                    </span>
                                </td>
                                <td style={{ padding: '15px', color: '#666', maxWidth: '200px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                    {feedback.subject}
                                </td>
                                <td style={{ padding: '15px' }}>{renderStars(feedback.rating)}</td>
                                <td style={{ padding: '15px' }}>
                                    <div style={{
                                        width: '10px',
                                        height: '10px',
                                        borderRadius: '50%',
                                        background: getSentimentColor(feedback.sentiment),
                                        display: 'inline-block'
                                    }}></div>
                                </td>
                                <td style={{ padding: '15px' }}>
                                    <span style={{
                                        padding: '4px 12px',
                                        borderRadius: '20px',
                                        fontSize: '12px',
                                        fontWeight: '500',
                                        background: feedback.reviewed ? '#d4edda' : '#fff3cd',
                                        color: feedback.reviewed ? '#155724' : '#856404'
                                    }}>
                                        {feedback.reviewed ? 'Reviewed' : 'Pending'}
                                    </span>
                                </td>
                                <td style={{ padding: '15px', color: '#666' }}>{formatDate(feedback.createdAt)}</td>
                                <td style={{ padding: '15px' }}>
                                    <button 
                                        onClick={() => setSelectedFeedback(feedback)}
                                        style={{
                                            padding: '6px 12px',
                                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            fontWeight: '500'
                                        }}
                                    >
                                        View
                                    </button>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
                
                {filteredFeedbacks.length === 0 && (
                    <div style={{
                        padding: '60px 20px',
                        textAlign: 'center',
                        color: '#999'
                    }}>
                        <div style={{ fontSize: '48px', marginBottom: '15px' }}>üìù</div>
                        <div style={{ fontSize: '18px', fontWeight: '500', marginBottom: '8px' }}>
                            No feedback found
                        </div>
                        <div style={{ fontSize: '14px' }}>
                            {searchQuery ? 'Try adjusting your search terms' : 'Feedback will appear here when submitted'}
                        </div>
                    </div>
                )}
            </div>
            
            {totalPages > 1 && (
                <div style={{ marginTop: '20px' }}>
                    <Pagination 
                        currentPage={currentPage}
                        totalPages={totalPages}
                        onPageChange={setCurrentPage}
                    />
                </div>
            )}
            
            {selectedFeedback && (
                <FeedbackDetailModal 
                    feedback={selectedFeedback}
                    onClose={() => setSelectedFeedback(null)}
                    onRespond={handleRespond}
                    onMarkReviewed={handleMarkReviewed}
                    getSentimentColor={getSentimentColor}
                    renderStars={renderStars}
                />
            )}
        </div>
    );
}

// Enhanced Feedback Detail Modal
function FeedbackDetailModal({ feedback, onClose, onRespond, onMarkReviewed, getSentimentColor, renderStars }) {
    const [response, setResponse] = useState(feedback.response || '');
    const [submitting, setSubmitting] = useState(false);

    const handleSubmit = async () => {
        if (!response.trim()) {
            alert('Please enter a response');
            return;
        }
        
        setSubmitting(true);
        await onRespond(feedback.id, response);
        setSubmitting(false);
        onClose();
    };

    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000,
            padding: '20px',
            animation: 'fadeIn 0.2s'
        }}>
            <div style={{
                background: 'white',
                borderRadius: '20px',
                maxWidth: '700px',
                width: '100%',
                maxHeight: '90vh',
                overflow: 'auto',
                boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
                animation: 'slideUp 0.3s'
            }}>
                {/* Header */}
                <div style={{
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    padding: '25px 30px',
                    borderRadius: '20px 20px 0 0',
                    color: 'white',
                    position: 'sticky',
                    top: 0,
                    zIndex: 1
                }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <h2 style={{ margin: 0, fontSize: '24px' }}>Feedback Details</h2>
                        <button 
                            onClick={onClose}
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                border: 'none',
                                color: 'white',
                                fontSize: '24px',
                                width: '36px',
                                height: '36px',
                                borderRadius: '50%',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                transition: 'background 0.2s'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.3)'}
                            onMouseLeave={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.2)'}
                        >
                            √ó
                        </button>
                    </div>
                </div>

                {/* Content */}
                <div style={{ padding: '30px' }}>
                    {/* Info Grid */}
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(2, 1fr)',
                        gap: '20px',
                        marginBottom: '25px'
                    }}>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>User</div>
                            <div style={{ fontSize: '16px', fontWeight: '500', color: '#333' }}>
                                {feedback.userName}
                            </div>
                        </div>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Type</div>
                            <div style={{ fontSize: '16px', fontWeight: '500', color: '#333' }}>
                                {feedback.type}
                            </div>
                        </div>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Rating</div>
                            {renderStars(feedback.rating)}
                        </div>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Sentiment</div>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                <div style={{
                                    width: '12px',
                                    height: '12px',
                                    borderRadius: '50%',
                                    background: getSentimentColor(feedback.sentiment)
                                }}></div>
                                <span style={{ textTransform: 'capitalize' }}>{feedback.sentiment}</span>
                            </div>
                        </div>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Date</div>
                            <div style={{ fontSize: '16px', fontWeight: '500', color: '#333' }}>
                                {formatDate(feedback.createdAt)}
                            </div>
                        </div>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Status</div>
                            <span style={{
                                padding: '4px 12px',
                                borderRadius: '20px',
                                fontSize: '12px',
                                fontWeight: '500',
                                background: feedback.reviewed ? '#d4edda' : '#fff3cd',
                                color: feedback.reviewed ? '#155724' : '#856404'
                            }}>
                                {feedback.reviewed ? 'Reviewed' : 'Pending'}
                            </span>
                        </div>
                    </div>

                    {/* Subject */}
                    <div style={{ marginBottom: '20px' }}>
                        <div style={{ fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                            Subject
                        </div>
                        <div style={{
                            padding: '15px',
                            background: '#f8f9fa',
                            borderRadius: '10px',
                            color: '#666'
                        }}>
                            {feedback.subject}
                        </div>
                    </div>

                    {/* Message */}
                    <div style={{ marginBottom: '25px' }}>
                        <div style={{ fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                            Message
                        </div>
                        <div style={{
                            padding: '15px',
                            background: '#f8f9fa',
                            borderRadius: '10px',
                            color: '#666',
                            lineHeight: '1.6',
                            whiteSpace: 'pre-wrap'
                        }}>
                            {feedback.message}
                        </div>
                    </div>

                    {/* Response Section */}
                    <div style={{ marginBottom: '20px' }}>
                        <div style={{ fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                            {feedback.response ? 'Your Response' : 'Add Response'}
                        </div>
                        <textarea
                            value={response}
                            onChange={(e) => setResponse(e.target.value)}
                            placeholder="Type your response here..."
                            style={{
                                width: '100%',
                                minHeight: '120px',
                                padding: '15px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '10px',
                                fontSize: '14px',
                                fontFamily: 'inherit',
                                resize: 'vertical',
                                transition: 'border-color 0.2s'
                            }}
                            onFocus={(e) => e.currentTarget.style.borderColor = '#667eea'}
                            onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                        />
                    </div>

                    {/* Actions */}
                    <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                        {!feedback.reviewed && (
                            <button
                                onClick={() => {
                                    onMarkReviewed(feedback.id, true);
                                    onClose();
                                }}
                                style={{
                                    padding: '12px 24px',
                                    background: '#6c757d',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500',
                                    transition: 'background 0.2s'
                                }}
                                onMouseEnter={(e) => e.currentTarget.style.background = '#5a6268'}
                                onMouseLeave={(e) => e.currentTarget.style.background = '#6c757d'}
                            >
                                Mark as Reviewed
                            </button>
                        )}
                        <button
                            onClick={handleSubmit}
                            disabled={submitting || !response.trim()}
                            style={{
                                padding: '12px 24px',
                                background: submitting || !response.trim() 
                                    ? '#ccc' 
                                    : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: submitting || !response.trim() ? 'not-allowed' : 'pointer',
                                fontSize: '14px',
                                fontWeight: '500',
                                transition: 'transform 0.2s'
                            }}
                            onMouseEnter={(e) => {
                                if (!submitting && response.trim()) {
                                    e.currentTarget.style.transform = 'translateY(-2px)';
                                }
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.transform = 'translateY(0)';
                            }}
                        >
                            {submitting ? 'Sending...' : 'Send Response'}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
}

        // FULLY ENHANCED AlertsView with All Features
function AlertsView({ searchQuery, user }) {
    const [alerts, setAlerts] = useState([]);
    const [filteredAlerts, setFilteredAlerts] = useState([]);
    const [loading, setLoading] = useState(true);
    const [currentPage, setCurrentPage] = useState(1);
    const [filterType, setFilterType] = useState('all');
    const [filterPriority, setFilterPriority] = useState('all');
    const [filterResolved, setFilterResolved] = useState('unresolved');
    const [selectedAlert, setSelectedAlert] = useState(null);
    const [stats, setStats] = useState({
        total: 0,
        active: 0,
        avgResponseTime: 0,
        critical: 0
    });
    const [frequencyData, setFrequencyData] = useState([]);
    const frequencyChartRef = useRef(null);
    const chartInstance = useRef(null);
    const itemsPerPage = 20;

    useEffect(() => {
        loadAlerts();
        
        const unsubscribe = db.collection('alerts')
            .where('type', '==', 'sos')
            .where('resolved', '==', false)
            .onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const alert = { id: change.doc.id, ...change.doc.data() };
                        if (alert.createdAt?.toDate() > new Date(Date.now() - 5000)) {
                            showSOSNotification(alert);
                        }
                    }
                });
            });
        
        return () => {
            unsubscribe();
            if (chartInstance.current) {
                chartInstance.current.destroy();
            }
        };
    }, []);

    useEffect(() => {
        filterAlerts();
        calculateStats();
        prepareFrequencyData();
    }, [alerts, filterType, filterPriority, filterResolved, searchQuery]);

    useEffect(() => {
        if (frequencyData.length > 0) {
            renderFrequencyChart();
        }
    }, [frequencyData]);

    const showSOSNotification = async (alert) => {
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification('üö® SOS ALERT', {
                body: `Emergency alert from ${alert.userName}`,
                icon: '/favicon.ico',
                requireInteraction: true
            });
        } else if ('Notification' in window && Notification.permission !== 'denied') {
            Notification.requestPermission();
        }
        
        await db.collection('notifications').add({
            type: 'sos',
            message: `SOS Alert from ${alert.userName}`,
            recipientId: user.uid,
            relatedId: alert.id,
            urgent: true,
            read: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    };

    const loadAlerts = async () => {
        try {
            const alertsSnap = await db.collection('alerts')
                .orderBy('createdAt', 'desc')
                .get();
            
            const alertsData = [];
            const userIds = new Set();
            
            alertsSnap.forEach(doc => {
                const alert = { id: doc.id, ...doc.data() };
                alertsData.push(alert);
                if (alert.userId) userIds.add(alert.userId);
            });
            
            if (userIds.size > 0) {
                const userResults = await batchQuery('users',
                    firebase.firestore.FieldPath.documentId(),
                    Array.from(userIds)
                );
                
                const userMap = {};
                userResults.forEach(user => {
                    userMap[user.id] = user.displayName || user.email;
                });
                
                alertsData.forEach(alert => {
                    alert.userName = userMap[alert.userId] || 'Unknown User';
                });
            }
            
            setAlerts(alertsData);
            setFilteredAlerts(alertsData);
        } catch (error) {
            console.error('Error loading alerts:', error);
            alert('Failed to load alerts');
        } finally {
            setLoading(false);
        }
    };

    const calculateStats = () => {
        const total = alerts.length;
        const active = alerts.filter(a => !a.resolved).length;
        const critical = alerts.filter(a => a.priority === 'critical' && !a.resolved).length;
        
        const resolvedAlerts = alerts.filter(a => a.resolved && a.createdAt && a.resolvedAt);
        let totalMinutes = 0;
        resolvedAlerts.forEach(alert => {
            const created = alert.createdAt.toDate ? alert.createdAt.toDate() : new Date(alert.createdAt);
            const resolved = alert.resolvedAt.toDate ? alert.resolvedAt.toDate() : new Date(alert.resolvedAt);
            const minutes = (resolved - created) / 1000 / 60;
            totalMinutes += minutes;
        });
        
        const avgResponseTime = resolvedAlerts.length > 0 
            ? Math.round(totalMinutes / resolvedAlerts.length) 
            : 0;
        
        setStats({ total, active, avgResponseTime, critical });
    };

    const prepareFrequencyData = () => {
        const last7Days = [];
        const counts = [];
        
        for (let i = 6; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            date.setHours(0, 0, 0, 0);
            
            const nextDay = new Date(date);
            nextDay.setDate(nextDay.getDate() + 1);
            
            const dayAlerts = alerts.filter(alert => {
                const alertDate = alert.createdAt?.toDate ? alert.createdAt.toDate() : new Date(alert.createdAt);
                return alertDate >= date && alertDate < nextDay;
            });
            
            last7Days.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
            counts.push(dayAlerts.length);
        }
        
        setFrequencyData({ labels: last7Days, data: counts });
    };

    const renderFrequencyChart = () => {
        if (chartInstance.current) {
            chartInstance.current.destroy();
        }
        
        const ctx = frequencyChartRef.current?.getContext('2d');
        if (ctx) {
            chartInstance.current = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: frequencyData.labels,
                    datasets: [{
                        label: 'Alerts',
                        data: frequencyData.data,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: '#667eea',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
    };

    const filterAlerts = () => {
        let filtered = alerts;
        
        if (filterType !== 'all') {
            filtered = filtered.filter(alert => alert.type === filterType);
        }
        
        if (filterPriority !== 'all') {
            filtered = filtered.filter(alert => alert.priority === filterPriority);
        }
        
        if (filterResolved === 'resolved') {
            filtered = filtered.filter(alert => alert.resolved);
        } else if (filterResolved === 'unresolved') {
            filtered = filtered.filter(alert => !alert.resolved);
        }
        
        if (searchQuery) {
            const query = searchQuery.toLowerCase();
            filtered = filtered.filter(alert =>
                alert.userName?.toLowerCase().includes(query) ||
                alert.message?.toLowerCase().includes(query) ||
                alert.type?.toLowerCase().includes(query)
            );
        }
        
        setFilteredAlerts(filtered);
        setCurrentPage(1);
    };

    const handleQuickResolve = async (alertId) => {
        try {
            await db.collection('alerts').doc(alertId).update({
                resolved: true,
                resolvedBy: user.uid,
                resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                resolutionNotes: 'Quick resolved'
            });
            
            setAlerts(prev => prev.map(a => 
                a.id === alertId ? { ...a, resolved: true, resolutionNotes: 'Quick resolved' } : a
            ));
        } catch (error) {
            console.error('Error quick resolving:', error);
            alert('Failed to resolve alert');
        }
    };

    const handleResolve = async (alertId, notes = '') => {
        try {
            await db.collection('alerts').doc(alertId).update({
                resolved: true,
                resolvedBy: user.uid,
                resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                resolutionNotes: notes
            });
            
            setAlerts(prev => prev.map(a => 
                a.id === alertId ? { ...a, resolved: true, resolutionNotes: notes } : a
            ));
            
            alert('Alert resolved successfully');
        } catch (error) {
            console.error('Error resolving alert:', error);
            alert('Failed to resolve alert');
        }
    };

    const handleDelete = async (alertId) => {
        if (!confirm('Are you sure you want to delete this alert?')) return;
        
        try {
            await db.collection('alerts').doc(alertId).delete();
            setAlerts(prev => prev.filter(a => a.id !== alertId));
            alert('Alert deleted');
        } catch (error) {
            console.error('Error deleting alert:', error);
            alert('Failed to delete alert');
        }
    };

    const getPriorityColor = (priority) => {
        if (priority === 'critical') return '#f44336';
        if (priority === 'high') return '#FF9800';
        if (priority === 'medium') return '#FFC107';
        return '#4CAF50';
    };

    const paginatedAlerts = useMemo(() => {
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        return filteredAlerts.slice(start, end);
    }, [filteredAlerts, currentPage]);

    const totalPages = Math.ceil(filteredAlerts.length / itemsPerPage);

    const handleExport = (format) => {
        const exportData = filteredAlerts.map(alert => ({
            user: alert.userName,
            type: alert.type,
            priority: alert.priority || 'Normal',
            message: alert.message,
            status: alert.resolved ? 'Resolved' : 'Active',
            createdAt: formatDateTime(alert.createdAt),
            resolvedAt: alert.resolvedAt ? formatDateTime(alert.resolvedAt) : 'N/A',
            resolutionNotes: alert.resolutionNotes || 'N/A'
        }));

        if (format === 'json') {
            exportToJSON(exportData, 'alerts');
        } else if (format === 'csv') {
            exportToCSV(exportData, 'alerts');
        } else if (format === 'pdf') {
            exportToPDF(exportData, 'Alerts Report');
        }
    };

    if (loading) {
        return (
            <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                minHeight: '400px',
                gap: '20px'
            }}>
                <div style={{
                    width: '60px',
                    height: '60px',
                    border: '4px solid #f3f3f3',
                    borderTop: '4px solid #667eea',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite'
                }}></div>
                <p style={{ color: '#666' }}>Loading alerts...</p>
            </div>
        );
    }

    return (
        <div style={{ padding: '20px', animation: 'fadeIn 0.5s' }}>
            {/* Stats Cards */}
            <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(240px, 1fr))',
                gap: '20px',
                marginBottom: '30px'
            }}>
                <div style={{
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(102, 126, 234, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Total Alerts</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.total}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>All time</div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(240, 147, 251, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Active Alerts</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.active}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Need attention</div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(79, 172, 254, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Avg Response Time</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.avgResponseTime}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Minutes</div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(250, 112, 154, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Critical Alerts</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.critical}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Active critical</div>
                </div>
            </div>

            {/* Alert Frequency Chart */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '25px',
                marginBottom: '30px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <h3 style={{ margin: '0 0 20px 0', color: '#333' }}>Alert Frequency - Last 7 Days</h3>
                <div style={{ height: '250px' }}>
                    <canvas ref={frequencyChartRef}></canvas>
                </div>
            </div>

            {/* SOS Alert Banner */}
            {filteredAlerts.filter(a => a.type === 'sos' && !a.resolved).length > 0 && (
                <div style={{
                    background: 'linear-gradient(135deg, #ff4444, #cc0000)',
                    padding: '20px',
                    borderRadius: '15px',
                    marginBottom: '20px',
                    animation: 'pulse 2s infinite',
                    boxShadow: '0 4px 15px rgba(255, 68, 68, 0.4)'
                }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '15px', color: 'white' }}>
                        <span style={{ fontSize: '32px' }}>üö®</span>
                        <div>
                            <div style={{ fontSize: '18px', fontWeight: 'bold', marginBottom: '5px' }}>
                                {filteredAlerts.filter(a => a.type === 'sos' && !a.resolved).length} Active SOS Alert(s)
                            </div>
                            <div style={{ fontSize: '14px', opacity: 0.9 }}>
                                Immediate attention required
                            </div>
                        </div>
                    </div>
                </div>
            )}
            
            {/* Filters and Actions Bar */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                marginBottom: '20px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', flexWrap: 'wrap', gap: '15px' }}>
                    <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                        <select 
                            value={filterType}
                            onChange={(e) => setFilterType(e.target.value)}
                            style={{
                                padding: '8px 12px',
                                borderRadius: '8px',
                                border: '1px solid #ddd',
                                background: 'white',
                                cursor: 'pointer',
                                fontSize: '14px'
                            }}
                        >
                            <option value="all">All Types</option>
                            <option value="sos">SOS Emergency</option>
                            <option value="missed_checkin">Missed Check-in</option>
                            <option value="low_mood">Low Mood</option>
                            <option value="high_craving">High Craving</option>
                            <option value="system">System Alert</option>
                        </select>
                        
                        <select 
                            value={filterPriority}
                            onChange={(e) => setFilterPriority(e.target.value)}
                            style={{
                                padding: '8px 12px',
                                borderRadius: '8px',
                                border: '1px solid #ddd',
                                background: 'white',
                                cursor: 'pointer',
                                fontSize: '14px'
                            }}
                        >
                            <option value="all">All Priorities</option>
                            <option value="critical">Critical</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                        
                        <select 
                            value={filterResolved}
                            onChange={(e) => setFilterResolved(e.target.value)}
                            style={{
                                padding: '8px 12px',
                                borderRadius: '8px',
                                border: '1px solid #ddd',
                                background: 'white',
                                cursor: 'pointer',
                                fontSize: '14px'
                            }}
                        >
                            <option value="all">All Status</option>
                            <option value="unresolved">Active</option>
                            <option value="resolved">Resolved</option>
                        </select>
                    </div>
                    
                    <div style={{ display: 'flex', gap: '10px' }}>
                        <button 
                            onClick={() => handleExport('csv')}
                            style={{
                                padding: '10px 16px',
                                background: '#6c757d',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '500'
                            }}
                        >
                            Export CSV
                        </button>
                    </div>
                </div>
            </div>
            
            {/* Enhanced Table */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                overflow: 'hidden',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                    <thead>
                        <tr style={{ background: '#f8f9fa', borderBottom: '2px solid #e9ecef' }}>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Priority</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>User</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Type</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Message</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Status</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Created</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {paginatedAlerts.map(alert => (
                            <tr key={alert.id} style={{
                                borderBottom: '1px solid #f0f0f0',
                                transition: 'all 0.2s',
                                background: alert.type === 'sos' && !alert.resolved ? 'rgba(244, 67, 54, 0.05)' : 'white',
                                borderLeft: `4px solid ${getPriorityColor(alert.priority || 'low')}`
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.background = '#f8f9fa';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.background = alert.type === 'sos' && !alert.resolved ? 'rgba(244, 67, 54, 0.05)' : 'white';
                            }}
                            >
                                <td style={{ padding: '15px' }}>
                                    <div style={{
                                        width: '12px',
                                        height: '12px',
                                        borderRadius: '50%',
                                        background: getPriorityColor(alert.priority || 'low')
                                    }}></div>
                                </td>
                                <td style={{ padding: '15px', fontWeight: '500', color: '#333' }}>
                                    {alert.userName}
                                </td>
                                <td style={{ padding: '15px' }}>
                                    <span style={{
                                        padding: '4px 12px',
                                        borderRadius: '20px',
                                        fontSize: '12px',
                                        fontWeight: '500',
                                        background: alert.type === 'sos' ? '#ffebee' : '#e3f2fd',
                                        color: alert.type === 'sos' ? '#c62828' : '#1565c0'
                                    }}>
                                        {alert.type === 'sos' ? 'üö® SOS' : alert.type?.replace('_', ' ')}
                                    </span>
                                </td>
                                <td style={{ padding: '15px', color: '#666', maxWidth: '200px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                    {alert.message}
                                </td>
                                <td style={{ padding: '15px' }}>
                                    <span style={{
                                        padding: '4px 12px',
                                        borderRadius: '20px',
                                        fontSize: '12px',
                                        fontWeight: '500',
                                        background: alert.resolved ? '#d4edda' : '#f8d7da',
                                        color: alert.resolved ? '#155724' : '#721c24'
                                    }}>
                                        {alert.resolved ? 'Resolved' : 'Active'}
                                    </span>
                                </td>
                                <td style={{ padding: '15px', color: '#666' }}>{formatTimeAgo(alert.createdAt)}</td>
                                <td style={{ padding: '15px' }}>
                                    <div style={{ display: 'flex', gap: '8px' }}>
                                        <button 
                                            onClick={() => setSelectedAlert(alert)}
                                            style={{
                                                padding: '6px 12px',
                                                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '6px',
                                                cursor: 'pointer',
                                                fontSize: '13px',
                                                fontWeight: '500'
                                            }}
                                        >
                                            View
                                        </button>
                                        {!alert.resolved && (
                                            <button 
                                                onClick={() => handleQuickResolve(alert.id)}
                                                style={{
                                                    padding: '6px 12px',
                                                    background: '#4CAF50',
                                                    color: 'white',
                                                    border: 'none',
                                                    borderRadius: '6px',
                                                    cursor: 'pointer',
                                                    fontSize: '13px',
                                                    fontWeight: '500'
                                                }}
                                            >
                                                Quick Resolve
                                            </button>
                                        )}
                                    </div>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
                
                {filteredAlerts.length === 0 && (
                    <div style={{
                        padding: '60px 20px',
                        textAlign: 'center',
                        color: '#999'
                    }}>
                        <div style={{ fontSize: '48px', marginBottom: '15px' }}>üîî</div>
                        <div style={{ fontSize: '18px', fontWeight: '500', marginBottom: '8px' }}>
                            No alerts found
                        </div>
                        <div style={{ fontSize: '14px' }}>
                            {searchQuery ? 'Try adjusting your search terms' : 'Alerts will appear here when triggered'}
                        </div>
                    </div>
                )}
            </div>
            
            {totalPages > 1 && (
                <div style={{ marginTop: '20px' }}>
                    <Pagination 
                        currentPage={currentPage}
                        totalPages={totalPages}
                        onPageChange={setCurrentPage}
                    />
                </div>
            )}
            
            {selectedAlert && (
                <AlertDetailModal 
                    alert={selectedAlert}
                    onClose={() => setSelectedAlert(null)}
                    onResolve={handleResolve}
                    getPriorityColor={getPriorityColor}
                />
            )}
        </div>
    );
}
      // ==================== COMPLETE REPORTS VIEW - FULL PRODUCTION VERSION ====================

function ReportsView({ user }) {
    // ========== STATE MANAGEMENT ==========
    const [reportMode, setReportMode] = useState('templates');
    const [selectedTemplate, setSelectedTemplate] = useState('overview');
    const [startDate, setStartDate] = useState(() => {
        const date = new Date();
        date.setMonth(date.getMonth() - 1);
        return date.toISOString().split('T')[0];
    });
    const [endDate, setEndDate] = useState(() => new Date().toISOString().split('T')[0]);
    const [reportData, setReportData] = useState(null);
    const [loading, setLoading] = useState(false);
    const [showAnalytics, setShowAnalytics] = useState(false);
    const [analyticsData, setAnalyticsData] = useState(null);
    const [selectedPIRForReport, setSelectedPIRForReport] = useState(null);
    const [allPIRs, setAllPIRs] = useState([]);
    const [allCheckIns, setAllCheckIns] = useState([]);
    
    const [customConfig, setCustomConfig] = useState({
        selectedPIRs: [],
        selectedMetrics: {
            mood: true,
            cravings: true,
            anxiety: true,
            sleep: true,
            gratitude: false,
            challenges: false,
            goals: false
        },
        selectedCharts: {
            moodVsCravings: true,
            anxietyVsSleep: true,
            trends: true,
            distribution: true,
            patternAnalysis: true
        },
        includeTables: true,
        includePatterns: true,
        includeSummary: true
    });

    // ========== CHART REFERENCES ==========
    const chartRefs = {
        moodTrend: useRef(null),
        cravingTrend: useRef(null),
        anxietyTrend: useRef(null),
        sleepTrend: useRef(null),
        moodVsCravings: useRef(null),
        anxietyVsSleep: useRef(null),
        moodDistribution: useRef(null),
        riskDistribution: useRef(null),
        complianceChart: useRef(null),
        engagementChart: useRef(null),
        sobrietyVsCravings: useRef(null),
        goalCompletion: useRef(null)
    };
    const chartInstances = useRef({});

    // ========== REPORT TEMPLATES ==========
    const REPORT_TEMPLATES = {
        overview: {
            name: 'Program Overview',
            icon: 'üìä',
            desc: 'Complete program statistics and trends',
            color: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
        },
        sobriety: {
            name: 'Sobriety Analysis',
            icon: 'üéØ',
            desc: 'Sobriety tracking and risk assessment',
            color: 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)'
        },
        morningCheckins: {
            name: 'Morning Check-ins',
            icon: 'üåÖ',
            desc: 'Morning mood and craving analysis',
            color: 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)'
        },
        eveningReflections: {
            name: 'Evening Reflections',
            icon: 'üåô',
            desc: 'Daily reflections and gratitude',
            color: 'linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%)'
        },
        fullPIR: {
            name: 'Full PIR Report',
            icon: 'üìã',
            desc: 'Comprehensive individual analysis',
            color: 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)'
        },
        moodAnalysis: {
            name: 'Mood Analysis',
            icon: 'üòä',
            desc: 'Detailed mood patterns and trends',
            color: 'linear-gradient(135deg, #00BCD4 0%, #0097A7 100%)'
        },
        crisis: {
            name: 'Crisis & Intervention',
            icon: 'üö®',
            desc: 'SOS alerts and emergency response',
            color: 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)'
        },
        engagement: {
            name: 'Engagement Report',
            icon: 'üìà',
            desc: 'PIR engagement and participation',
            color: 'linear-gradient(135deg, #FF5722 0%, #E64A19 100%)'
        },
        comparative: {
            name: 'Comparative Analysis',
            icon: '‚öñÔ∏è',
            desc: 'Compare PIR vs program averages',
            color: 'linear-gradient(135deg, #795548 0%, #5D4037 100%)'
        },
        milestones: {
            name: 'Milestones & Achievements',
            icon: 'üèÜ',
            desc: 'Goals and milestone tracking',
            color: 'linear-gradient(135deg, #FFC107 0%, #FFA000 100%)'
        },
        communication: {
            name: 'Communication Report',
            icon: 'üí¨',
            desc: 'Message activity and engagement',
            color: 'linear-gradient(135deg, #607D8B 0%, #455A64 100%)'
        },
        predictive: {
            name: 'Predictive Risk',
            icon: '‚ö†Ô∏è',
            desc: 'Risk prediction and early warnings',
            color: 'linear-gradient(135deg, #E91E63 0%, #C2185B 100%)'
        }
    };

    // ========== INITIALIZATION ==========
    useEffect(() => {
        loadPIRsList();
        loadAllCheckIns();
        return () => {
            Object.values(chartInstances.current).forEach(chart => {
                if (chart) chart.destroy();
            });
        };
    }, []);

    useEffect(() => {
        if (reportData && reportData.charts) {
            setTimeout(() => renderCharts(), 150);
        }
    }, [reportData]);

    useEffect(() => {
        if (allCheckIns.length > 0) {
            calculateAnalytics();
        }
    }, [allCheckIns]);

    const loadPIRsList = async () => {
        try {
            const pirsSnap = await db.collection('users')
                .where('role', '==', 'pir')
                .get();
            
            setAllPIRs(pirsSnap.docs.map(doc => ({
                id: doc.id,
                name: doc.data().displayName || doc.data().email
            })));
        } catch (error) {
            console.error('Error loading PIRs:', error);
        }
    };

    const loadAllCheckIns = async () => {
        try {
            const checkInsSnap = await db.collection('checkIns')
                .orderBy('createdAt', 'desc')
                .limit(1000)
                .get();
            
            const checkInsData = [];
            const usersCache = {};
            
            for (const doc of checkInsSnap.docs) {
                const checkIn = { id: doc.id, ...doc.data() };
                
                if (!usersCache[checkIn.userId]) {
                    const userDoc = await db.collection('users').doc(checkIn.userId).get();
                    usersCache[checkIn.userId] = userDoc.data()?.displayName || userDoc.data()?.email || 'Unknown';
                }
                
                checkIn.userName = usersCache[checkIn.userId];
                checkInsData.push(checkIn);
            }
            
            setAllCheckIns(checkInsData);
        } catch (error) {
            console.error('Error loading check-ins:', error);
        }
    };

    // ========== UTILITY FUNCTIONS ==========
    const formatDate = (date) => {
        if (!date) return '-';
        const d = date.toDate ? date.toDate() : new Date(date);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    };

    const formatDateTime = (date) => {
        if (!date) return '-';
        const d = date.toDate ? date.toDate() : new Date(date);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' +
               d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    };

    const formatTimeAgo = (date) => {
        if (!date) return '-';
        const d = date.toDate ? date.toDate() : new Date(date);
        const seconds = Math.floor((new Date() - d) / 1000);
        if (seconds < 60) return 'Just now';
        if (seconds < 3600) return Math.floor(seconds / 60) + ' min ago';
        if (seconds < 86400) return Math.floor(seconds / 3600) + ' hr ago';
        return Math.floor(seconds / 86400) + ' days ago';
    };

    const exportToJSON = (data, filename) => {
        const jsonStr = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${filename}_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
    };

    const exportToCSV = (data, filename) => {
        if (!data || data.length === 0) return;
        
        const headers = Object.keys(data[0]);
        const csvContent = [
            headers.join(','),
            ...data.map(row => headers.map(header => {
                const value = row[header]?.toString() || '';
                return value.includes(',') ? `"${value}"` : value;
            }).join(','))
        ].join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
    };

    // ========== ANALYTICS CALCULATION ==========
    const calculateAnalytics = () => {
        const pirStats = {};
        const allPIRsData = {
            totalCheckIns: allCheckIns.length,
            avgMood: 0,
            avgCraving: 0,
            avgAnxiety: 0,
            avgSleep: 0,
            completionRate: 0,
            last30Days: {
                avgMood: 0,
                avgCraving: 0,
                avgAnxiety: 0,
                avgSleep: 0,
                completionRate: 0
            }
        };

        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

        allCheckIns.forEach(checkIn => {
            if (!pirStats[checkIn.userId]) {
                pirStats[checkIn.userId] = {
                    userName: checkIn.userName,
                    userId: checkIn.userId,
                    totalCheckIns: 0,
                    completeCheckIns: 0,
                    moodSum: 0,
                    moodCount: 0,
                    cravingSum: 0,
                    cravingCount: 0,
                    anxietySum: 0,
                    anxietyCount: 0,
                    sleepSum: 0,
                    sleepCount: 0,
                    last30: {
                        totalCheckIns: 0,
                        completeCheckIns: 0,
                        moodSum: 0,
                        moodCount: 0,
                        cravingSum: 0,
                        cravingCount: 0,
                        anxietySum: 0,
                        anxietyCount: 0,
                        sleepSum: 0,
                        sleepCount: 0
                    }
                };
            }

            const stat = pirStats[checkIn.userId];
            const checkInDate = checkIn.createdAt?.toDate ? checkIn.createdAt.toDate() : new Date(checkIn.createdAt);
            const isLast30 = checkInDate >= thirtyDaysAgo;

            stat.totalCheckIns++;
            const hasMorning = checkIn.morningData && Object.keys(checkIn.morningData).length > 0;
            const hasEvening = checkIn.eveningData && Object.keys(checkIn.eveningData).length > 0;
            if (hasMorning && hasEvening) stat.completeCheckIns++;

            if (checkIn.morningData?.mood != null) {
                stat.moodSum += checkIn.morningData.mood;
                stat.moodCount++;
            }
            if (checkIn.morningData?.craving != null) {
                stat.cravingSum += checkIn.morningData.craving;
                stat.cravingCount++;
            }
            if (checkIn.morningData?.anxietyLevel != null) {
                stat.anxietySum += checkIn.morningData.anxietyLevel;
                stat.anxietyCount++;
            }
            if (checkIn.morningData?.sleepQuality != null) {
                stat.sleepSum += checkIn.morningData.sleepQuality;
                stat.sleepCount++;
            }

            if (isLast30) {
                stat.last30.totalCheckIns++;
                if (hasMorning && hasEvening) stat.last30.completeCheckIns++;
                
                if (checkIn.morningData?.mood != null) {
                    stat.last30.moodSum += checkIn.morningData.mood;
                    stat.last30.moodCount++;
                }
                if (checkIn.morningData?.craving != null) {
                    stat.last30.cravingSum += checkIn.morningData.craving;
                    stat.last30.cravingCount++;
                }
                if (checkIn.morningData?.anxietyLevel != null) {
                    stat.last30.anxietySum += checkIn.morningData.anxietyLevel;
                    stat.last30.anxietyCount++;
                }
                if (checkIn.morningData?.sleepQuality != null) {
                    stat.last30.sleepSum += checkIn.morningData.sleepQuality;
                    stat.last30.sleepCount++;
                }
            }
        });

        Object.values(pirStats).forEach(stat => {
            stat.avgMood = stat.moodCount > 0 ? (stat.moodSum / stat.moodCount).toFixed(1) : 'N/A';
            stat.avgCraving = stat.cravingCount > 0 ? (stat.cravingSum / stat.cravingCount).toFixed(1) : 'N/A';
            stat.avgAnxiety = stat.anxietyCount > 0 ? (stat.anxietySum / stat.anxietyCount).toFixed(1) : 'N/A';
            stat.avgSleep = stat.sleepCount > 0 ? (stat.sleepSum / stat.sleepCount).toFixed(1) : 'N/A';
            stat.completionRate = stat.totalCheckIns > 0 ? Math.round((stat.completeCheckIns / stat.totalCheckIns) * 100) : 0;

            stat.last30.avgMood = stat.last30.moodCount > 0 ? (stat.last30.moodSum / stat.last30.moodCount).toFixed(1) : 'N/A';
            stat.last30.avgCraving = stat.last30.cravingCount > 0 ? (stat.last30.cravingSum / stat.last30.cravingCount).toFixed(1) : 'N/A';
            stat.last30.avgAnxiety = stat.last30.anxietyCount > 0 ? (stat.last30.anxietySum / stat.last30.anxietyCount).toFixed(1) : 'N/A';
            stat.last30.avgSleep = stat.last30.sleepCount > 0 ? (stat.last30.sleepSum / stat.last30.sleepCount).toFixed(1) : 'N/A';
            stat.last30.completionRate = stat.last30.totalCheckIns > 0 ? Math.round((stat.last30.completeCheckIns / stat.last30.totalCheckIns) * 100) : 0;
        });

        // Calculate all-PIRs aggregate
        let totalMood = 0, totalCraving = 0, totalAnxiety = 0, totalSleep = 0;
        let moodCount = 0, cravingCount = 0, anxietyCount = 0, sleepCount = 0;
        let completeCount = 0;
        let last30Mood = 0, last30Craving = 0, last30Anxiety = 0, last30Sleep = 0;
        let last30MoodCount = 0, last30CravingCount = 0, last30AnxietyCount = 0, last30SleepCount = 0;
        let last30Complete = 0, last30Total = 0;

        allCheckIns.forEach(checkIn => {
            const checkInDate = checkIn.createdAt?.toDate ? checkIn.createdAt.toDate() : new Date(checkIn.createdAt);
            const isLast30 = checkInDate >= thirtyDaysAgo;

            const hasMorning = checkIn.morningData && Object.keys(checkIn.morningData).length > 0;
            const hasEvening = checkIn.eveningData && Object.keys(checkIn.eveningData).length > 0;
            if (hasMorning && hasEvening) completeCount++;
            
            if (checkIn.morningData?.mood != null) {
                totalMood += checkIn.morningData.mood;
                moodCount++;
            }
            if (checkIn.morningData?.craving != null) {
                totalCraving += checkIn.morningData.craving;
                cravingCount++;
            }
            if (checkIn.morningData?.anxietyLevel != null) {
                totalAnxiety += checkIn.morningData.anxietyLevel;
                anxietyCount++;
            }
            if (checkIn.morningData?.sleepQuality != null) {
                totalSleep += checkIn.morningData.sleepQuality;
                sleepCount++;
            }

            if (isLast30) {
                last30Total++;
                if (hasMorning && hasEvening) last30Complete++;
                
                if (checkIn.morningData?.mood != null) {
                    last30Mood += checkIn.morningData.mood;
                    last30MoodCount++;
                }
                if (checkIn.morningData?.craving != null) {
                    last30Craving += checkIn.morningData.craving;
                    last30CravingCount++;
                }
                if (checkIn.morningData?.anxietyLevel != null) {
                    last30Anxiety += checkIn.morningData.anxietyLevel;
                    last30AnxietyCount++;
                }
                if (checkIn.morningData?.sleepQuality != null) {
                    last30Sleep += checkIn.morningData.sleepQuality;
                    last30SleepCount++;
                }
            }
        });

        allPIRsData.avgMood = moodCount > 0 ? (totalMood / moodCount).toFixed(1) : 'N/A';
        allPIRsData.avgCraving = cravingCount > 0 ? (totalCraving / cravingCount).toFixed(1) : 'N/A';
        allPIRsData.avgAnxiety = anxietyCount > 0 ? (totalAnxiety / anxietyCount).toFixed(1) : 'N/A';
        allPIRsData.avgSleep = sleepCount > 0 ? (totalSleep / sleepCount).toFixed(1) : 'N/A';
        allPIRsData.completionRate = allCheckIns.length > 0 ? Math.round((completeCount / allCheckIns.length) * 100) : 0;

        allPIRsData.last30Days.avgMood = last30MoodCount > 0 ? (last30Mood / last30MoodCount).toFixed(1) : 'N/A';
        allPIRsData.last30Days.avgCraving = last30CravingCount > 0 ? (last30Craving / last30CravingCount).toFixed(1) : 'N/A';
        allPIRsData.last30Days.avgAnxiety = last30AnxietyCount > 0 ? (last30Anxiety / last30AnxietyCount).toFixed(1) : 'N/A';
        allPIRsData.last30Days.avgSleep = last30SleepCount > 0 ? (last30Sleep / last30SleepCount).toFixed(1) : 'N/A';
        allPIRsData.last30Days.completionRate = last30Total > 0 ? Math.round((last30Complete / last30Total) * 100) : 0;

        setAnalyticsData({ pirStats, allPIRsData });
    };

    // ========== REPORT GENERATOR 1: OVERVIEW ==========
    const generateOverviewReport = async (start, end) => {
        try {
            const [usersSnap, checkInsSnap, assignmentsSnap, alertsSnap, goalsSnap] = await Promise.all([
                db.collection('users').get(),
                db.collection('checkIns')
                    .where('createdAt', '>=', start)
                    .where('createdAt', '<=', end)
                    .get(),
                db.collection('assignments')
                    .where('createdAt', '>=', start)
                    .where('createdAt', '<=', end)
                    .get(),
                db.collection('alerts')
                    .where('createdAt', '>=', start)
                    .where('createdAt', '<=', end)
                    .get(),
                db.collection('goals').get()
            ]);

            const pirs = usersSnap.docs.filter(doc => doc.data().role === 'pir');
            const checkIns = checkInsSnap.docs.map(doc => doc.data());

            const dates = [];
            const moods = [];
            const cravings = [];
            const anxiety = [];
            const sleep = [];
            
            const current = new Date(start);
            while (current <= end) {
                const dayCheckIns = checkIns.filter(c => {
                    const date = c.createdAt?.toDate ? c.createdAt.toDate() : new Date(c.createdAt);
                    return date.toDateString() === current.toDateString();
                });
                
                dates.push(current.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                
                if (dayCheckIns.length > 0) {
                    moods.push((dayCheckIns.reduce((sum, c) => sum + (c.morningData?.mood || 0), 0) / dayCheckIns.length).toFixed(1));
                    cravings.push((dayCheckIns.reduce((sum, c) => sum + (c.morningData?.craving || 0), 0) / dayCheckIns.length).toFixed(1));
                    anxiety.push((dayCheckIns.reduce((sum, c) => sum + (c.morningData?.anxietyLevel || 0), 0) / dayCheckIns.length).toFixed(1));
                    sleep.push((dayCheckIns.reduce((sum, c) => sum + (c.morningData?.sleepQuality || 0), 0) / dayCheckIns.length).toFixed(1));
                } else {
                    moods.push(null);
                    cravings.push(null);
                    anxiety.push(null);
                    sleep.push(null);
                }
                
                current.setDate(current.getDate() + 1);
            }

            const avgMood = checkIns.reduce((sum, c) => sum + (c.morningData?.mood || 0), 0) / checkIns.length || 0;
            const avgCraving = checkIns.reduce((sum, c) => sum + (c.morningData?.craving || 0), 0) / checkIns.length || 0;

            return {
                type: 'overview',
                summary: {
                    totalPIRs: pirs.length,
                    activePIRs: pirs.filter(p => p.data().active !== false).length,
                    totalCheckIns: checkInsSnap.size,
                    avgMood: avgMood.toFixed(1),
                    avgCravings: avgCraving.toFixed(1),
                    totalAssignments: assignmentsSnap.size,
                    completedAssignments: assignmentsSnap.docs.filter(d => d.data().status === 'completed').length,
                    totalAlerts: alertsSnap.size,
                    sosAlerts: alertsSnap.docs.filter(d => d.data().type === 'sos').length,
                    totalGoals: goalsSnap.size,
                    completedGoals: goalsSnap.docs.filter(d => d.data().status === 'completed').length
                },
                charts: {
                    trends: { dates, moods, cravings, anxiety, sleep },
                    distribution: calculateMoodDistribution(checkIns),
                    moodVsCravings: {
                        data: checkIns.map(c => ({
                            x: c.morningData?.mood || 0,
                            y: c.morningData?.craving || 0
                        }))
                    },
                    anxietyVsSleep: {
                        data: checkIns.map(c => ({
                            x: c.morningData?.anxietyLevel || 0,
                            y: c.morningData?.sleepQuality || 0
                        }))
                    }
                },
                patterns: detectPatterns(checkIns)
            };
        } catch (error) {
            console.error('Error generating overview:', error);
            throw error;
        }
    };

    // ========== REPORT GENERATOR 2: SOBRIETY ==========
    const generateSobrietyReport = async (start, end) => {
        const pirsSnap = await db.collection('users')
            .where('role', '==', 'pir')
            .get();

        const sobrietyData = [];
        
        for (const pirDoc of pirsSnap.docs) {
            const pirData = pirDoc.data();
            if (!pirData.sobrietyDate) continue;

            const sobrietyDate = new Date(pirData.sobrietyDate);
            const daysSober = Math.floor((new Date() - sobrietyDate) / (1000 * 60 * 60 * 24));
            
            const checkInsSnap = await db.collection('checkIns')
                .where('userId', '==', pirDoc.id)
                .where('createdAt', '>=', start)
                .where('createdAt', '<=', end)
                .get();

            const checkIns = checkInsSnap.docs.map(doc => doc.data());
            const avgCravings = checkIns.length > 0 
                ? (checkIns.reduce((sum, c) => sum + (c.morningData?.craving || 0), 0) / checkIns.length).toFixed(1)
                : 0;
            const avgMood = checkIns.length > 0
                ? (checkIns.reduce((sum, c) => sum + (c.morningData?.mood || 0), 0) / checkIns.length).toFixed(1)
                : 0;

            const riskScore = calculateRiskScore(avgMood, avgCravings, daysSober);

            sobrietyData.push({
                pirName: pirData.displayName || pirData.email,
                pirId: pirDoc.id,
                daysSober,
                sobrietyDate: pirData.sobrietyDate,
                avgMood,
                avgCravings,
                riskScore,
                riskLevel: riskScore >= 7 ? 'Critical' : riskScore >= 4 ? 'High' : 'Moderate',
                checkInCount: checkIns.length
            });
        }

        return {
            type: 'sobriety',
            sobrietyData: sobrietyData.sort((a, b) => b.daysSober - a.daysSober),
            summary: {
                totalPIRs: sobrietyData.length,
                avgDaysSober: (sobrietyData.reduce((sum, p) => sum + p.daysSober, 0) / sobrietyData.length).toFixed(0),
                criticalRisk: sobrietyData.filter(p => p.riskScore >= 7).length,
                highRisk: sobrietyData.filter(p => p.riskScore >= 4 && p.riskScore < 7).length,
                moderateRisk: sobrietyData.filter(p => p.riskScore < 4).length
            },
            charts: {
                riskDistribution: {
                    labels: ['Moderate Risk', 'High Risk', 'Critical Risk'],
                    data: [
                        sobrietyData.filter(p => p.riskScore < 4).length,
                        sobrietyData.filter(p => p.riskScore >= 4 && p.riskScore < 7).length,
                        sobrietyData.filter(p => p.riskScore >= 7).length
                    ]
                },
                sobrietyVsCravings: {
                    data: sobrietyData.map(p => ({
                        x: p.daysSober,
                        y: parseFloat(p.avgCravings) || 0
                    }))
                }
            }
        };
    };

    // ========== REPORT GENERATOR 3: MORNING CHECK-INS ==========
    const generateMorningCheckinsReport = async (start, end) => {
        const checkInsSnap = await db.collection('checkIns')
            .where('createdAt', '>=', start)
            .where('createdAt', '<=', end)
            .get();

        const morningData = [];
        const checkIns = checkInsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const usersCache = {};
        for (const checkIn of checkIns) {
            if (checkIn.morningData) {
                if (!usersCache[checkIn.userId]) {
                    const userDoc = await db.collection('users').doc(checkIn.userId).get();
                    usersCache[checkIn.userId] = userDoc.data()?.displayName || 'Unknown';
                }
                
                morningData.push({
                    pirName: usersCache[checkIn.userId],
                    date: checkIn.createdAt,
                    mood: checkIn.morningData.mood,
                    craving: checkIn.morningData.craving,
                    anxiety: checkIn.morningData.anxietyLevel,
                    sleep: checkIn.morningData.sleepQuality,
                    notes: checkIn.morningData.notes
                });
            }
        }

        return {
            type: 'morningCheckins',
            morningData,
            summary: {
                totalCheckIns: morningData.length,
                avgMood: (morningData.reduce((sum, c) => sum + (c.mood || 0), 0) / morningData.length).toFixed(1),
                avgCravings: (morningData.reduce((sum, c) => sum + (c.craving || 0), 0) / morningData.length).toFixed(1),
                avgAnxiety: (morningData.reduce((sum, c) => sum + (c.anxiety || 0), 0) / morningData.length).toFixed(1),
                avgSleep: (morningData.reduce((sum, c) => sum + (c.sleep || 0), 0) / morningData.length).toFixed(1),
                withNotes: morningData.filter(m => m.notes && m.notes.length > 0).length
            }
        };
    };

    // ========== REPORT GENERATOR 4: EVENING REFLECTIONS ==========
    const generateEveningReflectionsReport = async (start, end) => {
        const checkInsSnap = await db.collection('checkIns')
            .where('createdAt', '>=', start)
            .where('createdAt', '<=', end)
            .get();

        const eveningData = [];
        const checkIns = checkInsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const usersCache = {};
        for (const checkIn of checkIns) {
            if (checkIn.eveningData) {
                if (!usersCache[checkIn.userId]) {
                    const userDoc = await db.collection('users').doc(checkIn.userId).get();
                    usersCache[checkIn.userId] = userDoc.data()?.displayName || 'Unknown';
                }
                
                eveningData.push({
                    pirName: usersCache[checkIn.userId],
                    date: checkIn.createdAt,
                    overallDay: checkIn.eveningData.overallDay,
                    gratitude: checkIn.eveningData.gratitude,
                    challenges: checkIn.eveningData.challenges,
                    tomorrowGoal: checkIn.eveningData.tomorrowGoal
                });
            }
        }

        return {
            type: 'eveningReflections',
            eveningData,
            summary: {
                totalReflections: eveningData.length,
                avgOverallDay: (eveningData.reduce((sum, c) => sum + (c.overallDay || 0), 0) / eveningData.length).toFixed(1),
                withGratitude: eveningData.filter(e => e.gratitude && e.gratitude.length > 0).length,
                withChallenges: eveningData.filter(e => e.challenges && e.challenges.length > 0).length,
                withGoals: eveningData.filter(e => e.tomorrowGoal && e.tomorrowGoal.length > 0).length
            }
        };
    };

    // ========== REPORT GENERATOR 5: FULL PIR ==========
    const generateFullPIRReport = async (start, end) => {
        const pirId = customConfig.selectedPIRs[0];
        if (!pirId) {
            alert('Please select a PIR for Full PIR Report');
            return {};
        }

        const pirDoc = await db.collection('users').doc(pirId).get();
        const pirData = pirDoc.data();

        const [checkInsSnap, goalsSnap, assignmentsSnap, alertsSnap] = await Promise.all([
            db.collection('checkIns').where('userId', '==', pirId)
                .where('createdAt', '>=', start).where('createdAt', '<=', end).get(),
            db.collection('goals').where('userId', '==', pirId).get(),
            db.collection('assignments').where('userId', '==', pirId)
                .where('createdAt', '>=', start).where('createdAt', '<=', end).get(),
            db.collection('alerts').where('userId', '==', pirId)
                .where('createdAt', '>=', start).where('createdAt', '<=', end).get()
        ]);

        const checkIns = checkInsSnap.docs.map(doc => doc.data());
        const goals = goalsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        const assignments = assignmentsSnap.docs.map(doc => doc.data());
        const alerts = alertsSnap.docs.map(doc => doc.data());

        const sobrietyDays = pirData.sobrietyDate 
            ? Math.floor((new Date() - new Date(pirData.sobrietyDate)) / (1000 * 60 * 60 * 24))
            : 0;

        return {
            type: 'fullPIR',
            pirInfo: {
                name: pirData.displayName || pirData.email,
                email: pirData.email,
                sobrietyDate: pirData.sobrietyDate,
                daysSober: sobrietyDays
            },
            checkIns: {
                total: checkIns.length,
                avgMood: (checkIns.reduce((sum, c) => sum + (c.morningData?.mood || 0), 0) / checkIns.length).toFixed(1),
                avgCravings: (checkIns.reduce((sum, c) => sum + (c.morningData?.craving || 0), 0) / checkIns.length).toFixed(1)
            },
            goals: {
                total: goals.length,
                completed: goals.filter(g => g.status === 'completed').length,
                active: goals.filter(g => g.status === 'active').length
            },
            assignments: {
                total: assignments.length,
                completed: assignments.filter(a => a.status === 'completed').length
            },
            alerts: {
                total: alerts.length,
                sos: alerts.filter(a => a.type === 'sos').length
            },
            charts: {
                goalCompletion: {
                    labels: ['Active', 'Completed'],
                    data: [
                        goals.filter(g => g.status === 'active').length,
                        goals.filter(g => g.status === 'completed').length
                    ]
                }
            }
        };
    };

    // ========== REPORT GENERATOR 6: MOOD ANALYSIS ==========
    const generateMoodAnalysisReport = async (start, end) => {
        const checkInsSnap = await db.collection('checkIns')
            .where('createdAt', '>=', start)
            .where('createdAt', '<=', end)
            .get();

        const checkIns = checkInsSnap.docs.map(doc => doc.data());
        const moodDistribution = Array(10).fill(0);

        checkIns.forEach(checkIn => {
            const mood = checkIn.morningData?.mood;
            if (mood >= 1 && mood <= 10) {
                moodDistribution[mood - 1]++;
            }
        });

        return {
            type: 'moodAnalysis',
            moodDistribution,
            summary: {
                avgMood: (checkIns.reduce((sum, c) => sum + (c.morningData?.mood || 0), 0) / checkIns.length).toFixed(1),
                highMoodDays: checkIns.filter(c => (c.morningData?.mood || 0) >= 7).length,
                lowMoodDays: checkIns.filter(c => (c.morningData?.mood || 0) <= 3).length,
                totalCheckIns: checkIns.length
            },
            charts: {
                distribution: moodDistribution
            }
        };
    };

    // ========== REPORT GENERATOR 7: CRISIS ==========
    const generateCrisisReport = async (start, end) => {
        const alertsSnap = await db.collection('alerts')
            .where('createdAt', '>=', start)
            .where('createdAt', '<=', end)
            .get();

        const alerts = [];
        for (const doc of alertsSnap.docs) {
            const alert = doc.data();
            const userDoc = await db.collection('users').doc(alert.userId).get();
            alerts.push({
                ...alert,
                pirName: userDoc.data()?.displayName || 'Unknown',
                id: doc.id
            });
        }

        const avgResponseTime = calculateAvgResponseTime(alerts.filter(a => a.resolved));

        return {
            type: 'crisis',
            alerts,
            summary: {
                totalAlerts: alerts.length,
                sosCount: alerts.filter(a => a.type === 'sos').length,
                resolved: alerts.filter(a => a.resolved).length,
                unresolved: alerts.filter(a => !a.resolved).length,
                criticalPriority: alerts.filter(a => a.priority === 'critical').length,
                avgResponseTime
            }
        };
    };

    // ========== REPORT GENERATOR 8: ENGAGEMENT ==========
    const generateEngagementReport = async (start, end) => {
        const pirsSnap = await db.collection('users')
            .where('role', '==', 'pir')
            .get();

        const engagementData = [];

        for (const pirDoc of pirsSnap.docs) {
            const pirId = pirDoc.id;
            const pirData = pirDoc.data();

            const [checkInsSnap, assignmentsSnap, messagesSnap] = await Promise.all([
                db.collection('checkIns').where('userId', '==', pirId)
                    .where('createdAt', '>=', start).where('createdAt', '<=', end).get(),
                db.collection('assignments').where('userId', '==', pirId)
                    .where('createdAt', '>=', start).where('createdAt', '<=', end).get(),
                db.collection('messages').where('senderId', '==', pirId)
                    .where('createdAt', '>=', start).where('createdAt', '<=', end).get()
            ]);

            const checkIns = checkInsSnap.docs.map(d => d.data());
            const streak = calculateStreak(checkIns);
            
            const assignments = assignmentsSnap.docs.map(d => d.data());
            const assignmentCompletion = assignments.length > 0 
                ? ((assignments.filter(a => a.status === 'completed').length / assignments.length) * 100).toFixed(0)
                : 0;

            engagementData.push({
                pirName: pirData.displayName || pirData.email,
                checkInCount: checkInsSnap.size,
                checkInStreak: streak,
                assignmentCount: assignmentsSnap.size,
                assignmentCompletion: assignmentCompletion,
                messageCount: messagesSnap.size,
                engagementScore: calculateEngagementScore(
                    checkInsSnap.size, 
                    assignmentCompletion, 
                    messagesSnap.size
                )
            });
        }

        return {
            type: 'engagement',
            engagementData: engagementData.sort((a, b) => b.engagementScore - a.engagementScore),
            summary: {
                avgCheckIns: (engagementData.reduce((sum, p) => sum + p.checkInCount, 0) / engagementData.length).toFixed(1),
                avgCompletion: (engagementData.reduce((sum, p) => sum + parseFloat(p.assignmentCompletion), 0) / engagementData.length).toFixed(0),
                highEngagement: engagementData.filter(p => p.engagementScore >= 75).length,
                lowEngagement: engagementData.filter(p => p.engagementScore < 50).length
            },
            charts: {
                engagementDistribution: {
                    labels: engagementData.map(e => e.pirName),
                    data: engagementData.map(e => e.engagementScore)
                }
            }
        };
    };

    // ========== REPORT GENERATOR 9: COMPARATIVE ==========
    const generateComparativeReport = async (start, end) => {
        const pirId = customConfig.selectedPIRs[0];
        if (!pirId) {
            alert('Please select a PIR for Comparative Report');
            return {};
        }

        const pirDoc = await db.collection('users').doc(pirId).get();
        const pirData = pirDoc.data();

        const [pirCheckIns, allCheckIns] = await Promise.all([
            db.collection('checkIns').where('userId', '==', pirId)
                .where('createdAt', '>=', start).where('createdAt', '<=', end).get(),
            db.collection('checkIns')
                .where('createdAt', '>=', start).where('createdAt', '<=', end).get()
        ]);

        const pirStats = calculateStats(pirCheckIns.docs.map(d => d.data()));
        const programStats = calculateStats(allCheckIns.docs.map(d => d.data()));

        const sobrietyDays = pirData.sobrietyDate 
            ? Math.floor((new Date() - new Date(pirData.sobrietyDate)) / 86400000)
            : 0;

        return {
            type: 'comparative',
            pirInfo: {
                name: pirData.displayName || pirData.email,
                daysSober: sobrietyDays
            },
            comparison: {
                avgMood: { pir: pirStats.avgMood, program: programStats.avgMood },
                avgCravings: { pir: pirStats.avgCravings, program: programStats.avgCravings },
                avgAnxiety: { pir: pirStats.avgAnxiety, program: programStats.avgAnxiety },
                avgSleep: { pir: pirStats.avgSleep, program: programStats.avgSleep }
            }
        };
    };

    // ========== REPORT GENERATOR 10: MILESTONES ==========
    const generateMilestonesReport = async (start, end) => {
        const [goalsSnap, milestonesSnap] = await Promise.all([
            db.collection('goals')
                .where('status', '==', 'completed')
                .get(),
            db.collection('milestones')
                .where('achieved', '==', true)
                .get()
        ]);

        const completedGoals = goalsSnap.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(g => {
                const completedDate = g.completedAt?.toDate ? g.completedAt.toDate() : new Date(g.completedAt);
                return completedDate >= start && completedDate <= end;
            });

        const achievements = [];

        const usersCache = {};
        for (const goal of completedGoals) {
            if (!usersCache[goal.userId]) {
                const userDoc = await db.collection('users').doc(goal.userId).get();
                usersCache[goal.userId] = userDoc.data()?.displayName || 'Unknown';
            }
            
            achievements.push({
                pirName: usersCache[goal.userId],
                type: 'goal',
                title: goal.title,
                completedAt: goal.completedAt,
                category: goal.category || 'general'
            });
        }

        const achievedMilestones = milestonesSnap.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(m => {
                const achievedDate = m.achievedAt?.toDate ? m.achievedAt.toDate() : new Date(m.achievedAt);
                return achievedDate >= start && achievedDate <= end;
            });

        for (const milestone of achievedMilestones) {
            if (!usersCache[milestone.userId]) {
                const userDoc = await db.collection('users').doc(milestone.userId).get();
                usersCache[milestone.userId] = userDoc.data()?.displayName || 'Unknown';
            }
            
            achievements.push({
                pirName: usersCache[milestone.userId],
                type: 'milestone',
                title: milestone.title,
                completedAt: milestone.achievedAt,
                category: milestone.type || 'sobriety'
            });
        }

        const sobrietyMilestones = await getSobrietyMilestones(start, end);

        return {
            type: 'milestones',
            achievements: achievements.sort((a, b) => {
                const dateA = a.completedAt?.toDate ? a.completedAt.toDate() : new Date(a.completedAt);
                const dateB = b.completedAt?.toDate ? b.completedAt.toDate() : new Date(b.completedAt);
                return dateB - dateA;
            }),
            sobrietyMilestones,
            summary: {
                totalAchievements: achievements.length,
                goalsCompleted: completedGoals.length,
                milestonesAchieved: achievedMilestones.length,
                sobrietyMilestones: sobrietyMilestones.length
            }
        };
    };

    // ========== REPORT GENERATOR 11: COMMUNICATION ==========
    const generateCommunicationReport = async (start, end) => {
        const messagesSnap = await db.collection('messages')
            .where('createdAt', '>=', start)
            .where('createdAt', '<=', end)
            .get();

        const pirMessages = {};
        const messages = messagesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        messages.forEach(msg => {
            const userId = msg.senderId;
            if (!pirMessages[userId]) {
                pirMessages[userId] = { sent: 0, received: 0 };
            }
            pirMessages[userId].sent++;

            if (msg.recipientId && msg.recipientId !== userId) {
                if (!pirMessages[msg.recipientId]) {
                    pirMessages[msg.recipientId] = { sent: 0, received: 0 };
                }
                pirMessages[msg.recipientId].received++;
            }
        });

        const pirComms = [];
        const usersCache = {};
        for (const [userId, counts] of Object.entries(pirMessages)) {
            if (!usersCache[userId]) {
                const userDoc = await db.collection('users').doc(userId).get();
                if (userDoc.exists && userDoc.data().role === 'pir') {
                    usersCache[userId] = userDoc.data().displayName || userDoc.data().email;
                    pirComms.push({
                        pirName: usersCache[userId],
                        messagesSent: counts.sent,
                        messagesReceived: counts.received
                    });
                }
            }
        }

        return {
            type: 'communication',
            pirComms: pirComms.sort((a, b) => b.messagesSent - a.messagesSent),
            summary: {
                totalMessages: messagesSnap.size,
                activeCommunicators: pirComms.filter(p => p.messagesSent >= 5).length,
                avgMessagesPerPIR: pirComms.length > 0 
                    ? (pirComms.reduce((sum, p) => sum + p.messagesSent, 0) / pirComms.length).toFixed(1)
                    : 0
            }
        };
    };

    // ========== REPORT GENERATOR 12: PREDICTIVE RISK ==========
    const generatePredictiveReport = async (start, end) => {
        const pirsSnap = await db.collection('users')
            .where('role', '==', 'pir')
            .get();

        const riskData = [];

        for (const pirDoc of pirsSnap.docs) {
            const pirId = pirDoc.id;
            const pirData = pirDoc.data();

            const checkInsSnap = await db.collection('checkIns')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .limit(7)
                .get();

            const recentCheckIns = checkInsSnap.docs.map(d => d.data());
            const patterns = detectPatternsForPIR(recentCheckIns);
            const riskScore = calculatePredictiveRisk(recentCheckIns, patterns, pirData);

            riskData.push({
                pirName: pirData.displayName || pirData.email,
                riskScore,
                riskLevel: riskScore >= 7 ? 'High' : riskScore >= 4 ? 'Moderate' : 'Low',
                patterns,
                recommendations: generateRecommendations(patterns, riskScore)
            });
        }

        return {
            type: 'predictive',
            riskData: riskData.sort((a, b) => b.riskScore - a.riskScore),
            summary: {
                highRisk: riskData.filter(r => r.riskScore >= 7).length,
                moderateRisk: riskData.filter(r => r.riskScore >= 4 && r.riskScore < 7).length,
                lowRisk: riskData.filter(r => r.riskScore < 4).length
            }
        };
    };

    // ========== HELPER FUNCTIONS (CONTINUED) ==========
    const calculateMoodDistribution = (checkIns) => {
        const distribution = Array(10).fill(0);
        checkIns.forEach(c => {
            const mood = c.morningData?.mood;
            if (mood >= 1 && mood <= 10) {
                distribution[mood - 1]++;
            }
        });
        return distribution;
    };

    const calculateRiskScore = (avgMood, avgCravings, daysSober) => {
        let score = 0;
        if (avgMood <= 3) score += 3;
        else if (avgMood <= 5) score += 2;
        if (avgCravings >= 7) score += 4;
        else if (avgCravings >= 4) score += 2;
        if (daysSober < 30) score += 2;
        else if (daysSober < 90) score += 1;
        return Math.min(score, 10);
    };

    const detectPatterns = (checkIns) => {
        const patterns = [];
        const sorted = checkIns.sort((a, b) => {
            const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt);
            const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt);
            return dateB - dateA;
        });

        if (sorted.length >= 3) {
            const recent = sorted.slice(0, 3);
            const moods = recent.map(c => c.morningData?.mood || 0);
            
            if (moods[0] < moods[1] && moods[1] < moods[2]) {
                patterns.push({ type: 'declining-mood', message: 'Declining mood trend detected across program' });
            }

            const cravings = recent.map(c => c.morningData?.craving || 0);
            if (cravings.filter(c => c >= 7).length >= 2) {
                patterns.push({ type: 'high-cravings', message: 'Multiple PIRs reporting high cravings' });
            }
        }

        return patterns;
    };

    const detectPatternsForPIR = (checkIns) => {
        const patterns = [];
        
        if (checkIns.length < 3) return patterns;

        const moods = checkIns.map(c => c.morningData?.mood || 0);
        const cravings = checkIns.map(c => c.morningData?.craving || 0);

        if (moods.length >= 3 && moods[0] < moods[1] && moods[1] < moods[2]) {
            patterns.push('Declining mood trend');
        }

        if (cravings.length >= 3 && cravings[0] > cravings[1] && cravings[1] > cravings[2]) {
            patterns.push('Increasing cravings');
        }

        const anxieties = checkIns.map(c => c.morningData?.anxietyLevel || 0);
        if (anxieties.filter(a => a >= 7).length >= 3) {
            patterns.push('Persistent high anxiety');
        }

        const sleeps = checkIns.map(c => c.morningData?.sleepQuality || 0);
        if (sleeps.filter(s => s <= 3).length >= 3) {
            patterns.push('Poor sleep quality');
        }

        return patterns;
    };

    const calculateAvgResponseTime = (resolvedAlerts) => {
        if (resolvedAlerts.length === 0) return 'N/A';
        
        const times = resolvedAlerts.map(alert => {
            const created = alert.createdAt?.toDate ? alert.createdAt.toDate() : new Date(alert.createdAt);
            const resolved = alert.resolvedAt?.toDate ? alert.resolvedAt.toDate() : new Date(alert.resolvedAt);
            return resolved - created;
        });
        
        const avgTime = times.reduce((sum, t) => sum + t, 0) / times.length;
        const hours = Math.floor(avgTime / (1000 * 60 * 60));
        const minutes = Math.floor((avgTime % (1000 * 60 * 60)) / (1000 * 60));
        
        return `${hours}h ${minutes}m`;
    };

    const calculateStreak = (checkIns) => {
        if (checkIns.length === 0) return 0;
        
        const sortedDates = checkIns
            .map(c => {
                const date = c.createdAt?.toDate ? c.createdAt.toDate() : new Date(c.createdAt);
                return date.toDateString();
            })
            .filter((date, index, arr) => arr.indexOf(date) === index)
            .sort((a, b) => new Date(b) - new Date(a));

        let streak = 1;
        const today = new Date().toDateString();
        
        if (sortedDates[0] !== today && sortedDates[0] !== new Date(Date.now() - 86400000).toDateString()) {
            return 0;
        }

        for (let i = 1; i < sortedDates.length; i++) {
            const prevDate = new Date(sortedDates[i - 1]);
            const currDate = new Date(sortedDates[i]);
            const diffDays = Math.floor((prevDate - currDate) / 86400000);
            
            if (diffDays === 1) {
                streak++;
            } else {
                break;
            }
        }
        
        return streak;
    };

    const calculateEngagementScore = (checkIns, assignmentCompletion, messages) => {
        const checkInScore = Math.min((checkIns / 30) * 40, 40);
        const assignmentScore = (parseFloat(assignmentCompletion) / 100) * 30;
        const messageScore = Math.min((messages / 10) * 30, 30);
        
        return Math.round(checkInScore + assignmentScore + messageScore);
    };

    const calculateStats = (checkIns) => {
        if (checkIns.length === 0) return { avgMood: 0, avgCravings: 0, avgAnxiety: 0, avgSleep: 0 };
        
        return {
            avgMood: (checkIns.reduce((sum, c) => sum + (c.morningData?.mood || 0), 0) / checkIns.length).toFixed(1),
            avgCravings: (checkIns.reduce((sum, c) => sum + (c.morningData?.craving || 0), 0) / checkIns.length).toFixed(1),
            avgAnxiety: (checkIns.reduce((sum, c) => sum + (c.morningData?.anxietyLevel || 0), 0) / checkIns.length).toFixed(1),
            avgSleep: (checkIns.reduce((sum, c) => sum + (c.morningData?.sleepQuality || 0), 0) / checkIns.length).toFixed(1)
        };
    };

    const getSobrietyMilestones = async (start, end) => {
        const pirsSnap = await db.collection('users')
            .where('role', '==', 'pir')
            .get();

        const milestones = [];
        const milestonesDays = [7, 30, 60, 90, 180, 365];

        for (const pirDoc of pirsSnap.docs) {
            const pirData = pirDoc.data();
            if (!pirData.sobrietyDate) continue;

            const sobrietyDate = new Date(pirData.sobrietyDate);
            
            milestonesDays.forEach(days => {
                const milestoneDate = new Date(sobrietyDate);
                milestoneDate.setDate(milestoneDate.getDate() + days);
                
                if (milestoneDate >= start && milestoneDate <= end) {
                    milestones.push({
                        pirName: pirData.displayName || pirData.email,
                        days,
                        achievedAt: milestoneDate,
                        title: `${days} Days Sober`
                    });
                }
            });
        }

        return milestones;
    };

    const calculatePredictiveRisk = (checkIns, patterns, pirData) => {
        let score = 0;

        if (checkIns.length === 0) return 5;

        const avgMood = checkIns.reduce((sum, c) => sum + (c.morningData?.mood || 0), 0) / checkIns.length;
        const avgCravings = checkIns.reduce((sum, c) => sum + (c.morningData?.craving || 0), 0) / checkIns.length;

        if (avgMood <= 4) score += 3;
        if (avgCravings >= 6) score += 3;
        
        score += patterns.length;

        const sobrietyDays = pirData.sobrietyDate 
            ? Math.floor((new Date() - new Date(pirData.sobrietyDate)) / 86400000)
            : 0;
        
        if (sobrietyDays < 30) score += 2;

        return Math.min(score, 10);
    };

    const generateRecommendations = (patterns, riskScore) => {
        const recs = [];

        if (riskScore >= 7) {
            recs.push('Immediate check-in recommended');
            recs.push('Consider increasing session frequency');
        }

        if (patterns.includes('Declining mood trend')) {
            recs.push('Mood intervention activities');
        }

        if (patterns.includes('Increasing cravings')) {
            recs.push('Craving management resources');
            recs.push('Emergency support contacts review');
        }

        if (patterns.includes('Persistent high anxiety')) {
            recs.push('Anxiety coping techniques');
        }

        if (patterns.includes('Poor sleep quality')) {
            recs.push('Sleep hygiene education');
        }

        if (recs.length === 0) {
            recs.push('Continue current support plan');
        }

        return recs;
    };

    // ========== CHART RENDERING ==========
    const renderCharts = () => {
        Object.values(chartInstances.current).forEach(chart => {
            if (chart) chart.destroy();
        });

        const data = reportData;
        const newCharts = {};

        // Mood Trend
        if (data.charts?.trends && chartRefs.moodTrend.current) {
            const ctx = chartRefs.moodTrend.current.getContext('2d');
            newCharts.moodTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.charts.trends.dates,
                    datasets: [{
                        label: 'Average Mood',
                        data: data.charts.trends.moods,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 10,
                            title: { display: true, text: 'Mood Level' }
                        },
                        x: {
                            title: { display: true, text: 'Date' }
                        }
                    }
                }
            });
        }

        // Craving Trend
        if (data.charts?.trends && chartRefs.cravingTrend.current) {
            const ctx = chartRefs.cravingTrend.current.getContext('2d');
            newCharts.cravingTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.charts.trends.dates,
                    datasets: [{
                        label: 'Average Cravings',
                        data: data.charts.trends.cravings,
                        borderColor: '#f44336',
                        backgroundColor: 'rgba(244, 67, 54, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 10,
                            title: { display: true, text: 'Craving Level' }
                        },
                        x: {
                            title: { display: true, text: 'Date' }
                        }
                    }
                }
            });
        }

        // Anxiety Trend
        if (data.charts?.trends && chartRefs.anxietyTrend.current) {
            const ctx = chartRefs.anxietyTrend.current.getContext('2d');
            newCharts.anxietyTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.charts.trends.dates,
                    datasets: [{
                        label: 'Average Anxiety',
                        data: data.charts.trends.anxiety,
                        borderColor: '#FF9800',
                        backgroundColor: 'rgba(255, 152, 0, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 10,
                            title: { display: true, text: 'Anxiety Level' }
                        },
                        x: {
                            title: { display: true, text: 'Date' }
                        }
                    }
                }
            });
        }

        // Sleep Trend
        if (data.charts?.trends && chartRefs.sleepTrend.current) {
            const ctx = chartRefs.sleepTrend.current.getContext('2d');
            newCharts.sleepTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.charts.trends.dates,
                    datasets: [{
                        label: 'Average Sleep Quality',
                        data: data.charts.trends.sleep,
                        borderColor: '#9C27B0',
                        backgroundColor: 'rgba(156, 39, 176, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 10,
                            title: { display: true, text: 'Sleep Quality' }
                        },
                        x: {
                            title: { display: true, text: 'Date' }
                        }
                    }
                }
            });
        }

        // Mood vs Cravings Scatter
        if (data.charts?.moodVsCravings && chartRefs.moodVsCravings.current) {
            const ctx = chartRefs.moodVsCravings.current.getContext('2d');
            newCharts.moodVsCravings = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Mood vs Cravings',
                        data: data.charts.moodVsCravings.data,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: '#667eea',
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        x: { 
                            title: { display: true, text: 'Mood' }, 
                            min: 0, 
                            max: 10 
                        },
                        y: { 
                            title: { display: true, text: 'Cravings' }, 
                            min: 0, 
                            max: 10 
                        }
                    }
                }
            });
        }

        // Anxiety vs Sleep Scatter
        if (data.charts?.anxietyVsSleep && chartRefs.anxietyVsSleep.current) {
            const ctx = chartRefs.anxietyVsSleep.current.getContext('2d');
            newCharts.anxietyVsSleep = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Anxiety vs Sleep Quality',
                        data: data.charts.anxietyVsSleep.data,
                        backgroundColor: 'rgba(156, 39, 176, 0.6)',
                        borderColor: '#9C27B0',
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        x: { 
                            title: { display: true, text: 'Anxiety Level' }, 
                            min: 0, 
                            max: 10 
                        },
                        y: { 
                            title: { display: true, text: 'Sleep Quality' }, 
                            min: 0, 
                            max: 10 
                        }
                    }
                }
            });
        }

        // Mood Distribution Bar Chart
        if (data.charts?.distribution && chartRefs.moodDistribution.current) {
            const ctx = chartRefs.moodDistribution.current.getContext('2d');
            newCharts.moodDistribution = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'],
                    datasets: [{
                        label: 'Mood Distribution',
                        data: data.charts.distribution,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: '#667eea',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            title: { display: true, text: 'Frequency' }
                        },
                        x: {
                            title: { display: true, text: 'Mood Level' }
                        }
                    }
                }
            });
        }

        // Risk Distribution Doughnut
        if (data.charts?.riskDistribution && chartRefs.riskDistribution.current) {
            const ctx = chartRefs.riskDistribution.current.getContext('2d');
            newCharts.riskDistribution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.charts.riskDistribution.labels,
                    datasets: [{
                        data: data.charts.riskDistribution.data,
                        backgroundColor: ['#4CAF50', '#FF9800', '#f44336'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true, 
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 12 }
                            }
                        }
                    }
                }
            });
        }

        // Sobriety vs Cravings Scatter
        if (data.charts?.sobrietyVsCravings && chartRefs.sobrietyVsCravings.current) {
            const ctx = chartRefs.sobrietyVsCravings.current.getContext('2d');
            newCharts.sobrietyVsCravings = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Days Sober vs Cravings',
                        data: data.charts.sobrietyVsCravings.data,
                        backgroundColor: 'rgba(76, 175, 80, 0.6)',
                        borderColor: '#4CAF50',
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        x: { 
                            title: { display: true, text: 'Days Sober' },
                            beginAtZero: true
                        },
                        y: { 
                            title: { display: true, text: 'Average Cravings' }, 
                            min: 0, 
                            max: 10 
                        }
                    }
                }
            });
        }

        // Goal Completion Pie Chart
        if (data.charts?.goalCompletion && chartRefs.goalCompletion.current) {
            const ctx = chartRefs.goalCompletion.current.getContext('2d');
            newCharts.goalCompletion = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.charts.goalCompletion.labels,
                    datasets: [{
                        data: data.charts.goalCompletion.data,
                        backgroundColor: ['#667eea', '#4CAF50'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true, 
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 12 }
                            }
                        }
                    }
                }
            });
        }

        // Engagement Distribution Bar Chart
        if (data.charts?.engagementDistribution && chartRefs.engagementChart.current) {
            const ctx = chartRefs.engagementChart.current.getContext('2d');
            newCharts.engagementChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.charts.engagementDistribution.labels,
                    datasets: [{
                        label: 'Engagement Score',
                        data: data.charts.engagementDistribution.data,
                        backgroundColor: data.charts.engagementDistribution.data.map(score => 
                            score >= 75 ? '#4CAF50' : score >= 50 ? '#FF9800' : '#f44336'
                        ),
                        borderColor: '#fff',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { 
                            beginAtZero: true, 
                            max: 100,
                            title: { display: true, text: 'Engagement Score' }
                        }
                    }
                }
            });
        }

        chartInstances.current = newCharts;
    };

    // ========== PDF EXPORT (CONTINUED) ==========
    const exportReportToPDF = async (data, reportTitle) => {
        await new Promise(resolve => setTimeout(resolve, 500));
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        let yPos = 20;

        // Title
        doc.setFontSize(20);
        doc.setTextColor(102, 126, 234);
        doc.text(reportTitle, 20, yPos);
        yPos += 10;

        // Metadata
        doc.setFontSize(10);
        doc.setTextColor(100, 100, 100);
        doc.text(`Generated: ${new Date().toLocaleString()}`, 20, yPos);
        yPos += 5;
        doc.text(`Date Range: ${startDate} to ${endDate}`, 20, yPos);
        yPos += 15;

        // Summary
        if (data.summary) {
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text('Summary Statistics', 20, yPos);
            yPos += 8;

            doc.setFontSize(10);
            Object.entries(data.summary).forEach(([key, value]) => {
                const label = key.replace(/([A-Z])/g, ' $1').trim();
                doc.text(`${label}: ${value}`, 30, yPos);
                yPos += 6;
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }
            });
            yPos += 10;
        }

        // Patterns
        if (data.patterns && data.patterns.length > 0) {
            if (yPos > 250) {
                doc.addPage();
                yPos = 20;
            }
            
            doc.setFontSize(14);
            doc.text('Detected Patterns', 20, yPos);
            yPos += 8;
            
            doc.setFontSize(10);
            data.patterns.forEach(pattern => {
                doc.text(`‚Ä¢ ${pattern.message}`, 30, yPos);
                yPos += 6;
            });
            yPos += 10;
        }

        // Charts
        for (const [chartName, chartInstance] of Object.entries(chartInstances.current)) {
            if (chartInstance) {
                if (yPos > 200) {
                    doc.addPage();
                    yPos = 20;
                }

                doc.setFontSize(12);
                const chartTitle = chartName.replace(/([A-Z])/g, ' $1').trim();
                doc.text(chartTitle.charAt(0).toUpperCase() + chartTitle.slice(1), 20, yPos);
                yPos += 5;

                try {
                    const chartImage = chartInstance.toBase64Image();
                    doc.addImage(chartImage, 'PNG', 20, yPos, 170, 80);
                    yPos += 90;
                } catch (error) {
                    console.error('Error adding chart:', error);
                }
            }
        }

        // Data Tables based on report type
        if (data.sobrietyData) {
            if (yPos > 200) {
                doc.addPage();
                yPos = 20;
            }

            doc.autoTable({
                startY: yPos,
                head: [['PIR', 'Days Sober', 'Avg Mood', 'Avg Cravings', 'Risk Level']],
                body: data.sobrietyData.map(p => [
                    p.pirName,
                    p.daysSober,
                    p.avgMood,
                    p.avgCravings,
                    p.riskLevel
                ]),
                theme: 'striped',
                headStyles: { fillColor: [102, 126, 234] }
            });
        }

        if (data.morningData) {
            doc.addPage();
            yPos = 20;

            doc.autoTable({
                startY: yPos,
                head: [['PIR', 'Date', 'Mood', 'Craving', 'Anxiety', 'Sleep']],
                body: data.morningData.slice(0, 20).map(m => [
                    m.pirName,
                    formatDate(m.date),
                    m.mood,
                    m.craving,
                    m.anxiety,
                    m.sleep
                ]),
                theme: 'striped',
                headStyles: { fillColor: [102, 126, 234] }
            });
        }

        if (data.eveningData) {
            doc.addPage();
            yPos = 20;

            doc.autoTable({
                startY: yPos,
                head: [['PIR', 'Date', 'Overall Day', 'Gratitude', 'Challenges']],
                body: data.eveningData.slice(0, 20).map(e => [
                    e.pirName,
                    formatDate(e.date),
                    e.overallDay + '/10',
                    (e.gratitude || '').substring(0, 30) + '...',
                    (e.challenges || '').substring(0, 30) + '...'
                ]),
                theme: 'striped',
                headStyles: { fillColor: [102, 126, 234] }
            });
        }

        if (data.engagementData) {
            doc.addPage();
            yPos = 20;

            doc.autoTable({
                startY: yPos,
                head: [['PIR', 'Check-ins', 'Streak', 'Messages', 'Score']],
                body: data.engagementData.slice(0, 20).map(e => [
                    e.pirName,
                    e.checkInCount,
                    e.checkInStreak + ' days',
                    e.messageCount,
                    e.engagementScore
                ]),
                theme: 'striped',
                headStyles: { fillColor: [102, 126, 234] }
            });
        }

        if (data.riskData) {
            doc.addPage();
            yPos = 20;

            doc.autoTable({
                startY: yPos,
                head: [['PIR', 'Risk Score', 'Level', 'Patterns']],
                body: data.riskData.slice(0, 20).map(r => [
                    r.pirName,
                    r.riskScore + '/10',
                    r.riskLevel,
                    r.patterns.join(', ').substring(0, 40) + '...'
                ]),
                theme: 'striped',
                headStyles: { fillColor: [102, 126, 234] }
            });
        }

        if (data.alerts) {
            doc.addPage();
            yPos = 20;

            doc.autoTable({
                startY: yPos,
                head: [['PIR', 'Type', 'Priority', 'Status', 'Created']],
                body: data.alerts.slice(0, 20).map(a => [
                    a.pirName,
                    a.type,
                    a.priority || 'normal',
                    a.resolved ? 'Resolved' : 'Active',
                    formatTimeAgo(a.createdAt)
                ]),
                theme: 'striped',
                headStyles: { fillColor: [102, 126, 234] }
            });
        }

        doc.save(`${reportTitle.replace(/\s+/g, '_')}_${startDate}_to_${endDate}.pdf`);
    };

    // ========== MAIN GENERATE ==========
    const generateReport = async () => {
        if (!startDate || !endDate) {
            alert('Please select date range');
            return;
        }

        setLoading(true);
        try {
            const start = new Date(startDate);
            start.setHours(0, 0, 0, 0);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999);

            let data = {};

            if (reportMode === 'templates') {
                switch (selectedTemplate) {
                    case 'overview':
                        data = await generateOverviewReport(start, end);
                        break;
                    case 'sobriety':
                        data = await generateSobrietyReport(start, end);
                        break;
                    case 'morningCheckins':
                        data = await generateMorningCheckinsReport(start, end);
                        break;
                    case 'eveningReflections':
                        data = await generateEveningReflectionsReport(start, end);
                        break;
                    case 'fullPIR':
                        data = await generateFullPIRReport(start, end);
                        break;
                    case 'moodAnalysis':
                        data = await generateMoodAnalysisReport(start, end);
                        break;
                    case 'crisis':
                        data = await generateCrisisReport(start, end);
                        break;
                    case 'engagement':
                        data = await generateEngagementReport(start, end);
                        break;
                    case 'comparative':
                        data = await generateComparativeReport(start, end);
                        break;
                    case 'milestones':
                        data = await generateMilestonesReport(start, end);
                        break;
                    case 'communication':
                        data = await generateCommunicationReport(start, end);
                        break;
                    case 'predictive':
                        data = await generatePredictiveReport(start, end);
                        break;
                    default:
                        data = await generateOverviewReport(start, end);
                }
            }

            setReportData(data);
        } catch (error) {
            console.error('Error generating report:', error);
            alert('Failed to generate report: ' + error.message);
        } finally {
            setLoading(false);
        }
    };

    // ========== ANALYTICS VIEW COMPONENT ==========
    function AnalyticsView({ analyticsData, onClose, onSelectPIR }) {
        const [selectedTab, setSelectedTab] = useState('aggregate');
        const [sortBy, setSortBy] = useState('name');

        if (!analyticsData) return null;

        const { pirStats, allPIRsData } = analyticsData;

        const sortedPIRs = Object.values(pirStats).sort((a, b) => {
            if (sortBy === 'name') return a.userName.localeCompare(b.userName);
            if (sortBy === 'avgMood') return parseFloat(b.avgMood) - parseFloat(a.avgMood);
            if (sortBy === 'avgCraving') return parseFloat(a.avgCraving) - parseFloat(b.avgCraving);
            if (sortBy === 'completion') return b.completionRate - a.completionRate;
            return 0;
        });

        const exportAggregateAnalytics = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');
            
            let yPos = 20;
            
            doc.setFontSize(20);
            doc.text('Analytics Report - All PIRs', 14, yPos);
            yPos += 15;
            
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 14, yPos);
            yPos += 15;

            doc.setFontSize(16);
            doc.text('Overall Program Statistics', 14, yPos);
            yPos += 10;

            const aggregateStats = [
                ['Metric', 'Lifetime Average', 'Last 30 Days'],
                ['Average Mood', allPIRsData.avgMood, allPIRsData.last30Days.avgMood],
                ['Average Cravings', allPIRsData.avgCraving, allPIRsData.last30Days.avgCraving],
                ['Average Anxiety', allPIRsData.avgAnxiety, allPIRsData.last30Days.avgAnxiety],
                ['Average Sleep Quality', allPIRsData.avgSleep, allPIRsData.last30Days.avgSleep],
                ['Completion Rate', `${allPIRsData.completionRate}%`, `${allPIRsData.last30Days.completionRate}%`],
                ['Total Check-ins', allPIRsData.totalCheckIns, '-']
            ];

            doc.autoTable({
                startY: yPos,
                head: [aggregateStats[0]],
                body: aggregateStats.slice(1),
                theme: 'grid',
                headStyles: { fillColor: [102, 126, 234] }
            });

            doc.addPage();
            yPos = 20;
            
            doc.setFontSize(16);
            doc.text('Individual PIR Statistics - Lifetime', 14, yPos);
            yPos += 10;

            const pirLifetimeData = sortedPIRs.map(pir => [
                pir.userName,
                pir.totalCheckIns,
                pir.avgMood,
                pir.avgCraving,
                pir.avgAnxiety,
                pir.avgSleep,
                `${pir.completionRate}%`
            ]);

            doc.autoTable({
                startY: yPos,
                head: [['PIR', 'Check-ins', 'Avg Mood', 'Avg Craving', 'Avg Anxiety', 'Avg Sleep', 'Completion']],
                body: pirLifetimeData,
                theme: 'grid',
                headStyles: { fillColor: [102, 126, 234] },
                styles: { fontSize: 9 }
            });

            doc.save(`Analytics_Report_${new Date().toISOString().split('T')[0]}.pdf`);
        };

        return (
            <div style={{ padding: '20px', animation: 'fadeIn 0.5s' }}>
                <div style={{ 
                    display: 'flex', 
                    justifyContent: 'space-between', 
                    alignItems: 'center',
                    marginBottom: '30px'
                }}>
                    <div>
                        <h2 style={{ margin: '0 0 10px 0', fontSize: '28px', color: '#333' }}>
                            Analytics & Reports
                        </h2>
                        <p style={{ margin: 0, color: '#666' }}>
                            Comprehensive check-in statistics and trends
                        </p>
                    </div>
                    <div style={{ display: 'flex', gap: '10px' }}>
                        <button
                            onClick={exportAggregateAnalytics}
                            style={{
                                padding: '12px 24px',
                                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '10px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '600'
                            }}
                        >
                            Export Analytics PDF
                        </button>
                        <button
                            onClick={onClose}
                            style={{
                                padding: '12px 24px',
                                background: '#6c757d',
                                color: 'white',
                                border: 'none',
                                borderRadius: '10px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '600'
                            }}
                        >
                            Back to Reports
                        </button>
                    </div>
                </div>

                <div style={{
                    display: 'flex',
                    gap: '10px',
                    marginBottom: '30px',
                    borderBottom: '2px solid #f0f0f0'
                }}>
                    {[
                        { id: 'aggregate', label: 'All PIRs Aggregate' },
                        { id: 'individual', label: 'Individual PIR Stats' }
                    ].map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setSelectedTab(tab.id)}
                            style={{
                                padding: '12px 24px',
                                background: selectedTab === tab.id ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'transparent',
                                color: selectedTab === tab.id ? 'white' : '#666',
                                border: 'none',
                                borderBottom: selectedTab === tab.id ? 'none' : '2px solid transparent',
                                cursor: 'pointer',
                                fontSize: '15px',
                                fontWeight: '600',
                                borderRadius: selectedTab === tab.id ? '10px 10px 0 0' : '0',
                                transition: 'all 0.2s'
                            }}
                        >
                            {tab.label}
                        </button>
                    ))}
                </div>

                {selectedTab === 'aggregate' && (
                    <div>
                        <div style={{
                            background: 'white',
                            borderRadius: '15px',
                            padding: '30px',
                            marginBottom: '30px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                        }}>
                            <h3 style={{ margin: '0 0 20px 0', fontSize: '20px', color: '#333' }}>
                                Overall Program Statistics
                            </h3>
                            
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '20px' }}>
                                <div style={{
                                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                    padding: '20px',
                                    borderRadius: '12px',
                                    color: 'white'
                                }}>
                                    <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '8px' }}>Total Check-ins</div>
                                    <div style={{ fontSize: '32px', fontWeight: 'bold' }}>{allPIRsData.totalCheckIns}</div>
                                </div>

                                <div style={{
                                    background: 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)',
                                    padding: '20px',
                                    borderRadius: '12px',
                                    color: 'white'
                                }}>
                                    <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '8px' }}>Completion Rate</div>
                                    <div style={{ fontSize: '32px', fontWeight: 'bold' }}>{allPIRsData.completionRate}%</div>
                                    <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '4px' }}>
                                        30-day: {allPIRsData.last30Days.completionRate}%
                                    </div>
                                </div>

                                <div style={{
                                    background: 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)',
                                    padding: '20px',
                                    borderRadius: '12px',
                                    color: 'white'
                                }}>
                                    <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '8px' }}>Average Mood</div>
                                    <div style={{ fontSize: '32px', fontWeight: 'bold' }}>{allPIRsData.avgMood}/10</div>
                                    <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '4px' }}>
                                        30-day: {allPIRsData.last30Days.avgMood}/10
                                    </div>
                                </div>

                                <div style={{
                                    background: 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)',
                                    padding: '20px',
                                    borderRadius: '12px',
                                    color: 'white'
                                }}>
                                    <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '8px' }}>Average Cravings</div>
                                    <div style={{ fontSize: '32px', fontWeight: 'bold' }}>{allPIRsData.avgCraving}/10</div>
                                    <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '4px' }}>
                                        30-day: {allPIRsData.last30Days.avgCraving}/10
                                    </div>
                                </div>

                                <div style={{
                                    background: 'linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%)',
                                    padding: '20px',
                                    borderRadius: '12px',
                                    color: 'white'
                                }}>
                                    <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '8px' }}>Average Anxiety</div>
                                    <div style={{ fontSize: '32px', fontWeight: 'bold' }}>{allPIRsData.avgAnxiety}/10</div>
                                    <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '4px' }}>
                                        30-day: {allPIRsData.last30Days.avgAnxiety}/10
                                    </div>
                                </div>

                                <div style={{
                                    background: 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)',
                                    padding: '20px',
                                    borderRadius: '12px',
                                    color: 'white'
                                }}>
                                    <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '8px' }}>Average Sleep Quality</div>
                                    <div style={{ fontSize: '32px', fontWeight: 'bold' }}>{allPIRsData.avgSleep}/10</div>
                                    <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '4px' }}>
                                        30-day: {allPIRsData.last30Days.avgSleep}/10
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style={{
                            background: 'white',
                            borderRadius: '15px',
                            padding: '30px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                        }}>
                            <h3 style={{ margin: '0 0 20px 0', fontSize: '20px', color: '#333' }}>
                                30-Day Trend vs Lifetime Average
                            </h3>
                            
                            <div style={{ display: 'grid', gap: '20px' }}>
                                {[
                                    { label: 'Mood', lifetime: allPIRsData.avgMood, recent: allPIRsData.last30Days.avgMood, color: '#667eea' },
                                    { label: 'Cravings', lifetime: allPIRsData.avgCraving, recent: allPIRsData.last30Days.avgCraving, color: '#f44336', inverse: true },
                                    { label: 'Anxiety', lifetime: allPIRsData.avgAnxiety, recent: allPIRsData.last30Days.avgAnxiety, color: '#FF9800', inverse: true },
                                    { label: 'Sleep Quality', lifetime: allPIRsData.avgSleep, recent: allPIRsData.last30Days.avgSleep, color: '#2196F3' },
                                    { label: 'Completion Rate', lifetime: `${allPIRsData.completionRate}`, recent: `${allPIRsData.last30Days.completionRate}`, color: '#4CAF50', isPercent: true }
                                ].map(metric => {
                                    const lifetimeVal = parseFloat(metric.lifetime);
                                    const recentVal = parseFloat(metric.recent);
                                    const diff = recentVal - lifetimeVal;
                                    const isImproving = metric.inverse ? diff < 0 : diff > 0;
                                    
                                    return (
                                        <div key={metric.label} style={{
                                            padding: '20px',
                                            background: '#f8f9fa',
                                            borderRadius: '10px'
                                        }}>
                                            <div style={{ 
                                                display: 'flex', 
                                                justifyContent: 'space-between', 
                                                alignItems: 'center',
                                                marginBottom: '15px'
                                            }}>
                                                <div style={{ fontSize: '16px', fontWeight: '600', color: '#333' }}>
                                                    {metric.label}
                                                </div>
                                                <div style={{
                                                    padding: '4px 12px',
                                                    background: isImproving ? '#d4edda' : '#f8d7da',
                                                    color: isImproving ? '#155724' : '#721c24',
                                                    borderRadius: '20px',
                                                    fontSize: '13px',
                                                    fontWeight: '600'
                                                }}>
                                                    {diff > 0 ? '+' : ''}{diff.toFixed(1)}{metric.isPercent ? '%' : ''} {isImproving ? '‚Üë' : '‚Üì'}
                                                </div>
                                            </div>
                                            <div style={{ display: 'flex', gap: '20px', alignItems: 'center' }}>
                                                <div style={{ flex: 1 }}>
                                                    <div style={{ fontSize: '12px', color: '#666', marginBottom: '5px' }}>
                                                        Lifetime: {metric.lifetime}{metric.isPercent ? '%' : '/10'}
                                                    </div>
                                                    <div style={{
                                                        height: '10px',
                                                        background: '#e0e0e0',
                                                        borderRadius: '5px',
                                                        overflow: 'hidden'
                                                    }}>
                                                        <div style={{
                                                            height: '100%',
                                                            width: `${metric.isPercent ? lifetimeVal : lifetimeVal * 10}%`,
                                                            background: metric.color,
                                                            opacity: 0.6
                                                        }}></div>
                                                    </div>
                                                </div>
                                                <div style={{ flex: 1 }}>
                                                    <div style={{ fontSize: '12px', color: '#666', marginBottom: '5px' }}>
                                                        Last 30 Days: {metric.recent}{metric.isPercent ? '%' : '/10'}
                                                    </div>
                                                    <div style={{
                                                        height: '10px',
                                                        background: '#e0e0e0',
                                                        borderRadius: '5px',
                                                        overflow: 'hidden'
                                                    }}>
                                                        <div style={{
                                                            height: '100%',
                                                            width: `${metric.isPercent ? recentVal : recentVal * 10}%`,
                                                            background: metric.color
                                                        }}></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                )}

                {selectedTab === 'individual' && (
                    <div style={{
                        background: 'white',
                        borderRadius: '15px',
                        padding: '30px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                    }}>
                        <div style={{ 
                            display: 'flex', 
                            justifyContent: 'space-between', 
                            alignItems: 'center',
                            marginBottom: '20px'
                        }}>
                            <h3 style={{ margin: 0, fontSize: '20px', color: '#333' }}>
                                Individual PIR Statistics
                            </h3>
                            <div>
                                <label style={{ marginRight: '10px', color: '#666', fontSize: '14px' }}>Sort by:</label>
                                <select
                                    value={sortBy}
                                    onChange={(e) => setSortBy(e.target.value)}
                                    style={{
                                        padding: '8px 12px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '8px',
                                        fontSize: '14px',
                                        background: 'white'
                                    }}
                                >
                                    <option value="name">PIR Name</option>
                                    <option value="avgMood">Avg Mood</option>
                                    <option value="avgCraving">Avg Cravings</option>
                                    <option value="completion">Completion Rate</option>
                                </select>
                            </div>
                        </div>

                        <div style={{ overflowX: 'auto' }}>
                            <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                <thead style={{ background: '#f8f9fa' }}>
                                    <tr>
                                        <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#333', fontSize: '14px' }}>PIR</th>
                                        <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Check-ins<br/>(Total / 30d)</th>
                                        <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Avg Mood<br/>(Life / 30d)</th>
                                        <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Avg Craving<br/>(Life / 30d)</th>
                                        <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Avg Anxiety<br/>(Life / 30d)</th>
                                        <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Avg Sleep<br/>(Life / 30d)</th>
                                        <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Completion<br/>(Life / 30d)</th>
                                        <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {sortedPIRs.map(pir => (
                                        <tr key={pir.userId} style={{ borderBottom: '1px solid #f0f0f0' }}>
                                            <td style={{ padding: '15px', fontWeight: '500', color: '#333' }}>
                                                {pir.userName}
                                            </td>
                                            <td style={{ padding: '15px', textAlign: 'center', color: '#666' }}>
                                                {pir.totalCheckIns} / {pir.last30.totalCheckIns}
                                            </td>
                                            <td style={{ padding: '15px', textAlign: 'center' }}>
                                                <div style={{ fontSize: '15px', fontWeight: '600', color: '#667eea' }}>
                                                    {pir.avgMood}
                                                </div>
                                                <div style={{ fontSize: '12px', color: '#999', marginTop: '2px' }}>
                                                    {pir.last30.avgMood}
                                                </div>
                                            </td>
                                            <td style={{ padding: '15px', textAlign: 'center' }}>
                                                <div style={{ fontSize: '15px', fontWeight: '600', color: '#f44336' }}>
                                                    {pir.avgCraving}
                                                </div>
                                                <div style={{ fontSize: '12px', color: '#999', marginTop: '2px' }}>
                                                    {pir.last30.avgCraving}
                                                </div>
                                            </td>
                                            <td style={{ padding: '15px', textAlign: 'center' }}>
                                                <div style={{ fontSize: '15px', fontWeight: '600', color: '#FF9800' }}>
                                                    {pir.avgAnxiety}
                                                </div>
                                                <div style={{ fontSize: '12px', color: '#999', marginTop: '2px' }}>
                                                    {pir.last30.avgAnxiety}
                                                </div>
                                            </td>
                                            <td style={{ padding: '15px', textAlign: 'center' }}>
                                                <div style={{ fontSize: '15px', fontWeight: '600', color: '#2196F3' }}>
                                                    {pir.avgSleep}
                                                </div>
                                                <div style={{ fontSize: '12px', color: '#999', marginTop: '2px' }}>
                                                    {pir.last30.avgSleep}
                                                </div>
                                            </td>
                                            <td style={{ padding: '15px', textAlign: 'center' }}>
                                                <div style={{ fontSize: '15px', fontWeight: '600', color: '#4CAF50' }}>
                                                    {pir.completionRate}%
                                                </div>
                                                <div style={{ fontSize: '12px', color: '#999', marginTop: '2px' }}>
                                                    {pir.last30.completionRate}%
                                                </div>
                                            </td>
                                            <td style={{ padding: '15px', textAlign: 'center' }}>
                                                <button
                                                    onClick={() => onSelectPIR(pir.userId)}
                                                    style={{
                                                        padding: '6px 16px',
                                                        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                                        color: 'white',
                                                        border: 'none',
                                                        borderRadius: '6px',
                                                        cursor: 'pointer',
                                                        fontSize: '13px',
                                                        fontWeight: '500'
                                                    }}
                                                >
                                                    View Report
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    // ========== INDIVIDUAL PIR REPORT COMPONENT ==========
    function IndividualPIRReport({ pirId, onClose }) {
        const [pirData, setPIRData] = useState(null);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
            loadPIRData();
        }, [pirId]);

        const loadPIRData = async () => {
            try {
                const pirDoc = await db.collection('users').doc(pirId).get();
                const data = { id: pirDoc.id, ...pirDoc.data() };
                
                const checkInsSnap = await db.collection('checkIns')
                    .where('userId', '==', pirId)
                    .orderBy('createdAt', 'desc')
                    .limit(100)
                    .get();
                
                data.checkIns = checkInsSnap.docs.map(d => d.data());
                
                setPIRData(data);
                setLoading(false);
            } catch (error) {
                console.error('Error loading PIR data:', error);
                setLoading(false);
            }
        };

        if (loading) {
            return (
                <div style={{ padding: '20px', textAlign: 'center' }}>
                    <div style={{ fontSize: '18px', color: '#666' }}>Loading PIR report...</div>
                </div>
            );
        }

        if (!pirData) {
            return (
                <div style={{ padding: '20px', textAlign: 'center' }}>
                    <div style={{ fontSize: '18px', color: '#666' }}>PIR not found</div>
                </div>
            );
        }

        const avgMood = pirData.checkIns.reduce((sum, c) => sum + (c.morningData?.mood || 0), 0) / pirData.checkIns.length;
        const avgCravings = pirData.checkIns.reduce((sum, c) => sum + (c.morningData?.craving || 0), 0) / pirData.checkIns.length;
        const sobrietyDays = pirData.sobrietyDate 
            ? Math.floor((new Date() - new Date(pirData.sobrietyDate)) / 86400000)
            : 0;

        return (
            <div style={{ padding: '20px', animation: 'fadeIn 0.5s' }}>
                <div style={{ 
                    display: 'flex', 
                    justifyContent: 'space-between', 
                    alignItems: 'center',
                    marginBottom: '30px'
                }}>
                    <div>
                        <h2 style={{ margin: '0 0 10px 0', fontSize: '28px', color: '#333' }}>
                            {pirData.displayName || pirData.email} - Individual Report
                        </h2>
                        <p style={{ margin: 0, color: '#666' }}>
                            Detailed analysis and trends
                        </p>
                    </div>
                    <button
                        onClick={onClose}
                        style={{
                            padding: '12px 24px',
                            background: '#6c757d',
                            color: 'white',
                            border: 'none',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '600'
                        }}
                    >
                        Back to Analytics
                    </button>
                </div>

                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '20px', marginBottom: '30px' }}>
                    <div style={{
                        background: 'white',
                        padding: '20px',
                        borderRadius: '12px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                        borderLeft: '4px solid #667eea'
                    }}>
                        <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px' }}>Total Check-ins</div>
                        <div style={{ fontSize: '28px', fontWeight: 'bold', color: '#333' }}>{pirData.checkIns.length}</div>
                    </div>

                    <div style={{
                        background: 'white',
                        padding: '20px',
                        borderRadius: '12px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                        borderLeft: '4px solid #4CAF50'
                    }}>
                        <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px' }}>Days Sober</div>
                        <div style={{ fontSize: '28px', fontWeight: 'bold', color: '#4CAF50' }}>{sobrietyDays}</div>
                    </div>

                    <div style={{
                        background: 'white',
                        padding: '20px',
                        borderRadius: '12px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                        borderLeft: '4px solid #667eea'
                    }}>
                        <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px' }}>Avg Mood</div>
                        <div style={{ fontSize: '28px', fontWeight: 'bold', color: '#667eea' }}>{avgMood.toFixed(1)}/10</div>
                    </div>

                    <div style={{
                        background: 'white',
                        padding: '20px',
                        borderRadius: '12px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                        borderLeft: '4px solid #f44336'
                    }}>
                        <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px' }}>Avg Cravings</div>
                        <div style={{ fontSize: '28px', fontWeight: 'bold', color: '#f44336' }}>{avgCravings.toFixed(1)}/10</div>
                    </div>
                </div>

                <div style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '25px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                }}>
                    <h3 style={{ margin: '0 0 20px 0', fontSize: '20px', color: '#333' }}>
                        Recent Check-ins (Last 10)
                    </h3>
                    <div style={{ overflowX: 'auto' }}>
                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead style={{ background: '#f8f9fa' }}>
                                <tr>
                                    <th style={{ padding: '12px', textAlign: 'left', fontWeight: '600', color: '#333', fontSize: '13px' }}>Date</th>
                                    <th style={{ padding: '12px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '13px' }}>Mood</th>
                                    <th style={{ padding: '12px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '13px' }}>Craving</th>
                                    <th style={{ padding: '12px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '13px' }}>Anxiety</th>
                                    <th style={{ padding: '12px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '13px' }}>Sleep</th>
                                    <th style={{ padding: '12px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '13px' }}>Overall</th>
                                </tr>
                            </thead>
                            <tbody>
                                {pirData.checkIns.slice(0, 10).map((checkIn, idx) => (
                                    <tr key={idx} style={{ borderBottom: '1px solid #f0f0f0' }}>
                                        <td style={{ padding: '12px', fontSize: '13px', color: '#666' }}>
                                            {formatDate(checkIn.createdAt)}
                                        </td>
                                        <td style={{ padding: '12px', textAlign: 'center', fontSize: '14px', fontWeight: '600', color: '#667eea' }}>
                                            {checkIn.morningData?.mood || '-'}
                                        </td>
                                        <td style={{ padding: '12px', textAlign: 'center', fontSize: '14px', fontWeight: '600', color: '#f44336' }}>
                                            {checkIn.morningData?.craving || '-'}
                                        </td>
                                        <td style={{ padding: '12px', textAlign: 'center', fontSize: '14px', fontWeight: '600', color: '#FF9800' }}>
                                            {checkIn.morningData?.anxietyLevel || '-'}
                                        </td>
                                        <td style={{ padding: '12px', textAlign: 'center', fontSize: '14px', fontWeight: '600', color: '#9C27B0' }}>
                                            {checkIn.morningData?.sleepQuality || '-'}
                                        </td>
                                        <td style={{ padding: '12px', textAlign: 'center', fontSize: '14px', fontWeight: '600', color: '#2196F3' }}>
                                                {checkIn.eveningData?.overallDay || '-'}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        );
    }

    // ========== MAIN REPORTS VIEW RENDER ==========
    if (showAnalytics) {
        return (
            <AnalyticsView 
                analyticsData={analyticsData}
                onClose={() => setShowAnalytics(false)}
                onSelectPIR={(pirId) => {
                    setSelectedPIRForReport(pirId);
                    setShowAnalytics(false);
                }}
            />
        );
    }

    if (selectedPIRForReport) {
        return (
            <IndividualPIRReport 
                pirId={selectedPIRForReport}
                onClose={() => setSelectedPIRForReport(null)}
            />
        );
    }

    return (
        <div style={{ padding: '20px', maxWidth: '1400px', margin: '0 auto' }}>
            {/* Header */}
            <div style={{ 
                display: 'flex', 
                justifyContent: 'space-between', 
                alignItems: 'center',
                marginBottom: '30px'
            }}>
                <div>
                    <h2 style={{ margin: '0 0 10px 0', fontSize: '32px', color: '#333' }}>
                        Reports & Analytics
                    </h2>
                    <p style={{ margin: 0, color: '#666', fontSize: '16px' }}>
                        Generate comprehensive reports and analyze program performance
                    </p>
                </div>
                <button
                    onClick={() => setShowAnalytics(true)}
                    style={{
                        padding: '14px 28px',
                        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '12px',
                        cursor: 'pointer',
                        fontSize: '15px',
                        fontWeight: '600',
                        boxShadow: '0 4px 15px rgba(102, 126, 234, 0.3)',
                        transition: 'transform 0.2s'
                    }}
                    onMouseEnter={(e) => e.target.style.transform = 'translateY(-2px)'}
                    onMouseLeave={(e) => e.target.style.transform = 'translateY(0)'}
                >
                    View Analytics Dashboard
                </button>
            </div>

            {/* Report Generation Section */}
            <div style={{
                background: 'white',
                borderRadius: '20px',
                padding: '35px',
                marginBottom: '30px',
                boxShadow: '0 2px 20px rgba(0,0,0,0.08)'
            }}>
                <h3 style={{ margin: '0 0 25px 0', fontSize: '24px', color: '#333' }}>
                    Generate Report
                </h3>

                {/* Date Range Selector */}
                <div style={{ 
                    display: 'grid', 
                    gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                    gap: '20px',
                    marginBottom: '30px'
                }}>
                    <div>
                        <label style={{ display: 'block', marginBottom: '8px', fontWeight: '600', color: '#555', fontSize: '14px' }}>
                            Start Date
                        </label>
                        <input
                            type="date"
                            value={startDate}
                            onChange={(e) => setStartDate(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '12px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '10px',
                                fontSize: '15px',
                                boxSizing: 'border-box'
                            }}
                        />
                    </div>
                    <div>
                        <label style={{ display: 'block', marginBottom: '8px', fontWeight: '600', color: '#555', fontSize: '14px' }}>
                            End Date
                        </label>
                        <input
                            type="date"
                            value={endDate}
                            onChange={(e) => setEndDate(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '12px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '10px',
                                fontSize: '15px',
                                boxSizing: 'border-box'
                            }}
                        />
                    </div>
                </div>

                {/* Report Templates Grid */}
                <div>
                    <h4 style={{ margin: '0 0 20px 0', fontSize: '18px', color: '#333' }}>
                        Select Report Template
                    </h4>
                    <div style={{ 
                        display: 'grid', 
                        gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))',
                        gap: '15px',
                        marginBottom: '25px'
                    }}>
                        {Object.entries(REPORT_TEMPLATES).map(([key, template]) => (
                            <div
                                key={key}
                                onClick={() => setSelectedTemplate(key)}
                                style={{
                                    padding: '20px',
                                    background: selectedTemplate === key ? template.color : '#f8f9fa',
                                    borderRadius: '12px',
                                    cursor: 'pointer',
                                    transition: 'all 0.3s',
                                    border: selectedTemplate === key ? '2px solid transparent' : '2px solid #e0e0e0',
                                    transform: selectedTemplate === key ? 'scale(1.02)' : 'scale(1)',
                                    boxShadow: selectedTemplate === key ? '0 8px 25px rgba(0,0,0,0.15)' : '0 2px 8px rgba(0,0,0,0.05)'
                                }}
                            >
                                <div style={{ 
                                    fontSize: '32px', 
                                    marginBottom: '10px',
                                    filter: selectedTemplate === key ? 'brightness(2)' : 'none'
                                }}>
                                    {template.icon}
                                </div>
                                <div style={{ 
                                    fontSize: '16px', 
                                    fontWeight: '700',
                                    color: selectedTemplate === key ? 'white' : '#333',
                                    marginBottom: '6px'
                                }}>
                                    {template.name}
                                </div>
                                <div style={{ 
                                    fontSize: '13px',
                                    color: selectedTemplate === key ? 'rgba(255,255,255,0.9)' : '#666',
                                    lineHeight: '1.4'
                                }}>
                                    {template.desc}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>

                {/* PIR Selector for specific reports */}
                {(selectedTemplate === 'fullPIR' || selectedTemplate === 'comparative') && (
                    <div style={{ marginBottom: '25px' }}>
                        <label style={{ display: 'block', marginBottom: '8px', fontWeight: '600', color: '#555', fontSize: '14px' }}>
                            Select PIR for {REPORT_TEMPLATES[selectedTemplate].name}
                        </label>
                        <select
                            value={customConfig.selectedPIRs[0] || ''}
                            onChange={(e) => setCustomConfig({
                                ...customConfig,
                                selectedPIRs: [e.target.value]
                            })}
                            style={{
                                width: '100%',
                                padding: '12px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '10px',
                                fontSize: '15px',
                                background: 'white'
                            }}
                        >
                            <option value="">-- Select a PIR --</option>
                            {allPIRs.map(pir => (
                                <option key={pir.id} value={pir.id}>{pir.name}</option>
                            ))}
                        </select>
                    </div>
                )}

                {/* Generate Button */}
                <button
                    onClick={generateReport}
                    disabled={loading}
                    style={{
                        width: '100%',
                        padding: '16px',
                        background: loading ? '#ccc' : 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '12px',
                        fontSize: '16px',
                        fontWeight: '700',
                        cursor: loading ? 'not-allowed' : 'pointer',
                        transition: 'all 0.3s',
                        boxShadow: loading ? 'none' : '0 4px 15px rgba(76, 175, 80, 0.3)'
                    }}
                >
                    {loading ? 'Generating Report...' : `Generate ${REPORT_TEMPLATES[selectedTemplate]?.name || 'Report'}`}
                </button>
            </div>

            {/* Report Display Section */}
            {reportData && (
                <div style={{
                    background: 'white',
                    borderRadius: '20px',
                    padding: '35px',
                    boxShadow: '0 2px 20px rgba(0,0,0,0.08)',
                    animation: 'fadeIn 0.5s'
                }}>
                    {/* Report Header */}
                    <div style={{ 
                        display: 'flex', 
                        justifyContent: 'space-between', 
                        alignItems: 'center',
                        marginBottom: '30px',
                        paddingBottom: '20px',
                        borderBottom: '2px solid #f0f0f0'
                    }}>
                        <div>
                            <h3 style={{ margin: '0 0 8px 0', fontSize: '26px', color: '#333' }}>
                                {REPORT_TEMPLATES[selectedTemplate]?.name || 'Report'}
                            </h3>
                            <p style={{ margin: 0, color: '#666', fontSize: '14px' }}>
                                {startDate} to {endDate}
                            </p>
                        </div>
                        <div style={{ display: 'flex', gap: '10px' }}>
                            <button
                                onClick={() => exportReportToPDF(reportData, REPORT_TEMPLATES[selectedTemplate]?.name || 'Report')}
                                style={{
                                    padding: '10px 20px',
                                    background: '#f44336',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '600'
                                }}
                            >
                                Export PDF
                            </button>
                            <button
                                onClick={() => exportToJSON(reportData, REPORT_TEMPLATES[selectedTemplate]?.name || 'Report')}
                                style={{
                                    padding: '10px 20px',
                                    background: '#2196F3',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '600'
                                }}
                            >
                                Export JSON
                            </button>
                        </div>
                    </div>

                    {/* Summary Section */}
                    {reportData.summary && (
                        <div style={{ marginBottom: '40px' }}>
                            <h4 style={{ margin: '0 0 20px 0', fontSize: '20px', color: '#333' }}>
                                Summary Statistics
                            </h4>
                            <div style={{ 
                                display: 'grid', 
                                gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                                gap: '15px'
                            }}>
                                {Object.entries(reportData.summary).map(([key, value]) => (
                                    <div key={key} style={{
                                        padding: '18px',
                                        background: '#f8f9fa',
                                        borderRadius: '10px',
                                        borderLeft: '4px solid #667eea'
                                    }}>
                                        <div style={{ fontSize: '12px', color: '#666', marginBottom: '6px', textTransform: 'capitalize' }}>
                                            {key.replace(/([A-Z])/g, ' $1').trim()}
                                        </div>
                                        <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#333' }}>
                                            {value}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Patterns Section */}
                    {reportData.patterns && reportData.patterns.length > 0 && (
                        <div style={{ 
                            marginBottom: '40px',
                            padding: '20px',
                            background: '#fff3cd',
                            borderRadius: '12px',
                            borderLeft: '4px solid #ffc107'
                        }}>
                            <h4 style={{ margin: '0 0 15px 0', fontSize: '18px', color: '#856404' }}>
                                Detected Patterns & Alerts
                            </h4>
                            <ul style={{ margin: 0, paddingLeft: '20px' }}>
                                {reportData.patterns.map((pattern, idx) => (
                                    <li key={idx} style={{ 
                                        color: '#856404', 
                                        marginBottom: '8px',
                                        fontSize: '14px'
                                    }}>
                                        {pattern.message || pattern}
                                    </li>
                                ))}
                            </ul>
                        </div>
                    )}

                    {/* Charts Section */}
                    {reportData.charts && (
                        <div style={{ marginBottom: '40px' }}>
                            <h4 style={{ margin: '0 0 25px 0', fontSize: '20px', color: '#333' }}>
                                Visual Analysis
                            </h4>
                            <div style={{ 
                                display: 'grid',
                                gap: '25px'
                            }}>
                                {/* Trend Charts */}
                                {reportData.charts.trends && (
                                    <>
                                        <div style={{ 
                                            background: '#f8f9fa', 
                                            padding: '20px', 
                                            borderRadius: '12px',
                                            height: '350px'
                                        }}>
                                            <h5 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#555' }}>
                                                Mood Trend
                                            </h5>
                                            <canvas ref={chartRefs.moodTrend} style={{ maxHeight: '280px' }}></canvas>
                                        </div>
                                        <div style={{ 
                                            background: '#f8f9fa', 
                                            padding: '20px', 
                                            borderRadius: '12px',
                                            height: '350px'
                                        }}>
                                            <h5 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#555' }}>
                                                Craving Trend
                                            </h5>
                                            <canvas ref={chartRefs.cravingTrend} style={{ maxHeight: '280px' }}></canvas>
                                        </div>
                                        <div style={{ 
                                            background: '#f8f9fa', 
                                            padding: '20px', 
                                            borderRadius: '12px',
                                            height: '350px'
                                        }}>
                                            <h5 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#555' }}>
                                                Anxiety Trend
                                            </h5>
                                            <canvas ref={chartRefs.anxietyTrend} style={{ maxHeight: '280px' }}></canvas>
                                        </div>
                                        <div style={{ 
                                            background: '#f8f9fa', 
                                            padding: '20px', 
                                            borderRadius: '12px',
                                            height: '350px'
                                        }}>
                                            <h5 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#555' }}>
                                                Sleep Quality Trend
                                            </h5>
                                            <canvas ref={chartRefs.sleepTrend} style={{ maxHeight: '280px' }}></canvas>
                                        </div>
                                    </>
                                )}

                                {/* Scatter Charts */}
                                {reportData.charts.moodVsCravings && (
                                    <div style={{ 
                                        background: '#f8f9fa', 
                                        padding: '20px', 
                                        borderRadius: '12px',
                                        height: '350px'
                                    }}>
                                        <h5 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#555' }}>
                                            Mood vs Cravings Correlation
                                        </h5>
                                        <canvas ref={chartRefs.moodVsCravings} style={{ maxHeight: '280px' }}></canvas>
                                    </div>
                                )}
                                {reportData.charts.anxietyVsSleep && (
                                    <div style={{ 
                                        background: '#f8f9fa', 
                                        padding: '20px', 
                                        borderRadius: '12px',
                                        height: '350px'
                                    }}>
                                        <h5 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#555' }}>
                                            Anxiety vs Sleep Quality Correlation
                                        </h5>
                                        <canvas ref={chartRefs.anxietyVsSleep} style={{ maxHeight: '280px' }}></canvas>
                                    </div>
                                )}
                                {reportData.charts.sobrietyVsCravings && (
                                    <div style={{ 
                                        background: '#f8f9fa', 
                                        padding: '20px', 
                                        borderRadius: '12px',
                                        height: '350px'
                                    }}>
                                        <h5 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#555' }}>
                                            Days Sober vs Cravings
                                        </h5>
                                        <canvas ref={chartRefs.sobrietyVsCravings} style={{ maxHeight: '280px' }}></canvas>
                                    </div>
                                )}

                                {/* Distribution Charts */}
                                {reportData.charts.distribution && (
                                    <div style={{ 
                                        background: '#f8f9fa', 
                                        padding: '20px', 
                                        borderRadius: '12px',
                                        height: '350px'
                                    }}>
                                        <h5 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#555' }}>
                                            Mood Distribution
                                        </h5>
                                        <canvas ref={chartRefs.moodDistribution} style={{ maxHeight: '280px' }}></canvas>
                                    </div>
                                )}
                                {reportData.charts.riskDistribution && (
                                    <div style={{ 
                                        background: '#f8f9fa', 
                                        padding: '20px', 
                                        borderRadius: '12px',
                                        height: '350px'
                                    }}>
                                        <h5 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#555' }}>
                                            Risk Distribution
                                        </h5>
                                        <canvas ref={chartRefs.riskDistribution} style={{ maxHeight: '280px' }}></canvas>
                                    </div>
                                )}
                                {reportData.charts.goalCompletion && (
                                    <div style={{ 
                                        background: '#f8f9fa', 
                                        padding: '20px', 
                                        borderRadius: '12px',
                                        height: '350px'
                                    }}>
                                        <h5 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#555' }}>
                                            Goal Completion Status
                                        </h5>
                                        <canvas ref={chartRefs.goalCompletion} style={{ maxHeight: '280px' }}></canvas>
                                    </div>
                                )}
                                {reportData.charts.engagementDistribution && (
                                    <div style={{ 
                                        background: '#f8f9fa', 
                                        padding: '20px', 
                                        borderRadius: '12px',
                                        height: '400px'
                                    }}>
                                        <h5 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#555' }}>
                                            Engagement Scores by PIR
                                        </h5>
                                        <canvas ref={chartRefs.engagementChart} style={{ maxHeight: '320px' }}></canvas>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Data Tables Section */}
                    <div>
                        {/* Sobriety Data Table */}
                        {reportData.sobrietyData && reportData.sobrietyData.length > 0 && (
                            <div style={{ marginBottom: '30px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
                                    <h4 style={{ margin: 0, fontSize: '18px', color: '#333' }}>
                                        Sobriety Analysis Data
                                    </h4>
                                    <button
                                        onClick={() => exportToCSV(reportData.sobrietyData, 'sobriety_analysis')}
                                        style={{
                                            padding: '8px 16px',
                                            background: '#4CAF50',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            fontWeight: '600'
                                        }}
                                    >
                                        Export CSV
                                    </button>
                                </div>
                                <div style={{ overflowX: 'auto', background: '#f8f9fa', borderRadius: '10px', padding: '15px' }}>
                                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                        <thead>
                                            <tr style={{ background: '#667eea', color: 'white' }}>
                                                <th style={{ padding: '12px', textAlign: 'left', fontSize: '13px', fontWeight: '600' }}>PIR</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Days Sober</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Avg Mood</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Avg Cravings</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Risk Score</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Risk Level</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {reportData.sobrietyData.map((pir, idx) => (
                                                <tr key={idx} style={{ borderBottom: '1px solid #e0e0e0', background: idx % 2 === 0 ? 'white' : '#fafafa' }}>
                                                    <td style={{ padding: '10px', fontSize: '13px', color: '#333' }}>{pir.pirName}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', fontWeight: '600', color: '#4CAF50' }}>{pir.daysSober}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', color: '#666' }}>{pir.avgMood}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', color: '#666' }}>{pir.avgCravings}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', fontWeight: '600', color: pir.riskScore >= 7 ? '#f44336' : pir.riskScore >= 4 ? '#FF9800' : '#4CAF50' }}>
                                                        {pir.riskScore}/10
                                                    </td>
                                                    <td style={{ padding: '10px', textAlign: 'center' }}>
                                                        <span style={{
                                                            padding: '4px 12px',
                                                            borderRadius: '12px',
                                                            fontSize: '12px',
                                                            fontWeight: '600',
                                                            background: pir.riskLevel === 'Critical' ? '#ffebee' : pir.riskLevel === 'High' ? '#fff3e0' : '#e8f5e9',
                                                            color: pir.riskLevel === 'Critical' ? '#c62828' : pir.riskLevel === 'High' ? '#ef6c00' : '#2e7d32'
                                                        }}>
                                                            {pir.riskLevel}
                                                        </span>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* Morning Check-ins Table */}
                        {reportData.morningData && reportData.morningData.length > 0 && (
                            <div style={{ marginBottom: '30px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
                                    <h4 style={{ margin: 0, fontSize: '18px', color: '#333' }}>
                                        Morning Check-ins Data
                                    </h4>
                                    <button
                                        onClick={() => exportToCSV(reportData.morningData, 'morning_checkins')}
                                        style={{
                                            padding: '8px 16px',
                                            background: '#4CAF50',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            fontWeight: '600'
                                        }}
                                    >
                                        Export CSV
                                    </button>
                                </div>
                                <div style={{ overflowX: 'auto', background: '#f8f9fa', borderRadius: '10px', padding: '15px' }}>
                                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                        <thead>
                                            <tr style={{ background: '#FF9800', color: 'white' }}>
                                                <th style={{ padding: '12px', textAlign: 'left', fontSize: '13px', fontWeight: '600' }}>PIR</th>
                                                <th style={{ padding: '12px', textAlign: 'left', fontSize: '13px', fontWeight: '600' }}>Date</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Mood</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Craving</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Anxiety</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Sleep</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {reportData.morningData.slice(0, 50).map((morning, idx) => (
                                                <tr key={idx} style={{ borderBottom: '1px solid #e0e0e0', background: idx % 2 === 0 ? 'white' : '#fafafa' }}>
                                                    <td style={{ padding: '10px', fontSize: '13px', color: '#333' }}>{morning.pirName}</td>
                                                    <td style={{ padding: '10px', fontSize: '13px', color: '#666' }}>{formatDate(morning.date)}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', fontWeight: '600', color: '#667eea' }}>{morning.mood}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', fontWeight: '600', color: '#f44336' }}>{morning.craving}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', fontWeight: '600', color: '#FF9800' }}>{morning.anxiety}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', fontWeight: '600', color: '#9C27B0' }}>{morning.sleep}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* Evening Reflections Table */}
                        {reportData.eveningData && reportData.eveningData.length > 0 && (
                            <div style={{ marginBottom: '30px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
                                    <h4 style={{ margin: 0, fontSize: '18px', color: '#333' }}>
                                        Evening Reflections Data
                                    </h4>
                                    <button
                                        onClick={() => exportToCSV(reportData.eveningData, 'evening_reflections')}
                                        style={{
                                            padding: '8px 16px',
                                            background: '#4CAF50',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            fontWeight: '600'
                                        }}
                                    >
                                        Export CSV
                                    </button>
                                </div>
                                <div style={{ overflowX: 'auto', background: '#f8f9fa', borderRadius: '10px', padding: '15px' }}>
                                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                        <thead>
                                            <tr style={{ background: '#9C27B0', color: 'white' }}>
                                                <th style={{ padding: '12px', textAlign: 'left', fontSize: '13px', fontWeight: '600' }}>PIR</th>
                                                <th style={{ padding: '12px', textAlign: 'left', fontSize: '13px', fontWeight: '600' }}>Date</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Overall Day</th>
                                                <th style={{ padding: '12px', textAlign: 'left', fontSize: '13px', fontWeight: '600' }}>Gratitude</th>
                                                <th style={{ padding: '12px', textAlign: 'left', fontSize: '13px', fontWeight: '600' }}>Challenges</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {reportData.eveningData.slice(0, 50).map((evening, idx) => (
                                                <tr key={idx} style={{ borderBottom: '1px solid #e0e0e0', background: idx % 2 === 0 ? 'white' : '#fafafa' }}>
                                                    <td style={{ padding: '10px', fontSize: '13px', color: '#333' }}>{evening.pirName}</td>
                                                    <td style={{ padding: '10px', fontSize: '13px', color: '#666' }}>{formatDate(evening.date)}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', fontWeight: '600', color: '#2196F3' }}>{evening.overallDay}/10</td>
                                                    <td style={{ padding: '10px', fontSize: '12px', color: '#555', maxWidth: '250px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                                        {evening.gratitude || '-'}
                                                    </td>
                                                    <td style={{ padding: '10px', fontSize: '12px', color: '#555', maxWidth: '250px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                                        {evening.challenges || '-'}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* Engagement Data Table */}
                        {reportData.engagementData && reportData.engagementData.length > 0 && (
                            <div style={{ marginBottom: '30px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
                                    <h4 style={{ margin: 0, fontSize: '18px', color: '#333' }}>
                                        Engagement Metrics
                                    </h4>
                                    <button
                                        onClick={() => exportToCSV(reportData.engagementData, 'engagement_metrics')}
                                        style={{
                                            padding: '8px 16px',
                                            background: '#4CAF50',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            fontWeight: '600'
                                        }}
                                    >
                                        Export CSV
                                    </button>
                                </div>
                                <div style={{ overflowX: 'auto', background: '#f8f9fa', borderRadius: '10px', padding: '15px' }}>
                                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                        <thead>
                                            <tr style={{ background: '#FF5722', color: 'white' }}>
                                                <th style={{ padding: '12px', textAlign: 'left', fontSize: '13px', fontWeight: '600' }}>PIR</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Check-ins</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Streak</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Assignments</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Completion</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Messages</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Score</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {reportData.engagementData.map((engagement, idx) => (
                                                <tr key={idx} style={{ borderBottom: '1px solid #e0e0e0', background: idx % 2 === 0 ? 'white' : '#fafafa' }}>
                                                    <td style={{ padding: '10px', fontSize: '13px', color: '#333' }}>{engagement.pirName}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', color: '#666' }}>{engagement.checkInCount}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', fontWeight: '600', color: '#4CAF50' }}>{engagement.checkInStreak} days</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', color: '#666' }}>{engagement.assignmentCount}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', fontWeight: '600', color: '#2196F3' }}>{engagement.assignmentCompletion}%</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', color: '#666' }}>{engagement.messageCount}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center' }}>
                                                        <span style={{
                                                            padding: '4px 12px',
                                                            borderRadius: '12px',
                                                            fontSize: '12px',
                                                            fontWeight: '600',
                                                            background: engagement.engagementScore >= 75 ? '#e8f5e9' : engagement.engagementScore >= 50 ? '#fff3e0' : '#ffebee',
                                                            color: engagement.engagementScore >= 75 ? '#2e7d32' : engagement.engagementScore >= 50 ? '#ef6c00' : '#c62828'
                                                        }}>
                                                            {engagement.engagementScore}
                                                        </span>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* Risk Data Table */}
                        {reportData.riskData && reportData.riskData.length > 0 && (
                            <div style={{ marginBottom: '30px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
                                    <h4 style={{ margin: 0, fontSize: '18px', color: '#333' }}>
                                        Predictive Risk Analysis
                                    </h4>
                                    <button
                                        onClick={() => exportToCSV(reportData.riskData, 'risk_analysis')}
                                        style={{
                                            padding: '8px 16px',
                                            background: '#4CAF50',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            fontWeight: '600'
                                        }}
                                    >
                                        Export CSV
                                    </button>
                                </div>
                                <div style={{ overflowX: 'auto', background: '#f8f9fa', borderRadius: '10px', padding: '15px' }}>
                                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                        <thead>
                                            <tr style={{ background: '#E91E63', color: 'white' }}>
                                                <th style={{ padding: '12px', textAlign: 'left', fontSize: '13px', fontWeight: '600' }}>PIR</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Risk Score</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Level</th>
                                                <th style={{ padding: '12px', textAlign: 'left', fontSize: '13px', fontWeight: '600' }}>Patterns</th>
                                                <th style={{ padding: '12px', textAlign: 'left', fontSize: '13px', fontWeight: '600' }}>Recommendations</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {reportData.riskData.map((risk, idx) => (
                                                <tr key={idx} style={{ borderBottom: '1px solid #e0e0e0', background: idx % 2 === 0 ? 'white' : '#fafafa' }}>
                                                    <td style={{ padding: '10px', fontSize: '13px', color: '#333' }}>{risk.pirName}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', fontWeight: '600', color: risk.riskScore >= 7 ? '#f44336' : risk.riskScore >= 4 ? '#FF9800' : '#4CAF50' }}>
                                                        {risk.riskScore}/10
                                                    </td>
                                                    <td style={{ padding: '10px', textAlign: 'center' }}>
                                                        <span style={{
                                                            padding: '4px 12px',
                                                            borderRadius: '12px',
                                                            fontSize: '12px',
                                                            fontWeight: '600',
                                                            background: risk.riskLevel === 'High' ? '#ffebee' : risk.riskLevel === 'Moderate' ? '#fff3e0' : '#e8f5e9',
                                                            color: risk.riskLevel === 'High' ? '#c62828' : risk.riskLevel === 'Moderate' ? '#ef6c00' : '#2e7d32'
                                                        }}>
                                                            {risk.riskLevel}
                                                        </span>
                                                    </td>
                                                    <td style={{ padding: '10px', fontSize: '12px', color: '#555' }}>
                                                        {risk.patterns.length > 0 ? risk.patterns.join(', ') : 'None detected'}
                                                    </td>
                                                    <td style={{ padding: '10px', fontSize: '12px', color: '#555' }}>
                                                        {risk.recommendations.join('; ')}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* Alerts Table */}
                        {reportData.alerts && reportData.alerts.length > 0 && (
                            <div style={{ marginBottom: '30px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
                                    <h4 style={{ margin: 0, fontSize: '18px', color: '#333' }}>
                                        Crisis Alerts & Interventions
                                    </h4>
                                    <button
                                        onClick={() => exportToCSV(reportData.alerts, 'crisis_alerts')}
                                        style={{
                                            padding: '8px 16px',
                                            background: '#4CAF50',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            fontWeight: '600'
                                        }}
                                    >
                                        Export CSV
                                    </button>
                                </div>
                                <div style={{ overflowX: 'auto', background: '#f8f9fa', borderRadius: '10px', padding: '15px' }}>
                                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                        <thead>
                                            <tr style={{ background: '#f44336', color: 'white' }}>
                                                <th style={{ padding: '12px', textAlign: 'left', fontSize: '13px', fontWeight: '600' }}>PIR</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Type</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Priority</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Status</th>
                                                <th style={{ padding: '12px', textAlign: 'left', fontSize: '13px', fontWeight: '600' }}>Created</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {reportData.alerts.slice(0, 50).map((alert, idx) => (
                                                <tr key={idx} style={{ borderBottom: '1px solid #e0e0e0', background: idx % 2 === 0 ? 'white' : '#fafafa' }}>
                                                    <td style={{ padding: '10px', fontSize: '13px', color: '#333' }}>{alert.pirName}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center' }}>
                                                        <span style={{
                                                            padding: '4px 10px',
                                                            borderRadius: '10px',
                                                            fontSize: '11px',
                                                            fontWeight: '600',
                                                            background: alert.type === 'sos' ? '#ffebee' : '#e3f2fd',
                                                            color: alert.type === 'sos' ? '#c62828' : '#1565c0'
                                                        }}>
                                                            {alert.type.toUpperCase()}
                                                        </span>
                                                    </td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', color: alert.priority === 'critical' ? '#f44336' : '#666' }}>
                                                        {alert.priority || 'normal'}
                                                    </td>
                                                    <td style={{ padding: '10px', textAlign: 'center' }}>
                                                        <span style={{
                                                            padding: '4px 10px',
                                                            borderRadius: '10px',
                                                            fontSize: '11px',
                                                            fontWeight: '600',
                                                            background: alert.resolved ? '#e8f5e9' : '#fff3e0',
                                                            color: alert.resolved ? '#2e7d32' : '#ef6c00'
                                                        }}>
                                                            {alert.resolved ? 'Resolved' : 'Active'}
                                                        </span>
                                                    </td>
                                                    <td style={{ padding: '10px', fontSize: '13px', color: '#666' }}>{formatTimeAgo(alert.createdAt)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* PIR Info (for Full PIR Report) */}
                        {reportData.pirInfo && (
                            <div style={{ 
                                marginBottom: '30px',
                                padding: '20px',
                                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                borderRadius: '12px',
                                color: 'white'
                            }}>
                                <h4 style={{ margin: '0 0 15px 0', fontSize: '20px' }}>PIR Information</h4>
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '15px' }}>
                                    <div>
                                        <div style={{ fontSize: '12px', opacity: 0.9 }}>Name</div>
                                        <div style={{ fontSize: '18px', fontWeight: '600' }}>{reportData.pirInfo.name}</div>
                                    </div>
                                    <div>
                                        <div style={{ fontSize: '12px', opacity: 0.9 }}>Email</div>
                                        <div style={{ fontSize: '18px', fontWeight: '600' }}>{reportData.pirInfo.email}</div>
                                    </div>
                                    <div>
                                        <div style={{ fontSize: '12px', opacity: 0.9 }}>Days Sober</div>
                                        <div style={{ fontSize: '18px', fontWeight: '600' }}>{reportData.pirInfo.daysSober}</div>
                                    </div>
                                    <div>
                                        <div style={{ fontSize: '12px', opacity: 0.9 }}>Sobriety Date</div>
                                        <div style={{ fontSize: '18px', fontWeight: '600' }}>{formatDate(reportData.pirInfo.sobrietyDate)}</div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Comparative Data */}
                        {reportData.comparison && (
                            <div style={{ marginBottom: '30px' }}>
                                <h4 style={{ margin: '0 0 20px 0', fontSize: '18px', color: '#333' }}>
                                    Comparative Analysis: {reportData.pirInfo?.name} vs Program Average
                                </h4>
                                <div style={{ display: 'grid', gap: '15px' }}>
                                    {Object.entries(reportData.comparison).map(([metric, values]) => (
                                        <div key={metric} style={{
                                            padding: '20px',
                                            background: '#f8f9fa',
                                            borderRadius: '10px',
                                            display: 'grid',
                                            gridTemplateColumns: '200px 1fr 1fr',
                                            gap: '20px',
                                            alignItems: 'center'
                                        }}>
                                            <div style={{ fontSize: '16px', fontWeight: '600', color: '#333', textTransform: 'capitalize' }}>
                                                {metric.replace(/([A-Z])/g, ' $1').trim()}
                                            </div>
                                            <div>
                                                <div style={{ fontSize: '12px', color: '#666', marginBottom: '4px' }}>PIR</div>
                                                <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#667eea' }}>{values.pir}</div>
                                            </div>
                                            <div>
                                                <div style={{ fontSize: '12px', color: '#666', marginBottom: '4px' }}>Program Avg</div>
                                                <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#FF9800' }}>{values.program}</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Achievements/Milestones */}
                        {reportData.achievements && reportData.achievements.length > 0 && (
                            <div style={{ marginBottom: '30px' }}>
                                <h4 style={{ margin: '0 0 20px 0', fontSize: '18px', color: '#333' }}>
                                    Achievements & Milestones
                                </h4>
                                <div style={{ display: 'grid', gap: '12px' }}>
                                    {reportData.achievements.slice(0, 20).map((achievement, idx) => (
                                        <div key={idx} style={{
                                            padding: '15px',
                                            background: achievement.type === 'milestone' ? '#e8f5e9' : '#e3f2fd',
                                            borderRadius: '10px',
                                            borderLeft: `4px solid ${achievement.type === 'milestone' ? '#4CAF50' : '#2196F3'}`,
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            alignItems: 'center'
                                        }}>
                                            <div>
                                                <div style={{ fontSize: '15px', fontWeight: '600', color: '#333', marginBottom: '4px' }}>
                                                    {achievement.title}
                                                </div>
                                                <div style={{ fontSize: '13px', color: '#666' }}>
                                                    {achievement.pirName} ‚Ä¢ {formatDate(achievement.completedAt)}
                                                </div>
                                            </div>
                                            <div style={{
                                                padding: '6px 14px',
                                                background: achievement.type === 'milestone' ? '#4CAF50' : '#2196F3',
                                                color: 'white',
                                                borderRadius: '20px',
                                                fontSize: '12px',
                                                fontWeight: '600'
                                            }}>
                                                {achievement.type === 'milestone' ? 'Milestone' : 'Goal'}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Communication Data */}
                        {reportData.pirComms && reportData.pirComms.length > 0 && (
                            <div style={{ marginBottom: '30px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
                                    <h4 style={{ margin: 0, fontSize: '18px', color: '#333' }}>
                                        Communication Activity
                                    </h4>
                                    <button
                                        onClick={() => exportToCSV(reportData.pirComms, 'communication_report')}
                                        style={{
                                            padding: '8px 16px',
                                            background: '#4CAF50',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            fontWeight: '600'
                                        }}
                                    >
                                        Export CSV
                                    </button>
                                </div>
                                <div style={{ overflowX: 'auto', background: '#f8f9fa', borderRadius: '10px', padding: '15px' }}>
                                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                        <thead>
                                            <tr style={{ background: '#607D8B', color: 'white' }}>
                                                <th style={{ padding: '12px', textAlign: 'left', fontSize: '13px', fontWeight: '600' }}>PIR</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Messages Sent</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Messages Received</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Total Activity</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {reportData.pirComms.map((comm, idx) => (
                                                <tr key={idx} style={{ borderBottom: '1px solid #e0e0e0', background: idx % 2 === 0 ? 'white' : '#fafafa' }}>
                                                    <td style={{ padding: '10px', fontSize: '13px', color: '#333' }}>{comm.pirName}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', fontWeight: '600', color: '#2196F3' }}>{comm.messagesSent}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', fontWeight: '600', color: '#4CAF50' }}>{comm.messagesReceived}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', fontWeight: '600', color: '#667eea' }}>{comm.messagesSent + comm.messagesReceived}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            )}
        </div>
    );
}
// COMPLETE SETTINGS VIEW - ALL IN ORDER
function SettingsView({ user }) {
    // ========== STATE VARIABLES ==========
    const [activeSection, setActiveSection] = useState('notifications');
    const [settings, setSettings] = useState({
        // Notification Settings
        emailNotifications: false,
        smsNotifications: false,
        pushNotifications: true,
        sosAlertEmail: true,
        sosAlertSMS: false,
        dailyDigest: false,
        weeklyReport: false,
        
        // Check-in Settings
        checkInReminderTime: '09:00',
        eveningReminderTime: '20:00',
        missedCheckInAlert: true,
        
        // Alert Thresholds
        lowMoodThreshold: 3,
        highCravingThreshold: 7,
        highAnxietyThreshold: 7,
        poorSleepThreshold: 3,
        
        // System Settings
        timezone: 'America/Los_Angeles',
        dateFormat: 'MM/DD/YYYY',
        timeFormat: '12h',
        language: 'en',
        autoRefresh: 30,
        
        // Data Management
        autoBackupEnabled: false,
        backupFrequency: 'weekly',
        dataRetentionDays: 2555,
        autoArchiveOldMessages: true,
        archiveAfterDays: 90
    });
    
    const [coaches, setCoaches] = useState([]);
    const [pirs, setPirs] = useState([]);
    const [permissions, setPermissions] = useState({});
    const [saving, setSaving] = useState(false);
    const [loading, setLoading] = useState(true);

    // ========== USEEFFECT - INITIALIZATION ==========
    useEffect(() => {
        loadAllSettings();
    }, []);

    // ========== LOAD ALL SETTINGS ==========
    const loadAllSettings = async () => {
        try {
            const [settingsDoc, coachesSnap, pirsSnap, permissionsDoc] = await Promise.all([
                db.collection('settings').doc('system').get(),
                db.collection('users').where('role', 'in', ['coach', 'admin']).get(),
                db.collection('users').where('role', '==', 'pir').get(),
                db.collection('settings').doc('permissions').get()
            ]);

            if (settingsDoc.exists) {
                setSettings({ ...settings, ...settingsDoc.data() });
            }

            setCoaches(coachesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            setPirs(pirsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })));

            if (permissionsDoc.exists) {
                setPermissions(permissionsDoc.data());
            }
        } catch (error) {
            console.error('Error loading settings:', error);
        } finally {
            setLoading(false);
        }
    };

    // ========== SAVE SETTINGS ==========
    const saveSettings = async () => {
        setSaving(true);
        try {
            await db.collection('settings').doc('system').set({
                ...settings,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: user.uid
            });
            alert('Settings saved successfully');
        } catch (error) {
            console.error('Error saving settings:', error);
            alert('Failed to save settings');
        } finally {
            setSaving(false);
        }
    };

    // ========== ADD COACH ==========
    const handleAddCoach = async () => {
        const email = prompt('Enter coach email:');
        const password = prompt('Enter temporary password:');
        const firstName = prompt('First name:');
        const lastName = prompt('Last name:');

        if (!email || !password || !firstName || !lastName) return;

        try {
            const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
            
            await db.collection('users').doc(userCredential.user.uid).set({
                email,
                firstName,
                lastName,
                displayName: `${firstName} ${lastName}`,
                role: 'coach',
                active: true,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: user.uid
            });

            await loadAllSettings();
            alert('Coach added successfully');
        } catch (error) {
            console.error('Error adding coach:', error);
            alert('Failed to add coach: ' + error.message);
        }
    };

    // ========== ADD PIR ==========
    const handleAddPIR = async () => {
        const email = prompt('Enter PIR email:');
        const password = prompt('Enter temporary password:');
        const firstName = prompt('First name:');
        const lastName = prompt('Last name:');
        const coachId = prompt('Assign to coach ID (optional):');

        if (!email || !password || !firstName || !lastName) return;

        try {
            const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
            
            await db.collection('users').doc(userCredential.user.uid).set({
                email,
                firstName,
                lastName,
                displayName: `${firstName} ${lastName}`,
                role: 'pir',
                active: true,
                assignedCoach: coachId || null,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: user.uid
            });

            await loadAllSettings();
            alert('PIR added successfully');
        } catch (error) {
            console.error('Error adding PIR:', error);
            alert('Failed to add PIR: ' + error.message);
        }
    };

    // ========== REMOVE USER ==========
    const handleRemoveUser = async (userId, role) => {
        if (!confirm(`Are you sure you want to remove this ${role}?`)) return;

        try {
            await db.collection('users').doc(userId).update({
                active: false,
                deactivatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                deactivatedBy: user.uid
            });

            await loadAllSettings();
            alert(`${role} removed successfully`);
        } catch (error) {
            console.error('Error removing user:', error);
            alert('Failed to remove user');
        }
    };

    // ========== ASSIGN COACH ==========
    const handleAssignCoach = async (pirId) => {
        const coachId = prompt('Enter coach ID to assign:');
        if (!coachId) return;

        try {
            await db.collection('users').doc(pirId).update({
                assignedCoach: coachId,
                assignedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            await loadAllSettings();
            alert('Coach assigned successfully');
        } catch (error) {
            console.error('Error assigning coach:', error);
            alert('Failed to assign coach');
        }
    };

    // ========== CHANGE COACH ==========
    const handleChangeCoach = async (pirId, currentCoachId) => {
        const newCoachId = prompt('Enter new coach ID:', currentCoachId);
        if (!newCoachId) return;

        try {
            await db.collection('users').doc(pirId).update({
                assignedCoach: newCoachId,
                coachChangedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            await loadAllSettings();
            alert('Coach changed successfully');
        } catch (error) {
            console.error('Error changing coach:', error);
            alert('Failed to change coach');
        }
    };

    // ========== UPDATE PERMISSIONS ==========
    const updatePermissions = async (userId, permissionType, value) => {
        try {
            const updatedPermissions = {
                ...permissions,
                [userId]: {
                    ...permissions[userId],
                    [permissionType]: value
                }
            };

            await db.collection('settings').doc('permissions').set(updatedPermissions);
            setPermissions(updatedPermissions);
            alert('Permissions updated');
        } catch (error) {
            console.error('Error updating permissions:', error);
            alert('Failed to update permissions');
        }
    };

    // ========== DATA EXPORT ==========
    const handleDataExport = async (format, scope, dataType) => {
        try {
            let data = {};

            if (scope === 'all') {
                const collections = ['users', 'checkIns', 'assignments', 'alerts', 'messages', 'goals', 'feedback', 'activities', 'notifications'];
                
                for (const collection of collections) {
                    const snapshot = await db.collection(collection).get();
                    data[collection] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }
            } else if (scope === 'specific_pir') {
                const pirId = prompt('Enter PIR ID:');
                if (!pirId) return;

                const pirDoc = await db.collection('users').doc(pirId).get();
                if (!pirDoc.exists) {
                    alert('PIR not found');
                    return;
                }

                data.pir = { id: pirDoc.id, ...pirDoc.data() };
                
                const [checkIns, assignments, goals, alerts, messages] = await Promise.all([
                    db.collection('checkIns').where('userId', '==', pirId).get(),
                    db.collection('assignments').where('userId', '==', pirId).get(),
                    db.collection('goals').where('userId', '==', pirId).get(),
                    db.collection('alerts').where('userId', '==', pirId).get(),
                    db.collection('messages').where('senderId', '==', pirId).get()
                ]);

                data.checkIns = checkIns.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                data.assignments = assignments.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                data.goals = goals.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                data.alerts = alerts.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                data.messages = messages.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } else if (scope === 'data_type') {
                const snapshot = await db.collection(dataType).get();
                data[dataType] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }

            const fileName = `glrs_export_${scope}_${new Date().toISOString().split('T')[0]}`;

            if (format === 'json') {
                exportToJSON(data, fileName);
            } else if (format === 'csv') {
                exportToCSV(data, fileName);
            } else if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text('Data Export', 20, 20);
                doc.text(JSON.stringify(data, null, 2).substring(0, 1000), 20, 30);
                doc.save(`${fileName}.pdf`);
            }

            alert('Export completed successfully');
        } catch (error) {
            console.error('Error exporting data:', error);
            alert('Export failed: ' + error.message);
        }
    };

    // ========== LOADING STATE ==========
    if (loading) {
        return (
            <div className="loading-container">
                <div className="loading-spinner"></div>
            </div>
        );
    }

    // ========== RETURN JSX ==========
    return (
        <div style={{ display: 'flex', gap: '20px', minHeight: '100vh' }}>
            {/* SIDEBAR NAVIGATION */}
            <div style={{
                width: '280px',
                background: 'linear-gradient(180deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.05) 100%)',
                borderRadius: '20px',
                padding: '30px 20px',
                backdropFilter: 'blur(10px)',
                border: '1px solid rgba(255,255,255,0.1)'
            }}>
                <h3 style={{ 
                    marginBottom: '30px', 
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    WebkitBackgroundClip: 'text',
                    WebkitTextFillColor: 'transparent',
                    fontSize: '24px',
                    fontWeight: 'bold'
                }}>Settings</h3>
                
                {[
                    { id: 'notifications', icon: 'üîî', label: 'Notifications' },
                    { id: 'checkins', icon: '‚úÖ', label: 'Check-ins' },
                    { id: 'alerts', icon: '‚ö†Ô∏è', label: 'Alert Thresholds' },
                    { id: 'dataExport', icon: 'üì•', label: 'Data Export' },
                    { id: 'userManagement', icon: 'üë•', label: 'User Management' },
                    { id: 'permissions', icon: 'üîê', label: 'Permissions' },
                    { id: 'integrations', icon: 'üîå', label: 'Integrations' },
                    { id: 'system', icon: '‚öôÔ∏è', label: 'System Config' }
                ].map(section => (
                    <div
                        key={section.id}
                        onClick={() => setActiveSection(section.id)}
                        style={{
                            padding: '16px 20px',
                            borderRadius: '12px',
                            cursor: 'pointer',
                            background: activeSection === section.id 
                                ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                                : 'transparent',
                            marginBottom: '8px',
                            transition: 'all 0.3s',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '12px',
                            transform: activeSection === section.id ? 'translateX(5px)' : 'translateX(0)',
                            boxShadow: activeSection === section.id ? '0 8px 16px rgba(102, 126, 234, 0.3)' : 'none'
                        }}
                    >
                        <span style={{ fontSize: '20px' }}>{section.icon}</span>
                        <span style={{ fontWeight: activeSection === section.id ? 'bold' : 'normal' }}>
                            {section.label}
                        </span>
                    </div>
                ))}
            </div>

            {/* MAIN CONTENT */}
            <div style={{ flex: 1 }}>
                {/* NOTIFICATIONS SECTION */}
                {activeSection === 'notifications' && (
                    <div className="table-container" style={{
                        background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%)',
                        border: '1px solid rgba(255,255,255,0.1)',
                        borderRadius: '20px',
                        padding: '30px'
                    }}>
                        <h3 style={{ 
                            marginBottom: '30px',
                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            fontSize: '28px'
                        }}>Notification Settings</h3>

                        <div style={{ marginBottom: '40px' }}>
                            <h4 style={{ marginBottom: '20px', color: '#667eea' }}>Email Notifications</h4>
                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="emailNotifications"
                                    checked={settings.emailNotifications}
                                    onChange={(e) => setSettings({...settings, emailNotifications: e.target.checked})}
                                />
                                <label htmlFor="emailNotifications">Enable Email Notifications</label>
                            </div>

                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="sosAlertEmail"
                                    checked={settings.sosAlertEmail}
                                    onChange={(e) => setSettings({...settings, sosAlertEmail: e.target.checked})}
                                />
                                <label htmlFor="sosAlertEmail">SOS Alert Emails</label>
                            </div>

                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="dailyDigest"
                                    checked={settings.dailyDigest}
                                    onChange={(e) => setSettings({...settings, dailyDigest: e.target.checked})}
                                />
                                <label htmlFor="dailyDigest">Daily Summary Digest</label>
                            </div>

                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="weeklyReport"
                                    checked={settings.weeklyReport}
                                    onChange={(e) => setSettings({...settings, weeklyReport: e.target.checked})}
                                />
                                <label htmlFor="weeklyReport">Weekly Report</label>
                            </div>

                            <div style={{
                                marginTop: '25px',
                                padding: '20px',
                                background: 'linear-gradient(135deg, rgba(255,193,7,0.1) 0%, rgba(255,152,0,0.1) 100%)',
                                borderRadius: '12px',
                                border: '1px solid rgba(255,193,7,0.3)'
                            }}>
                                <h5 style={{ color: '#FFC107', marginBottom: '10px' }}>üöß Coming Soon: Gmail Integration</h5>
                                <p style={{ fontSize: '0.9em', color: '#ccc', margin: 0 }}>
                                    Connect your Gmail account to send notifications directly from your email.
                                </p>
                            </div>

                            <div style={{
                                marginTop: '15px',
                                padding: '20px',
                                background: 'linear-gradient(135deg, rgba(255,193,7,0.1) 0%, rgba(255,152,0,0.1) 100%)',
                                borderRadius: '12px',
                                border: '1px solid rgba(255,193,7,0.3)'
                            }}>
                                <h5 style={{ color: '#FFC107', marginBottom: '10px' }}>üöß Coming Soon: Google Calendar Integration</h5>
                                <p style={{ fontSize: '0.9em', color: '#ccc', margin: 0 }}>
                                    Sync sessions and reminders with Google Calendar.
                                </p>
                            </div>

                            <div style={{
                                marginTop: '15px',
                                padding: '20px',
                                background: 'linear-gradient(135deg, rgba(255,193,7,0.1) 0%, rgba(255,152,0,0.1) 100%)',
                                borderRadius: '12px',
                                border: '1px solid rgba(255,193,7,0.3)'
                            }}>
                                <h5 style={{ color: '#FFC107', marginBottom: '10px' }}>üöß Coming Soon: Google Drive Integration</h5>
                                <p style={{ fontSize: '0.9em', color: '#ccc', margin: 0 }}>
                                    Automatically backup reports and documents to Google Drive.
                                </p>
                            </div>
                        </div>

                        <div style={{ marginBottom: '40px' }}>
                            <h4 style={{ marginBottom: '20px', color: '#667eea' }}>SMS Notifications</h4>
                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="smsNotifications"
                                    checked={settings.smsNotifications}
                                    onChange={(e) => setSettings({...settings, smsNotifications: e.target.checked})}
                                />
                                <label htmlFor="smsNotifications">Enable SMS Notifications</label>
                            </div>

                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="sosAlertSMS"
                                    checked={settings.sosAlertSMS}
                                    onChange={(e) => setSettings({...settings, sosAlertSMS: e.target.checked})}
                                />
                                <label htmlFor="sosAlertSMS">SOS Alert SMS</label>
                            </div>

                            <div style={{
                                marginTop: '25px',
                                padding: '20px',
                                background: 'linear-gradient(135deg, rgba(255,193,7,0.1) 0%, rgba(255,152,0,0.1) 100%)',
                                borderRadius: '12px',
                                border: '1px solid rgba(255,193,7,0.3)'
                            }}>
                                <h5 style={{ color: '#FFC107', marginBottom: '10px' }}>üöß Coming Soon: Phone Number Setup</h5>
                                <p style={{ fontSize: '0.9em', color: '#ccc', margin: 0 }}>
                                    Add and verify phone numbers for SMS notifications.
                                </p>
                            </div>

                            <div style={{
                                marginTop: '15px',
                                padding: '20px',
                                background: 'linear-gradient(135deg, rgba(255,193,7,0.1) 0%, rgba(255,152,0,0.1) 100%)',
                                borderRadius: '12px',
                                border: '1px solid rgba(255,193,7,0.3)'
                            }}>
                                <h5 style={{ color: '#FFC107', marginBottom: '10px' }}>üöß Coming Soon: Twilio SMS Integration</h5>
                                <p style={{ fontSize: '0.9em', color: '#ccc', margin: 0 }}>
                                    Configure Twilio for SMS delivery.
                                </p>
                            </div>
                        </div>

                        <div style={{
                            marginTop: '25px',
                            padding: '20px',
                            background: 'linear-gradient(135deg, rgba(255,193,7,0.1) 0%, rgba(255,152,0,0.1) 100%)',
                            borderRadius: '12px',
                            border: '1px solid rgba(255,193,7,0.3)'
                        }}>
                            <h5 style={{ color: '#FFC107', marginBottom: '10px' }}>üöß Coming Soon: Two-Factor Authentication</h5>
                            <p style={{ fontSize: '0.9em', color: '#ccc', margin: 0 }}>
                                Enable 2FA for enhanced security.
                            </p>
                        </div>

                        <button className="btn btn-primary" onClick={saveSettings} disabled={saving} style={{ 
                            marginTop: '30px',
                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            border: 'none',
                            padding: '14px 32px',
                            fontSize: '16px',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            transition: 'transform 0.2s',
                            boxShadow: '0 4px 15px rgba(102, 126, 234, 0.4)'
                        }}>
                            {saving ? 'Saving...' : 'Save Notification Settings'}
                        </button>
                    </div>
                )}

                {/* CHECK-IN SETTINGS */}
                {activeSection === 'checkins' && (
                    <div className="table-container" style={{
                        background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%)',
                        border: '1px solid rgba(255,255,255,0.1)',
                        borderRadius: '20px',
                        padding: '30px'
                    }}>
                        <h3 style={{ 
                            marginBottom: '30px',
                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            fontSize: '28px'
                        }}>Check-in Settings</h3>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#667eea', fontWeight: 'bold' }}>Morning Check-in Reminder Time</label>
                            <input
                                type="time"
                                className="form-input"
                                value={settings.checkInReminderTime}
                                onChange={(e) => setSettings({...settings, checkInReminderTime: e.target.value})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%'
                                }}
                            />
                        </div>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#667eea', fontWeight: 'bold' }}>Evening Reflection Reminder Time</label>
                            <input
                                type="time"
                                className="form-input"
                                value={settings.eveningReminderTime}
                                onChange={(e) => setSettings({...settings, eveningReminderTime: e.target.value})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%'
                                }}
                            />
                        </div>

                        <div className="checkbox-group">
                            <input
                                type="checkbox"
                                id="missedCheckInAlert"
                                checked={settings.missedCheckInAlert}
                                onChange={(e) => setSettings({...settings, missedCheckInAlert: e.target.checked})}
                            />
                            <label htmlFor="missedCheckInAlert">Alert on Missed Check-ins</label>
                        </div>

                        <button className="btn btn-primary" onClick={saveSettings} disabled={saving} style={{ 
                            marginTop: '30px',
                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            border: 'none',
                            padding: '14px 32px',
                            fontSize: '16px',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            transition: 'transform 0.2s',
                            boxShadow: '0 4px 15px rgba(102, 126, 234, 0.4)'
                        }}>
                            {saving ? 'Saving...' : 'Save Check-in Settings'}
                        </button>
                    </div>
                )}

                {/* ALERT THRESHOLDS */}
                {activeSection === 'alerts' && (
                    <div className="table-container" style={{
                        background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%)',
                        border: '1px solid rgba(255,255,255,0.1)',
                        borderRadius: '20px',
                        padding: '30px'
                    }}>
                        <h3 style={{ 
                            marginBottom: '30px',
                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            fontSize: '28px'
                        }}>Alert Thresholds</h3>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#667eea', fontWeight: 'bold' }}>Low Mood Threshold (1-10)</label>
                            <input
                                type="number"
                                className="form-input"
                                min="1"
                                max="10"
                                value={settings.lowMoodThreshold}
                                onChange={(e) => setSettings({...settings, lowMoodThreshold: parseInt(e.target.value)})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%'
                                }}
                            />
                            <small style={{ color: '#999', marginTop: '5px', display: 'block' }}>Alert when mood is at or below this value</small>
                        </div>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#667eea', fontWeight: 'bold' }}>High Craving Threshold (1-10)</label>
                            <input
                                type="number"
                                className="form-input"
                                min="1"
                                max="10"
                                value={settings.highCravingThreshold}
                                onChange={(e) => setSettings({...settings, highCravingThreshold: parseInt(e.target.value)})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%'
                                }}
                            />
                            <small style={{ color: '#999', marginTop: '5px', display: 'block' }}>Alert when cravings are at or above this value</small>
                        </div>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#667eea', fontWeight: 'bold' }}>High Anxiety Threshold (1-10)</label>
                            <input
                                type="number"
                                className="form-input"
                                min="1"
                                max="10"
                                value={settings.highAnxietyThreshold}
                                onChange={(e) => setSettings({...settings, highAnxietyThreshold: parseInt(e.target.value)})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%'
                                }}
                            />
                            <small style={{ color: '#999', marginTop: '5px', display: 'block' }}>Alert when anxiety is at or above this value</small>
                        </div>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#667eea', fontWeight: 'bold' }}>Poor Sleep Threshold (1-10)</label>
                            <input
                                type="number"
                                className="form-input"
                                min="1"
                                max="10"
                                value={settings.poorSleepThreshold}
                                onChange={(e) => setSettings({...settings, poorSleepThreshold: parseInt(e.target.value)})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%'
                                }}
                            />
                            <small style={{ color: '#999', marginTop: '5px', display: 'block' }}>Alert when sleep quality is at or below this value</small>
                        </div>

                        <button className="btn btn-primary" onClick={saveSettings} disabled={saving} style={{ 
                            marginTop: '30px',
                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            border: 'none',
                            padding: '14px 32px',
                            fontSize: '16px',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            transition: 'transform 0.2s',
                            boxShadow: '0 4px 15px rgba(102, 126, 234, 0.4)'
                        }}>
                            {saving ? 'Saving...' : 'Save Alert Settings'}
                        </button>
                    </div>
                )}

                {/* DATA EXPORT */}
                {activeSection === 'dataExport' && (
                    <div className="table-container" style={{
                        background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%)',
                        border: '1px solid rgba(255,255,255,0.1)',
                        borderRadius: '20px',
                        padding: '30px'
                    }}>
                        <h3 style={{ 
                            marginBottom: '30px',
                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            fontSize: '28px'
                        }}>Data Export</h3>

                        <div style={{ marginBottom: '40px' }}>
                            <h4 style={{ marginBottom: '20px', color: '#667eea' }}>Export All User Data</h4>
                            <div style={{ display: 'flex', gap: '15px', flexWrap: 'wrap' }}>
                                <button className="btn btn-secondary" onClick={() => handleDataExport('json', 'all')} style={{
                                    background: 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)',
                                    border: 'none',
                                    padding: '12px 24px',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    transition: 'transform 0.2s'
                                }}>
                                    üìÑ Export as JSON
                                </button>
                                <button className="btn btn-secondary" onClick={() => handleDataExport('csv', 'all')} style={{
                                    background: 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)',
                                    border: 'none',
                                    padding: '12px 24px',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    transition: 'transform 0.2s'
                                }}>
                                    üìä Export as Spreadsheet
                                </button>
                                <button className="btn btn-secondary" onClick={() => handleDataExport('pdf', 'all')} style={{
                                    background: 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)',
                                    border: 'none',
                                    padding: '12px 24px',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    transition: 'transform 0.2s'
                                }}>
                                    üìë Export as PDF
                                </button>
                            </div>
                        </div>

                        <div style={{ marginBottom: '40px' }}>
                            <h4 style={{ marginBottom: '20px', color: '#667eea' }}>Export Specific PIR Data</h4>
                            <div style={{ display: 'flex', gap: '15px', flexWrap: 'wrap' }}>
                                <button className="btn btn-secondary" onClick={() => handleDataExport('json', 'specific_pir')} style={{
                                    background: 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)',
                                    border: 'none',
                                    padding: '12px 24px',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    transition: 'transform 0.2s'
                                }}>
                                    üìÑ Export as JSON
                                </button>
                                <button className="btn btn-secondary" onClick={() => handleDataExport('csv', 'specific_pir')} style={{
                                    background: 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)',
                                    border: 'none',
                                    padding: '12px 24px',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    transition: 'transform 0.2s'
                                }}>
                                    üìä Export as Spreadsheet
                                </button>
                                <button className="btn btn-secondary" onClick={() => handleDataExport('pdf', 'specific_pir')} style={{
                                    background: 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)',
                                    border: 'none',
                                    padding: '12px 24px',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    transition: 'transform 0.2s'
                                }}>
                                    üìë Export as PDF
                                </button>
                            </div>
                        </div>

                        <div style={{ marginBottom: '40px' }}>
                            <h4 style={{ marginBottom: '20px', color: '#667eea' }}>Export by Data Type</h4>
                            <select 
                                className="form-input" 
                                onChange={(e) => {
                                    if (e.target.value) {
                                        const format = prompt('Export format? (json/csv/pdf)');
                                        if (format) handleDataExport(format, 'data_type', e.target.value);
                                    }
                                }}
                                defaultValue=""
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%',
                                    cursor: 'pointer'
                                }}
                            >
                                <option value="">Select data type...</option>
                                <option value="checkIns">Check-ins</option>
                                <option value="messages">Messages</option>
                                <option value="assignments">Assignments</option>
                                <option value="goals">Goals</option>
                                <option value="alerts">Alerts</option>
                                <option value="feedback">Feedback</option>
                                <option value="activities">Activities</option>
                                <option value="notifications">Notifications</option>
                            </select>
                        </div>

                        <div style={{ marginTop: '40px' }}>
                            <h4 style={{ marginBottom: '20px', color: '#667eea' }}>Automated Exports</h4>
                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="autoBackup"
                                    checked={settings.autoBackupEnabled}
                                    onChange={(e) => setSettings({...settings, autoBackupEnabled: e.target.checked})}
                                />
                                <label htmlFor="autoBackup">Enable Automatic Backups</label>
                            </div>

                            <div className="form-group" style={{ marginTop: '20px' }}>
                                <label className="form-label" style={{ color: '#667eea', fontWeight: 'bold' }}>Backup Frequency</label>
                                <select
                                    className="form-input"
                                    value={settings.backupFrequency}
                                    onChange={(e) => setSettings({...settings, backupFrequency: e.target.value})}
                                    style={{
                                        background: 'rgba(255,255,255,0.05)',
                                        border: '1px solid rgba(255,255,255,0.1)',
                                        borderRadius: '8px',
                                        padding: '12px',
                                        color: '#fff',
                                        width: '100%',
                                        cursor: 'pointer'
                                    }}
                                >
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>

                            <button className="btn btn-primary" onClick={saveSettings} disabled={saving} style={{ 
                                marginTop: '30px',
                                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                border: 'none',
                                padding: '14px 32px',
                                fontSize: '16px',
                                borderRadius: '10px',
                                cursor: 'pointer',
                                transition: 'transform 0.2s',
                                boxShadow: '0 4px 15px rgba(102, 126, 234, 0.4)'
                            }}>
                                {saving ? 'Saving...' : 'Save Export Settings'}
                            </button>
                        </div>
                    </div>
                )}

                {/* USER MANAGEMENT */}
                {activeSection === 'userManagement' && (
                    <div className="table-container" style={{
                        background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%)',
                        border: '1px solid rgba(255,255,255,0.1)',
                        borderRadius: '20px',
                        padding: '30px'
                    }}>
                        <h3 style={{ 
                            marginBottom: '30px',
                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            fontSize: '28px'
                        }}>User Management</h3>

                        <div style={{ marginBottom: '40px' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                                <h4 style={{ color: '#667eea' }}>Coaches ({coaches.filter(c => c.active !== false).length})</h4>
                                <button className="btn btn-primary" onClick={handleAddCoach} style={{
                                    background: 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)',
                                    border: 'none',
                                    padding: '10px 20px',
                                    borderRadius: '8px',
                                    cursor: 'pointer'
                                }}>+ Add Coach</button>
                            </div>

                            <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                <thead>
                                    <tr style={{ borderBottom: '2px solid rgba(102, 126, 234, 0.3)' }}>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#667eea' }}>Name</th>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#667eea' }}>Email</th>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#667eea' }}>Assigned PIRs</th>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#667eea' }}>Status</th>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#667eea' }}>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {coaches.map(coach => (
                                        <tr key={coach.id} style={{ borderBottom: '1px solid rgba(255,255,255,0.1)' }}>
                                            <td style={{ padding: '15px' }}>{coach.displayName}</td>
                                            <td style={{ padding: '15px' }}>{coach.email}</td>
                                            <td style={{ padding: '15px' }}>{pirs.filter(p => p.assignedCoach === coach.id).length}</td>
                                            <td style={{ padding: '15px' }}>
                                                <span className={`badge ${coach.active !== false ? 'badge-success' : 'badge-danger'}`} style={{
                                                    padding: '6px 12px',
                                                    borderRadius: '6px',
                                                    fontSize: '0.85em',
                                                    background: coach.active !== false ? 'linear-gradient(135deg, #4CAF50, #45a049)' : 'linear-gradient(135deg, #f44336, #d32f2f)'
                                                }}>
                                                    {coach.active !== false ? 'Active' : 'Inactive'}
                                                </span>
                                            </td>
                                            <td style={{ padding: '15px' }}>
                                                <button 
                                                    className="action-btn"
                                                    onClick={() => handleRemoveUser(coach.id, 'coach')}
                                                    style={{
                                                        background: 'linear-gradient(135deg, #f44336, #d32f2f)',
                                                        border: 'none',
                                                        padding: '8px 16px',
                                                        borderRadius: '6px',
                                                        cursor: 'pointer',
                                                        color: '#fff'
                                                    }}
                                                >
                                                    Remove
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        <div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                                <h4 style={{ color: '#667eea' }}>PIRs ({pirs.filter(p => p.active !== false).length})</h4>
                                <button className="btn btn-primary" onClick={handleAddPIR} style={{
                                    background: 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)',
                                    border: 'none',
                                    padding: '10px 20px',
                                    borderRadius: '8px',
                                    cursor: 'pointer'
                                }}>+ Add PIR</button>
                            </div>

                            <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                <thead>
                                    <tr style={{ borderBottom: '2px solid rgba(102, 126, 234, 0.3)' }}>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#667eea' }}>Name</th>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#667eea' }}>Email</th>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#667eea' }}>Assigned Coach</th>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#667eea' }}>Status</th>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#667eea' }}>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {pirs.map(pir => {
                                        const assignedCoach = coaches.find(c => c.id === pir.assignedCoach);
                                        return (
                                            <tr key={pir.id} style={{ borderBottom: '1px solid rgba(255,255,255,0.1)' }}>
                                                <td style={{ padding: '15px' }}>{pir.displayName}</td>
                                                <td style={{ padding: '15px' }}>{pir.email}</td>
                                                <td style={{ padding: '15px' }}>
                                                    {assignedCoach ? assignedCoach.displayName : 'Unassigned'}
                                                </td>
                                                <td style={{ padding: '15px' }}>
                                                    <span className={`badge ${pir.active !== false ? 'badge-success' : 'badge-danger'}`} style={{
                                                        padding: '6px 12px',
                                                        borderRadius: '6px',
                                                        fontSize: '0.85em',
                                                        background: pir.active !== false ? 'linear-gradient(135deg, #4CAF50, #45a049)' : 'linear-gradient(135deg, #f44336, #d32f2f)'
                                                    }}>
                                                        {pir.active !== false ? 'Active' : 'Inactive'}
                                                    </span>
                                                </td>
                                                <td style={{ padding: '15px' }}>
                                                    <div style={{ display: 'flex', gap: '8px' }}>
                                                        {!pir.assignedCoach ? (
                                                            <button 
                                                                className="action-btn"
                                                                onClick={() => handleAssignCoach(pir.id)}
                                                                style={{
                                                                    background: 'linear-gradient(135deg, #2196F3, #1976D2)',
                                                                    border: 'none',
                                                                    padding: '8px 16px',
                                                                    borderRadius: '6px',
                                                                    cursor: 'pointer',
                                                                    color: '#fff'
                                                                }}
                                                            >
                                                                Assign Coach
                                                            </button>
                                                        ) : (
                                                            <button 
                                                                className="action-btn"
                                                                onClick={() => handleChangeCoach(pir.id, pir.assignedCoach)}
                                                                style={{
                                                                    background: 'linear-gradient(135deg, #FF9800, #F57C00)',
                                                                    border: 'none',
                                                                    padding: '8px 16px',
                                                                    borderRadius: '6px',
                                                                    cursor: 'pointer',
                                                                    color: '#fff'
                                                                }}
                                                            >
                                                                Change Coach
                                                            </button>
                                                        )}
                                                        <button 
                                                            className="action-btn"
                                                            onClick={() => handleRemoveUser(pir.id, 'pir')}
                                                            style={{
                                                                background: 'linear-gradient(135deg, #f44336, #d32f2f)',
                                                                border: 'none',
                                                                padding: '8px 16px',
                                                                borderRadius: '6px',
                                                                cursor: 'pointer',
                                                                color: '#fff'
                                                            }}
                                                        >
                                                            Remove
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )}

                {/* PERMISSIONS */}
                {activeSection === 'permissions' && (
                    <div className="table-container" style={{
                        background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%)',
                        border: '1px solid rgba(255,255,255,0.1)',
                        borderRadius: '20px',
                        padding: '30px'
                    }}>
                        <h3 style={{ 
                            marginBottom: '30px',
                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            fontSize: '28px'
                        }}>Permission Levels</h3>

                        <div style={{ 
                            marginBottom: '40px',
                            padding: '25px',
                            background: 'linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(67, 160, 71, 0.1) 100%)',
                            borderRadius: '12px',
                            border: '1px solid rgba(76, 175, 80, 0.3)'
                        }}>
                            <h4 style={{ color: '#4CAF50', marginBottom: '15px' }}>Admin Permissions</h4>
                            <p style={{ color: '#ccc', fontSize: '0.95em', marginBottom: '15px' }}>
                                Admins have full system access including:
                            </p>
                            <ul style={{ color: '#ccc', lineHeight: '1.8', paddingLeft: '25px' }}>
                                <li>Full access to all PIR data</li>
                                <li>Create/edit/delete users (PIRs, coaches, admins)</li>
                                <li>Assign and reassign PIRs to coaches</li>
                                <li>Access all reports and analytics</li>
                                <li>Modify system settings</li>
                                <li>Manage resources and assignments</li>
                                <li>Export all data</li>
                                <li>Can function as coaches (assigned PIRs)</li>
                            </ul>
                        </div>

                        <div style={{ 
                            marginBottom: '40px',
                            padding: '25px',
                            background: 'linear-gradient(135deg, rgba(33, 150, 243, 0.1) 0%, rgba(25, 118, 210, 0.1) 100%)',
                            borderRadius: '12px',
                            border: '1px solid rgba(33, 150, 243, 0.3)'
                        }}>
                            <h4 style={{ color: '#2196F3', marginBottom: '15px' }}>Coach Permissions</h4>
                            <p style={{ color: '#ccc', fontSize: '0.95em', marginBottom: '15px' }}>
                                Coaches have limited access to only their assigned PIRs:
                            </p>
                            <ul style={{ color: '#ccc', lineHeight: '1.8', paddingLeft: '25px' }}>
                                <li>View and manage only assigned PIRs</li>
                                <li>Create assignments for assigned PIRs</li>
                                <li>View check-ins and alerts for assigned PIRs</li>
                                <li>Message assigned PIRs</li>
                                <li>Generate reports for assigned PIRs only</li>
                                <li>Cannot access system settings</li>
                                <li>Cannot create/delete users</li>
                                <li>Cannot export global data</li>
                            </ul>
                        </div>

                        <div>
                            <h4 style={{ marginBottom: '20px', color: '#667eea' }}>Custom Permissions (Individual Override)</h4>
                            <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                <thead>
                                    <tr style={{ borderBottom: '2px solid rgba(102, 126, 234, 0.3)' }}>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#667eea' }}>User</th>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#667eea' }}>Role</th>
                                        <th style={{ padding: '15px', textAlign: 'center', color: '#667eea' }}>Create Assignments</th>
                                        <th style={{ padding: '15px', textAlign: 'center', color: '#667eea' }}>Delete Data</th>
                                        <th style={{ padding: '15px', textAlign: 'center', color: '#667eea' }}>Export Data</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {coaches.map(coach => (
                                        <tr key={coach.id} style={{ borderBottom: '1px solid rgba(255,255,255,0.1)' }}>
                                            <td style={{ padding: '15px' }}>{coach.displayName}</td>
                                            <td style={{ padding: '15px' }}>
                                                <span style={{
                                                    padding: '4px 12px',
                                                    borderRadius: '6px',
                                                    fontSize: '0.85em',
                                                    background: coach.role === 'admin' ? 'linear-gradient(135deg, #4CAF50, #45a049)' : 'linear-gradient(135deg, #2196F3, #1976D2)'
                                                }}>
                                                    {coach.role}
                                                </span>
                                            </td>
                                            <td style={{ padding: '15px', textAlign: 'center' }}>
                                                <input
                                                    type="checkbox"
                                                    checked={permissions[coach.id]?.canCreateAssignments !== false}
                                                    onChange={(e) => updatePermissions(coach.id, 'canCreateAssignments', e.target.checked)}
                                                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                                />
                                            </td>
                                            <td style={{ padding: '15px', textAlign: 'center' }}>
                                                <input
                                                    type="checkbox"
                                                    checked={permissions[coach.id]?.canDelete === true}
                                                    onChange={(e) => updatePermissions(coach.id, 'canDelete', e.target.checked)}
                                                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                                />
                                            </td>
                                            <td style={{ padding: '15px', textAlign: 'center' }}>
                                                <input
                                                    type="checkbox"
                                                    checked={permissions[coach.id]?.canExport === true}
                                                    onChange={(e) => updatePermissions(coach.id, 'canExport', e.target.checked)}
                                                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                                />
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )}

                {/* INTEGRATIONS */}
                {activeSection === 'integrations' && (
                    <div className="table-container" style={{
                        background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%)',
                        border: '1px solid rgba(255,255,255,0.1)',
                        borderRadius: '20px',
                        padding: '30px'
                    }}>
                        <h3 style={{ 
                            marginBottom: '30px',
                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            fontSize: '28px'
                        }}>Integrations</h3>

                        <div style={{
                            padding: '25px',
                            background: 'linear-gradient(135deg, rgba(255,193,7,0.1) 0%, rgba(255,152,0,0.1) 100%)',
                            borderRadius: '12px',
                            border: '1px solid rgba(255,193,7,0.3)',
                            marginBottom: '20px'
                        }}>
                            <h4 style={{ color: '#FFC107', marginBottom: '15px' }}>üöß Coming Soon: Carepatron Webhook</h4>
                            <p style={{ color: '#ccc', margin: 0 }}>
                                Automatically sync session data with Carepatron practice management system.
                            </p>
                        </div>

                        <div style={{
                            padding: '25px',
                            background: 'linear-gradient(135deg, rgba(255,193,7,0.1) 0%, rgba(255,152,0,0.1) 100%)',
                            borderRadius: '12px',
                            border: '1px solid rgba(255,193,7,0.3)',
                            marginBottom: '20px'
                        }}>
                            <h4 style={{ color: '#FFC107', marginBottom: '15px' }}>üöß Coming Soon: Google Calendar Sync</h4>
                            <p style={{ color: '#ccc', margin: 0 }}>
                                Two-way sync of sessions, meetings, and reminders with Google Calendar.
                            </p>
                        </div>

                        <div style={{
                            padding: '25px',
                            background: 'linear-gradient(135deg, rgba(255,193,7,0.1) 0%, rgba(255,152,0,0.1) 100%)',
                            borderRadius: '12px',
                            border: '1px solid rgba(255,193,7,0.3)',
                            marginBottom: '20px'
                        }}>
                            <h4 style={{ color: '#FFC107', marginBottom: '15px' }}>üöß Coming Soon: Email Service Provider</h4>
                            <p style={{ color: '#ccc', margin: 0 }}>
                                Configure SendGrid or Mailgun for professional email delivery.
                            </p>
                        </div>

                        <div style={{
                            padding: '25px',
                            background: 'linear-gradient(135deg, rgba(255,193,7,0.1) 0%, rgba(255,152,0,0.1) 100%)',
                            borderRadius: '12px',
                            border: '1px solid rgba(255,193,7,0.3)',
                            marginBottom: '20px'
                        }}>
                            <h4 style={{ color: '#FFC107', marginBottom: '15px' }}>üöß Coming Soon: SMS Provider (Twilio)</h4>
                            <p style={{ color: '#ccc', margin: 0 }}>
                                Set up Twilio for SMS notifications and two-way messaging.
                            </p>
                        </div>

                        <div style={{
                            padding: '25px',
                            background: 'linear-gradient(135deg, rgba(255,193,7,0.1) 0%, rgba(255,152,0,0.1) 100%)',
                            borderRadius: '12px',
                            border: '1px solid rgba(255,193,7,0.3)'
                        }}>
                            <h4 style={{ color: '#FFC107', marginBottom: '15px' }}>üöß Coming Soon: Zapier Integration</h4>
                            <p style={{ color: '#ccc', margin: 0 }}>
                                Connect to 3000+ apps via Zapier for custom automation workflows.
                            </p>
                        </div>
                    </div>
                )}

                {/* SYSTEM CONFIGURATION */}
                {activeSection === 'system' && (
                    <div className="table-container" style={{
                        background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%)',
                        border: '1px solid rgba(255,255,255,0.1)',
                        borderRadius: '20px',
                        padding: '30px'
                    }}>
                        <h3 style={{ 
                            marginBottom: '30px',
                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            fontSize: '28px'
                        }}>System Configuration</h3>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#667eea', fontWeight: 'bold' }}>Timezone</label>
                            <select
                                className="form-input"
                                value={settings.timezone}
                                onChange={(e) => setSettings({...settings, timezone: e.target.value})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%',
                                    cursor: 'pointer'
                                }}
                            >
                                <option value="America/Los_Angeles">Pacific Time (PT)</option>
                                <option value="America/Denver">Mountain Time (MT)</option>
                                <option value="America/Chicago">Central Time (CT)</option>
                                <option value="America/New_York">Eastern Time (ET)</option>
                                <option value="America/Phoenix">Arizona (MST)</option>
                                <option value="America/Anchorage">Alaska (AKT)</option>
                                <option value="Pacific/Honolulu">Hawaii (HST)</option>
                            </select>
                        </div>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#667eea', fontWeight: 'bold' }}>Date Format</label>
                            <select
                                className="form-input"
                                value={settings.dateFormat}
                                onChange={(e) => setSettings({...settings, dateFormat: e.target.value})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%',
                                    cursor: 'pointer'
                                }}
                            >
                                <option value="MM/DD/YYYY">MM/DD/YYYY (US)</option>
                                <option value="DD/MM/YYYY">DD/MM/YYYY (International)</option>
                                <option value="YYYY-MM-DD">YYYY-MM-DD (ISO)</option>
                            </select>
                        </div>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#667eea', fontWeight: 'bold' }}>Time Format</label>
                            <select
                                className="form-input"
                                value={settings.timeFormat}
                                onChange={(e) => setSettings({...settings, timeFormat: e.target.value})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%',
                                    cursor: 'pointer'
                                }}
                            >
                                <option value="12h">12-hour (AM/PM)</option>
                                <option value="24h">24-hour</option>
                            </select>
                        </div>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#667eea', fontWeight: 'bold' }}>Language</label>
                            <select
                                className="form-input"
                                value={settings.language}
                                onChange={(e) => setSettings({...settings, language: e.target.value})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%',
                                    cursor: 'pointer'
                                }}
                            >
                                <option value="en">English</option>
                                <option value="es">Spanish (Coming Soon)</option>
                                <option value="fr">French (Coming Soon)</option>
                            </select>
                        </div>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#667eea', fontWeight: 'bold' }}>Auto-Refresh Interval</label>
                            <select
                                className="form-input"
                                value={settings.autoRefresh}
                                onChange={(e) => setSettings({...settings, autoRefresh: parseInt(e.target.value)})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%',
                                    cursor: 'pointer'
                                }}
                            >
                                <option value="0">Manual Only</option>
                                <option value="30">30 seconds</option>
                                <option value="60">1 minute</option>
                                <option value="300">5 minutes</option>
                                <option value="600">10 minutes</option>
                            </select>
                        </div>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#667eea', fontWeight: 'bold' }}>Data Retention (days)</label>
                            <input
                                type="number"
                                className="form-input"
                                min="90"
                                max="2555"
                                value={settings.dataRetentionDays}
                                onChange={(e) => setSettings({...settings, dataRetentionDays: parseInt(e.target.value)})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%'
                                }}
                            />
                            <small style={{ color: '#999', marginTop: '5px', display: 'block' }}>Minimum 90 days, maximum 7 years (2555 days) for HIPAA compliance</small>
                        </div>

                        <button className="btn btn-primary" onClick={saveSettings} disabled={saving} style={{ 
                            marginTop: '30px',
                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            border: 'none',
                            padding: '14px 32px',
                            fontSize: '16px',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            transition: 'transform 0.2s',
                            boxShadow: '0 4px 15px rgba(102, 126, 234, 0.4)'
                        }}>
                            {saving ? 'Saving...' : 'Save System Settings'}
                        </button>
                    </div>
                )}
            </div>
        </div>
    );
}

     
    
// ENHANCED CreateUserModal
function CreateUserModal({ onClose, onSuccess, defaultRole }) {
    const [formData, setFormData] = useState({
        email: '',
        password: 'TempPassword123!',
        firstName: '',
        lastName: '',
        role: defaultRole || 'pir',
        assignedCoach: '',
        phone: '',
        sobrietyDate: ''
    });
    const [coachesList, setCoachesList] = useState([]);
    const [loading, setLoading] = useState(false);
    const [emailValid, setEmailValid] = useState(null);
    const [step, setStep] = useState(1);

    useEffect(() => {
        loadCoaches();
    }, []);

    const loadCoaches = async () => {
        const coachesSnap = await db.collection('users')
            .where('role', '==', 'coach')
            .get();
        
        const coachesData = [];
        coachesSnap.forEach(doc => {
            coachesData.push({ id: doc.id, ...doc.data() });
        });
        setCoachesList(coachesData);
    };

    const validateEmail = (email) => {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    };

    const handleEmailChange = (email) => {
        setFormData({...formData, email});
        if (email.length > 0) {
            setEmailValid(validateEmail(email));
        } else {
            setEmailValid(null);
        }
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        
        if (!validateEmail(formData.email)) {
            alert('Please enter a valid email address');
            return;
        }
        
        setLoading(true);
        
        let secondaryApp;
        try {
            try {
                secondaryApp = firebase.app('SecondaryApp');
                await secondaryApp.delete();
            } catch (e) {
                // App doesn't exist
            }
            
            secondaryApp = firebase.initializeApp(firebaseConfig, 'SecondaryApp');
            const secondaryAuth = secondaryApp.auth();
            
            const userCredential = await secondaryAuth.createUserWithEmailAndPassword(
                formData.email,
                formData.password
            );
            
            const userData = {
                email: formData.email,
                displayName: `${formData.firstName} ${formData.lastName}`,
                firstName: formData.firstName,
                lastName: formData.lastName,
                phone: formData.phone,
                role: formData.role,
                active: true,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            if (formData.role === 'pir') {
                if (formData.assignedCoach) {
                    userData.assignedCoach = formData.assignedCoach;
                    const coach = coachesList.find(c => c.id === formData.assignedCoach);
                    if (coach) {
                        userData.assignedCoachName = coach.displayName || coach.email;
                    }
                }
                if (formData.sobrietyDate) {
                    userData.sobrietyDate = firebase.firestore.Timestamp.fromDate(new Date(formData.sobrietyDate));
                }
            }
            
            await db.collection('users').doc(userCredential.user.uid).set(userData);
            await auth.sendPasswordResetEmail(formData.email);
            
            await db.collection('notifications').add({
                type: 'user-created',
                message: `New ${formData.role} created: ${userData.displayName}`,
                recipientId: auth.currentUser.uid,
                relatedId: userCredential.user.uid,
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await secondaryApp.delete();
            
            alert('User created successfully! Password reset email sent.');
            onSuccess();
        } catch (error) {
            console.error('Error creating user:', error);
            alert('Error creating user: ' + error.message);
            
            if (secondaryApp) {
                try {
                    await secondaryApp.delete();
                } catch (e) {
                    // Ignore
                }
            }
        } finally {
            setLoading(false);
        }
    };

    const getRoleColor = (role) => {
        if (role === 'pir') return 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        if (role === 'coach') return 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
        return 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';
    };

    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000,
            padding: '20px',
            animation: 'fadeIn 0.2s'
        }}>
            <div style={{
                background: 'white',
                borderRadius: '20px',
                maxWidth: '600px',
                width: '100%',
                maxHeight: '90vh',
                overflow: 'auto',
                boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
                animation: 'slideUp 0.3s'
            }}>
                {/* Header */}
                <div style={{
                    background: getRoleColor(formData.role),
                    padding: '25px 30px',
                    borderRadius: '20px 20px 0 0',
                    color: 'white',
                    position: 'sticky',
                    top: 0,
                    zIndex: 1
                }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div>
                            <h2 style={{ margin: '0 0 5px 0', fontSize: '24px' }}>Create New User</h2>
                            <div style={{ fontSize: '14px', opacity: 0.9 }}>
                                Step {step} of 2
                            </div>
                        </div>
                        <button 
                            onClick={onClose}
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                border: 'none',
                                color: 'white',
                                fontSize: '24px',
                                width: '36px',
                                height: '36px',
                                borderRadius: '50%',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                transition: 'background 0.2s'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.3)'}
                            onMouseLeave={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.2)'}
                        >
                            √ó
                        </button>
                    </div>
                </div>

                {/* Content */}
                <form onSubmit={handleSubmit} style={{ padding: '30px' }}>
                    {step === 1 && (
                        <>
                            {/* Role Selection */}
                            <div style={{ marginBottom: '25px' }}>
                                <label style={{ 
                                    display: 'block', 
                                    fontSize: '14px', 
                                    fontWeight: '600', 
                                    color: '#333', 
                                    marginBottom: '10px' 
                                }}>
                                    User Role *
                                </label>
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '10px' }}>
                                    {['pir', 'coach', 'admin'].map(role => (
                                        <button
                                            key={role}
                                            type="button"
                                            onClick={() => setFormData({...formData, role})}
                                            style={{
                                                padding: '15px',
                                                background: formData.role === role ? getRoleColor(role) : '#f0f0f0',
                                                color: formData.role === role ? 'white' : '#666',
                                                border: 'none',
                                                borderRadius: '10px',
                                                cursor: 'pointer',
                                                fontSize: '14px',
                                                fontWeight: '600',
                                                textTransform: 'uppercase',
                                                transition: 'all 0.2s'
                                            }}
                                            onMouseEnter={(e) => {
                                                if (formData.role !== role) {
                                                    e.currentTarget.style.background = '#e0e0e0';
                                                }
                                            }}
                                            onMouseLeave={(e) => {
                                                if (formData.role !== role) {
                                                    e.currentTarget.style.background = '#f0f0f0';
                                                }
                                            }}
                                        >
                                            {role}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Email */}
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ 
                                    display: 'block', 
                                    fontSize: '14px', 
                                    fontWeight: '600', 
                                    color: '#333', 
                                    marginBottom: '8px' 
                                }}>
                                    Email Address *
                                </label>
                                <input
                                    type="email"
                                    value={formData.email}
                                    onChange={(e) => handleEmailChange(e.target.value)}
                                    required
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: `2px solid ${emailValid === false ? '#f44336' : emailValid === true ? '#4CAF50' : '#e0e0e0'}`,
                                        borderRadius: '10px',
                                        fontSize: '14px',
                                        transition: 'border-color 0.2s'
                                    }}
                                    onFocus={(e) => {
                                        if (emailValid === null) e.currentTarget.style.borderColor = '#667eea';
                                    }}
                                    onBlur={(e) => {
                                        if (emailValid === null) e.currentTarget.style.borderColor = '#e0e0e0';
                                    }}
                                />
                                {emailValid === false && (
                                    <div style={{ color: '#f44336', fontSize: '12px', marginTop: '5px' }}>
                                        Please enter a valid email address
                                    </div>
                                )}
                                {emailValid === true && (
                                    <div style={{ color: '#4CAF50', fontSize: '12px', marginTop: '5px' }}>
                                        ‚úì Valid email address
                                    </div>
                                )}
                            </div>

                            {/* Name Fields */}
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px', marginBottom: '20px' }}>
                                <div>
                                    <label style={{ 
                                        display: 'block', 
                                        fontSize: '14px', 
                                        fontWeight: '600', 
                                        color: '#333', 
                                        marginBottom: '8px' 
                                    }}>
                                        First Name *
                                    </label>
                                    <input
                                        type="text"
                                        value={formData.firstName}
                                        onChange={(e) => setFormData({...formData, firstName: e.target.value})}
                                        required
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '10px',
                                            fontSize: '14px',
                                            transition: 'border-color 0.2s'
                                        }}
                                        onFocus={(e) => e.currentTarget.style.borderColor = '#667eea'}
                                        onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                                    />
                                </div>
                                <div>
                                    <label style={{ 
                                        display: 'block', 
                                        fontSize: '14px', 
                                        fontWeight: '600', 
                                        color: '#333', 
                                        marginBottom: '8px' 
                                    }}>
                                        Last Name *
                                    </label>
                                    <input
                                        type="text"
                                        value={formData.lastName}
                                        onChange={(e) => setFormData({...formData, lastName: e.target.value})}
                                        required
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '10px',
                                            fontSize: '14px',
                                            transition: 'border-color 0.2s'
                                        }}
                                        onFocus={(e) => e.currentTarget.style.borderColor = '#667eea'}
                                        onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                                    />
                                </div>
                            </div>

                            {/* Phone */}
                            <div style={{ marginBottom: '25px' }}>
                                <label style={{ 
                                    display: 'block', 
                                    fontSize: '14px', 
                                    fontWeight: '600', 
                                    color: '#333', 
                                    marginBottom: '8px' 
                                }}>
                                    Phone Number
                                </label>
                                <input
                                    type="tel"
                                    value={formData.phone}
                                    onChange={(e) => setFormData({...formData, phone: e.target.value})}
                                    placeholder="(555) 123-4567"
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px',
                                        transition: 'border-color 0.2s'
                                    }}
                                    onFocus={(e) => e.currentTarget.style.borderColor = '#667eea'}
                                    onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                                />
                            </div>

                            <button
                                type="button"
                                onClick={() => setStep(2)}
                                style={{
                                    width: '100%',
                                    padding: '14px',
                                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '10px',
                                    cursor: 'pointer',
                                    fontSize: '16px',
                                    fontWeight: '600',
                                    transition: 'transform 0.2s'
                                }}
                                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                            >
                                Next Step ‚Üí
                            </button>
                        </>
                    )}

                    {step === 2 && (
                        <>
                            {/* PIR-specific fields */}
                            {formData.role === 'pir' && (
                                <>
                                    <div style={{ marginBottom: '20px' }}>
                                        <label style={{ 
                                            display: 'block', 
                                            fontSize: '14px', 
                                            fontWeight: '600', 
                                            color: '#333', 
                                            marginBottom: '8px' 
                                        }}>
                                            Assign Coach
                                        </label>
                                        <select
                                            value={formData.assignedCoach}
                                            onChange={(e) => setFormData({...formData, assignedCoach: e.target.value})}
                                            style={{
                                                width: '100%',
                                                padding: '12px 15px',
                                                border: '2px solid #e0e0e0',
                                                borderRadius: '10px',
                                                fontSize: '14px',
                                                background: 'white',
                                                cursor: 'pointer',
                                                transition: 'border-color 0.2s'
                                            }}
                                            onFocus={(e) => e.currentTarget.style.borderColor = '#667eea'}
                                            onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                                        >
                                            <option value="">Select Coach (Optional)</option>
                                            {coachesList.map(coach => (
                                                <option key={coach.id} value={coach.id}>
                                                    {coach.displayName || coach.email}
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    <div style={{ marginBottom: '25px' }}>
                                        <label style={{ 
                                            display: 'block', 
                                            fontSize: '14px', 
                                            fontWeight: '600', 
                                            color: '#333', 
                                            marginBottom: '8px' 
                                        }}>
                                            Sobriety Start Date
                                        </label>
                                        <input
                                            type="date"
                                            value={formData.sobrietyDate}
                                            onChange={(e) => setFormData({...formData, sobrietyDate: e.target.value})}
                                            style={{
                                                width: '100%',
                                                padding: '12px 15px',
                                                border: '2px solid #e0e0e0',
                                                borderRadius: '10px',
                                                fontSize: '14px',
                                                transition: 'border-color 0.2s'
                                            }}
                                            onFocus={(e) => e.currentTarget.style.borderColor = '#667eea'}
                                            onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                                        />
                                    </div>
                                </>
                            )}

                            {/* Password Info */}
                            <div style={{
                                padding: '15px',
                                background: '#e3f2fd',
                                borderRadius: '10px',
                                marginBottom: '25px'
                            }}>
                                <div style={{ fontSize: '14px', fontWeight: '600', color: '#1976d2', marginBottom: '5px' }}>
                                    üîí Password Reset Email
                                </div>
                                <div style={{ fontSize: '13px', color: '#1565c0' }}>
                                    A password reset link will be sent to the user's email address. They will set their own secure password.
                                </div>
                            </div>

                            <div style={{ display: 'flex', gap: '10px' }}>
                                <button
                                    type="button"
                                    onClick={() => setStep(1)}
                                    style={{
                                        flex: 1,
                                        padding: '14px',
                                        background: '#6c757d',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '10px',
                                        cursor: 'pointer',
                                        fontSize: '16px',
                                        fontWeight: '600',
                                        transition: 'background 0.2s'
                                    }}
                                    onMouseEnter={(e) => e.currentTarget.style.background = '#5a6268'}
                                    onMouseLeave={(e) => e.currentTarget.style.background = '#6c757d'}
                                >
                                    ‚Üê Back
                                </button>
                                <button
                                    type="submit"
                                    disabled={loading}
                                    style={{
                                        flex: 2,
                                        padding: '14px',
                                        background: loading ? '#ccc' : getRoleColor(formData.role),
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '10px',
                                        cursor: loading ? 'not-allowed' : 'pointer',
                                        fontSize: '16px',
                                        fontWeight: '600',
                                        transition: 'transform 0.2s'
                                    }}
                                    onMouseEnter={(e) => {
                                        if (!loading) e.currentTarget.style.transform = 'translateY(-2px)';
                                    }}
                                    onMouseLeave={(e) => {
                                        e.currentTarget.style.transform = 'translateY(0)';
                                    }}
                                >
                                    {loading ? 'Creating User...' : 'Create User'}
                                </button>
                            </div>
                        </>
                    )}
                </form>
            </div>
        </div>
    );
}

// ENHANCED CreateAssignmentModal
function CreateAssignmentModal({ onClose, onSuccess, users, createdBy }) {
    const [formData, setFormData] = useState({
        title: '',
        description: '',
        userId: '',
        dueDate: '',
        priority: 'medium',
        status: 'pending',
        category: 'general'
    });
    const [loading, setLoading] = useState(false);

    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        
        try {
            await db.collection('assignments').add({
                ...formData,
                createdBy: createdBy,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Create notification for PIR
            if (formData.userId) {
                await db.collection('notifications').add({
                    type: 'assignment',
                    message: `New assignment: ${formData.title}`,
                    recipientId: formData.userId,
                    relatedId: formData.userId,
                    read: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            alert('Assignment created successfully!');
            onSuccess();
        } catch (error) {
            console.error('Error creating assignment:', error);
            alert('Failed to create assignment');
        } finally {
            setLoading(false);
        }
    };

    const getPriorityColor = (priority) => {
        if (priority === 'high') return '#f44336';
        if (priority === 'medium') return '#FF9800';
        return '#4CAF50';
    };

    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000,
            padding: '20px',
            animation: 'fadeIn 0.2s'
        }}>
            <div style={{
                background: 'white',
                borderRadius: '20px',
                maxWidth: '600px',
                width: '100%',
                maxHeight: '90vh',
                overflow: 'auto',
                boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
                animation: 'slideUp 0.3s'
            }}>
                {/* Header */}
                <div style={{
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    padding: '25px 30px',
                    borderRadius: '20px 20px 0 0',
                    color: 'white',
                    position: 'sticky',
                    top: 0,
                    zIndex: 1
                }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <h2 style={{ margin: 0, fontSize: '24px' }}>Create Assignment</h2>
                        <button 
                            onClick={onClose}
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                border: 'none',
                                color: 'white',
                                fontSize: '24px',
                                width: '36px',
                                height: '36px',
                                borderRadius: '50%',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                transition: 'background 0.2s'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.3)'}
                            onMouseLeave={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.2)'}
                        >
                            √ó
                        </button>
                    </div>
                </div>

                {/* Content */}
                <form onSubmit={handleSubmit} style={{ padding: '30px' }}>
                    {/* Title */}
                    <div style={{ marginBottom: '20px' }}>
                        <label style={{ 
                            display: 'block', 
                            fontSize: '14px', 
                            fontWeight: '600', 
                            color: '#333', 
                            marginBottom: '8px' 
                        }}>
                            Assignment Title *
                        </label>
                        <input
                            type="text"
                            value={formData.title}
                            onChange={(e) => setFormData({...formData, title: e.target.value})}
                            required
                            placeholder="e.g., Complete daily gratitude journal"
                            style={{
                                width: '100%',
                                padding: '12px 15px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '10px',
                                fontSize: '14px',
                                transition: 'border-color 0.2s'
                            }}
                            onFocus={(e) => e.currentTarget.style.borderColor = '#667eea'}
                            onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                        />
                    </div>

                    {/* Description */}
                    <div style={{ marginBottom: '20px' }}>
                        <label style={{ 
                            display: 'block', 
                            fontSize: '14px', 
                            fontWeight: '600', 
                            color: '#333', 
                            marginBottom: '8px' 
                        }}>
                            Description *
                        </label>
                        <textarea
                            value={formData.description}
                            onChange={(e) => setFormData({...formData, description: e.target.value})}
                            required
                            placeholder="Provide detailed instructions..."
                            style={{
                                width: '100%',
                                minHeight: '100px',
                                padding: '12px 15px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '10px',
                                fontSize: '14px',
                                fontFamily: 'inherit',
                                resize: 'vertical',
                                transition: 'border-color 0.2s'
                            }}
                            onFocus={(e) => e.currentTarget.style.borderColor = '#667eea'}
                            onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                        />
                    </div>

                    {/* Assign To */}
                    <div style={{ marginBottom: '20px' }}>
                        <label style={{ 
                            display: 'block', 
                            fontSize: '14px', 
                            fontWeight: '600', 
                            color: '#333', 
                            marginBottom: '8px' 
                        }}>
                            Assign To *
                        </label>
                        <select
                            value={formData.userId}
                            onChange={(e) => setFormData({...formData, userId: e.target.value})}
                            required
                            style={{
                                width: '100%',
                                padding: '12px 15px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '10px',
                                fontSize: '14px',
                                background: 'white',
                                cursor: 'pointer',
                                transition: 'border-color 0.2s'
                            }}
                            onFocus={(e) => e.currentTarget.style.borderColor = '#667eea'}
                            onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                        >
                            <option value="">Select PIR</option>
                            {users.map(user => (
                                <option key={user.id} value={user.id}>
                                    {user.displayName || user.email}
                                </option>
                            ))}
                        </select>
                    </div>

                    {/* Priority Selection */}
                    <div style={{ marginBottom: '20px' }}>
                        <label style={{ 
                            display: 'block', 
                            fontSize: '14px', 
                            fontWeight: '600', 
                            color: '#333', 
                            marginBottom: '10px' 
                        }}>
                            Priority Level
                        </label>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '10px' }}>
                            {['low', 'medium', 'high'].map(priority => (
                                <button
                                    key={priority}
                                    type="button"
                                    onClick={() => setFormData({...formData, priority})}
                                    style={{
                                        padding: '12px',
                                        background: formData.priority === priority ? getPriorityColor(priority) : '#f0f0f0',
                                        color: formData.priority === priority ? 'white' : '#666',
                                        border: 'none',
                                        borderRadius: '10px',
                                        cursor: 'pointer',
                                        fontSize: '14px',
                                        fontWeight: '600',
                                        textTransform: 'capitalize',
                                        transition: 'all 0.2s'
                                    }}
                                >
                                    {priority}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Category and Due Date */}
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px', marginBottom: '25px' }}>
                        <div>
                            <label style={{ 
                                display: 'block', 
                                fontSize: '14px', 
                                fontWeight: '600', 
                                color: '#333', 
                                marginBottom: '8px' 
                            }}>
                                Category
                            </label>
                            <select
                                value={formData.category}
                                onChange={(e) => setFormData({...formData, category: e.target.value})}
                                style={{
                                    width: '100%',
                                    padding: '12px 15px',
                                    border: '2px solid #e0e0e0',
                                    borderRadius: '10px',
                                    fontSize: '14px',
                                    background: 'white',
                                    cursor: 'pointer'
                                }}
                            >
                                <option value="general">General</option>
                                <option value="recovery">Recovery</option>
                                <option value="wellness">Wellness</option>
                                <option value="social">Social</option>
                                <option value="education">Education</option>
                            </select>
                        </div>
                        <div>
                            <label style={{ 
                                display: 'block', 
                                fontSize: '14px', 
                                fontWeight: '600', 
                                color: '#333', 
                                marginBottom: '8px' 
                            }}>
                                Due Date
                            </label>
                            <input
                                type="date"
                                value={formData.dueDate}
                                onChange={(e) => setFormData({...formData, dueDate: e.target.value})}
                                style={{
                                    width: '100%',
                                    padding: '12px 15px',
                                    border: '2px solid #e0e0e0',
                                    borderRadius: '10px',
                                    fontSize: '14px'
                                }}
                            />
                        </div>
                    </div>

                    {/* Actions */}
                    <div style={{ display: 'flex', gap: '10px' }}>
                        <button
                            type="button"
                            onClick={onClose}
                            style={{
                                flex: 1,
                                padding: '14px',
                                background: '#6c757d',
                                color: 'white',
                                border: 'none',
                                borderRadius: '10px',
                                cursor: 'pointer',
                                fontSize: '16px',
                                fontWeight: '600',
                                transition: 'background 0.2s'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.background = '#5a6268'}
                            onMouseLeave={(e) => e.currentTarget.style.background = '#6c757d'}
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            disabled={loading}
                            style={{
                                flex: 2,
                                padding: '14px',
                                background: loading ? '#ccc' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '10px',
                                cursor: loading ? 'not-allowed' : 'pointer',
                                fontSize: '16px',
                                fontWeight: '600',
                                transition: 'transform 0.2s'
                            }}
                            onMouseEnter={(e) => {
                                if (!loading) e.currentTarget.style.transform = 'translateY(-2px)';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.transform = 'translateY(0)';
                            }}
                        >
                            {loading ? 'Creating...' : 'Create Assignment'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
}
       

       
        function AlertDetailModal({ alert, onClose, onResolve }) {
            const [notes, setNotes] = useState('');
            const [resolving, setResolving] = useState(false);

            const handleResolve = async () => {
                setResolving(true);
                await onResolve(alert.id, notes);
                setResolving(false);
                onClose();
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">
                                {alert.type === 'sos' ? 'üö® SOS ALERT' : 'Alert Details'}
                            </div>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        
                        <div style={{marginBottom: '20px'}}>
                            <strong>User:</strong> {alert.userName}<br />
                            <strong>Type:</strong> {alert.type}<br />
                            <strong>Priority:</strong> {alert.priority || 'Normal'}<br />
                            <strong>Created:</strong> {formatDateTime(alert.createdAt)}<br />
                            <strong>Status:</strong> {alert.resolved ? 'Resolved' : 'Active'}
                        </div>
                        
                        <div style={{marginBottom: '20px', padding: '15px', background: 'rgba(255,255,255,0.05)', borderRadius: '10px'}}>
                            <strong>Message:</strong><br />
                            {alert.message}
                        </div>
                        
                        {alert.resolved && alert.resolutionNotes && (
                            <div style={{marginBottom: '20px', padding: '15px', background: 'rgba(76,175,80,0.1)', borderRadius: '10px'}}>
                                <strong>Resolution Notes:</strong><br />
                                {alert.resolutionNotes}<br />
                                <small>Resolved at: {formatDateTime(alert.resolvedAt)}</small>
                            </div>
                        )}
                        
                        {!alert.resolved && (
                            <>
                                <div className="form-group">
                                    <label className="form-label">Resolution Notes (optional)</label>
                                    <textarea
                                        className="form-input"
                                        value={notes}
                                        onChange={(e) => setNotes(e.target.value)}
                                        rows="3"
                                    />
                                </div>
                                
                                <button 
                                    className="btn btn-success"
                                    onClick={handleResolve}
                                    disabled={resolving}
                                >
                                    {resolving ? 'Resolving...' : 'Mark as Resolved'}
                                </button>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        // Other existing modals remain the same...

        // Pagination Component
        function Pagination({ currentPage, totalPages, onPageChange }) {
            return (
                <div className="pagination">
                    <button 
                        className="page-btn"
                        onClick={() => onPageChange(currentPage - 1)}
                        disabled={currentPage === 1}
                    >
                        Previous
                    </button>
                    
                    {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                        let pageNum;
                        if (totalPages <= 5) {
                            pageNum = i + 1;
                        } else if (currentPage <= 3) {
                            pageNum = i + 1;
                        } else if (currentPage >= totalPages - 2) {
                            pageNum = totalPages - 4 + i;
                        } else {
                            pageNum = currentPage - 2 + i;
                        }
                        
                        return (
                            <button
                                key={pageNum}
                                className={`page-btn ${currentPage === pageNum ? 'active' : ''}`}
                                onClick={() => onPageChange(pageNum)}
                            >
                                {pageNum}
                            </button>
                        );
                    })}
                    
                    <button 
                        className="page-btn"
                        onClick={() => onPageChange(currentPage + 1)}
                        disabled={currentPage === totalPages}
                    >
                        Next
                    </button>
                </div>
            );
        }

// Complete Enhanced PIR Detail View Component - All Fixes Applied
function UserDetailModal({ user, onClose, onUpdate }) {
    // Extract ID from user object
    const pirId = user?.id;
    
    // Core States
    const [pirData, setPirData] = useState(null);
    const [loading, setLoading] = useState(true);
    const [activeTab, setActiveTab] = useState('overview');
    
    // Data States
    const [activities, setActivities] = useState([]);
            const [availableCoaches, setAvailableCoaches] = useState([]);
    const [checkIns, setCheckIns] = useState([]);
    const [assignments, setAssignments] = useState([]);
    const [goals, setGoals] = useState([]);
    const [objectives, setObjectives] = useState([]);
    const [alerts, setAlerts] = useState([]);
    const [meetings, setMeetings] = useState([]);
    const [resources, setResources] = useState([]);
    const [milestones, setMilestones] = useState([]);
    const [messages, setMessages] = useState([]);
    const [supportGroups, setSupportGroups] = useState([]);
    const [pledges, setPledges] = useState([]);
    const [notifications, setNotifications] = useState([]);
    const [topicRooms, setTopicRooms] = useState([]);
    const [resourceProgress, setResourceProgress] = useState({});
    const [resourceNotes, setResourceNotes] = useState({});
    const [streakData, setStreakData] = useState({});
    const [complianceData, setComplianceData] = useState({});
    const [allMessages, setAllMessages] = useState([]);
    
    // UI States
    const [editing, setEditing] = useState(false);
    const [editData, setEditData] = useState({});
    const [chartData, setChartData] = useState(null);
    const [expandedGoals, setExpandedGoals] = useState({});
    const [showAddGoal, setShowAddGoal] = useState(false);
    const [showAddObjective, setShowAddObjective] = useState(false);
    const [showAddAssignment, setShowAddAssignment] = useState(false);
    const [selectedGoalId, setSelectedGoalId] = useState(null);
    const [selectedObjectiveId, setSelectedObjectiveId] = useState(null);
    const [showAssignResource, setShowAssignResource] = useState(false);
    const [showCreateResource, setShowCreateResource] = useState(false);

     // Golden Thread specific states - ADD THESE THREE
    const [showGoldenThread, setShowGoldenThread] = useState(false);
    const [selectedGoalForObjective, setSelectedGoalForObjective] = useState(null);
    const [selectedObjectiveForAssignment, setSelectedObjectiveForAssignment] = useState(null);
    
    
    // Chart refs
    const moodChartRef = useRef(null);
    const cravingChartRef = useRef(null);
    const anxietyChartRef = useRef(null);
    const sleepChartRef = useRef(null);

  useEffect(() => {
    if (pirId) {
        loadCompletePIRData();
    }
}, [pirId]);

const loadCompletePIRData = async () => {
    try {
        setLoading(true);
        
        // Load main user data
        const userDoc = await db.collection('users').doc(pirId).get();
        if (!userDoc.exists) {
            alert('PIR not found');
            onClose();
            return;
        }
        
        const userData = { id: userDoc.id, ...userDoc.data() };
        
        // Fix timezone issues for dates
        userData.sobrietyDays = calculateSobrietyDaysFixed(userData.sobrietyDate);
        userData.accountAge = daysSince(userData.createdAt);
        
        // Get last login from auth or user doc
        userData.lastLoginFormatted = await getLastLoginFormatted(pirId, userData);
        userData.firstLoginFormatted = formatFirstLogin(userData.createdAt);
        userData.moneySaved = userData.sobrietyDays * (userData.dailyCost || 20);
        
        setPirData(userData);
        setEditData(userData);
        
        // Load all related data in parallel
        await Promise.all([
            loadActivitiesData(),
            loadCheckInsData(),
            loadAssignmentsData(),
            loadGoalsData(),
            loadObjectivesData(),
            loadAlertsData(),
            loadMeetingsData(),
            loadResourcesData(),
            loadMilestonesData(),
            loadMessagesData(),
            loadAllUserMessages(),
            loadSupportGroupsData(),
            loadPledgesData(),
            loadNotificationsData(),
            loadTopicRoomsData(),
            loadResourceProgressData(),
            loadStreakData(),
            loadComplianceDataFixed(userData.createdAt),
            loadProgressChartData(),
            loadAvailableCoaches() // ‚úÖ ADDED: Load coaches for assignment dropdown
        ]);
        
    } catch (error) {
        console.error('Error loading PIR data:', error);
        alert('Failed to load PIR data: ' + error.message);
    } finally {
        setLoading(false);
    }
};
   const calculateSobrietyDaysFixed = (sobrietyDate) => {
    if (!sobrietyDate) return 0;
    
    let sobriety;
    
    // Handle string dates more carefully
    if (typeof sobrietyDate === 'string') {
        // For YYYY-MM-DD format, parse components directly to avoid timezone issues
        if (sobrietyDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
            const [year, month, day] = sobrietyDate.split('-').map(Number);
            sobriety = new Date(year, month - 1, day); // month is 0-indexed
        } else {
            sobriety = new Date(sobrietyDate);
        }
    } else if (sobrietyDate.toDate) {
        sobriety = sobrietyDate.toDate();
    } else if (sobrietyDate.seconds) {
        sobriety = new Date(sobrietyDate.seconds * 1000);
    } else {
        sobriety = new Date(sobrietyDate);
    }
    
    // Set to midnight
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    sobriety.setHours(0, 0, 0, 0);
    
    // Calculate difference
    const diffTime = today.getTime() - sobriety.getTime();
    const days = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 2;
    
    return days >= 0 ? days : 0;
};

    const getLastLoginFormatted = async (userId, userData) => {
        try {
            // Try to get from user document first
            if (userData.lastLogin) {
                const lastLogin = userData.lastLogin.toDate ? userData.lastLogin.toDate() : new Date(userData.lastLogin);
                return lastLogin.toLocaleString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric',
                    hour: 'numeric', 
                    minute: '2-digit', 
                    hour12: true 
                });
            }
            
            // Check activities for last login
            const loginActivity = await db.collection('activities')
                .where('userId', '==', userId)
                .where('type', '==', 'login')
                .orderBy('createdAt', 'desc')
                .limit(1)
                .get();
            
            if (!loginActivity.empty) {
                const lastLogin = loginActivity.docs[0].data().createdAt.toDate();
                return lastLogin.toLocaleString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric',
                    hour: 'numeric', 
                    minute: '2-digit', 
                    hour12: true 
                });
            }
            
            return 'No login recorded';
        } catch (error) {
            console.error('Error getting last login:', error);
            return 'Unable to determine';
        }
    };


    const formatFirstLogin = (createdAt) => {
        if (!createdAt) return 'Unknown';
        const date = createdAt.toDate ? createdAt.toDate() : new Date(createdAt);
        return date.toLocaleString('en-US', { 
            month: 'short', 
            day: 'numeric', 
            year: 'numeric'
        });
    };

    // Fixed compliance calculation function
const loadComplianceDataFixed = async (accountCreatedAt) => {
    try {
        // Calculate days since account creation
        const accountDate = accountCreatedAt?.toDate ? accountCreatedAt.toDate() : new Date(accountCreatedAt);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        accountDate.setHours(0, 0, 0, 0);
        
        const daysSinceCreation = Math.floor((today - accountDate) / (1000 * 60 * 60 * 24));
        const daysToCheck = Math.min(daysSinceCreation, 30); // Max 30 days
        
        if (daysToCheck <= 0) {
            setComplianceData({
                morningRate: 0,
                eveningRate: 0,
                assignmentRate: 0,
                totalCheckIns: 0,
                daysTracked: 0,
                recentCheckIns: []
            });
            return;
        }
        
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - daysToCheck);
        startDate.setHours(0, 0, 0, 0);
        
        // Get ALL check-ins for display
        const allCheckInsSnap = await db.collection('checkIns')
            .where('userId', '==', pirId)
            .orderBy('createdAt', 'desc')
            .get();
        
        // Get check-ins for compliance calculation (last 30 days max)
        const complianceCheckInsSnap = await db.collection('checkIns')
            .where('userId', '==', pirId)
            .where('createdAt', '>=', startDate)
            .get();
        
        // Process all check-ins for display
        const allCheckInsData = [];
        allCheckInsSnap.forEach(doc => {
            const data = doc.data();
            allCheckInsData.push({
                id: doc.id,
                ...data,
                date: data.createdAt?.toDate ? data.createdAt.toDate() : new Date(data.createdAt)
            });
        });
        
        // Calculate compliance metrics
        let morningCount = 0;
        let eveningCount = 0;
        const dateMap = new Map();
        
        complianceCheckInsSnap.forEach(doc => {
            const data = doc.data();
            const checkInDate = data.createdAt?.toDate ? data.createdAt.toDate() : new Date(data.createdAt);
            const dateKey = checkInDate.toDateString();
            
            if (!dateMap.has(dateKey)) {
                dateMap.set(dateKey, { morning: false, evening: false });
            }
            
            if (data.morningData && !dateMap.get(dateKey).morning) {
                morningCount++;
                dateMap.get(dateKey).morning = true;
            }
            if (data.eveningData && !dateMap.get(dateKey).evening) {
                eveningCount++;
                dateMap.get(dateKey).evening = true;
            }
        });
        
        // Calculate assignment compliance
        const completedAssignments = assignments.filter(a => a.status === 'completed').length;
        const totalAssignments = assignments.length;
        
        // Cap percentages at 100%
        const morningRate = Math.min(100, Math.round((morningCount / daysToCheck) * 100));
        const eveningRate = Math.min(100, Math.round((eveningCount / daysToCheck) * 100));
        const assignmentRate = totalAssignments > 0 ? 
            Math.min(100, Math.round((completedAssignments / totalAssignments) * 100)) : 0;
        
        setComplianceData({
            morningRate,
            eveningRate,
            assignmentRate,
            totalCheckIns: morningCount + eveningCount,
            daysTracked: daysToCheck,
            recentCheckIns: allCheckInsData // Store all check-ins for display
        });
        
        // Also update the checkIns state for the table
        setCheckIns(allCheckInsData);
        
    } catch (error) {
        console.error('Error calculating compliance:', error);
        setComplianceData({
            morningRate: 0,
            eveningRate: 0,
            assignmentRate: 0,
            totalCheckIns: 0,
            daysTracked: 0,
            recentCheckIns: []
        });
    }
};
            const loadAvailableCoaches = async () => {
    try {
        const coachesSnap = await db.collection('users')
            .where('role', 'in', ['admin', 'coach'])
            .get();
        
        const coachesList = [];
        coachesSnap.forEach(doc => {
            coachesList.push({ 
                id: doc.id, 
                ...doc.data() 
            });
        });
        setAvailableCoaches(coachesList);
    } catch (error) {
        console.error('Error loading coaches:', error);
        setAvailableCoaches([]);
    }
};

    

    // Fixed milestones loading
    const loadMilestonesData = async () => {
        try {
            const milestonesList = [];
            
            // Try to load custom milestones
            try {
                const milestonesSnap = await db.collection('milestones')
                    .where('userId', '==', pirId)
                    .get();
                
                milestonesSnap.forEach(doc => {
                    milestonesList.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.error('Error loading custom milestones:', error);
            }
            
            // Add standard recovery milestones based on sobriety date
            if (pirData?.sobrietyDate) {
                const standardMilestones = getStandardMilestones(pirData.sobrietyDate);
                milestonesList.push(...standardMilestones);
            }
            
            setMilestones(milestonesList);
        } catch (error) {
            console.error('Error loading milestones:', error);
            setMilestones([]);
        }
    };

    const getStandardMilestones = (sobrietyDate) => {
        const milestones = [
            { days: 1, title: '24 Hours', icon: 'üåÖ', description: 'First day of recovery' },
            { days: 7, title: 'One Week', icon: 'üìÖ', description: 'A week of sobriety' },
            { days: 30, title: 'One Month', icon: 'üìÜ', description: 'First month milestone' },
            { days: 60, title: 'Two Months', icon: 'üìÖ', description: 'Two months strong' },
            { days: 90, title: 'Three Months', icon: 'üèÜ', description: 'Quarter year achieved' },
            { days: 180, title: 'Six Months', icon: '‚≠ê', description: 'Half year milestone' },
            { days: 365, title: 'One Year', icon: 'üéâ', description: 'Full year of recovery' },
            { days: 730, title: 'Two Years', icon: 'üéä', description: 'Two years of sobriety' }
        ];
        
        const sobrietyDateObj = sobrietyDate?.toDate ? sobrietyDate.toDate() : new Date(sobrietyDate);
        const today = new Date();
        
        return milestones.map(m => {
            const targetDate = new Date(sobrietyDateObj);
            targetDate.setDate(targetDate.getDate() + m.days);
            const achieved = today >= targetDate;
            const daysUntil = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
            
            return {
                ...m,
                targetDate,
                achieved,
                daysUntil: achieved ? 0 : daysUntil,
                type: 'standard',
                id: `standard-${m.days}`
            };
        });
    };

    // Add Goal function
    const handleAddGoal = async (goalData) => {
        try {
            await db.collection('goals').add({
                ...goalData,
                userId: pirId,
                createdBy: user.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await loadGoalsData();
            setShowAddGoal(false);
            alert('Goal added successfully');
        } catch (error) {
            console.error('Error adding goal:', error);
            alert('Failed to add goal');
        }
    };

    // Assign Resource function
    const handleAssignResource = async (resourceId) => {
        try {
            const resourceDoc = await db.collection('resources').doc(resourceId).get();
            const resourceData = resourceDoc.data();
            
            const currentAssigned = resourceData.assignedTo || [];
            if (!currentAssigned.includes(pirId)) {
                await db.collection('resources').doc(resourceId).update({
                    assignedTo: firebase.firestore.FieldValue.arrayUnion(pirId)
                });
                
                await loadResourcesData();
                alert('Resource assigned successfully');
            } else {
                alert('Resource already assigned to this PIR');
            }
        } catch (error) {
            console.error('Error assigning resource:', error);
            alert('Failed to assign resource');
        }
    };

    // All other data loading functions remain the same...
    const loadActivitiesData = async () => {
        try {
            const activitiesSnap = await db.collection('activities')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .limit(100)
                .get();
            
            const activitiesList = [];
            activitiesSnap.forEach(doc => {
                activitiesList.push({ id: doc.id, ...doc.data() });
            });
            setActivities(activitiesList);
        } catch (error) {
            console.error('Error loading activities:', error);
            setActivities([]);
        }
    };

    const loadCheckInsData = async () => {
        try {
            const checkInsSnap = await db.collection('checkIns')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .limit(60)
                .get();
            
            const checkInsList = [];
            checkInsSnap.forEach(doc => {
                checkInsList.push({ id: doc.id, ...doc.data() });
            });
            setCheckIns(checkInsList);
        } catch (error) {
            console.error('Error loading check-ins:', error);
            setCheckIns([]);
        }
    };

    const loadAssignmentsData = async () => {
        try {
            const assignmentsSnap = await db.collection('assignments')
                .where('userId', '==', pirId)
                .get();
            
            const assignmentsList = [];
            assignmentsSnap.forEach(doc => {
                assignmentsList.push({ id: doc.id, ...doc.data() });
            });
            setAssignments(assignmentsList);
        } catch (error) {
            console.error('Error loading assignments:', error);
            setAssignments([]);
        }
    };

    const loadGoalsData = async () => {
        try {
            const goalsSnap = await db.collection('goals')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .get();
            
            const goalsList = [];
            for (const doc of goalsSnap.docs) {
                const goalData = { id: doc.id, ...doc.data() };
                goalData.progress = await calculateGoalProgress(doc.id);
                goalsList.push(goalData);
            }
            setGoals(goalsList);
        } catch (error) {
            console.error('Error loading goals:', error);
            setGoals([]);
        }
    };

    const loadObjectivesData = async () => {
        try {
            const objectivesSnap = await db.collection('objectives')
                .where('userId', '==', pirId)
                .orderBy('order', 'asc')
                .get();
            
            const objectivesList = [];
            objectivesSnap.forEach(doc => {
                objectivesList.push({ id: doc.id, ...doc.data() });
            });
            setObjectives(objectivesList);
        } catch (error) {
            console.error('Error loading objectives:', error);
            setObjectives([]);
        }
    };

    const loadAlertsData = async () => {
        try {
            const alertsSnap = await db.collection('alerts')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .limit(50)
                .get();
            
            const alertsList = [];
            alertsSnap.forEach(doc => {
                alertsList.push({ id: doc.id, ...doc.data() });
            });
            setAlerts(alertsList);
        } catch (error) {
            console.error('Error loading alerts:', error);
            setAlerts([]);
        }
    };

    const loadMeetingsData = async () => {
        try {
            const meetingsSnap = await db.collection('meetings')
                .where('pirId', '==', pirId)
                .orderBy('scheduledTime', 'desc')
                .get();
            
            const meetingsList = [];
            meetingsSnap.forEach(doc => {
                meetingsList.push({ id: doc.id, ...doc.data() });
            });
            setMeetings(meetingsList);
        } catch (error) {
            console.error('Error loading meetings:', error);
            setMeetings([]);
        }
    };

    const loadResourcesData = async () => {
        try {
            // Try multiple approaches to load resources
            const resourcesList = [];
            
            // Try loading with array-contains
            try {
                const assignedResources = await db.collection('resources')
                    .where('assignedTo', 'array-contains', pirId)
                    .get();
                
                assignedResources.forEach(doc => {
                    resourcesList.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.log('Array-contains query failed, trying alternative');
            }
            
            // Also load global resources
            try {
                const globalResources = await db.collection('resources')
                    .where('isGlobal', '==', true)
                    .get();
                
                globalResources.forEach(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    if (!resourcesList.find(r => r.id === doc.id)) {
                        resourcesList.push(data);
                    }
                });
            } catch (error) {
                console.log('Global resources query failed');
            }
            
            setResources(resourcesList);
        } catch (error) {
            console.error('Error loading resources:', error);
            setResources([]);
        }
    };

    const loadMessagesData = async () => {
        try {
            const messagesSnap = await db.collection('messages')
                .where('senderId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .limit(50)
                .get();
            
            const messagesList = [];
            messagesSnap.forEach(doc => {
                messagesList.push({ id: doc.id, ...doc.data() });
            });
            setMessages(messagesList);
        } catch (error) {
            console.error('Error loading messages:', error);
            setMessages([]);
        }
    };

    const loadSupportGroupsData = async () => {
        try {
            const supportGroupsSnap = await db.collection('supportGroups')
                .where('active', '==', true)
                .get();
            
            const supportGroupsList = [];
            supportGroupsSnap.forEach(doc => {
                supportGroupsList.push({ id: doc.id, ...doc.data() });
            });
            setSupportGroups(supportGroupsList);
        } catch (error) {
            console.error('Error loading support groups:', error);
            setSupportGroups([]);
        }
    };

    const loadPledgesData = async () => {
        try {
            const pledgesSnap = await db.collection('pledges')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .limit(30)
                .get();
            
            const pledgesList = [];
            pledgesSnap.forEach(doc => {
                pledgesList.push({ id: doc.id, ...doc.data() });
            });
            setPledges(pledgesList);
        } catch (error) {
            console.error('Error loading pledges:', error);
            setPledges([]);
        }
    };

    const loadNotificationsData = async () => {
        try {
            const notificationsSnap = await db.collection('notifications')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .limit(50)
                .get();
            
            const notificationsList = [];
            notificationsSnap.forEach(doc => {
                notificationsList.push({ id: doc.id, ...doc.data() });
            });
            setNotifications(notificationsList);
        } catch (error) {
            console.error('Error loading notifications:', error);
            setNotifications([]);
        }
    };

    const loadTopicRoomsData = async () => {
        try {
            const topicRoomsSnap = await db.collection('topicRooms')
                .get();
            
            const topicRoomsList = [];
            topicRoomsSnap.forEach(doc => {
                topicRoomsList.push({ id: doc.id, ...doc.data() });
            });
            setTopicRooms(topicRoomsList);
        } catch (error) {
            console.error('Error loading topic rooms:', error);
            setTopicRooms([]);
        }
    };

    const loadResourceProgressData = async () => {
        try {
            const progressDoc = await db.collection('users').doc(pirId)
                .collection('resourcePreferences').doc('progress').get();
            
            if (progressDoc.exists) {
                setResourceProgress(progressDoc.data() || {});
            }
            
            const notesDoc = await db.collection('users').doc(pirId)
                .collection('resourcePreferences').doc('notes').get();
            
            if (notesDoc.exists) {
                setResourceNotes(notesDoc.data() || {});
            }
        } catch (error) {
            console.error('Error loading resource progress:', error);
        }
    };

    const loadStreakData = async () => {
        try {
            const streakDoc = await db.collection('streaks').doc(pirId).get();
            if (streakDoc.exists) {
                setStreakData(streakDoc.data());
            }
        } catch (error) {
            console.error('Error loading streak data:', error);
        }
    };

    const loadProgressChartData = async () => {
        try {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const checkInsSnap = await db.collection('checkIns')
                .where('userId', '==', pirId)
                .where('createdAt', '>=', thirtyDaysAgo)
                .orderBy('createdAt', 'asc')
                .get();
            
            const chartLabels = [];
            const moodData = [];
            const cravingData = [];
            const anxietyData = [];
            const sleepData = [];
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                chartLabels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                
                let dayCheckIn = null;
                checkInsSnap.forEach(doc => {
                    const checkInDate = doc.data().createdAt?.toDate() || new Date(doc.data().createdAt);
                    if (checkInDate.toDateString() === date.toDateString()) {
                        dayCheckIn = doc.data();
                    }
                });
                
                moodData.push(dayCheckIn?.morningData?.mood ?? null);
                cravingData.push(dayCheckIn?.morningData?.craving ?? null);
                anxietyData.push(dayCheckIn?.morningData?.anxietyLevel ?? null);
                sleepData.push(dayCheckIn?.morningData?.sleepQuality ?? null);
            }
            
            setChartData({
                labels: chartLabels,
                mood: moodData,
                craving: cravingData,
                anxiety: anxietyData,
                sleep: sleepData
            });
        } catch (error) {
            console.error('Error loading chart data:', error);
        }
    };

    // Utility functions
    const daysSince = (date) => {
        if (!date) return 0;
        const start = date?.toDate ? date.toDate() : new Date(date);
        const today = new Date();
        const diffTime = Math.abs(today - start);
        return Math.floor(diffTime / (1000 * 60 * 60 * 24));
    };

    const formatTimeAgo = (date) => {
        if (!date) return 'Never';
        const d = date?.toDate ? date.toDate() : new Date(date);
        const now = new Date();
        const diff = Math.floor((now - d) / 1000);
        
        if (diff < 60) return 'Just now';
        if (diff < 3600) return Math.floor(diff / 60) + ' minutes ago';
        if (diff < 86400) return Math.floor(diff / 3600) + ' hours ago';
        if (diff < 604800) return Math.floor(diff / 86400) + ' days ago';
        return d.toLocaleDateString();
    };

    // Also fix the formatDate function to display dates correctly
const formatDate = (date) => {
    if (!date) return 'N/A';
    
    let d;
    
    // Handle Firestore Timestamp
    if (date?.toDate) {
        d = date.toDate();
    }
    // Handle timestamp object with seconds
    else if (date?.seconds) {
        d = new Date(date.seconds * 1000);
    }
    // Handle string
    else if (typeof date === 'string') {
        // Add timezone handling for date strings
        if (!date.includes('T')) {
            d = new Date(date + 'T00:00:00');
        } else {
            d = new Date(date);
        }
    }
    // Handle Date object
    else {
        d = new Date(date);
    }
    
    // Format as locale date string
    return d.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
};

    const formatDateTime = (date) => {
        if (!date) return 'N/A';
        const d = date?.toDate ? date.toDate() : new Date(date);
        return d.toLocaleString();
    };

    const calculateGoalProgress = async (goalId) => {
        const goalAssignments = assignments.filter(a => a.goalId === goalId);
        const completed = goalAssignments.filter(a => a.status === 'completed').length;
        return goalAssignments.length > 0 ? Math.round((completed / goalAssignments.length) * 100) : 0;
    };

    const getActivityIcon = (type) => {
        const icons = {
            'check_in': '‚úÖ',
            'assignment_completed': 'üìù',
            'goal_completed': 'üéØ',
            'objective_completed': 'üéØ',
            'message_sent': 'üí¨',
            'sos_triggered': 'üö®',
            'login': 'üîë',
            'profile_updated': 'üë§',
            'pledge_completed': 'ü§ù',
            'resource_viewed': 'üìö',
            'milestone_achieved': 'üèÜ',
            'streak_update': 'üî•'
        };
        return icons[type] || 'üìå';
    };

    const getActivityColor = (type) => {
        const colors = {
            'check_in': '#4CAF50',
            'assignment_completed': '#2196F3',
            'goal_completed': '#FF9800',
            'message_sent': '#9C27B0',
            'sos_triggered': '#F44336',
            'login': '#607D8B',
            'profile_updated': '#795548'
        };
        return colors[type] || '#9E9E9E';
    };

    // Chart rendering
    useEffect(() => {
        if (chartData && activeTab === 'progress') {
            setTimeout(() => {
                renderCharts();
            }, 100);
        }
    }, [chartData, activeTab]);

    const renderCharts = () => {
        const chartConfig = {
            type: 'line',
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 10,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true
                    },
                    tooltip: {
                        enabled: true
                    }
                }
            }
        };

        // Destroy existing charts
        if (moodChartRef.current) moodChartRef.current.destroy();
        if (cravingChartRef.current) cravingChartRef.current.destroy();
        if (anxietyChartRef.current) anxietyChartRef.current.destroy();
        if (sleepChartRef.current) sleepChartRef.current.destroy();

        // Create new charts
        const moodCanvas = document.getElementById(`mood-chart-${pirId}`);
        if (moodCanvas) {
            moodChartRef.current = new Chart(moodCanvas, {
                ...chartConfig,
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Mood',
                        data: chartData.mood,
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4,
                        spanGaps: true
                    }]
                }
            });
        }

        const cravingCanvas = document.getElementById(`craving-chart-${pirId}`);
        if (cravingCanvas) {
            cravingChartRef.current = new Chart(cravingCanvas, {
                ...chartConfig,
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Craving',
                        data: chartData.craving,
                        borderColor: '#ff9800',
                        backgroundColor: 'rgba(255, 152, 0, 0.1)',
                        tension: 0.4,
                        spanGaps: true
                    }]
                }
            });
        }

        const anxietyCanvas = document.getElementById(`anxiety-chart-${pirId}`);
        if (anxietyCanvas) {
            anxietyChartRef.current = new Chart(anxietyCanvas, {
                ...chartConfig,
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Anxiety',
                        data: chartData.anxiety,
                        borderColor: '#f44336',
                        backgroundColor: 'rgba(244, 67, 54, 0.1)',
                        tension: 0.4,
                        spanGaps: true
                    }]
                }
            });
        }

        const sleepCanvas = document.getElementById(`sleep-chart-${pirId}`);
        if (sleepCanvas) {
            sleepChartRef.current = new Chart(sleepCanvas, {
                ...chartConfig,
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Sleep Quality',
                        data: chartData.sleep,
                        borderColor: '#9c27b0',
                        backgroundColor: 'rgba(156, 39, 176, 0.1)',
                        tension: 0.4,
                        spanGaps: true
                    }]
                }
            });
        }
    };

   const handleSaveProfile = async () => {
    try {
        const updates = {
            ...editData,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Track coach assignment changes
        if (editData.assignedCoach !== pirData.assignedCoach) {
            const newCoach = availableCoaches.find(c => c.id === editData.assignedCoach);
            const oldCoach = availableCoaches.find(c => c.id === pirData.assignedCoach);
            
            // Add to assignment history
            const historyEntry = {
                assignedAt: new Date().toISOString(),
                assignedBy: user.uid,
                coachId: editData.assignedCoach,
                coachName: newCoach?.displayName || newCoach?.email || 'Unknown',
                previousCoachId: pirData.assignedCoach || null,
                previousCoachName: oldCoach?.displayName || oldCoach?.email || 'None'
            };
            
            updates.coachAssignmentHistory = firebase.firestore.FieldValue.arrayUnion(historyEntry);
            
            // Create notification for new coach
            if (editData.assignedCoach) {
                await db.collection('notifications').add({
                    recipientId: editData.assignedCoach,
                    type: 'pir_assigned',
                    message: `${pirData.displayName || pirData.email} has been assigned to you`,
                    pirId: pirId,
                    pirName: pirData.displayName || pirData.email,
                    read: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            // Create notification for PIR
            await db.collection('notifications').add({
                recipientId: pirId,
                type: 'coach_changed',
                message: `Your coach has been updated to ${newCoach?.displayName || 'a new coach'}`,
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        await db.collection('users').doc(pirId).update(updates);
        
        await db.collection('activities').add({
            userId: pirId,
            type: 'profile_updated',
            description: 'Profile information updated' + 
                (editData.assignedCoach !== pirData.assignedCoach ? ' - Coach assignment changed' : ''),
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        setPirData(editData);
        setEditing(false);
        alert('Profile updated successfully' + 
            (editData.assignedCoach !== pirData.assignedCoach ? '\n\nCoach assignment changed and notifications sent!' : ''));
        if (onUpdate) onUpdate();
    } catch (error) {
        console.error('Error updating profile:', error);
        alert('Failed to update profile: ' + error.message);
    }
};
     // Fixed loadAllUserMessages function - add this to your load functions
const loadAllUserMessages = async () => {
    try {
        const messagesData = [];
        
        // Get direct messages where user is the sender
        try {
            const directMessages = await db.collection('messages')
                .where('senderId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .get();
            
            directMessages.forEach(doc => {
                messagesData.push({ 
                    id: doc.id, 
                    ...doc.data(), 
                    type: 'direct' 
                });
            });
        } catch (error) {
            console.log('Error loading direct messages:', error);
        }
        
        // Also get direct messages where user is the recipient
        try {
            const receivedMessages = await db.collection('messages')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .get();
            
            receivedMessages.forEach(doc => {
                const data = doc.data();
                if (data.senderId === pirId) {  // Only include if they sent it
                    messagesData.push({ 
                        id: doc.id, 
                        ...data, 
                        type: 'direct' 
                    });
                }
            });
        } catch (error) {
            console.log('Error loading received messages:', error);
        }
        
        // Get community messages (if collection exists)
        try {
            const communityMessages = await db.collection('glrsChat')
                .where('senderId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .limit(50)
                .get();
            
            communityMessages.forEach(doc => {
                messagesData.push({ 
                    id: doc.id, 
                    ...doc.data(), 
                    type: 'community' 
                });
            });
        } catch (error) {
            console.log('Community chat collection may not exist:', error);
        }
        
        // Get topic room messages
        try {
            const topicMessages = await db.collection('topicRoomMessages')
                .where('senderId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .limit(50)
                .get();
            
            topicMessages.forEach(doc => {
                messagesData.push({ 
                    id: doc.id, 
                    ...doc.data(), 
                    type: 'topic' 
                });
            });
        } catch (error) {
            console.log('Topic room messages may not exist:', error);
        }
        
        // Sort all messages by date
        messagesData.sort((a, b) => {
            const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
            const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
            return dateB - dateA;
        });
        
        setAllMessages(messagesData);
        console.log(`Loaded ${messagesData.length} total messages for PIR`);
        
    } catch (error) {
        console.error('Error loading user messages:', error);
        setAllMessages([]);
    }
};

    // Delete message function
    const handleDeleteMessage = async (messageId, messageType) => {
        if (!confirm('Are you sure you want to delete this message?')) return;
        
        try {
            let collection = 'messages';
            if (messageType === 'community') collection = 'glrsChat';
            if (messageType === 'topic') collection = 'topicRoomMessages';
            
            await db.collection(collection).doc(messageId).delete();
            
            // Flag content for moderation record
            await db.collection('flaggedContent').add({
                originalCollection: collection,
                originalId: messageId,
                userId: pirId,
                flaggedBy: user.uid,
                reason: 'Deleted by coach',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await loadAllUserMessages();
            alert('Message deleted and flagged');
        } catch (error) {
            console.error('Error deleting message:', error);
            alert('Failed to delete message');
        }
    };

 const renderOverviewTab = () => (
    <div style={{ padding: '20px' }}>
        {/* Key Metrics Cards */}
        <div style={{ 
            display: 'grid', 
            gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
            gap: '20px',
            marginBottom: '30px'
        }}>
            <div style={{
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                padding: '20px',
                borderRadius: '15px',
                color: 'white',
                boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
            }}>
                <div style={{ fontSize: '14px', opacity: 0.9 }}>Sobriety Days</div>
                <div style={{ fontSize: '36px', fontWeight: 'bold' }}>
                    {pirData.sobrietyDays}
                </div>
                <div style={{ fontSize: '12px', opacity: 0.8 }}>
                    Since {formatDate(pirData.sobrietyDate)}
                </div>
            </div>

            <div style={{
                background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                padding: '20px',
                borderRadius: '15px',
                color: 'white',
                boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
            }}>
                <div style={{ fontSize: '14px', opacity: 0.9 }}>Current Streak</div>
                <div style={{ fontSize: '36px', fontWeight: 'bold' }}>
                    {streakData.currentStreak || 0} üî•
                </div>
                <div style={{ fontSize: '12px', opacity: 0.8 }}>
                    Best: {streakData.longestStreak || 0} days
                </div>
            </div>

            <div style={{
                background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                padding: '20px',
                borderRadius: '15px',
                color: 'white',
                boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
            }}>
                <div style={{ fontSize: '14px', opacity: 0.9 }}>Last Login</div>
                <div style={{ fontSize: '16px', fontWeight: 'bold' }}>
                    {pirData.lastLoginFormatted}
                </div>
                <div style={{ fontSize: '12px', opacity: 0.8 }}>
                    Account age: {pirData.accountAge} days
                </div>
            </div>

            <div style={{
                background: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                padding: '20px',
                borderRadius: '15px',
                color: 'white',
                boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
            }}>
                <div style={{ fontSize: '14px', opacity: 0.9 }}>Money Saved</div>
                <div style={{ fontSize: '36px', fontWeight: 'bold' }}>
                    ${pirData.moneySaved}
                </div>
                <div style={{ fontSize: '12px', opacity: 0.8 }}>
                    ${pirData.dailyCost || 20}/day saved
                </div>
            </div>
        </div>
        
        {/* Profile Information */}
        <div style={{
            background: 'white',
            borderRadius: '15px',
            padding: '25px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
            marginBottom: '20px'
        }}>
            <div style={{ 
                display: 'flex', 
                justifyContent: 'space-between', 
                alignItems: 'center',
                marginBottom: '20px'
            }}>
                <h3 style={{ margin: 0, color: '#333' }}>Profile Information</h3>
                {!editing ? (
                    <button 
                        className="btn btn-secondary"
                        onClick={() => setEditing(true)}
                    >
                        Edit Profile
                    </button>
                ) : (
                    <div style={{ display: 'flex', gap: '10px' }}>
                        <button 
                            className="btn btn-primary"
                            onClick={handleSaveProfile}
                        >
                            Save Changes
                        </button>
                        <button 
                            className="btn btn-secondary"
                            onClick={() => {
                                setEditing(false);
                                setEditData(pirData);
                            }}
                        >
                            Cancel
                        </button>
                    </div>
                )}
            </div>

            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
                <div>
                    <label style={{ fontWeight: 'bold', color: '#666' }}>Full Name</label>
                    {editing ? (
                        <div style={{ display: 'flex', gap: '10px' }}>
                            <input
                                type="text"
                                value={editData.firstName || ''}
                                onChange={(e) => setEditData({...editData, firstName: e.target.value})}
                                style={{ flex: 1, padding: '8px', borderRadius: '5px', border: '1px solid #ddd' }}
                            />
                            <input
                                type="text"
                                value={editData.lastName || ''}
                                onChange={(e) => setEditData({...editData, lastName: e.target.value})}
                                style={{ flex: 1, padding: '8px', borderRadius: '5px', border: '1px solid #ddd' }}
                            />
                        </div>
                    ) : (
                        <p style={{ color: '#333' }}>{pirData.firstName} {pirData.lastName}</p>
                    )}
                </div>

                <div>
                    <label style={{ fontWeight: 'bold', color: '#666' }}>Email</label>
                    <p style={{ color: '#333' }}>{pirData.email}</p>
                </div>

                <div>
                    <label style={{ fontWeight: 'bold', color: '#666' }}>Phone</label>
                    {editing ? (
                        <input
                            type="tel"
                            value={editData.phone || ''}
                            onChange={(e) => setEditData({...editData, phone: e.target.value})}
                            style={{ width: '100%', padding: '8px', borderRadius: '5px', border: '1px solid #ddd' }}
                        />
                    ) : (
                        <p style={{ color: '#333' }}>{pirData.phone || 'Not provided'}</p>
                    )}
                </div>

                <div>
                    <label style={{ fontWeight: 'bold', color: '#666' }}>Date of Birth</label>
                    {editing ? (
                        <input
                            type="date"
                            value={editData.dateOfBirth || ''}
                            onChange={(e) => setEditData({...editData, dateOfBirth: e.target.value})}
                            style={{ width: '100%', padding: '8px', borderRadius: '5px', border: '1px solid #ddd' }}
                        />
                    ) : (
                        <p style={{ color: '#333' }}>{pirData.dateOfBirth || 'Not provided'}</p>
                    )}
                </div>

                <div>
                    <label style={{ fontWeight: 'bold', color: '#666' }}>Sobriety Date</label>
                    {editing ? (
                        <input
                            type="date"
                            value={editData.sobrietyDate || ''}
                            onChange={(e) => setEditData({...editData, sobrietyDate: e.target.value})}
                            style={{ width: '100%', padding: '8px', borderRadius: '5px', border: '1px solid #ddd' }}
                        />
                    ) : (
                        <p style={{ color: '#333' }}>{formatDate(pirData.sobrietyDate)}</p>
                    )}
                </div>

                <div>
                    <label style={{ fontWeight: 'bold', color: '#666' }}>Substance</label>
                    <p style={{ color: '#333' }}>{pirData.substance || 'Not specified'}</p>
                </div>

                <div style={{ gridColumn: 'span 2' }}>
                    <label style={{ fontWeight: 'bold', color: '#666' }}>Address</label>
                    {editing ? (
                        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr 1fr', gap: '10px' }}>
                            <input
                                type="text"
                                value={editData.address?.street || ''}
                                onChange={(e) => setEditData({
                                    ...editData, 
                                    address: {...editData.address, street: e.target.value}
                                })}
                                placeholder="Street Address"
                                style={{ padding: '8px', borderRadius: '5px', border: '1px solid #ddd' }}
                            />
                            <input
                                type="text"
                                value={editData.address?.city || ''}
                                onChange={(e) => setEditData({
                                    ...editData, 
                                    address: {...editData.address, city: e.target.value}
                                })}
                                placeholder="City"
                                style={{ padding: '8px', borderRadius: '5px', border: '1px solid #ddd' }}
                            />
                            <input
                                type="text"
                                value={editData.address?.state || ''}
                                onChange={(e) => setEditData({
                                    ...editData, 
                                    address: {...editData.address, state: e.target.value}
                                })}
                                placeholder="State"
                                style={{ padding: '8px', borderRadius: '5px', border: '1px solid #ddd' }}
                            />
                            <input
                                type="text"
                                value={editData.address?.zip || ''}
                                onChange={(e) => setEditData({
                                    ...editData, 
                                    address: {...editData.address, zip: e.target.value}
                                })}
                                placeholder="ZIP"
                                style={{ padding: '8px', borderRadius: '5px', border: '1px solid #ddd' }}
                            />
                        </div>
                    ) : (
                        <p style={{ color: '#333' }}>
                            {pirData.address ? 
                                `${pirData.address.street || ''} ${pirData.address.city || ''}, ${pirData.address.state || ''} ${pirData.address.zip || ''}`.trim() : 
                                'Not provided'}
                        </p>
                    )}
                </div>
            </div>
        </div>

        {/* Assigned Coach Section - NEW */}
        <div style={{
            background: 'white',
            borderRadius: '15px',
            padding: '25px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
            marginBottom: '20px'
        }}>
            <h3 style={{ marginBottom: '20px', color: '#333' }}>Assigned Coach</h3>
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
                <div>
                    <label style={{ fontWeight: 'bold', color: '#666' }}>Current Coach</label>
                    {editing ? (
                        <select
                            value={editData.assignedCoach || ''}
                            onChange={(e) => setEditData({...editData, assignedCoach: e.target.value})}
                            style={{ 
                                width: '100%', 
                                padding: '8px', 
                                borderRadius: '5px', 
                                border: '1px solid #ddd',
                                fontSize: '14px'
                            }}
                        >
                            <option value="">-- No Coach Assigned --</option>
                            {availableCoaches.map(coach => (
                                <option key={coach.id} value={coach.id}>
                                    {coach.displayName || coach.email} ({coach.role})
                                </option>
                            ))}
                        </select>
                    ) : (
                        <p style={{ color: '#333' }}>
                            {availableCoaches.find(c => c.id === pirData.assignedCoach)?.displayName || 
                             availableCoaches.find(c => c.id === pirData.assignedCoach)?.email || 
                             'No coach assigned'}
                        </p>
                    )}
                </div>
                <div>
                    <label style={{ fontWeight: 'bold', color: '#666' }}>Coach Email</label>
                    <p style={{ color: '#333' }}>
                        {availableCoaches.find(c => c.id === pirData.assignedCoach)?.email || 'N/A'}
                    </p>
                </div>
            </div>
            
            {/* Coach Assignment History */}
            {pirData.coachAssignmentHistory && pirData.coachAssignmentHistory.length > 0 && (
                <div style={{ marginTop: '20px', paddingTop: '20px', borderTop: '1px solid #eee' }}>
                    <h4 style={{ fontSize: '14px', color: '#666', marginBottom: '10px' }}>Assignment History</h4>
                    <div style={{ fontSize: '12px', color: '#999' }}>
                        {pirData.coachAssignmentHistory.slice(0, 3).map((history, index) => (
                            <div key={index} style={{ padding: '5px 0' }}>
                                {formatDate(history.assignedAt)} - Assigned to {history.coachName || 'Unknown'}
                            </div>
                        ))}
                    </div>
                </div>
            )}
        </div>

        {/* Emergency Contacts */}
        <div style={{
            background: 'white',
            borderRadius: '15px',
            padding: '25px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
            marginBottom: '20px'
        }}>
            <h3 style={{ marginBottom: '20px', color: '#333' }}>Emergency Contacts</h3>
            {pirData.emergencyContacts && pirData.emergencyContacts.length > 0 ? (
                <div style={{ display: 'grid', gap: '15px' }}>
                    {pirData.emergencyContacts.map((contact, index) => (
                        <div key={index} style={{
                            padding: '15px',
                            background: contact.isPrimary ? '#f0f8ff' : '#f9f9f9',
                            borderRadius: '10px',
                            border: contact.isPrimary ? '2px solid #4CAF50' : '1px solid #ddd'
                        }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <div>
                                    <div style={{ fontWeight: 'bold', fontSize: '16px', color: '#333' }}>
                                        {contact.name} 
                                        {contact.isPrimary && (
                                            <span style={{
                                                marginLeft: '10px',
                                                background: '#4CAF50',
                                                color: 'white',
                                                padding: '2px 8px',
                                                borderRadius: '12px',
                                                fontSize: '12px'
                                            }}>PRIMARY</span>
                                        )}
                                    </div>
                                    <div style={{ color: '#666', marginTop: '5px' }}>
                                        {contact.relationship} ‚Ä¢ {contact.phone}
                                    </div>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            ) : (
                <p style={{ color: '#666' }}>No emergency contacts configured</p>
            )}
        </div>

        {/* Sponsor Information */}
        <div style={{
            background: 'white',
            borderRadius: '15px',
            padding: '25px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
            <h3 style={{ marginBottom: '20px', color: '#333' }}>Sponsor Information</h3>
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
                <div>
                    <label style={{ fontWeight: 'bold', color: '#666' }}>Sponsor Name</label>
                    {editing ? (
                        <input
                            type="text"
                            value={editData.sponsorName || ''}
                            onChange={(e) => setEditData({...editData, sponsorName: e.target.value})}
                            style={{ width: '100%', padding: '8px', borderRadius: '5px', border: '1px solid #ddd' }}
                        />
                    ) : (
                        <p style={{ color: '#333' }}>{pirData.sponsorName || 'Not assigned'}</p>
                    )}
                </div>
                <div>
                    <label style={{ fontWeight: 'bold', color: '#666' }}>Sponsor Phone</label>
                    {editing ? (
                        <input
                            type="tel"
                            value={editData.sponsorPhone || ''}
                            onChange={(e) => setEditData({...editData, sponsorPhone: e.target.value})}
                            style={{ width: '100%', padding: '8px', borderRadius: '5px', border: '1px solid #ddd' }}
                        />
                    ) : (
                        <p style={{ color: '#333' }}>{pirData.sponsorPhone || 'Not provided'}</p>
                    )}
                </div>
            </div>
        </div>
    </div>
);

  const renderGoldenThreadTab = () => {
    // Handler functions for creating items
    const handleCreateGoldenThread = async (threadData) => {
        try {
            for (const goal of threadData.goals) {
                if (!goal.title) continue;
                
                const goalRef = await db.collection('goals').add({
                    userId: pirId,
                    title: goal.title,
                    description: goal.description,
                    dueDate: goal.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(goal.dueDate)) : null,
                    status: 'active',
                    createdBy: user.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                for (let i = 0; i < goal.objectives.length; i++) {
                    const objective = goal.objectives[i];
                    if (!objective.title) continue;
                    
                    const objectiveRef = await db.collection('objectives').add({
                        goalId: goalRef.id,
                        userId: pirId,
                        title: objective.title,
                        order: i + 1,
                        dueDate: objective.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(objective.dueDate)) : null,
                        status: 'active',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    for (const assignment of objective.assignments) {
                        if (!assignment.title) continue;
                        
                        await db.collection('assignments').add({
                            goalId: goalRef.id,
                            objectiveId: objectiveRef.id,
                            userId: pirId,
                            pirName: pirData.displayName || pirData.email,
                            coachId: user.uid,
                            coachName: user.displayName || user.email,
                            title: assignment.title,
                            description: assignment.description,
                            dueDate: assignment.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(assignment.dueDate)) : null,
                            status: 'pending',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }
            }
            
            await loadGoalsData();
            await loadObjectivesData();
            await loadAssignmentsData();
            setShowGoldenThread(false);
            alert('Golden Thread created successfully!');
        } catch (error) {
            console.error('Error creating golden thread:', error);
            alert('Failed to create golden thread');
        }
    };

    const handleAddGoal = async (goalData) => {
        try {
            await db.collection('goals').add({
                userId: pirId,
                title: goalData.title,
                description: goalData.description,
                dueDate: goalData.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(goalData.dueDate)) : null,
                status: 'active',
                createdBy: user.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await loadGoalsData();
            setShowAddGoal(false);
            alert('Goal added successfully');
        } catch (error) {
            console.error('Error adding goal:', error);
            alert('Failed to add goal');
        }
    };

    const handleAddObjective = async (objectiveData) => {
        try {
            const objectivesCount = objectives.filter(o => o.goalId === selectedGoalForObjective.id).length;
            
            await db.collection('objectives').add({
                goalId: selectedGoalForObjective.id,
                userId: pirId,
                title: objectiveData.title,
                order: objectivesCount + 1,
                dueDate: objectiveData.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(objectiveData.dueDate)) : null,
                status: 'active',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await loadObjectivesData();
            setShowAddObjective(false);
            setSelectedGoalForObjective(null);
            alert('Objective added successfully');
        } catch (error) {
            console.error('Error adding objective:', error);
            alert('Failed to add objective');
        }
    };

    const handleAddAssignment = async (assignmentData) => {
        try {
            await db.collection('assignments').add({
                goalId: selectedObjectiveForAssignment.goalId,
                objectiveId: selectedObjectiveForAssignment.id,
                userId: pirId,
                pirName: pirData.displayName || pirData.email,
                coachId: user.uid,
                coachName: user.displayName || user.email,
                title: assignmentData.title,
                description: assignmentData.description,
                dueDate: assignmentData.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(assignmentData.dueDate)) : null,
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await loadAssignmentsData();
            setShowAddAssignment(false);
            setSelectedObjectiveForAssignment(null);
            alert('Assignment added successfully');
        } catch (error) {
            console.error('Error adding assignment:', error);
            alert('Failed to add assignment');
        }
    };

    return (
        <div style={{ padding: '20px' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                <h3 style={{ margin: 0, color: '#333' }}>Recovery Journey Structure</h3>
                <div style={{ display: 'flex', gap: '10px' }}>
                    <button
                        className="btn btn-primary"
                        onClick={() => setShowGoldenThread(true)}
                        style={{
                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            border: 'none',
                            color: 'white',
                            padding: '10px 20px',
                            borderRadius: '8px',
                            cursor: 'pointer'
                        }}
                    >
                        + Golden Thread
                    </button>
                    <button
                        className="btn btn-secondary"
                        onClick={() => setShowAddGoal(true)}
                        style={{
                            background: '#4CAF50',
                            border: 'none',
                            color: 'white',
                            padding: '10px 20px',
                            borderRadius: '8px',
                            cursor: 'pointer'
                        }}
                    >
                        + Add Goal
                    </button>
                </div>
            </div>
            
            {/* Goals list with add objective/assignment capabilities */}
            {goals.length > 0 ? (
                goals.map(goal => (
                    <div key={goal.id} style={{
                        background: 'white',
                        borderRadius: '15px',
                        padding: '20px',
                        marginBottom: '20px',
                        boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                        borderLeft: `4px solid ${goal.status === 'completed' ? '#4CAF50' : '#2196F3'}`
                    }}>
                        <div 
                            style={{ 
                                display: 'flex', 
                                justifyContent: 'space-between', 
                                alignItems: 'center',
                                cursor: 'pointer'
                            }}
                            onClick={() => setExpandedGoals({...expandedGoals, [goal.id]: !expandedGoals[goal.id]})}
                        >
                            <div>
                                <h4 style={{ margin: 0, color: '#333' }}>
                                    {expandedGoals[goal.id] ? '‚ñº' : '‚ñ∂'} {goal.title}
                                </h4>
                                <p style={{ margin: '5px 0', color: '#666' }}>{goal.description}</p>
                            </div>
                            <div style={{
                                background: `conic-gradient(#4CAF50 0% ${goal.progress || 0}%, #e0e0e0 ${goal.progress || 0}% 100%)`,
                                width: '60px',
                                height: '60px',
                                borderRadius: '50%',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center'
                            }}>
                                <div style={{
                                    background: 'white',
                                    width: '50px',
                                    height: '50px',
                                    borderRadius: '50%',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    fontWeight: 'bold',
                                    color: '#333'
                                }}>
                                    {goal.progress || 0}%
                                </div>
                            </div>
                        </div>
                        
                        {expandedGoals[goal.id] && (
                            <div style={{ marginTop: '20px' }}>
                                <div style={{ display: 'flex', gap: '10px', marginBottom: '15px' }}>
                                    <button 
                                        className="btn btn-secondary"
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            setSelectedGoalForObjective(goal);
                                            setShowAddObjective(true);
                                        }}
                                        style={{
                                            background: '#2196F3',
                                            border: 'none',
                                            color: 'white',
                                            padding: '8px 16px',
                                            borderRadius: '5px',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        + Add Objective
                                    </button>
                                </div>
                                
                                {/* Objectives */}
                                <div style={{ marginBottom: '15px' }}>
                                    <h5 style={{ color: '#666', marginBottom: '10px' }}>Objectives</h5>
                                    {objectives.filter(o => o.goalId === goal.id).map(objective => (
                                        <div key={objective.id} style={{
                                            background: '#f9f9f9',
                                            padding: '10px',
                                            borderRadius: '8px',
                                            marginBottom: '10px',
                                            borderLeft: `3px solid ${objective.status === 'completed' ? '#4CAF50' : '#FF9800'}`
                                        }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                <strong style={{ color: '#333' }}>#{objective.order} - {objective.title}</strong>
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        setSelectedObjectiveForAssignment(objective);
                                                        setShowAddAssignment(true);
                                                    }}
                                                    style={{
                                                        background: '#9C27B0',
                                                        border: 'none',
                                                        color: 'white',
                                                        padding: '4px 12px',
                                                        borderRadius: '4px',
                                                        cursor: 'pointer',
                                                        fontSize: '12px'
                                                    }}
                                                >
                                                    + Assignment
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                
                                {/* Assignments */}
                                <div>
                                    <h5 style={{ color: '#666', marginBottom: '10px' }}>Assignments</h5>
                                    {assignments.filter(a => a.goalId === goal.id).map(assignment => (
                                        <div key={assignment.id} style={{
                                            background: '#f5f5f5',
                                            padding: '10px',
                                            borderRadius: '8px',
                                            marginBottom: '10px',
                                            borderLeft: `3px solid ${assignment.status === 'completed' ? '#4CAF50' : '#2196F3'}`
                                        }}>
                                            <strong style={{ color: '#333' }}>{assignment.title}</strong>
                                            <div style={{ fontSize: '12px', color: '#666' }}>
                                                {assignment.description}
                                            </div>
                                            <div style={{ fontSize: '11px', color: '#999', marginTop: '5px' }}>
                                                Due: {formatDate(assignment.dueDate)} ‚Ä¢ Status: {assignment.status}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                ))
            ) : (
                <div style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '40px',
                    textAlign: 'center',
                    color: '#666'
                }}>
                    <p>No goals configured yet</p>
                    <p style={{ fontSize: '14px' }}>Click "Golden Thread" or "Add Goal" to get started</p>
                </div>
            )}

            {/* Golden Thread Modal */}
            {showGoldenThread && (
                <CreateGoalModal
                    type="goldenThread"
                    selectedPIR={{ id: pirId, displayName: pirData?.displayName, email: pirData?.email }}
                    selectedParent={null}
                    onSubmit={handleCreateGoldenThread}
                    onClose={() => setShowGoldenThread(false)}
                />
            )}

            {/* Add Goal Modal */}
            {showAddGoal && (
                <CreateGoalModal
                    type="goal"
                    selectedPIR={{ id: pirId }}
                    selectedParent={null}
                    onSubmit={handleAddGoal}
                    onClose={() => setShowAddGoal(false)}
                />
            )}

            {/* Add Objective Modal */}
            {showAddObjective && (
                <CreateGoalModal
                    type="objective"
                    selectedPIR={{ id: pirId }}
                    selectedParent={selectedGoalForObjective}
                    onSubmit={handleAddObjective}
                    onClose={() => {
                        setShowAddObjective(false);
                        setSelectedGoalForObjective(null);
                    }}
                />
            )}

            {/* Add Assignment Modal */}
            {showAddAssignment && (
                <CreateGoalModal
                    type="assignment"
                    selectedPIR={{ id: pirId }}
                    selectedParent={selectedObjectiveForAssignment}
                    onSubmit={handleAddAssignment}
                    onClose={() => {
                        setShowAddAssignment(false);
                        setSelectedObjectiveForAssignment(null);
                    }}
                />
            )}
        </div>
    );
};  // FIXED: Removed the extra closing brace here

  const renderProgressTab = () => (
    <div style={{ padding: '20px' }}>
        {/* Compliance Metrics */}
        <div style={{
            background: 'white',
            borderRadius: '15px',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
            <h3 style={{ marginBottom: '20px', color: '#333' }}>
                Compliance Metrics (Last {complianceData.daysTracked} Days)
            </h3>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '20px' }}>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '36px', fontWeight: 'bold', color: '#4CAF50' }}>
                        {complianceData.morningRate}%
                    </div>
                    <div style={{ color: '#666' }}>Morning Check-ins</div>
                </div>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '36px', fontWeight: 'bold', color: '#2196F3' }}>
                        {complianceData.eveningRate}%
                    </div>
                    <div style={{ color: '#666' }}>Evening Reflections</div>
                </div>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '36px', fontWeight: 'bold', color: '#FF9800' }}>
                        {complianceData.assignmentRate}%
                    </div>
                    <div style={{ color: '#666' }}>Assignments Complete</div>
                </div>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '36px', fontWeight: 'bold', color: '#9C27B0' }}>
                        {complianceData.totalCheckIns}
                    </div>
                    <div style={{ color: '#666' }}>Total Check-ins</div>
                </div>
            </div>
        </div>

        {/* Check-ins History Table - Keep as is */}
        <div style={{
            background: 'white',
            borderRadius: '15px',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
            <h3 style={{ marginBottom: '20px', color: '#333' }}>Check-in History</h3>
            <div style={{ overflowX: 'auto' }}>
                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                    <thead>
                        <tr style={{ borderBottom: '2px solid #333', background: '#f0f0f0' }}>
                            <th style={{ padding: '12px', textAlign: 'left', color: '#333', fontWeight: 'bold' }}>Date</th>
                            <th style={{ padding: '12px', textAlign: 'center', color: '#333', fontWeight: 'bold' }}>Morning</th>
                            <th style={{ padding: '12px', textAlign: 'center', color: '#333', fontWeight: 'bold' }}>Evening</th>
                            <th style={{ padding: '12px', textAlign: 'center', color: '#333', fontWeight: 'bold' }}>Mood</th>
                            <th style={{ padding: '12px', textAlign: 'center', color: '#333', fontWeight: 'bold' }}>Craving</th>
                            <th style={{ padding: '12px', textAlign: 'center', color: '#333', fontWeight: 'bold' }}>Sleep</th>
                            <th style={{ padding: '12px', textAlign: 'left', color: '#333', fontWeight: 'bold' }}>Daily Pledge</th>
                        </tr>
                    </thead>
                    <tbody>
                        {checkIns && checkIns.length > 0 ? (
                            checkIns.map((checkIn, index) => (
                                <tr key={checkIn.id} style={{ 
                                    borderBottom: '1px solid #ddd',
                                    background: index % 2 === 0 ? '#ffffff' : '#f8f9fa'
                                }}>
                                    <td style={{ padding: '10px', color: '#333', fontWeight: '500' }}>
                                        {formatDate(checkIn.createdAt)}
                                    </td>
                                    <td style={{ padding: '10px', textAlign: 'center' }}>
                                        {checkIn.morningData ? (
                                            <span style={{ color: '#4CAF50', fontSize: '18px', fontWeight: 'bold' }}>‚úì</span>
                                        ) : (
                                            <span style={{ color: '#e0e0e0', fontSize: '18px' }}>‚úó</span>
                                        )}
                                    </td>
                                    <td style={{ padding: '10px', textAlign: 'center' }}>
                                        {checkIn.eveningData ? (
                                            <span style={{ color: '#2196F3', fontSize: '18px', fontWeight: 'bold' }}>‚úì</span>
                                        ) : (
                                            <span style={{ color: '#e0e0e0', fontSize: '18px' }}>‚úó</span>
                                        )}
                                    </td>
                                    <td style={{ padding: '10px', textAlign: 'center', color: '#333', fontWeight: '500' }}>
                                        {checkIn.morningData?.mood || checkIn.eveningData?.mood || '-'}/10
                                    </td>
                                    <td style={{ padding: '10px', textAlign: 'center', color: '#333', fontWeight: '500' }}>
                                        {checkIn.morningData?.craving || checkIn.eveningData?.craving || '-'}/10
                                    </td>
                                    <td style={{ padding: '10px', textAlign: 'center', color: '#333', fontWeight: '500' }}>
                                        {checkIn.morningData?.sleepQuality || '-'}/10
                                    </td>
                                    <td style={{ padding: '10px' }}>
                                        <div style={{ 
                                            maxWidth: '200px', 
                                            overflow: 'hidden', 
                                            textOverflow: 'ellipsis',
                                            whiteSpace: 'nowrap',
                                            fontSize: '12px',
                                            color: '#555',
                                            fontWeight: '400'
                                        }}>
                                            {checkIn.morningData?.dailyPledge || '-'}
                                        </div>
                                    </td>
                                </tr>
                            ))
                        ) : (
                            <tr>
                                <td colSpan="7" style={{ 
                                    padding: '40px', 
                                    textAlign: 'center', 
                                    color: '#666',
                                    background: '#f8f9fa'
                                }}>
                                    No check-ins recorded yet
                                </td>
                            </tr>
                        )}
                    </tbody>
                </table>
            </div>
        </div>

        {/* Progress Charts */}
        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px', marginBottom: '20px' }}>
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
            }}>
                <h4 style={{ marginBottom: '15px', color: '#333' }}>30-Day Mood Trend</h4>
                <div style={{ height: '200px' }}>
                    <canvas id={`mood-chart-${pirId}`}></canvas>
                </div>
            </div>
            
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
            }}>
                <h4 style={{ marginBottom: '15px', color: '#333' }}>30-Day Craving Trend</h4>
                <div style={{ height: '200px' }}>
                    <canvas id={`craving-chart-${pirId}`}></canvas>
                </div>
            </div>
            
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
            }}>
                <h4 style={{ marginBottom: '15px', color: '#333' }}>30-Day Anxiety Trend</h4>
                <div style={{ height: '200px' }}>
                    <canvas id={`anxiety-chart-${pirId}`}></canvas>
                </div>
            </div>
            
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
            }}>
                <h4 style={{ marginBottom: '15px', color: '#333' }}>30-Day Sleep Quality Trend</h4>
                <div style={{ height: '200px' }}>
                    <canvas id={`sleep-chart-${pirId}`}></canvas>
                </div>
            </div>
        </div>

        {/* Evening Reflections Section */}
        <div style={{
            background: 'white',
            borderRadius: '15px',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
            <h3 style={{ marginBottom: '20px', color: '#333' }}>Evening Reflections</h3>
            <div style={{ maxHeight: '500px', overflowY: 'auto' }}>
                {checkIns && checkIns.filter(c => c.eveningData).length > 0 ? (
                    checkIns.filter(c => c.eveningData).map((checkIn, index) => (
                        <div key={checkIn.id} style={{
                            padding: '20px',
                            marginBottom: '15px',
                            background: index % 2 === 0 ? '#f9f9f9' : '#f5f5f5',
                            borderRadius: '10px',
                            borderLeft: '4px solid #2196F3'
                        }}>
                            <div style={{ 
                                display: 'flex', 
                                justifyContent: 'space-between', 
                                alignItems: 'center',
                                marginBottom: '15px'
                            }}>
                                <h5 style={{ margin: 0, color: '#333' }}>
                                    {formatDate(checkIn.createdAt)}
                                </h5>
                                <div style={{
                                    background: '#2196F3',
                                    color: 'white',
                                    padding: '4px 12px',
                                    borderRadius: '12px',
                                    fontSize: '12px'
                                }}>
                                    Overall Day: {checkIn.eveningData.overallDay || 0}/10
                                </div>
                            </div>
                            
                            <div style={{ display: 'grid', gap: '12px' }}>
                                {checkIn.eveningData.gratitude && (
                                    <div>
                                        <strong style={{ color: '#4CAF50', fontSize: '13px' }}>Gratitude:</strong>
                                        <p style={{ 
                                            margin: '4px 0', 
                                            color: '#333', 
                                            fontSize: '14px',
                                            lineHeight: '1.5'
                                        }}>
                                            {checkIn.eveningData.gratitude}
                                        </p>
                                    </div>
                                )}
                                
                                {checkIn.eveningData.challenges && (
                                    <div>
                                        <strong style={{ color: '#FF9800', fontSize: '13px' }}>Challenges:</strong>
                                        <p style={{ 
                                            margin: '4px 0', 
                                            color: '#333', 
                                            fontSize: '14px',
                                            lineHeight: '1.5'
                                        }}>
                                            {checkIn.eveningData.challenges}
                                        </p>
                                    </div>
                                )}
                                
                                {checkIn.eveningData.tomorrowGoal && (
                                    <div>
                                        <strong style={{ color: '#9C27B0', fontSize: '13px' }}>Tomorrow's Goal:</strong>
                                        <p style={{ 
                                            margin: '4px 0', 
                                            color: '#333', 
                                            fontSize: '14px',
                                            lineHeight: '1.5'
                                        }}>
                                            {checkIn.eveningData.tomorrowGoal}
                                        </p>
                                    </div>
                                )}
                            </div>
                        </div>
                    ))
                ) : (
                    <div style={{ 
                        padding: '40px', 
                        textAlign: 'center', 
                        color: '#666' 
                    }}>
                        No evening reflections recorded yet
                    </div>
                )}
            </div>
        </div>

        {/* Pledges Section */}
        <div style={{
            background: 'white',
            borderRadius: '15px',
            padding: '20px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
            <h3 style={{ marginBottom: '20px', color: '#333' }}>Daily Pledges</h3>
            <div style={{ maxHeight: '400px', overflowY: 'auto' }}>
                {pledges && pledges.length > 0 ? (
                    pledges.map((pledge, index) => (
                        <div key={pledge.id} style={{
                            padding: '15px',
                            marginBottom: '10px',
                            background: index % 2 === 0 ? '#f9f9f9' : '#f5f5f5',
                            borderRadius: '8px',
                            borderLeft: `4px solid ${pledge.completed ? '#4CAF50' : '#FF9800'}`
                        }}>
                            <div style={{ 
                                display: 'flex', 
                                justifyContent: 'space-between', 
                                alignItems: 'center',
                                marginBottom: '8px'
                            }}>
                                <span style={{ 
                                    fontSize: '12px', 
                                    color: '#666' 
                                }}>
                                    {formatDate(pledge.createdAt)}
                                </span>
                                {pledge.completed && (
                                    <span style={{ 
                                        color: '#4CAF50', 
                                        fontSize: '16px' 
                                    }}>‚úì</span>
                                )}
                            </div>
                            <p style={{ 
                                margin: 0, 
                                color: '#333', 
                                fontSize: '14px',
                                lineHeight: '1.5'
                            }}>
                                {pledge.content || pledge.text || pledge.pledge}
                            </p>
                        </div>
                    ))
                ) : (
                    <div style={{ 
                        padding: '30px', 
                        textAlign: 'center', 
                        color: '#666' 
                    }}>
                        No pledges recorded yet
                    </div>
                )}
            </div>
        </div>
    </div>
);
  
    const renderMilestonesTab = () => {
    // Calculate milestones based on sobriety date
    const calculateMilestones = () => {
        if (!pirData?.sobrietyDate) return [];
        
        const sobrietyDate = pirData.sobrietyDate?.toDate ? pirData.sobrietyDate.toDate() : new Date(pirData.sobrietyDate);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        sobrietyDate.setHours(0, 0, 0, 0);  // FIXED: Changed from 'sobriety' to 'sobrietyDate'
        
        const standardMilestones = [
            { days: 1, title: '24 Hours', icon: 'üåÖ', description: 'The first day - the hardest step' },
            { days: 3, title: '3 Days', icon: 'üí™', description: 'Past the acute phase' },
            { days: 7, title: 'One Week', icon: 'üìÖ', description: 'A full week of sobriety' },
            { days: 14, title: 'Two Weeks', icon: 'üåü', description: 'Building momentum' },
            { days: 30, title: 'One Month', icon: 'üìÜ', description: 'First major milestone' },
            { days: 60, title: 'Two Months', icon: 'üèÉ', description: 'Establishing new habits' },
            { days: 90, title: 'Three Months', icon: 'üèÜ', description: 'Quarter year achieved' },
            { days: 120, title: 'Four Months', icon: 'üéØ', description: 'Solid foundation built' },
            { days: 180, title: 'Six Months', icon: '‚≠ê', description: 'Half year milestone' },
            { days: 365, title: 'One Year', icon: 'üéâ', description: 'Full year of recovery' },
            { days: 548, title: '18 Months', icon: 'üåà', description: 'A year and a half strong' },
            { days: 730, title: 'Two Years', icon: 'üéä', description: 'Two years of sobriety' },
            { days: 1095, title: 'Three Years', icon: 'üèÖ', description: 'Three years of growth' },
            { days: 1825, title: 'Five Years', icon: 'üëë', description: 'Half a decade of recovery' },
            { days: 3650, title: 'Ten Years', icon: 'üíé', description: 'A decade of sobriety' }
        ];
        
        return standardMilestones.map(m => {
            const targetDate = new Date(sobrietyDate);
            targetDate.setDate(targetDate.getDate() + m.days);
            const achieved = today >= targetDate;
            const daysUntil = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
            
            return {
                ...m,
                targetDate,
                achieved,
                daysUntil: achieved ? 0 : daysUntil,
                achievedDate: achieved ? targetDate : null,
                id: `standard-${m.days}`
            };
        });
    };
    
    const allMilestones = calculateMilestones();
    const achievedMilestones = allMilestones.filter(m => m.achieved);
    const upcomingMilestones = allMilestones.filter(m => !m.achieved).slice(0, 6); // Next 6 upcoming
    
    return (
        <div style={{ padding: '20px' }}>
            <h3 style={{ marginBottom: '30px', color: '#333' }}>Recovery Milestones</h3>
            
            {/* Summary Stats */}
            <div style={{
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                borderRadius: '15px',
                padding: '25px',
                marginBottom: '30px',
                color: 'white',
                textAlign: 'center'
            }}>
                <div style={{ fontSize: '48px', fontWeight: 'bold', marginBottom: '10px' }}>
                    {achievedMilestones.length}
                </div>
                <div style={{ fontSize: '18px', opacity: 0.9 }}>
                    Milestones Achieved
                </div>
                <div style={{ fontSize: '14px', opacity: 0.8, marginTop: '10px' }}>
                    {pirData?.sobrietyDays || 0} days of continuous sobriety
                </div>
            </div>
            
            {/* Achieved Milestones Section */}
            {achievedMilestones.length > 0 && (
                <>
                    <h4 style={{ marginBottom: '20px', color: '#333' }}>Achieved Milestones üéâ</h4>
                    <div style={{ 
                        display: 'grid', 
                        gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
                        gap: '20px',
                        marginBottom: '40px'
                    }}>
                        {achievedMilestones.map((milestone, index) => (
                            <div key={milestone.id || index} style={{
                                background: 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)',
                                borderRadius: '15px',
                                padding: '20px',
                                boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                                position: 'relative',
                                overflow: 'hidden',
                                transform: 'scale(1)',
                                transition: 'transform 0.2s',
                                cursor: 'pointer'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.05)'}
                            onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}>
                                <div style={{
                                    position: 'absolute',
                                    top: '10px',
                                    right: '10px',
                                    fontSize: '24px',
                                    color: 'rgba(255,255,255,0.9)'
                                }}>
                                    ‚úì
                                </div>
                                <div style={{
                                    fontSize: '36px',
                                    marginBottom: '10px',
                                    textAlign: 'center'
                                }}>
                                    {milestone.icon}
                                </div>
                                <h5 style={{
                                    margin: '0 0 10px 0',
                                    color: 'white',
                                    textAlign: 'center',
                                    fontSize: '16px',
                                    fontWeight: 'bold'
                                }}>
                                    {milestone.title}
                                </h5>
                                <p style={{
                                    fontSize: '12px',
                                    color: 'rgba(255,255,255,0.9)',
                                    textAlign: 'center',
                                    margin: '0 0 10px 0'
                                }}>
                                    {milestone.description}
                                </p>
                                <div style={{
                                    fontSize: '11px',
                                    color: 'rgba(255,255,255,0.8)',
                                    textAlign: 'center',
                                    fontWeight: 'bold'
                                }}>
                                    Achieved on {formatDate(milestone.achievedDate)}
                                </div>
                            </div>
                        ))}
                    </div>
                </>
            )}
            
            {/* Upcoming Milestones Section */}
            {upcomingMilestones.length > 0 && (
                <>
                    <h4 style={{ marginBottom: '20px', color: '#333' }}>Upcoming Milestones üéØ</h4>
                    <div style={{ 
                        display: 'grid', 
                        gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
                        gap: '20px' 
                    }}>
                        {upcomingMilestones.map((milestone, index) => (
                            <div key={milestone.id || index} style={{
                                background: 'white',
                                borderRadius: '15px',
                                padding: '20px',
                                boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                                border: '2px solid #e0e0e0',
                                position: 'relative',
                                overflow: 'hidden',
                                transform: 'scale(1)',
                                transition: 'all 0.2s',
                                cursor: 'pointer'
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.transform = 'scale(1.05)';
                                e.currentTarget.style.borderColor = '#667eea';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.transform = 'scale(1)';
                                e.currentTarget.style.borderColor = '#e0e0e0';
                            }}>
                                {milestone.daysUntil <= 7 && (
                                    <div style={{
                                        position: 'absolute',
                                        top: '10px',
                                        right: '10px',
                                        background: '#FF9800',
                                        color: 'white',
                                        padding: '2px 8px',
                                        borderRadius: '12px',
                                        fontSize: '10px',
                                        fontWeight: 'bold'
                                    }}>
                                        SOON!
                                    </div>
                                )}
                                <div style={{
                                    fontSize: '36px',
                                    marginBottom: '10px',
                                    textAlign: 'center',
                                    opacity: 0.7
                                }}>
                                    {milestone.icon}
                                </div>
                                <h5 style={{
                                    margin: '0 0 10px 0',
                                    color: '#333',
                                    textAlign: 'center',
                                    fontSize: '16px',
                                    fontWeight: 'bold'
                                }}>
                                    {milestone.title}
                                </h5>
                                <p style={{
                                    fontSize: '12px',
                                    color: '#666',
                                    textAlign: 'center',
                                    margin: '0 0 15px 0'
                                }}>
                                    {milestone.description}
                                </p>
                                <div style={{
                                    background: '#f5f5f5',
                                    borderRadius: '20px',
                                    padding: '8px',
                                    textAlign: 'center'
                                }}>
                                    <div style={{
                                        fontSize: '20px',
                                        fontWeight: 'bold',
                                        color: milestone.daysUntil <= 7 ? '#FF9800' : '#667eea'
                                    }}>
                                        {milestone.daysUntil}
                                    </div>
                                    <div style={{
                                        fontSize: '11px',
                                        color: '#999',
                                        textTransform: 'uppercase'
                                    }}>
                                        days to go
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </>
            )}
            
            {allMilestones.length === 0 && (
                <div style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '40px',
                    textAlign: 'center',
                    color: '#666'
                }}>
                    <p>No milestones configured yet</p>
                    <p style={{ fontSize: '14px', marginTop: '10px' }}>
                        Milestones will appear once a sobriety date is set
                    </p>
                </div>
            )}
        </div>
    );
};

   

// Fixed renderCommunicationsTab
const renderCommunicationsTab = () => {
    // Add a delete message handler if not already defined
    const handleDeleteMessage = async (messageId, messageType) => {
        if (!confirm('Are you sure you want to delete this message?')) return;
        
        try {
            let collection = 'messages';
            if (messageType === 'community') collection = 'glrsChat';
            if (messageType === 'topic') collection = 'topicRoomMessages';
            
            await db.collection(collection).doc(messageId).delete();
            
            // Flag content for moderation record
            await db.collection('flaggedContent').add({
                originalCollection: collection,
                originalId: messageId,
                userId: pirId,
                flaggedBy: user.uid,
                reason: 'Deleted by coach',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await loadAllUserMessages();
            alert('Message deleted and flagged');
        } catch (error) {
            console.error('Error deleting message:', error);
            alert('Failed to delete message');
        }
    };
    
    return (
        <div style={{ padding: '20px' }}>
            <h3 style={{ marginBottom: '20px', color: '#333' }}>Communication Activity</h3>
            
            {/* Message Stats */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                marginBottom: '20px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
            }}>
                <h4 style={{ marginBottom: '15px', color: '#333' }}>Engagement Metrics</h4>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '20px' }}>
                    <div style={{ textAlign: 'center' }}>
                        <div style={{ fontSize: '36px', fontWeight: 'bold', color: '#2196F3' }}>
                            {allMessages.length}
                        </div>
                        <div style={{ color: '#666' }}>Total Messages</div>
                    </div>
                    <div style={{ textAlign: 'center' }}>
                        <div style={{ fontSize: '36px', fontWeight: 'bold', color: '#4CAF50' }}>
                            {allMessages.filter(m => m.type === 'community').length}
                        </div>
                        <div style={{ color: '#666' }}>Community Posts</div>
                    </div>
                    <div style={{ textAlign: 'center' }}>
                        <div style={{ fontSize: '36px', fontWeight: 'bold', color: '#FF9800' }}>
                            {allMessages.filter(m => m.type === 'topic').length}
                        </div>
                        <div style={{ color: '#666' }}>Topic Room Posts</div>
                    </div>
                    <div style={{ textAlign: 'center' }}>
                        <div style={{ fontSize: '36px', fontWeight: 'bold', color: '#9C27B0' }}>
                            {allMessages.filter(m => m.type === 'direct').length}
                        </div>
                        <div style={{ color: '#666' }}>Direct Messages</div>
                    </div>
                </div>
            </div>

            {/* All Messages with Moderation Controls */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
            }}>
                <h4 style={{ marginBottom: '15px', color: '#333' }}>Message History</h4>
                {allMessages.length > 0 ? (
                    <div style={{ maxHeight: '600px', overflowY: 'auto' }}>
                        {allMessages.map(message => (
                            <div key={message.id} style={{
                                padding: '15px',
                                borderBottom: '1px solid #eee',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'start'
                            }}>
                                <div style={{ flex: 1 }}>
                                    <div style={{ display: 'flex', gap: '10px', marginBottom: '5px' }}>
                                        <span style={{
                                            background: message.type === 'community' ? '#4CAF50' :
                                                       message.type === 'topic' ? '#FF9800' : '#2196F3',
                                            color: 'white',
                                            padding: '2px 8px',
                                            borderRadius: '12px',
                                            fontSize: '10px'
                                        }}>
                                            {message.type.toUpperCase()}
                                        </span>
                                        {message.roomId && (
                                            <span style={{ fontSize: '12px', color: '#999' }}>
                                                Room: {message.roomId}
                                            </span>
                                        )}
                                        <span style={{ fontSize: '12px', color: '#999' }}>
                                            {formatTimeAgo(message.createdAt)}
                                        </span>
                                    </div>
                                    <div style={{ color: '#333' }}>
                                        {message.content || message.text || message.message || 'No content'}
                                    </div>
                                    {message.imageUrl && (
                                        <div style={{ marginTop: '10px' }}>
                                            <img 
                                                src={message.imageUrl} 
                                                alt="Message attachment" 
                                                style={{ maxWidth: '200px', borderRadius: '8px' }}
                                            />
                                        </div>
                                    )}
                                </div>
                                <div style={{ display: 'flex', gap: '10px' }}>
                                    <button
                                        onClick={() => handleDeleteMessage(message.id, message.type)}
                                        style={{
                                            background: '#f44336',
                                            color: 'white',
                                            border: 'none',
                                            padding: '5px 10px',
                                            borderRadius: '5px',
                                            cursor: 'pointer',
                                            fontSize: '12px'
                                        }}
                                    >
                                        Delete
                                    </button>
                                    <button
                                        onClick={async () => {
                                            try {
                                                await db.collection('flaggedContent').add({
                                                    messageId: message.id,
                                                    messageType: message.type,
                                                    userId: pirId,
                                                    flaggedBy: user.uid,
                                                    reason: 'Flagged for review',
                                                    content: message.content || message.text,
                                                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                                });
                                                alert('Message flagged for review');
                                            } catch (error) {
                                                console.error('Error flagging message:', error);
                                                alert('Failed to flag message');
                                            }
                                        }}
                                        style={{
                                            background: '#FF9800',
                                            color: 'white',
                                            border: 'none',
                                            padding: '5px 10px',
                                            borderRadius: '5px',
                                            cursor: 'pointer',
                                            fontSize: '12px'
                                        }}
                                    >
                                        Flag
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                ) : (
                    <p style={{ color: '#666', padding: '20px', textAlign: 'center' }}>
                        No messages sent yet
                    </p>
                )}
            </div>
        </div>
    );
};

// Continue with renderResourcesTab, renderActivityTab, etc... (the rest of the code from my previous message)
// All render functions remain the same as provided earlier

// The return statement continues from my previous response...

  // This closes the UserDetailModal function
   const renderResourcesTab = () => (
    <div style={{ padding: '20px' }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
            <h3 style={{ margin: 0, color: '#333' }}>Resource Management</h3>
            <div style={{ display: 'flex', gap: '10px' }}>
                <button
                    className="btn btn-primary"
                    onClick={() => setShowAssignResource(true)}
                    style={{
                        background: 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)',
                        border: 'none',
                        color: 'white',
                        padding: '10px 20px',
                        borderRadius: '8px',
                        cursor: 'pointer'
                    }}
                >
                    Assign Resource
                </button>
                <button
                    className="btn btn-primary"
                    onClick={() => setShowCreateResource(true)}
                    style={{
                        background: 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)',
                        border: 'none',
                        color: 'white',
                        padding: '10px 20px',
                        borderRadius: '8px',
                        cursor: 'pointer'
                    }}
                >
                    Create Resource
                </button>
            </div>
        </div>
        
        {['education', 'coping', 'daily', 'life', 'support', 'relapse'].map(category => {
            const categoryResources = resources.filter(r => r.category === category);
            if (categoryResources.length === 0) return null;
            
            return (
                <div key={category} style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '20px',
                    marginBottom: '20px',
                    boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                }}>
                    <h4 style={{ marginBottom: '15px', color: '#333', textTransform: 'capitalize' }}>
                        {category} Resources ({categoryResources.length})
                    </h4>
                    <div style={{ display: 'grid', gap: '10px' }}>
                        {categoryResources.map(resource => (
                            <div key={resource.id} style={{
                                padding: '15px',
                                background: '#f9f9f9',
                                borderRadius: '8px',
                                borderLeft: `3px solid ${
                                    resourceProgress[resource.id]?.status === 'completed' ? '#4CAF50' :
                                    resourceProgress[resource.id]?.status === 'in-progress' ? '#FF9800' :
                                    '#2196F3'
                                }`,
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center'
                            }}>
                                <div style={{ flex: 1 }}>
                                    <strong style={{ color: '#333' }}>{resource.title}</strong>
                                    <p style={{ fontSize: '12px', color: '#666', margin: '5px 0' }}>
                                        {resource.description}
                                    </p>
                                    {resource.url && (
                                        <a href={resource.url} target="_blank" style={{
                                            fontSize: '11px',
                                            color: '#2196F3'
                                        }}>
                                            View Resource ‚Üí
                                        </a>
                                    )}
                                </div>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                    <span style={{
                                        background: resourceProgress[resource.id]?.status === 'completed' ? '#4CAF50' :
                                                   resourceProgress[resource.id]?.status === 'in-progress' ? '#FF9800' :
                                                   '#e0e0e0',
                                        color: 'white',
                                        padding: '4px 8px',
                                        borderRadius: '12px',
                                        fontSize: '10px'
                                    }}>
                                        {resourceProgress[resource.id]?.status || 'Not Started'}
                                    </span>
                                    <button
                                        onClick={async () => {
                                            if (confirm('Are you sure you want to unassign this resource?')) {
                                                try {
                                                    await db.collection('resources').doc(resource.id).update({
                                                        assignedTo: firebase.firestore.FieldValue.arrayRemove(pirId)
                                                    });
                                                    await loadResourcesData();
                                                    alert('Resource unassigned successfully');
                                                } catch (error) {
                                                    console.error('Error unassigning resource:', error);
                                                    alert('Failed to unassign resource');
                                                }
                                            }
                                        }}
                                        style={{
                                            background: '#f44336',
                                            color: 'white',
                                            border: 'none',
                                            padding: '4px 8px',
                                            borderRadius: '5px',
                                            cursor: 'pointer',
                                            fontSize: '10px'
                                        }}
                                    >
                                        Unassign
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        })}

        {/* Assign Resource Modal */}
        {showAssignResource && (
            <div style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0,0,0,0.5)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 10000
            }}>
                <div style={{
                    background: 'white',
                    padding: '30px',
                    borderRadius: '15px',
                    width: '600px',
                    maxWidth: '90%',
                    maxHeight: '80vh',
                    overflow: 'auto'
                }}>
                    <h3 style={{ marginBottom: '20px' }}>Assign Resource to {pirData?.firstName || 'PIR'}</h3>
                    
                    <div style={{ marginBottom: '20px' }}>
                        <label style={{ display: 'block', marginBottom: '10px', color: '#666' }}>
                            Select Resource to Assign:
                        </label>
                        <select 
                            id="resource-select"
                            style={{
                                width: '100%',
                                padding: '10px',
                                borderRadius: '5px',
                                border: '1px solid #ddd'
                            }}
                        >
                            <option value="">Choose a resource...</option>
                            {resources.filter(r => !r.assignedTo?.includes(pirId)).map(resource => (
                                <option key={resource.id} value={resource.id}>
                                    {resource.title} ({resource.category})
                                </option>
                            ))}
                        </select>
                    </div>
                    
                    <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                        <button
                            onClick={() => setShowAssignResource(false)}
                            style={{
                                padding: '10px 20px',
                                borderRadius: '5px',
                                border: '1px solid #ddd',
                                background: 'white',
                                cursor: 'pointer'
                            }}
                        >
                            Cancel
                        </button>
                        <button
                            onClick={async () => {
                                const select = document.getElementById('resource-select');
                                const resourceId = select.value;
                                if (resourceId) {
                                    try {
                                        await db.collection('resources').doc(resourceId).update({
                                            assignedTo: firebase.firestore.FieldValue.arrayUnion(pirId)
                                        });
                                        await loadResourcesData();
                                        setShowAssignResource(false);
                                        alert('Resource assigned successfully');
                                    } catch (error) {
                                        console.error('Error assigning resource:', error);
                                        alert('Failed to assign resource');
                                    }
                                } else {
                                    alert('Please select a resource');
                                }
                            }}
                            style={{
                                padding: '10px 20px',
                                borderRadius: '5px',
                                border: 'none',
                                background: 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)',
                                color: 'white',
                                cursor: 'pointer'
                            }}
                        >
                            Assign Resource
                        </button>
                    </div>
                </div>
            </div>
        )}

        {/* Create Resource Modal */}
        {showCreateResource && (
            <div style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0,0,0,0.5)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 10000
            }}>
                <div style={{
                    background: 'white',
                    padding: '30px',
                    borderRadius: '15px',
                    width: '600px',
                    maxWidth: '90%'
                }}>
                    <h3 style={{ marginBottom: '20px' }}>Create New Resource</h3>
                    
                    <form onSubmit={async (e) => {
                        e.preventDefault();
                        const form = e.target;
                        try {
                            await db.collection('resources').add({
                                title: form.title.value,
                                description: form.description.value,
                                category: form.category.value,
                                url: form.url.value || null,
                                assignedTo: [pirId],
                                createdBy: user.uid,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            await loadResourcesData();
                            setShowCreateResource(false);
                            alert('Resource created and assigned successfully');
                        } catch (error) {
                            console.error('Error creating resource:', error);
                            alert('Failed to create resource');
                        }
                    }}>
                        <div style={{ marginBottom: '15px' }}>
                            <label style={{ display: 'block', marginBottom: '5px' }}>Title *</label>
                            <input
                                name="title"
                                type="text"
                                required
                                style={{
                                    width: '100%',
                                    padding: '8px',
                                    borderRadius: '5px',
                                    border: '1px solid #ddd'
                                }}
                            />
                        </div>
                        
                        <div style={{ marginBottom: '15px' }}>
                            <label style={{ display: 'block', marginBottom: '5px' }}>Description *</label>
                            <textarea
                                name="description"
                                required
                                rows="3"
                                style={{
                                    width: '100%',
                                    padding: '8px',
                                    borderRadius: '5px',
                                    border: '1px solid #ddd'
                                }}
                            />
                        </div>
                        
                        <div style={{ marginBottom: '15px' }}>
                            <label style={{ display: 'block', marginBottom: '5px' }}>Category *</label>
                            <select
                                name="category"
                                required
                                style={{
                                    width: '100%',
                                    padding: '8px',
                                    borderRadius: '5px',
                                    border: '1px solid #ddd'
                                }}
                            >
                                <option value="">Select category...</option>
                                <option value="education">Education</option>
                                <option value="coping">Coping</option>
                                <option value="daily">Daily</option>
                                <option value="life">Life</option>
                                <option value="support">Support</option>
                                <option value="relapse">Relapse Prevention</option>
                            </select>
                        </div>
                        
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{ display: 'block', marginBottom: '5px' }}>URL (optional)</label>
                            <input
                                name="url"
                                type="url"
                                placeholder="https://..."
                                style={{
                                    width: '100%',
                                    padding: '8px',
                                    borderRadius: '5px',
                                    border: '1px solid #ddd'
                                }}
                            />
                        </div>
                        
                        <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                            <button
                                type="button"
                                onClick={() => setShowCreateResource(false)}
                                style={{
                                    padding: '10px 20px',
                                    borderRadius: '5px',
                                    border: '1px solid #ddd',
                                    background: 'white',
                                    cursor: 'pointer'
                                }}
                            >
                                Cancel
                            </button>
                            <button
                                type="submit"
                                style={{
                                    padding: '10px 20px',
                                    borderRadius: '5px',
                                    border: 'none',
                                    background: 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)',
                                    color: 'white',
                                    cursor: 'pointer'
                                }}
                            >
                                Create Resource
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        )}
    </div>
);

const renderActivityTab = () => (
    <div style={{ padding: '20px' }}>
        <h3 style={{ marginBottom: '20px', color: '#333' }}>Complete Activity Feed</h3>
        
        <div style={{
            background: 'white',
            borderRadius: '15px',
            padding: '20px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
            <div style={{ maxHeight: '600px', overflowY: 'auto' }}>
                {activities.length > 0 ? (
                    activities.map(activity => (
                        <div key={activity.id} style={{
                            padding: '15px',
                            borderBottom: '1px solid #eee',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '15px'
                        }}>
                            <div style={{
                                width: '40px',
                                height: '40px',
                                borderRadius: '50%',
                                background: getActivityColor(activity.type),
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '20px'
                            }}>
                                {getActivityIcon(activity.type)}
                            </div>
                            <div style={{ flex: 1 }}>
                                <div style={{ fontWeight: 'bold', color: '#333' }}>
                                    {activity.description || activity.type?.replace(/_/g, ' ').toUpperCase()}
                                </div>
                                <div style={{ fontSize: '11px', color: '#999', marginTop: '5px' }}>
                                    {formatTimeAgo(activity.createdAt)}
                                </div>
                            </div>
                        </div>
                    ))
                ) : (
                    <p style={{ color: '#666' }}>No activity recorded</p>
                )}
            </div>
        </div>
    </div>
);

const renderFinancialTab = () => (
    <div style={{ padding: '20px' }}>
        <h3 style={{ marginBottom: '20px', color: '#333' }}>Financial Impact</h3>
        
        <div style={{
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            borderRadius: '15px',
            padding: '30px',
            marginBottom: '20px',
            color: 'white',
            textAlign: 'center'
        }}>
            <div style={{ fontSize: '48px', fontWeight: 'bold' }}>
                ${pirData?.moneySaved || 0}
            </div>
            <div style={{ fontSize: '18px', opacity: 0.9 }}>
                Total Saved in Recovery
            </div>
            <div style={{ fontSize: '14px', opacity: 0.8, marginTop: '10px' }}>
                Based on ${pirData?.dailyCost || 20}/day
            </div>
        </div>

        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
            }}>
                <h4 style={{ marginBottom: '15px', color: '#333' }}>Monthly Projection</h4>
                <div style={{ fontSize: '32px', fontWeight: 'bold', color: '#4CAF50' }}>
                    ${(pirData?.dailyCost || 20) * 30}
                </div>
                <div style={{ fontSize: '12px', color: '#666' }}>
                    Saved per month
                </div>
            </div>

            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
            }}>
                <h4 style={{ marginBottom: '15px', color: '#333' }}>Yearly Projection</h4>
                <div style={{ fontSize: '32px', fontWeight: 'bold', color: '#2196F3' }}>
                    ${(pirData?.dailyCost || 20) * 365}
                </div>
                <div style={{ fontSize: '12px', color: '#666' }}>
                    Saved per year
                </div>
            </div>
        </div>
    </div>
);

const renderCommunityTab = () => (
    <div style={{ padding: '20px' }}>
        <h3 style={{ marginBottom: '30px', color: '#333' }}>Community Engagement</h3>
        
        {/* Community Stats Overview */}
        <div style={{
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            borderRadius: '15px',
            padding: '20px',
            marginBottom: '30px',
            color: 'white'
        }}>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '20px' }}>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '32px', fontWeight: 'bold' }}>
                        {meetings.filter(m => m.status === 'scheduled').length}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.9 }}>Upcoming Meetings</div>
                </div>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '32px', fontWeight: 'bold' }}>
                        {topicRooms.filter(room => 
                            room.members?.includes(pirId) || room.activeParticipants?.includes(pirId)
                        ).length}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.9 }}>Topic Rooms</div>
                </div>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '32px', fontWeight: 'bold' }}>
                        {supportGroups.filter(group => 
                            group.members?.includes(pirId) || group.participants?.includes(pirId)
                        ).length}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.9 }}>Support Groups</div>
                </div>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '32px', fontWeight: 'bold' }}>
                        {allMessages.filter(m => m.type === 'community').length}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.9 }}>Community Posts</div>
                </div>
            </div>
        </div>

        {/* Scheduled Meetings Section */}
        <div style={{
            background: 'white',
            borderRadius: '15px',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
            <h4 style={{ marginBottom: '20px', color: '#333' }}>üìÖ Scheduled Meetings</h4>
            {meetings && meetings.filter(m => 
                (m.pirId === pirId || m.pirIds?.includes(pirId) || m.isGlobal) && 
                m.status === 'scheduled'
            ).length > 0 ? (
                <div style={{ display: 'grid', gap: '15px' }}>
                    {meetings.filter(m => 
                        (m.pirId === pirId || m.pirIds?.includes(pirId) || m.isGlobal) && 
                        m.status === 'scheduled'
                    ).map(meeting => (
                        <div key={meeting.id} style={{
                            padding: '15px',
                            background: '#f9f9f9',
                            borderRadius: '10px',
                            borderLeft: '4px solid #2196F3'
                        }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <div>
                                    <h5 style={{ margin: '0 0 10px 0', color: '#333' }}>
                                        {meeting.meetingTitle || meeting.title || 'Recovery Session'}
                                    </h5>
                                    <div style={{ display: 'flex', gap: '15px', fontSize: '13px', color: '#666' }}>
                                        <span>üìÖ {formatDate(meeting.scheduledTime)}</span>
                                        <span>üïê {new Date(meeting.scheduledTime?.toDate ? 
                                            meeting.scheduledTime.toDate() : 
                                            meeting.scheduledTime).toLocaleTimeString('en-US', {
                                                hour: 'numeric',
                                                minute: '2-digit',
                                                hour12: true
                                            })}</span>
                                        <span>üìù {meeting.type || 'Group Session'}</span>
                                    </div>
                                    {meeting.notes && (
                                        <p style={{ margin: '10px 0 0 0', fontSize: '12px', color: '#555' }}>
                                            {meeting.notes}
                                        </p>
                                    )}
                                </div>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '5px' }}>
                                    {meeting.isGlobal && (
                                        <span style={{
                                            background: '#4CAF50',
                                            color: 'white',
                                            padding: '4px 8px',
                                            borderRadius: '12px',
                                            fontSize: '10px',
                                            textAlign: 'center'
                                        }}>
                                            ALL PIRS
                                        </span>
                                    )}
                                    {meeting.meetingLink && (
                                        <a 
                                            href={meeting.meetingLink} 
                                            target="_blank" 
                                            rel="noopener noreferrer"
                                            style={{
                                                background: '#2196F3',
                                                color: 'white',
                                                padding: '6px 12px',
                                                borderRadius: '5px',
                                                textDecoration: 'none',
                                                fontSize: '12px',
                                                textAlign: 'center'
                                            }}
                                        >
                                            Join Meeting
                                        </a>
                                    )}
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            ) : (
                <p style={{ color: '#666', textAlign: 'center', padding: '20px' }}>
                    No upcoming meetings scheduled
                </p>
            )}
        </div>

        {/* Topic Rooms Section */}
        <div style={{
            background: 'white',
            borderRadius: '15px',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
            <h4 style={{ marginBottom: '20px', color: '#333' }}>üí¨ Topic Rooms</h4>
            {topicRooms && topicRooms.length > 0 ? (
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '15px' }}>
                    {topicRooms.map(room => {
                        const isMember = room.members?.includes(pirId) || 
                                        room.activeParticipants?.includes(pirId);
                        return (
                            <div key={room.id} style={{
                                padding: '15px',
                                background: isMember ? '#e3f2fd' : '#f5f5f5',
                                borderRadius: '10px',
                                border: isMember ? '2px solid #2196F3' : '1px solid #ddd',
                                position: 'relative'
                            }}>
                                {isMember && (
                                    <span style={{
                                        position: 'absolute',
                                        top: '10px',
                                        right: '10px',
                                        background: '#4CAF50',
                                        color: 'white',
                                        padding: '2px 6px',
                                        borderRadius: '10px',
                                        fontSize: '10px'
                                    }}>
                                        MEMBER
                                    </span>
                                )}
                                <h5 style={{ margin: '0 0 10px 0', color: '#333' }}>
                                    {room.name}
                                </h5>
                                <p style={{ fontSize: '12px', color: '#666', margin: '0 0 10px 0' }}>
                                    {room.description}
                                </p>
                                <div style={{ fontSize: '11px', color: '#999' }}>
                                    üë• {room.members?.length || 0} members
                                    {room.lastActivity && (
                                        <span style={{ marginLeft: '10px' }}>
                                            Last active: {formatTimeAgo(room.lastActivity)}
                                        </span>
                                    )}
                                </div>
                            </div>
                        );
                    })}
                </div>
            ) : (
                <p style={{ color: '#666', textAlign: 'center', padding: '20px' }}>
                    No topic rooms available
                </p>
            )}
        </div>

        {/* Support Groups Section */}
        <div style={{
            background: 'white',
            borderRadius: '15px',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
            <h4 style={{ marginBottom: '20px', color: '#333' }}>ü§ù Support Groups</h4>
            {supportGroups && supportGroups.length > 0 ? (
                <div style={{ display: 'grid', gap: '15px' }}>
                    {supportGroups.map(group => {
                        const isMember = group.members?.includes(pirId) || 
                                        group.participants?.includes(pirId);
                        return (
                            <div key={group.id} style={{
                                padding: '20px',
                                background: isMember ? '#f3e5f5' : '#f9f9f9',
                                borderRadius: '10px',
                                borderLeft: `4px solid ${isMember ? '#9C27B0' : '#ddd'}`
                            }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start' }}>
                                    <div style={{ flex: 1 }}>
                                        <h5 style={{ margin: '0 0 10px 0', color: '#333' }}>
                                            {group.name}
                                        </h5>
                                        <p style={{ fontSize: '13px', color: '#666', margin: '0 0 10px 0' }}>
                                            {group.description}
                                        </p>
                                        {group.meetingSchedule && (
                                            <div style={{ fontSize: '12px', color: '#555' }}>
                                                üìÖ Meets: {group.meetingSchedule}
                                            </div>
                                        )}
                                        <div style={{ fontSize: '11px', color: '#999', marginTop: '10px' }}>
                                            üë• {group.members?.length || 0} members
                                            {group.facilitator && (
                                                <span style={{ marginLeft: '15px' }}>
                                                    Facilitated by: {group.facilitator}
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                    {isMember && (
                                        <span style={{
                                            background: '#9C27B0',
                                            color: 'white',
                                            padding: '4px 12px',
                                            borderRadius: '12px',
                                            fontSize: '11px'
                                        }}>
                                            ENROLLED
                                        </span>
                                    )}
                                </div>
                            </div>
                        );
                    })}
                </div>
            ) : (
                <p style={{ color: '#666', textAlign: 'center', padding: '20px' }}>
                    No support groups available
                </p>
            )}
        </div>

        {/* Recent Community Activity */}
        <div style={{
            background: 'white',
            borderRadius: '15px',
            padding: '20px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
            <h4 style={{ marginBottom: '20px', color: '#333' }}>üåê Recent Community Activity</h4>
            {allMessages.filter(m => m.type === 'community' || m.type === 'topic').length > 0 ? (
                <div style={{ maxHeight: '300px', overflowY: 'auto' }}>
                    {allMessages
                        .filter(m => m.type === 'community' || m.type === 'topic')
                        .slice(0, 10)
                        .map(message => (
                        <div key={message.id} style={{
                            padding: '10px',
                            borderBottom: '1px solid #eee',
                            fontSize: '13px'
                        }}>
                            <div style={{ display: 'flex', gap: '10px', marginBottom: '5px' }}>
                                <span style={{
                                    background: message.type === 'community' ? '#4CAF50' : '#FF9800',
                                    color: 'white',
                                    padding: '2px 6px',
                                    borderRadius: '8px',
                                    fontSize: '10px'
                                }}>
                                    {message.type === 'community' ? 'COMMUNITY' : 'TOPIC'}
                                </span>
                                <span style={{ color: '#999', fontSize: '11px' }}>
                                    {formatTimeAgo(message.createdAt)}
                                </span>
                            </div>
                            <div style={{ color: '#333' }}>
                                {message.content || message.text || 'Posted a message'}
                            </div>
                        </div>
                    ))}
                </div>
            ) : (
                <p style={{ color: '#666', textAlign: 'center', padding: '20px' }}>
                    No recent community activity
                </p>
            )}
        </div>
    </div>
);

return (
    <div className="modal-overlay" style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        background: 'rgba(0, 0, 0, 0.5)',
        backdropFilter: 'blur(5px)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        zIndex: 1000,
        animation: 'fadeIn 0.3s ease-in-out'
    }}>
        <div className="modal-content" style={{
            maxWidth: '1200px',
            width: '95%',
            maxHeight: '90vh',
            background: 'white',
            borderRadius: '20px',
            boxShadow: '0 20px 60px rgba(0,0,0,0.3)',
            display: 'flex',
            flexDirection: 'column',
            overflow: 'hidden',
            animation: 'slideUp 0.3s ease-out'
        }}>
            <div className="modal-header" style={{
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                padding: '25px 30px',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                borderBottom: '1px solid rgba(255,255,255,0.1)'
            }}>
                <h3 style={{
                    margin: 0,
                    color: 'white',
                    fontSize: '24px',
                    fontWeight: '600',
                    letterSpacing: '-0.5px'
                }}>
                    {pirData?.firstName} {pirData?.lastName} - PIR Details
                </h3>
                <button 
                    className="close-btn" 
                    onClick={onClose}
                    style={{
                        background: 'rgba(255,255,255,0.2)',
                        border: 'none',
                        color: 'white',
                        fontSize: '28px',
                        width: '40px',
                        height: '40px',
                        borderRadius: '50%',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        transition: 'all 0.2s',
                        fontWeight: '300'
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.background = 'rgba(255,255,255,0.3)';
                        e.currentTarget.style.transform = 'rotate(90deg)';
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.background = 'rgba(255,255,255,0.2)';
                        e.currentTarget.style.transform = 'rotate(0deg)';
                    }}
                >
                    √ó
                </button>
            </div>
            
            {loading ? (
                <div className="loading-container" style={{
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    justifyContent: 'center',
                    minHeight: '400px',
                    gap: '20px'
                }}>
                    <div className="loading-spinner" style={{
                        width: '60px',
                        height: '60px',
                        border: '4px solid #f3f3f3',
                        borderTop: '4px solid #667eea',
                        borderRadius: '50%',
                        animation: 'spin 1s linear infinite'
                    }}></div>
                    <p style={{
                        color: '#666',
                        fontSize: '16px',
                        margin: 0
                    }}>
                        Loading PIR data...
                    </p>
                </div>
            ) : (
                <>
                    <div className="tab-nav" style={{
                        display: 'flex',
                        gap: '8px',
                        padding: '20px 25px 0 25px',
                        background: '#f8f9fa',
                        borderBottom: '2px solid #e9ecef',
                        overflowX: 'auto',
                        position: 'sticky',
                        top: 0,
                        zIndex: 10
                    }}>
                        <button 
                            className={`tab-btn ${activeTab === 'overview' ? 'active' : ''}`}
                            onClick={() => setActiveTab('overview')}
                            style={{
                                padding: '12px 20px',
                                border: 'none',
                                background: activeTab === 'overview' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'transparent',
                                color: activeTab === 'overview' ? 'white' : '#666',
                                borderRadius: '10px 10px 0 0',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: activeTab === 'overview' ? '600' : '500',
                                transition: 'all 0.3s',
                                whiteSpace: 'nowrap',
                                boxShadow: activeTab === 'overview' ? '0 -2px 10px rgba(102, 126, 234, 0.3)' : 'none'
                            }}
                            onMouseEnter={(e) => {
                                if (activeTab !== 'overview') {
                                    e.currentTarget.style.background = '#e9ecef';
                                    e.currentTarget.style.color = '#333';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (activeTab !== 'overview') {
                                    e.currentTarget.style.background = 'transparent';
                                    e.currentTarget.style.color = '#666';
                                }
                            }}
                        >
                            üìä Overview
                        </button>
                        <button 
                            className={`tab-btn ${activeTab === 'progress' ? 'active' : ''}`}
                            onClick={() => setActiveTab('progress')}
                            style={{
                                padding: '12px 20px',
                                border: 'none',
                                background: activeTab === 'progress' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'transparent',
                                color: activeTab === 'progress' ? 'white' : '#666',
                                borderRadius: '10px 10px 0 0',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: activeTab === 'progress' ? '600' : '500',
                                transition: 'all 0.3s',
                                whiteSpace: 'nowrap',
                                boxShadow: activeTab === 'progress' ? '0 -2px 10px rgba(102, 126, 234, 0.3)' : 'none'
                            }}
                            onMouseEnter={(e) => {
                                if (activeTab !== 'progress') {
                                    e.currentTarget.style.background = '#e9ecef';
                                    e.currentTarget.style.color = '#333';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (activeTab !== 'progress') {
                                    e.currentTarget.style.background = 'transparent';
                                    e.currentTarget.style.color = '#666';
                                }
                            }}
                        >
                            üìà Progress
                        </button>
                        <button 
                            className={`tab-btn ${activeTab === 'goldenthread' ? 'active' : ''}`}
                            onClick={() => setActiveTab('goldenthread')}
                            style={{
                                padding: '12px 20px',
                                border: 'none',
                                background: activeTab === 'goldenthread' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'transparent',
                                color: activeTab === 'goldenthread' ? 'white' : '#666',
                                borderRadius: '10px 10px 0 0',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: activeTab === 'goldenthread' ? '600' : '500',
                                transition: 'all 0.3s',
                                whiteSpace: 'nowrap',
                                boxShadow: activeTab === 'goldenthread' ? '0 -2px 10px rgba(102, 126, 234, 0.3)' : 'none'
                            }}
                            onMouseEnter={(e) => {
                                if (activeTab !== 'goldenthread') {
                                    e.currentTarget.style.background = '#e9ecef';
                                    e.currentTarget.style.color = '#333';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (activeTab !== 'goldenthread') {
                                    e.currentTarget.style.background = 'transparent';
                                    e.currentTarget.style.color = '#666';
                                }
                            }}
                        >
                            üßµ Golden Thread
                        </button>
                        <button 
                            className={`tab-btn ${activeTab === 'milestones' ? 'active' : ''}`}
                            onClick={() => setActiveTab('milestones')}
                            style={{
                                padding: '12px 20px',
                                border: 'none',
                                background: activeTab === 'milestones' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'transparent',
                                color: activeTab === 'milestones' ? 'white' : '#666',
                                borderRadius: '10px 10px 0 0',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: activeTab === 'milestones' ? '600' : '500',
                                transition: 'all 0.3s',
                                whiteSpace: 'nowrap',
                                boxShadow: activeTab === 'milestones' ? '0 -2px 10px rgba(102, 126, 234, 0.3)' : 'none'
                            }}
                            onMouseEnter={(e) => {
                                if (activeTab !== 'milestones') {
                                    e.currentTarget.style.background = '#e9ecef';
                                    e.currentTarget.style.color = '#333';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (activeTab !== 'milestones') {
                                    e.currentTarget.style.background = 'transparent';
                                    e.currentTarget.style.color = '#666';
                                }
                            }}
                        >
                            üèÜ Milestones
                        </button>
                        <button 
                            className={`tab-btn ${activeTab === 'resources' ? 'active' : ''}`}
                            onClick={() => setActiveTab('resources')}
                            style={{
                                padding: '12px 20px',
                                border: 'none',
                                background: activeTab === 'resources' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'transparent',
                                color: activeTab === 'resources' ? 'white' : '#666',
                                borderRadius: '10px 10px 0 0',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: activeTab === 'resources' ? '600' : '500',
                                transition: 'all 0.3s',
                                whiteSpace: 'nowrap',
                                boxShadow: activeTab === 'resources' ? '0 -2px 10px rgba(102, 126, 234, 0.3)' : 'none'
                            }}
                            onMouseEnter={(e) => {
                                if (activeTab !== 'resources') {
                                    e.currentTarget.style.background = '#e9ecef';
                                    e.currentTarget.style.color = '#333';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (activeTab !== 'resources') {
                                    e.currentTarget.style.background = 'transparent';
                                    e.currentTarget.style.color = '#666';
                                }
                            }}
                        >
                            üìö Resources
                        </button>
                        <button 
                            className={`tab-btn ${activeTab === 'communications' ? 'active' : ''}`}
                            onClick={() => setActiveTab('communications')}
                            style={{
                                padding: '12px 20px',
                                border: 'none',
                                background: activeTab === 'communications' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'transparent',
                                color: activeTab === 'communications' ? 'white' : '#666',
                                borderRadius: '10px 10px 0 0',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: activeTab === 'communications' ? '600' : '500',
                                transition: 'all 0.3s',
                                whiteSpace: 'nowrap',
                                boxShadow: activeTab === 'communications' ? '0 -2px 10px rgba(102, 126, 234, 0.3)' : 'none'
                            }}
                            onMouseEnter={(e) => {
                                if (activeTab !== 'communications') {
                                    e.currentTarget.style.background = '#e9ecef';
                                    e.currentTarget.style.color = '#333';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (activeTab !== 'communications') {
                                    e.currentTarget.style.background = 'transparent';
                                    e.currentTarget.style.color = '#666';
                                }
                            }}
                        >
                            üí¨ Communications
                        </button>
                        <button 
                            className={`tab-btn ${activeTab === 'activity' ? 'active' : ''}`}
                            onClick={() => setActiveTab('activity')}
                            style={{
                                padding: '12px 20px',
                                border: 'none',
                                background: activeTab === 'activity' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'transparent',
                                color: activeTab === 'activity' ? 'white' : '#666',
                                borderRadius: '10px 10px 0 0',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: activeTab === 'activity' ? '600' : '500',
                                transition: 'all 0.3s',
                                whiteSpace: 'nowrap',
                                boxShadow: activeTab === 'activity' ? '0 -2px 10px rgba(102, 126, 234, 0.3)' : 'none'
                            }}
                            onMouseEnter={(e) => {
                                if (activeTab !== 'activity') {
                                    e.currentTarget.style.background = '#e9ecef';
                                    e.currentTarget.style.color = '#333';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (activeTab !== 'activity') {
                                    e.currentTarget.style.background = 'transparent';
                                    e.currentTarget.style.color = '#666';
                                }
                            }}
                        >
                            üìã Activity
                        </button>
                        <button 
                            className={`tab-btn ${activeTab === 'financial' ? 'active' : ''}`}
                            onClick={() => setActiveTab('financial')}
                            style={{
                                padding: '12px 20px',
                                border: 'none',
                                background: activeTab === 'financial' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'transparent',
                                color: activeTab === 'financial' ? 'white' : '#666',
                                borderRadius: '10px 10px 0 0',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: activeTab === 'financial' ? '600' : '500',
                                transition: 'all 0.3s',
                                whiteSpace: 'nowrap',
                                boxShadow: activeTab === 'financial' ? '0 -2px 10px rgba(102, 126, 234, 0.3)' : 'none'
                            }}
                            onMouseEnter={(e) => {
                                if (activeTab !== 'financial') {
                                    e.currentTarget.style.background = '#e9ecef';
                                    e.currentTarget.style.color = '#333';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (activeTab !== 'financial') {
                                    e.currentTarget.style.background = 'transparent';
                                    e.currentTarget.style.color = '#666';
                                }
                            }}
                        >
                            üí∞ Financial
                        </button>
                        <button 
                            className={`tab-btn ${activeTab === 'community' ? 'active' : ''}`}
                            onClick={() => setActiveTab('community')}
                            style={{
                                padding: '12px 20px',
                                border: 'none',
                                background: activeTab === 'community' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'transparent',
                                color: activeTab === 'community' ? 'white' : '#666',
                                borderRadius: '10px 10px 0 0',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: activeTab === 'community' ? '600' : '500',
                                transition: 'all 0.3s',
                                whiteSpace: 'nowrap',
                                boxShadow: activeTab === 'community' ? '0 -2px 10px rgba(102, 126, 234, 0.3)' : 'none'
                            }}
                            onMouseEnter={(e) => {
                                if (activeTab !== 'community') {
                                    e.currentTarget.style.background = '#e9ecef';
                                    e.currentTarget.style.color = '#333';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (activeTab !== 'community') {
                                    e.currentTarget.style.background = 'transparent';
                                    e.currentTarget.style.color = '#666';
                                }
                            }}
                        >
                            üåê Community
                        </button>
                    </div>
                    
                    <div className="tab-content" style={{
                        flex: 1,
                        overflowY: 'auto',
                        background: '#f8f9fa',
                        transition: 'opacity 0.3s ease-in-out'
                    }}>
                        {activeTab === 'overview' && renderOverviewTab()}
                        {activeTab === 'progress' && renderProgressTab()}
                        {activeTab === 'goldenthread' && renderGoldenThreadTab()}
                        {activeTab === 'milestones' && renderMilestonesTab()}
                        {activeTab === 'resources' && renderResourcesTab()}
                        {activeTab === 'communications' && renderCommunicationsTab()}
                        {activeTab === 'activity' && renderActivityTab()}
                        {activeTab === 'financial' && renderFinancialTab()}
                        {activeTab === 'community' && renderCommunityTab()}
                    </div>
                </>
            )}
        </div>
    </div>
);
}

  
        
    
      // Enhanced Coach Detail Modal with Tabs for admin viewing coaches
function CoachDetailModal({ coach, onClose, onUpdate, currentUserId }) {
    const [activeTab, setActiveTab] = useState('overview');
    const [loading, setLoading] = useState(true);
    const [coachData, setCoachData] = useState({
        assignedPIRs: [],
        activities: [],
        assignments: [],
        checkInsReviewed: [],
        alerts: [],
        stats: {
            totalPIRs: 0,
            avgResponseTime: 0,
            checkInComplianceRate: 0,
            assignmentCompletionRate: 0,
            alertsHandled: 0,
            avgCaseloadDays: 0,
            lastActive: null,
            satisfactionScore: 0
        }
    });

    useEffect(() => {
        if (coach.role === 'coach' || coach.role === 'admin') {
            loadCoachData();
        } else {
            setLoading(false);
        }
    }, [coach]);

    const loadCoachData = async () => {
        try {
            setLoading(true);

            // Get all PIRs assigned to this coach
            const pirsSnap = await db.collection('users')
                .where('assignedCoach', '==', coach.id)
                .where('role', '==', 'pir')
                .get();

            const assignedPIRs = [];
            const pirIds = [];
            pirsSnap.forEach(doc => {
                const pirData = { id: doc.id, ...doc.data() };
                assignedPIRs.push(pirData);
                pirIds.push(doc.id);
            });

            // If coach has no PIRs, set empty data
            if (pirIds.length === 0) {
                setCoachData({
                    assignedPIRs: [],
                    activities: [],
                    assignments: [],
                    checkInsReviewed: [],
                    alerts: [],
                    stats: {
                        totalPIRs: 0,
                        avgResponseTime: 0,
                        checkInComplianceRate: 0,
                        assignmentCompletionRate: 0,
                        alertsHandled: 0,
                        avgCaseloadDays: 0,
                        lastActive: coach.lastActive || null,
                        satisfactionScore: 0
                    }
                });
                setLoading(false);
                return;
            }

            // Get assignments created by this coach
            const assignmentsSnap = await db.collection('assignments')
                .where('createdBy', '==', coach.id)
                .limit(50)
                .get();

            const assignments = [];
            let completedAssignments = 0;
            assignmentsSnap.forEach(doc => {
                const data = { id: doc.id, ...doc.data() };
                assignments.push(data);
                if (data.status === 'completed') completedAssignments++;
            });

            // Get recent check-ins for coach's PIRs (last 30 days)
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            // We'll need to batch query for PIR check-ins
            const checkInsPromises = pirIds.map(pirId => 
                db.collection('checkIns')
                    .where('userId', '==', pirId)
                    .where('createdAt', '>=', thirtyDaysAgo)
                    .get()
            );

            const checkInsSnapshots = await Promise.all(checkInsPromises);
            const allCheckIns = [];
            checkInsSnapshots.forEach(snapshot => {
                snapshot.forEach(doc => {
                    allCheckIns.push({ id: doc.id, ...doc.data() });
                });
            });

            // Get alerts for coach's PIRs
            const alertsPromises = pirIds.map(pirId =>
                db.collection('alerts')
                    .where('userId', '==', pirId)
                    .limit(10)
                    .get()
            );

            const alertsSnapshots = await Promise.all(alertsPromises);
            const alerts = [];
            alertsSnapshots.forEach(snapshot => {
                snapshot.forEach(doc => {
                    alerts.push({ id: doc.id, ...doc.data() });
                });
            });

            // Calculate statistics
            const now = new Date();
            const checkInComplianceRate = assignedPIRs.length > 0 ? 
                Math.round((allCheckIns.length / (assignedPIRs.length * 30)) * 100) : 0;

            const assignmentCompletionRate = assignments.length > 0 ?
                Math.round((completedAssignments / assignments.length) * 100) : 0;

            // Calculate average days with coach
            let totalDays = 0;
            assignedPIRs.forEach(pir => {
                if (pir.assignedDate) {
                    const assignedDate = pir.assignedDate.toDate ? pir.assignedDate.toDate() : new Date(pir.assignedDate);
                    totalDays += Math.floor((now - assignedDate) / (1000 * 60 * 60 * 24));
                }
            });
            const avgCaseloadDays = assignedPIRs.length > 0 ? Math.round(totalDays / assignedPIRs.length) : 0;

            // Get feedback scores for satisfaction
            const feedbackPromises = pirIds.map(pirId =>
                db.collection('feedback')
                    .where('userId', '==', pirId)
                    .where('type', '==', 'coach_rating')
                    .get()
            );

            const feedbackSnapshots = await Promise.all(feedbackPromises);
            let totalRating = 0;
            let ratingCount = 0;
            feedbackSnapshots.forEach(snapshot => {
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.rating) {
                        totalRating += data.rating;
                        ratingCount++;
                    }
                });
            });
            const satisfactionScore = ratingCount > 0 ? (totalRating / ratingCount).toFixed(1) : 0;

            // Sort data by date
            assignments.sort((a, b) => {
                const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
                const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
                return dateB - dateA;
            });

            alerts.sort((a, b) => {
                const dateA = a.timestamp?.toDate ? a.timestamp.toDate() : new Date(a.timestamp || 0);
                const dateB = b.timestamp?.toDate ? b.timestamp.toDate() : new Date(b.timestamp || 0);
                return dateB - dateA;
            });

            setCoachData({
                assignedPIRs,
                activities: [], // Would need activity logging to populate
                assignments,
                checkInsReviewed: allCheckIns,
                alerts,
                stats: {
                    totalPIRs: assignedPIRs.length,
                    avgResponseTime: 0, // Would need response tracking
                    checkInComplianceRate,
                    assignmentCompletionRate,
                    alertsHandled: alerts.filter(a => a.status === 'resolved').length,
                    avgCaseloadDays,
                    lastActive: coach.lastActive || null,
                    satisfactionScore
                }
            });

        } catch (error) {
            console.error('Error loading coach data:', error);
        } finally {
            setLoading(false);
        }
    };

    const handleAssignPIR = async () => {
        const pirEmail = prompt('Enter PIR email to assign:');
        if (pirEmail) {
            try {
                // Find PIR by email
                const pirQuery = await db.collection('users')
                    .where('email', '==', pirEmail)
                    .where('role', '==', 'pir')
                    .limit(1)
                    .get();

                if (pirQuery.empty) {
                    alert('PIR not found');
                    return;
                }

                const pirDoc = pirQuery.docs[0];
                await pirDoc.ref.update({
                    assignedCoach: coach.id,
                    assignedDate: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('PIR assigned successfully!');
                loadCoachData();
            } catch (error) {
                console.error('Error assigning PIR:', error);
                alert('Failed to assign PIR');
            }
        }
    };

    const handleRemovePIR = async (pirId) => {
        if (confirm('Remove this PIR from coach?')) {
            try {
                await db.collection('users').doc(pirId).update({
                    assignedCoach: null,
                    assignedDate: null
                });
                alert('PIR removed from coach');
                loadCoachData();
            } catch (error) {
                console.error('Error removing PIR:', error);
                alert('Failed to remove PIR');
            }
        }
    };

    const handleExportReport = () => {
        const report = {
            coach: {
                name: coach.displayName || coach.email,
                email: coach.email,
                role: coach.role,
                lastActive: coach.lastActive
            },
            stats: coachData.stats,
            assignedPIRs: coachData.assignedPIRs.map(pir => ({
                name: pir.displayName || pir.email,
                email: pir.email,
                daysWithCoach: pir.assignedDate ? 
                    Math.floor((new Date() - new Date(pir.assignedDate)) / (1000 * 60 * 60 * 24)) : 0,
                lastCheckIn: pir.lastCheckIn
            })),
            recentAssignments: coachData.assignments.slice(0, 20).map(a => ({
                title: a.title,
                status: a.status,
                createdAt: formatDate(a.createdAt)
            }))
        };

        const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `coach-report-${coach.email}-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
    };

    const renderOverviewTab = () => (
        <div className="tab-content">
            <div className="stats-grid">
                <div className="stat-card">
                    <div className="stat-label">Total PIRs</div>
                    <div className="stat-value" style={{fontSize: '2em'}}>
                        {coachData.stats.totalPIRs}
                    </div>
                </div>
                
                <div className="stat-card">
                    <div className="stat-label">PIR Compliance Rate</div>
                    <div className="stat-value" style={{fontSize: '2em', 
                        color: coachData.stats.checkInComplianceRate >= 70 ? '#4CAF50' : '#ff9800'}}>
                        {coachData.stats.checkInComplianceRate}%
                    </div>
                    <div className="stat-sublabel">Check-ins last 30 days</div>
                </div>
                
                <div className="stat-card">
                    <div className="stat-label">Assignment Completion</div>
                    <div className="stat-value" style={{fontSize: '2em'}}>
                        {coachData.stats.assignmentCompletionRate}%
                    </div>
                </div>
                
                <div className="stat-card">
                    <div className="stat-label">Satisfaction Score</div>
                    <div className="stat-value" style={{fontSize: '2em'}}>
                        {coachData.stats.satisfactionScore}/5
                    </div>
                </div>
            </div>

            <div className="info-section">
                <h4>Coach Information</h4>
                <div className="info-grid">
                    <div><strong>Email:</strong> {coach.email}</div>
                    <div><strong>Name:</strong> {coach.displayName || 'N/A'}</div>
                    <div><strong>Role:</strong> {coach.role}</div>
                    <div><strong>Status:</strong> 
                        <span className={`badge ${coach.active !== false ? 'badge-success' : 'badge-danger'}`}>
                            {coach.active !== false ? 'Active' : 'Inactive'}
                        </span>
                    </div>
                    <div><strong>Last Active:</strong> {coach.lastActive ? formatTimeAgo(coach.lastActive) : 'N/A'}</div>
                    <div><strong>Joined:</strong> {formatDate(coach.createdAt)}</div>
                </div>
            </div>
        </div>
    );

    const renderCaseloadTab = () => (
        <div className="tab-content">
            <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '20px'}}>
                <h4>Assigned PIRs ({coachData.assignedPIRs.length})</h4>
                <button className="btn btn-primary" onClick={handleAssignPIR}>
                    + Assign PIR
                </button>
            </div>
            
            <div className="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>PIR Name</th>
                            <th>Email</th>
                            <th>Days with Coach</th>
                            <th>Last Check-in</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {coachData.assignedPIRs.map(pir => {
                            const daysWithCoach = pir.assignedDate ? 
                                Math.floor((new Date() - new Date(pir.assignedDate)) / (1000 * 60 * 60 * 24)) : 0;
                            
                            return (
                                <tr key={pir.id}>
                                    <td>{pir.displayName || 'N/A'}</td>
                                    <td>{pir.email}</td>
                                    <td>{daysWithCoach} days</td>
                                    <td>{pir.lastCheckIn ? formatTimeAgo(pir.lastCheckIn) : 'Never'}</td>
                                    <td>
                                        <span className={`badge ${pir.active !== false ? 'badge-success' : 'badge-danger'}`}>
                                            {pir.active !== false ? 'Active' : 'Inactive'}
                                        </span>
                                    </td>
                                    <td>
                                        <button 
                                            className="action-btn"
                                            onClick={() => handleRemovePIR(pir.id)}
                                        >
                                            Remove
                                        </button>
                                    </td>
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
                {coachData.assignedPIRs.length === 0 && (
                    <div className="empty-state">No PIRs assigned to this coach</div>
                )}
            </div>
        </div>
    );

    const renderActivityTab = () => (
        <div className="tab-content">
            <h4>Recent Activity</h4>
            
            <div className="activity-section">
                <h5>Recent Assignments Created ({coachData.assignments.length})</h5>
                {coachData.assignments.slice(0, 10).map(assignment => (
                    <div key={assignment.id} className="activity-item">
                        <div className="activity-header">
                            <span className="activity-title">{assignment.title}</span>
                            <span className="activity-time">{formatTimeAgo(assignment.createdAt)}</span>
                        </div>
                        <div className="activity-meta">
                            Status: <span className={`badge ${
                                assignment.status === 'completed' ? 'badge-success' :
                                assignment.status === 'in_progress' ? 'badge-warning' :
                                'badge-secondary'
                            }`}>{assignment.status}</span>
                        </div>
                    </div>
                ))}
                {coachData.assignments.length === 0 && (
                    <div className="empty-state">No assignments created</div>
                )}
            </div>

            <div className="activity-section">
                <h5>Alerts from PIRs</h5>
                {coachData.alerts.slice(0, 10).map(alert => (
                    <div key={alert.id} className={`alert alert-${alert.type}`}>
                        <div className="alert-header">
                            <span className="alert-type">{alert.type.toUpperCase()}</span>
                            <span className="alert-time">{formatTimeAgo(alert.timestamp)}</span>
                        </div>
                        <div className="alert-message">{alert.message}</div>
                    </div>
                ))}
                {coachData.alerts.length === 0 && (
                    <div className="empty-state">No alerts</div>
                )}
            </div>
        </div>
    );

    const renderPerformanceTab = () => (
        <div className="tab-content">
            <h4>Performance Metrics</h4>
            
            <div className="performance-grid">
                <div className="metric-card">
                    <h5>PIR Outcomes</h5>
                    <div className="metric-item">
                        <span>Average Days with Coach:</span>
                        <strong>{coachData.stats.avgCaseloadDays} days</strong>
                    </div>
                    <div className="metric-item">
                        <span>Alerts Handled:</span>
                        <strong>{coachData.stats.alertsHandled}</strong>
                    </div>
                </div>

                <div className="metric-card">
                    <h5>Engagement</h5>
                    <div className="metric-item">
                        <span>Assignments Created:</span>
                        <strong>{coachData.assignments.length}</strong>
                    </div>
                    <div className="metric-item">
                        <span>Completion Rate:</span>
                        <strong>{coachData.stats.assignmentCompletionRate}%</strong>
                    </div>
                </div>

                <div className="metric-card">
                    <h5>Quality Indicators</h5>
                    <div className="metric-item">
                        <span>PIR Satisfaction:</span>
                        <strong>{coachData.stats.satisfactionScore}/5</strong>
                    </div>
                    <div className="metric-item">
                        <span>Check-in Compliance:</span>
                        <strong>{coachData.stats.checkInComplianceRate}%</strong>
                    </div>
                </div>
            </div>
        </div>
    );

    const renderWorkloadTab = () => (
        <div className="tab-content">
            <h4>Workload Analysis</h4>
            
            <div className="workload-section">
                <div className="workload-card">
                    <h5>Current Capacity</h5>
                    <div className="capacity-meter">
                        <div className="capacity-bar" style={{
                            width: `${Math.min(coachData.stats.totalPIRs * 10, 100)}%`,
                            backgroundColor: coachData.stats.totalPIRs > 10 ? '#ff9800' : '#4CAF50'
                        }}></div>
                    </div>
                    <p>{coachData.stats.totalPIRs} PIRs assigned (Recommended max: 10)</p>
                </div>

                <div className="workload-card">
                    <h5>PIR Distribution</h5>
                    {coachData.assignedPIRs.map(pir => {
                        const daysClean = pir.sobrietyDate ? 
                            Math.floor((new Date() - new Date(pir.sobrietyDate)) / (1000 * 60 * 60 * 24)) : 0;
                        
                        return (
                            <div key={pir.id} className="pir-workload-item">
                                <span>{pir.displayName || pir.email}</span>
                                <span className="badge badge-info">{daysClean} days clean</span>
                            </div>
                        );
                    })}
                </div>

                <div className="workload-recommendations">
                    <h5>Recommendations</h5>
                    {coachData.stats.totalPIRs > 10 && (
                        <div className="recommendation-item">
                            ‚ö†Ô∏è Consider redistributing caseload - coach has more than 10 PIRs
                        </div>
                    )}
                    {coachData.stats.checkInComplianceRate < 50 && (
                        <div className="recommendation-item">
                            ‚ö†Ô∏è Low check-in compliance - coach may need support or training
                        </div>
                    )}
                    {coachData.stats.totalPIRs === 0 && (
                        <div className="recommendation-item">
                            ‚ÑπÔ∏è Coach has no assigned PIRs - ready for new assignments
                        </div>
                    )}
                </div>
            </div>
        </div>
    );

    const renderActionsTab = () => (
        <div className="tab-content">
            <h4>Admin Actions</h4>
            <div className="actions-grid">
                <button className="action-card" onClick={handleAssignPIR}>
                    <span className="action-icon">‚ûï</span>
                    <span>Assign PIR</span>
                </button>
                
                <button className="action-card" onClick={handleExportReport}>
                    <span className="action-icon">üìä</span>
                    <span>Export Report</span>
                </button>
                
                <button className="action-card" onClick={() => {
                    const newStatus = coach.active === false ? true : false;
                    db.collection('users').doc(coach.id).update({ active: newStatus })
                        .then(() => {
                            alert(`Coach ${newStatus ? 'activated' : 'deactivated'}`);
                            onUpdate();
                        });
                }}>
                    <span className="action-icon">{coach.active !== false ? 'üö´' : '‚úÖ'}</span>
                    <span>{coach.active !== false ? 'Deactivate' : 'Activate'}</span>
                </button>
                
                <button className="action-card" onClick={() => loadCoachData()}>
                    <span className="action-icon">üîÑ</span>
                    <span>Refresh Data</span>
                </button>
            </div>
        </div>
    );

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{maxWidth: '900px', maxHeight: '80vh', overflowY: 'auto'}}>
                <div className="modal-header">
                    <h3>{coach.displayName || coach.email} - Coach View</h3>
                    <button className="close-btn" onClick={onClose}>√ó</button>
                </div>
                
                {coach.role === 'coach' || coach.role === 'admin' ? (
                    <>
                        <div className="tab-nav">
                            <button 
                                className={`tab-btn ${activeTab === 'overview' ? 'active' : ''}`}
                                onClick={() => setActiveTab('overview')}
                            >
                                Overview
                            </button>
                            <button 
                                className={`tab-btn ${activeTab === 'caseload' ? 'active' : ''}`}
                                onClick={() => setActiveTab('caseload')}
                            >
                                Caseload
                            </button>
                            <button 
                                className={`tab-btn ${activeTab === 'activity' ? 'active' : ''}`}
                                onClick={() => setActiveTab('activity')}
                            >
                                Activity
                            </button>
                            <button 
                                className={`tab-btn ${activeTab === 'performance' ? 'active' : ''}`}
                                onClick={() => setActiveTab('performance')}
                            >
                                Performance
                            </button>
                            <button 
                                className={`tab-btn ${activeTab === 'workload' ? 'active' : ''}`}
                                onClick={() => setActiveTab('workload')}
                            >
                                Workload
                            </button>
                            <button 
                                className={`tab-btn ${activeTab === 'actions' ? 'active' : ''}`}
                                onClick={() => setActiveTab('actions')}
                            >
                                Actions
                            </button>
                        </div>
                        
                        {loading ? (
                            <div className="loading-container">
                                <div className="loading-spinner"></div>
                            </div>
                        ) : (
                            <>
                                {activeTab === 'overview' && renderOverviewTab()}
                                {activeTab === 'caseload' && renderCaseloadTab()}
                                {activeTab === 'activity' && renderActivityTab()}
                                {activeTab === 'performance' && renderPerformanceTab()}
                                {activeTab === 'workload' && renderWorkloadTab()}
                                {activeTab === 'actions' && renderActionsTab()}
                            </>
                        )}
                    </>
                ) : (
                    <div className="modal-body">
                        <p>This user is not a coach.</p>
                    </div>
                )}
            </div>
        </div>
    );
}

        function CreateGroupModal({ onClose, onSuccess, adminId }) {
            const [formData, setFormData] = useState({
                name: '',
                description: '',
                dayOfWeek: 'Monday',
                time: '18:00',
                recurring: true,
                link: '',
                members: []
            });
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                
                try {
                    await db.collection('groups').add({
                        ...formData,
                        coachId: adminId,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        nextMeeting: calculateNextMeeting(formData.dayOfWeek, formData.time),
                        attendance: {}
                    });
                    
                    alert('Group created successfully!');
                    onSuccess();
                } catch (error) {
                    console.error('Error creating group:', error);
                    alert('Failed to create group');
                } finally {
                    setLoading(false);
                }
            };

            const calculateNextMeeting = (dayOfWeek, time) => {
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const targetDay = days.indexOf(dayOfWeek);
                const now = new Date();
                const currentDay = now.getDay();
                
                let daysUntilTarget = targetDay - currentDay;
                if (daysUntilTarget <= 0) {
                    daysUntilTarget += 7;
                }
                
                const nextMeeting = new Date();
                nextMeeting.setDate(nextMeeting.getDate() + daysUntilTarget);
                const [hours, minutes] = time.split(':');
                nextMeeting.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                
                return nextMeeting;
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">Create New Group</div>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Group Name *</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    value={formData.name}
                                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                                    required
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Description *</label>
                                <textarea
                                    className="form-input"
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                    required
                                />
                            </div>
                            
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px'}}>
                                <div className="form-group">
                                    <label className="form-label">Day of Week *</label>
                                    <select 
                                        className="form-input"
                                        value={formData.dayOfWeek}
                                        onChange={(e) => setFormData({...formData, dayOfWeek: e.target.value})}
                                        required
                                    >
                                        <option value="Monday">Monday</option>
                                        <option value="Tuesday">Tuesday</option>
                                        <option value="Wednesday">Wednesday</option>
                                        <option value="Thursday">Thursday</option>
                                        <option value="Friday">Friday</option>
                                        <option value="Saturday">Saturday</option>
                                        <option value="Sunday">Sunday</option>
                                    </select>
                                </div>
                                
                                <div className="form-group">
                                    <label className="form-label">Time *</label>
                                    <input
                                        type="time"
                                        className="form-input"
                                        value={formData.time}
                                        onChange={(e) => setFormData({...formData, time: e.target.value})}
                                        required
                                    />
                                </div>
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Meeting Link (optional)</label>
                                <input
                                    type="url"
                                    className="form-input"
                                    placeholder="https://zoom.us/..."
                                    value={formData.link}
                                    onChange={(e) => setFormData({...formData, link: e.target.value})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <div className="checkbox-group">
                                    <input
                                        type="checkbox"
                                        id="recurring"
                                        checked={formData.recurring}
                                        onChange={(e) => setFormData({...formData, recurring: e.target.checked})}
                                    />
                                    <label htmlFor="recurring">Recurring Weekly</label>
                                </div>
                            </div>
                            
                            <div style={{display: 'flex', gap: '10px', marginTop: '20px'}}>
                                <button 
                                    type="submit"
                                    className="btn btn-primary"
                                    disabled={loading}
                                >
                                    {loading ? 'Creating...' : 'Create Group'}
                                </button>
                                <button 
                                    type="button"
                                    className="btn btn-secondary"
                                    onClick={onClose}
                                >
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }
 function GroupDetailModal({ group, onClose, onUpdate }) {
            const [addingMember, setAddingMember] = useState(false);
            const [newMemberEmail, setNewMemberEmail] = useState('');

            const addMember = async () => {
                if (!newMemberEmail) return;
                
                setAddingMember(true);
                try {
                    const userSnap = await db.collection('users')
                        .where('email', '==', newMemberEmail)
                        .get();
                    
                    if (userSnap.empty) {
                        alert('User not found');
                        return;
                    }
                    
                    const userId = userSnap.docs[0].id;
                    const members = group.members || [];
                    
                    if (members.includes(userId)) {
                        alert('User is already a member');
                        return;
                    }
                    
                    members.push(userId);
                    
                    await db.collection('groups').doc(group.id).update({
                        members: members
                    });
                    
                    alert('Member added successfully');
                    setNewMemberEmail('');
                    onUpdate();
                } catch (error) {
                    console.error('Error adding member:', error);
                    alert('Failed to add member');
                } finally {
                    setAddingMember(false);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">{group.name}</div>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        
                        <p style={{marginBottom: '20px'}}>{group.description}</p>
                        
                        <div style={{marginBottom: '20px'}}>
                            <strong>Schedule:</strong> {group.dayOfWeek} at {group.time}
                            {group.recurring && ' (Recurring)'}
                        </div>
                        
                        {group.link && (
                            <div style={{marginBottom: '20px'}}>
                                <strong>Meeting Link:</strong>{' '}
                                <a href={group.link} target="_blank" rel="noopener noreferrer" style={{color: '#f4c430'}}>
                                    {group.link}
                                </a>
                            </div>
                        )}
                        
                        <div style={{marginBottom: '20px'}}>
                            <h4 style={{marginBottom: '15px'}}>Members ({group.membersData?.length || 0})</h4>
                            
                            {group.membersData?.map(member => (
                                <div key={member.id} style={{
                                    padding: '10px',
                                    background: 'rgba(255,255,255,0.05)',
                                    borderRadius: '10px',
                                    marginBottom: '10px'
                                }}>
                                    {member.name}
                                </div>
                            ))}
                            
                            <div style={{display: 'flex', gap: '10px', marginTop: '15px'}}>
                                <input
                                    type="email"
                                    className="form-input"
                                    placeholder="Enter member email..."
                                    value={newMemberEmail}
                                    onChange={(e) => setNewMemberEmail(e.target.value)}
                                />
                                <button 
                                    className="btn btn-primary"
                                    onClick={addMember}
                                    disabled={addingMember}
                                >
                                    {addingMember ? 'Adding...' : 'Add Member'}
                                </button>
                            </div>
                        </div>
                        
                        <button className="btn btn-secondary" onClick={onClose}>Close</button>
                    </div>
                </div>
            );
        }

        function CreateResourceModal({ onClose, onSuccess }) {
            const [formData, setFormData] = useState({
                title: '',
                description: '',
                type: 'Link',
                url: '',
                content: '',
                category: 'General',
                isGlobal: true,
                assignedTo: []
            });
            const [file, setFile] = useState(null);
            const [uploadProgress, setUploadProgress] = useState(0);
            const [loading, setLoading] = useState(false);

            const handleFileChange = (e) => {
                const selectedFile = e.target.files[0];
                if (selectedFile) {
                    // Check file size (10MB limit)
                    if (selectedFile.size > 10 * 1024 * 1024) {
                        alert('File size must be less than 10MB');
                        return;
                    }
                    
                    // Check file type
                    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'image/webp'];
                    if (!allowedTypes.includes(selectedFile.type)) {
                        alert('Only PDF and image files are allowed');
                        return;
                    }
                    
                    setFile(selectedFile);
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                
                try {
                    const resourceData = {
                        ...formData,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: auth.currentUser.uid
                    };
                    
                    // If file upload is needed
                    if (file && formData.type !== 'Link') {
                        const resourceRef = db.collection('resources').doc();
                        const storageRef = storage.ref(`resources/${resourceRef.id}/${file.name}`);
                        
                        // Upload file with progress tracking
                        const uploadTask = storageRef.put(file);
                        
                        uploadTask.on('state_changed',
                            (snapshot) => {
                                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                setUploadProgress(progress);
                            },
                            (error) => {
                                console.error('Upload error:', error);
                                alert('Failed to upload file');
                                setLoading(false);
                            },
                            async () => {
                                // Get download URL
                                const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                                resourceData.fileURL = downloadURL;
                                resourceData.fileName = file.name;
                                
                                // Save to Firestore
                                await resourceRef.set(resourceData);
                                alert('Resource created successfully!');
                                onSuccess();
                            }
                        );
                    } else {
                        // No file upload, just save data
                        await db.collection('resources').add(resourceData);
                        alert('Resource created successfully!');
                        onSuccess();
                    }
                } catch (error) {
                    console.error('Error creating resource:', error);
                    alert('Failed to create resource');
                    setLoading(false);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">Add New Resource</div>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Title *</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    value={formData.title}
                                    onChange={(e) => setFormData({...formData, title: e.target.value})}
                                    required
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Description *</label>
                                <textarea
                                    className="form-input"
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                    required
                                />
                            </div>
                            
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px'}}>
                                <div className="form-group">
                                    <label className="form-label">Type *</label>
                                    <select 
                                        className="form-input"
                                        value={formData.type}
                                        onChange={(e) => setFormData({...formData, type: e.target.value})}
                                        required
                                    >
                                        <option value="Link">Link</option>
                                        <option value="PDF">PDF</option>
                                        <option value="Video">Video</option>
                                        <option value="Article">Article</option>
                                        <option value="Audio">Audio</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                
                                <div className="form-group">
                                    <label className="form-label">Category</label>
                                    <select 
                                        className="form-input"
                                        value={formData.category}
                                        onChange={(e) => setFormData({...formData, category: e.target.value})}
                                    >
                                        <option value="General">General</option>
                                        <option value="Educational">Educational</option>
                                        <option value="Motivational">Motivational</option>
                                        <option value="Tools">Tools</option>
                                        <option value="Exercises">Exercises</option>
                                    </select>
                                </div>
                            </div>
                            
                            {formData.type === 'Link' ? (
                                <div className="form-group">
                                    <label className="form-label">URL *</label>
                                    <input
                                        type="url"
                                        className="form-input"
                                        value={formData.url}
                                        onChange={(e) => setFormData({...formData, url: e.target.value})}
                                        required
                                    />
                                </div>
                            ) : (
                                <div className="form-group">
                                    <label className="form-label">Upload File (Max 10MB)</label>
                                    <input
                                        type="file"
                                        className="form-input"
                                        onChange={handleFileChange}
                                        accept=".pdf,image/*"
                                    />
                                    {uploadProgress > 0 && uploadProgress < 100 && (
                                        <div style={{marginTop: '10px'}}>
                                            <div className="progress-bar">
                                                <div className="progress-fill" style={{width: `${uploadProgress}%`}}></div>
                                            </div>
                                            <div style={{fontSize: '12px', marginTop: '5px'}}>
                                                Uploading: {Math.round(uploadProgress)}%
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            {formData.type !== 'Link' && (
                                <div className="form-group">
                                    <label className="form-label">Additional Content/Notes</label>
                                    <textarea
                                        className="form-input"
                                        value={formData.content}
                                        onChange={(e) => setFormData({...formData, content: e.target.value})}
                                        placeholder="Add any additional notes or instructions..."
                                        rows="3"
                                    />
                                </div>
                            )}
                            
                            <div className="form-group">
                                <div className="checkbox-group">
                                    <input
                                        type="checkbox"
                                        id="isGlobal"
                                        checked={formData.isGlobal}
                                        onChange={(e) => setFormData({...formData, isGlobal: e.target.checked})}
                                    />
                                    <label htmlFor="isGlobal">Available to all PIRs</label>
                                </div>
                            </div>
                            
                            <div style={{display: 'flex', gap: '10px', marginTop: '20px'}}>
                                <button 
                                    type="submit"
                                    className="btn btn-primary"
                                    disabled={loading}
                                >
                                    {loading ? 'Creating...' : 'Create Resource'}
                                </button>
                                <button 
                                    type="button"
                                    className="btn btn-secondary"
                                    onClick={onClose}
                                    disabled={loading}
                                >
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function ResourceDetailModal({ resource, onClose }) {
            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">{resource.title}</div>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        
                        <div style={{marginBottom: '20px'}}>
                            <span className="badge badge-info">{resource.type}</span>
                            <span className="badge badge-info" style={{marginLeft: '10px'}}>{resource.category}</span>
                        </div>
                        
                        <p style={{marginBottom: '20px'}}>{resource.description}</p>
                        
                        {(resource.url || resource.fileURL) && (
                            <div style={{marginBottom: '20px'}}>
                                <a 
                                    href={resource.url || resource.fileURL}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="btn btn-primary"
                                >
                                    Open Resource
                                </a>
                            </div>
                        )}
                        
                        {resource.content && (
                            <div style={{
                                padding: '20px',
                                background: 'rgba(255,255,255,0.05)',
                                borderRadius: '10px',
                                whiteSpace: 'pre-wrap'
                            }}>
                                {resource.content}
                            </div>
                        )}
                    </div>
                </div>
            );
        }     
    // Initialize App
        ReactDOM.render(<AdminApp />, document.getElementById('root'));
    </script>
</body>
</html>
