<!DOCTYPE html> 
<html lang="en">
<head>
   <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Security-Policy" 
      content="default-src 'self'; 
               script-src 'self' 'unsafe-inline' 'unsafe-eval' https://apis.google.com https://accounts.google.com https://www.gstatic.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com; 
               style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
               font-src 'self' https://fonts.gstatic.com; 
               img-src 'self' data: https: blob:; 
               connect-src 'self' 
                   https://identitytoolkit.googleapis.com 
                   https://securetoken.googleapis.com 
                   https://firestore.googleapis.com 
                   https://firebase.googleapis.com 
                   https://firebasestorage.googleapis.com 
                   https://storage.googleapis.com
                   https://glrs-pir-system.firebasestorage.app
                   https://*.firebasestorage.app
                   https://gmail.googleapis.com 
                   https://www.googleapis.com 
                   wss://*.firebaseio.com; 
               frame-src 'self' https://accounts.google.com https://content.googleapis.com https://glrs-pir-system.firebaseapp.com https://glrs-pir-system.web.app;">
<title>GLRS Admin Portal</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- Add this with your other script tags -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Google Identity Services (NEW API) -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- jsPDF for PDF exports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
   /* ========================================
   GLRS THEME VARIABLES - DYNAMIC THEMING SYSTEM
   All colors use variables - NO hardcoded values
======================================== */

:root {
    /* ========== MEDICAL-STANDARD PRIMARY COLORS ========== */
    /* Medical Blue - Trust, Professionalism, Healthcare Standard */
    --primary-color: #0077CC;
    --primary-light: #339FDB;
    --primary-dark: #005BA3;
    --primary-rgb: 0, 119, 204;

    /* ========== MEDICAL-STANDARD SECONDARY COLORS ========== */
    /* Healthcare Teal - Calm, Clinical, Professional */
    --secondary-color: #008B8B;
    --secondary-light: #20A5A5;
    --secondary-dark: #006B6B;
    --secondary-rgb: 0, 139, 139;

    /* ========== MEDICAL-STANDARD ACCENT COLORS ========== */
    /* Medical Orange - Warmth, Energy, Medical Alert */
    --accent-color: #FF8C00;
    --accent-light: #FFA533;
    --accent-dark: #CC7000;

    /* ========== MEDICAL-STANDARD STATUS COLORS ========== */
    /* Medical Green - Health, Vitality, Success */
    --success-color: #00A86B;
    --success-light: #33BA87;
    --success-dark: #008554;
    --success-rgb: 0, 168, 107;

    /* Medical Amber - Caution, Warning, Alert */
    --warning-color: #FFA500;
    --warning-light: #FFB833;
    --warning-dark: #CC8400;
    --warning-rgb: 255, 165, 0;

    /* Medical Crimson - Emergency, Danger, Critical */
    --danger-color: #DC143C;
    --danger-light: #E5476F;
    --danger-dark: #B01030;
    --danger-rgb: 220, 20, 60;

    /* Medical Steel Blue - Information, Clinical Data */
    --info-color: #4682B4;
    --info-light: #6B9FD0;
    --info-dark: #3A6C9B;
    --info-rgb: 70, 130, 180;

    /* ========== MEDICAL-STANDARD GRADIENTS ========== */
    --gradient-primary: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    --gradient-primary-hover: linear-gradient(135deg, var(--primary-light) 0%, var(--secondary-light) 100%);

    --gradient-success: linear-gradient(135deg, var(--success-color) 0%, var(--success-dark) 100%);
    --gradient-warning: linear-gradient(135deg, var(--warning-color) 0%, var(--warning-dark) 100%);
    --gradient-danger: linear-gradient(135deg, var(--danger-color) 0%, var(--danger-dark) 100%);
    --gradient-info: linear-gradient(135deg, var(--info-color) 0%, var(--info-dark) 100%);

    /* ========== MEDICAL-STANDARD BACKGROUND COLORS ========== */
    /* Deep Professional Backgrounds */
    --bg-dark: #2C3E50;
    --bg-darker: #1C2833;

    /* Glass/Overlay Effects */
    --bg-glass: rgba(255, 255, 255, 0.05);
    --bg-glass-10: rgba(255, 255, 255, 0.1);
    --bg-glass-15: rgba(255, 255, 255, 0.15);

    /* Light Tinted Backgrounds */
    --bg-primary-light: rgba(0, 119, 204, 0.05);
    --bg-success-light: rgba(0, 168, 107, 0.1);
    --bg-warning-light: rgba(255, 165, 0, 0.1);
    --bg-danger-light: rgba(220, 20, 60, 0.1);

    /* Clean Medical Backgrounds */
    --bg-light: #F8F9FA;
    --bg-gray: #E9ECEF;

    /* ========== MEDICAL-STANDARD TEXT COLORS ========== */
    --text-white: #FFFFFF;
    --text-light: #E0E0E0;
    --text-gray: #95A5A6;
    --text-medium: #5A6C7D;
    --text-dark-gray: #2C3E50;
    --text-black: #000000;

    /* Common Text Shades */
    --text-333: #333333;
    --text-666: #666666;
    --text-999: #999999;

    /* ========== MEDICAL-STANDARD BORDER COLORS ========== */
    --border-glass: rgba(255, 255, 255, 0.1);
    --border-glass-20: rgba(255, 255, 255, 0.2);
    --border-primary: rgba(0, 119, 204, 0.3);
    --border-success: rgba(0, 168, 107, 0.3);
    --border-light: #E5E7EB;
    --border-medium: #E0E0E0;

    /* ========== MEDICAL-STANDARD SHADOWS ========== */
    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 8px 25px rgba(0, 0, 0, 0.15);
    --shadow-primary: 0 4px 12px rgba(0, 119, 204, 0.3);
    --shadow-success: 0 4px 12px rgba(0, 168, 107, 0.3);

    /* ========== SPACING ========== */
    --spacing-xs: 5px;
    --spacing-sm: 10px;
    --spacing-md: 20px;
    --spacing-lg: 30px;
    --spacing-xl: 40px;

    /* ========== BORDER RADIUS ========== */
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 15px;
    --radius-xl: 20px;
    --radius-round: 50%;

    /* ========== TRANSITIONS ========== */
    --transition-fast: all 0.2s ease;
    --transition-normal: all 0.3s ease;
    --transition-slow: all 0.5s ease;
}

body {
    background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-darker) 100%);
    color: var(--text-light);
}
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-darker) 100%);
            color: var(--text-light);
            min-height: 100vh;
        }

        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Connection Status Bar */
        .connection-status {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 5px;
            text-align: center;
            font-size: 12px;
            z-index: 2000;
            transition: all 0.3s ease;
        }

        .connection-status.online {
            background: var(--success-color);
            transform: translateY(-100%);
        }

        .connection-status.offline {
            background: var(--danger-color);
            transform: translateY(0);
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 20px;
            background: var(--gradient-accent);
            color: var(--text-black);
            font-weight: bold;
            font-size: 18px;
            text-align: center;
        }

        .nav-section {
            padding: 10px;
        }

        .nav-section-title {
            font-size: 11px;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.5);
            padding: 10px;
            letter-spacing: 1px;
        }

        .nav-item {
            padding: 12px 15px;
            margin: 5px 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            background: var(--gradient-accent);
            color: var(--text-black);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            padding: 20px 30px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .search-bar {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            color: white;
            width: 300px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-bar:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--accent-color);
        }

        .refresh-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
            padding: 10px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .notification-bell:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .notification-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
        }

        .content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            overflow-x: auto;
        }

        /* Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .stat-label {
            font-size: 12px;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            background: var(--gradient-accent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .stat-change {
            font-size: 12px;
            color: var(--success-color);
        }

        /* Tables */
        .table-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        th {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.8);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        td {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.9);
        }

        tr:hover td {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
            outline: none;
        }

        .btn-primary {
            background: var(--gradient-accent);
            color: var(--text-black);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(var(--accent-color), 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: var(--gradient-danger);
            color: white;
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: var(--bg-dark);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--accent-color);
        }

        select.form-input {
            cursor: pointer;
        }

        textarea.form-input {
            resize: vertical;
            min-height: 100px;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
        }

        .page-btn {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .page-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.2);
        }

        .page-btn.active {
            background: var(--gradient-accent);
            color: var(--text-black);
            border: none;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Loading */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 50px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-container {
            text-align: center;
            padding: 50px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 50px;
            color: rgba(255, 255, 255, 0.5);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .empty-state-text {
            font-size: 16px;
        }

        /* User Avatar */
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            color: white;
        }

        /* Status Badges */
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .badge-success {
            background: rgba(var(--success-rgb), 0.2);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }

        .badge-warning {
            background: rgba(var(--warning-rgb), 0.2);
            color: var(--warning-color);
            border: 1px solid var(--warning-color);
        }

        .badge-danger {
            background: rgba(var(--danger-rgb), 0.2);
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }

        .badge-info {
            background: rgba(var(--info-rgb), 0.2);
            color: var(--info-color);
            border: 1px solid var(--info-color);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-btn:hover {
            color: rgba(255, 255, 255, 0.9);
        }

        .tab-btn.active {
            color: var(--accent-color);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gradient-accent);
        }

        /* Notification Dropdown */
        .notification-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            width: 400px;
            background: var(--bg-dark);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin-top: 10px;
            max-height: 500px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .notification-header {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-item {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .notification-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .notification-item.unread {
            background: rgba(255, 140, 0, 0.1);
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-accent);
            transition: width 0.3s ease;
        }

        /* File Upload */
        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: var(--accent-color);
            background: rgba(255, 140, 0, 0.05);
        }

        .upload-area.dragging {
            border-color: var(--accent-color);
            background: rgba(255, 140, 0, 0.1);
        }

        /* Charts Container */
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            height: 400px;
            position: relative;
        }

        /* Messages */
        .message-bubble {
            padding: 10px 15px;
            border-radius: 15px;
            margin-bottom: 10px;
            max-width: 70%;
        }

        .message-bubble.sent {
            background: var(--gradient-accent);
            color: var(--text-black);
            align-self: flex-end;
            margin-left: auto;
        }

        .message-bubble.received {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
        }

        /* Groups */
        .group-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .group-title {
            font-size: 18px;
            font-weight: 600;
        }

        .group-members {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .member-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            border: 2px solid var(--bg-dark);
        }

        /* Resources */
        .resource-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .resource-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .resource-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .resource-type {
            display: inline-block;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            font-size: 11px;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .resource-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .resource-description {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 15px;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-darker) 100%);
        }

        .login-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-title {
            font-size: 32px;
            font-weight: bold;
            background: var(--gradient-accent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .error-message {
            background: rgba(var(--danger-rgb), 0.1);
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .success-message {
            background: rgba(var(--success-rgb), 0.1);
            border: 1px solid var(--success-color);
            color: var(--success-color);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        /* Checkbox */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        /* Filters */
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            font-size: 12px;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.6);
            letter-spacing: 1px;
        }

        .filter-select {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            outline: none;
            transition: all 0.3s ease;
        }

        .filter-select:focus {
            border-color: var(--accent-color);
            background: rgba(255, 255, 255, 0.15);
        }

        /* Date Range Picker */
        .date-range {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .date-input {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            outline: none;
        }

        /* Mood Rating Display */
        .mood-scale {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .mood-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .mood-1 { background: var(--danger-color); }
        .mood-2 { background: #E6394A; }
        .mood-3 { background: #F07356; }
        .mood-4 { background: #FA9D62; }
        .mood-5 { background: #FFC76E; }
        .mood-6 { background: #FFE680; }
        .mood-7 { background: #B8D65C; }
        .mood-8 { background: #7BC658; }
        .mood-9 { background: #44B854; }
        .mood-10 { background: var(--success-color); }

        /* Responsive Layout */
        @media (max-width: 768px) {
            .content {
                margin-left: 0 !important;
                padding: 70px 10px 10px !important;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        // Firebase Configuration
       const firebaseConfig = {
    apiKey: "AIzaSyAufSTHtCTFSEIeZ9YzvrULCnji5I-SMi0",
    authDomain: "glrs-pir-system.firebaseapp.com",
    projectId: "glrs-pir-system",
    storageBucket: "glrs-pir-system.firebasestorage.app", // ✅ CORRECT
    messagingSenderId: "830378577655",
    appId: "..."
};
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // ==========================================
        // MULTI-TENANT ARCHITECTURE - PHASE 0
        // ==========================================

        // Tenant Detection Function
        // Detects tenant from subdomain (e.g., tenant.glrecoveryservices.com)
        // Falls back to 'glrs' for localhost and default domain
        const getTenantId = () => {
            const hostname = window.location.hostname;

            // For localhost or IP addresses
            if (hostname === 'localhost' || hostname.match(/^\d+\.\d+\.\d+\.\d+$/)) {
                return 'glrs';
            }

            // Extract subdomain
            const parts = hostname.split('.');

            // For subdomain.glrecoveryservices.com
            if (parts.length >= 3) {
                const subdomain = parts[0];
                // Exclude common prefixes
                if (subdomain !== 'www' && subdomain !== 'app') {
                    return subdomain;
                }
            }

            // Default tenant
            return 'glrs';
        };

        const CURRENT_TENANT = getTenantId();

        // Audit Logging Function for HIPAA Compliance
        const logAudit = async (action, details = {}) => {
            try {
                const currentUser = auth.currentUser;
                if (!currentUser) return;

                // Get user data for logging
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.exists ? userDoc.data() : {};

                await db.collection('auditLogs').add({
                    tenantId: details.tenantId || CURRENT_TENANT,
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    userName: userData.displayName || `${userData.firstName || ''} ${userData.lastName || ''}`.trim(),
                    userRole: userData.role || 'unknown',
                    action: action,
                    targetUserId: details.targetUserId || null,
                    targetResource: details.resource || null,
                    resourceId: details.resourceId || null,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    changes: details.changes || null,
                    metadata: {
                        userAgent: navigator.userAgent,
                        url: window.location.href
                    },
                    success: details.success !== false
                });
            } catch (error) {
                console.error('Failed to log audit:', error);
                // Don't throw - audit logging should not break app functionality
            }
        };

        // Notification Preference Helper Functions
        const getUserNotificationPrefs = async (userId) => {
            try {
                const prefsDoc = await db.collection('settings').doc(`${userId}-notifications`).get();
                if (prefsDoc.exists) {
                    return prefsDoc.data();
                }
                // Default preferences (all enabled)
                return {
                    emailOnSOS: true,
                    emailOnMissedCheckIn: true,
                    emailOnNewPIR: true,
                    emailOnGoalComplete: true,
                    emailOnAlert: true,
                    pushOnSOS: true,
                    pushOnMessage: true,
                    pushOnAlert: true,
                    quietHoursEnabled: false,
                    quietHoursStart: '22:00',
                    quietHoursEnd: '08:00'
                };
            } catch (error) {
                console.error('Error loading notification preferences:', error);
                return null;
            }
        };

        const isInQuietHours = (prefs) => {
            if (!prefs || !prefs.quietHoursEnabled) return false;

            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();

            const [startH, startM] = (prefs.quietHoursStart || '22:00').split(':').map(Number);
            const [endH, endM] = (prefs.quietHoursEnd || '08:00').split(':').map(Number);

            const quietStart = startH * 60 + startM;
            const quietEnd = endH * 60 + endM;

            // Handle overnight quiet hours (e.g., 22:00 to 08:00)
            if (quietStart > quietEnd) {
                return currentMinutes >= quietStart || currentMinutes <= quietEnd;
            }
            // Handle same-day quiet hours
            return currentMinutes >= quietStart && currentMinutes <= quietEnd;
        };

        const shouldSendNotification = async (recipientId, notificationType) => {
            try {
                const prefs = await getUserNotificationPrefs(recipientId);
                if (!prefs) return true; // If can't load prefs, allow notification

                // Check quiet hours (applies to all non-urgent notifications)
                if (notificationType !== 'sos' && isInQuietHours(prefs)) {
                    console.log(`⏰ Notification suppressed (quiet hours): ${notificationType} for user ${recipientId}`);
                    return false;
                }

                // Check notification type preferences
                const prefMap = {
                    'sos': 'emailOnSOS',
                    'sos_push': 'pushOnSOS',
                    'alert': 'emailOnAlert',
                    'alert_push': 'pushOnAlert',
                    'assignment_created': 'emailOnNewPIR',
                    'assignment_push': 'pushOnMessage',
                    'user-created': 'emailOnNewPIR',
                    'pir_assigned': 'emailOnNewPIR',
                    'coach_changed': 'emailOnAlert',
                    'goal_complete': 'emailOnGoalComplete',
                    'message': 'pushOnMessage'
                };

                const prefKey = prefMap[notificationType];
                if (prefKey && prefs[prefKey] === false) {
                    console.log(`🔕 Notification suppressed (user preference): ${notificationType} for user ${recipientId}`);
                    return false;
                }

                return true;
            } catch (error) {
                console.error('Error checking notification preferences:', error);
                return true; // On error, allow notification
            }
        };

        const createNotificationWithPreferences = async (notificationData, notificationType) => {
            try {
                const recipientId = notificationData.recipientId || notificationData.userId;
                if (!recipientId) {
                    console.error('❌ Cannot create notification: no recipientId specified');
                    return null;
                }

                const shouldSend = await shouldSendNotification(recipientId, notificationType);
                if (!shouldSend) {
                    return null; // Notification suppressed
                }

                // Create the notification
                const notifRef = await db.collection('notifications').add({
                    ...notificationData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                console.log(`✅ Notification created: ${notificationType} for user ${recipientId}`);
                return notifRef;
            } catch (error) {
                console.error('Error creating notification:', error);
                throw error;
            }
        };

        // Role hierarchy helper
        const ROLE_HIERARCHY = {
            superadmin: 4,
            admin: 3,
            coach: 2,
            pir: 1
        };

        const hasPermission = (userRole, requiredRole) => {
            return (ROLE_HIERARCHY[userRole] || 0) >= (ROLE_HIERARCHY[requiredRole] || 0);
        };

        const isSuperAdmin = (user) => {
            return user && user.role === 'superadmin';
        };

        // Tenant Branding System
        let tenantConfig = null;

        const loadTenantBranding = async (tenantId) => {
            try {
                const tenantDoc = await db.collection('tenants').doc(tenantId).get();
                if (tenantDoc.exists) {
                    tenantConfig = tenantDoc.data();
                    applyTenantBranding(tenantConfig.config?.branding);
                }
            } catch (error) {
                console.error('Error loading tenant branding:', error);
                // Use default branding
                applyDefaultBranding();
            }
        };

        const applyTenantBranding = (branding) => {
            if (!branding) {
                applyDefaultBranding();
                return;
            }

            const root = document.documentElement;
            root.style.setProperty('--primary-color', branding.primaryColor || '#0077CC');
            root.style.setProperty('--secondary-color', branding.secondaryColor || '#008B8B');
            root.style.setProperty('--accent-color', branding.accentColor || '#FF8C00');

            // Update logo if provided
            if (branding.logoUrl) {
                const logoElements = document.querySelectorAll('.tenant-logo');
                logoElements.forEach(el => {
                    el.src = branding.logoUrl;
                    el.style.display = 'block';
                });
            }
        };

        const applyDefaultBranding = () => {
            const root = document.documentElement;
            root.style.setProperty('--primary-color', '#DC143C');
            root.style.setProperty('--secondary-color', '#008B8B');
            root.style.setProperty('--accent-color', '#FF8C00');
        };

        // Data Migration & Validation Utilities
        const COLLECTIONS_TO_MIGRATE = [
            'users', 'checkIns', 'alerts', 'messages', 'goals', 'objectives',
            'assignments', 'meetings', 'supportGroups', 'topicRooms', 'resources',
            'milestones', 'pirNotes', 'notifications', 'moderationActions',
            'userWarnings', 'meetingAttendance', 'messageReactions', 'activities',
            'pledges', 'coachNotes', 'checkInReviews', 'sessionFlags'
        ];

        const migrateTenantData = async (tenantId, onProgress) => {
            console.log(`🔄 Starting migration for tenant: ${tenantId}`);
            let totalUpdated = 0;

            for (const collection of COLLECTIONS_TO_MIGRATE) {
                try {
                    const snapshot = await db.collection(collection)
                        .where('tenantId', '==', null)
                        .limit(500)
                        .get();

                    if (snapshot.empty) {
                        console.log(`✓ ${collection}: No documents to migrate`);
                        continue;
                    }

                    const batch = db.batch();
                    let batchCount = 0;

                    snapshot.forEach(doc => {
                        batch.update(doc.ref, { tenantId: tenantId });
                        batchCount++;
                    });

                    if (batchCount > 0) {
                        await batch.commit();
                        totalUpdated += batchCount;
                        console.log(`✓ ${collection}: Migrated ${batchCount} documents`);
                        if (onProgress) onProgress(collection, batchCount);
                    }
                } catch (error) {
                    console.error(`✗ ${collection}: Migration failed`, error);
                }
            }

            console.log(`✅ Migration complete! Updated ${totalUpdated} documents`);
            return totalUpdated;
        };

        const validateTenantData = async (tenantId) => {
            console.log(`🔍 Validating data for tenant: ${tenantId}`);
            const report = {};

            for (const collection of COLLECTIONS_TO_MIGRATE) {
                try {
                    const totalSnap = await db.collection(collection).get();
                    const tenantSnap = await db.collection(collection)
                        .where('tenantId', '==', tenantId)
                        .get();
                    const nullSnap = await db.collection(collection)
                        .where('tenantId', '==', null)
                        .get();

                    report[collection] = {
                        total: totalSnap.size,
                        withTenant: tenantSnap.size,
                        missing: nullSnap.size
                    };
                } catch (error) {
                    report[collection] = { error: error.message };
                }
            }

            console.table(report);
            return report;
        };

        // Make utilities available globally for manual execution
        window.migrateTenantData = migrateTenantData;
        window.validateTenantData = validateTenantData;

       function formatDate(date) {
    if (!date) return '';
    const d = date?.toDate ? date.toDate() : new Date(date);
    return d.toLocaleDateString('en-US', { timeZone: 'UTC' });
}
       

        function formatDateTime(date) {
            if (!date) return '-';
            const d = date?.toDate ? date.toDate() : new Date(date);
            if (isNaN(d.getTime())) return '-';
            return d.toLocaleString();
        }

        function formatTimeAgo(date) {
            if (!date) return '-';
            const d = date?.toDate ? date.toDate() : new Date(date);
            if (isNaN(d.getTime())) return '-';
            const now = new Date();
            const seconds = Math.floor((now - d) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)} mins ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)} days ago`;
            return d.toLocaleDateString();
        }

        // Debounce utility
        function useDebounce(value, delay) {
            const [debouncedValue, setDebouncedValue] = useState(value);
            
            useEffect(() => {
                const handler = setTimeout(() => {
                    setDebouncedValue(value);
                }, delay);
                
                return () => clearTimeout(handler);
            }, [value, delay]);
            
            return debouncedValue;
        }

        // Connection Status Hook
        function useConnectionStatus() {
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            
            useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);
                
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);
            
            return isOnline;
        }

        // Batch query utility - handles Firestore's 10-item 'in' query limit
        async function batchQuery(collection, field, values, additionalConstraints = []) {
            if (values.length === 0) return [];
            
            const results = [];
            const chunks = [];
            
            // Split into chunks of 10
            for (let i = 0; i < values.length; i += 10) {
                chunks.push(values.slice(i, i + 10));
            }
            
            // Query each chunk
            for (const chunk of chunks) {
                let query = db.collection(collection).where(field, 'in', chunk);
                
                // Add additional constraints
                for (const constraint of additionalConstraints) {
                    query = query[constraint.method](...constraint.args);
                }
                
                const snapshot = await query.get();
                snapshot.forEach(doc => {
                    results.push({ id: doc.id, ...doc.data() });
                });
            }
            
            return results;
        }

        // Export utilities
        function exportToJSON(data, filename) {
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportToCSV(data, filename) {
            if (!data || data.length === 0) {
                alert('No data to export');
                return;
            }
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => 
                    headers.map(header => {
                        const cell = row[header];
                        const value = cell === null || cell === undefined ? '' : String(cell);
                        return value.includes(',') || value.includes('"') || value.includes('\n') 
                            ? `"${value.replace(/"/g, '""')}"` 
                            : value;
                    }).join(',')
                )
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportToPDF(data, title) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.text(title, 20, 20);
            
            if (Array.isArray(data) && data.length > 0) {
                const headers = Object.keys(data[0]);
                const rows = data.map(item => headers.map(header => String(item[header] || '')));
                
                doc.autoTable({
                    head: [headers],
                    body: rows,
                    startY: 30,
                });
            } else {
                doc.setFontSize(12);
                doc.text(JSON.stringify(data, null, 2), 20, 40);
            }
            
            doc.save(`${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
        }





      // ==========================================
// SEND NEW ASSIGNMENT EMAIL
// ==========================================
const sendNewAssignmentEmail = async (pirEmail, pirName, assignmentData, coachName) => {
    try {
        console.log('📧 Sending new assignment email...');
        
        await db.collection('mail').add({
            to: [pirEmail],
            message: {
                subject: `📝 New Assignment: ${assignmentData.title}`,
                html: `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                        <div style="background: linear-gradient(135deg, #0077CC 0%, #008B8B 100%); color: white; padding: 20px; border-radius: 8px 8px 0 0;">
                            <h1 style="margin: 0; font-size: 24px;">📝 New Assignment</h1>
                        </div>
                        
                        <div style="background: #f9fafb; padding: 20px; border: 1px solid #e5e7eb;">
                            <h2 style="color: #0077CC; margin-top: 0;">You Have a New Task</h2>
                            
                            <div style="background: white; padding: 15px; border-radius: 8px; margin: 15px 0;">
                                <p style="margin: 5px 0;"><strong>Assignment:</strong> ${assignmentData.title}</p>
                                ${assignmentData.description ? `<p style="margin: 10px 0; color: #666;">${assignmentData.description}</p>` : ''}
                                <p style="margin: 5px 0;"><strong>Assigned By:</strong> ${coachName}</p>
                            </div>
                            
                            <div style="background: #fffbeb; padding: 15px; border-radius: 8px; margin: 15px 0;">
                                <p style="margin: 0; color: #92400e;">
                                    💡 <strong>Tip:</strong> Complete this assignment on time to maintain your progress streak!
                                </p>
                            </div>
                            
                            <div style="text-align: center; margin-top: 20px;">
                                <a href="app.glrecoveryservices.com"
                                   style="background: #0077CC; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">
                                    View Assignment
                                </a>
                            </div>
                        </div>
                        
                        <div style="background: #f3f4f6; padding: 15px; text-align: center; font-size: 12px; color: #6b7280; border-radius: 0 0 8px 8px;">
                            <p style="margin: 0;">Guiding Light Recovery Services</p>
                            <p style="margin: 5px 0 0 0;">Supporting your recovery journey</p>
                        </div>
                    </div>
                `,
                text: `
New Assignment: ${assignmentData.title}

${assignmentData.description || ''}

Assigned By: ${coachName}

View your assignment: app.glrecoveryservices.com

---
Guiding Light Recovery Services
                `
            }
        });
        
        console.log('✅ New assignment email sent');
        return true;
    } catch (error) {
        console.error('❌ Failed to send assignment email:', error);
        return false;
    }
};
// ==========================================
// WELCOME EMAIL TEMPLATE - FIREBASE EXTENSION VERSION
// ==========================================
function getWelcomeEmailHTML(pirName, coachName, email, tempPassword) {
    return `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f9f9f9;">
            <div style="background: linear-gradient(135deg, #0077CC 0%, #008B8B 100%); padding: 30px; border-radius: 10px 10px 0 0; text-align: center;">
                <h1 style="color: white; margin: 0; font-size: 32px;">Welcome to Your Recovery Journey! 🌟</h1>
            </div>
            
            <div style="background: white; padding: 30px; border-radius: 0 0 10px 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <p style="font-size: 18px; color: #333; margin-bottom: 20px;">
                    Hi <strong>${pirName}</strong>,
                </p>
                
                <p style="font-size: 16px; color: #333; line-height: 1.6; margin-bottom: 20px;">
                    We're thrilled to have you join Guiding Light Recovery Services! Your coach, <strong>${coachName}</strong>, has created your account and is ready to support you every step of the way.
                </p>
                
                <div style="background: #f0f8ff; border-left: 4px solid #0077CC; padding: 20px; margin: 20px 0; border-radius: 5px;">
                    <h2 style="color: #0077CC; margin: 0 0 15px 0; font-size: 20px;">📧 Your Login Credentials</h2>
                    <p style="margin: 10px 0; color: #555;"><strong>Email:</strong> ${email}</p>
                    <p style="margin: 10px 0; color: #555;"><strong>Temporary Password:</strong> <code style="background: #e8e8e8; padding: 5px 10px; border-radius: 4px; font-size: 16px;">${tempPassword}</code></p>
                    <p style="margin: 15px 0 0 0; color: #B01030; font-size: 14px;">
                        ⚠️ <strong>Important:</strong> Please change this password after your first login for security.
                    </p>
                </div>
                
                <div style="text-align: center; margin: 30px 0;">
                    <a href="app.glrecoveryservices.com" 
                       style="display: inline-block; background: linear-gradient(135deg, #0077CC 0%, #008B8B 100%); color: white; padding: 15px 40px; text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 18px;">
                        Access Your Portal
                    </a>
                </div>
                
                <div style="background: #fff9e6; border-left: 4px solid #ffa726; padding: 15px; margin: 20px 0; border-radius: 5px;">
                    <h3 style="color: #f57c00; margin: 0 0 10px 0; font-size: 16px;">🚀 Getting Started</h3>
                    <ul style="margin: 0; padding-left: 20px; color: #666;">
                        <li style="margin: 8px 0;">Complete your profile setup</li>
                        <li style="margin: 8px 0;">Set up emergency contacts</li>
                        <li style="margin: 8px 0;">Review your first assignment</li>
                        <li style="margin: 8px 0;">Schedule your welcome session</li>
                    </ul>
                </div>
                
                <p style="font-size: 14px; color: #666; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                    If you have any questions or need assistance, don't hesitate to reach out to your coach through the messaging system.
                </p>
                
                <p style="font-size: 14px; color: #666; margin-top: 20px;">
                    We're here to support you!<br>
                    <strong>Guiding Light Recovery Services Team</strong>
                </p>
            </div>
            
            <div style="text-align: center; margin-top: 20px; padding: 20px; color: #999; font-size: 12px;">
                <p style="margin: 5px 0;">Guiding Light Recovery Services</p>
                <p style="margin: 5px 0;">Virtual Recovery Coaching</p>
                <p style="margin: 5px 0;">
                    <a href="https://glrecoveryservices.com" style="color: #0077CC; text-decoration: none;">glrecoveryservices.com</a>
                </p>
            </div>
        </div>
    `;
}

function getWelcomeEmailText(pirName, coachName, email, tempPassword) {
    return `
Welcome to Your Recovery Journey!

Hi ${pirName},

We're thrilled to have you join Guiding Light Recovery Services! Your coach, ${coachName}, has created your account and is ready to support you every step of the way.

YOUR LOGIN CREDENTIALS
Email: ${email}
Temporary Password: ${tempPassword}

⚠️ IMPORTANT: Please change this password after your first login for security.

Access your portal: app.glrecoveryservices.com/admin.html

GETTING STARTED
- Complete your profile setup
- Set up emergency contacts
- Review your first assignment

If you have any questions or need assistance, don't hesitate to reach out to your coach through the messaging system.

We're here to support you!
Guiding Light Recovery Services Team

---
Guiding Light Recovery Services
Recovery Coaching
glrecoveryservices.com
    `;
}


// ============================================
// INDIVIDUAL EMAIL TEMPLATES
// ============================================

function getWelcomeEmailTemplate({ pirName, email, tempPassword, coachName }) {
    const subject = '🎉 Welcome to Guiding Light Recovery Services!';
    
    const body = `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f9f9f9;">
            <div style="background: linear-gradient(135deg, #0077CC 0%, #008B8B 100%); padding: 30px; border-radius: 10px 10px 0 0; text-align: center;">
                <h1 style="color: white; margin: 0; font-size: 32px;">Welcome to Your Recovery Journey! 🌟</h1>
            </div>
            
            <div style="background: white; padding: 30px; border-radius: 0 0 10px 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <p style="font-size: 18px; color: #333; margin-bottom: 20px;">
                    Hi <strong>${pirName}</strong>,
                </p>
                
                <p style="font-size: 16px; color: #333; line-height: 1.6; margin-bottom: 20px;">
                    We're thrilled to have you join Guiding Light Recovery Services! Your coach, <strong>${coachName}</strong>, has created your account and is ready to support you every step of the way.
                </p>
                
                <div style="background: #f0f8ff; border-left: 4px solid #0077CC; padding: 20px; margin: 20px 0; border-radius: 5px;">
                    <h2 style="color: #0077CC; margin: 0 0 15px 0; font-size: 20px;">📧 Your Login Credentials</h2>
                    <p style="margin: 10px 0; color: #555;"><strong>Email:</strong> ${email}</p>
                    <p style="margin: 10px 0; color: #555;"><strong>Temporary Password:</strong> <code style="background: #e8e8e8; padding: 5px 10px; border-radius: 4px; font-size: 16px;">${tempPassword}</code></p>
                    <p style="margin: 15px 0 0 0; color: #B01030; font-size: 14px;">
                        ⚠️ <strong>Important:</strong> Please change this password after your first login for security.
                    </p>
                </div>
                
                <div style="text-align: center; margin: 30px 0;">
                    <a href="app.glrecoveryservices.com" 
                       style="display: inline-block; background: linear-gradient(135deg, #0077CC 0%, #008B8B 100%); color: white; padding: 15px 40px; text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 18px;">
                        Access Your Portal
                    </a>
                </div>
                
                <div style="background: #fff9e6; border-left: 4px solid #ffa726; padding: 15px; margin: 20px 0; border-radius: 5px;">
                    <h3 style="color: #f57c00; margin: 0 0 10px 0; font-size: 16px;">🚀 Getting Started</h3>
                    <ul style="margin: 0; padding-left: 20px; color: #666;">
                        <li style="margin: 8px 0;">Complete your profile setup</li>
                        <li style="margin: 8px 0;">Set up emergency contacts</li>
                        <li style="margin: 8px 0;">Review your first assignment</li>
                        <li style="margin: 8px 0;">Schedule your welcome session</li>
                    </ul>
                </div>
                
                <p style="font-size: 14px; color: #666; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                    If you have any questions or need assistance, don't hesitate to reach out to your coach through the messaging system.
                </p>
                
                <p style="font-size: 14px; color: #666; margin-top: 20px;">
                    We're here to support you!<br>
                    <strong>Guiding Light Recovery Services Team</strong>
                </p>
            </div>
            
            <div style="text-align: center; margin-top: 20px; padding: 20px; color: #999; font-size: 12px;">
                <p style="margin: 5px 0;">Guiding Light Recovery Services</p>
                <p style="margin: 5px 0;">Virtual Recovery Coaching</p>
                <p style="margin: 5px 0;">
                    <a href="https://glrecoveryservices.com" style="color: #0077CC; text-decoration: none;">glrecoveryservices.com</a>
                </p>
            </div>
        </div>
    `;
    
    return { subject, body };
}
      
        
const getMilestoneApproachingTemplate = (pirName, milestone, daysUntil) => {
    const content = `
        <h1 style="color: #0077CC; margin: 0 0 20px 0; font-size: 28px;">Milestone Approaching!</h1>
        <p style="font-size: 16px; color: #333; line-height: 1.6; margin: 0 0 15px 0;">
            Hi ${pirName},
        </p>
        <p style="font-size: 16px; color: #333; line-height: 1.6; margin: 0 0 15px 0;">
            Exciting news! You're just <strong style="color: #0077CC;">${daysUntil} days away</strong> from reaching your <strong>${milestone}</strong> milestone!
        </p>
        
        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left: 4px solid #f59e0b; padding: 20px; margin: 25px 0; border-radius: 8px;">
            <p style="margin: 0 0 10px 0; font-size: 18px; color: #92400e; font-weight: 600; text-align: center;">
                ${milestone}
            </p>
            <p style="margin: 0; text-align: center; font-size: 14px; color: #78350f;">
                ${daysUntil} days to go!
            </p>
        </div>
        
        <p style="font-size: 16px; color: #333; line-height: 1.6; margin: 0 0 15px 0;">
            This is a significant achievement and a testament to your commitment and strength. Keep up the incredible work!
        </p>
        
        <div style="text-align: center; margin: 30px 0;">
            <a href="app.glrecoveryservices.com" 
               style="display: inline-block; padding: 14px 32px; background: linear-gradient(135deg, #0077CC 0%, #008B8B 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px;">
                View Your Progress
            </a>
        </div>
        
        <p style="font-size: 16px; color: #333; line-height: 1.6; margin: 0;">
            We're proud of you and the journey you're on. Keep moving forward!
        </p>
    `;
    return getEmailTemplate(content);
};

const getMilestoneAchievedTemplate = (pirName, milestone) => {
    const content = `
        <h1 style="color: #00A86B; margin: 0 0 20px 0; font-size: 28px;">MILESTONE ACHIEVED!</h1>
        <p style="font-size: 16px; color: #333; line-height: 1.6; margin: 0 0 15px 0;">
            Hi ${pirName},
        </p>
        <p style="font-size: 20px; color: #333; line-height: 1.6; margin: 0 0 15px 0; font-weight: 600;">
            CONGRATULATIONS!
        </p>
        <p style="font-size: 16px; color: #333; line-height: 1.6; margin: 0 0 15px 0;">
            You've officially reached your <strong style="color: #00A86B;">${milestone}</strong> milestone!
        </p>
        
        <div style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); border-left: 4px solid #00A86B; padding: 30px; margin: 25px 0; border-radius: 8px; text-align: center;">
            <p style="margin: 0 0 5px 0; font-size: 24px; color: #166534; font-weight: 600;">
                ${milestone}
            </p>
            <p style="margin: 0; font-size: 14px; color: #166534;">
                Milestone Achieved!
            </p>
        </div>
        
        <p style="font-size: 16px; color: #333; line-height: 1.6; margin: 0 0 15px 0;">
            This is a huge accomplishment and proof of your dedication, strength, and resilience. Every day you choose recovery is a victory worth celebrating.
        </p>
        
        <p style="font-size: 16px; color: #333; line-height: 1.6; margin: 0 0 15px 0;">
            Take a moment today to reflect on how far you've come. You should be incredibly proud of yourself!
        </p>
        
        <div style="text-align: center; margin: 30px 0;">
            <a href="app.glrecoveryservices.com" 
               style="display: inline-block; padding: 14px 32px; background: linear-gradient(135deg, #00A86B 0%, #008554 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px;">
                Celebrate Your Victory
            </a>
        </div>
        
        <p style="font-size: 16px; color: #333; line-height: 1.6; margin: 0;">
            Here's to many more milestones ahead!
        </p>
    `;
    return getEmailTemplate(content);
};

const getNewAssignmentTemplate = (pirName, title, description, dueDate) => {
    const content = `
        <h1 style="color: #0077CC; margin: 0 0 20px 0; font-size: 28px;">New Assignment</h1>
        <p style="font-size: 16px; color: #333; line-height: 1.6; margin: 0 0 15px 0;">
            Hi ${pirName},
        </p>
        <p style="font-size: 16px; color: #333; line-height: 1.6; margin: 0 0 15px 0;">
            Your coach has created a new assignment for you:
        </p>
        
        <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-left: 4px solid #0077CC; padding: 20px; margin: 25px 0; border-radius: 8px;">
            <h3 style="margin: 0 0 15px 0; color: #0c4a6e; font-size: 18px;">${title}</h3>
            <p style="margin: 0 0 15px 0; color: #0c4a6e; font-size: 15px; line-height: 1.6;">
                ${description}
            </p>
            <p style="margin: 0; color: #0369a1; font-size: 14px; font-weight: 600;">
                Due: ${dueDate}
            </p>
        </div>
        
        <div style="text-align: center; margin: 30px 0;">
            <a href="app.glrecoveryservices.com" 
               style="display: inline-block; padding: 14px 32px; background: linear-gradient(135deg, #0077CC 0%, #008B8B 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px;">
                View Assignment
            </a>
        </div>
        
        <p style="font-size: 16px; color: #333; line-height: 1.6; margin: 0;">
            Complete this assignment to continue your progress. You've got this!
        </p>
    `;
    return getEmailTemplate(content);
};

const getCheckInReminderTemplate = (pirName, timeOfDay) => {
    const content = `
        <h1 style="color: #0077CC; margin: 0 0 20px 0; font-size: 28px;">Daily Check-In Reminder</h1>
        <p style="font-size: 16px; color: #333; line-height: 1.6; margin: 0 0 15px 0;">
            Hi ${pirName},
        </p>
        <p style="font-size: 16px; color: #333; line-height: 1.6; margin: 0 0 15px 0;">
            This is your ${timeOfDay} reminder to complete your daily check-in.
        </p>
        
        <div style="background: linear-gradient(135deg, #fef9c3 0%, #fef08a 100%); border-left: 4px solid #f59e0b; padding: 20px; margin: 25px 0; border-radius: 8px;">
            <p style="margin: 0 0 10px 0; font-size: 15px; color: #92400e; font-weight: 600;">
                Daily Check-Ins Help You:
            </p>
            <ul style="margin: 0; padding-left: 20px; color: #92400e; font-size: 14px; line-height: 1.8;">
                <li>Track your mood and progress</li>
                <li>Identify triggers and patterns</li>
                <li>Stay accountable to your recovery</li>
                <li>Help your coach support you better</li>
            </ul>
        </div>
        
        <div style="text-align: center; margin: 30px 0;">
            <a href="app.glrecoveryservices.com" 
               style="display: inline-block; padding: 14px 32px; background: linear-gradient(135deg, #0077CC 0%, #008B8B 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px;">
                Complete Check-In Now
            </a>
        </div>
        
        <p style="font-size: 16px; color: #333; line-height: 1.6; margin: 0;">
            Taking just 2 minutes to check in keeps you connected to your recovery journey.
        </p>
    `;
    return getEmailTemplate(content);
};

const getNewResourceTemplate = (pirName, resourceTitle, resourceDescription, resourceCategory) => {
    const content = `
        <h1 style="color: #0077CC; margin: 0 0 20px 0; font-size: 28px;">New Resource Available</h1>
        <p style="font-size: 16px; color: #333; line-height: 1.6; margin: 0 0 15px 0;">
            Hi ${pirName},
        </p>
        <p style="font-size: 16px; color: #333; line-height: 1.6; margin: 0 0 15px 0;">
            A new resource has been added to your library:
        </p>
        
        <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-left: 4px solid #0077CC; padding: 20px; margin: 25px 0; border-radius: 8px;">
            <div style="display: inline-block; background: #0077CC; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; margin-bottom: 12px;">
                ${resourceCategory}
            </div>
            <h3 style="margin: 0 0 15px 0; color: #0c4a6e; font-size: 18px;">${resourceTitle}</h3>
            <p style="margin: 0; color: #0c4a6e; font-size: 15px; line-height: 1.6;">
                ${resourceDescription}
            </p>
        </div>
        
        <div style="text-align: center; margin: 30px 0;">
            <a href="app.glrecoveryservices.com" 
               style="display: inline-block; padding: 14px 32px; background: linear-gradient(135deg, #0077CC 0%, #008B8B 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px;">
                View Resource
            </a>
        </div>
        
        <p style="font-size: 16px; color: #333; line-height: 1.6; margin: 0;">
            We hope this resource supports you on your recovery journey!
        </p>
    `;
    return getEmailTemplate(content);
};

const getSOSAlertTemplate = (pirName, message, timestamp) => {
    const content = `
        <h1 style="color: #DC143C; margin: 0 0 20px 0; font-size: 28px;">URGENT: SOS Alert</h1>
        <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-left: 4px solid #DC143C; padding: 20px; margin: 0 0 25px 0; border-radius: 8px;">
            <p style="margin: 0 0 10px 0; font-size: 16px; color: #991b1b; font-weight: 600;">
                Alert from: ${pirName}
            </p>
            <p style="margin: 0 0 10px 0; font-size: 16px; color: #991b1b;">
                Time: ${timestamp}
            </p>
            <p style="margin: 0; font-size: 15px; color: #991b1b; line-height: 1.6;">
                Message: "${message}"
            </p>
        </div>
        
        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 20px; margin: 0 0 25px 0; border-radius: 8px;">
            <p style="margin: 0 0 10px 0; font-size: 15px; color: #856404; font-weight: 600;">
                Immediate Action Required
            </p>
            <p style="margin: 0; font-size: 14px; color: #856404; line-height: 1.6;">
                Please respond to this PIR as soon as possible. They are reaching out for immediate support.
            </p>
        </div>
        
        <div style="text-align: center; margin: 30px 0;">
            <a href="app.glrecoveryservices.com" 
               style="display: inline-block; padding: 14px 32px; background: linear-gradient(135deg, #DC143C 0%, #B01030 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px;">
                View Alert & Respond
            </a>
        </div>
        
        <p style="font-size: 14px; color: #666; line-height: 1.6; margin: 0;">
            If this is a life-threatening emergency, please contact emergency services (911) immediately.
        </p>
    `;
    return getEmailTemplate(content);
};

console.log('✅ Email system initialized - Root level functions loaded');
        // ==========================================
// REQUEST NOTIFICATION PERMISSION ON LOAD
// ==========================================
(function requestNotificationPermission() {
    if ('Notification' in window && Notification.permission === 'default') {
        console.log('📢 Requesting notification permission...');
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                console.log('✅ Notification permission granted');
                new Notification('GLRS Coach Portal', {
                    body: 'Notifications enabled! You will receive alerts for emergency SOS triggers.',
                    icon: '/favicon.ico'
                });
            } else {
                console.warn('⚠️ Notification permission denied');
            }
        });
    }
})();

// Audit Logs View Component
function AuditLogsView({ user, searchQuery }) {
    const [logs, setLogs] = useState([]);
    const [loading, setLoading] = useState(true);
    const [filters, setFilters] = useState({
        dateRange: '7days'
    });
    const [currentPage, setCurrentPage] = useState(1);
    const itemsPerPage = 50;

    useEffect(() => {
        loadAuditLogs();
    }, [filters]);

    const loadAuditLogs = async () => {
        try {
            setLoading(true);
            let startDate = new Date();
            switch(filters.dateRange) {
                case '24hours': startDate.setHours(startDate.getHours() - 24); break;
                case '7days': startDate.setDate(startDate.getDate() - 7); break;
                case '30days': startDate.setDate(startDate.getDate() - 30); break;
                default: startDate.setDate(startDate.getDate() - 7);
            }

            let query = db.collection('auditLogs');
            if (!isSuperAdmin(user)) {
                query = query.where('tenantId', '==', CURRENT_TENANT);
            }
            query = query.where('timestamp', '>=', startDate).orderBy('timestamp', 'desc').limit(500);

            const snapshot = await query.get();
            const logsData = [];
            snapshot.forEach(doc => logsData.push({ id: doc.id, ...doc.data() }));
            setLogs(logsData);
        } catch (error) {
            console.error('Error loading audit logs:', error);
        } finally {
            setLoading(false);
        }
    };

    const filteredLogs = logs.filter(log => {
        if (searchQuery) {
            const q = searchQuery.toLowerCase();
            return log.userEmail?.toLowerCase().includes(q) || log.userName?.toLowerCase().includes(q) || log.action?.toLowerCase().includes(q);
        }
        return true;
    });

    const totalPages = Math.ceil(filteredLogs.length / itemsPerPage);
    const paginatedLogs = filteredLogs.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

    const formatTimestamp = (ts) => {
        if (!ts) return 'N/A';
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        return d.toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    };

    const getActionColor = (a) => {
        if (a?.includes('CREATE')) return '#00A86B';
        if (a?.includes('UPDATE')) return '#0077CC';
        if (a?.includes('DELETE')) return '#DC143C';
        return '#666';
    };

    return (
        <div style={{ padding: '20px' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '20px' }}>
                <h2>Audit Logs {isSuperAdmin(user) && '(All Tenants)'}</h2>
                <button onClick={loadAuditLogs} style={{ padding: '8px 16px' }}>Refresh</button>
            </div>
            <select value={filters.dateRange} onChange={(e) => setFilters({dateRange: e.target.value})} style={{ padding: '8px', marginBottom: '20px' }}>
                <option value="24hours">Last 24 Hours</option>
                <option value="7days">Last 7 Days</option>
                <option value="30days">Last 30 Days</option>
            </select>
            {loading ? <div style={{ padding: '40px', textAlign: 'center' }}>Loading...</div> : (
                <>
                    <div style={{ background: 'white', borderRadius: '8px', overflow: 'auto' }}>
                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead style={{ background: '#f5f5f5' }}>
                                <tr>
                                    <th style={{ padding: '12px', textAlign: 'left' }}>Time</th>
                                    {isSuperAdmin(user) && <th style={{ padding: '12px', textAlign: 'left' }}>Tenant</th>}
                                    <th style={{ padding: '12px', textAlign: 'left' }}>User</th>
                                    <th style={{ padding: '12px', textAlign: 'left' }}>Action</th>
                                    <th style={{ padding: '12px', textAlign: 'left' }}>Resource</th>
                                </tr>
                            </thead>
                            <tbody>
                                {paginatedLogs.map(log => (
                                    <tr key={log.id} style={{ borderBottom: '1px solid #eee' }}>
                                        <td style={{ padding: '12px', fontSize: '13px' }}>{formatTimestamp(log.timestamp)}</td>
                                        {isSuperAdmin(user) && <td style={{ padding: '12px', fontWeight: '600' }}>{log.tenantId}</td>}
                                        <td style={{ padding: '12px' }}>
                                            <div style={{ fontWeight: '500' }}>{log.userName || log.userEmail}</div>
                                            <div style={{ fontSize: '12px', color: '#666' }}>{log.userRole}</div>
                                        </td>
                                        <td style={{ padding: '12px' }}>
                                            <span style={{ padding: '4px 8px', borderRadius: '4px', background: getActionColor(log.action) + '20', color: getActionColor(log.action), fontSize: '12px', fontWeight: '600' }}>
                                                {log.action}
                                            </span>
                                        </td>
                                        <td style={{ padding: '12px', fontSize: '13px' }}>{log.targetResource || '-'}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    {totalPages > 1 && (
                        <div style={{ display: 'flex', justifyContent: 'center', gap: '10px', marginTop: '20px' }}>
                            <button onClick={() => setCurrentPage(Math.max(1, currentPage - 1))} disabled={currentPage === 1}>Previous</button>
                            <span style={{ padding: '8px' }}>Page {currentPage} of {totalPages}</span>
                            <button onClick={() => setCurrentPage(Math.min(totalPages, currentPage + 1))} disabled={currentPage === totalPages}>Next</button>
                        </div>
                    )}
                </>
            )}
        </div>
    );
}

        // Main App Component
function AdminApp() {
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(true);
    const [currentView, setCurrentView] = useState('dashboard');
    const [searchQuery, setSearchQuery] = useState('');
    const [notifications, setNotifications] = useState([]);
    const [showNotifications, setShowNotifications] = useState(false);
    const [sidebarCollapsed, setSidebarCollapsed] = useState(false); // SIDEBAR STATE
    const isOnline = useConnectionStatus();

    // FIX: Move useDebounce here at component level
    const debouncedSearchQuery = useDebounce(searchQuery, 300);
    
    // Firestore listeners cleanup
    const unsubscribers = useRef([]);

    useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged(async (authUser) => {
            if (authUser) {
                try {
                    const userDoc = await db.collection('users').doc(authUser.uid).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        if (userData.role === 'admin' || userData.role === 'superadmin') {
                            setUser({ uid: authUser.uid, ...userData });
                            setupRealtimeListeners(authUser.uid);
                        } else {
                            auth.signOut();
                            alert('Access denied. Admin access required.');
                        }
                    } else {
                        auth.signOut();
                        alert('User profile not found.');
                    }
                } catch (error) {
                    console.error('Error loading user:', error);
                    auth.signOut();
                }
            } else {
                setUser(null);
                cleanupListeners();
            }
            setLoading(false);
        });

        return () => {
            unsubscribe();
            cleanupListeners();
        };
    }, []);

    // Load tenant branding on mount
    useEffect(() => {
        loadTenantBranding(CURRENT_TENANT);
    }, []);

    const setupRealtimeListeners = (userId) => {
        // Clean up existing listeners
        cleanupListeners();
        
        // Listen to notifications
        try {
            const notifQuery = db.collection('notifications')
                .where('tenantId', '==', CURRENT_TENANT)
                .where('recipientId', '==', userId)
                .orderBy('createdAt', 'desc')
                .limit(50);
            
            const unsubNotif = notifQuery.onSnapshot(
                snapshot => {
                    const notifs = [];
                    snapshot.forEach(doc => {
                        notifs.push({ id: doc.id, ...doc.data() });
                    });
                    setNotifications(notifs);
                },
                error => {
                    console.error('Error loading notifications:', error);
                }
            );
            
            unsubscribers.current.push(unsubNotif);
        } catch (error) {
            console.error('Error setting up listeners:', error);
        }
    };

    const cleanupListeners = () => {
        unsubscribers.current.forEach(unsub => {
            try {
                unsub();
            } catch (error) {
                console.error('Error cleaning up listener:', error);
            }
        });
        unsubscribers.current = [];
    };

    const handleLogout = async () => {
        try {
            cleanupListeners();
            await auth.signOut();
            setUser(null);
            setCurrentView('dashboard');
        } catch (error) {
            console.error('Logout error:', error);
            alert('Error logging out. Please try again.');
        }
    };

    const handleImpersonate = (targetUser) => {
        // Open PIR view in new tab/window
        const pirViewUrl = `pir-view.html?userId=${targetUser.id}`;
        window.open(pirViewUrl, '_blank');
    };

    if (loading) {
        return (
            <div className="loading-container">
                <div className="loading-spinner"></div>
                <p style={{marginTop: '20px'}}>Loading Admin Portal...</p>
            </div>
        );
    }

    if (!user) {
        return <LoginScreen />;
    }

   return (
    <>
        <div className={`connection-status ${isOnline ? 'online' : 'offline'}`}>
            {!isOnline && '⚠️ Offline - Some features may be limited'}
        </div>
        
        <div style={{ display: 'flex', flexDirection: 'column', minHeight: '100vh' }}>
            {/* Header FIRST */}
            <Header
                currentView={currentView}
                searchQuery={searchQuery}
                setSearchQuery={setSearchQuery}
                notifications={notifications}
                showNotifications={showNotifications}
                setShowNotifications={setShowNotifications}
                onLogout={handleLogout}
                user={user}
                sidebarCollapsed={sidebarCollapsed}
            />
            
            {/* Sidebar Navigation */}
            <Sidebar
                currentView={currentView}
                setCurrentView={setCurrentView}
                user={user}
                collapsed={sidebarCollapsed}
                setCollapsed={setSidebarCollapsed}
            />
            
          <div className="content" style={{
                marginLeft: sidebarCollapsed ? '80px' : '280px',
                minHeight: '100vh',
                background: '#c4c9cf',
                padding: '20px',
                transition: 'margin-left 0.3s'
            }}>
                {renderView(currentView, debouncedSearchQuery, user, handleImpersonate)}
            </div>
        </div>
    </>
);
}

// View Renderer - NO HOOKS HERE
function renderView(view, searchQuery, user, onImpersonate) {
    // REMOVED: const debouncedSearchQuery = useDebounce(searchQuery, 300);
    // Now searchQuery is already debounced when passed in
    
    switch(view) {
        case 'dashboard':
            return <DashboardView user={user} />;
        case 'users':
            return <UsersView searchQuery={searchQuery} user={user} onImpersonate={onImpersonate} />;
        case 'mypirs':
    return <MyPIRsView searchQuery={searchQuery} user={user} />;
        case 'feedback':
            return <FeedbackView searchQuery={searchQuery} user={user} />;
        case 'resources':
            return <ResourcesView user={user} searchQuery={searchQuery} />;
            case 'community':
    return <CommunityView searchQuery={searchQuery} user={user} />;
        case 'checkins':
            return <CheckInsView searchQuery={searchQuery} />;
            case 'goals':
    return <GoalsView searchQuery={searchQuery} user={user} />;
        case 'alerts':
            return <AlertsView searchQuery={searchQuery} user={user} />;
        case 'reports':
            return <ReportsView user={user} />;
        case 'settings':
            return <SettingsView user={user} />;
        case 'auditlogs':
            return <AuditLogsView user={user} searchQuery={searchQuery} />;
        default:
            return <div className="empty-state">View not found</div>;
    }
}

// Modern Sidebar Navigation Component
function Sidebar({ currentView, setCurrentView, user, collapsed, setCollapsed }) {
    const [showTenantModal, setShowTenantModal] = useState(false);
    const [showCreateUserModal, setShowCreateUserModal] = useState(false);
    const [createUserRole, setCreateUserRole] = useState('pir');
    const [tenants, setTenants] = useState([]);
    const [currentTenant, setCurrentTenant] = useState(CURRENT_TENANT);
    const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
    const [isMobile, setIsMobile] = useState(window.innerWidth < 768);

    useEffect(() => {
        const handleResize = () => {
            setIsMobile(window.innerWidth < 768);
            if (window.innerWidth >= 768) {
                setMobileMenuOpen(false);
            }
        };
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
    }, []);

    useEffect(() => {
        if (user && isSuperAdmin(user)) {
            const loadTenants = async () => {
                try {
                    const tenantsSnap = await db.collection('tenants').get();
                    const tenantsData = tenantsSnap.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setTenants(tenantsData);
                } catch (error) {
                    console.error('Error loading tenants:', error);
                }
            };
            loadTenants();
        }
    }, [user]);

    const menuItems = [
        { id: 'dashboard', label: 'Dashboard', icon: '📊' },
        { id: 'users', label: 'Users', icon: '👥' },
        { id: 'mypirs', label: 'My PIRs', icon: '🎯' },
        { id: 'feedback', label: 'Feedback', icon: '📝' },
        { id: 'resources', label: 'Resources', icon: '📚' },
        { id: 'goals', label: 'Goals', icon: '🏆' },
        { id: 'community', label: 'Community', icon: '💬' },
        { id: 'checkins', label: 'Check-ins', icon: '✅' },
        { id: 'alerts', label: 'Alerts', icon: '🚨' },
        { id: 'reports', label: 'Reports', icon: '📈' },
        { id: 'settings', label: 'Settings', icon: '⚙️' }
    ];

    return (
        <>
            {/* Mobile Menu Toggle */}
            {isMobile && (
                <button
                    onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
                    style={{
                        position: 'fixed',
                        top: '15px',
                        left: '15px',
                        zIndex: 1001,
                        background: 'linear-gradient(135deg, #0077CC 0%, #005A9C 100%)',
                        border: 'none',
                        color: 'white',
                        padding: '12px 16px',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontSize: '20px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.2)'
                    }}
                >
                    ☰
                </button>
            )}

            {/* Sidebar */}
            <div style={{
                width: isMobile ? '280px' : (collapsed ? '80px' : '280px'),
                background: 'linear-gradient(180deg, #0077CC 0%, #005A9C 100%)',
                height: '100vh',
                position: 'fixed',
                left: isMobile ? (mobileMenuOpen ? 0 : '-280px') : 0,
                top: 0,
                display: 'flex',
                flexDirection: 'column',
                boxShadow: '4px 0 12px rgba(0,0,0,0.15)',
                transition: 'left 0.3s, width 0.3s',
                zIndex: 1000,
                overflowY: 'auto',
                overflowX: 'hidden'
            }}>
                {/* Header */}
                <div style={{
                    padding: '20px',
                    borderBottom: '1px solid rgba(255,255,255,0.2)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between'
                }}>
                    {!collapsed && (
                        <div style={{ color: 'white', fontSize: '20px', fontWeight: 'bold' }}>
                            🛡️ GLRS Admin
                        </div>
                    )}
                    <button
                        onClick={() => setCollapsed(!collapsed)}
                        style={{
                            background: 'rgba(255,255,255,0.2)',
                            border: 'none',
                            color: 'white',
                            padding: '8px 12px',
                            borderRadius: '6px',
                            cursor: 'pointer',
                            fontSize: '16px'
                        }}
                    >
                        {collapsed ? '→' : '←'}
                    </button>
                </div>

                {/* User Profile */}
                {user && (
                    <div style={{
                        padding: '20px',
                        borderBottom: '1px solid rgba(255,255,255,0.2)',
                        display: collapsed ? 'none' : 'block'
                    }}>
                        <div style={{
                            background: 'rgba(255,255,255,0.1)',
                            borderRadius: '12px',
                            padding: '15px',
                            color: 'white'
                        }}>
                            <div style={{ fontSize: '16px', fontWeight: '600', marginBottom: '8px' }}>
                                {user.displayName || `${user.firstName} ${user.lastName}`}
                            </div>
                            <div style={{ fontSize: '13px', opacity: 0.9, marginBottom: '8px' }}>
                                {user.email}
                            </div>
                            <div style={{
                                display: 'inline-block',
                                background: 'rgba(255,255,255,0.3)',
                                padding: '4px 12px',
                                borderRadius: '20px',
                                fontSize: '12px',
                                fontWeight: '600'
                            }}>
                                {user.role?.toUpperCase()}
                            </div>
                        </div>
                    </div>
                )}

                {/* Navigation Menu */}
                <div style={{ flex: 1, padding: '10px', overflowY: 'auto' }}>
                    {menuItems.map(item => (
                        <div
                            key={item.id}
                            onClick={() => setCurrentView(item.id)}
                            style={{
                                padding: collapsed ? '16px 0' : '16px 20px',
                                margin: '4px 0',
                                borderRadius: '10px',
                                cursor: 'pointer',
                                background: currentView === item.id
                                    ? 'rgba(255,255,255,0.25)'
                                    : 'transparent',
                                color: 'white',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '12px',
                                transition: 'all 0.2s',
                                fontWeight: currentView === item.id ? '600' : 'normal',
                                justifyContent: collapsed ? 'center' : 'flex-start'
                            }}
                            onMouseEnter={(e) => {
                                if (currentView !== item.id) {
                                    e.currentTarget.style.background = 'rgba(255,255,255,0.15)';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (currentView !== item.id) {
                                    e.currentTarget.style.background = 'transparent';
                                }
                            }}
                        >
                            <span style={{ fontSize: '20px' }}>{item.icon}</span>
                            {!collapsed && <span style={{ fontSize: '15px' }}>{item.label}</span>}
                        </div>
                    ))}
                </div>

                {/* Tenant Switcher (SuperAdmin Only) */}
                {user && isSuperAdmin(user) && !collapsed && (
                    <div style={{
                        padding: '15px',
                        borderTop: '1px solid rgba(255,255,255,0.2)',
                        background: 'rgba(0,0,0,0.2)'
                    }}>
                        <div style={{ color: 'white', fontSize: '12px', marginBottom: '8px', opacity: 0.8 }}>
                            Current Tenant
                        </div>
                        <select
                            value={currentTenant}
                            onChange={(e) => {
                                setCurrentTenant(e.target.value);
                                alert(`Switching to tenant: ${e.target.value}\n\nPage will reload.`);
                                window.location.reload();
                            }}
                            style={{
                                width: '100%',
                                padding: '8px',
                                background: 'rgba(255,255,255,0.2)',
                                border: '1px solid rgba(255,255,255,0.3)',
                                borderRadius: '6px',
                                color: 'white',
                                fontSize: '14px',
                                cursor: 'pointer',
                                marginBottom: '8px'
                            }}
                        >
                            {tenants.map(tenant => (
                                <option key={tenant.id} value={tenant.id} style={{ color: 'black' }}>
                                    {tenant.config?.companyName || tenant.id}
                                </option>
                            ))}
                        </select>
                        <button
                            onClick={() => setShowTenantModal(true)}
                            style={{
                                width: '100%',
                                padding: '8px',
                                background: 'rgba(255,255,255,0.3)',
                                border: 'none',
                                borderRadius: '6px',
                                color: 'white',
                                fontSize: '13px',
                                cursor: 'pointer',
                                fontWeight: '600'
                            }}
                        >
                            + New Tenant
                        </button>
                    </div>
                )}

                {/* Logout Button */}
                <div style={{
                    padding: '15px',
                    borderTop: '1px solid rgba(255,255,255,0.2)'
                }}>
                    <button
                        onClick={() => {
                            auth.signOut();
                            window.location.reload();
                        }}
                        style={{
                            width: '100%',
                            padding: collapsed ? '12px 0' : '12px',
                            background: 'rgba(220,20,60,0.8)',
                            border: 'none',
                            borderRadius: '8px',
                            color: 'white',
                            fontSize: '14px',
                            cursor: 'pointer',
                            fontWeight: '600',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            gap: '8px'
                        }}
                    >
                        <span>🚪</span>
                        {!collapsed && <span>Logout</span>}
                    </button>
                </div>
            </div>

            {/* Modals */}
            {showTenantModal && <TenantManagementModal onClose={() => setShowTenantModal(false)} user={user} />}
            {showCreateUserModal && (
                <CreateUserModal
                    role={createUserRole}
                    onClose={() => setShowCreateUserModal(false)}
                    onUserCreated={() => {
                        setShowCreateUserModal(false);
                        window.location.reload();
                    }}
                />
            )}
        </>
    );
}

function Header({ currentView, searchQuery, setSearchQuery, notifications, showNotifications, setShowNotifications, onLogout, user, sidebarCollapsed }) {
    const [refreshing, setRefreshing] = useState(false);
    const notificationRef = useRef(null);

    const unreadCount = notifications.filter(n => !n.read).length;

    const handleRefresh = () => {
        setRefreshing(true);
        setTimeout(() => {
            window.location.reload();
        }, 500);
    };

    const clearNotification = async (notifId) => {
        try {
            await db.collection('notifications').doc(notifId).update({ read: true });
        } catch (error) {
            console.error('Error clearing notification:', error);
        }
    };

    const clearAllNotifications = async () => {
        try {
            const batch = db.batch();
            notifications.forEach(notif => {
                if (!notif.read) {
                    batch.update(db.collection('notifications').doc(notif.id), { read: true });
                }
            });
            await batch.commit();
        } catch (error) {
            console.error('Error clearing all notifications:', error);
        }
    };

    const handleNotificationClick = (notif) => {
        clearNotification(notif.id);
        setShowNotifications(false);
    };

    useEffect(() => {
        const handleClickOutside = (event) => {
            if (notificationRef.current && !notificationRef.current.contains(event.target)) {
                setShowNotifications(false);
            }
        };
        
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, []);

    return (
        <div style={{
            background: 'white',
            padding: '15px 30px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            position: 'sticky',
            top: 0,
            zIndex: 99,
            marginLeft: sidebarCollapsed ? '80px' : '280px',
            transition: 'margin-left 0.3s'
        }}>
            <div style={{
                fontSize: '18px',
                fontWeight: '600',
                color: '#333'
            }}>
                {user.displayName || user.email}
            </div>
            
            <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                <input
                    type="text"
                    placeholder="Search users, messages, resources..."
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    style={{
                        padding: '10px 20px',
                        borderRadius: '25px',
                        border: '2px solid #e0e0e0',
                        width: '350px',
                        fontSize: '14px',
                        transition: 'all 0.3s'
                    }}
                    onFocus={(e) => e.currentTarget.style.borderColor = '#0077CC'}
                    onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                />
                
                <button 
                    onClick={handleRefresh}
                    disabled={refreshing}
                    style={{
                        padding: '10px 20px',
                        background: refreshing ? '#e0e0e0' : 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: refreshing ? 'not-allowed' : 'pointer',
                        fontSize: '14px',
                        fontWeight: '500',
                        transition: 'all 0.2s',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px'
                    }}
                    onMouseEnter={(e) => {
                        if (!refreshing) {
                            e.currentTarget.style.transform = 'translateY(-2px)';
                            e.currentTarget.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.4)';
                        }
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = 'none';
                    }}
                >
                    {refreshing ? '⟳' : '↻'} Refresh
                </button>
                
                <div style={{ position: 'relative' }} ref={notificationRef}>
                    <button
                        onClick={() => setShowNotifications(!showNotifications)}
                        style={{
                            background: 'transparent',
                            border: 'none',
                            cursor: 'pointer',
                            fontSize: '24px',
                            position: 'relative',
                            padding: '8px'
                        }}
                    >
                        🔔
                        {unreadCount > 0 && (
                            <div style={{
                                position: 'absolute',
                                top: '4px',
                                right: '4px',
                                background: '#DC143C',
                                color: 'white',
                                borderRadius: '50%',
                                width: '20px',
                                height: '20px',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '10px',
                                fontWeight: 'bold'
                            }}>
                                {unreadCount > 99 ? '99+' : unreadCount}
                            </div>
                        )}
                    </button>
                    
                    {showNotifications && (
                        <div style={{
                            position: 'absolute',
                            top: '100%',
                            right: 0,
                            marginTop: '10px',
                            background: 'white',
                            borderRadius: '10px',
                            boxShadow: '0 4px 20px rgba(0,0,0,0.15)',
                            width: '350px',
                            maxHeight: '400px',
                            overflowY: 'auto',
                            zIndex: 1000
                        }}>
                            <div style={{
                                padding: '15px',
                                borderBottom: '1px solid #f0f0f0',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                position: 'sticky',
                                top: 0,
                                background: 'white'
                            }}>
                                <span style={{ fontWeight: '600', color: '#333' }}>
                                    Notifications ({unreadCount})
                                </span>
                                <button 
                                    onClick={clearAllNotifications}
                                    style={{
                                        padding: '5px 10px',
                                        fontSize: '12px',
                                        background: '#f0f0f0',
                                        border: 'none',
                                        borderRadius: '5px',
                                        cursor: 'pointer'
                                    }}
                                >
                                    Clear All
                                </button>
                            </div>
                            
                            {notifications.length === 0 ? (
                                <div style={{ padding: '30px', textAlign: 'center', color: '#999' }}>
                                    No notifications
                                </div>
                            ) : (
                                notifications.slice(0, 20).map(notif => (
                                    <div 
                                        key={notif.id}
                                        onClick={() => handleNotificationClick(notif)}
                                        style={{
                                            padding: '15px',
                                            borderBottom: '1px solid #f0f0f0',
                                            cursor: 'pointer',
                                            background: notif.read ? 'white' : '#f0f4ff',
                                            transition: 'background 0.2s'
                                        }}
                                        onMouseEnter={(e) => e.currentTarget.style.background = '#f8f9fa'}
                                        onMouseLeave={(e) => e.currentTarget.style.background = notif.read ? 'white' : '#f0f4ff'}
                                    >
                                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '5px' }}>
                                            <span style={{ fontSize: '14px', color: '#333' }}>{notif.message}</span>
                                            {notif.urgent && (
                                                <span style={{
                                                    background: '#DC143C',
                                                    color: 'white',
                                                    padding: '2px 6px',
                                                    borderRadius: '10px',
                                                    fontSize: '10px'
                                                }}>
                                                    Urgent
                                                </span>
                                            )}
                                        </div>
                                        <div style={{ fontSize: '11px', color: '#999' }}>
                                            {formatTimeAgo(notif.createdAt)}
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    )}
                </div>
                
                <button 
                    onClick={onLogout}
                    style={{
                        padding: '10px 20px',
                        background: '#6c757d',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontSize: '14px',
                        fontWeight: '500',
                        transition: 'all 0.2s'
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.background = '#5a6268';
                        e.currentTarget.style.transform = 'translateY(-2px)';
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.background = '#6c757d';
                        e.currentTarget.style.transform = 'translateY(0)';
                    }}
                >
                    Logout
                </button>
            </div>
        </div>
    );
}

        // Login Screen
        function LoginScreen() {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    setError(error.message);
                    setLoading(false);
                }
            };

            return (
                <div className="login-container">
                    <div className="login-card">
                        <div className="login-header">
                            <div className="login-title">GLRS Admin Portal</div>
                            <p style={{color: 'rgba(255,255,255,0.7)'}}>Administrator Access Only</p>
                        </div>
                        
                        {error && <div className="error-message">{error}</div>}
                        
                        <form onSubmit={handleLogin}>
                            <div className="form-group">
                                <label className="form-label">Email</label>
                                <input
                                    type="email"
                                    className="form-input"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    required
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Password</label>
                                <input
                                    type="password"
                                    className="form-input"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    required
                                />
                            </div>
                            
                            <button 
                                type="submit"
                                className="btn btn-primary"
                                style={{width: '100%'}}
                                disabled={loading}
                            >
                                {loading ? 'Logging in...' : 'Login'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

       
      // Enhanced Dashboard View with Charts, Stats, and Active PIRs
function DashboardView({ user }) {
    const [stats, setStats] = useState({
        totalPirs: 0,
        totalCoaches: 0,
        alertsToday: 0,
        avgCompliance: 0
    });
    const [chartData, setChartData] = useState({
        mood: { labels: [], data: [], average: 0 },
        craving: { labels: [], data: [], average: 0 },
        anxiety: { labels: [], data: [], average: 0 },
        sleep: { labels: [], data: [], average: 0 }
    });
    const [sobrietyData, setSobrietyData] = useState({ labels: [], data: [], average: 0 });
    const [recentActivity, setRecentActivity] = useState([]);
    const [activePIRs, setActivePIRs] = useState([]);
    const [loading, setLoading] = useState(true);
    const [selectedPIR, setSelectedPIR] = useState(null);

    // Chart refs
    const moodChartRef = useRef(null);
    const cravingChartRef = useRef(null);
    const anxietyChartRef = useRef(null);
    const sleepChartRef = useRef(null);
    const sobrietyChartRef = useRef(null);

    // Chart instances
    const chartInstances = useRef({});

    useEffect(() => {
        loadDashboardData();

        return () => {
            // Cleanup all charts
            Object.values(chartInstances.current).forEach(chart => {
                if (chart) chart.destroy();
            });
        };
    }, []);

    useEffect(() => {
        if (!loading) {
            renderAllCharts();
        }
    }, [chartData, sobrietyData, loading]);

    const loadDashboardData = async () => {
        try {
            console.log('🔄 Loading dashboard data for tenant:', CURRENT_TENANT);

            // Load basic stats
            const usersSnap = await db.collection('users').where('tenantId', '==', CURRENT_TENANT).get();
            console.log('✓ Loaded users:', usersSnap.size);

            let totalPirs = 0;
            let totalCoaches = 0;
            const pirIds = [];
            const pirsData = [];

            usersSnap.forEach(doc => {
                const data = doc.data();
                if (data.role === 'pir') {
                    totalPirs++;
                    pirIds.push(doc.id);
                    pirsData.push({ id: doc.id, ...data });
                }
                if (data.role === 'coach') totalCoaches++;
            });

            console.log(`✓ Found ${totalPirs} PIRs and ${totalCoaches} coaches`);

            // Process PIRs for Active PIRs section
            const processedPIRs = await Promise.all(pirsData.map(async (pir) => {
                // Calculate days sober
                let daysSober = 0;
                if (pir.sobrietyDate) {
                    const sobrietyDate = typeof pir.sobrietyDate === 'string' 
                        ? new Date(pir.sobrietyDate)
                        : pir.sobrietyDate.toDate ? pir.sobrietyDate.toDate() : new Date(pir.sobrietyDate);
                    const today = new Date();
                    daysSober = Math.floor((today - sobrietyDate) / (1000 * 60 * 60 * 24));
                }

                // Get coach name
                let coachName = 'Unassigned';
                if (pir.assignedCoach) {
                    try {
                        const coachDoc = await db.collection('users').doc(pir.assignedCoach).get();
                        if (coachDoc.exists) {
                            const coachData = coachDoc.data();
                            coachName = coachData.displayName || coachData.firstName || 'Coach';
                        }
                    } catch (error) {
                        console.error('Error fetching coach:', error);
                    }
                }

                return {
                    ...pir,
                    daysSober,
                    coachName
                };
            }));

            // Sort by first name
            processedPIRs.sort((a, b) => {
                const nameA = (a.firstName || a.displayName || '').toLowerCase();
                const nameB = (b.firstName || b.displayName || '').toLowerCase();
                return nameA.localeCompare(nameB);
            });

            setActivePIRs(processedPIRs);
            console.log('✓ Processed PIRs for Active PIRs widget:', processedPIRs.length);

            // Get today's alerts
            console.log('📊 Loading alerts...');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const alertsSnap = await db.collection('alerts')
                .where('tenantId', '==', CURRENT_TENANT)
                .where('createdAt', '>=', today)
                .get();

            console.log('✓ Loaded alerts:', alertsSnap.size);

            // SET BASIC STATS EARLY - before chart data loading
            // This ensures stats display even if chart queries fail
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const recentCheckIns = await db.collection('checkIns')
                .where('tenantId', '==', CURRENT_TENANT)
                .where('createdAt', '>=', sevenDaysAgo)
                .get();

            const avgCompliance = totalPirs > 0
                ? Math.round((recentCheckIns.size / (totalPirs * 14)) * 100)
                : 0;

            // Set stats immediately so they display
            setStats({
                totalPirs,
                totalCoaches,
                alertsToday: alertsSnap.size,
                avgCompliance: Math.min(avgCompliance, 100)
            });

            console.log('✅ Stats set:', { totalPirs, totalCoaches, alertsToday: alertsSnap.size, avgCompliance });

            // Continue loading chart data (wrapped in try-catch so failures don't break stats)

            // Calculate 30-day trends for all PIRs
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            const checkInsSnap = await db.collection('checkIns')
                .where('tenantId', '==', CURRENT_TENANT)
                .where('createdAt', '>=', thirtyDaysAgo)
                .get();

            // Process check-ins data
            const last30Days = [];
            const moodData = [];
            const cravingData = [];
            const anxietyData = [];
            const sleepData = [];

            // All-time data for averages
            const allCheckInsSnap = await db.collection('checkIns').where('tenantId', '==', CURRENT_TENANT).get();
            let allTimeMood = [];
            let allTimeCraving = [];
            let allTimeAnxiety = [];
            let allTimeSleep = [];

            allCheckInsSnap.forEach(doc => {
                const data = doc.data();
                if (data.morningData) {
                    if (data.morningData.mood) allTimeMood.push(data.morningData.mood);
                    if (data.morningData.craving) allTimeCraving.push(data.morningData.craving);
                    if (data.morningData.anxietyLevel) allTimeAnxiety.push(data.morningData.anxietyLevel);
                    if (data.morningData.sleepQuality) allTimeSleep.push(data.morningData.sleepQuality);
                }
                if (data.eveningData) {
                    if (data.eveningData.mood) allTimeMood.push(data.eveningData.mood);
                    if (data.eveningData.craving) allTimeCraving.push(data.eveningData.craving);
                }
            });

            // Calculate all-time averages
            const avgMood = allTimeMood.length > 0 
                ? (allTimeMood.reduce((a, b) => a + b, 0) / allTimeMood.length).toFixed(1)
                : 0;
            const avgCraving = allTimeCraving.length > 0 
                ? (allTimeCraving.reduce((a, b) => a + b, 0) / allTimeCraving.length).toFixed(1)
                : 0;
            const avgAnxiety = allTimeAnxiety.length > 0 
                ? (allTimeAnxiety.reduce((a, b) => a + b, 0) / allTimeAnxiety.length).toFixed(1)
                : 0;
            const avgSleep = allTimeSleep.length > 0 
                ? (allTimeSleep.reduce((a, b) => a + b, 0) / allTimeSleep.length).toFixed(1)
                : 0;

            // Build 30-day data
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                last30Days.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));

                const dayCheckIns = [];
                checkInsSnap.forEach(doc => {
                    const checkInDate = doc.data().createdAt?.toDate 
                        ? doc.data().createdAt.toDate() 
                        : new Date(doc.data().createdAt);
                    if (checkInDate.toDateString() === date.toDateString()) {
                        dayCheckIns.push(doc.data());
                    }
                });

                // Calculate averages for the day
                const dayMoods = [];
                const dayCravings = [];
                const dayAnxiety = [];
                const daySleep = [];

                dayCheckIns.forEach(checkIn => {
                    if (checkIn.morningData) {
                        if (checkIn.morningData.mood) dayMoods.push(checkIn.morningData.mood);
                        if (checkIn.morningData.craving) dayCravings.push(checkIn.morningData.craving);
                        if (checkIn.morningData.anxietyLevel) dayAnxiety.push(checkIn.morningData.anxietyLevel);
                        if (checkIn.morningData.sleepQuality) daySleep.push(checkIn.morningData.sleepQuality);
                    }
                    if (checkIn.eveningData) {
                        if (checkIn.eveningData.mood) dayMoods.push(checkIn.eveningData.mood);
                        if (checkIn.eveningData.craving) dayCravings.push(checkIn.eveningData.craving);
                    }
                });

                moodData.push(dayMoods.length > 0 ? dayMoods.reduce((a, b) => a + b) / dayMoods.length : null);
                cravingData.push(dayCravings.length > 0 ? dayCravings.reduce((a, b) => a + b) / dayCravings.length : null);
                anxietyData.push(dayAnxiety.length > 0 ? dayAnxiety.reduce((a, b) => a + b) / dayAnxiety.length : null);
                sleepData.push(daySleep.length > 0 ? daySleep.reduce((a, b) => a + b) / daySleep.length : null);
            }

            setChartData({
                mood: { labels: last30Days, data: moodData, average: avgMood },
                craving: { labels: last30Days, data: cravingData, average: avgCraving },
                anxiety: { labels: last30Days, data: anxietyData, average: avgAnxiety },
                sleep: { labels: last30Days, data: sleepData, average: avgSleep }
            });

            // Load sobriety data
            const sobrietyLabels = [];
            const sobrietyDays = [];
            let totalSobrietyDays = 0;

            for (const pirId of pirIds.slice(0, 20)) {
                const pirDoc = await db.collection('users').doc(pirId).get();
                if (pirDoc.exists) {
                    const pirData = pirDoc.data();
                    if (pirData.sobrietyDate) {
                        const sobrietyDate = pirData.sobrietyDate.toDate 
                            ? pirData.sobrietyDate.toDate() 
                            : new Date(pirData.sobrietyDate);
                        const today = new Date();
                        const days = Math.floor((today - sobrietyDate) / (1000 * 60 * 60 * 24));
                        
                        sobrietyLabels.push(pirData.displayName || pirData.email?.split('@')[0] || 'PIR');
                        sobrietyDays.push(days);
                        totalSobrietyDays += days;
                    }
                }
            }

            const avgSobriety = sobrietyDays.length > 0 
                ? Math.round(totalSobrietyDays / sobrietyDays.length)
                : 0;

            setSobrietyData({
                labels: sobrietyLabels,
                data: sobrietyDays,
                average: avgSobriety
            });

            // Stats already set earlier (lines 3308-3315)
            // Load recent activity
            const activityData = [];
            
            const recentCheckInsSnap = await db.collection('checkIns')
                .where('tenantId', '==', CURRENT_TENANT)
                .orderBy('createdAt', 'desc')
                .limit(5)
                .get();
            
            recentCheckInsSnap.forEach(doc => {
                const data = doc.data();
                activityData.push({
                    type: 'check-in',
                    message: `${data.userName || 'PIR'} completed check-in`,
                    time: data.createdAt
                });
            });

            const recentAlertsSnap = await db.collection('alerts')
                .where('tenantId', '==', CURRENT_TENANT)
                .orderBy('createdAt', 'desc')
                .limit(3)
                .get();
            
            recentAlertsSnap.forEach(doc => {
                const data = doc.data();
                activityData.push({
                    type: 'alert',
                    message: `Alert: ${data.message || 'New alert triggered'}`,
                    time: data.createdAt
                });
            });

            activityData.sort((a, b) => {
                const timeA = a.time?.toDate ? a.time.toDate() : new Date(a.time);
                const timeB = b.time?.toDate ? b.time.toDate() : new Date(b.time);
                return timeB - timeA;
            });

            setRecentActivity(activityData.slice(0, 10));

        } catch (error) {
            console.error('Error loading dashboard data:', error);
        } finally {
            setLoading(false);
        }
    };

    const renderAllCharts = () => {
        Object.values(chartInstances.current).forEach(chart => {
            if (chart) chart.destroy();
        });

        const chartConfig = {
            type: 'line',
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 10,
                        ticks: { stepSize: 1 }
                    }
                },
                plugins: {
                    legend: { display: true }
                }
            }
        };

        if (moodChartRef.current) {
            chartInstances.current.mood = new Chart(moodChartRef.current, {
                ...chartConfig,
                data: {
                    labels: chartData.mood.labels,
                    datasets: [{
                        label: 'Mood',
                        data: chartData.mood.data,
                        borderColor: 'var(--success-color)',
                        backgroundColor: 'var(--bg-success-light)',
                        tension: 0.4,
                        spanGaps: true
                    }]
                }
            });
        }

        if (cravingChartRef.current) {
            chartInstances.current.craving = new Chart(cravingChartRef.current, {
                ...chartConfig,
                data: {
                    labels: chartData.craving.labels,
                    datasets: [{
                        label: 'Craving',
                        data: chartData.craving.data,
                        borderColor: 'var(--warning-color)',
                        backgroundColor: 'var(--bg-warning-light)',
                        tension: 0.4,
                        spanGaps: true
                    }]
                }
            });
        }

        if (anxietyChartRef.current) {
            chartInstances.current.anxiety = new Chart(anxietyChartRef.current, {
                ...chartConfig,
                data: {
                    labels: chartData.anxiety.labels,
                    datasets: [{
                        label: 'Anxiety',
                        data: chartData.anxiety.data,
                        borderColor: 'var(--danger-color)',
                        backgroundColor: 'var(--bg-danger-light)',
                        tension: 0.4,
                        spanGaps: true
                    }]
                }
            });
        }

        if (sleepChartRef.current) {
            chartInstances.current.sleep = new Chart(sleepChartRef.current, {
                ...chartConfig,
                data: {
                    labels: chartData.sleep.labels,
                    datasets: [{
                        label: 'Sleep Quality',
                        data: chartData.sleep.data,
                        borderColor: 'var(--primary-color)',
                        backgroundColor: 'var(--bg-primary-light)',
                        tension: 0.4,
                        spanGaps: true
                    }]
                }
            });
        }

        if (sobrietyChartRef.current) {
            chartInstances.current.sobriety = new Chart(sobrietyChartRef.current, {
                type: 'bar',
                data: {
                    labels: sobrietyData.labels,
                    datasets: [{
                        label: 'Sobriety Days',
                        data: sobrietyData.data,
                        backgroundColor: 'var(--primary-color)',
                        borderColor: 'var(--primary-color)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 30 }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    },
                    plugins: {
                        legend: { display: true }
                    }
                }
            });
        }
    };

    // Helper function to get initials
    const getInitials = (pir) => {
        const firstName = pir.firstName || '';
        const lastName = pir.lastName || '';
        return `${firstName.charAt(0)}${lastName.charAt(0)}`.toUpperCase() || '?';
    };

    // Helper function to get color for initials
    const getInitialsColor = (name) => {
        const colors = [
            'var(--primary-color)',
            'var(--success-color)',
            'var(--info-color)',
            'var(--warning-color)'
        ];
        const index = (name || '').charCodeAt(0) % colors.length;
        return colors[index];
    };

    if (loading) {
        return (
            <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                minHeight: '400px',
                gap: '20px'
            }}>
                <div style={{
                    width: '60px',
                    height: '60px',
                    border: '4px solid #f3f3f3',
                    borderTop: '4px solid var(--primary-color)',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite'
                }}></div>
                <p style={{ color: '#666' }}>Loading dashboard...</p>
            </div>
        );
    }

    return (
        <div style={{ padding: '30px', animation: 'fadeIn 0.5s' }}>
            {/* Stats Cards */}
            <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))',
                gap: '20px',
                marginBottom: '40px'
            }}>
                <div style={{
                    background: 'var(--gradient-primary)',
                    borderRadius: 'var(--radius-lg)',
                    padding: '25px',
                    color: 'var(--text-white)',
                    boxShadow: 'var(--shadow-primary)',
                    transition: 'var(--transition-fast)'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Total PIRs</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.totalPirs}
                    </div>
                </div>

                <div style={{
                    background: 'var(--gradient-primary)',
                    borderRadius: 'var(--radius-lg)',
                    padding: '25px',
                    color: 'var(--text-white)',
                    boxShadow: 'var(--shadow-md)',
                    transition: 'var(--transition-fast)'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Total Coaches</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.totalCoaches}
                    </div>
                </div>

                <div style={{
                    background: 'var(--gradient-primary)',
                    borderRadius: 'var(--radius-lg)',
                    padding: '25px',
                    color: 'var(--text-white)',
                    boxShadow: 'var(--shadow-md)',
                    transition: 'var(--transition-fast)'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Alerts Today</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.alertsToday}
                    </div>
                </div>

                <div style={{
                    background: 'var(--gradient-primary)',
                    borderRadius: 'var(--radius-lg)',
                    padding: '25px',
                    color: 'var(--text-white)',
                    boxShadow: 'var(--shadow-md)',
                    transition: 'var(--transition-fast)'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Avg Compliance</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.avgCompliance}%
                    </div>
                </div>
            </div>

            {/* Active PIRs Section */}
            <div style={{ marginBottom: '40px' }}>
                <h2 style={{ 
                    marginBottom: '20px',
                    fontSize: '24px',
                    color: 'var(--text-white)'
                }}>
                    Active PIRs ({activePIRs.length})
                </h2>
                <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))',
                    gap: '20px'
                }}>
                    {activePIRs.map(pir => (
                        <div
                            key={pir.id}
                            onClick={() => setSelectedPIR(pir)}
                            style={{
                                background: 'var(--text-white)',
                                borderRadius: 'var(--radius-lg)',
                                padding: '20px',
                                boxShadow: 'var(--shadow-sm)',
                                cursor: 'pointer',
                                transition: 'var(--transition-fast)',
                                display: 'flex',
                                gap: '15px',
                                alignItems: 'center'
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.transform = 'translateY(-3px)';
                                e.currentTarget.style.boxShadow = 'var(--shadow-md)';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.transform = 'translateY(0)';
                                e.currentTarget.style.boxShadow = 'var(--shadow-sm)';
                            }}
                        >
                            {/* Profile Photo or Initials */}
                            <div style={{
                                width: '80px',
                                height: '80px',
                                borderRadius: 'var(--radius-round)',
                                flexShrink: 0,
                                overflow: 'hidden',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                background: pir.profileImageUrl ? 'transparent' : getInitialsColor(pir.firstName),
                                color: 'var(--text-white)',
                                fontSize: '28px',
                                fontWeight: 'bold'
                            }}>
                                {pir.profileImageUrl ? (
                                    <img 
                                        src={pir.profileImageUrl} 
                                        alt={pir.displayName}
                                        style={{ 
                                            width: '100%', 
                                            height: '100%', 
                                            objectFit: 'cover' 
                                        }}
                                        onError={(e) => {
                                            e.target.style.display = 'none';
                                            e.target.parentElement.textContent = getInitials(pir);
                                        }}
                                    />
                                ) : (
                                    getInitials(pir)
                                )}
                            </div>

                            {/* PIR Info */}
                            <div style={{ flex: 1, minWidth: 0 }}>
                                <div style={{ 
                                    fontSize: '18px',
                                    fontWeight: '600',
                                    color: '#333',
                                    marginBottom: '8px',
                                    overflow: 'hidden',
                                    textOverflow: 'ellipsis',
                                    whiteSpace: 'nowrap'
                                }}>
                                    {pir.displayName || pir.firstName || 'Unknown'}
                                </div>
                                <div style={{ 
                                    fontSize: '14px',
                                    color: '#666',
                                    marginBottom: '4px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px'
                                }}>
                                    <span>📅</span>
                                    <span>{pir.daysSober} days sober</span>
                                </div>
                                <div style={{ 
                                    fontSize: '14px',
                                    color: '#666',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px',
                                    overflow: 'hidden',
                                    textOverflow: 'ellipsis',
                                    whiteSpace: 'nowrap'
                                }}>
                                    <span>🎓</span>
                                    <span>Coach: {pir.coachName}</span>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>

            {/* Trend Charts */}
            <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(400px, 1fr))',
                gap: '25px',
                marginBottom: '40px'
            }}>
                <div style={{
                    background: 'var(--text-white)',
                    borderRadius: 'var(--radius-lg)',
                    padding: '25px',
                    boxShadow: 'var(--shadow-sm)'
                }}>
                    <h3 style={{ marginBottom: '15px', color: '#333' }}>30-Day Mood Trend</h3>
                    <div style={{ height: '250px' }}>
                        <canvas ref={moodChartRef}></canvas>
                    </div>
                    <div style={{
                        marginTop: '15px',
                        padding: '15px',
                        background: '#f8f9fa',
                        borderRadius: 'var(--radius-md)',
                        textAlign: 'center'
                    }}>
                        <div style={{ fontSize: '12px', color: '#666', marginBottom: '5px' }}>
                            All-Time Average
                        </div>
                        <div style={{ fontSize: '24px', fontWeight: 'bold', color: 'var(--success-color)' }}>
                            {chartData.mood.average}/10
                        </div>
                    </div>
                </div>

                <div style={{
                    background: 'var(--text-white)',
                    borderRadius: 'var(--radius-lg)',
                    padding: '25px',
                    boxShadow: 'var(--shadow-sm)'
                }}>
                    <h3 style={{ marginBottom: '15px', color: '#333' }}>30-Day Craving Trend</h3>
                    <div style={{ height: '250px' }}>
                        <canvas ref={cravingChartRef}></canvas>
                    </div>
                    <div style={{
                        marginTop: '15px',
                        padding: '15px',
                        background: '#f8f9fa',
                        borderRadius: 'var(--radius-md)',
                        textAlign: 'center'
                    }}>
                        <div style={{ fontSize: '12px', color: '#666', marginBottom: '5px' }}>
                            All-Time Average
                        </div>
                        <div style={{ fontSize: '24px', fontWeight: 'bold', color: 'var(--warning-color)' }}>
                            {chartData.craving.average}/10
                        </div>
                    </div>
                </div>

                <div style={{
                    background: 'var(--text-white)',
                    borderRadius: 'var(--radius-lg)',
                    padding: '25px',
                    boxShadow: 'var(--shadow-sm)'
                }}>
                    <h3 style={{ marginBottom: '15px', color: '#333' }}>30-Day Anxiety Trend</h3>
                    <div style={{ height: '250px' }}>
                        <canvas ref={anxietyChartRef}></canvas>
                    </div>
                    <div style={{
                        marginTop: '15px',
                        padding: '15px',
                        background: '#f8f9fa',
                        borderRadius: 'var(--radius-md)',
                        textAlign: 'center'
                    }}>
                        <div style={{ fontSize: '12px', color: '#666', marginBottom: '5px' }}>
                            All-Time Average
                        </div>
                        <div style={{ fontSize: '24px', fontWeight: 'bold', color: 'var(--danger-color)' }}>
                            {chartData.anxiety.average}/10
                        </div>
                    </div>
                </div>

                <div style={{
                    background: 'var(--text-white)',
                    borderRadius: 'var(--radius-lg)',
                    padding: '25px',
                    boxShadow: 'var(--shadow-sm)'
                }}>
                    <h3 style={{ marginBottom: '15px', color: '#333' }}>30-Day Sleep Quality Trend</h3>
                    <div style={{ height: '250px' }}>
                        <canvas ref={sleepChartRef}></canvas>
                    </div>
                    <div style={{
                        marginTop: '15px',
                        padding: '15px',
                        background: '#f8f9fa',
                        borderRadius: 'var(--radius-md)',
                        textAlign: 'center'
                    }}>
                        <div style={{ fontSize: '12px', color: '#666', marginBottom: '5px' }}>
                            All-Time Average
                        </div>
                        <div style={{ fontSize: '24px', fontWeight: 'bold', color: 'var(--primary-color)' }}>
                            {chartData.sleep.average}/10
                        </div>
                    </div>
                </div>
            </div>

            {/* Sobriety Bar Chart */}
            <div style={{
                background: 'var(--text-white)',
                borderRadius: 'var(--radius-lg)',
                padding: '25px',
                boxShadow: 'var(--shadow-sm)',
                marginBottom: '40px'
            }}>
                <h3 style={{ marginBottom: '15px', color: '#333' }}>PIR Sobriety Days</h3>
                <div style={{ height: '350px' }}>
                    <canvas ref={sobrietyChartRef}></canvas>
                </div>
                <div style={{
                    marginTop: '20px',
                    padding: '20px',
                    background: 'var(--gradient-primary)',
                    borderRadius: 'var(--radius-md)',
                    textAlign: 'center',
                    color: 'var(--text-white)'
                }}>
                    <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '5px' }}>
                        Average Sobriety Days (All PIRs)
                    </div>
                    <div style={{ fontSize: '36px', fontWeight: 'bold' }}>
                        {sobrietyData.average} days
                    </div>
                </div>
            </div>

            {/* Recent Activity */}
            <div style={{
                background: 'var(--text-white)',
                borderRadius: 'var(--radius-lg)',
                padding: '25px',
                boxShadow: 'var(--shadow-sm)'
            }}>
                <h3 style={{ marginBottom: '20px', color: '#333' }}>Recent Activity</h3>
                {recentActivity.length === 0 ? (
                    <div style={{
                        padding: '40px',
                        textAlign: 'center',
                        color: '#999'
                    }}>
                        No recent activity
                    </div>
                ) : (
                    <div>
                        {recentActivity.map((activity, index) => (
                            <div key={index} style={{
                                padding: '15px',
                                borderBottom: index < recentActivity.length - 1 ? '1px solid #f0f0f0' : 'none',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center'
                            }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                                    <div style={{
                                        width: '40px',
                                        height: '40px',
                                        borderRadius: '50%',
                                        background: activity.type === 'check-in' 
                                            ? 'var(--gradient-success)' 
                                            : 'var(--gradient-danger)',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        color: 'var(--text-white)',
                                        fontSize: '18px'
                                    }}>
                                        {activity.type === 'check-in' ? '✓' : '⚠'}
                                    </div>
                                    <div>
                                        <div style={{ fontWeight: '500', color: '#333' }}>
                                            {activity.message}
                                        </div>
                                        <div style={{ fontSize: '12px', color: '#999', marginTop: '4px' }}>
                                            {formatTimeAgo(activity.time)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>

            {/* PIR Detail Modal */}
            {selectedPIR && (
                <UserDetailModal
                    user={selectedPIR}
                    onClose={() => setSelectedPIR(null)}
                    onUpdate={() => {
                        setSelectedPIR(null);
                        loadDashboardData();
                    }}
                    currentUserId={user.uid}
                />
            )}
        </div>
    );
}
     // Enhanced Users View with Full Features
function UsersView({ searchQuery, user, onImpersonate }) {
    const [users, setUsers] = useState([]);
    const [filteredUsers, setFilteredUsers] = useState([]);
    const [loading, setLoading] = useState(true);
    const [currentPage, setCurrentPage] = useState(1);
    const [showCreateModal, setShowCreateModal] = useState(false);
    const [selectedUser, setSelectedUser] = useState(null);
    const [activeTab, setActiveTab] = useState('pir');
    
    // New state for enhancements
    const [stats, setStats] = useState({
        totalPIRs: 0,
        activePIRs: 0,
        avgCompliance: 0,
        criticalAlerts: 0,
        newThisWeek: 0
    });
    const [selectedUsers, setSelectedUsers] = useState(new Set());
    const [showBulkActions, setShowBulkActions] = useState(false);
    const [statusFilter, setStatusFilter] = useState('all'); // 'all', 'active', 'inactive', 'critical'
    const [complianceFilter, setComplianceFilter] = useState('all'); // 'all', 'high', 'medium', 'low'
    const [pirHealthData, setPirHealthData] = useState({}); // Store compliance and last check-in per PIR
    
    const itemsPerPage = 20;

    // Separate users by role
    const pirUsers = useMemo(() => users.filter(u => u.role === 'pir'), [users]);
    const coachUsers = useMemo(() => users.filter(u => u.role === 'coach'), [users]);
    const adminUsers = useMemo(() => users.filter(u => u.role === 'admin'), [users]);

    useEffect(() => {
        loadUsers();
    }, []);

    useEffect(() => {
        if (activeTab === 'pir') {
            loadPIRHealthData();
            calculateStats();
        }
    }, [users, activeTab]);

    useEffect(() => {
        filterUsers();
        setCurrentPage(1);
    }, [users, searchQuery, activeTab, statusFilter, complianceFilter]);

    const loadUsers = async () => {
        try {
            setLoading(true);
            
            const usersSnap = await db.collection('users')
                .where('tenantId', '==', CURRENT_TENANT)
                .orderBy('createdAt', 'desc')
                .get();
            
            const usersData = [];
            const coachIds = new Set();
            
            usersSnap.forEach(doc => {
                const userData = { id: doc.id, ...doc.data() };
                usersData.push(userData);
                if (userData.assignedCoach) {
                    coachIds.add(userData.assignedCoach);
                }
            });
            
            // Batch load coaches
            const coachesMap = {};
            if (coachIds.size > 0) {
                const coachResults = await batchQuery('users', 
                    firebase.firestore.FieldPath.documentId(), 
                    Array.from(coachIds)
                );
                
                coachResults.forEach(coach => {
                    coachesMap[coach.id] = coach.displayName || coach.email;
                });
            }
            
            usersData.forEach(user => {
                if (user.assignedCoach && coachesMap[user.assignedCoach]) {
                    user.coachName = coachesMap[user.assignedCoach];
                }
            });
            
            setUsers(usersData);
            
        } catch (error) {
            console.error('Error loading users:', error);
            alert('Failed to load users. Please refresh the page.');
        } finally {
            setLoading(false);
        }
    };

    const loadPIRHealthData = async () => {
        try {
            const healthData = {};
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            // Load check-ins for all PIRs from last 7 days
            const checkInsSnap = await db.collection('checkIns')
                .where('tenantId', '==', CURRENT_TENANT)
                .where('createdAt', '>=', sevenDaysAgo)
                .get();
            
            const pirCheckIns = {};
            checkInsSnap.forEach(doc => {
                const data = doc.data();
                if (!pirCheckIns[data.userId]) {
                    pirCheckIns[data.userId] = [];
                }
                pirCheckIns[data.userId].push(data);
            });
            
            // Calculate compliance and last check-in for each PIR
            pirUsers.forEach(pir => {
                const checkIns = pirCheckIns[pir.id] || [];
                const compliance = Math.round((checkIns.length / 14) * 100); // 2 check-ins per day * 7 days
                
                const lastCheckIn = checkIns.length > 0 
                    ? checkIns.reduce((latest, current) => {
                        const currentDate = current.createdAt?.toDate ? current.createdAt.toDate() : new Date(current.createdAt);
                        const latestDate = latest.createdAt?.toDate ? latest.createdAt.toDate() : new Date(latest.createdAt);
                        return currentDate > latestDate ? current : latest;
                    }).createdAt
                    : null;
                
                healthData[pir.id] = {
                    compliance: Math.min(compliance, 100),
                    lastCheckIn,
                    checkInCount: checkIns.length,
                    status: compliance >= 70 ? 'good' : compliance >= 40 ? 'moderate' : 'critical'
                };
            });
            
            setPirHealthData(healthData);
            
        } catch (error) {
            console.error('Error loading PIR health data:', error);
        }
    };

    const calculateStats = async () => {
        try {
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            // Count active PIRs
            const activePIRs = pirUsers.filter(p => p.active !== false).length;
            
            // Calculate average compliance
            const complianceValues = Object.values(pirHealthData).map(h => h.compliance || 0);
            const avgCompliance = complianceValues.length > 0 
                ? Math.round(complianceValues.reduce((a, b) => a + b, 0) / complianceValues.length)
                : 0;
            
            // Count critical alerts
            const alertsSnap = await db.collection('alerts')
                .where('tenantId', '==', CURRENT_TENANT)
                .where('resolved', '==', false)
                .where('priority', '==', 'critical')
                .get();
            
            // Count new PIRs this week
            const newThisWeek = pirUsers.filter(p => {
                const createdAt = p.createdAt?.toDate ? p.createdAt.toDate() : new Date(p.createdAt);
                return createdAt >= oneWeekAgo;
            }).length;
            
            setStats({
                totalPIRs: pirUsers.length,
                activePIRs,
                avgCompliance,
                criticalAlerts: alertsSnap.size,
                newThisWeek
            });
            
        } catch (error) {
            console.error('Error calculating stats:', error);
        }
    };

    const filterUsers = () => {
        let tabFiltered = [];
        if (activeTab === 'pir') {
            tabFiltered = pirUsers;
        } else if (activeTab === 'coach') {
            tabFiltered = coachUsers;
        } else if (activeTab === 'admin') {
            tabFiltered = adminUsers;
        }

        // Apply status filter
        if (statusFilter !== 'all') {
            if (statusFilter === 'active') {
                tabFiltered = tabFiltered.filter(u => u.active !== false);
            } else if (statusFilter === 'inactive') {
                tabFiltered = tabFiltered.filter(u => u.active === false);
            } else if (statusFilter === 'critical') {
                tabFiltered = tabFiltered.filter(u => pirHealthData[u.id]?.status === 'critical');
            }
        }

        // Apply compliance filter (PIRs only)
        if (activeTab === 'pir' && complianceFilter !== 'all') {
            if (complianceFilter === 'high') {
                tabFiltered = tabFiltered.filter(u => (pirHealthData[u.id]?.compliance || 0) >= 70);
            } else if (complianceFilter === 'medium') {
                tabFiltered = tabFiltered.filter(u => {
                    const comp = pirHealthData[u.id]?.compliance || 0;
                    return comp >= 40 && comp < 70;
                });
            } else if (complianceFilter === 'low') {
                tabFiltered = tabFiltered.filter(u => (pirHealthData[u.id]?.compliance || 0) < 40);
            }
        }

        // Apply search filter
        if (searchQuery) {
            const query = searchQuery.toLowerCase();
            tabFiltered = tabFiltered.filter(user => 
                user.email?.toLowerCase().includes(query) ||
                user.displayName?.toLowerCase().includes(query) ||
                user.firstName?.toLowerCase().includes(query) ||
                user.lastName?.toLowerCase().includes(query) ||
                user.phone?.toLowerCase().includes(query) ||
                user.coachName?.toLowerCase().includes(query)
            );
        }
        
        setFilteredUsers(tabFiltered);
    };

    const paginatedUsers = useMemo(() => {
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        return filteredUsers.slice(start, end);
    }, [filteredUsers, currentPage]);

    const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);

    const handleSelectAll = () => {
        if (selectedUsers.size === paginatedUsers.length) {
            setSelectedUsers(new Set());
        } else {
            setSelectedUsers(new Set(paginatedUsers.map(u => u.id)));
        }
    };

    const handleSelectUser = (userId) => {
        const newSelected = new Set(selectedUsers);
        if (newSelected.has(userId)) {
            newSelected.delete(userId);
        } else {
            newSelected.add(userId);
        }
        setSelectedUsers(newSelected);
    };

    const handleBulkAssignCoach = async () => {
        const coachId = prompt('Enter coach ID to assign:');
        if (!coachId) return;
        
        try {
            const batch = db.batch();
            selectedUsers.forEach(userId => {
                const userRef = db.collection('users').doc(userId);
                batch.update(userRef, { assignedCoach: coachId });
            });
            
            await batch.commit();
            alert(`Assigned coach to ${selectedUsers.size} users`);
            setSelectedUsers(new Set());
            loadUsers();
        } catch (error) {
            console.error('Error in bulk assign:', error);
            alert('Failed to assign coach');
        }
    };

    const handleBulkToggleStatus = async () => {
        try {
            const batch = db.batch();
            selectedUsers.forEach(userId => {
                const user = users.find(u => u.id === userId);
                const userRef = db.collection('users').doc(userId);
                batch.update(userRef, { active: user.active === false });
            });
            
            await batch.commit();
            alert(`Updated status for ${selectedUsers.size} users`);
            setSelectedUsers(new Set());
            loadUsers();
        } catch (error) {
            console.error('Error in bulk status toggle:', error);
            alert('Failed to update status');
        }
    };

    const handleExport = (format) => {
        const exportData = filteredUsers.map(user => ({
            name: user.displayName || 'N/A',
            email: user.email,
            role: user.role,
            status: user.active !== false ? 'Active' : 'Inactive',
            coach: user.coachName || 'N/A',
            compliance: activeTab === 'pir' ? `${pirHealthData[user.id]?.compliance || 0}%` : 'N/A',
            phone: user.phone || 'N/A',
            joined: formatDate(user.createdAt)
        }));

        if (format === 'json') {
            exportToJSON(exportData, `${activeTab}_users`);
        } else if (format === 'csv') {
            exportToCSV(exportData, `${activeTab}_users`);
        } else if (format === 'pdf') {
            exportToPDF(exportData, `${activeTab.toUpperCase()} Users Report`);
        }
    };

    const getHealthBadgeColor = (status) => {
        if (status === 'good') return '#00A86B';
        if (status === 'moderate') return '#FF9800';
        return '#f44336';
    };

    if (loading) {
        return (
            <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                minHeight: '400px',
                gap: '20px'
            }}>
                <div style={{
                    width: '60px',
                    height: '60px',
                    border: '4px solid #f3f3f3',
                    borderTop: '4px solid #0077CC',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite'
                }}></div>
                <p style={{ color: '#666', fontSize: '16px' }}>Loading users...</p>
            </div>
        );
    }

    return (
        <div style={{ animation: 'fadeIn 0.3s ease-in' }}>
            {/* Stats Cards - PIRs Only */}
            {activeTab === 'pir' && (
                <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                    gap: '20px',
                    marginBottom: '30px'
                }}>
                   <div style={{
                        background: 'var(--gradient-primary)',
                        borderRadius: 'var(--radius-lg)',
                        padding: '25px',
                        color: 'var(--text-white)',
                        boxShadow: 'var(--shadow-primary)',
                        transition: 'var(--transition-fast)',
                        cursor: 'pointer'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                    onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                    >
                        <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '10px' }}>Total PIRs</div>
                        <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{stats.totalPIRs}</div>
                        <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '10px' }}>
                            {stats.activePIRs} active
                        </div>
                    </div>

                    <div style={{
                        background: 'var(--gradient-warning)',
                        borderRadius: 'var(--radius-lg)',
                        padding: '25px',
                        color: 'var(--text-white)',
                        boxShadow: 'var(--shadow-md)',
                        transition: 'var(--transition-fast)',
                        cursor: 'pointer'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                    onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                    >
                        <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '10px' }}>Avg Compliance</div>
                        <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{stats.avgCompliance}%</div>
                        <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '10px' }}>
                            Last 7 days
                        </div>
                    </div>

                    <div style={{
                        background: 'var(--gradient-info)',
                        borderRadius: 'var(--radius-lg)',
                        padding: '25px',
                        color: 'var(--text-white)',
                        boxShadow: 'var(--shadow-md)',
                        transition: 'var(--transition-fast)',
                        cursor: 'pointer'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                    onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                    >
                        <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '10px' }}>Critical Alerts</div>
                        <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{stats.criticalAlerts}</div>
                        <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '10px' }}>
                            Require attention
                        </div>
                    </div>

                    <div style={{
                        background: 'var(--gradient-success)',
                        borderRadius: 'var(--radius-lg)',
                        padding: '25px',
                        color: 'var(--text-white)',
                        boxShadow: 'var(--shadow-success)',
                        transition: 'var(--transition-fast)',
                        cursor: 'pointer'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                    onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                    >
                        <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '10px' }}>New This Week</div>
                        <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{stats.newThisWeek}</div>
                        <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '10px' }}>
                            Recent additions
                        </div>
                    </div>
                </div>
            )}

          {/* Tab Navigation - FIXED: Using CSS Variables */}
            <div style={{
                display: 'flex',
                gap: '10px',
                marginBottom: '25px',
                borderBottom: '2px solid var(--border-color)',
                paddingBottom: '5px'
            }}>
                <button 
                    onClick={() => setActiveTab('pir')}
                    style={{
                        padding: '12px 24px',
                        border: 'none',
                        background: activeTab === 'pir' ? 'var(--gradient-primary)' : 'transparent',
                        color: activeTab === 'pir' ? 'var(--text-white)' : 'var(--text-gray)',
                        borderRadius: 'var(--radius-md) var(--radius-md) 0 0',
                        cursor: 'pointer',
                        fontSize: '15px',
                        fontWeight: activeTab === 'pir' ? '600' : '500',
                        transition: 'var(--transition-normal)',
                        boxShadow: activeTab === 'pir' ? 'var(--shadow-primary)' : 'none',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                    }}
                    onMouseEnter={(e) => {
                        if (activeTab !== 'pir') {
                            e.currentTarget.style.background = 'var(--background-secondary)';
                            e.currentTarget.style.color = 'var(--text-primary)';
                        }
                    }}
                    onMouseLeave={(e) => {
                        if (activeTab !== 'pir') {
                            e.currentTarget.style.background = 'transparent';
                            e.currentTarget.style.color = 'var(--text-gray)';
                        }
                    }}
                >
                    <span style={{ fontSize: '18px' }}>👥</span>
                    PIRs ({pirUsers.length})
                </button>
                <button 
                    onClick={() => setActiveTab('coach')}
                    style={{
                        padding: '12px 24px',
                        border: 'none',
                        background: activeTab === 'coach' ? 'var(--gradient-primary)' : 'transparent',
                        color: activeTab === 'coach' ? 'var(--text-white)' : 'var(--text-gray)',
                        borderRadius: 'var(--radius-md) var(--radius-md) 0 0',
                        cursor: 'pointer',
                        fontSize: '15px',
                        fontWeight: activeTab === 'coach' ? '600' : '500',
                        transition: 'var(--transition-normal)',
                        boxShadow: activeTab === 'coach' ? 'var(--shadow-primary)' : 'none',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                    }}
                    onMouseEnter={(e) => {
                        if (activeTab !== 'coach') {
                            e.currentTarget.style.background = 'var(--background-secondary)';
                            e.currentTarget.style.color = 'var(--text-primary)';
                        }
                    }}
                    onMouseLeave={(e) => {
                        if (activeTab !== 'coach') {
                            e.currentTarget.style.background = 'transparent';
                            e.currentTarget.style.color = 'var(--text-gray)';
                        }
                    }}
                >
                    <span style={{ fontSize: '18px' }}>🎓</span>
                    Coaches ({coachUsers.length})
                </button>
                <button 
                    onClick={() => setActiveTab('admin')}
                    style={{
                        padding: '12px 24px',
                        border: 'none',
                        background: activeTab === 'admin' ? 'var(--gradient-primary)' : 'transparent',
                        color: activeTab === 'admin' ? 'var(--text-white)' : 'var(--text-gray)',
                        borderRadius: 'var(--radius-md) var(--radius-md) 0 0',
                        cursor: 'pointer',
                        fontSize: '15px',
                        fontWeight: activeTab === 'admin' ? '600' : '500',
                        transition: 'var(--transition-normal)',
                        boxShadow: activeTab === 'admin' ? 'var(--shadow-primary)' : 'none',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                    }}
                    onMouseEnter={(e) => {
                        if (activeTab !== 'admin') {
                            e.currentTarget.style.background = 'var(--background-secondary)';
                            e.currentTarget.style.color = 'var(--text-primary)';
                        }
                    }}
                    onMouseLeave={(e) => {
                        if (activeTab !== 'admin') {
                            e.currentTarget.style.background = 'transparent';
                            e.currentTarget.style.color = 'var(--text-gray)';
                        }
                    }}
                >
                    <span style={{ fontSize: '18px' }}>⚙️</span>
                    Admins ({adminUsers.length})
                </button>
            </div>

            {/* Filters and Actions Bar */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                marginBottom: '20px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                flexWrap: 'wrap',
                gap: '15px'
            }}>
                <div style={{ display: 'flex', gap: '10px', alignItems: 'center', flexWrap: 'wrap' }}>
                    {/* Status Filter */}
                    <select 
                        value={statusFilter}
                        onChange={(e) => setStatusFilter(e.target.value)}
                        style={{
                            padding: '8px 12px',
                            borderRadius: '8px',
                            border: '1px solid #ddd',
                            background: 'white',
                            cursor: 'pointer',
                            fontSize: '14px'
                        }}
                    >
                        <option value="all">All Status</option>
                        <option value="active">Active Only</option>
                        <option value="inactive">Inactive Only</option>
                        {activeTab === 'pir' && <option value="critical">Critical Status</option>}
                    </select>

                    {/* Compliance Filter - PIRs only */}
                    {activeTab === 'pir' && (
                        <select 
                            value={complianceFilter}
                            onChange={(e) => setComplianceFilter(e.target.value)}
                            style={{
                                padding: '8px 12px',
                                borderRadius: '8px',
                                border: '1px solid #ddd',
                                background: 'white',
                                cursor: 'pointer',
                                fontSize: '14px'
                            }}
                        >
                            <option value="all">All Compliance</option>
                            <option value="high">High (70%+)</option>
                            <option value="medium">Medium (40-70%)</option>
                            <option value="low">Low (&lt;40%)</option>
                        </select>
                    )}

                    <div style={{ 
                        fontSize: '14px', 
                        color: '#666',
                        padding: '8px 12px',
                        background: '#f8f9fa',
                        borderRadius: '8px'
                    }}>
                        Showing {paginatedUsers.length} of {filteredUsers.length} {activeTab}s
                        {searchQuery && ' (filtered)'}
                    </div>
                </div>

                <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                    {/* Bulk Actions - PIRs only */}
                    {activeTab === 'pir' && selectedUsers.size > 0 && (
                        <>
                            <button 
                                onClick={handleBulkAssignCoach}
                                style={{
                                    padding: '10px 16px',
                                    background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500',
                                    transition: 'transform 0.2s',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px'
                                }}
                                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                            >
                                Assign Coach ({selectedUsers.size})
                            </button>
                            <button 
                                onClick={handleBulkToggleStatus}
                                style={{
                                    padding: '10px 16px',
                                    background: 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500',
                                    transition: 'transform 0.2s',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px'
                                }}
                                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                            >
                                Toggle Status ({selectedUsers.size})
                            </button>
                        </>
                    )}

                    {/* Export Buttons */}
                    <button 
                        onClick={() => handleExport('csv')}
                        style={{
                            padding: '10px 16px',
                            background: '#6c757d',
                            color: 'white',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500',
                            transition: 'all 0.2s'
                        }}
                        onMouseEnter={(e) => {
                            e.currentTarget.style.background = '#5a6268';
                            e.currentTarget.style.transform = 'translateY(-2px)';
                        }}
                        onMouseLeave={(e) => {
                            e.currentTarget.style.background = '#6c757d';
                            e.currentTarget.style.transform = 'translateY(0)';
                        }}
                    >
                        Export CSV
                    </button>
                    
                    <button 
                        onClick={() => setShowCreateModal(true)}
                        style={{
                            padding: '10px 20px',
                            background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                            color: 'white',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '600',
                            transition: 'all 0.2s',
                            boxShadow: '0 4px 12px rgba(102, 126, 234, 0.4)',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px'
                        }}
                        onMouseEnter={(e) => {
                            e.currentTarget.style.transform = 'translateY(-2px)';
                            e.currentTarget.style.boxShadow = '0 6px 16px rgba(102, 126, 234, 0.5)';
                        }}
                        onMouseLeave={(e) => {
                            e.currentTarget.style.transform = 'translateY(0)';
                            e.currentTarget.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.4)';
                        }}
                    >
                        <span style={{ fontSize: '16px' }}>+</span> Create User
                    </button>
                </div>
            </div>
            
         {/* User Table */}
            <div style={{
                background: 'var(--text-white)',
                borderRadius: 'var(--radius-lg)',
                boxShadow: 'var(--shadow-md)',
                overflow: 'hidden'
            }}>
                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                    <thead>
                        <tr style={{ background: 'var(--background-secondary)', borderBottom: '2px solid var(--border-color)' }}>
                            {activeTab === 'pir' && (
                                <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: 'var(--text-primary)' }}>
                                    <input 
                                        type="checkbox"
                                        checked={selectedUsers.size === paginatedUsers.length && paginatedUsers.length > 0}
                                        onChange={handleSelectAll}
                                        style={{ cursor: 'pointer', width: '16px', height: '16px' }}
                                    />
                                </th>
                            )}
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: 'var(--text-primary)' }}>Name</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: 'var(--text-primary)' }}>Email</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: 'var(--text-primary)' }}>Status</th>
                            {activeTab === 'pir' && <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: 'var(--text-primary)' }}>Health</th>}
                            {activeTab === 'pir' && <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: 'var(--text-primary)' }}>Assigned Coach</th>}
                            {activeTab === 'pir' && <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: 'var(--text-primary)' }}>Last Check-in</th>}
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: 'var(--text-primary)' }}>Phone</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: 'var(--text-primary)' }}>Joined</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: 'var(--text-primary)' }}>Actions</th>
                        </tr>
                    </thead>
                   <tbody>
                        {paginatedUsers.map((user, index) => (
                            <tr key={user.id} style={{
                                borderBottom: '1px solid var(--border-color)',
                                transition: 'var(--transition-fast)',
                                background: selectedUsers.has(user.id) ? 'var(--bg-primary-light)' : 'var(--text-white)'
                            }}
                            onMouseEnter={(e) => {
                                if (!selectedUsers.has(user.id)) {
                                    e.currentTarget.style.background = 'var(--background-secondary)';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (!selectedUsers.has(user.id)) {
                                    e.currentTarget.style.background = 'var(--text-white)';
                                }
                            }}
                            >
                                {activeTab === 'pir' && (
                                    <td style={{ padding: '15px' }}>
                                        <input 
                                            type="checkbox"
                                            checked={selectedUsers.has(user.id)}
                                            onChange={() => handleSelectUser(user.id)}
                                            style={{ cursor: 'pointer', width: '16px', height: '16px' }}
                                        />
                                    </td>
                                )}
                                <td style={{ padding: '15px' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                        <div style={{
                                            width: '40px',
                                            height: '40px',
                                            borderRadius: '50%',
                                            background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            color: 'white',
                                            fontWeight: '600',
                                            fontSize: '16px'
                                        }}>
                                            {(user.displayName || user.email || 'U').charAt(0).toUpperCase()}
                                        </div>
                                        <span style={{ fontWeight: '500', color: '#333' }}>
                                            {user.displayName || 'N/A'}
                                        </span>
                                    </div>
                               </td>
                                <td style={{ padding: '15px', color: 'var(--text-gray)' }}>{user.email}</td>
                                <td style={{ padding: '15px' }}>
                                    <span style={{
                                        padding: '4px 12px',
                                        borderRadius: 'var(--radius-xl)',
                                        fontSize: '12px',
                                        fontWeight: '500',
                                        background: user.active !== false ? 'var(--bg-success-light)' : 'var(--bg-danger-light)',
                                        color: user.active !== false ? 'var(--success-dark)' : 'var(--danger-dark)'
                                    }}>
                                        {user.active !== false ? 'Active' : 'Inactive'}
                                    </span>
                                </td>
                                {activeTab === 'pir' && (
                                    <td style={{ padding: '15px' }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            <div style={{
                                                width: '8px',
                                                height: '8px',
                                                borderRadius: '50%',
                                                background: getHealthBadgeColor(pirHealthData[user.id]?.status)
                                            }}></div>
                                            <span style={{ 
                                                fontSize: '13px',
                                                fontWeight: '500',
                                                color: 'var(--text-gray)'
                                            }}>
                                                {pirHealthData[user.id]?.compliance || 0}%
                                            </span>
                                        </div>
                                    </td>
                                )}
                                {activeTab === 'pir' && <td style={{ padding: '15px', color: 'var(--text-gray)' }}>{user.coachName || '-'}</td>}
                                {activeTab === 'pir' && (
                                    <td style={{ padding: '15px', color: 'var(--text-gray)' }}>
                                        {pirHealthData[user.id]?.lastCheckIn ? formatTimeAgo(pirHealthData[user.id].lastCheckIn) : 'Never'}
                                    </td>
                                )}
                                <td style={{ padding: '15px', color: 'var(--text-gray)' }}>{user.phone || '-'}</td>
                                <td style={{ padding: '15px', color: 'var(--text-gray)' }}>{formatDate(user.createdAt)}</td>
                                <td style={{ padding: '15px' }}>
                                    <div style={{ display: 'flex', gap: '8px' }}>
                                       <button 
                                            onClick={() => setSelectedUser(user)}
                                            style={{
                                                padding: '6px 12px',
                                                background: 'var(--gradient-primary)',
                                                color: 'var(--text-white)',
                                                border: 'none',
                                                borderRadius: 'var(--radius-sm)',
                                                cursor: 'pointer',
                                                fontSize: '13px',
                                                fontWeight: '500',
                                                transition: 'var(--transition-fast)'
                                            }}
                                            onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.05)'}
                                            onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
                                        >
                                            View
                                        </button>
                                        {user.role === 'pir' && (
                                            <button 
                                                onClick={() => onImpersonate(user)}
                                                style={{
                                                    padding: '6px 12px',
                                                    background: 'var(--text-dark-gray)',
                                                    color: 'var(--text-white)',
                                                    border: 'none',
                                                    borderRadius: 'var(--radius-sm)',
                                                    cursor: 'pointer',
                                                    fontSize: '13px',
                                                    fontWeight: '500',
                                                    transition: 'var(--transition-fast)'
                                                }}
                                                onMouseEnter={(e) => {
                                                    e.currentTarget.style.background = 'var(--text-gray)';
                                                    e.currentTarget.style.transform = 'scale(1.05)';
                                                }}
                                                onMouseLeave={(e) => {
                                                    e.currentTarget.style.background = 'var(--text-dark-gray)';
                                                    e.currentTarget.style.transform = 'scale(1)';
                                                }}
                                            >
                                                View As
                                            </button>
                                        )}
                                    </div>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
                
                {filteredUsers.length === 0 && (
                    <div style={{
                        padding: '60px 20px',
                        textAlign: 'center',
                        color: 'var(--text-gray)'
                    }}>
                        <div style={{ fontSize: '48px', marginBottom: '15px' }}>🔍</div>
                        <div style={{ fontSize: '18px', fontWeight: '500', marginBottom: '8px' }}>
                            {searchQuery ? `No ${activeTab}s found matching your search` : `No ${activeTab}s found`}
                        </div>
                        <div style={{ fontSize: '14px' }}>
                            {searchQuery ? 'Try adjusting your search terms' : `Click "Create User" to add a new ${activeTab}`}
                        </div>
                    </div>
                )}
            </div>
            
            {totalPages > 1 && (
                <div style={{ marginTop: '20px' }}>
                    <Pagination 
                        currentPage={currentPage}
                        totalPages={totalPages}
                        onPageChange={setCurrentPage}
                    />
                </div>
            )}
            
            {showCreateModal && (
                <CreateUserModal 
                    onClose={() => setShowCreateModal(false)}
                    onSuccess={() => {
                        setShowCreateModal(false);
                        loadUsers();
                    }}
                />
            )}
            
            {selectedUser && (
                selectedUser.role === 'coach' || selectedUser.role === 'admin' ? (
                    <CoachDetailModal 
                        coach={selectedUser}
                        onClose={() => setSelectedUser(null)}
                        onUpdate={() => {
                            setSelectedUser(null);
                            loadUsers();
                        }}
                        currentUserId={user.uid}
                    />
                ) : (
                    <UserDetailModal 
                        user={selectedUser}
                        onClose={() => setSelectedUser(null)}
                        onUpdate={() => {
                            setSelectedUser(null);
                            loadUsers();
                        }}
                        currentUserId={user.uid}
                    />
                )
            )}
        </div>
    );
}
       // FULLY ENHANCED MyPIRsView with All Features
function MyPIRsView({ searchQuery, user }) {
    const [myPIRs, setMyPIRs] = useState([]);
    const [filteredPIRs, setFilteredPIRs] = useState([]);
    const [loading, setLoading] = useState(true);
    const [selectedPIR, setSelectedPIR] = useState(null);
    const [activeFilter, setActiveFilter] = useState('all');
    const [recentCheckIns, setRecentCheckIns] = useState([]);
    const [pendingAlerts, setPendingAlerts] = useState([]);
    const [showNotesModal, setShowNotesModal] = useState(false);
    const [selectedPIRForNotes, setSelectedPIRForNotes] = useState(null);
    const [pirNotes, setPirNotes] = useState({});
    const [sortBy, setSortBy] = useState('daysClean'); // daysClean, compliance, lastCheckIn
    const [viewMode, setViewMode] = useState('grid'); // grid or list
    
    const moodChartRefs = useRef({});
    const cravingChartRefs = useRef({});
    const chartInstances = useRef({});

    useEffect(() => {
        loadMyPIRs();
        loadPIRNotes();
    }, [user]);

    useEffect(() => {
        filterPIRs();
    }, [searchQuery, myPIRs, activeFilter, sortBy]);

    useEffect(() => {
        // Render mini charts when data is loaded
        if (myPIRs.length > 0 && viewMode === 'grid') {
            myPIRs.forEach(pir => {
                if (pir.moodTrend) renderMiniChart(pir.id, 'mood', pir.moodTrend);
                if (pir.cravingTrend) renderMiniChart(pir.id, 'craving', pir.cravingTrend);
            });
        }
    }, [myPIRs, viewMode]);

    const loadPIRNotes = async () => {
        try {
            const notesSnap = await db.collection('pirNotes')
                .where('tenantId', '==', CURRENT_TENANT)
                .where('coachId', '==', user.uid)
                .get();
            
            const notes = {};
            notesSnap.forEach(doc => {
                notes[doc.data().pirId] = doc.data().notes;
            });
            setPirNotes(notes);
        } catch (error) {
            console.error('Error loading PIR notes:', error);
        }
    };

    const loadMyPIRs = async () => {
        try {
            setLoading(true);
            
            const pirsSnap = await db.collection('users')
                .where('tenantId', '==', CURRENT_TENANT)
                .where('assignedCoach', '==', user.uid)
                .where('role', '==', 'pir')
                .get();

            const pirsData = [];
            const pirIds = [];
            
            for (const doc of pirsSnap.docs) {
                const pirData = { id: doc.id, ...doc.data() };
                pirIds.push(doc.id);
                
                // Get last check-in
                const lastCheckInSnap = await db.collection('checkIns')
                    .where('tenantId', '==', CURRENT_TENANT)
                    .where('userId', '==', doc.id)
                    .orderBy('createdAt', 'desc')
                    .limit(1)
                    .get();
                
                if (!lastCheckInSnap.empty) {
                    pirData.lastCheckIn = lastCheckInSnap.docs[0].data();
                    pirData.lastCheckInDate = lastCheckInSnap.docs[0].data().createdAt;
                }
                
                // Get last 7 days of check-ins for trend
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                
                const weekCheckInsSnap = await db.collection('checkIns')
                    .where('tenantId', '==', CURRENT_TENANT)
                    .where('userId', '==', doc.id)
                    .where('createdAt', '>=', sevenDaysAgo)
                    .orderBy('createdAt', 'asc')
                    .get();
                
                const moodTrend = [];
                const cravingTrend = [];
                
                weekCheckInsSnap.forEach(checkInDoc => {
                    const data = checkInDoc.data();
                    if (data.morningData?.mood) moodTrend.push(data.morningData.mood);
                    if (data.morningData?.craving) cravingTrend.push(data.morningData.craving);
                });
                
                pirData.moodTrend = moodTrend;
                pirData.cravingTrend = cravingTrend;
                
                // Calculate days clean
                if (pirData.sobrietyDate) {
                    const sobrietyDate = pirData.sobrietyDate.toDate ? 
                        pirData.sobrietyDate.toDate() : new Date(pirData.sobrietyDate);
                    pirData.daysClean = Math.floor((new Date() - sobrietyDate) / (1000 * 60 * 60 * 24));
                } else {
                    pirData.daysClean = 0;
                }
                
                // Check compliance
                pirData.weeklyCheckIns = weekCheckInsSnap.size;
                pirData.complianceRate = Math.min(Math.round((weekCheckInsSnap.size / 14) * 100), 100);
                
                // Check for active alerts
                const alertsSnap = await db.collection('alerts')
                    .where('tenantId', '==', CURRENT_TENANT)
                    .where('userId', '==', doc.id)
                    .where('resolved', '==', false)
                    .get();
                
                pirData.activeAlerts = alertsSnap.size;
                
                // Get milestone badge
                pirData.milestone = getMilestone(pirData.daysClean);
                
                pirsData.push(pirData);
            }
            
            // Load recent check-ins
            if (pirIds.length > 0) {
                const checkInsPromises = pirIds.map(id =>
                    db.collection('checkIns')
                        .where('tenantId', '==', CURRENT_TENANT)
                        .where('userId', '==', id)
                        .orderBy('createdAt', 'desc')
                        .limit(3)
                        .get()
                );
                
                const checkInsSnapshots = await Promise.all(checkInsPromises);
                const allCheckIns = [];
                
                checkInsSnapshots.forEach((snapshot, index) => {
                    snapshot.forEach(doc => {
                        const checkInData = { id: doc.id, ...doc.data() };
                        const pir = pirsData.find(p => p.id === pirIds[index]);
                        checkInData.pirName = pir?.displayName || pir?.email || 'Unknown';
                        checkInData.pirId = pirIds[index];
                        allCheckIns.push(checkInData);
                    });
                });
                
                allCheckIns.sort((a, b) => {
                    const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
                    const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
                    return dateB - dateA;
                });
                
                setRecentCheckIns(allCheckIns.slice(0, 10));
                
                // Load pending alerts
                const alertsPromises = pirIds.map(id =>
                    db.collection('alerts')
                        .where('tenantId', '==', CURRENT_TENANT)
                        .where('userId', '==', id)
                        .where('resolved', '==', false)
                        .get()
                );
                
                const alertsSnapshots = await Promise.all(alertsPromises);
                const allAlerts = [];
                
                alertsSnapshots.forEach((snapshot, index) => {
                    snapshot.forEach(doc => {
                        const alertData = { id: doc.id, ...doc.data() };
                        const pir = pirsData.find(p => p.id === pirIds[index]);
                        alertData.pirName = pir?.displayName || pir?.email || 'Unknown';
                        alertData.pirId = pirIds[index];
                        allAlerts.push(alertData);
                    });
                });
                
                setPendingAlerts(allAlerts);
            }
            
            setMyPIRs(pirsData);
            setFilteredPIRs(pirsData);
            
        } catch (error) {
            console.error('Error loading my PIRs:', error);
        } finally {
            setLoading(false);
        }
    };
 // AUTO-REFRESH: Silently refresh Google token if expired
const refreshGoogleToken = async () => {
    return new Promise((resolve, reject) => {
        try {
            console.log('Attempting to refresh Google token...');
            
            // Check if Google Identity Services is loaded
            if (typeof google === 'undefined' || !google.accounts) {
                reject(new Error('Google Identity Services not loaded'));
                return;
            }
            
            // Use token client to get new token silently
            const tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: '457406864879-k1sunucuqofe22m5rg93hvo6nngiqh0u.apps.googleusercontent.com',
                scope: [
                    'https://www.googleapis.com/auth/calendar.events',
                    'https://www.googleapis.com/auth/drive.file',
                    'https://www.googleapis.com/auth/gmail.send'
                ].join(' '),
                callback: async (tokenResponse) => {
                    try {
                        if (tokenResponse.error) {
                            reject(new Error(tokenResponse.error));
                            return;
                        }
                        
                        if (tokenResponse.access_token) {
                            // Update Firebase with new token
                            await db.collection('users').doc(user.uid).update({
                                googleAccessToken: tokenResponse.access_token,
                                googleTokenExpiry: Date.now() + (tokenResponse.expires_in * 1000),
                                googleTokenRefreshedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            console.log('✓ Token refreshed successfully');
                            
                            // Update local user object
                            user.googleAccessToken = tokenResponse.access_token;
                            user.googleTokenExpiry = Date.now() + (tokenResponse.expires_in * 1000);
                            
                            resolve(tokenResponse.access_token);
                        } else {
                            reject(new Error('No access token received'));
                        }
                    } catch (error) {
                        reject(error);
                    }
                },
            });
            
            // Request new token (will try silently first with prompt: '')
            tokenClient.requestAccessToken({ prompt: '' });
            
        } catch (error) {
            console.error('Failed to refresh token:', error);
            reject(error);
        }
    });
};

// Check if Google token is valid and auto-refresh if needed
const checkGoogleToken = async () => {
    // Check if user has Google connected
    if (!user.googleConnected || !user.googleAccessToken) {
        return {
            valid: false,
            error: 'Google Services not connected. Please connect Google in your Profile settings.'
        };
    }
    
    // Check if token is expired
    if (user.googleTokenExpiry) {
        const now = Date.now();
        const expiryTime = user.googleTokenExpiry;
        const fiveMinutes = 5 * 60 * 1000;
        
        if (now >= expiryTime - fiveMinutes) {
            // Token expired - try to refresh automatically
            try {
                console.log('⚠️ Token expired, attempting auto-refresh...');
                await refreshGoogleToken();
                console.log('✓ Token auto-refreshed successfully');
                return { valid: true };
            } catch (refreshError) {
                console.error('❌ Auto-refresh failed:', refreshError);
                return {
                    valid: false,
                    error: 'Google token expired and could not be refreshed automatically.\n\nPlease:\n1. Go to Profile\n2. Click "Disconnect Google Services"\n3. Click "Connect Google Services" again\n\nThen try scheduling the meeting again.'
                };
            }
        }
    }
    
    return { valid: true };
};
    // UPDATED: Simplified milestone calculation with calendar-based logic
const getRecoveryMilestones = (sobrietyDate) => {
    if (!sobrietyDate) return [];
    
    // Parse sobriety date in LOCAL timezone (Pacific)
    let startYear, startMonth, startDay;
    
    if (typeof sobrietyDate === 'string' && sobrietyDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
        [startYear, startMonth, startDay] = sobrietyDate.split('-').map(Number);
    } else if (sobrietyDate.toDate) {
        const d = sobrietyDate.toDate();
        startYear = d.getFullYear();
        startMonth = d.getMonth() + 1;
        startDay = d.getDate();
    } else if (sobrietyDate.seconds) {
        const d = new Date(sobrietyDate.seconds * 1000);
        startYear = d.getFullYear();
        startMonth = d.getMonth() + 1;
        startDay = d.getDate();
    } else {
        const d = new Date(sobrietyDate);
        startYear = d.getFullYear();
        startMonth = d.getMonth() + 1;
        startDay = d.getDate();
    }
    
    const startDate = new Date(startYear, startMonth - 1, startDay, 0, 0, 0, 0);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // Calculate current days sober (matching calculateSobrietyDaysFixed logic with +2)
    const daysSober = Math.floor((today - startDate) / (1000 * 60 * 60 * 24)) + 2;
    
    const milestones = [];
    
    // DAY-BASED MILESTONES (count exact days)
    const dayBased = [
        { days: 1, title: '24 Hours Clean', icon: '🌟' },
        { days: 7, title: '1 Week Clean', icon: '📅' },
        { days: 30, title: '1 Month Clean', icon: '🏆' },
        { days: 60, title: '2 Months Clean', icon: '💪' },
        { days: 90, title: '3 Months Clean', icon: '🎯' },
        { days: 100, title: '100 Days Clean', icon: '💯' },
        { days: 200, title: '200 Days Clean', icon: '✨' },
        { days: 500, title: '500 Days Clean', icon: '🏆' },
        { days: 1000, title: '1000 Days Clean', icon: '🏅' }
    ];
    
    dayBased.forEach(milestone => {
        const targetDate = new Date(startDate);
        targetDate.setDate(targetDate.getDate() + milestone.days - 1); // ✅ FIXED: Changed from -2 to -1
        
        milestones.push({
            ...milestone,
            date: targetDate,
            targetDate: targetDate,
            achieved: daysSober >= milestone.days,
            isToday: daysSober === milestone.days,
            isTomorrow: daysSober === (milestone.days - 1),
            daysUntil: milestone.days - daysSober,
            type: 'recovery'
        });
    });
    
    // MONTHLY MILESTONES (same day of month)
    const monthBased = [
        { months: 4, title: '4 Months Clean', icon: '⭐' },
        { months: 5, title: '5 Months Clean', icon: '🌈' },
        { months: 6, title: '6 Months Clean', icon: '🎉' },
        { months: 7, title: '7 Months Clean', icon: '🌟' },
        { months: 8, title: '8 Months Clean', icon: '🏅' },
        { months: 9, title: '9 Months Clean', icon: '💎' },
        { months: 10, title: '10 Months Clean', icon: '🌺' },
        { months: 11, title: '11 Months Clean', icon: '🎊' },
        { months: 12, title: '1 Year Clean', icon: '🎂' },
        { months: 18, title: '18 Months Clean', icon: '🌟' }
    ];
    
    monthBased.forEach(milestone => {
        const targetDate = new Date(startYear, (startMonth - 1) + milestone.months, startDay, 0, 0, 0, 0);
        const approxDays = Math.floor((targetDate - startDate) / (1000 * 60 * 60 * 24)) + 2;
        
        milestones.push({
            days: approxDays,
            title: milestone.title,
            icon: milestone.icon,
            date: targetDate,
            targetDate: targetDate,
            achieved: today >= targetDate,
            isToday: today.toDateString() === targetDate.toDateString(),
            isTomorrow: false,
            daysUntil: Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24)),
            type: 'recovery'
        });
    });
    
    // YEARLY MILESTONES (same month & day every year)
    const yearBased = [
        { years: 2, title: '2 Years Clean', icon: '🎈' },
        { years: 3, title: '3 Years Clean', icon: '🎉' },
        { years: 4, title: '4 Years Clean', icon: '🌟' },
        { years: 5, title: '5 Years Clean', icon: '💫' }
    ];
    
    // Add 6-20 years dynamically
    for (let year = 6; year <= 20; year++) {
        yearBased.push({
            years: year,
            title: `${year} Years Clean`,
            icon: '🌟'
        });
    }
    
    yearBased.forEach(milestone => {
        const targetDate = new Date(startYear + milestone.years, startMonth - 1, startDay, 0, 0, 0, 0);
        const approxDays = Math.floor((targetDate - startDate) / (1000 * 60 * 60 * 24)) + 2;
        
        milestones.push({
            days: approxDays,
            title: milestone.title,
            icon: milestone.icon,
            date: targetDate,
            targetDate: targetDate,
            achieved: today >= targetDate,
            isToday: today.toDateString() === targetDate.toDateString(),
            isTomorrow: false,
            daysUntil: Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24)),
            type: 'recovery'
        });
    });
    
    // Sort by target date
    milestones.sort((a, b) => a.targetDate - b.targetDate);
    
    return milestones;
};
   
    // DELETE: Remove PIR's milestone events from Google Calendar
const deletePIRMilestones = async (pirId) => {
    try {
        // Check token first
        const tokenCheck = await checkGoogleToken();
        if (!tokenCheck.valid) {
            console.error('Cannot delete milestones - invalid token');
            return false;
        }
        
        const validToken = user.googleAccessToken;
        
        // Get stored milestone events from Firestore
        const pirDoc = await db.collection('users').doc(pirId).get();
        const events = pirDoc.data()?.milestoneCalendarEvents || [];
        
        if (events.length === 0) {
            console.log('No milestone events to delete');
            return true;
        }
        
        console.log(`Deleting ${events.length} milestone events...`);
        
        let successCount = 0;
        let failCount = 0;
        
        for (const event of events) {
            try {
                const response = await fetch(
                    `https://www.googleapis.com/calendar/v3/calendars/primary/events/${event.eventId}`,
                    {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${validToken}`
                        }
                    }
                );
                
                if (response.ok || response.status === 404) {
                    successCount++;
                    console.log(`✓ Deleted: ${event.eventId}`);
                } else {
                    failCount++;
                    console.error(`✗ Failed to delete: ${event.eventId}`);
                }
            } catch (error) {
                failCount++;
                console.error('Error deleting event:', event.eventId, error);
            }
        }
        
        // Clear the array in Firestore
        await db.collection('users').doc(pirId).update({
            milestoneCalendarEvents: []
        });
        
        console.log(`Deletion complete: ${successCount} deleted, ${failCount} failed`);
        return true;
        
    } catch (error) {
        console.error('Error in deletePIRMilestones:', error);
        return false;
    }
};

// RECREATE: Delete old milestones and create new ones
const recreatePIRMilestones = async (pir) => {
    try {
        // Check token first
        const tokenCheck = await checkGoogleToken();
        if (!tokenCheck.valid) {
            alert('❌ Cannot recreate milestones without Google Calendar\n\n' + tokenCheck.error);
            return false;
        }
        
        console.log('Recreating milestones for:', pir.displayName || pir.email);
        
        // Step 1: Delete old milestones
        const deleted = await deletePIRMilestones(pir.id);
        if (!deleted) {
            console.error('Failed to delete old milestones');
        }
        
        // Step 2: Create new milestones
        await addMilestonesToCoachCalendar(pir, user.googleAccessToken);
        
        return true;
        
    } catch (error) {
        console.error('Error recreating milestones:', error);
        alert('Failed to recreate milestones: ' + error.message);
        return false;
    }
};

// UPDATED: Add milestones WITH event tracking
const addMilestonesToCoachCalendar = async (pir, accessToken) => {
    try {
        if (!pir.sobrietyDate) {
            alert('PIR has no sobriety date set. Cannot calculate milestones.');
            return;
        }
        
        // ✅ CRITICAL: Check Google token FIRST (with auto-refresh)
        const tokenCheck = await checkGoogleToken();
        
        if (!tokenCheck.valid) {
            alert('❌ Cannot add milestones without Google Calendar\n\n' + tokenCheck.error);
            return;
        }
        
        console.log('✓ Google token valid, proceeding with milestone creation...');
        
        // Use the refreshed token
        const validToken = user.googleAccessToken;
        
        console.log('Adding milestones to coach calendar for:', pir.displayName || pir.email);
        
        // Get all milestones
        const milestones = getRecoveryMilestones(pir.sobrietyDate);
        
        // Filter: Only upcoming milestones (not already achieved)
        const upcomingMilestones = milestones.filter(m => !m.achieved);
        
        if (upcomingMilestones.length === 0) {
            alert(`${pir.displayName || 'PIR'} has achieved all defined milestones! 🎉`);
            return;
        }
        
        console.log(`Creating ${upcomingMilestones.length} milestone events...`);
        
        let successCount = 0;
        let failCount = 0;
        const createdEvents = []; // Track created events
        
        for (const milestone of upcomingMilestones) {
            try {
                // Create all-day event on milestone date
                const eventDate = milestone.targetDate.toISOString().split('T')[0]; // YYYY-MM-DD
                
                const event = {
                    summary: `${milestone.icon} ${pir.displayName || 'PIR'} - ${milestone.title}`,
                    description: `Celebrate ${pir.displayName || pir.email}'s milestone!\n\nDays Clean: ${milestone.days}\n\nRemember to acknowledge this achievement!`,
                    start: {
                        date: eventDate,
                        timeZone: 'America/Los_Angeles'
                    },
                    end: {
                        date: eventDate,
                        timeZone: 'America/Los_Angeles'
                    },
                    reminders: {
                        useDefault: false,
                        overrides: [
                            { method: 'email', minutes: 24 * 60 }, // 1 day before
                            { method: 'popup', minutes: 0 } // On the day
                        ]
                    },
                    colorId: '9' // Blue color for milestones
                };
                
                const response = await fetch(
                    'https://www.googleapis.com/calendar/v3/calendars/primary/events',
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${validToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(event)
                    }
                );
                
                if (response.ok) {
                    const createdEvent = await response.json();
                    successCount++;
                    console.log(`✓ Created: ${milestone.title}`);
                    
                    // Track the event
                    createdEvents.push({
                        eventId: createdEvent.id,
                        milestoneDays: milestone.days,
                        milestoneTitle: milestone.title,
                        milestoneDate: eventDate,
                        createdAt: new Date().toISOString()
                    });
                } else {
                    failCount++;
                    const errorData = await response.json().catch(() => ({}));
                    console.error(`✗ Failed: ${milestone.title}`, errorData);
                }
                
            } catch (error) {
                failCount++;
                console.error(`Error creating milestone event:`, error);
            }
        }
        
        // Save tracked events to Firestore
        if (createdEvents.length > 0) {
            try {
                await db.collection('users').doc(pir.id).update({
                    milestoneCalendarEvents: createdEvents,
                    milestonesLastSynced: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log(`✓ Saved ${createdEvents.length} event IDs to Firestore`);
            } catch (error) {
                console.error('Error saving event IDs to Firestore:', error);
            }
        }
        
        // Success message
        if (successCount > 0 && failCount === 0) {
            alert(
                `✅ Success!\n\n` +
                `${successCount} milestone celebration${successCount > 1 ? 's' : ''} added to your calendar!\n\n` +
                `🎉 You'll be reminded to celebrate each milestone with ${pir.displayName || 'your PIR'}!`
            );
        } else if (successCount > 0 && failCount > 0) {
            alert(
                `⚠️ Partial Success\n\n` +
                `✅ ${successCount} milestone${successCount > 1 ? 's' : ''} added\n` +
                `❌ ${failCount} failed\n\n` +
                `Check console for details.`
            );
        } else {
            alert(
                `❌ Failed to add milestones\n\n` +
                `Please check your Google Calendar connection and try again.`
            );
        }
        
    } catch (error) {
        console.error('Error adding milestones to calendar:', error);
        alert('Failed to add milestones: ' + error.message);
    }
};
    const getMilestone = (days) => {
        if (days >= 365) return { label: '1 Year+', color: '#9C27B0', icon: '👑' };
        if (days >= 180) return { label: '6 Months', color: '#673AB7', icon: '💎' };
        if (days >= 90) return { label: '90 Days', color: '#3F51B5', icon: '🌟' };
        if (days >= 60) return { label: '60 Days', color: '#4682B4', icon: '⭐' };
        if (days >= 30) return { label: '30 Days', color: '#00A86B', icon: '🎯' };
        if (days >= 7) return { label: '1 Week', color: '#8BC34A', icon: '✨' };
        return null;
    };

    const renderMiniChart = (pirId, type, data) => {
        const refKey = `${type}-${pirId}`;
        const chartRef = type === 'mood' ? moodChartRefs.current[pirId] : cravingChartRefs.current[pirId];
        
        if (!chartRef) return;
        
        // Destroy existing chart
        if (chartInstances.current[refKey]) {
            chartInstances.current[refKey].destroy();
        }
        
        const ctx = chartRef.getContext('2d');
        chartInstances.current[refKey] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map((_, i) => ''),
                datasets: [{
                    data: data,
                    borderColor: type === 'mood' ? '#00A86B' : '#FF9800',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { display: false, min: 0, max: 10 },
                    x: { display: false }
                },
                plugins: { legend: { display: false } }
            }
        });
    };

    const filterPIRs = () => {
        let filtered = [...myPIRs];
        
        if (activeFilter === 'needsAttention') {
            filtered = filtered.filter(pir => 
                pir.complianceRate < 50 || 
                pir.activeAlerts > 0 ||
                !pir.lastCheckInDate ||
                (pir.lastCheckInDate && daysSince(pir.lastCheckInDate) > 2)
            );
        } else if (activeFilter === 'compliant') {
            filtered = filtered.filter(pir => 
                pir.complianceRate >= 70 && 
                pir.activeAlerts === 0
            );
        }
        
        if (searchQuery) {
            const query = searchQuery.toLowerCase();
            filtered = filtered.filter(pir =>
                pir.email?.toLowerCase().includes(query) ||
                pir.displayName?.toLowerCase().includes(query) ||
                pir.firstName?.toLowerCase().includes(query) ||
                pir.lastName?.toLowerCase().includes(query)
            );
        }
        
        // Sort
        filtered.sort((a, b) => {
            if (sortBy === 'daysClean') return b.daysClean - a.daysClean;
            if (sortBy === 'compliance') return b.complianceRate - a.complianceRate;
            if (sortBy === 'lastCheckIn') {
                const dateA = a.lastCheckInDate?.toDate ? a.lastCheckInDate.toDate() : new Date(0);
                const dateB = b.lastCheckInDate?.toDate ? b.lastCheckInDate.toDate() : new Date(0);
                return dateB - dateA;
            }
            return 0;
        });
        
        setFilteredPIRs(filtered);
    };

    const daysSince = (date) => {
        if (!date) return 999;
        const checkDate = date?.toDate ? date.toDate() : new Date(date);
        return Math.floor((new Date() - checkDate) / (1000 * 60 * 60 * 24));
    };

    const handleSaveNotes = async (pirId, notes) => {
        try {
            await db.collection('pirNotes').doc(`${user.uid}_${pirId}`).set({
                coachId: user.uid,
                pirId: pirId,
                notes: notes,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            setPirNotes(prev => ({ ...prev, [pirId]: notes }));
            alert('Notes saved successfully');
        } catch (error) {
            console.error('Error saving notes:', error);
            alert('Failed to save notes');
        }
    };

    const handleQuickAssignment = async (pirId) => {
        const title = prompt('Assignment Title:');
        if (title) {
            const description = prompt('Assignment Description:');
            const dueDate = prompt('Due Date (YYYY-MM-DD):');
            
            try {
                await db.collection('assignments').add({
                    tenantId: CURRENT_TENANT,
                    userId: pirId,
                    title: title,
                    description: description || '',
                    dueDate: dueDate || '',
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: user.uid
                });
                
                alert('Assignment created successfully!');
            } catch (error) {
                console.error('Error creating assignment:', error);
                alert('Failed to create assignment');
            }
        }
    };

    const handleResolveAlert = async (alertId) => {
        try {
            await db.collection('alerts').doc(alertId).update({
                resolved: true,
                resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                resolvedBy: user.uid
            });
            
            loadMyPIRs();
        } catch (error) {
            console.error('Error resolving alert:', error);
            alert('Failed to resolve alert');
        }
    };

    const handleExportPIRReport = (pir) => {
        const reportData = {
            name: pir.displayName || pir.email,
            email: pir.email,
            daysClean: pir.daysClean,
            complianceRate: `${pir.complianceRate}%`,
            weeklyCheckIns: pir.weeklyCheckIns,
            activeAlerts: pir.activeAlerts,
            lastCheckIn: pir.lastCheckInDate ? formatDateTime(pir.lastCheckInDate) : 'Never',
            lastMood: pir.lastCheckIn?.morningData?.mood || 'N/A',
            lastCraving: pir.lastCheckIn?.morningData?.craving || 'N/A',
            milestone: pir.milestone?.label || 'None',
            notes: pirNotes[pir.id] || 'No notes'
        };
        
        exportToPDF([reportData], `${pir.displayName || 'PIR'} Report`);
    };

    const getStatusColor = (pir) => {
        if (pir.activeAlerts > 0) return '#f44336';
        if (pir.complianceRate < 50) return '#FF9800';
        if (pir.complianceRate >= 70) return '#00A86B';
        return '#FFC107';
    };

    const getStatusLabel = (pir) => {
        if (pir.activeAlerts > 0) return 'Alert';
        if (!pir.lastCheckInDate) return 'No Check-in';
        if (daysSince(pir.lastCheckInDate) > 2) return 'Overdue';
        if (pir.complianceRate >= 70) return 'Good';
        if (pir.complianceRate >= 50) return 'Fair';
        return 'Needs Attention';
    };

    if (loading) {
        return (
            <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                minHeight: '400px',
                gap: '20px'
            }}>
                <div style={{
                    width: '60px',
                    height: '60px',
                    border: '4px solid #f3f3f3',
                    borderTop: '4px solid #0077CC',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite'
                }}></div>
                <p style={{ color: '#666' }}>Loading your PIRs...</p>
            </div>
        );
    }

  return (
    <div style={{ padding: '20px', animation: 'fadeIn 0.5s' }}>
        {/* Enhanced Stats Cards */}
        <div style={{
            display: 'grid',
            gridTemplateColumns: 'repeat(auto-fit, minmax(240px, 1fr))',
            gap: '20px',
            marginBottom: '30px'
        }}>
            <div style={{
                background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                borderRadius: '15px',
                padding: '25px',
                color: 'white',
                boxShadow: '0 4px 15px rgba(102, 126, 234, 0.3)',
                transition: 'transform 0.2s',
                cursor: 'pointer'
            }}
            onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
            onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
            >
                <div style={{ fontSize: '14px', opacity: 0.9 }}>Total PIRs</div>
                <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                    {myPIRs.length}
                </div>
                <div style={{ fontSize: '12px', opacity: 0.8 }}>In your caseload</div>
            </div>

            <div style={{
                background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                borderRadius: '15px',
                padding: '25px',
                color: 'white',
                boxShadow: '0 4px 15px rgba(240, 147, 251, 0.3)',
                transition: 'transform 0.2s',
                cursor: 'pointer'
            }}
            onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
            onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
            >
                <div style={{ fontSize: '14px', opacity: 0.9 }}>Active Alerts</div>
                <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                    {pendingAlerts.length}
                </div>
                <div style={{ fontSize: '12px', opacity: 0.8 }}>Need attention</div>
            </div>

            <div style={{
                background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                borderRadius: '15px',
                padding: '25px',
                color: 'white',
                boxShadow: '0 4px 15px rgba(79, 172, 254, 0.3)',
                transition: 'transform 0.2s',
                cursor: 'pointer'
            }}
            onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
            onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
            >
                <div style={{ fontSize: '14px', opacity: 0.9 }}>Compliant PIRs</div>
                <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                    {myPIRs.filter(p => p.complianceRate >= 70).length}
                </div>
                <div style={{ fontSize: '12px', opacity: 0.8 }}>70%+ compliance</div>
            </div>

            <div style={{
                background: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                borderRadius: '15px',
                padding: '25px',
                color: 'white',
                boxShadow: '0 4px 15px rgba(250, 112, 154, 0.3)',
                transition: 'transform 0.2s',
                cursor: 'pointer'
            }}
            onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
            onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
            >
                <div style={{ fontSize: '14px', opacity: 0.9 }}>Avg Days Clean</div>
                <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                    {Math.round(myPIRs.reduce((acc, p) => acc + p.daysClean, 0) / (myPIRs.length || 1))}
                </div>
                <div style={{ fontSize: '12px', opacity: 0.8 }}>All PIRs average</div>
            </div>
        </div>

        {/* Pending Alerts Banner */}
        {pendingAlerts.length > 0 && (
            <div style={{
                background: 'linear-gradient(135deg, #ff4444, #cc0000)',
                padding: '20px',
                borderRadius: '15px',
                marginBottom: '20px',
                boxShadow: '0 4px 15px rgba(255, 68, 68, 0.4)'
            }}>
                <div style={{ color: 'white', marginBottom: '15px', fontSize: '18px', fontWeight: 'bold', display: 'flex', alignItems: 'center', gap: '10px' }}>
                    <span style={{ fontSize: '24px' }}>⚠️</span>
                    {pendingAlerts.length} Pending Alert{pendingAlerts.length > 1 ? 's' : ''}
                </div>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                    {pendingAlerts.slice(0, 3).map(alert => (
                        <div key={alert.id} style={{
                            background: 'rgba(255,255,255,0.15)',
                            backdropFilter: 'blur(10px)',
                            borderRadius: '10px',
                            padding: '15px',
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            color: 'white'
                        }}>
                            <div>
                                <div style={{ fontWeight: '600', marginBottom: '5px' }}>
                                    {alert.pirName} - {alert.type?.replace('_', ' ')}
                                </div>
                                <div style={{ fontSize: '13px', opacity: 0.9 }}>
                                    {alert.message}
                                </div>
                                <div style={{ fontSize: '11px', opacity: 0.7, marginTop: '5px' }}>
                                    {formatTimeAgo(alert.createdAt)}
                                </div>
                            </div>
                            <button 
                                onClick={() => handleResolveAlert(alert.id)}
                                style={{
                                    padding: '8px 16px',
                                    background: 'white',
                                    color: '#DC143C',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '13px',
                                    fontWeight: '600',
                                    transition: 'transform 0.2s'
                                }}
                                onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.05)'}
                                onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
                            >
                                Resolve
                            </button>
                        </div>
                    ))}
                    {pendingAlerts.length > 3 && (
                        <div style={{ color: 'white', fontSize: '13px', opacity: 0.9, textAlign: 'center' }}>
                            +{pendingAlerts.length - 3} more alerts
                        </div>
                    )}
                </div>
            </div>
        )}

        {/* Filters and Controls */}
        <div style={{
            background: 'white',
            borderRadius: '15px',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
        }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '15px' }}>
                <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                    <button 
                        onClick={() => setActiveFilter('all')}
                        style={{
                            padding: '8px 16px',
                            background: activeFilter === 'all' ? 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)' : '#f0f0f0',
                            color: activeFilter === 'all' ? 'white' : '#666',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500',
                            transition: 'all 0.2s'
                        }}
                    >
                        All ({myPIRs.length})
                    </button>
                    <button 
                        onClick={() => setActiveFilter('needsAttention')}
                        style={{
                            padding: '8px 16px',
                            background: activeFilter === 'needsAttention' ? 'linear-gradient(135deg, #f44336 0%, #e53935 100%)' : '#f0f0f0',
                            color: activeFilter === 'needsAttention' ? 'white' : '#666',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500',
                            transition: 'all 0.2s'
                        }}
                    >
                        Needs Attention ({myPIRs.filter(p => 
                            p.complianceRate < 50 || p.activeAlerts > 0 || daysSince(p.lastCheckInDate) > 2
                        ).length})
                    </button>
                    <button 
                        onClick={() => setActiveFilter('compliant')}
                        style={{
                            padding: '8px 16px',
                            background: activeFilter === 'compliant' ? 'linear-gradient(135deg, #00A86B 0%, #008554 100%)' : '#f0f0f0',
                            color: activeFilter === 'compliant' ? 'white' : '#666',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500',
                            transition: 'all 0.2s'
                        }}
                    >
                        Compliant ({myPIRs.filter(p => p.complianceRate >= 70 && p.activeAlerts === 0).length})
                    </button>
                </div>
                
                <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>
                    <select
                        value={sortBy}
                        onChange={(e) => setSortBy(e.target.value)}
                        style={{
                            padding: '8px 12px',
                            borderRadius: '8px',
                            border: '1px solid #ddd',
                            background: 'white',
                            cursor: 'pointer',
                            fontSize: '14px'
                        }}
                    >
                        <option value="daysClean">Sort by Days Clean</option>
                        <option value="compliance">Sort by Compliance</option>
                        <option value="lastCheckIn">Sort by Last Check-in</option>
                    </select>
                    
                    <button
                        onClick={() => setViewMode(viewMode === 'grid' ? 'list' : 'grid')}
                        style={{
                            padding: '8px 16px',
                            background: '#6c757d',
                            color: 'white',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500'
                        }}
                    >
                        {viewMode === 'grid' ? 'List View' : 'Grid View'}
                    </button>
                </div>
            </div>
        </div>

        {/* PIRs Grid/List */}
        <div style={{
            display: 'grid',
            gridTemplateColumns: viewMode === 'grid' ? 'repeat(auto-fill, minmax(350px, 1fr))' : '1fr',
            gap: '20px',
            marginBottom: '30px'
        }}>
            {filteredPIRs.map(pir => (
                <div key={pir.id} style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '20px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                    borderLeft: `4px solid ${getStatusColor(pir)}`,
                    transition: 'all 0.2s',
                    cursor: 'pointer'
                }}
                onMouseEnter={(e) => {
                    e.currentTarget.style.transform = 'translateY(-5px)';
                    e.currentTarget.style.boxShadow = '0 8px 20px rgba(0,0,0,0.15)';
                }}
                onMouseLeave={(e) => {
                    e.currentTarget.style.transform = 'translateY(0)';
                    e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
                }}
                >
                    {/* Header */}
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '15px' }}>
                        <div style={{ flex: 1 }}>
                            <h4 style={{ margin: '0 0 5px 0', fontSize: '18px', color: '#333' }}>
                                {pir.displayName || pir.email}
                            </h4>
                            <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                                <span style={{
                                    padding: '4px 12px',
                                    borderRadius: '20px',
                                    fontSize: '12px',
                                    fontWeight: '500',
                                    background: getStatusColor(pir),
                                    color: 'white'
                                }}>
                                    {getStatusLabel(pir)}
                                </span>
                                {pir.milestone && (
                                    <span style={{
                                        padding: '4px 12px',
                                        borderRadius: '20px',
                                        fontSize: '12px',
                                        fontWeight: '500',
                                        background: pir.milestone.color,
                                        color: 'white'
                                    }}>
                                        {pir.milestone.icon} {pir.milestone.label}
                                    </span>
                                )}
                            </div>
                        </div>
                        {pir.activeAlerts > 0 && (
                            <div style={{
                                background: '#DC143C',
                                color: 'white',
                                borderRadius: '50%',
                                width: '30px',
                                height: '30px',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '14px',
                                fontWeight: 'bold'
                            }}>
                                {pir.activeAlerts}
                            </div>
                        )}
                    </div>

                    {/* Stats Grid */}
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(2, 1fr)',
                        gap: '10px',
                        marginBottom: '15px',
                        padding: '15px',
                        background: '#f8f9fa',
                        borderRadius: '10px'
                    }}>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '3px' }}>Days Clean</div>
                            <div style={{ fontSize: '20px', fontWeight: 'bold', color: '#333' }}>{pir.daysClean}</div>
                        </div>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '3px' }}>Compliance</div>
                            <div style={{ fontSize: '20px', fontWeight: 'bold', color: getStatusColor(pir) }}>
                                {pir.complianceRate}%
                            </div>
                        </div>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '3px' }}>Last Check-in</div>
                            <div style={{ fontSize: '13px', fontWeight: '500', color: '#666' }}>
                                {pir.lastCheckInDate ? formatTimeAgo(pir.lastCheckInDate) : 'Never'}
                            </div>
                        </div>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '3px' }}>Weekly Check-ins</div>
                            <div style={{ fontSize: '13px', fontWeight: '500', color: '#666' }}>
                                {pir.weeklyCheckIns}/14
                            </div>
                        </div>
                    </div>

                    {/* Trend Charts */}
                    {viewMode === 'grid' && (pir.moodTrend?.length > 0 || pir.cravingTrend?.length > 0) && (
                        <div style={{
                            display: 'grid',
                            gridTemplateColumns: '1fr 1fr',
                            gap: '10px',
                            marginBottom: '15px'
                        }}>
                            {pir.moodTrend?.length > 0 && (
                                <div>
                                    <div style={{ fontSize: '11px', color: '#999', marginBottom: '5px' }}>Mood Trend</div>
                                    <canvas 
                                        ref={el => moodChartRefs.current[pir.id] = el}
                                        style={{ height: '40px' }}
                                    ></canvas>
                                </div>
                            )}
                            {pir.cravingTrend?.length > 0 && (
                                <div>
                                    <div style={{ fontSize: '11px', color: '#999', marginBottom: '5px' }}>Craving Trend</div>
                                    <canvas 
                                        ref={el => cravingChartRefs.current[pir.id] = el}
                                        style={{ height: '40px' }}
                                    ></canvas>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Quick Notes Preview */}
                    {pirNotes[pir.id] && (
                        <div style={{
                            padding: '10px',
                            background: '#fff3cd',
                            borderRadius: '8px',
                            fontSize: '12px',
                            color: '#856404',
                            marginBottom: '15px',
                            maxHeight: '40px',
                            overflow: 'hidden',
                            textOverflow: 'ellipsis'
                        }}>
                            📝 {pirNotes[pir.id]}
                        </div>
                    )}

                    {/* Actions */}
                    <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                        <button
                            onClick={() => setSelectedPIR(pir)}
                            style={{
                                flex: 1,
                                padding: '10px 16px',
                                background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '13px',
                                fontWeight: '500',
                                transition: 'transform 0.2s'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.02)'}
                            onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
                        >
                            View Details
                        </button>
                        
                        <button
                            onClick={async () => {
                                if (!user.googleConnected || !user.googleAccessToken) {
                                    alert('❌ Google Calendar Not Connected\n\nPlease connect Google Services in your Profile to sync milestones!');
                                    return;
                                }
                                await addMilestonesToCoachCalendar(pir, user.googleAccessToken);
                            }}
                            style={{
                                padding: '10px 16px',
                                background: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '13px',
                                fontWeight: '500',
                                transition: 'transform 0.2s'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.02)'}
                            onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
                        >
                            🎉 Calendar
                        </button>
                        
                        <button
                            onClick={() => {
                                setSelectedPIRForNotes(pir);
                                setShowNotesModal(true);
                            }}
                            style={{
                                padding: '10px 16px',
                                background: '#6c757d',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '13px',
                                fontWeight: '500'
                            }}
                        >
                            Notes
                        </button>
                        <button
                            onClick={() => handleQuickAssignment(pir.id)}
                            style={{
                                padding: '10px 16px',
                                background: '#00A86B',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '13px',
                                fontWeight: '500'
                            }}
                        >
                            + Task
                        </button>
                        <button
                            onClick={() => handleExportPIRReport(pir)}
                            style={{
                                padding: '10px 16px',
                                background: '#FFA500',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '13px',
                                fontWeight: '500'
                            }}
                        >
                            Export
                        </button>
                    </div>
                </div>
            ))}
        </div>

        {filteredPIRs.length === 0 && (
            <div style={{
                padding: '60px 20px',
                textAlign: 'center',
                background: 'white',
                borderRadius: '15px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <div style={{ fontSize: '48px', marginBottom: '15px' }}>👥</div>
                <div style={{ fontSize: '18px', fontWeight: '500', color: '#333', marginBottom: '8px' }}>
                    {myPIRs.length === 0 ? 'No PIRs Assigned' : 'No PIRs Match Filters'}
                </div>
                <div style={{ fontSize: '14px', color: '#999' }}>
                    {myPIRs.length === 0 
                        ? 'PIRs will appear here when assigned to you' 
                        : 'Try adjusting your filters'}
                </div>
            </div>
        )}

        {/* Recent Check-ins Section */}
        {recentCheckIns.length > 0 && (
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '25px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                marginTop: '30px'
            }}>
                <h3 style={{ margin: '0 0 20px 0', color: '#333' }}>Recent Check-ins</h3>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                    {recentCheckIns.map(checkIn => (
                        <div key={checkIn.id} style={{
                            padding: '15px',
                            background: '#f8f9fa',
                            borderRadius: '10px',
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center'
                        }}>
                            <div>
                                <div style={{ fontWeight: '600', color: '#333', marginBottom: '5px' }}>
                                    {checkIn.pirName}
                                </div>
                                <div style={{ fontSize: '13px', color: '#666', display: 'flex', gap: '15px' }}>
                                    <span>Mood: {checkIn.morningData?.mood || '--'}/10</span>
                                    <span>Craving: {checkIn.morningData?.craving || '--'}/10</span>
                                    {checkIn.attendedMeeting && <span style={{ color: '#00A86B' }}>✓ Meeting</span>}
                                </div>
                            </div>
                            <div style={{ fontSize: '12px', color: '#999' }}>
                                {formatTimeAgo(checkIn.createdAt)}
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        )}

        {/* Notes Modal */}
        {showNotesModal && selectedPIRForNotes && (
            <PIRNotesModal
                pir={selectedPIRForNotes}
                existingNotes={pirNotes[selectedPIRForNotes.id] || ''}
                onClose={() => {
                    setShowNotesModal(false);
                    setSelectedPIRForNotes(null);
                }}
                onSave={(notes) => {
                    handleSaveNotes(selectedPIRForNotes.id, notes);
                    setShowNotesModal(false);
                    setSelectedPIRForNotes(null);
                }}
            />
        )}

        {/* PIR Detail Modal */}
        {selectedPIR && (
            <UserDetailModal
                user={selectedPIR}
                onClose={() => setSelectedPIR(null)}
                onUpdate={() => {
                    setSelectedPIR(null);
                    loadMyPIRs();
                }}
                currentUserId={user.uid}
            />
        )}
    </div>
);
  }  
// PIR Notes Modal Component
function PIRNotesModal({ pir, existingNotes, onClose, onSave }) {
    const [notes, setNotes] = useState(existingNotes);

    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000,
            padding: '20px',
            animation: 'fadeIn 0.2s'
        }}>
            <div style={{
                background: 'white',
                borderRadius: '20px',
                maxWidth: '600px',
                width: '100%',
                boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
                animation: 'slideUp 0.3s'
            }}>
                {/* Header */}
                <div style={{
                    background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                    padding: '25px 30px',
                    borderRadius: '20px 20px 0 0',
                    color: 'white'
                }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <h2 style={{ margin: 0, fontSize: '24px' }}>
                            Notes for {pir.displayName || pir.email}
                        </h2>
                        <button 
                            onClick={onClose}
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                border: 'none',
                                color: 'white',
                                fontSize: '24px',
                                width: '36px',
                                height: '36px',
                                borderRadius: '50%',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center'
                            }}
                        >
                            ×
                        </button>
                    </div>
                </div>

                {/* Content */}
                <div style={{ padding: '30px' }}>
                    <textarea
                        value={notes}
                        onChange={(e) => setNotes(e.target.value)}
                        placeholder="Add private notes about this PIR..."
                        style={{
                            width: '100%',
                            minHeight: '200px',
                            padding: '15px',
                            border: '2px solid #e0e0e0',
                            borderRadius: '10px',
                            fontSize: '14px',
                            fontFamily: 'inherit',
                            resize: 'vertical',
                            marginBottom: '20px'
                        }}
                    />

                    <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                        <button
                            onClick={onClose}
                            style={{
                                padding: '12px 24px',
                                background: '#6c757d',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '500'
                            }}
                        >
                            Cancel
                        </button>
                        <button
                            onClick={() => onSave(notes)}
                            style={{
                                padding: '12px 24px',
                                background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '500'
                            }}
                        >
                            Save Notes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
}
// COMPLETE ENHANCED CommunityView - WITH SUPPORT GROUP CALENDAR INTEGRATION
function CommunityView({ searchQuery, user }) {
    const [activeTab, setActiveTab] = useState('analytics');
    const [loading, setLoading] = useState(true);
    const [createType, setCreateType] = useState('room');
    const [messages, setMessages] = useState([]);
    const [topicRooms, setTopicRooms] = useState([]);
    const [flaggedMessages, setFlaggedMessages] = useState([]);
    const [supportGroups, setSupportGroups] = useState([]);
    const [meetings, setMeetings] = useState([]);
    const [selectedRoom, setSelectedRoom] = useState('main');
    const [newMessage, setNewMessage] = useState('');
    const [showCreateModal, setShowCreateModal] = useState(false);
    const [selectedItem, setSelectedItem] = useState(null);
    const [selectedImage, setSelectedImage] = useState(null);
    const [messageListener, setMessageListener] = useState(null);
    const [pinnedMessages, setPinnedMessages] = useState([]);
    const [messageReactions, setMessageReactions] = useState({});
    const [chatSearch, setChatSearch] = useState('');
    const [filteredMessages, setFilteredMessages] = useState([]);
    const [onlineUsers, setOnlineUsers] = useState(new Set());
    const [typingUsers, setTypingUsers] = useState(new Set());
    const [moderationKeywords, setModerationKeywords] = useState([]);
    const [userWarnings, setUserWarnings] = useState({});
    const [moderationHistory, setModerationHistory] = useState([]);
    const [selectedMeeting, setSelectedMeeting] = useState(null);
    const [attendanceData, setAttendanceData] = useState({});
    const [showAttendanceModal, setShowAttendanceModal] = useState(false);
    const [viewMode, setViewMode] = useState('messages');
    const [selectedThread, setSelectedThread] = useState(null);
    
    const activityChartRef = useRef(null);
    const sentimentChartRef = useRef(null);
    const engagementChartRef = useRef(null);
    const chartInstances = useRef({});
    
    const [stats, setStats] = useState({
        totalMessages: 0,
        activeUsers: 0,
        flaggedCount: 0,
        roomsCount: 0,
        supportGroupsCount: 0,
        meetingsCount: 0,
        todayMessages: 0,
        weekMessages: 0,
        avgMessagesPerUser: 0,
        topContributors: [],
        engagementRate: 0
    });

    const [analyticsData, setAnalyticsData] = useState({
        activityByHour: [],
        activityByDay: [],
        roomEngagement: [],
        sentimentTrend: [],
        topContributors: [],
        messageVolume: []
    });

    useEffect(() => {
        loadCommunityData();
        loadModerationKeywords();
        setupPresenceListener();
        
        return () => {
            if (messageListener) messageListener();
            if (chartInstances.current.activity) chartInstances.current.activity.destroy();
            if (chartInstances.current.sentiment) chartInstances.current.sentiment.destroy();
            if (chartInstances.current.engagement) chartInstances.current.engagement.destroy();
        };
    }, []);

    useEffect(() => {
        if (selectedRoom) {
            loadMessages(selectedRoom);
            loadPinnedMessages(selectedRoom);
        }
    }, [selectedRoom]);

    useEffect(() => {
        filterMessages();
    }, [messages, chatSearch]);

    useEffect(() => {
        if (analyticsData.activityByHour.length > 0) {
            renderAnalyticsCharts();
        }
    }, [analyticsData]);

    const setupPresenceListener = () => {
        const presenceRef = db.collection('presence');
        
        presenceRef.where('online', '==', true).onSnapshot(snapshot => {
            const online = new Set();
            snapshot.forEach(doc => {
                online.add(doc.id);
            });
            setOnlineUsers(online);
        });
    };

    const loadModerationKeywords = async () => {
        try {
            const keywordsDoc = await db.collection('settings').doc('moderation').get();
            if (keywordsDoc.exists) {
                setModerationKeywords(keywordsDoc.data().keywords || []);
            }
        } catch (error) {
            console.error('Error loading moderation keywords:', error);
        }
    };

    const loadCommunityData = async () => {
        try {
            setLoading(true);

            // Load rooms
            const roomsSnap = await db.collection('topicRooms').where('tenantId', '==', CURRENT_TENANT).get();
            const roomsData = [];
            for (const doc of roomsSnap.docs) {
                const roomData = { id: doc.id, ...doc.data() };
                
                // Get message count
                const messagesCount = await db.collection('messages')
                    .where('tenantId', '==', CURRENT_TENANT)
                    .where('roomId', '==', doc.id)
                    .get();
                roomData.messageCount = messagesCount.size;
                
                roomsData.push(roomData);
            }
            setTopicRooms(roomsData);

            // Load support groups
            const supportGroupsSnap = await db.collection('supportGroups')
                .where('tenantId', '==', CURRENT_TENANT)
                .orderBy('createdAt', 'desc')
                .get();
            const supportGroupsData = [];
            supportGroupsSnap.forEach(doc => {
                supportGroupsData.push({ id: doc.id, ...doc.data() });
            });
            setSupportGroups(supportGroupsData);

            // Load meetings
            const meetingsSnap = await db.collection('meetings')
                .where('tenantId', '==', CURRENT_TENANT)
                .where('coachId', '==', user.uid)
                .orderBy('scheduledTime', 'desc')
                .limit(50)
                .get();
            
            const meetingsData = [];
            for (const doc of meetingsSnap.docs) {
                const meetingData = { id: doc.id, ...doc.data() };
                
                if (meetingData.assignedPIRs && meetingData.assignedPIRs.length > 0) {
                    const pirNames = [];
                    for (const pirId of meetingData.assignedPIRs) {
                        const pirDoc = await db.collection('users').doc(pirId).get();
                        if (pirDoc.exists) {
                            const pirData = pirDoc.data();
                            pirNames.push(pirData.displayName || pirData.email);
                        }
                    }
                    meetingData.pirNames = pirNames;
                }
                
                // Load attendance data
                const attendanceSnap = await db.collection('meetingAttendance')
                    .where('tenantId', '==', CURRENT_TENANT)
                    .where('meetingId', '==', doc.id)
                    .get();
                meetingData.attendanceCount = attendanceSnap.size;
                
                meetingsData.push(meetingData);
            }
            setMeetings(meetingsData);

            // Load flagged messages
            const flaggedSnap = await db.collection('messages')
                .where('tenantId', '==', CURRENT_TENANT)
                .where('flagged', '==', true)
                .where('resolved', '==', false)
                .orderBy('flaggedAt', 'desc')
                .limit(20)
                .get();

            const flaggedData = [];
            for (const doc of flaggedSnap.docs) {
                const messageData = { id: doc.id, ...doc.data() };
                
                if (messageData.userId) {
                    const userDoc = await db.collection('users').doc(messageData.userId).get();
                    if (userDoc.exists) {
                        messageData.userName = userDoc.data().displayName || userDoc.data().email;
                    }
                }
                
                flaggedData.push(messageData);
            }
            setFlaggedMessages(flaggedData);

            // Load moderation history
            const moderationSnap = await db.collection('moderationActions')
                .where('tenantId', '==', CURRENT_TENANT)
                .orderBy('timestamp', 'desc')
                .limit(50)
                .get();
            
            const moderationData = [];
            moderationSnap.forEach(doc => {
                moderationData.push({ id: doc.id, ...doc.data() });
            });
            setModerationHistory(moderationData);

            // Load user warnings
            const warningsSnap = await db.collection('userWarnings').where('tenantId', '==', CURRENT_TENANT).get();
            const warnings = {};
            warningsSnap.forEach(doc => {
                warnings[doc.id] = doc.data().warnings || [];
            });
            setUserWarnings(warnings);

            // Calculate comprehensive stats
            await calculateStats(roomsData, supportGroupsData, meetingsData);
            await calculateAnalytics();

        } catch (error) {
            console.error('Error loading community data:', error);
        } finally {
            setLoading(false);
        }
    };

    const calculateStats = async (rooms, groups, meets) => {
        try {
            // Get all messages for analysis
            const allMessagesSnap = await db.collection('messages')
                .where('tenantId', '==', CURRENT_TENANT)
                .orderBy('createdAt', 'desc')
                .limit(1000)
                .get();

            const allMessages = [];
            const uniqueUsers = new Set();
            const userMessageCounts = {};
            
            const now = new Date();
            const todayStart = new Date(now.setHours(0, 0, 0, 0));
            const weekStart = new Date(now.setDate(now.getDate() - 7));
            
            let todayCount = 0;
            let weekCount = 0;

            allMessagesSnap.forEach(doc => {
                const msg = doc.data();
                allMessages.push(msg);
                
                if (msg.userId) {
                    uniqueUsers.add(msg.userId);
                    userMessageCounts[msg.userId] = (userMessageCounts[msg.userId] || 0) + 1;
                }
                
                const msgDate = msg.createdAt?.toDate ? msg.createdAt.toDate() : new Date(msg.createdAt);
                if (msgDate >= todayStart) todayCount++;
                if (msgDate >= weekStart) weekCount++;
            });

            // Top contributors
            const topContributors = Object.entries(userMessageCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([userId, count]) => ({ userId, count }));

            // Load user names for top contributors
            for (const contributor of topContributors) {
                const userDoc = await db.collection('users').doc(contributor.userId).get();
                if (userDoc.exists) {
                    contributor.userName = userDoc.data().displayName || userDoc.data().email;
                }
            }

            const totalMessages = allMessages.length;

            const engagementRate = uniqueUsers.size > 0 
                ? Math.round((totalMessages / uniqueUsers.size) * 10) / 10 
                : 0;

            setStats({
                totalMessages: totalMessages,
                activeUsers: uniqueUsers.size,
                flaggedCount: flaggedMessages.length,
                roomsCount: rooms.length,
                supportGroupsCount: groups.length,
                meetingsCount: meets.length,
                todayMessages: todayCount,
                weekMessages: weekCount,
                avgMessagesPerUser: engagementRate,
                topContributors: topContributors,
                engagementRate: engagementRate
            });

        } catch (error) {
            console.error('Error calculating stats:', error);
        }
    };

    const calculateAnalytics = async () => {
        try {
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

            const messagesSnap = await db.collection('messages')
                .where('tenantId', '==', CURRENT_TENANT)
                .where('createdAt', '>=', sevenDaysAgo)
                .get();

            // Activity by hour (0-23)
            const hourlyActivity = new Array(24).fill(0);
            
            // Activity by day
            const dailyActivity = {};
            
            // Room engagement
            const roomEngagement = {};
            
            // Sentiment trend
            const sentimentByDay = {};

            messagesSnap.forEach(doc => {
                const msg = doc.data();
                const date = msg.createdAt?.toDate ? msg.createdAt.toDate() : new Date(msg.createdAt);
                
                // Hour analysis
                hourlyActivity[date.getHours()]++;
                
                // Day analysis
                const dayKey = date.toISOString().split('T')[0];
                dailyActivity[dayKey] = (dailyActivity[dayKey] || 0) + 1;
                
                // Room engagement
                roomEngagement[msg.roomId] = (roomEngagement[msg.roomId] || 0) + 1;
                
                // Sentiment by day
                const content = (msg.content || '').toLowerCase();
                const isPositive = ['great', 'good', 'thanks', 'helpful', 'love'].some(w => content.includes(w));
                const isNegative = ['bad', 'worst', 'hate', 'terrible', 'awful'].some(w => content.includes(w));
                
                if (!sentimentByDay[dayKey]) sentimentByDay[dayKey] = { positive: 0, negative: 0, neutral: 0 };
                if (isPositive) sentimentByDay[dayKey].positive++;
                else if (isNegative) sentimentByDay[dayKey].negative++;
                else sentimentByDay[dayKey].neutral++;
            });

            setAnalyticsData({
                activityByHour: hourlyActivity,
                activityByDay: Object.entries(dailyActivity).map(([day, count]) => ({ day, count })),
                roomEngagement: Object.entries(roomEngagement).map(([room, count]) => ({ room, count })),
                sentimentTrend: Object.entries(sentimentByDay).map(([day, data]) => ({ day, ...data })),
                messageVolume: Object.entries(dailyActivity).map(([day, count]) => ({ day, count }))
            });

        } catch (error) {
            console.error('Error calculating analytics:', error);
        }
    };

    const renderAnalyticsCharts = () => {
        // Activity by Hour Chart
        if (activityChartRef.current) {
            if (chartInstances.current.activity) {
                chartInstances.current.activity.destroy();
            }
            
            const ctx = activityChartRef.current.getContext('2d');
            chartInstances.current.activity = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: [{
                        label: 'Messages',
                        data: analyticsData.activityByHour,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: '#0077CC',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // Sentiment Trend Chart
        if (sentimentChartRef.current && analyticsData.sentimentTrend.length > 0) {
            if (chartInstances.current.sentiment) {
                chartInstances.current.sentiment.destroy();
            }
            
            const ctx = sentimentChartRef.current.getContext('2d');
            chartInstances.current.sentiment = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: analyticsData.sentimentTrend.map(d => new Date(d.day).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                    datasets: [
                        {
                            label: 'Positive',
                            data: analyticsData.sentimentTrend.map(d => d.positive),
                            borderColor: '#00A86B',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Negative',
                            data: analyticsData.sentimentTrend.map(d => d.negative),
                            borderColor: '#f44336',
                            backgroundColor: 'rgba(244, 67, 54, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Room Engagement Chart
        if (engagementChartRef.current && analyticsData.roomEngagement.length > 0) {
            if (chartInstances.current.engagement) {
                chartInstances.current.engagement.destroy();
            }
            
            const ctx = engagementChartRef.current.getContext('2d');
            const roomNames = analyticsData.roomEngagement.map(r => {
                if (r.room === 'main') return 'Main Chat';
                const room = topicRooms.find(tr => tr.id === r.room);
                return room?.name || 'Unknown';
            });
            
            chartInstances.current.engagement = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: roomNames,
                    datasets: [{
                        data: analyticsData.roomEngagement.map(r => r.count),
                        backgroundColor: [
                            '#0077CC',
                            '#f093fb',
                            '#4facfe',
                            '#fa709a',
                            '#43e97b',
                            '#38f9d7'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
    };

    const loadMessages = async (roomId) => {
        if (messageListener) {
            messageListener();
        }

        const listener = db.collection('messages')
            .where('tenantId', '==', CURRENT_TENANT)
            .where('roomId', '==', roomId)
            .orderBy('createdAt', 'desc')
            .limit(100)
            .onSnapshot(async snapshot => {
                const messagesData = [];
                
                for (const doc of snapshot.docs) {
                    const messageData = { id: doc.id, ...doc.data() };
                    
                    if (messageData.userId) {
                        const userDoc = await db.collection('users').doc(messageData.userId).get();
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            messageData.userName = userData.displayName || userData.email;
                            messageData.userRole = userData.role;
                        }
                    }
                    
                    // Load reactions
                    const reactionsSnap = await db.collection('messageReactions')
                        .where('tenantId', '==', CURRENT_TENANT)
                        .where('messageId', '==', doc.id)
                        .get();
                    
                    const reactions = {};
                    reactionsSnap.forEach(reactionDoc => {
                        const data = reactionDoc.data();
                        if (!reactions[data.emoji]) {
                            reactions[data.emoji] = [];
                        }
                        reactions[data.emoji].push(data.userId);
                    });
                    messageData.reactions = reactions;
                    
                    // Load replies count
                    const repliesSnap = await db.collection('messages')
                        .where('tenantId', '==', CURRENT_TENANT)
                        .where('parentId', '==', doc.id)
                        .get();
                    messageData.repliesCount = repliesSnap.size;
                    
                    messagesData.push(messageData);
                }
                
                setMessages(messagesData);
            });

        setMessageListener(() => listener);
    };

    const loadPinnedMessages = async (roomId) => {
        try {
            const pinnedSnap = await db.collection('messages')
                .where('tenantId', '==', CURRENT_TENANT)
                .where('roomId', '==', roomId)
                .where('pinned', '==', true)
                .orderBy('pinnedAt', 'desc')
                .get();
            
            const pinned = [];
            for (const doc of pinnedSnap.docs) {
                const msgData = { id: doc.id, ...doc.data() };
                
                if (msgData.userId) {
                    const userDoc = await db.collection('users').doc(msgData.userId).get();
                    if (userDoc.exists) {
                        msgData.userName = userDoc.data().displayName || userDoc.data().email;
                    }
                }
                
                pinned.push(msgData);
            }
            setPinnedMessages(pinned);
        } catch (error) {
            console.error('Error loading pinned messages:', error);
        }
    };

    const filterMessages = () => {
        if (!chatSearch) {
            setFilteredMessages(messages);
            return;
        }
        
        const query = chatSearch.toLowerCase();
        const filtered = messages.filter(msg =>
            msg.content?.toLowerCase().includes(query) ||
            msg.userName?.toLowerCase().includes(query)
        );
        setFilteredMessages(filtered);
    };

    const handleSendMessage = async () => {
        if (!newMessage.trim()) return;

        try {
            // Check for moderation keywords
            const lowerMessage = newMessage.toLowerCase();
            const hasBlockedKeyword = moderationKeywords.some(keyword => 
                lowerMessage.includes(keyword.toLowerCase())
            );

            if (hasBlockedKeyword) {
                alert('Your message contains inappropriate content and cannot be sent.');
                return;
            }

            await db.collection('messages').add({
                tenantId: CURRENT_TENANT,
                roomId: selectedRoom,
                userId: user.uid,
                content: newMessage,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                edited: false,
                flagged: false,
                resolved: false,
                fromAdmin: true,
                pinned: false,
                parentId: selectedThread
            });

            setNewMessage('');
            setSelectedThread(null);
        } catch (error) {
            console.error('Error sending message:', error);
            alert('Failed to send message');
        }
    };

    const handleReaction = async (messageId, emoji) => {
        try {
            const reactionRef = db.collection('messageReactions')
                .doc(`${messageId}_${user.uid}_${emoji}`);
            
            const reactionDoc = await reactionRef.get();
            
            if (reactionDoc.exists) {
                await reactionRef.delete();
            } else {
                await reactionRef.set({
                    messageId: messageId,
                    userId: user.uid,
                    emoji: emoji,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        } catch (error) {
            console.error('Error handling reaction:', error);
        }
    };

    const handlePinMessage = async (messageId, isPinned) => {
        try {
            await db.collection('messages').doc(messageId).update({
                pinned: !isPinned,
                pinnedAt: !isPinned ? firebase.firestore.FieldValue.serverTimestamp() : null,
                pinnedBy: !isPinned ? user.uid : null
            });
            
            loadPinnedMessages(selectedRoom);
        } catch (error) {
            console.error('Error pinning message:', error);
        }
    };

    const handleDeleteMessage = async (messageId) => {
        if (confirm('Delete this message permanently?')) {
            try {
                await db.collection('messages').doc(messageId).delete();
                
                // Log moderation action
                await db.collection('moderationActions').add({
                    tenantId: CURRENT_TENANT,
                    action: 'delete',
                    messageId: messageId,
                    moderatorId: user.uid,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('Message deleted');
            } catch (error) {
                console.error('Error deleting message:', error);
                alert('Failed to delete message');
            }
        }
    };

    const handleWarnUser = async (userId, reason) => {
        try {
            const warningData = {
                userId: userId,
                reason: reason,
                issuedBy: user.uid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection('userWarnings').doc(userId).set({
                warnings: firebase.firestore.FieldValue.arrayUnion(warningData)
            }, { merge: true });
            
            // Log moderation action
            await db.collection('moderationActions').add({
                tenantId: CURRENT_TENANT,
                action: 'warn',
                userId: userId,
                reason: reason,
                moderatorId: user.uid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            alert('Warning issued');
            loadCommunityData();
        } catch (error) {
            console.error('Error warning user:', error);
            alert('Failed to issue warning');
        }
    };

    const handleFlagResolve = async (messageId, action) => {
        try {
            if (action === 'delete') {
                await db.collection('messages').doc(messageId).delete();
            } else if (action === 'unflag') {
                await db.collection('messages').doc(messageId).update({
                    flagged: false,
                    resolved: true,
                    resolvedBy: user.uid,
                    resolvedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            // Log action
            await db.collection('moderationActions').add({
                tenantId: CURRENT_TENANT,
                action: action,
                messageId: messageId,
                moderatorId: user.uid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            loadCommunityData();
        } catch (error) {
            console.error('Error resolving flag:', error);
            alert('Failed to resolve flag');
        }
    };

    const handleCreateRoom = async (roomData) => {
        try {
            await db.collection('topicRooms').add({
                tenantId: CURRENT_TENANT,
                ...roomData,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: user.uid,
                active: true,
                messageCount: 0
            });

            alert('Topic room created successfully!');
            setShowCreateModal(false);
            setSelectedItem(null);
            loadCommunityData();
        } catch (error) {
            console.error('Error creating room:', error);
            alert('Failed to create room');
        }
    };

    const handleToggleRoom = async (roomId, currentStatus) => {
        try {
            await db.collection('topicRooms').doc(roomId).update({
                active: !currentStatus
            });
            loadCommunityData();
        } catch (error) {
            console.error('Error toggling room:', error);
        }
    };

    const handleDeleteRoom = async (roomId) => {
        if (confirm('Delete this topic room?')) {
            try {
                await db.collection('topicRooms').doc(roomId).delete();
                alert('Room deleted');
                loadCommunityData();
            } catch (error) {
                console.error('Error deleting room:', error);
            }
        }
    };

    // NEW: Helper to calculate next occurrence of a day
    const getNextDayOfWeek = (dayName, time) => {
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const targetDay = days.indexOf(dayName);
        
        if (targetDay === -1) {
            throw new Error('Invalid day name');
        }
        
        const now = new Date();
        const currentDay = now.getDay();
        
        // Calculate days until target day
        let daysUntilTarget = targetDay - currentDay;
        if (daysUntilTarget <= 0) {
            daysUntilTarget += 7; // Next week
        }
        
        // Create date for next occurrence
        const nextDate = new Date(now);
        nextDate.setDate(now.getDate() + daysUntilTarget);
        
        // Set time
        const [hours, minutes] = time.split(':');
        nextDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
        
        return nextDate;
    };

    // NEW: Create Google Calendar event for Support Group
    const createSupportGroupCalendarEvent = async (groupData, pirId, accessToken) => {
        try {
            // Calculate next occurrence
            const startDateTime = getNextDayOfWeek(groupData.day, groupData.time);
            
            // End time is 1 hour after start (default for support groups)
            const endDateTime = new Date(startDateTime);
            endDateTime.setHours(endDateTime.getHours() + 1);
            
            // Build description
            let description = groupData.description || '';
            if (groupData.location) {
                description += `\n\nLocation: ${groupData.location}`;
            }
            if (groupData.link) {
                description += `\n\nVirtual Meeting Link: ${groupData.link}`;
            }
            
            const event = {
                summary: `${groupData.type} - ${groupData.name}`,
                description: description,
                location: groupData.location || '',
                start: {
                    dateTime: startDateTime.toISOString(),
                    timeZone: 'America/Los_Angeles'
                },
                end: {
                    dateTime: endDateTime.toISOString(),
                    timeZone: 'America/Los_Angeles'
                },
                recurrence: [
                    'RRULE:FREQ=WEEKLY' // Repeats weekly
                ],
                reminders: {
                    useDefault: false,
                    overrides: [
                        { method: 'popup', minutes: 30 },
                        { method: 'email', minutes: 60 }
                    ]
                }
            };
            
            console.log('Creating support group calendar event for PIR:', pirId);
            
            // Get PIR's Google access token
            const pirDoc = await db.collection('users').doc(pirId).get();
            if (!pirDoc.exists) {
                throw new Error('PIR not found');
            }
            
            const pirData = pirDoc.data();
            const pirAccessToken = pirData.googleAccessToken || accessToken;
            
            if (!pirAccessToken) {
                console.warn('PIR does not have Google connected, skipping calendar event');
                return null;
            }
            
            // Make API request to PIR's calendar
            const response = await fetch(
                'https://www.googleapis.com/calendar/v3/calendars/primary/events',
                {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${pirAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(event)
                }
            );
            
            if (!response.ok) {
                const error = await response.json();
                console.error('Google Calendar API error for PIR:', error);
                throw new Error('Failed to create calendar event for PIR');
            }
            
            const createdEvent = await response.json();
            console.log('✓ Calendar event created for PIR:', pirId);
            
            return {
                eventId: createdEvent.id,
                htmlLink: createdEvent.htmlLink,
                pirId: pirId
            };
            
        } catch (error) {
            console.error('Error creating support group calendar event:', error);
            return null;
        }
    };

    // UPDATED: Handle Create Support Group with Calendar Integration
    const handleCreateSupportGroup = async (groupData) => {
        try {
            console.log('Creating support group with data:', groupData);
            
            // Save support group to Firebase first
            const groupDoc = await db.collection('supportGroups').add({
                tenantId: CURRENT_TENANT,
                ...groupData,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: user.uid,
                active: true
            });
            
            console.log('✓ Support group saved to Firebase:', groupDoc.id);
            
            // If there are assigned PIRs and coach has Google connected, create calendar events
            if (groupData.assignedPIRs && groupData.assignedPIRs.length > 0 && user.googleConnected) {
                console.log(`Creating calendar events for ${groupData.assignedPIRs.length} PIRs...`);
                
                const calendarEvents = [];
                let successCount = 0;
                let failCount = 0;
                
                for (const pirId of groupData.assignedPIRs) {
                    try {
                        const eventData = await createSupportGroupCalendarEvent(
                            groupData,
                            pirId,
                            user.googleAccessToken
                        );
                        
                        if (eventData) {
                            calendarEvents.push(eventData);
                            successCount++;
                        } else {
                            failCount++;
                        }
                    } catch (error) {
                        console.error(`Failed to create calendar event for PIR ${pirId}:`, error);
                        failCount++;
                    }
                }
                
                // Save calendar event IDs to the support group document
                if (calendarEvents.length > 0) {
                    await db.collection('supportGroups').doc(groupDoc.id).update({
                        googleCalendarEvents: calendarEvents
                    });
                    
                    console.log(`✓ Created ${successCount} calendar events`);
                }
                
                // Show summary
                if (successCount > 0 && failCount === 0) {
                    alert(
                        `✅ Support group created successfully!\n\n` +
                        `📅 Added to ${successCount} PIR calendar(s)\n` +
                        `🔁 Repeats: Weekly on ${groupData.day}s\n` +
                        `🕐 Time: ${groupData.time} PT`
                    );
                } else if (successCount > 0 && failCount > 0) {
                    alert(
                        `⚠️ Support group created!\n\n` +
                        `✅ Added to ${successCount} calendar(s)\n` +
                        `❌ Failed for ${failCount} PIR(s)\n\n` +
                        `(Some PIRs may not have Google Calendar connected)`
                    );
                } else if (failCount > 0) {
                    alert(
                        `✅ Support group created!\n\n` +
                        `⚠️ Calendar events could not be created.\n` +
                        `PIRs may need to connect their Google Calendar.`
                    );
                }
            } else {
                // No calendar integration
                if (!user.googleConnected) {
                    alert(
                        `✅ Support group created!\n\n` +
                        `⚠️ Connect Google Services in your Profile to automatically\n` +
                        `add support groups to PIR calendars.`
                    );
                } else {
                    alert('✅ Support group created successfully!');
                }
            }
            
            setShowCreateModal(false);
            setSelectedItem(null);
            loadCommunityData();
            
        } catch (error) {
            console.error('Error creating support group:', error);
            alert('Failed to create support group: ' + error.message);
        }
    };

    // AUTO-REFRESH: Silently refresh Google token if expired
    const refreshGoogleToken = async () => {
        return new Promise((resolve, reject) => {
            try {
                console.log('Attempting to refresh Google token...');
                
                // Check if Google Identity Services is loaded
                if (typeof google === 'undefined' || !google.accounts) {
                    reject(new Error('Google Identity Services not loaded'));
                    return;
                }
                
                // Use token client to get new token silently
                const tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: '457406864879-k1sunucuqofe22m5rg93hvo6nngiqh0u.apps.googleusercontent.com',
                    scope: [
                        'https://www.googleapis.com/auth/calendar.events',
                        'https://www.googleapis.com/auth/drive.file',
                        'https://www.googleapis.com/auth/gmail.send'
                    ].join(' '),
                    callback: async (tokenResponse) => {
                        try {
                            if (tokenResponse.error) {
                                reject(new Error(tokenResponse.error));
                                return;
                            }
                            
                            if (tokenResponse.access_token) {
                                // Update Firebase with new token
                                await db.collection('users').doc(user.uid).update({
                                    googleAccessToken: tokenResponse.access_token,
                                    googleTokenExpiry: Date.now() + (tokenResponse.expires_in * 1000),
                                    googleTokenRefreshedAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                
                                console.log('✓ Token refreshed successfully');
                                
                                // Update local user object
                                user.googleAccessToken = tokenResponse.access_token;
                                user.googleTokenExpiry = Date.now() + (tokenResponse.expires_in * 1000);
                                
                                resolve(tokenResponse.access_token);
                            } else {
                                reject(new Error('No access token received'));
                            }
                        } catch (error) {
                            reject(error);
                        }
                    },
                });
                
                // Request new token (will try silently first with prompt: '')
                tokenClient.requestAccessToken({ prompt: '' });
                
            } catch (error) {
                console.error('Failed to refresh token:', error);
                reject(error);
            }
        });
    };

    // Check if Google token is valid and auto-refresh if needed
    const checkGoogleToken = async () => {
        // Check if user has Google connected
        if (!user.googleConnected || !user.googleAccessToken) {
            return {
                valid: false,
                error: 'Google Services not connected. Please connect Google in your Profile settings.'
            };
        }
        
        // Check if token is expired
        if (user.googleTokenExpiry) {
            const now = Date.now();
            const expiryTime = user.googleTokenExpiry;
            const fiveMinutes = 5 * 60 * 1000;
            
            if (now >= expiryTime - fiveMinutes) {
                // Token expired - try to refresh automatically
                try {
                    console.log('⚠️ Token expired, attempting auto-refresh...');
                    await refreshGoogleToken();
                    console.log('✓ Token auto-refreshed successfully');
                    return { valid: true };
                } catch (refreshError) {
                    console.error('❌ Auto-refresh failed:', refreshError);
                    return {
                        valid: false,
                        error: 'Google token expired and could not be refreshed automatically.\n\nPlease:\n1. Go to Profile\n2. Click "Disconnect Google Services"\n3. Click "Connect Google Services" again\n\nThen try scheduling the meeting again.'
                    };
                }
            }
        }
        
        return { valid: true };
    };

  // PERMANENT FIX: Google Calendar Helper - Timezone-Safe Meeting Creation
const createGoogleMeeting = async (meetingData, accessToken) => {
    try {
        // BUILD DATETIME STRING DIRECTLY IN PACIFIC TIMEZONE (NO CONVERSIONS!)
        const date = meetingData.date; // Already in YYYY-MM-DD format
        const time = meetingData.time; // Already in HH:MM format
        
        // Construct RFC3339 datetime in Pacific timezone (no Date object conversions)
        const startDateTimeString = `${date}T${time}:00`; // e.g., "2025-10-08T14:30:00"
        
        console.log('Meeting datetime (Pacific):', startDateTimeString);
        
        // Calculate end time
        const [startHours, startMinutes] = time.split(':').map(Number);
        const durationMinutes = parseInt(meetingData.duration || 60);
        
        let endHours = startHours;
        let endMinutes = startMinutes + durationMinutes;
        
        // Handle minute overflow
        if (endMinutes >= 60) {
            endHours += Math.floor(endMinutes / 60);
            endMinutes = endMinutes % 60;
        }
        
        // Handle hour overflow (next day)
        let endDate = date;
        if (endHours >= 24) {
            endHours = endHours % 24;
            const dateParts = date.split('-');
            const nextDay = new Date(
                parseInt(dateParts[0]),
                parseInt(dateParts[1]) - 1,
                parseInt(dateParts[2]) + 1
            );
            endDate = nextDay.toISOString().split('T')[0];
        }
        
        const endDateTimeString = `${endDate}T${String(endHours).padStart(2, '0')}:${String(endMinutes).padStart(2, '0')}:00`;
        
        console.log('End datetime (Pacific):', endDateTimeString);
        
        // BUILD RECURRENCE RULE WITH PROPER END CONDITIONS
        let recurrence = [];
        let estimatedOccurrences = 1;
        
        if (meetingData.recurring && meetingData.recurring !== 'none') {
            const freq = meetingData.recurring.toUpperCase();
            
            if (meetingData.recurringEnd === 'count') {
                // After X occurrences
                recurrence = [`RRULE:FREQ=${freq};COUNT=${meetingData.recurringCount}`];
                estimatedOccurrences = parseInt(meetingData.recurringCount);
            } else if (meetingData.recurringEnd === 'until') {
                // Until specific date - use 23:59:59 on that day in Pacific
                const untilDateString = `${meetingData.recurringUntil}T23:59:59`;
                // Convert to RRULE format (basic ISO string without separators + Z)
                const untilStr = untilDateString.replace(/[-:]/g, '') + 'Z';
                recurrence = [`RRULE:FREQ=${freq};UNTIL=${untilStr}`];
                
                // Calculate estimated occurrences
                const startDate = new Date(date);
                const untilDate = new Date(meetingData.recurringUntil);
                const daysBetween = Math.floor((untilDate - startDate) / (1000 * 60 * 60 * 24));
                
                if (meetingData.recurring === 'daily') {
                    estimatedOccurrences = daysBetween + 1;
                } else if (meetingData.recurring === 'weekly') {
                    estimatedOccurrences = Math.floor(daysBetween / 7) + 1;
                } else if (meetingData.recurring === 'monthly') {
                    estimatedOccurrences = Math.floor(daysBetween / 30) + 1;
                }
            } else if (meetingData.recurringEnd === 'never') {
                // Infinite - no COUNT or UNTIL
                recurrence = [`RRULE:FREQ=${freq}`];
                estimatedOccurrences = '∞';
            }
        }
        
        // Create event with Meet link - PACIFIC TIME (NO CONVERSIONS!)
        const event = {
            summary: meetingData.title || meetingData.meetingTitle,
            description: meetingData.description || meetingData.notes || '',
            start: {
                dateTime: startDateTimeString,
                timeZone: 'America/Los_Angeles'
            },
            end: {
                dateTime: endDateTimeString,
                timeZone: 'America/Los_Angeles'
            },
            conferenceData: {
                createRequest: {
                    requestId: `meet-${Date.now()}`,
                    conferenceSolutionKey: { type: 'hangoutsMeet' }
                }
            },
            reminders: {
                useDefault: false,
                overrides: [
                    { method: 'email', minutes: 24 * 60 },
                    { method: 'popup', minutes: 30 }
                ]
            }
        };
        
        if (recurrence.length > 0) {
            event.recurrence = recurrence;
        }
        
        console.log('Sending request to Google Calendar API...');
        console.log('Event payload:', JSON.stringify(event, null, 2));
        
        // Make API request
        const response = await fetch(
            'https://www.googleapis.com/calendar/v3/calendars/primary/events?conferenceDataVersion=1',
            {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(event)
            }
        );
        
        console.log('Google Calendar API response status:', response.status);
        
        if (!response.ok) {
            const error = await response.json();
            console.error('Google Calendar API error:', error);
            
            if (response.status === 401) {
                throw new Error('TOKEN_EXPIRED');
            }
            
            throw new Error(error.error?.message || 'Failed to create calendar event');
        }
        
        const createdEvent = await response.json();
        console.log('Calendar event created successfully:', createdEvent.id);
        
        return {
            eventId: createdEvent.id,
            meetLink: createdEvent.hangoutLink,
            htmlLink: createdEvent.htmlLink,
            occurrences: estimatedOccurrences
        };
        
    } catch (error) {
        console.error('Error creating Google Calendar event:', error);
        throw error;
    }
};
   // UPDATED: Handle Create Meeting with Occurrence Count Display
const handleCreateMeeting = async (meetingData) => {
    try {
        // CRITICAL: Check Google token FIRST (now async with auto-refresh)
        const tokenCheck = await checkGoogleToken();
        
        if (!tokenCheck.valid) {
            alert('❌ Cannot create meeting without Google Calendar\n\n' + tokenCheck.error);
            return;
        }
        
        console.log('✓ Google token valid, proceeding with meeting creation...');
        
        let googleEventData = null;
        let occurrenceCount = 1;
        
        try {
            console.log('Creating Google Calendar event with Meet link...');
            googleEventData = await createGoogleMeeting(meetingData, user.googleAccessToken);
            console.log('✓ Google event created:', googleEventData);
            
            // Get occurrence count
            occurrenceCount = googleEventData.occurrences || 1;
            
            // Update meeting data with generated Meet link
            if (googleEventData.meetLink) {
                meetingData.meetingLink = googleEventData.meetLink;
            }
        } catch (googleError) {
            console.error('❌ Google Calendar integration failed:', googleError);
            
            // If token expired during creation, show reconnect message
            if (googleError.message === 'TOKEN_EXPIRED') {
                alert('❌ Google token expired during creation!\n\nPlease:\n1. Go to Profile\n2. Disconnect Google Services\n3. Connect Google Services again\n4. Try scheduling the meeting again');
                return;
            }
            
            // Other Google errors - let user decide
            const continueWithoutGoogle = confirm(
                '⚠️ Google Calendar sync failed!\n\n' +
                'Error: ' + googleError.message + '\n\n' +
                'Do you want to create the meeting WITHOUT a Google Meet link?\n\n' +
                '(You can add the link manually later)'
            );
            
            if (!continueWithoutGoogle) {
                return;
            }
        }
        
        // Only reach here if Google Calendar succeeded OR user chose to continue
        console.log('Saving meeting to Firebase...');
        
        // Save to Firebase
        const meetingDoc = await db.collection('meetings').add({
            tenantId: CURRENT_TENANT,
            ...meetingData,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            coachId: user.uid,
            status: 'scheduled',
            googleCalendarEventId: googleEventData?.eventId || null,
            googleCalendarLink: googleEventData?.htmlLink || null,
            recurring: meetingData.recurring || 'none',
            recurringEnd: meetingData.recurringEnd || 'never',
            recurringCount: meetingData.recurringCount || null,
            recurringUntil: meetingData.recurringUntil || null,
            timezone: 'America/Los_Angeles'
        });
        
        console.log('✓ Meeting saved to Firebase:', meetingDoc.id);
        
        // ENHANCED SUCCESS MESSAGE WITH OCCURRENCE COUNT
        let successMessage = '✅ Meeting scheduled successfully!\n\n';
        
        if (meetingData.recurring && meetingData.recurring !== 'none') {
            if (occurrenceCount === '∞') {
                successMessage += `📅 Recurring ${meetingData.recurring} (infinite)\n`;
                successMessage += '⚠️ This meeting will repeat forever until manually deleted\n\n';
            } else {
                const startDate = new Date(
                    parseInt(meetingData.date.split('-')[0]),
                    parseInt(meetingData.date.split('-')[1]) - 1,
                    parseInt(meetingData.date.split('-')[2])
                ).toLocaleDateString();
                
                successMessage += `📅 ${occurrenceCount} occurrences created\n`;
                successMessage += `📆 Starting ${startDate}\n\n`;
            }
        } else {
            const meetingDateTime = new Date(
                parseInt(meetingData.date.split('-')[0]),
                parseInt(meetingData.date.split('-')[1]) - 1,
                parseInt(meetingData.date.split('-')[2]),
                parseInt(meetingData.time.split(':')[0]),
                parseInt(meetingData.time.split(':')[1])
            );
            successMessage += `📅 ${meetingDateTime.toLocaleString()}\n\n`;
        }
        
        if (googleEventData?.meetLink) {
            successMessage += `🔗 Meet link: ${googleEventData.meetLink}\n`;
        }
        
        if (googleEventData?.htmlLink) {
            successMessage += `📆 View in Calendar: ${googleEventData.htmlLink}\n`;
        }
        
        successMessage += '🕐 Time: Pacific Time (PT)';
        
        alert(successMessage);
        
        setShowCreateModal(false);
        setSelectedItem(null);
        loadCommunityData();
        
    } catch (error) {
        console.error('❌ Error creating meeting:', error);
        alert('Failed to create meeting: ' + error.message);
    }
};

    const handleRecordAttendance = async (meetingId, pirId, status) => {
        try {
            await db.collection('meetingAttendance').doc(`${meetingId}_${pirId}`).set({
                meetingId: meetingId,
                pirId: pirId,
                status: status,
                recordedAt: firebase.firestore.FieldValue.serverTimestamp(),
                recordedBy: user.uid
            });
            
            alert('Attendance recorded');
            loadCommunityData();
        } catch (error) {
            console.error('Error recording attendance:', error);
        }
    };

    const exportData = (type, format) => {
        let data = [];
        let filename = '';
        
        if (type === 'messages') {
            data = messages.map(msg => ({
                room: selectedRoom,
                user: msg.userName,
                message: msg.content,
                timestamp: formatDateTime(msg.createdAt),
                flagged: msg.flagged ? 'Yes' : 'No'
            }));
            filename = 'chat-messages';
        } else if (type === 'analytics') {
            data = [
                { metric: 'Total Messages', value: stats.totalMessages },
                { metric: 'Active Users', value: stats.activeUsers },
                { metric: 'Flagged Messages', value: stats.flaggedCount },
                { metric: 'Engagement Rate', value: stats.engagementRate }
            ];
            filename = 'community-analytics';
        } else if (type === 'moderation') {
            data = moderationHistory.map(action => ({
                action: action.action,
                moderator: action.moderatorId,
                timestamp: formatDateTime(action.timestamp),
                details: action.reason || 'N/A'
            }));
            filename = 'moderation-history';
        }
        
        if (format === 'csv') {
            exportToCSV(data, filename);
        } else if (format === 'pdf') {
            exportToPDF(data, `${filename} Report`);
        } else {
            exportToJSON(data, filename);
        }
    };

    if (loading) {
        return (
            <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                minHeight: '400px',
                gap: '20px'
            }}>
                <div style={{
                    width: '60px',
                    height: '60px',
                    border: '4px solid #f3f3f3',
                    borderTop: '4px solid #0077CC',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite'
                }}></div>
                <p style={{ color: '#666' }}>Loading community data...</p>
            </div>
        );
    }

    return (
        <div style={{ padding: '20px', animation: 'fadeIn 0.5s' }}>
            {/* Enhanced Navigation */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '15px 20px',
                marginBottom: '20px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                display: 'flex',
                gap: '10px',
                flexWrap: 'wrap',
                overflowX: 'auto'
            }}>
                {[
                    { id: 'analytics', label: 'Analytics', icon: '📊' },
                    { id: 'chat', label: 'Chat', icon: '💬' },
                    { id: 'rooms', label: `Rooms (${topicRooms.length})`, icon: '🏠' },
                    { id: 'supportGroups', label: `Support Groups (${supportGroups.length})`, icon: '🤝' },
                    { id: 'meetings', label: `Meetings (${meetings.length})`, icon: '📅' },
                    { id: 'moderation', label: `Moderation ${flaggedMessages.length > 0 ? `(${flaggedMessages.length})` : ''}`, icon: '🛡️' }
                ].map(tab => (
                    <button
                        key={tab.id}
                        onClick={() => setActiveTab(tab.id)}
                        style={{
                            padding: '10px 20px',
                            background: activeTab === tab.id 
                                ? 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)' 
                                : '#f0f0f0',
                            color: activeTab === tab.id ? 'white' : '#666',
                            border: 'none',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500',
                            transition: 'all 0.2s',
                            whiteSpace: 'nowrap'
                        }}
                    >
                        {tab.icon} {tab.label}
                    </button>
                ))}
            </div>

            {/* Render Active Tab */}
            {activeTab === 'analytics' && (
                <AnalyticsTab 
                    stats={stats}
                    analyticsData={analyticsData}
                    activityChartRef={activityChartRef}
                    sentimentChartRef={sentimentChartRef}
                    engagementChartRef={engagementChartRef}
                    exportData={exportData}
                />
            )}

            {activeTab === 'chat' && (
                <EnhancedChatTab
                    messages={filteredMessages}
                    selectedRoom={selectedRoom}
                    setSelectedRoom={setSelectedRoom}
                    topicRooms={topicRooms}
                    newMessage={newMessage}
                    setNewMessage={setNewMessage}
                    handleSendMessage={handleSendMessage}
                    handleReaction={handleReaction}
                    handlePinMessage={handlePinMessage}
                    handleDeleteMessage={handleDeleteMessage}
                    handleWarnUser={handleWarnUser}
                    pinnedMessages={pinnedMessages}
                    chatSearch={chatSearch}
                    setChatSearch={setChatSearch}
                    onlineUsers={onlineUsers}
                    setSelectedImage={setSelectedImage}
                    viewMode={viewMode}
                    setViewMode={setViewMode}
                    selectedThread={selectedThread}
                    setSelectedThread={setSelectedThread}
                    user={user}
                    exportData={exportData}
                />
            )}

            {activeTab === 'rooms' && (
                <RoomsTab
                    topicRooms={topicRooms}
                    handleToggleRoom={handleToggleRoom}
                    handleDeleteRoom={handleDeleteRoom}
                    setShowCreateModal={setShowCreateModal}
                    setCreateType={setCreateType}
                />
            )}

            {activeTab === 'supportGroups' && (
                <SupportGroupsTab
                    supportGroups={supportGroups}
                    setShowCreateModal={setShowCreateModal}
                    setCreateType={setCreateType}
                    loadCommunityData={loadCommunityData}
                />
            )}

            {activeTab === 'meetings' && (
                <MeetingsTab
                    meetings={meetings}
                    setShowCreateModal={setShowCreateModal}
                    setCreateType={setCreateType}
                    setSelectedMeeting={setSelectedMeeting}
                    setShowAttendanceModal={setShowAttendanceModal}
                    loadCommunityData={loadCommunityData}
                />
            )}

            {activeTab === 'moderation' && (
                <ModerationTab
                    flaggedMessages={flaggedMessages}
                    moderationHistory={moderationHistory}
                    userWarnings={userWarnings}
                    moderationKeywords={moderationKeywords}
                    setModerationKeywords={setModerationKeywords}
                    handleFlagResolve={handleFlagResolve}
                    stats={stats}
                    exportData={exportData}
                />
            )}

            {/* Modals */}
            {selectedImage && (
                <ImageModal image={selectedImage} onClose={() => setSelectedImage(null)} />
            )}

            {showCreateModal && (
                <CommunityCreateModal
                    type={createType}
                    item={selectedItem}
                    onSubmit={(data) => {
                        if (createType === 'meeting') {
                            handleCreateMeeting(data);
                        } else if (createType === 'room') {
                            handleCreateRoom(data);
                        } else if (createType === 'supportGroup') {
                            handleCreateSupportGroup(data);
                        }
                    }}
                    onClose={() => {
                        setShowCreateModal(false);
                        setSelectedItem(null);
                    }}
                    user={user}
                />
            )}

            {showAttendanceModal && selectedMeeting && (
                <AttendanceModal
                    meeting={selectedMeeting}
                    onClose={() => {
                        setShowAttendanceModal(false);
                        setSelectedMeeting(null);
                    }}
                    handleRecordAttendance={handleRecordAttendance}
                />
            )}
        </div>
    );
}
        // ANALYTICS TAB
function AnalyticsTab({ stats, analyticsData, activityChartRef, sentimentChartRef, engagementChartRef, exportData }) {
    return (
        <div style={{ animation: 'fadeIn 0.5s' }}>

            {/* Charts */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(400px, 1fr))', gap: '20px', marginBottom: '30px' }}>
                <div style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '25px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                }}>
                    <h3 style={{ margin: '0 0 20px 0', color: '#333' }}>Activity by Hour</h3>
                    <div style={{ height: '300px' }}>
                        <canvas ref={activityChartRef}></canvas>
                    </div>
                </div>


                <div style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '25px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                }}>
                    <h3 style={{ margin: '0 0 20px 0', color: '#333' }}>Room Engagement</h3>
                    <div style={{ height: '300px' }}>
                        <canvas ref={engagementChartRef}></canvas>
                    </div>
                </div>
            </div>

            {/* Top Contributors */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '25px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                marginBottom: '20px'
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                    <h3 style={{ margin: 0, color: '#333' }}>Top Contributors</h3>
                    <button
                        onClick={() => exportData('analytics', 'csv')}
                        style={{
                            padding: '8px 16px',
                            background: '#6c757d',
                            color: 'white',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500'
                        }}
                    >
                        Export Analytics
                    </button>
                </div>
                <div style={{ display: 'grid', gap: '10px' }}>
                    {stats.topContributors.slice(0, 10).map((contributor, index) => (
                        <div key={contributor.userId} style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            padding: '15px',
                            background: '#f8f9fa',
                            borderRadius: '10px'
                        }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                                <div style={{
                                    width: '40px',
                                    height: '40px',
                                    borderRadius: '50%',
                                    background: index < 3 ? 'linear-gradient(135deg, #FFD700, #FFA500)' : 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                    color: 'white',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    fontSize: '18px',
                                    fontWeight: 'bold'
                                }}>
                                    {index + 1}
                                </div>
                                <div>
                                    <div style={{ fontWeight: '600', color: '#333' }}>
                                        {contributor.userName || 'Unknown User'}
                                    </div>
                                    <div style={{ fontSize: '13px', color: '#666' }}>
                                        {contributor.count} messages
                                    </div>
                                </div>
                            </div>
                            <div style={{
                                padding: '6px 16px',
                                background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                                color: 'white',
                                borderRadius: '20px',
                                fontSize: '13px',
                                fontWeight: '600'
                            }}>
                                Active
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
}

// ENHANCED CHAT TAB
function EnhancedChatTab({ 
    messages, 
    selectedRoom, 
    setSelectedRoom, 
    topicRooms, 
    newMessage, 
    setNewMessage, 
    handleSendMessage,
    handleReaction,
    handlePinMessage,
    handleDeleteMessage,
    handleWarnUser,
    pinnedMessages,
    chatSearch,
    setChatSearch,
    onlineUsers,
    setSelectedImage,
    viewMode,
    setViewMode,
    selectedThread,
    setSelectedThread,
    user,
    exportData
}) {
    const reactions = ['👍', '❤️', '😊', '🎉', '💪', '🙏'];

    return (
        <div style={{ display: 'grid', gridTemplateColumns: '250px 1fr', gap: '20px', height: '700px' }}>
            {/* Sidebar */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                overflowY: 'auto'
            }}>
                <h4 style={{ margin: '0 0 15px 0', color: '#333' }}>Chat Rooms</h4>
                
                <div 
                    onClick={() => setSelectedRoom('main')}
                    style={{
                        padding: '12px',
                        background: selectedRoom === 'main' ? 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)' : '#f8f9fa',
                        color: selectedRoom === 'main' ? 'white' : '#333',
                        borderRadius: '10px',
                        cursor: 'pointer',
                        marginBottom: '8px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '10px',
                        transition: 'all 0.2s'
                    }}
                >
                    <span style={{ fontSize: '20px' }}>🏠</span>
                    <span style={{ fontWeight: '500' }}>Main Chat</span>
                </div>
                
                {topicRooms.filter(room => room.active).map(room => (
                    <div 
                        key={room.id}
                        onClick={() => setSelectedRoom(room.id)}
                        style={{
                            padding: '12px',
                            background: selectedRoom === room.id ? 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)' : '#f8f9fa',
                            color: selectedRoom === room.id ? 'white' : '#333',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            marginBottom: '8px',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '10px',
                            transition: 'all 0.2s'
                        }}
                    >
                        <span style={{ fontSize: '20px' }}>{room.icon || '💬'}</span>
                        <div style={{ flex: 1 }}>
                            <div style={{ fontWeight: '500', fontSize: '14px' }}>{room.name}</div>
                            <div style={{ fontSize: '11px', opacity: 0.8 }}>{room.messageCount || 0} msgs</div>
                        </div>
                    </div>
                ))}
            </div>

            {/* Main Chat Area */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                display: 'flex',
                flexDirection: 'column',
                overflow: 'hidden'
            }}>
                {/* Header */}
                <div style={{
                    padding: '20px',
                    borderBottom: '1px solid #f0f0f0',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center'
                }}>
                    <div>
                        <h3 style={{ margin: 0, color: '#333' }}>
                            {selectedRoom === 'main' ? 'GLRS Community Chat' : 
                             topicRooms.find(r => r.id === selectedRoom)?.name || 'Chat'}
                        </h3>
                        <div style={{ fontSize: '13px', color: '#666', marginTop: '5px' }}>
                            {messages.length} messages • {onlineUsers.size} online
                        </div>
                    </div>
                    <div style={{ display: 'flex', gap: '10px' }}>
                        <input
                            type="text"
                            placeholder="Search messages..."
                            value={chatSearch}
                            onChange={(e) => setChatSearch(e.target.value)}
                            style={{
                                padding: '8px 12px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '8px',
                                fontSize: '14px',
                                width: '200px'
                            }}
                        />
                        <button
                            onClick={() => exportData('messages', 'csv')}
                            style={{
                                padding: '8px 16px',
                                background: '#6c757d',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '500'
                            }}
                        >
                            Export
                        </button>
                    </div>
                </div>

                {/* Pinned Messages */}
                {pinnedMessages.length > 0 && (
                    <div style={{
                        padding: '15px 20px',
                        background: '#fff3cd',
                        borderBottom: '1px solid #f0f0f0'
                    }}>
                        <div style={{ fontWeight: '600', color: '#856404', marginBottom: '10px', fontSize: '13px' }}>
                            📌 Pinned Messages
                        </div>
                        {pinnedMessages.map(msg => (
                            <div key={msg.id} style={{
                                padding: '8px',
                                background: 'rgba(255,255,255,0.5)',
                                borderRadius: '6px',
                                marginBottom: '5px',
                                fontSize: '13px',
                                color: '#856404'
                            }}>
                                <strong>{msg.userName}:</strong> {msg.content}
                            </div>
                        ))}
                    </div>
                )}

                {/* Messages */}
                <div style={{
                    flex: 1,
                    overflowY: 'auto',
                    padding: '20px',
                    display: 'flex',
                    flexDirection: 'column-reverse'
                }}>
                    {messages.map(message => (
                        <div key={message.id} style={{
                            marginBottom: '20px',
                            padding: '15px',
                            background: message.fromAdmin ? 'rgba(102, 126, 234, 0.1)' : '#f8f9fa',
                            borderRadius: '10px',
                            borderLeft: message.flagged ? '4px solid #f44336' : 'none'
                        }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '8px' }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                    <div style={{
                                        width: '36px',
                                        height: '36px',
                                        borderRadius: '50%',
                                        background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                        color: 'white',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        fontSize: '16px',
                                        fontWeight: 'bold'
                                    }}>
                                        {message.userName?.charAt(0).toUpperCase() || '?'}
                                    </div>
                                    <div>
                                        <div style={{ fontWeight: '600', color: '#333', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            {message.userName || 'Unknown'}
                                            {message.userRole === 'admin' && <span>🛡️</span>}
                                            {message.userRole === 'coach' && <span>👤</span>}
                                            {onlineUsers.has(message.userId) && (
                                                <span style={{
                                                    width: '8px',
                                                    height: '8px',
                                                    borderRadius: '50%',
                                                    background: '#00A86B',
                                                    display: 'inline-block'
                                                }}></span>
                                            )}
                                        </div>
                                        <div style={{ fontSize: '12px', color: '#999' }}>
                                            {formatTimeAgo(message.createdAt)}
                                        </div>
                                    </div>
                                </div>
                                <div style={{ display: 'flex', gap: '5px' }}>
                                    <button
                                        onClick={() => handlePinMessage(message.id, message.pinned)}
                                        style={{
                                            padding: '4px 8px',
                                            background: message.pinned ? '#FFC107' : 'transparent',
                                            border: '1px solid #ddd',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '12px'
                                        }}
                                        title={message.pinned ? 'Unpin' : 'Pin message'}
                                    >
                                        📌
                                    </button>
                                    <button
                                        onClick={() => {
                                            const reason = prompt('Warning reason:');
                                            if (reason) handleWarnUser(message.userId, reason);
                                        }}
                                        style={{
                                            padding: '4px 8px',
                                            background: 'transparent',
                                            border: '1px solid #ddd',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '12px'
                                        }}
                                        title="Warn user"
                                    >
                                        ⚠️
                                    </button>
                                    <button
                                        onClick={() => handleDeleteMessage(message.id)}
                                        style={{
                                            padding: '4px 8px',
                                            background: 'transparent',
                                            border: '1px solid #ddd',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '12px'
                                        }}
                                        title="Delete message"
                                    >
                                        🗑️
                                    </button>
                                </div>
                            </div>
                            
                            <div style={{ color: '#333', marginBottom: '10px', lineHeight: '1.6' }}>
                                {message.content}
                            </div>

                            {message.imageUrl && (
                                <img 
                                    src={message.imageUrl}
                                    alt="Shared"
                                    onClick={() => setSelectedImage(message.imageUrl)}
                                    style={{
                                        maxWidth: '300px',
                                        borderRadius: '8px',
                                        cursor: 'pointer',
                                        marginBottom: '10px'
                                    }}
                                />
                            )}

                            {/* Reactions */}
                            <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap', marginBottom: '8px' }}>
                                {reactions.map(emoji => {
                                    const count = message.reactions?.[emoji]?.length || 0;
                                    const hasReacted = message.reactions?.[emoji]?.includes(user.uid);
                                    
                                    return (
                                        <button
                                            key={emoji}
                                            onClick={() => handleReaction(message.id, emoji)}
                                            style={{
                                                padding: '4px 10px',
                                                background: hasReacted ? '#e3f2fd' : 'white',
                                                border: '1px solid #ddd',
                                                borderRadius: '20px',
                                                cursor: 'pointer',
                                                fontSize: '14px',
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '4px'
                                            }}
                                        >
                                            {emoji} {count > 0 && <span style={{ fontSize: '12px' }}>{count}</span>}
                                        </button>
                                    );
                                })}
                            </div>

                            {message.repliesCount > 0 && (
                                <button
                                    onClick={() => setSelectedThread(message.id)}
                                    style={{
                                        padding: '6px 12px',
                                        background: '#e3f2fd',
                                        border: 'none',
                                        borderRadius: '6px',
                                        cursor: 'pointer',
                                        fontSize: '12px',
                                        color: '#1976d2',
                                        fontWeight: '500'
                                    }}
                                >
                                    {message.repliesCount} {message.repliesCount === 1 ? 'reply' : 'replies'}
                                </button>
                            )}

                            {message.flagged && (
                                <div style={{
                                    marginTop: '10px',
                                    padding: '8px',
                                    background: '#ffebee',
                                    borderRadius: '6px',
                                    color: '#c62828',
                                    fontSize: '12px',
                                    fontWeight: '500'
                                }}>
                                    🚩 This message has been flagged
                                </div>
                            )}
                        </div>
                    ))}
                    
                    {messages.length === 0 && (
                        <div style={{
                            textAlign: 'center',
                            padding: '60px 20px',
                            color: '#999'
                        }}>
                            <div style={{ fontSize: '48px', marginBottom: '15px' }}>💬</div>
                            <div>No messages yet. Start the conversation!</div>
                        </div>
                    )}
                </div>

                {/* Input */}
                <div style={{
                    padding: '20px',
                    borderTop: '1px solid #f0f0f0'
                }}>
                    {selectedThread && (
                        <div style={{
                            padding: '8px 12px',
                            background: '#e3f2fd',
                            borderRadius: '8px',
                            marginBottom: '10px',
                            fontSize: '13px',
                            color: '#1976d2',
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center'
                        }}>
                            <span>Replying to thread...</span>
                            <button
                                onClick={() => setSelectedThread(null)}
                                style={{
                                    background: 'none',
                                    border: 'none',
                                    color: '#1976d2',
                                    cursor: 'pointer',
                                    fontSize: '16px'
                                }}
                            >
                                ×
                            </button>
                        </div>
                    )}
                    <div style={{ display: 'flex', gap: '10px' }}>
                        <input
                            type="text"
                            placeholder="Type a message..."
                            value={newMessage}
                            onChange={(e) => setNewMessage(e.target.value)}
                            onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                            style={{
                                flex: 1,
                                padding: '12px 16px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '10px',
                                fontSize: '14px'
                            }}
                        />
                        <button
                            onClick={handleSendMessage}
                            style={{
                                padding: '12px 24px',
                                background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '10px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '600'
                            }}
                        >
                            Send
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
}

// ROOMS TAB
function RoomsTab({ topicRooms, handleToggleRoom, handleDeleteRoom, setShowCreateModal, setModalType }) {
    return (
        <div style={{ animation: 'fadeIn 0.5s' }}>
            <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                marginBottom: '20px'
            }}>
                <h3 style={{ margin: 0, color: '#333' }}>Topic Rooms Management</h3>
                <button
                    onClick={() => {
                        setModalType('room');
                        setShowCreateModal(true);
                    }}
                    style={{
                        padding: '10px 20px',
                        background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '10px',
                        cursor: 'pointer',
                        fontSize: '14px',
                        fontWeight: '600'
                    }}
                >
                    + Create Room
                </button>
            </div>

            <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))',
                gap: '20px'
            }}>
                {topicRooms.map(room => (
                    <div key={room.id} style={{
                        background: 'white',
                        borderRadius: '15px',
                        padding: '20px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                        transition: 'all 0.2s'
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.transform = 'translateY(-5px)';
                        e.currentTarget.style.boxShadow = '0 8px 20px rgba(0,0,0,0.15)';
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
                    }}
                    >
                        <div style={{ fontSize: '48px', textAlign: 'center', marginBottom: '15px' }}>
                            {room.icon || '💬'}
                        </div>
                        <h4 style={{ margin: '0 0 10px 0', textAlign: 'center', color: '#333' }}>
                            {room.name}
                        </h4>
                        <p style={{ fontSize: '14px', color: '#666', textAlign: 'center', marginBottom: '15px' }}>
                            {room.description}
                        </p>
                        <div style={{
                            display: 'flex',
                            justifyContent: 'center',
                            gap: '8px',
                            marginBottom: '15px'
                        }}>
                            <span style={{
                                padding: '4px 12px',
                                background: room.active ? '#d4edda' : '#f8d7da',
                                color: room.active ? '#155724' : '#721c24',
                                borderRadius: '20px',
                                fontSize: '12px',
                                fontWeight: '500'
                            }}>
                                {room.active ? 'Active' : 'Inactive'}
                            </span>
                            <span style={{
                                padding: '4px 12px',
                                background: '#e3f2fd',
                                color: '#1976d2',
                                borderRadius: '20px',
                                fontSize: '12px',
                                fontWeight: '500'
                            }}>
                                {room.messageCount || 0} messages
                            </span>
                        </div>
                        <div style={{ display: 'flex', gap: '8px' }}>
                            <button
                                onClick={() => handleToggleRoom(room.id, room.active)}
                                style={{
                                    flex: 1,
                                    padding: '8px',
                                    background: room.active ? '#FFC107' : '#00A86B',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '13px',
                                    fontWeight: '500'
                                }}
                            >
                                {room.active ? 'Deactivate' : 'Activate'}
                            </button>
                            <button
                                onClick={() => handleDeleteRoom(room.id)}
                                style={{
                                    flex: 1,
                                    padding: '8px',
                                    background: '#DC143C',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '13px',
                                    fontWeight: '500'
                                }}
                            >
                                Delete
                            </button>
                        </div>
                    </div>
                ))}
            </div>

            {topicRooms.length === 0 && (
                <div style={{
                    padding: '80px 20px',
                    textAlign: 'center',
                    background: 'white',
                    borderRadius: '15px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                }}>
                    <div style={{ fontSize: '64px', marginBottom: '20px' }}>🏠</div>
                    <div style={{ fontSize: '20px', fontWeight: '600', color: '#333', marginBottom: '10px' }}>
                        No Topic Rooms Yet
                    </div>
                    <div style={{ fontSize: '16px', color: '#999' }}>
                        Create topic-specific rooms for focused discussions
                    </div>
                </div>
            )}
        </div>
    );
}
     // SUPPORT GROUPS TAB - CORRECTED
function SupportGroupsTab({ supportGroups, setShowCreateModal, setModalType, loadCommunityData }) {
    return (
        <div style={{ animation: 'fadeIn 0.5s' }}>
            <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                marginBottom: '20px'
            }}>
                <h3 style={{ margin: 0, color: '#333' }}>Support Groups</h3>
                <button
                    onClick={() => {
                        setModalType('supportGroup');
                        setShowCreateModal(true);
                    }}
                    style={{
                        padding: '10px 20px',
                        background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '10px',
                        cursor: 'pointer',
                        fontSize: '14px',
                        fontWeight: '600'
                    }}
                >
                    + Add Support Group
                </button>
            </div>

            <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fill, minmax(350px, 1fr))',
                gap: '20px'
            }}>
                {supportGroups.map(group => (
                    <div key={group.id} style={{
                        background: 'white',
                        borderRadius: '15px',
                        padding: '20px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                        transition: 'all 0.2s'
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.transform = 'translateY(-5px)';
                        e.currentTarget.style.boxShadow = '0 8px 20px rgba(0,0,0,0.15)';
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
                    }}
                    >
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '15px' }}>
                            <h4 style={{ margin: 0, color: '#333' }}>{group.name}</h4>
                            <span style={{
                                padding: '4px 12px',
                                background: group.type === 'AA' ? '#0077CC' :
                                           group.type === 'NA' ? '#f093fb' :
                                           group.type === 'SMART' ? '#4facfe' : '#fa709a',
                                color: 'white',
                                borderRadius: '20px',
                                fontSize: '12px',
                                fontWeight: '600'
                            }}>
                                {group.type}
                            </span>
                        </div>

                        {group.description && (
                            <p style={{ fontSize: '14px', color: '#666', marginBottom: '15px' }}>
                                {group.description}
                            </p>
                        )}

                        <div style={{
                            display: 'grid',
                            gap: '10px',
                            marginBottom: '15px',
                            padding: '15px',
                            background: '#f8f9fa',
                            borderRadius: '10px'
                        }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px', fontSize: '14px' }}>
                                <span>📅</span>
                                <span style={{ fontWeight: '600' }}>{group.day}</span>
                            </div>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px', fontSize: '14px' }}>
                                <span>🕐</span>
                                <span style={{ fontWeight: '600' }}>{group.time}</span>
                            </div>
                            {group.location && (
                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px', fontSize: '14px' }}>
                                    <span>📍</span>
                                    <span>{group.location}</span>
                                </div>
                            )}
                            {group.link && (
                                <a
                                    href={group.link}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px',
                                        color: '#1976d2',
                                        textDecoration: 'none',
                                        fontSize: '14px',
                                        fontWeight: '500'
                                    }}
                                >
                                    <span>🔗</span>
                                    <span>Join Meeting</span>
                                </a>
                            )}
                        </div>

                        <div style={{ display: 'flex', gap: '8px' }}>
                            <button
                                onClick={async () => {
                                    await db.collection('supportGroups').doc(group.id).update({
                                        active: !group.active
                                    });
                                    loadCommunityData();
                                }}
                                style={{
                                    flex: 1,
                                    padding: '8px',
                                    background: group.active ? '#00A86B' : '#6c757d',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '13px',
                                    fontWeight: '500'
                                }}
                            >
                                {group.active ? 'Active' : 'Inactive'}
                            </button>
                            <button
                                onClick={async () => {
                                    if (confirm('Delete this support group?')) {
                                        await db.collection('supportGroups').doc(group.id).delete();
                                        loadCommunityData();
                                    }
                                }}
                                style={{
                                    flex: 1,
                                    padding: '8px',
                                    background: '#DC143C',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '13px',
                                    fontWeight: '500'
                                }}
                            >
                                Delete
                            </button>
                        </div>
                    </div>
                ))}
            </div>

            {supportGroups.length === 0 && (
                <div style={{
                    padding: '80px 20px',
                    textAlign: 'center',
                    background: 'white',
                    borderRadius: '15px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                }}>
                    <div style={{ fontSize: '64px', marginBottom: '20px' }}>🤝</div>
                    <div style={{ fontSize: '20px', fontWeight: '600', color: '#333', marginBottom: '10px' }}>
                        No Support Groups Yet
                    </div>
                    <div style={{ fontSize: '16px', color: '#999' }}>
                        Add support groups for PIRs to join
                    </div>
                </div>
            )}
        </div>
    );
}
// MEETINGS TAB
function MeetingsTab({ meetings, setShowCreateModal, setCreateType, setSelectedMeeting, setShowAttendanceModal, loadCommunityData }) {
    return (
        <div style={{ animation: 'fadeIn 0.5s' }}>
            <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                marginBottom: '20px'
            }}>
                <h3 style={{ margin: 0, color: '#333' }}>Group Meetings</h3>
                <button
                    onClick={() => {
                        setCreateType('meeting');
                        setShowCreateModal(true);
                    }}
                    style={{
                        padding: '10px 20px',
                        background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '10px',
                        cursor: 'pointer',
                        fontSize: '14px',
                        fontWeight: '600'
                    }}
                >
                    + Schedule Meeting
                </button>
            </div>

            <div style={{ display: 'grid', gap: '20px' }}>
                {meetings.map(meeting => (
                    <div key={meeting.id} style={{
                        background: 'white',
                        borderRadius: '15px',
                        padding: '25px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                        transition: 'all 0.2s'
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.transform = 'translateY(-2px)';
                        e.currentTarget.style.boxShadow = '0 8px 20px rgba(0,0,0,0.15)';
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
                    }}
                    >
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '15px' }}>
                            <div style={{ flex: 1 }}>
                                <h4 style={{ margin: '0 0 10px 0', color: '#333', fontSize: '20px' }}>
                                    {meeting.meetingTitle || 'Group Recovery Session'}
                                </h4>
                                <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap', marginBottom: '10px' }}>
                                    <span style={{
                                        padding: '4px 12px',
                                        background: meeting.status === 'completed' ? '#d4edda' :
                                                   meeting.status === 'scheduled' ? '#cfe2ff' :
                                                   meeting.status === 'cancelled' ? '#f8d7da' : '#e2e3e5',
                                        color: meeting.status === 'completed' ? '#155724' :
                                               meeting.status === 'scheduled' ? '#084298' :
                                               meeting.status === 'cancelled' ? '#721c24' : '#41464b',
                                        borderRadius: '20px',
                                        fontSize: '12px',
                                        fontWeight: '600',
                                        textTransform: 'uppercase'
                                    }}>
                                        {meeting.status}
                                    </span>
                                    <span style={{
                                        padding: '4px 12px',
                                        background: '#e3f2fd',
                                        color: '#1976d2',
                                        borderRadius: '20px',
                                        fontSize: '12px',
                                        fontWeight: '500'
                                    }}>
                                        {meeting.type || 'Group Session'}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div style={{
                            display: 'grid',
                            gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                            gap: '15px',
                            marginBottom: '15px',
                            padding: '15px',
                            background: '#f8f9fa',
                            borderRadius: '10px'
                        }}>
                            <div>
                                <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Date & Time</div>
                                <div style={{ fontSize: '14px', fontWeight: '600', color: '#333' }}>
                                    {formatDate(meeting.scheduledTime)}
                                </div>
                                <div style={{ fontSize: '13px', color: '#666' }}>
                                    {new Date(meeting.scheduledTime?.toDate ? meeting.scheduledTime.toDate() : meeting.scheduledTime).toLocaleTimeString()}
                                </div>
                            </div>
                            <div>
                                <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Duration</div>
                                <div style={{ fontSize: '14px', fontWeight: '600', color: '#333' }}>
                                    {meeting.duration || 60} minutes
                                </div>
                            </div>
                            {meeting.attendanceCount !== undefined && (
                                <div>
                                    <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Attendance</div>
                                    <div style={{ fontSize: '14px', fontWeight: '600', color: '#333' }}>
                                        {meeting.attendanceCount} recorded
                                    </div>
                                </div>
                            )}
                        </div>

                        {meeting.isGlobal ? (
                            <div style={{
                                padding: '12px',
                                background: '#e8f5e9',
                                borderRadius: '10px',
                                marginBottom: '15px'
                            }}>
                                <div style={{ fontSize: '14px', fontWeight: '600', color: '#2e7d32' }}>
                                    🌍 All PIRs Invited
                                </div>
                            </div>
                        ) : meeting.pirNames && meeting.pirNames.length > 0 && (
                            <div style={{ marginBottom: '15px' }}>
                                <div style={{ fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '10px' }}>
                                    Participants ({meeting.pirNames.length})
                                </div>
                                <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                                    {meeting.pirNames.slice(0, 5).map((name, idx) => (
                                        <span key={idx} style={{
                                            padding: '6px 12px',
                                            background: '#e3f2fd',
                                            color: '#1976d2',
                                            borderRadius: '20px',
                                            fontSize: '13px'
                                        }}>
                                            {name}
                                        </span>
                                    ))}
                                    {meeting.pirNames.length > 5 && (
                                        <span style={{
                                            padding: '6px 12px',
                                            background: '#f0f0f0',
                                            color: '#666',
                                            borderRadius: '20px',
                                            fontSize: '13px',
                                            fontWeight: '600'
                                        }}>
                                            +{meeting.pirNames.length - 5} more
                                        </span>
                                    )}
                                </div>
                            </div>
                        )}

                        {meeting.meetingLink && (
                            <a
                                href={meeting.meetingLink}
                                target="_blank"
                                rel="noopener noreferrer"
                                style={{
                                    display: 'inline-flex',
                                    alignItems: 'center',
                                    gap: '8px',
                                    padding: '10px 16px',
                                    background: '#e3f2fd',
                                    color: '#1976d2',
                                    textDecoration: 'none',
                                    borderRadius: '8px',
                                    fontSize: '14px',
                                    fontWeight: '500',
                                    marginBottom: '15px'
                                }}
                            >
                                🔗 Join Meeting
                            </a>
                        )}

                        {meeting.notes && (
                            <div style={{
                                padding: '12px',
                                background: '#fff3cd',
                                borderRadius: '10px',
                                marginBottom: '15px'
                            }}>
                                <div style={{ fontSize: '12px', fontWeight: '600', color: '#856404', marginBottom: '5px' }}>
                                    Notes
                                </div>
                                <div style={{ fontSize: '14px', color: '#856404' }}>
                                    {meeting.notes}
                                </div>
                            </div>
                        )}

                        <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                            <button
                                onClick={() => {
                                    setSelectedMeeting(meeting);
                                    setShowAttendanceModal(true);
                                }}
                                style={{
                                    padding: '8px 16px',
                                    background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '13px',
                                    fontWeight: '500'
                                }}
                            >
                                Attendance
                            </button>
                            <button
                                onClick={async () => {
                                    await db.collection('meetings').doc(meeting.id).update({
                                        status: 'completed',
                                        completedAt: firebase.firestore.FieldValue.serverTimestamp()
                                    });
                                    loadCommunityData();
                                }}
                                disabled={meeting.status === 'completed'}
                                style={{
                                    padding: '8px 16px',
                                    background: meeting.status === 'completed' ? '#ccc' : '#00A86B',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: meeting.status === 'completed' ? 'not-allowed' : 'pointer',
                                    fontSize: '13px',
                                    fontWeight: '500'
                                }}
                            >
                                Mark Complete
                            </button>
                            <button
                                onClick={async () => {
                                    if (confirm('Cancel this meeting?')) {
                                        await db.collection('meetings').doc(meeting.id).update({
                                            status: 'cancelled'
                                        });
                                        loadCommunityData();
                                    }
                                }}
                                disabled={meeting.status === 'cancelled'}
                                style={{
                                    padding: '8px 16px',
                                    background: meeting.status === 'cancelled' ? '#ccc' : '#FFC107',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: meeting.status === 'cancelled' ? 'not-allowed' : 'pointer',
                                    fontSize: '13px',
                                    fontWeight: '500'
                                }}
                            >
                                Cancel
                            </button>
                            <button
                                onClick={async () => {
                                    if (confirm('Delete this meeting permanently?')) {
                                        await db.collection('meetings').doc(meeting.id).delete();
                                        loadCommunityData();
                                    }
                                }}
                                style={{
                                    padding: '8px 16px',
                                    background: '#DC143C',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '13px',
                                    fontWeight: '500'
                                }}
                            >
                                Delete
                            </button>
                        </div>
                    </div>
                ))}
            </div>

            {meetings.length === 0 && (
                <div style={{
                    padding: '80px 20px',
                    textAlign: 'center',
                    background: 'white',
                    borderRadius: '15px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                }}>
                    <div style={{ fontSize: '64px', marginBottom: '20px' }}>📅</div>
                    <div style={{ fontSize: '20px', fontWeight: '600', color: '#333', marginBottom: '10px' }}>
                        No Meetings Scheduled
                    </div>
                    <div style={{ fontSize: '16px', color: '#999' }}>
                        Schedule group meetings for PIRs
                    </div>
                </div>
            )}
        </div>
    );
}

// MODERATION TAB
function ModerationTab({ 
    flaggedMessages, 
    moderationHistory, 
    userWarnings, 
    moderationKeywords, 
    setModerationKeywords, 
    handleFlagResolve, 
    stats,
    exportData 
}) {
    const [newKeyword, setNewKeyword] = useState('');
    const [showKeywordManager, setShowKeywordManager] = useState(false);

    const handleAddKeyword = async () => {
        if (!newKeyword.trim()) return;
        
        try {
            const updated = [...moderationKeywords, newKeyword.toLowerCase()];
            await db.collection('settings').doc('moderation').set({
                keywords: updated
            });
            setModerationKeywords(updated);
            setNewKeyword('');
            alert('Keyword added');
        } catch (error) {
            console.error('Error adding keyword:', error);
        }
    };

    const handleRemoveKeyword = async (keyword) => {
        try {
            const updated = moderationKeywords.filter(k => k !== keyword);
            await db.collection('settings').doc('moderation').set({
                keywords: updated
            });
            setModerationKeywords(updated);
        } catch (error) {
            console.error('Error removing keyword:', error);
        }
    };

    return (
        <div style={{ animation: 'fadeIn 0.5s' }}>
            {/* Stats Row */}
            <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                gap: '20px',
                marginBottom: '30px'
            }}>
                <div style={{
                    background: 'linear-gradient(135deg, #f44336 0%, #e53935 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(244, 67, 54, 0.3)'
                }}>
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Flagged Messages</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {flaggedMessages.length}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Pending review</div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #FFC107 0%, #FFA000 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(255, 193, 7, 0.3)'
                }}>
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Total Warnings</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {Object.values(userWarnings).reduce((acc, warnings) => acc + warnings.length, 0)}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Issued to users</div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(102, 126, 234, 0.3)'
                }}>
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Moderation Actions</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {moderationHistory.length}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>All time</div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(79, 172, 254, 0.3)'
                }}>
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Blocked Keywords</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {moderationKeywords.length}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Auto-filtered</div>
                </div>
            </div>

            {/* Keyword Manager */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '25px',
                marginBottom: '20px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
                    <h3 style={{ margin: 0, color: '#333' }}>Keyword Filtering</h3>
                    <button
                        onClick={() => setShowKeywordManager(!showKeywordManager)}
                        style={{
                            padding: '8px 16px',
                            background: '#0077CC',
                            color: 'white',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500'
                        }}
                    >
                        {showKeywordManager ? 'Hide' : 'Manage Keywords'}
                    </button>
                </div>

                {showKeywordManager && (
                    <>
                        <div style={{ display: 'flex', gap: '10px', marginBottom: '15px' }}>
                            <input
                                type="text"
                                placeholder="Add keyword to block..."
                                value={newKeyword}
                                onChange={(e) => setNewKeyword(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && handleAddKeyword()}
                                style={{
                                    flex: 1,
                                    padding: '10px 15px',
                                    border: '2px solid #e0e0e0',
                                    borderRadius: '8px',
                                    fontSize: '14px'
                                }}
                            />
                            <button
                                onClick={handleAddKeyword}
                                style={{
                                    padding: '10px 20px',
                                    background: '#00A86B',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500'
                                }}
                            >
                                Add
                            </button>
                        </div>

                        <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                            {moderationKeywords.map(keyword => (
                                <div key={keyword} style={{
                                    padding: '6px 12px',
                                    background: '#ffebee',
                                    color: '#c62828',
                                    borderRadius: '20px',
                                    fontSize: '13px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px'
                                }}>
                                    <span>{keyword}</span>
                                    <button
                                        onClick={() => handleRemoveKeyword(keyword)}
                                        style={{
                                            background: 'none',
                                            border: 'none',
                                            color: '#c62828',
                                            cursor: 'pointer',
                                            fontSize: '16px',
                                            padding: 0,
                                            lineHeight: 1
                                        }}
                                    >
                                        ×
                                    </button>
                                </div>
                            ))}
                            {moderationKeywords.length === 0 && (
                                <div style={{ color: '#999', fontSize: '14px' }}>
                                    No keywords set. Messages will not be auto-filtered.
                                </div>
                            )}
                        </div>
                    </>
                )}
            </div>

            {/* Flagged Messages */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '25px',
                marginBottom: '20px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                    <h3 style={{ margin: 0, color: '#333' }}>
                        Flagged Messages ({flaggedMessages.length})
                    </h3>
                    {flaggedMessages.length > 0 && (
                        <button
                            onClick={() => exportData('moderation', 'csv')}
                            style={{
                                padding: '8px 16px',
                                background: '#6c757d',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '500'
                            }}
                        >
                            Export Report
                        </button>
                    )}
                </div>

                {flaggedMessages.length > 0 ? (
                    <div style={{ display: 'grid', gap: '15px' }}>
                        {flaggedMessages.map(message => (
                            <div key={message.id} style={{
                                padding: '20px',
                                background: '#fff3cd',
                                border: '2px solid #f44336',
                                borderRadius: '10px'
                            }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px' }}>
                                    <div>
                                        <div style={{ fontWeight: '600', color: '#333' }}>
                                            {message.userName || 'Unknown User'}
                                        </div>
                                        <div style={{ fontSize: '12px', color: '#666' }}>
                                            {formatTimeAgo(message.flaggedAt)}
                                        </div>
                                    </div>
                                    <span style={{
                                        padding: '6px 12px',
                                        background: '#DC143C',
                                        color: 'white',
                                        borderRadius: '20px',
                                        fontSize: '12px',
                                        fontWeight: '600'
                                    }}>
                                        FLAGGED
                                    </span>
                                </div>

                                <div style={{
                                    padding: '15px',
                                    background: 'white',
                                    borderRadius: '8px',
                                    marginBottom: '10px',
                                    color: '#333'
                                }}>
                                    {message.content}
                                </div>

                                {message.imageUrl && (
                                    <img
                                        src={message.imageUrl}
                                        alt="Flagged content"
                                        style={{
                                            maxWidth: '200px',
                                            borderRadius: '8px',
                                            marginBottom: '10px'
                                        }}
                                    />
                                )}

                                {message.flagReason && (
                                    <div style={{
                                        padding: '10px',
                                        background: 'rgba(244, 67, 54, 0.1)',
                                        borderRadius: '8px',
                                        fontSize: '14px',
                                        color: '#c62828',
                                        marginBottom: '10px'
                                    }}>
                                        <strong>Reason:</strong> {message.flagReason}
                                    </div>
                                )}

                                <div style={{ display: 'flex', gap: '10px' }}>
                                    <button
                                        onClick={() => handleFlagResolve(message.id, 'delete')}
                                        style={{
                                            padding: '8px 16px',
                                            background: '#DC143C',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '8px',
                                            cursor: 'pointer',
                                            fontSize: '14px',
                                            fontWeight: '500'
                                        }}
                                    >
                                        Delete Message
                                    </button>
                                    <button
                                        onClick={() => handleFlagResolve(message.id, 'unflag')}
                                        style={{
                                            padding: '8px 16px',
                                            background: '#00A86B',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '8px',
                                            cursor: 'pointer',
                                            fontSize: '14px',
                                            fontWeight: '500'
                                        }}
                                    >
                                        Unflag & Keep
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                ) : (
                    <div style={{
                        padding: '60px 20px',
                        textAlign: 'center',
                        color: '#999'
                    }}>
                        <div style={{ fontSize: '48px', marginBottom: '15px' }}>✅</div>
                        <div style={{ fontSize: '18px', fontWeight: '500', marginBottom: '8px' }}>
                            No Flagged Messages
                        </div>
                        <div style={{ fontSize: '14px' }}>
                            Community is clean!
                        </div>
                    </div>
                )}
            </div>

            {/* Moderation History */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '25px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <h3 style={{ margin: '0 0 20px 0', color: '#333' }}>
                    Recent Moderation Actions
                </h3>

                {moderationHistory.length > 0 ? (
                    <div style={{ display: 'grid', gap: '10px' }}>
                        {moderationHistory.slice(0, 20).map(action => (
                            <div key={action.id} style={{
                                padding: '15px',
                                background: '#f8f9fa',
                                borderRadius: '10px',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center'
                            }}>
                                <div>
                                    <div style={{ fontWeight: '600', color: '#333', marginBottom: '5px' }}>
                                        {action.action === 'delete' && '🗑️ Message Deleted'}
                                        {action.action === 'warn' && '⚠️ User Warned'}
                                        {action.action === 'unflag' && '✅ Message Unflagged'}
                                    </div>
                                    <div style={{ fontSize: '13px', color: '#666' }}>
                                        {formatTimeAgo(action.timestamp)}
                                        {action.reason && ` • ${action.reason}`}
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                ) : (
                    <div style={{ textAlign: 'center', padding: '40px', color: '#999' }}>
                        No moderation actions yet
                    </div>
                )}
            </div>
        </div>
    );
}
            // IMAGE MODAL
function ImageModal({ image, onClose }) {
    return (
        <div 
            onClick={onClose}
            style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0, 0, 0, 0.9)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 2000,
                cursor: 'pointer',
                animation: 'fadeIn 0.2s'
            }}
        >
            <img 
                src={image}
                alt="Full size"
                onClick={(e) => e.stopPropagation()}
                style={{
                    maxWidth: '90vw',
                    maxHeight: '90vh',
                    objectFit: 'contain',
                    borderRadius: '10px',
                    boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5)'
                }}
            />
            <button
                onClick={onClose}
                style={{
                    position: 'absolute',
                    top: '20px',
                    right: '20px',
                    background: 'rgba(255,255,255,0.2)',
                    border: 'none',
                    color: 'white',
                    fontSize: '32px',
                    width: '48px',
                    height: '48px',
                    borderRadius: '50%',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    backdropFilter: 'blur(10px)',
                    transition: 'background 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.3)'}
                onMouseLeave={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.2)'}
            >
                ×
            </button>
        </div>
    );
}

// COMMUNITY CREATE MODAL - WITH RECURRING END OPTIONS
function CommunityCreateModal({ type, item, onSubmit, onClose, user }) {
    const [formData, setFormData] = useState(() => {
        if (item) {
            return {
                ...item,
                assignedPIRs: item.assignedPIRs || [],
                recurring: item.recurring || 'none',
                recurringEnd: item.recurringEnd || 'never',
                recurringCount: item.recurringCount || 10,
                recurringUntil: item.recurringUntil || ''
            };
        }
        
        if (type === 'room') {
            return {
                name: '',
                description: '',
                icon: '💬',
                rules: ''
            };
        } else if (type === 'supportGroup') {
            return {
                name: '',
                type: 'AA',
                day: 'Monday',
                time: '',
                link: '',
                location: '',
                description: '',
                active: true
            };
        } else if (type === 'meeting') {
            return {
                meetingTitle: '',
                scheduledTime: '',
                type: 'Group Session',
                meetingLink: '',
                duration: '60',
                isGlobal: false,
                assignedPIRs: [],
                notes: '',
                sendReminder: true,
                status: 'scheduled',
                recurring: 'none',
                recurringEnd: 'never',
                recurringCount: 10,
                recurringUntil: ''
            };
        }
    });

    const [allPIRs, setAllPIRs] = useState([]);
    const [selectedPIRs, setSelectedPIRs] = useState(item?.assignedPIRs || []);
    const [loading, setLoading] = useState(true);

    const icons = ['💬', '🎯', '💪', '🧘', '📖', '🌟', '❤️', '🙏', '🎨', '🎵'];

    useEffect(() => {
        if (type === 'meeting' || type === 'supportGroup') {
            loadPIRs();
        } else {
            setLoading(false);
        }
    }, []);

    const loadPIRs = async () => {
        try {
            const pirsSnap = await db.collection('users')
                .where('role', '==', 'pir')
                .where('active', '!=', false)
                .get();
            
            const pirsData = [];
            pirsSnap.forEach(doc => {
                const data = doc.data();
                pirsData.push({
                    id: doc.id,
                    name: data.displayName || `${data.firstName} ${data.lastName}` || data.email,
                    email: data.email
                });
            });
            setAllPIRs(pirsData);
        } catch (error) {
            console.error('Error loading PIRs:', error);
        } finally {
            setLoading(false);
        }
    };

    const handleSubmit = (e) => {
        e.preventDefault();
        
        if (type === 'room') {
            if (!formData.name || !formData.description) {
                alert('Please fill in all required fields');
                return;
            }
        } else if (type === 'supportGroup') {
            if (!formData.name || !formData.day || !formData.time) {
                alert('Please fill in all required fields');
                return;
            }
            
            const finalData = {
                ...formData,
                assignedPIRs: selectedPIRs
            };
            
            onSubmit(finalData);
            return;
        } else if (type === 'meeting') {
            if (!formData.meetingTitle || !formData.scheduledTime) {
                alert('Please provide a meeting title and scheduled time');
                return;
            }
            
            // Validate recurring end options
            if (formData.recurring !== 'none') {
                if (formData.recurringEnd === 'count' && (!formData.recurringCount || formData.recurringCount < 1)) {
                    alert('Please specify how many times the meeting should repeat');
                    return;
                }
                if (formData.recurringEnd === 'until' && !formData.recurringUntil) {
                    alert('Please specify when the recurring meetings should end');
                    return;
                }
            }
            
            const scheduledDate = new Date(formData.scheduledTime);
            const dateStr = scheduledDate.toISOString().split('T')[0];
            const timeStr = formData.scheduledTime.split('T')[1];
            
            const finalData = {
                ...formData,
                scheduledTime: firebase.firestore.Timestamp.fromDate(scheduledDate),
                assignedPIRs: formData.isGlobal ? [] : selectedPIRs,
                date: dateStr,
                time: timeStr,
                title: formData.meetingTitle,
                description: formData.notes || ''
            };
            
            onSubmit(finalData);
            return;
        }
        
        onSubmit(formData);
    };

    const handlePIRSelection = (pirId) => {
        if (selectedPIRs.includes(pirId)) {
            setSelectedPIRs(selectedPIRs.filter(id => id !== pirId));
        } else {
            setSelectedPIRs([...selectedPIRs, pirId]);
        }
    };

    const selectAllPIRs = () => {
        setSelectedPIRs(allPIRs.map(pir => pir.id));
    };

    const clearSelection = () => {
        setSelectedPIRs([]);
    };

    const getCurrentDateTime = () => {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        return now.toISOString().slice(0, 16);
    };

    const getMinRecurringEndDate = () => {
        if (!formData.scheduledTime) return '';
        const scheduledDate = new Date(formData.scheduledTime);
        scheduledDate.setDate(scheduledDate.getDate() + 1); // At least 1 day after start
        return scheduledDate.toISOString().split('T')[0];
    };

    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1500,
            padding: '20px',
            animation: 'fadeIn 0.2s'
        }}>
            <div style={{
                background: 'white',
                borderRadius: '20px',
                maxWidth: '700px',
                width: '100%',
                maxHeight: '90vh',
                overflow: 'auto',
                boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
                animation: 'slideUp 0.3s'
            }}>
                {/* Header */}
                <div style={{
                    background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                    padding: '25px 30px',
                    borderRadius: '20px 20px 0 0',
                    color: 'white',
                    position: 'sticky',
                    top: 0,
                    zIndex: 1
                }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <h3 style={{ margin: 0, fontSize: '24px' }}>
                            {item ? 'Edit' : 'Create'} {
                                type === 'room' ? 'Topic Room' :
                                type === 'supportGroup' ? 'Support Group' :
                                'Group Meeting'
                            }
                        </h3>
                        <button 
                            onClick={onClose}
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                border: 'none',
                                color: 'white',
                                fontSize: '24px',
                                width: '36px',
                                height: '36px',
                                borderRadius: '50%',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center'
                            }}
                        >
                            ×
                        </button>
                    </div>
                </div>

                {/* Form Content */}
                <form onSubmit={handleSubmit} style={{ padding: '30px' }}>
                    {/* TIMEZONE BANNER */}
                    {(type === 'meeting' || type === 'supportGroup') && (
                        <div style={{
                            marginBottom: '25px',
                            padding: '15px 20px',
                            background: 'linear-gradient(135deg, #0077CC15 0%, #008B8B15 100%)',
                            border: '2px solid #0077CC',
                            borderRadius: '12px',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '12px'
                        }}>
                            <span style={{ fontSize: '24px' }}>🕐</span>
                            <div>
                                <div style={{ fontWeight: '600', color: '#0077CC', fontSize: '15px', marginBottom: '4px' }}>
                                    Pacific Time Zone (PT)
                                </div>
                                <div style={{ fontSize: '13px', color: '#666' }}>
                                    All times are in Pacific Time. Calendar events will be created in PT timezone.
                                </div>
                            </div>
                        </div>
                    )}

                    {type === 'room' && (
                        <>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Room Name *
                                </label>
                                <input
                                    type="text"
                                    value={formData.name}
                                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                                    placeholder="e.g., Daily Reflections"
                                    required
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px'
                                    }}
                                />
                            </div>

                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Description *
                                </label>
                                <textarea
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                    placeholder="What is this room about?"
                                    rows="3"
                                    required
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px',
                                        fontFamily: 'inherit',
                                        resize: 'vertical'
                                    }}
                                />
                            </div>

                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Icon
                                </label>
                                <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                                    {icons.map(icon => (
                                        <button
                                            key={icon}
                                            type="button"
                                            onClick={() => setFormData({...formData, icon})}
                                            style={{
                                                padding: '10px 15px',
                                                background: formData.icon === icon ? '#e3f2fd' : '#f0f0f0',
                                                border: formData.icon === icon ? '2px solid #1976d2' : '2px solid transparent',
                                                borderRadius: '8px',
                                                cursor: 'pointer',
                                                fontSize: '24px',
                                                transition: 'all 0.2s'
                                            }}
                                        >
                                            {icon}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Room Rules (optional)
                                </label>
                                <textarea
                                    value={formData.rules}
                                    onChange={(e) => setFormData({...formData, rules: e.target.value})}
                                    placeholder="Any specific guidelines for this room?"
                                    rows="2"
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px',
                                        fontFamily: 'inherit',
                                        resize: 'vertical'
                                    }}
                                />
                            </div>
                        </>
                    )}

                    {type === 'supportGroup' && (
                        <>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Group Name *
                                </label>
                                <input
                                    type="text"
                                    value={formData.name}
                                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                                    placeholder="e.g., Wednesday Night NA Meeting"
                                    required
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px'
                                    }}
                                />
                            </div>
                            
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px', marginBottom: '20px' }}>
                                <div>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        Type *
                                    </label>
                                    <select
                                        value={formData.type}
                                        onChange={(e) => setFormData({...formData, type: e.target.value})}
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '10px',
                                            fontSize: '14px',
                                            background: 'white'
                                        }}
                                    >
                                        <option value="AA">AA</option>
                                        <option value="NA">NA</option>
                                        <option value="Al-Anon">Al-Anon</option>
                                        <option value="SMART">SMART Recovery</option>
                                        <option value="Celebrate Recovery">Celebrate Recovery</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        Day *
                                    </label>
                                    <select
                                        value={formData.day}
                                        onChange={(e) => setFormData({...formData, day: e.target.value})}
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '10px',
                                            fontSize: '14px',
                                            background: 'white'
                                        }}
                                    >
                                        <option value="Monday">Monday</option>
                                        <option value="Tuesday">Tuesday</option>
                                        <option value="Wednesday">Wednesday</option>
                                        <option value="Thursday">Thursday</option>
                                        <option value="Friday">Friday</option>
                                        <option value="Saturday">Saturday</option>
                                        <option value="Sunday">Sunday</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Time (PT) *
                                </label>
                                <input
                                    type="time"
                                    value={formData.time}
                                    onChange={(e) => setFormData({...formData, time: e.target.value})}
                                    required
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px'
                                    }}
                                />
                            </div>
                            
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Meeting Link (for virtual meetings)
                                </label>
                                <input
                                    type="url"
                                    value={formData.link}
                                    onChange={(e) => setFormData({...formData, link: e.target.value})}
                                    placeholder="https://zoom.us/j/..."
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px'
                                    }}
                                />
                            </div>
                            
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Location (for in-person meetings)
                                </label>
                                <input
                                    type="text"
                                    value={formData.location || ''}
                                    onChange={(e) => setFormData({...formData, location: e.target.value})}
                                    placeholder="e.g., Community Center, 123 Main St"
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px'
                                    }}
                                />
                            </div>
                            
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Description
                                </label>
                                <textarea
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                    placeholder="Additional details about this support group"
                                    rows="3"
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px',
                                        fontFamily: 'inherit',
                                        resize: 'vertical'
                                    }}
                                />
                            </div>

                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Assign PIRs to This Support Group
                                </label>
                                <div style={{
                                    marginBottom: '10px',
                                    padding: '10px 12px',
                                    background: '#f0f9ff',
                                    borderRadius: '8px',
                                    fontSize: '13px',
                                    color: '#0369a1'
                                }}>
                                    ℹ️ Selected PIRs will have this support group added to their calendars
                                </div>
                                <div style={{ display: 'flex', gap: '10px', marginBottom: '10px' }}>
                                    <button 
                                        type="button"
                                        onClick={selectAllPIRs}
                                        style={{
                                            padding: '6px 12px',
                                            background: '#0077CC',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            fontWeight: '500'
                                        }}
                                    >
                                        Select All
                                    </button>
                                    <button 
                                        type="button"
                                        onClick={clearSelection}
                                        style={{
                                            padding: '6px 12px',
                                            background: '#6c757d',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            fontWeight: '500'
                                        }}
                                    >
                                        Clear All
                                    </button>
                                    <span style={{ fontSize: '13px', color: '#666', lineHeight: '32px' }}>
                                        {selectedPIRs.length} selected
                                    </span>
                                </div>
                                <div style={{
                                    maxHeight: '200px',
                                    overflowY: 'auto',
                                    border: '2px solid #e0e0e0',
                                    borderRadius: '10px',
                                    padding: '10px'
                                }}>
                                    {loading ? (
                                        <div style={{ textAlign: 'center', padding: '20px', color: '#999' }}>
                                            Loading PIRs...
                                        </div>
                                    ) : allPIRs.length > 0 ? (
                                        allPIRs.map(pir => (
                                            <label key={pir.id} style={{
                                                display: 'block',
                                                padding: '8px',
                                                cursor: 'pointer',
                                                background: selectedPIRs.includes(pir.id) ? '#e3f2fd' : 'transparent',
                                                borderRadius: '6px',
                                                marginBottom: '4px',
                                                transition: 'background 0.2s'
                                            }}>
                                                <input
                                                    type="checkbox"
                                                    checked={selectedPIRs.includes(pir.id)}
                                                    onChange={() => handlePIRSelection(pir.id)}
                                                    style={{ marginRight: '10px', width: '16px', height: '16px', cursor: 'pointer' }}
                                                />
                                                <span style={{ fontSize: '14px' }}>
                                                    {pir.name} <span style={{ color: '#999', fontSize: '12px' }}>({pir.email})</span>
                                                </span>
                                            </label>
                                        ))
                                    ) : (
                                        <div style={{ color: '#999', textAlign: 'center', padding: '20px' }}>
                                            No PIRs available
                                        </div>
                                    )}
                                </div>
                            </div>
                        </>
                    )}

                    {type === 'meeting' && (
                        <>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Meeting Title *
                                </label>
                                <input
                                    type="text"
                                    value={formData.meetingTitle}
                                    onChange={(e) => setFormData({...formData, meetingTitle: e.target.value})}
                                    placeholder="e.g., Weekly Progress Review, Drop-In Hours"
                                    required
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px'
                                    }}
                                />
                            </div>
                            
                            <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr', gap: '15px', marginBottom: '20px' }}>
                                <div>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        Date & Time (PT) *
                                    </label>
                                    <input
                                        type="datetime-local"
                                        value={formData.scheduledTime}
                                        onChange={(e) => setFormData({...formData, scheduledTime: e.target.value})}
                                        min={getCurrentDateTime()}
                                        required
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '10px',
                                            fontSize: '14px'
                                        }}
                                    />
                                </div>
                                
                                <div>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        Duration
                                    </label>
                                    <select
                                        value={formData.duration}
                                        onChange={(e) => setFormData({...formData, duration: e.target.value})}
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '10px',
                                            fontSize: '14px',
                                            background: 'white'
                                        }}
                                    >
                                        <option value="30">30 min</option>
                                        <option value="60">60 min</option>
                                        <option value="90">90 min</option>
                                        <option value="120">2 hours</option>
                                    </select>
                                </div>
                            </div>

                            {/* RECURRING OPTIONS */}
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Recurring Schedule
                                </label>
                                <select
                                    value={formData.recurring}
                                    onChange={(e) => setFormData({...formData, recurring: e.target.value})}
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px',
                                        background: 'white'
                                    }}
                                >
                                    <option value="none">One-time meeting</option>
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>

                            {/* RECURRING END OPTIONS - NEW! */}
                            {formData.recurring !== 'none' && (
                                <div style={{ 
                                    marginBottom: '20px',
                                    padding: '20px',
                                    background: '#f8f9fa',
                                    borderRadius: '12px',
                                    border: '2px solid #e0e0e0'
                                }}>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '12px' }}>
                                        When should this recurring meeting end?
                                    </label>
                                    
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                        {/* After X occurrences */}
                                        <label style={{ display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer' }}>
                                            <input
                                                type="radio"
                                                name="recurringEnd"
                                                value="count"
                                                checked={formData.recurringEnd === 'count'}
                                                onChange={(e) => setFormData({...formData, recurringEnd: e.target.value})}
                                                style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                            />
                                            <span style={{ fontSize: '14px', fontWeight: '500', color: '#333' }}>
                                                After
                                            </span>
                                            <select
                                                value={formData.recurringCount}
                                                onChange={(e) => setFormData({...formData, recurringEnd: 'count', recurringCount: e.target.value})}
                                                disabled={formData.recurringEnd !== 'count'}
                                                style={{
                                                    padding: '8px 12px',
                                                    border: '2px solid #e0e0e0',
                                                    borderRadius: '8px',
                                                    fontSize: '14px',
                                                    background: 'white',
                                                    cursor: formData.recurringEnd !== 'count' ? 'not-allowed' : 'pointer',
                                                    opacity: formData.recurringEnd !== 'count' ? 0.5 : 1
                                                }}
                                            >
                                                <option value="5">5</option>
                                                <option value="10">10</option>
                                                <option value="15">15</option>
                                                <option value="20">20</option>
                                                <option value="25">25</option>
                                                <option value="30">30</option>
                                            </select>
                                            <span style={{ fontSize: '14px', fontWeight: '500', color: '#333' }}>
                                                occurrences
                                            </span>
                                        </label>

                                        {/* Until specific date */}
                                        <label style={{ display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer' }}>
                                            <input
                                                type="radio"
                                                name="recurringEnd"
                                                value="until"
                                                checked={formData.recurringEnd === 'until'}
                                                onChange={(e) => setFormData({...formData, recurringEnd: e.target.value})}
                                                style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                            />
                                            <span style={{ fontSize: '14px', fontWeight: '500', color: '#333' }}>
                                                Until
                                            </span>
                                            <input
                                                type="date"
                                                value={formData.recurringUntil}
                                                onChange={(e) => setFormData({...formData, recurringEnd: 'until', recurringUntil: e.target.value})}
                                                min={getMinRecurringEndDate()}
                                                disabled={formData.recurringEnd !== 'until'}
                                                style={{
                                                    padding: '8px 12px',
                                                    border: '2px solid #e0e0e0',
                                                    borderRadius: '8px',
                                                    fontSize: '14px',
                                                    cursor: formData.recurringEnd !== 'until' ? 'not-allowed' : 'pointer',
                                                    opacity: formData.recurringEnd !== 'until' ? 0.5 : 1
                                                }}
                                            />
                                        </label>

                                        {/* Never (infinite) */}
                                        <label style={{ display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer' }}>
                                            <input
                                                type="radio"
                                                name="recurringEnd"
                                                value="never"
                                                checked={formData.recurringEnd === 'never'}
                                                onChange={(e) => setFormData({...formData, recurringEnd: e.target.value})}
                                                style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                            />
                                            <span style={{ fontSize: '14px', fontWeight: '500', color: '#333' }}>
                                                Never (infinite)
                                            </span>
                                        </label>
                                    </div>

                                    {/* Warning for "Never" */}
                                    {formData.recurringEnd === 'never' && (
                                        <div style={{
                                            marginTop: '12px',
                                            padding: '12px',
                                            background: '#fff3cd',
                                            border: '2px solid #ffc107',
                                            borderRadius: '8px',
                                            fontSize: '13px',
                                            color: '#856404',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '8px'
                                        }}>
                                            <span>⚠️</span>
                                            <span>This meeting will repeat forever until manually deleted. Consider setting an end date or occurrence limit.</span>
                                        </div>
                                    )}

                                    {/* Info for selected option */}
                                    {formData.recurringEnd === 'count' && formData.recurringCount && (
                                        <div style={{
                                            marginTop: '12px',
                                            padding: '10px 12px',
                                            background: '#f0f9ff',
                                            borderRadius: '8px',
                                            fontSize: '13px',
                                            color: '#0369a1'
                                        }}>
                                            ℹ️ This meeting will repeat {formData.recurring} {formData.recurringCount} times
                                        </div>
                                    )}

                                    {formData.recurringEnd === 'until' && formData.recurringUntil && (
                                        <div style={{
                                            marginTop: '12px',
                                            padding: '10px 12px',
                                            background: '#f0f9ff',
                                            borderRadius: '8px',
                                            fontSize: '13px',
                                            color: '#0369a1'
                                        }}>
                                            ℹ️ This meeting will repeat {formData.recurring} until {new Date(formData.recurringUntil).toLocaleDateString()}
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Meeting Type
                                </label>
                                <select
                                    value={formData.type}
                                    onChange={(e) => setFormData({...formData, type: e.target.value})}
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px',
                                        background: 'white'
                                    }}
                                >
                                    <option value="Group Session">Group Session</option>
                                    <option value="Progress Review">Progress Review</option>
                                    <option value="Educational">Educational</option>
                                    <option value="Group Therapy">Group Therapy</option>
                                    <option value="Special Topic">Special Topic</option>
                                    <option value="Check-in">Check-in</option>
                                </select>
                            </div>
                            
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Meeting Link
                                </label>
                                <input
                                    type="url"
                                    value={formData.meetingLink}
                                    onChange={(e) => setFormData({...formData, meetingLink: e.target.value})}
                                    placeholder={user?.googleConnected ? "Will auto-generate Google Meet link" : "https://zoom.us/j/..."}
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px'
                                    }}
                                />
                                {user?.googleConnected ? (
                                    <div style={{
                                        marginTop: '8px',
                                        padding: '10px 12px',
                                        background: '#f0fdf4',
                                        borderRadius: '8px',
                                        fontSize: '13px',
                                        color: '#166534',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px'
                                    }}>
                                        <span>✓</span>
                                        <span>Google Meet link will be generated automatically when you save</span>
                                    </div>
                                ) : (
                                    <div style={{
                                        marginTop: '8px',
                                        padding: '10px 12px',
                                        background: '#fef9c3',
                                        borderRadius: '8px',
                                        fontSize: '13px',
                                        color: '#854d0e',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px'
                                    }}>
                                        <span>⚠️</span>
                                        <span>Connect Google Services in your Profile to auto-generate Meet links</span>
                                    </div>
                                )}
                            </div>
                            
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer' }}>
                                    <input
                                        type="checkbox"
                                        checked={formData.isGlobal}
                                        onChange={(e) => setFormData({...formData, isGlobal: e.target.checked})}
                                        style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                    />
                                    <span style={{ fontSize: '14px', fontWeight: '500', color: '#333' }}>
                                        Invite all PIRs (Global Meeting / Drop-In Hours)
                                    </span>
                                </label>
                            </div>
                            
                            {!formData.isGlobal && (
                                <div style={{ marginBottom: '20px' }}>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        Select PIRs to Invite
                                    </label>
                                    <div style={{ display: 'flex', gap: '10px', marginBottom: '10px' }}>
                                        <button 
                                            type="button"
                                            onClick={selectAllPIRs}
                                            style={{
                                                padding: '6px 12px',
                                                background: '#0077CC',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '6px',
                                                cursor: 'pointer',
                                                fontSize: '13px',
                                                fontWeight: '500'
                                            }}
                                        >
                                            Select All
                                        </button>
                                        <button 
                                            type="button"
                                            onClick={clearSelection}
                                            style={{
                                                padding: '6px 12px',
                                                background: '#6c757d',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '6px',
                                                cursor: 'pointer',
                                                fontSize: '13px',
                                                fontWeight: '500'
                                            }}
                                        >
                                            Clear All
                                        </button>
                                        <span style={{ fontSize: '13px', color: '#666', lineHeight: '32px' }}>
                                            {selectedPIRs.length} selected
                                        </span>
                                    </div>
                                    <div style={{
                                        maxHeight: '200px',
                                        overflowY: 'auto',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        padding: '10px'
                                    }}>
                                        {loading ? (
                                            <div style={{ textAlign: 'center', padding: '20px', color: '#999' }}>
                                                Loading PIRs...
                                            </div>
                                        ) : allPIRs.length > 0 ? (
                                            allPIRs.map(pir => (
                                                <label key={pir.id} style={{
                                                    display: 'block',
                                                    padding: '8px',
                                                    cursor: 'pointer',
                                                    background: selectedPIRs.includes(pir.id) ? '#e3f2fd' : 'transparent',
                                                    borderRadius: '6px',
                                                    marginBottom: '4px',
                                                    transition: 'background 0.2s'
                                                }}>
                                                    <input
                                                        type="checkbox"
                                                        checked={selectedPIRs.includes(pir.id)}
                                                        onChange={() => handlePIRSelection(pir.id)}
                                                        style={{ marginRight: '10px', width: '16px', height: '16px', cursor: 'pointer' }}
                                                    />
                                                    <span style={{ fontSize: '14px' }}>
                                                        {pir.name} <span style={{ color: '#999', fontSize: '12px' }}>({pir.email})</span>
                                                    </span>
                                                </label>
                                            ))
                                        ) : (
                                            <div style={{ color: '#999', textAlign: 'center', padding: '20px' }}>
                                                No PIRs available
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                            
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                    Meeting Notes
                                </label>
                                <textarea
                                    value={formData.notes}
                                    onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                    placeholder="Topics to cover, preparation needed, etc."
                                    rows="3"
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px',
                                        fontFamily: 'inherit',
                                        resize: 'vertical'
                                    }}
                                />
                            </div>
                        </>
                    )}
                    
                    <div style={{ display: 'flex', gap: '10px', marginTop: '25px' }}>
                        <button
                            type="button"
                            onClick={onClose}
                            style={{
                                flex: 1,
                                padding: '12px',
                                background: '#6c757d',
                                color: 'white',
                                border: 'none',
                                borderRadius: '10px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '600'
                            }}
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            style={{
                                flex: 2,
                                padding: '12px',
                                background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '10px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '600'
                            }}
                        >
                            {item ? 'Update' : 'Create'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
}

// ATTENDANCE MODAL
function AttendanceModal({ meeting, onClose, handleRecordAttendance }) {
    const [attendanceData, setAttendanceData] = useState({});
    const [loading, setLoading] = useState(true);
    const [participants, setParticipants] = useState([]);

    useEffect(() => {
        loadAttendance();
    }, []);

    const loadAttendance = async () => {
        try {
            // Load PIRs
            let pirIds = meeting.assignedPIRs || [];
            
            if (meeting.isGlobal) {
                const pirsSnap = await db.collection('users')
                    .where('role', '==', 'pir')
                    .get();
                pirIds = pirsSnap.docs.map(doc => doc.id);
            }

            const pirData = [];
            for (const pirId of pirIds) {
                const pirDoc = await db.collection('users').doc(pirId).get();
                if (pirDoc.exists) {
                    const data = pirDoc.data();
                    pirData.push({
                        id: pirId,
                        name: data.displayName || data.email
                    });
                }
            }
            setParticipants(pirData);

            // Load existing attendance
            const attendanceSnap = await db.collection('meetingAttendance')
                .where('meetingId', '==', meeting.id)
                .get();

            const attendance = {};
            attendanceSnap.forEach(doc => {
                const data = doc.data();
                attendance[data.pirId] = data.status;
            });
            setAttendanceData(attendance);

        } catch (error) {
            console.error('Error loading attendance:', error);
        } finally {
            setLoading(false);
        }
    };

    const handleStatusChange = async (pirId, status) => {
        try {
            await handleRecordAttendance(meeting.id, pirId, status);
            setAttendanceData(prev => ({ ...prev, [pirId]: status }));
        } catch (error) {
            console.error('Error updating attendance:', error);
        }
    };

    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1500,
            padding: '20px',
            animation: 'fadeIn 0.2s'
        }}>
            <div style={{
                background: 'white',
                borderRadius: '20px',
                maxWidth: '600px',
                width: '100%',
                maxHeight: '90vh',
                overflow: 'auto',
                boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
                animation: 'slideUp 0.3s'
            }}>
                {/* Header */}
                <div style={{
                    background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                    padding: '25px 30px',
                    borderRadius: '20px 20px 0 0',
                    color: 'white',
                    position: 'sticky',
                    top: 0,
                    zIndex: 1
                }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div>
                            <h3 style={{ margin: '0 0 5px 0', fontSize: '24px' }}>Meeting Attendance</h3>
                            <div style={{ fontSize: '14px', opacity: 0.9 }}>
                                {meeting.meetingTitle}
                            </div>
                        </div>
                        <button 
                            onClick={onClose}
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                border: 'none',
                                color: 'white',
                                fontSize: '24px',
                                width: '36px',
                                height: '36px',
                                borderRadius: '50%',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center'
                            }}
                        >
                            ×
                        </button>
                    </div>
                </div>

                {/* Content */}
                <div style={{ padding: '30px' }}>
                    {loading ? (
                        <div style={{ textAlign: 'center', padding: '40px', color: '#999' }}>
                            Loading participants...
                        </div>
                    ) : participants.length > 0 ? (
                        <div style={{ display: 'grid', gap: '12px' }}>
                            {participants.map(pir => (
                                <div key={pir.id} style={{
                                    padding: '15px',
                                    background: '#f8f9fa',
                                    borderRadius: '10px',
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center'
                                }}>
                                    <div style={{ fontWeight: '600', color: '#333' }}>
                                        {pir.name}
                                    </div>
                                    <div style={{ display: 'flex', gap: '8px' }}>
                                        <button
                                            onClick={() => handleStatusChange(pir.id, 'present')}
                                            style={{
                                                padding: '6px 12px',
                                                background: attendanceData[pir.id] === 'present' ? '#00A86B' : 'white',
                                                color: attendanceData[pir.id] === 'present' ? 'white' : '#333',
                                                border: '2px solid #00A86B',
                                                borderRadius: '6px',
                                                cursor: 'pointer',
                                                fontSize: '13px',
                                                fontWeight: '500'
                                            }}
                                        >
                                            Present
                                        </button>
                                        <button
                                            onClick={() => handleStatusChange(pir.id, 'absent')}
                                            style={{
                                                padding: '6px 12px',
                                                background: attendanceData[pir.id] === 'absent' ? '#f44336' : 'white',
                                                color: attendanceData[pir.id] === 'absent' ? 'white' : '#333',
                                                border: '2px solid #f44336',
                                                borderRadius: '6px',
                                                cursor: 'pointer',
                                                fontSize: '13px',
                                                fontWeight: '500'
                                            }}
                                        >
                                            Absent
                                        </button>
                                        <button
                                            onClick={() => handleStatusChange(pir.id, 'excused')}
                                            style={{
                                                padding: '6px 12px',
                                                background: attendanceData[pir.id] === 'excused' ? '#FFC107' : 'white',
                                                color: attendanceData[pir.id] === 'excused' ? 'white' : '#333',
                                                border: '2px solid #FFC107',
                                                borderRadius: '6px',
                                                cursor: 'pointer',
                                                fontSize: '13px',
                                                fontWeight: '500'
                                            }}
                                        >
                                            Excused
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div style={{ textAlign: 'center', padding: '40px', color: '#999' }}>
                            No participants for this meeting
                        </div>
                    )}

                    <button
                        onClick={onClose}
                        style={{
                            width: '100%',
                            marginTop: '20px',
                            padding: '12px',
                            background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                            color: 'white',
                            border: 'none',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '600'
                        }}
                    >
                        Done
                    </button>
                </div>
            </div>
        </div>
    );
}
    // PIR-Centric Goals & Objectives Management View with Enhanced UI - FIXED VERSION
function GoalsView({ searchQuery, user }) {
    const [selectedPIR, setSelectedPIR] = useState(null);
    const [pirs, setPirs] = useState([]);
    const [loading, setLoading] = useState(true);
    const [expandedGoals, setExpandedGoals] = useState(new Set());
    const [expandedObjectives, setExpandedObjectives] = useState(new Set());
    const [showCreateModal, setShowCreateModal] = useState(false);
    const [modalType, setModalType] = useState('');
    const [selectedParent, setSelectedParent] = useState(null);
    const [pirGoalsData, setPirGoalsData] = useState({
        goals: [],
        objectives: [],
        assignments: [],
        milestones: [],
        customMilestones: []
    });
    const [activeTab, setActiveTab] = useState('overview');

    useEffect(() => {
        loadPIRsWithStats();
    }, []);

    useEffect(() => {
        if (selectedPIR) {
            loadPIRGoalsData(selectedPIR.id);
        }
    }, [selectedPIR]);

    const loadPIRsWithStats = async () => {
        try {
            setLoading(true);
            console.log('🎯 GoalsView: Loading PIRs for tenant:', CURRENT_TENANT);

            // FIXED: Removed .where('active', '!=', false) - compound inequality query issue
            // Filter active status in JavaScript instead
            const pirsSnap = await db.collection('users')
                .where('tenantId', '==', CURRENT_TENANT)
                .where('role', '==', 'pir')
                .get();

            console.log('✓ GoalsView: Found', pirsSnap.size, 'total PIRs');

            const pirsData = [];

            for (const doc of pirsSnap.docs) {
                const pirData = { id: doc.id, ...doc.data() };

                // Filter out inactive PIRs
                if (pirData.active === false) {
                    console.log('  ⊘ Skipping inactive PIR:', pirData.displayName || pirData.email);
                    continue;
                }
                
                // Get ALL goals (both active and completed) for stats
                const goalsSnap = await db.collection('goals')
                    .where('tenantId', '==', CURRENT_TENANT)
                    .where('userId', '==', doc.id)
                    .get();
                
                let totalProgress = 0;
                let overdueCount = 0;
                let nearCompletion = 0;
                let activeGoalsCount = 0;
                let completedGoalsCount = 0;
                
                for (const goalDoc of goalsSnap.docs) {
                    const goalData = goalDoc.data();
                    if (goalData.status === 'active') activeGoalsCount++;
                    if (goalData.status === 'completed') completedGoalsCount++;
                    
                    // Get assignments for this goal
                    const assignmentsSnap = await db.collection('assignments')
                        .where('tenantId', '==', CURRENT_TENANT)
                        .where('goalId', '==', goalDoc.id)
                        .get();
                    
                    let completed = 0;
                    let total = assignmentsSnap.size;
                    
                    assignmentsSnap.forEach(assignDoc => {
                        const assignment = assignDoc.data();
                        if (assignment.status === 'completed') completed++;
                        if (assignment.dueDate && new Date(assignment.dueDate.toDate()) < new Date() && assignment.status !== 'completed') {
                            overdueCount++;
                        }
                    });
                    
                    const goalProgress = total > 0 ? (completed / total) * 100 : 0;
                    totalProgress += goalProgress;
                    if (goalProgress >= 80 && goalData.status === 'active') nearCompletion++;
                }
                
                pirData.activeGoals = activeGoalsCount;
                pirData.completedGoals = completedGoalsCount;
                pirData.totalGoals = goalsSnap.size;
                pirData.overallProgress = goalsSnap.size > 0 ? Math.round(totalProgress / goalsSnap.size) : 0;
                pirData.overdueAssignments = overdueCount;
                pirData.nearCompletion = nearCompletion;
                
                pirsData.push(pirData);
            }

            console.log('✅ GoalsView: Loaded', pirsData.length, 'active PIRs with stats');
            setPirs(pirsData);
        } catch (error) {
            console.error('❌ GoalsView: Error loading PIRs:', error);
        } finally {
            setLoading(false);
        }
    };

    const loadPIRGoalsData = async (pirId) => {
        try {
            setLoading(true);
            
            // Get ALL goals, not just active ones
            const goalsSnap = await db.collection('goals')
                .where('tenantId', '==', CURRENT_TENANT)
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .get();

            const goalsData = [];
            const objectivesData = [];
            const assignmentsData = [];

            for (const goalDoc of goalsSnap.docs) {
                const goalData = { id: goalDoc.id, ...goalDoc.data() };
                
                // Get ALL objectives for this goal
                const objectivesSnap = await db.collection('objectives')
                    .where('tenantId', '==', CURRENT_TENANT)
                    .where('goalId', '==', goalDoc.id)
                    .orderBy('order', 'asc')
                    .get();
                
                let goalAssignments = 0;
                let completedAssignments = 0;
                
                for (const objDoc of objectivesSnap.docs) {
                    const objData = { id: objDoc.id, ...objDoc.data() };
                    objectivesData.push(objData);
                    
                    // Get ALL assignments for this objective
                    const assignmentsSnap = await db.collection('assignments')
                        .where('tenantId', '==', CURRENT_TENANT)
                        .where('objectiveId', '==', objDoc.id)
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    assignmentsSnap.forEach(assignDoc => {
                        const assignData = { id: assignDoc.id, ...assignDoc.data() };
                        assignmentsData.push(assignData);
                        goalAssignments++;
                        if (assignData.status === 'completed') completedAssignments++;
                    });
                }
                
                goalData.progress = goalAssignments > 0 
                    ? Math.round((completedAssignments / goalAssignments) * 100)
                    : 0;
                
                goalsData.push(goalData);
            }

            const recoveryMilestones = getRecoveryMilestones(selectedPIR.sobrietyDate);
            
            const customMilestonesSnap = await db.collection('milestones')
                .where('tenantId', '==', CURRENT_TENANT)
                .where('userId', '==', pirId)
                .where('type', '==', 'custom')
                .orderBy('targetDate', 'asc')
                .get();
            
            const customMilestonesData = [];
            customMilestonesSnap.forEach(doc => {
                customMilestonesData.push({ id: doc.id, ...doc.data() });
            });

            setPirGoalsData({
                goals: goalsData,
                objectives: objectivesData,
                assignments: assignmentsData,
                milestones: recoveryMilestones,
                customMilestones: customMilestonesData
            });

        } catch (error) {
            console.error('Error loading PIR goals:', error);
        } finally {
            setLoading(false);
        }
    };

  
    const toggleGoalExpand = (goalId) => {
        const newExpanded = new Set(expandedGoals);
        if (newExpanded.has(goalId)) {
            newExpanded.delete(goalId);
        } else {
            newExpanded.add(goalId);
        }
        setExpandedGoals(newExpanded);
    };

    const toggleObjectiveExpand = (objId) => {
        const newExpanded = new Set(expandedObjectives);
        if (newExpanded.has(objId)) {
            newExpanded.delete(objId);
        } else {
            newExpanded.add(objId);
        }
        setExpandedObjectives(newExpanded);
    };

    const handleCompleteGoal = async (goalId) => {
        if (!confirm('Mark this goal as complete? Only coaches can complete goals.')) return;
        
        try {
            await db.collection('goals').doc(goalId).update({
                status: 'completed',
                completedBy: user.uid,
                completedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            loadPIRGoalsData(selectedPIR.id);
        } catch (error) {
            console.error('Error completing goal:', error);
        }
    };

    const handleCompleteObjective = async (objectiveId) => {
        if (!confirm('Mark this objective as complete? Only coaches can complete objectives.')) return;
        
        try {
            await db.collection('objectives').doc(objectiveId).update({
                status: 'completed',
                completedBy: user.uid,
                completedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            loadPIRGoalsData(selectedPIR.id);
        } catch (error) {
            console.error('Error completing objective:', error);
        }
    };

    const handleCreateGoal = async (goalData) => {
        try {
            await db.collection('goals').add({
                tenantId: CURRENT_TENANT,
                userId: selectedPIR.id,
                title: goalData.title,
                description: goalData.description,
                dueDate: goalData.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(goalData.dueDate)) : null,
                status: 'active',
                createdBy: user.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            alert('Goal created successfully!');
            setShowCreateModal(false);
            loadPIRGoalsData(selectedPIR.id);
        } catch (error) {
            console.error('Error creating goal:', error);
            alert('Failed to create goal');
        }
    };

    const handleCreateObjective = async (objectiveData) => {
        try {
            const objectivesSnap = await db.collection('objectives')
                .where('tenantId', '==', CURRENT_TENANT)
                .where('goalId', '==', objectiveData.goalId)
                .get();

            await db.collection('objectives').add({
                tenantId: CURRENT_TENANT,
                goalId: objectiveData.goalId,
                userId: selectedPIR.id,
                title: objectiveData.title,
                order: objectivesSnap.size + 1,
                dueDate: objectiveData.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(objectiveData.dueDate)) : null,
                status: 'active',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            alert('Objective created successfully!');
            setShowCreateModal(false);
            loadPIRGoalsData(selectedPIR.id);
        } catch (error) {
            console.error('Error creating objective:', error);
            alert('Failed to create objective');
        }
    };

   const handleCreateAssignment = async (assignmentData) => {
    try {
        // ✅ FIXED: Proper date handling (no .trim())
        let dueDateTimestamp = null;
        if (assignmentData.dueDate) {
            const dateObj = new Date(assignmentData.dueDate);
            if (!isNaN(dateObj.getTime())) {
                dueDateTimestamp = firebase.firestore.Timestamp.fromDate(dateObj);
            }
        }
        
        await db.collection('assignments').add({
            tenantId: CURRENT_TENANT,
            goalId: assignmentData.goalId,
            objectiveId: assignmentData.objectiveId,
            userId: selectedPIR.id,
            pirName: selectedPIR.displayName || selectedPIR.email,
            coachId: user.uid,
            coachName: user.displayName || user.email,
            title: assignmentData.title,
            description: assignmentData.description,
            dueDate: dueDateTimestamp,
            status: 'pending',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Send notification to PIR (with preference checking)
        await createNotificationWithPreferences({
            tenantId: CURRENT_TENANT,
            userId: selectedPIR.id,
            recipientId: selectedPIR.id,
            type: 'assignment_created',
            title: 'New Assignment',
            message: `You have a new assignment: ${assignmentData.title}`,
            read: false
        }, 'assignment_created');
        
        // ✅ Send email notification
        await sendNewAssignmentEmail(
            selectedPIR.email,
            selectedPIR.displayName || selectedPIR.email,
            assignmentData,
            user.displayName || user.email
        );
        
        alert('Assignment created successfully!');
        setShowCreateModal(false);
        loadPIRGoalsData(selectedPIR.id);
    } catch (error) {
        console.error('Error creating assignment:', error);
        alert('Failed to create assignment');
    }
};

    const handleCreateMilestone = async (milestoneData) => {
        try {
            await db.collection('milestones').add({
                userId: selectedPIR.id,
                title: milestoneData.title,
                description: milestoneData.description,
                targetDate: firebase.firestore.Timestamp.fromDate(new Date(milestoneData.targetDate)),
                type: 'custom',
                achieved: false,
                icon: milestoneData.icon || '🎯',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            alert('Milestone created successfully!');
            setShowCreateModal(false);
            loadPIRGoalsData(selectedPIR.id);
        } catch (error) {
            console.error('Error creating milestone:', error);
            alert('Failed to create milestone');
        }
    };

    const PIRCard = ({ pir, onClick }) => (
        <div 
            className="pir-card-enhanced"
            onClick={onClick}
            style={{
                background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                borderRadius: '12px',
                padding: '20px',
                marginBottom: '15px',
                cursor: 'pointer',
                transition: 'transform 0.2s, box-shadow 0.2s',
                color: 'white',
                boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
            }}
            onMouseEnter={(e) => {
                e.currentTarget.style.transform = 'translateY(-2px)';
                e.currentTarget.style.boxShadow = '0 6px 12px rgba(0,0,0,0.15)';
            }}
            onMouseLeave={(e) => {
                e.currentTarget.style.transform = 'translateY(0)';
                e.currentTarget.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
            }}
        >
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start' }}>
                <div>
                    <h3 style={{ margin: '0 0 10px 0', fontSize: '1.4em' }}>
                        👤 {pir.displayName || `${pir.firstName} ${pir.lastName}` || pir.email}
                    </h3>
                    <div style={{ display: 'flex', gap: '20px', fontSize: '0.95em', opacity: '0.95' }}>
                        <span>📊 {pir.activeGoals || 0} Active</span>
                        <span>✅ {pir.completedGoals || 0} Complete</span>
                        <span>📈 {pir.overallProgress || 0}% Progress</span>
                    </div>
                </div>
                <div style={{ 
                    background: 'rgba(255,255,255,0.2)', 
                    borderRadius: '20px', 
                    padding: '8px 16px',
                    fontSize: '2em',
                    fontWeight: 'bold'
                }}>
                    {pir.overallProgress || 0}%
                </div>
            </div>
            
            {(pir.overdueAssignments > 0 || pir.nearCompletion > 0) && (
                <div style={{ 
                    marginTop: '15px', 
                    paddingTop: '15px', 
                    borderTop: '1px solid rgba(255,255,255,0.2)'
                }}>
                    {pir.overdueAssignments > 0 && (
                        <span style={{ 
                            background: 'rgba(255,100,100,0.3)', 
                            padding: '4px 12px', 
                            borderRadius: '15px',
                            marginRight: '10px',
                            fontSize: '0.9em'
                        }}>
                            ⚠️ {pir.overdueAssignments} Overdue
                        </span>
                    )}
                    {pir.nearCompletion > 0 && (
                        <span style={{ 
                            background: 'rgba(100,255,100,0.3)', 
                            padding: '4px 12px', 
                            borderRadius: '15px',
                            fontSize: '0.9em'
                        }}>
                            🎯 {pir.nearCompletion} Near Completion
                        </span>
                    )}
                </div>
            )}
        </div>
    );

    const ActionButton = ({ icon, label, onClick, variant = 'primary' }) => {
        const colors = {
            primary: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
            success: 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)',
            warning: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
            info: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)'
        };

        return (
            <button
                onClick={onClick}
                style={{
                    background: colors[variant],
                    border: 'none',
                    borderRadius: '8px',
                    color: 'white',
                    padding: '10px 20px',
                    fontSize: '0.95em',
                    fontWeight: '500',
                    cursor: 'pointer',
                    transition: 'transform 0.2s',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.05)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
            >
                <span style={{ fontSize: '1.2em' }}>{icon}</span>
                {label}
            </button>
        );
    };

    const GoalItem = ({ goal }) => {
        const isExpanded = expandedGoals.has(goal.id);
        const objectives = pirGoalsData.objectives.filter(obj => obj.goalId === goal.id);
        const isCompleted = goal.status === 'completed';
        
        return (
            <div style={{
                background: isCompleted ? '#f0f8ff' : 'white',
                borderRadius: '10px',
                padding: '20px',
                marginBottom: '15px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                transition: 'all 0.3s',
                opacity: isCompleted ? 0.9 : 1
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <div 
                        onClick={() => toggleGoalExpand(goal.id)}
                        style={{ cursor: 'pointer', flex: 1 }}
                    >
                        <h4 style={{ margin: 0, color: '#333', display: 'flex', alignItems: 'center', gap: '10px' }}>
                            <span>{isExpanded ? '▼' : '▶'}</span>
                            {goal.title}
                            <span style={{
                                background: isCompleted ? '#00A86B' : `linear-gradient(90deg, #0077CC ${goal.progress}%, #e0e0e0 ${goal.progress}%)`,
                                padding: '2px 10px',
                                borderRadius: '12px',
                                fontSize: '0.8em',
                                color: 'white'
                            }}>
                                {isCompleted ? 'Completed' : `${goal.progress}%`}
                            </span>
                        </h4>
                        <div style={{ marginTop: '5px', fontSize: '0.9em', color: '#666' }}>
                            Created: {formatDate(goal.createdAt)} 
                            {goal.dueDate && ` • Due: ${formatDate(goal.dueDate)}`}
                            {goal.completedAt && ` • Completed: ${formatDate(goal.completedAt)}`}
                        </div>
                        {goal.description && (
                            <div style={{ marginTop: '8px', fontSize: '0.9em', color: '#555' }}>
                                {goal.description}
                            </div>
                        )}
                    </div>
                    <div style={{ display: 'flex', gap: '10px' }}>
                        {!isCompleted && (
                            <>
                                <button
                                    onClick={() => {
                                        setSelectedParent({ type: 'goal', id: goal.id, title: goal.title });
                                        setModalType('objective');
                                        setShowCreateModal(true);
                                    }}
                                    style={{
                                        background: '#00A86B',
                                        border: 'none',
                                        borderRadius: '6px',
                                        color: 'white',
                                        padding: '6px 12px',
                                        cursor: 'pointer',
                                        fontSize: '0.85em'
                                    }}
                                >
                                    + Objective
                                </button>
                                <button
                                    onClick={() => handleCompleteGoal(goal.id)}
                                    style={{
                                        background: '#4682B4',
                                        border: 'none',
                                        borderRadius: '6px',
                                        color: 'white',
                                        padding: '6px 12px',
                                        cursor: 'pointer',
                                        fontSize: '0.85em'
                                    }}
                                >
                                    Complete
                                </button>
                            </>
                        )}
                    </div>
                </div>
                
                {isExpanded && (
                    <div style={{ marginTop: '20px', paddingLeft: '30px' }}>
                        {objectives.map(objective => (
                            <ObjectiveItem key={objective.id} objective={objective} goal={goal} />
                        ))}
                        {objectives.length === 0 && (
                            <p style={{ color: '#999', fontSize: '0.9em' }}>No objectives yet</p>
                        )}
                    </div>
                )}
            </div>
        );
    };

    const ObjectiveItem = ({ objective, goal }) => {
        const isExpanded = expandedObjectives.has(objective.id);
        const assignments = pirGoalsData.assignments.filter(a => a.objectiveId === objective.id);
        const isCompleted = objective.status === 'completed';
        
        return (
            <div style={{
                background: isCompleted ? '#f5fff5' : '#f8f9fa',
                borderLeft: `3px solid ${isCompleted ? '#00A86B' : '#0077CC'}`,
                padding: '15px',
                marginBottom: '10px',
                borderRadius: '6px',
                opacity: isCompleted ? 0.9 : 1
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <div 
                        onClick={() => toggleObjectiveExpand(objective.id)}
                        style={{ cursor: 'pointer', flex: 1 }}
                    >
                        <h5 style={{ margin: 0, color: '#555', display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <span>{isExpanded ? '▼' : '▶'}</span>
                            {objective.title}
                            <span style={{
                                background: isCompleted ? '#00A86B' : '#FFA726',
                                padding: '2px 8px',
                                borderRadius: '10px',
                                fontSize: '0.75em',
                                color: 'white'
                            }}>
                                {isCompleted ? 'completed' : 'active'}
                            </span>
                        </h5>
                        <div style={{ marginTop: '5px', fontSize: '0.85em', color: '#777' }}>
                            {objective.dueDate && `Due: ${formatDate(objective.dueDate)}`}
                            {objective.completedAt && ` • Completed: ${formatDate(objective.completedAt)}`}
                        </div>
                    </div>
                    <div style={{ display: 'flex', gap: '10px' }}>
                        {!isCompleted && (
                            <>
                                <button
                                    onClick={() => {
                                        setSelectedParent({
                                            type: 'objective',
                                            id: objective.id,
                                            goalId: goal.id,
                                            title: `${goal.title} > ${objective.title}`
                                        });
                                        setModalType('assignment');
                                        setShowCreateModal(true);
                                    }}
                                    style={{
                                        background: '#9C27B0',
                                        border: 'none',
                                        borderRadius: '6px',
                                        color: 'white',
                                        padding: '5px 10px',
                                        cursor: 'pointer',
                                        fontSize: '0.8em'
                                    }}
                                >
                                    + Assignment
                                </button>
                                <button
                                    onClick={() => handleCompleteObjective(objective.id)}
                                    style={{
                                        background: '#FFA500',
                                        border: 'none',
                                        borderRadius: '6px',
                                        color: 'white',
                                        padding: '5px 10px',
                                        cursor: 'pointer',
                                        fontSize: '0.8em'
                                    }}
                                >
                                    Complete
                                </button>
                            </>
                        )}
                    </div>
                </div>
                
                {isExpanded && (
                    <div style={{ marginTop: '15px', paddingLeft: '20px' }}>
                        {assignments.map(assignment => (
                            <AssignmentItem key={assignment.id} assignment={assignment} />
                        ))}
                        {assignments.length === 0 && (
                            <p style={{ color: '#999', fontSize: '0.9em' }}>No assignments yet</p>
                        )}
                    </div>
                )}
            </div>
        );
    };

    const AssignmentItem = ({ assignment }) => {
        const isCompleted = assignment.status === 'completed';
        
        return (
            <div style={{
                background: isCompleted ? '#f0fff0' : 'white',
                border: `1px solid ${isCompleted ? '#c8e6c9' : '#e0e0e0'}`,
                padding: '12px',
                marginBottom: '8px',
                borderRadius: '4px',
                display: 'flex',
                alignItems: 'flex-start',
                gap: '10px'
            }}>
                <span style={{ fontSize: '1.2em', marginTop: '2px' }}>
                    {isCompleted ? '✅' : '⏳'}
                </span>
                <div style={{ flex: 1 }}>
                    <div style={{ fontWeight: '500', color: '#333' }}>
                        {assignment.title}
                    </div>
                    {assignment.description && (
                        <div style={{ fontSize: '0.85em', color: '#666', marginTop: '4px' }}>
                            {assignment.description}
                        </div>
                    )}
                    {assignment.reflection && (
                        <div style={{
                            background: '#e3f2fd',
                            padding: '8px',
                            borderRadius: '4px',
                            marginTop: '8px',
                            fontSize: '0.85em',
                            borderLeft: '3px solid #2196F3'
                        }}>
                            <strong style={{ color: '#1565C0' }}>PIR Reflection:</strong>
                            <div style={{ marginTop: '4px', color: '#424242' }}>
                                {assignment.reflection}
                            </div>
                        </div>
                    )}
                    <div style={{ fontSize: '0.8em', color: '#999', marginTop: '6px' }}>
                        {assignment.createdAt && `Created: ${formatDate(assignment.createdAt)}`}
                        {assignment.dueDate && ` • Due: ${formatDate(assignment.dueDate)}`}
                        {assignment.completedAt && ` • Completed: ${formatDate(assignment.completedAt)}`}
                    </div>
                </div>
            </div>
        );
    };

    // Rest of component remains the same...
    if (loading) {
        return (
            <div style={{ 
                display: 'flex', 
                justifyContent: 'center', 
                alignItems: 'center', 
                height: '400px' 
            }}>
                <div className="loading-spinner"></div>
            </div>
        );
    }

    if (selectedPIR) {
        return (
            <div style={{ padding: '20px' }}>
                <div style={{ 
                    display: 'flex', 
                    justifyContent: 'space-between', 
                    alignItems: 'center',
                    marginBottom: '30px',
                    background: 'white',
                    padding: '20px',
                    borderRadius: '10px',
                    boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                }}>
                    <div>
                        <button
                            onClick={() => setSelectedPIR(null)}
                            style={{
                                background: 'none',
                                border: 'none',
                                color: '#0077CC',
                                cursor: 'pointer',
                                fontSize: '1em',
                                marginBottom: '10px',
                                padding: 0
                            }}
                        >
                            ← Back to PIR List
                        </button>
                        <h2 style={{ margin: 0, color: '#333' }}>
                            {selectedPIR.displayName || selectedPIR.email}'s Recovery Plan
                        </h2>
                        <div style={{ 
                            marginTop: '10px',
                            fontSize: '1.2em',
                            color: '#666'
                        }}>
                            Overall Progress: {Math.round(pirGoalsData.goals.reduce((acc, g) => acc + g.progress, 0) / (pirGoalsData.goals.length || 1))}%
                        </div>
                    </div>
                    
                    <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                        <ActionButton 
                            icon="🧵" 
                            label="Golden Thread" 
                            variant="primary"
                            onClick={() => {
                                setModalType('goldenThread');
                                setShowCreateModal(true);
                            }}
                        />
                        <ActionButton 
                            icon="🎯" 
                            label="Add Goal" 
                            variant="success"
                            onClick={() => {
                                setModalType('goal');
                                setShowCreateModal(true);
                            }}
                        />
                        <ActionButton 
                            icon="⭐" 
                            label="Add Milestone" 
                            variant="warning"
                            onClick={() => {
                                setModalType('milestone');
                                setShowCreateModal(true);
                            }}
                        />
                    </div>
                </div>

                <div style={{ marginTop: '20px' }}>
                    {pirGoalsData.goals.map(goal => (
                        <GoalItem key={goal.id} goal={goal} />
                    ))}
                    
                    {pirGoalsData.goals.length === 0 && (
                        <div style={{
                            background: 'white',
                            borderRadius: '10px',
                            padding: '40px',
                            textAlign: 'center',
                            color: '#999'
                        }}>
                            <h3>No goals assigned yet</h3>
                            <p>Start with a Golden Thread to create a structured recovery plan</p>
                        </div>
                    )}
                </div>

                {/* MODAL RENDERING */}
                {showCreateModal && (
                    <CreateGoalModal
                        type={modalType}
                        selectedPIR={selectedPIR}
                        selectedParent={selectedParent}
                        onSubmit={(data) => {
                            if (modalType === 'goldenThread') {
                                // Golden thread handles its own submit
                                return;
                            } else if (modalType === 'goal') {
                                handleCreateGoal(data);
                            } else if (modalType === 'objective') {
                                handleCreateObjective(data);
                            } else if (modalType === 'assignment') {
                                handleCreateAssignment(data);
                            } else if (modalType === 'milestone') {
                                handleCreateMilestone(data);
                            }
                        }}
                        onClose={() => {
                            setShowCreateModal(false);
                            setSelectedParent(null);
                        }}
                    />
                )}
            </div>
        );
    }

    return (
        <div style={{ padding: '20px' }}>
            <h2 style={{ marginBottom: '30px', color: '#333' }}>PIR Goals Management</h2>
            <div>
                {pirs.map(pir => (
                    <PIRCard 
                        key={pir.id} 
                        pir={pir} 
                        onClick={() => setSelectedPIR(pir)}
                    />
                ))}
                
                {pirs.length === 0 && (
                    <div style={{
                        background: 'white',
                        borderRadius: '10px',
                        padding: '40px',
                        textAlign: 'center',
                        color: '#999'
                    }}>
                        <h3>No active PIRs found</h3>
                        <p>PIRs will appear here once they are added to the system</p>
                    </div>
                )}
            </div>

            {/* MODAL RENDERING FOR MAIN VIEW */}
            {showCreateModal && (
                <CreateGoalModal
                    type={modalType}
                    selectedPIR={selectedPIR}
                    selectedParent={selectedParent}
                    onSubmit={(data) => {
                        if (modalType === 'goldenThread') {
                            // Golden thread handles its own submit
                            return;
                        } else if (modalType === 'goal') {
                            handleCreateGoal(data);
                        } else if (modalType === 'objective') {
                            handleCreateObjective(data);
                        } else if (modalType === 'assignment') {
                            handleCreateAssignment(data);
                        } else if (modalType === 'milestone') {
                            handleCreateMilestone(data);
                        }
                    }}
                    onClose={() => {
                        setShowCreateModal(false);
                        setSelectedParent(null);
                    }}
                />
            )}
        </div>
    );
}

// Enhanced Golden Thread Modal - COMPLETE VERSION
function CreateGoalModal({ type, selectedPIR, selectedParent, currentUser, onSubmit, onClose }) {
    const [goldenThreadData, setGoldenThreadData] = useState({
        goals: [
            {
                title: '',
                description: '',
                dueDate: '',
                objectives: [
                    { title: '', dueDate: '', assignments: [{ title: '', description: '', dueDate: '' }] },
                    { title: '', dueDate: '', assignments: [{ title: '', description: '', dueDate: '' }] }
                ]
            },
            {
                title: '',
                description: '',
                dueDate: '',
                objectives: [
                    { title: '', dueDate: '', assignments: [{ title: '', description: '', dueDate: '' }] },
                    { title: '', dueDate: '', assignments: [{ title: '', description: '', dueDate: '' }] }
                ]
            }
        ]
    });

    const [singleFormData, setSingleFormData] = useState({
        title: '',
        description: '',
        dueDate: '',
        targetDate: '',
        icon: '🎯',
        goalId: selectedParent?.goalId || '',
        objectiveId: selectedParent?.id || ''
    });

    const addGoal = () => {
        setGoldenThreadData({
            ...goldenThreadData,
            goals: [...goldenThreadData.goals, {
                title: '',
                description: '',
                dueDate: '',
                objectives: [
                    { title: '', dueDate: '', assignments: [{ title: '', description: '', dueDate: '' }] }
                ]
            }]
        });
    };

    const addObjective = (goalIndex) => {
        const newGoals = [...goldenThreadData.goals];
        newGoals[goalIndex].objectives.push({
            title: '',
            dueDate: '',
            assignments: [{ title: '', description: '', dueDate: '' }]
        });
        setGoldenThreadData({ ...goldenThreadData, goals: newGoals });
    };

    const addAssignment = (goalIndex, objIndex) => {
        const newGoals = [...goldenThreadData.goals];
        newGoals[goalIndex].objectives[objIndex].assignments.push({
            title: '',
            description: '',
            dueDate: ''
        });
        setGoldenThreadData({ ...goldenThreadData, goals: newGoals });
    };

    const updateGoal = (index, field, value) => {
        const newGoals = [...goldenThreadData.goals];
        newGoals[index][field] = value;
        setGoldenThreadData({ ...goldenThreadData, goals: newGoals });
    };

    const updateObjective = (goalIndex, objIndex, field, value) => {
        const newGoals = [...goldenThreadData.goals];
        newGoals[goalIndex].objectives[objIndex][field] = value;
        setGoldenThreadData({ ...goldenThreadData, goals: newGoals });
    };

    const updateAssignment = (goalIndex, objIndex, assignIndex, field, value) => {
        const newGoals = [...goldenThreadData.goals];
        newGoals[goalIndex].objectives[objIndex].assignments[assignIndex][field] = value;
        setGoldenThreadData({ ...goldenThreadData, goals: newGoals });
    };

    const handleGoldenThreadSubmit = async () => {
        try {
            for (const goal of goldenThreadData.goals) {
                if (!goal.title) continue;
                
                const goalRef = await db.collection('goals').add({
                    userId: selectedPIR.id,
                    title: goal.title,
                    description: goal.description,
                    dueDate: goal.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(goal.dueDate)) : null,
                    status: 'active',
                    createdBy: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                for (let i = 0; i < goal.objectives.length; i++) {
                    const objective = goal.objectives[i];
                    if (!objective.title) continue;
                    
                    const objectiveRef = await db.collection('objectives').add({
                        goalId: goalRef.id,
                        userId: selectedPIR.id,
                        title: objective.title,
                        order: i + 1,
                        dueDate: objective.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(objective.dueDate)) : null,
                        status: 'active',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    for (const assignment of objective.assignments) {
                        if (!assignment.title) continue;
                        
                        await db.collection('assignments').add({
                            goalId: goalRef.id,
                            objectiveId: objectiveRef.id,
                            userId: selectedPIR.id,
                            pirName: selectedPIR.displayName || selectedPIR.email,
                            coachId: currentUser.uid,
                            coachName: currentUser.displayName || currentUser.email,
                            title: assignment.title,
                            description: assignment.description,
                            dueDate: assignment.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(assignment.dueDate)) : null,
                            status: 'pending',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }
            }

            alert('Golden Thread created successfully!');
            onClose();
            window.location.reload();
        } catch (error) {
            console.error('Error creating golden thread:', error);
            alert('Failed to create golden thread');
        }
    };

    if (type === 'goldenThread') {
        return (
            <div className="modal-overlay" style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0,0,0,0.5)',
                display: 'flex',
                justifyContent: 'center',
                alignItems: 'center',
                zIndex: 1000,
                overflow: 'auto'
            }}>
                <div style={{
                    background: 'white',
                    borderRadius: '12px',
                    width: '90%',
                    maxWidth: '900px',
                    maxHeight: '90vh',
                    overflow: 'auto',
                    padding: '30px'
                }}>
                    <div style={{ 
                        display: 'flex', 
                        justifyContent: 'space-between', 
                        alignItems: 'center',
                        marginBottom: '20px'
                    }}>
                        <h2 style={{ margin: 0 }}>Create Golden Thread</h2>
                        <button 
                            onClick={onClose}
                            style={{
                                background: 'none',
                                border: 'none',
                                fontSize: '24px',
                                cursor: 'pointer'
                            }}
                        >
                            ×
                        </button>
                    </div>

                    {goldenThreadData.goals.map((goal, goalIndex) => (
                        <div key={goalIndex} style={{
                            background: '#f8f9fa',
                            borderRadius: '8px',
                            padding: '20px',
                            marginBottom: '20px'
                        }}>
                            <h3 style={{ color: '#0077CC', marginTop: 0 }}>Goal {goalIndex + 1}</h3>
                            <input
                                type="text"
                                placeholder="Goal Title"
                                value={goal.title}
                                onChange={(e) => updateGoal(goalIndex, 'title', e.target.value)}
                                style={{
                                    width: '100%',
                                    padding: '10px',
                                    marginBottom: '10px',
                                    border: '1px solid #ddd',
                                    borderRadius: '6px'
                                }}
                            />
                            <textarea
                                placeholder="Goal Description"
                                value={goal.description}
                                onChange={(e) => updateGoal(goalIndex, 'description', e.target.value)}
                                style={{
                                    width: '100%',
                                    padding: '10px',
                                    marginBottom: '10px',
                                    border: '1px solid #ddd',
                                    borderRadius: '6px',
                                    minHeight: '60px'
                                }}
                            />
                            <input
                                type="date"
                                value={goal.dueDate}
                                onChange={(e) => updateGoal(goalIndex, 'dueDate', e.target.value)}
                                style={{
                                    padding: '10px',
                                    marginBottom: '20px',
                                    border: '1px solid #ddd',
                                    borderRadius: '6px'
                                }}
                            />

                            {goal.objectives.map((objective, objIndex) => (
                                <div key={objIndex} style={{
                                    background: 'white',
                                    borderLeft: '3px solid #0077CC',
                                    padding: '15px',
                                    marginLeft: '20px',
                                    marginBottom: '15px',
                                    borderRadius: '4px'
                                }}>
                                    <h4 style={{ color: '#555', marginTop: 0 }}>Objective {objIndex + 1}</h4>
                                    <input
                                        type="text"
                                        placeholder="Objective Title"
                                        value={objective.title}
                                        onChange={(e) => updateObjective(goalIndex, objIndex, 'title', e.target.value)}
                                        style={{
                                            width: '100%',
                                            padding: '8px',
                                            marginBottom: '8px',
                                            border: '1px solid #ddd',
                                            borderRadius: '4px'
                                        }}
                                    />
                                    <input
                                        type="date"
                                        value={objective.dueDate}
                                        onChange={(e) => updateObjective(goalIndex, objIndex, 'dueDate', e.target.value)}
                                        style={{
                                            padding: '8px',
                                            marginBottom: '15px',
                                            border: '1px solid #ddd',
                                            borderRadius: '4px'
                                        }}
                                    />

                                    {objective.assignments.map((assignment, assignIndex) => (
                                        <div key={assignIndex} style={{
                                            background: '#f8f9fa',
                                            padding: '10px',
                                            marginLeft: '20px',
                                            marginBottom: '8px',
                                            borderRadius: '4px'
                                        }}>
                                            <div style={{ color: '#777', fontSize: '0.9em', marginBottom: '5px' }}>
                                                Assignment {assignIndex + 1}
                                            </div>
                                            <input
                                                type="text"
                                                placeholder="Assignment Title"
                                                value={assignment.title}
                                                onChange={(e) => updateAssignment(goalIndex, objIndex, assignIndex, 'title', e.target.value)}
                                                style={{
                                                    width: '100%',
                                                    padding: '6px',
                                                    marginBottom: '6px',
                                                    border: '1px solid #ddd',
                                                    borderRadius: '4px'
                                                }}
                                            />
                                            <input
                                                type="text"
                                                placeholder="Assignment Description"
                                                value={assignment.description}
                                                onChange={(e) => updateAssignment(goalIndex, objIndex, assignIndex, 'description', e.target.value)}
                                                style={{
                                                    width: '100%',
                                                    padding: '6px',
                                                    marginBottom: '6px',
                                                    border: '1px solid #ddd',
                                                    borderRadius: '4px'
                                                }}
                                            />
                                            <input
                                                type="date"
                                                value={assignment.dueDate}
                                                onChange={(e) => updateAssignment(goalIndex, objIndex, assignIndex, 'dueDate', e.target.value)}
                                                style={{
                                                    padding: '6px',
                                                    border: '1px solid #ddd',
                                                    borderRadius: '4px'
                                                }}
                                            />
                                        </div>
                                    ))}
                                    
                                    <button
                                        onClick={() => addAssignment(goalIndex, objIndex)}
                                        style={{
                                            marginLeft: '20px',
                                            marginTop: '5px',
                                            background: '#9C27B0',
                                            border: 'none',
                                            borderRadius: '4px',
                                            color: 'white',
                                            padding: '6px 12px',
                                            cursor: 'pointer',
                                            fontSize: '0.85em'
                                        }}
                                    >
                                        + Add Assignment
                                    </button>
                                </div>
                            ))}
                            
                            <button
                                onClick={() => addObjective(goalIndex)}
                                style={{
                                    marginLeft: '20px',
                                    background: '#00A86B',
                                    border: 'none',
                                    borderRadius: '4px',
                                    color: 'white',
                                    padding: '8px 16px',
                                    cursor: 'pointer'
                                }}
                            >
                                + Add Objective
                            </button>
                        </div>
                    ))}
                    
                    <button
                        onClick={addGoal}
                        style={{
                            background: '#4682B4',
                            border: 'none',
                            borderRadius: '6px',
                            color: 'white',
                            padding: '10px 20px',
                            cursor: 'pointer',
                            marginBottom: '20px'
                        }}
                    >
                        + Add Another Goal
                    </button>
                    
                    <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                        <button
                            onClick={onClose}
                            style={{
                                background: '#e0e0e0',
                                border: 'none',
                                borderRadius: '6px',
                                padding: '12px 24px',
                                cursor: 'pointer'
                            }}
                        >
                            Cancel
                        </button>
                        <button
                            onClick={handleGoldenThreadSubmit}
                            style={{
                                background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                border: 'none',
                                borderRadius: '6px',
                                color: 'white',
                                padding: '12px 24px',
                                cursor: 'pointer',
                                fontWeight: 'bold'
                            }}
                        >
                            Create Golden Thread
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // Regular single item creation forms
    return (
        <div className="modal-overlay" style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0,0,0,0.5)',
            display: 'flex',
            justifyContent: 'center',
            alignItems: 'center',
            zIndex: 1000
        }}>
            <div style={{
                background: 'white',
                borderRadius: '12px',
                width: '90%',
                maxWidth: '500px',
                padding: '30px'
            }}>
                <div style={{ 
                    display: 'flex', 
                    justifyContent: 'space-between', 
                    alignItems: 'center',
                    marginBottom: '20px'
                }}>
                    <h2 style={{ margin: 0 }}>
                        {type === 'goal' && 'Add New Goal'}
                        {type === 'objective' && `Add Objective to: ${selectedParent?.title}`}
                        {type === 'assignment' && `Add Assignment to: ${selectedParent?.title}`}
                        {type === 'milestone' && 'Add Custom Milestone'}
                    </h2>
                    <button 
                        onClick={onClose}
                        style={{
                            background: 'none',
                            border: 'none',
                            fontSize: '24px',
                            cursor: 'pointer'
                        }}
                    >
                        ×
                    </button>
                </div>

                <form onSubmit={(e) => {
                    e.preventDefault();
                    onSubmit({...singleFormData, ...selectedParent});
                }}>
                    <input
                        type="text"
                        placeholder="Title"
                        value={singleFormData.title}
                        onChange={(e) => setSingleFormData({...singleFormData, title: e.target.value})}
                        required
                        style={{
                            width: '100%',
                            padding: '10px',
                            marginBottom: '15px',
                            border: '1px solid #ddd',
                            borderRadius: '6px'
                        }}
                    />
                    
                    {(type === 'goal' || type === 'assignment' || type === 'milestone') && (
                        <textarea
                            placeholder="Description"
                            value={singleFormData.description}
                            onChange={(e) => setSingleFormData({...singleFormData, description: e.target.value})}
                            style={{
                                width: '100%',
                                padding: '10px',
                                marginBottom: '15px',
                                border: '1px solid #ddd',
                                borderRadius: '6px',
                                minHeight: '80px'
                            }}
                        />
                    )}
                    
                    <input
                        type="date"
                        value={singleFormData.dueDate || singleFormData.targetDate}
                        onChange={(e) => setSingleFormData({
                            ...singleFormData, 
                            dueDate: e.target.value,
                            targetDate: e.target.value
                        })}
                        style={{
                            width: '100%',
                            padding: '10px',
                            marginBottom: '15px',
                            border: '1px solid #ddd',
                            borderRadius: '6px'
                        }}
                    />
                    
                    <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                        <button
                            type="button"
                            onClick={onClose}
                            style={{
                                background: '#e0e0e0',
                                border: 'none',
                                borderRadius: '6px',
                                padding: '10px 20px',
                                cursor: 'pointer'
                            }}
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            style={{
                                background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                border: 'none',
                                borderRadius: '6px',
                                color: 'white',
                                padding: '10px 20px',
                                cursor: 'pointer',
                                fontWeight: 'bold'
                            }}
                        >
                            Create
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
}
     // ========================================
// RESOURCESVIEW - COMPLETE MAIN VIEW COMPONENT
// Matches UserDetailModal styling patterns
// Uses root-level Firestore with tenantId filtering
// ========================================
function ResourcesView({ user, searchQuery }) {
    // ========== CORE STATES ==========
    const [resources, setResources] = useState([]);
    const [loading, setLoading] = useState(true);
    const [showCreateModal, setShowCreateModal] = useState(false);
    const [showDetailModal, setShowDetailModal] = useState(false);
    const [selectedResource, setSelectedResource] = useState(null);
    
    // ========== FILTER STATES ==========
    const [filterType, setFilterType] = useState('all');
    const [filterCategory, setFilterCategory] = useState('all');
    const [filterStatus, setFilterStatus] = useState('all');
    const [viewMode, setViewMode] = useState('grid'); // 'grid' or 'list'
    const [sortBy, setSortBy] = useState('newest'); // 'newest', 'oldest', 'title', 'category'
    
    // ========== STATS STATE ==========
    const [stats, setStats] = useState({
        total: 0,
        active: 0,
        inactive: 0,
        global: 0,
        assigned: 0,
        byType: {},
        byCategory: {}
    });

    // ========== LOAD DATA ON MOUNT ==========
    useEffect(() => {
        loadResourcesData();
    }, []);

    // ========== DATA LOADING FUNCTIONS ==========
    const loadResourcesData = async () => {
        try {
            setLoading(true);
            
            // Query root-level resources filtered by tenantId (matching UserDetailModal pattern)
            const resourcesRef = db.collection('resources')
                .where('tenantId', '==', user.tenantId);
            
            const snapshot = await resourcesRef.get();
            const resourcesData = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));

            console.log(`✓ Loaded ${resourcesData.length} resources for tenant: ${user.tenantId}`);
            setResources(resourcesData);
            calculateStats(resourcesData);
        } catch (error) {
            console.error('Error loading resources:', error);
            alert('Failed to load resources: ' + error.message);
        } finally {
            setLoading(false);
        }
    };

    const calculateStats = (resourcesData) => {
        const stats = {
            total: resourcesData.length,
            active: resourcesData.filter(r => r.active !== false).length,
            inactive: resourcesData.filter(r => r.active === false).length,
            global: resourcesData.filter(r => r.isGlobal === true).length,
            assigned: resourcesData.filter(r => r.assignedTo && r.assignedTo.length > 0).length,
            byType: {},
            byCategory: {}
        };

        resourcesData.forEach(resource => {
            // Count by type
            const type = resource.type || 'unknown';
            stats.byType[type] = (stats.byType[type] || 0) + 1;

            // Count by category
            const category = resource.category || 'uncategorized';
            stats.byCategory[category] = (stats.byCategory[category] || 0) + 1;
        });

        setStats(stats);
    };

    // ========== EVENT HANDLERS ==========
    const handleResourceClick = (resource) => {
        setSelectedResource(resource);
        setShowDetailModal(true);
    };

    const handleDeleteResource = async (resourceId) => {
        if (!confirm('Are you sure you want to delete this resource? This action cannot be undone.')) return;

        try {
            await db.collection('resources').doc(resourceId).delete();
            await loadResourcesData();
            alert('Resource deleted successfully');
        } catch (error) {
            console.error('Error deleting resource:', error);
            alert('Failed to delete resource: ' + error.message);
        }
    };

    const handleToggleStatus = async (resource, e) => {
        e.stopPropagation(); // Prevent opening modal
        
        try {
            const newStatus = !resource.active;
            await db.collection('resources')
                .doc(resource.id)
                .update({
                    active: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

            await loadResourcesData();
        } catch (error) {
            console.error('Error updating resource status:', error);
            alert('Failed to update resource status');
        }
    };

    const handleRefresh = () => {
        loadResourcesData();
    };

    // ========== FILTERING & SORTING ==========
    const getFilteredAndSortedResources = () => {
        let filtered = [...resources];

        // Apply search query
        if (searchQuery && searchQuery.trim()) {
            const query = searchQuery.toLowerCase();
            filtered = filtered.filter(resource => 
                resource.title?.toLowerCase().includes(query) ||
                resource.description?.toLowerCase().includes(query) ||
                resource.category?.toLowerCase().includes(query) ||
                resource.type?.toLowerCase().includes(query)
            );
        }

        // Apply type filter
        if (filterType !== 'all') {
            filtered = filtered.filter(r => r.type === filterType);
        }

        // Apply category filter
        if (filterCategory !== 'all') {
            filtered = filtered.filter(r => r.category === filterCategory);
        }

        // Apply status filter
        if (filterStatus === 'active') {
            filtered = filtered.filter(r => r.active !== false);
        } else if (filterStatus === 'inactive') {
            filtered = filtered.filter(r => r.active === false);
        } else if (filterStatus === 'global') {
            filtered = filtered.filter(r => r.isGlobal === true);
        } else if (filterStatus === 'assigned') {
            filtered = filtered.filter(r => r.assignedTo && r.assignedTo.length > 0);
        }

        // Apply sorting
        filtered.sort((a, b) => {
            switch (sortBy) {
                case 'newest':
                    return (b.addedAt?.seconds || 0) - (a.addedAt?.seconds || 0);
                case 'oldest':
                    return (a.addedAt?.seconds || 0) - (b.addedAt?.seconds || 0);
                case 'title':
                    return (a.title || '').localeCompare(b.title || '');
                case 'category':
                    return (a.category || '').localeCompare(b.category || '');
                default:
                    return 0;
            }
        });

        return filtered;
    };

    const filteredResources = getFilteredAndSortedResources();

    // ========== RENDER: LOADING STATE ==========
    if (loading) {
        return (
            <div style={{ 
                padding: '40px', 
                textAlign: 'center',
                background: 'var(--background-secondary)',
                minHeight: '100vh',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center'
            }}>
                <div>
                    <div style={{
                        width: '60px',
                        height: '60px',
                        border: '4px solid var(--background-primary)',
                        borderTop: '4px solid var(--primary-color)',
                        borderRadius: '50%',
                        animation: 'spin 1s linear infinite',
                        margin: '0 auto 20px'
                    }}></div>
                    <div style={{ 
                        fontSize: '18px', 
                        color: 'var(--text-primary)',
                        fontWeight: '600'
                    }}>
                        Loading resources...
                    </div>
                </div>
            </div>
        );
    }

    // ========== RENDER: MAIN VIEW ==========
    return (
        <div style={{ 
            padding: '30px',
            background: 'var(--background-secondary)',
            minHeight: '100vh'
        }}>
            {/* ========== HEADER SECTION ========== */}
            <div style={{ 
                display: 'flex', 
                justifyContent: 'space-between', 
                alignItems: 'center',
                marginBottom: '30px',
                flexWrap: 'wrap',
                gap: '20px'
            }}>
                <div>
                    <h1 style={{ 
                        margin: '0 0 8px 0',
                        color: 'var(--text-primary)',
                        fontSize: '32px',
                        fontWeight: '600',
                        letterSpacing: '-0.5px'
                    }}>
                        📚 Resources
                    </h1>
                    <p style={{ 
                        margin: 0,
                        color: 'var(--text-secondary)',
                        fontSize: '16px'
                    }}>
                        Manage recovery resources and educational materials
                    </p>
                </div>
                <div style={{ display: 'flex', gap: '12px' }}>
                    <button
                        onClick={handleRefresh}
                        style={{
                            background: 'var(--background-primary)',
                            color: 'var(--text-primary)',
                            border: '1px solid var(--border-color)',
                            padding: '12px 20px',
                            borderRadius: 'var(--radius-md)',
                            fontSize: '16px',
                            fontWeight: '600',
                            cursor: 'pointer',
                            transition: 'var(--transition-fast)',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px'
                        }}
                        onMouseEnter={(e) => {
                            e.currentTarget.style.background = 'var(--bg-primary-light)';
                        }}
                        onMouseLeave={(e) => {
                            e.currentTarget.style.background = 'var(--background-primary)';
                        }}
                    >
                        🔄 Refresh
                    </button>
                    <button
                        onClick={() => setShowCreateModal(true)}
                        style={{
                            background: 'var(--gradient-primary)',
                            color: 'var(--text-white)',
                            border: 'none',
                            padding: '14px 28px',
                            borderRadius: 'var(--radius-md)',
                            fontSize: '16px',
                            fontWeight: '600',
                            cursor: 'pointer',
                            boxShadow: 'var(--shadow-md)',
                            transition: 'var(--transition-fast)',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px'
                        }}
                        onMouseEnter={(e) => {
                            e.currentTarget.style.transform = 'translateY(-2px)';
                            e.currentTarget.style.boxShadow = 'var(--shadow-lg)';
                        }}
                        onMouseLeave={(e) => {
                            e.currentTarget.style.transform = 'translateY(0)';
                            e.currentTarget.style.boxShadow = 'var(--shadow-md)';
                        }}
                    >
                        ➕ Create Resource
                    </button>
                </div>
            </div>

            {/* ========== STATS CARDS ========== */}
            <div style={{ 
                display: 'grid', 
                gridTemplateColumns: 'repeat(auto-fit, minmax(240px, 1fr))',
                gap: '20px',
                marginBottom: '30px'
            }}>
                {/* Total Resources */}
                <div style={{
                    background: 'var(--gradient-info)',
                    padding: '25px',
                    borderRadius: 'var(--radius-lg)',
                    boxShadow: 'var(--shadow-md)',
                    cursor: 'pointer',
                    transition: 'var(--transition-fast)'
                }}
                onClick={() => setFilterStatus('all')}
                onMouseEnter={(e) => {
                    e.currentTarget.style.transform = 'translateY(-4px)';
                    e.currentTarget.style.boxShadow = 'var(--shadow-lg)';
                }}
                onMouseLeave={(e) => {
                    e.currentTarget.style.transform = 'translateY(0)';
                    e.currentTarget.style.boxShadow = 'var(--shadow-md)';
                }}>
                    <div style={{ 
                        fontSize: '14px', 
                        color: 'var(--text-white)',
                        fontWeight: '600',
                        marginBottom: '10px',
                        textTransform: 'uppercase',
                        letterSpacing: '0.5px',
                        opacity: 0.95
                    }}>
                        TOTAL RESOURCES
                    </div>
                    <div style={{ 
                        fontSize: '48px', 
                        color: 'var(--text-white)',
                        fontWeight: '700',
                        marginBottom: '5px',
                        lineHeight: 1
                    }}>
                        {stats.total}
                    </div>
                    <div style={{ 
                        fontSize: '14px', 
                        color: 'var(--text-white)',
                        opacity: 0.9
                    }}>
                        All time
                    </div>
                </div>

                {/* Active Resources */}
                <div style={{
                    background: 'var(--gradient-success)',
                    padding: '25px',
                    borderRadius: 'var(--radius-lg)',
                    boxShadow: 'var(--shadow-md)',
                    cursor: 'pointer',
                    transition: 'var(--transition-fast)'
                }}
                onClick={() => setFilterStatus('active')}
                onMouseEnter={(e) => {
                    e.currentTarget.style.transform = 'translateY(-4px)';
                    e.currentTarget.style.boxShadow = 'var(--shadow-lg)';
                }}
                onMouseLeave={(e) => {
                    e.currentTarget.style.transform = 'translateY(0)';
                    e.currentTarget.style.boxShadow = 'var(--shadow-md)';
                }}>
                    <div style={{ 
                        fontSize: '14px', 
                        color: 'var(--text-white)',
                        fontWeight: '600',
                        marginBottom: '10px',
                        textTransform: 'uppercase',
                        letterSpacing: '0.5px',
                        opacity: 0.95
                    }}>
                        ACTIVE RESOURCES
                    </div>
                    <div style={{ 
                        fontSize: '48px', 
                        color: 'var(--text-white)',
                        fontWeight: '700',
                        marginBottom: '5px',
                        lineHeight: 1
                    }}>
                        {stats.active}
                    </div>
                    <div style={{ 
                        fontSize: '14px', 
                        color: 'var(--text-white)',
                        opacity: 0.9
                    }}>
                        Visible to PIRs
                    </div>
                </div>

                {/* Resource Types */}
                <div style={{
                    background: 'var(--gradient-primary)',
                    padding: '25px',
                    borderRadius: 'var(--radius-lg)',
                    boxShadow: 'var(--shadow-md)',
                    cursor: 'pointer',
                    transition: 'var(--transition-fast)'
                }}
                onMouseEnter={(e) => {
                    e.currentTarget.style.transform = 'translateY(-4px)';
                    e.currentTarget.style.boxShadow = 'var(--shadow-lg)';
                }}
                onMouseLeave={(e) => {
                    e.currentTarget.style.transform = 'translateY(0)';
                    e.currentTarget.style.boxShadow = 'var(--shadow-md)';
                }}>
                    <div style={{ 
                        fontSize: '14px', 
                        color: 'var(--text-white)',
                        fontWeight: '600',
                        marginBottom: '10px',
                        textTransform: 'uppercase',
                        letterSpacing: '0.5px',
                        opacity: 0.95
                    }}>
                        RESOURCE TYPES
                    </div>
                    <div style={{ 
                        fontSize: '48px', 
                        color: 'var(--text-white)',
                        fontWeight: '700',
                        marginBottom: '5px',
                        lineHeight: 1
                    }}>
                        {Object.keys(stats.byType).length}
                    </div>
                    <div style={{ 
                        fontSize: '14px', 
                        color: 'var(--text-white)',
                        opacity: 0.9
                    }}>
                        Different formats
                    </div>
                </div>

                {/* Categories */}
                <div style={{
                    background: 'var(--gradient-warning)',
                    padding: '25px',
                    borderRadius: 'var(--radius-lg)',
                    boxShadow: 'var(--shadow-md)',
                    cursor: 'pointer',
                    transition: 'var(--transition-fast)'
                }}
                onMouseEnter={(e) => {
                    e.currentTarget.style.transform = 'translateY(-4px)';
                    e.currentTarget.style.boxShadow = 'var(--shadow-lg)';
                }}
                onMouseLeave={(e) => {
                    e.currentTarget.style.transform = 'translateY(0)';
                    e.currentTarget.style.boxShadow = 'var(--shadow-md)';
                }}>
                    <div style={{ 
                        fontSize: '14px', 
                        color: 'var(--text-white)',
                        fontWeight: '600',
                        marginBottom: '10px',
                        textTransform: 'uppercase',
                        letterSpacing: '0.5px',
                        opacity: 0.95
                    }}>
                        CATEGORIES
                    </div>
                    <div style={{ 
                        fontSize: '48px', 
                        color: 'var(--text-white)',
                        fontWeight: '700',
                        marginBottom: '5px',
                        lineHeight: 1
                    }}>
                        {Object.keys(stats.byCategory).length}
                    </div>
                    <div style={{ 
                        fontSize: '14px', 
                        color: 'var(--text-white)',
                        opacity: 0.9
                    }}>
                        Organized topics
                    </div>
                </div>

                {/* Global Resources */}
                <div style={{
                    background: 'var(--gradient-info)',
                    padding: '25px',
                    borderRadius: 'var(--radius-lg)',
                    boxShadow: 'var(--shadow-md)',
                    cursor: 'pointer',
                    transition: 'var(--transition-fast)'
                }}
                onClick={() => setFilterStatus('global')}
                onMouseEnter={(e) => {
                    e.currentTarget.style.transform = 'translateY(-4px)';
                    e.currentTarget.style.boxShadow = 'var(--shadow-lg)';
                }}
                onMouseLeave={(e) => {
                    e.currentTarget.style.transform = 'translateY(0)';
                    e.currentTarget.style.boxShadow = 'var(--shadow-md)';
                }}>
                    <div style={{ 
                        fontSize: '14px', 
                        color: 'var(--text-white)',
                        fontWeight: '600',
                        marginBottom: '10px',
                        textTransform: 'uppercase',
                        letterSpacing: '0.5px',
                        opacity: 0.95
                    }}>
                        GLOBAL RESOURCES
                    </div>
                    <div style={{ 
                        fontSize: '48px', 
                        color: 'var(--text-white)',
                        fontWeight: '700',
                        marginBottom: '5px',
                        lineHeight: 1
                    }}>
                        {stats.global}
                    </div>
                    <div style={{ 
                        fontSize: '14px', 
                        color: 'var(--text-white)',
                        opacity: 0.9
                    }}>
                        Available to all PIRs
                    </div>
                </div>

                {/* Assigned Resources */}
                <div style={{
                    background: 'var(--gradient-primary)',
                    padding: '25px',
                    borderRadius: 'var(--radius-lg)',
                    boxShadow: 'var(--shadow-md)',
                    cursor: 'pointer',
                    transition: 'var(--transition-fast)'
                }}
                onClick={() => setFilterStatus('assigned')}
                onMouseEnter={(e) => {
                    e.currentTarget.style.transform = 'translateY(-4px)';
                    e.currentTarget.style.boxShadow = 'var(--shadow-lg)';
                }}
                onMouseLeave={(e) => {
                    e.currentTarget.style.transform = 'translateY(0)';
                    e.currentTarget.style.boxShadow = 'var(--shadow-md)';
                }}>
                    <div style={{ 
                        fontSize: '14px', 
                        color: 'var(--text-white)',
                        fontWeight: '600',
                        marginBottom: '10px',
                        textTransform: 'uppercase',
                        letterSpacing: '0.5px',
                        opacity: 0.95
                    }}>
                        ASSIGNED RESOURCES
                    </div>
                    <div style={{ 
                        fontSize: '48px', 
                        color: 'var(--text-white)',
                        fontWeight: '700',
                        marginBottom: '5px',
                        lineHeight: 1
                    }}>
                        {stats.assigned}
                    </div>
                    <div style={{ 
                        fontSize: '14px', 
                        color: 'var(--text-white)',
                        opacity: 0.9
                    }}>
                        Assigned to PIRs
                    </div>
                </div>
            </div>

            {/* ========== FILTERS & CONTROLS ========== */}
            <div style={{
                background: 'var(--background-primary)',
                padding: '20px',
                borderRadius: 'var(--radius-lg)',
                marginBottom: '25px',
                boxShadow: 'var(--shadow-sm)',
                display: 'flex',
                gap: '15px',
                alignItems: 'center',
                flexWrap: 'wrap'
            }}>
                {/* Type Filter */}
                <select
                    value={filterType}
                    onChange={(e) => setFilterType(e.target.value)}
                    style={{
                        padding: '10px 15px',
                        borderRadius: 'var(--radius-md)',
                        border: '1px solid var(--border-color)',
                        background: 'var(--background-secondary)',
                        color: 'var(--text-primary)',
                        fontSize: '14px',
                        fontWeight: '500',
                        cursor: 'pointer',
                        minWidth: '150px',
                        transition: 'var(--transition-fast)'
                    }}
                >
                    <option value="all">All Types</option>
                    {Object.keys(stats.byType).sort().map(type => (
                        <option key={type} value={type}>
                            {type.charAt(0).toUpperCase() + type.slice(1)} ({stats.byType[type]})
                        </option>
                    ))}
                </select>

                {/* Category Filter */}
                <select
                    value={filterCategory}
                    onChange={(e) => setFilterCategory(e.target.value)}
                    style={{
                        padding: '10px 15px',
                        borderRadius: 'var(--radius-md)',
                        border: '1px solid var(--border-color)',
                        background: 'var(--background-secondary)',
                        color: 'var(--text-primary)',
                        fontSize: '14px',
                        fontWeight: '500',
                        cursor: 'pointer',
                        minWidth: '150px',
                        transition: 'var(--transition-fast)'
                    }}
                >
                    <option value="all">All Categories</option>
                    {Object.keys(stats.byCategory).sort().map(category => (
                        <option key={category} value={category}>
                            {category.charAt(0).toUpperCase() + category.slice(1)} ({stats.byCategory[category]})
                        </option>
                    ))}
                </select>

                {/* Status Filter */}
                <select
                    value={filterStatus}
                    onChange={(e) => setFilterStatus(e.target.value)}
                    style={{
                        padding: '10px 15px',
                        borderRadius: 'var(--radius-md)',
                        border: '1px solid var(--border-color)',
                        background: 'var(--background-secondary)',
                        color: 'var(--text-primary)',
                        fontSize: '14px',
                        fontWeight: '500',
                        cursor: 'pointer',
                        minWidth: '150px',
                        transition: 'var(--transition-fast)'
                    }}
                >
                    <option value="all">All Status</option>
                    <option value="active">Active Only</option>
                    <option value="inactive">Inactive Only</option>
                    <option value="global">Global Only</option>
                    <option value="assigned">Assigned Only</option>
                </select>

                {/* Sort By */}
                <select
                    value={sortBy}
                    onChange={(e) => setSortBy(e.target.value)}
                    style={{
                        padding: '10px 15px',
                        borderRadius: 'var(--radius-md)',
                        border: '1px solid var(--border-color)',
                        background: 'var(--background-secondary)',
                        color: 'var(--text-primary)',
                        fontSize: '14px',
                        fontWeight: '500',
                        cursor: 'pointer',
                        minWidth: '150px',
                        transition: 'var(--transition-fast)'
                    }}
                >
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="title">Title (A-Z)</option>
                    <option value="category">Category</option>
                </select>

                {/* View Mode Toggle */}
                <div style={{ marginLeft: 'auto', display: 'flex', gap: '10px' }}>
                    <button
                        onClick={() => setViewMode('grid')}
                        style={{
                            padding: '10px 20px',
                            background: viewMode === 'grid' ? 'var(--gradient-primary)' : 'var(--background-secondary)',
                            color: viewMode === 'grid' ? 'var(--text-white)' : 'var(--text-primary)',
                            border: '1px solid var(--border-color)',
                            borderRadius: 'var(--radius-md)',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '600',
                            transition: 'var(--transition-fast)'
                        }}
                    >
                        ⊞ Grid
                    </button>
                    <button
                        onClick={() => setViewMode('list')}
                        style={{
                            padding: '10px 20px',
                            background: viewMode === 'list' ? 'var(--gradient-primary)' : 'var(--background-secondary)',
                            color: viewMode === 'list' ? 'var(--text-white)' : 'var(--text-primary)',
                            border: '1px solid var(--border-color)',
                            borderRadius: 'var(--radius-md)',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '600',
                            transition: 'var(--transition-fast)'
                        }}
                    >
                        ☰ List
                    </button>
                </div>
            </div>

            {/* Results Count */}
            <div style={{
                marginBottom: '20px',
                color: 'var(--text-secondary)',
                fontSize: '14px',
                fontWeight: '500'
            }}>
                Showing {filteredResources.length} of {stats.total} resources
            </div>

            {/* ========== RESOURCES GRID/LIST ========== */}
            {filteredResources.length === 0 ? (
                <div style={{
                    textAlign: 'center',
                    padding: '80px 20px',
                    background: 'var(--background-primary)',
                    borderRadius: 'var(--radius-lg)',
                    boxShadow: 'var(--shadow-sm)'
                }}>
                    <div style={{ fontSize: '64px', marginBottom: '20px' }}>📚</div>
                    <div style={{ 
                        fontSize: '24px', 
                        fontWeight: '600',
                        color: 'var(--text-primary)',
                        marginBottom: '10px'
                    }}>
                        {resources.length === 0 ? 'No resources yet' : 'No resources match your filters'}
                    </div>
                    <div style={{ 
                        fontSize: '16px',
                        color: 'var(--text-secondary)',
                        marginBottom: '30px'
                    }}>
                        {resources.length === 0 
                            ? 'Create your first resource to get started' 
                            : 'Try adjusting your filters to see more resources'}
                    </div>
                    {resources.length === 0 && (
                        <button
                            onClick={() => setShowCreateModal(true)}
                            style={{
                                background: 'var(--gradient-primary)',
                                color: 'var(--text-white)',
                                border: 'none',
                                padding: '14px 28px',
                                borderRadius: 'var(--radius-md)',
                                fontSize: '16px',
                                fontWeight: '600',
                                cursor: 'pointer',
                                boxShadow: 'var(--shadow-md)',
                                transition: 'var(--transition-fast)'
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.transform = 'translateY(-2px)';
                                e.currentTarget.style.boxShadow = 'var(--shadow-lg)';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.transform = 'translateY(0)';
                                e.currentTarget.style.boxShadow = 'var(--shadow-md)';
                            }}
                        >
                            ➕ Create First Resource
                        </button>
                    )}
                </div>
            ) : (
                <div style={{
                    display: viewMode === 'grid' ? 'grid' : 'flex',
                    gridTemplateColumns: viewMode === 'grid' ? 'repeat(auto-fill, minmax(320px, 1fr))' : 'none',
                    flexDirection: viewMode === 'list' ? 'column' : 'none',
                    gap: '20px'
                }}>
                    {filteredResources.map(resource => (
                        <div
                            key={resource.id}
                            onClick={() => handleResourceClick(resource)}
                            style={{
                                background: 'var(--background-primary)',
                                padding: '25px',
                                borderRadius: 'var(--radius-lg)',
                                boxShadow: 'var(--shadow-sm)',
                                cursor: 'pointer',
                                transition: 'var(--transition-fast)',
                                border: '1px solid var(--border-color)',
                                display: 'flex',
                                flexDirection: viewMode === 'list' ? 'row' : 'column',
                                gap: viewMode === 'list' ? '20px' : '0'
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.transform = 'translateY(-4px)';
                                e.currentTarget.style.boxShadow = 'var(--shadow-lg)';
                                e.currentTarget.style.borderColor = 'var(--primary-color)';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.transform = 'translateY(0)';
                                e.currentTarget.style.boxShadow = 'var(--shadow-sm)';
                                e.currentTarget.style.borderColor = 'var(--border-color)';
                            }}
                        >
                            {/* Resource Icon & Status */}
                            <div style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'flex-start',
                                marginBottom: viewMode === 'grid' ? '15px' : '0',
                                minWidth: viewMode === 'list' ? '100px' : 'auto'
                            }}>
                                <div style={{
                                    fontSize: viewMode === 'list' ? '48px' : '40px'
                                }}>
                                    {resource.type === 'link' ? '🔗' :
                                     resource.type === 'file' ? '📄' :
                                     resource.type === 'video' ? '🎥' :
                                     resource.type === 'article' ? '📰' : '📚'}
                                </div>
                                {viewMode === 'grid' && (
                                    <div style={{
                                        padding: '6px 12px',
                                        background: resource.active !== false ? 'var(--gradient-success)' : 'var(--gradient-danger)',
                                        color: 'var(--text-white)',
                                        borderRadius: 'var(--radius-md)',
                                        fontSize: '12px',
                                        fontWeight: '600'
                                    }}>
                                        {resource.active !== false ? '✓ Active' : '✕ Inactive'}
                                    </div>
                                )}
                            </div>

                            {/* Resource Content */}
                            <div style={{ flex: 1 }}>
                                {/* Title */}
                                <h3 style={{
                                    margin: '0 0 10px 0',
                                    fontSize: viewMode === 'list' ? '20px' : '18px',
                                    fontWeight: '600',
                                    color: 'var(--text-primary)',
                                    lineHeight: '1.3'
                                }}>
                                    {resource.title}
                                </h3>

                                {/* Description */}
                                <p style={{
                                    margin: '0 0 15px 0',
                                    fontSize: '14px',
                                    color: 'var(--text-secondary)',
                                    lineHeight: '1.5',
                                    display: '-webkit-box',
                                    WebkitLineClamp: viewMode === 'list' ? 2 : 3,
                                    WebkitBoxOrient: 'vertical',
                                    overflow: 'hidden'
                                }}>
                                    {resource.description || 'No description provided'}
                                </p>

                                {/* Tags */}
                                <div style={{
                                    display: 'flex',
                                    gap: '10px',
                                    flexWrap: 'wrap',
                                    marginBottom: viewMode === 'list' ? '0' : '15px'
                                }}>
                                    <span style={{
                                        padding: '6px 12px',
                                        background: 'var(--bg-primary-light)',
                                        color: 'var(--primary-color)',
                                        borderRadius: 'var(--radius-md)',
                                        fontSize: '12px',
                                        fontWeight: '600'
                                    }}>
                                        {resource.category || 'Uncategorized'}
                                    </span>
                                    <span style={{
                                        padding: '6px 12px',
                                        background: 'var(--bg-info-light)',
                                        color: 'var(--info-color)',
                                        borderRadius: 'var(--radius-md)',
                                        fontSize: '12px',
                                        fontWeight: '600'
                                    }}>
                                        {resource.type}
                                    </span>
                                    {resource.isGlobal && (
                                        <span style={{
                                            padding: '6px 12px',
                                            background: 'var(--bg-warning-light)',
                                            color: 'var(--warning-color)',
                                            borderRadius: 'var(--radius-md)',
                                            fontSize: '12px',
                                            fontWeight: '600'
                                        }}>
                                            🌐 Global
                                        </span>
                                    )}
                                    {resource.assignedTo && resource.assignedTo.length > 0 && (
                                        <span style={{
                                            padding: '6px 12px',
                                            background: 'var(--bg-success-light)',
                                            color: 'var(--success-color)',
                                            borderRadius: 'var(--radius-md)',
                                            fontSize: '12px',
                                            fontWeight: '600'
                                        }}>
                                            👥 {resource.assignedTo.length} PIR{resource.assignedTo.length !== 1 ? 's' : ''}
                                        </span>
                                    )}
                                </div>
                            </div>

                            {/* List View Actions */}
                            {viewMode === 'list' && (
                                <div style={{
                                    display: 'flex',
                                    flexDirection: 'column',
                                    gap: '10px',
                                    minWidth: '120px'
                                }}>
                                    <div style={{
                                        padding: '8px 16px',
                                        background: resource.active !== false ? 'var(--gradient-success)' : 'var(--gradient-danger)',
                                        color: 'var(--text-white)',
                                        borderRadius: 'var(--radius-md)',
                                        fontSize: '12px',
                                        fontWeight: '600',
                                        textAlign: 'center'
                                    }}>
                                        {resource.active !== false ? '✓ Active' : '✕ Inactive'}
                                    </div>
                                    <button
                                        onClick={(e) => handleToggleStatus(resource, e)}
                                        style={{
                                            padding: '8px 16px',
                                            background: 'var(--background-secondary)',
                                            color: 'var(--text-primary)',
                                            border: '1px solid var(--border-color)',
                                            borderRadius: 'var(--radius-md)',
                                            fontSize: '12px',
                                            fontWeight: '600',
                                            cursor: 'pointer',
                                            transition: 'var(--transition-fast)'
                                        }}
                                        onMouseEnter={(e) => {
                                            e.currentTarget.style.background = 'var(--bg-primary-light)';
                                        }}
                                        onMouseLeave={(e) => {
                                            e.currentTarget.style.background = 'var(--background-secondary)';
                                        }}
                                    >
                                        Toggle
                                    </button>
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            )}

            {/* ========== MODALS ========== */}
            {showCreateModal && (
                <ResourceCreateModal
                    user={user}
                    onClose={() => setShowCreateModal(false)}
                    onSuccess={() => {
                        setShowCreateModal(false);
                        loadResourcesData();
                    }}
                />
            )}

            {showDetailModal && selectedResource && (
                <ResourceDetailModal
                    resource={selectedResource}
                    user={user}
                    onClose={() => {
                        setShowDetailModal(false);
                        setSelectedResource(null);
                    }}
                    onUpdate={() => {
                        loadResourcesData();
                    }}
                    onDelete={(id) => {
                        handleDeleteResource(id);
                        setShowDetailModal(false);
                        setSelectedResource(null);
                    }}
                />
            )}
        </div>
    );
}
    
   // ========================================
// RESOURCECREATEMODAL - COMPLETE CREATION MODAL
// Matches UserDetailModal styling patterns
// Uses root-level Firestore with tenantId field
// ========================================
function ResourceCreateModal({ user, onClose, onSuccess }) {
    // ========== FORM STATE ==========
    const [formData, setFormData] = useState({
        title: '',
        description: '',
        type: 'link',
        category: '',
        url: '',
        fileURL: '',
        embedUrl: '',
        content: '',
        isGlobal: false,
        active: true,
        tags: []
    });

    // ========== UI STATES ==========
    const [saving, setSaving] = useState(false);
    const [errors, setErrors] = useState({});
    const [showCategoryDropdown, setShowCategoryDropdown] = useState(false);
    const [customCategory, setCustomCategory] = useState('');
    
    // ========== PREDEFINED CATEGORIES ==========
    const predefinedCategories = [
        'Education',
        'Coping Skills',
        'Mindfulness',
        'Exercise & Wellness',
        'Nutrition',
        'Sleep Hygiene',
        'Stress Management',
        'Relapse Prevention',
        'Support Groups',
        'Motivational',
        'Personal Growth',
        'Relationships',
        'Financial Wellness',
        'Career Development',
        'Creative Expression'
    ];

    // ========== VALIDATION ==========
    const validateForm = () => {
        const newErrors = {};

        // Title validation
        if (!formData.title.trim()) {
            newErrors.title = 'Title is required';
        } else if (formData.title.length < 3) {
            newErrors.title = 'Title must be at least 3 characters';
        } else if (formData.title.length > 100) {
            newErrors.title = 'Title must be less than 100 characters';
        }

        // Category validation
        if (!formData.category.trim()) {
            newErrors.category = 'Category is required';
        }

        // Type-specific validation
        if (formData.type === 'link' && !formData.url.trim()) {
            newErrors.url = 'URL is required for link resources';
        } else if (formData.type === 'link' && formData.url.trim()) {
            try {
                new URL(formData.url);
            } catch (e) {
                newErrors.url = 'Please enter a valid URL';
            }
        }

        if (formData.type === 'file' && !formData.fileURL.trim()) {
            newErrors.fileURL = 'File URL is required for file resources';
        }

        if (formData.type === 'video' && !formData.embedUrl.trim()) {
            newErrors.embedUrl = 'Video embed URL is required for video resources';
        }

        if (formData.type === 'article' && !formData.content.trim()) {
            newErrors.content = 'Content is required for article resources';
        }

        setErrors(newErrors);
        return Object.keys(newErrors).length === 0;
    };

    // ========== FORM SUBMISSION ==========
    const handleSubmit = async (e) => {
        e.preventDefault();
        
        if (!validateForm()) {
            return;
        }

        try {
            setSaving(true);
            
            // Create resource in root-level collection with tenantId field
            await db.collection('resources').add({
                title: formData.title.trim(),
                description: formData.description.trim(),
                type: formData.type,
                category: formData.category.trim(),
                url: formData.url.trim(),
                fileURL: formData.fileURL.trim(),
                embedUrl: formData.embedUrl.trim(),
                content: formData.content.trim(),
                contentType: formData.type,
                isGlobal: formData.isGlobal,
                active: formData.active,
                tags: formData.tags,
                tenantId: user.tenantId,
                addedBy: user.uid,
                addedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                assignedTo: [],
                viewCount: 0,
                completionCount: 0
            });

            alert('Resource created successfully! 🎉');
            onSuccess();
        } catch (error) {
            console.error('Error creating resource:', error);
            alert('Failed to create resource: ' + error.message);
        } finally {
            setSaving(false);
        }
    };

    // ========== HELPER FUNCTIONS ==========
    const handleCategorySelect = (category) => {
        setFormData({...formData, category});
        setShowCategoryDropdown(false);
        setCustomCategory('');
    };

    const handleCustomCategory = () => {
        if (customCategory.trim()) {
            setFormData({...formData, category: customCategory.trim()});
            setShowCategoryDropdown(false);
            setCustomCategory('');
        }
    };

    const getResourceTypeIcon = (type) => {
        switch (type) {
            case 'link': return '🔗';
            case 'file': return '📄';
            case 'video': return '🎥';
            case 'article': return '📰';
            default: return '📚';
        }
    };

    const getResourceTypeDescription = (type) => {
        switch (type) {
            case 'link': return 'External website or web resource';
            case 'file': return 'PDF, document, or downloadable file';
            case 'video': return 'YouTube, Vimeo, or embedded video';
            case 'article': return 'Written content stored in the system';
            default: return 'Select a resource type';
        }
    };

    // ========== RENDER ==========
    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.5)',
            backdropFilter: 'blur(5px)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000,
            animation: 'fadeIn 0.3s ease-in-out',
            padding: '20px'
        }}>
            <div style={{
                maxWidth: '700px',
                width: '100%',
                maxHeight: '90vh',
                background: 'var(--text-white)',
                borderRadius: 'var(--radius-xl)',
                boxShadow: 'var(--shadow-xl)',
                display: 'flex',
                flexDirection: 'column',
                overflow: 'hidden',
                animation: 'slideUp 0.3s ease-out'
            }}>
                {/* ========== MODAL HEADER ========== */}
                <div style={{
                    background: 'var(--gradient-primary)',
                    padding: '25px 30px',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    borderBottom: '1px solid rgba(255,255,255,0.1)'
                }}>
                    <div>
                        <h3 style={{
                            margin: '0 0 5px 0',
                            color: 'var(--text-white)',
                            fontSize: '24px',
                            fontWeight: '600',
                            letterSpacing: '-0.5px'
                        }}>
                            Create New Resource
                        </h3>
                        <p style={{
                            margin: 0,
                            color: 'var(--text-white)',
                            fontSize: '14px',
                            opacity: 0.9
                        }}>
                            Add educational content for PIRs
                        </p>
                    </div>
                    <button
                        onClick={onClose}
                        disabled={saving}
                        style={{
                            background: 'rgba(255,255,255,0.2)',
                            border: 'none',
                            color: 'var(--text-white)',
                            fontSize: '28px',
                            width: '40px',
                            height: '40px',
                            borderRadius: '50%',
                            cursor: saving ? 'not-allowed' : 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            transition: 'var(--transition-fast)',
                            fontWeight: '300',
                            opacity: saving ? 0.5 : 1
                        }}
                        onMouseEnter={(e) => {
                            if (!saving) {
                                e.currentTarget.style.background = 'rgba(255,255,255,0.3)';
                                e.currentTarget.style.transform = 'rotate(90deg)';
                            }
                        }}
                        onMouseLeave={(e) => {
                            if (!saving) {
                                e.currentTarget.style.background = 'rgba(255,255,255,0.2)';
                                e.currentTarget.style.transform = 'rotate(0deg)';
                            }
                        }}
                    >
                        ×
                    </button>
                </div>

                {/* ========== MODAL CONTENT ========== */}
                <form onSubmit={handleSubmit} style={{
                    flex: 1,
                    overflowY: 'auto',
                    background: 'var(--background-secondary)'
                }}>
                    <div style={{ padding: '30px' }}>
                        
                        {/* ========== BASIC INFO SECTION ========== */}
                        <div style={{
                            background: 'var(--background-primary)',
                            padding: '25px',
                            borderRadius: 'var(--radius-lg)',
                            marginBottom: '25px',
                            boxShadow: 'var(--shadow-sm)'
                        }}>
                            <h4 style={{
                                margin: '0 0 20px 0',
                                color: 'var(--text-primary)',
                                fontSize: '18px',
                                fontWeight: '600',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px'
                            }}>
                                📝 Basic Information
                            </h4>

                            {/* Title Field */}
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{
                                    display: 'block',
                                    marginBottom: '8px',
                                    color: 'var(--text-primary)',
                                    fontWeight: '600',
                                    fontSize: '14px'
                                }}>
                                    Resource Title *
                                </label>
                                <input
                                    type="text"
                                    value={formData.title}
                                    onChange={(e) => setFormData({...formData, title: e.target.value})}
                                    placeholder="e.g., Guided Meditation for Stress Relief"
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        borderRadius: 'var(--radius-md)',
                                        border: errors.title ? '2px solid var(--danger-color)' : '1px solid var(--border-color)',
                                        fontSize: '14px',
                                        color: 'var(--text-primary)',
                                        background: 'var(--background-secondary)',
                                        transition: 'var(--transition-fast)'
                                    }}
                                    onFocus={(e) => {
                                        if (!errors.title) {
                                            e.currentTarget.style.borderColor = 'var(--primary-color)';
                                        }
                                    }}
                                    onBlur={(e) => {
                                        if (!errors.title) {
                                            e.currentTarget.style.borderColor = 'var(--border-color)';
                                        }
                                    }}
                                />
                                {errors.title && (
                                    <div style={{
                                        marginTop: '5px',
                                        color: 'var(--danger-color)',
                                        fontSize: '12px',
                                        fontWeight: '500'
                                    }}>
                                        ⚠️ {errors.title}
                                    </div>
                                )}
                            </div>

                            {/* Description Field */}
                            <div style={{ marginBottom: '0' }}>
                                <label style={{
                                    display: 'block',
                                    marginBottom: '8px',
                                    color: 'var(--text-primary)',
                                    fontWeight: '600',
                                    fontSize: '14px'
                                }}>
                                    Description
                                </label>
                                <textarea
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                    placeholder="Describe what this resource is about and how it can help PIRs..."
                                    rows="4"
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        borderRadius: 'var(--radius-md)',
                                        border: '1px solid var(--border-color)',
                                        fontSize: '14px',
                                        color: 'var(--text-primary)',
                                        background: 'var(--background-secondary)',
                                        resize: 'vertical',
                                        fontFamily: 'inherit',
                                        lineHeight: '1.5',
                                        transition: 'var(--transition-fast)'
                                    }}
                                    onFocus={(e) => {
                                        e.currentTarget.style.borderColor = 'var(--primary-color)';
                                    }}
                                    onBlur={(e) => {
                                        e.currentTarget.style.borderColor = 'var(--border-color)';
                                    }}
                                />
                            </div>
                        </div>

                        {/* ========== RESOURCE TYPE SECTION ========== */}
                        <div style={{
                            background: 'var(--background-primary)',
                            padding: '25px',
                            borderRadius: 'var(--radius-lg)',
                            marginBottom: '25px',
                            boxShadow: 'var(--shadow-sm)'
                        }}>
                            <h4 style={{
                                margin: '0 0 20px 0',
                                color: 'var(--text-primary)',
                                fontSize: '18px',
                                fontWeight: '600',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px'
                            }}>
                                📋 Resource Type
                            </h4>

                            {/* Type Selector */}
                            <div style={{
                                display: 'grid',
                                gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))',
                                gap: '15px',
                                marginBottom: '20px'
                            }}>
                                {['link', 'file', 'video', 'article'].map(type => (
                                    <div
                                        key={type}
                                        onClick={() => setFormData({...formData, type})}
                                        style={{
                                            padding: '20px',
                                            borderRadius: 'var(--radius-md)',
                                            border: formData.type === type ? '2px solid var(--primary-color)' : '1px solid var(--border-color)',
                                            background: formData.type === type ? 'var(--bg-primary-light)' : 'var(--background-secondary)',
                                            cursor: 'pointer',
                                            transition: 'var(--transition-fast)',
                                            textAlign: 'center'
                                        }}
                                        onMouseEnter={(e) => {
                                            if (formData.type !== type) {
                                                e.currentTarget.style.borderColor = 'var(--primary-color)';
                                                e.currentTarget.style.transform = 'translateY(-2px)';
                                            }
                                        }}
                                        onMouseLeave={(e) => {
                                            if (formData.type !== type) {
                                                e.currentTarget.style.borderColor = 'var(--border-color)';
                                                e.currentTarget.style.transform = 'translateY(0)';
                                            }
                                        }}
                                    >
                                        <div style={{ fontSize: '32px', marginBottom: '8px' }}>
                                            {getResourceTypeIcon(type)}
                                        </div>
                                        <div style={{
                                            fontSize: '14px',
                                            fontWeight: '600',
                                            color: formData.type === type ? 'var(--primary-color)' : 'var(--text-primary)',
                                            textTransform: 'capitalize'
                                        }}>
                                            {type}
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {/* Type Description */}
                            <div style={{
                                padding: '15px',
                                background: 'var(--bg-info-light)',
                                borderLeft: '4px solid var(--info-color)',
                                borderRadius: 'var(--radius-md)',
                                fontSize: '14px',
                                color: 'var(--text-primary)',
                                lineHeight: '1.5'
                            }}>
                                <strong>ℹ️ {formData.type.charAt(0).toUpperCase() + formData.type.slice(1)}:</strong> {getResourceTypeDescription(formData.type)}
                            </div>

                            {/* Type-Specific Fields */}
                            <div style={{ marginTop: '20px' }}>
                                {formData.type === 'link' && (
                                    <div>
                                        <label style={{
                                            display: 'block',
                                            marginBottom: '8px',
                                            color: 'var(--text-primary)',
                                            fontWeight: '600',
                                            fontSize: '14px'
                                        }}>
                                            URL *
                                        </label>
                                        <input
                                            type="url"
                                            value={formData.url}
                                            onChange={(e) => setFormData({...formData, url: e.target.value})}
                                            placeholder="https://example.com/resource"
                                            style={{
                                                width: '100%',
                                                padding: '12px 15px',
                                                borderRadius: 'var(--radius-md)',
                                                border: errors.url ? '2px solid var(--danger-color)' : '1px solid var(--border-color)',
                                                fontSize: '14px',
                                                color: 'var(--text-primary)',
                                                background: 'var(--background-secondary)',
                                                transition: 'var(--transition-fast)'
                                            }}
                                            onFocus={(e) => {
                                                if (!errors.url) {
                                                    e.currentTarget.style.borderColor = 'var(--primary-color)';
                                                }
                                            }}
                                            onBlur={(e) => {
                                                if (!errors.url) {
                                                    e.currentTarget.style.borderColor = 'var(--border-color)';
                                                }
                                            }}
                                        />
                                        {errors.url && (
                                            <div style={{
                                                marginTop: '5px',
                                                color: 'var(--danger-color)',
                                                fontSize: '12px',
                                                fontWeight: '500'
                                            }}>
                                                ⚠️ {errors.url}
                                            </div>
                                        )}
                                    </div>
                                )}

                                {formData.type === 'file' && (
                                    <div>
                                        <label style={{
                                            display: 'block',
                                            marginBottom: '8px',
                                            color: 'var(--text-primary)',
                                            fontWeight: '600',
                                            fontSize: '14px'
                                        }}>
                                            File URL *
                                        </label>
                                        <input
                                            type="url"
                                            value={formData.fileURL}
                                            onChange={(e) => setFormData({...formData, fileURL: e.target.value})}
                                            placeholder="https://storage.googleapis.com/..."
                                            style={{
                                                width: '100%',
                                                padding: '12px 15px',
                                                borderRadius: 'var(--radius-md)',
                                                border: errors.fileURL ? '2px solid var(--danger-color)' : '1px solid var(--border-color)',
                                                fontSize: '14px',
                                                color: 'var(--text-primary)',
                                                background: 'var(--background-secondary)',
                                                transition: 'var(--transition-fast)'
                                            }}
                                            onFocus={(e) => {
                                                if (!errors.fileURL) {
                                                    e.currentTarget.style.borderColor = 'var(--primary-color)';
                                                }
                                            }}
                                            onBlur={(e) => {
                                                if (!errors.fileURL) {
                                                    e.currentTarget.style.borderColor = 'var(--border-color)';
                                                }
                                            }}
                                        />
                                        {errors.fileURL && (
                                            <div style={{
                                                marginTop: '5px',
                                                color: 'var(--danger-color)',
                                                fontSize: '12px',
                                                fontWeight: '500'
                                            }}>
                                                ⚠️ {errors.fileURL}
                                            </div>
                                        )}
                                        <div style={{
                                            marginTop: '8px',
                                            fontSize: '12px',
                                            color: 'var(--text-secondary)'
                                        }}>
                                            💡 Upload your file to Google Drive or Firebase Storage first, then paste the URL here
                                        </div>
                                    </div>
                                )}

                                {formData.type === 'video' && (
                                    <div>
                                        <label style={{
                                            display: 'block',
                                            marginBottom: '8px',
                                            color: 'var(--text-primary)',
                                            fontWeight: '600',
                                            fontSize: '14px'
                                        }}>
                                            Video Embed URL *
                                        </label>
                                        <input
                                            type="url"
                                            value={formData.embedUrl}
                                            onChange={(e) => setFormData({...formData, embedUrl: e.target.value})}
                                            placeholder="https://youtube.com/embed/..."
                                            style={{
                                                width: '100%',
                                                padding: '12px 15px',
                                                borderRadius: 'var(--radius-md)',
                                                border: errors.embedUrl ? '2px solid var(--danger-color)' : '1px solid var(--border-color)',
                                                fontSize: '14px',
                                                color: 'var(--text-primary)',
                                                background: 'var(--background-secondary)',
                                                transition: 'var(--transition-fast)'
                                            }}
                                            onFocus={(e) => {
                                                if (!errors.embedUrl) {
                                                    e.currentTarget.style.borderColor = 'var(--primary-color)';
                                                }
                                            }}
                                            onBlur={(e) => {
                                                if (!errors.embedUrl) {
                                                    e.currentTarget.style.borderColor = 'var(--border-color)';
                                                }
                                            }}
                                        />
                                        {errors.embedUrl && (
                                            <div style={{
                                                marginTop: '5px',
                                                color: 'var(--danger-color)',
                                                fontSize: '12px',
                                                fontWeight: '500'
                                            }}>
                                                ⚠️ {errors.embedUrl}
                                            </div>
                                        )}
                                        <div style={{
                                            marginTop: '8px',
                                            fontSize: '12px',
                                            color: 'var(--text-secondary)'
                                        }}>
                                            💡 Use YouTube embed format: https://youtube.com/embed/VIDEO_ID
                                        </div>
                                    </div>
                                )}

                                {formData.type === 'article' && (
                                    <div>
                                        <label style={{
                                            display: 'block',
                                            marginBottom: '8px',
                                            color: 'var(--text-primary)',
                                            fontWeight: '600',
                                            fontSize: '14px'
                                        }}>
                                            Article Content *
                                        </label>
                                        <textarea
                                            value={formData.content}
                                            onChange={(e) => setFormData({...formData, content: e.target.value})}
                                            placeholder="Write your article content here..."
                                            rows="12"
                                            style={{
                                                width: '100%',
                                                padding: '12px 15px',
                                                borderRadius: 'var(--radius-md)',
                                                border: errors.content ? '2px solid var(--danger-color)' : '1px solid var(--border-color)',
                                                fontSize: '14px',
                                                color: 'var(--text-primary)',
                                                background: 'var(--background-secondary)',
                                                resize: 'vertical',
                                                fontFamily: 'inherit',
                                                lineHeight: '1.6',
                                                transition: 'var(--transition-fast)'
                                            }}
                                            onFocus={(e) => {
                                                if (!errors.content) {
                                                    e.currentTarget.style.borderColor = 'var(--primary-color)';
                                                }
                                            }}
                                            onBlur={(e) => {
                                                if (!errors.content) {
                                                    e.currentTarget.style.borderColor = 'var(--border-color)';
                                                }
                                            }}
                                        />
                                        {errors.content && (
                                            <div style={{
                                                marginTop: '5px',
                                                color: 'var(--danger-color)',
                                                fontSize: '12px',
                                                fontWeight: '500'
                                            }}>
                                                ⚠️ {errors.content}
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* ========== CATEGORY SECTION ========== */}
                        <div style={{
                            background: 'var(--background-primary)',
                            padding: '25px',
                            borderRadius: 'var(--radius-lg)',
                            marginBottom: '25px',
                            boxShadow: 'var(--shadow-sm)'
                        }}>
                            <h4 style={{
                                margin: '0 0 20px 0',
                                color: 'var(--text-primary)',
                                fontSize: '18px',
                                fontWeight: '600',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px'
                            }}>
                                🏷️ Category *
                            </h4>

                            {/* Selected Category Display */}
                            <div style={{
                                padding: '12px 15px',
                                background: formData.category ? 'var(--bg-primary-light)' : 'var(--background-secondary)',
                                border: errors.category ? '2px solid var(--danger-color)' : '1px solid var(--border-color)',
                                borderRadius: 'var(--radius-md)',
                                marginBottom: '15px',
                                fontSize: '14px',
                                color: formData.category ? 'var(--primary-color)' : 'var(--text-secondary)',
                                fontWeight: formData.category ? '600' : '400',
                                minHeight: '44px',
                                display: 'flex',
                                alignItems: 'center'
                            }}>
                                {formData.category || 'No category selected'}
                            </div>
                            {errors.category && (
                                <div style={{
                                    marginBottom: '15px',
                                    color: 'var(--danger-color)',
                                    fontSize: '12px',
                                    fontWeight: '500'
                                }}>
                                    ⚠️ {errors.category}
                                </div>
                            )}

                            {/* Quick Select Categories */}
                            <div style={{
                                display: 'grid',
                                gridTemplateColumns: 'repeat(auto-fill, minmax(160px, 1fr))',
                                gap: '10px',
                                marginBottom: '15px'
                            }}>
                                {predefinedCategories.slice(0, 6).map(category => (
                                    <button
                                        key={category}
                                        type="button"
                                        onClick={() => handleCategorySelect(category.toLowerCase())}
                                        style={{
                                            padding: '10px 15px',
                                            background: formData.category === category.toLowerCase() ? 
                                                'var(--gradient-primary)' : 
                                                'var(--background-secondary)',
                                            color: formData.category === category.toLowerCase() ? 
                                                'var(--text-white)' : 
                                                'var(--text-primary)',
                                            border: '1px solid var(--border-color)',
                                            borderRadius: 'var(--radius-md)',
                                            fontSize: '13px',
                                            fontWeight: '500',
                                            cursor: 'pointer',
                                            transition: 'var(--transition-fast)',
                                            textAlign: 'center'
                                        }}
                                        onMouseEnter={(e) => {
                                            if (formData.category !== category.toLowerCase()) {
                                                e.currentTarget.style.background = 'var(--bg-primary-light)';
                                                e.currentTarget.style.color = 'var(--primary-color)';
                                            }
                                        }}
                                        onMouseLeave={(e) => {
                                            if (formData.category !== category.toLowerCase()) {
                                                e.currentTarget.style.background = 'var(--background-secondary)';
                                                e.currentTarget.style.color = 'var(--text-primary)';
                                            }
                                        }}
                                    >
                                        {category}
                                    </button>
                                ))}
                            </div>

                            {/* Show All Categories Button */}
                            <button
                                type="button"
                                onClick={() => setShowCategoryDropdown(!showCategoryDropdown)}
                                style={{
                                    width: '100%',
                                    padding: '12px 15px',
                                    background: 'var(--background-secondary)',
                                    color: 'var(--text-primary)',
                                    border: '1px solid var(--border-color)',
                                    borderRadius: 'var(--radius-md)',
                                    fontSize: '14px',
                                    fontWeight: '500',
                                    cursor: 'pointer',
                                    transition: 'var(--transition-fast)',
                                    marginBottom: '15px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'space-between'
                                }}
                                onMouseEnter={(e) => {
                                    e.currentTarget.style.background = 'var(--bg-primary-light)';
                                    e.currentTarget.style.borderColor = 'var(--primary-color)';
                                }}
                                onMouseLeave={(e) => {
                                    e.currentTarget.style.background = 'var(--background-secondary)';
                                    e.currentTarget.style.borderColor = 'var(--border-color)';
                                }}
                            >
                                <span>📂 {showCategoryDropdown ? 'Hide' : 'Show'} All Categories</span>
                                <span>{showCategoryDropdown ? '▲' : '▼'}</span>
                            </button>

                            {/* All Categories Dropdown */}
                            {showCategoryDropdown && (
                                <div style={{
                                    maxHeight: '200px',
                                    overflowY: 'auto',
                                    background: 'var(--background-secondary)',
                                    border: '1px solid var(--border-color)',
                                    borderRadius: 'var(--radius-md)',
                                    marginBottom: '15px'
                                }}>
                                    {predefinedCategories.map(category => (
                                        <div
                                            key={category}
                                            onClick={() => handleCategorySelect(category.toLowerCase())}
                                            style={{
                                                padding: '12px 15px',
                                                cursor: 'pointer',
                                                background: formData.category === category.toLowerCase() ? 
                                                    'var(--bg-primary-light)' : 
                                                    'transparent',
                                                color: formData.category === category.toLowerCase() ? 
                                                    'var(--primary-color)' : 
                                                    'var(--text-primary)',
                                                fontSize: '14px',
                                                fontWeight: formData.category === category.toLowerCase() ? '600' : '400',
                                                borderBottom: '1px solid var(--border-color)',
                                                transition: 'var(--transition-fast)'
                                            }}
                                            onMouseEnter={(e) => {
                                                e.currentTarget.style.background = 'var(--bg-primary-light)';
                                            }}
                                            onMouseLeave={(e) => {
                                                if (formData.category !== category.toLowerCase()) {
                                                    e.currentTarget.style.background = 'transparent';
                                                }
                                            }}
                                        >
                                            {formData.category === category.toLowerCase() && '✓ '}{category}
                                        </div>
                                    ))}
                                </div>
                            )}

                            {/* Custom Category Input */}
                            <div>
                                <label style={{
                                    display: 'block',
                                    marginBottom: '8px',
                                    color: 'var(--text-primary)',
                                    fontWeight: '600',
                                    fontSize: '14px'
                                }}>
                                    Or Create Custom Category
                                </label>
                                <div style={{ display: 'flex', gap: '10px' }}>
                                    <input
                                        type="text"
                                        value={customCategory}
                                        onChange={(e) => setCustomCategory(e.target.value)}
                                        placeholder="Enter custom category..."
                                        style={{
                                            flex: 1,
                                            padding: '12px 15px',
                                            borderRadius: 'var(--radius-md)',
                                            border: '1px solid var(--border-color)',
                                            fontSize: '14px',
                                            color: 'var(--text-primary)',
                                            background: 'var(--background-secondary)',
                                            transition: 'var(--transition-fast)'
                                        }}
                                        onFocus={(e) => {
                                            e.currentTarget.style.borderColor = 'var(--primary-color)';
                                        }}
                                        onBlur={(e) => {
                                            e.currentTarget.style.borderColor = 'var(--border-color)';
                                        }}
                                    />
                                    <button
                                        type="button"
                                        onClick={handleCustomCategory}
                                        disabled={!customCategory.trim()}
                                        style={{
                                            padding: '12px 20px',
                                            background: customCategory.trim() ? 'var(--gradient-primary)' : 'var(--text-gray)',
                                            color: 'var(--text-white)',
                                            border: 'none',
                                            borderRadius: 'var(--radius-md)',
                                            fontSize: '14px',
                                            fontWeight: '600',
                                            cursor: customCategory.trim() ? 'pointer' : 'not-allowed',
                                            transition: 'var(--transition-fast)',
                                            whiteSpace: 'nowrap'
                                        }}
                                    >
                                        Add
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* ========== OPTIONS SECTION ========== */}
                        <div style={{
                            background: 'var(--background-primary)',
                            padding: '25px',
                            borderRadius: 'var(--radius-lg)',
                            marginBottom: '0',
                            boxShadow: 'var(--shadow-sm)'
                        }}>
                            <h4 style={{
                                margin: '0 0 20px 0',
                                color: 'var(--text-primary)',
                                fontSize: '18px',
                                fontWeight: '600',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px'
                            }}>
                                ⚙️ Options
                            </h4>

                            {/* Global Resource Toggle */}
                            <label style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '12px',
                                padding: '15px',
                                background: 'var(--background-secondary)',
                                borderRadius: 'var(--radius-md)',
                                cursor: 'pointer',
                                marginBottom: '15px',
                                transition: 'var(--transition-fast)'
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.background = 'var(--bg-primary-light)';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.background = 'var(--background-secondary)';
                            }}>
                                <input
                                    type="checkbox"
                                    checked={formData.isGlobal}
                                    onChange={(e) => setFormData({...formData, isGlobal: e.target.checked})}
                                    style={{
                                        cursor: 'pointer',
                                        width: '20px',
                                        height: '20px'
                                    }}
                                />
                                <div style={{ flex: 1 }}>
                                    <div style={{
                                        fontSize: '14px',
                                        fontWeight: '600',
                                        color: 'var(--text-primary)',
                                        marginBottom: '4px'
                                    }}>
                                        🌐 Make this a Global Resource
                                    </div>
                                    <div style={{
                                        fontSize: '12px',
                                        color: 'var(--text-secondary)',
                                        lineHeight: '1.4'
                                    }}>
                                        Global resources are automatically visible to all PIRs. Non-global resources must be manually assigned.
                                    </div>
                                </div>
                            </label>

                            {/* Active Status Toggle */}
                            <label style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '12px',
                                padding: '15px',
                                background: 'var(--background-secondary)',
                                borderRadius: 'var(--radius-md)',
                                cursor: 'pointer',
                                transition: 'var(--transition-fast)'
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.background = 'var(--bg-primary-light)';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.background = 'var(--background-secondary)';
                            }}>
                                <input
                                    type="checkbox"
                                    checked={formData.active}
                                    onChange={(e) => setFormData({...formData, active: e.target.checked})}
                                    style={{
                                        cursor: 'pointer',
                                        width: '20px',
                                        height: '20px'
                                    }}
                                />
                                <div style={{ flex: 1 }}>
                                    <div style={{
                                        fontSize: '14px',
                                        fontWeight: '600',
                                        color: 'var(--text-primary)',
                                        marginBottom: '4px'
                                    }}>
                                        ✓ Mark as Active
                                    </div>
                                    <div style={{
                                        fontSize: '12px',
                                        color: 'var(--text-secondary)',
                                        lineHeight: '1.4'
                                    }}>
                                        Only active resources are visible to PIRs. Uncheck to save as draft.
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>

                    {/* ========== ACTION BUTTONS ========== */}
                    <div style={{
                        padding: '20px 30px',
                        background: 'var(--background-primary)',
                        borderTop: '2px solid var(--border-color)',
                        display: 'flex',
                        gap: '15px',
                        justifyContent: 'flex-end',
                        position: 'sticky',
                        bottom: 0
                    }}>
                        <button
                            type="button"
                            onClick={onClose}
                            disabled={saving}
                            style={{
                                padding: '12px 24px',
                                borderRadius: 'var(--radius-md)',
                                border: '1px solid var(--border-color)',
                                background: 'var(--background-secondary)',
                                color: 'var(--text-primary)',
                                fontSize: '14px',
                                fontWeight: '600',
                                cursor: saving ? 'not-allowed' : 'pointer',
                                transition: 'var(--transition-fast)',
                                opacity: saving ? 0.5 : 1
                            }}
                            onMouseEnter={(e) => {
                                if (!saving) {
                                    e.currentTarget.style.background = 'var(--bg-danger-light)';
                                    e.currentTarget.style.color = 'var(--danger-color)';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (!saving) {
                                    e.currentTarget.style.background = 'var(--background-secondary)';
                                    e.currentTarget.style.color = 'var(--text-primary)';
                                }
                            }}
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            disabled={saving}
                            style={{
                                padding: '12px 32px',
                                borderRadius: 'var(--radius-md)',
                                border: 'none',
                                background: saving ? 'var(--text-gray)' : 'var(--gradient-primary)',
                                color: 'var(--text-white)',
                                fontSize: '14px',
                                fontWeight: '600',
                                cursor: saving ? 'not-allowed' : 'pointer',
                                transition: 'var(--transition-fast)',
                                boxShadow: saving ? 'none' : 'var(--shadow-md)',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                            }}
                            onMouseEnter={(e) => {
                                if (!saving) {
                                    e.currentTarget.style.transform = 'translateY(-2px)';
                                    e.currentTarget.style.boxShadow = 'var(--shadow-lg)';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (!saving) {
                                    e.currentTarget.style.transform = 'translateY(0)';
                                    e.currentTarget.style.boxShadow = 'var(--shadow-md)';
                                }
                            }}
                        >
                            {saving ? (
                                <>
                                    <span style={{
                                        display: 'inline-block',
                                        width: '16px',
                                        height: '16px',
                                        border: '2px solid var(--text-white)',
                                        borderTop: '2px solid transparent',
                                        borderRadius: '50%',
                                        animation: 'spin 0.8s linear infinite'
                                    }}></span>
                                    Creating...
                                </>
                            ) : (
                                <>✨ Create Resource</>
                            )}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
}
       // ========================================
// RESOURCEDETAILMODAL - COMPLETE DETAIL MODAL WITH 4 TABS
// Matches UserDetailModal styling patterns
// Uses root-level Firestore with tenantId filtering
// ========================================
function ResourceDetailModal({ resource, user, onClose, onUpdate, onDelete }) {
    // ========== CORE STATES ==========
    const [resourceData, setResourceData] = useState(resource);
    const [loading, setLoading] = useState(false);
    const [activeTab, setActiveTab] = useState('overview');
    
    // ========== DATA STATES ==========
    const [assignments, setAssignments] = useState([]);
    const [feedback, setFeedback] = useState([]);
    const [pirUsers, setPirUsers] = useState([]);
    const [analytics, setAnalytics] = useState({
        totalViews: 0,
        uniqueUsers: 0,
        completions: 0,
        avgRating: 0,
        totalAssignments: 0,
        completedAssignments: 0
    });
    const [assignedPirIds, setAssignedPirIds] = useState(resource.assignedTo || []);
    
    // ========== UI STATES ==========
    const [editing, setEditing] = useState(false);
    const [formData, setFormData] = useState(resource);
    const [saving, setSaving] = useState(false);
    const [showAssignModal, setShowAssignModal] = useState(false);
    const [selectedPirs, setSelectedPirs] = useState([]);
    const [searchPir, setSearchPir] = useState('');

    // ========== LOAD DATA ON MOUNT ==========
    useEffect(() => {
        if (resource.id) {
            loadAllData();
        }
    }, [resource.id]);

    const loadAllData = async () => {
        try {
            setLoading(true);
            await Promise.all([
                loadAssignments(),
                loadFeedback(),
                loadPirUsers(),
                loadAnalytics()
            ]);
        } catch (error) {
            console.error('Error loading resource data:', error);
        } finally {
            setLoading(false);
        }
    };

    // ========== DATA LOADING FUNCTIONS ==========
    const loadAssignments = async () => {
        try {
            const assignmentsSnap = await db.collection('assignments')
                .where('resourceId', '==', resource.id)
                .get();
            
            const assignmentsList = [];
            for (const doc of assignmentsSnap.docs) {
                const assignmentData = { id: doc.id, ...doc.data() };
                
                // Load user info for each assignment
                if (assignmentData.userId) {
                    try {
                        const userDoc = await db.collection('users').doc(assignmentData.userId).get();
                        if (userDoc.exists) {
                            assignmentData.userName = `${userDoc.data().firstName} ${userDoc.data().lastName}`;
                        }
                    } catch (error) {
                        console.error('Error loading user for assignment:', error);
                    }
                }
                
                assignmentsList.push(assignmentData);
            }
            setAssignments(assignmentsList);
        } catch (error) {
            console.error('Error loading assignments:', error);
            setAssignments([]);
        }
    };

    const loadFeedback = async () => {
        try {
            const feedbackSnap = await db.collection('resourceFeedback')
                .where('resourceId', '==', resource.id)
                .orderBy('createdAt', 'desc')
                .get();
            
            const feedbackList = [];
            for (const doc of feedbackSnap.docs) {
                const feedbackData = { id: doc.id, ...doc.data() };
                
                // Load user info for each feedback
                if (feedbackData.userId) {
                    try {
                        const userDoc = await db.collection('users').doc(feedbackData.userId).get();
                        if (userDoc.exists) {
                            feedbackData.userName = `${userDoc.data().firstName} ${userDoc.data().lastName}`;
                        }
                    } catch (error) {
                        console.error('Error loading user for feedback:', error);
                    }
                }
                
                feedbackList.push(feedbackData);
            }
            setFeedback(feedbackList);
        } catch (error) {
            console.error('Error loading feedback:', error);
            setFeedback([]);
        }
    };

    const loadPirUsers = async () => {
        try {
            const usersSnap = await db.collection('users')
                .where('role', '==', 'pir')
                .where('tenantId', '==', user.tenantId)
                .get();
            
            const usersList = [];
            usersSnap.forEach(doc => {
                usersList.push({ id: doc.id, ...doc.data() });
            });
            setPirUsers(usersList);
        } catch (error) {
            console.error('Error loading PIR users:', error);
            setPirUsers([]);
        }
    };

    const loadAnalytics = async () => {
        try {
            // Load view data
            const viewsSnap = await db.collection('resourceViews')
                .where('resourceId', '==', resource.id)
                .get();
            
            const uniqueUsers = new Set();
            let totalViews = 0;
            
            viewsSnap.forEach(doc => {
                totalViews++;
                const data = doc.data();
                if (data.userId) uniqueUsers.add(data.userId);
            });

            // Calculate assignment stats
            const completedAssignments = assignments.filter(a => a.completed).length;
            
            // Calculate average rating
            const avgRating = feedback.length > 0 
                ? (feedback.reduce((sum, f) => sum + (f.rating || 0), 0) / feedback.length).toFixed(1)
                : 0;

            setAnalytics({
                totalViews,
                uniqueUsers: uniqueUsers.size,
                completions: completedAssignments,
                avgRating,
                totalAssignments: assignments.length,
                completedAssignments
            });
        } catch (error) {
            console.error('Error loading analytics:', error);
        }
    };

    // ========== CRUD OPERATIONS ==========
    const handleSave = async () => {
        if (!formData.title.trim()) {
            alert('Title is required');
            return;
        }

        if (!formData.category.trim()) {
            alert('Category is required');
            return;
        }

        try {
            setSaving(true);
            
            await db.collection('resources')
                .doc(resource.id)
                .update({
                    title: formData.title.trim(),
                    description: formData.description.trim(),
                    category: formData.category.trim(),
                    type: formData.type,
                    url: formData.url.trim(),
                    fileURL: formData.fileURL.trim(),
                    embedUrl: formData.embedUrl.trim(),
                    content: formData.content.trim(),
                    isGlobal: formData.isGlobal,
                    active: formData.active,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

            setResourceData(formData);
            setEditing(false);
            alert('Resource updated successfully! ✓');
            onUpdate();
        } catch (error) {
            console.error('Error updating resource:', error);
            alert('Failed to update resource: ' + error.message);
        } finally {
            setSaving(false);
        }
    };

    const handleDelete = async () => {
        if (!confirm('⚠️ Are you sure you want to delete this resource?\n\nThis will also delete:\n• All assignments using this resource\n• All feedback for this resource\n• All analytics data\n\nThis action cannot be undone!')) {
            return;
        }

        try {
            // Delete resource
            await db.collection('resources').doc(resource.id).delete();
            
            // Delete related assignments
            const assignmentsToDelete = await db.collection('assignments')
                .where('resourceId', '==', resource.id)
                .get();
            
            const deletePromises = [];
            assignmentsToDelete.forEach(doc => {
                deletePromises.push(doc.ref.delete());
            });

            // Delete related feedback
            const feedbackToDelete = await db.collection('resourceFeedback')
                .where('resourceId', '==', resource.id)
                .get();
            
            feedbackToDelete.forEach(doc => {
                deletePromises.push(doc.ref.delete());
            });

            await Promise.all(deletePromises);

            alert('Resource deleted successfully! 🗑️');
            onDelete(resource.id);
        } catch (error) {
            console.error('Error deleting resource:', error);
            alert('Failed to delete resource: ' + error.message);
        }
    };

    const toggleStatus = async () => {
        try {
            const newStatus = !resourceData.active;
            await db.collection('resources')
                .doc(resource.id)
                .update({
                    active: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

            setResourceData({...resourceData, active: newStatus});
            alert(`Resource ${newStatus ? 'activated' : 'deactivated'} successfully! ${newStatus ? '✓' : '⏸️'}`);
            onUpdate();
        } catch (error) {
            console.error('Error updating status:', error);
            alert('Failed to update status: ' + error.message);
        }
    };

    const handleAssignPirs = async () => {
        if (selectedPirs.length === 0) {
            alert('Please select at least one PIR');
            return;
        }

        try {
            setSaving(true);

            // Get current assignedTo array
            const currentAssigned = assignedPirIds || [];
            const newAssigned = [...new Set([...currentAssigned, ...selectedPirs])];

            // Update resource
            await db.collection('resources')
                .doc(resource.id)
                .update({
                    assignedTo: newAssigned,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

            setAssignedPirIds(newAssigned);
            setSelectedPirs([]);
            setShowAssignModal(false);
            alert(`Resource assigned to ${selectedPirs.length} PIR(s) successfully! ✓`);
            onUpdate();
        } catch (error) {
            console.error('Error assigning resource:', error);
            alert('Failed to assign resource: ' + error.message);
        } finally {
            setSaving(false);
        }
    };

    const handleUnassignPir = async (pirId) => {
        if (!confirm('Remove this PIR from the resource?')) return;

        try {
            const newAssigned = assignedPirIds.filter(id => id !== pirId);

            await db.collection('resources')
                .doc(resource.id)
                .update({
                    assignedTo: newAssigned,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

            setAssignedPirIds(newAssigned);
            alert('PIR removed successfully! ✓');
            onUpdate();
        } catch (error) {
            console.error('Error unassigning PIR:', error);
            alert('Failed to remove PIR: ' + error.message);
        }
    };

    // ========== HELPER FUNCTIONS ==========
    const formatDate = (timestamp) => {
        if (!timestamp) return 'N/A';
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric'
        });
    };

    const getResourceIcon = (type) => {
        switch (type) {
            case 'link': return '🔗';
            case 'file': return '📄';
            case 'video': return '🎥';
            case 'article': return '📰';
            default: return '📚';
        }
    };

    const getAssignedPirs = () => {
        return pirUsers.filter(pir => assignedPirIds.includes(pir.id));
    };

    const getUnassignedPirs = () => {
        return pirUsers.filter(pir => !assignedPirIds.includes(pir.id));
    };

    const getFilteredUnassignedPirs = () => {
        const unassigned = getUnassignedPirs();
        if (!searchPir.trim()) return unassigned;
        
        const query = searchPir.toLowerCase();
        return unassigned.filter(pir => 
            pir.firstName?.toLowerCase().includes(query) ||
            pir.lastName?.toLowerCase().includes(query) ||
            pir.email?.toLowerCase().includes(query)
        );
    };

    // ========== TAB RENDER FUNCTIONS ==========
    const renderOverviewTab = () => (
        <div style={{ padding: '30px' }}>
            {editing ? (
                // ========== EDIT MODE ==========
                <div>
                    <div style={{
                        background: 'var(--background-primary)',
                        padding: '25px',
                        borderRadius: 'var(--radius-lg)',
                        marginBottom: '25px',
                        boxShadow: 'var(--shadow-sm)'
                    }}>
                        <h4 style={{
                            margin: '0 0 20px 0',
                            color: 'var(--text-primary)',
                            fontSize: '18px',
                            fontWeight: '600'
                        }}>
                            Edit Resource Details
                        </h4>

                        {/* Title */}
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{
                                display: 'block',
                                marginBottom: '8px',
                                color: 'var(--text-primary)',
                                fontWeight: '600',
                                fontSize: '14px'
                            }}>
                                Title *
                            </label>
                            <input
                                type="text"
                                value={formData.title}
                                onChange={(e) => setFormData({...formData, title: e.target.value})}
                                style={{
                                    width: '100%',
                                    padding: '12px 15px',
                                    borderRadius: 'var(--radius-md)',
                                    border: '1px solid var(--border-color)',
                                    fontSize: '14px',
                                    color: 'var(--text-primary)',
                                    background: 'var(--background-secondary)',
                                    transition: 'var(--transition-fast)'
                                }}
                                onFocus={(e) => e.currentTarget.style.borderColor = 'var(--primary-color)'}
                                onBlur={(e) => e.currentTarget.style.borderColor = 'var(--border-color)'}
                            />
                        </div>

                        {/* Description */}
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{
                                display: 'block',
                                marginBottom: '8px',
                                color: 'var(--text-primary)',
                                fontWeight: '600',
                                fontSize: '14px'
                            }}>
                                Description
                            </label>
                            <textarea
                                value={formData.description}
                                onChange={(e) => setFormData({...formData, description: e.target.value})}
                                rows="6"
                                style={{
                                    width: '100%',
                                    padding: '12px 15px',
                                    borderRadius: 'var(--radius-md)',
                                    border: '1px solid var(--border-color)',
                                    fontSize: '14px',
                                    color: 'var(--text-primary)',
                                    background: 'var(--background-secondary)',
                                    resize: 'vertical',
                                    fontFamily: 'inherit',
                                    lineHeight: '1.5',
                                    transition: 'var(--transition-fast)'
                                }}
                                onFocus={(e) => e.currentTarget.style.borderColor = 'var(--primary-color)'}
                                onBlur={(e) => e.currentTarget.style.borderColor = 'var(--border-color)'}
                            />
                        </div>

                        {/* Category */}
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{
                                display: 'block',
                                marginBottom: '8px',
                                color: 'var(--text-primary)',
                                fontWeight: '600',
                                fontSize: '14px'
                            }}>
                                Category *
                            </label>
                            <input
                                type="text"
                                value={formData.category}
                                onChange={(e) => setFormData({...formData, category: e.target.value})}
                                style={{
                                    width: '100%',
                                    padding: '12px 15px',
                                    borderRadius: 'var(--radius-md)',
                                    border: '1px solid var(--border-color)',
                                    fontSize: '14px',
                                    color: 'var(--text-primary)',
                                    background: 'var(--background-secondary)',
                                    transition: 'var(--transition-fast)'
                                }}
                                onFocus={(e) => e.currentTarget.style.borderColor = 'var(--primary-color)'}
                                onBlur={(e) => e.currentTarget.style.borderColor = 'var(--border-color)'}
                            />
                        </div>

                        {/* Type-specific URL fields */}
                        {formData.type === 'link' && (
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{
                                    display: 'block',
                                    marginBottom: '8px',
                                    color: 'var(--text-primary)',
                                    fontWeight: '600',
                                    fontSize: '14px'
                                }}>
                                    URL
                                </label>
                                <input
                                    type="url"
                                    value={formData.url}
                                    onChange={(e) => setFormData({...formData, url: e.target.value})}
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        borderRadius: 'var(--radius-md)',
                                        border: '1px solid var(--border-color)',
                                        fontSize: '14px',
                                        color: 'var(--text-primary)',
                                        background: 'var(--background-secondary)',
                                        transition: 'var(--transition-fast)'
                                    }}
                                    onFocus={(e) => e.currentTarget.style.borderColor = 'var(--primary-color)'}
                                    onBlur={(e) => e.currentTarget.style.borderColor = 'var(--border-color)'}
                                />
                            </div>
                        )}

                        {formData.type === 'file' && (
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{
                                    display: 'block',
                                    marginBottom: '8px',
                                    color: 'var(--text-primary)',
                                    fontWeight: '600',
                                    fontSize: '14px'
                                }}>
                                    File URL
                                </label>
                                <input
                                    type="url"
                                    value={formData.fileURL}
                                    onChange={(e) => setFormData({...formData, fileURL: e.target.value})}
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        borderRadius: 'var(--radius-md)',
                                        border: '1px solid var(--border-color)',
                                        fontSize: '14px',
                                        color: 'var(--text-primary)',
                                        background: 'var(--background-secondary)',
                                        transition: 'var(--transition-fast)'
                                    }}
                                    onFocus={(e) => e.currentTarget.style.borderColor = 'var(--primary-color)'}
                                    onBlur={(e) => e.currentTarget.style.borderColor = 'var(--border-color)'}
                                />
                            </div>
                        )}

                        {formData.type === 'video' && (
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{
                                    display: 'block',
                                    marginBottom: '8px',
                                    color: 'var(--text-primary)',
                                    fontWeight: '600',
                                    fontSize: '14px'
                                }}>
                                    Video Embed URL
                                </label>
                                <input
                                    type="url"
                                    value={formData.embedUrl}
                                    onChange={(e) => setFormData({...formData, embedUrl: e.target.value})}
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        borderRadius: 'var(--radius-md)',
                                        border: '1px solid var(--border-color)',
                                        fontSize: '14px',
                                        color: 'var(--text-primary)',
                                        background: 'var(--background-secondary)',
                                        transition: 'var(--transition-fast)'
                                    }}
                                    onFocus={(e) => e.currentTarget.style.borderColor = 'var(--primary-color)'}
                                    onBlur={(e) => e.currentTarget.style.borderColor = 'var(--border-color)'}
                                />
                            </div>
                        )}

                        {/* Toggles */}
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px',
                                cursor: 'pointer',
                                marginBottom: '10px'
                            }}>
                                <input
                                    type="checkbox"
                                    checked={formData.isGlobal}
                                    onChange={(e) => setFormData({...formData, isGlobal: e.target.checked})}
                                    style={{ cursor: 'pointer', width: '18px', height: '18px' }}
                                />
                                <span style={{
                                    color: 'var(--text-primary)',
                                    fontWeight: '600',
                                    fontSize: '14px'
                                }}>
                                    🌐 Global Resource
                                </span>
                            </label>
                            <label style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px',
                                cursor: 'pointer'
                            }}>
                                <input
                                    type="checkbox"
                                    checked={formData.active}
                                    onChange={(e) => setFormData({...formData, active: e.target.checked})}
                                    style={{ cursor: 'pointer', width: '18px', height: '18px' }}
                                />
                                <span style={{
                                    color: 'var(--text-primary)',
                                    fontWeight: '600',
                                    fontSize: '14px'
                                }}>
                                    ✓ Active
                                </span>
                            </label>
                        </div>

                        {/* Action Buttons */}
                        <div style={{
                            display: 'flex',
                            gap: '15px',
                            justifyContent: 'flex-end',
                            paddingTop: '20px',
                            borderTop: '1px solid var(--border-color)'
                        }}>
                            <button
                                onClick={() => {
                                    setEditing(false);
                                    setFormData(resourceData);
                                }}
                                style={{
                                    padding: '12px 24px',
                                    borderRadius: 'var(--radius-md)',
                                    border: '1px solid var(--border-color)',
                                    background: 'var(--background-secondary)',
                                    color: 'var(--text-primary)',
                                    fontSize: '14px',
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    transition: 'var(--transition-fast)'
                                }}
                                onMouseEnter={(e) => {
                                    e.currentTarget.style.background = 'var(--bg-danger-light)';
                                    e.currentTarget.style.color = 'var(--danger-color)';
                                }}
                                onMouseLeave={(e) => {
                                    e.currentTarget.style.background = 'var(--background-secondary)';
                                    e.currentTarget.style.color = 'var(--text-primary)';
                                }}
                            >
                                Cancel
                            </button>
                            <button
                                onClick={handleSave}
                                disabled={saving}
                                style={{
                                    padding: '12px 24px',
                                    borderRadius: 'var(--radius-md)',
                                    border: 'none',
                                    background: saving ? 'var(--text-gray)' : 'var(--gradient-primary)',
                                    color: 'var(--text-white)',
                                    fontSize: '14px',
                                    fontWeight: '600',
                                    cursor: saving ? 'not-allowed' : 'pointer',
                                    transition: 'var(--transition-fast)',
                                    boxShadow: saving ? 'none' : 'var(--shadow-md)'
                                }}
                                onMouseEnter={(e) => {
                                    if (!saving) {
                                        e.currentTarget.style.transform = 'translateY(-2px)';
                                        e.currentTarget.style.boxShadow = 'var(--shadow-lg)';
                                    }
                                }}
                                onMouseLeave={(e) => {
                                    if (!saving) {
                                        e.currentTarget.style.transform = 'translateY(0)';
                                        e.currentTarget.style.boxShadow = 'var(--shadow-md)';
                                    }
                                }}
                            >
                                {saving ? 'Saving...' : '✓ Save Changes'}
                            </button>
                        </div>
                    </div>
                </div>
            ) : (
                // ========== VIEW MODE ==========
                <div>
                    {/* Resource Header Card */}
                    <div style={{
                        background: 'var(--background-primary)',
                        padding: '30px',
                        borderRadius: 'var(--radius-lg)',
                        marginBottom: '25px',
                        boxShadow: 'var(--shadow-sm)'
                    }}>
                        <div style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'flex-start',
                            marginBottom: '20px'
                        }}>
                            <div style={{ fontSize: '56px' }}>
                                {getResourceIcon(resourceData.type)}
                            </div>
                            <div style={{
                                padding: '10px 20px',
                                background: resourceData.active ? 'var(--gradient-success)' : 'var(--gradient-danger)',
                                color: 'var(--text-white)',
                                borderRadius: 'var(--radius-md)',
                                fontSize: '14px',
                                fontWeight: '600',
                                boxShadow: 'var(--shadow-sm)'
                            }}>
                                {resourceData.active ? '✓ Active' : '✕ Inactive'}
                            </div>
                        </div>

                        <h2 style={{
                            margin: '0 0 15px 0',
                            color: 'var(--text-primary)',
                            fontSize: '28px',
                            fontWeight: '600',
                            lineHeight: '1.3'
                        }}>
                            {resourceData.title}
                        </h2>

                        <p style={{
                            margin: '0 0 20px 0',
                            color: 'var(--text-secondary)',
                            fontSize: '16px',
                            lineHeight: '1.6'
                        }}>
                            {resourceData.description || 'No description provided'}
                        </p>

                        <div style={{
                            display: 'flex',
                            gap: '12px',
                            flexWrap: 'wrap'
                        }}>
                            <span style={{
                                padding: '8px 16px',
                                background: 'var(--bg-primary-light)',
                                color: 'var(--primary-color)',
                                borderRadius: 'var(--radius-md)',
                                fontSize: '14px',
                                fontWeight: '600'
                            }}>
                                📂 {resourceData.category || 'Uncategorized'}
                            </span>
                            <span style={{
                                padding: '8px 16px',
                                background: 'var(--bg-info-light)',
                                color: 'var(--info-color)',
                                borderRadius: 'var(--radius-md)',
                                fontSize: '14px',
                                fontWeight: '600',
                                textTransform: 'capitalize'
                            }}>
                                {getResourceIcon(resourceData.type)} {resourceData.type}
                            </span>
                            {resourceData.isGlobal && (
                                <span style={{
                                    padding: '8px 16px',
                                    background: 'var(--bg-warning-light)',
                                    color: 'var(--warning-color)',
                                    borderRadius: 'var(--radius-md)',
                                    fontSize: '14px',
                                    fontWeight: '600'
                                }}>
                                    🌐 Global
                                </span>
                            )}
                            {assignedPirIds.length > 0 && (
                                <span style={{
                                    padding: '8px 16px',
                                    background: 'var(--bg-success-light)',
                                    color: 'var(--success-color)',
                                    borderRadius: 'var(--radius-md)',
                                    fontSize: '14px',
                                    fontWeight: '600'
                                }}>
                                    👥 {assignedPirIds.length} PIR{assignedPirIds.length !== 1 ? 's' : ''}
                                </span>
                            )}
                        </div>
                    </div>

                    {/* Analytics Cards */}
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))',
                        gap: '20px',
                        marginBottom: '25px'
                    }}>
                        <div style={{
                            background: 'var(--background-primary)',
                            padding: '20px',
                            borderRadius: 'var(--radius-lg)',
                            boxShadow: 'var(--shadow-sm)',
                            textAlign: 'center',
                            border: '2px solid var(--border-color)',
                            transition: 'var(--transition-fast)'
                        }}>
                            <div style={{
                                fontSize: '36px',
                                fontWeight: '700',
                                color: 'var(--primary-color)',
                                marginBottom: '8px'
                            }}>
                                {analytics.totalViews}
                            </div>
                            <div style={{
                                fontSize: '14px',
                                color: 'var(--text-secondary)',
                                fontWeight: '500'
                            }}>
                                Total Views
                            </div>
                        </div>

                        <div style={{
                            background: 'var(--background-primary)',
                            padding: '20px',
                            borderRadius: 'var(--radius-lg)',
                            boxShadow: 'var(--shadow-sm)',
                            textAlign: 'center',
                            border: '2px solid var(--border-color)',
                            transition: 'var(--transition-fast)'
                        }}>
                            <div style={{
                                fontSize: '36px',
                                fontWeight: '700',
                                color: 'var(--success-color)',
                                marginBottom: '8px'
                            }}>
                                {analytics.uniqueUsers}
                            </div>
                            <div style={{
                                fontSize: '14px',
                                color: 'var(--text-secondary)',
                                fontWeight: '500'
                            }}>
                                Unique Users
                            </div>
                        </div>

                        <div style={{
                            background: 'var(--background-primary)',
                            padding: '20px',
                            borderRadius: 'var(--radius-lg)',
                            boxShadow: 'var(--shadow-sm)',
                            textAlign: 'center',
                            border: '2px solid var(--border-color)',
                            transition: 'var(--transition-fast)'
                        }}>
                            <div style={{
                                fontSize: '36px',
                                fontWeight: '700',
                                color: 'var(--warning-color)',
                                marginBottom: '8px'
                            }}>
                                {analytics.totalAssignments}
                            </div>
                            <div style={{
                                fontSize: '14px',
                                color: 'var(--text-secondary)',
                                fontWeight: '500'
                            }}>
                                Total Assignments
                            </div>
                        </div>

                        <div style={{
                            background: 'var(--background-primary)',
                            padding: '20px',
                            borderRadius: 'var(--radius-lg)',
                            boxShadow: 'var(--shadow-sm)',
                            textAlign: 'center',
                            border: '2px solid var(--border-color)',
                            transition: 'var(--transition-fast)'
                        }}>
                            <div style={{
                                fontSize: '36px',
                                fontWeight: '700',
                                color: 'var(--info-color)',
                                marginBottom: '8px'
                            }}>
                                {analytics.avgRating > 0 ? analytics.avgRating : 'N/A'}
                            </div>
                            <div style={{
                                fontSize: '14px',
                                color: 'var(--text-secondary)',
                                fontWeight: '500'
                            }}>
                                Avg Rating
                            </div>
                        </div>
                    </div>

                    {/* Resource URL Display */}
                    {(resourceData.url || resourceData.fileURL || resourceData.embedUrl) && (
                        <div style={{
                            background: 'var(--background-primary)',
                            padding: '20px',
                            borderRadius: 'var(--radius-lg)',
                            marginBottom: '25px',
                            boxShadow: 'var(--shadow-sm)'
                        }}>
                            <div style={{
                                fontSize: '14px',
                                color: 'var(--text-secondary)',
                                marginBottom: '8px',
                                fontWeight: '600'
                            }}>
                                🔗 Resource URL
                            </div>
                            
                                href={resourceData.url || resourceData.fileURL || resourceData.embedUrl}
                                target="_blank"
                                rel="noopener noreferrer"
                                style={{
                                    color: 'var(--primary-color)',
                                    fontSize: '14px',
                                    textDecoration: 'none',
                                    wordBreak: 'break-all',
                                    fontWeight: '500'
                                }}
                            >
                                {resourceData.url || resourceData.fileURL || resourceData.embedUrl}
                            </a>
                        </div>
                    )}

                    {/* Assigned PIRs */}
                    {assignedPirIds.length > 0 && (
                        <div style={{
                            background: 'var(--background-primary)',
                            padding: '25px',
                            borderRadius: 'var(--radius-lg)',
                            boxShadow: 'var(--shadow-sm)'
                        }}>
                            <h4 style={{
                                margin: '0 0 15px 0',
                                fontSize: '16px',
                                fontWeight: '600',
                                color: 'var(--text-primary)',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px'
                            }}>
                                👥 Assigned PIRs ({assignedPirIds.length})
                            </h4>
                            <div style={{
                                display: 'flex',
                                flexDirection: 'column',
                                gap: '10px'
                            }}>
                                {getAssignedPirs().map(pir => (
                                    <div
                                        key={pir.id}
                                        style={{
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            alignItems: 'center',
                                            padding: '12px 15px',
                                            background: 'var(--background-secondary)',
                                            borderRadius: 'var(--radius-md)',
                                            border: '1px solid var(--border-color)'
                                        }}
                                    >
                                        <div>
                                            <div style={{
                                                fontSize: '14px',
                                                fontWeight: '600',
                                                color: 'var(--text-primary)',
                                                marginBottom: '2px'
                                            }}>
                                                {pir.firstName} {pir.lastName}
                                            </div>
                                            <div style={{
                                                fontSize: '12px',
                                                color: 'var(--text-secondary)'
                                            }}>
                                                {pir.email}
                                            </div>
                                        </div>
                                        <button
                                            onClick={() => handleUnassignPir(pir.id)}
                                            style={{
                                                padding: '6px 12px',
                                                background: 'var(--bg-danger-light)',
                                                color: 'var(--danger-color)',
                                                border: '1px solid var(--danger-color)',
                                                borderRadius: 'var(--radius-md)',
                                                fontSize: '12px',
                                                fontWeight: '600',
                                                cursor: 'pointer',
                                                transition: 'var(--transition-fast)'
                                            }}
                                            onMouseEnter={(e) => {
                                                e.currentTarget.style.background = 'var(--danger-color)';
                                                e.currentTarget.style.color = 'var(--text-white)';
                                            }}
                                            onMouseLeave={(e) => {
                                                e.currentTarget.style.background = 'var(--bg-danger-light)';
                                                e.currentTarget.style.color = 'var(--danger-color)';
                                            }}
                                        >
                                            Remove
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            )}
        </div>
    );

    const renderAssignmentsTab = () => (
        <div style={{ padding: '30px' }}>
            <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                marginBottom: '25px'
            }}>
                <h3 style={{
                    margin: 0,
                    color: 'var(--text-primary)',
                    fontSize: '20px',
                    fontWeight: '600'
                }}>
                    Assignments ({assignments.length})
                </h3>
            </div>

            {loading ? (
                <div style={{
                    textAlign: 'center',
                    padding: '60px 20px',
                    background: 'var(--background-primary)',
                    borderRadius: 'var(--radius-lg)',
                    boxShadow: 'var(--shadow-sm)'
                }}>
                    <div style={{
                        width: '40px',
                        height: '40px',
                        border: '4px solid var(--background-secondary)',
                        borderTop: '4px solid var(--primary-color)',
                        borderRadius: '50%',
                        animation: 'spin 1s linear infinite',
                        margin: '0 auto 15px'
                    }}></div>
                    <div style={{
                        fontSize: '16px',
                        color: 'var(--text-secondary)'
                    }}>
                        Loading assignments...
                    </div>
                </div>
            ) : assignments.length === 0 ? (
                <div style={{
                    textAlign: 'center',
                    padding: '60px 20px',
                    background: 'var(--background-primary)',
                    borderRadius: 'var(--radius-lg)',
                    boxShadow: 'var(--shadow-sm)'
                }}>
                    <div style={{ fontSize: '48px', marginBottom: '15px' }}>📋</div>
                    <div style={{
                        fontSize: '18px',
                        fontWeight: '600',
                        color: 'var(--text-primary)',
                        marginBottom: '8px'
                    }}>
                        No assignments yet
                    </div>
                    <div style={{
                        fontSize: '14px',
                        color: 'var(--text-secondary)'
                    }}>
                        This resource hasn't been assigned to any PIRs yet
                    </div>
                </div>
            ) : (
                <div style={{ display: 'flex', flexDirection: 'column', gap: '15px' }}>
                    {assignments.map(assignment => (
                        <div
                            key={assignment.id}
                            style={{
                                background: 'var(--background-primary)',
                                padding: '20px',
                                borderRadius: 'var(--radius-lg)',
                                boxShadow: 'var(--shadow-sm)',
                                border: '1px solid var(--border-color)',
                                transition: 'var(--transition-fast)'
                            }}
                        >
                            <div style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'flex-start',
                                marginBottom: '12px'
                            }}>
                                <div style={{ flex: 1 }}>
                                    <div style={{
                                        fontSize: '16px',
                                        fontWeight: '600',
                                        color: 'var(--text-primary)',
                                        marginBottom: '8px'
                                    }}>
                                        {assignment.title || 'Untitled Assignment'}
                                    </div>
                                    {assignment.description && (
                                        <div style={{
                                            fontSize: '14px',
                                            color: 'var(--text-secondary)',
                                            marginBottom: '12px',
                                            lineHeight: '1.5'
                                        }}>
                                            {assignment.description}
                                        </div>
                                    )}
                                    <div style={{
                                        display: 'flex',
                                        gap: '15px',
                                        flexWrap: 'wrap',
                                        fontSize: '13px',
                                        color: 'var(--text-secondary)'
                                    }}>
                                        {assignment.userName && (
                                            <span>👤 {assignment.userName}</span>
                                        )}
                                        {assignment.dueDate && (
                                            <span>📅 Due: {formatDate(assignment.dueDate)}</span>
                                        )}
                                        {assignment.createdAt && (
                                            <span>🕒 Created: {formatDate(assignment.createdAt)}</span>
                                        )}
                                    </div>
                                </div>
                                <div style={{
                                    padding: '6px 12px',
                                    background: assignment.completed ? 
                                        'var(--gradient-success)' : 
                                        assignment.status === 'in_progress' ?
                                        'var(--gradient-warning)' :
                                        'var(--gradient-info)',
                                    color: 'var(--text-white)',
                                    borderRadius: 'var(--radius-md)',
                                    fontSize: '12px',
                                    fontWeight: '600',
                                    whiteSpace: 'nowrap',
                                    boxShadow: 'var(--shadow-sm)'
                                }}>
                                    {assignment.completed ? '✓ Completed' : 
                                     assignment.status === 'in_progress' ? '⏳ In Progress' : 
                                     '📌 Pending'}
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );

    const renderFeedbackTab = () => (
        <div style={{ padding: '30px' }}>
            <h3 style={{
                margin: '0 0 25px 0',
                color: 'var(--text-primary)',
                fontSize: '20px',
                fontWeight: '600'
            }}>
                Feedback & Ratings ({feedback.length})
            </h3>

            {loading ? (
                <div style={{
                    textAlign: 'center',
                    padding: '60px 20px',
                    background: 'var(--background-primary)',
                    borderRadius: 'var(--radius-lg)',
                    boxShadow: 'var(--shadow-sm)'
                }}>
                    <div style={{
                        width: '40px',
                        height: '40px',
                        border: '4px solid var(--background-secondary)',
                        borderTop: '4px solid var(--primary-color)',
                        borderRadius: '50%',
                        animation: 'spin 1s linear infinite',
                        margin: '0 auto 15px'
                    }}></div>
                    <div style={{
                        fontSize: '16px',
                        color: 'var(--text-secondary)'
                    }}>
                        Loading feedback...
                    </div>
                </div>
            ) : feedback.length === 0 ? (
                <div style={{
                    textAlign: 'center',
                    padding: '60px 20px',
                    background: 'var(--background-primary)',
                    borderRadius: 'var(--radius-lg)',
                    boxShadow: 'var(--shadow-sm)'
                }}>
                    <div style={{ fontSize: '48px', marginBottom: '15px' }}>💬</div>
                    <div style={{
                        fontSize: '18px',
                        fontWeight: '600',
                        color: 'var(--text-primary)',
                        marginBottom: '8px'
                    }}>
                        No feedback yet
                    </div>
                    <div style={{
                        fontSize: '14px',
                        color: 'var(--text-secondary)'
                    }}>
                        PIRs haven't provided feedback on this resource yet
                    </div>
                </div>
            ) : (
                <div style={{ display: 'flex', flexDirection: 'column', gap: '15px' }}>
                    {feedback.map(item => (
                        <div
                            key={item.id}
                            style={{
                                background: 'var(--background-primary)',
                                padding: '20px',
                                borderRadius: 'var(--radius-lg)',
                                boxShadow: 'var(--shadow-sm)',
                                border: '1px solid var(--border-color)'
                            }}
                        >
                            <div style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                marginBottom: '12px'
                            }}>
                                <div style={{
                                    fontSize: '14px',
                                    fontWeight: '600',
                                    color: 'var(--text-primary)'
                                }}>
                                    {item.userName || 'Anonymous PIR'}
                                </div>
                                <div style={{
                                    display: 'flex',
                                    gap: '4px'
                                }}>
                                    {[1, 2, 3, 4, 5].map(star => (
                                        <span key={star} style={{
                                            color: star <= (item.rating || 0) ? 
                                                'var(--warning-color)' : 
                                                'var(--text-gray)',
                                            fontSize: '18px'
                                        }}>
                                            ★
                                        </span>
                                    ))}
                                </div>
                            </div>
                            <div style={{
                                fontSize: '14px',
                                color: 'var(--text-secondary)',
                                lineHeight: '1.6',
                                marginBottom: '12px'
                            }}>
                                {item.comment || 'No comment provided'}
                            </div>
                            <div style={{
                                fontSize: '12px',
                                color: 'var(--text-gray)'
                            }}>
                                📅 {formatDate(item.createdAt)}
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );

    const renderActionsTab = () => (
        <div style={{ padding: '30px' }}>
            <h3 style={{
                margin: '0 0 25px 0',
                color: 'var(--text-primary)',
                fontSize: '20px',
                fontWeight: '600'
            }}>
                Resource Actions
            </h3>

            <div style={{
                display: 'flex',
                flexDirection: 'column',
                gap: '15px',
                marginBottom: '30px'
            }}>
                {/* Edit Button */}
                <button
                    onClick={() => {
                        setEditing(true);
                        setActiveTab('overview');
                    }}
                    style={{
                        padding: '18px 24px',
                        background: 'var(--gradient-primary)',
                        color: 'var(--text-white)',
                        border: 'none',
                        borderRadius: 'var(--radius-lg)',
                        fontSize: '16px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '10px',
                        transition: 'var(--transition-fast)',
                        boxShadow: 'var(--shadow-md)'
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.transform = 'translateY(-2px)';
                        e.currentTarget.style.boxShadow = 'var(--shadow-lg)';
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = 'var(--shadow-md)';
                    }}
                >
                    <span style={{ fontSize: '20px' }}>✏️</span>
                    Edit Resource Details
                </button>

                {/* Assign to PIRs Button */}
                <button
                    onClick={() => setShowAssignModal(true)}
                    style={{
                        padding: '18px 24px',
                        background: 'var(--gradient-success)',
                        color: 'var(--text-white)',
                        border: 'none',
                        borderRadius: 'var(--radius-lg)',
                        fontSize: '16px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '10px',
                        transition: 'var(--transition-fast)',
                        boxShadow: 'var(--shadow-md)'
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.transform = 'translateY(-2px)';
                        e.currentTarget.style.boxShadow = 'var(--shadow-lg)';
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = 'var(--shadow-md)';
                    }}
                >
                    <span style={{ fontSize: '20px' }}>👥</span>
                    Assign to PIRs
                </button>

                {/* Toggle Status Button */}
                <button
                    onClick={toggleStatus}
                    style={{
                        padding: '18px 24px',
                        background: resourceData.active ? 
                            'var(--gradient-warning)' : 
                            'var(--gradient-success)',
                        color: 'var(--text-white)',
                        border: 'none',
                        borderRadius: 'var(--radius-lg)',
                        fontSize: '16px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '10px',
                        transition: 'var(--transition-fast)',
                        boxShadow: 'var(--shadow-md)'
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.transform = 'translateY(-2px)';
                        e.currentTarget.style.boxShadow = 'var(--shadow-lg)';
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = 'var(--shadow-md)';
                    }}
                >
                    <span style={{ fontSize: '20px' }}>
                        {resourceData.active ? '⏸️' : '▶️'}
                    </span>
                    {resourceData.active ? 'Deactivate Resource' : 'Activate Resource'}
                </button>

                {/* Delete Button */}
                <button
                    onClick={handleDelete}
                    style={{
                        padding: '18px 24px',
                        background: 'var(--gradient-danger)',
                        color: 'var(--text-white)',
                        border: 'none',
                        borderRadius: 'var(--radius-lg)',
                        fontSize: '16px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '10px',
                        transition: 'var(--transition-fast)',
                        boxShadow: 'var(--shadow-md)'
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.transform = 'translateY(-2px)';
                        e.currentTarget.style.boxShadow = 'var(--shadow-lg)';
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = 'var(--shadow-md)';
                    }}
                >
                    <span style={{ fontSize: '20px' }}>🗑️</span>
                    Delete Resource
                </button>
            </div>

            {/* Resource Information Card */}
            <div style={{
                background: 'var(--background-primary)',
                padding: '25px',
                borderRadius: 'var(--radius-lg)',
                boxShadow: 'var(--shadow-sm)'
            }}>
                <h4 style={{
                    margin: '0 0 20px 0',
                    fontSize: '16px',
                    fontWeight: '600',
                    color: 'var(--text-primary)',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '10px'
                }}>
                    ℹ️ Resource Information
                </h4>
                <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                    gap: '15px',
                    fontSize: '14px'
                }}>
                    <div style={{
                        padding: '15px',
                        background: 'var(--background-secondary)',
                        borderRadius: 'var(--radius-md)',
                        border: '1px solid var(--border-color)'
                    }}>
                        <div style={{ 
                            color: 'var(--text-secondary)', 
                            marginBottom: '5px',
                            fontSize: '12px',
                            fontWeight: '600'
                        }}>
                            Created
                        </div>
                        <div style={{ 
                            color: 'var(--text-primary)', 
                            fontWeight: '600'
                        }}>
                            {formatDate(resourceData.addedAt)}
                        </div>
                    </div>
                    <div style={{
                        padding: '15px',
                        background: 'var(--background-secondary)',
                        borderRadius: 'var(--radius-md)',
                        border: '1px solid var(--border-color)'
                    }}>
                        <div style={{ 
                            color: 'var(--text-secondary)', 
                            marginBottom: '5px',
                            fontSize: '12px',
                            fontWeight: '600'
                        }}>
                            Type
                        </div>
                        <div style={{ 
                            color: 'var(--text-primary)', 
                            fontWeight: '600',
                            textTransform: 'capitalize'
                        }}>
                            {getResourceIcon(resourceData.type)} {resourceData.type}
                        </div>
                    </div>
                    <div style={{
                        padding: '15px',
                        background: 'var(--background-secondary)',
                        borderRadius: 'var(--radius-md)',
                        border: '1px solid var(--border-color)'
                    }}>
                        <div style={{ 
                            color: 'var(--text-secondary)', 
                            marginBottom: '5px',
                            fontSize: '12px',
                            fontWeight: '600'
                        }}>
                            Status
                        </div>
                        <div style={{ 
                            color: resourceData.active ? 'var(--success-color)' : 'var(--danger-color)',
                            fontWeight: '600'
                        }}>
                            {resourceData.active ? '✓ Active' : '✕ Inactive'}
                        </div>
                    </div>
                    <div style={{
                        padding: '15px',
                        background: 'var(--background-secondary)',
                        borderRadius: 'var(--radius-md)',
                        border: '1px solid var(--border-color)'
                    }}>
                        <div style={{ 
                            color: 'var(--text-secondary)', 
                            marginBottom: '5px',
                            fontSize: '12px',
                            fontWeight: '600'
                        }}>
                            Visibility
                        </div>
                        <div style={{ 
                            color: 'var(--text-primary)', 
                            fontWeight: '600'
                        }}>
                            {resourceData.isGlobal ? '🌐 Global' : '👥 Assigned Only'}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );

    // ========== MAIN RENDER ==========
    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.5)',
            backdropFilter: 'blur(5px)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000,
            animation: 'fadeIn 0.3s ease-in-out',
            padding: '20px'
        }}>
            <div style={{
                maxWidth: '1100px',
                width: '100%',
                maxHeight: '90vh',
                background: 'var(--text-white)',
                borderRadius: 'var(--radius-xl)',
                boxShadow: 'var(--shadow-xl)',
                display: 'flex',
                flexDirection: 'column',
                overflow: 'hidden',
                animation: 'slideUp 0.3s ease-out'
            }}>
                {/* ========== MODAL HEADER ========== */}
                <div style={{
                    background: 'var(--gradient-primary)',
                    padding: '25px 30px',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    borderBottom: '1px solid rgba(255,255,255,0.1)'
                }}>
                    <h3 style={{
                        margin: 0,
                        color: 'var(--text-white)',
                        fontSize: '24px',
                        fontWeight: '600',
                        letterSpacing: '-0.5px'
                    }}>
                        {resourceData.title}
                    </h3>
                    <button
                        onClick={onClose}
                        style={{
                            background: 'rgba(255,255,255,0.2)',
                            border: 'none',
                            color: 'var(--text-white)',
                            fontSize: '28px',
                            width: '40px',
                            height: '40px',
                            borderRadius: '50%',
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            transition: 'var(--transition-fast)',
                            fontWeight: '300'
                        }}
                        onMouseEnter={(e) => {
                            e.currentTarget.style.background = 'rgba(255,255,255,0.3)';
                            e.currentTarget.style.transform = 'rotate(90deg)';
                        }}
                        onMouseLeave={(e) => {
                            e.currentTarget.style.background = 'rgba(255,255,255,0.2)';
                            e.currentTarget.style.transform = 'rotate(0deg)';
                        }}
                    >
                        ×
                    </button>
                </div>

                {/* ========== TAB NAVIGATION ========== */}
                <div style={{
                    display: 'flex',
                    gap: '8px',
                    padding: '20px 25px 0 25px',
                    background: 'var(--background-secondary)',
                    borderBottom: '2px solid var(--border-color)',
                    overflowX: 'auto',
                    position: 'sticky',
                    top: 0,
                    zIndex: 10
                }}>
                    {[
                        { id: 'overview', icon: '📊', label: 'Overview' },
                        { id: 'assignments', icon: '📝', label: 'Assignments' },
                        { id: 'feedback', icon: '💬', label: 'Feedback' },
                        { id: 'actions', icon: '⚙️', label: 'Actions' }
                    ].map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveTab(tab.id)}
                            style={{
                                padding: '12px 20px',
                                border: 'none',
                                background: activeTab === tab.id ? 
                                    'var(--gradient-primary)' : 
                                    'transparent',
                                color: activeTab === tab.id ? 
                                    'var(--text-white)' : 
                                    'var(--text-secondary)',
                                borderRadius: 'var(--radius-md) var(--radius-md) 0 0',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: activeTab === tab.id ? '600' : '500',
                                transition: 'var(--transition-fast)',
                                whiteSpace: 'nowrap',
                                boxShadow: activeTab === tab.id ? 'var(--shadow-sm)' : 'none'
                            }}
                            onMouseEnter={(e) => {
                                if (activeTab !== tab.id) {
                                    e.currentTarget.style.background = 'var(--background-primary)';
                                    e.currentTarget.style.color = 'var(--text-primary)';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (activeTab !== tab.id) {
                                    e.currentTarget.style.background = 'transparent';
                                    e.currentTarget.style.color = 'var(--text-secondary)';
                                }
                            }}
                        >
                            {tab.icon} {tab.label}
                        </button>
                    ))}
                </div>

                {/* ========== TAB CONTENT ========== */}
                <div style={{
                    flex: 1,
                    overflowY: 'auto',
                    background: 'var(--background-secondary)',
                    transition: 'opacity 0.3s ease-in-out',
                    position: 'relative',
                    zIndex: 1
                }}>
                    {activeTab === 'overview' && renderOverviewTab()}
                    {activeTab === 'assignments' && renderAssignmentsTab()}
                    {activeTab === 'feedback' && renderFeedbackTab()}
                    {activeTab === 'actions' && renderActionsTab()}
                </div>
            </div>

            {/* ========== ASSIGN PIRs MODAL ========== */}
            {showAssignModal && (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0, 0, 0, 0.7)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 10001
                }}>
                    <div style={{
                        maxWidth: '600px',
                        width: '90%',
                        maxHeight: '80vh',
                        background: 'var(--text-white)',
                        borderRadius: 'var(--radius-xl)',
                        boxShadow: 'var(--shadow-xl)',
                        display: 'flex',
                        flexDirection: 'column',
                        overflow: 'hidden'
                    }}>
                        {/* Modal Header */}
                        <div style={{
                            background: 'var(--gradient-success)',
                            padding: '20px 25px',
                            borderBottom: '1px solid rgba(255,255,255,0.1)'
                        }}>
                            <h4 style={{
                                margin: 0,
                                color: 'var(--text-white)',
                                fontSize: '20px',
                                fontWeight: '600'
                            }}>
                                Assign Resource to PIRs
                            </h4>
                        </div>

                        {/* Modal Content */}
                        <div style={{
                            flex: 1,
                            overflowY: 'auto',
                            padding: '25px',
                            background: 'var(--background-secondary)'
                        }}>
                            {/* Search */}
                            <input
                                type="text"
                                value={searchPir}
                                onChange={(e) => setSearchPir(e.target.value)}
                                placeholder="🔍 Search PIRs by name or email..."
                                style={{
                                    width: '100%',
                                    padding: '12px 15px',
                                    borderRadius: 'var(--radius-md)',
                                    border: '1px solid var(--border-color)',
                                    fontSize: '14px',
                                    color: 'var(--text-primary)',
                                    background: 'var(--background-primary)',
                                    marginBottom: '20px'
                                }}
                            />

                            {/* PIR List */}
                            <div style={{
                                display: 'flex',
                                flexDirection: 'column',
                                gap: '10px'
                            }}>
                                {getFilteredUnassignedPirs().length === 0 ? (
                                    <div style={{
                                        textAlign: 'center',
                                        padding: '40px 20px',
                                        background: 'var(--background-primary)',
                                        borderRadius: 'var(--radius-lg)',
                                        color: 'var(--text-secondary)'
                                    }}>
                                        {getUnassignedPirs().length === 0 
                                            ? 'All PIRs are already assigned to this resource'
                                            : 'No PIRs match your search'}
                                    </div>
                                ) : (
                                    getFilteredUnassignedPirs().map(pir => (
                                        <label
                                            key={pir.id}
                                            style={{
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '12px',
                                                padding: '15px',
                                                background: selectedPirs.includes(pir.id) ? 
                                                    'var(--bg-primary-light)' : 
                                                    'var(--background-primary)',
                                                borderRadius: 'var(--radius-md)',
                                                cursor: 'pointer',
                                                transition: 'var(--transition-fast)',
                                                border: '1px solid var(--border-color)'
                                            }}
                                            onMouseEnter={(e) => {
                                                e.currentTarget.style.borderColor = 'var(--primary-color)';
                                            }}
                                            onMouseLeave={(e) => {
                                                e.currentTarget.style.borderColor = 'var(--border-color)';
                                            }}
                                        >
                                            <input
                                                type="checkbox"
                                                checked={selectedPirs.includes(pir.id)}
                                                onChange={(e) => {
                                                    if (e.target.checked) {
                                                        setSelectedPirs([...selectedPirs, pir.id]);
                                                    } else {
                                                        setSelectedPirs(selectedPirs.filter(id => id !== pir.id));
                                                    }
                                                }}
                                                style={{
                                                    cursor: 'pointer',
                                                    width: '18px',
                                                    height: '18px'
                                                }}
                                            />
                                            <div style={{ flex: 1 }}>
                                                <div style={{
                                                    fontSize: '14px',
                                                    fontWeight: '600',
                                                    color: 'var(--text-primary)',
                                                    marginBottom: '2px'
                                                }}>
                                                    {pir.firstName} {pir.lastName}
                                                </div>
                                                <div style={{
                                                    fontSize: '12px',
                                                    color: 'var(--text-secondary)'
                                                }}>
                                                    {pir.email}
                                                </div>
                                            </div>
                                        </label>
                                    ))
                                )}
                            </div>
                        </div>

                        {/* Modal Footer */}
                        <div style={{
                            padding: '20px 25px',
                            background: 'var(--background-primary)',
                            borderTop: '2px solid var(--border-color)',
                            display: 'flex',
                            gap: '12px',
                            justifyContent: 'flex-end'
                        }}>
                            <button
                                onClick={() => {
                                    setShowAssignModal(false);
                                    setSelectedPirs([]);
                                    setSearchPir('');
                                }}
                                disabled={saving}
                                style={{
                                    padding: '12px 20px',
                                    borderRadius: 'var(--radius-md)',
                                    border: '1px solid var(--border-color)',
                                    background: 'var(--background-secondary)',
                                    color: 'var(--text-primary)',
                                    fontSize: '14px',
                                    fontWeight: '600',
                                    cursor: saving ? 'not-allowed' : 'pointer',
                                    opacity: saving ? 0.5 : 1
                                }}
                            >
                                Cancel
                            </button>
                            <button
                                onClick={handleAssignPirs}
                                disabled={saving || selectedPirs.length === 0}
                                style={{
                                    padding: '12px 20px',
                                    borderRadius: 'var(--radius-md)',
                                    border: 'none',
                                    background: (saving || selectedPirs.length === 0) ? 
                                        'var(--text-gray)' : 
                                        'var(--gradient-success)',
                                    color: 'var(--text-white)',
                                    fontSize: '14px',
                                    fontWeight: '600',
                                    cursor: (saving || selectedPirs.length === 0) ? 'not-allowed' : 'pointer',
                                    boxShadow: (saving || selectedPirs.length === 0) ? 'none' : 'var(--shadow-md)'
                                }}
                            >
                                {saving ? 'Assigning...' : `Assign to ${selectedPirs.length} PIR${selectedPirs.length !== 1 ? 's' : ''}`}
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}
      // COMPLETE ENHANCED CHECK-INS VIEW - ALL FEATURES WITH ANALYTICS
function CheckInsView({ searchQuery }) {
    const [checkIns, setCheckIns] = useState([]);
    const [filteredCheckIns, setFilteredCheckIns] = useState([]);
    const [loading, setLoading] = useState(true);
    const [currentPage, setCurrentPage] = useState(1);
    const [filterUser, setFilterUser] = useState('all');
    const [filterMood, setFilterMood] = useState('all');
    const [filterCraving, setFilterCraving] = useState('all');
    const [filterAnxiety, setFilterAnxiety] = useState('all');
    const [filterSleep, setFilterSleep] = useState('all');
    const [filterDate, setFilterDate] = useState('all');
    const [filterCompletion, setFilterCompletion] = useState('all');
    const [filterRisk, setFilterRisk] = useState('all');
    const [users, setUsers] = useState([]);
    const [selectedCheckIn, setSelectedCheckIn] = useState(null);
    const [activeTab, setActiveTab] = useState('all');
    const [sortBy, setSortBy] = useState('date');
    const [selectedCheckIns, setSelectedCheckIns] = useState(new Set());
    const [showCharts, setShowCharts] = useState(false);
    const [coachNotes, setCoachNotes] = useState({});
    const [reviewedCheckIns, setReviewedCheckIns] = useState(new Set());
    const [analyticsData, setAnalyticsData] = useState(null);
    const [showAnalytics, setShowAnalytics] = useState(false);
    const [selectedPIRForReport, setSelectedPIRForReport] = useState(null);
    
    const moodChartRef = useRef(null);
    const cravingChartRef = useRef(null);
    const anxietyChartRef = useRef(null);
    const sleepChartRef = useRef(null);
    const completionChartRef = useRef(null);
    const chartInstances = useRef({});
    
    const itemsPerPage = 20;

    useEffect(() => {
        loadCheckInsAndUsers();
        loadCoachData();
    }, []);

    useEffect(() => {
        filterCheckIns();
    }, [checkIns, filterUser, filterMood, filterCraving, filterAnxiety, filterSleep, filterDate, filterCompletion, filterRisk, searchQuery, activeTab, sortBy]);

    useEffect(() => {
        if (showCharts && filteredCheckIns.length > 0) {
            renderCharts();
        }
        
        return () => {
            Object.values(chartInstances.current).forEach(chart => {
                if (chart) chart.destroy();
            });
        };
    }, [showCharts, filteredCheckIns]);

    useEffect(() => {
        if (checkIns.length > 0) {
            calculateAnalytics();
        }
    }, [checkIns]);

    const loadCheckInsAndUsers = async () => {
        try {
            const usersSnap = await db.collection('users')
                .where('role', '==', 'pir')
                .get();
            
            const usersData = [];
            const userMap = {};
            
            usersSnap.forEach(doc => {
                const user = { id: doc.id, ...doc.data() };
                usersData.push(user);
                userMap[doc.id] = user.displayName || user.email;
            });
            
            setUsers(usersData);

            const checkInsSnap = await db.collection('checkIns')
                .orderBy('createdAt', 'desc')
                .limit(1000)
                .get();
            
            const checkInsData = [];
            checkInsSnap.forEach(doc => {
                const checkIn = { id: doc.id, ...doc.data() };
                checkIn.userName = userMap[checkIn.userId] || 'Unknown User';
                checkIn.riskLevel = calculateRiskLevel(checkIn);
                checkIn.completionStatus = getCompletionStatus(checkIn);
                checkInsData.push(checkIn);
            });
            
            setCheckIns(checkInsData);
        } catch (error) {
            console.error('Error loading check-ins:', error);
            alert('Failed to load check-ins');
        } finally {
            setLoading(false);
        }
    };

    const loadCoachData = async () => {
        try {
            const notesSnap = await db.collection('coachNotes')
                .where('type', '==', 'checkin')
                .get();
            
            const notes = {};
            notesSnap.forEach(doc => {
                notes[doc.data().checkInId] = doc.data();
            });
            setCoachNotes(notes);

            const reviewedSnap = await db.collection('checkInReviews')
                .get();
            
            const reviewed = new Set();
            reviewedSnap.forEach(doc => {
                reviewed.add(doc.data().checkInId);
            });
            setReviewedCheckIns(reviewed);
        } catch (error) {
            console.error('Error loading coach data:', error);
        }
    };

    const calculateRiskLevel = (checkIn) => {
        const morningMood = checkIn.morningData?.mood ?? 10;
        const morningCraving = checkIn.morningData?.craving ?? 0;
        const anxiety = checkIn.eveningData?.anxiety ?? 0;
        
        if (morningMood <= 3 && morningCraving >= 7) return 'critical';
        if (morningMood <= 4 && morningCraving >= 6) return 'high';
        if (morningMood <= 5 || morningCraving >= 5 || anxiety >= 7) return 'moderate';
        return 'low';
    };

    const getCompletionStatus = (checkIn) => {
        const hasMorning = checkIn.morningData && Object.keys(checkIn.morningData).length > 0;
        const hasEvening = checkIn.eveningData && Object.keys(checkIn.eveningData).length > 0;
        
        if (hasMorning && hasEvening) return 'complete';
        if (hasMorning && !hasEvening) return 'morning-only';
        if (!hasMorning && hasEvening) return 'evening-only';
        return 'incomplete';
    };

    const calculateAnalytics = () => {
        const pirStats = {};
        const allPIRsData = {
            totalCheckIns: checkIns.length,
            avgMood: 0,
            avgCraving: 0,
            avgAnxiety: 0,
            avgSleep: 0,
            completionRate: 0,
            last30Days: {
                avgMood: 0,
                avgCraving: 0,
                avgAnxiety: 0,
                avgSleep: 0,
                completionRate: 0
            }
        };

        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

        // Calculate per-PIR stats
        checkIns.forEach(checkIn => {
            if (!pirStats[checkIn.userId]) {
                pirStats[checkIn.userId] = {
                    userName: checkIn.userName,
                    userId: checkIn.userId,
                    totalCheckIns: 0,
                    completeCheckIns: 0,
                    moodSum: 0,
                    moodCount: 0,
                    cravingSum: 0,
                    cravingCount: 0,
                    anxietySum: 0,
                    anxietyCount: 0,
                    sleepSum: 0,
                    sleepCount: 0,
                    last30: {
                        totalCheckIns: 0,
                        completeCheckIns: 0,
                        moodSum: 0,
                        moodCount: 0,
                        cravingSum: 0,
                        cravingCount: 0,
                        anxietySum: 0,
                        anxietyCount: 0,
                        sleepSum: 0,
                        sleepCount: 0
                    }
                };
            }

            const stat = pirStats[checkIn.userId];
            const checkInDate = checkIn.createdAt?.toDate ? checkIn.createdAt.toDate() : new Date(checkIn.createdAt);
            const isLast30 = checkInDate >= thirtyDaysAgo;

            stat.totalCheckIns++;
            if (checkIn.completionStatus === 'complete') stat.completeCheckIns++;

            if (checkIn.morningData?.mood != null) {
                stat.moodSum += checkIn.morningData.mood;
                stat.moodCount++;
            }
            if (checkIn.morningData?.craving != null) {
                stat.cravingSum += checkIn.morningData.craving;
                stat.cravingCount++;
            }
           if (checkIn.morningData?.anxietyLevel != null) {
    stat.anxietySum += checkIn.morningData.anxietyLevel;
    stat.anxietyCount++;
}
if (checkIn.morningData?.sleepQuality != null) {
    stat.sleepSum += checkIn.morningData.sleepQuality;
    stat.sleepCount++;
}

            if (isLast30) {
                stat.last30.totalCheckIns++;
                if (checkIn.completionStatus === 'complete') stat.last30.completeCheckIns++;
                
                if (checkIn.morningData?.mood != null) {
                    stat.last30.moodSum += checkIn.morningData.mood;
                    stat.last30.moodCount++;
                }
                if (checkIn.morningData?.craving != null) {
                    stat.last30.cravingSum += checkIn.morningData.craving;
                    stat.last30.cravingCount++;
                }
                if (checkIn.morningData?.anxietyLevel != null) {
    stat.last30.anxietySum += checkIn.morningData.anxietyLevel;
    stat.last30.anxietyCount++;
}
if (checkIn.morningData?.sleepQuality != null) {
    stat.last30.sleepSum += checkIn.morningData.sleepQuality;
    stat.last30.sleepCount++;
}
            }
        });

        // Calculate averages
        Object.values(pirStats).forEach(stat => {
            stat.avgMood = stat.moodCount > 0 ? (stat.moodSum / stat.moodCount).toFixed(1) : 'N/A';
            stat.avgCraving = stat.cravingCount > 0 ? (stat.cravingSum / stat.cravingCount).toFixed(1) : 'N/A';
            stat.avgAnxiety = stat.anxietyCount > 0 ? (stat.anxietySum / stat.anxietyCount).toFixed(1) : 'N/A';
            stat.avgSleep = stat.sleepCount > 0 ? (stat.sleepSum / stat.sleepCount).toFixed(1) : 'N/A';
            stat.completionRate = stat.totalCheckIns > 0 ? Math.round((stat.completeCheckIns / stat.totalCheckIns) * 100) : 0;

            stat.last30.avgMood = stat.last30.moodCount > 0 ? (stat.last30.moodSum / stat.last30.moodCount).toFixed(1) : 'N/A';
            stat.last30.avgCraving = stat.last30.cravingCount > 0 ? (stat.last30.cravingSum / stat.last30.cravingCount).toFixed(1) : 'N/A';
            stat.last30.avgAnxiety = stat.last30.anxietyCount > 0 ? (stat.last30.anxietySum / stat.last30.anxietyCount).toFixed(1) : 'N/A';
            stat.last30.avgSleep = stat.last30.sleepCount > 0 ? (stat.last30.sleepSum / stat.last30.sleepCount).toFixed(1) : 'N/A';
            stat.last30.completionRate = stat.last30.totalCheckIns > 0 ? Math.round((stat.last30.completeCheckIns / stat.last30.totalCheckIns) * 100) : 0;
        });

        // Calculate all-PIRs aggregate
        let totalMood = 0, totalCraving = 0, totalAnxiety = 0, totalSleep = 0;
        let moodCount = 0, cravingCount = 0, anxietyCount = 0, sleepCount = 0;
        let completeCount = 0;
        let last30Mood = 0, last30Craving = 0, last30Anxiety = 0, last30Sleep = 0;
        let last30MoodCount = 0, last30CravingCount = 0, last30AnxietyCount = 0, last30SleepCount = 0;
        let last30Complete = 0, last30Total = 0;

        checkIns.forEach(checkIn => {
            const checkInDate = checkIn.createdAt?.toDate ? checkIn.createdAt.toDate() : new Date(checkIn.createdAt);
            const isLast30 = checkInDate >= thirtyDaysAgo;

            if (checkIn.completionStatus === 'complete') completeCount++;
            
            if (checkIn.morningData?.mood != null) {
                totalMood += checkIn.morningData.mood;
                moodCount++;
            }
            if (checkIn.morningData?.craving != null) {
                totalCraving += checkIn.morningData.craving;
                cravingCount++;
            }
            if (checkIn.morningData?.anxietyLevel != null) {
    totalAnxiety += checkIn.morningData.anxietyLevel;
    anxietyCount++;
}
if (checkIn.morningData?.sleepQuality != null) {
    totalSleep += checkIn.morningData.sleepQuality;
    sleepCount++;
}

            if (isLast30) {
                last30Total++;
                if (checkIn.completionStatus === 'complete') last30Complete++;
                
                if (checkIn.morningData?.mood != null) {
                    last30Mood += checkIn.morningData.mood;
                    last30MoodCount++;
                }
                if (checkIn.morningData?.craving != null) {
                    last30Craving += checkIn.morningData.craving;
                    last30CravingCount++;
                }
               if (checkIn.morningData?.anxietyLevel != null) {
    last30Anxiety += checkIn.morningData.anxietyLevel;
    last30AnxietyCount++;
}
if (checkIn.morningData?.sleepQuality != null) {
    last30Sleep += checkIn.morningData.sleepQuality;
    last30SleepCount++;
}
            }
        });

        allPIRsData.avgMood = moodCount > 0 ? (totalMood / moodCount).toFixed(1) : 'N/A';
        allPIRsData.avgCraving = cravingCount > 0 ? (totalCraving / cravingCount).toFixed(1) : 'N/A';
        allPIRsData.avgAnxiety = anxietyCount > 0 ? (totalAnxiety / anxietyCount).toFixed(1) : 'N/A';
        allPIRsData.avgSleep = sleepCount > 0 ? (totalSleep / sleepCount).toFixed(1) : 'N/A';
        allPIRsData.completionRate = checkIns.length > 0 ? Math.round((completeCount / checkIns.length) * 100) : 0;

        allPIRsData.last30Days.avgMood = last30MoodCount > 0 ? (last30Mood / last30MoodCount).toFixed(1) : 'N/A';
        allPIRsData.last30Days.avgCraving = last30CravingCount > 0 ? (last30Craving / last30CravingCount).toFixed(1) : 'N/A';
        allPIRsData.last30Days.avgAnxiety = last30AnxietyCount > 0 ? (last30Anxiety / last30AnxietyCount).toFixed(1) : 'N/A';
        allPIRsData.last30Days.avgSleep = last30SleepCount > 0 ? (last30Sleep / last30SleepCount).toFixed(1) : 'N/A';
        allPIRsData.last30Days.completionRate = last30Total > 0 ? Math.round((last30Complete / last30Total) * 100) : 0;

        setAnalyticsData({ pirStats, allPIRsData });
    };

    const detectPatterns = () => {
        const patterns = [];
        const pirCheckIns = {};
        
        checkIns.forEach(checkIn => {
            if (!pirCheckIns[checkIn.userId]) {
                pirCheckIns[checkIn.userId] = [];
            }
            pirCheckIns[checkIn.userId].push(checkIn);
        });

        Object.entries(pirCheckIns).forEach(([userId, userCheckIns]) => {
            const sorted = userCheckIns.sort((a, b) => {
                const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt);
                const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt);
                return dateB - dateA;
            });

            if (sorted.length >= 3) {
                const recent = sorted.slice(0, 3);
                const moods = recent.map(c => c.morningData?.mood ?? 10);
                
                if (moods[0] < moods[1] && moods[1] < moods[2]) {
                    patterns.push({
                        userId,
                        userName: recent[0].userName,
                        type: 'declining-mood',
                        message: `${recent[0].userName}'s mood declining over 3 days`
                    });
                }

                const cravings = recent.map(c => c.morningData?.craving ?? 0);
                if (cravings[0] > 6 && cravings[1] > 6 && cravings[2] > 6) {
                    patterns.push({
                        userId,
                        userName: recent[0].userName,
                        type: 'high-cravings',
                        message: `${recent[0].userName} has high cravings for 3+ days`
                    });
                }

                const anxiety = recent.map(c => c.eveningData?.anxiety ?? 0);
                if (anxiety[0] > 7 && anxiety[1] > 7) {
                    patterns.push({
                        userId,
                        userName: recent[0].userName,
                        type: 'high-anxiety',
                        message: `${recent[0].userName} reporting high anxiety`
                    });
                }
            }

            const incomplete = userCheckIns.filter(c => c.completionStatus !== 'complete');
            if (incomplete.length >= 3) {
                patterns.push({
                    userId,
                    userName: userCheckIns[0].userName,
                    type: 'incomplete-pattern',
                    message: `${userCheckIns[0].userName} has ${incomplete.length} incomplete check-ins`
                });
            }

            // Keyword detection
            const recentNotes = sorted.slice(0, 5);
            const concerningWords = ['relapse', 'using', 'hopeless', 'giving up', 'cant cope', 'want to use'];
            recentNotes.forEach(checkIn => {
                const allText = [
                    checkIn.morningData?.notes,
                    checkIn.eveningData?.gratitude,
                    checkIn.eveningData?.challenges,
                    checkIn.eveningData?.tomorrowGoal
                ].filter(Boolean).join(' ').toLowerCase();

                concerningWords.forEach(word => {
                    if (allText.includes(word)) {
                        patterns.push({
                            userId,
                            userName: checkIn.userName,
                            type: 'keyword-alert',
                            message: `${checkIn.userName} mentioned "${word}" in check-in`
                        });
                    }
                });
            });
        });

        return patterns;
    };

    const filterCheckIns = () => {
        let filtered = checkIns;
        
        if (activeTab === 'at-risk') {
            filtered = filtered.filter(c => c.riskLevel === 'critical' || c.riskLevel === 'high');
        } else if (activeTab === 'incomplete') {
            filtered = filtered.filter(c => c.completionStatus !== 'complete');
        } else if (activeTab === 'week') {
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            filtered = filtered.filter(c => {
                const date = c.createdAt?.toDate ? c.createdAt.toDate() : new Date(c.createdAt);
                return date >= weekAgo;
            });
        } else if (activeTab === 'needs-review') {
            filtered = filtered.filter(c => !reviewedCheckIns.has(c.id));
        }
        
        if (filterUser !== 'all') {
            filtered = filtered.filter(c => c.userId === filterUser);
        }
        
        if (filterMood !== 'all') {
            const moodValue = parseInt(filterMood);
            if (moodValue === 1) {
                filtered = filtered.filter(c => (c.morningData?.mood ?? 10) <= 3);
            } else if (moodValue === 2) {
                filtered = filtered.filter(c => {
                    const mood = c.morningData?.mood ?? 10;
                    return mood >= 4 && mood <= 6;
                });
            } else if (moodValue === 3) {
                filtered = filtered.filter(c => (c.morningData?.mood ?? 10) >= 7);
            }
        }

        if (filterCraving !== 'all') {
            const cravingValue = parseInt(filterCraving);
            if (cravingValue === 1) {
                filtered = filtered.filter(c => (c.morningData?.craving ?? 0) <= 3);
            } else if (cravingValue === 2) {
                filtered = filtered.filter(c => {
                    const craving = c.morningData?.craving ?? 0;
                    return craving >= 4 && craving <= 6;
                });
            } else if (cravingValue === 3) {
                filtered = filtered.filter(c => (c.morningData?.craving ?? 0) >= 7);
            }
        }

       if (filterAnxiety !== 'all') {
    const anxietyValue = parseInt(filterAnxiety);
    if (anxietyValue === 1) {
        filtered = filtered.filter(c => (c.morningData?.anxietyLevel ?? 0) <= 3);
    } else if (anxietyValue === 2) {
        filtered = filtered.filter(c => {
            const anxiety = c.morningData?.anxietyLevel ?? 0;
            return anxiety >= 4 && anxiety <= 6;
        });
    } else if (anxietyValue === 3) {
        filtered = filtered.filter(c => (c.morningData?.anxietyLevel ?? 0) >= 7);
    }
}

if (filterSleep !== 'all') {
    const sleepValue = parseInt(filterSleep);
    if (sleepValue === 1) {
        filtered = filtered.filter(c => (c.morningData?.sleepQuality ?? 0) <= 3);
    } else if (sleepValue === 2) {
        filtered = filtered.filter(c => {
            const sleep = c.morningData?.sleepQuality ?? 0;
            return sleep >= 4 && sleep <= 6;
        });
    } else if (sleepValue === 3) {
        filtered = filtered.filter(c => (c.morningData?.sleepQuality ?? 0) >= 7);
    }
}
        
        if (filterDate !== 'all') {
            const now = new Date();
            const startDate = new Date();
            
            if (filterDate === 'today') {
                startDate.setHours(0, 0, 0, 0);
            } else if (filterDate === 'week') {
                startDate.setDate(now.getDate() - 7);
            } else if (filterDate === 'month') {
                startDate.setMonth(now.getMonth() - 1);
            }
            
            filtered = filtered.filter(c => {
                const date = c.createdAt?.toDate ? c.createdAt.toDate() : new Date(c.createdAt);
                return date >= startDate;
            });
        }

        if (filterCompletion !== 'all') {
            filtered = filtered.filter(c => c.completionStatus === filterCompletion);
        }

        if (filterRisk !== 'all') {
            filtered = filtered.filter(c => c.riskLevel === filterRisk);
        }
        
        if (searchQuery) {
            const query = searchQuery.toLowerCase();
            filtered = filtered.filter(c =>
                c.userName?.toLowerCase().includes(query) ||
                c.morningData?.notes?.toLowerCase().includes(query) ||
                c.eveningData?.gratitude?.toLowerCase().includes(query) ||
                c.eveningData?.challenges?.toLowerCase().includes(query) ||
                c.eveningData?.tomorrowGoal?.toLowerCase().includes(query)
            );
        }

        // Sorting
        filtered.sort((a, b) => {
            if (sortBy === 'date') {
                const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt);
                const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt);
                return dateB - dateA;
            } else if (sortBy === 'user') {
                return a.userName.localeCompare(b.userName);
            } else if (sortBy === 'risk') {
                const riskOrder = { critical: 0, high: 1, moderate: 2, low: 3 };
                return riskOrder[a.riskLevel] - riskOrder[b.riskLevel];
            } else if (sortBy === 'mood') {
                return (a.morningData?.mood ?? 10) - (b.morningData?.mood ?? 10);
            }
            return 0;
        });
        
        setFilteredCheckIns(filtered);
        setCurrentPage(1);
    };

    const renderCharts = () => {
        if (moodChartRef.current) {
            if (chartInstances.current.mood) chartInstances.current.mood.destroy();
            
            const ctx = moodChartRef.current.getContext('2d');
            const last30 = filteredCheckIns.slice(0, 30).reverse();
            
            chartInstances.current.mood = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last30.map(c => formatDate(c.createdAt)),
                    datasets: [{
                        label: 'Morning Mood',
                        data: last30.map(c => c.morningData?.mood ?? null),
                        borderColor: '#0077CC',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 10 }
                    }
                }
            });
        }

        if (cravingChartRef.current) {
            if (chartInstances.current.craving) chartInstances.current.craving.destroy();
            
            const ctx = cravingChartRef.current.getContext('2d');
            const last30 = filteredCheckIns.slice(0, 30).reverse();
            
            chartInstances.current.craving = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last30.map(c => formatDate(c.createdAt)),
                    datasets: [{
                        label: 'Cravings',
                        data: last30.map(c => c.morningData?.craving ?? null),
                        borderColor: '#f44336',
                        backgroundColor: 'rgba(244, 67, 54, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 10 }
                    }
                }
            });
        }

        if (anxietyChartRef.current) {
            if (chartInstances.current.anxiety) chartInstances.current.anxiety.destroy();
            
            const ctx = anxietyChartRef.current.getContext('2d');
            const last30 = filteredCheckIns.slice(0, 30).reverse();
            
            chartInstances.current.anxiety = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last30.map(c => formatDate(c.createdAt)),
                   datasets: [{
    label: 'Anxiety',
    data: last30.map(c => c.morningData?.anxietyLevel ?? null),
    borderColor: '#FF9800',
    backgroundColor: 'rgba(255, 152, 0, 0.1)',
    tension: 0.4,
    fill: true
}]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 10 }
                    }
                }
            });
        }

        if (sleepChartRef.current) {
            if (chartInstances.current.sleep) chartInstances.current.sleep.destroy();
            
            const ctx = sleepChartRef.current.getContext('2d');
            const last30 = filteredCheckIns.slice(0, 30).reverse();
            
            chartInstances.current.sleep = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last30.map(c => formatDate(c.createdAt)),
                    datasets: [{
    label: 'Sleep Quality',
    data: last30.map(c => c.morningData?.sleepQuality ?? null),
    borderColor: '#9C27B0',
    backgroundColor: 'rgba(156, 39, 176, 0.1)',
    tension: 0.4,
    fill: true
}]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 10 }
                    }
                }
            });
        }

        if (completionChartRef.current) {
            if (chartInstances.current.completion) chartInstances.current.completion.destroy();
            
            const ctx = completionChartRef.current.getContext('2d');
            const statusCounts = {
                complete: filteredCheckIns.filter(c => c.completionStatus === 'complete').length,
                'morning-only': filteredCheckIns.filter(c => c.completionStatus === 'morning-only').length,
                'evening-only': filteredCheckIns.filter(c => c.completionStatus === 'evening-only').length,
                incomplete: filteredCheckIns.filter(c => c.completionStatus === 'incomplete').length
            };
            
            chartInstances.current.completion = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Both Complete', 'Morning Only', 'Evening Only', 'Incomplete'],
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['#00A86B', '#FFC107', '#FF9800', '#f44336']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
    };

    const handleExport = (format, selectedOnly = false) => {
        const dataToExport = selectedOnly 
            ? filteredCheckIns.filter(c => selectedCheckIns.has(c.id))
            : filteredCheckIns;

        if (format === 'pdf') {
            exportCheckInsToPDF(dataToExport);
        } else {
            const exportData = dataToExport.map(checkIn => ({
                user: checkIn.userName,
                date: formatDateTime(checkIn.createdAt),
                morningMood: checkIn.morningData?.mood ?? '-',
                morningCraving: checkIn.morningData?.craving ?? '-',
                morningNotes: checkIn.morningData?.notes ?? '-',
                eveningAnxiety: checkIn.eveningData?.anxiety ?? '-',
                eveningSleep: checkIn.eveningData?.sleepQuality ?? '-',
                eveningOverallDay: checkIn.eveningData?.overallDay ?? '-',
                eveningGratitude: checkIn.eveningData?.gratitude ?? '-',
                eveningChallenges: checkIn.eveningData?.challenges ?? '-',
                eveningTomorrowGoal: checkIn.eveningData?.tomorrowGoal ?? '-',
                completionStatus: checkIn.completionStatus,
                riskLevel: checkIn.riskLevel,
                reviewed: reviewedCheckIns.has(checkIn.id) ? 'Yes' : 'No'
            }));

            if (format === 'json') {
                exportToJSON(exportData, 'checkins');
            } else if (format === 'csv') {
                exportToCSV(exportData, 'checkins');
            }
        }
    };

    const exportCheckInsToPDF = (data) => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('landscape');
        
        let yPos = 20;
        
        // Title
        doc.setFontSize(18);
        doc.text('Check-ins Report', 14, yPos);
        yPos += 10;
        
        doc.setFontSize(10);
        doc.text(`Generated: ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}`, 14, yPos);
        doc.text(`Total Records: ${data.length}`, 200, yPos);
        yPos += 15;

        // Morning Data Table
        doc.setFontSize(14);
        doc.text('Morning Check-ins', 14, yPos);
        yPos += 5;

        const morningData = data.map(c => [
            c.userName,
            formatDate(c.createdAt),
            c.morningData?.mood ?? '-',
            c.morningData?.craving ?? '-',
            (c.morningData?.notes ?? '-').substring(0, 50) + (c.morningData?.notes?.length > 50 ? '...' : ''),
            c.completionStatus.replace('-', ' ')
        ]);

        doc.autoTable({
            startY: yPos,
            head: [['PIR', 'Date', 'Mood', 'Craving', 'Notes', 'Status']],
            body: morningData,
            theme: 'grid',
            headStyles: { fillColor: [102, 126, 234] },
            styles: { fontSize: 8 },
            columnStyles: {
                0: { cellWidth: 40 },
                1: { cellWidth: 35 },
                2: { cellWidth: 20 },
                3: { cellWidth: 20 },
                4: { cellWidth: 80 },
                5: { cellWidth: 35 }
            }
        });

        // Evening Data Table (new page)
        doc.addPage();
        yPos = 20;
        
        doc.setFontSize(14);
        doc.text('Evening Reflections', 14, yPos);
        yPos += 5;

        const eveningData = data.map(c => [
            c.userName,
            formatDate(c.createdAt),
            c.eveningData?.overallDay ?? '-',
           c.morningData?.anxietyLevel ?? '-',
c.morningData?.sleepQuality ?? '-',
            (c.eveningData?.gratitude ?? '-').substring(0, 40) + (c.eveningData?.gratitude?.length > 40 ? '...' : '')
        ]);

        doc.autoTable({
            startY: yPos,
            head: [['PIR', 'Date', 'Overall', 'Anxiety', 'Sleep', 'Gratitude']],
            body: eveningData,
            theme: 'grid',
            headStyles: { fillColor: [118, 75, 162] },
            styles: { fontSize: 8 },
            columnStyles: {
                0: { cellWidth: 40 },
                1: { cellWidth: 35 },
                2: { cellWidth: 20 },
                3: { cellWidth: 20 },
                4: { cellWidth: 20 },
                5: { cellWidth: 95 }
            }
        });

        // Challenges & Goals (new page if many records)
        if (data.length > 10) {
            doc.addPage();
            yPos = 20;
        } else {
            yPos = doc.lastAutoTable.finalY + 15;
        }

        doc.setFontSize(14);
        doc.text('Challenges & Tomorrow Goals', 14, yPos);
        yPos += 5;

        const detailsData = data.map(c => [
            c.userName,
            formatDate(c.createdAt),
            (c.eveningData?.challenges ?? '-').substring(0, 60) + (c.eveningData?.challenges?.length > 60 ? '...' : ''),
            (c.eveningData?.tomorrowGoal ?? '-').substring(0, 60) + (c.eveningData?.tomorrowGoal?.length > 60 ? '...' : '')
        ]);

        doc.autoTable({
            startY: yPos,
            head: [['PIR', 'Date', 'Challenges', 'Tomorrow\'s Goal']],
            body: detailsData,
            theme: 'grid',
            headStyles: { fillColor: [255, 152, 0] },
            styles: { fontSize: 8 },
            columnStyles: {
                0: { cellWidth: 40 },
                1: { cellWidth: 35 },
                2: { cellWidth: 90 },
                3: { cellWidth: 90 }
            }
        });

        doc.save(`Check-ins_Report_${new Date().toISOString().split('T')[0]}.pdf`);
    };

    const handleBulkReview = async () => {
        if (selectedCheckIns.size === 0) {
            alert('No check-ins selected');
            return;
        }

        try {
            const batch = db.batch();
            selectedCheckIns.forEach(checkInId => {
                const reviewRef = db.collection('checkInReviews').doc();
                batch.set(reviewRef, {
                    checkInId: checkInId,
                    reviewedBy: auth.currentUser.uid,
                    reviewedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            });
            
            await batch.commit();
            setReviewedCheckIns(new Set([...reviewedCheckIns, ...selectedCheckIns]));
            setSelectedCheckIns(new Set());
            alert(`${selectedCheckIns.size} check-ins marked as reviewed`);
        } catch (error) {
            console.error('Error bulk reviewing:', error);
            alert('Failed to mark as reviewed');
        }
    };

    const handleToggleSelect = (checkInId) => {
        const newSelected = new Set(selectedCheckIns);
        if (newSelected.has(checkInId)) {
            newSelected.delete(checkInId);
        } else {
            newSelected.add(checkInId);
        }
        setSelectedCheckIns(newSelected);
    };

    const handleSelectAll = () => {
        if (selectedCheckIns.size === paginatedCheckIns.length) {
            setSelectedCheckIns(new Set());
        } else {
            setSelectedCheckIns(new Set(paginatedCheckIns.map(c => c.id)));
        }
    };

    const paginatedCheckIns = useMemo(() => {
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        return filteredCheckIns.slice(start, end);
    }, [filteredCheckIns, currentPage]);

    const totalPages = Math.ceil(filteredCheckIns.length / itemsPerPage);
    const patterns = detectPatterns();

    const getRiskBadgeStyle = (level) => {
        const styles = {
            critical: { background: '#DC143C', color: 'white' },
            high: { background: '#FFA500', color: 'white' },
            moderate: { background: '#FFC107', color: '#333' },
            low: { background: '#00A86B', color: 'white' }
        };
        return styles[level] ?? styles.low;
    };

    const getCompletionBadgeStyle = (status) => {
        const styles = {
            complete: { background: '#00A86B', color: 'white', text: 'Both Complete' },
            'morning-only': { background: '#FFC107', color: '#333', text: 'Morning Only' },
            'evening-only': { background: '#FFA500', color: 'white', text: 'Evening Only' },
            incomplete: { background: '#DC143C', color: 'white', text: 'Incomplete' }
        };
        return styles[status] ?? styles.incomplete;
    };

    const getRowStyle = (checkIn) => {
        if (checkIn.riskLevel === 'critical') {
            return { background: 'rgba(244, 67, 54, 0.1)', borderLeft: '4px solid #f44336' };
        } else if (checkIn.riskLevel === 'high') {
            return { background: 'rgba(255, 152, 0, 0.1)', borderLeft: '4px solid #FF9800' };
        } else if (checkIn.completionStatus !== 'complete') {
            return { background: 'rgba(255, 193, 7, 0.05)', borderLeft: '4px solid #FFC107' };
        }
        return {};
    };

    if (loading) {
        return (
            <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                minHeight: '400px',
                gap: '20px'
            }}>
                <div style={{
                    width: '60px',
                    height: '60px',
                    border: '4px solid #f3f3f3',
                    borderTop: '4px solid #0077CC',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite'
                }}></div>
                <p style={{ color: '#666' }}>Loading check-ins...</p>
            </div>
        );
    }

    // Main view tabs
    if (showAnalytics) {
        return <AnalyticsView 
            analyticsData={analyticsData} 
            checkIns={checkIns}
            users={users}
            onClose={() => setShowAnalytics(false)}
            onSelectPIR={setSelectedPIRForReport}
        />;
    }

    if (selectedPIRForReport) {
        return <IndividualPIRReport
            pirId={selectedPIRForReport}
            checkIns={checkIns.filter(c => c.userId === selectedPIRForReport)}
            analyticsData={analyticsData}
            onClose={() => setSelectedPIRForReport(null)}
        />;
    }

    return (
        <div style={{ padding: '20px', animation: 'fadeIn 0.5s' }}>
            {/* Action Bar */}
            <div style={{ display: 'flex', gap: '10px', marginBottom: '20px' }}>
                <button
                    onClick={() => setShowAnalytics(true)}
                    style={{
                        padding: '12px 24px',
                        background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '10px',
                        cursor: 'pointer',
                        fontSize: '14px',
                        fontWeight: '600'
                    }}
                >
                    View Analytics & Reports
                </button>
            </div>

            {/* Pattern Alerts */}
            {patterns.length > 0 && (
                <div style={{
                    background: '#fff3cd',
                    border: '1px solid #ffc107',
                    borderRadius: '10px',
                    padding: '15px',
                    marginBottom: '20px'
                }}>
                    <div style={{ fontWeight: '600', color: '#856404', marginBottom: '10px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <span style={{ fontSize: '20px' }}>⚠️</span>
                        Pattern Alerts Detected
                    </div>
                    {patterns.slice(0, 3).map((pattern, idx) => (
                        <div key={idx} style={{ fontSize: '14px', color: '#856404', marginBottom: '5px' }}>
                            • {pattern.message}
                        </div>
                    ))}
                    {patterns.length > 3 && (
                        <div style={{ fontSize: '13px', color: '#856404', marginTop: '8px' }}>
                            +{patterns.length - 3} more patterns detected
                        </div>
                    )}
                </div>
            )}

            {/* Tabs */}
            <div style={{
                display: 'flex',
                gap: '10px',
                marginBottom: '20px',
                borderBottom: '2px solid #f0f0f0',
                flexWrap: 'wrap'
            }}>
                {[
                    { id: 'all', label: 'All Check-ins', count: checkIns.length },
                    { id: 'at-risk', label: 'At-Risk', count: checkIns.filter(c => c.riskLevel === 'critical' || c.riskLevel === 'high').length },
                    { id: 'incomplete', label: 'Incomplete', count: checkIns.filter(c => c.completionStatus !== 'complete').length },
                    { id: 'week', label: 'This Week', count: checkIns.filter(c => {
                        const date = c.createdAt?.toDate ? c.createdAt.toDate() : new Date(c.createdAt);
                        const weekAgo = new Date();
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        return date >= weekAgo;
                    }).length },
                    { id: 'needs-review', label: 'Needs Review', count: checkIns.filter(c => !reviewedCheckIns.has(c.id)).length }
                ].map(tab => (
                    <button
                        key={tab.id}
                        onClick={() => setActiveTab(tab.id)}
                        style={{
                            padding: '10px 20px',
                            background: activeTab === tab.id ? 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)' : 'transparent',
                            color: activeTab === tab.id ? 'white' : '#666',
                            border: 'none',
                            borderBottom: activeTab === tab.id ? 'none' : '2px solid transparent',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500',
                            borderRadius: activeTab === tab.id ? '10px 10px 0 0' : '0',
                            transition: 'all 0.2s',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px'
                        }}
                    >
                        {tab.label}
                        {tab.count > 0 && (
                            <span style={{
                                background: activeTab === tab.id ? 'rgba(255,255,255,0.3)' : '#e0e0e0',
                                padding: '2px 8px',
                                borderRadius: '12px',
                                fontSize: '12px',
                                fontWeight: '600'
                            }}>
                                {tab.count}
                            </span>
                        )}
                    </button>
                ))}
            </div>

            {/* Filters Bar */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                marginBottom: '20px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '15px', marginBottom: '15px' }}>
                    <div>
                        <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#666', marginBottom: '5px' }}>
                            Sort By
                        </label>
                        <select 
                            value={sortBy}
                            onChange={(e) => setSortBy(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '8px 12px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '8px',
                                fontSize: '14px',
                                background: 'white'
                            }}
                        >
                            <option value="date">Date (Newest)</option>
                            <option value="user">PIR Name (A-Z)</option>
                            <option value="risk">Risk Level</option>
                            <option value="mood">Mood (Low to High)</option>
                        </select>
                    </div>

                    <div>
                        <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#666', marginBottom: '5px' }}>
                            PIR
                        </label>
                        <select 
                            value={filterUser}
                            onChange={(e) => setFilterUser(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '8px 12px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '8px',
                                fontSize: '14px',
                                background: 'white'
                            }}
                        >
                            <option value="all">All PIRs</option>
                            {users.map(user => (
                                <option key={user.id} value={user.id}>
                                    {user.displayName || user.email}
                                </option>
                            ))}
                        </select>
                    </div>
                    
                    <div>
                        <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#666', marginBottom: '5px' }}>
                            Mood Level
                        </label>
                        <select 
                            value={filterMood}
                            onChange={(e) => setFilterMood(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '8px 12px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '8px',
                                fontSize: '14px',
                                background: 'white'
                            }}
                        >
                            <option value="all">All Moods</option>
                            <option value="1">Low (1-3)</option>
                            <option value="2">Medium (4-6)</option>
                            <option value="3">High (7-10)</option>
                        </select>
                    </div>

                    <div>
                        <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#666', marginBottom: '5px' }}>
                            Craving Level
                        </label>
                        <select 
                            value={filterCraving}
                            onChange={(e) => setFilterCraving(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '8px 12px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '8px',
                                fontSize: '14px',
                                background: 'white'
                            }}
                        >
                            <option value="all">All Levels</option>
                            <option value="1">Low (1-3)</option>
                            <option value="2">Medium (4-6)</option>
                            <option value="3">High (7-10)</option>
                        </select>
                    </div>

                    <div>
                        <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#666', marginBottom: '5px' }}>
                            Anxiety Level
                        </label>
                        <select 
                            value={filterAnxiety}
                            onChange={(e) => setFilterAnxiety(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '8px 12px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '8px',
                                fontSize: '14px',
                                background: 'white'
                            }}
                        >
                            <option value="all">All Levels</option>
                            <option value="1">Low (1-3)</option>
                            <option value="2">Medium (4-6)</option>
                            <option value="3">High (7-10)</option>
                        </select>
                    </div>

                    <div>
                        <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#666', marginBottom: '5px' }}>
                            Sleep Quality
                        </label>
                        <select 
                            value={filterSleep}
                            onChange={(e) => setFilterSleep(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '8px 12px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '8px',
                                fontSize: '14px',
                                background: 'white'
                            }}
                        >
                            <option value="all">All Levels</option>
                            <option value="1">Poor (1-3)</option>
                            <option value="2">Fair (4-6)</option>
                            <option value="3">Good (7-10)</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#666', marginBottom: '5px' }}>
                            Time Period
                        </label>
                        <select 
                            value={filterDate}
                            onChange={(e) => setFilterDate(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '8px 12px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '8px',
                                fontSize: '14px',
                                background: 'white'
                            }}
                        >
                            <option value="all">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">Last 7 Days</option>
                            <option value="month">Last 30 Days</option>
                        </select>
                    </div>

                    <div>
                        <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#666', marginBottom: '5px' }}>
                            Completion
                        </label>
                        <select 
                            value={filterCompletion}
                            onChange={(e) => setFilterCompletion(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '8px 12px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '8px',
                                fontSize: '14px',
                                background: 'white'
                            }}
                        >
                            <option value="all">All Status</option>
                            <option value="complete">Both Complete</option>
                            <option value="morning-only">Morning Only</option>
                            <option value="evening-only">Evening Only</option>
                            <option value="incomplete">Incomplete</option>
                        </select>
                    </div>

                    <div>
                        <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#666', marginBottom: '5px' }}>
                            Risk Level
                        </label>
                        <select 
                            value={filterRisk}
                            onChange={(e) => setFilterRisk(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '8px 12px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '8px',
                                fontSize: '14px',
                                background: 'white'
                            }}
                        >
                            <option value="all">All Levels</option>
                            <option value="critical">Critical</option>
                            <option value="high">High</option>
                            <option value="moderate">Moderate</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                </div>

                <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                    <button 
                        onClick={() => setShowCharts(!showCharts)}
                        style={{
                            padding: '8px 16px',
                            background: showCharts ? '#0077CC' : '#6c757d',
                            color: 'white',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500'
                        }}
                    >
                        {showCharts ? 'Hide Charts' : 'Show Charts'}
                    </button>

                    {selectedCheckIns.size > 0 && (
                        <>
                            <button 
                                onClick={handleBulkReview}
                                style={{
                                    padding: '8px 16px',
                                    background: '#00A86B',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500'
                                }}
                            >
                                Mark {selectedCheckIns.size} as Reviewed
                            </button>
                            <button 
                                onClick={() => handleExport('pdf', true)}
                                style={{
                                    padding: '8px 16px',
                                    background: '#FFA500',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500'
                                }}
                            >
                                Export Selected PDF
                            </button>
                        </>
                    )}

                    <button onClick={() => handleExport('csv')} style={{
                        padding: '8px 16px',
                        background: '#6c757d',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontSize: '14px',
                        fontWeight: '500'
                    }}>
                        Export All CSV
                    </button>
                    <button onClick={() => handleExport('json')} style={{
                        padding: '8px 16px',
                        background: '#6c757d',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontSize: '14px',
                        fontWeight: '500'
                    }}>
                        Export All JSON
                    </button>
                    <button onClick={() => handleExport('pdf')} style={{
                        padding: '8px 16px',
                        background: '#6c757d',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontSize: '14px',
                        fontWeight: '500'
                    }}>
                        Export All PDF
                    </button>
                </div>
            </div>

            {/* Charts Section */}
            {showCharts && (
                <div style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '25px',
                    marginBottom: '20px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                }}>
                    <h3 style={{ margin: '0 0 20px 0', color: '#333' }}>Check-in Analytics</h3>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '20px' }}>
                        <div>
                            <h4 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#666' }}>Mood Trend</h4>
                            <div style={{ height: '250px' }}>
                                <canvas ref={moodChartRef}></canvas>
                            </div>
                        </div>
                        <div>
                            <h4 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#666' }}>Craving Intensity</h4>
                            <div style={{ height: '250px' }}>
                                <canvas ref={cravingChartRef}></canvas>
                            </div>
                        </div>
                        <div>
                            <h4 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#666' }}>Anxiety Levels</h4>
                            <div style={{ height: '250px' }}>
                                <canvas ref={anxietyChartRef}></canvas>
                            </div>
                        </div>
                        <div>
                            <h4 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#666' }}>Sleep Quality</h4>
                            <div style={{ height: '250px' }}>
                                <canvas ref={sleepChartRef}></canvas>
                            </div>
                        </div>
                        <div>
                            <h4 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#666' }}>Completion Status</h4>
                            <div style={{ height: '250px' }}>
                                <canvas ref={completionChartRef}></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Table */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                overflow: 'hidden',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <div style={{ overflowX: 'auto' }}>
                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                        <thead style={{ background: '#f8f9fa' }}>
                            <tr>
                                <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#333', fontSize: '14px' }}>
                                    <input
                                        type="checkbox"
                                        checked={selectedCheckIns.size === paginatedCheckIns.length && paginatedCheckIns.length > 0}
                                        onChange={handleSelectAll}
                                        style={{ cursor: 'pointer' }}
                                    />
                                </th>
                                <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#333', fontSize: '14px' }}>PIR</th>
                                <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#333', fontSize: '14px' }}>Date/Time</th>
                                <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Mood</th>
                                <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Craving</th>
                                <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Anxiety</th>
                                <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Sleep</th>
                                <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Overall</th>
                                <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#333', fontSize: '14px' }}>Status</th>
                                <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#333', fontSize: '14px' }}>Risk</th>
                                <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {paginatedCheckIns.map(checkIn => {
                                const completionBadge = getCompletionBadgeStyle(checkIn.completionStatus);
                                const riskBadge = getRiskBadgeStyle(checkIn.riskLevel);
                                
                                return (
                                    <tr key={checkIn.id} style={getRowStyle(checkIn)}>
                                        <td style={{ padding: '15px' }}>
                                            <input
                                                type="checkbox"
                                                checked={selectedCheckIns.has(checkIn.id)}
                                                onChange={() => handleToggleSelect(checkIn.id)}
                                                style={{ cursor: 'pointer' }}
                                            />
                                        </td>
                                        <td style={{ padding: '15px', fontWeight: '500', color: '#333' }}>
                                            {checkIn.userName}
                                            {reviewedCheckIns.has(checkIn.id) && (
                                                <span style={{ marginLeft: '8px', fontSize: '16px' }} title="Reviewed">✓</span>
                                            )}
                                        </td>
                                        <td style={{ padding: '15px', color: '#666', fontSize: '14px' }}>
                                            {formatDateTime(checkIn.createdAt)}
                                        </td>
                                        <td style={{ padding: '15px', textAlign: 'center' }}>
                                            <div style={{
                                                width: '40px',
                                                height: '40px',
                                                borderRadius: '50%',
                                                background: checkIn.morningData?.mood != null
                                                    ? `linear-gradient(135deg, ${checkIn.morningData.mood <= 3 ? '#f44336' : checkIn.morningData.mood <= 6 ? '#FF9800' : '#00A86B'}, ${checkIn.morningData.mood <= 3 ? '#B01030' : checkIn.morningData.mood <= 6 ? '#F57C00' : '#388E3C'})`
                                                    : '#e0e0e0',
                                                color: 'white',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontWeight: 'bold',
                                                margin: '0 auto'
                                            }}>
                                                {checkIn.morningData?.mood ?? '-'}
                                            </div>
                                        </td>
                                        <td style={{ padding: '15px', textAlign: 'center' }}>
                                            <div style={{
                                                width: '40px',
                                                height: '40px',
                                                borderRadius: '50%',
                                                background: checkIn.morningData?.craving != null
                                                    ? `linear-gradient(135deg, ${checkIn.morningData.craving >= 7 ? '#f44336' : checkIn.morningData.craving >= 4 ? '#FF9800' : '#00A86B'}, ${checkIn.morningData.craving >= 7 ? '#B01030' : checkIn.morningData.craving >= 4 ? '#F57C00' : '#388E3C'})`
                                                    : '#e0e0e0',
                                                color: 'white',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontWeight: 'bold',
                                                margin: '0 auto'
                                            }}>
                                                {checkIn.morningData?.craving ?? '-'}
                                            </div>
                                        </td>
                                       <td style={{ padding: '15px', textAlign: 'center' }}>
    <div style={{
        width: '40px',
        height: '40px',
        borderRadius: '50%',
        background: checkIn.morningData?.anxietyLevel != null
            ? `linear-gradient(135deg, ${checkIn.morningData.anxietyLevel >= 7 ? '#f44336' : checkIn.morningData.anxietyLevel >= 4 ? '#FF9800' : '#00A86B'}, ${checkIn.morningData.anxietyLevel >= 7 ? '#B01030' : checkIn.morningData.anxietyLevel >= 4 ? '#F57C00' : '#388E3C'})`
            : '#e0e0e0',
        color: 'white',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        fontWeight: 'bold',
        margin: '0 auto'
    }}>
        {checkIn.morningData?.anxietyLevel ?? '-'}
    </div>
</td>
                                        <td style={{ padding: '15px', textAlign: 'center' }}>
    <div style={{
        width: '40px',
        height: '40px',
        borderRadius: '50%',
        background: checkIn.morningData?.sleepQuality != null
            ? `linear-gradient(135deg, ${checkIn.morningData.sleepQuality <= 3 ? '#f44336' : checkIn.morningData.sleepQuality <= 6 ? '#FF9800' : '#00A86B'}, ${checkIn.morningData.sleepQuality <= 3 ? '#B01030' : checkIn.morningData.sleepQuality <= 6 ? '#F57C00' : '#388E3C'})`
            : '#e0e0e0',
        color: 'white',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        fontWeight: 'bold',
        margin: '0 auto'
    }}>
        {checkIn.morningData?.sleepQuality ?? '-'}
    </div>
</td>
                                        <td style={{ padding: '15px', textAlign: 'center' }}>
                                            <div style={{
                                                width: '40px',
                                                height: '40px',
                                                borderRadius: '50%',
                                                background: checkIn.eveningData?.overallDay != null
                                                    ? `linear-gradient(135deg, ${checkIn.eveningData.overallDay <= 3 ? '#f44336' : checkIn.eveningData.overallDay <= 6 ? '#FF9800' : '#00A86B'}, ${checkIn.eveningData.overallDay <= 3 ? '#B01030' : checkIn.eveningData.overallDay <= 6 ? '#F57C00' : '#388E3C'})`
                                                    : '#e0e0e0',
                                                color: 'white',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontWeight: 'bold',
                                                margin: '0 auto'
                                            }}>
                                                {checkIn.eveningData?.overallDay ?? '-'}
                                            </div>
                                        </td>
                                        <td style={{ padding: '15px' }}>
                                            <span style={{
                                                padding: '4px 12px',
                                                borderRadius: '20px',
                                                fontSize: '12px',
                                                fontWeight: '600',
                                                ...completionBadge
                                            }}>
                                                {completionBadge.text}
                                            </span>
                                        </td>
                                        <td style={{ padding: '15px' }}>
                                            <span style={{
                                                padding: '4px 12px',
                                                borderRadius: '20px',
                                                fontSize: '12px',
                                                fontWeight: '600',
                                                textTransform: 'capitalize',
                                                ...riskBadge
                                            }}>
                                                {checkIn.riskLevel}
                                            </span>
                                        </td>
                                        <td style={{ padding: '15px', textAlign: 'center' }}>
                                            <button 
                                                onClick={() => setSelectedCheckIn(checkIn)}
                                                style={{
                                                    padding: '6px 16px',
                                                    background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                                    color: 'white',
                                                    border: 'none',
                                                    borderRadius: '6px',
                                                    cursor: 'pointer',
                                                    fontSize: '13px',
                                                    fontWeight: '500'
                                                }}
                                            >
                                                View Details
                                            </button>
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                    
                    {filteredCheckIns.length === 0 && (
                        <div style={{
                            padding: '60px 20px',
                            textAlign: 'center',
                            color: '#999'
                        }}>
                            <div style={{ fontSize: '48px', marginBottom: '15px' }}>📋</div>
                            <div style={{ fontSize: '18px', fontWeight: '500', marginBottom: '8px' }}>
                                No check-ins found
                            </div>
                            <div style={{ fontSize: '14px' }}>
                                {searchQuery ? 'Try adjusting your search or filters' : 'Check-ins will appear here'}
                            </div>
                        </div>
                    )}
                </div>
            </div>
            
            {totalPages > 1 && (
                <Pagination 
                    currentPage={currentPage}
                    totalPages={totalPages}
                    onPageChange={setCurrentPage}
                />
            )}
            
            {selectedCheckIn && (
                <EnhancedCheckInDetailModal 
                    checkIn={selectedCheckIn}
                    checkIns={checkIns.filter(c => c.userId === selectedCheckIn.userId)}
                    coachNote={coachNotes[selectedCheckIn.id]}
                    isReviewed={reviewedCheckIns.has(selectedCheckIn.id)}
                    onClose={() => setSelectedCheckIn(null)}
                    onNoteAdd={async (note) => {
                        await db.collection('coachNotes').add({
                            type: 'checkin',
                            checkInId: selectedCheckIn.id,
                            note: note,
                            createdBy: auth.currentUser.uid,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        loadCoachData();
                    }}
                    onMarkReviewed={async () => {
                        await db.collection('checkInReviews').add({
                            checkInId: selectedCheckIn.id,
                            reviewedBy: auth.currentUser.uid,
                            reviewedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        setReviewedCheckIns(new Set([...reviewedCheckIns, selectedCheckIn.id]));
                    }}
                    onFlagForSession={async () => {
                        await db.collection('sessionFlags').add({
                            type: 'checkin',
                            checkInId: selectedCheckIn.id,
                            userId: selectedCheckIn.userId,
                            flaggedBy: auth.currentUser.uid,
                            flaggedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        alert('Flagged for next session');
                    }}
                />
            )}
        </div>
    );
}
        // ENHANCED CHECK-IN DETAIL MODAL - COMPLETE VIEW WITH ALL FIELDS (FIXED ZEROS)
function EnhancedCheckInDetailModal({ 
    checkIn, 
    checkIns, 
    coachNote, 
    isReviewed, 
    onClose, 
    onNoteAdd, 
    onMarkReviewed, 
    onFlagForSession 
}) {
    const [newNote, setNewNote] = useState('');
    const [showNoteInput, setShowNoteInput] = useState(false);
    const [saving, setSaving] = useState(false);

    const recentCheckIns = checkIns
        .filter(c => c.id !== checkIn.id)
        .sort((a, b) => {
            const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt);
            const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt);
            return dateB - dateA;
        })
        .slice(0, 5);

    const handleSaveNote = async () => {
        if (!newNote.trim()) return;
        
        setSaving(true);
        try {
            await onNoteAdd(newNote);
            setNewNote('');
            setShowNoteInput(false);
        } catch (error) {
            console.error('Error saving note:', error);
            alert('Failed to save note');
        } finally {
            setSaving(false);
        }
    };

    const getMoodColor = (mood) => {
        if (mood == null) return '#e0e0e0';
        if (mood <= 3) return '#f44336';
        if (mood <= 6) return '#FF9800';
        return '#00A86B';
    };

    const getCravingColor = (craving) => {
        if (craving == null) return '#e0e0e0';
        if (craving >= 7) return '#f44336';
        if (craving >= 4) return '#FF9800';
        return '#00A86B';
    };

    const getAnxietyColor = (anxiety) => {
        if (anxiety == null) return '#e0e0e0';
        if (anxiety >= 7) return '#f44336';
        if (anxiety >= 4) return '#FF9800';
        return '#00A86B';
    };

    const getSleepColor = (sleep) => {
        if (sleep == null) return '#e0e0e0';
        if (sleep <= 3) return '#f44336';
        if (sleep <= 6) return '#FF9800';
        return '#00A86B';
    };

    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000,
            padding: '20px',
            animation: 'fadeIn 0.2s'
        }}>
            <div style={{
                background: 'white',
                borderRadius: '20px',
                maxWidth: '1400px',
                width: '100%',
                maxHeight: '90vh',
                overflow: 'auto',
                boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
                animation: 'slideUp 0.3s'
            }}>
                {/* Header */}
                <div style={{
                    background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                    padding: '25px 30px',
                    borderRadius: '20px 20px 0 0',
                    color: 'white',
                    position: 'sticky',
                    top: 0,
                    zIndex: 1
                }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div>
                            <h3 style={{ margin: '0 0 5px 0', fontSize: '24px' }}>
                                {checkIn.userName}'s Check-in
                            </h3>
                            <div style={{ fontSize: '14px', opacity: 0.9 }}>
                                {formatDateTime(checkIn.createdAt)}
                            </div>
                        </div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                            <div style={{
                                padding: '6px 16px',
                                background: 'rgba(255,255,255,0.2)',
                                borderRadius: '20px',
                                fontSize: '13px',
                                fontWeight: '600'
                            }}>
                                Risk: {checkIn.riskLevel.toUpperCase()}
                            </div>
                            {isReviewed && (
                                <div style={{
                                    padding: '6px 16px',
                                    background: 'rgba(76, 175, 80, 0.3)',
                                    borderRadius: '20px',
                                    fontSize: '13px',
                                    fontWeight: '600'
                                }}>
                                    ✓ Reviewed
                                </div>
                            )}
                            <button 
                                onClick={onClose}
                                style={{
                                    background: 'rgba(255,255,255,0.2)',
                                    border: 'none',
                                    color: 'white',
                                    fontSize: '24px',
                                    width: '36px',
                                    height: '36px',
                                    borderRadius: '50%',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center'
                                }}
                            >
                                ×
                            </button>
                        </div>
                    </div>
                </div>

                {/* Main Content */}
                <div style={{ padding: '30px' }}>
                    {/* Split View - Morning & Evening */}
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px', marginBottom: '30px' }}>
                        {/* Morning Check-in */}
                        <div style={{
                            background: '#f8f9fa',
                            borderRadius: '15px',
                            padding: '20px',
                            border: '2px solid #e0e0e0'
                        }}>
                            <h4 style={{ margin: '0 0 20px 0', color: '#0077CC', fontSize: '18px', fontWeight: '600' }}>
                                ☀️ Morning Check-in
                            </h4>
                            
                            <div style={{ display: 'grid', gap: '15px' }}>
                                <div>
                                    <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px' }}>Mood</div>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                                        <div style={{
                                            width: '60px',
                                            height: '60px',
                                            borderRadius: '50%',
                                            background: checkIn.morningData?.mood != null
                                                ? `linear-gradient(135deg, ${getMoodColor(checkIn.morningData.mood)}, ${getMoodColor(checkIn.morningData.mood)}dd)`
                                                : '#e0e0e0',
                                            color: 'white',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            fontSize: '24px',
                                            fontWeight: 'bold'
                                        }}>
                                            {checkIn.morningData?.mood ?? '-'}
                                        </div>
                                        <div style={{ flex: 1 }}>
                                            <div style={{ 
                                                height: '8px', 
                                                background: '#e0e0e0', 
                                                borderRadius: '4px',
                                                overflow: 'hidden'
                                            }}>
                                                <div style={{
                                                    height: '100%',
                                                    width: `${(checkIn.morningData?.mood ?? 0) * 10}%`,
                                                    background: getMoodColor(checkIn.morningData?.mood),
                                                    transition: 'width 0.3s'
                                                }}></div>
                                            </div>
                                            <div style={{ fontSize: '12px', color: '#666', marginTop: '4px' }}>
                                                {checkIn.morningData?.mood == null ? 'Not reported' : 
                                                 checkIn.morningData.mood <= 3 ? 'Low' : 
                                                 checkIn.morningData.mood <= 6 ? 'Moderate' : 'Good'}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px' }}>Cravings</div>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                                        <div style={{
                                            width: '60px',
                                            height: '60px',
                                            borderRadius: '50%',
                                            background: checkIn.morningData?.craving != null
                                                ? `linear-gradient(135deg, ${getCravingColor(checkIn.morningData.craving)}, ${getCravingColor(checkIn.morningData.craving)}dd)`
                                                : '#e0e0e0',
                                            color: 'white',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            fontSize: '24px',
                                            fontWeight: 'bold'
                                        }}>
                                            {checkIn.morningData?.craving ?? '-'}
                                        </div>
                                        <div style={{ flex: 1 }}>
                                            <div style={{ 
                                                height: '8px', 
                                                background: '#e0e0e0', 
                                                borderRadius: '4px',
                                                overflow: 'hidden'
                                            }}>
                                                <div style={{
                                                    height: '100%',
                                                    width: `${(checkIn.morningData?.craving ?? 0) * 10}%`,
                                                    background: getCravingColor(checkIn.morningData?.craving),
                                                    transition: 'width 0.3s'
                                                }}></div>
                                            </div>
                                            <div style={{ fontSize: '12px', color: '#666', marginTop: '4px' }}>
                                                {checkIn.morningData?.craving == null ? 'Not reported' :
                                                 checkIn.morningData.craving >= 7 ? 'High' : 
                                                 checkIn.morningData.craving >= 4 ? 'Moderate' : 'Low'}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {checkIn.morningData?.notes && (
                                    <div>
                                        <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px', fontWeight: '600' }}>Notes</div>
                                        <div style={{
                                            padding: '12px',
                                            background: 'white',
                                            borderRadius: '8px',
                                            color: '#333',
                                            fontSize: '14px',
                                            lineHeight: '1.6'
                                        }}>
                                            {checkIn.morningData.notes}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Evening Reflection */}
                        <div style={{
                            background: '#f8f9fa',
                            borderRadius: '15px',
                            padding: '20px',
                            border: '2px solid #e0e0e0'
                        }}>
                            <h4 style={{ margin: '0 0 20px 0', color: '#008B8B', fontSize: '18px', fontWeight: '600' }}>
                                🌙 Evening Reflection
                            </h4>
                            
                            {checkIn.eveningData ? (
                                <div style={{ display: 'grid', gap: '15px' }}>
                                    <div>
                                        <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px' }}>Overall Day</div>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                                            <div style={{
                                                width: '60px',
                                                height: '60px',
                                                borderRadius: '50%',
                                                background: checkIn.eveningData.overallDay != null
                                                    ? `linear-gradient(135deg, ${getMoodColor(checkIn.eveningData.overallDay)}, ${getMoodColor(checkIn.eveningData.overallDay)}dd)`
                                                    : '#e0e0e0',
                                                color: 'white',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontSize: '24px',
                                                fontWeight: 'bold'
                                            }}>
                                                {checkIn.eveningData.overallDay ?? '-'}
                                            </div>
                                            <div style={{ flex: 1 }}>
                                                <div style={{ 
                                                    height: '8px', 
                                                    background: '#e0e0e0', 
                                                    borderRadius: '4px',
                                                    overflow: 'hidden'
                                                }}>
                                                    <div style={{
                                                        height: '100%',
                                                        width: `${(checkIn.eveningData.overallDay ?? 0) * 10}%`,
                                                        background: getMoodColor(checkIn.eveningData.overallDay),
                                                        transition: 'width 0.3s'
                                                    }}></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                   <div>
    <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px' }}>Anxiety Level</div>
    <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
        <div style={{
            width: '60px',
            height: '60px',
            borderRadius: '50%',
            background: checkIn.morningData?.anxietyLevel != null
                ? `linear-gradient(135deg, ${getAnxietyColor(checkIn.morningData.anxietyLevel)}, ${getAnxietyColor(checkIn.morningData.anxietyLevel)}dd)`
                : '#e0e0e0',
            color: 'white',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            fontSize: '24px',
            fontWeight: 'bold'
        }}>
            {checkIn.morningData?.anxietyLevel ?? '-'}
        </div>
        <div style={{ flex: 1 }}>
            <div style={{ 
                height: '8px', 
                background: '#e0e0e0', 
                borderRadius: '4px',
                overflow: 'hidden'
            }}>
                <div style={{
                    height: '100%',
                    width: `${(checkIn.morningData?.anxietyLevel ?? 0) * 10}%`,
                    background: getAnxietyColor(checkIn.morningData?.anxietyLevel),
                    transition: 'width 0.3s'
                }}></div>
            </div>
            <div style={{ fontSize: '12px', color: '#666', marginTop: '4px' }}>
                {checkIn.morningData?.anxietyLevel == null ? 'Not reported' :
                 checkIn.morningData.anxietyLevel >= 7 ? 'High' : 
                 checkIn.morningData.anxietyLevel >= 4 ? 'Moderate' : 'Low'}
            </div>
        </div>
    </div>
</div>

<div>
    <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px' }}>Sleep Quality (Last Night)</div>
    <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
        <div style={{
            width: '60px',
            height: '60px',
            borderRadius: '50%',
            background: checkIn.morningData?.sleepQuality != null
                ? `linear-gradient(135deg, ${getSleepColor(checkIn.morningData.sleepQuality)}, ${getSleepColor(checkIn.morningData.sleepQuality)}dd)`
                : '#e0e0e0',
            color: 'white',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            fontSize: '24px',
            fontWeight: 'bold'
        }}>
            {checkIn.morningData?.sleepQuality ?? '-'}
        </div>
        <div style={{ flex: 1 }}>
            <div style={{ 
                height: '8px', 
                background: '#e0e0e0', 
                borderRadius: '4px',
                overflow: 'hidden'
            }}>
                <div style={{
                    height: '100%',
                    width: `${(checkIn.morningData?.sleepQuality ?? 0) * 10}%`,
                    background: getSleepColor(checkIn.morningData?.sleepQuality),
                    transition: 'width 0.3s'
                }}></div>
            </div>
            <div style={{ fontSize: '12px', color: '#666', marginTop: '4px' }}>
                {checkIn.morningData?.sleepQuality == null ? 'Not reported' :
                 checkIn.morningData.sleepQuality <= 3 ? 'Poor' : 
                 checkIn.morningData.sleepQuality <= 6 ? 'Fair' : 'Good'}
            </div>
        </div>
    </div>
</div>

                                    {checkIn.eveningData.gratitude && (
                                        <div>
                                            <div style={{ fontSize: '13px', color: '#00A86B', marginBottom: '8px', fontWeight: '600' }}>
                                                💚 Gratitude
                                            </div>
                                            <div style={{
                                                padding: '12px',
                                                background: 'white',
                                                borderRadius: '8px',
                                                color: '#333',
                                                fontSize: '14px',
                                                lineHeight: '1.6'
                                            }}>
                                                {checkIn.eveningData.gratitude}
                                            </div>
                                        </div>
                                    )}

                                    {checkIn.eveningData.challenges && (
                                        <div>
                                            <div style={{ fontSize: '13px', color: '#FFA500', marginBottom: '8px', fontWeight: '600' }}>
                                                ⚠️ Challenges
                                            </div>
                                            <div style={{
                                                padding: '12px',
                                                background: 'white',
                                                borderRadius: '8px',
                                                color: '#333',
                                                fontSize: '14px',
                                                lineHeight: '1.6'
                                            }}>
                                                {checkIn.eveningData.challenges}
                                            </div>
                                        </div>
                                    )}

                                    {checkIn.eveningData.tomorrowGoal && (
                                        <div>
                                            <div style={{ fontSize: '13px', color: '#9C27B0', marginBottom: '8px', fontWeight: '600' }}>
                                                🎯 Tomorrow's Goal
                                            </div>
                                            <div style={{
                                                padding: '12px',
                                                background: 'white',
                                                borderRadius: '8px',
                                                color: '#333',
                                                fontSize: '14px',
                                                lineHeight: '1.6'
                                            }}>
                                                {checkIn.eveningData.tomorrowGoal}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <div style={{
                                    padding: '40px',
                                    textAlign: 'center',
                                    color: '#999'
                                }}>
                                    <div style={{ fontSize: '48px', marginBottom: '10px' }}>🌙</div>
                                    <div>No evening reflection submitted</div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Historical Context */}
                    {recentCheckIns.length > 0 && (
                        <div style={{
                            background: '#f8f9fa',
                            borderRadius: '15px',
                            padding: '20px',
                            marginBottom: '20px'
                        }}>
                            <h4 style={{ margin: '0 0 15px 0', color: '#333', fontSize: '16px', fontWeight: '600' }}>
                                📊 Recent History (Last 5 Check-ins)
                            </h4>
                            <div style={{ display: 'grid', gap: '10px' }}>
                                {recentCheckIns.map(prevCheckIn => (
                                    <div key={prevCheckIn.id} style={{
                                        padding: '12px',
                                        background: 'white',
                                        borderRadius: '8px',
                                        display: 'grid',
                                        gridTemplateColumns: '100px repeat(5, 1fr)',
                                        gap: '12px',
                                        alignItems: 'center',
                                        fontSize: '13px'
                                    }}>
                                        <div style={{ color: '#666', fontSize: '12px' }}>
                                            {formatDate(prevCheckIn.createdAt)}
                                        </div>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                            <span style={{ color: '#666', fontSize: '11px' }}>Mood:</span>
                                            <div style={{
                                                width: '28px',
                                                height: '28px',
                                                borderRadius: '50%',
                                                background: getMoodColor(prevCheckIn.morningData?.mood),
                                                color: 'white',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontWeight: 'bold',
                                                fontSize: '12px'
                                            }}>
                                                {prevCheckIn.morningData?.mood ?? '-'}
                                            </div>
                                        </div>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                            <span style={{ color: '#666', fontSize: '11px' }}>Craving:</span>
                                            <div style={{
                                                width: '28px',
                                                height: '28px',
                                                borderRadius: '50%',
                                                background: getCravingColor(prevCheckIn.morningData?.craving),
                                                color: 'white',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontWeight: 'bold',
                                                fontSize: '12px'
                                            }}>
                                                {prevCheckIn.morningData?.craving ?? '-'}
                                            </div>
                                        </div>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
    <span style={{ color: '#666', fontSize: '11px' }}>Anxiety:</span>
    <div style={{
        width: '28px',
        height: '28px',
        borderRadius: '50%',
        background: getAnxietyColor(prevCheckIn.morningData?.anxietyLevel),
        color: 'white',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        fontWeight: 'bold',
        fontSize: '12px'
    }}>
        {prevCheckIn.morningData?.anxietyLevel ?? '-'}
    </div>
</div>
<div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
    <span style={{ color: '#666', fontSize: '11px' }}>Sleep:</span>
    <div style={{
        width: '28px',
        height: '28px',
        borderRadius: '50%',
        background: getSleepColor(prevCheckIn.morningData?.sleepQuality),
        color: 'white',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        fontWeight: 'bold',
        fontSize: '12px'
    }}>
        {prevCheckIn.morningData?.sleepQuality ?? '-'}
    </div>
</div>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                            <span style={{ color: '#666', fontSize: '11px' }}>Overall:</span>
                                            <div style={{
                                                width: '28px',
                                                height: '28px',
                                                borderRadius: '50%',
                                                background: prevCheckIn.eveningData?.overallDay != null
                                                    ? getMoodColor(prevCheckIn.eveningData.overallDay)
                                                    : '#e0e0e0',
                                                color: 'white',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontWeight: 'bold',
                                                fontSize: '12px'
                                            }}>
                                                {prevCheckIn.eveningData?.overallDay ?? '-'}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                 {/* Coach Notes Section */}
                    <div style={{
                        background: '#fff3cd',
                        borderRadius: '15px',
                        padding: '20px',
                        marginBottom: '20px'
                    }}>
                        <h4 style={{ margin: '0 0 15px 0', color: '#856404', fontSize: '16px', fontWeight: '600' }}>
                            📝 Coach Notes (Private)
                        </h4>
                        
                        {coachNote ? (
                            <div style={{
                                padding: '12px',
                                background: 'white',
                                borderRadius: '8px',
                                color: '#333',
                                fontSize: '14px',
                                lineHeight: '1.6',
                                marginBottom: '10px'
                            }}>
                                {coachNote.note}
                                <div style={{ fontSize: '12px', color: '#666', marginTop: '8px' }}>
                                    Added {formatTimeAgo(coachNote.createdAt)}
                                </div>
                            </div>
                        ) : (
                            <div style={{ color: '#856404', fontSize: '14px', marginBottom: '10px' }}>
                                No coach notes yet
                            </div>
                        )}

                        {showNoteInput ? (
                            <div>
                                <textarea
                                    value={newNote}
                                    onChange={(e) => setNewNote(e.target.value)}
                                    placeholder="Add your private observations..."
                                    style={{
                                        width: '100%',
                                        minHeight: '80px',
                                        padding: '12px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '8px',
                                        fontSize: '14px',
                                        fontFamily: 'inherit',
                                        resize: 'vertical',
                                        marginBottom: '10px'
                                    }}
                                />
                                <div style={{ display: 'flex', gap: '10px' }}>
                                    <button
                                        onClick={handleSaveNote}
                                        disabled={saving}
                                        style={{
                                            padding: '8px 16px',
                                            background: '#00A86B',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            cursor: saving ? 'not-allowed' : 'pointer',
                                            fontSize: '14px',
                                            fontWeight: '500',
                                            opacity: saving ? 0.6 : 1
                                        }}
                                    >
                                        {saving ? 'Saving...' : 'Save Note'}
                                    </button>
                                    <button
                                        onClick={() => {
                                            setShowNoteInput(false);
                                            setNewNote('');
                                        }}
                                        style={{
                                            padding: '8px 16px',
                                            background: '#6c757d',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '14px',
                                            fontWeight: '500'
                                        }}
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <button
                                onClick={() => setShowNoteInput(true)}
                                style={{
                                    padding: '8px 16px',
                                    background: '#0077CC',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '6px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500'
                                }}
                            >
                                {coachNote ? '+ Add Another Note' : '+ Add Coach Note'}
                            </button>
                        )}
                    </div>

                    {/* Action Buttons */}
                    <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                        {!isReviewed && (
                            <button
                                onClick={onMarkReviewed}
                                style={{
                                    padding: '12px 24px',
                                    background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '10px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '600',
                                    transition: 'transform 0.2s'
                                }}
                                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                            >
                                ✓ Mark as Reviewed
                            </button>
                        )}
                        
                        <button
                            onClick={onFlagForSession}
                            style={{
                                padding: '12px 24px',
                                background: 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '10px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '600',
                                transition: 'transform 0.2s'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                            onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                        >
                            🚩 Flag for Session
                        </button>

                        <button
                            onClick={onClose}
                            style={{
                                padding: '12px 24px',
                                background: '#6c757d',
                                color: 'white',
                                border: 'none',
                                borderRadius: '10px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '600',
                                transition: 'transform 0.2s',
                                marginLeft: 'auto'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                            onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                        >
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
}
        // ANALYTICS VIEW - COMPREHENSIVE STATS FOR ALL PIRS
function AnalyticsView({ analyticsData, checkIns, users, onClose, onSelectPIR }) {
    const [selectedTab, setSelectedTab] = useState('aggregate');
    const [sortBy, setSortBy] = useState('name');

    if (!analyticsData) return null;

    const { pirStats, allPIRsData } = analyticsData;

    const sortedPIRs = Object.values(pirStats).sort((a, b) => {
        if (sortBy === 'name') return a.userName.localeCompare(b.userName);
        if (sortBy === 'avgMood') return parseFloat(b.avgMood) - parseFloat(a.avgMood);
        if (sortBy === 'avgCraving') return parseFloat(a.avgCraving) - parseFloat(b.avgCraving);
        if (sortBy === 'completion') return b.completionRate - a.completionRate;
        return 0;
    });

    const exportAggregateAnalytics = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('landscape');
        
        let yPos = 20;
        
        // Title
        doc.setFontSize(20);
        doc.text('Check-ins Analytics Report - All PIRs', 14, yPos);
        yPos += 15;
        
        doc.setFontSize(10);
        doc.text(`Generated: ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}`, 14, yPos);
        yPos += 15;

        // Aggregate Stats
        doc.setFontSize(16);
        doc.text('Overall Program Statistics', 14, yPos);
        yPos += 10;

        const aggregateStats = [
            ['Metric', 'Lifetime Average', 'Last 30 Days'],
            ['Average Mood', allPIRsData.avgMood, allPIRsData.last30Days.avgMood],
            ['Average Cravings', allPIRsData.avgCraving, allPIRsData.last30Days.avgCraving],
            ['Average Anxiety', allPIRsData.avgAnxiety, allPIRsData.last30Days.avgAnxiety],
            ['Average Sleep Quality', allPIRsData.avgSleep, allPIRsData.last30Days.avgSleep],
            ['Completion Rate', `${allPIRsData.completionRate}%`, `${allPIRsData.last30Days.completionRate}%`],
            ['Total Check-ins', allPIRsData.totalCheckIns, '-']
        ];

        doc.autoTable({
            startY: yPos,
            head: [aggregateStats[0]],
            body: aggregateStats.slice(1),
            theme: 'grid',
            headStyles: { fillColor: [102, 126, 234] },
            styles: { fontSize: 10 }
        });

        // Individual PIR Stats
        doc.addPage();
        yPos = 20;
        
        doc.setFontSize(16);
        doc.text('Individual PIR Statistics - Lifetime', 14, yPos);
        yPos += 10;

        const pirLifetimeData = sortedPIRs.map(pir => [
            pir.userName,
            pir.totalCheckIns,
            pir.avgMood,
            pir.avgCraving,
            pir.avgAnxiety,
            pir.avgSleep,
            `${pir.completionRate}%`
        ]);

        doc.autoTable({
            startY: yPos,
            head: [['PIR', 'Check-ins', 'Avg Mood', 'Avg Craving', 'Avg Anxiety', 'Avg Sleep', 'Completion']],
            body: pirLifetimeData,
            theme: 'grid',
            headStyles: { fillColor: [102, 126, 234] },
            styles: { fontSize: 9 },
            columnStyles: {
                0: { cellWidth: 60 },
                1: { cellWidth: 30 },
                2: { cellWidth: 30 },
                3: { cellWidth: 35 },
                4: { cellWidth: 30 },
                5: { cellWidth: 30 },
                6: { cellWidth: 35 }
            }
        });

        // 30-Day Stats
        doc.addPage();
        yPos = 20;
        
        doc.setFontSize(16);
        doc.text('Individual PIR Statistics - Last 30 Days', 14, yPos);
        yPos += 10;

        const pir30DayData = sortedPIRs.map(pir => [
            pir.userName,
            pir.last30.totalCheckIns,
            pir.last30.avgMood,
            pir.last30.avgCraving,
            pir.last30.avgAnxiety,
            pir.last30.avgSleep,
            `${pir.last30.completionRate}%`
        ]);

        doc.autoTable({
            startY: yPos,
            head: [['PIR', 'Check-ins', 'Avg Mood', 'Avg Craving', 'Avg Anxiety', 'Avg Sleep', 'Completion']],
            body: pir30DayData,
            theme: 'grid',
            headStyles: { fillColor: [118, 75, 162] },
            styles: { fontSize: 9 },
            columnStyles: {
                0: { cellWidth: 60 },
                1: { cellWidth: 30 },
                2: { cellWidth: 30 },
                3: { cellWidth: 35 },
                4: { cellWidth: 30 },
                5: { cellWidth: 30 },
                6: { cellWidth: 35 }
            }
        });

        doc.save(`Analytics_Report_${new Date().toISOString().split('T')[0]}.pdf`);
    };

    return (
        <div style={{ padding: '20px', animation: 'fadeIn 0.5s' }}>
            {/* Header */}
            <div style={{ 
                display: 'flex', 
                justifyContent: 'space-between', 
                alignItems: 'center',
                marginBottom: '30px'
            }}>
                <div>
                    <h2 style={{ margin: '0 0 10px 0', fontSize: '28px', color: '#333' }}>
                        Analytics & Reports
                    </h2>
                    <p style={{ margin: 0, color: '#666', fontSize: '14px' }}>
                        Comprehensive check-in statistics and trends
                    </p>
                </div>
                <div style={{ display: 'flex', gap: '10px' }}>
                    <button
                        onClick={exportAggregateAnalytics}
                        style={{
                            padding: '12px 24px',
                            background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                            color: 'white',
                            border: 'none',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '600'
                        }}
                    >
                        Export Analytics PDF
                    </button>
                    <button
                        onClick={onClose}
                        style={{
                            padding: '12px 24px',
                            background: '#6c757d',
                            color: 'white',
                            border: 'none',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '600'
                        }}
                    >
                        Back to Check-ins
                    </button>
                </div>
            </div>

            {/* Tabs */}
            <div style={{
                display: 'flex',
                gap: '10px',
                marginBottom: '30px',
                borderBottom: '2px solid #f0f0f0'
            }}>
                {[
                    { id: 'aggregate', label: 'All PIRs Aggregate' },
                    { id: 'individual', label: 'Individual PIR Stats' }
                ].map(tab => (
                    <button
                        key={tab.id}
                        onClick={() => setSelectedTab(tab.id)}
                        style={{
                            padding: '12px 24px',
                            background: selectedTab === tab.id ? 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)' : 'transparent',
                            color: selectedTab === tab.id ? 'white' : '#666',
                            border: 'none',
                            borderBottom: selectedTab === tab.id ? 'none' : '2px solid transparent',
                            cursor: 'pointer',
                            fontSize: '15px',
                            fontWeight: '600',
                            borderRadius: selectedTab === tab.id ? '10px 10px 0 0' : '0',
                            transition: 'all 0.2s'
                        }}
                    >
                        {tab.label}
                    </button>
                ))}
            </div>

            {/* Aggregate View */}
            {selectedTab === 'aggregate' && (
                <div>
                    <div style={{
                        background: 'white',
                        borderRadius: '15px',
                        padding: '30px',
                        marginBottom: '30px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                    }}>
                        <h3 style={{ margin: '0 0 20px 0', fontSize: '20px', color: '#333' }}>
                            Overall Program Statistics
                        </h3>
                        
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '20px' }}>
                            <div style={{
                                background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                padding: '20px',
                                borderRadius: '12px',
                                color: 'white'
                            }}>
                                <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '8px' }}>Total Check-ins</div>
                                <div style={{ fontSize: '32px', fontWeight: 'bold' }}>{allPIRsData.totalCheckIns}</div>
                            </div>

                            <div style={{
                                background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                                padding: '20px',
                                borderRadius: '12px',
                                color: 'white'
                            }}>
                                <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '8px' }}>Completion Rate</div>
                                <div style={{ fontSize: '32px', fontWeight: 'bold' }}>{allPIRsData.completionRate}%</div>
                                <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '4px' }}>
                                    30-day: {allPIRsData.last30Days.completionRate}%
                                </div>
                            </div>

                            <div style={{
                                background: 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)',
                                padding: '20px',
                                borderRadius: '12px',
                                color: 'white'
                            }}>
                                <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '8px' }}>Average Mood</div>
                                <div style={{ fontSize: '32px', fontWeight: 'bold' }}>{allPIRsData.avgMood}/10</div>
                                <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '4px' }}>
                                    30-day: {allPIRsData.last30Days.avgMood}/10
                                </div>
                            </div>

                            <div style={{
                                background: 'linear-gradient(135deg, #f44336 0%, #B01030 100%)',
                                padding: '20px',
                                borderRadius: '12px',
                                color: 'white'
                            }}>
                                <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '8px' }}>Average Cravings</div>
                                <div style={{ fontSize: '32px', fontWeight: 'bold' }}>{allPIRsData.avgCraving}/10</div>
                                <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '4px' }}>
                                    30-day: {allPIRsData.last30Days.avgCraving}/10
                                </div>
                            </div>

                            <div style={{
                                background: 'linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%)',
                                padding: '20px',
                                borderRadius: '12px',
                                color: 'white'
                            }}>
                                <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '8px' }}>Average Anxiety</div>
                                <div style={{ fontSize: '32px', fontWeight: 'bold' }}>{allPIRsData.avgAnxiety}/10</div>
                                <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '4px' }}>
                                    30-day: {allPIRsData.last30Days.avgAnxiety}/10
                                </div>
                            </div>

                            <div style={{
                                background: 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)',
                                padding: '20px',
                                borderRadius: '12px',
                                color: 'white'
                            }}>
                                <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '8px' }}>Average Sleep Quality</div>
                                <div style={{ fontSize: '32px', fontWeight: 'bold' }}>{allPIRsData.avgSleep}/10</div>
                                <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '4px' }}>
                                    30-day: {allPIRsData.last30Days.avgSleep}/10
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Trend Comparison */}
                    <div style={{
                        background: 'white',
                        borderRadius: '15px',
                        padding: '30px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                    }}>
                        <h3 style={{ margin: '0 0 20px 0', fontSize: '20px', color: '#333' }}>
                            30-Day Trend vs Lifetime Average
                        </h3>
                        
                        <div style={{ display: 'grid', gap: '20px' }}>
                            {[
                                { label: 'Mood', lifetime: allPIRsData.avgMood, recent: allPIRsData.last30Days.avgMood, color: '#0077CC' },
                                { label: 'Cravings', lifetime: allPIRsData.avgCraving, recent: allPIRsData.last30Days.avgCraving, color: '#DC143C', inverse: true },
                                { label: 'Anxiety', lifetime: allPIRsData.avgAnxiety, recent: allPIRsData.last30Days.avgAnxiety, color: '#FFA500', inverse: true },
                                { label: 'Sleep Quality', lifetime: allPIRsData.avgSleep, recent: allPIRsData.last30Days.avgSleep, color: '#4682B4' },
                                { label: 'Completion Rate', lifetime: `${allPIRsData.completionRate}`, recent: `${allPIRsData.last30Days.completionRate}`, color: '#00A86B', isPercent: true }
                            ].map(metric => {
                                const lifetimeVal = parseFloat(metric.lifetime);
                                const recentVal = parseFloat(metric.recent);
                                const diff = recentVal - lifetimeVal;
                                const isImproving = metric.inverse ? diff < 0 : diff > 0;
                                
                                return (
                                    <div key={metric.label} style={{
                                        padding: '20px',
                                        background: '#f8f9fa',
                                        borderRadius: '10px'
                                    }}>
                                        <div style={{ 
                                            display: 'flex', 
                                            justifyContent: 'space-between', 
                                            alignItems: 'center',
                                            marginBottom: '15px'
                                        }}>
                                            <div style={{ fontSize: '16px', fontWeight: '600', color: '#333' }}>
                                                {metric.label}
                                            </div>
                                            <div style={{
                                                padding: '4px 12px',
                                                background: isImproving ? '#d4edda' : '#f8d7da',
                                                color: isImproving ? '#155724' : '#721c24',
                                                borderRadius: '20px',
                                                fontSize: '13px',
                                                fontWeight: '600'
                                            }}>
                                                {diff > 0 ? '+' : ''}{diff.toFixed(1)}{metric.isPercent ? '%' : ''} {isImproving ? '↑' : '↓'}
                                            </div>
                                        </div>
                                        <div style={{ display: 'flex', gap: '20px', alignItems: 'center' }}>
                                            <div style={{ flex: 1 }}>
                                                <div style={{ fontSize: '12px', color: '#666', marginBottom: '5px' }}>
                                                    Lifetime: {metric.lifetime}{metric.isPercent ? '%' : '/10'}
                                                </div>
                                                <div style={{
                                                    height: '10px',
                                                    background: '#e0e0e0',
                                                    borderRadius: '5px',
                                                    overflow: 'hidden'
                                                }}>
                                                    <div style={{
                                                        height: '100%',
                                                        width: `${metric.isPercent ? lifetimeVal : lifetimeVal * 10}%`,
                                                        background: metric.color,
                                                        opacity: 0.6
                                                    }}></div>
                                                </div>
                                            </div>
                                            <div style={{ flex: 1 }}>
                                                <div style={{ fontSize: '12px', color: '#666', marginBottom: '5px' }}>
                                                    Last 30 Days: {metric.recent}{metric.isPercent ? '%' : '/10'}
                                                </div>
                                                <div style={{
                                                    height: '10px',
                                                    background: '#e0e0e0',
                                                    borderRadius: '5px',
                                                    overflow: 'hidden'
                                                }}>
                                                    <div style={{
                                                        height: '100%',
                                                        width: `${metric.isPercent ? recentVal : recentVal * 10}%`,
                                                        background: metric.color
                                                    }}></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            )}

            {/* Individual PIR Stats View */}
            {selectedTab === 'individual' && (
                <div style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '30px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                }}>
                    <div style={{ 
                        display: 'flex', 
                        justifyContent: 'space-between', 
                        alignItems: 'center',
                        marginBottom: '20px'
                    }}>
                        <h3 style={{ margin: 0, fontSize: '20px', color: '#333' }}>
                            Individual PIR Statistics
                        </h3>
                        <div>
                            <label style={{ marginRight: '10px', color: '#666', fontSize: '14px' }}>Sort by:</label>
                            <select
                                value={sortBy}
                                onChange={(e) => setSortBy(e.target.value)}
                                style={{
                                    padding: '8px 12px',
                                    border: '2px solid #e0e0e0',
                                    borderRadius: '8px',
                                    fontSize: '14px',
                                    background: 'white'
                                }}
                            >
                                <option value="name">PIR Name</option>
                                <option value="avgMood">Avg Mood</option>
                                <option value="avgCraving">Avg Cravings</option>
                                <option value="completion">Completion Rate</option>
                            </select>
                        </div>
                    </div>

                    <div style={{ overflowX: 'auto' }}>
                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead style={{ background: '#f8f9fa' }}>
                                <tr>
                                    <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#333', fontSize: '14px' }}>PIR</th>
                                    <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Check-ins<br/>(Total / 30d)</th>
                                    <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Avg Mood<br/>(Life / 30d)</th>
                                    <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Avg Craving<br/>(Life / 30d)</th>
                                    <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Avg Anxiety<br/>(Life / 30d)</th>
                                    <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Avg Sleep<br/>(Life / 30d)</th>
                                    <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Completion<br/>(Life / 30d)</th>
                                    <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {sortedPIRs.map(pir => (
                                    <tr key={pir.userId} style={{ borderBottom: '1px solid #f0f0f0' }}>
                                        <td style={{ padding: '15px', fontWeight: '500', color: '#333' }}>
                                            {pir.userName}
                                        </td>
                                        <td style={{ padding: '15px', textAlign: 'center', color: '#666' }}>
                                            {pir.totalCheckIns} / {pir.last30.totalCheckIns}
                                        </td>
                                        <td style={{ padding: '15px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '15px', fontWeight: '600', color: '#0077CC' }}>
                                                {pir.avgMood}
                                            </div>
                                            <div style={{ fontSize: '12px', color: '#999', marginTop: '2px' }}>
                                                {pir.last30.avgMood}
                                            </div>
                                        </td>
                                        <td style={{ padding: '15px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '15px', fontWeight: '600', color: '#DC143C' }}>
                                                {pir.avgCraving}
                                            </div>
                                            <div style={{ fontSize: '12px', color: '#999', marginTop: '2px' }}>
                                                {pir.last30.avgCraving}
                                            </div>
                                        </td>
                                        <td style={{ padding: '15px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '15px', fontWeight: '600', color: '#FFA500' }}>
                                                {pir.avgAnxiety}
                                            </div>
                                            <div style={{ fontSize: '12px', color: '#999', marginTop: '2px' }}>
                                                {pir.last30.avgAnxiety}
                                            </div>
                                        </td>
                                        <td style={{ padding: '15px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '15px', fontWeight: '600', color: '#4682B4' }}>
                                                {pir.avgSleep}
                                            </div>
                                            <div style={{ fontSize: '12px', color: '#999', marginTop: '2px' }}>
                                                {pir.last30.avgSleep}
                                            </div>
                                        </td>
                                        <td style={{ padding: '15px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '15px', fontWeight: '600', color: '#00A86B' }}>
                                                {pir.completionRate}%
                                            </div>
                                            <div style={{ fontSize: '12px', color: '#999', marginTop: '2px' }}>
                                                {pir.last30.completionRate}%
                                            </div>
                                        </td>
                                        <td style={{ padding: '15px', textAlign: 'center' }}>
                                            <button
                                                onClick={() => onSelectPIR(pir.userId)}
                                                style={{
                                                    padding: '6px 16px',
                                                    background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                                    color: 'white',
                                                    border: 'none',
                                                    borderRadius: '6px',
                                                    cursor: 'pointer',
                                                    fontSize: '13px',
                                                    fontWeight: '500'
                                                }}
                                            >
                                                View Report
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}
        </div>
    );
}
        // INDIVIDUAL PIR REPORT - DETAILED ANALYSIS
function IndividualPIRReport({ pirId, checkIns, analyticsData, onClose }) {
    const pirStats = analyticsData?.pirStats[pirId];
    const pirCheckIns = checkIns.filter(c => c.userId === pirId).sort((a, b) => {
        const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt);
        const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt);
        return dateB - dateA;
    });

    const moodChartRef = useRef(null);
    const cravingChartRef = useRef(null);
    const anxietyChartRef = useRef(null);
    const sleepChartRef = useRef(null);
    const chartInstances = useRef({});

    useEffect(() => {
        renderIndividualCharts();
        
        return () => {
            Object.values(chartInstances.current).forEach(chart => {
                if (chart) chart.destroy();
            });
        };
    }, [pirCheckIns]);

    const renderIndividualCharts = () => {
        const last30 = pirCheckIns.slice(0, 30).reverse();

        if (moodChartRef.current) {
            if (chartInstances.current.mood) chartInstances.current.mood.destroy();
            
            const ctx = moodChartRef.current.getContext('2d');
            chartInstances.current.mood = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last30.map(c => formatDate(c.createdAt)),
                    datasets: [{
                        label: 'Morning Mood',
                        data: last30.map(c => c.morningData?.mood ?? null),
                        borderColor: '#0077CC',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 10 }
                    }
                }
            });
        }

        if (cravingChartRef.current) {
            if (chartInstances.current.craving) chartInstances.current.craving.destroy();
            
            const ctx = cravingChartRef.current.getContext('2d');
            chartInstances.current.craving = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last30.map(c => formatDate(c.createdAt)),
                    datasets: [{
                        label: 'Cravings',
                        data: last30.map(c => c.morningData?.craving ?? null),
                        borderColor: '#f44336',
                        backgroundColor: 'rgba(244, 67, 54, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 10 }
                    }
                }
            });
        }

        if (anxietyChartRef.current) {
            if (chartInstances.current.anxiety) chartInstances.current.anxiety.destroy();
            
            const ctx = anxietyChartRef.current.getContext('2d');
            chartInstances.current.anxiety = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last30.map(c => formatDate(c.createdAt)),
                    datasets: [{
    label: 'Anxiety',
    data: last30.map(c => c.morningData?.anxietyLevel ?? null),
    borderColor: '#FF9800',
    backgroundColor: 'rgba(255, 152, 0, 0.1)',
    tension: 0.4,
    fill: true
}]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 10 }
                    }
                }
            });
        }

        if (sleepChartRef.current) {
            if (chartInstances.current.sleep) chartInstances.current.sleep.destroy();
            
            const ctx = sleepChartRef.current.getContext('2d');
            chartInstances.current.sleep = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last30.map(c => formatDate(c.createdAt)),
                    datasets: [{
    label: 'Sleep Quality',
    data: last30.map(c => c.morningData?.sleepQuality ?? null),
    borderColor: '#9C27B0',
    backgroundColor: 'rgba(156, 39, 176, 0.1)',
    tension: 0.4,
    fill: true
}]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 10 }
                    }
                }
            });
        }
    };

    const exportIndividualReport = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        let yPos = 20;
        
        // Title
        doc.setFontSize(20);
        doc.text(`Check-in Report: ${pirStats.userName}`, 14, yPos);
        yPos += 15;
        
        doc.setFontSize(10);
        doc.text(`Generated: ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}`, 14, yPos);
        yPos += 15;

        // Summary Stats
        doc.setFontSize(14);
        doc.text('Summary Statistics', 14, yPos);
        yPos += 5;

        const summaryData = [
            ['Metric', 'Lifetime', 'Last 30 Days'],
            ['Total Check-ins', pirStats.totalCheckIns, pirStats.last30.totalCheckIns],
            ['Average Mood', pirStats.avgMood, pirStats.last30.avgMood],
            ['Average Cravings', pirStats.avgCraving, pirStats.last30.avgCraving],
            ['Average Anxiety', pirStats.avgAnxiety, pirStats.last30.avgAnxiety],
            ['Average Sleep Quality', pirStats.avgSleep, pirStats.last30.avgSleep],
            ['Completion Rate', `${pirStats.completionRate}%`, `${pirStats.last30.completionRate}%`]
        ];

        doc.autoTable({
            startY: yPos,
            head: [summaryData[0]],
            body: summaryData.slice(1),
            theme: 'grid',
            headStyles: { fillColor: [102, 126, 234] }
        });

        // Recent Check-ins
        doc.addPage();
        yPos = 20;
        
        doc.setFontSize(14);
        doc.text('Recent Check-ins (Last 10)', 14, yPos);
        yPos += 5;

        const recentData = pirCheckIns.slice(0, 10).map(c => [
            formatDate(c.createdAt),
            c.morningData?.mood ?? '-',
            c.morningData?.craving ?? '-',
           c.morningData?.anxietyLevel ?? '-',
c.morningData?.sleepQuality ?? '-',
            c.eveningData?.overallDay ?? '-',
            c.completionStatus === 'complete' ? 'Yes' : 'No'
        ]);

        doc.autoTable({
            startY: yPos,
            head: [['Date', 'Mood', 'Craving', 'Anxiety', 'Sleep', 'Overall', 'Complete']],
            body: recentData,
            theme: 'grid',
            headStyles: { fillColor: [102, 126, 234] },
            styles: { fontSize: 9 }
        });

        // Gratitude & Challenges
        doc.addPage();
        yPos = 20;
        
        doc.setFontSize(14);
        doc.text('Recent Gratitude & Challenges', 14, yPos);
        yPos += 10;

        pirCheckIns.slice(0, 5).forEach((c, idx) => {
            if (yPos > 250) {
                doc.addPage();
                yPos = 20;
            }
            
            doc.setFontSize(12);
            doc.text(`${formatDate(c.createdAt)}`, 14, yPos);
            yPos += 7;
            
            doc.setFontSize(10);
            if (c.eveningData?.gratitude) {
                doc.text('Gratitude:', 14, yPos);
                yPos += 5;
                const gratitudeLines = doc.splitTextToSize(c.eveningData.gratitude, 180);
                doc.text(gratitudeLines, 20, yPos);
                yPos += gratitudeLines.length * 5 + 3;
            }
            
            if (c.eveningData?.challenges) {
                doc.text('Challenges:', 14, yPos);
                yPos += 5;
                const challengeLines = doc.splitTextToSize(c.eveningData.challenges, 180);
                doc.text(challengeLines, 20, yPos);
                yPos += challengeLines.length * 5 + 3;
            }
            
            yPos += 5;
        });

        doc.save(`${pirStats.userName.replace(/\s+/g, '_')}_Report_${new Date().toISOString().split('T')[0]}.pdf`);
    };

    if (!pirStats) return null;

    return (
        <div style={{ padding: '20px', animation: 'fadeIn 0.5s' }}>
            {/* Header */}
            <div style={{ 
                display: 'flex', 
                justifyContent: 'space-between', 
                alignItems: 'center',
                marginBottom: '30px'
            }}>
                <div>
                    <h2 style={{ margin: '0 0 10px 0', fontSize: '28px', color: '#333' }}>
                        {pirStats.userName} - Detailed Report
                    </h2>
                    <p style={{ margin: 0, color: '#666', fontSize: '14px' }}>
                        Comprehensive check-in analysis and trends
                    </p>
                </div>
                <div style={{ display: 'flex', gap: '10px' }}>
                    <button
                        onClick={exportIndividualReport}
                        style={{
                            padding: '12px 24px',
                            background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                            color: 'white',
                            border: 'none',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '600'
                        }}
                    >
                        Export PDF Report
                    </button>
                    <button
                        onClick={onClose}
                        style={{
                            padding: '12px 24px',
                            background: '#6c757d',
                            color: 'white',
                            border: 'none',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '600'
                        }}
                    >
                        Back to Analytics
                    </button>
                </div>
            </div>

            {/* Summary Cards */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '20px', marginBottom: '30px' }}>
                <div style={{
                    background: 'white',
                    padding: '20px',
                    borderRadius: '12px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                    borderLeft: '4px solid #0077CC'
                }}>
                    <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px' }}>Total Check-ins</div>
                    <div style={{ fontSize: '28px', fontWeight: 'bold', color: '#333' }}>{pirStats.totalCheckIns}</div>
                    <div style={{ fontSize: '12px', color: '#999', marginTop: '4px' }}>
                        Last 30 days: {pirStats.last30.totalCheckIns}
                    </div>
                </div>

                <div style={{
                    background: 'white',
                    padding: '20px',
                    borderRadius: '12px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                    borderLeft: '4px solid #00A86B'
                }}>
                    <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px' }}>Completion Rate</div>
                    <div style={{ fontSize: '28px', fontWeight: 'bold', color: '#00A86B' }}>{pirStats.completionRate}%</div>
                    <div style={{ fontSize: '12px', color: '#999', marginTop: '4px' }}>
                        Last 30 days: {pirStats.last30.completionRate}%
                    </div>
                </div>

                <div style={{
                    background: 'white',
                    padding: '20px',
                    borderRadius: '12px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                    borderLeft: '4px solid #0077CC'
                }}>
                    <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px' }}>Avg Mood</div>
                    <div style={{ fontSize: '28px', fontWeight: 'bold', color: '#0077CC' }}>{pirStats.avgMood}/10</div>
                    <div style={{ fontSize: '12px', color: '#999', marginTop: '4px' }}>
                        Last 30 days: {pirStats.last30.avgMood}/10
                    </div>
                </div>

                <div style={{
                    background: 'white',
                    padding: '20px',
                    borderRadius: '12px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                    borderLeft: '4px solid #f44336'
                }}>
                    <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px' }}>Avg Cravings</div>
                    <div style={{ fontSize: '28px', fontWeight: 'bold', color: '#DC143C' }}>{pirStats.avgCraving}/10</div>
                    <div style={{ fontSize: '12px', color: '#999', marginTop: '4px' }}>
                        Last 30 days: {pirStats.last30.avgCraving}/10
                    </div>
                </div>

                <div style={{
                    background: 'white',
                    padding: '20px',
                    borderRadius: '12px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                    borderLeft: '4px solid #FF9800'
                }}>
                    <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px' }}>Avg Anxiety</div>
                    <div style={{ fontSize: '28px', fontWeight: 'bold', color: '#FFA500' }}>{pirStats.avgAnxiety}/10</div>
                    <div style={{ fontSize: '12px', color: '#999', marginTop: '4px' }}>
                        Last 30 days: {pirStats.last30.avgAnxiety}/10
                    </div>
                </div>

                <div style={{
                    background: 'white',
                    padding: '20px',
                    borderRadius: '12px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                    borderLeft: '4px solid #9C27B0'
                }}>
                    <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px' }}>Avg Sleep</div>
                    <div style={{ fontSize: '28px', fontWeight: 'bold', color: '#9C27B0' }}>{pirStats.avgSleep}/10</div>
                    <div style={{ fontSize: '12px', color: '#999', marginTop: '4px' }}>
                        Last 30 days: {pirStats.last30.avgSleep}/10
                    </div>
                </div>
            </div>

            {/* Charts */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '30px',
                marginBottom: '30px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <h3 style={{ margin: '0 0 25px 0', fontSize: '20px', color: '#333' }}>
                    Trend Analysis (Last 30 Check-ins)
                </h3>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(350px, 1fr))', gap: '30px' }}>
                    <div>
                        <h4 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#666' }}>Mood Trend</h4>
                        <div style={{ height: '250px' }}>
                            <canvas ref={moodChartRef}></canvas>
                        </div>
                    </div>
                    <div>
                        <h4 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#666' }}>Craving Intensity</h4>
                        <div style={{ height: '250px' }}>
                            <canvas ref={cravingChartRef}></canvas>
                        </div>
                    </div>
                    <div>
                        <h4 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#666' }}>Anxiety Levels</h4>
                        <div style={{ height: '250px' }}>
                            <canvas ref={anxietyChartRef}></canvas>
                        </div>
                    </div>
                    <div>
                        <h4 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#666' }}>Sleep Quality</h4>
                        <div style={{ height: '250px' }}>
                            <canvas ref={sleepChartRef}></canvas>
                        </div>
                    </div>
                </div>
            </div>

            {/* Recent Check-ins Table */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '30px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <h3 style={{ margin: '0 0 20px 0', fontSize: '20px', color: '#333' }}>
                    Recent Check-ins (Last 10)
                </h3>
                <div style={{ overflowX: 'auto' }}>
                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                        <thead style={{ background: '#f8f9fa' }}>
                            <tr>
                                <th style={{ padding: '12px', textAlign: 'left', fontWeight: '600', color: '#333', fontSize: '13px' }}>Date</th>
                                <th style={{ padding: '12px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '13px' }}>Mood</th>
                                <th style={{ padding: '12px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '13px' }}>Craving</th>
                                <th style={{ padding: '12px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '13px' }}>Anxiety</th>
                                <th style={{ padding: '12px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '13px' }}>Sleep</th>
                                <th style={{ padding: '12px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '13px' }}>Overall</th>
                                <th style={{ padding: '12px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '13px' }}>Complete</th>
                            </tr>
                        </thead>
                        <tbody>
                            {pirCheckIns.slice(0, 10).map(checkIn => (
                                <tr key={checkIn.id} style={{ borderBottom: '1px solid #f0f0f0' }}>
                                    <td style={{ padding: '12px', fontSize: '13px', color: '#666' }}>
                                        {formatDate(checkIn.createdAt)}
                                    </td>
                                    <td style={{ padding: '12px', textAlign: 'center', fontSize: '14px', fontWeight: '600', color: '#0077CC' }}>
                                        {checkIn.morningData?.mood ?? '-'}
                                    </td>
                                    <td style={{ padding: '12px', textAlign: 'center', fontSize: '14px', fontWeight: '600', color: '#DC143C' }}>
                                        {checkIn.morningData?.craving ?? '-'}
                                    </td>
                                    <td style={{ padding: '12px', textAlign: 'center', fontSize: '14px', fontWeight: '600', color: '#FFA500' }}>
                                        {checkIn.eveningData?.anxiety ?? '-'}
                                    </td>
                                    <td style={{ padding: '12px', textAlign: 'center', fontSize: '14px', fontWeight: '600', color: '#9C27B0' }}>
                                        {checkIn.eveningData?.sleepQuality ?? '-'}
                                    </td>
                                    <td style={{ padding: '12px', textAlign: 'center', fontSize: '14px', fontWeight: '600', color: '#4682B4' }}>
                                        {checkIn.eveningData?.overallDay ?? '-'}
                                    </td>
                                    <td style={{ padding: '12px', textAlign: 'center' }}>
                                        <span style={{
                                            padding: '4px 10px',
                                            borderRadius: '12px',
                                            fontSize: '11px',
                                            fontWeight: '600',
                                            background: checkIn.completionStatus === 'complete' ? '#d4edda' : '#f8d7da',
                                            color: checkIn.completionStatus === 'complete' ? '#155724' : '#721c24'
                                        }}>
                                            {checkIn.completionStatus === 'complete' ? 'Yes' : 'No'}
                                        </span>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
}

// FULLY ENHANCED FeedbackView with All Features
function FeedbackView({ searchQuery, user }) {
    const [feedbacks, setFeedbacks] = useState([]);
    const [filteredFeedbacks, setFilteredFeedbacks] = useState([]);
    const [loading, setLoading] = useState(true);
    const [currentPage, setCurrentPage] = useState(1);
    const [filterStatus, setFilterStatus] = useState('all');
    const [filterType, setFilterType] = useState('all');
    const [filterSentiment, setFilterSentiment] = useState('all');
    const [selectedFeedback, setSelectedFeedback] = useState(null);
    const [selectedFeedbacks, setSelectedFeedbacks] = useState(new Set());
    const [stats, setStats] = useState({
        total: 0,
        pending: 0,
        avgRating: 0,
        responseRate: 0
    });
    const itemsPerPage = 20;

    useEffect(() => {
        loadFeedbacks();
    }, []);

    useEffect(() => {
        filterFeedbacks();
        calculateStats();
    }, [feedbacks, filterStatus, filterType, filterSentiment, searchQuery]);

    const analyzeSentiment = (feedback) => {
        const text = (feedback.message + ' ' + feedback.subject).toLowerCase();
        const positiveWords = ['great', 'excellent', 'amazing', 'love', 'perfect', 'fantastic', 'wonderful', 'helpful', 'thank'];
        const negativeWords = ['bad', 'terrible', 'awful', 'hate', 'worst', 'horrible', 'disappointed', 'frustrated', 'angry', 'useless'];
        
        let score = 0;
        positiveWords.forEach(word => { if (text.includes(word)) score++; });
        negativeWords.forEach(word => { if (text.includes(word)) score--; });
        
        if (score > 1) return 'positive';
        if (score < -1) return 'negative';
        return 'neutral';
    };

    const loadFeedbacks = async () => {
        try {
            const feedbacksSnap = await db.collection('feedback')
                .orderBy('createdAt', 'desc')
                .get();
            
            const feedbacksData = [];
            const userIds = new Set();
            
            feedbacksSnap.forEach(doc => {
                const feedback = { id: doc.id, ...doc.data() };
                feedback.sentiment = analyzeSentiment(feedback);
                feedbacksData.push(feedback);
                if (feedback.userId) userIds.add(feedback.userId);
            });
            
            if (userIds.size > 0) {
                const userResults = await batchQuery('users',
                    firebase.firestore.FieldPath.documentId(),
                    Array.from(userIds)
                );
                
                const userMap = {};
                userResults.forEach(user => {
                    userMap[user.id] = user.displayName || user.email;
                });
                
                feedbacksData.forEach(feedback => {
                    feedback.userName = userMap[feedback.userId] || 'Anonymous';
                });
            }
            
            setFeedbacks(feedbacksData);
            setFilteredFeedbacks(feedbacksData);
        } catch (error) {
            console.error('Error loading feedback:', error);
            alert('Failed to load feedback');
        } finally {
            setLoading(false);
        }
    };

    const calculateStats = () => {
        const total = feedbacks.length;
        const pending = feedbacks.filter(f => !f.reviewed).length;
        const ratings = feedbacks.filter(f => f.rating).map(f => f.rating);
        const avgRating = ratings.length > 0 ? (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1) : 0;
        const responded = feedbacks.filter(f => f.response).length;
        const responseRate = total > 0 ? Math.round((responded / total) * 100) : 0;
        
        setStats({ total, pending, avgRating, responseRate });
    };

    const filterFeedbacks = () => {
        let filtered = feedbacks;
        
        if (filterStatus !== 'all') {
            filtered = filtered.filter(feedback => 
                filterStatus === 'reviewed' ? feedback.reviewed : !feedback.reviewed
            );
        }
        
        if (filterType !== 'all') {
            filtered = filtered.filter(feedback => feedback.type === filterType);
        }
        
        if (filterSentiment !== 'all') {
            filtered = filtered.filter(feedback => feedback.sentiment === filterSentiment);
        }
        
        if (searchQuery) {
            const query = searchQuery.toLowerCase();
            filtered = filtered.filter(feedback =>
                feedback.userName?.toLowerCase().includes(query) ||
                feedback.subject?.toLowerCase().includes(query) ||
                feedback.message?.toLowerCase().includes(query)
            );
        }
        
        setFilteredFeedbacks(filtered);
        setCurrentPage(1);
    };

    const quickFilter = (type) => {
        if (type === 'urgent') {
            setFilterType('complaint');
            setFilterStatus('pending');
        } else if (type === 'high-priority') {
            setFilterSentiment('negative');
            setFilterStatus('pending');
        } else if (type === 'needs-response') {
            setFilterStatus('pending');
        }
    };

    const handleSelectAll = () => {
        if (selectedFeedbacks.size === paginatedFeedbacks.length) {
            setSelectedFeedbacks(new Set());
        } else {
            setSelectedFeedbacks(new Set(paginatedFeedbacks.map(f => f.id)));
        }
    };

    const handleSelectFeedback = (feedbackId) => {
        const newSelected = new Set(selectedFeedbacks);
        if (newSelected.has(feedbackId)) {
            newSelected.delete(feedbackId);
        } else {
            newSelected.add(feedbackId);
        }
        setSelectedFeedbacks(newSelected);
    };

    const handleBulkMarkReviewed = async () => {
        try {
            const batch = db.batch();
            selectedFeedbacks.forEach(feedbackId => {
                const feedbackRef = db.collection('feedback').doc(feedbackId);
                batch.update(feedbackRef, {
                    reviewed: true,
                    reviewedBy: user.uid,
                    reviewedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            });
            
            await batch.commit();
            
            setFeedbacks(prev => prev.map(f => 
                selectedFeedbacks.has(f.id) ? { ...f, reviewed: true } : f
            ));
            setSelectedFeedbacks(new Set());
            alert(`Marked ${selectedFeedbacks.size} feedbacks as reviewed`);
        } catch (error) {
            console.error('Error bulk updating:', error);
            alert('Failed to update feedbacks');
        }
    };

    const handleMarkReviewed = async (feedbackId, reviewed = true) => {
        try {
            await db.collection('feedback').doc(feedbackId).update({
                reviewed: reviewed,
                reviewedBy: user.uid,
                reviewedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            setFeedbacks(prev => prev.map(f => 
                f.id === feedbackId ? { ...f, reviewed } : f
            ));
            
            alert('Feedback marked as ' + (reviewed ? 'reviewed' : 'unreviewed'));
        } catch (error) {
            console.error('Error updating feedback:', error);
            alert('Failed to update feedback');
        }
    };

    const handleRespond = async (feedbackId, response) => {
        try {
            await db.collection('feedback').doc(feedbackId).update({
                response: response,
                respondedBy: user.uid,
                respondedAt: firebase.firestore.FieldValue.serverTimestamp(),
                reviewed: true
            });
            
            setFeedbacks(prev => prev.map(f => 
                f.id === feedbackId ? { ...f, response, reviewed: true } : f
            ));
            
            alert('Response sent successfully');
        } catch (error) {
            console.error('Error responding to feedback:', error);
            alert('Failed to send response');
        }
    };

    const handleDelete = async (feedbackId) => {
        if (!confirm('Are you sure you want to delete this feedback?')) return;
        
        try {
            await db.collection('feedback').doc(feedbackId).delete();
            setFeedbacks(prev => prev.filter(f => f.id !== feedbackId));
            alert('Feedback deleted');
        } catch (error) {
            console.error('Error deleting feedback:', error);
            alert('Failed to delete feedback');
        }
    };

    const renderStars = (rating) => {
        if (!rating) return '-';
        return (
            <div style={{ display: 'flex', gap: '2px' }}>
                {[1, 2, 3, 4, 5].map(star => (
                    <span key={star} style={{ 
                        color: star <= rating ? '#FFD700' : '#ddd',
                        fontSize: '16px'
                    }}>
                        ★
                    </span>
                ))}
            </div>
        );
    };

    const getSentimentColor = (sentiment) => {
        if (sentiment === 'positive') return '#00A86B';
        if (sentiment === 'negative') return '#f44336';
        return '#9E9E9E';
    };

    const paginatedFeedbacks = useMemo(() => {
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        return filteredFeedbacks.slice(start, end);
    }, [filteredFeedbacks, currentPage]);

    const totalPages = Math.ceil(filteredFeedbacks.length / itemsPerPage);

    const handleExport = (format) => {
        const exportData = filteredFeedbacks.map(feedback => ({
            user: feedback.userName,
            type: feedback.type,
            subject: feedback.subject,
            message: feedback.message,
            rating: feedback.rating || 'N/A',
            sentiment: feedback.sentiment,
            status: feedback.reviewed ? 'Reviewed' : 'Pending',
            createdAt: formatDate(feedback.createdAt),
            response: feedback.response || 'No response yet'
        }));

        if (format === 'json') {
            exportToJSON(exportData, 'feedback');
        } else if (format === 'csv') {
            exportToCSV(exportData, 'feedback');
        } else if (format === 'pdf') {
            exportToPDF(exportData, 'Feedback Report');
        }
    };

    if (loading) {
        return (
            <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                minHeight: '400px',
                gap: '20px'
            }}>
                <div style={{
                    width: '60px',
                    height: '60px',
                    border: '4px solid #f3f3f3',
                    borderTop: '4px solid #0077CC',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite'
                }}></div>
                <p style={{ color: '#666' }}>Loading feedback...</p>
            </div>
        );
    }

    return (
        <div style={{ padding: '20px', animation: 'fadeIn 0.5s' }}>
            {/* Stats Cards */}
            <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(240px, 1fr))',
                gap: '20px',
                marginBottom: '30px'
            }}>
                <div style={{
                    background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(102, 126, 234, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Total Feedback</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.total}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>All time</div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(240, 147, 251, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Pending Reviews</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.pending}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Awaiting action</div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(79, 172, 254, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Average Rating</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.avgRating}/5
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>From rated feedback</div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(250, 112, 154, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Response Rate</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.responseRate}%
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Responded to</div>
                </div>
            </div>

            {/* Quick Filters */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '15px 20px',
                marginBottom: '20px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                display: 'flex',
                gap: '10px',
                flexWrap: 'wrap',
                alignItems: 'center'
            }}>
                <span style={{ fontWeight: '600', color: '#333', marginRight: '10px' }}>Quick Filters:</span>
                <button
                    onClick={() => quickFilter('urgent')}
                    style={{
                        padding: '8px 16px',
                        background: 'linear-gradient(135deg, #f44336 0%, #e53935 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontSize: '13px',
                        fontWeight: '500',
                        transition: 'transform 0.2s'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                    onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    Urgent Complaints
                </button>
                <button
                    onClick={() => quickFilter('high-priority')}
                    style={{
                        padding: '8px 16px',
                        background: 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontSize: '13px',
                        fontWeight: '500',
                        transition: 'transform 0.2s'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                    onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    High Priority
                </button>
                <button
                    onClick={() => quickFilter('needs-response')}
                    style={{
                        padding: '8px 16px',
                        background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontSize: '13px',
                        fontWeight: '500',
                        transition: 'transform 0.2s'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                    onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    Needs Response
                </button>
            </div>

            {/* Filters and Actions Bar */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                marginBottom: '20px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', flexWrap: 'wrap', gap: '15px' }}>
                    <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                        <select 
                            value={filterStatus}
                            onChange={(e) => setFilterStatus(e.target.value)}
                            style={{
                                padding: '8px 12px',
                                borderRadius: '8px',
                                border: '1px solid #ddd',
                                background: 'white',
                                cursor: 'pointer',
                                fontSize: '14px'
                            }}
                        >
                            <option value="all">All Status</option>
                            <option value="pending">Pending Review</option>
                            <option value="reviewed">Reviewed</option>
                        </select>
                        
                        <select 
                            value={filterType}
                            onChange={(e) => setFilterType(e.target.value)}
                            style={{
                                padding: '8px 12px',
                                borderRadius: '8px',
                                border: '1px solid #ddd',
                                background: 'white',
                                cursor: 'pointer',
                                fontSize: '14px'
                            }}
                        >
                            <option value="all">All Types</option>
                            <option value="bug">Bug Report</option>
                            <option value="feature">Feature Request</option>
                            <option value="general">General Feedback</option>
                            <option value="complaint">Complaint</option>
                            <option value="praise">Praise</option>
                        </select>

                        <select 
                            value={filterSentiment}
                            onChange={(e) => setFilterSentiment(e.target.value)}
                            style={{
                                padding: '8px 12px',
                                borderRadius: '8px',
                                border: '1px solid #ddd',
                                background: 'white',
                                cursor: 'pointer',
                                fontSize: '14px'
                            }}
                        >
                            <option value="all">All Sentiments</option>
                            <option value="positive">Positive</option>
                            <option value="neutral">Neutral</option>
                            <option value="negative">Negative</option>
                        </select>
                    </div>
                    
                    <div style={{ display: 'flex', gap: '10px' }}>
                        {selectedFeedbacks.size > 0 && (
                            <button 
                                onClick={handleBulkMarkReviewed}
                                style={{
                                    padding: '10px 16px',
                                    background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500'
                                }}
                            >
                                Mark {selectedFeedbacks.size} as Reviewed
                            </button>
                        )}
                        <button 
                            onClick={() => handleExport('csv')}
                            style={{
                                padding: '10px 16px',
                                background: '#6c757d',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '500'
                            }}
                        >
                            Export CSV
                        </button>
                    </div>
                </div>
            </div>
            
            {/* Enhanced Table */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                overflow: 'hidden',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                    <thead>
                        <tr style={{ background: '#f8f9fa', borderBottom: '2px solid #e9ecef' }}>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>
                                <input 
                                    type="checkbox"
                                    checked={selectedFeedbacks.size === paginatedFeedbacks.length && paginatedFeedbacks.length > 0}
                                    onChange={handleSelectAll}
                                    style={{ cursor: 'pointer', width: '16px', height: '16px' }}
                                />
                            </th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>User</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Type</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Subject</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Rating</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Sentiment</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Status</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Date</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {paginatedFeedbacks.map(feedback => (
                            <tr key={feedback.id} style={{
                                borderBottom: '1px solid #f0f0f0',
                                transition: 'all 0.2s',
                                background: selectedFeedbacks.has(feedback.id) ? '#f0f4ff' : 'white'
                            }}
                            onMouseEnter={(e) => {
                                if (!selectedFeedbacks.has(feedback.id)) {
                                    e.currentTarget.style.background = '#f8f9fa';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (!selectedFeedbacks.has(feedback.id)) {
                                    e.currentTarget.style.background = 'white';
                                }
                            }}
                            >
                                <td style={{ padding: '15px' }}>
                                    <input 
                                        type="checkbox"
                                        checked={selectedFeedbacks.has(feedback.id)}
                                        onChange={() => handleSelectFeedback(feedback.id)}
                                        style={{ cursor: 'pointer', width: '16px', height: '16px' }}
                                    />
                                </td>
                                <td style={{ padding: '15px', fontWeight: '500', color: '#333' }}>
                                    {feedback.userName}
                                </td>
                                <td style={{ padding: '15px' }}>
                                    <span style={{
                                        padding: '4px 12px',
                                        borderRadius: '20px',
                                        fontSize: '12px',
                                        fontWeight: '500',
                                        background: '#e3f2fd',
                                        color: '#1976d2'
                                    }}>
                                        {feedback.type}
                                    </span>
                                </td>
                                <td style={{ padding: '15px', color: '#666', maxWidth: '200px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                    {feedback.subject}
                                </td>
                                <td style={{ padding: '15px' }}>{renderStars(feedback.rating)}</td>
                                <td style={{ padding: '15px' }}>
                                    <div style={{
                                        width: '10px',
                                        height: '10px',
                                        borderRadius: '50%',
                                        background: getSentimentColor(feedback.sentiment),
                                        display: 'inline-block'
                                    }}></div>
                                </td>
                                <td style={{ padding: '15px' }}>
                                    <span style={{
                                        padding: '4px 12px',
                                        borderRadius: '20px',
                                        fontSize: '12px',
                                        fontWeight: '500',
                                        background: feedback.reviewed ? '#d4edda' : '#fff3cd',
                                        color: feedback.reviewed ? '#155724' : '#856404'
                                    }}>
                                        {feedback.reviewed ? 'Reviewed' : 'Pending'}
                                    </span>
                                </td>
                                <td style={{ padding: '15px', color: '#666' }}>{formatDate(feedback.createdAt)}</td>
                                <td style={{ padding: '15px' }}>
                                    <button 
                                        onClick={() => setSelectedFeedback(feedback)}
                                        style={{
                                            padding: '6px 12px',
                                            background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            fontWeight: '500'
                                        }}
                                    >
                                        View
                                    </button>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
                
                {filteredFeedbacks.length === 0 && (
                    <div style={{
                        padding: '60px 20px',
                        textAlign: 'center',
                        color: '#999'
                    }}>
                        <div style={{ fontSize: '48px', marginBottom: '15px' }}>📝</div>
                        <div style={{ fontSize: '18px', fontWeight: '500', marginBottom: '8px' }}>
                            No feedback found
                        </div>
                        <div style={{ fontSize: '14px' }}>
                            {searchQuery ? 'Try adjusting your search terms' : 'Feedback will appear here when submitted'}
                        </div>
                    </div>
                )}
            </div>
            
            {totalPages > 1 && (
                <div style={{ marginTop: '20px' }}>
                    <Pagination 
                        currentPage={currentPage}
                        totalPages={totalPages}
                        onPageChange={setCurrentPage}
                    />
                </div>
            )}
            
            {selectedFeedback && (
                <FeedbackDetailModal 
                    feedback={selectedFeedback}
                    onClose={() => setSelectedFeedback(null)}
                    onRespond={handleRespond}
                    onMarkReviewed={handleMarkReviewed}
                    getSentimentColor={getSentimentColor}
                    renderStars={renderStars}
                />
            )}
        </div>
    );
}

// Enhanced Feedback Detail Modal
function FeedbackDetailModal({ feedback, onClose, onRespond, onMarkReviewed, getSentimentColor, renderStars }) {
    const [response, setResponse] = useState(feedback.response || '');
    const [submitting, setSubmitting] = useState(false);

    const handleSubmit = async () => {
        if (!response.trim()) {
            alert('Please enter a response');
            return;
        }
        
        setSubmitting(true);
        await onRespond(feedback.id, response);
        setSubmitting(false);
        onClose();
    };

    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000,
            padding: '20px',
            animation: 'fadeIn 0.2s'
        }}>
            <div style={{
                background: 'white',
                borderRadius: '20px',
                maxWidth: '700px',
                width: '100%',
                maxHeight: '90vh',
                overflow: 'auto',
                boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
                animation: 'slideUp 0.3s'
            }}>
                {/* Header */}
                <div style={{
                    background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                    padding: '25px 30px',
                    borderRadius: '20px 20px 0 0',
                    color: 'white',
                    position: 'sticky',
                    top: 0,
                    zIndex: 1
                }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <h2 style={{ margin: 0, fontSize: '24px' }}>Feedback Details</h2>
                        <button 
                            onClick={onClose}
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                border: 'none',
                                color: 'white',
                                fontSize: '24px',
                                width: '36px',
                                height: '36px',
                                borderRadius: '50%',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                transition: 'background 0.2s'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.3)'}
                            onMouseLeave={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.2)'}
                        >
                            ×
                        </button>
                    </div>
                </div>

                {/* Content */}
                <div style={{ padding: '30px' }}>
                    {/* Info Grid */}
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(2, 1fr)',
                        gap: '20px',
                        marginBottom: '25px'
                    }}>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>User</div>
                            <div style={{ fontSize: '16px', fontWeight: '500', color: '#333' }}>
                                {feedback.userName}
                            </div>
                        </div>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Type</div>
                            <div style={{ fontSize: '16px', fontWeight: '500', color: '#333' }}>
                                {feedback.type}
                            </div>
                        </div>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Rating</div>
                            {renderStars(feedback.rating)}
                        </div>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Sentiment</div>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                <div style={{
                                    width: '12px',
                                    height: '12px',
                                    borderRadius: '50%',
                                    background: getSentimentColor(feedback.sentiment)
                                }}></div>
                                <span style={{ textTransform: 'capitalize' }}>{feedback.sentiment}</span>
                            </div>
                        </div>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Date</div>
                            <div style={{ fontSize: '16px', fontWeight: '500', color: '#333' }}>
                                {formatDate(feedback.createdAt)}
                            </div>
                        </div>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Status</div>
                            <span style={{
                                padding: '4px 12px',
                                borderRadius: '20px',
                                fontSize: '12px',
                                fontWeight: '500',
                                background: feedback.reviewed ? '#d4edda' : '#fff3cd',
                                color: feedback.reviewed ? '#155724' : '#856404'
                            }}>
                                {feedback.reviewed ? 'Reviewed' : 'Pending'}
                            </span>
                        </div>
                    </div>

                    {/* Subject */}
                    <div style={{ marginBottom: '20px' }}>
                        <div style={{ fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                            Subject
                        </div>
                        <div style={{
                            padding: '15px',
                            background: '#f8f9fa',
                            borderRadius: '10px',
                            color: '#666'
                        }}>
                            {feedback.subject}
                        </div>
                    </div>

                    {/* Message */}
                    <div style={{ marginBottom: '25px' }}>
                        <div style={{ fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                            Message
                        </div>
                        <div style={{
                            padding: '15px',
                            background: '#f8f9fa',
                            borderRadius: '10px',
                            color: '#666',
                            lineHeight: '1.6',
                            whiteSpace: 'pre-wrap'
                        }}>
                            {feedback.message}
                        </div>
                    </div>

                    {/* Response Section */}
                    <div style={{ marginBottom: '20px' }}>
                        <div style={{ fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                            {feedback.response ? 'Your Response' : 'Add Response'}
                        </div>
                        <textarea
                            value={response}
                            onChange={(e) => setResponse(e.target.value)}
                            placeholder="Type your response here..."
                            style={{
                                width: '100%',
                                minHeight: '120px',
                                padding: '15px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '10px',
                                fontSize: '14px',
                                fontFamily: 'inherit',
                                resize: 'vertical',
                                transition: 'border-color 0.2s'
                            }}
                            onFocus={(e) => e.currentTarget.style.borderColor = '#0077CC'}
                            onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                        />
                    </div>

                    {/* Actions */}
                    <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                        {!feedback.reviewed && (
                            <button
                                onClick={() => {
                                    onMarkReviewed(feedback.id, true);
                                    onClose();
                                }}
                                style={{
                                    padding: '12px 24px',
                                    background: '#6c757d',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500',
                                    transition: 'background 0.2s'
                                }}
                                onMouseEnter={(e) => e.currentTarget.style.background = '#5a6268'}
                                onMouseLeave={(e) => e.currentTarget.style.background = '#6c757d'}
                            >
                                Mark as Reviewed
                            </button>
                        )}
                        <button
                            onClick={handleSubmit}
                            disabled={submitting || !response.trim()}
                            style={{
                                padding: '12px 24px',
                                background: submitting || !response.trim() 
                                    ? '#ccc' 
                                    : 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: submitting || !response.trim() ? 'not-allowed' : 'pointer',
                                fontSize: '14px',
                                fontWeight: '500',
                                transition: 'transform 0.2s'
                            }}
                            onMouseEnter={(e) => {
                                if (!submitting && response.trim()) {
                                    e.currentTarget.style.transform = 'translateY(-2px)';
                                }
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.transform = 'translateY(0)';
                            }}
                        >
                            {submitting ? 'Sending...' : 'Send Response'}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
}

  // ==========================================
// ALERTS VIEW - FIREBASE EXTENSION VERSION
// ==========================================
function AlertsView({ searchQuery, user }) {
    const [alerts, setAlerts] = useState([]);
    const [filteredAlerts, setFilteredAlerts] = useState([]);
    const [loading, setLoading] = useState(true);
    const [currentPage, setCurrentPage] = useState(1);
    const [filterType, setFilterType] = useState('all');
    const [filterPriority, setFilterPriority] = useState('all');
    const [filterResolved, setFilterResolved] = useState('unresolved');
    const [selectedAlert, setSelectedAlert] = useState(null);
    const [stats, setStats] = useState({
        total: 0,
        active: 0,
        critical: 0,
        // Type-specific breakdowns
        sos: { count: 0, avgResponseTime: 0 },
        missedCheckin: { count: 0, avgResponseTime: 0 },
        highCraving: { count: 0, avgResponseTime: 0 },
        customThreshold: { count: 0 }
    });
    const [frequencyData, setFrequencyData] = useState([]);
    const frequencyChartRef = useRef(null);
    const chartInstance = useRef(null);
    const itemsPerPage = 20;

    useEffect(() => {
        loadAlerts();
        
        // Real-time SOS listener
        const unsubscribe = db.collection('alerts')
            .where('type', '==', 'sos')
            .where('status', '==', 'active')
            .onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const alert = { id: change.doc.id, ...change.doc.data() };
                        
                        // Only process NEW alerts (created in last 10 seconds)
                        const alertTime = alert.createdAt?.toDate ? alert.createdAt.toDate() : new Date(alert.createdAt);
                        const now = new Date();
                        const secondsAgo = (now - alertTime) / 1000;
                        
                        if (secondsAgo < 10) {
                            console.log('🚨 NEW SOS ALERT DETECTED:', alert.id);
                            handleNewSOSAlert(alert);
                        }
                    }
                });
            });
        
        return () => {
            unsubscribe();
            if (chartInstance.current) {
                chartInstance.current.destroy();
            }
        };
    }, []);

    useEffect(() => {
        filterAlerts();
        calculateStats();
        prepareFrequencyData();
    }, [alerts, filterType, filterPriority, filterResolved, searchQuery]);

    useEffect(() => {
        if (frequencyData.length > 0) {
            renderFrequencyChart();
        }
    }, [frequencyData]);

    // ==========================================
    // ENHANCED SOS HANDLER - FIREBASE EXTENSION VERSION
    // ==========================================
    const handleNewSOSAlert = async (alert) => {
        try {
            console.log('🚨 Processing SOS alert for notifications...');
            
            // Show browser notification first (instant feedback)
            showBrowserNotification(alert);
            
            // Get PIR data
            const pirDoc = await db.collection('users').doc(alert.userId).get();
            if (!pirDoc.exists) {
                console.error('❌ PIR not found:', alert.userId);
                return;
            }
            
            const pirData = pirDoc.data();
            console.log('👤 PIR data loaded:', pirData.email);
            
            // Check if this PIR is assigned to current coach
            if (pirData.assignedCoach !== user.uid) {
                console.log('⚠️ This PIR is not assigned to current coach - skipping email');
                return;
            }
            
            // Get current coach's email
            const coachDoc = await db.collection('users').doc(user.uid).get();
            const coachData = coachDoc.data();
            const coachEmail = coachData.email;
            
            console.log('📧 Sending SOS email via Firebase Extension to:', coachEmail);
            
            // Send email using Firebase Extension (NEW METHOD)
            await db.collection('mail').add({
                to: [coachEmail],
                message: {
                    subject: '🚨 URGENT: SOS Alert from ' + (pirData.displayName || pirData.firstName || pirData.email),
                    html: `
                        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                            <div style="background: #dc2626; color: white; padding: 20px; border-radius: 8px 8px 0 0;">
                                <h1 style="margin: 0; font-size: 24px;">🚨 SOS ALERT</h1>
                            </div>
                            
                            <div style="background: #f9fafb; padding: 20px; border: 1px solid #e5e7eb;">
                                <h2 style="color: #dc2626; margin-top: 0;">Person in Recovery Needs Help</h2>
                                
                                <div style="background: white; padding: 15px; border-radius: 8px; margin: 15px 0;">
                                    <p style="margin: 5px 0;"><strong>Name:</strong> ${pirData.displayName || pirData.firstName || 'Not provided'}</p>
                                    <p style="margin: 5px 0;"><strong>Email:</strong> ${pirData.email}</p>
                                    <p style="margin: 5px 0;"><strong>Phone:</strong> ${pirData.phone || 'Not provided'}</p>
                                    <p style="margin: 5px 0;"><strong>Time:</strong> ${new Date(alert.timestamp?.toDate ? alert.timestamp.toDate() : Date.now()).toLocaleString()}</p>
                                </div>
                                
                                ${alert.message ? `
                                <div style="background: #fef2f2; padding: 15px; border-left: 4px solid #dc2626; margin: 15px 0;">
                                    <p style="margin: 0;"><strong>Message:</strong></p>
                                    <p style="margin: 10px 0 0 0;">${alert.message}</p>
                                </div>
                                ` : ''}
                                
                                <div style="background: #fffbeb; padding: 15px; border-radius: 8px; margin: 15px 0;">
                                    <p style="margin: 0; color: #92400e;">
                                        <strong>⚠️ Action Required:</strong> Please contact this person immediately.
                                    </p>
                                </div>
                                
                                <div style="text-align: center; margin-top: 20px;">
                                    <a href="app.glrecoveryservices.com/admin.html" 
                                       style="background: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">
                                        View in Coach Portal
                                    </a>
                                </div>
                            </div>
                            
                            <div style="background: #f3f4f6; padding: 15px; text-align: center; font-size: 12px; color: #6b7280; border-radius: 0 0 8px 8px;">
                                <p style="margin: 0;">Guiding Light Recovery Services</p>
                                <p style="margin: 5px 0 0 0;">Automated alert system</p>
                            </div>
                        </div>
                    `,
                    text: `
🚨 SOS ALERT - ${pirData.displayName || pirData.firstName || pirData.email}

A person in recovery has triggered an SOS alert and needs immediate assistance.

Name: ${pirData.displayName || pirData.firstName || 'Not provided'}
Email: ${pirData.email}
Phone: ${pirData.phone || 'Not provided'}
Time: ${new Date(alert.timestamp?.toDate ? alert.timestamp.toDate() : Date.now()).toLocaleString()}
${alert.message ? `\nMessage: ${alert.message}` : ''}

⚠️ Please contact this person immediately.

View details: app.glrecoveryservices.com/admin.html

---
Guiding Light Recovery Services
Automated alert system
                    `
                }
            });
            
            console.log('✅ SOS email queued successfully!');
            
            // Update alert to mark email was sent
            await db.collection('alerts').doc(alert.id).update({
                emailSent: true,
                emailSentAt: firebase.firestore.FieldValue.serverTimestamp(),
                emailSentTo: coachEmail
            });
            
            // Show success notification
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('🚨 SOS EMAIL SENT', {
                    body: `Emergency alert from ${pirData.displayName || pirData.email}\n\n✓ Email notification sent to your inbox`,
                    icon: '/favicon.ico',
                    requireInteraction: true,
                    tag: 'sos-email-sent'
                });
            }
            
            // Create in-app notification
            await createInAppNotification(alert, pirData);
            
            console.log('✅ SOS alert processing complete');
            
        } catch (error) {
            console.error('❌ Error handling SOS alert:', error);
            
            // Still show notification about the SOS even if email failed
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('🚨 SOS ALERT - Email Failed', {
                    body: `Emergency alert detected but email failed to send.\n\nError: ${error.message}\n\nCheck Alerts tab immediately!`,
                    icon: '/favicon.ico',
                    requireInteraction: true,
                    tag: 'sos-email-failed'
                });
            }
        }
    };

    // Helper: Show browser notification
    const showBrowserNotification = (alert) => {
        if ('Notification' in window) {
            if (Notification.permission === 'granted') {
                new Notification('🚨 SOS ALERT', {
                    body: `Emergency alert detected - Processing...`,
                    icon: '/favicon.ico',
                    requireInteraction: true,
                    tag: 'sos-alert'
                });
            } else if (Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }
    };

    // Helper: Create in-app notification (with preference checking)
    const createInAppNotification = async (alert, pirData) => {
        await createNotificationWithPreferences({
            type: 'sos',
            title: '🚨 EMERGENCY: SOS Alert',
            message: `${pirData.displayName || pirData.email} has triggered an SOS alert`,
            recipientId: user.uid,
            relatedId: alert.id,
            urgent: true,
            read: false
        }, 'sos');
    };

    const loadAlerts = async () => {
        try {
            const alertsSnap = await db.collection('alerts')
                .orderBy('createdAt', 'desc')
                .get();
            
            const alertsData = [];
            const userIds = new Set();
            
            alertsSnap.forEach(doc => {
                const alert = { id: doc.id, ...doc.data() };
                alertsData.push(alert);
                if (alert.userId) userIds.add(alert.userId);
            });
            
            if (userIds.size > 0) {
                const userResults = await batchQuery('users',
                    firebase.firestore.FieldPath.documentId(),
                    Array.from(userIds)
                );
                
                const userMap = {};
                userResults.forEach(user => {
                    userMap[user.id] = user.displayName || user.email;
                });
                
                alertsData.forEach(alert => {
                    alert.userName = userMap[alert.userId] || 'Unknown User';
                });
            }
            
            setAlerts(alertsData);
            setFilteredAlerts(alertsData);
        } catch (error) {
            console.error('Error loading alerts:', error);
            alert('Failed to load alerts');
        } finally {
            setLoading(false);
        }
    };

    // Helper: Format response time in human-readable format
    const formatResponseTime = (minutes) => {
        if (minutes === 0) return '0m';
        const hours = Math.floor(minutes / 60);
        const mins = Math.round(minutes % 60);
        if (hours === 0) return `${mins}m`;
        if (mins === 0) return `${hours}h`;
        return `${hours}h ${mins}m`;
    };

    const calculateStats = () => {
        const total = alerts.length;
        const active = alerts.filter(a => a.status === 'active').length;
        const critical = alerts.filter(a => a.severity === 'critical' && a.status === 'active').length;

        // Calculate type-specific stats
        const calculateTypeStats = (type) => {
            const typeAlerts = alerts.filter(a => a.type === type);
            const resolvedTypeAlerts = typeAlerts.filter(a => a.resolved && a.createdAt && a.resolvedAt);

            let totalMinutes = 0;
            resolvedTypeAlerts.forEach(alert => {
                const created = alert.createdAt.toDate ? alert.createdAt.toDate() : new Date(alert.createdAt);
                const resolved = alert.resolvedAt.toDate ? alert.resolvedAt.toDate() : new Date(alert.resolvedAt);
                const minutes = (resolved - created) / 1000 / 60;
                totalMinutes += minutes;
            });

            return {
                count: typeAlerts.length,
                avgResponseTime: resolvedTypeAlerts.length > 0
                    ? Math.round(totalMinutes / resolvedTypeAlerts.length)
                    : 0
            };
        };

        const sos = calculateTypeStats('sos');
        const missedCheckin = calculateTypeStats('missed_checkin');
        const highCraving = calculateTypeStats('high_craving');
        const customThreshold = { count: alerts.filter(a => a.type === 'custom' || a.type === 'system').length };

        setStats({
            total,
            active,
            critical,
            sos,
            missedCheckin,
            highCraving,
            customThreshold
        });
    };

    const prepareFrequencyData = () => {
        const last7Days = [];
        const counts = [];
        
        for (let i = 6; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            date.setHours(0, 0, 0, 0);
            
            const nextDay = new Date(date);
            nextDay.setDate(nextDay.getDate() + 1);
            
            const dayAlerts = alerts.filter(alert => {
                const alertDate = alert.createdAt?.toDate ? alert.createdAt.toDate() : new Date(alert.createdAt);
                return alertDate >= date && alertDate < nextDay;
            });
            
            last7Days.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
            counts.push(dayAlerts.length);
        }
        
        setFrequencyData({ labels: last7Days, data: counts });
    };

    const renderFrequencyChart = () => {
        if (chartInstance.current) {
            chartInstance.current.destroy();
        }
        
        const ctx = frequencyChartRef.current?.getContext('2d');
        if (ctx) {
            chartInstance.current = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: frequencyData.labels,
                    datasets: [{
                        label: 'Alerts',
                        data: frequencyData.data,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: '#0077CC',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
    };

    const filterAlerts = () => {
        let filtered = alerts;
        
        if (filterType !== 'all') {
            filtered = filtered.filter(alert => alert.type === filterType);
        }
        
        if (filterPriority !== 'all') {
            filtered = filtered.filter(alert => alert.priority === filterPriority);
        }
        
        if (filterResolved === 'resolved') {
            filtered = filtered.filter(alert => alert.resolved);
        } else if (filterResolved === 'unresolved') {
            filtered = filtered.filter(alert => !alert.resolved);
        }
        
        if (searchQuery) {
            const query = searchQuery.toLowerCase();
            filtered = filtered.filter(alert =>
                alert.userName?.toLowerCase().includes(query) ||
                alert.message?.toLowerCase().includes(query) ||
                alert.type?.toLowerCase().includes(query)
            );
        }
        
        setFilteredAlerts(filtered);
        setCurrentPage(1);
    };

    const handleQuickResolve = async (alertId) => {
        try {
            await db.collection('alerts').doc(alertId).update({
                resolved: true,
                status: 'resolved',
                resolvedBy: user.uid,
                resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                resolutionNotes: 'Quick resolved'
            });
            
            setAlerts(prev => prev.map(a => 
                a.id === alertId ? { ...a, resolved: true, status: 'resolved', resolutionNotes: 'Quick resolved' } : a
            ));
        } catch (error) {
            console.error('Error quick resolving:', error);
            alert('Failed to resolve alert');
        }
    };

    const handleResolve = async (alertId, notes = '') => {
        try {
            await db.collection('alerts').doc(alertId).update({
                resolved: true,
                status: 'resolved',
                resolvedBy: user.uid,
                resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                resolutionNotes: notes
            });
            
            setAlerts(prev => prev.map(a => 
                a.id === alertId ? { ...a, resolved: true, status: 'resolved', resolutionNotes: notes } : a
            ));
            
            alert('Alert resolved successfully');
        } catch (error) {
            console.error('Error resolving alert:', error);
            alert('Failed to resolve alert');
        }
    };

    const handleDelete = async (alertId) => {
        if (!confirm('Are you sure you want to delete this alert?')) return;
        
        try {
            await db.collection('alerts').doc(alertId).delete();
            setAlerts(prev => prev.filter(a => a.id !== alertId));
            alert('Alert deleted');
        } catch (error) {
            console.error('Error deleting alert:', error);
            alert('Failed to delete alert');
        }
    };

    const getPriorityColor = (priority) => {
        if (priority === 'critical') return '#f44336';
        if (priority === 'high') return '#FF9800';
        if (priority === 'medium') return '#FFC107';
        return '#00A86B';
    };

    const paginatedAlerts = useMemo(() => {
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        return filteredAlerts.slice(start, end);
    }, [filteredAlerts, currentPage]);

    const totalPages = Math.ceil(filteredAlerts.length / itemsPerPage);

    const handleExport = (format) => {
        const exportData = filteredAlerts.map(alert => ({
            user: alert.userName,
            type: alert.type,
            priority: alert.priority || 'Normal',
            message: alert.message,
            status: alert.resolved ? 'Resolved' : 'Active',
            createdAt: formatDateTime(alert.createdAt),
            resolvedAt: alert.resolvedAt ? formatDateTime(alert.resolvedAt) : 'N/A',
            resolutionNotes: alert.resolutionNotes || 'N/A',
            emailSent: alert.emailSent ? 'Yes' : 'No'
        }));

        if (format === 'json') {
            exportToJSON(exportData, 'alerts');
        } else if (format === 'csv') {
            exportToCSV(exportData, 'alerts');
        } else if (format === 'pdf') {
            exportToPDF(exportData, 'Alerts Report');
        }
    };

    if (loading) {
        return (
            <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                minHeight: '400px',
                gap: '20px'
            }}>
                <div style={{
                    width: '60px',
                    height: '60px',
                    border: '4px solid #f3f3f3',
                    borderTop: '4px solid #0077CC',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite'
                }}></div>
                <p style={{ color: '#666' }}>Loading alerts...</p>
            </div>
        );
    }

    return (
        <div style={{ padding: '20px', animation: 'fadeIn 0.5s' }}>
            {/* Stats Cards */}
            <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(240px, 1fr))',
                gap: '20px',
                marginBottom: '30px'
            }}>
                {/* Total Alerts */}
                <div style={{
                    background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(102, 126, 234, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Total Alerts</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.total}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>All time</div>
                </div>

                {/* Active Alerts */}
                <div style={{
                    background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(240, 147, 251, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Active Alerts</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.active}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Need attention</div>
                </div>

                {/* SOS Alerts */}
                <div style={{
                    background: 'linear-gradient(135deg, #ff4444 0%, #cc0000 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(255, 68, 68, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9, display: 'flex', alignItems: 'center', gap: '5px' }}>
                        <span>🚨</span> SOS Alerts
                    </div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.sos.count}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>
                        Avg response: {formatResponseTime(stats.sos.avgResponseTime)}
                    </div>
                </div>

                {/* Missed Check-ins */}
                <div style={{
                    background: 'linear-gradient(135deg, #FF9800 0%, #FF6B00 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(255, 152, 0, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9, display: 'flex', alignItems: 'center', gap: '5px' }}>
                        <span>⏰</span> Missed Check-ins
                    </div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.missedCheckin.count}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>
                        Avg response: {formatResponseTime(stats.missedCheckin.avgResponseTime)}
                    </div>
                </div>

                {/* High Craving Alerts */}
                <div style={{
                    background: 'linear-gradient(135deg, #FFC107 0%, #FFA000 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(255, 193, 7, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9, display: 'flex', alignItems: 'center', gap: '5px' }}>
                        <span>⚠️</span> High Craving
                    </div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.highCraving.count}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>
                        Avg response: {formatResponseTime(stats.highCraving.avgResponseTime)}
                    </div>
                </div>

                {/* Custom Threshold Alerts */}
                <div style={{
                    background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(79, 172, 254, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9, display: 'flex', alignItems: 'center', gap: '5px' }}>
                        <span>🔔</span> Custom/System
                    </div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.customThreshold.count}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>
                        Other alert types
                    </div>
                </div>
            </div>

            {/* Alert Frequency Chart */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '25px',
                marginBottom: '30px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <h3 style={{ margin: '0 0 20px 0', color: '#333' }}>Alert Frequency - Last 7 Days</h3>
                <div style={{ height: '250px' }}>
                    <canvas ref={frequencyChartRef}></canvas>
                </div>
            </div>

            {/* SOS Alert Banner */}
            {filteredAlerts.filter(a => a.type === 'sos' && a.status === 'active').length > 0 && (
                <div style={{
                    background: 'linear-gradient(135deg, #ff4444, #cc0000)',
                    padding: '20px',
                    borderRadius: '15px',
                    marginBottom: '20px',
                    animation: 'pulse 2s infinite',
                    boxShadow: '0 4px 15px rgba(255, 68, 68, 0.4)'
                }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '15px', color: 'white' }}>
                        <span style={{ fontSize: '32px' }}>🚨</span>
                        <div>
                            <div style={{ fontSize: '18px', fontWeight: 'bold', marginBottom: '5px' }}>
                                {filteredAlerts.filter(a => a.type === 'sos' && a.status === 'active').length} Active SOS Alert(s)
                            </div>
                            <div style={{ fontSize: '14px', opacity: 0.9 }}>
                                Immediate attention required - Email notifications sent automatically
                            </div>
                        </div>
                    </div>
                </div>
            )}
            
            {/* Filters and Actions Bar */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                marginBottom: '20px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', flexWrap: 'wrap', gap: '15px' }}>
                    <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                        <select 
                            value={filterType}
                            onChange={(e) => setFilterType(e.target.value)}
                            style={{
                                padding: '8px 12px',
                                borderRadius: '8px',
                                border: '1px solid #ddd',
                                background: 'white',
                                cursor: 'pointer',
                                fontSize: '14px'
                            }}
                        >
                            <option value="all">All Types</option>
                            <option value="sos">SOS Emergency</option>
                            <option value="missed_checkin">Missed Check-in</option>
                            <option value="low_mood">Low Mood</option>
                            <option value="high_craving">High Craving</option>
                            <option value="system">System Alert</option>
                        </select>
                        
                        <select 
                            value={filterPriority}
                            onChange={(e) => setFilterPriority(e.target.value)}
                            style={{
                                padding: '8px 12px',
                                borderRadius: '8px',
                                border: '1px solid #ddd',
                                background: 'white',
                                cursor: 'pointer',
                                fontSize: '14px'
                            }}
                        >
                            <option value="all">All Priorities</option>
                            <option value="critical">Critical</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                        
                        <select 
                            value={filterResolved}
                            onChange={(e) => setFilterResolved(e.target.value)}
                            style={{
                                padding: '8px 12px',
                                borderRadius: '8px',
                                border: '1px solid #ddd',
                                background: 'white',
                                cursor: 'pointer',
                                fontSize: '14px'
                            }}
                        >
                            <option value="all">All Status</option>
                            <option value="unresolved">Active</option>
                            <option value="resolved">Resolved</option>
                        </select>
                    </div>
                    
                    <div style={{ display: 'flex', gap: '10px' }}>
                        <button 
                            onClick={() => handleExport('csv')}
                            style={{
                                padding: '10px 16px',
                                background: '#6c757d',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '500'
                            }}
                        >
                            Export CSV
                        </button>
                    </div>
                </div>
            </div>
            
            {/* Enhanced Table */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                overflow: 'hidden',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                    <thead>
                        <tr style={{ background: '#f8f9fa', borderBottom: '2px solid #e9ecef' }}>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Priority</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>User</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Type</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Message</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Status</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Email</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Created</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {paginatedAlerts.map(alert => (
                            <tr key={alert.id} style={{
                                borderBottom: '1px solid #f0f0f0',
                                transition: 'all 0.2s',
                                background: alert.type === 'sos' && alert.status === 'active' ? 'rgba(244, 67, 54, 0.05)' : 'white',
                                borderLeft: `4px solid ${getPriorityColor(alert.severity || 'low')}`
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.background = '#f8f9fa';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.background = alert.type === 'sos' && alert.status === 'active' ? 'rgba(244, 67, 54, 0.05)' : 'white';
                            }}
                            >
                                <td style={{ padding: '15px' }}>
                                    <div style={{
                                        width: '12px',
                                        height: '12px',
                                        borderRadius: '50%',
                                        background: getPriorityColor(alert.severity || 'low')
                                    }}></div>
                                </td>
                                <td style={{ padding: '15px', fontWeight: '500', color: '#333' }}>
                                    {alert.userName}
                                </td>
                                <td style={{ padding: '15px' }}>
                                    <span style={{
                                        padding: '4px 12px',
                                        borderRadius: '20px',
                                        fontSize: '12px',
                                        fontWeight: '500',
                                        background: alert.type === 'sos' ? '#ffebee' : '#e3f2fd',
                                        color: alert.type === 'sos' ? '#c62828' : '#1565c0'
                                    }}>
                                        {alert.type === 'sos' ? '🚨 SOS' : alert.type?.replace('_', ' ')}
                                    </span>
                                </td>
                                <td style={{ padding: '15px', color: '#666', maxWidth: '200px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                    {alert.message}
                                </td>
                                <td style={{ padding: '15px' }}>
                                    <span style={{
                                        padding: '4px 12px',
                                        borderRadius: '20px',
                                        fontSize: '12px',
                                        fontWeight: '500',
                                        background: alert.status === 'resolved' ? '#d4edda' : '#f8d7da',
                                        color: alert.status === 'resolved' ? '#155724' : '#721c24'
                                    }}>
                                        {alert.status === 'resolved' ? 'Resolved' : 'Active'}
                                    </span>
                                </td>
                                <td style={{ padding: '15px' }}>
                                    {alert.emailSent ? (
                                        <span style={{ color: '#00A86B', fontSize: '16px' }} title="Email sent">✓</span>
                                    ) : (
                                        <span style={{ color: '#999', fontSize: '16px' }} title="No email sent">—</span>
                                    )}
                                </td>
                                <td style={{ padding: '15px', color: '#666' }}>{formatTimeAgo(alert.createdAt)}</td>
                                <td style={{ padding: '15px' }}>
                                    <div style={{ display: 'flex', gap: '8px' }}>
                                        <button 
                                            onClick={() => setSelectedAlert(alert)}
                                            style={{
                                                padding: '6px 12px',
                                                background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '6px',
                                                cursor: 'pointer',
                                                fontSize: '13px',
                                                fontWeight: '500'
                                            }}
                                        >
                                            View
                                        </button>
                                        {alert.status !== 'resolved' && (
                                            <button 
                                                onClick={() => handleQuickResolve(alert.id)}
                                                style={{
                                                    padding: '6px 12px',
                                                    background: '#00A86B',
                                                    color: 'white',
                                                    border: 'none',
                                                    borderRadius: '6px',
                                                    cursor: 'pointer',
                                                    fontSize: '13px',
                                                    fontWeight: '500'
                                                }}
                                            >
                                                Quick Resolve
                                            </button>
                                        )}
                                    </div>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
                
                {filteredAlerts.length === 0 && (
                    <div style={{
                        padding: '60px 20px',
                        textAlign: 'center',
                        color: '#999'
                    }}>
                        <div style={{ fontSize: '48px', marginBottom: '15px' }}>🔔</div>
                        <div style={{ fontSize: '18px', fontWeight: '500', marginBottom: '8px' }}>
                            No alerts found
                        </div>
                        <div style={{ fontSize: '14px' }}>
                            {searchQuery ? 'Try adjusting your search terms' : 'Alerts will appear here when triggered'}
                        </div>
                    </div>
                )}
            </div>
            
            {totalPages > 1 && (
                <div style={{ marginTop: '20px' }}>
                    <Pagination 
                        currentPage={currentPage}
                        totalPages={totalPages}
                        onPageChange={setCurrentPage}
                    />
                </div>
            )}
            
            {selectedAlert && (
                <AlertDetailModal 
                    alert={selectedAlert}
                    onClose={() => setSelectedAlert(null)}
                    onResolve={handleResolve}
                    getPriorityColor={getPriorityColor}
                />
            )}
        </div>
    );
}
      // ==================== COMPLETE REPORTS VIEW - FULL PRODUCTION VERSION ====================

function ReportsView({ user }) {
    // ========== STATE MANAGEMENT ==========
    const [reportMode, setReportMode] = useState('templates');
    const [selectedTemplate, setSelectedTemplate] = useState('overview');
    const [startDate, setStartDate] = useState(() => {
        const date = new Date();
        date.setMonth(date.getMonth() - 1);
        return date.toISOString().split('T')[0];
    });
    const [endDate, setEndDate] = useState(() => new Date().toISOString().split('T')[0]);
    const [reportData, setReportData] = useState(null);
    const [loading, setLoading] = useState(false);
    const [showAnalytics, setShowAnalytics] = useState(false);
    const [analyticsData, setAnalyticsData] = useState(null);
    const [selectedPIRForReport, setSelectedPIRForReport] = useState(null);
    const [allPIRs, setAllPIRs] = useState([]);
    const [allCheckIns, setAllCheckIns] = useState([]);
   const [sendingWeekly, setSendingWeekly] = useState(false);
    const [sendingMonthly, setSendingMonthly] = useState(false);
    
    // ========== NEW: AUTOMATION CONFIGURATION STATE ==========
    const [selectedReports, setSelectedReports] = useState({
        morningCheckins: true,
        eveningReflections: true,
        moodAnalysis: true,
        overview: false,
        sobriety: false,
        engagement: false,
        milestones: false,
        crisis: false,
        communication: false,
        predictive: false
    });
    
    const [automationEnabled, setAutomationEnabled] = useState(true);
    
    const [scheduleConfig, setScheduleConfig] = useState({
        weekly: {
            day: 1, // Monday = 1
            time: '08:00'
        },
        monthly: {
            day: 2, // 2nd of month
            time: '08:00'
        }
    });
    
    const [lastRunStatus, setLastRunStatus] = useState({
        weekly: null,
        monthly: null
    });
    
    const [customConfig, setCustomConfig] = useState({
        selectedPIRs: [],
        selectedMetrics: {
            mood: true,
            cravings: true,
            anxiety: true,
            sleep: true,
            gratitude: false,
            challenges: false,
            goals: false
        },
        selectedCharts: {
            moodVsCravings: true,
            anxietyVsSleep: true,
            trends: true,
            distribution: true,
            patternAnalysis: true
        },
        includeTables: true,
        includePatterns: true,
        includeSummary: true
    });

   // ========== CHART REFERENCES ==========
const chartRefs = {
    moodTrend: useRef(null),
    cravingTrend: useRef(null),
    anxietyTrend: useRef(null),
    sleepTrend: useRef(null),
    moodVsCravings: useRef(null),
    anxietyVsSleep: useRef(null),
    moodDistribution: useRef(null),
    riskDistribution: useRef(null),
    complianceChart: useRef(null),
    engagementChart: useRef(null),
    sobrietyVsCravings: useRef(null),
    goalCompletion: useRef(null),
    overallDayTrend: useRef(null),
    dayQualityPie: useRef(null),
    completionBar: useRef(null)
};
const chartInstances = useRef({});
    // ========== REPORT TEMPLATES ==========
    const REPORT_TEMPLATES = {
        overview: {
            name: 'Program Overview',
            icon: '📊',
            desc: 'Complete program statistics and trends',
            color: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)'
        },
        sobriety: {
            name: 'Sobriety Analysis',
            icon: '🎯',
            desc: 'Sobriety tracking and risk assessment',
            color: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)'
        },
        morningCheckins: {
            name: 'Morning Check-ins',
            icon: '🌅',
            desc: 'Morning mood and craving analysis',
            color: 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)'
        },
        eveningReflections: {
            name: 'Evening Reflections',
            icon: '🌙',
            desc: 'Daily reflections and gratitude',
            color: 'linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%)'
        },
        fullPIR: {
            name: 'Full PIR Report',
            icon: '📋',
            desc: 'Comprehensive individual analysis',
            color: 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)'
        },
        moodAnalysis: {
            name: 'Mood Analysis',
            icon: '😊',
            desc: 'Detailed mood patterns and trends',
            color: 'linear-gradient(135deg, #00BCD4 0%, #0097A7 100%)'
        },
        crisis: {
            name: 'Crisis & Intervention',
            icon: '🚨',
            desc: 'SOS alerts and emergency response',
            color: 'linear-gradient(135deg, #f44336 0%, #B01030 100%)'
        },
        engagement: {
            name: 'Engagement Report',
            icon: '📈',
            desc: 'PIR engagement and participation',
            color: 'linear-gradient(135deg, #FF5722 0%, #E64A19 100%)'
        },
        comparative: {
            name: 'Comparative Analysis',
            icon: '⚖️',
            desc: 'Compare PIR vs program averages',
            color: 'linear-gradient(135deg, #795548 0%, #5D4037 100%)'
        },
        milestones: {
            name: 'Milestones & Achievements',
            icon: '🏆',
            desc: 'Goals and milestone tracking',
            color: 'linear-gradient(135deg, #FFC107 0%, #FFA000 100%)'
        },
        communication: {
            name: 'Communication Report',
            icon: '💬',
            desc: 'Message activity and engagement',
            color: 'linear-gradient(135deg, #607D8B 0%, #455A64 100%)'
        },
        predictive: {
            name: 'Predictive Risk',
            icon: '⚠️',
            desc: 'Risk prediction and early warnings',
            color: 'linear-gradient(135deg, #E91E63 0%, #C2185B 100%)'
        }
    };

    // ========== INITIALIZATION ==========
   useEffect(() => {
        loadPIRsList();
        loadAllCheckIns();
        return () => {
            Object.values(chartInstances.current).forEach(chart => {
                if (chart) chart.destroy();
            });
        };
    }, []);

    // ========== NEW: LOAD AUTOMATION CONFIG ON MOUNT ==========
    useEffect(() => {
        loadAutomationConfig();
    }, []);
   

    useEffect(() => {
        if (reportData && reportData.charts) {
            setTimeout(() => renderCharts(), 150);
        }
    }, [reportData]);

    useEffect(() => {
        if (allCheckIns.length > 0) {
            calculateAnalytics();
        }
    }, [allCheckIns]);

    const loadPIRsList = async () => {
        try {
            const pirsSnap = await db.collection('users')
                .where('role', '==', 'pir')
                .get();
            
            setAllPIRs(pirsSnap.docs.map(doc => ({
                id: doc.id,
                name: doc.data().displayName || doc.data().email
            })));
        } catch (error) {
            console.error('Error loading PIRs:', error);
        }
    };

    const loadAllCheckIns = async () => {
        try {
            const checkInsSnap = await db.collection('checkIns')
                .orderBy('createdAt', 'desc')
                .limit(1000)
                .get();
            
            const checkInsData = [];
            const usersCache = {};
            
            for (const doc of checkInsSnap.docs) {
                const checkIn = { id: doc.id, ...doc.data() };
                
                if (!usersCache[checkIn.userId]) {
                    const userDoc = await db.collection('users').doc(checkIn.userId).get();
                    usersCache[checkIn.userId] = userDoc.data()?.displayName || userDoc.data()?.email || 'Unknown';
                }
                
                checkIn.userName = usersCache[checkIn.userId];
                checkInsData.push(checkIn);
            }
            
            setAllCheckIns(checkInsData);
        } catch (error) {
            console.error('Error loading check-ins:', error);
        }
    };
// ==========================================
// WORKING GOOGLE TOKEN REFRESH (INSIDE COMPONENT)
// ==========================================
const refreshGoogleToken = async () => {
    return new Promise((resolve, reject) => {
        try {
            console.log('🔄 Attempting to refresh Google token...');
            
            // Check if Google Identity Services is loaded
            if (typeof google === 'undefined' || !google.accounts) {
                reject(new Error('Google Identity Services not loaded'));
                return;
            }
            
            // Use token client to get new token silently
            const tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: '457406864879-k1sunucuqofe22m5rg93hvo6nngiqh0u.apps.googleusercontent.com',
                scope: [
                    'https://www.googleapis.com/auth/calendar.events',
                    'https://www.googleapis.com/auth/drive.file'
                ].join(' '),
                callback: async (tokenResponse) => {
                    try {
                        if (tokenResponse.error) {
                            reject(new Error(tokenResponse.error));
                            return;
                        }
                        
                        if (tokenResponse.access_token) {
                            // Update Firebase with new token
                            await db.collection('users').doc(user.uid).update({
                                googleAccessToken: tokenResponse.access_token,
                                googleTokenExpiry: Date.now() + (tokenResponse.expires_in * 1000),
                                googleTokenRefreshedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            // Update local user object
                            user.googleAccessToken = tokenResponse.access_token;
                            user.googleTokenExpiry = Date.now() + (tokenResponse.expires_in * 1000);
                            
                            console.log('✅ Token refreshed successfully');
                            resolve(tokenResponse.access_token);
                        } else {
                            reject(new Error('No access token received'));
                        }
                    } catch (error) {
                        reject(error);
                    }
                },
            });
            
            // Request new token silently (no popup unless necessary)
            tokenClient.requestAccessToken({ prompt: '' });
            
        } catch (error) {
            console.error('❌ Failed to refresh token:', error);
            reject(error);
        }
    });
};

// ==========================================
// CHECK & AUTO-REFRESH GOOGLE TOKEN (INSIDE COMPONENT)
// ==========================================
const checkAndRefreshGoogleToken = async () => {
    try {
        // Check if user has Google connected
        if (!user.googleConnected || !user.googleAccessToken) {
            throw new Error('Google Services not connected. Please connect Google in your Profile settings.');
        }
        
        // Check if token is expired or about to expire
        if (user.googleTokenExpiry) {
            const now = Date.now();
            const expiryTime = user.googleTokenExpiry;
            const fiveMinutes = 5 * 60 * 1000;
            
            if (now >= expiryTime - fiveMinutes) {
                console.log('⚠️ Token expired, refreshing...');
                await refreshGoogleToken();
            }
        }
        
        console.log('✅ Token validated');
        return user.googleAccessToken;
        
    } catch (error) {
        console.error('❌ Token validation failed:', error);
        throw new Error('Google token invalid. Please reconnect Google in Profile settings.');
    }
};
   // ==========================================
// AUTOMATION CONFIGURATION MANAGEMENT
// ==========================================

// ========== SAVE AUTOMATION CONFIG TO FIREBASE ==========
const saveAutomationConfig = async () => {
    try {
        console.log('💾 Saving automation configuration...');
        
        await db.collection('automationConfig').doc(user.uid).set({
            userId: user.uid,
            enabled: automationEnabled,
            selectedReports,
            schedule: scheduleConfig,
            lastRunStatus,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('✅ Automation configuration saved');
        alert('✅ Configuration saved successfully!');
        
    } catch (error) {
        console.error('❌ Error saving automation config:', error);
        alert('❌ Failed to save configuration. Check console for details.');
    }
};

// ========== LOAD AUTOMATION CONFIG FROM FIREBASE ==========
const loadAutomationConfig = async () => {
    try {
        console.log('📥 Loading automation configuration...');
        
        const configDoc = await db.collection('automationConfig').doc(user.uid).get();
        
        if (configDoc.exists) {
            const config = configDoc.data();
            
            setAutomationEnabled(config.enabled ?? true);
            setSelectedReports(config.selectedReports ?? {
                morningCheckins: true,
                eveningReflections: true,
                moodAnalysis: true,
                overview: false,
                sobriety: false,
                engagement: false,
                milestones: false,
                crisis: false,
                communication: false,
                predictive: false
            });
            setScheduleConfig(config.schedule ?? {
                weekly: { day: 1, time: '08:00' },
                monthly: { day: 2, time: '08:00' }
            });
            setLastRunStatus(config.lastRunStatus ?? {
                weekly: null,
                monthly: null
            });
            
            console.log('✅ Automation configuration loaded');
        } else {
            console.log('ℹ️ No saved configuration found, using defaults');
        }
        
    } catch (error) {
        console.error('❌ Error loading automation config:', error);
    }
};

// ========== TEST WEEKLY REPORTS (SEND TO ALL PIRS) ==========
const testWeeklyReports = async () => {
    if (!confirm('🧪 TEST MODE: Send weekly reports to ALL active PIRs right now?\n\nThis uses the currently selected reports.')) {
        return;
    }
    
    try {
        setSendingWeekly(true);
        await sendAllWeeklyReports();
    } catch (error) {
        console.error('❌ Error testing weekly reports:', error);
        alert(`❌ Error: ${error.message}`);
    } finally {
        setSendingWeekly(false);
    }
};

// ========== TEST MONTHLY REPORTS (SEND TO ALL PIRS) ==========
const testMonthlyReports = async () => {
    if (!confirm('🧪 TEST MODE: Send monthly reports to ALL active PIRs right now?\n\nThis uses the currently selected reports.')) {
        return;
    }
    
    try {
        setSendingMonthly(true);
        await sendAllMonthlyReports();
    } catch (error) {
        console.error('❌ Error testing monthly reports:', error);
        alert(`❌ Error: ${error.message}`);
    } finally {
        setSendingMonthly(false);
    }
};

// ========== CONSTANTS ==========
const GLRS_MAIN_FOLDER_ID = '1Nuem8Nw8a3LxkVya0U3GcV6nwmdp3VCw';
const GLRS_LOGO_BASE64 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEu0lEQVR4nO2ZW2wUVRzGv5mdmd3Z7rbbXbe7pbQtpRRKS0sRKBcRUB4UH4zRxBuJMSZqfPBBTXzwwQcTE40vvhhj4oMxMcYHE2OMiTHGGBNjjIkxxhgTY4yJMcYYY2L8zjkz252d2Z3tbktL0ZN8yc7MmXP+3/87l9kBHnjggQceeOD/Dco0KKVUSimlUkqplFIqpZRKKaVSSqmUUiqllEoppVRKKZVSSqmUUiqllEoppVRKKZVSSqmUUiqllEoppVRKKZVSSqmUUiqllEoppVRKKZVSSqn/r1JKqZRSKqWUSilVSimVUkqllFIppVRKKZVSSqmUUiqllEoppVRKKZVSSqmUUiqllEoppVRKKZVSSqmUUiqllEoppVRKKZVSSqmUUiqllEoppZRSKqWUSv2/lVJKpZRSKaVUSqmUUiqllFIppVRKKZVSSqmUUiqllEoppVRKKZVSSqmUUiqllEoplVJKpZRSKaVUSqmUUkqllFIppVRKqZRSKqWUSqmUUiqllFIppf7fSimlUkqplFIqpZRKKaVSSqmUUiqllEoplVJKpZRKKaVSSqmUUiqllEoplVJKpZRSKaVUSqmUUkqllFIppVRKqZRSKqWUSqmUUiqllFIppf7fSimlUkqplFIqpZRKKaVSSqmUUiqllEoplVJKpZRKKaVSSqmUUiqllEoplVJKpZRSKaVUSqmUUkqllFIppVRKqZRSKqWUSqmUUiqllFIppf7fSimlUkqplFIqpZRKKaVSSqmUUiqllEoplVJKpZRKKaVSSqmUUiqllEoplVJKpZRSKaVUSqmUUkqllFIppVRKqZRSKqWUSqmUUiqllFIppf7fSimlUkqplFIqpZRKKaVSSqmUUiqllEoplVJKpZRKKaVSSqmUUiqllEoplVJKpZRSKaVUSqmUUkqllFIppVRKqZRSKqWUSqmUUiqllFIppf7/6k+xKg0Q8QAAAABJRU5ErkJggg==";

// ========== AVAILABLE REPORTS CONFIGURATION ==========
const AVAILABLE_REPORTS = {
    morningCheckins: {
        name: 'Morning Check-ins',
        generator: null, // Will be set to function reference
        key: 'morningCheckins',
        icon: '🌅',
        description: 'Daily morning mood, cravings, anxiety, and sleep quality'
    },
    eveningReflections: {
        name: 'Evening Reflections',
        generator: null,
        key: 'eveningReflections',
        icon: '🌙',
        description: 'Daily reflections, gratitude, and challenges'
    },
    moodAnalysis: {
        name: 'Mood Analysis',
        generator: null,
        key: 'moodAnalysis',
        icon: '😊',
        description: 'Detailed mood patterns and distribution'
    },
    overview: {
        name: 'Overview Report',
        generator: null,
        key: 'overview',
        icon: '📊',
        description: 'Comprehensive progress statistics'
    },
    sobriety: {
        name: 'Sobriety Analysis',
        generator: null,
        key: 'sobriety',
        icon: '🎯',
        description: 'Sobriety tracking and risk assessment'
    },
    engagement: {
        name: 'Engagement Report',
        generator: null,
        key: 'engagement',
        icon: '📈',
        description: 'Participation and activity metrics'
    },
    milestones: {
        name: 'Milestones & Achievements',
        generator: null,
        key: 'milestones',
        icon: '🏆',
        description: 'Goals completed and milestones reached'
    },
    crisis: {
        name: 'Crisis & Interventions',
        generator: null,
        key: 'crisis',
        icon: '🚨',
        description: 'SOS alerts and emergency responses'
    },
    communication: {
        name: 'Communication Activity',
        generator: null,
        key: 'communication',
        icon: '💬',
        description: 'Message activity and engagement'
    },
    predictive: {
        name: 'Predictive Risk',
        generator: null,
        key: 'predictive',
        icon: '⚠️',
        description: 'Risk prediction and early warnings'
    }
};
// ========== GOOGLE DRIVE FOLDER MANAGEMENT ==========
const getOrCreatePIRFolder = async (pirName, accessToken) => {
    try {
        console.log(`📁 Looking for folder: ${pirName}`);
        
        const searchResponse = await fetch(
            `https://www.googleapis.com/drive/v3/files?q=name='${pirName}' and '${GLRS_MAIN_FOLDER_ID}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
            {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            }
        );
        
        const searchData = await searchResponse.json();
        
        if (searchData.files && searchData.files.length > 0) {
            console.log(`✅ Found existing PIR folder: ${searchData.files[0].id}`);
            return searchData.files[0].id;
        }
        
        console.log(`📁 Creating new PIR folder: ${pirName}`);
        const createResponse = await fetch(
            'https://www.googleapis.com/drive/v3/files',
            {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: pirName,
                    mimeType: 'application/vnd.google-apps.folder',
                    parents: [GLRS_MAIN_FOLDER_ID]
                })
            }
        );
        
        const createData = await createResponse.json();
        console.log(`✅ Created PIR folder: ${createData.id}`);
        return createData.id;
        
    } catch (error) {
        console.error('❌ Error managing PIR folder:', error);
        throw error;
    }
};

const getOrCreateReportTypeFolder = async (pirFolderId, reportType, accessToken) => {
    try {
        const folderName = reportType === 'weekly' ? 'Weekly Reports' : 'Monthly Reports';
        console.log(`📁 Looking for ${folderName} folder...`);
        
        const searchResponse = await fetch(
            `https://www.googleapis.com/drive/v3/files?q=name='${folderName}' and '${pirFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
            {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            }
        );
        
        const searchData = await searchResponse.json();
        
        if (searchData.files && searchData.files.length > 0) {
            console.log(`✅ Found existing ${folderName} folder: ${searchData.files[0].id}`);
            return searchData.files[0].id;
        }
        
        console.log(`📁 Creating ${folderName} folder...`);
        const createResponse = await fetch(
            'https://www.googleapis.com/drive/v3/files',
            {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: folderName,
                    mimeType: 'application/vnd.google-apps.folder',
                    parents: [pirFolderId]
                })
            }
        );
        
        const createData = await createResponse.json();
        console.log(`✅ Created ${folderName} folder: ${createData.id}`);
        return createData.id;
        
    } catch (error) {
        console.error(`❌ Error managing report type folder:`, error);
        throw error;
    }
};

// ========== UPLOAD PDF TO GOOGLE DRIVE ==========
const uploadPDFToDrive = async (pdfBlob, fileName, pirName, reportType, accessToken) => {
    try {
        console.log(`📤 Uploading ${fileName} to Google Drive...`);
        
        const pirFolderId = await getOrCreatePIRFolder(pirName, accessToken);
        const reportFolderId = await getOrCreateReportTypeFolder(pirFolderId, reportType, accessToken);
        
        const metadata = {
            name: fileName,
            mimeType: 'application/pdf',
            parents: [reportFolderId]
        };
        
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', pdfBlob);
        
        const uploadResponse = await fetch(
            'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink',
            {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${accessToken}` },
                body: form
            }
        );
        
        if (!uploadResponse.ok) {
            const errorText = await uploadResponse.text();
            throw new Error(`Upload failed: ${errorText}`);
        }
        
        const fileData = await uploadResponse.json();
        console.log(`✅ Uploaded to Drive: ${fileData.id}`);
        
        await fetch(
            `https://www.googleapis.com/drive/v3/files/${fileData.id}/permissions`,
            {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    role: 'reader',
                    type: 'anyone'
                })
            }
        );
        
        console.log(`✅ Made shareable: ${fileData.webViewLink}`);
        
        return {
            fileId: fileData.id,
            webViewLink: fileData.webViewLink
        };
        
    } catch (error) {
        console.error('❌ Error uploading to Drive:', error);
        throw error;
    }
};

// ========== GENERATE PDF FROM REPORT DATA ==========
const generatePDFFromReport = async (reportData, reportTitle, pirName, coachName, dateRange) => {
    try {
        console.log(`📄 Generating PDF: ${reportTitle}...`);
        
        const container = document.createElement('div');
        container.style.position = 'absolute';
        container.style.left = '-9999px';
        container.style.width = '800px';
        document.body.appendChild(container);
        
        // ✅ FIXED: No full HTML document wrapper, just content
        container.innerHTML = `
            <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body { 
                    font-family: 'Segoe UI', Arial, sans-serif;
                    color: #2c3e50;
                    padding: 40px;
                    line-height: 1.6;
                }
                .header {
                    text-align: center;
                    border-bottom: 3px solid #0077CC;
                    padding-bottom: 20px;
                    margin-bottom: 30px;
                }
                .header h1 {
                    color: #0077CC;
                    font-size: 28px;
                    margin-bottom: 10px;
                }
                .header p {
                    color: #666;
                    font-size: 14px;
                    margin: 5px 0;
                }
                .summary-grid {
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    gap: 15px;
                    margin: 30px 0;
                }
                .summary-card {
                    background: #f8f9fa;
                    padding: 15px;
                    border-left: 4px solid #0077CC;
                    border-radius: 6px;
                }
                .summary-card .label {
                    font-size: 11px;
                    color: #666;
                    text-transform: uppercase;
                    margin-bottom: 5px;
                }
                .summary-card .value {
                    font-size: 24px;
                    color: #0077CC;
                    font-weight: bold;
                }
                .section {
                    margin: 25px 0;
                    page-break-inside: avoid;
                }
                .section-title {
                    color: #0077CC;
                    font-size: 18px;
                    border-bottom: 2px solid #0077CC;
                    padding-bottom: 8px;
                    margin-bottom: 15px;
                }
                .insights-list {
                    list-style: none;
                    margin: 15px 0;
                }
                .insights-list li {
                    background: #e3f2fd;
                    padding: 12px;
                    margin: 8px 0;
                    border-left: 4px solid #0077CC;
                    border-radius: 4px;
                    font-size: 13px;
                }
                .data-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 20px 0;
                    font-size: 12px;
                }
                .data-table th {
                    background: #0077CC;
                    color: white;
                    padding: 10px;
                    text-align: left;
                    font-weight: 600;
                }
                .data-table td {
                    padding: 8px 10px;
                    border-bottom: 1px solid #e0e0e0;
                }
                .data-table tr:nth-child(even) {
                    background: #f8f9fa;
                }
                .pattern-box {
                    background: #fff3cd;
                    border-left: 4px solid #ffc107;
                    padding: 12px;
                    margin: 10px 0;
                    border-radius: 4px;
                    font-size: 13px;
                }
                .footer {
                    margin-top: 40px;
                    padding-top: 20px;
                    border-top: 2px solid #e0e0e0;
                    text-align: center;
                    font-size: 11px;
                    color: #999;
                }
            </style>

            <div class="header">
                <h1>${reportTitle}</h1>
                <p><strong>${pirName}</strong></p>
                <p>Coach: ${coachName}</p>
                <p>Period: ${dateRange}</p>
                <p>Generated: ${new Date().toLocaleDateString('en-US')}</p>
            </div>

            ${reportData.summary ? `
                <div class="section">
                    <h2 class="section-title">Summary Statistics</h2>
                    <div class="summary-grid">
                        ${Object.entries(reportData.summary).slice(0, 9).map(([key, value]) => `
                            <div class="summary-card">
                                <div class="label">${key.replace(/([A-Z])/g, ' $1').trim()}</div>
                                <div class="value">${value}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}

            ${reportData.insights && reportData.insights.length > 0 ? `
                <div class="section">
                    <h2 class="section-title">Key Insights</h2>
                    <ul class="insights-list">
                        ${reportData.insights.map(insight => `<li>${insight}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}

            ${reportData.patterns && reportData.patterns.length > 0 ? `
                <div class="section">
                    <h2 class="section-title">Detected Patterns</h2>
                    ${reportData.patterns.map(pattern => `
                        <div class="pattern-box">
                            ${pattern.message || pattern}
                        </div>
                    `).join('')}
                </div>
            ` : ''}

            ${reportData.morningData && reportData.morningData.length > 0 ? `
                <div class="section">
                    <h2 class="section-title">Morning Check-in Details</h2>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Mood</th>
                                <th>Craving</th>
                                <th>Anxiety</th>
                                <th>Sleep</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reportData.morningData.slice(0, 20).map(m => {
                                const date = m.date?.toDate ? m.date.toDate() : new Date(m.date);
                                return `
                                    <tr>
                                        <td>${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</td>
                                        <td>${m.mood || 'N/A'}/10</td>
                                        <td>${m.craving || 'N/A'}/10</td>
                                        <td>${m.anxiety || 'N/A'}/10</td>
                                        <td>${m.sleep || 'N/A'}/10</td>
                                        <td>${(m.notes || '').substring(0, 30)}${m.notes && m.notes.length > 30 ? '...' : ''}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            ` : ''}

            ${reportData.eveningData && reportData.eveningData.length > 0 ? `
                <div class="section">
                    <h2 class="section-title">Evening Reflection Details</h2>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Overall Day</th>
                                <th>Gratitude</th>
                                <th>Challenges</th>
                                <th>Tomorrow Goal</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reportData.eveningData.slice(0, 20).map(e => {
                                const date = e.date?.toDate ? e.date.toDate() : new Date(e.date);
                                return `
                                    <tr>
                                        <td>${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</td>
                                        <td>${e.overallDay || 'N/A'}/10</td>
                                        <td>${(e.gratitude || '').substring(0, 30)}${e.gratitude && e.gratitude.length > 30 ? '...' : ''}</td>
                                        <td>${(e.challenges || '').substring(0, 30)}${e.challenges && e.challenges.length > 30 ? '...' : ''}</td>
                                        <td>${(e.tomorrowGoal || '').substring(0, 30)}${e.tomorrowGoal && e.tomorrowGoal.length > 30 ? '...' : ''}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            ` : ''}

            ${reportData.sobrietyData && reportData.sobrietyData.length > 0 ? `
                <div class="section">
                    <h2 class="section-title">Sobriety Analysis</h2>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>PIR Name</th>
                                <th>Days Sober</th>
                                <th>Avg Mood</th>
                                <th>Avg Cravings</th>
                                <th>Risk Level</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reportData.sobrietyData.slice(0, 20).map(s => `
                                <tr>
                                    <td>${s.pirName}</td>
                                    <td>${s.daysSober} days</td>
                                    <td>${s.avgMood}/10</td>
                                    <td>${s.avgCravings}/10</td>
                                    <td>${s.riskLevel}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            ` : ''}

            ${reportData.engagementData && reportData.engagementData.length > 0 ? `
                <div class="section">
                    <h2 class="section-title">Engagement Details</h2>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>PIR Name</th>
                                <th>Check-ins</th>
                                <th>Streak</th>
                                <th>Assignments</th>
                                <th>Completion %</th>
                                <th>Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reportData.engagementData.slice(0, 20).map(e => `
                                <tr>
                                    <td>${e.pirName}</td>
                                    <td>${e.checkInCount}</td>
                                    <td>${e.checkInStreak} days</td>
                                    <td>${e.assignmentCount}</td>
                                    <td>${e.assignmentCompletion}%</td>
                                    <td>${e.engagementScore}/100</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            ` : ''}

            ${reportData.achievements && reportData.achievements.length > 0 ? `
                <div class="section">
                    <h2 class="section-title">Achievements & Milestones</h2>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>PIR Name</th>
                                <th>Type</th>
                                <th>Achievement</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reportData.achievements.slice(0, 20).map(a => {
                                const date = a.completedAt?.toDate ? a.completedAt.toDate() : new Date(a.completedAt);
                                return `
                                    <tr>
                                        <td>${a.pirName}</td>
                                        <td>${a.type}</td>
                                        <td>${a.title}</td>
                                        <td>${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            ` : ''}

            ${reportData.riskData && reportData.riskData.length > 0 ? `
                <div class="section">
                    <h2 class="section-title">Risk Assessment</h2>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>PIR Name</th>
                                <th>Risk Score</th>
                                <th>Risk Level</th>
                                <th>Detected Patterns</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reportData.riskData.slice(0, 20).map(r => `
                                <tr>
                                    <td>${r.pirName}</td>
                                    <td>${r.riskScore}/10</td>
                                    <td>${r.riskLevel}</td>
                                    <td>${r.patterns.join(', ')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            ` : ''}

            <div class="footer">
                <p><strong>Guiding Light Recovery Services</strong></p>
                <p>Confidential Recovery Report - For Professional Use Only</p>
                <p>www.glrecoveryservices.com</p>
            </div>
        `;
        
        const opt = {
            margin: 10,
            filename: `${reportTitle}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        
        const pdfBlob = await html2pdf().set(opt).from(container).outputPdf('blob');
        
        document.body.removeChild(container);
        
        console.log(`✅ PDF generated: ${reportTitle}`);
        return pdfBlob;
        
    } catch (error) {
        console.error('❌ Error generating PDF:', error);
        throw error;
    }
};

// ========== EMAIL TEMPLATE WITH DYNAMIC DRIVE LINKS ==========
const getEmailTemplateWithDynamicLinks = (pirName, reportType, dateRange, driveLinks) => {
    return `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
        </head>
        <body style="margin: 0; padding: 0; font-family: Arial, sans-serif; background-color: #f5f5f5;">
            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f5f5f5; padding: 20px 0;">
                <tr>
                    <td align="center">
                        <table width="600" cellpadding="0" cellspacing="0" style="background-color: #ffffff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <tr>
                                <td style="padding: 40px 30px;">
                                    <p style="margin: 0 0 20px 0; font-size: 16px; color: #333;">
                                        Hi ${pirName},
                                    </p>
                                    <p style="margin: 0 0 30px 0; font-size: 14px; color: #666; line-height: 1.6;">
                                        Your ${reportType} progress reports for ${dateRange} are ready! 📊
                                    </p>
                                    
                                    <h3 style="margin: 0 0 20px 0; font-size: 16px; color: #0077CC;">📄 YOUR REPORTS:</h3>
                                    
                                    ${driveLinks.map(link => `
                                        <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #0077CC;">
                                            <div style="font-weight: 600; color: #333; margin-bottom: 8px;">${link.title}</div>
                                            <a href="${link.url}" target="_blank" style="color: #0077CC; text-decoration: none; font-size: 14px;">
                                                📂 View in Google Drive →
                                            </a>
                                        </div>
                                    `).join('')}
                                    
                                    <p style="margin: 30px 0 0 0; font-size: 13px; color: #999;">
                                        Click any link to view, download, or print your reports.
                                    </p>
                                    
                                    <p style="margin: 30px 0 0 0; font-size: 14px; color: #666;">
                                        Best regards,<br>
                                        <strong>Guiding Light Recovery Services</strong>
                                    </p>
                                </td>
                            </tr>
                            <tr>
                                <td style="background-color: #f9f9f9; padding: 20px 30px; text-align: center; border-top: 1px solid #e0e0e0;">
                                    <p style="margin: 0 0 10px 0; font-size: 13px; color: #666;">
                                        <a href="https://www.glrecoveryservices.com" style="color: #0077CC; text-decoration: none;">www.glrecoveryservices.com</a>
                                    </p>
                                    <p style="margin: 0; font-size: 12px; color: #999;">
                                        © 2024 Guiding Light Recovery Services. All Rights Reserved.
                                    </p>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>
        </body>
        </html>
    `;
};
// ========== SEND WEEKLY PROGRESS REPORTS (DYNAMIC BASED ON SELECTED REPORTS) ==========
const sendWeeklyProgressReport = async (pirId) => {
    try {
        console.log(`📧 Generating weekly reports for PIR: ${pirId}`);
        
        // ✅ Check & refresh token before using
        await checkAndRefreshGoogleToken();
        console.log('✅ Token validated, proceeding with weekly reports...');
        
        const pirDoc = await db.collection('users').doc(pirId).get();
        if (!pirDoc.exists) {
            throw new Error('PIR not found');
        }
        const pirData = pirDoc.data();
        
        let coachName = 'Your Recovery Coach';
        if (pirData.assignedCoach) {
            const coachDoc = await db.collection('users').doc(pirData.assignedCoach).get();
            if (coachDoc.exists) {
                coachName = coachDoc.data().displayName || coachName;
            }
        }
        
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 6);
        
        const dateRange = `${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
        const dateStamp = endDate.toISOString().split('T')[0];
        
        // ✅ DYNAMICALLY BUILD REPORT LIST BASED ON SELECTED REPORTS
        const reportsToGenerate = [];
        const reportTitles = [];
        
        // Set generator functions (they're defined later in the code)
        AVAILABLE_REPORTS.morningCheckins.generator = generateMorningCheckinsReport;
        AVAILABLE_REPORTS.eveningReflections.generator = generateEveningReflectionsReport;
        AVAILABLE_REPORTS.moodAnalysis.generator = generateMoodAnalysisReport;
        AVAILABLE_REPORTS.overview.generator = generateOverviewReport;
        AVAILABLE_REPORTS.sobriety.generator = generateSobrietyReport;
        AVAILABLE_REPORTS.engagement.generator = generateEngagementReport;
        AVAILABLE_REPORTS.milestones.generator = generateMilestonesReport;
        AVAILABLE_REPORTS.crisis.generator = generateCrisisReport;
        AVAILABLE_REPORTS.communication.generator = generateCommunicationReport;
        AVAILABLE_REPORTS.predictive.generator = generatePredictiveReport;
        
        Object.entries(selectedReports).forEach(([key, isSelected]) => {
            if (isSelected && AVAILABLE_REPORTS[key]) {
                reportsToGenerate.push(
                    AVAILABLE_REPORTS[key].generator(startDate, endDate, pirId)
                );
                reportTitles.push(AVAILABLE_REPORTS[key].name);
            }
        });
        
        if (reportsToGenerate.length === 0) {
            throw new Error('No reports selected for weekly emails');
        }
        
        console.log(`📊 Generating ${reportsToGenerate.length} reports...`);
        const reportsData = await Promise.all(reportsToGenerate);
        
        console.log('📄 Creating PDFs and uploading to Google Drive...');
        const driveLinks = [];
        
        for (let i = 0; i < reportsData.length; i++) {
            try {
                console.log(`\n📄 Processing ${i + 1}/${reportsData.length}: ${reportTitles[i]}`);
                
                const pdfBlob = await exportReportToPDFBlob(reportsData[i], reportTitles[i]);
                
                const fileName = `${pirData.displayName || pirData.email}_${reportTitles[i]}_${dateStamp}.pdf`;
                
                const driveFile = await uploadPDFToDrive(
                    pdfBlob,
                    fileName,
                    pirData.displayName || pirData.email,
                    'weekly',
                    user.googleAccessToken
                );
                
                driveLinks.push({
                    title: reportTitles[i],
                    url: driveFile.webViewLink
                });
                
                console.log(`✅ Uploaded: ${reportTitles[i]}`);
                
            } catch (error) {
                console.error(`❌ Failed ${reportTitles[i]}:`, error);
            }
        }
        
        if (driveLinks.length === 0) {
            throw new Error('Failed to generate any reports');
        }
        
        console.log(`📧 Sending email with ${driveLinks.length} Drive links...`);
        
        const emailHtml = getEmailTemplateWithDynamicLinks(
            pirData.displayName || pirData.email,
            'weekly',
            dateRange,
            driveLinks
        );
        
        await db.collection('mail').add({
            to: [pirData.email],
            message: {
                subject: `Weekly Progress Reports - ${dateRange}`,
                html: emailHtml
            }
        });
        
        console.log(`✅ Weekly reports complete: ${driveLinks.length}/${reportsToGenerate.length} sent to ${pirData.email}`);
        return { 
            success: driveLinks.length === reportsToGenerate.length, 
            pirEmail: pirData.email, 
            sentCount: driveLinks.length,
            expectedCount: reportsToGenerate.length
        };
        
    } catch (error) {
        console.error('❌ Error sending weekly reports:', error);
        throw error;
    }
};

// ========== SEND MONTHLY PROGRESS REPORTS (DYNAMIC BASED ON SELECTED REPORTS) ==========
const sendMonthlyProgressReport = async (pirId) => {
    try {
        console.log(`📧 Generating monthly reports for PIR: ${pirId}`);
        
        // ✅ Check & refresh token before using
        await checkAndRefreshGoogleToken();
        console.log('✅ Token validated, proceeding with monthly reports...');
        
        const pirDoc = await db.collection('users').doc(pirId).get();
        if (!pirDoc.exists) {
            throw new Error('PIR not found');
        }
        const pirData = pirDoc.data();
        
        let coachName = 'Your Recovery Coach';
        if (pirData.assignedCoach) {
            const coachDoc = await db.collection('users').doc(pirData.assignedCoach).get();
            if (coachDoc.exists) {
                coachName = coachDoc.data().displayName || coachName;
            }
        }
        
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 29);
        
        const dateRange = startDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        const dateStamp = endDate.toISOString().split('T')[0];
        
        // ✅ DYNAMICALLY BUILD REPORT LIST BASED ON SELECTED REPORTS
        const reportsToGenerate = [];
        const reportTitles = [];
        
        // Set generator functions (they're defined later in the code)
        AVAILABLE_REPORTS.morningCheckins.generator = generateMorningCheckinsReport;
        AVAILABLE_REPORTS.eveningReflections.generator = generateEveningReflectionsReport;
        AVAILABLE_REPORTS.moodAnalysis.generator = generateMoodAnalysisReport;
        AVAILABLE_REPORTS.overview.generator = generateOverviewReport;
        AVAILABLE_REPORTS.sobriety.generator = generateSobrietyReport;
        AVAILABLE_REPORTS.engagement.generator = generateEngagementReport;
        AVAILABLE_REPORTS.milestones.generator = generateMilestonesReport;
        AVAILABLE_REPORTS.crisis.generator = generateCrisisReport;
        AVAILABLE_REPORTS.communication.generator = generateCommunicationReport;
        AVAILABLE_REPORTS.predictive.generator = generatePredictiveReport;
        
        Object.entries(selectedReports).forEach(([key, isSelected]) => {
            if (isSelected && AVAILABLE_REPORTS[key]) {
                reportsToGenerate.push(
                    AVAILABLE_REPORTS[key].generator(startDate, endDate, pirId)
                );
                reportTitles.push(AVAILABLE_REPORTS[key].name);
            }
        });
        
        if (reportsToGenerate.length === 0) {
            throw new Error('No reports selected for monthly emails');
        }
        
        console.log(`📊 Generating ${reportsToGenerate.length} reports...`);
        const reportsData = await Promise.all(reportsToGenerate);
        
        console.log('📄 Creating PDFs and uploading to Google Drive...');
        const driveLinks = [];
        
        for (let i = 0; i < reportsData.length; i++) {
            try {
                console.log(`\n📄 Processing ${i + 1}/${reportsData.length}: ${reportTitles[i]}`);
                
                const pdfBlob = await exportReportToPDFBlob(reportsData[i], reportTitles[i]);
                
                const fileName = `${pirData.displayName || pirData.email}_${reportTitles[i]}_${dateStamp}.pdf`;
                
                const driveFile = await uploadPDFToDrive(
                    pdfBlob,
                    fileName,
                    pirData.displayName || pirData.email,
                    'monthly',
                    user.googleAccessToken
                );
                
                driveLinks.push({
                    title: reportTitles[i],
                    url: driveFile.webViewLink
                });
                
                console.log(`✅ Uploaded: ${reportTitles[i]}`);
                
            } catch (error) {
                console.error(`❌ Failed ${reportTitles[i]}:`, error);
            }
        }
        
        if (driveLinks.length === 0) {
            throw new Error('Failed to generate any reports');
        }
        
        console.log(`📧 Sending email with ${driveLinks.length} Drive links...`);
        
        const emailHtml = getEmailTemplateWithDynamicLinks(
            pirData.displayName || pirData.email,
            'monthly',
            dateRange,
            driveLinks
        );
        
        await db.collection('mail').add({
            to: [pirData.email],
            message: {
                subject: `Monthly Progress Reports - ${dateRange}`,
                html: emailHtml
            }
        });
        
        console.log(`✅ Monthly reports complete: ${driveLinks.length}/${reportsToGenerate.length} sent to ${pirData.email}`);
        return { 
            success: driveLinks.length === reportsToGenerate.length, 
            pirEmail: pirData.email, 
            sentCount: driveLinks.length,
            expectedCount: reportsToGenerate.length
        };
        
    } catch (error) {
        console.error('❌ Error sending monthly reports:', error);
        throw error;
    }
};
// ========== SEND ALL WEEKLY REPORTS ==========
const sendAllWeeklyReports = async () => {
    try {
        // ✅ CHECK IF AUTOMATION IS ENABLED
        if (!automationEnabled) {
            console.log('⚠️ Automation is disabled. Skipping weekly reports.');
            alert('⚠️ Automation is currently disabled. Enable it in the configuration to send reports.');
            return [];
        }
        
        console.log('📧 Sending weekly reports to all PIRs...');
        
        const pirsSnapshot = await db.collection('users')
            .where('role', '==', 'pir')
            .where('active', '==', true)
            .get();
        
        const results = [];
        
        for (const pirDoc of pirsSnapshot.docs) {
            try {
                const result = await sendWeeklyProgressReport(pirDoc.id);
                results.push({ pirId: pirDoc.id, ...result });
            } catch (error) {
                console.error(`Failed to send weekly reports to ${pirDoc.id}:`, error);
                results.push({ pirId: pirDoc.id, success: false, error: error.message });
            }
        }
        
        const successCount = results.filter(r => r.success).length;
        console.log(`✅ Weekly reports sent: ${successCount}/${results.length}`);
        
        // Update last run status
        setLastRunStatus(prev => ({
            ...prev,
            weekly: {
                timestamp: new Date().toISOString(),
                pirCount: results.length,
                successCount,
                success: successCount === results.length
            }
        }));
        
        // Save to Firebase
        await db.collection('automationConfig').doc(user.uid).update({
            'lastRunStatus.weekly': {
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                pirCount: results.length,
                successCount,
                success: successCount === results.length
            }
        });
        
        alert(`✅ Weekly reports sent to ${successCount} out of ${results.length} PIRs`);
        return results;
        
    } catch (error) {
        console.error('❌ Error sending weekly reports:', error);
        alert('Error sending weekly reports. Check console for details.');
        throw error;
    }
};
// ========== SEND ALL MONTHLY REPORTS ==========
const sendAllMonthlyReports = async () => {
    try {
        // ✅ CHECK IF AUTOMATION IS ENABLED
        if (!automationEnabled) {
            console.log('⚠️ Automation is disabled. Skipping monthly reports.');
            alert('⚠️ Automation is currently disabled. Enable it in the configuration to send reports.');
            return [];
        }
        
        console.log('📧 Sending monthly reports to all PIRs...');
        
        const pirsSnapshot = await db.collection('users')
            .where('role', '==', 'pir')
            .where('active', '==', true)
            .get();
        
        const results = [];
        
        for (const pirDoc of pirsSnapshot.docs) {
            try {
                const result = await sendMonthlyProgressReport(pirDoc.id);
                results.push({ pirId: pirDoc.id, ...result });
            } catch (error) {
                console.error(`Failed to send monthly reports to ${pirDoc.id}:`, error);
                results.push({ pirId: pirDoc.id, success: false, error: error.message });
            }
        }
        
        const successCount = results.filter(r => r.success).length;
        console.log(`✅ Monthly reports sent: ${successCount}/${results.length}`);
        
        // Update last run status
        setLastRunStatus(prev => ({
            ...prev,
            monthly: {
                timestamp: new Date().toISOString(),
                pirCount: results.length,
                successCount,
                success: successCount === results.length
            }
        }));
        
        // Save to Firebase
        await db.collection('automationConfig').doc(user.uid).update({
            'lastRunStatus.monthly': {
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                pirCount: results.length,
                successCount,
                success: successCount === results.length
            }
        });
        
        alert(`✅ Monthly reports sent to ${successCount} out of ${results.length} PIRs`);
        return results;
        
    } catch (error) {
        console.error('❌ Error sending monthly reports:', error);
        alert('Error sending monthly reports. Check console for details.');
        throw error;
    }
};
    // ========== UTILITY FUNCTIONS ==========
    const formatDate = (date) => {
        if (!date) return '-';
        const d = date.toDate ? date.toDate() : new Date(date);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    };

    const formatDateTime = (date) => {
        if (!date) return '-';
        const d = date.toDate ? date.toDate() : new Date(date);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' +
               d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    };

    const formatTimeAgo = (date) => {
        if (!date) return '-';
        const d = date.toDate ? date.toDate() : new Date(date);
        const seconds = Math.floor((new Date() - d) / 1000);
        if (seconds < 60) return 'Just now';
        if (seconds < 3600) return Math.floor(seconds / 60) + ' min ago';
        if (seconds < 86400) return Math.floor(seconds / 3600) + ' hr ago';
        return Math.floor(seconds / 86400) + ' days ago';
    };

    const exportToJSON = (data, filename) => {
        const jsonStr = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${filename}_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
    };

    const exportToCSV = (data, filename) => {
        if (!data || data.length === 0) return;
        
        const headers = Object.keys(data[0]);
        const csvContent = [
            headers.join(','),
            ...data.map(row => headers.map(header => {
                const value = row[header]?.toString() || '';
                return value.includes(',') ? `"${value}"` : value;
            }).join(','))
        ].join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
    };

    // ========== ANALYTICS CALCULATION ==========
    const calculateAnalytics = () => {
        const pirStats = {};
        const allPIRsData = {
            totalCheckIns: allCheckIns.length,
            avgMood: 0,
            avgCraving: 0,
            avgAnxiety: 0,
            avgSleep: 0,
            completionRate: 0,
            last30Days: {
                avgMood: 0,
                avgCraving: 0,
                avgAnxiety: 0,
                avgSleep: 0,
                completionRate: 0
            }
        };

        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

        allCheckIns.forEach(checkIn => {
            if (!pirStats[checkIn.userId]) {
                pirStats[checkIn.userId] = {
                    userName: checkIn.userName,
                    userId: checkIn.userId,
                    totalCheckIns: 0,
                    completeCheckIns: 0,
                    moodSum: 0,
                    moodCount: 0,
                    cravingSum: 0,
                    cravingCount: 0,
                    anxietySum: 0,
                    anxietyCount: 0,
                    sleepSum: 0,
                    sleepCount: 0,
                    last30: {
                        totalCheckIns: 0,
                        completeCheckIns: 0,
                        moodSum: 0,
                        moodCount: 0,
                        cravingSum: 0,
                        cravingCount: 0,
                        anxietySum: 0,
                        anxietyCount: 0,
                        sleepSum: 0,
                        sleepCount: 0
                    }
                };
            }

            const stat = pirStats[checkIn.userId];
            const checkInDate = checkIn.createdAt?.toDate ? checkIn.createdAt.toDate() : new Date(checkIn.createdAt);
            const isLast30 = checkInDate >= thirtyDaysAgo;

            stat.totalCheckIns++;
            const hasMorning = checkIn.morningData && Object.keys(checkIn.morningData).length > 0;
            const hasEvening = checkIn.eveningData && Object.keys(checkIn.eveningData).length > 0;
            if (hasMorning && hasEvening) stat.completeCheckIns++;

            if (checkIn.morningData?.mood != null) {
                stat.moodSum += checkIn.morningData.mood;
                stat.moodCount++;
            }
            if (checkIn.morningData?.craving != null) {
                stat.cravingSum += checkIn.morningData.craving;
                stat.cravingCount++;
            }
            if (checkIn.morningData?.anxietyLevel != null) {
                stat.anxietySum += checkIn.morningData.anxietyLevel;
                stat.anxietyCount++;
            }
            if (checkIn.morningData?.sleepQuality != null) {
                stat.sleepSum += checkIn.morningData.sleepQuality;
                stat.sleepCount++;
            }

            if (isLast30) {
                stat.last30.totalCheckIns++;
                if (hasMorning && hasEvening) stat.last30.completeCheckIns++;
                
                if (checkIn.morningData?.mood != null) {
                    stat.last30.moodSum += checkIn.morningData.mood;
                    stat.last30.moodCount++;
                }
                if (checkIn.morningData?.craving != null) {
                    stat.last30.cravingSum += checkIn.morningData.craving;
                    stat.last30.cravingCount++;
                }
                if (checkIn.morningData?.anxietyLevel != null) {
                    stat.last30.anxietySum += checkIn.morningData.anxietyLevel;
                    stat.last30.anxietyCount++;
                }
                if (checkIn.morningData?.sleepQuality != null) {
                    stat.last30.sleepSum += checkIn.morningData.sleepQuality;
                    stat.last30.sleepCount++;
                }
            }
        });

        Object.values(pirStats).forEach(stat => {
            stat.avgMood = stat.moodCount > 0 ? (stat.moodSum / stat.moodCount).toFixed(1) : 'N/A';
            stat.avgCraving = stat.cravingCount > 0 ? (stat.cravingSum / stat.cravingCount).toFixed(1) : 'N/A';
            stat.avgAnxiety = stat.anxietyCount > 0 ? (stat.anxietySum / stat.anxietyCount).toFixed(1) : 'N/A';
            stat.avgSleep = stat.sleepCount > 0 ? (stat.sleepSum / stat.sleepCount).toFixed(1) : 'N/A';
            stat.completionRate = stat.totalCheckIns > 0 ? Math.round((stat.completeCheckIns / stat.totalCheckIns) * 100) : 0;

            stat.last30.avgMood = stat.last30.moodCount > 0 ? (stat.last30.moodSum / stat.last30.moodCount).toFixed(1) : 'N/A';
            stat.last30.avgCraving = stat.last30.cravingCount > 0 ? (stat.last30.cravingSum / stat.last30.cravingCount).toFixed(1) : 'N/A';
            stat.last30.avgAnxiety = stat.last30.anxietyCount > 0 ? (stat.last30.anxietySum / stat.last30.anxietyCount).toFixed(1) : 'N/A';
            stat.last30.avgSleep = stat.last30.sleepCount > 0 ? (stat.last30.sleepSum / stat.last30.sleepCount).toFixed(1) : 'N/A';
            stat.last30.completionRate = stat.last30.totalCheckIns > 0 ? Math.round((stat.last30.completeCheckIns / stat.last30.totalCheckIns) * 100) : 0;
        });

        // Calculate all-PIRs aggregate
        let totalMood = 0, totalCraving = 0, totalAnxiety = 0, totalSleep = 0;
        let moodCount = 0, cravingCount = 0, anxietyCount = 0, sleepCount = 0;
        let completeCount = 0;
        let last30Mood = 0, last30Craving = 0, last30Anxiety = 0, last30Sleep = 0;
        let last30MoodCount = 0, last30CravingCount = 0, last30AnxietyCount = 0, last30SleepCount = 0;
        let last30Complete = 0, last30Total = 0;

        allCheckIns.forEach(checkIn => {
            const checkInDate = checkIn.createdAt?.toDate ? checkIn.createdAt.toDate() : new Date(checkIn.createdAt);
            const isLast30 = checkInDate >= thirtyDaysAgo;

            const hasMorning = checkIn.morningData && Object.keys(checkIn.morningData).length > 0;
            const hasEvening = checkIn.eveningData && Object.keys(checkIn.eveningData).length > 0;
            if (hasMorning && hasEvening) completeCount++;
            
            if (checkIn.morningData?.mood != null) {
                totalMood += checkIn.morningData.mood;
                moodCount++;
            }
            if (checkIn.morningData?.craving != null) {
                totalCraving += checkIn.morningData.craving;
                cravingCount++;
            }
            if (checkIn.morningData?.anxietyLevel != null) {
                totalAnxiety += checkIn.morningData.anxietyLevel;
                anxietyCount++;
            }
            if (checkIn.morningData?.sleepQuality != null) {
                totalSleep += checkIn.morningData.sleepQuality;
                sleepCount++;
            }

            if (isLast30) {
                last30Total++;
                if (hasMorning && hasEvening) last30Complete++;
                
                if (checkIn.morningData?.mood != null) {
                    last30Mood += checkIn.morningData.mood;
                    last30MoodCount++;
                }
                if (checkIn.morningData?.craving != null) {
                    last30Craving += checkIn.morningData.craving;
                    last30CravingCount++;
                }
                if (checkIn.morningData?.anxietyLevel != null) {
                    last30Anxiety += checkIn.morningData.anxietyLevel;
                    last30AnxietyCount++;
                }
                if (checkIn.morningData?.sleepQuality != null) {
                    last30Sleep += checkIn.morningData.sleepQuality;
                    last30SleepCount++;
                }
            }
        });

        allPIRsData.avgMood = moodCount > 0 ? (totalMood / moodCount).toFixed(1) : 'N/A';
        allPIRsData.avgCraving = cravingCount > 0 ? (totalCraving / cravingCount).toFixed(1) : 'N/A';
        allPIRsData.avgAnxiety = anxietyCount > 0 ? (totalAnxiety / anxietyCount).toFixed(1) : 'N/A';
        allPIRsData.avgSleep = sleepCount > 0 ? (totalSleep / sleepCount).toFixed(1) : 'N/A';
        allPIRsData.completionRate = allCheckIns.length > 0 ? Math.round((completeCount / allCheckIns.length) * 100) : 0;

        allPIRsData.last30Days.avgMood = last30MoodCount > 0 ? (last30Mood / last30MoodCount).toFixed(1) : 'N/A';
        allPIRsData.last30Days.avgCraving = last30CravingCount > 0 ? (last30Craving / last30CravingCount).toFixed(1) : 'N/A';
        allPIRsData.last30Days.avgAnxiety = last30AnxietyCount > 0 ? (last30Anxiety / last30AnxietyCount).toFixed(1) : 'N/A';
        allPIRsData.last30Days.avgSleep = last30SleepCount > 0 ? (last30Sleep / last30SleepCount).toFixed(1) : 'N/A';
        allPIRsData.last30Days.completionRate = last30Total > 0 ? Math.round((last30Complete / last30Total) * 100) : 0;

        setAnalyticsData({ pirStats, allPIRsData });
    };

 // ==========================================
// REPORT GENERATOR FUNCTIONS (ALL 12)
// ==========================================

// ========== REPORT GENERATOR 1: OVERVIEW ==========
const generateOverviewReport = async (start, end, pirId = null) => {
    try {
        // ✅ Build queries with optional PIR filter
        let checkInsQuery = db.collection('checkIns')
            .where('createdAt', '>=', start)
            .where('createdAt', '<=', end);
        
        let assignmentsQuery = db.collection('assignments')
            .where('createdAt', '>=', start)
            .where('createdAt', '<=', end);
        
        let alertsQuery = db.collection('alerts')
            .where('createdAt', '>=', start)
            .where('createdAt', '<=', end);
        
        let goalsQuery = db.collection('goals');
        
        if (pirId) {
            checkInsQuery = checkInsQuery.where('userId', '==', pirId);
            assignmentsQuery = assignmentsQuery.where('userId', '==', pirId);
            alertsQuery = alertsQuery.where('userId', '==', pirId);
            goalsQuery = goalsQuery.where('userId', '==', pirId);
        }
        
        const [usersSnap, checkInsSnap, assignmentsSnap, alertsSnap, goalsSnap] = await Promise.all([
            db.collection('users').get(),
            checkInsQuery.get(),
            assignmentsQuery.get(),
            alertsQuery.get(),
            goalsQuery.get()
        ]);
        const pirs = usersSnap.docs.filter(doc => doc.data().role === 'pir');
        const checkIns = checkInsSnap.docs.map(doc => doc.data());

        // Calculate dates and metrics
        const dates = [];
        const moods = [];
        const cravings = [];
        const anxiety = [];
        const sleep = [];
        
        const current = new Date(start);
        while (current <= end) {
            const dayCheckIns = checkIns.filter(c => {
                const date = c.createdAt?.toDate ? c.createdAt.toDate() : new Date(c.createdAt);
                return date.toDateString() === current.toDateString();
            });
            
            dates.push(current.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            
            if (dayCheckIns.length > 0) {
                moods.push(parseFloat((dayCheckIns.reduce((sum, c) => sum + (c.morningData?.mood || 0), 0) / dayCheckIns.length).toFixed(1)));
                cravings.push(parseFloat((dayCheckIns.reduce((sum, c) => sum + (c.morningData?.craving || 0), 0) / dayCheckIns.length).toFixed(1)));
                anxiety.push(parseFloat((dayCheckIns.reduce((sum, c) => sum + (c.morningData?.anxietyLevel || 0), 0) / dayCheckIns.length).toFixed(1)));
                sleep.push(parseFloat((dayCheckIns.reduce((sum, c) => sum + (c.morningData?.sleepQuality || 0), 0) / dayCheckIns.length).toFixed(1)));
            } else {
                moods.push(null);
                cravings.push(null);
                anxiety.push(null);
                sleep.push(null);
            }
            
            current.setDate(current.getDate() + 1);
        }

        const avgMood = checkIns.reduce((sum, c) => sum + (c.morningData?.mood || 0), 0) / checkIns.length || 0;
        const avgCraving = checkIns.reduce((sum, c) => sum + (c.morningData?.craving || 0), 0) / checkIns.length || 0;
        const avgAnxiety = checkIns.reduce((sum, c) => sum + (c.morningData?.anxietyLevel || 0), 0) / checkIns.length || 0;
        const avgSleep = checkIns.reduce((sum, c) => sum + (c.morningData?.sleepQuality || 0), 0) / checkIns.length || 0;

        // Calculate previous period for comparison
        const periodLength = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
        const prevStart = new Date(start);
        prevStart.setDate(prevStart.getDate() - periodLength);
        const prevEnd = new Date(start);
        prevEnd.setDate(prevEnd.getDate() - 1);

        const prevCheckInsSnap = await db.collection('checkIns')
            .where('createdAt', '>=', prevStart)
            .where('createdAt', '<=', prevEnd)
            .get();

        const prevCheckIns = prevCheckInsSnap.docs.map(doc => doc.data());
        const prevAvgMood = prevCheckIns.reduce((sum, c) => sum + (c.morningData?.mood || 0), 0) / prevCheckIns.length || 0;
        const prevAvgCraving = prevCheckIns.reduce((sum, c) => sum + (c.morningData?.craving || 0), 0) / prevCheckIns.length || 0;

        const moodChange = avgMood - prevAvgMood;
        const cravingChange = avgCraving - prevAvgCraving;

        // Generate insights
        const insights = [];
        if (moodChange > 1) insights.push(`🎉 Mood improved ${moodChange.toFixed(1)} points - excellent progress!`);
        else if (moodChange < -1) insights.push(`⚠️ Mood decreased ${Math.abs(moodChange).toFixed(1)} points - reach out for support`);
        
        if (cravingChange < -1) insights.push(`✨ Cravings decreased ${Math.abs(cravingChange).toFixed(1)} points - stay strong!`);
        else if (cravingChange > 1) insights.push(`⚠️ Cravings increased ${cravingChange.toFixed(1)} points - use coping strategies`);
        
        if (avgMood >= 7) insights.push('💚 Overall mood is in a healthy range this period');
        if (avgCraving <= 3) insights.push('🌟 Cravings are well-managed - keep up the great work!');
        if (insights.length === 0) insights.push('📊 Continue building positive momentum in your recovery');

        const completedAssignments = assignmentsSnap.docs.filter(d => d.data().status === 'completed').length;
        const assignmentRate = assignmentsSnap.size > 0 ? ((completedAssignments / assignmentsSnap.size) * 100).toFixed(0) : 0;

        return {
            type: 'overview',
            metadata: {
                title: 'Program Overview Report',
                period: `${start.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} - ${end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`,
                generatedAt: new Date().toLocaleString('en-US'),
                reportType: 'overview'
            },
            summary: {
                totalPIRs: pirs.length,
                activePIRs: pirs.filter(p => p.data().active !== false).length,
                totalCheckIns: checkInsSnap.size,
                avgMood: parseFloat(avgMood.toFixed(1)),
                avgCravings: parseFloat(avgCraving.toFixed(1)),
                avgAnxiety: parseFloat(avgAnxiety.toFixed(1)),
                avgSleep: parseFloat(avgSleep.toFixed(1)),
                totalAssignments: assignmentsSnap.size,
                completedAssignments,
                assignmentRate: parseFloat(assignmentRate),
                totalAlerts: alertsSnap.size,
                sosAlerts: alertsSnap.docs.filter(d => d.data().type === 'sos').length,
                totalGoals: goalsSnap.size,
                completedGoals: goalsSnap.docs.filter(d => d.data().status === 'completed').length,
                moodChange: parseFloat(moodChange.toFixed(1)),
                cravingChange: parseFloat(cravingChange.toFixed(1))
            },
            insights,
            charts: {
                trends: { dates, moods, cravings, anxiety, sleep },
                distribution: calculateMoodDistribution(checkIns)
            },
            patterns: detectPatterns(checkIns)
        };
    } catch (error) {
        console.error('Error generating overview:', error);
        throw error;
    }
};

// ========== REPORT GENERATOR 2: SOBRIETY ==========
const generateSobrietyReport = async (start, end, pirId = null) => {
    // ✅ Build PIR query with optional filter
    let pirsQuery = db.collection('users').where('role', '==', 'pir');
    
    if (pirId) {
        pirsQuery = pirsQuery.where(firebase.firestore.FieldPath.documentId(), '==', pirId);
    }
    
    const pirsSnap = await pirsQuery.get();

    const sobrietyData = [];
    
    for (const pirDoc of pirsSnap.docs) {
        const pirData = pirDoc.data();
        if (!pirData.sobrietyDate) continue;

        const sobrietyDate = new Date(pirData.sobrietyDate);
        const daysSober = Math.floor((new Date() - sobrietyDate) / (1000 * 60 * 60 * 24));
        
        const checkInsSnap = await db.collection('checkIns')
            .where('userId', '==', pirDoc.id)
            .where('createdAt', '>=', start)
            .where('createdAt', '<=', end)
            .get();
       
        const checkIns = checkInsSnap.docs.map(doc => doc.data());
        const avgCravings = checkIns.length > 0 
            ? (checkIns.reduce((sum, c) => sum + (c.morningData?.craving || 0), 0) / checkIns.length).toFixed(1)
            : 0;
        const avgMood = checkIns.length > 0
            ? (checkIns.reduce((sum, c) => sum + (c.morningData?.mood || 0), 0) / checkIns.length).toFixed(1)
            : 0;

        const riskScore = calculateRiskScore(avgMood, avgCravings, daysSober);

        sobrietyData.push({
            pirName: pirData.displayName || pirData.email,
            pirId: pirDoc.id,
            daysSober,
            sobrietyDate: pirData.sobrietyDate,
            avgMood,
            avgCravings,
            riskScore,
            riskLevel: riskScore >= 7 ? 'Critical' : riskScore >= 4 ? 'High' : 'Moderate',
            checkInCount: checkIns.length
        });
    }

    return {
        type: 'sobriety',
        metadata: {
            title: 'Sobriety Analysis Report',
            period: `${start.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} - ${end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`,
            generatedAt: new Date().toLocaleString('en-US'),
            reportType: 'sobriety'
        },
        sobrietyData: sobrietyData.sort((a, b) => b.daysSober - a.daysSober),
        summary: {
            totalPIRs: sobrietyData.length,
            avgDaysSober: (sobrietyData.reduce((sum, p) => sum + p.daysSober, 0) / sobrietyData.length).toFixed(0),
            criticalRisk: sobrietyData.filter(p => p.riskScore >= 7).length,
            highRisk: sobrietyData.filter(p => p.riskScore >= 4 && p.riskScore < 7).length,
            moderateRisk: sobrietyData.filter(p => p.riskScore < 4).length
        },
        charts: {
            riskDistribution: {
                labels: ['Moderate Risk', 'High Risk', 'Critical Risk'],
                data: [
                    sobrietyData.filter(p => p.riskScore < 4).length,
                    sobrietyData.filter(p => p.riskScore >= 4 && p.riskScore < 7).length,
                    sobrietyData.filter(p => p.riskScore >= 7).length
                ]
            },
            sobrietyVsCravings: {
                data: sobrietyData.map(p => ({
                    x: p.daysSober,
                    y: parseFloat(p.avgCravings) || 0
                }))
            }
        }
    };
};

// ========== REPORT GENERATOR 3: MORNING CHECK-INS ==========
const generateMorningCheckinsReport = async (start, end, pirId = null) => {
    try {
        // ✅ Build query with optional PIR filter
        let checkInsQuery = db.collection('checkIns')
            .where('createdAt', '>=', start)
            .where('createdAt', '<=', end);
        
        if (pirId) {
            checkInsQuery = checkInsQuery.where('userId', '==', pirId);
        }
        
        const checkInsSnap = await checkInsQuery.get();

        const morningData = [];
        const checkIns = checkInsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const usersCache = {};
        for (const checkIn of checkIns) {
            if (checkIn.morningData) {
                if (!usersCache[checkIn.userId]) {
                    const userDoc = await db.collection('users').doc(checkIn.userId).get();
                    usersCache[checkIn.userId] = userDoc.exists ? userDoc.data()?.displayName || 'Unknown' : 'Unknown';
                }
                
                morningData.push({
                    pirName: usersCache[checkIn.userId],
                    date: checkIn.createdAt,
                    mood: checkIn.morningData.mood,
                    craving: checkIn.morningData.craving,
                    anxiety: checkIn.morningData.anxietyLevel,
                    sleep: checkIn.morningData.sleepQuality,
                    notes: checkIn.morningData.notes || ''
                });
            }
        }

        // Calculate trends over time
        const dates = [];
        const moods = [];
        const cravings = [];
        const anxiety = [];
        const sleep = [];
        
        const current = new Date(start);
        while (current <= end) {
            const dayData = morningData.filter(m => {
                const date = m.date?.toDate ? m.date.toDate() : new Date(m.date);
                return date.toDateString() === current.toDateString();
            });
            
            dates.push(current.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            
            if (dayData.length > 0) {
                moods.push(parseFloat((dayData.reduce((sum, d) => sum + (d.mood || 0), 0) / dayData.length).toFixed(1)));
                cravings.push(parseFloat((dayData.reduce((sum, d) => sum + (d.craving || 0), 0) / dayData.length).toFixed(1)));
                anxiety.push(parseFloat((dayData.reduce((sum, d) => sum + (d.anxiety || 0), 0) / dayData.length).toFixed(1)));
                sleep.push(parseFloat((dayData.reduce((sum, d) => sum + (d.sleep || 0), 0) / dayData.length).toFixed(1)));
            } else {
                moods.push(null);
                cravings.push(null);
                anxiety.push(null);
                sleep.push(null);
            }
            
            current.setDate(current.getDate() + 1);
        }

        const avgMood = morningData.reduce((sum, c) => sum + (c.mood || 0), 0) / morningData.length || 0;
        const avgCravings = morningData.reduce((sum, c) => sum + (c.craving || 0), 0) / morningData.length || 0;
        const avgAnxiety = morningData.reduce((sum, c) => sum + (c.anxiety || 0), 0) / morningData.length || 0;
        const avgSleep = morningData.reduce((sum, c) => sum + (c.sleep || 0), 0) / morningData.length || 0;
        const withNotes = morningData.filter(m => m.notes && m.notes.length > 0).length;

        const insights = [];
        if (avgMood >= 7) insights.push('💚 Morning mood consistently positive');
        if (avgCravings <= 3) insights.push('🌟 Cravings well-managed in mornings');
        if (avgSleep >= 7) insights.push('😴 Sleep quality is excellent');
        if (withNotes > morningData.length * 0.5) insights.push('📝 Great job adding notes to check-ins');

        return {
            type: 'morningCheckins',
            metadata: {
                title: 'Morning Check-ins Report',
                period: `${start.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} - ${end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`,
                generatedAt: new Date().toLocaleString('en-US'),
                reportType: 'morningCheckins'
            },
            morningData,
            summary: {
                totalCheckIns: morningData.length,
                avgMood: parseFloat(avgMood.toFixed(1)),
                avgCravings: parseFloat(avgCravings.toFixed(1)),
                avgAnxiety: parseFloat(avgAnxiety.toFixed(1)),
                avgSleep: parseFloat(avgSleep.toFixed(1)),
                withNotes
            },
            insights,
            charts: {
                trends: { dates, moods, cravings, anxiety, sleep }
            }
        };
    } catch (error) {
        console.error('Error generating morning check-ins report:', error);
        throw error;
    }
};

// ========== REPORT GENERATOR 4: EVENING REFLECTIONS ==========
const generateEveningReflectionsReport = async (start, end, pirId = null) => {
    try {
        // ✅ Build query with optional PIR filter
        let checkInsQuery = db.collection('checkIns')
            .where('createdAt', '>=', start)
            .where('createdAt', '<=', end);
        
        if (pirId) {
            checkInsQuery = checkInsQuery.where('userId', '==', pirId);
        }
        
        const checkInsSnap = await checkInsQuery.get();
        
        const eveningData = [];
        const checkIns = checkInsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const usersCache = {};
        for (const checkIn of checkIns) {
            if (checkIn.eveningData) {
                if (!usersCache[checkIn.userId]) {
                    const userDoc = await db.collection('users').doc(checkIn.userId).get();
                    usersCache[checkIn.userId] = userDoc.exists ? userDoc.data()?.displayName || 'Unknown' : 'Unknown';
                }
                
                eveningData.push({
                    pirName: usersCache[checkIn.userId],
                    date: checkIn.createdAt,
                    overallDay: checkIn.eveningData.overallDay,
                    gratitude: checkIn.eveningData.gratitude || '',
                    challenges: checkIn.eveningData.challenges || '',
                    tomorrowGoal: checkIn.eveningData.tomorrowGoal || ''
                });
            }
        }
        
        const dates = [];
        const overallDayScores = [];
        
        const current = new Date(start);
        while (current <= end) {
            const dayData = eveningData.filter(e => {
                const date = e.date?.toDate ? e.date.toDate() : new Date(e.date);
                return date.toDateString() === current.toDateString();
            });
            
            dates.push(current.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            
            if (dayData.length > 0) {
                const dayAvg = dayData.reduce((sum, d) => sum + (d.overallDay || 0), 0) / dayData.length;
                overallDayScores.push(parseFloat(dayAvg.toFixed(1)));
            } else {
                overallDayScores.push(null);
            }
            
            current.setDate(current.getDate() + 1);
        }
        
        const avgOverallDay = eveningData.reduce((sum, c) => sum + (c.overallDay || 0), 0) / eveningData.length || 0;
        const withGratitude = eveningData.filter(e => e.gratitude && e.gratitude.length > 0).length;
        const withChallenges = eveningData.filter(e => e.challenges && e.challenges.length > 0).length;
        const withGoals = eveningData.filter(e => e.tomorrowGoal && e.tomorrowGoal.length > 0).length;
        const completionRate = eveningData.length > 0 ? ((withGratitude + withChallenges + withGoals) / (eveningData.length * 3) * 100) : 0;
        
        const excellentDays = eveningData.filter(e => (e.overallDay || 0) >= 8).length;
        const goodDays = eveningData.filter(e => (e.overallDay || 0) >= 6 && (e.overallDay || 0) < 8).length;
        const challengingDays = eveningData.filter(e => (e.overallDay || 0) < 6).length;
        
        const insights = [];
        
        if (avgOverallDay >= 7) {
            insights.push('🎉 Overall day ratings are consistently positive');
        } else if (avgOverallDay >= 5) {
            insights.push('📊 Day quality is moderate - identifying patterns can help');
        } else {
            insights.push('⚠️ Multiple challenging days - reach out for additional support');
        }
        
        const gratitudePercent = ((withGratitude / eveningData.length) * 100).toFixed(0);
        if (withGratitude > eveningData.length * 0.8) {
            insights.push(`💚 Excellent gratitude practice - ${gratitudePercent}% completion`);
        } else if (withGratitude > eveningData.length * 0.5) {
            insights.push(`🌟 Good gratitude engagement - ${gratitudePercent}% completion`);
        }
        
        if (withGoals > eveningData.length * 0.7) {
            insights.push('🎯 Strong goal-setting habit - planning ahead consistently');
        }
        
        if (excellentDays > eveningData.length * 0.4) {
            insights.push(`✨ ${excellentDays} excellent days (8+ rating) - great progress!`);
        }
        
        if (insights.length === 0) {
            insights.push('📝 Continue building your evening reflection practice');
        }
        
        return {
            type: 'eveningReflections',
            metadata: {
                title: 'Evening Reflections Report',
                period: `${start.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} - ${end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`,
                generatedAt: new Date().toLocaleString('en-US'),
                reportType: 'eveningReflections'
            },
            eveningData,
            summary: {
                totalReflections: eveningData.length,
                avgOverallDay: parseFloat(avgOverallDay.toFixed(1)),
                withGratitude,
                withChallenges,
                withGoals,
                completionRate: parseFloat(completionRate.toFixed(1)),
                excellentDays,
                goodDays,
                challengingDays,
                gratitudePercent: parseFloat(gratitudePercent)
            },
            insights,
            charts: {
                trends: { dates, overallDayScores },
                dayQualityDistribution: {
                    labels: ['Excellent (8-10)', 'Good (6-7)', 'Challenging (1-5)'],
                    data: [excellentDays, goodDays, challengingDays]
                },
                completionBreakdown: {
                    labels: ['Gratitude', 'Challenges', 'Tomorrow Goals'],
                    data: [withGratitude, withChallenges, withGoals]
                }
            }
        };
    } catch (error) {
        console.error('Error generating evening reflections report:', error);
        throw error;
    }
};

// ========== REPORT GENERATOR 5: FULL PIR ==========
const generateFullPIRReport = async (start, end) => {
    const pirId = customConfig.selectedPIRs[0];
    if (!pirId) {
        alert('Please select a PIR for Full PIR Report');
        return {};
    }

    const pirDoc = await db.collection('users').doc(pirId).get();
    const pirData = pirDoc.data();

    const [checkInsSnap, goalsSnap, assignmentsSnap, alertsSnap] = await Promise.all([
        db.collection('checkIns').where('userId', '==', pirId)
            .where('createdAt', '>=', start).where('createdAt', '<=', end).get(),
        db.collection('goals').where('userId', '==', pirId).get(),
        db.collection('assignments').where('userId', '==', pirId)
            .where('createdAt', '>=', start).where('createdAt', '<=', end).get(),
        db.collection('alerts').where('userId', '==', pirId)
            .where('createdAt', '>=', start).where('createdAt', '<=', end).get()
    ]);

    const checkIns = checkInsSnap.docs.map(doc => doc.data());
    const goals = goalsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    const assignments = assignmentsSnap.docs.map(doc => doc.data());
    const alerts = alertsSnap.docs.map(doc => doc.data());

    const sobrietyDays = pirData.sobrietyDate 
        ? Math.floor((new Date() - new Date(pirData.sobrietyDate)) / (1000 * 60 * 60 * 24))
        : 0;

    return {
        type: 'fullPIR',
        metadata: {
            title: 'Full PIR Report',
            period: `${start.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} - ${end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`,
            generatedAt: new Date().toLocaleString('en-US'),
            reportType: 'fullPIR'
        },
        pirInfo: {
            name: pirData.displayName || pirData.email,
            email: pirData.email,
            sobrietyDate: pirData.sobrietyDate,
            daysSober: sobrietyDays
        },
        checkIns: {
            total: checkIns.length,
            avgMood: (checkIns.reduce((sum, c) => sum + (c.morningData?.mood || 0), 0) / checkIns.length).toFixed(1),
            avgCravings: (checkIns.reduce((sum, c) => sum + (c.morningData?.craving || 0), 0) / checkIns.length).toFixed(1)
        },
        goals: {
            total: goals.length,
            completed: goals.filter(g => g.status === 'completed').length,
            active: goals.filter(g => g.status === 'active').length
        },
        assignments: {
            total: assignments.length,
            completed: assignments.filter(a => a.status === 'completed').length
        },
        alerts: {
            total: alerts.length,
            sos: alerts.filter(a => a.type === 'sos').length
        },
        charts: {
            goalCompletion: {
                labels: ['Active', 'Completed'],
                data: [
                    goals.filter(g => g.status === 'active').length,
                    goals.filter(g => g.status === 'completed').length
                ]
            }
        }
    };
};

// ========== REPORT GENERATOR 6: MOOD ANALYSIS ==========
const generateMoodAnalysisReport = async (start, end, pirId = null) => {
    try {
        // ✅ Build query with optional PIR filter
        let checkInsQuery = db.collection('checkIns')
            .where('createdAt', '>=', start)
            .where('createdAt', '<=', end);
        
        if (pirId) {
            checkInsQuery = checkInsQuery.where('userId', '==', pirId);
        }
        
        const checkInsSnap = await checkInsQuery.get();
        const checkIns = checkInsSnap.docs.map(doc => doc.data());
        
        const moodDistribution = Array(10).fill(0);
        checkIns.forEach(checkIn => {
            const mood = checkIn.morningData?.mood;
            if (mood >= 1 && mood <= 10) {
                moodDistribution[mood - 1]++;
            }
        });

        const avgMood = checkIns.reduce((sum, c) => sum + (c.morningData?.mood || 0), 0) / checkIns.length || 0;
        const highMoodDays = checkIns.filter(c => (c.morningData?.mood || 0) >= 7).length;
        const lowMoodDays = checkIns.filter(c => (c.morningData?.mood || 0) <= 3).length;
        const moderateMoodDays = checkIns.filter(c => {
            const mood = c.morningData?.mood || 0;
            return mood > 3 && mood < 7;
        }).length;

        const dates = [];
        const moods = [];
        const current = new Date(start);
        
        while (current <= end) {
            const dayCheckIns = checkIns.filter(c => {
                const date = c.createdAt?.toDate ? c.createdAt.toDate() : new Date(c.createdAt);
                return date.toDateString() === current.toDateString();
            });
            
            dates.push(current.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            
            if (dayCheckIns.length > 0) {
                const dayAvg = dayCheckIns.reduce((sum, c) => sum + (c.morningData?.mood || 0), 0) / dayCheckIns.length;
                moods.push(parseFloat(dayAvg.toFixed(1)));
            } else {
                moods.push(null);
            }
            
            current.setDate(current.getDate() + 1);
        }

        const insights = [];
        const healthyPercentage = ((highMoodDays / checkIns.length) * 100).toFixed(0);
        const concerningPercentage = ((lowMoodDays / checkIns.length) * 100).toFixed(0);

        if (highMoodDays > checkIns.length * 0.6) {
            insights.push(`🎉 ${healthyPercentage}% of days in healthy mood range (7-10)`);
        }
        if (lowMoodDays > checkIns.length * 0.3) {
            insights.push(`⚠️ ${concerningPercentage}% of days in low mood range - consider additional support`);
        }
        if (avgMood >= 7) {
            insights.push('💚 Overall mood average is excellent');
        } else if (avgMood >= 5) {
            insights.push('📊 Mood is in moderate range - opportunities for improvement');
        } else {
            insights.push('⚠️ Mood average below target - reach out to your recovery coach');
        }

        return {
            type: 'moodAnalysis',
            metadata: {
                title: 'Mood Analysis Report',
                period: `${start.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} - ${end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`,
                generatedAt: new Date().toLocaleString('en-US'),
                reportType: 'moodAnalysis'
            },
            summary: {
                avgMood: parseFloat(avgMood.toFixed(1)),
                highMoodDays,
                moderateMoodDays,
                lowMoodDays,
                totalCheckIns: checkIns.length,
                healthyPercentage: parseFloat(healthyPercentage),
                concerningPercentage: parseFloat(concerningPercentage)
            },
            insights,
            charts: {
                distribution: moodDistribution,
                trends: { dates, moods }
            }
        };
    } catch (error) {
        console.error('Error generating mood analysis:', error);
        throw error;
    }
};

// ========== REPORT GENERATOR 7: CRISIS ==========
const generateCrisisReport = async (start, end, pirId = null) => {
    // ✅ Build query with optional PIR filter
    let alertsQuery = db.collection('alerts')
        .where('createdAt', '>=', start)
        .where('createdAt', '<=', end);
    
    if (pirId) {
        alertsQuery = alertsQuery.where('userId', '==', pirId);
    }
    
    const alertsSnap = await alertsQuery.get();
    const alerts = [];
    for (const doc of alertsSnap.docs) {
        const alert = doc.data();
        const userDoc = await db.collection('users').doc(alert.userId).get();
        alerts.push({
            ...alert,
            pirName: userDoc.data()?.displayName || 'Unknown',
            id: doc.id
        });
    }

    const avgResponseTime = calculateAvgResponseTime(alerts.filter(a => a.resolved));

    return {
        type: 'crisis',
        metadata: {
            title: 'Crisis & Intervention Report',
            period: `${start.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} - ${end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`,
            generatedAt: new Date().toLocaleString('en-US'),
            reportType: 'crisis'
        },
        alerts,
        summary: {
            totalAlerts: alerts.length,
            sosCount: alerts.filter(a => a.type === 'sos').length,
            resolved: alerts.filter(a => a.resolved).length,
            unresolved: alerts.filter(a => !a.resolved).length,
            criticalPriority: alerts.filter(a => a.priority === 'critical').length,
            avgResponseTime
        }
    };
};

// ========== REPORT GENERATOR 8: ENGAGEMENT ==========
const generateEngagementReport = async (start, end, pirId = null) => {
    try {
        // ✅ Build PIR query with optional filter
        let pirsQuery = db.collection('users').where('role', '==', 'pir');
        
        if (pirId) {
            pirsQuery = pirsQuery.where(firebase.firestore.FieldPath.documentId(), '==', pirId);
        }
        
        const pirsSnap = await pirsQuery.get();
        
        const engagementData = [];
        
        for (const pirDoc of pirsSnap.docs) {
            const currentPirId = pirDoc.id;
            const pirData = pirDoc.data();
            
            const [checkInsSnap, assignmentsSnap, messagesSnap] = await Promise.all([
                db.collection('checkIns').where('userId', '==', currentPirId)
                    .where('createdAt', '>=', start).where('createdAt', '<=', end).get(),
                db.collection('assignments').where('userId', '==', currentPirId)
                    .where('createdAt', '>=', start).where('createdAt', '<=', end).get(),
                db.collection('messages').where('senderId', '==', currentPirId)
                    .where('createdAt', '>=', start).where('createdAt', '<=', end).get()
            ]);
            
            const checkIns = checkInsSnap.docs.map(d => d.data());
            const streak = calculateStreak(checkIns);
            
            const assignments = assignmentsSnap.docs.map(d => d.data());
            const assignmentCompletion = assignments.length > 0 
                ? ((assignments.filter(a => a.status === 'completed').length / assignments.length) * 100).toFixed(0)
                : 0;
            
            const engagementScore = calculateEngagementScore(
                checkInsSnap.size, 
                assignmentCompletion, 
                messagesSnap.size
            );
            
            engagementData.push({
                pirName: pirData.displayName || pirData.email,
                checkInCount: checkInsSnap.size,
                checkInStreak: streak,
                assignmentCount: assignmentsSnap.size,
                assignmentCompletion: parseFloat(assignmentCompletion),
                messageCount: messagesSnap.size,
                engagementScore
            });
        }
        
        engagementData.sort((a, b) => b.engagementScore - a.engagementScore);
        
        const avgCheckIns = engagementData.reduce((sum, p) => sum + p.checkInCount, 0) / engagementData.length;
        const avgCompletion = engagementData.reduce((sum, p) => sum + p.assignmentCompletion, 0) / engagementData.length;
        const highEngagement = engagementData.filter(p => p.engagementScore >= 75).length;
        const lowEngagement = engagementData.filter(p => p.engagementScore < 50).length;
        
        const insights = [];
        const highEngagementPercent = ((highEngagement / engagementData.length) * 100).toFixed(0);
        
        if (highEngagement > engagementData.length * 0.5) {
            insights.push(`🎉 ${highEngagementPercent}% of PIRs have high engagement (75+)`);
        }
        if (lowEngagement > engagementData.length * 0.3) {
            insights.push(`⚠️ ${lowEngagement} PIRs need engagement support`);
        }
        if (avgCheckIns >= 5) {
            insights.push(`💚 Strong check-in activity - average ${avgCheckIns.toFixed(1)} per PIR`);
        }
        
        return {
            type: 'engagement',
            metadata: {
                title: 'Engagement Report',
                period: `${start.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} - ${end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`,
                generatedAt: new Date().toLocaleString('en-US'),
                reportType: 'engagement'
            },
            engagementData,
            summary: {
                avgCheckIns: parseFloat(avgCheckIns.toFixed(1)),
                avgCompletion: parseFloat(avgCompletion.toFixed(0)),
                highEngagement,
                lowEngagement,
                totalPIRs: engagementData.length
            },
            insights,
            charts: {
                engagementDistribution: {
                    labels: engagementData.map(e => e.pirName),
                    data: engagementData.map(e => e.engagementScore)
                }
            }
        };
    } catch (error) {
        console.error('Error generating engagement report:', error);
        throw error;
    }
};

// ========== REPORT GENERATOR 9: COMPARATIVE ==========
const generateComparativeReport = async (start, end) => {
    const pirId = customConfig.selectedPIRs[0];
    if (!pirId) {
        alert('Please select a PIR for Comparative Report');
        return {};
    }

    const pirDoc = await db.collection('users').doc(pirId).get();
    const pirData = pirDoc.data();

    const [pirCheckIns, allCheckIns] = await Promise.all([
        db.collection('checkIns').where('userId', '==', pirId)
            .where('createdAt', '>=', start).where('createdAt', '<=', end).get(),
        db.collection('checkIns')
            .where('createdAt', '>=', start).where('createdAt', '<=', end).get()
    ]);

    const pirStats = calculateStats(pirCheckIns.docs.map(d => d.data()));
    const programStats = calculateStats(allCheckIns.docs.map(d => d.data()));

    const sobrietyDays = pirData.sobrietyDate 
        ? Math.floor((new Date() - new Date(pirData.sobrietyDate)) / 86400000)
        : 0;

    return {
        type: 'comparative',
        metadata: {
            title: 'Comparative Analysis Report',
            period: `${start.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} - ${end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`,
            generatedAt: new Date().toLocaleString('en-US'),
            reportType: 'comparative'
        },
        pirInfo: {
            name: pirData.displayName || pirData.email,
            daysSober: sobrietyDays
        },
        comparison: {
            avgMood: { pir: pirStats.avgMood, program: programStats.avgMood },
            avgCravings: { pir: pirStats.avgCravings, program: programStats.avgCravings },
            avgAnxiety: { pir: pirStats.avgAnxiety, program: programStats.avgAnxiety },
            avgSleep: { pir: pirStats.avgSleep, program: programStats.avgSleep }
        }
    };
};

// ========== REPORT GENERATOR 10: MILESTONES ==========
const generateMilestonesReport = async (start, end, pirId = null) => {
    try {
        // ✅ Build queries with optional PIR filter
        let goalsQuery = db.collection('goals').where('status', '==', 'completed');
        let milestonesQuery = db.collection('milestones').where('achieved', '==', true);
        
        if (pirId) {
            goalsQuery = goalsQuery.where('userId', '==', pirId);
            milestonesQuery = milestonesQuery.where('userId', '==', pirId);
        }
        
        const [goalsSnap, milestonesSnap] = await Promise.all([
            goalsQuery.get(),
            milestonesQuery.get()
        ]);
        
        const completedGoals = goalsSnap.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(g => {
                const completedDate = g.completedAt?.toDate ? g.completedAt.toDate() : new Date(g.completedAt);
                return completedDate >= start && completedDate <= end;
            });
        
        const achievements = [];
        const usersCache = {};
        
        for (const goal of completedGoals) {
            if (!usersCache[goal.userId]) {
                const userDoc = await db.collection('users').doc(goal.userId).get();
                usersCache[goal.userId] = userDoc.exists ? userDoc.data()?.displayName || 'Unknown' : 'Unknown';
            }
            
            achievements.push({
                pirName: usersCache[goal.userId],
                type: 'goal',
                title: goal.title,
                completedAt: goal.completedAt,
                category: goal.category || 'general',
                description: goal.description || ''
            });
        }
        
        const achievedMilestones = milestonesSnap.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(m => {
                const achievedDate = m.achievedAt?.toDate ? m.achievedAt.toDate() : new Date(m.achievedAt);
                return achievedDate >= start && achievedDate <= end;
            });
        
        for (const milestone of achievedMilestones) {
            if (!usersCache[milestone.userId]) {
                const userDoc = await db.collection('users').doc(milestone.userId).get();
                usersCache[milestone.userId] = userDoc.exists ? userDoc.data()?.displayName || 'Unknown' : 'Unknown';
            }
            
            achievements.push({
                pirName: usersCache[milestone.userId],
                type: 'milestone',
                title: milestone.title,
                completedAt: milestone.achievedAt,
                category: milestone.type || 'sobriety',
                description: milestone.description || ''
            });
        }
        
        achievements.sort((a, b) => {
            const dateA = a.completedAt?.toDate ? a.completedAt.toDate() : new Date(a.completedAt);
            const dateB = b.completedAt?.toDate ? b.completedAt.toDate() : new Date(b.completedAt);
            return dateB - dateA;
        });
        
        const sobrietyMilestones = await getSobrietyMilestones(start, end);
        
        const insights = [];
        const totalAchievements = achievements.length;
        
        if (totalAchievements > 10) {
            insights.push(`🎉 ${totalAchievements} achievements unlocked this period!`);
        } else if (totalAchievements > 0) {
            insights.push(`🌟 ${totalAchievements} achievements completed`);
        }
        
        if (sobrietyMilestones.length > 0) {
            insights.push(`🏆 ${sobrietyMilestones.length} sobriety milestones reached`);
        }
        
        const uniquePIRs = [...new Set(achievements.map(a => a.pirName))].length;
        if (uniquePIRs > 0) {
            insights.push(`💪 ${uniquePIRs} PIRs achieved milestones`);
        }
        
        return {
            type: 'milestones',
            metadata: {
                title: 'Milestones & Achievements Report',
                period: `${start.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} - ${end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`,
                generatedAt: new Date().toLocaleString('en-US'),
                reportType: 'milestones'
            },
            achievements,
            sobrietyMilestones,
            summary: {
                totalAchievements: achievements.length,
                goalsCompleted: completedGoals.length,
                milestonesAchieved: achievedMilestones.length,
                sobrietyMilestones: sobrietyMilestones.length,
                uniquePIRs
            },
            insights
        };
    } catch (error) {
        console.error('Error generating milestones report:', error);
        throw error;
    }
};

// ========== REPORT GENERATOR 11: COMMUNICATION ==========
const generateCommunicationReport = async (start, end, pirId = null) => {
    // ✅ Build query with optional PIR filter
    let messagesQuery = db.collection('messages')
        .where('createdAt', '>=', start)
        .where('createdAt', '<=', end);
    
    if (pirId) {
        messagesQuery = messagesQuery.where('senderId', '==', pirId);
    }
    
    const messagesSnap = await messagesQuery.get();

    const pirMessages = {};
    const messages = messagesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    messages.forEach(msg => {
        const userId = msg.senderId;
        if (!pirMessages[userId]) {
            pirMessages[userId] = { sent: 0, received: 0 };
        }
        pirMessages[userId].sent++;

        if (msg.recipientId && msg.recipientId !== userId) {
            if (!pirMessages[msg.recipientId]) {
                pirMessages[msg.recipientId] = { sent: 0, received: 0 };
            }
            pirMessages[msg.recipientId].received++;
        }
    });

    const pirComms = [];
    const usersCache = {};
    for (const [userId, counts] of Object.entries(pirMessages)) {
        if (!usersCache[userId]) {
            const userDoc = await db.collection('users').doc(userId).get();
            if (userDoc.exists && userDoc.data().role === 'pir') {
                usersCache[userId] = userDoc.data().displayName || userDoc.data().email;
                pirComms.push({
                    pirName: usersCache[userId],
                    messagesSent: counts.sent,
                    messagesReceived: counts.received
                });
            }
        }
    }

    return {
        type: 'communication',
        metadata: {
            title: 'Communication Report',
            period: `${start.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} - ${end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`,
            generatedAt: new Date().toLocaleString('en-US'),
            reportType: 'communication'
        },
        pirComms: pirComms.sort((a, b) => b.messagesSent - a.messagesSent),
        summary: {
            totalMessages: messagesSnap.size,
            activeCommunicators: pirComms.filter(p => p.messagesSent >= 5).length,
            avgMessagesPerPIR: pirComms.length > 0 
                ? (pirComms.reduce((sum, p) => sum + p.messagesSent, 0) / pirComms.length).toFixed(1)
                : 0
        }
    };
};

// ========== REPORT GENERATOR 12: PREDICTIVE RISK ==========
const generatePredictiveReport = async (start, end, pirId = null) => {
    // ✅ Build PIR query with optional filter
    let pirsQuery = db.collection('users').where('role', '==', 'pir');
    
    if (pirId) {
        pirsQuery = pirsQuery.where(firebase.firestore.FieldPath.documentId(), '==', pirId);
    }
    
    const pirsSnap = await pirsQuery.get();

    const riskData = [];

    for (const pirDoc of pirsSnap.docs) {
        const currentPirId = pirDoc.id;
        const pirData = pirDoc.data();

        const checkInsSnap = await db.collection('checkIns')
            .where('userId', '==', currentPirId)
            .orderBy('createdAt', 'desc')
            .limit(7)
            .get();
        const recentCheckIns = checkInsSnap.docs.map(d => d.data());
        const patterns = detectPatternsForPIR(recentCheckIns);
        const riskScore = calculatePredictiveRisk(recentCheckIns, patterns, pirData);

        riskData.push({
            pirName: pirData.displayName || pirData.email,
            riskScore,
            riskLevel: riskScore >= 7 ? 'High' : riskScore >= 4 ? 'Moderate' : 'Low',
            patterns,
            recommendations: generateRecommendations(patterns, riskScore)
        });
    }

    return {
        type: 'predictive',
        metadata: {
            title: 'Predictive Risk Report',
            period: `${start.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} - ${end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`,
            generatedAt: new Date().toLocaleString('en-US'),
            reportType: 'predictive'
        },
        riskData: riskData.sort((a, b) => b.riskScore - a.riskScore),
        summary: {
            highRisk: riskData.filter(r => r.riskScore >= 7).length,
            moderateRisk: riskData.filter(r => r.riskScore >= 4 && r.riskScore < 7).length,
            lowRisk: riskData.filter(r => r.riskScore < 4).length
        }
    };
};

// ==========================================
// HELPER FUNCTIONS FOR REPORTS
// ==========================================

const calculateMoodDistribution = (checkIns) => {
    const distribution = Array(10).fill(0);
    checkIns.forEach(c => {
        const mood = c.morningData?.mood;
        if (mood >= 1 && mood <= 10) {
            distribution[mood - 1]++;
        }
    });
    return distribution;
};

const calculateRiskScore = (avgMood, avgCravings, daysSober) => {
    let score = 0;
    if (avgMood <= 3) score += 3;
    else if (avgMood <= 5) score += 2;
    if (avgCravings >= 7) score += 4;
    else if (avgCravings >= 4) score += 2;
    if (daysSober < 30) score += 2;
    else if (daysSober < 90) score += 1;
    return Math.min(score, 10);
};

const detectPatterns = (checkIns) => {
    const patterns = [];
    const sorted = checkIns.sort((a, b) => {
        const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt);
        const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt);
        return dateB - dateA;
    });

    if (sorted.length >= 3) {
        const recent = sorted.slice(0, 3);
        const moods = recent.map(c => c.morningData?.mood || 0);
        
        if (moods[0] < moods[1] && moods[1] < moods[2]) {
            patterns.push({ type: 'declining-mood', message: 'Declining mood trend detected across program' });
        }

        const cravings = recent.map(c => c.morningData?.craving || 0);
        if (cravings.filter(c => c >= 7).length >= 2) {
            patterns.push({ type: 'high-cravings', message: 'Multiple PIRs reporting high cravings' });
        }
    }

    return patterns;
};

const detectPatternsForPIR = (checkIns) => {
    const patterns = [];
    
    if (checkIns.length < 3) return patterns;

    const moods = checkIns.map(c => c.morningData?.mood || 0);
    const cravings = checkIns.map(c => c.morningData?.craving || 0);

    if (moods.length >= 3 && moods[0] < moods[1] && moods[1] < moods[2]) {
        patterns.push('Declining mood trend');
    }

    if (cravings.length >= 3 && cravings[0] > cravings[1] && cravings[1] > cravings[2]) {
        patterns.push('Increasing cravings');
    }

    const anxieties = checkIns.map(c => c.morningData?.anxietyLevel || 0);
    if (anxieties.filter(a => a >= 7).length >= 3) {
        patterns.push('Persistent high anxiety');
    }

    const sleeps = checkIns.map(c => c.morningData?.sleepQuality || 0);
    if (sleeps.filter(s => s <= 3).length >= 3) {
        patterns.push('Poor sleep quality');
    }

    return patterns;
};

const calculateAvgResponseTime = (resolvedAlerts) => {
    if (resolvedAlerts.length === 0) return 'N/A';
    
    const times = resolvedAlerts.map(alert => {
        const created = alert.createdAt?.toDate ? alert.createdAt.toDate() : new Date(alert.createdAt);
        const resolved = alert.resolvedAt?.toDate ? alert.resolvedAt.toDate() : new Date(alert.resolvedAt);
        return resolved - created;
    });
    
    const avgTime = times.reduce((sum, t) => sum + t, 0) / times.length;
    const hours = Math.floor(avgTime / (1000 * 60 * 60));
    const minutes = Math.floor((avgTime % (1000 * 60 * 60)) / (1000 * 60));
    
    return `${hours}h ${minutes}m`;
};

const calculateStreak = (checkIns) => {
    if (checkIns.length === 0) return 0;
    
    const sortedDates = checkIns
        .map(c => {
            const date = c.createdAt?.toDate ? c.createdAt.toDate() : new Date(c.createdAt);
            return date.toDateString();
        })
        .filter((date, index, arr) => arr.indexOf(date) === index)
        .sort((a, b) => new Date(b) - new Date(a));

    let streak = 1;
    const today = new Date().toDateString();
    
    if (sortedDates[0] !== today && sortedDates[0] !== new Date(Date.now() - 86400000).toDateString()) {
        return 0;
    }

    for (let i = 1; i < sortedDates.length; i++) {
        const prevDate = new Date(sortedDates[i - 1]);
        const currDate = new Date(sortedDates[i]);
        const diffDays = Math.floor((prevDate - currDate) / 86400000);
        
        if (diffDays === 1) {
            streak++;
        } else {
            break;
        }
    }
    
    return streak;
};

const calculateEngagementScore = (checkIns, assignmentCompletion, messages) => {
    const checkInScore = Math.min((checkIns / 30) * 40, 40);
    const assignmentScore = (parseFloat(assignmentCompletion) / 100) * 30;
    const messageScore = Math.min((messages / 10) * 30, 30);
    
    return Math.round(checkInScore + assignmentScore + messageScore);
};

const calculateStats = (checkIns) => {
    if (checkIns.length === 0) return { avgMood: 0, avgCravings: 0, avgAnxiety: 0, avgSleep: 0 };
    
    return {
        avgMood: (checkIns.reduce((sum, c) => sum + (c.morningData?.mood || 0), 0) / checkIns.length).toFixed(1),
        avgCravings: (checkIns.reduce((sum, c) => sum + (c.morningData?.craving || 0), 0) / checkIns.length).toFixed(1),
        avgAnxiety: (checkIns.reduce((sum, c) => sum + (c.morningData?.anxietyLevel || 0), 0) / checkIns.length).toFixed(1),
        avgSleep: (checkIns.reduce((sum, c) => sum + (c.morningData?.sleepQuality || 0), 0) / checkIns.length).toFixed(1)
    };
};

const getSobrietyMilestones = async (start, end) => {
    const pirsSnap = await db.collection('users')
        .where('role', '==', 'pir')
        .get();

    const milestones = [];
    const milestonesDays = [7, 30, 60, 90, 180, 365];

    for (const pirDoc of pirsSnap.docs) {
        const pirData = pirDoc.data();
        if (!pirData.sobrietyDate) continue;

        const sobrietyDate = new Date(pirData.sobrietyDate);
        
        milestonesDays.forEach(days => {
            const milestoneDate = new Date(sobrietyDate);
            milestoneDate.setDate(milestoneDate.getDate() + days);
            
            if (milestoneDate >= start && milestoneDate <= end) {
                milestones.push({
                    pirName: pirData.displayName || pirData.email,
                    days,
                    achievedAt: milestoneDate,
                    title: `${days} Days Sober`
                });
            }
        });
    }

    return milestones;
};

const calculatePredictiveRisk = (checkIns, patterns, pirData) => {
    let score = 0;

    if (checkIns.length === 0) return 5;

    const avgMood = checkIns.reduce((sum, c) => sum + (c.morningData?.mood || 0), 0) / checkIns.length;
    const avgCravings = checkIns.reduce((sum, c) => sum + (c.morningData?.craving || 0), 0) / checkIns.length;

    if (avgMood <= 4) score += 3;
    if (avgCravings >= 6) score += 3;
    
    score += patterns.length;

    const sobrietyDays = pirData.sobrietyDate 
        ? Math.floor((new Date() - new Date(pirData.sobrietyDate)) / 86400000)
        : 0;
    
    if (sobrietyDays < 30) score += 2;

    return Math.min(score, 10);
};

const generateRecommendations = (patterns, riskScore) => {
    const recs = [];

    if (riskScore >= 7) {
        recs.push('Immediate check-in recommended');
        recs.push('Consider increasing session frequency');
    }

    if (patterns.includes('Declining mood trend')) {
        recs.push('Mood intervention activities');
    }

    if (patterns.includes('Increasing cravings')) {
        recs.push('Craving management resources');
        recs.push('Emergency support contacts review');
    }

    if (patterns.includes('Persistent high anxiety')) {
        recs.push('Anxiety coping techniques');
    }

    if (patterns.includes('Poor sleep quality')) {
        recs.push('Sleep hygiene education');
    }

    if (recs.length === 0) {
        recs.push('Continue current support plan');
    }

    return recs;
};
 // ==========================================
// CHART RENDERING + HANDLERS + PDF EXPORT
// Complete replacement section
// ==========================================

// ========== PROFESSIONAL CHART RENDERING ==========
const renderCharts = () => {
    // Destroy existing charts
    Object.values(chartInstances.current).forEach(chart => {
        if (chart) chart.destroy();
    });

    const data = reportData;
    const newCharts = {};

    // ========== MOOD & CRAVINGS CORRELATION (LINE CHART) ==========
    if (data.charts?.trends && chartRefs.moodVsCravings.current) {
        const ctx = chartRefs.moodVsCravings.current.getContext('2d');
        newCharts.moodVsCravings = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.charts.trends.dates,
                datasets: [
                    {
                        label: 'Mood',
                        data: data.charts.trends.moods,
                        borderColor: '#00A86B',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: false,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#00A86B',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    },
                    {
                        label: 'Cravings',
                        data: data.charts.trends.cravings,
                        borderColor: '#f44336',
                        backgroundColor: 'rgba(244, 67, 54, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: false,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#f44336',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Mood & Cravings Correlation',
                        font: { size: 16, weight: 'bold' },
                        padding: 15
                    },
                    subtitle: {
                        display: true,
                        text: 'Notice how these metrics relate to each other over time',
                        font: { size: 12 },
                        color: '#666',
                        padding: { bottom: 15 }
                    },
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 15,
                            font: { size: 13 }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        padding: 12,
                        titleFont: { size: 13, weight: 'bold' },
                        bodyFont: { size: 12 },
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y + '/10';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Date',
                            font: { size: 13, weight: 'bold' }
                        },
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Level (0-10)',
                            font: { size: 13, weight: 'bold' }
                        },
                        min: 0,
                        max: 10,
                        ticks: {
                            stepSize: 1
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.08)'
                        }
                    }
                }
            }
        });
    }

    // ========== ANXIETY & SLEEP CORRELATION (LINE CHART) ==========
    if (data.charts?.trends && chartRefs.anxietyVsSleep.current) {
        const ctx = chartRefs.anxietyVsSleep.current.getContext('2d');
        newCharts.anxietyVsSleep = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.charts.trends.dates,
                datasets: [
                    {
                        label: 'Anxiety',
                        data: data.charts.trends.anxiety,
                        borderColor: '#FF9800',
                        backgroundColor: 'rgba(255, 152, 0, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: false,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#FF9800',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    },
                    {
                        label: 'Sleep Quality',
                        data: data.charts.trends.sleep,
                        borderColor: '#9C27B0',
                        backgroundColor: 'rgba(156, 39, 176, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: false,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#9C27B0',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Anxiety & Sleep Quality Correlation',
                        font: { size: 16, weight: 'bold' },
                        padding: 15
                    },
                    subtitle: {
                        display: true,
                        text: 'See how anxiety levels affect your sleep quality',
                        font: { size: 12 },
                        color: '#666',
                        padding: { bottom: 15 }
                    },
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 15,
                            font: { size: 13 }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        padding: 12,
                        titleFont: { size: 13, weight: 'bold' },
                        bodyFont: { size: 12 },
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y + '/10';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Date',
                            font: { size: 13, weight: 'bold' }
                        },
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Level (0-10)',
                            font: { size: 13, weight: 'bold' }
                        },
                        min: 0,
                        max: 10,
                        ticks: {
                            stepSize: 1
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.08)'
                        }
                    }
                }
            }
        });
    }

    // ========== MOOD DISTRIBUTION (COLOR-CODED BAR CHART) ==========
    if (data.charts?.distribution && chartRefs.moodDistribution.current) {
        const ctx = chartRefs.moodDistribution.current.getContext('2d');
        newCharts.moodDistribution = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'],
                datasets: [{
                    label: 'Days at this mood level',
                    data: data.charts.distribution,
                    backgroundColor: [
                        '#f44336', '#f44336', '#f44336', // 1-3: Red (Concerning)
                        '#FF9800', '#FF9800', '#FF9800', // 4-6: Orange (Moderate)
                        '#00A86B', '#00A86B', '#00A86B', '#00A86B' // 7-10: Green (Healthy)
                    ],
                    borderColor: '#fff',
                    borderWidth: 2,
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Mood Distribution - Where You Spend Your Time',
                        font: { size: 16, weight: 'bold' },
                        padding: 15
                    },
                    subtitle: {
                        display: true,
                        text: 'Red (1-3): Needs Support | Orange (4-6): Moderate | Green (7-10): Healthy',
                        font: { size: 11 },
                        color: '#666',
                        padding: { bottom: 15 }
                    },
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Days',
                            font: { size: 13, weight: 'bold' }
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '← Low Mood — MOOD SCALE — High Mood →',
                            font: { size: 13, weight: 'bold' }
                        }
                    }
                }
            }
        });
    }

    // ========== MOOD TREND (SINGLE LINE) ==========
    if (data.charts?.trends && chartRefs.moodTrend.current) {
        const ctx = chartRefs.moodTrend.current.getContext('2d');
        newCharts.moodTrend = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.charts.trends.dates,
                datasets: [{
                    label: 'Average Mood',
                    data: data.charts.trends.moods,
                    borderColor: '#00A86B',
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#00A86B',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Daily Mood Trend',
                        font: { size: 16, weight: 'bold' }
                    },
                    legend: { display: false }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        max: 10,
                        title: { display: true, text: 'Mood Level (0-10)', font: { weight: 'bold' } }
                    },
                    x: {
                        title: { display: true, text: 'Date', font: { weight: 'bold' } }
                    }
                }
            }
        });
    }

    // ========== CRAVING TREND (SINGLE LINE) ==========
    if (data.charts?.trends && chartRefs.cravingTrend.current) {
        const ctx = chartRefs.cravingTrend.current.getContext('2d');
        newCharts.cravingTrend = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.charts.trends.dates,
                datasets: [{
                    label: 'Average Cravings',
                    data: data.charts.trends.cravings,
                    borderColor: '#f44336',
                    backgroundColor: 'rgba(244, 67, 54, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#f44336',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Daily Cravings Trend',
                        font: { size: 16, weight: 'bold' }
                    },
                    legend: { display: false }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        max: 10,
                        title: { display: true, text: 'Craving Level (0-10)', font: { weight: 'bold' } }
                    },
                    x: {
                        title: { display: true, text: 'Date', font: { weight: 'bold' } }
                    }
                }
            }
        });
    }

    // ========== ANXIETY TREND (SINGLE LINE) ==========
    if (data.charts?.trends && chartRefs.anxietyTrend.current) {
        const ctx = chartRefs.anxietyTrend.current.getContext('2d');
        newCharts.anxietyTrend = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.charts.trends.dates,
                datasets: [{
                    label: 'Average Anxiety',
                    data: data.charts.trends.anxiety,
                    borderColor: '#FF9800',
                    backgroundColor: 'rgba(255, 152, 0, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#FF9800',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Daily Anxiety Trend',
                        font: { size: 16, weight: 'bold' }
                    },
                    legend: { display: false }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        max: 10,
                        title: { display: true, text: 'Anxiety Level (0-10)', font: { weight: 'bold' } }
                    },
                    x: {
                        title: { display: true, text: 'Date', font: { weight: 'bold' } }
                    }
                }
            }
        });
    }

    // ========== SLEEP TREND (SINGLE LINE) ==========
    if (data.charts?.trends && chartRefs.sleepTrend.current) {
        const ctx = chartRefs.sleepTrend.current.getContext('2d');
        newCharts.sleepTrend = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.charts.trends.dates,
                datasets: [{
                    label: 'Average Sleep Quality',
                    data: data.charts.trends.sleep,
                    borderColor: '#9C27B0',
                    backgroundColor: 'rgba(156, 39, 176, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#9C27B0',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Daily Sleep Quality Trend',
                        font: { size: 16, weight: 'bold' }
                    },
                    legend: { display: false }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        max: 10,
                        title: { display: true, text: 'Sleep Quality (0-10)', font: { weight: 'bold' } }
                    },
                    x: {
                        title: { display: true, text: 'Date', font: { weight: 'bold' } }
                    }
                }
            }
        });
    }

    // ========== ENGAGEMENT DISTRIBUTION ==========
    if (data.charts?.engagementDistribution && chartRefs.engagementChart.current) {
        const ctx = chartRefs.engagementChart.current.getContext('2d');
        newCharts.engagementChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.charts.engagementDistribution.labels,
                datasets: [{
                    label: 'Engagement Score',
                    data: data.charts.engagementDistribution.data,
                    backgroundColor: data.charts.engagementDistribution.data.map(score => 
                        score >= 75 ? '#00A86B' : score >= 50 ? '#FF9800' : '#f44336'
                    ),
                    borderColor: '#fff',
                    borderWidth: 2,
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    title: {
                        display: true,
                        text: 'PIR Engagement Scores',
                        font: { size: 16, weight: 'bold' }
                    },
                    legend: { display: false }
                },
                scales: {
                    x: { 
                        beginAtZero: true, 
                        max: 100,
                        title: { display: true, text: 'Engagement Score (%)', font: { weight: 'bold' } }
                    }
                }
            }
        });
    }

    // ========== EVENING REFLECTIONS - OVERALL DAY TREND ==========
    if (data.charts?.trends?.overallDayScores && chartRefs.overallDayTrend.current) {
        const ctx = chartRefs.overallDayTrend.current.getContext('2d');
        newCharts.overallDayTrend = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.charts.trends.dates,
                datasets: [{
                    label: 'Overall Day Rating',
                    data: data.charts.trends.overallDayScores,
                    borderColor: '#0077CC',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#0077CC',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Daily Overall Day Rating',
                        font: { size: 16, weight: 'bold' }
                    },
                    legend: { display: false }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        max: 10,
                        title: { display: true, text: 'Overall Day (0-10)', font: { weight: 'bold' } }
                    },
                    x: {
                        title: { display: true, text: 'Date', font: { weight: 'bold' } }
                    }
                }
            }
        });
    }

    // ========== EVENING REFLECTIONS - DAY QUALITY PIE CHART ==========
    if (data.charts?.dayQualityDistribution && chartRefs.dayQualityPie.current) {
        const ctx = chartRefs.dayQualityPie.current.getContext('2d');
        newCharts.dayQualityPie = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: data.charts.dayQualityDistribution.labels,
                datasets: [{
                    data: data.charts.dayQualityDistribution.data,
                    backgroundColor: ['#00A86B', '#FF9800', '#f44336'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Day Quality Distribution',
                        font: { size: 16, weight: 'bold' }
                    },
                    legend: { 
                        display: true, 
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: { size: 12 }
                        }
                    }
                }
            }
        });
    }

    // ========== EVENING REFLECTIONS - COMPLETION BREAKDOWN ==========
    if (data.charts?.completionBreakdown && chartRefs.completionBar.current) {
        const ctx = chartRefs.completionBar.current.getContext('2d');
        newCharts.completionBar = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.charts.completionBreakdown.labels,
                datasets: [{
                    label: 'Completed',
                    data: data.charts.completionBreakdown.data,
                    backgroundColor: ['#00A86B', '#FF9800', '#0077CC'],
                    borderColor: '#fff',
                    borderWidth: 2,
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Reflection Component Completion',
                        font: { size: 16, weight: 'bold' }
                    },
                    legend: { display: false }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        title: { display: true, text: 'Number of Entries', font: { weight: 'bold' } }
                    }
                }
            }
        });
    }

    // ========== RISK DISTRIBUTION DOUGHNUT ==========
    if (data.charts?.riskDistribution && chartRefs.riskDistribution.current) {
        const ctx = chartRefs.riskDistribution.current.getContext('2d');
        newCharts.riskDistribution = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.charts.riskDistribution.labels,
                datasets: [{
                    data: data.charts.riskDistribution.data,
                    backgroundColor: ['#00A86B', '#FF9800', '#f44336'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: true, 
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: { size: 12 }
                        }
                    }
                }
            }
        });
    }

    // ========== SOBRIETY VS CRAVINGS SCATTER ==========
    if (data.charts?.sobrietyVsCravings && chartRefs.sobrietyVsCravings.current) {
        const ctx = chartRefs.sobrietyVsCravings.current.getContext('2d');
        newCharts.sobrietyVsCravings = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Days Sober vs Cravings',
                    data: data.charts.sobrietyVsCravings.data,
                    backgroundColor: 'rgba(76, 175, 80, 0.6)',
                    borderColor: '#00A86B',
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true, position: 'top' }
                },
                scales: {
                    x: { 
                        title: { display: true, text: 'Days Sober' },
                        beginAtZero: true
                    },
                    y: { 
                        title: { display: true, text: 'Average Cravings' }, 
                        min: 0, 
                        max: 10 
                    }
                }
            }
        });
    }

    // ========== GOAL COMPLETION PIE CHART ==========
    if (data.charts?.goalCompletion && chartRefs.goalCompletion.current) {
        const ctx = chartRefs.goalCompletion.current.getContext('2d');
        newCharts.goalCompletion = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: data.charts.goalCompletion.labels,
                datasets: [{
                    data: data.charts.goalCompletion.data,
                    backgroundColor: ['#0077CC', '#00A86B'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: true, 
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: { size: 12 }
                        }
                    }
                }
            }
        });
    }

    chartInstances.current = newCharts;
};

// ========== PDF EXPORT ==========
const exportReportToPDF = async (data, reportTitle) => {
    await new Promise(resolve => setTimeout(resolve, 500));
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    let yPos = 20;

    // Title
    doc.setFontSize(20);
    doc.setTextColor(102, 126, 234);
    doc.text(reportTitle, 20, yPos);
    yPos += 10;

    // Metadata
    doc.setFontSize(10);
    doc.setTextColor(100, 100, 100);
    doc.text(`Generated: ${new Date().toLocaleString()}`, 20, yPos);
    yPos += 5;
    doc.text(`Date Range: ${startDate} to ${endDate}`, 20, yPos);
    yPos += 15;

    // Summary
    if (data.summary) {
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        doc.text('Summary Statistics', 20, yPos);
        yPos += 8;

        doc.setFontSize(10);
        Object.entries(data.summary).forEach(([key, value]) => {
            const label = key.replace(/([A-Z])/g, ' $1').trim();
            doc.text(`${label}: ${value}`, 30, yPos);
            yPos += 6;
            if (yPos > 270) {
                doc.addPage();
                yPos = 20;
            }
        });
        yPos += 10;
    }

    // Patterns
    if (data.patterns && data.patterns.length > 0) {
        if (yPos > 250) {
            doc.addPage();
            yPos = 20;
        }
        
        doc.setFontSize(14);
        doc.text('Detected Patterns', 20, yPos);
        yPos += 8;
        
        doc.setFontSize(10);
        data.patterns.forEach(pattern => {
            doc.text(`• ${pattern.message}`, 30, yPos);
            yPos += 6;
        });
        yPos += 10;
    }

    // Charts
    for (const [chartName, chartInstance] of Object.entries(chartInstances.current)) {
        if (chartInstance) {
            if (yPos > 200) {
                doc.addPage();
                yPos = 20;
            }

            doc.setFontSize(12);
            const chartTitle = chartName.replace(/([A-Z])/g, ' $1').trim();
            doc.text(chartTitle.charAt(0).toUpperCase() + chartTitle.slice(1), 20, yPos);
            yPos += 5;

            try {
                const chartImage = chartInstance.toBase64Image();
                doc.addImage(chartImage, 'PNG', 20, yPos, 170, 80);
                yPos += 90;
            } catch (error) {
                console.error('Error adding chart:', error);
            }
        }
    }

    // Data Tables
    if (data.sobrietyData) {
        if (yPos > 200) {
            doc.addPage();
            yPos = 20;
        }

        doc.autoTable({
            startY: yPos,
            head: [['PIR', 'Days Sober', 'Avg Mood', 'Avg Cravings', 'Risk Level']],
            body: data.sobrietyData.map(p => [
                p.pirName,
                p.daysSober,
                p.avgMood,
                p.avgCravings,
                p.riskLevel
            ]),
            theme: 'striped',
            headStyles: { fillColor: [102, 126, 234] }
        });
    }

    if (data.morningData) {
        doc.addPage();
        yPos = 20;

        doc.autoTable({
            startY: yPos,
            head: [['PIR', 'Date', 'Mood', 'Craving', 'Anxiety', 'Sleep']],
            body: data.morningData.slice(0, 20).map(m => [
                m.pirName,
                formatDate(m.date),
                m.mood,
                m.craving,
                m.anxiety,
                m.sleep
            ]),
            theme: 'striped',
            headStyles: { fillColor: [102, 126, 234] }
        });
    }

    if (data.eveningData) {
        doc.addPage();
        yPos = 20;

        doc.autoTable({
            startY: yPos,
            head: [['PIR', 'Date', 'Overall Day', 'Gratitude', 'Challenges']],
            body: data.eveningData.slice(0, 20).map(e => [
                e.pirName,
                formatDate(e.date),
                e.overallDay + '/10',
                (e.gratitude || '').substring(0, 30) + '...',
                (e.challenges || '').substring(0, 30) + '...'
            ]),
            theme: 'striped',
            headStyles: { fillColor: [102, 126, 234] }
        });
    }

    if (data.engagementData) {
        doc.addPage();
        yPos = 20;

        doc.autoTable({
            startY: yPos,
            head: [['PIR', 'Check-ins', 'Streak', 'Messages', 'Score']],
            body: data.engagementData.slice(0, 20).map(e => [
                e.pirName,
                e.checkInCount,
                e.checkInStreak + ' days',
                e.messageCount,
                e.engagementScore
            ]),
            theme: 'striped',
            headStyles: { fillColor: [102, 126, 234] }
        });
    }

    if (data.riskData) {
        doc.addPage();
        yPos = 20;

        doc.autoTable({
            startY: yPos,
            head: [['PIR', 'Risk Score', 'Level', 'Patterns']],
            body: data.riskData.slice(0, 20).map(r => [
                r.pirName,
                r.riskScore + '/10',
                r.riskLevel,
                r.patterns.join(', ').substring(0, 40) + '...'
            ]),
            theme: 'striped',
            headStyles: { fillColor: [102, 126, 234] }
        });
    }

    if (data.alerts) {
        doc.addPage();
        yPos = 20;

        doc.autoTable({
            startY: yPos,
            head: [['PIR', 'Type', 'Priority', 'Status', 'Created']],
            body: data.alerts.slice(0, 20).map(a => [
                a.pirName,
                a.type,
                a.priority || 'normal',
                a.resolved ? 'Resolved' : 'Active',
                formatTimeAgo(a.createdAt)
            ]),
            theme: 'striped',
            headStyles: { fillColor: [102, 126, 234] }
        });
    }

    doc.save(`${reportTitle.replace(/\s+/g, '_')}_${startDate}_to_${endDate}.pdf`);
};
  // ========== EXPORT REPORT TO PDF WITH CHARTS (RETURN BLOB) ==========
const exportReportToPDFBlob = async (data, reportTitle) => {
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // ✅ HELPER: Strip emojis from text
    const stripEmojis = (text) => {
        return text.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu, '').trim();
    };
    
    // ✅ HELPER: Render chart to canvas and return base64
    const renderChartToImage = async (chartData, chartType, title) => {
        return new Promise((resolve) => {
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 400;
            document.body.appendChild(canvas);
            
            const ctx = canvas.getContext('2d');
            const chart = new Chart(ctx, {
                type: chartType,
                data: chartData,
                options: {
                    responsive: false,
                    animation: false,
                    plugins: {
                        title: {
                            display: true,
                            text: title,
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
            
            setTimeout(() => {
                const imageData = canvas.toDataURL('image/png');
                chart.destroy();
                document.body.removeChild(canvas);
                resolve(imageData);
            }, 500);
        });
    };
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    let yPos = 20;

    // Title
    doc.setFontSize(20);
    doc.setTextColor(102, 126, 234);
    doc.text(reportTitle, 20, yPos);
    yPos += 10;

    // Metadata
    doc.setFontSize(10);
    doc.setTextColor(100, 100, 100);
    doc.text(`Generated: ${new Date().toLocaleString()}`, 20, yPos);
    yPos += 5;
    if (data.metadata?.period) {
        doc.text(`Period: ${data.metadata.period}`, 20, yPos);
        yPos += 15;
    } else {
        yPos += 10;
    }

    // Summary
    if (data.summary) {
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        doc.text('Summary Statistics', 20, yPos);
        yPos += 8;

        doc.setFontSize(10);
        Object.entries(data.summary).forEach(([key, value]) => {
            const label = key.replace(/([A-Z])/g, ' $1').trim();
            doc.text(`${label}: ${value}`, 30, yPos);
            yPos += 6;
            if (yPos > 270) {
                doc.addPage();
                yPos = 20;
            }
        });
        yPos += 10;
    }

    // Insights
    if (data.insights && data.insights.length > 0) {
        if (yPos > 250) {
            doc.addPage();
            yPos = 20;
        }
        
        doc.setFontSize(14);
        doc.text('Key Insights', 20, yPos);
        yPos += 8;
        
        doc.setFontSize(10);
        data.insights.forEach(insight => {
            const cleanInsight = stripEmojis(insight);
            const lines = doc.splitTextToSize(cleanInsight, 170);
            lines.forEach(line => {
                doc.text(`- ${line}`, 30, yPos);
                yPos += 6;
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }
            });
        });
        yPos += 10;
    }

    // Patterns
    if (data.patterns && data.patterns.length > 0) {
        if (yPos > 250) {
            doc.addPage();
            yPos = 20;
        }
        
        doc.setFontSize(14);
        doc.text('Detected Patterns', 20, yPos);
        yPos += 8;
        
        doc.setFontSize(10);
        data.patterns.forEach(pattern => {
            const message = pattern.message || pattern;
            const cleanMessage = stripEmojis(message);
            const lines = doc.splitTextToSize(cleanMessage, 170);
            lines.forEach(line => {
                doc.text(`- ${line}`, 30, yPos);
                yPos += 6;
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }
            });
        });
        yPos += 10;
    }

    // ✅ CHARTS SECTION - MOOD & CRAVINGS TREND
    if (data.charts?.trends) {
        if (yPos > 200) {
            doc.addPage();
            yPos = 20;
        }
        
        doc.setFontSize(12);
        doc.text('Mood & Cravings Trend', 20, yPos);
        yPos += 5;

        const chartImage = await renderChartToImage(
            {
                labels: data.charts.trends.dates,
                datasets: [
                    {
                        label: 'Mood',
                        data: data.charts.trends.moods,
                        borderColor: '#00A86B',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        borderWidth: 2,
                        tension: 0.4
                    },
                    {
                        label: 'Cravings',
                        data: data.charts.trends.cravings,
                        borderColor: '#f44336',
                        backgroundColor: 'rgba(244, 67, 54, 0.1)',
                        borderWidth: 2,
                        tension: 0.4
                    }
                ]
            },
            'line',
            'Mood & Cravings Over Time'
        );
        
        doc.addImage(chartImage, 'PNG', 20, yPos, 170, 80);
        yPos += 90;
    }

    // ✅ ANXIETY & SLEEP TREND CHART
    if (data.charts?.trends?.anxiety && data.charts?.trends?.sleep) {
        if (yPos > 200) {
            doc.addPage();
            yPos = 20;
        }
        
        doc.setFontSize(12);
        doc.text('Anxiety & Sleep Quality Trend', 20, yPos);
        yPos += 5;

        const chartImage = await renderChartToImage(
            {
                labels: data.charts.trends.dates,
                datasets: [
                    {
                        label: 'Anxiety',
                        data: data.charts.trends.anxiety,
                        borderColor: '#FF9800',
                        backgroundColor: 'rgba(255, 152, 0, 0.1)',
                        borderWidth: 2,
                        tension: 0.4
                    },
                    {
                        label: 'Sleep Quality',
                        data: data.charts.trends.sleep,
                        borderColor: '#9C27B0',
                        backgroundColor: 'rgba(156, 39, 176, 0.1)',
                        borderWidth: 2,
                        tension: 0.4
                    }
                ]
            },
            'line',
            'Anxiety & Sleep Over Time'
        );
        
        doc.addImage(chartImage, 'PNG', 20, yPos, 170, 80);
        yPos += 90;
    }

    // ✅ MOOD DISTRIBUTION CHART
    if (data.charts?.distribution) {
        if (yPos > 200) {
            doc.addPage();
            yPos = 20;
        }
        
        doc.setFontSize(12);
        doc.text('Mood Distribution', 20, yPos);
        yPos += 5;

        const chartImage = await renderChartToImage(
            {
                labels: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'],
                datasets: [{
                    label: 'Days at this mood level',
                    data: data.charts.distribution,
                    backgroundColor: [
                        '#f44336', '#f44336', '#f44336',
                        '#FF9800', '#FF9800', '#FF9800',
                        '#00A86B', '#00A86B', '#00A86B', '#00A86B'
                    ],
                    borderWidth: 1
                }]
            },
            'bar',
            'Where You Spend Your Time'
        );
        
        doc.addImage(chartImage, 'PNG', 20, yPos, 170, 80);
        yPos += 90;
    }

    // Data Tables - Morning Check-ins
    if (data.morningData && data.morningData.length > 0) {
        doc.addPage();
        yPos = 20;

        doc.setFontSize(14);
        doc.text('Morning Check-in Details', 20, yPos);
        yPos += 10;

        doc.autoTable({
            startY: yPos,
            head: [['Date', 'Mood', 'Craving', 'Anxiety', 'Sleep']],
            body: data.morningData.slice(0, 30).map(m => {
                const date = m.date?.toDate ? m.date.toDate() : new Date(m.date);
                return [
                    date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                    m.mood || 'N/A',
                    m.craving || 'N/A',
                    m.anxiety || 'N/A',
                    m.sleep || 'N/A'
                ];
            }),
            theme: 'striped',
            headStyles: { fillColor: [102, 126, 234] }
        });
    }

    // Data Tables - Evening Reflections
    if (data.eveningData && data.eveningData.length > 0) {
        doc.addPage();
        yPos = 20;

        doc.setFontSize(14);
        doc.text('Evening Reflection Details', 20, yPos);
        yPos += 10;

        doc.autoTable({
            startY: yPos,
            head: [['Date', 'Overall Day', 'Gratitude', 'Challenges']],
            body: data.eveningData.slice(0, 30).map(e => {
                const date = e.date?.toDate ? e.date.toDate() : new Date(e.date);
                return [
                    date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                    (e.overallDay || 'N/A') + '/10',
                    (e.gratitude || '').substring(0, 30) + '...',
                    (e.challenges || '').substring(0, 30) + '...'
                ];
            }),
            theme: 'striped',
            headStyles: { fillColor: [102, 126, 234] }
        });
    }

    // Data Tables - Sobriety
    if (data.sobrietyData && data.sobrietyData.length > 0) {
        doc.addPage();
        yPos = 20;

        doc.setFontSize(14);
        doc.text('Sobriety Analysis', 20, yPos);
        yPos += 10;

        doc.autoTable({
            startY: yPos,
            head: [['PIR', 'Days Sober', 'Avg Mood', 'Avg Cravings', 'Risk Level']],
            body: data.sobrietyData.slice(0, 30).map(s => [
                s.pirName,
                s.daysSober,
                s.avgMood,
                s.avgCravings,
                s.riskLevel
            ]),
            theme: 'striped',
            headStyles: { fillColor: [102, 126, 234] }
        });
    }

    // Data Tables - Engagement
    if (data.engagementData && data.engagementData.length > 0) {
        doc.addPage();
        yPos = 20;

        doc.setFontSize(14);
        doc.text('Engagement Details', 20, yPos);
        yPos += 10;

        doc.autoTable({
            startY: yPos,
            head: [['PIR', 'Check-ins', 'Streak', 'Assignments', 'Score']],
            body: data.engagementData.slice(0, 30).map(e => [
                e.pirName,
                e.checkInCount,
                e.checkInStreak + ' days',
                e.assignmentCompletion + '%',
                e.engagementScore
            ]),
            theme: 'striped',
            headStyles: { fillColor: [102, 126, 234] }
        });
    }

    // Data Tables - Achievements
    if (data.achievements && data.achievements.length > 0) {
        doc.addPage();
        yPos = 20;

        doc.setFontSize(14);
        doc.text('Achievements & Milestones', 20, yPos);
        yPos += 10;

        doc.autoTable({
            startY: yPos,
            head: [['PIR', 'Type', 'Achievement', 'Date']],
            body: data.achievements.slice(0, 30).map(a => {
                const date = a.completedAt?.toDate ? a.completedAt.toDate() : new Date(a.completedAt);
                return [
                    a.pirName,
                    a.type,
                    a.title,
                    date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                ];
            }),
            theme: 'striped',
            headStyles: { fillColor: [102, 126, 234] }
        });
    }

    // Data Tables - Risk
    if (data.riskData && data.riskData.length > 0) {
        doc.addPage();
        yPos = 20;

        doc.setFontSize(14);
        doc.text('Risk Assessment', 20, yPos);
        yPos += 10;

        doc.autoTable({
            startY: yPos,
            head: [['PIR', 'Risk Score', 'Level', 'Patterns']],
            body: data.riskData.slice(0, 30).map(r => [
                r.pirName,
                r.riskScore + '/10',
                r.riskLevel,
                r.patterns.join(', ').substring(0, 40) + '...'
            ]),
            theme: 'striped',
            headStyles: { fillColor: [102, 126, 234] }
        });
    }

    // ✅ RETURN BLOB
    return doc.output('blob');
};

// ========== SEND WEEKLY REPORTS HANDLER ==========
const handleSendWeeklyReports = async () => {
    if (!confirm('Send weekly progress reports to all active PIRs?')) {
        return;
    }
    
    setSendingWeekly(true);
    try {
        await sendAllWeeklyReports();
    } catch (error) {
        console.error('Error sending weekly reports:', error);
    } finally {
        setSendingWeekly(false);
    }
};

// ========== SEND MONTHLY REPORTS HANDLER ==========
const handleSendMonthlyReports = async () => {
    if (!confirm('Send monthly progress reports to all active PIRs?')) {
        return;
    }
    
    setSendingMonthly(true);
    try {
        await sendAllMonthlyReports();
    } catch (error) {
        console.error('Error sending monthly reports:', error);
    } finally {
        setSendingMonthly(false);
    }
};

// ========== MAIN GENERATE REPORT ==========
const generateReport = async () => {
    if (!startDate || !endDate) {
        alert('Please select date range');
        return;
    }

    setLoading(true);
    try {
        const start = new Date(startDate);
        start.setHours(0, 0, 0, 0);
        const end = new Date(endDate);
        end.setHours(23, 59, 59, 999);

        let data = {};

        if (reportMode === 'templates') {
            switch (selectedTemplate) {
                case 'overview':
                    data = await generateOverviewReport(start, end);
                    break;
                case 'sobriety':
                    data = await generateSobrietyReport(start, end);
                    break;
                case 'morningCheckins':
                    data = await generateMorningCheckinsReport(start, end);
                    break;
                case 'eveningReflections':
                    data = await generateEveningReflectionsReport(start, end);
                    break;
                case 'fullPIR':
                    data = await generateFullPIRReport(start, end);
                    break;
                case 'moodAnalysis':
                    data = await generateMoodAnalysisReport(start, end);
                    break;
                case 'crisis':
                    data = await generateCrisisReport(start, end);
                    break;
                case 'engagement':
                    data = await generateEngagementReport(start, end);
                    break;
                case 'comparative':
                    data = await generateComparativeReport(start, end);
                    break;
                case 'milestones':
                    data = await generateMilestonesReport(start, end);
                    break;
                case 'communication':
                    data = await generateCommunicationReport(start, end);
                    break;
                case 'predictive':
                    data = await generatePredictiveReport(start, end);
                    break;
                default:
                    data = await generateOverviewReport(start, end);
            }
        }

        setReportData(data);
    } catch (error) {
        console.error('Error generating report:', error);
        alert('Failed to generate report: ' + error.message);
    } finally {
        setLoading(false);
    }
};

    // ========== ANALYTICS VIEW COMPONENT ==========
    function AnalyticsView({ analyticsData, onClose, onSelectPIR }) {
        const [selectedTab, setSelectedTab] = useState('aggregate');
        const [sortBy, setSortBy] = useState('name');

        if (!analyticsData) return null;

        const { pirStats, allPIRsData } = analyticsData;

        const sortedPIRs = Object.values(pirStats).sort((a, b) => {
            if (sortBy === 'name') return a.userName.localeCompare(b.userName);
            if (sortBy === 'avgMood') return parseFloat(b.avgMood) - parseFloat(a.avgMood);
            if (sortBy === 'avgCraving') return parseFloat(a.avgCraving) - parseFloat(b.avgCraving);
            if (sortBy === 'completion') return b.completionRate - a.completionRate;
            return 0;
        });

        const exportAggregateAnalytics = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');
            
            let yPos = 20;
            
            doc.setFontSize(20);
            doc.text('Analytics Report - All PIRs', 14, yPos);
            yPos += 15;
            
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 14, yPos);
            yPos += 15;

            doc.setFontSize(16);
            doc.text('Overall Program Statistics', 14, yPos);
            yPos += 10;

            const aggregateStats = [
                ['Metric', 'Lifetime Average', 'Last 30 Days'],
                ['Average Mood', allPIRsData.avgMood, allPIRsData.last30Days.avgMood],
                ['Average Cravings', allPIRsData.avgCraving, allPIRsData.last30Days.avgCraving],
                ['Average Anxiety', allPIRsData.avgAnxiety, allPIRsData.last30Days.avgAnxiety],
                ['Average Sleep Quality', allPIRsData.avgSleep, allPIRsData.last30Days.avgSleep],
                ['Completion Rate', `${allPIRsData.completionRate}%`, `${allPIRsData.last30Days.completionRate}%`],
                ['Total Check-ins', allPIRsData.totalCheckIns, '-']
            ];

            doc.autoTable({
                startY: yPos,
                head: [aggregateStats[0]],
                body: aggregateStats.slice(1),
                theme: 'grid',
                headStyles: { fillColor: [102, 126, 234] }
            });

            doc.addPage();
            yPos = 20;
            
            doc.setFontSize(16);
            doc.text('Individual PIR Statistics - Lifetime', 14, yPos);
            yPos += 10;

            const pirLifetimeData = sortedPIRs.map(pir => [
                pir.userName,
                pir.totalCheckIns,
                pir.avgMood,
                pir.avgCraving,
                pir.avgAnxiety,
                pir.avgSleep,
                `${pir.completionRate}%`
            ]);

            doc.autoTable({
                startY: yPos,
                head: [['PIR', 'Check-ins', 'Avg Mood', 'Avg Craving', 'Avg Anxiety', 'Avg Sleep', 'Completion']],
                body: pirLifetimeData,
                theme: 'grid',
                headStyles: { fillColor: [102, 126, 234] },
                styles: { fontSize: 9 }
            });

            doc.save(`Analytics_Report_${new Date().toISOString().split('T')[0]}.pdf`);
        };

        return (
            <div style={{ padding: '20px', animation: 'fadeIn 0.5s' }}>
                <div style={{ 
                    display: 'flex', 
                    justifyContent: 'space-between', 
                    alignItems: 'center',
                    marginBottom: '30px'
                }}>
                    <div>
                        <h2 style={{ margin: '0 0 10px 0', fontSize: '28px', color: '#333' }}>
                            Analytics & Reports
                        </h2>
                        <p style={{ margin: 0, color: '#666' }}>
                            Comprehensive check-in statistics and trends
                        </p>
                    </div>
                    <div style={{ display: 'flex', gap: '10px' }}>
                        <button
                            onClick={exportAggregateAnalytics}
                            style={{
                                padding: '12px 24px',
                                background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '10px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '600'
                            }}
                        >
                            Export Analytics PDF
                        </button>
                        <button
                            onClick={onClose}
                            style={{
                                padding: '12px 24px',
                                background: '#6c757d',
                                color: 'white',
                                border: 'none',
                                borderRadius: '10px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '600'
                            }}
                        >
                            Back to Reports
                        </button>
                    </div>
                </div>

                <div style={{
                    display: 'flex',
                    gap: '10px',
                    marginBottom: '30px',
                    borderBottom: '2px solid #f0f0f0'
                }}>
                    {[
                        { id: 'aggregate', label: 'All PIRs Aggregate' },
                        { id: 'individual', label: 'Individual PIR Stats' }
                    ].map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setSelectedTab(tab.id)}
                            style={{
                                padding: '12px 24px',
                                background: selectedTab === tab.id ? 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)' : 'transparent',
                                color: selectedTab === tab.id ? 'white' : '#666',
                                border: 'none',
                                borderBottom: selectedTab === tab.id ? 'none' : '2px solid transparent',
                                cursor: 'pointer',
                                fontSize: '15px',
                                fontWeight: '600',
                                borderRadius: selectedTab === tab.id ? '10px 10px 0 0' : '0',
                                transition: 'all 0.2s'
                            }}
                        >
                            {tab.label}
                        </button>
                    ))}
                </div>

                {selectedTab === 'aggregate' && (
                    <div>
                        <div style={{
                            background: 'white',
                            borderRadius: '15px',
                            padding: '30px',
                            marginBottom: '30px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                        }}>
                            <h3 style={{ margin: '0 0 20px 0', fontSize: '20px', color: '#333' }}>
                                Overall Program Statistics
                            </h3>
                            
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '20px' }}>
                                <div style={{
                                    background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                    padding: '20px',
                                    borderRadius: '12px',
                                    color: 'white'
                                }}>
                                    <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '8px' }}>Total Check-ins</div>
                                    <div style={{ fontSize: '32px', fontWeight: 'bold' }}>{allPIRsData.totalCheckIns}</div>
                                </div>

                                <div style={{
                                    background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                                    padding: '20px',
                                    borderRadius: '12px',
                                    color: 'white'
                                }}>
                                    <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '8px' }}>Completion Rate</div>
                                    <div style={{ fontSize: '32px', fontWeight: 'bold' }}>{allPIRsData.completionRate}%</div>
                                    <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '4px' }}>
                                        30-day: {allPIRsData.last30Days.completionRate}%
                                    </div>
                                </div>

                                <div style={{
                                    background: 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)',
                                    padding: '20px',
                                    borderRadius: '12px',
                                    color: 'white'
                                }}>
                                    <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '8px' }}>Average Mood</div>
                                    <div style={{ fontSize: '32px', fontWeight: 'bold' }}>{allPIRsData.avgMood}/10</div>
                                    <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '4px' }}>
                                        30-day: {allPIRsData.last30Days.avgMood}/10
                                    </div>
                                </div>

                                <div style={{
                                    background: 'linear-gradient(135deg, #f44336 0%, #B01030 100%)',
                                    padding: '20px',
                                    borderRadius: '12px',
                                    color: 'white'
                                }}>
                                    <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '8px' }}>Average Cravings</div>
                                    <div style={{ fontSize: '32px', fontWeight: 'bold' }}>{allPIRsData.avgCraving}/10</div>
                                    <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '4px' }}>
                                        30-day: {allPIRsData.last30Days.avgCraving}/10
                                    </div>
                                </div>

                                <div style={{
                                    background: 'linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%)',
                                    padding: '20px',
                                    borderRadius: '12px',
                                    color: 'white'
                                }}>
                                    <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '8px' }}>Average Anxiety</div>
                                    <div style={{ fontSize: '32px', fontWeight: 'bold' }}>{allPIRsData.avgAnxiety}/10</div>
                                    <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '4px' }}>
                                        30-day: {allPIRsData.last30Days.avgAnxiety}/10
                                    </div>
                                </div>

                                <div style={{
                                    background: 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)',
                                    padding: '20px',
                                    borderRadius: '12px',
                                    color: 'white'
                                }}>
                                    <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '8px' }}>Average Sleep Quality</div>
                                    <div style={{ fontSize: '32px', fontWeight: 'bold' }}>{allPIRsData.avgSleep}/10</div>
                                    <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '4px' }}>
                                        30-day: {allPIRsData.last30Days.avgSleep}/10
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style={{
                            background: 'white',
                            borderRadius: '15px',
                            padding: '30px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                        }}>
                            <h3 style={{ margin: '0 0 20px 0', fontSize: '20px', color: '#333' }}>
                                30-Day Trend vs Lifetime Average
                            </h3>
                            
                            <div style={{ display: 'grid', gap: '20px' }}>
                                {[
                                    { label: 'Mood', lifetime: allPIRsData.avgMood, recent: allPIRsData.last30Days.avgMood, color: '#0077CC' },
                                    { label: 'Cravings', lifetime: allPIRsData.avgCraving, recent: allPIRsData.last30Days.avgCraving, color: '#DC143C', inverse: true },
                                    { label: 'Anxiety', lifetime: allPIRsData.avgAnxiety, recent: allPIRsData.last30Days.avgAnxiety, color: '#FFA500', inverse: true },
                                    { label: 'Sleep Quality', lifetime: allPIRsData.avgSleep, recent: allPIRsData.last30Days.avgSleep, color: '#4682B4' },
                                    { label: 'Completion Rate', lifetime: `${allPIRsData.completionRate}`, recent: `${allPIRsData.last30Days.completionRate}`, color: '#00A86B', isPercent: true }
                                ].map(metric => {
                                    const lifetimeVal = parseFloat(metric.lifetime);
                                    const recentVal = parseFloat(metric.recent);
                                    const diff = recentVal - lifetimeVal;
                                    const isImproving = metric.inverse ? diff < 0 : diff > 0;
                                    
                                    return (
                                        <div key={metric.label} style={{
                                            padding: '20px',
                                            background: '#f8f9fa',
                                            borderRadius: '10px'
                                        }}>
                                            <div style={{ 
                                                display: 'flex', 
                                                justifyContent: 'space-between', 
                                                alignItems: 'center',
                                                marginBottom: '15px'
                                            }}>
                                                <div style={{ fontSize: '16px', fontWeight: '600', color: '#333' }}>
                                                    {metric.label}
                                                </div>
                                                <div style={{
                                                    padding: '4px 12px',
                                                    background: isImproving ? '#d4edda' : '#f8d7da',
                                                    color: isImproving ? '#155724' : '#721c24',
                                                    borderRadius: '20px',
                                                    fontSize: '13px',
                                                    fontWeight: '600'
                                                }}>
                                                    {diff > 0 ? '+' : ''}{diff.toFixed(1)}{metric.isPercent ? '%' : ''} {isImproving ? '↑' : '↓'}
                                                </div>
                                            </div>
                                            <div style={{ display: 'flex', gap: '20px', alignItems: 'center' }}>
                                                <div style={{ flex: 1 }}>
                                                    <div style={{ fontSize: '12px', color: '#666', marginBottom: '5px' }}>
                                                        Lifetime: {metric.lifetime}{metric.isPercent ? '%' : '/10'}
                                                    </div>
                                                    <div style={{
                                                        height: '10px',
                                                        background: '#e0e0e0',
                                                        borderRadius: '5px',
                                                        overflow: 'hidden'
                                                    }}>
                                                        <div style={{
                                                            height: '100%',
                                                            width: `${metric.isPercent ? lifetimeVal : lifetimeVal * 10}%`,
                                                            background: metric.color,
                                                            opacity: 0.6
                                                        }}></div>
                                                    </div>
                                                </div>
                                                <div style={{ flex: 1 }}>
                                                    <div style={{ fontSize: '12px', color: '#666', marginBottom: '5px' }}>
                                                        Last 30 Days: {metric.recent}{metric.isPercent ? '%' : '/10'}
                                                    </div>
                                                    <div style={{
                                                        height: '10px',
                                                        background: '#e0e0e0',
                                                        borderRadius: '5px',
                                                        overflow: 'hidden'
                                                    }}>
                                                        <div style={{
                                                            height: '100%',
                                                            width: `${metric.isPercent ? recentVal : recentVal * 10}%`,
                                                            background: metric.color
                                                        }}></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                )}

                {selectedTab === 'individual' && (
                    <div style={{
                        background: 'white',
                        borderRadius: '15px',
                        padding: '30px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                    }}>
                        <div style={{ 
                            display: 'flex', 
                            justifyContent: 'space-between', 
                            alignItems: 'center',
                            marginBottom: '20px'
                        }}>
                            <h3 style={{ margin: 0, fontSize: '20px', color: '#333' }}>
                                Individual PIR Statistics
                            </h3>
                            <div>
                                <label style={{ marginRight: '10px', color: '#666', fontSize: '14px' }}>Sort by:</label>
                                <select
                                    value={sortBy}
                                    onChange={(e) => setSortBy(e.target.value)}
                                    style={{
                                        padding: '8px 12px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '8px',
                                        fontSize: '14px',
                                        background: 'white'
                                    }}
                                >
                                    <option value="name">PIR Name</option>
                                    <option value="avgMood">Avg Mood</option>
                                    <option value="avgCraving">Avg Cravings</option>
                                    <option value="completion">Completion Rate</option>
                                </select>
                            </div>
                        </div>

                        <div style={{ overflowX: 'auto' }}>
                            <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                <thead style={{ background: '#f8f9fa' }}>
                                    <tr>
                                        <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#333', fontSize: '14px' }}>PIR</th>
                                        <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Check-ins<br/>(Total / 30d)</th>
                                        <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Avg Mood<br/>(Life / 30d)</th>
                                        <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Avg Craving<br/>(Life / 30d)</th>
                                        <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Avg Anxiety<br/>(Life / 30d)</th>
                                        <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Avg Sleep<br/>(Life / 30d)</th>
                                        <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Completion<br/>(Life / 30d)</th>
                                        <th style={{ padding: '15px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '14px' }}>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {sortedPIRs.map(pir => (
                                        <tr key={pir.userId} style={{ borderBottom: '1px solid #f0f0f0' }}>
                                            <td style={{ padding: '15px', fontWeight: '500', color: '#333' }}>
                                                {pir.userName}
                                            </td>
                                            <td style={{ padding: '15px', textAlign: 'center', color: '#666' }}>
                                                {pir.totalCheckIns} / {pir.last30.totalCheckIns}
                                            </td>
                                            <td style={{ padding: '15px', textAlign: 'center' }}>
                                                <div style={{ fontSize: '15px', fontWeight: '600', color: '#0077CC' }}>
                                                    {pir.avgMood}
                                                </div>
                                                <div style={{ fontSize: '12px', color: '#999', marginTop: '2px' }}>
                                                    {pir.last30.avgMood}
                                                </div>
                                            </td>
                                            <td style={{ padding: '15px', textAlign: 'center' }}>
                                                <div style={{ fontSize: '15px', fontWeight: '600', color: '#DC143C' }}>
                                                    {pir.avgCraving}
                                                </div>
                                                <div style={{ fontSize: '12px', color: '#999', marginTop: '2px' }}>
                                                    {pir.last30.avgCraving}
                                                </div>
                                            </td>
                                            <td style={{ padding: '15px', textAlign: 'center' }}>
                                                <div style={{ fontSize: '15px', fontWeight: '600', color: '#FFA500' }}>
                                                    {pir.avgAnxiety}
                                                </div>
                                                <div style={{ fontSize: '12px', color: '#999', marginTop: '2px' }}>
                                                    {pir.last30.avgAnxiety}
                                                </div>
                                            </td>
                                            <td style={{ padding: '15px', textAlign: 'center' }}>
                                                <div style={{ fontSize: '15px', fontWeight: '600', color: '#4682B4' }}>
                                                    {pir.avgSleep}
                                                </div>
                                                <div style={{ fontSize: '12px', color: '#999', marginTop: '2px' }}>
                                                    {pir.last30.avgSleep}
                                                </div>
                                            </td>
                                            <td style={{ padding: '15px', textAlign: 'center' }}>
                                                <div style={{ fontSize: '15px', fontWeight: '600', color: '#00A86B' }}>
                                                    {pir.completionRate}%
                                                </div>
                                                <div style={{ fontSize: '12px', color: '#999', marginTop: '2px' }}>
                                                    {pir.last30.completionRate}%
                                                </div>
                                            </td>
                                            <td style={{ padding: '15px', textAlign: 'center' }}>
                                                <button
                                                    onClick={() => onSelectPIR(pir.userId)}
                                                    style={{
                                                        padding: '6px 16px',
                                                        background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                                        color: 'white',
                                                        border: 'none',
                                                        borderRadius: '6px',
                                                        cursor: 'pointer',
                                                        fontSize: '13px',
                                                        fontWeight: '500'
                                                    }}
                                                >
                                                    View Report
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    // ========== INDIVIDUAL PIR REPORT COMPONENT ==========
    function IndividualPIRReport({ pirId, onClose }) {
        const [pirData, setPIRData] = useState(null);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
            loadPIRData();
        }, [pirId]);

        const loadPIRData = async () => {
            try {
                const pirDoc = await db.collection('users').doc(pirId).get();
                const data = { id: pirDoc.id, ...pirDoc.data() };
                
                const checkInsSnap = await db.collection('checkIns')
                    .where('userId', '==', pirId)
                    .orderBy('createdAt', 'desc')
                    .limit(100)
                    .get();
                
                data.checkIns = checkInsSnap.docs.map(d => d.data());
                
                setPIRData(data);
                setLoading(false);
            } catch (error) {
                console.error('Error loading PIR data:', error);
                setLoading(false);
            }
        };

        if (loading) {
            return (
                <div style={{ padding: '20px', textAlign: 'center' }}>
                    <div style={{ fontSize: '18px', color: '#666' }}>Loading PIR report...</div>
                </div>
            );
        }

        if (!pirData) {
            return (
                <div style={{ padding: '20px', textAlign: 'center' }}>
                    <div style={{ fontSize: '18px', color: '#666' }}>PIR not found</div>
                </div>
            );
        }

        const avgMood = pirData.checkIns.reduce((sum, c) => sum + (c.morningData?.mood || 0), 0) / pirData.checkIns.length;
        const avgCravings = pirData.checkIns.reduce((sum, c) => sum + (c.morningData?.craving || 0), 0) / pirData.checkIns.length;
        const sobrietyDays = pirData.sobrietyDate 
            ? Math.floor((new Date() - new Date(pirData.sobrietyDate)) / 86400000)
            : 0;

        return (
            <div style={{ padding: '20px', animation: 'fadeIn 0.5s' }}>
                <div style={{ 
                    display: 'flex', 
                    justifyContent: 'space-between', 
                    alignItems: 'center',
                    marginBottom: '30px'
                }}>
                    <div>
                        <h2 style={{ margin: '0 0 10px 0', fontSize: '28px', color: '#333' }}>
                            {pirData.displayName || pirData.email} - Individual Report
                        </h2>
                        <p style={{ margin: 0, color: '#666' }}>
                            Detailed analysis and trends
                        </p>
                    </div>
                    <button
                        onClick={onClose}
                        style={{
                            padding: '12px 24px',
                            background: '#6c757d',
                            color: 'white',
                            border: 'none',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '600'
                        }}
                    >
                        Back to Analytics
                    </button>
                </div>

                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '20px', marginBottom: '30px' }}>
                    <div style={{
                        background: 'white',
                        padding: '20px',
                        borderRadius: '12px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                        borderLeft: '4px solid #0077CC'
                    }}>
                        <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px' }}>Total Check-ins</div>
                        <div style={{ fontSize: '28px', fontWeight: 'bold', color: '#333' }}>{pirData.checkIns.length}</div>
                    </div>

                    <div style={{
                        background: 'white',
                        padding: '20px',
                        borderRadius: '12px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                        borderLeft: '4px solid #00A86B'
                    }}>
                        <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px' }}>Days Sober</div>
                        <div style={{ fontSize: '28px', fontWeight: 'bold', color: '#00A86B' }}>{sobrietyDays}</div>
                    </div>

                    <div style={{
                        background: 'white',
                        padding: '20px',
                        borderRadius: '12px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                        borderLeft: '4px solid #0077CC'
                    }}>
                        <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px' }}>Avg Mood</div>
                        <div style={{ fontSize: '28px', fontWeight: 'bold', color: '#0077CC' }}>{avgMood.toFixed(1)}/10</div>
                    </div>

                    <div style={{
                        background: 'white',
                        padding: '20px',
                        borderRadius: '12px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                        borderLeft: '4px solid #f44336'
                    }}>
                        <div style={{ fontSize: '13px', color: '#666', marginBottom: '8px' }}>Avg Cravings</div>
                        <div style={{ fontSize: '28px', fontWeight: 'bold', color: '#DC143C' }}>{avgCravings.toFixed(1)}/10</div>
                    </div>
                </div>

                <div style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '25px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                }}>
                    <h3 style={{ margin: '0 0 20px 0', fontSize: '20px', color: '#333' }}>
                        Recent Check-ins (Last 10)
                    </h3>
                    <div style={{ overflowX: 'auto' }}>
                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead style={{ background: '#f8f9fa' }}>
                                <tr>
                                    <th style={{ padding: '12px', textAlign: 'left', fontWeight: '600', color: '#333', fontSize: '13px' }}>Date</th>
                                    <th style={{ padding: '12px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '13px' }}>Mood</th>
                                    <th style={{ padding: '12px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '13px' }}>Craving</th>
                                    <th style={{ padding: '12px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '13px' }}>Anxiety</th>
                                    <th style={{ padding: '12px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '13px' }}>Sleep</th>
                                    <th style={{ padding: '12px', textAlign: 'center', fontWeight: '600', color: '#333', fontSize: '13px' }}>Overall</th>
                                </tr>
                            </thead>
                            <tbody>
                                {pirData.checkIns.slice(0, 10).map((checkIn, idx) => (
                                    <tr key={idx} style={{ borderBottom: '1px solid #f0f0f0' }}>
                                        <td style={{ padding: '12px', fontSize: '13px', color: '#666' }}>
                                            {formatDate(checkIn.createdAt)}
                                        </td>
                                        <td style={{ padding: '12px', textAlign: 'center', fontSize: '14px', fontWeight: '600', color: '#0077CC' }}>
                                            {checkIn.morningData?.mood || '-'}
                                        </td>
                                        <td style={{ padding: '12px', textAlign: 'center', fontSize: '14px', fontWeight: '600', color: '#DC143C' }}>
                                            {checkIn.morningData?.craving || '-'}
                                        </td>
                                        <td style={{ padding: '12px', textAlign: 'center', fontSize: '14px', fontWeight: '600', color: '#FFA500' }}>
                                            {checkIn.morningData?.anxietyLevel || '-'}
                                        </td>
                                        <td style={{ padding: '12px', textAlign: 'center', fontSize: '14px', fontWeight: '600', color: '#9C27B0' }}>
                                            {checkIn.morningData?.sleepQuality || '-'}
                                        </td>
                                        <td style={{ padding: '12px', textAlign: 'center', fontSize: '14px', fontWeight: '600', color: '#4682B4' }}>
                                                {checkIn.eveningData?.overallDay || '-'}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        );
    }

    // ========== MAIN REPORTS VIEW RENDER ==========
    if (showAnalytics) {
        return (
            <AnalyticsView 
                analyticsData={analyticsData}
                onClose={() => setShowAnalytics(false)}
                onSelectPIR={(pirId) => {
                    setSelectedPIRForReport(pirId);
                    setShowAnalytics(false);
                }}
            />
        );
    }

    if (selectedPIRForReport) {
        return (
            <IndividualPIRReport 
                pirId={selectedPIRForReport}
                onClose={() => setSelectedPIRForReport(null)}
            />
        );
    }

    return (
        <div style={{ padding: '20px', maxWidth: '1400px', margin: '0 auto' }}>
            {/* Header */}
            <div style={{ 
                display: 'flex', 
                justifyContent: 'space-between', 
                alignItems: 'center',
                marginBottom: '30px'
            }}>
                <div>
                    <h2 style={{ margin: '0 0 10px 0', fontSize: '32px', color: '#333' }}>
                        Reports & Analytics
                    </h2>
                    <p style={{ margin: 0, color: '#666', fontSize: '16px' }}>
                        Generate comprehensive reports and analyze program performance
                    </p>
                </div>
                <button
                    onClick={() => setShowAnalytics(true)}
                    style={{
                        padding: '14px 28px',
                        background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '12px',
                        cursor: 'pointer',
                        fontSize: '15px',
                        fontWeight: '600',
                        boxShadow: '0 4px 15px rgba(102, 126, 234, 0.3)',
                        transition: 'transform 0.2s'
                    }}
                    onMouseEnter={(e) => e.target.style.transform = 'translateY(-2px)'}
                    onMouseLeave={(e) => e.target.style.transform = 'translateY(0)'}
                >
                    View Analytics Dashboard
                </button>
            </div>

        {/* ========== AUTOMATED PROGRESS REPORTS SECTION ========== */}
<div style={{ 
    background: 'white',
    borderRadius: '15px',
    padding: '25px',
    marginBottom: '30px',
    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
}}>
    <h3 style={{ margin: '0 0 20px 0', color: '#333', fontSize: '20px' }}>
        📧 Automated Progress Reports
    </h3>
    
    {/* Google Drive Connection Warning */}
    {!user.googleConnected && (
        <div style={{
            background: '#fff3cd',
            border: '1px solid #ffc107',
            borderRadius: '8px',
            padding: '15px',
            marginBottom: '20px',
            display: 'flex',
            alignItems: 'center',
            gap: '10px'
        }}>
            <span style={{ fontSize: '24px' }}>⚠️</span>
            <div>
                <strong>Google Drive Not Connected</strong>
                <p style={{ margin: '5px 0 0 0', fontSize: '14px', color: '#666' }}>
                    Please connect Google Drive in your Profile to enable report generation.
                </p>
            </div>
        </div>
    )}
    
    {/* ========== AUTOMATION TOGGLE ========== */}
    <div style={{
        background: '#f8f9fa',
        borderRadius: '10px',
        padding: '20px',
        marginBottom: '25px',
        border: `2px solid ${automationEnabled ? '#00A86B' : '#999'}`
    }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <div>
                <h4 style={{ margin: '0 0 5px 0', fontSize: '16px', color: '#333' }}>
                    🔧 Automation Status
                </h4>
                <p style={{ margin: 0, fontSize: '13px', color: '#666' }}>
                    {automationEnabled 
                        ? '✅ Automated reports are ENABLED and will be sent on schedule'
                        : '⚠️ Automated reports are DISABLED - reports will not be sent automatically'
                    }
                </p>
            </div>
            <button
                onClick={() => setAutomationEnabled(!automationEnabled)}
                style={{
                    padding: '10px 20px',
                    background: automationEnabled ? '#00A86B' : '#999',
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontWeight: 'bold',
                    cursor: 'pointer',
                    transition: 'all 0.3s'
                }}
                onMouseOver={(e) => e.target.style.opacity = '0.8'}
                onMouseOut={(e) => e.target.style.opacity = '1'}
            >
                {automationEnabled ? '✓ ENABLED' : '✗ DISABLED'}
            </button>
        </div>
    </div>
    
    {/* ========== REPORT SELECTION ========== */}
    <div style={{
        background: '#f8f9fa',
        borderRadius: '10px',
        padding: '20px',
        marginBottom: '25px'
    }}>
        <h4 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#333' }}>
            ⚙️ Select Reports to Include in Automated Emails
        </h4>
        <div style={{ 
            display: 'grid', 
            gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))',
            gap: '12px',
            marginBottom: '15px'
        }}>
            {Object.entries(AVAILABLE_REPORTS).map(([key, report]) => (
                <label 
                    key={key}
                    style={{
                        display: 'flex',
                        alignItems: 'flex-start',
                        gap: '12px',
                        padding: '12px',
                        background: selectedReports[key] ? '#e3f2fd' : 'white',
                        border: `2px solid ${selectedReports[key] ? '#2196F3' : '#e0e0e0'}`,
                        borderRadius: '8px',
                        cursor: 'pointer',
                        transition: 'all 0.2s'
                    }}
                    onMouseOver={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                    onMouseOut={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <input
                        type="checkbox"
                        checked={selectedReports[key]}
                        onChange={(e) => setSelectedReports({
                            ...selectedReports,
                            [key]: e.target.checked
                        })}
                        style={{
                            width: '18px',
                            height: '18px',
                            marginTop: '2px',
                            cursor: 'pointer'
                        }}
                    />
                    <div style={{ flex: 1 }}>
                        <div style={{ 
                            fontSize: '14px', 
                            fontWeight: '600', 
                            color: '#333',
                            marginBottom: '4px',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px'
                        }}>
                            <span>{report.icon}</span>
                            <span>{report.name}</span>
                        </div>
                        <div style={{ fontSize: '12px', color: '#666', lineHeight: '1.4' }}>
                            {report.description}
                        </div>
                    </div>
                </label>
            ))}
        </div>
        <button
            onClick={saveAutomationConfig}
            style={{
                width: '100%',
                padding: '12px',
                background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                color: 'white',
                border: 'none',
                borderRadius: '8px',
                fontSize: '14px',
                fontWeight: 'bold',
                cursor: 'pointer',
                transition: 'all 0.3s'
            }}
            onMouseOver={(e) => e.target.style.transform = 'translateY(-2px)'}
            onMouseOut={(e) => e.target.style.transform = 'translateY(0)'}
        >
            💾 Save Configuration
        </button>
    </div>
    
    {/* ========== SCHEDULE CONFIGURATION ========== */}
    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px', marginBottom: '25px' }}>
        {/* Weekly Schedule */}
        <div style={{
            background: '#f8f9fa',
            borderRadius: '10px',
            padding: '20px'
        }}>
            <h4 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#333' }}>
                📅 Weekly Reports Schedule
            </h4>
            <div style={{ marginBottom: '15px' }}>
                <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '600', color: '#555' }}>
                    Day of Week
                </label>
                <select
                    value={scheduleConfig.weekly.day}
                    onChange={(e) => setScheduleConfig({
                        ...scheduleConfig,
                        weekly: { ...scheduleConfig.weekly, day: parseInt(e.target.value) }
                    })}
                    style={{
                        width: '100%',
                        padding: '10px',
                        border: '2px solid #e0e0e0',
                        borderRadius: '6px',
                        fontSize: '14px'
                    }}
                >
                    <option value="1">Monday</option>
                    <option value="2">Tuesday</option>
                    <option value="3">Wednesday</option>
                    <option value="4">Thursday</option>
                    <option value="5">Friday</option>
                    <option value="6">Saturday</option>
                    <option value="0">Sunday</option>
                </select>
            </div>
            <div style={{ marginBottom: '15px' }}>
                <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '600', color: '#555' }}>
                    Time
                </label>
                <input
                    type="time"
                    value={scheduleConfig.weekly.time}
                    onChange={(e) => setScheduleConfig({
                        ...scheduleConfig,
                        weekly: { ...scheduleConfig.weekly, time: e.target.value }
                    })}
                    style={{
                        width: '100%',
                        padding: '10px',
                        border: '2px solid #e0e0e0',
                        borderRadius: '6px',
                        fontSize: '14px'
                    }}
                />
            </div>
            <button
                onClick={testWeeklyReports}
                disabled={sendingWeekly || !user.googleConnected}
                style={{
                    width: '100%',
                    padding: '12px',
                    background: (sendingWeekly || !user.googleConnected) ? '#ccc' : 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontWeight: 'bold',
                    cursor: (sendingWeekly || !user.googleConnected) ? 'not-allowed' : 'pointer',
                    transition: 'all 0.3s'
                }}
            >
                {sendingWeekly ? '📤 Sending...' : '🧪 Test Weekly Reports Now'}
            </button>
            {lastRunStatus.weekly && (
                <div style={{
                    marginTop: '12px',
                    padding: '10px',
                    background: lastRunStatus.weekly.success ? '#e8f5e9' : '#ffebee',
                    borderRadius: '6px',
                    fontSize: '12px',
                    color: '#666'
                }}>
                    <strong>Last Run:</strong><br/>
                    {new Date(lastRunStatus.weekly.timestamp).toLocaleString()}<br/>
                    {lastRunStatus.weekly.successCount}/{lastRunStatus.weekly.pirCount} PIRs
                </div>
            )}
        </div>
        
        {/* Monthly Schedule */}
        <div style={{
            background: '#f8f9fa',
            borderRadius: '10px',
            padding: '20px'
        }}>
            <h4 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#333' }}>
                📆 Monthly Reports Schedule
            </h4>
            <div style={{ marginBottom: '15px' }}>
                <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '600', color: '#555' }}>
                    Day of Month
                </label>
                <select
                    value={scheduleConfig.monthly.day}
                    onChange={(e) => setScheduleConfig({
                        ...scheduleConfig,
                        monthly: { ...scheduleConfig.monthly, day: parseInt(e.target.value) }
                    })}
                    style={{
                        width: '100%',
                        padding: '10px',
                        border: '2px solid #e0e0e0',
                        borderRadius: '6px',
                        fontSize: '14px'
                    }}
                >
                    {[...Array(28)].map((_, i) => (
                        <option key={i + 1} value={i + 1}>
                            {i + 1}{i === 0 ? 'st' : i === 1 ? 'nd' : i === 2 ? 'rd' : 'th'}
                        </option>
                    ))}
                </select>
            </div>
            <div style={{ marginBottom: '15px' }}>
                <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '600', color: '#555' }}>
                    Time
                </label>
                <input
                    type="time"
                    value={scheduleConfig.monthly.time}
                    onChange={(e) => setScheduleConfig({
                        ...scheduleConfig,
                        monthly: { ...scheduleConfig.monthly, time: e.target.value }
                    })}
                    style={{
                        width: '100%',
                        padding: '10px',
                        border: '2px solid #e0e0e0',
                        borderRadius: '6px',
                        fontSize: '14px'
                    }}
                />
            </div>
            <button
                onClick={testMonthlyReports}
                disabled={sendingMonthly || !user.googleConnected}
                style={{
                    width: '100%',
                    padding: '12px',
                    background: (sendingMonthly || !user.googleConnected) ? '#ccc' : 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontWeight: 'bold',
                    cursor: (sendingMonthly || !user.googleConnected) ? 'not-allowed' : 'pointer',
                    transition: 'all 0.3s'
                }}
            >
                {sendingMonthly ? '📤 Sending...' : '🧪 Test Monthly Reports Now'}
            </button>
            {lastRunStatus.monthly && (
                <div style={{
                    marginTop: '12px',
                    padding: '10px',
                    background: lastRunStatus.monthly.success ? '#e8f5e9' : '#ffebee',
                    borderRadius: '6px',
                    fontSize: '12px',
                    color: '#666'
                }}>
                    <strong>Last Run:</strong><br/>
                    {new Date(lastRunStatus.monthly.timestamp).toLocaleString()}<br/>
                    {lastRunStatus.monthly.successCount}/{lastRunStatus.monthly.pirCount} PIRs
                </div>
            )}
        </div>
    </div>
    
    {/* Info Note */}
    <div style={{ 
        padding: '12px',
        background: '#f0f7ff',
        borderRadius: '8px',
        fontSize: '13px',
        color: '#0066cc'
    }}>
        <strong>ℹ️ Note:</strong> Changes to schedule take effect immediately. Use the test buttons to send reports manually to all PIRs right now. Remember to click "Save Configuration" after changing report selections.
    </div>
</div>

{/* Report Generation Section */}
<div style={{
    background: 'white',
    borderRadius: '20px',
    padding: '35px',
    marginBottom: '30px',
    boxShadow: '0 2px 20px rgba(0,0,0,0.08)'
}}>
    <h3 style={{ margin: '0 0 25px 0', fontSize: '24px', color: '#333' }}>
        Generate Report
    </h3>

    {/* Date Range Selector */}
    <div style={{ 
        display: 'grid', 
        gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
        gap: '20px',
        marginBottom: '30px'
    }}>
        <div>
            <label style={{ display: 'block', marginBottom: '8px', fontWeight: '600', color: '#555', fontSize: '14px' }}>
                Start Date
            </label>
            <input
                type="date"
                value={startDate}
                onChange={(e) => setStartDate(e.target.value)}
                style={{
                    width: '100%',
                    padding: '12px',
                    border: '2px solid #e0e0e0',
                    borderRadius: '10px',
                    fontSize: '15px',
                    boxSizing: 'border-box'
                }}
            />
        </div>
        <div>
            <label style={{ display: 'block', marginBottom: '8px', fontWeight: '600', color: '#555', fontSize: '14px' }}>
                End Date
            </label>
            <input
                type="date"
                value={endDate}
                onChange={(e) => setEndDate(e.target.value)}
                style={{
                    width: '100%',
                    padding: '12px',
                    border: '2px solid #e0e0e0',
                    borderRadius: '10px',
                    fontSize: '15px',
                    boxSizing: 'border-box'
                }}
            />
        </div>
    </div>
                {/* Report Templates Grid */}
                <div>
                    <h4 style={{ margin: '0 0 20px 0', fontSize: '18px', color: '#333' }}>
                        Select Report Template
                    </h4>
                    <div style={{ 
                        display: 'grid', 
                        gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))',
                        gap: '15px',
                        marginBottom: '25px'
                    }}>
                        {Object.entries(REPORT_TEMPLATES).map(([key, template]) => (
                            <div
                                key={key}
                                onClick={() => setSelectedTemplate(key)}
                                style={{
                                    padding: '20px',
                                    background: selectedTemplate === key ? template.color : '#f8f9fa',
                                    borderRadius: '12px',
                                    cursor: 'pointer',
                                    transition: 'all 0.3s',
                                    border: selectedTemplate === key ? '2px solid transparent' : '2px solid #e0e0e0',
                                    transform: selectedTemplate === key ? 'scale(1.02)' : 'scale(1)',
                                    boxShadow: selectedTemplate === key ? '0 8px 25px rgba(0,0,0,0.15)' : '0 2px 8px rgba(0,0,0,0.05)'
                                }}
                            >
                                <div style={{ 
                                    fontSize: '32px', 
                                    marginBottom: '10px',
                                    filter: selectedTemplate === key ? 'brightness(2)' : 'none'
                                }}>
                                    {template.icon}
                                </div>
                                <div style={{ 
                                    fontSize: '16px', 
                                    fontWeight: '700',
                                    color: selectedTemplate === key ? 'white' : '#333',
                                    marginBottom: '6px'
                                }}>
                                    {template.name}
                                </div>
                                <div style={{ 
                                    fontSize: '13px',
                                    color: selectedTemplate === key ? 'rgba(255,255,255,0.9)' : '#666',
                                    lineHeight: '1.4'
                                }}>
                                    {template.desc}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>

                {/* PIR Selector for specific reports */}
                {(selectedTemplate === 'fullPIR' || selectedTemplate === 'comparative') && (
                    <div style={{ marginBottom: '25px' }}>
                        <label style={{ display: 'block', marginBottom: '8px', fontWeight: '600', color: '#555', fontSize: '14px' }}>
                            Select PIR for {REPORT_TEMPLATES[selectedTemplate].name}
                        </label>
                        <select
                            value={customConfig.selectedPIRs[0] || ''}
                            onChange={(e) => setCustomConfig({
                                ...customConfig,
                                selectedPIRs: [e.target.value]
                            })}
                            style={{
                                width: '100%',
                                padding: '12px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '10px',
                                fontSize: '15px',
                                background: 'white'
                            }}
                        >
                            <option value="">-- Select a PIR --</option>
                            {allPIRs.map(pir => (
                                <option key={pir.id} value={pir.id}>{pir.name}</option>
                            ))}
                        </select>
                    </div>
                )}

                {/* Generate Button */}
                <button
                    onClick={generateReport}
                    disabled={loading}
                    style={{
                        width: '100%',
                        padding: '16px',
                        background: loading ? '#ccc' : 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '12px',
                        fontSize: '16px',
                        fontWeight: '700',
                        cursor: loading ? 'not-allowed' : 'pointer',
                        transition: 'all 0.3s',
                        boxShadow: loading ? 'none' : '0 4px 15px rgba(76, 175, 80, 0.3)'
                    }}
                >
                    {loading ? 'Generating Report...' : `Generate ${REPORT_TEMPLATES[selectedTemplate]?.name || 'Report'}`}
                </button>
            </div>

            {/* Report Display Section */}
            {reportData && (
                <div style={{
                    background: 'white',
                    borderRadius: '20px',
                    padding: '35px',
                    boxShadow: '0 2px 20px rgba(0,0,0,0.08)',
                    animation: 'fadeIn 0.5s'
                }}>
                    {/* Report Header */}
                    <div style={{ 
                        display: 'flex', 
                        justifyContent: 'space-between', 
                        alignItems: 'center',
                        marginBottom: '30px',
                        paddingBottom: '20px',
                        borderBottom: '2px solid #f0f0f0'
                    }}>
                        <div>
                            <h3 style={{ margin: '0 0 8px 0', fontSize: '26px', color: '#333' }}>
                                {REPORT_TEMPLATES[selectedTemplate]?.name || 'Report'}
                            </h3>
                            <p style={{ margin: 0, color: '#666', fontSize: '14px' }}>
                                {startDate} to {endDate}
                            </p>
                        </div>
                        <div style={{ display: 'flex', gap: '10px' }}>
                            <button
                                onClick={() => exportReportToPDF(reportData, REPORT_TEMPLATES[selectedTemplate]?.name || 'Report')}
                                style={{
                                    padding: '10px 20px',
                                    background: '#DC143C',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '600'
                                }}
                            >
                                Export PDF
                            </button>
                            <button
                                onClick={() => exportToJSON(reportData, REPORT_TEMPLATES[selectedTemplate]?.name || 'Report')}
                                style={{
                                    padding: '10px 20px',
                                    background: '#4682B4',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '600'
                                }}
                            >
                                Export JSON
                            </button>
                        </div>
                    </div>

                    {/* Summary Section */}
                    {reportData.summary && (
                        <div style={{ marginBottom: '40px' }}>
                            <h4 style={{ margin: '0 0 20px 0', fontSize: '20px', color: '#333' }}>
                                Summary Statistics
                            </h4>
                            <div style={{ 
                                display: 'grid', 
                                gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                                gap: '15px'
                            }}>
                                {Object.entries(reportData.summary).map(([key, value]) => (
                                    <div key={key} style={{
                                        padding: '18px',
                                        background: '#f8f9fa',
                                        borderRadius: '10px',
                                        borderLeft: '4px solid #0077CC'
                                    }}>
                                        <div style={{ fontSize: '12px', color: '#666', marginBottom: '6px', textTransform: 'capitalize' }}>
                                            {key.replace(/([A-Z])/g, ' $1').trim()}
                                        </div>
                                        <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#333' }}>
                                            {value}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Patterns Section */}
                    {reportData.patterns && reportData.patterns.length > 0 && (
                        <div style={{ 
                            marginBottom: '40px',
                            padding: '20px',
                            background: '#fff3cd',
                            borderRadius: '12px',
                            borderLeft: '4px solid #ffc107'
                        }}>
                            <h4 style={{ margin: '0 0 15px 0', fontSize: '18px', color: '#856404' }}>
                                Detected Patterns & Alerts
                            </h4>
                            <ul style={{ margin: 0, paddingLeft: '20px' }}>
                                {reportData.patterns.map((pattern, idx) => (
                                    <li key={idx} style={{ 
                                        color: '#856404', 
                                        marginBottom: '8px',
                                        fontSize: '14px'
                                    }}>
                                        {pattern.message || pattern}
                                    </li>
                                ))}
                            </ul>
                        </div>
                    )}

                    {/* Charts Section */}
                    {reportData.charts && (
                        <div style={{ marginBottom: '40px' }}>
                            <h4 style={{ margin: '0 0 25px 0', fontSize: '20px', color: '#333' }}>
                                Visual Analysis
                            </h4>
                            <div style={{ 
                                display: 'grid',
                                gap: '25px'
                            }}>
                                {/* Trend Charts */}
                                {reportData.charts.trends && (
                                    <>
                                        <div style={{ 
                                            background: '#f8f9fa', 
                                            padding: '20px', 
                                            borderRadius: '12px',
                                            height: '350px'
                                        }}>
                                            <h5 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#555' }}>
                                                Mood Trend
                                            </h5>
                                            <canvas ref={chartRefs.moodTrend} style={{ maxHeight: '280px' }}></canvas>
                                        </div>
                                        <div style={{ 
                                            background: '#f8f9fa', 
                                            padding: '20px', 
                                            borderRadius: '12px',
                                            height: '350px'
                                        }}>
                                            <h5 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#555' }}>
                                                Craving Trend
                                            </h5>
                                            <canvas ref={chartRefs.cravingTrend} style={{ maxHeight: '280px' }}></canvas>
                                        </div>
                                        <div style={{ 
                                            background: '#f8f9fa', 
                                            padding: '20px', 
                                            borderRadius: '12px',
                                            height: '350px'
                                        }}>
                                            <h5 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#555' }}>
                                                Anxiety Trend
                                            </h5>
                                            <canvas ref={chartRefs.anxietyTrend} style={{ maxHeight: '280px' }}></canvas>
                                        </div>
                                        <div style={{ 
                                            background: '#f8f9fa', 
                                            padding: '20px', 
                                            borderRadius: '12px',
                                            height: '350px'
                                        }}>
                                            <h5 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#555' }}>
                                                Sleep Quality Trend
                                            </h5>
                                            <canvas ref={chartRefs.sleepTrend} style={{ maxHeight: '280px' }}></canvas>
                                        </div>
                                    </>
                                )}

                                {/* Scatter Charts */}
                                {reportData.charts.moodVsCravings && (
                                    <div style={{ 
                                        background: '#f8f9fa', 
                                        padding: '20px', 
                                        borderRadius: '12px',
                                        height: '350px'
                                    }}>
                                        <h5 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#555' }}>
                                            Mood vs Cravings Correlation
                                        </h5>
                                        <canvas ref={chartRefs.moodVsCravings} style={{ maxHeight: '280px' }}></canvas>
                                    </div>
                                )}
                                {reportData.charts.anxietyVsSleep && (
                                    <div style={{ 
                                        background: '#f8f9fa', 
                                        padding: '20px', 
                                        borderRadius: '12px',
                                        height: '350px'
                                    }}>
                                        <h5 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#555' }}>
                                            Anxiety vs Sleep Quality Correlation
                                        </h5>
                                        <canvas ref={chartRefs.anxietyVsSleep} style={{ maxHeight: '280px' }}></canvas>
                                    </div>
                                )}
                                {reportData.charts.sobrietyVsCravings && (
                                    <div style={{ 
                                        background: '#f8f9fa', 
                                        padding: '20px', 
                                        borderRadius: '12px',
                                        height: '350px'
                                    }}>
                                        <h5 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#555' }}>
                                            Days Sober vs Cravings
                                        </h5>
                                        <canvas ref={chartRefs.sobrietyVsCravings} style={{ maxHeight: '280px' }}></canvas>
                                    </div>
                                )}

                                {/* Distribution Charts */}
                                {reportData.charts.distribution && (
                                    <div style={{ 
                                        background: '#f8f9fa', 
                                        padding: '20px', 
                                        borderRadius: '12px',
                                        height: '350px'
                                    }}>
                                        <h5 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#555' }}>
                                            Mood Distribution
                                        </h5>
                                        <canvas ref={chartRefs.moodDistribution} style={{ maxHeight: '280px' }}></canvas>
                                    </div>
                                )}
                                {reportData.charts.riskDistribution && (
                                    <div style={{ 
                                        background: '#f8f9fa', 
                                        padding: '20px', 
                                        borderRadius: '12px',
                                        height: '350px'
                                    }}>
                                        <h5 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#555' }}>
                                            Risk Distribution
                                        </h5>
                                        <canvas ref={chartRefs.riskDistribution} style={{ maxHeight: '280px' }}></canvas>
                                    </div>
                                )}
                                {reportData.charts.goalCompletion && (
                                    <div style={{ 
                                        background: '#f8f9fa', 
                                        padding: '20px', 
                                        borderRadius: '12px',
                                        height: '350px'
                                    }}>
                                        <h5 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#555' }}>
                                            Goal Completion Status
                                        </h5>
                                        <canvas ref={chartRefs.goalCompletion} style={{ maxHeight: '280px' }}></canvas>
                                    </div>
                                )}
                                {reportData.charts.engagementDistribution && (
                                    <div style={{ 
                                        background: '#f8f9fa', 
                                        padding: '20px', 
                                        borderRadius: '12px',
                                        height: '400px'
                                    }}>
                                        <h5 style={{ margin: '0 0 15px 0', fontSize: '16px', color: '#555' }}>
                                            Engagement Scores by PIR
                                        </h5>
                                        <canvas ref={chartRefs.engagementChart} style={{ maxHeight: '320px' }}></canvas>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Data Tables Section */}
                    <div>
                        {/* Sobriety Data Table */}
                        {reportData.sobrietyData && reportData.sobrietyData.length > 0 && (
                            <div style={{ marginBottom: '30px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
                                    <h4 style={{ margin: 0, fontSize: '18px', color: '#333' }}>
                                        Sobriety Analysis Data
                                    </h4>
                                    <button
                                        onClick={() => exportToCSV(reportData.sobrietyData, 'sobriety_analysis')}
                                        style={{
                                            padding: '8px 16px',
                                            background: '#00A86B',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            fontWeight: '600'
                                        }}
                                    >
                                        Export CSV
                                    </button>
                                </div>
                                <div style={{ overflowX: 'auto', background: '#f8f9fa', borderRadius: '10px', padding: '15px' }}>
                                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                        <thead>
                                            <tr style={{ background: '#0077CC', color: 'white' }}>
                                                <th style={{ padding: '12px', textAlign: 'left', fontSize: '13px', fontWeight: '600' }}>PIR</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Days Sober</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Avg Mood</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Avg Cravings</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Risk Score</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Risk Level</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {reportData.sobrietyData.map((pir, idx) => (
                                                <tr key={idx} style={{ borderBottom: '1px solid #e0e0e0', background: idx % 2 === 0 ? 'white' : '#fafafa' }}>
                                                    <td style={{ padding: '10px', fontSize: '13px', color: '#333' }}>{pir.pirName}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', fontWeight: '600', color: '#00A86B' }}>{pir.daysSober}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', color: '#666' }}>{pir.avgMood}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', color: '#666' }}>{pir.avgCravings}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', fontWeight: '600', color: pir.riskScore >= 7 ? '#f44336' : pir.riskScore >= 4 ? '#FF9800' : '#00A86B' }}>
                                                        {pir.riskScore}/10
                                                    </td>
                                                    <td style={{ padding: '10px', textAlign: 'center' }}>
                                                        <span style={{
                                                            padding: '4px 12px',
                                                            borderRadius: '12px',
                                                            fontSize: '12px',
                                                            fontWeight: '600',
                                                            background: pir.riskLevel === 'Critical' ? '#ffebee' : pir.riskLevel === 'High' ? '#fff3e0' : '#e8f5e9',
                                                            color: pir.riskLevel === 'Critical' ? '#c62828' : pir.riskLevel === 'High' ? '#ef6c00' : '#2e7d32'
                                                        }}>
                                                            {pir.riskLevel}
                                                        </span>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* Morning Check-ins Table */}
                        {reportData.morningData && reportData.morningData.length > 0 && (
                            <div style={{ marginBottom: '30px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
                                    <h4 style={{ margin: 0, fontSize: '18px', color: '#333' }}>
                                        Morning Check-ins Data
                                    </h4>
                                    <button
                                        onClick={() => exportToCSV(reportData.morningData, 'morning_checkins')}
                                        style={{
                                            padding: '8px 16px',
                                            background: '#00A86B',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            fontWeight: '600'
                                        }}
                                    >
                                        Export CSV
                                    </button>
                                </div>
                                <div style={{ overflowX: 'auto', background: '#f8f9fa', borderRadius: '10px', padding: '15px' }}>
                                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                        <thead>
                                            <tr style={{ background: '#FFA500', color: 'white' }}>
                                                <th style={{ padding: '12px', textAlign: 'left', fontSize: '13px', fontWeight: '600' }}>PIR</th>
                                                <th style={{ padding: '12px', textAlign: 'left', fontSize: '13px', fontWeight: '600' }}>Date</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Mood</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Craving</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Anxiety</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Sleep</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {reportData.morningData.slice(0, 50).map((morning, idx) => (
                                                <tr key={idx} style={{ borderBottom: '1px solid #e0e0e0', background: idx % 2 === 0 ? 'white' : '#fafafa' }}>
                                                    <td style={{ padding: '10px', fontSize: '13px', color: '#333' }}>{morning.pirName}</td>
                                                    <td style={{ padding: '10px', fontSize: '13px', color: '#666' }}>{formatDate(morning.date)}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', fontWeight: '600', color: '#0077CC' }}>{morning.mood}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', fontWeight: '600', color: '#DC143C' }}>{morning.craving}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', fontWeight: '600', color: '#FFA500' }}>{morning.anxiety}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', fontWeight: '600', color: '#9C27B0' }}>{morning.sleep}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* Evening Reflections Table */}
                        {reportData.eveningData && reportData.eveningData.length > 0 && (
                            <div style={{ marginBottom: '30px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
                                    <h4 style={{ margin: 0, fontSize: '18px', color: '#333' }}>
                                        Evening Reflections Data
                                    </h4>
                                    <button
                                        onClick={() => exportToCSV(reportData.eveningData, 'evening_reflections')}
                                        style={{
                                            padding: '8px 16px',
                                            background: '#00A86B',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            fontWeight: '600'
                                        }}
                                    >
                                        Export CSV
                                    </button>
                                </div>
                                <div style={{ overflowX: 'auto', background: '#f8f9fa', borderRadius: '10px', padding: '15px' }}>
                                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                        <thead>
                                            <tr style={{ background: '#9C27B0', color: 'white' }}>
                                                <th style={{ padding: '12px', textAlign: 'left', fontSize: '13px', fontWeight: '600' }}>PIR</th>
                                                <th style={{ padding: '12px', textAlign: 'left', fontSize: '13px', fontWeight: '600' }}>Date</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Overall Day</th>
                                                <th style={{ padding: '12px', textAlign: 'left', fontSize: '13px', fontWeight: '600' }}>Gratitude</th>
                                                <th style={{ padding: '12px', textAlign: 'left', fontSize: '13px', fontWeight: '600' }}>Challenges</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {reportData.eveningData.slice(0, 50).map((evening, idx) => (
                                                <tr key={idx} style={{ borderBottom: '1px solid #e0e0e0', background: idx % 2 === 0 ? 'white' : '#fafafa' }}>
                                                    <td style={{ padding: '10px', fontSize: '13px', color: '#333' }}>{evening.pirName}</td>
                                                    <td style={{ padding: '10px', fontSize: '13px', color: '#666' }}>{formatDate(evening.date)}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', fontWeight: '600', color: '#4682B4' }}>{evening.overallDay}/10</td>
                                                    <td style={{ padding: '10px', fontSize: '12px', color: '#555', maxWidth: '250px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                                        {evening.gratitude || '-'}
                                                    </td>
                                                    <td style={{ padding: '10px', fontSize: '12px', color: '#555', maxWidth: '250px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                                        {evening.challenges || '-'}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* Engagement Data Table */}
                        {reportData.engagementData && reportData.engagementData.length > 0 && (
                            <div style={{ marginBottom: '30px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
                                    <h4 style={{ margin: 0, fontSize: '18px', color: '#333' }}>
                                        Engagement Metrics
                                    </h4>
                                    <button
                                        onClick={() => exportToCSV(reportData.engagementData, 'engagement_metrics')}
                                        style={{
                                            padding: '8px 16px',
                                            background: '#00A86B',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            fontWeight: '600'
                                        }}
                                    >
                                        Export CSV
                                    </button>
                                </div>
                                <div style={{ overflowX: 'auto', background: '#f8f9fa', borderRadius: '10px', padding: '15px' }}>
                                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                        <thead>
                                            <tr style={{ background: '#FF5722', color: 'white' }}>
                                                <th style={{ padding: '12px', textAlign: 'left', fontSize: '13px', fontWeight: '600' }}>PIR</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Check-ins</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Streak</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Assignments</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Completion</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Messages</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Score</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {reportData.engagementData.map((engagement, idx) => (
                                                <tr key={idx} style={{ borderBottom: '1px solid #e0e0e0', background: idx % 2 === 0 ? 'white' : '#fafafa' }}>
                                                    <td style={{ padding: '10px', fontSize: '13px', color: '#333' }}>{engagement.pirName}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', color: '#666' }}>{engagement.checkInCount}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', fontWeight: '600', color: '#00A86B' }}>{engagement.checkInStreak} days</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', color: '#666' }}>{engagement.assignmentCount}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', fontWeight: '600', color: '#4682B4' }}>{engagement.assignmentCompletion}%</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', color: '#666' }}>{engagement.messageCount}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center' }}>
                                                        <span style={{
                                                            padding: '4px 12px',
                                                            borderRadius: '12px',
                                                            fontSize: '12px',
                                                            fontWeight: '600',
                                                            background: engagement.engagementScore >= 75 ? '#e8f5e9' : engagement.engagementScore >= 50 ? '#fff3e0' : '#ffebee',
                                                            color: engagement.engagementScore >= 75 ? '#2e7d32' : engagement.engagementScore >= 50 ? '#ef6c00' : '#c62828'
                                                        }}>
                                                            {engagement.engagementScore}
                                                        </span>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* Risk Data Table */}
                        {reportData.riskData && reportData.riskData.length > 0 && (
                            <div style={{ marginBottom: '30px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
                                    <h4 style={{ margin: 0, fontSize: '18px', color: '#333' }}>
                                        Predictive Risk Analysis
                                    </h4>
                                    <button
                                        onClick={() => exportToCSV(reportData.riskData, 'risk_analysis')}
                                        style={{
                                            padding: '8px 16px',
                                            background: '#00A86B',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            fontWeight: '600'
                                        }}
                                    >
                                        Export CSV
                                    </button>
                                </div>
                                <div style={{ overflowX: 'auto', background: '#f8f9fa', borderRadius: '10px', padding: '15px' }}>
                                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                        <thead>
                                            <tr style={{ background: '#E91E63', color: 'white' }}>
                                                <th style={{ padding: '12px', textAlign: 'left', fontSize: '13px', fontWeight: '600' }}>PIR</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Risk Score</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Level</th>
                                                <th style={{ padding: '12px', textAlign: 'left', fontSize: '13px', fontWeight: '600' }}>Patterns</th>
                                                <th style={{ padding: '12px', textAlign: 'left', fontSize: '13px', fontWeight: '600' }}>Recommendations</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {reportData.riskData.map((risk, idx) => (
                                                <tr key={idx} style={{ borderBottom: '1px solid #e0e0e0', background: idx % 2 === 0 ? 'white' : '#fafafa' }}>
                                                    <td style={{ padding: '10px', fontSize: '13px', color: '#333' }}>{risk.pirName}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', fontWeight: '600', color: risk.riskScore >= 7 ? '#f44336' : risk.riskScore >= 4 ? '#FF9800' : '#00A86B' }}>
                                                        {risk.riskScore}/10
                                                    </td>
                                                    <td style={{ padding: '10px', textAlign: 'center' }}>
                                                        <span style={{
                                                            padding: '4px 12px',
                                                            borderRadius: '12px',
                                                            fontSize: '12px',
                                                            fontWeight: '600',
                                                            background: risk.riskLevel === 'High' ? '#ffebee' : risk.riskLevel === 'Moderate' ? '#fff3e0' : '#e8f5e9',
                                                            color: risk.riskLevel === 'High' ? '#c62828' : risk.riskLevel === 'Moderate' ? '#ef6c00' : '#2e7d32'
                                                        }}>
                                                            {risk.riskLevel}
                                                        </span>
                                                    </td>
                                                    <td style={{ padding: '10px', fontSize: '12px', color: '#555' }}>
                                                        {risk.patterns.length > 0 ? risk.patterns.join(', ') : 'None detected'}
                                                    </td>
                                                    <td style={{ padding: '10px', fontSize: '12px', color: '#555' }}>
                                                        {risk.recommendations.join('; ')}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* Alerts Table */}
                        {reportData.alerts && reportData.alerts.length > 0 && (
                            <div style={{ marginBottom: '30px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
                                    <h4 style={{ margin: 0, fontSize: '18px', color: '#333' }}>
                                        Crisis Alerts & Interventions
                                    </h4>
                                    <button
                                        onClick={() => exportToCSV(reportData.alerts, 'crisis_alerts')}
                                        style={{
                                            padding: '8px 16px',
                                            background: '#00A86B',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            fontWeight: '600'
                                        }}
                                    >
                                        Export CSV
                                    </button>
                                </div>
                                <div style={{ overflowX: 'auto', background: '#f8f9fa', borderRadius: '10px', padding: '15px' }}>
                                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                        <thead>
                                            <tr style={{ background: '#DC143C', color: 'white' }}>
                                                <th style={{ padding: '12px', textAlign: 'left', fontSize: '13px', fontWeight: '600' }}>PIR</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Type</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Priority</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Status</th>
                                                <th style={{ padding: '12px', textAlign: 'left', fontSize: '13px', fontWeight: '600' }}>Created</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {reportData.alerts.slice(0, 50).map((alert, idx) => (
                                                <tr key={idx} style={{ borderBottom: '1px solid #e0e0e0', background: idx % 2 === 0 ? 'white' : '#fafafa' }}>
                                                    <td style={{ padding: '10px', fontSize: '13px', color: '#333' }}>{alert.pirName}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center' }}>
                                                        <span style={{
                                                            padding: '4px 10px',
                                                            borderRadius: '10px',
                                                            fontSize: '11px',
                                                            fontWeight: '600',
                                                            background: alert.type === 'sos' ? '#ffebee' : '#e3f2fd',
                                                            color: alert.type === 'sos' ? '#c62828' : '#1565c0'
                                                        }}>
                                                            {alert.type.toUpperCase()}
                                                        </span>
                                                    </td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', color: alert.priority === 'critical' ? '#f44336' : '#666' }}>
                                                        {alert.priority || 'normal'}
                                                    </td>
                                                    <td style={{ padding: '10px', textAlign: 'center' }}>
                                                        <span style={{
                                                            padding: '4px 10px',
                                                            borderRadius: '10px',
                                                            fontSize: '11px',
                                                            fontWeight: '600',
                                                            background: alert.resolved ? '#e8f5e9' : '#fff3e0',
                                                            color: alert.resolved ? '#2e7d32' : '#ef6c00'
                                                        }}>
                                                            {alert.resolved ? 'Resolved' : 'Active'}
                                                        </span>
                                                    </td>
                                                    <td style={{ padding: '10px', fontSize: '13px', color: '#666' }}>{formatTimeAgo(alert.createdAt)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* PIR Info (for Full PIR Report) */}
                        {reportData.pirInfo && (
                            <div style={{ 
                                marginBottom: '30px',
                                padding: '20px',
                                background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                borderRadius: '12px',
                                color: 'white'
                            }}>
                                <h4 style={{ margin: '0 0 15px 0', fontSize: '20px' }}>PIR Information</h4>
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '15px' }}>
                                    <div>
                                        <div style={{ fontSize: '12px', opacity: 0.9 }}>Name</div>
                                        <div style={{ fontSize: '18px', fontWeight: '600' }}>{reportData.pirInfo.name}</div>
                                    </div>
                                    <div>
                                        <div style={{ fontSize: '12px', opacity: 0.9 }}>Email</div>
                                        <div style={{ fontSize: '18px', fontWeight: '600' }}>{reportData.pirInfo.email}</div>
                                    </div>
                                    <div>
                                        <div style={{ fontSize: '12px', opacity: 0.9 }}>Days Sober</div>
                                        <div style={{ fontSize: '18px', fontWeight: '600' }}>{reportData.pirInfo.daysSober}</div>
                                    </div>
                                    <div>
                                        <div style={{ fontSize: '12px', opacity: 0.9 }}>Sobriety Date</div>
                                        <div style={{ fontSize: '18px', fontWeight: '600' }}>{formatDate(reportData.pirInfo.sobrietyDate)}</div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Comparative Data */}
                        {reportData.comparison && (
                            <div style={{ marginBottom: '30px' }}>
                                <h4 style={{ margin: '0 0 20px 0', fontSize: '18px', color: '#333' }}>
                                    Comparative Analysis: {reportData.pirInfo?.name} vs Program Average
                                </h4>
                                <div style={{ display: 'grid', gap: '15px' }}>
                                    {Object.entries(reportData.comparison).map(([metric, values]) => (
                                        <div key={metric} style={{
                                            padding: '20px',
                                            background: '#f8f9fa',
                                            borderRadius: '10px',
                                            display: 'grid',
                                            gridTemplateColumns: '200px 1fr 1fr',
                                            gap: '20px',
                                            alignItems: 'center'
                                        }}>
                                            <div style={{ fontSize: '16px', fontWeight: '600', color: '#333', textTransform: 'capitalize' }}>
                                                {metric.replace(/([A-Z])/g, ' $1').trim()}
                                            </div>
                                            <div>
                                                <div style={{ fontSize: '12px', color: '#666', marginBottom: '4px' }}>PIR</div>
                                                <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#0077CC' }}>{values.pir}</div>
                                            </div>
                                            <div>
                                                <div style={{ fontSize: '12px', color: '#666', marginBottom: '4px' }}>Program Avg</div>
                                                <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#FFA500' }}>{values.program}</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Achievements/Milestones */}
                        {reportData.achievements && reportData.achievements.length > 0 && (
                            <div style={{ marginBottom: '30px' }}>
                                <h4 style={{ margin: '0 0 20px 0', fontSize: '18px', color: '#333' }}>
                                    Achievements & Milestones
                                </h4>
                                <div style={{ display: 'grid', gap: '12px' }}>
                                    {reportData.achievements.slice(0, 20).map((achievement, idx) => (
                                        <div key={idx} style={{
                                            padding: '15px',
                                            background: achievement.type === 'milestone' ? '#e8f5e9' : '#e3f2fd',
                                            borderRadius: '10px',
                                            borderLeft: `4px solid ${achievement.type === 'milestone' ? '#00A86B' : '#2196F3'}`,
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            alignItems: 'center'
                                        }}>
                                            <div>
                                                <div style={{ fontSize: '15px', fontWeight: '600', color: '#333', marginBottom: '4px' }}>
                                                    {achievement.title}
                                                </div>
                                                <div style={{ fontSize: '13px', color: '#666' }}>
                                                    {achievement.pirName} • {formatDate(achievement.completedAt)}
                                                </div>
                                            </div>
                                            <div style={{
                                                padding: '6px 14px',
                                                background: achievement.type === 'milestone' ? '#00A86B' : '#2196F3',
                                                color: 'white',
                                                borderRadius: '20px',
                                                fontSize: '12px',
                                                fontWeight: '600'
                                            }}>
                                                {achievement.type === 'milestone' ? 'Milestone' : 'Goal'}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Communication Data */}
                        {reportData.pirComms && reportData.pirComms.length > 0 && (
                            <div style={{ marginBottom: '30px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
                                    <h4 style={{ margin: 0, fontSize: '18px', color: '#333' }}>
                                        Communication Activity
                                    </h4>
                                    <button
                                        onClick={() => exportToCSV(reportData.pirComms, 'communication_report')}
                                        style={{
                                            padding: '8px 16px',
                                            background: '#00A86B',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            fontWeight: '600'
                                        }}
                                    >
                                        Export CSV
                                    </button>
                                </div>
                                <div style={{ overflowX: 'auto', background: '#f8f9fa', borderRadius: '10px', padding: '15px' }}>
                                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                        <thead>
                                            <tr style={{ background: '#607D8B', color: 'white' }}>
                                                <th style={{ padding: '12px', textAlign: 'left', fontSize: '13px', fontWeight: '600' }}>PIR</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Messages Sent</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Messages Received</th>
                                                <th style={{ padding: '12px', textAlign: 'center', fontSize: '13px', fontWeight: '600' }}>Total Activity</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {reportData.pirComms.map((comm, idx) => (
                                                <tr key={idx} style={{ borderBottom: '1px solid #e0e0e0', background: idx % 2 === 0 ? 'white' : '#fafafa' }}>
                                                    <td style={{ padding: '10px', fontSize: '13px', color: '#333' }}>{comm.pirName}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', fontWeight: '600', color: '#4682B4' }}>{comm.messagesSent}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', fontWeight: '600', color: '#00A86B' }}>{comm.messagesReceived}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px', fontWeight: '600', color: '#0077CC' }}>{comm.messagesSent + comm.messagesReceived}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            )}
        </div>
    );
}
// COMPLETE SETTINGS VIEW - ALL IN ORDER
function SettingsView({ user }) {
    // ========== STATE VARIABLES ==========
    const [activeSection, setActiveSection] = useState('profile');
    const [settings, setSettings] = useState({
        // Notification Settings
        emailNotifications: false,
        smsNotifications: false,
        pushNotifications: true,
        sosAlertEmail: true,
        sosAlertSMS: false,
        dailyDigest: false,
        weeklyReport: false,
        
        // Check-in Settings
        checkInReminderTime: '09:00',
        eveningReminderTime: '20:00',
        missedCheckInAlert: true,
        
        // Alert Thresholds
        lowMoodThreshold: 3,
        highCravingThreshold: 7,
        highAnxietyThreshold: 7,
        poorSleepThreshold: 3,
        
        // System Settings
        timezone: 'America/Los_Angeles',
        dateFormat: 'MM/DD/YYYY',
        timeFormat: '12h',
        language: 'en',
        autoRefresh: 30,
        
        // Data Management
        autoBackupEnabled: false,
        backupFrequency: 'weekly',
        dataRetentionDays: 2555,
        autoArchiveOldMessages: true,
        archiveAfterDays: 90
    });
    
    const [coaches, setCoaches] = useState([]);
    const [pirs, setPirs] = useState([]);
    const [permissions, setPermissions] = useState({});
    const [saving, setSaving] = useState(false);
    const [loading, setLoading] = useState(true);
    const [googleConnected, setGoogleConnected] = useState(false);
    const [googleEmail, setGoogleEmail] = useState('');
    const [lastGoogleSync, setLastGoogleSync] = useState(null);
    const [notificationPrefs, setNotificationPrefs] = useState({
        // Email Notifications
        emailOnSOS: true,
        emailOnMissedCheckIn: true,
        emailOnNewPIR: true,
        emailOnGoalComplete: false,
        emailOnAlert: true,
        // Push Notifications
        pushOnSOS: true,
        pushOnMessage: false,
        pushOnAlert: true,
        // Calendar Integration
        calendarOnSOS: true,
        calendarOnMeeting: true,
        calendarOnMissedCheckIn: true,
        calendarAutoSync: true,
        // Quiet Hours
        quietHoursEnabled: false,
        quietHoursStart: '22:00',
        quietHoursEnd: '08:00',
        // Digest Settings
        dailyDigest: true,
        dailyDigestTime: '09:00',
        weeklyReport: true
    });

    // Profile-specific state
    const [profileData, setProfileData] = useState({
        firstName: user.firstName || '',
        lastName: user.lastName || '',
        displayName: user.displayName || '',
        phone: user.phone || '',
        email: user.email || '',
        role: user.role || ''
    });
    const [editingProfile, setEditingProfile] = useState(false);
    const [passwordData, setPasswordData] = useState({
        currentPassword: '',
        newPassword: '',
        confirmPassword: ''
    });
    const [showPassword, setShowPassword] = useState({
        current: false,
        new: false,
        confirm: false
    });
    const [passwordStrength, setPasswordStrength] = useState(0);

    // User creation form state
    const [showAddCoachForm, setShowAddCoachForm] = useState(false);
    const [showAddPIRForm, setShowAddPIRForm] = useState(false);
    const [newUserData, setNewUserData] = useState({
        email: '',
        password: '',
        firstName: '',
        lastName: '',
        assignedCoach: ''
    });

    // ========== USEEFFECT - INITIALIZATION ==========
    useEffect(() => {
        loadAllSettings();
        loadGoogleConnectionStatus();
        loadNotificationPreferences();
    }, []);

    // ========== LOAD ALL SETTINGS ==========
    const loadAllSettings = async () => {
        try {
            const [settingsDoc, coachesSnap, pirsSnap, permissionsDoc] = await Promise.all([
                db.collection('settings').doc('system').get(),
                db.collection('users').where('role', 'in', ['coach', 'admin']).get(),
                db.collection('users').where('role', '==', 'pir').get(),
                db.collection('settings').doc('permissions').get()
            ]);

            if (settingsDoc.exists) {
                setSettings({ ...settings, ...settingsDoc.data() });
            }

            setCoaches(coachesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            setPirs(pirsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })));

            if (permissionsDoc.exists) {
                setPermissions(permissionsDoc.data());
            }
        } catch (error) {
            console.error('Error loading settings:', error);
        } finally {
            setLoading(false);
        }
    };

    // ========== SAVE SETTINGS ==========
    const saveSettings = async () => {
        setSaving(true);
        try {
            await db.collection('settings').doc('system').set({
                ...settings,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: user.uid
            });
            alert('Settings saved successfully');
        } catch (error) {
            console.error('Error saving settings:', error);
            alert('Failed to save settings');
        } finally {
            setSaving(false);
        }
    };

    // ========== GOOGLE OAUTH INTEGRATION ==========
    const loadGoogleConnectionStatus = async () => {
        try {
            const userDoc = await db.collection('users').doc(user.uid).get();
            if (userDoc.exists) {
                const userData = userDoc.data();
                setGoogleConnected(userData.googleConnected || false);
                setGoogleEmail(userData.googleEmail || '');
                setLastGoogleSync(userData.lastGoogleSync || null);
            }
        } catch (error) {
            console.error('Error loading Google connection status:', error);
        }
    };

    const handleGoogleConnect = async () => {
        try {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.addScope('https://www.googleapis.com/auth/calendar');
            provider.addScope('https://www.googleapis.com/auth/calendar.events');

            const result = await auth.currentUser.linkWithPopup(provider);
            const credential = result.credential;
            const token = credential.accessToken;

            // Save token and connection info to user document
            await db.collection('users').doc(user.uid).update({
                googleAccessToken: token,
                googleRefreshToken: credential.refreshToken || null,
                googleConnected: true,
                googleEmail: result.user.email,
                googleConnectionDate: firebase.firestore.FieldValue.serverTimestamp(),
                lastGoogleSync: firebase.firestore.FieldValue.serverTimestamp()
            });

            setGoogleConnected(true);
            setGoogleEmail(result.user.email);
            setLastGoogleSync(new Date());

            // Log audit trail
            await logAudit({
                userId: user.uid,
                tenantId: CURRENT_TENANT,
                action: 'google-connected',
                resourceType: 'integrations',
                resourceId: user.uid,
                details: { email: result.user.email }
            });

            alert('✅ Google Calendar connected successfully!');
        } catch (error) {
            console.error('Google OAuth error:', error);
            if (error.code === 'auth/credential-already-in-use') {
                alert('This Google account is already linked to another user.');
            } else {
                alert('Failed to connect Google Calendar. Please try again.');
            }
        }
    };

    const handleGoogleDisconnect = async () => {
        if (!confirm('Are you sure you want to disconnect Google Calendar? This will stop all calendar syncing.')) {
            return;
        }

        try {
            await db.collection('users').doc(user.uid).update({
                googleAccessToken: firebase.firestore.FieldValue.delete(),
                googleRefreshToken: firebase.firestore.FieldValue.delete(),
                googleConnected: false,
                googleEmail: firebase.firestore.FieldValue.delete(),
                googleDisconnectedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            setGoogleConnected(false);
            setGoogleEmail('');
            setLastGoogleSync(null);

            // Log audit trail
            await logAudit({
                userId: user.uid,
                tenantId: CURRENT_TENANT,
                action: 'google-disconnected',
                resourceType: 'integrations',
                resourceId: user.uid
            });

            alert('Google Calendar disconnected successfully');
        } catch (error) {
            console.error('Error disconnecting Google:', error);
            alert('Failed to disconnect Google Calendar');
        }
    };

    // ========== GOOGLE CALENDAR SYNC ==========
    const syncToGoogleCalendar = async () => {
        if (!googleConnected) {
            alert('Please connect Google Calendar first');
            return;
        }

        setSaving(true);
        try {
            const userDoc = await db.collection('users').doc(user.uid).get();
            const accessToken = userDoc.data().googleAccessToken;

            if (!accessToken) {
                alert('Google access token not found. Please reconnect.');
                return;
            }

            // Get all meetings from Firestore
            const meetingsSnap = await db.collection('meetings')
                .where('tenantId', '==', CURRENT_TENANT)
                .get();

            let synced = 0;
            const errors = [];

            for (const doc of meetingsSnap.docs) {
                const meeting = { id: doc.id, ...doc.data() };

                // Skip if already synced
                if (meeting.googleEventId) continue;

                try {
                    const event = {
                        summary: meeting.title || 'GLRS Meeting',
                        description: meeting.description || 'Meeting scheduled via GLRS',
                        start: {
                            dateTime: meeting.startTime?.toDate ? meeting.startTime.toDate().toISOString() : new Date(meeting.date).toISOString(),
                            timeZone: 'America/Los_Angeles'
                        },
                        end: {
                            dateTime: meeting.endTime?.toDate ? meeting.endTime.toDate().toISOString() : new Date(new Date(meeting.date).getTime() + 3600000).toISOString(),
                            timeZone: 'America/Los_Angeles'
                        }
                    };

                    const response = await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(event)
                    });

                    if (response.ok) {
                        const data = await response.json();
                        await db.collection('meetings').doc(meeting.id).update({
                            googleEventId: data.id,
                            lastSyncedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        synced++;
                    } else {
                        const error = await response.json();
                        errors.push(`${meeting.title}: ${error.message || 'Unknown error'}`);
                    }
                } catch (error) {
                    errors.push(`${meeting.title}: ${error.message}`);
                }
            }

            // Update last sync time
            await db.collection('users').doc(user.uid).update({
                lastGoogleSync: firebase.firestore.FieldValue.serverTimestamp()
            });

            setLastGoogleSync(new Date());

            if (errors.length > 0) {
                alert(`✅ Synced ${synced} meetings to Google Calendar\n\n❌ ${errors.length} failed:\n${errors.slice(0, 3).join('\n')}${errors.length > 3 ? '\n...' : ''}`);
            } else {
                alert(`✅ Successfully synced ${synced} meetings to Google Calendar!`);
            }
        } catch (error) {
            console.error('Error syncing to Google Calendar:', error);
            alert('Failed to sync to Google Calendar: ' + error.message);
        } finally {
            setSaving(false);
        }
    };

    const syncFromGoogleCalendar = async () => {
        if (!googleConnected) {
            alert('Please connect Google Calendar first');
            return;
        }

        setSaving(true);
        try {
            const userDoc = await db.collection('users').doc(user.uid).get();
            const accessToken = userDoc.data().googleAccessToken;

            if (!accessToken) {
                alert('Google access token not found. Please reconnect.');
                return;
            }

            // Get events from Google Calendar (next 30 days)
            const timeMin = new Date().toISOString();
            const timeMax = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString();

            const response = await fetch(
                `https://www.googleapis.com/calendar/v3/calendars/primary/events?timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`,
                {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                }
            );

            if (!response.ok) {
                throw new Error('Failed to fetch Google Calendar events');
            }

            const data = await response.json();
            let imported = 0;

            for (const event of data.items || []) {
                // Skip if event already exists in Firestore
                const existingSnap = await db.collection('meetings')
                    .where('googleEventId', '==', event.id)
                    .limit(1)
                    .get();

                if (!existingSnap.empty) continue;

                // Create meeting in Firestore
                await db.collection('meetings').add({
                    title: event.summary || 'Imported Meeting',
                    description: event.description || '',
                    startTime: firebase.firestore.Timestamp.fromDate(new Date(event.start.dateTime || event.start.date)),
                    endTime: firebase.firestore.Timestamp.fromDate(new Date(event.end.dateTime || event.end.date)),
                    googleEventId: event.id,
                    tenantId: CURRENT_TENANT,
                    createdBy: user.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    importedFromGoogle: true
                });
                imported++;
            }

            // Update last sync time
            await db.collection('users').doc(user.uid).update({
                lastGoogleSync: firebase.firestore.FieldValue.serverTimestamp()
            });

            setLastGoogleSync(new Date());
            alert(`✅ Successfully imported ${imported} events from Google Calendar!`);
        } catch (error) {
            console.error('Error importing from Google Calendar:', error);
            alert('Failed to import from Google Calendar: ' + error.message);
        } finally {
            setSaving(false);
        }
    };

    // ========== NOTIFICATION PREFERENCES ==========
    const loadNotificationPreferences = async () => {
        try {
            const notifDoc = await db.collection('settings').doc(`${user.uid}-notifications`).get();
            if (notifDoc.exists) {
                setNotificationPrefs({ ...notificationPrefs, ...notifDoc.data() });
            }
        } catch (error) {
            console.error('Error loading notification preferences:', error);
        }
    };

    const saveNotificationPreferences = async () => {
        setSaving(true);
        try {
            await db.collection('settings').doc(`${user.uid}-notifications`).set({
                ...notificationPrefs,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: user.uid,
                tenantId: CURRENT_TENANT
            });

            // Log audit trail
            await logAudit({
                userId: user.uid,
                tenantId: CURRENT_TENANT,
                action: 'notification-preferences-updated',
                resourceType: 'settings',
                resourceId: `${user.uid}-notifications`
            });

            alert('✅ Notification preferences saved successfully!');
        } catch (error) {
            console.error('Error saving notification preferences:', error);
            alert('Failed to save notification preferences');
        } finally {
            setSaving(false);
        }
    };

    // ========== PROFILE MANAGEMENT ==========
    const calculatePasswordStrength = (password) => {
        let strength = 0;
        if (password.length >= 8) strength += 25;
        if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength += 25;
        if (password.match(/[0-9]/)) strength += 25;
        if (password.match(/[^a-zA-Z0-9]/)) strength += 25;
        return strength;
    };

    const handlePasswordChange = (value) => {
        setPasswordData({...passwordData, newPassword: value});
        setPasswordStrength(calculatePasswordStrength(value));
    };

    const getPasswordStrengthColor = () => {
        if (passwordStrength <= 25) return '#f44336';
        if (passwordStrength <= 50) return '#FF9800';
        if (passwordStrength <= 75) return '#FFC107';
        return '#00A86B';
    };

    const getPasswordStrengthLabel = () => {
        if (passwordStrength <= 25) return 'Weak';
        if (passwordStrength <= 50) return 'Fair';
        if (passwordStrength <= 75) return 'Good';
        return 'Strong';
    };

    const handleSaveProfile = async () => {
        setSaving(true);
        try {
            const updates = {
                firstName: profileData.firstName,
                lastName: profileData.lastName,
                displayName: `${profileData.firstName} ${profileData.lastName}`,
                phone: profileData.phone,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            await db.collection('users').doc(user.uid).update(updates);

            // Log audit trail
            await logAudit({
                userId: user.uid,
                tenantId: CURRENT_TENANT,
                action: 'profile-updated',
                resourceType: 'user',
                resourceId: user.uid
            });

            // Update user object
            Object.assign(user, updates);

            setEditingProfile(false);
            alert('✅ Profile updated successfully!');
        } catch (error) {
            console.error('Error updating profile:', error);
            alert('Failed to update profile: ' + error.message);
        } finally {
            setSaving(false);
        }
    };

    const handleChangePassword = async () => {
        if (passwordData.newPassword !== passwordData.confirmPassword) {
            alert('New passwords do not match');
            return;
        }

        if (passwordData.newPassword.length < 6) {
            alert('Password must be at least 6 characters');
            return;
        }

        setSaving(true);
        try {
            const credential = firebase.auth.EmailAuthProvider.credential(
                user.email,
                passwordData.currentPassword
            );

            await auth.currentUser.reauthenticateWithCredential(credential);
            await auth.currentUser.updatePassword(passwordData.newPassword);

            // Log audit trail
            await logAudit({
                userId: user.uid,
                tenantId: CURRENT_TENANT,
                action: 'password-changed',
                resourceType: 'user',
                resourceId: user.uid
            });

            alert('✅ Password changed successfully!');
            setPasswordData({
                currentPassword: '',
                newPassword: '',
                confirmPassword: ''
            });
            setPasswordStrength(0);
        } catch (error) {
            console.error('Error changing password:', error);
            if (error.code === 'auth/wrong-password') {
                alert('Current password is incorrect');
            } else {
                alert('Failed to change password: ' + error.message);
            }
        } finally {
            setSaving(false);
        }
    };

    // ========== ADD COACH ==========
    const handleAddCoach = () => {
        setShowAddCoachForm(!showAddCoachForm);
        setShowAddPIRForm(false);
        setNewUserData({ email: '', password: '', firstName: '', lastName: '', assignedCoach: '' });
    };

    const submitAddCoach = async () => {
        const { email, password, firstName, lastName } = newUserData;

        if (!email || !password || !firstName || !lastName) {
            alert('Please fill in all fields');
            return;
        }

        setSaving(true);
        try {
            const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);

            await db.collection('users').doc(userCredential.user.uid).set({
                email,
                firstName,
                lastName,
                displayName: `${firstName} ${lastName}`,
                role: 'coach',
                active: true,
                tenantId: CURRENT_TENANT,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: user.uid
            });

            await loadAllSettings();
            setShowAddCoachForm(false);
            setNewUserData({ email: '', password: '', firstName: '', lastName: '', assignedCoach: '' });
            alert('✅ Coach added successfully!');
        } catch (error) {
            console.error('Error adding coach:', error);
            alert('Failed to add coach: ' + error.message);
        } finally {
            setSaving(false);
        }
    };

    // ========== ADD PIR ==========
    const handleAddPIR = () => {
        setShowAddPIRForm(!showAddPIRForm);
        setShowAddCoachForm(false);
        setNewUserData({ email: '', password: '', firstName: '', lastName: '', assignedCoach: '' });
    };

    const submitAddPIR = async () => {
        const { email, password, firstName, lastName, assignedCoach } = newUserData;

        if (!email || !password || !firstName || !lastName) {
            alert('Please fill in all required fields');
            return;
        }

        setSaving(true);
        try {
            const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);

            await db.collection('users').doc(userCredential.user.uid).set({
                email,
                firstName,
                lastName,
                displayName: `${firstName} ${lastName}`,
                role: 'pir',
                active: true,
                assignedCoach: assignedCoach || null,
                tenantId: CURRENT_TENANT,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: user.uid
            });

            await loadAllSettings();
            setShowAddPIRForm(false);
            setNewUserData({ email: '', password: '', firstName: '', lastName: '', assignedCoach: '' });
            alert('✅ PIR added successfully!');
        } catch (error) {
            console.error('Error adding PIR:', error);
            alert('Failed to add PIR: ' + error.message);
        } finally {
            setSaving(false);
        }
    };

    // ========== REMOVE USER ==========
    const handleRemoveUser = async (userId, role) => {
        if (!confirm(`Are you sure you want to remove this ${role}?`)) return;

        try {
            await db.collection('users').doc(userId).update({
                active: false,
                deactivatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                deactivatedBy: user.uid
            });

            await loadAllSettings();
            alert(`${role} removed successfully`);
        } catch (error) {
            console.error('Error removing user:', error);
            alert('Failed to remove user');
        }
    };

    // ========== ASSIGN COACH ==========
    const handleAssignCoach = async (pirId) => {
        const coachId = prompt('Enter coach ID to assign:');
        if (!coachId) return;

        try {
            await db.collection('users').doc(pirId).update({
                assignedCoach: coachId,
                assignedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            await loadAllSettings();
            alert('Coach assigned successfully');
        } catch (error) {
            console.error('Error assigning coach:', error);
            alert('Failed to assign coach');
        }
    };

    // ========== CHANGE COACH ==========
    const handleChangeCoach = async (pirId, currentCoachId) => {
        const newCoachId = prompt('Enter new coach ID:', currentCoachId);
        if (!newCoachId) return;

        try {
            await db.collection('users').doc(pirId).update({
                assignedCoach: newCoachId,
                coachChangedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            await loadAllSettings();
            alert('Coach changed successfully');
        } catch (error) {
            console.error('Error changing coach:', error);
            alert('Failed to change coach');
        }
    };

    // ========== UPDATE PERMISSIONS ==========
    const updatePermissions = async (userId, permissionType, value) => {
        try {
            const updatedPermissions = {
                ...permissions,
                [userId]: {
                    ...permissions[userId],
                    [permissionType]: value
                }
            };

            await db.collection('settings').doc('permissions').set(updatedPermissions);
            setPermissions(updatedPermissions);
            alert('Permissions updated');
        } catch (error) {
            console.error('Error updating permissions:', error);
            alert('Failed to update permissions');
        }
    };

    // ========== DATA EXPORT ==========
    const handleDataExport = async (format, scope, dataType) => {
        try {
            let data = {};

            if (scope === 'all') {
                const collections = ['users', 'checkIns', 'assignments', 'alerts', 'messages', 'goals', 'feedback', 'activities', 'notifications'];
                
                for (const collection of collections) {
                    const snapshot = await db.collection(collection).get();
                    data[collection] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }
            } else if (scope === 'specific_pir') {
                const pirId = prompt('Enter PIR ID:');
                if (!pirId) return;

                const pirDoc = await db.collection('users').doc(pirId).get();
                if (!pirDoc.exists) {
                    alert('PIR not found');
                    return;
                }

                data.pir = { id: pirDoc.id, ...pirDoc.data() };
                
                const [checkIns, assignments, goals, alerts, messages] = await Promise.all([
                    db.collection('checkIns').where('userId', '==', pirId).get(),
                    db.collection('assignments').where('userId', '==', pirId).get(),
                    db.collection('goals').where('userId', '==', pirId).get(),
                    db.collection('alerts').where('userId', '==', pirId).get(),
                    db.collection('messages').where('senderId', '==', pirId).get()
                ]);

                data.checkIns = checkIns.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                data.assignments = assignments.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                data.goals = goals.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                data.alerts = alerts.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                data.messages = messages.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } else if (scope === 'data_type') {
                const snapshot = await db.collection(dataType).get();
                data[dataType] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }

            const fileName = `glrs_export_${scope}_${new Date().toISOString().split('T')[0]}`;

            if (format === 'json') {
                exportToJSON(data, fileName);
            } else if (format === 'csv') {
                exportToCSV(data, fileName);
            } else if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text('Data Export', 20, 20);
                doc.text(JSON.stringify(data, null, 2).substring(0, 1000), 20, 30);
                doc.save(`${fileName}.pdf`);
            }

            alert('Export completed successfully');
        } catch (error) {
            console.error('Error exporting data:', error);
            alert('Export failed: ' + error.message);
        }
    };

    // ========== LOADING STATE ==========
    if (loading) {
        return (
            <div className="loading-container">
                <div className="loading-spinner"></div>
            </div>
        );
    }

    // ========== RETURN JSX ==========
    return (
        <div style={{ display: 'flex', gap: '20px', minHeight: '100vh' }}>
            {/* SIDEBAR NAVIGATION */}
            <div style={{
                width: '280px',
                background: 'linear-gradient(180deg, var(--primary-color-light, rgba(102, 126, 234, 0.1)) 0%, var(--secondary-color-light, rgba(118, 75, 162, 0.05)) 100%)',
                borderRadius: '20px',
                padding: '30px 20px',
                backdropFilter: 'blur(10px)',
                border: '1px solid rgba(255,255,255,0.1)'
            }}>
                <h3 style={{
                    marginBottom: '30px',
                    background: 'linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%)',
                    WebkitBackgroundClip: 'text',
                    WebkitTextFillColor: 'transparent',
                    fontSize: '24px',
                    fontWeight: 'bold'
                }}>Settings</h3>
                
                {[
                    { id: 'profile', icon: '👤', label: 'My Profile' },
                    { id: 'notifications', icon: '🔔', label: 'Notifications' },
                    { id: 'checkins', icon: '✅', label: 'Check-ins' },
                    { id: 'alerts', icon: '⚠️', label: 'Alert Thresholds' },
                    { id: 'dataExport', icon: '📥', label: 'Data Export' },
                    { id: 'userManagement', icon: '👥', label: 'User Management' },
                    { id: 'permissions', icon: '🔐', label: 'Permissions' },
                    { id: 'integrations', icon: '🔌', label: 'Integrations' },
                    { id: 'system', icon: '⚙️', label: 'System Config' }
                ].map(section => (
                    <div
                        key={section.id}
                        onClick={() => setActiveSection(section.id)}
                        style={{
                            padding: '16px 20px',
                            borderRadius: '12px',
                            cursor: 'pointer',
                            background: activeSection === section.id
                                ? 'linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%)'
                                : 'transparent',
                            marginBottom: '8px',
                            transition: 'all 0.3s',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '12px',
                            transform: activeSection === section.id ? 'translateX(5px)' : 'translateX(0)',
                            boxShadow: activeSection === section.id ? '0 8px 16px var(--primary-color-shadow, rgba(102, 126, 234, 0.3))' : 'none'
                        }}
                    >
                        <span style={{ fontSize: '20px' }}>{section.icon}</span>
                        <span style={{ fontWeight: activeSection === section.id ? 'bold' : 'normal' }}>
                            {section.label}
                        </span>
                    </div>
                ))}
            </div>

            {/* MAIN CONTENT */}
            <div style={{ flex: 1 }}>
                {/* PROFILE SECTION */}
                {activeSection === 'profile' && (
                    <div className="table-container" style={{
                        background: 'linear-gradient(135deg, var(--primary-color-light, rgba(102, 126, 234, 0.05)) 0%, var(--secondary-color-light, rgba(118, 75, 162, 0.05)) 100%)',
                        border: '1px solid rgba(255,255,255,0.1)',
                        borderRadius: '20px',
                        padding: '30px'
                    }}>
                        <h3 style={{
                            marginBottom: '30px',
                            background: 'linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%)',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            fontSize: '28px',
                            fontWeight: 'bold'
                        }}>My Profile</h3>

                        {/* Profile Information */}
                        <div style={{
                            background: 'white',
                            borderRadius: '15px',
                            padding: '25px',
                            marginBottom: '25px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                        }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                                <h4 style={{ margin: 0, fontSize: '18px', color: '#333' }}>Profile Information</h4>
                                <button
                                    onClick={() => editingProfile ? handleSaveProfile() : setEditingProfile(true)}
                                    disabled={saving}
                                    style={{
                                        padding: '10px 24px',
                                        background: editingProfile
                                            ? 'linear-gradient(135deg, #00A86B 0%, #008554 100%)'
                                            : 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '10px',
                                        cursor: saving ? 'not-allowed' : 'pointer',
                                        fontSize: '14px',
                                        fontWeight: '600',
                                        transition: 'transform 0.2s'
                                    }}
                                >
                                    {saving ? 'Saving...' : editingProfile ? 'Save Changes' : 'Edit Profile'}
                                </button>
                            </div>

                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '20px' }}>
                                <div>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        First Name
                                    </label>
                                    <input
                                        type="text"
                                        value={profileData.firstName}
                                        onChange={(e) => setProfileData({...profileData, firstName: e.target.value})}
                                        disabled={!editingProfile}
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '10px',
                                            fontSize: '14px',
                                            background: editingProfile ? 'white' : '#f8f9fa'
                                        }}
                                    />
                                </div>

                                <div>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        Last Name
                                    </label>
                                    <input
                                        type="text"
                                        value={profileData.lastName}
                                        onChange={(e) => setProfileData({...profileData, lastName: e.target.value})}
                                        disabled={!editingProfile}
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '10px',
                                            fontSize: '14px',
                                            background: editingProfile ? 'white' : '#f8f9fa'
                                        }}
                                    />
                                </div>

                                <div>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        Email Address
                                    </label>
                                    <input
                                        type="email"
                                        value={profileData.email}
                                        disabled
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '10px',
                                            fontSize: '14px',
                                            background: '#f8f9fa',
                                            color: '#999'
                                        }}
                                    />
                                </div>

                                <div>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        Phone Number
                                    </label>
                                    <input
                                        type="tel"
                                        value={profileData.phone}
                                        onChange={(e) => setProfileData({...profileData, phone: e.target.value})}
                                        disabled={!editingProfile}
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '10px',
                                            fontSize: '14px',
                                            background: editingProfile ? 'white' : '#f8f9fa'
                                        }}
                                    />
                                </div>

                                <div>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        Role
                                    </label>
                                    <input
                                        type="text"
                                        value={profileData.role.toUpperCase()}
                                        disabled
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '10px',
                                            fontSize: '14px',
                                            background: '#f8f9fa',
                                            color: '#999'
                                        }}
                                    />
                                </div>
                            </div>

                            {editingProfile && (
                                <button
                                    onClick={() => {
                                        setEditingProfile(false);
                                        setProfileData({
                                            firstName: user.firstName || '',
                                            lastName: user.lastName || '',
                                            displayName: user.displayName || '',
                                            phone: user.phone || '',
                                            email: user.email || '',
                                            role: user.role || ''
                                        });
                                    }}
                                    style={{
                                        marginTop: '20px',
                                        padding: '10px 24px',
                                        background: '#6c757d',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '10px',
                                        cursor: 'pointer',
                                        fontSize: '14px',
                                        fontWeight: '600'
                                    }}
                                >
                                    Cancel
                                </button>
                            )}
                        </div>

                        {/* Change Password */}
                        <div style={{
                            background: 'white',
                            borderRadius: '15px',
                            padding: '25px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                        }}>
                            <h4 style={{ margin: '0 0 20px 0', fontSize: '18px', color: '#333' }}>Change Password</h4>

                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '20px', marginBottom: '20px' }}>
                                <div>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        Current Password
                                    </label>
                                    <input
                                        type={showPassword.current ? 'text' : 'password'}
                                        value={passwordData.currentPassword}
                                        onChange={(e) => setPasswordData({...passwordData, currentPassword: e.target.value})}
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '10px',
                                            fontSize: '14px'
                                        }}
                                    />
                                </div>

                                <div>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        New Password
                                    </label>
                                    <input
                                        type={showPassword.new ? 'text' : 'password'}
                                        value={passwordData.newPassword}
                                        onChange={(e) => handlePasswordChange(e.target.value)}
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '10px',
                                            fontSize: '14px'
                                        }}
                                    />
                                    {passwordData.newPassword && (
                                        <div style={{ marginTop: '8px' }}>
                                            <div style={{
                                                height: '4px',
                                                background: '#e0e0e0',
                                                borderRadius: '2px',
                                                overflow: 'hidden'
                                            }}>
                                                <div style={{
                                                    height: '100%',
                                                    width: `${passwordStrength}%`,
                                                    background: getPasswordStrengthColor(),
                                                    transition: 'all 0.3s'
                                                }}></div>
                                            </div>
                                            <div style={{
                                                fontSize: '12px',
                                                color: getPasswordStrengthColor(),
                                                marginTop: '4px'
                                            }}>
                                                {getPasswordStrengthLabel()}
                                            </div>
                                        </div>
                                    )}
                                </div>

                                <div>
                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                        Confirm New Password
                                    </label>
                                    <input
                                        type={showPassword.confirm ? 'text' : 'password'}
                                        value={passwordData.confirmPassword}
                                        onChange={(e) => setPasswordData({...passwordData, confirmPassword: e.target.value})}
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: `2px solid ${passwordData.confirmPassword && passwordData.confirmPassword !== passwordData.newPassword ? '#f44336' : '#e0e0e0'}`,
                                            borderRadius: '10px',
                                            fontSize: '14px'
                                        }}
                                    />
                                    {passwordData.confirmPassword && passwordData.confirmPassword !== passwordData.newPassword && (
                                        <div style={{ fontSize: '12px', color: '#DC143C', marginTop: '4px' }}>
                                            Passwords do not match
                                        </div>
                                    )}
                                </div>
                            </div>

                            <button
                                onClick={handleChangePassword}
                                disabled={saving || !passwordData.currentPassword || !passwordData.newPassword || passwordData.newPassword !== passwordData.confirmPassword}
                                style={{
                                    padding: '12px 32px',
                                    background: (saving || !passwordData.currentPassword || !passwordData.newPassword || passwordData.newPassword !== passwordData.confirmPassword)
                                        ? '#ccc'
                                        : 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '10px',
                                    cursor: (saving || !passwordData.currentPassword || !passwordData.newPassword || passwordData.newPassword !== passwordData.confirmPassword)
                                        ? 'not-allowed'
                                        : 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '600'
                                }}
                            >
                                {saving ? 'Changing Password...' : 'Change Password'}
                            </button>
                        </div>
                    </div>
                )}

                {/* NOTIFICATIONS SECTION */}
                {activeSection === 'notifications' && (
                    <div className="table-container" style={{
                        background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%)',
                        border: '1px solid rgba(255,255,255,0.1)',
                        borderRadius: '20px',
                        padding: '30px'
                    }}>
                        <h3 style={{
                            marginBottom: '30px',
                            background: 'linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%)',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            fontSize: '28px'
                        }}>Notification Settings</h3>

                        <div style={{ marginBottom: '40px' }}>
                            <h4 style={{ marginBottom: '20px', color: '#0077CC' }}>Email Notifications</h4>
                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="emailOnSOS"
                                    checked={notificationPrefs.emailOnSOS}
                                    onChange={(e) => setNotificationPrefs({...notificationPrefs, emailOnSOS: e.target.checked})}
                                />
                                <label htmlFor="emailOnSOS">SOS Alert Emails</label>
                            </div>

                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="emailOnMissedCheckIn"
                                    checked={notificationPrefs.emailOnMissedCheckIn}
                                    onChange={(e) => setNotificationPrefs({...notificationPrefs, emailOnMissedCheckIn: e.target.checked})}
                                />
                                <label htmlFor="emailOnMissedCheckIn">Missed Check-in Alerts</label>
                            </div>

                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="emailOnNewPIR"
                                    checked={notificationPrefs.emailOnNewPIR}
                                    onChange={(e) => setNotificationPrefs({...notificationPrefs, emailOnNewPIR: e.target.checked})}
                                />
                                <label htmlFor="emailOnNewPIR">New PIR Assignments</label>
                            </div>

                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="emailOnAlert"
                                    checked={notificationPrefs.emailOnAlert}
                                    onChange={(e) => setNotificationPrefs({...notificationPrefs, emailOnAlert: e.target.checked})}
                                />
                                <label htmlFor="emailOnAlert">Alert Notifications</label>
                            </div>

                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="emailOnGoalComplete"
                                    checked={notificationPrefs.emailOnGoalComplete}
                                    onChange={(e) => setNotificationPrefs({...notificationPrefs, emailOnGoalComplete: e.target.checked})}
                                />
                                <label htmlFor="emailOnGoalComplete">Goal Completions</label>
                            </div>

                        </div>

                        <div style={{ marginBottom: '40px' }}>
                            <h4 style={{ marginBottom: '20px', color: '#0077CC' }}>Push Notifications</h4>
                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="pushOnSOS"
                                    checked={notificationPrefs.pushOnSOS}
                                    onChange={(e) => setNotificationPrefs({...notificationPrefs, pushOnSOS: e.target.checked})}
                                />
                                <label htmlFor="pushOnSOS">SOS Alert Push Notifications</label>
                            </div>

                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="pushOnMessage"
                                    checked={notificationPrefs.pushOnMessage}
                                    onChange={(e) => setNotificationPrefs({...notificationPrefs, pushOnMessage: e.target.checked})}
                                />
                                <label htmlFor="pushOnMessage">New Message Notifications</label>
                            </div>

                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="pushOnAlert"
                                    checked={notificationPrefs.pushOnAlert}
                                    onChange={(e) => setNotificationPrefs({...notificationPrefs, pushOnAlert: e.target.checked})}
                                />
                                <label htmlFor="pushOnAlert">Alert Notifications</label>
                            </div>
                        </div>

                        {googleConnected && (
                            <div style={{ marginBottom: '40px' }}>
                                <h4 style={{ marginBottom: '20px', color: '#0077CC' }}>Google Calendar Sync</h4>
                                <div className="checkbox-group">
                                    <input
                                        type="checkbox"
                                        id="calendarAutoSync"
                                        checked={notificationPrefs.calendarAutoSync}
                                        onChange={(e) => setNotificationPrefs({...notificationPrefs, calendarAutoSync: e.target.checked})}
                                    />
                                    <label htmlFor="calendarAutoSync">Enable Auto-Sync</label>
                                </div>

                                <div className="checkbox-group">
                                    <input
                                        type="checkbox"
                                        id="calendarOnSOS"
                                        checked={notificationPrefs.calendarOnSOS}
                                        onChange={(e) => setNotificationPrefs({...notificationPrefs, calendarOnSOS: e.target.checked})}
                                    />
                                    <label htmlFor="calendarOnSOS">Create Calendar Event for SOS Alerts</label>
                                </div>

                                <div className="checkbox-group">
                                    <input
                                        type="checkbox"
                                        id="calendarOnMeeting"
                                        checked={notificationPrefs.calendarOnMeeting}
                                        onChange={(e) => setNotificationPrefs({...notificationPrefs, calendarOnMeeting: e.target.checked})}
                                    />
                                    <label htmlFor="calendarOnMeeting">Sync Scheduled Meetings</label>
                                </div>

                                <div className="checkbox-group">
                                    <input
                                        type="checkbox"
                                        id="calendarOnMissedCheckIn"
                                        checked={notificationPrefs.calendarOnMissedCheckIn}
                                        onChange={(e) => setNotificationPrefs({...notificationPrefs, calendarOnMissedCheckIn: e.target.checked})}
                                    />
                                    <label htmlFor="calendarOnMissedCheckIn">Create Reminder for Missed Check-ins</label>
                                </div>
                            </div>
                        )}

                        <div style={{ marginBottom: '40px' }}>
                            <h4 style={{ marginBottom: '20px', color: '#0077CC' }}>Quiet Hours</h4>
                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="quietHoursEnabled"
                                    checked={notificationPrefs.quietHoursEnabled}
                                    onChange={(e) => setNotificationPrefs({...notificationPrefs, quietHoursEnabled: e.target.checked})}
                                />
                                <label htmlFor="quietHoursEnabled">Enable Quiet Hours (no notifications during this time)</label>
                            </div>

                            {notificationPrefs.quietHoursEnabled && (
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px', marginTop: '15px' }}>
                                    <div className="form-group">
                                        <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>Start Time</label>
                                        <input
                                            type="time"
                                            className="form-input"
                                            value={notificationPrefs.quietHoursStart}
                                            onChange={(e) => setNotificationPrefs({...notificationPrefs, quietHoursStart: e.target.value})}
                                            style={{
                                                background: 'rgba(255,255,255,0.05)',
                                                border: '1px solid rgba(255,255,255,0.1)',
                                                borderRadius: '8px',
                                                padding: '12px',
                                                color: '#fff',
                                                width: '100%'
                                            }}
                                        />
                                    </div>

                                    <div className="form-group">
                                        <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>End Time</label>
                                        <input
                                            type="time"
                                            className="form-input"
                                            value={notificationPrefs.quietHoursEnd}
                                            onChange={(e) => setNotificationPrefs({...notificationPrefs, quietHoursEnd: e.target.value})}
                                            style={{
                                                background: 'rgba(255,255,255,0.05)',
                                                border: '1px solid rgba(255,255,255,0.1)',
                                                borderRadius: '8px',
                                                padding: '12px',
                                                color: '#fff',
                                                width: '100%'
                                            }}
                                        />
                                    </div>
                                </div>
                            )}
                        </div>

                        <div style={{ marginBottom: '40px' }}>
                            <h4 style={{ marginBottom: '20px', color: '#0077CC' }}>Digest & Reports</h4>
                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="dailyDigest"
                                    checked={notificationPrefs.dailyDigest}
                                    onChange={(e) => setNotificationPrefs({...notificationPrefs, dailyDigest: e.target.checked})}
                                />
                                <label htmlFor="dailyDigest">Daily Digest Email</label>
                            </div>

                            {notificationPrefs.dailyDigest && (
                                <div className="form-group" style={{ marginTop: '15px', maxWidth: '200px' }}>
                                    <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>Delivery Time</label>
                                    <input
                                        type="time"
                                        className="form-input"
                                        value={notificationPrefs.dailyDigestTime}
                                        onChange={(e) => setNotificationPrefs({...notificationPrefs, dailyDigestTime: e.target.value})}
                                        style={{
                                            background: 'rgba(255,255,255,0.05)',
                                            border: '1px solid rgba(255,255,255,0.1)',
                                            borderRadius: '8px',
                                            padding: '12px',
                                            color: '#fff',
                                            width: '100%'
                                        }}
                                    />
                                </div>
                            )}

                            <div className="checkbox-group" style={{ marginTop: '15px' }}>
                                <input
                                    type="checkbox"
                                    id="weeklyReport"
                                    checked={notificationPrefs.weeklyReport}
                                    onChange={(e) => setNotificationPrefs({...notificationPrefs, weeklyReport: e.target.checked})}
                                />
                                <label htmlFor="weeklyReport">Weekly Summary Report</label>
                            </div>
                        </div>

                        <button className="btn btn-primary" onClick={saveNotificationPreferences} disabled={saving} style={{
                            marginTop: '30px',
                            background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                            border: 'none',
                            padding: '14px 32px',
                            fontSize: '16px',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            transition: 'transform 0.2s',
                            boxShadow: '0 4px 15px rgba(102, 126, 234, 0.4)'
                        }}>
                            {saving ? 'Saving...' : 'Save Notification Settings'}
                        </button>
                    </div>
                )}

                {/* CHECK-IN SETTINGS */}
                {activeSection === 'checkins' && (
                    <div className="table-container" style={{
                        background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%)',
                        border: '1px solid rgba(255,255,255,0.1)',
                        borderRadius: '20px',
                        padding: '30px'
                    }}>
                        <h3 style={{
                            marginBottom: '30px',
                            background: 'linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%)',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            fontSize: '28px'
                        }}>Check-in Settings</h3>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>Morning Check-in Reminder Time</label>
                            <input
                                type="time"
                                className="form-input"
                                value={settings.checkInReminderTime}
                                onChange={(e) => setSettings({...settings, checkInReminderTime: e.target.value})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%'
                                }}
                            />
                        </div>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>Evening Reflection Reminder Time</label>
                            <input
                                type="time"
                                className="form-input"
                                value={settings.eveningReminderTime}
                                onChange={(e) => setSettings({...settings, eveningReminderTime: e.target.value})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%'
                                }}
                            />
                        </div>

                        <div className="checkbox-group">
                            <input
                                type="checkbox"
                                id="missedCheckInAlert"
                                checked={settings.missedCheckInAlert}
                                onChange={(e) => setSettings({...settings, missedCheckInAlert: e.target.checked})}
                            />
                            <label htmlFor="missedCheckInAlert">Alert on Missed Check-ins</label>
                        </div>

                        <button className="btn btn-primary" onClick={saveSettings} disabled={saving} style={{ 
                            marginTop: '30px',
                            background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                            border: 'none',
                            padding: '14px 32px',
                            fontSize: '16px',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            transition: 'transform 0.2s',
                            boxShadow: '0 4px 15px rgba(102, 126, 234, 0.4)'
                        }}>
                            {saving ? 'Saving...' : 'Save Check-in Settings'}
                        </button>
                    </div>
                )}

                {/* ALERT THRESHOLDS */}
                {activeSection === 'alerts' && (
                    <div className="table-container" style={{
                        background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%)',
                        border: '1px solid rgba(255,255,255,0.1)',
                        borderRadius: '20px',
                        padding: '30px'
                    }}>
                        <h3 style={{
                            marginBottom: '30px',
                            background: 'linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%)',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            fontSize: '28px'
                        }}>Alert Thresholds</h3>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>Low Mood Threshold (1-10)</label>
                            <input
                                type="number"
                                className="form-input"
                                min="1"
                                max="10"
                                value={settings.lowMoodThreshold}
                                onChange={(e) => setSettings({...settings, lowMoodThreshold: parseInt(e.target.value)})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%'
                                }}
                            />
                            <small style={{ color: '#999', marginTop: '5px', display: 'block' }}>Alert when mood is at or below this value</small>
                        </div>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>High Craving Threshold (1-10)</label>
                            <input
                                type="number"
                                className="form-input"
                                min="1"
                                max="10"
                                value={settings.highCravingThreshold}
                                onChange={(e) => setSettings({...settings, highCravingThreshold: parseInt(e.target.value)})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%'
                                }}
                            />
                            <small style={{ color: '#999', marginTop: '5px', display: 'block' }}>Alert when cravings are at or above this value</small>
                        </div>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>High Anxiety Threshold (1-10)</label>
                            <input
                                type="number"
                                className="form-input"
                                min="1"
                                max="10"
                                value={settings.highAnxietyThreshold}
                                onChange={(e) => setSettings({...settings, highAnxietyThreshold: parseInt(e.target.value)})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%'
                                }}
                            />
                            <small style={{ color: '#999', marginTop: '5px', display: 'block' }}>Alert when anxiety is at or above this value</small>
                        </div>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>Poor Sleep Threshold (1-10)</label>
                            <input
                                type="number"
                                className="form-input"
                                min="1"
                                max="10"
                                value={settings.poorSleepThreshold}
                                onChange={(e) => setSettings({...settings, poorSleepThreshold: parseInt(e.target.value)})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%'
                                }}
                            />
                            <small style={{ color: '#999', marginTop: '5px', display: 'block' }}>Alert when sleep quality is at or below this value</small>
                        </div>

                        <button className="btn btn-primary" onClick={saveSettings} disabled={saving} style={{ 
                            marginTop: '30px',
                            background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                            border: 'none',
                            padding: '14px 32px',
                            fontSize: '16px',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            transition: 'transform 0.2s',
                            boxShadow: '0 4px 15px rgba(102, 126, 234, 0.4)'
                        }}>
                            {saving ? 'Saving...' : 'Save Alert Settings'}
                        </button>
                    </div>
                )}

                {/* DATA EXPORT */}
                {activeSection === 'dataExport' && (
                    <div className="table-container" style={{
                        background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%)',
                        border: '1px solid rgba(255,255,255,0.1)',
                        borderRadius: '20px',
                        padding: '30px'
                    }}>
                        <h3 style={{
                            marginBottom: '30px',
                            background: 'linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%)',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            fontSize: '28px'
                        }}>Data Export</h3>

                        <div style={{ marginBottom: '40px' }}>
                            <h4 style={{ marginBottom: '20px', color: '#0077CC' }}>Export All User Data</h4>
                            <div style={{ display: 'flex', gap: '15px', flexWrap: 'wrap' }}>
                                <button className="btn btn-secondary" onClick={() => handleDataExport('json', 'all')} style={{
                                    background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                                    border: 'none',
                                    padding: '12px 24px',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    transition: 'transform 0.2s'
                                }}>
                                    📄 Export as JSON
                                </button>
                                <button className="btn btn-secondary" onClick={() => handleDataExport('csv', 'all')} style={{
                                    background: 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)',
                                    border: 'none',
                                    padding: '12px 24px',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    transition: 'transform 0.2s'
                                }}>
                                    📊 Export as Spreadsheet
                                </button>
                                <button className="btn btn-secondary" onClick={() => handleDataExport('pdf', 'all')} style={{
                                    background: 'linear-gradient(135deg, #f44336 0%, #B01030 100%)',
                                    border: 'none',
                                    padding: '12px 24px',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    transition: 'transform 0.2s'
                                }}>
                                    📑 Export as PDF
                                </button>
                            </div>
                        </div>

                        <div style={{ marginBottom: '40px' }}>
                            <h4 style={{ marginBottom: '20px', color: '#0077CC' }}>Export Specific PIR Data</h4>
                            <div style={{ display: 'flex', gap: '15px', flexWrap: 'wrap' }}>
                                <button className="btn btn-secondary" onClick={() => handleDataExport('json', 'specific_pir')} style={{
                                    background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                                    border: 'none',
                                    padding: '12px 24px',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    transition: 'transform 0.2s'
                                }}>
                                    📄 Export as JSON
                                </button>
                                <button className="btn btn-secondary" onClick={() => handleDataExport('csv', 'specific_pir')} style={{
                                    background: 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)',
                                    border: 'none',
                                    padding: '12px 24px',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    transition: 'transform 0.2s'
                                }}>
                                    📊 Export as Spreadsheet
                                </button>
                                <button className="btn btn-secondary" onClick={() => handleDataExport('pdf', 'specific_pir')} style={{
                                    background: 'linear-gradient(135deg, #f44336 0%, #B01030 100%)',
                                    border: 'none',
                                    padding: '12px 24px',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    transition: 'transform 0.2s'
                                }}>
                                    📑 Export as PDF
                                </button>
                            </div>
                        </div>

                        <div style={{ marginBottom: '40px' }}>
                            <h4 style={{ marginBottom: '20px', color: '#0077CC' }}>Export by Data Type</h4>
                            <select 
                                className="form-input" 
                                onChange={(e) => {
                                    if (e.target.value) {
                                        const format = prompt('Export format? (json/csv/pdf)');
                                        if (format) handleDataExport(format, 'data_type', e.target.value);
                                    }
                                }}
                                defaultValue=""
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%',
                                    cursor: 'pointer'
                                }}
                            >
                                <option value="">Select data type...</option>
                                <option value="checkIns">Check-ins</option>
                                <option value="messages">Messages</option>
                                <option value="assignments">Assignments</option>
                                <option value="goals">Goals</option>
                                <option value="alerts">Alerts</option>
                                <option value="feedback">Feedback</option>
                                <option value="activities">Activities</option>
                                <option value="notifications">Notifications</option>
                            </select>
                        </div>

                        <div style={{ marginTop: '40px' }}>
                            <h4 style={{ marginBottom: '20px', color: '#0077CC' }}>Automated Exports</h4>
                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="autoBackup"
                                    checked={settings.autoBackupEnabled}
                                    onChange={(e) => setSettings({...settings, autoBackupEnabled: e.target.checked})}
                                />
                                <label htmlFor="autoBackup">Enable Automatic Backups</label>
                            </div>

                            <div className="form-group" style={{ marginTop: '20px' }}>
                                <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>Backup Frequency</label>
                                <select
                                    className="form-input"
                                    value={settings.backupFrequency}
                                    onChange={(e) => setSettings({...settings, backupFrequency: e.target.value})}
                                    style={{
                                        background: 'rgba(255,255,255,0.05)',
                                        border: '1px solid rgba(255,255,255,0.1)',
                                        borderRadius: '8px',
                                        padding: '12px',
                                        color: '#fff',
                                        width: '100%',
                                        cursor: 'pointer'
                                    }}
                                >
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>

                            <button className="btn btn-primary" onClick={saveSettings} disabled={saving} style={{ 
                                marginTop: '30px',
                                background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                border: 'none',
                                padding: '14px 32px',
                                fontSize: '16px',
                                borderRadius: '10px',
                                cursor: 'pointer',
                                transition: 'transform 0.2s',
                                boxShadow: '0 4px 15px rgba(102, 126, 234, 0.4)'
                            }}>
                                {saving ? 'Saving...' : 'Save Export Settings'}
                            </button>
                        </div>
                    </div>
                )}

                {/* USER MANAGEMENT */}
                {activeSection === 'userManagement' && (
                    <div className="table-container" style={{
                        background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%)',
                        border: '1px solid rgba(255,255,255,0.1)',
                        borderRadius: '20px',
                        padding: '30px'
                    }}>
                        <h3 style={{
                            marginBottom: '30px',
                            background: 'linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%)',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            fontSize: '28px'
                        }}>User Management</h3>

                        <div style={{ marginBottom: '40px' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                                <h4 style={{ color: '#0077CC' }}>Coaches ({coaches.filter(c => c.active !== false).length})</h4>
                                <button className="btn btn-primary" onClick={handleAddCoach} style={{
                                    background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                                    border: 'none',
                                    padding: '10px 20px',
                                    borderRadius: '8px',
                                    cursor: 'pointer'
                                }}>+ Add Coach</button>
                            </div>

                            {/* Add Coach Form */}
                            {showAddCoachForm && (
                                <div style={{
                                    background: 'white',
                                    borderRadius: '10px',
                                    padding: '20px',
                                    marginBottom: '20px',
                                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                                }}>
                                    <h5 style={{ marginBottom: '15px', color: '#333' }}>Add New Coach</h5>
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '15px' }}>
                                        <input
                                            type="text"
                                            placeholder="First Name"
                                            value={newUserData.firstName}
                                            onChange={(e) => setNewUserData({...newUserData, firstName: e.target.value})}
                                            style={{
                                                padding: '10px',
                                                borderRadius: '8px',
                                                border: '1px solid #ddd',
                                                fontSize: '14px'
                                            }}
                                        />
                                        <input
                                            type="text"
                                            placeholder="Last Name"
                                            value={newUserData.lastName}
                                            onChange={(e) => setNewUserData({...newUserData, lastName: e.target.value})}
                                            style={{
                                                padding: '10px',
                                                borderRadius: '8px',
                                                border: '1px solid #ddd',
                                                fontSize: '14px'
                                            }}
                                        />
                                        <input
                                            type="email"
                                            placeholder="Email Address"
                                            value={newUserData.email}
                                            onChange={(e) => setNewUserData({...newUserData, email: e.target.value})}
                                            style={{
                                                padding: '10px',
                                                borderRadius: '8px',
                                                border: '1px solid #ddd',
                                                fontSize: '14px'
                                            }}
                                        />
                                        <input
                                            type="password"
                                            placeholder="Temporary Password"
                                            value={newUserData.password}
                                            onChange={(e) => setNewUserData({...newUserData, password: e.target.value})}
                                            style={{
                                                padding: '10px',
                                                borderRadius: '8px',
                                                border: '1px solid #ddd',
                                                fontSize: '14px'
                                            }}
                                        />
                                    </div>
                                    <div style={{ display: 'flex', gap: '10px', marginTop: '15px' }}>
                                        <button
                                            onClick={submitAddCoach}
                                            disabled={saving}
                                            style={{
                                                padding: '10px 20px',
                                                background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '8px',
                                                cursor: saving ? 'not-allowed' : 'pointer',
                                                fontSize: '14px',
                                                fontWeight: '600'
                                            }}
                                        >
                                            {saving ? 'Adding...' : 'Add Coach'}
                                        </button>
                                        <button
                                            onClick={() => setShowAddCoachForm(false)}
                                            style={{
                                                padding: '10px 20px',
                                                background: '#6c757d',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '8px',
                                                cursor: 'pointer',
                                                fontSize: '14px',
                                                fontWeight: '600'
                                            }}
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            )}

                            <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                <thead>
                                    <tr style={{ borderBottom: '2px solid rgba(102, 126, 234, 0.3)' }}>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#0077CC' }}>Name</th>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#0077CC' }}>Email</th>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#0077CC' }}>Assigned PIRs</th>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#0077CC' }}>Status</th>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#0077CC' }}>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {coaches.map(coach => (
                                        <tr key={coach.id} style={{ borderBottom: '1px solid rgba(255,255,255,0.1)' }}>
                                            <td style={{ padding: '15px' }}>{coach.displayName}</td>
                                            <td style={{ padding: '15px' }}>{coach.email}</td>
                                            <td style={{ padding: '15px' }}>{pirs.filter(p => p.assignedCoach === coach.id).length}</td>
                                            <td style={{ padding: '15px' }}>
                                                <span className={`badge ${coach.active !== false ? 'badge-success' : 'badge-danger'}`} style={{
                                                    padding: '6px 12px',
                                                    borderRadius: '6px',
                                                    fontSize: '0.85em',
                                                    background: coach.active !== false ? 'linear-gradient(135deg, #00A86B, #008554)' : 'linear-gradient(135deg, #f44336, #B01030)'
                                                }}>
                                                    {coach.active !== false ? 'Active' : 'Inactive'}
                                                </span>
                                            </td>
                                            <td style={{ padding: '15px' }}>
                                                <button 
                                                    className="action-btn"
                                                    onClick={() => handleRemoveUser(coach.id, 'coach')}
                                                    style={{
                                                        background: 'linear-gradient(135deg, #f44336, #B01030)',
                                                        border: 'none',
                                                        padding: '8px 16px',
                                                        borderRadius: '6px',
                                                        cursor: 'pointer',
                                                        color: '#fff'
                                                    }}
                                                >
                                                    Remove
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        <div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                                <h4 style={{ color: '#0077CC' }}>PIRs ({pirs.filter(p => p.active !== false).length})</h4>
                                <button className="btn btn-primary" onClick={handleAddPIR} style={{
                                    background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                                    border: 'none',
                                    padding: '10px 20px',
                                    borderRadius: '8px',
                                    cursor: 'pointer'
                                }}>+ Add PIR</button>
                            </div>

                            {/* Add PIR Form */}
                            {showAddPIRForm && (
                                <div style={{
                                    background: 'white',
                                    borderRadius: '10px',
                                    padding: '20px',
                                    marginBottom: '20px',
                                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                                }}>
                                    <h5 style={{ marginBottom: '15px', color: '#333' }}>Add New PIR</h5>
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '15px' }}>
                                        <input
                                            type="text"
                                            placeholder="First Name"
                                            value={newUserData.firstName}
                                            onChange={(e) => setNewUserData({...newUserData, firstName: e.target.value})}
                                            style={{
                                                padding: '10px',
                                                borderRadius: '8px',
                                                border: '1px solid #ddd',
                                                fontSize: '14px'
                                            }}
                                        />
                                        <input
                                            type="text"
                                            placeholder="Last Name"
                                            value={newUserData.lastName}
                                            onChange={(e) => setNewUserData({...newUserData, lastName: e.target.value})}
                                            style={{
                                                padding: '10px',
                                                borderRadius: '8px',
                                                border: '1px solid #ddd',
                                                fontSize: '14px'
                                            }}
                                        />
                                        <input
                                            type="email"
                                            placeholder="Email Address"
                                            value={newUserData.email}
                                            onChange={(e) => setNewUserData({...newUserData, email: e.target.value})}
                                            style={{
                                                padding: '10px',
                                                borderRadius: '8px',
                                                border: '1px solid #ddd',
                                                fontSize: '14px'
                                            }}
                                        />
                                        <input
                                            type="password"
                                            placeholder="Temporary Password"
                                            value={newUserData.password}
                                            onChange={(e) => setNewUserData({...newUserData, password: e.target.value})}
                                            style={{
                                                padding: '10px',
                                                borderRadius: '8px',
                                                border: '1px solid #ddd',
                                                fontSize: '14px'
                                            }}
                                        />
                                        <select
                                            value={newUserData.assignedCoach}
                                            onChange={(e) => setNewUserData({...newUserData, assignedCoach: e.target.value})}
                                            style={{
                                                padding: '10px',
                                                borderRadius: '8px',
                                                border: '1px solid #ddd',
                                                fontSize: '14px',
                                                gridColumn: 'span 2'
                                            }}
                                        >
                                            <option value="">Assign to Coach (Optional)</option>
                                            {coaches.filter(c => c.active !== false).map(coach => (
                                                <option key={coach.id} value={coach.id}>
                                                    {coach.displayName}
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                    <div style={{ display: 'flex', gap: '10px', marginTop: '15px' }}>
                                        <button
                                            onClick={submitAddPIR}
                                            disabled={saving}
                                            style={{
                                                padding: '10px 20px',
                                                background: 'linear-gradient(135deg, #00A86B 0%, #008554 100%)',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '8px',
                                                cursor: saving ? 'not-allowed' : 'pointer',
                                                fontSize: '14px',
                                                fontWeight: '600'
                                            }}
                                        >
                                            {saving ? 'Adding...' : 'Add PIR'}
                                        </button>
                                        <button
                                            onClick={() => setShowAddPIRForm(false)}
                                            style={{
                                                padding: '10px 20px',
                                                background: '#6c757d',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '8px',
                                                cursor: 'pointer',
                                                fontSize: '14px',
                                                fontWeight: '600'
                                            }}
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            )}

                            <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                <thead>
                                    <tr style={{ borderBottom: '2px solid rgba(102, 126, 234, 0.3)' }}>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#0077CC' }}>Name</th>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#0077CC' }}>Email</th>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#0077CC' }}>Assigned Coach</th>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#0077CC' }}>Status</th>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#0077CC' }}>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {pirs.map(pir => {
                                        const assignedCoach = coaches.find(c => c.id === pir.assignedCoach);
                                        return (
                                            <tr key={pir.id} style={{ borderBottom: '1px solid rgba(255,255,255,0.1)' }}>
                                                <td style={{ padding: '15px' }}>{pir.displayName}</td>
                                                <td style={{ padding: '15px' }}>{pir.email}</td>
                                                <td style={{ padding: '15px' }}>
                                                    {assignedCoach ? assignedCoach.displayName : 'Unassigned'}
                                                </td>
                                                <td style={{ padding: '15px' }}>
                                                    <span className={`badge ${pir.active !== false ? 'badge-success' : 'badge-danger'}`} style={{
                                                        padding: '6px 12px',
                                                        borderRadius: '6px',
                                                        fontSize: '0.85em',
                                                        background: pir.active !== false ? 'linear-gradient(135deg, #00A86B, #008554)' : 'linear-gradient(135deg, #f44336, #B01030)'
                                                    }}>
                                                        {pir.active !== false ? 'Active' : 'Inactive'}
                                                    </span>
                                                </td>
                                                <td style={{ padding: '15px' }}>
                                                    <div style={{ display: 'flex', gap: '8px' }}>
                                                        {!pir.assignedCoach ? (
                                                            <button 
                                                                className="action-btn"
                                                                onClick={() => handleAssignCoach(pir.id)}
                                                                style={{
                                                                    background: 'linear-gradient(135deg, #2196F3, #1976D2)',
                                                                    border: 'none',
                                                                    padding: '8px 16px',
                                                                    borderRadius: '6px',
                                                                    cursor: 'pointer',
                                                                    color: '#fff'
                                                                }}
                                                            >
                                                                Assign Coach
                                                            </button>
                                                        ) : (
                                                            <button 
                                                                className="action-btn"
                                                                onClick={() => handleChangeCoach(pir.id, pir.assignedCoach)}
                                                                style={{
                                                                    background: 'linear-gradient(135deg, #FF9800, #F57C00)',
                                                                    border: 'none',
                                                                    padding: '8px 16px',
                                                                    borderRadius: '6px',
                                                                    cursor: 'pointer',
                                                                    color: '#fff'
                                                                }}
                                                            >
                                                                Change Coach
                                                            </button>
                                                        )}
                                                        <button 
                                                            className="action-btn"
                                                            onClick={() => handleRemoveUser(pir.id, 'pir')}
                                                            style={{
                                                                background: 'linear-gradient(135deg, #f44336, #B01030)',
                                                                border: 'none',
                                                                padding: '8px 16px',
                                                                borderRadius: '6px',
                                                                cursor: 'pointer',
                                                                color: '#fff'
                                                            }}
                                                        >
                                                            Remove
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )}

                {/* PERMISSIONS */}
                {activeSection === 'permissions' && (
                    <div className="table-container" style={{
                        background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%)',
                        border: '1px solid rgba(255,255,255,0.1)',
                        borderRadius: '20px',
                        padding: '30px'
                    }}>
                        <h3 style={{
                            marginBottom: '30px',
                            background: 'linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%)',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            fontSize: '28px'
                        }}>Permission Levels</h3>

                        <div style={{ 
                            marginBottom: '40px',
                            padding: '25px',
                            background: 'linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(67, 160, 71, 0.1) 100%)',
                            borderRadius: '12px',
                            border: '1px solid rgba(76, 175, 80, 0.3)'
                        }}>
                            <h4 style={{ color: '#00A86B', marginBottom: '15px' }}>Admin Permissions</h4>
                            <p style={{ color: '#ccc', fontSize: '0.95em', marginBottom: '15px' }}>
                                Admins have full system access including:
                            </p>
                            <ul style={{ color: '#ccc', lineHeight: '1.8', paddingLeft: '25px' }}>
                                <li>Full access to all PIR data</li>
                                <li>Create/edit/delete users (PIRs, coaches, admins)</li>
                                <li>Assign and reassign PIRs to coaches</li>
                                <li>Access all reports and analytics</li>
                                <li>Modify system settings</li>
                                <li>Manage resources and assignments</li>
                                <li>Export all data</li>
                                <li>Can function as coaches (assigned PIRs)</li>
                            </ul>
                        </div>

                        <div style={{ 
                            marginBottom: '40px',
                            padding: '25px',
                            background: 'linear-gradient(135deg, rgba(33, 150, 243, 0.1) 0%, rgba(25, 118, 210, 0.1) 100%)',
                            borderRadius: '12px',
                            border: '1px solid rgba(33, 150, 243, 0.3)'
                        }}>
                            <h4 style={{ color: '#4682B4', marginBottom: '15px' }}>Coach Permissions</h4>
                            <p style={{ color: '#ccc', fontSize: '0.95em', marginBottom: '15px' }}>
                                Coaches have limited access to only their assigned PIRs:
                            </p>
                            <ul style={{ color: '#ccc', lineHeight: '1.8', paddingLeft: '25px' }}>
                                <li>View and manage only assigned PIRs</li>
                                <li>Create assignments for assigned PIRs</li>
                                <li>View check-ins and alerts for assigned PIRs</li>
                                <li>Message assigned PIRs</li>
                                <li>Generate reports for assigned PIRs only</li>
                                <li>Cannot access system settings</li>
                                <li>Cannot create/delete users</li>
                                <li>Cannot export global data</li>
                            </ul>
                        </div>

                        <div>
                            <h4 style={{ marginBottom: '20px', color: '#0077CC' }}>Custom Permissions (Individual Override)</h4>
                            <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                <thead>
                                    <tr style={{ borderBottom: '2px solid rgba(102, 126, 234, 0.3)' }}>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#0077CC' }}>User</th>
                                        <th style={{ padding: '15px', textAlign: 'left', color: '#0077CC' }}>Role</th>
                                        <th style={{ padding: '15px', textAlign: 'center', color: '#0077CC' }}>Create Assignments</th>
                                        <th style={{ padding: '15px', textAlign: 'center', color: '#0077CC' }}>Delete Data</th>
                                        <th style={{ padding: '15px', textAlign: 'center', color: '#0077CC' }}>Export Data</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {coaches.map(coach => (
                                        <tr key={coach.id} style={{ borderBottom: '1px solid rgba(255,255,255,0.1)' }}>
                                            <td style={{ padding: '15px' }}>{coach.displayName}</td>
                                            <td style={{ padding: '15px' }}>
                                                <span style={{
                                                    padding: '4px 12px',
                                                    borderRadius: '6px',
                                                    fontSize: '0.85em',
                                                    background: coach.role === 'admin' ? 'linear-gradient(135deg, #00A86B, #008554)' : 'linear-gradient(135deg, #2196F3, #1976D2)'
                                                }}>
                                                    {coach.role}
                                                </span>
                                            </td>
                                            <td style={{ padding: '15px', textAlign: 'center' }}>
                                                <input
                                                    type="checkbox"
                                                    checked={permissions[coach.id]?.canCreateAssignments !== false}
                                                    onChange={(e) => updatePermissions(coach.id, 'canCreateAssignments', e.target.checked)}
                                                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                                />
                                            </td>
                                            <td style={{ padding: '15px', textAlign: 'center' }}>
                                                <input
                                                    type="checkbox"
                                                    checked={permissions[coach.id]?.canDelete === true}
                                                    onChange={(e) => updatePermissions(coach.id, 'canDelete', e.target.checked)}
                                                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                                />
                                            </td>
                                            <td style={{ padding: '15px', textAlign: 'center' }}>
                                                <input
                                                    type="checkbox"
                                                    checked={permissions[coach.id]?.canExport === true}
                                                    onChange={(e) => updatePermissions(coach.id, 'canExport', e.target.checked)}
                                                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                                />
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )}

                {/* INTEGRATIONS */}
                {activeSection === 'integrations' && (
                    <div className="table-container" style={{
                        background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%)',
                        border: '1px solid rgba(255,255,255,0.1)',
                        borderRadius: '20px',
                        padding: '30px'
                    }}>
                        <h3 style={{
                            marginBottom: '30px',
                            background: 'linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%)',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            fontSize: '28px'
                        }}>Integrations</h3>

                        {/* Google Calendar Integration */}
                        <div style={{
                            padding: '25px',
                            background: googleConnected
                                ? 'linear-gradient(135deg, rgba(52, 168, 83, 0.1) 0%, rgba(46, 125, 50, 0.1) 100%)'
                                : 'linear-gradient(135deg, rgba(66, 133, 244, 0.1) 0%, rgba(52, 168, 83, 0.1) 100%)',
                            borderRadius: '12px',
                            border: googleConnected
                                ? '1px solid rgba(52, 168, 83, 0.3)'
                                : '1px solid rgba(66, 133, 244, 0.3)',
                            marginBottom: '20px'
                        }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '15px' }}>
                                <div>
                                    <h4 style={{ color: googleConnected ? '#34A853' : '#4285F4', marginBottom: '10px', display: 'flex', alignItems: 'center', gap: '10px' }}>
                                        📅 Google Calendar Sync
                                        {googleConnected && (
                                            <span style={{
                                                background: 'linear-gradient(135deg, #00C851 0%, #007E33 100%)',
                                                color: 'white',
                                                padding: '4px 10px',
                                                borderRadius: '12px',
                                                fontSize: '11px',
                                                fontWeight: '600'
                                            }}>✓ Connected</span>
                                        )}
                                    </h4>
                                    <p style={{ color: '#ccc', margin: 0, fontSize: '14px' }}>
                                        {googleConnected
                                            ? 'Two-way sync of sessions, meetings, and reminders with your Google Calendar.'
                                            : 'Connect your Google account to automatically sync events and reminders.'}
                                    </p>
                                </div>
                            </div>

                            {googleConnected ? (
                                <div>
                                    <div style={{
                                        background: 'rgba(255,255,255,0.05)',
                                        borderRadius: '8px',
                                        padding: '15px',
                                        marginBottom: '15px'
                                    }}>
                                        <div style={{ color: '#aaa', fontSize: '12px', marginBottom: '8px' }}>Connected Account</div>
                                        <div style={{ color: 'white', fontSize: '14px', fontWeight: '500', marginBottom: '8px' }}>
                                            {googleEmail}
                                        </div>
                                        {lastGoogleSync && (
                                            <div style={{ color: '#888', fontSize: '12px' }}>
                                                Last synced: {lastGoogleSync.toDate ? lastGoogleSync.toDate().toLocaleString() : new Date(lastGoogleSync).toLocaleString()}
                                            </div>
                                        )}
                                    </div>

                                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '10px', marginBottom: '15px' }}>
                                        <button
                                            onClick={syncToGoogleCalendar}
                                            disabled={saving}
                                            style={{
                                                padding: '10px 20px',
                                                background: saving ? '#ccc' : 'linear-gradient(135deg, #4285F4 0%, #34A853 100%)',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '8px',
                                                cursor: saving ? 'not-allowed' : 'pointer',
                                                fontSize: '14px',
                                                fontWeight: '500',
                                                transition: 'transform 0.2s'
                                            }}
                                            onMouseEnter={(e) => !saving && (e.currentTarget.style.transform = 'translateY(-2px)')}
                                            onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                                        >
                                            📤 Push to Google
                                        </button>
                                        <button
                                            onClick={syncFromGoogleCalendar}
                                            disabled={saving}
                                            style={{
                                                padding: '10px 20px',
                                                background: saving ? '#ccc' : 'linear-gradient(135deg, #34A853 0%, #4285F4 100%)',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '8px',
                                                cursor: saving ? 'not-allowed' : 'pointer',
                                                fontSize: '14px',
                                                fontWeight: '500',
                                                transition: 'transform 0.2s'
                                            }}
                                            onMouseEnter={(e) => !saving && (e.currentTarget.style.transform = 'translateY(-2px)')}
                                            onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                                        >
                                            📥 Import from Google
                                        </button>
                                        <button
                                            onClick={handleGoogleDisconnect}
                                            disabled={saving}
                                            style={{
                                                padding: '10px 20px',
                                                background: saving ? '#ccc' : 'linear-gradient(135deg, #ef5350 0%, #d32f2f 100%)',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '8px',
                                                cursor: saving ? 'not-allowed' : 'pointer',
                                                fontSize: '14px',
                                                fontWeight: '500',
                                                transition: 'transform 0.2s'
                                            }}
                                            onMouseEnter={(e) => !saving && (e.currentTarget.style.transform = 'translateY(-2px)')}
                                            onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                                        >
                                            Disconnect
                                        </button>
                                    </div>
                                    <div style={{ color: '#aaa', fontSize: '12px', padding: '10px 0', background: 'rgba(255,255,255,0.05)', borderRadius: '6px', textAlign: 'center' }}>
                                        💡 Push: Sync GLRS meetings → Google Calendar | Import: Sync Google Calendar → GLRS
                                    </div>
                                </div>
                            ) : (
                                <button
                                    onClick={handleGoogleConnect}
                                    style={{
                                        padding: '12px 24px',
                                        background: 'white',
                                        color: '#4285F4',
                                        border: 'none',
                                        borderRadius: '8px',
                                        cursor: 'pointer',
                                        fontSize: '14px',
                                        fontWeight: '600',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '10px',
                                        transition: 'all 0.2s',
                                        boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                                    }}
                                    onMouseEnter={(e) => {
                                        e.currentTarget.style.transform = 'translateY(-2px)';
                                        e.currentTarget.style.boxShadow = '0 4px 12px rgba(66, 133, 244, 0.3)';
                                    }}
                                    onMouseLeave={(e) => {
                                        e.currentTarget.style.transform = 'translateY(0)';
                                        e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                                    }}
                                >
                                    <svg width="18" height="18" viewBox="0 0 18 18">
                                        <path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/>
                                        <path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"/>
                                        <path fill="#FBBC05" d="M4.5 10.52a4.8 4.8 0 0 1 0-3.04V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07z"/>
                                        <path fill="#EA4335" d="M8.98 4.18c1.17 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.4L4.5 7.49a4.77 4.77 0 0 1 4.48-3.3z"/>
                                    </svg>
                                    Connect Google Calendar
                                </button>
                            )}
                        </div>

                        {/* Coming Soon Integrations */}
                        <div style={{
                            padding: '25px',
                            background: 'linear-gradient(135deg, rgba(255,193,7,0.1) 0%, rgba(255,152,0,0.1) 100%)',
                            borderRadius: '12px',
                            border: '1px solid rgba(255,193,7,0.3)',
                            marginBottom: '20px'
                        }}>
                            <h4 style={{ color: '#FFC107', marginBottom: '15px' }}>🚧 Coming Soon: Carepatron Webhook</h4>
                            <p style={{ color: '#ccc', margin: 0 }}>
                                Automatically sync session data with Carepatron practice management system.
                            </p>
                        </div>

                        <div style={{
                            padding: '25px',
                            background: 'linear-gradient(135deg, rgba(255,193,7,0.1) 0%, rgba(255,152,0,0.1) 100%)',
                            borderRadius: '12px',
                            border: '1px solid rgba(255,193,7,0.3)',
                            marginBottom: '20px'
                        }}>
                            <h4 style={{ color: '#FFC107', marginBottom: '15px' }}>🚧 Coming Soon: Email Service Provider</h4>
                            <p style={{ color: '#ccc', margin: 0 }}>
                                Configure SendGrid or Mailgun for professional email delivery.
                            </p>
                        </div>

                        <div style={{
                            padding: '25px',
                            background: 'linear-gradient(135deg, rgba(255,193,7,0.1) 0%, rgba(255,152,0,0.1) 100%)',
                            borderRadius: '12px',
                            border: '1px solid rgba(255,193,7,0.3)',
                            marginBottom: '20px'
                        }}>
                            <h4 style={{ color: '#FFC107', marginBottom: '15px' }}>🚧 Coming Soon: SMS Provider (Twilio)</h4>
                            <p style={{ color: '#ccc', margin: 0 }}>
                                Set up Twilio for SMS notifications and two-way messaging.
                            </p>
                        </div>

                        <div style={{
                            padding: '25px',
                            background: 'linear-gradient(135deg, rgba(255,193,7,0.1) 0%, rgba(255,152,0,0.1) 100%)',
                            borderRadius: '12px',
                            border: '1px solid rgba(255,193,7,0.3)'
                        }}>
                            <h4 style={{ color: '#FFC107', marginBottom: '15px' }}>🚧 Coming Soon: Zapier Integration</h4>
                            <p style={{ color: '#ccc', margin: 0 }}>
                                Connect to 3000+ apps via Zapier for custom automation workflows.
                            </p>
                        </div>
                    </div>
                )}

                {/* SYSTEM CONFIGURATION */}
                {activeSection === 'system' && (
                    <div className="table-container" style={{
                        background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%)',
                        border: '1px solid rgba(255,255,255,0.1)',
                        borderRadius: '20px',
                        padding: '30px'
                    }}>
                        <h3 style={{
                            marginBottom: '30px',
                            background: 'linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%)',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            fontSize: '28px'
                        }}>System Configuration</h3>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>Timezone</label>
                            <select
                                className="form-input"
                                value={settings.timezone}
                                onChange={(e) => setSettings({...settings, timezone: e.target.value})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%',
                                    cursor: 'pointer'
                                }}
                            >
                                <option value="America/Los_Angeles">Pacific Time (PT)</option>
                                <option value="America/Denver">Mountain Time (MT)</option>
                                <option value="America/Chicago">Central Time (CT)</option>
                                <option value="America/New_York">Eastern Time (ET)</option>
                                <option value="America/Phoenix">Arizona (MST)</option>
                                <option value="America/Anchorage">Alaska (AKT)</option>
                                <option value="Pacific/Honolulu">Hawaii (HST)</option>
                            </select>
                        </div>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>Date Format</label>
                            <select
                                className="form-input"
                                value={settings.dateFormat}
                                onChange={(e) => setSettings({...settings, dateFormat: e.target.value})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%',
                                    cursor: 'pointer'
                                }}
                            >
                                <option value="MM/DD/YYYY">MM/DD/YYYY (US)</option>
                                <option value="DD/MM/YYYY">DD/MM/YYYY (International)</option>
                                <option value="YYYY-MM-DD">YYYY-MM-DD (ISO)</option>
                            </select>
                        </div>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>Time Format</label>
                            <select
                                className="form-input"
                                value={settings.timeFormat}
                                onChange={(e) => setSettings({...settings, timeFormat: e.target.value})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%',
                                    cursor: 'pointer'
                                }}
                            >
                                <option value="12h">12-hour (AM/PM)</option>
                                <option value="24h">24-hour</option>
                            </select>
                        </div>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>Language</label>
                            <select
                                className="form-input"
                                value={settings.language}
                                onChange={(e) => setSettings({...settings, language: e.target.value})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%',
                                    cursor: 'pointer'
                                }}
                            >
                                <option value="en">English</option>
                                <option value="es">Spanish (Coming Soon)</option>
                                <option value="fr">French (Coming Soon)</option>
                            </select>
                        </div>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>Auto-Refresh Interval</label>
                            <select
                                className="form-input"
                                value={settings.autoRefresh}
                                onChange={(e) => setSettings({...settings, autoRefresh: parseInt(e.target.value)})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%',
                                    cursor: 'pointer'
                                }}
                            >
                                <option value="0">Manual Only</option>
                                <option value="30">30 seconds</option>
                                <option value="60">1 minute</option>
                                <option value="300">5 minutes</option>
                                <option value="600">10 minutes</option>
                            </select>
                        </div>

                        <div className="form-group" style={{ marginBottom: '25px' }}>
                            <label className="form-label" style={{ color: '#0077CC', fontWeight: 'bold' }}>Data Retention (days)</label>
                            <input
                                type="number"
                                className="form-input"
                                min="90"
                                max="2555"
                                value={settings.dataRetentionDays}
                                onChange={(e) => setSettings({...settings, dataRetentionDays: parseInt(e.target.value)})}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    color: '#fff',
                                    width: '100%'
                                }}
                            />
                            <small style={{ color: '#999', marginTop: '5px', display: 'block' }}>Minimum 90 days, maximum 7 years (2555 days) for HIPAA compliance</small>
                        </div>

                        <button className="btn btn-primary" onClick={saveSettings} disabled={saving} style={{ 
                            marginTop: '30px',
                            background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                            border: 'none',
                            padding: '14px 32px',
                            fontSize: '16px',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            transition: 'transform 0.2s',
                            boxShadow: '0 4px 15px rgba(102, 126, 234, 0.4)'
                        }}>
                            {saving ? 'Saving...' : 'Save System Settings'}
                        </button>
                    </div>
                )}
            </div>
        </div>
    );
}

     
    
// ==========================================
// ENHANCED CREATE USER MODAL - FIREBASE EXTENSION VERSION
// ==========================================
function CreateUserModal({ onClose, onSuccess, defaultRole }) {
    const [formData, setFormData] = useState({
        email: '',
        password: '',
        firstName: '',
        lastName: '',
        role: defaultRole || 'pir',
        assignedCoach: '',
        phone: '',
        sobrietyDate: ''
    });
    const [coachesList, setCoachesList] = useState([]);
    const [loading, setLoading] = useState(false);
    const [emailValid, setEmailValid] = useState(null);
    const [step, setStep] = useState(1);

    useEffect(() => {
        loadCoaches();
    }, []);

    // Auto-generate password when names change
    useEffect(() => {
        if (formData.firstName && formData.lastName) {
            const newPassword = generateTempPassword(formData.firstName, formData.lastName);
            setFormData(prev => ({ ...prev, password: newPassword }));
        }
    }, [formData.firstName, formData.lastName]);

    const generateTempPassword = (firstName, lastName) => {
        if (!firstName || !lastName) return 'TempPass123!';
        
        const firstPart = firstName.slice(0, Math.min(3, firstName.length));
        const firstFormatted = firstPart.charAt(0).toUpperCase() + firstPart.slice(1).toLowerCase();
        
        const lastPart = lastName.slice(0, Math.min(3, lastName.length));
        const lastFormatted = lastPart.charAt(0).toUpperCase() + lastPart.slice(1).toLowerCase();
        
        const randomNum = Math.floor(Math.random() * 90) + 10;
        const specialChars = ['!', '@', '#', '$', '%', '&', '*'];
        const randomSpecial = specialChars[Math.floor(Math.random() * specialChars.length)];
        
        return `${firstFormatted}${lastFormatted}${randomNum}${randomSpecial}`;
    };

    const loadCoaches = async () => {
        const coachesSnap = await db.collection('users')
            .where('tenantId', '==', CURRENT_TENANT)
            .where('role', 'in', ['coach', 'admin'])
            .get();

        const coachesData = [];
        coachesSnap.forEach(doc => {
            coachesData.push({ id: doc.id, ...doc.data() });
        });
        setCoachesList(coachesData);
    };

    const validateEmail = (email) => {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    };

    const handleEmailChange = (email) => {
        setFormData({...formData, email});
        if (email.length > 0) {
            setEmailValid(validateEmail(email));
        } else {
            setEmailValid(null);
        }
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        
        if (!validateEmail(formData.email)) {
            alert('Please enter a valid email address');
            return;
        }
        
        setLoading(true);
        
        let secondaryApp;
        try {
            // Delete existing secondary app if any
            try {
                secondaryApp = firebase.app('SecondaryApp');
                await secondaryApp.delete();
            } catch (e) {
                // App doesn't exist
            }
            
            // Create secondary app for user creation
            secondaryApp = firebase.initializeApp(firebaseConfig, 'SecondaryApp');
            const secondaryAuth = secondaryApp.auth();
            
            // Create Firebase Auth user
            const userCredential = await secondaryAuth.createUserWithEmailAndPassword(
                formData.email,
                formData.password
            );
            
            // Prepare user data
            const userData = {
                tenantId: CURRENT_TENANT,
                email: formData.email,
                displayName: `${formData.firstName} ${formData.lastName}`,
                firstName: formData.firstName,
                lastName: formData.lastName,
                phone: formData.phone,
                role: formData.role,
                active: true,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Add PIR-specific fields
            if (formData.role === 'pir') {
                if (formData.assignedCoach) {
                    userData.assignedCoach = formData.assignedCoach;
                    const coach = coachesList.find(c => c.id === formData.assignedCoach);
                    if (coach) {
                        userData.assignedCoachName = coach.displayName || coach.email;
                    }
                }
                if (formData.sobrietyDate) {
                    userData.sobrietyDate = firebase.firestore.Timestamp.fromDate(new Date(formData.sobrietyDate));
                }
            }
            
            // Save to Firestore
            await db.collection('users').doc(userCredential.user.uid).set(userData);
            
            // Create notification (with preference checking)
            await createNotificationWithPreferences({
                tenantId: CURRENT_TENANT,
                type: 'user-created',
                message: `New ${formData.role} created: ${userData.displayName}`,
                recipientId: auth.currentUser.uid,
                relatedId: userCredential.user.uid,
                read: false
            }, 'user-created');
            
            // Send welcome email if PIR (using Firebase Extension)
            if (formData.role === 'pir') {
                try {
                    console.log('📧 Sending welcome email via Firebase Extension...');
                    
                    const currentUserDoc = await db.collection('users').doc(auth.currentUser.uid).get();
                    const currentUserData = currentUserDoc.data();
                    const coachName = currentUserData.displayName || `${currentUserData.firstName} ${currentUserData.lastName}`;
                    
                    // Write to Firestore - Extension automatically sends email
                    await db.collection('mail').add({
                        to: [formData.email],
                        message: {
                            subject: '🎉 Welcome to Guiding Light Recovery Services!',
                            html: getWelcomeEmailHTML(
                                `${formData.firstName} ${formData.lastName}`,
                                coachName,
                                formData.email,
                                formData.password
                            ),
                            text: getWelcomeEmailText(
                                `${formData.firstName} ${formData.lastName}`,
                                coachName,
                                formData.email,
                                formData.password
                            )
                        }
                    });
                    
                    console.log('✅ Welcome email queued successfully!');
                } catch (emailError) {
                    console.error('⚠️ Failed to queue welcome email:', emailError);
                    // Don't block user creation if email fails
                }
            }
            
            // Clean up secondary app
            await secondaryApp.delete();
            
            alert('✅ User created successfully!' + (formData.role === 'pir' ? '\n\nWelcome email has been sent with login credentials.' : ''));
            onSuccess();
            
        } catch (error) {
            console.error('Error creating user:', error);
            alert('❌ Error creating user: ' + error.message);
            
            if (secondaryApp) {
                try {
                    await secondaryApp.delete();
                } catch (e) {
                    // Ignore
                }
            }
        } finally {
            setLoading(false);
        }
    };

    const getRoleColor = (role) => {
        if (role === 'pir') return 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)';
        if (role === 'coach') return 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
        return 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';
    };

    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000,
            padding: '20px',
            animation: 'fadeIn 0.2s'
        }}>
            <div style={{
                background: 'white',
                borderRadius: '20px',
                maxWidth: '600px',
                width: '100%',
                maxHeight: '90vh',
                overflow: 'auto',
                boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
                animation: 'slideUp 0.3s'
            }}>
                {/* Header */}
                <div style={{
                    background: getRoleColor(formData.role),
                    padding: '25px 30px',
                    borderRadius: '20px 20px 0 0',
                    color: 'white',
                    position: 'sticky',
                    top: 0,
                    zIndex: 1
                }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div>
                            <h2 style={{ margin: '0 0 5px 0', fontSize: '24px' }}>Create New User</h2>
                            <div style={{ fontSize: '14px', opacity: 0.9 }}>
                                Step {step} of 2
                            </div>
                        </div>
                        <button 
                            onClick={onClose}
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                border: 'none',
                                color: 'white',
                                fontSize: '24px',
                                width: '36px',
                                height: '36px',
                                borderRadius: '50%',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                transition: 'background 0.2s'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.3)'}
                            onMouseLeave={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.2)'}
                        >
                            ×
                        </button>
                    </div>
                </div>

                {/* Content */}
                <form onSubmit={handleSubmit} style={{ padding: '30px' }}>
                    {step === 1 && (
                        <>
                            {/* Role Selection */}
                            <div style={{ marginBottom: '25px' }}>
                                <label style={{ 
                                    display: 'block', 
                                    fontSize: '14px', 
                                    fontWeight: '600', 
                                    color: '#333', 
                                    marginBottom: '10px' 
                                }}>
                                    User Role *
                                </label>
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '10px' }}>
                                    {['pir', 'coach', 'admin'].map(role => (
                                        <button
                                            key={role}
                                            type="button"
                                            onClick={() => setFormData({...formData, role})}
                                            style={{
                                                padding: '15px',
                                                background: formData.role === role ? getRoleColor(role) : '#f0f0f0',
                                                color: formData.role === role ? 'white' : '#666',
                                                border: 'none',
                                                borderRadius: '10px',
                                                cursor: 'pointer',
                                                fontSize: '14px',
                                                fontWeight: '600',
                                                textTransform: 'uppercase',
                                                transition: 'all 0.2s'
                                            }}
                                            onMouseEnter={(e) => {
                                                if (formData.role !== role) {
                                                    e.currentTarget.style.background = '#e0e0e0';
                                                }
                                            }}
                                            onMouseLeave={(e) => {
                                                if (formData.role !== role) {
                                                    e.currentTarget.style.background = '#f0f0f0';
                                                }
                                            }}
                                        >
                                            {role}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Email */}
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ 
                                    display: 'block', 
                                    fontSize: '14px', 
                                    fontWeight: '600', 
                                    color: '#333', 
                                    marginBottom: '8px' 
                                }}>
                                    Email Address *
                                </label>
                                <input
                                    type="email"
                                    value={formData.email}
                                    onChange={(e) => handleEmailChange(e.target.value)}
                                    required
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: `2px solid ${emailValid === false ? '#f44336' : emailValid === true ? '#00A86B' : '#e0e0e0'}`,
                                        borderRadius: '10px',
                                        fontSize: '14px',
                                        transition: 'border-color 0.2s'
                                    }}
                                    onFocus={(e) => {
                                        if (emailValid === null) e.currentTarget.style.borderColor = '#0077CC';
                                    }}
                                    onBlur={(e) => {
                                        if (emailValid === null) e.currentTarget.style.borderColor = '#e0e0e0';
                                    }}
                                />
                                {emailValid === false && (
                                    <div style={{ color: '#DC143C', fontSize: '12px', marginTop: '5px' }}>
                                        Please enter a valid email address
                                    </div>
                                )}
                                {emailValid === true && (
                                    <div style={{ color: '#00A86B', fontSize: '12px', marginTop: '5px' }}>
                                        ✓ Valid email address
                                    </div>
                                )}
                            </div>

                            {/* Name Fields */}
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px', marginBottom: '20px' }}>
                                <div>
                                    <label style={{ 
                                        display: 'block', 
                                        fontSize: '14px', 
                                        fontWeight: '600', 
                                        color: '#333', 
                                        marginBottom: '8px' 
                                    }}>
                                        First Name *
                                    </label>
                                    <input
                                        type="text"
                                        value={formData.firstName}
                                        onChange={(e) => setFormData({...formData, firstName: e.target.value})}
                                        required
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '10px',
                                            fontSize: '14px',
                                            transition: 'border-color 0.2s'
                                        }}
                                        onFocus={(e) => e.currentTarget.style.borderColor = '#0077CC'}
                                        onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                                    />
                                </div>
                                <div>
                                    <label style={{ 
                                        display: 'block', 
                                        fontSize: '14px', 
                                        fontWeight: '600', 
                                        color: '#333', 
                                        marginBottom: '8px' 
                                    }}>
                                        Last Name *
                                    </label>
                                    <input
                                        type="text"
                                        value={formData.lastName}
                                        onChange={(e) => setFormData({...formData, lastName: e.target.value})}
                                        required
                                        style={{
                                            width: '100%',
                                            padding: '12px 15px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '10px',
                                            fontSize: '14px',
                                            transition: 'border-color 0.2s'
                                        }}
                                        onFocus={(e) => e.currentTarget.style.borderColor = '#0077CC'}
                                        onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                                    />
                                </div>
                            </div>

                            {/* Phone */}
                            <div style={{ marginBottom: '25px' }}>
                                <label style={{ 
                                    display: 'block', 
                                    fontSize: '14px', 
                                    fontWeight: '600', 
                                    color: '#333', 
                                    marginBottom: '8px' 
                                }}>
                                    Phone Number
                                </label>
                                <input
                                    type="tel"
                                    value={formData.phone}
                                    onChange={(e) => setFormData({...formData, phone: e.target.value})}
                                    placeholder="(555) 123-4567"
                                    style={{
                                        width: '100%',
                                        padding: '12px 15px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '14px',
                                        transition: 'border-color 0.2s'
                                    }}
                                    onFocus={(e) => e.currentTarget.style.borderColor = '#0077CC'}
                                    onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                                />
                            </div>

                            {/* Auto-generated Password Preview */}
                            {formData.role === 'pir' && formData.firstName && formData.lastName && (
                                <div style={{
                                    padding: '15px',
                                    background: '#f0f9ff',
                                    border: '2px solid #0077CC',
                                    borderRadius: '10px',
                                    marginBottom: '20px'
                                }}>
                                    <div style={{ fontSize: '14px', fontWeight: '600', color: '#0c4a6e', marginBottom: '5px' }}>
                                        Auto-Generated Password:
                                    </div>
                                    <div style={{ fontSize: '18px', color: '#0077CC', fontFamily: 'monospace', fontWeight: '600' }}>
                                        {formData.password}
                                    </div>
                                    <div style={{ fontSize: '12px', color: '#64748b', marginTop: '5px' }}>
                                        This will be sent to the PIR in their welcome email
                                    </div>
                                </div>
                            )}

                            <button
                                type="button"
                                onClick={() => setStep(2)}
                                style={{
                                    width: '100%',
                                    padding: '14px',
                                    background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '10px',
                                    cursor: 'pointer',
                                    fontSize: '16px',
                                    fontWeight: '600',
                                    transition: 'transform 0.2s'
                                }}
                                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                            >
                                Next Step →
                            </button>
                        </>
                    )}

                    {step === 2 && (
                        <>
                            {/* PIR-specific fields */}
                            {formData.role === 'pir' && (
                                <>
                                    <div style={{ marginBottom: '20px' }}>
                                        <label style={{ 
                                            display: 'block', 
                                            fontSize: '14px', 
                                            fontWeight: '600', 
                                            color: '#333', 
                                            marginBottom: '8px' 
                                        }}>
                                            Assign Coach
                                        </label>
                                        <select
                                            value={formData.assignedCoach}
                                            onChange={(e) => setFormData({...formData, assignedCoach: e.target.value})}
                                            style={{
                                                width: '100%',
                                                padding: '12px 15px',
                                                border: '2px solid #e0e0e0',
                                                borderRadius: '10px',
                                                fontSize: '14px',
                                                background: 'white',
                                                cursor: 'pointer',
                                                transition: 'border-color 0.2s'
                                            }}
                                            onFocus={(e) => e.currentTarget.style.borderColor = '#0077CC'}
                                            onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                                        >
                                            <option value="">Select Coach (Optional)</option>
                                            {coachesList.map(coach => (
                                                <option key={coach.id} value={coach.id}>
                                                    {coach.displayName || coach.email}
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    <div style={{ marginBottom: '25px' }}>
                                        <label style={{ 
                                            display: 'block', 
                                            fontSize: '14px', 
                                            fontWeight: '600', 
                                            color: '#333', 
                                            marginBottom: '8px' 
                                        }}>
                                            Sobriety Start Date
                                        </label>
                                        <input
                                            type="date"
                                            value={formData.sobrietyDate}
                                            onChange={(e) => setFormData({...formData, sobrietyDate: e.target.value})}
                                            style={{
                                                width: '100%',
                                                padding: '12px 15px',
                                                border: '2px solid #e0e0e0',
                                                borderRadius: '10px',
                                                fontSize: '14px',
                                                transition: 'border-color 0.2s'
                                            }}
                                            onFocus={(e) => e.currentTarget.style.borderColor = '#0077CC'}
                                            onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                                        />
                                    </div>
                                </>
                            )}

                            {/* Email Info */}
                            <div style={{
                                padding: '15px',
                                background: '#e3f2fd',
                                borderRadius: '10px',
                                marginBottom: '25px'
                            }}>
                                <div style={{ fontSize: '14px', fontWeight: '600', color: '#1976d2', marginBottom: '5px' }}>
                                    Welcome Email
                                </div>
                                <div style={{ fontSize: '13px', color: '#1565c0' }}>
                                    {formData.role === 'pir' 
                                        ? 'A welcome email with login credentials will be sent to the PIR automatically. They should change their password after first login.'
                                        : 'User will be created and notified.'
                                    }
                                </div>
                            </div>

                            <div style={{ display: 'flex', gap: '10px' }}>
                                <button
                                    type="button"
                                    onClick={() => setStep(1)}
                                    style={{
                                        flex: 1,
                                        padding: '14px',
                                        background: '#6c757d',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '10px',
                                        cursor: 'pointer',
                                        fontSize: '16px',
                                        fontWeight: '600',
                                        transition: 'background 0.2s'
                                    }}
                                    onMouseEnter={(e) => e.currentTarget.style.background = '#5a6268'}
                                    onMouseLeave={(e) => e.currentTarget.style.background = '#6c757d'}
                                >
                                    ← Back
                                </button>
                                <button
                                    type="submit"
                                    disabled={loading}
                                    style={{
                                        flex: 2,
                                        padding: '14px',
                                        background: loading ? '#ccc' : getRoleColor(formData.role),
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '10px',
                                        cursor: loading ? 'not-allowed' : 'pointer',
                                        fontSize: '16px',
                                        fontWeight: '600',
                                        transition: 'transform 0.2s'
                                    }}
                                    onMouseEnter={(e) => {
                                        if (!loading) e.currentTarget.style.transform = 'translateY(-2px)';
                                    }}
                                    onMouseLeave={(e) => {
                                        e.currentTarget.style.transform = 'translateY(0)';
                                    }}
                                >
                                    {loading ? 'Creating User...' : 'Create User'}
                                </button>
                            </div>
                        </>
                    )}
                </form>
            </div>
        </div>
    );
}

// ==========================================
// TENANT MANAGEMENT MODAL (SUPERADMIN ONLY)
// ==========================================
function TenantManagementModal({ onClose, onSuccess }) {
    const [formData, setFormData] = useState({
        tenantId: '',
        companyName: '',
        contactEmail: '',
        primaryColor: '#0077CC',
        secondaryColor: '#008B8B',
        accentColor: '#FF8C00',
        logoUrl: '',
        adminEmail: '',
        adminPassword: '',
        adminFirstName: '',
        adminLastName: ''
    });
    const [submitting, setSubmitting] = useState(false);
    const [error, setError] = useState('');

    const handleSubmit = async (e) => {
        e.preventDefault();
        setSubmitting(true);
        setError('');

        try {
            // Validate tenant ID (lowercase, no spaces, alphanumeric + hyphens only)
            const tenantIdRegex = /^[a-z0-9-]+$/;
            if (!tenantIdRegex.test(formData.tenantId)) {
                throw new Error('Tenant ID must be lowercase alphanumeric with hyphens only');
            }

            // Check if tenant already exists
            const tenantDoc = await db.collection('tenants').doc(formData.tenantId).get();
            if (tenantDoc.exists) {
                throw new Error('Tenant ID already exists. Please choose a different ID.');
            }

            // Create tenant configuration
            await db.collection('tenants').doc(formData.tenantId).set({
                config: {
                    companyName: formData.companyName,
                    contactEmail: formData.contactEmail,
                    branding: {
                        primaryColor: formData.primaryColor,
                        secondaryColor: formData.secondaryColor,
                        accentColor: formData.accentColor,
                        logoUrl: formData.logoUrl
                    }
                },
                active: true,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: auth.currentUser.uid
            });

            // Create tenant admin user using secondary Firebase app
            const secondaryApp = firebase.initializeApp(firebaseConfig, `temp-${Date.now()}`);
            const userCredential = await secondaryApp.auth().createUserWithEmailAndPassword(
                formData.adminEmail,
                formData.adminPassword
            );

            // Create admin user document
            await db.collection('users').doc(userCredential.user.uid).set({
                email: formData.adminEmail,
                firstName: formData.adminFirstName,
                lastName: formData.adminLastName,
                displayName: `${formData.adminFirstName} ${formData.adminLastName}`,
                role: 'admin', // NOT superadmin
                tenantId: formData.tenantId,
                active: true,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: auth.currentUser.uid
            });

            // Clean up secondary app
            await secondaryApp.delete();

            // Log audit trail
            await logAudit('CREATE_TENANT', {
                tenantId: formData.tenantId,
                resource: 'tenants',
                resourceId: formData.tenantId,
                changes: {
                    companyName: formData.companyName,
                    adminEmail: formData.adminEmail
                }
            });

            await logAudit('CREATE_USER', {
                tenantId: formData.tenantId,
                targetUserId: userCredential.user.uid,
                resource: 'users',
                changes: {
                    email: formData.adminEmail,
                    role: 'admin',
                    tenantId: formData.tenantId
                }
            });

            alert(`✅ Tenant "${formData.companyName}" created successfully!\n\nAdmin account created for ${formData.adminEmail}`);
            onSuccess();
            onClose();
        } catch (error) {
            console.error('Error creating tenant:', error);
            setError(error.message);
        } finally {
            setSubmitting(false);
        }
    };

    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.8)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000
        }}>
            <div style={{
                background: 'var(--bg-dark)',
                borderRadius: '20px',
                padding: '30px',
                maxWidth: '700px',
                width: '90%',
                maxHeight: '90vh',
                overflowY: 'auto',
                border: '1px solid rgba(255, 255, 255, 0.1)'
            }}>
                <div style={{ marginBottom: '20px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <h2 style={{ margin: 0, color: 'var(--text-light)' }}>🏢 Create New Tenant</h2>
                    <button onClick={onClose} style={{
                        background: 'none',
                        border: 'none',
                        color: 'var(--text-light)',
                        fontSize: '28px',
                        cursor: 'pointer'
                    }}>×</button>
                </div>

                {error && (
                    <div style={{
                        background: 'rgba(var(--danger-rgb), 0.1)',
                        border: '1px solid var(--danger-color)',
                        color: 'var(--danger-color)',
                        padding: '10px',
                        borderRadius: '10px',
                        marginBottom: '20px'
                    }}>
                        {error}
                    </div>
                )}

                <form onSubmit={handleSubmit}>
                    {/* Tenant Information */}
                    <div style={{
                        marginBottom: '25px',
                        padding: '20px',
                        background: 'rgba(var(--info-rgb), 0.1)',
                        border: '2px solid var(--info-color)',
                        borderRadius: '12px'
                    }}>
                        <h3 style={{ margin: '0 0 15px 0', color: 'var(--info-color)' }}>📋 Tenant Information</h3>

                        <div style={{ marginBottom: '15px' }}>
                            <label style={{ display: 'block', marginBottom: '5px', color: 'var(--text-light)' }}>
                                Tenant ID (URL identifier) *
                            </label>
                            <input
                                type="text"
                                value={formData.tenantId}
                                onChange={(e) => setFormData({...formData, tenantId: e.target.value.toLowerCase().replace(/[^a-z0-9-]/g, '')})}
                                placeholder="example-clinic"
                                required
                                style={{
                                    width: '100%',
                                    padding: '12px',
                                    background: 'rgba(255, 255, 255, 0.1)',
                                    border: '1px solid rgba(255, 255, 255, 0.2)',
                                    borderRadius: '10px',
                                    color: 'white'
                                }}
                            />
                            <small style={{ color: 'var(--text-gray)' }}>
                                Will be used as: {formData.tenantId || 'tenant-id'}.glrecoveryservices.com
                            </small>
                        </div>

                        <div style={{ marginBottom: '15px' }}>
                            <label style={{ display: 'block', marginBottom: '5px', color: 'var(--text-light)' }}>
                                Company Name *
                            </label>
                            <input
                                type="text"
                                value={formData.companyName}
                                onChange={(e) => setFormData({...formData, companyName: e.target.value})}
                                placeholder="Example Recovery Clinic"
                                required
                                style={{
                                    width: '100%',
                                    padding: '12px',
                                    background: 'rgba(255, 255, 255, 0.1)',
                                    border: '1px solid rgba(255, 255, 255, 0.2)',
                                    borderRadius: '10px',
                                    color: 'white'
                                }}
                            />
                        </div>

                        <div style={{ marginBottom: '15px' }}>
                            <label style={{ display: 'block', marginBottom: '5px', color: 'var(--text-light)' }}>
                                Contact Email *
                            </label>
                            <input
                                type="email"
                                value={formData.contactEmail}
                                onChange={(e) => setFormData({...formData, contactEmail: e.target.value})}
                                placeholder="contact@example.com"
                                required
                                style={{
                                    width: '100%',
                                    padding: '12px',
                                    background: 'rgba(255, 255, 255, 0.1)',
                                    border: '1px solid rgba(255, 255, 255, 0.2)',
                                    borderRadius: '10px',
                                    color: 'white'
                                }}
                            />
                        </div>

                        <div style={{ marginBottom: '15px' }}>
                            <label style={{ display: 'block', marginBottom: '5px', color: 'var(--text-light)' }}>
                                Logo URL (optional)
                            </label>
                            <input
                                type="url"
                                value={formData.logoUrl}
                                onChange={(e) => setFormData({...formData, logoUrl: e.target.value})}
                                placeholder="https://example.com/logo.png"
                                style={{
                                    width: '100%',
                                    padding: '12px',
                                    background: 'rgba(255, 255, 255, 0.1)',
                                    border: '1px solid rgba(255, 255, 255, 0.2)',
                                    borderRadius: '10px',
                                    color: 'white'
                                }}
                            />
                        </div>

                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '10px' }}>
                            <div>
                                <label style={{ display: 'block', marginBottom: '5px', color: 'var(--text-light)', fontSize: '12px' }}>
                                    Primary Color
                                </label>
                                <input
                                    type="color"
                                    value={formData.primaryColor}
                                    onChange={(e) => setFormData({...formData, primaryColor: e.target.value})}
                                    style={{ width: '100%', height: '40px', border: 'none', borderRadius: '8px' }}
                                />
                            </div>
                            <div>
                                <label style={{ display: 'block', marginBottom: '5px', color: 'var(--text-light)', fontSize: '12px' }}>
                                    Secondary Color
                                </label>
                                <input
                                    type="color"
                                    value={formData.secondaryColor}
                                    onChange={(e) => setFormData({...formData, secondaryColor: e.target.value})}
                                    style={{ width: '100%', height: '40px', border: 'none', borderRadius: '8px' }}
                                />
                            </div>
                            <div>
                                <label style={{ display: 'block', marginBottom: '5px', color: 'var(--text-light)', fontSize: '12px' }}>
                                    Accent Color
                                </label>
                                <input
                                    type="color"
                                    value={formData.accentColor}
                                    onChange={(e) => setFormData({...formData, accentColor: e.target.value})}
                                    style={{ width: '100%', height: '40px', border: 'none', borderRadius: '8px' }}
                                />
                            </div>
                        </div>
                    </div>

                    {/* Admin Account Creation */}
                    <div style={{
                        marginBottom: '25px',
                        padding: '20px',
                        background: 'rgba(var(--success-rgb), 0.1)',
                        border: '2px solid var(--success-color)',
                        borderRadius: '12px'
                    }}>
                        <h3 style={{ margin: '0 0 15px 0', color: 'var(--success-color)' }}>👤 Create Admin Account</h3>

                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px', marginBottom: '15px' }}>
                            <div>
                                <label style={{ display: 'block', marginBottom: '5px', color: 'var(--text-light)' }}>
                                    First Name *
                                </label>
                                <input
                                    type="text"
                                    value={formData.adminFirstName}
                                    onChange={(e) => setFormData({...formData, adminFirstName: e.target.value})}
                                    required
                                    style={{
                                        width: '100%',
                                        padding: '12px',
                                        background: 'rgba(255, 255, 255, 0.1)',
                                        border: '1px solid rgba(255, 255, 255, 0.2)',
                                        borderRadius: '10px',
                                        color: 'white'
                                    }}
                                />
                            </div>
                            <div>
                                <label style={{ display: 'block', marginBottom: '5px', color: 'var(--text-light)' }}>
                                    Last Name *
                                </label>
                                <input
                                    type="text"
                                    value={formData.adminLastName}
                                    onChange={(e) => setFormData({...formData, adminLastName: e.target.value})}
                                    required
                                    style={{
                                        width: '100%',
                                        padding: '12px',
                                        background: 'rgba(255, 255, 255, 0.1)',
                                        border: '1px solid rgba(255, 255, 255, 0.2)',
                                        borderRadius: '10px',
                                        color: 'white'
                                    }}
                                />
                            </div>
                        </div>

                        <div style={{ marginBottom: '15px' }}>
                            <label style={{ display: 'block', marginBottom: '5px', color: 'var(--text-light)' }}>
                                Admin Email *
                            </label>
                            <input
                                type="email"
                                value={formData.adminEmail}
                                onChange={(e) => setFormData({...formData, adminEmail: e.target.value})}
                                placeholder="admin@example.com"
                                required
                                style={{
                                    width: '100%',
                                    padding: '12px',
                                    background: 'rgba(255, 255, 255, 0.1)',
                                    border: '1px solid rgba(255, 255, 255, 0.2)',
                                    borderRadius: '10px',
                                    color: 'white'
                                }}
                            />
                        </div>

                        <div style={{ marginBottom: '15px' }}>
                            <label style={{ display: 'block', marginBottom: '5px', color: 'var(--text-light)' }}>
                                Admin Password *
                            </label>
                            <input
                                type="password"
                                value={formData.adminPassword}
                                onChange={(e) => setFormData({...formData, adminPassword: e.target.value})}
                                placeholder="Minimum 6 characters"
                                minLength="6"
                                required
                                style={{
                                    width: '100%',
                                    padding: '12px',
                                    background: 'rgba(255, 255, 255, 0.1)',
                                    border: '1px solid rgba(255, 255, 255, 0.2)',
                                    borderRadius: '10px',
                                    color: 'white'
                                }}
                            />
                        </div>

                        <div style={{
                            padding: '10px',
                            background: 'rgba(255, 140, 0, 0.1)',
                            border: '1px solid var(--accent-color)',
                            borderRadius: '8px',
                            fontSize: '13px',
                            color: 'var(--text-light)'
                        }}>
                            ℹ️ This account will be created with <strong>admin</strong> role (not superadmin) and will only have access to this tenant.
                        </div>
                    </div>

                    <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                        <button
                            type="button"
                            onClick={onClose}
                            style={{
                                padding: '12px 24px',
                                background: 'rgba(255, 255, 255, 0.1)',
                                border: '1px solid rgba(255, 255, 255, 0.2)',
                                borderRadius: '10px',
                                color: 'white',
                                cursor: 'pointer'
                            }}
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            disabled={submitting}
                            style={{
                                padding: '12px 24px',
                                background: submitting ? '#666' : 'var(--gradient-primary)',
                                border: 'none',
                                borderRadius: '10px',
                                color: 'white',
                                cursor: submitting ? 'not-allowed' : 'pointer',
                                fontWeight: '600'
                            }}
                        >
                            {submitting ? 'Creating...' : '🏢 Create Tenant & Admin'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
}

// ENHANCED CreateAssignmentModal
function CreateAssignmentModal({ onClose, onSuccess, users, createdBy }) {
    const [formData, setFormData] = useState({
        title: '',
        description: '',
        userId: '',
        dueDate: '',
        priority: 'medium',
        status: 'pending',
        category: 'general'
    });
    const [loading, setLoading] = useState(false);

    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        
        try {
            await db.collection('assignments').add({
                ...formData,
                createdBy: createdBy,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Create notification for PIR (with preference checking)
            if (formData.userId) {
                await createNotificationWithPreferences({
                    type: 'assignment',
                    message: `New assignment: ${formData.title}`,
                    recipientId: formData.userId,
                    relatedId: formData.userId,
                    read: false
                }, 'assignment_created');
            }
            
            alert('Assignment created successfully!');
            onSuccess();
        } catch (error) {
            console.error('Error creating assignment:', error);
            alert('Failed to create assignment');
        } finally {
            setLoading(false);
        }
    };

    const getPriorityColor = (priority) => {
        if (priority === 'high') return '#f44336';
        if (priority === 'medium') return '#FF9800';
        return '#00A86B';
    };

    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000,
            padding: '20px',
            animation: 'fadeIn 0.2s'
        }}>
            <div style={{
                background: 'white',
                borderRadius: '20px',
                maxWidth: '600px',
                width: '100%',
                maxHeight: '90vh',
                overflow: 'auto',
                boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
                animation: 'slideUp 0.3s'
            }}>
                {/* Header */}
                <div style={{
                    background: 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                    padding: '25px 30px',
                    borderRadius: '20px 20px 0 0',
                    color: 'white',
                    position: 'sticky',
                    top: 0,
                    zIndex: 1
                }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <h2 style={{ margin: 0, fontSize: '24px' }}>Create Assignment</h2>
                        <button 
                            onClick={onClose}
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                border: 'none',
                                color: 'white',
                                fontSize: '24px',
                                width: '36px',
                                height: '36px',
                                borderRadius: '50%',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                transition: 'background 0.2s'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.3)'}
                            onMouseLeave={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.2)'}
                        >
                            ×
                        </button>
                    </div>
                </div>

                {/* Content */}
                <form onSubmit={handleSubmit} style={{ padding: '30px' }}>
                    {/* Title */}
                    <div style={{ marginBottom: '20px' }}>
                        <label style={{ 
                            display: 'block', 
                            fontSize: '14px', 
                            fontWeight: '600', 
                            color: '#333', 
                            marginBottom: '8px' 
                        }}>
                            Assignment Title *
                        </label>
                        <input
                            type="text"
                            value={formData.title}
                            onChange={(e) => setFormData({...formData, title: e.target.value})}
                            required
                            placeholder="e.g., Complete daily gratitude journal"
                            style={{
                                width: '100%',
                                padding: '12px 15px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '10px',
                                fontSize: '14px',
                                transition: 'border-color 0.2s'
                            }}
                            onFocus={(e) => e.currentTarget.style.borderColor = '#0077CC'}
                            onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                        />
                    </div>

                    {/* Description */}
                    <div style={{ marginBottom: '20px' }}>
                        <label style={{ 
                            display: 'block', 
                            fontSize: '14px', 
                            fontWeight: '600', 
                            color: '#333', 
                            marginBottom: '8px' 
                        }}>
                            Description *
                        </label>
                        <textarea
                            value={formData.description}
                            onChange={(e) => setFormData({...formData, description: e.target.value})}
                            required
                            placeholder="Provide detailed instructions..."
                            style={{
                                width: '100%',
                                minHeight: '100px',
                                padding: '12px 15px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '10px',
                                fontSize: '14px',
                                fontFamily: 'inherit',
                                resize: 'vertical',
                                transition: 'border-color 0.2s'
                            }}
                            onFocus={(e) => e.currentTarget.style.borderColor = '#0077CC'}
                            onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                        />
                    </div>

                    {/* Assign To */}
                    <div style={{ marginBottom: '20px' }}>
                        <label style={{ 
                            display: 'block', 
                            fontSize: '14px', 
                            fontWeight: '600', 
                            color: '#333', 
                            marginBottom: '8px' 
                        }}>
                            Assign To *
                        </label>
                        <select
                            value={formData.userId}
                            onChange={(e) => setFormData({...formData, userId: e.target.value})}
                            required
                            style={{
                                width: '100%',
                                padding: '12px 15px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '10px',
                                fontSize: '14px',
                                background: 'white',
                                cursor: 'pointer',
                                transition: 'border-color 0.2s'
                            }}
                            onFocus={(e) => e.currentTarget.style.borderColor = '#0077CC'}
                            onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                        >
                            <option value="">Select PIR</option>
                            {users.map(user => (
                                <option key={user.id} value={user.id}>
                                    {user.displayName || user.email}
                                </option>
                            ))}
                        </select>
                    </div>

                    {/* Priority Selection */}
                    <div style={{ marginBottom: '20px' }}>
                        <label style={{ 
                            display: 'block', 
                            fontSize: '14px', 
                            fontWeight: '600', 
                            color: '#333', 
                            marginBottom: '10px' 
                        }}>
                            Priority Level
                        </label>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '10px' }}>
                            {['low', 'medium', 'high'].map(priority => (
                                <button
                                    key={priority}
                                    type="button"
                                    onClick={() => setFormData({...formData, priority})}
                                    style={{
                                        padding: '12px',
                                        background: formData.priority === priority ? getPriorityColor(priority) : '#f0f0f0',
                                        color: formData.priority === priority ? 'white' : '#666',
                                        border: 'none',
                                        borderRadius: '10px',
                                        cursor: 'pointer',
                                        fontSize: '14px',
                                        fontWeight: '600',
                                        textTransform: 'capitalize',
                                        transition: 'all 0.2s'
                                    }}
                                >
                                    {priority}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Category and Due Date */}
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px', marginBottom: '25px' }}>
                        <div>
                            <label style={{ 
                                display: 'block', 
                                fontSize: '14px', 
                                fontWeight: '600', 
                                color: '#333', 
                                marginBottom: '8px' 
                            }}>
                                Category
                            </label>
                            <select
                                value={formData.category}
                                onChange={(e) => setFormData({...formData, category: e.target.value})}
                                style={{
                                    width: '100%',
                                    padding: '12px 15px',
                                    border: '2px solid #e0e0e0',
                                    borderRadius: '10px',
                                    fontSize: '14px',
                                    background: 'white',
                                    cursor: 'pointer'
                                }}
                            >
                                <option value="general">General</option>
                                <option value="recovery">Recovery</option>
                                <option value="wellness">Wellness</option>
                                <option value="social">Social</option>
                                <option value="education">Education</option>
                            </select>
                        </div>
                        <div>
                            <label style={{ 
                                display: 'block', 
                                fontSize: '14px', 
                                fontWeight: '600', 
                                color: '#333', 
                                marginBottom: '8px' 
                            }}>
                                Due Date
                            </label>
                            <input
                                type="date"
                                value={formData.dueDate}
                                onChange={(e) => setFormData({...formData, dueDate: e.target.value})}
                                style={{
                                    width: '100%',
                                    padding: '12px 15px',
                                    border: '2px solid #e0e0e0',
                                    borderRadius: '10px',
                                    fontSize: '14px'
                                }}
                            />
                        </div>
                    </div>

                    {/* Actions */}
                    <div style={{ display: 'flex', gap: '10px' }}>
                        <button
                            type="button"
                            onClick={onClose}
                            style={{
                                flex: 1,
                                padding: '14px',
                                background: '#6c757d',
                                color: 'white',
                                border: 'none',
                                borderRadius: '10px',
                                cursor: 'pointer',
                                fontSize: '16px',
                                fontWeight: '600',
                                transition: 'background 0.2s'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.background = '#5a6268'}
                            onMouseLeave={(e) => e.currentTarget.style.background = '#6c757d'}
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            disabled={loading}
                            style={{
                                flex: 2,
                                padding: '14px',
                                background: loading ? '#ccc' : 'linear-gradient(135deg, #0077CC 0%, #008B8B 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '10px',
                                cursor: loading ? 'not-allowed' : 'pointer',
                                fontSize: '16px',
                                fontWeight: '600',
                                transition: 'transform 0.2s'
                            }}
                            onMouseEnter={(e) => {
                                if (!loading) e.currentTarget.style.transform = 'translateY(-2px)';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.transform = 'translateY(0)';
                            }}
                        >
                            {loading ? 'Creating...' : 'Create Assignment'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
}
       

       
        function AlertDetailModal({ alert, onClose, onResolve }) {
            const [notes, setNotes] = useState('');
            const [resolving, setResolving] = useState(false);

            const handleResolve = async () => {
                setResolving(true);
                await onResolve(alert.id, notes);
                setResolving(false);
                onClose();
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">
                                {alert.type === 'sos' ? '🚨 SOS ALERT' : 'Alert Details'}
                            </div>
                            <button className="modal-close" onClick={onClose}>×</button>
                        </div>
                        
                        <div style={{marginBottom: '20px'}}>
                            <strong>User:</strong> {alert.userName}<br />
                            <strong>Type:</strong> {alert.type}<br />
                            <strong>Priority:</strong> {alert.priority || 'Normal'}<br />
                            <strong>Created:</strong> {formatDateTime(alert.createdAt)}<br />
                            <strong>Status:</strong> {alert.resolved ? 'Resolved' : 'Active'}
                        </div>
                        
                        <div style={{marginBottom: '20px', padding: '15px', background: 'rgba(255,255,255,0.05)', borderRadius: '10px'}}>
                            <strong>Message:</strong><br />
                            {alert.message}
                        </div>
                        
                        {alert.resolved && alert.resolutionNotes && (
                            <div style={{marginBottom: '20px', padding: '15px', background: 'rgba(76,175,80,0.1)', borderRadius: '10px'}}>
                                <strong>Resolution Notes:</strong><br />
                                {alert.resolutionNotes}<br />
                                <small>Resolved at: {formatDateTime(alert.resolvedAt)}</small>
                            </div>
                        )}
                        
                        {!alert.resolved && (
                            <>
                                <div className="form-group">
                                    <label className="form-label">Resolution Notes (optional)</label>
                                    <textarea
                                        className="form-input"
                                        value={notes}
                                        onChange={(e) => setNotes(e.target.value)}
                                        rows="3"
                                    />
                                </div>
                                
                                <button 
                                    className="btn btn-success"
                                    onClick={handleResolve}
                                    disabled={resolving}
                                >
                                    {resolving ? 'Resolving...' : 'Mark as Resolved'}
                                </button>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        // Other existing modals remain the same...

        // Pagination Component
        function Pagination({ currentPage, totalPages, onPageChange }) {
            return (
                <div className="pagination">
                    <button 
                        className="page-btn"
                        onClick={() => onPageChange(currentPage - 1)}
                        disabled={currentPage === 1}
                    >
                        Previous
                    </button>
                    
                    {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                        let pageNum;
                        if (totalPages <= 5) {
                            pageNum = i + 1;
                        } else if (currentPage <= 3) {
                            pageNum = i + 1;
                        } else if (currentPage >= totalPages - 2) {
                            pageNum = totalPages - 4 + i;
                        } else {
                            pageNum = currentPage - 2 + i;
                        }
                        
                        return (
                            <button
                                key={pageNum}
                                className={`page-btn ${currentPage === pageNum ? 'active' : ''}`}
                                onClick={() => onPageChange(pageNum)}
                            >
                                {pageNum}
                            </button>
                        );
                    })}
                    
                    <button 
                        className="page-btn"
                        onClick={() => onPageChange(currentPage + 1)}
                        disabled={currentPage === totalPages}
                    >
                        Next
                    </button>
                </div>
            );
        }

// ========== COMPLETE ENHANCED PIR DETAIL MODAL - FULLY REFACTORED ==========
function UserDetailModal({ user, onClose, onUpdate }) {
    // Extract ID from user object
    const pirId = user?.id;
    
    // Core States
    const [pirData, setPirData] = useState(null);
    const [loading, setLoading] = useState(true);
    const [activeTab, setActiveTab] = useState('overview');
    
    // Data States
    const [activities, setActivities] = useState([]);
    const [availableCoaches, setAvailableCoaches] = useState([]);
    const [checkIns, setCheckIns] = useState([]);
    const [assignments, setAssignments] = useState([]);
    const [goals, setGoals] = useState([]);
    const [objectives, setObjectives] = useState([]);
    const [alerts, setAlerts] = useState([]);
    const [meetings, setMeetings] = useState([]);
    const [resources, setResources] = useState([]);
    const [milestones, setMilestones] = useState([]);
    const [messages, setMessages] = useState([]);
    const [supportGroups, setSupportGroups] = useState([]);
    const [pledges, setPledges] = useState([]);
    const [notifications, setNotifications] = useState([]);
    const [topicRooms, setTopicRooms] = useState([]);
    const [resourceProgress, setResourceProgress] = useState({});
    const [resourceNotes, setResourceNotes] = useState({});
    const [streakData, setStreakData] = useState({});
    const [complianceData, setComplianceData] = useState({});
    const [allMessages, setAllMessages] = useState([]);
    
    // UI States
    const [editing, setEditing] = useState(false);
    const [editData, setEditData] = useState({});
    const [chartData, setChartData] = useState(null);
    const [expandedGoals, setExpandedGoals] = useState({});
    const [showAddGoal, setShowAddGoal] = useState(false);
    const [showAddObjective, setShowAddObjective] = useState(false);
    const [showAddAssignment, setShowAddAssignment] = useState(false);
    const [selectedGoalId, setSelectedGoalId] = useState(null);
    const [selectedObjectiveId, setSelectedObjectiveId] = useState(null);
    const [showAssignResource, setShowAssignResource] = useState(false);
    const [showCreateResource, setShowCreateResource] = useState(false);
    const [showGoldenThread, setShowGoldenThread] = useState(false);
    const [selectedGoalForObjective, setSelectedGoalForObjective] = useState(null);
    const [selectedObjectiveForAssignment, setSelectedObjectiveForAssignment] = useState(null);
    
    // Chart refs
    const moodChartRef = useRef(null);
    const cravingChartRef = useRef(null);
    const anxietyChartRef = useRef(null);
    const sleepChartRef = useRef(null);

    // ========== LOAD DATA ON MOUNT ==========
    useEffect(() => {
        if (pirId) {
            loadCompletePIRData();
        }
    }, [pirId]);

    const loadCompletePIRData = async () => {
        try {
            setLoading(true);
            
            const userDoc = await db.collection('users').doc(pirId).get();
            if (!userDoc.exists) {
                alert('PIR not found');
                onClose();
                return;
            }
            
            const userData = { id: userDoc.id, ...userDoc.data() };
            
            // Fix timezone issues for dates
            userData.sobrietyDays = calculateSobrietyDaysFixed(userData.sobrietyDate);
            userData.accountAge = daysSince(userData.createdAt);
            userData.lastLoginFormatted = await getLastLoginFormatted(pirId, userData);
            userData.firstLoginFormatted = formatFirstLogin(userData.createdAt);
            userData.moneySaved = userData.sobrietyDays * (userData.dailyCost || 20);
            
            setPirData(userData);
            setEditData(userData);
            
            // Load all related data in parallel
            await Promise.all([
                loadActivitiesData(),
                loadCheckInsData(),
                loadAssignmentsData(),
                loadGoalsData(),
                loadObjectivesData(),
                loadAlertsData(),
                loadMeetingsData(),
                loadResourcesData(),
                loadMilestonesData(),
                loadMessagesData(),
                loadAllUserMessages(),
                loadSupportGroupsData(),
                loadPledgesData(),
                loadNotificationsData(),
                loadTopicRoomsData(),
                loadResourceProgressData(),
                loadStreakData(),
                loadComplianceDataFixed(userData.createdAt),
                loadProgressChartData(),
                loadAvailableCoaches()
            ]);
            
        } catch (error) {
            console.error('Error loading PIR data:', error);
            alert('Failed to load PIR data: ' + error.message);
        } finally {
            setLoading(false);
        }
    };

    // ========== CALCULATION FUNCTIONS ==========
    const calculateSobrietyDaysFixed = (sobrietyDate) => {
        if (!sobrietyDate) return 0;
        
        let year, month, day;
        
        if (typeof sobrietyDate === 'string' && sobrietyDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
            [year, month, day] = sobrietyDate.split('-').map(Number);
        } else if (sobrietyDate.toDate) {
            const date = sobrietyDate.toDate();
            year = date.getFullYear();
            month = date.getMonth() + 1;
            day = date.getDate();
        } else if (sobrietyDate.seconds) {
            const date = new Date(sobrietyDate.seconds * 1000);
            year = date.getFullYear();
            month = date.getMonth() + 1;
            day = date.getDate();
        } else {
            const date = new Date(sobrietyDate);
            year = date.getFullYear();
            month = date.getMonth() + 1;
            day = date.getDate();
        }
        
        const today = new Date();
        const todayYear = today.getFullYear();
        const todayMonth = today.getMonth() + 1;
        const todayDay = today.getDate();
        
        const startDate = new Date(year, month - 1, day, 0, 0, 0, 0);
        const endDate = new Date(todayYear, todayMonth - 1, todayDay, 0, 0, 0, 0);
        
        const millisecondsDiff = endDate.getTime() - startDate.getTime();
        const complete24HourPeriods = Math.floor(millisecondsDiff / (1000 * 60 * 60 * 24));
        const totalDays = complete24HourPeriods + 2;
        
        return Math.max(1, totalDays);
    };

    const getLastLoginFormatted = async (userId, userData) => {
        try {
            if (userData.lastLogin) {
                const lastLogin = userData.lastLogin.toDate ? userData.lastLogin.toDate() : new Date(userData.lastLogin);
                return lastLogin.toLocaleString('en-US', { 
                    month: 'short', day: 'numeric', year: 'numeric',
                    hour: 'numeric', minute: '2-digit', hour12: true 
                });
            }
            
            const loginActivity = await db.collection('activities')
                .where('userId', '==', userId)
                .where('type', '==', 'login')
                .orderBy('createdAt', 'desc')
                .limit(1)
                .get();
            
            if (!loginActivity.empty) {
                const lastLogin = loginActivity.docs[0].data().createdAt.toDate();
                return lastLogin.toLocaleString('en-US', { 
                    month: 'short', day: 'numeric', year: 'numeric',
                    hour: 'numeric', minute: '2-digit', hour12: true 
                });
            }
            
            return 'No login recorded';
        } catch (error) {
            console.error('Error getting last login:', error);
            return 'Unable to determine';
        }
    };

    const formatFirstLogin = (createdAt) => {
        if (!createdAt) return 'Unknown';
        const date = createdAt.toDate ? createdAt.toDate() : new Date(createdAt);
        return date.toLocaleString('en-US', { 
            month: 'short', day: 'numeric', year: 'numeric'
        });
    };

    const daysSince = (date) => {
        if (!date) return 0;
        const start = date?.toDate ? date.toDate() : new Date(date);
        const today = new Date();
        const diffTime = Math.abs(today - start);
        return Math.floor(diffTime / (1000 * 60 * 60 * 24));
    };

    const formatDate = (date) => {
        if (!date) return 'N/A';
        
        let d;
        if (date?.toDate) {
            d = date.toDate();
        } else if (date?.seconds) {
            d = new Date(date.seconds * 1000);
        } else if (typeof date === 'string') {
            if (!date.includes('T')) {
                d = new Date(date + 'T00:00:00');
            } else {
                d = new Date(date);
            }
        } else {
            d = new Date(date);
        }
        
        return d.toLocaleDateString('en-US', {
            year: 'numeric', month: 'long', day: 'numeric'
        });
    };

    const formatDateTime = (date) => {
        if (!date) return 'N/A';
        const d = date?.toDate ? date.toDate() : new Date(date);
        return d.toLocaleString();
    };

    const formatTimeAgo = (date) => {
        if (!date) return 'Never';
        const d = date?.toDate ? date.toDate() : new Date(date);
        const now = new Date();
        const diff = Math.floor((now - d) / 1000);
        
        if (diff < 60) return 'Just now';
        if (diff < 3600) return Math.floor(diff / 60) + ' minutes ago';
        if (diff < 86400) return Math.floor(diff / 3600) + ' hours ago';
        if (diff < 604800) return Math.floor(diff / 86400) + ' days ago';
        return d.toLocaleDateString();
    };

    // ========== DATA LOADING FUNCTIONS ==========
    const loadAvailableCoaches = async () => {
        try {
            const coachesSnap = await db.collection('users')
                .where('role', 'in', ['admin', 'coach'])
                .get();
            
            const coachesList = [];
            coachesSnap.forEach(doc => {
                coachesList.push({ id: doc.id, ...doc.data() });
            });
            setAvailableCoaches(coachesList);
        } catch (error) {
            console.error('Error loading coaches:', error);
            setAvailableCoaches([]);
        }
    };

    const loadComplianceDataFixed = async (accountCreatedAt) => {
        try {
            const accountDate = accountCreatedAt?.toDate ? accountCreatedAt.toDate() : new Date(accountCreatedAt);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            accountDate.setHours(0, 0, 0, 0);
            
            const daysSinceCreation = Math.floor((today - accountDate) / (1000 * 60 * 60 * 24));
            const daysToCheck = Math.min(daysSinceCreation, 30);
            
            if (daysToCheck <= 0) {
                setComplianceData({
                    morningRate: 0, eveningRate: 0, assignmentRate: 0,
                    totalCheckIns: 0, daysTracked: 0, recentCheckIns: []
                });
                return;
            }
            
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - daysToCheck);
            startDate.setHours(0, 0, 0, 0);
            
            const allCheckInsSnap = await db.collection('checkIns')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .get();
            
            const complianceCheckInsSnap = await db.collection('checkIns')
                .where('userId', '==', pirId)
                .where('createdAt', '>=', startDate)
                .get();
            
            const allCheckInsData = [];
            allCheckInsSnap.forEach(doc => {
                const data = doc.data();
                allCheckInsData.push({
                    id: doc.id, ...data,
                    date: data.createdAt?.toDate ? data.createdAt.toDate() : new Date(data.createdAt)
                });
            });
            
            let morningCount = 0, eveningCount = 0;
            const dateMap = new Map();
            
            complianceCheckInsSnap.forEach(doc => {
                const data = doc.data();
                const checkInDate = data.createdAt?.toDate ? data.createdAt.toDate() : new Date(data.createdAt);
                const dateKey = checkInDate.toDateString();
                
                if (!dateMap.has(dateKey)) {
                    dateMap.set(dateKey, { morning: false, evening: false });
                }
                
                if (data.morningData && !dateMap.get(dateKey).morning) {
                    morningCount++;
                    dateMap.get(dateKey).morning = true;
                }
                if (data.eveningData && !dateMap.get(dateKey).evening) {
                    eveningCount++;
                    dateMap.get(dateKey).evening = true;
                }
            });
            
            const completedAssignments = assignments.filter(a => a.status === 'completed').length;
            const totalAssignments = assignments.length;
            
            const morningRate = Math.min(100, Math.round((morningCount / daysToCheck) * 100));
            const eveningRate = Math.min(100, Math.round((eveningCount / daysToCheck) * 100));
            const assignmentRate = totalAssignments > 0 ? 
                Math.min(100, Math.round((completedAssignments / totalAssignments) * 100)) : 0;
            
            setComplianceData({
                morningRate, eveningRate, assignmentRate,
                totalCheckIns: morningCount + eveningCount,
                daysTracked: daysToCheck,
                recentCheckIns: allCheckInsData
            });
            
            setCheckIns(allCheckInsData);
            
        } catch (error) {
            console.error('Error calculating compliance:', error);
            setComplianceData({
                morningRate: 0, eveningRate: 0, assignmentRate: 0,
                totalCheckIns: 0, daysTracked: 0, recentCheckIns: []
            });
        }
    };

    const loadMilestonesData = async () => {
        try {
            const milestonesList = [];
            
            try {
                const milestonesSnap = await db.collection('milestones')
                    .where('userId', '==', pirId)
                    .get();
                
                milestonesSnap.forEach(doc => {
                    milestonesList.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.error('Error loading custom milestones:', error);
            }
            
            if (pirData?.sobrietyDate) {
                const standardMilestones = getStandardMilestones(pirData.sobrietyDate);
                milestonesList.push(...standardMilestones);
            }
            
            setMilestones(milestonesList);
        } catch (error) {
            console.error('Error loading milestones:', error);
            setMilestones([]);
        }
    };

    const getStandardMilestones = (sobrietyDate) => {
        const milestones = [
            { days: 1, title: '24 Hours', icon: '🌅', description: 'First day of recovery' },
            { days: 7, title: 'One Week', icon: '📅', description: 'A week of sobriety' },
            { days: 30, title: 'One Month', icon: '📆', description: 'First month milestone' },
            { days: 60, title: 'Two Months', icon: '📅', description: 'Two months strong' },
            { days: 90, title: 'Three Months', icon: '🏆', description: 'Quarter year achieved' },
            { days: 180, title: 'Six Months', icon: '⭐', description: 'Half year milestone' },
            { days: 365, title: 'One Year', icon: '🎉', description: 'Full year of recovery' },
            { days: 730, title: 'Two Years', icon: '🎊', description: 'Two years of sobriety' }
        ];
        
        const sobrietyDateObj = sobrietyDate?.toDate ? sobrietyDate.toDate() : new Date(sobrietyDate);
        const today = new Date();
        
        return milestones.map(m => {
            const targetDate = new Date(sobrietyDateObj);
            targetDate.setDate(targetDate.getDate() + m.days);
            const achieved = today >= targetDate;
            const daysUntil = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
            
            return {
                ...m, targetDate, achieved,
                daysUntil: achieved ? 0 : daysUntil,
                type: 'standard',
                id: `standard-${m.days}`
            };
        });
    };

    const loadActivitiesData = async () => {
        try {
            const activitiesSnap = await db.collection('activities')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .limit(100)
                .get();
            
            const activitiesList = [];
            activitiesSnap.forEach(doc => {
                activitiesList.push({ id: doc.id, ...doc.data() });
            });
            setActivities(activitiesList);
        } catch (error) {
            console.error('Error loading activities:', error);
            setActivities([]);
        }
    };

    const loadCheckInsData = async () => {
        try {
            const checkInsSnap = await db.collection('checkIns')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .limit(60)
                .get();
            
            const checkInsList = [];
            checkInsSnap.forEach(doc => {
                checkInsList.push({ id: doc.id, ...doc.data() });
            });
            setCheckIns(checkInsList);
        } catch (error) {
            console.error('Error loading check-ins:', error);
            setCheckIns([]);
        }
    };

    const loadAssignmentsData = async () => {
        try {
            const assignmentsSnap = await db.collection('assignments')
                .where('userId', '==', pirId)
                .get();
            
            const assignmentsList = [];
            assignmentsSnap.forEach(doc => {
                assignmentsList.push({ id: doc.id, ...doc.data() });
            });
            setAssignments(assignmentsList);
        } catch (error) {
            console.error('Error loading assignments:', error);
            setAssignments([]);
        }
    };

    const loadGoalsData = async () => {
        try {
            const goalsSnap = await db.collection('goals')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .get();
            
            const goalsList = [];
            for (const doc of goalsSnap.docs) {
                const goalData = { id: doc.id, ...doc.data() };
                goalData.progress = await calculateGoalProgress(doc.id);
                goalsList.push(goalData);
            }
            setGoals(goalsList);
        } catch (error) {
            console.error('Error loading goals:', error);
            setGoals([]);
        }
    };

    const loadObjectivesData = async () => {
        try {
            const objectivesSnap = await db.collection('objectives')
                .where('userId', '==', pirId)
                .orderBy('order', 'asc')
                .get();
            
            const objectivesList = [];
            objectivesSnap.forEach(doc => {
                objectivesList.push({ id: doc.id, ...doc.data() });
            });
            setObjectives(objectivesList);
        } catch (error) {
            console.error('Error loading objectives:', error);
            setObjectives([]);
        }
    };

    const loadAlertsData = async () => {
        try {
            const alertsSnap = await db.collection('alerts')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .limit(50)
                .get();
            
            const alertsList = [];
            alertsSnap.forEach(doc => {
                alertsList.push({ id: doc.id, ...doc.data() });
            });
            setAlerts(alertsList);
        } catch (error) {
            console.error('Error loading alerts:', error);
            setAlerts([]);
        }
    };

    const loadMeetingsData = async () => {
        try {
            const meetingsSnap = await db.collection('meetings')
                .where('pirId', '==', pirId)
                .orderBy('scheduledTime', 'desc')
                .get();
            
            const meetingsList = [];
            meetingsSnap.forEach(doc => {
                meetingsList.push({ id: doc.id, ...doc.data() });
            });
            setMeetings(meetingsList);
        } catch (error) {
            console.error('Error loading meetings:', error);
            setMeetings([]);
        }
    };

    const loadResourcesData = async () => {
        try {
            const resourcesList = [];
            
            try {
                const assignedResources = await db.collection('resources')
                    .where('assignedTo', 'array-contains', pirId)
                    .get();
                
                assignedResources.forEach(doc => {
                    resourcesList.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.log('Array-contains query failed, trying alternative');
            }
            
            try {
                const globalResources = await db.collection('resources')
                    .where('isGlobal', '==', true)
                    .get();
                
                globalResources.forEach(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    if (!resourcesList.find(r => r.id === doc.id)) {
                        resourcesList.push(data);
                    }
                });
            } catch (error) {
                console.log('Global resources query failed');
            }
            
            setResources(resourcesList);
        } catch (error) {
            console.error('Error loading resources:', error);
            setResources([]);
        }
    };

    const loadMessagesData = async () => {
        try {
            const messagesSnap = await db.collection('messages')
                .where('senderId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .limit(50)
                .get();
            
            const messagesList = [];
            messagesSnap.forEach(doc => {
                messagesList.push({ id: doc.id, ...doc.data() });
            });
            setMessages(messagesList);
        } catch (error) {
            console.error('Error loading messages:', error);
            setMessages([]);
        }
    };

    const loadAllUserMessages = async () => {
        try {
            const messagesData = [];
            
            try {
                const directMessages = await db.collection('messages')
                    .where('senderId', '==', pirId)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                directMessages.forEach(doc => {
                    messagesData.push({ id: doc.id, ...doc.data(), type: 'direct' });
                });
            } catch (error) {
                console.log('Error loading direct messages:', error);
            }
            
            try {
                const receivedMessages = await db.collection('messages')
                    .where('userId', '==', pirId)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                receivedMessages.forEach(doc => {
                    const data = doc.data();
                    if (data.senderId === pirId) {
                        messagesData.push({ id: doc.id, ...data, type: 'direct' });
                    }
                });
            } catch (error) {
                console.log('Error loading received messages:', error);
            }
            
            try {
                const communityMessages = await db.collection('glrsChat')
                    .where('senderId', '==', pirId)
                    .orderBy('createdAt', 'desc')
                    .limit(50)
                    .get();
                
                communityMessages.forEach(doc => {
                    messagesData.push({ id: doc.id, ...doc.data(), type: 'community' });
                });
            } catch (error) {
                console.log('Community chat collection may not exist:', error);
            }
            
            try {
                const topicMessages = await db.collection('topicRoomMessages')
                    .where('senderId', '==', pirId)
                    .orderBy('createdAt', 'desc')
                    .limit(50)
                    .get();
                
                topicMessages.forEach(doc => {
                    messagesData.push({ id: doc.id, ...doc.data(), type: 'topic' });
                });
            } catch (error) {
                console.log('Topic room messages may not exist:', error);
            }
            
            messagesData.sort((a, b) => {
                const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
                const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
                return dateB - dateA;
            });
            
            setAllMessages(messagesData);
            
        } catch (error) {
            console.error('Error loading user messages:', error);
            setAllMessages([]);
        }
    };

    const loadSupportGroupsData = async () => {
        try {
            const supportGroupsSnap = await db.collection('supportGroups')
                .where('active', '==', true)
                .get();
            
            const supportGroupsList = [];
            supportGroupsSnap.forEach(doc => {
                supportGroupsList.push({ id: doc.id, ...doc.data() });
            });
            setSupportGroups(supportGroupsList);
        } catch (error) {
            console.error('Error loading support groups:', error);
            setSupportGroups([]);
        }
    };

    const loadPledgesData = async () => {
        try {
            const pledgesSnap = await db.collection('pledges')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .limit(30)
                .get();
            
            const pledgesList = [];
            pledgesSnap.forEach(doc => {
                pledgesList.push({ id: doc.id, ...doc.data() });
            });
            setPledges(pledgesList);
        } catch (error) {
            console.error('Error loading pledges:', error);
            setPledges([]);
        }
    };

    const loadNotificationsData = async () => {
        try {
            const notificationsSnap = await db.collection('notifications')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .limit(50)
                .get();
            
            const notificationsList = [];
            notificationsSnap.forEach(doc => {
                notificationsList.push({ id: doc.id, ...doc.data() });
            });
            setNotifications(notificationsList);
        } catch (error) {
            console.error('Error loading notifications:', error);
            setNotifications([]);
        }
    };

    const loadTopicRoomsData = async () => {
        try {
            const topicRoomsSnap = await db.collection('topicRooms').get();
            
            const topicRoomsList = [];
            topicRoomsSnap.forEach(doc => {
                topicRoomsList.push({ id: doc.id, ...doc.data() });
            });
            setTopicRooms(topicRoomsList);
        } catch (error) {
            console.error('Error loading topic rooms:', error);
            setTopicRooms([]);
        }
    };

    const loadResourceProgressData = async () => {
        try {
            const progressDoc = await db.collection('users').doc(pirId)
                .collection('resourcePreferences').doc('progress').get();
            
            if (progressDoc.exists) {
                setResourceProgress(progressDoc.data() || {});
            }
            
            const notesDoc = await db.collection('users').doc(pirId)
                .collection('resourcePreferences').doc('notes').get();
            
            if (notesDoc.exists) {
                setResourceNotes(notesDoc.data() || {});
            }
        } catch (error) {
            console.error('Error loading resource progress:', error);
        }
    };

    const loadStreakData = async () => {
        try {
            const streakDoc = await db.collection('streaks').doc(pirId).get();
            if (streakDoc.exists) {
                setStreakData(streakDoc.data());
            }
        } catch (error) {
            console.error('Error loading streak data:', error);
        }
    };

    const loadProgressChartData = async () => {
        try {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const checkInsSnap = await db.collection('checkIns')
                .where('userId', '==', pirId)
                .where('createdAt', '>=', thirtyDaysAgo)
                .orderBy('createdAt', 'asc')
                .get();
            
            const chartLabels = [];
            const moodData = [];
            const cravingData = [];
            const anxietyData = [];
            const sleepData = [];
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                chartLabels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                
                let dayCheckIn = null;
                checkInsSnap.forEach(doc => {
                    const checkInDate = doc.data().createdAt?.toDate() || new Date(doc.data().createdAt);
                    if (checkInDate.toDateString() === date.toDateString()) {
                        dayCheckIn = doc.data();
                    }
                });
                
                moodData.push(dayCheckIn?.morningData?.mood ?? null);
                cravingData.push(dayCheckIn?.morningData?.craving ?? null);
                anxietyData.push(dayCheckIn?.morningData?.anxietyLevel ?? null);
                sleepData.push(dayCheckIn?.morningData?.sleepQuality ?? null);
            }
            
            setChartData({
                labels: chartLabels,
                mood: moodData,
                craving: cravingData,
                anxiety: anxietyData,
                sleep: sleepData
            });
        } catch (error) {
            console.error('Error loading chart data:', error);
        }
    };

    const calculateGoalProgress = async (goalId) => {
        const goalAssignments = assignments.filter(a => a.goalId === goalId);
        const completed = goalAssignments.filter(a => a.status === 'completed').length;
        return goalAssignments.length > 0 ? Math.round((completed / goalAssignments.length) * 100) : 0;
    };

    const getActivityIcon = (type) => {
        const icons = {
            'check_in': '✅', 'assignment_completed': '📝', 'goal_completed': '🎯',
            'objective_completed': '🎯', 'message_sent': '💬', 'sos_triggered': '🚨',
            'login': '🔑', 'profile_updated': '👤', 'pledge_completed': '🤝',
            'resource_viewed': '📚', 'milestone_achieved': '🏆', 'streak_update': '🔥'
        };
        return icons[type] || '📌';
    };

    const getActivityColor = (type) => {
        const colors = {
            'check_in': 'var(--success-color)',
            'assignment_completed': 'var(--primary-color)',
            'goal_completed': 'var(--warning-color)',
            'message_sent': 'var(--secondary-color)',
            'sos_triggered': 'var(--danger-color)',
            'login': 'var(--info-color)',
            'profile_updated': 'var(--muted-color)'
        };
        return colors[type] || 'var(--text-muted)';
    };

    // ========== CHART RENDERING ==========
    useEffect(() => {
        if (chartData && activeTab === 'progress') {
            setTimeout(() => {
                renderCharts();
            }, 100);
        }
    }, [chartData, activeTab]);

    const renderCharts = () => {
        const chartConfig = {
            type: 'line',
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 10, ticks: { stepSize: 1 } }
                },
                plugins: {
                    legend: { display: true },
                    tooltip: { enabled: true }
                }
            }
        };

        if (moodChartRef.current) moodChartRef.current.destroy();
        if (cravingChartRef.current) cravingChartRef.current.destroy();
        if (anxietyChartRef.current) anxietyChartRef.current.destroy();
        if (sleepChartRef.current) sleepChartRef.current.destroy();

        const moodCanvas = document.getElementById(`mood-chart-${pirId}`);
        if (moodCanvas) {
            moodChartRef.current = new Chart(moodCanvas, {
                ...chartConfig,
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Mood',
                        data: chartData.mood,
                        borderColor: 'var(--success-color)',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4,
                        spanGaps: true
                    }]
                }
            });
        }

        const cravingCanvas = document.getElementById(`craving-chart-${pirId}`);
        if (cravingCanvas) {
            cravingChartRef.current = new Chart(cravingCanvas, {
                ...chartConfig,
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Craving',
                        data: chartData.craving,
                        borderColor: 'var(--warning-color)',
                        backgroundColor: 'rgba(255, 152, 0, 0.1)',
                        tension: 0.4,
                        spanGaps: true
                    }]
                }
            });
        }

        const anxietyCanvas = document.getElementById(`anxiety-chart-${pirId}`);
        if (anxietyCanvas) {
            anxietyChartRef.current = new Chart(anxietyCanvas, {
                ...chartConfig,
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Anxiety',
                        data: chartData.anxiety,
                        borderColor: 'var(--danger-color)',
                        backgroundColor: 'rgba(244, 67, 54, 0.1)',
                        tension: 0.4,
                        spanGaps: true
                    }]
                }
            });
        }

        const sleepCanvas = document.getElementById(`sleep-chart-${pirId}`);
        if (sleepCanvas) {
            sleepChartRef.current = new Chart(sleepCanvas, {
                ...chartConfig,
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Sleep Quality',
                        data: chartData.sleep,
                        borderColor: 'var(--secondary-color)',
                        backgroundColor: 'rgba(156, 39, 176, 0.1)',
                        tension: 0.4,
                        spanGaps: true
                    }]
                }
            });
        }
    };

    // ========== ACTION HANDLERS ==========
    const handleSaveProfile = async () => {
        try {
            const updates = {
                ...editData,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            if (editData.assignedCoach !== pirData.assignedCoach) {
                const newCoach = availableCoaches.find(c => c.id === editData.assignedCoach);
                const oldCoach = availableCoaches.find(c => c.id === pirData.assignedCoach);
                
                const historyEntry = {
                    assignedAt: new Date().toISOString(),
                    assignedBy: user.uid,
                    coachId: editData.assignedCoach,
                    coachName: newCoach?.displayName || newCoach?.email || 'Unknown',
                    previousCoachId: pirData.assignedCoach || null,
                    previousCoachName: oldCoach?.displayName || oldCoach?.email || 'None'
                };
                
                updates.coachAssignmentHistory = firebase.firestore.FieldValue.arrayUnion(historyEntry);
                
                if (editData.assignedCoach) {
                    await createNotificationWithPreferences({
                        recipientId: editData.assignedCoach,
                        type: 'pir_assigned',
                        message: `${pirData.displayName || pirData.email} has been assigned to you`,
                        pirId: pirId,
                        pirName: pirData.displayName || pirData.email,
                        read: false
                    }, 'pir_assigned');
                }

                await createNotificationWithPreferences({
                    recipientId: pirId,
                    type: 'coach_changed',
                    message: `Your coach has been updated to ${newCoach?.displayName || 'a new coach'}`,
                    read: false
                }, 'coach_changed');
            }
            
            await db.collection('users').doc(pirId).update(updates);
            
            await db.collection('activities').add({
                userId: pirId,
                type: 'profile_updated',
                description: 'Profile information updated' + 
                    (editData.assignedCoach !== pirData.assignedCoach ? ' - Coach assignment changed' : ''),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            setPirData(editData);
            setEditing(false);
            alert('Profile updated successfully' + 
                (editData.assignedCoach !== pirData.assignedCoach ? '\n\nCoach assignment changed and notifications sent!' : ''));
            if (onUpdate) onUpdate();
        } catch (error) {
            console.error('Error updating profile:', error);
            alert('Failed to update profile: ' + error.message);
        }
    };

    // ========== NEW: DELETE ACCOUNT (SOFT DELETE) ==========
    const handleDeleteAccount = async () => {
        const confirmDelete = confirm(
            `⚠️ DELETE ACCOUNT WARNING\n\n` +
            `Are you sure you want to delete ${pirData.displayName || pirData.email}'s account?\n\n` +
            `This will:\n` +
            `• Mark account as DELETED and INACTIVE\n` +
            `• Prevent PIR from logging in\n` +
            `• Preserve all data for compliance (7 years)\n` +
            `• Record deletion in activity log\n\n` +
            `Type "DELETE" in the next prompt to confirm.`
        );
        
        if (!confirmDelete) return;
        
        const confirmText = prompt('Type DELETE to confirm account deletion:');
        if (confirmText !== 'DELETE') {
            alert('Deletion cancelled. Text did not match.');
            return;
        }
        
        try {
            await db.collection('users').doc(pirId).update({
                deleted: true,
                active: false,
                deletedAt: firebase.firestore.FieldValue.serverTimestamp(),
                deletedBy: user.uid,
                deletedReason: 'Admin deleted account',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await db.collection('activities').add({
                userId: pirId,
                type: 'account_deleted',
                description: `Account deleted by ${user.displayName || user.email}`,
                deletedBy: user.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await createNotificationWithPreferences({
                recipientId: pirId,
                type: 'account_deleted',
                message: 'Your account has been deactivated. Please contact support if you believe this is an error.',
                read: false
            }, 'alert');
            
            alert('✅ Account deleted successfully!\n\nThe PIR can no longer log in, but all data is preserved for compliance.');
            
            if (onUpdate) onUpdate();
            onClose();
            
        } catch (error) {
            console.error('Error deleting account:', error);
            alert('❌ Failed to delete account: ' + error.message);
        }
    };

    // ========== NEW: TOGGLE ACTIVE STATUS ==========
    const handleToggleActiveStatus = async () => {
        const newActiveStatus = !pirData.active;
        const action = newActiveStatus ? 'ACTIVATE' : 'DEACTIVATE';
        
        const confirm = window.confirm(
            `${action} ACCOUNT\n\n` +
            `Are you sure you want to ${action.toLowerCase()} ${pirData.displayName || pirData.email}'s account?\n\n` +
            `${newActiveStatus ? 
                '• PIR will be able to log in\n• All features will be accessible' : 
                '• PIR will NOT be able to log in\n• Account will be locked'}`
        );
        
        if (!confirm) return;
        
        try {
            await db.collection('users').doc(pirId).update({
                active: newActiveStatus,
                activeStatusChangedAt: firebase.firestore.FieldValue.serverTimestamp(),
                activeStatusChangedBy: user.uid,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await db.collection('activities').add({
                userId: pirId,
                type: newActiveStatus ? 'account_activated' : 'account_deactivated',
                description: `Account ${newActiveStatus ? 'activated' : 'deactivated'} by ${user.displayName || user.email}`,
                changedBy: user.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await createNotificationWithPreferences({
                recipientId: pirId,
                type: newActiveStatus ? 'account_activated' : 'account_deactivated',
                message: newActiveStatus ?
                    'Your account has been activated. You can now log in.' :
                    'Your account has been deactivated. Please contact support.',
                read: false
            }, 'alert');
            
            setPirData({...pirData, active: newActiveStatus});
            setEditData({...editData, active: newActiveStatus});
            
            alert(`✅ Account ${newActiveStatus ? 'activated' : 'deactivated'} successfully!`);
            
            if (onUpdate) onUpdate();
            
        } catch (error) {
            console.error('Error toggling active status:', error);
            alert('❌ Failed to update status: ' + error.message);
        }
    };

    const handleAddGoal = async (goalData) => {
        try {
            await db.collection('goals').add({
                ...goalData,
                userId: pirId,
                createdBy: user.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await loadGoalsData();
            setShowAddGoal(false);
            alert('Goal added successfully');
        } catch (error) {
            console.error('Error adding goal:', error);
            alert('Failed to add goal');
        }
    };

    const handleAssignResource = async (resourceId) => {
        try {
            const resourceDoc = await db.collection('resources').doc(resourceId).get();
            const resourceData = resourceDoc.data();
            
            const currentAssigned = resourceData.assignedTo || [];
            if (!currentAssigned.includes(pirId)) {
                await db.collection('resources').doc(resourceId).update({
                    assignedTo: firebase.firestore.FieldValue.arrayUnion(pirId)
                });
                
                await loadResourcesData();
                alert('Resource assigned successfully');
            } else {
                alert('Resource already assigned to this PIR');
            }
        } catch (error) {
            console.error('Error assigning resource:', error);
            alert('Failed to assign resource');
        }
    };

    const handleDeleteMessage = async (messageId, messageType) => {
        if (!confirm('Are you sure you want to delete this message?')) return;
        
        try {
            let collection = 'messages';
            if (messageType === 'community') collection = 'glrsChat';
            if (messageType === 'topic') collection = 'topicRoomMessages';
            
            await db.collection(collection).doc(messageId).delete();
            
            await db.collection('flaggedContent').add({
                originalCollection: collection,
                originalId: messageId,
                userId: pirId,
                flaggedBy: user.uid,
                reason: 'Deleted by coach',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await loadAllUserMessages();
            alert('Message deleted and flagged');
        } catch (error) {
            console.error('Error deleting message:', error);
            alert('Failed to delete message');
        }
    };

    // ========== RENDER OVERVIEW TAB (UPDATED WITH CSS VARIABLES) ==========
    const renderOverviewTab = () => (
        <div style={{ padding: '20px' }}>
            {/* Account Status Banner */}
            {(!pirData.active || pirData.deleted) && (
                <div style={{
                    background: pirData.deleted ? 'var(--gradient-danger)' : 'var(--gradient-warning)',
                    padding: '15px 20px',
                    borderRadius: 'var(--radius-md)',
                    color: 'var(--text-white)',
                    marginBottom: '20px',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    fontWeight: 'bold',
                    boxShadow: 'var(--shadow-md)'
                }}>
                    <span>
                        {pirData.deleted ? '🚫 ACCOUNT DELETED' : '⚠️ ACCOUNT INACTIVE'}
                        {pirData.deleted && ' - PIR cannot log in. Data preserved for compliance.'}
                        {!pirData.deleted && !pirData.active && ' - PIR cannot log in until activated.'}
                    </span>
                    {!pirData.deleted && (
                        <button
                            onClick={handleToggleActiveStatus}
                            style={{
                                background: 'var(--text-white)',
                                color: pirData.active ? 'var(--warning-color)' : 'var(--success-color)',
                                border: 'none',
                                padding: '8px 16px',
                                borderRadius: 'var(--radius-sm)',
                                cursor: 'pointer',
                                fontWeight: 'bold',
                                fontSize: '14px',
                                transition: 'var(--transition-fast)'
                            }}
                        >
                            {pirData.active ? 'Deactivate' : 'Activate'}
                        </button>
                    )}
                </div>
            )}

            {/* Key Metrics Cards */}
            <div style={{ 
                display: 'grid', 
                gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
                gap: '20px',
                marginBottom: '30px'
            }}>
                <div style={{
                    background: 'var(--gradient-primary)',
                    padding: '20px',
                    borderRadius: 'var(--radius-lg)',
                    color: 'var(--text-white)',
                    boxShadow: 'var(--shadow-primary)',
                    transition: 'var(--transition-fast)',
                    cursor: 'default'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Sobriety Days</div>
                    <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{pirData.sobrietyDays}</div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Since {formatDate(pirData.sobrietyDate)}</div>
                </div>

                <div style={{
                    background: 'var(--gradient-primary)',
                    padding: '20px',
                    borderRadius: 'var(--radius-lg)',
                    color: 'var(--text-white)',
                    boxShadow: 'var(--shadow-md)',
                    transition: 'var(--transition-fast)',
                    cursor: 'default'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Current Streak</div>
                    <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{streakData.currentStreak || 0} 🔥</div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Best: {streakData.longestStreak || 0} days</div>
                </div>

                <div style={{
                    background: 'var(--gradient-primary)',
                    padding: '20px',
                    borderRadius: 'var(--radius-lg)',
                    color: 'var(--text-white)',
                    boxShadow: 'var(--shadow-md)',
                    transition: 'var(--transition-fast)',
                    cursor: 'default'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Last Login</div>
                    <div style={{ fontSize: '16px', fontWeight: 'bold' }}>{pirData.lastLoginFormatted}</div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Account age: {pirData.accountAge} days</div>
                </div>

                <div style={{
                    background: 'var(--gradient-primary)',
                    padding: '20px',
                    borderRadius: 'var(--radius-lg)',
                    color: 'var(--text-white)',
                    boxShadow: 'var(--shadow-md)',
                    transition: 'var(--transition-fast)',
                    cursor: 'default'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Money Saved</div>
                    <div style={{ fontSize: '36px', fontWeight: 'bold' }}>${pirData.moneySaved}</div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>${pirData.dailyCost || 20}/day saved</div>
                </div>
            </div>
            
            {/* Profile Information */}
            <div style={{
                background: 'var(--text-white)',
                borderRadius: 'var(--radius-lg)',
                padding: '25px',
                boxShadow: 'var(--shadow-sm)',
                marginBottom: '20px'
            }}>
                <div style={{ 
                    display: 'flex', 
                    justifyContent: 'space-between', 
                    alignItems: 'center',
                    marginBottom: '20px'
                }}>
                    <h3 style={{ margin: 0, color: 'var(--text-primary)' }}>Profile Information</h3>
                    {!editing ? (
                        <button 
                            className="btn btn-secondary"
                            onClick={() => setEditing(true)}
                            style={{
                                background: 'var(--gradient-secondary)',
                                color: 'var(--text-white)',
                                border: 'none',
                                padding: '10px 20px',
                                borderRadius: 'var(--radius-sm)',
                                cursor: 'pointer',
                                fontWeight: '500',
                                transition: 'var(--transition-fast)'
                            }}
                        >
                            Edit Profile
                        </button>
                    ) : (
                        <div style={{ display: 'flex', gap: '10px' }}>
                            <button 
                                className="btn btn-primary"
                                onClick={handleSaveProfile}
                                style={{
                                    background: 'var(--gradient-primary)',
                                    color: 'var(--text-white)',
                                    border: 'none',
                                    padding: '10px 20px',
                                    borderRadius: 'var(--radius-sm)',
                                    cursor: 'pointer',
                                    fontWeight: '500',
                                    transition: 'var(--transition-fast)'
                                }}
                            >
                                Save Changes
                            </button>
                            <button 
                                className="btn btn-secondary"
                                onClick={() => {
                                    setEditing(false);
                                    setEditData(pirData);
                                }}
                                style={{
                                    background: 'var(--text-muted)',
                                    color: 'var(--text-white)',
                                    border: 'none',
                                    padding: '10px 20px',
                                    borderRadius: 'var(--radius-sm)',
                                    cursor: 'pointer',
                                    fontWeight: '500',
                                    transition: 'var(--transition-fast)'
                                }}
                            >
                                Cancel
                            </button>
                        </div>
                    )}
                </div>

                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
                    <div>
                        <label style={{ fontWeight: 'bold', color: 'var(--text-secondary)' }}>Full Name</label>
                        {editing ? (
                            <div style={{ display: 'flex', gap: '10px' }}>
                                <input
                                    type="text"
                                    value={editData.firstName || ''}
                                    onChange={(e) => setEditData({...editData, firstName: e.target.value})}
                                    style={{ 
                                        flex: 1, 
                                        padding: '8px', 
                                        borderRadius: 'var(--radius-sm)', 
                                        border: '1px solid var(--border-color)' 
                                    }}
                                />
                                <input
                                    type="text"
                                    value={editData.lastName || ''}
                                    onChange={(e) => setEditData({...editData, lastName: e.target.value})}
                                    style={{ 
                                        flex: 1, 
                                        padding: '8px', 
                                        borderRadius: 'var(--radius-sm)', 
                                        border: '1px solid var(--border-color)' 
                                    }}
                                />
                            </div>
                        ) : (
                            <p style={{ color: 'var(--text-primary)' }}>{pirData.firstName} {pirData.lastName}</p>
                        )}
                    </div>

                    <div>
                        <label style={{ fontWeight: 'bold', color: 'var(--text-secondary)' }}>Email</label>
                        <p style={{ color: 'var(--text-primary)' }}>{pirData.email}</p>
                    </div>

                    <div>
                        <label style={{ fontWeight: 'bold', color: 'var(--text-secondary)' }}>Phone</label>
                        {editing ? (
                            <input
                                type="tel"
                                value={editData.phone || ''}
                                onChange={(e) => setEditData({...editData, phone: e.target.value})}
                                style={{ 
                                    width: '100%', 
                                    padding: '8px', 
                                    borderRadius: 'var(--radius-sm)', 
                                    border: '1px solid var(--border-color)' 
                                }}
                            />
                        ) : (
                            <p style={{ color: 'var(--text-primary)' }}>{pirData.phone || 'Not provided'}</p>
                        )}
                    </div>

                    <div>
                        <label style={{ fontWeight: 'bold', color: 'var(--text-secondary)' }}>Date of Birth</label>
                        {editing ? (
                            <input
                                type="date"
                                value={editData.dateOfBirth || ''}
                                onChange={(e) => setEditData({...editData, dateOfBirth: e.target.value})}
                                style={{ 
                                    width: '100%', 
                                    padding: '8px', 
                                    borderRadius: 'var(--radius-sm)', 
                                    border: '1px solid var(--border-color)' 
                                }}
                            />
                        ) : (
                            <p style={{ color: 'var(--text-primary)' }}>{pirData.dateOfBirth || 'Not provided'}</p>
                        )}
                    </div>

                    <div>
                        <label style={{ fontWeight: 'bold', color: 'var(--text-secondary)' }}>Sobriety Date</label>
                        {editing ? (
                            <input
                                type="date"
                                value={editData.sobrietyDate || ''}
                                onChange={(e) => setEditData({...editData, sobrietyDate: e.target.value})}
                                style={{ 
                                    width: '100%', 
                                    padding: '8px', 
                                    borderRadius: 'var(--radius-sm)', 
                                    border: '1px solid var(--border-color)' 
                                }}
                            />
                        ) : (
                            <p style={{ color: 'var(--text-primary)' }}>{formatDate(pirData.sobrietyDate)}</p>
                        )}
                    </div>

                    <div>
                        <label style={{ fontWeight: 'bold', color: 'var(--text-secondary)' }}>Substance</label>
                        <p style={{ color: 'var(--text-primary)' }}>{pirData.substance || 'Not specified'}</p>
                    </div>

                    <div style={{ gridColumn: 'span 2' }}>
                        <label style={{ fontWeight: 'bold', color: 'var(--text-secondary)' }}>Address</label>
                        {editing ? (
                            <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr 1fr', gap: '10px' }}>
                                <input
                                    type="text"
                                    value={editData.address?.street || ''}
                                    onChange={(e) => setEditData({
                                        ...editData, 
                                        address: {...editData.address, street: e.target.value}
                                    })}
                                    placeholder="Street Address"
                                    style={{ 
                                        padding: '8px', 
                                        borderRadius: 'var(--radius-sm)', 
                                        border: '1px solid var(--border-color)' 
                                    }}
                                />
                                <input
                                    type="text"
                                    value={editData.address?.city || ''}
                                    onChange={(e) => setEditData({
                                        ...editData, 
                                        address: {...editData.address, city: e.target.value}
                                    })}
                                    placeholder="City"
                                    style={{ 
                                        padding: '8px', 
                                        borderRadius: 'var(--radius-sm)', 
                                        border: '1px solid var(--border-color)' 
                                    }}
                                />
                                <input
                                    type="text"
                                    value={editData.address?.state || ''}
                                    onChange={(e) => setEditData({
                                        ...editData, 
                                        address: {...editData.address, state: e.target.value}
                                    })}
                                    placeholder="State"
                                    style={{ 
                                        padding: '8px', 
                                        borderRadius: 'var(--radius-sm)', 
                                        border: '1px solid var(--border-color)' 
                                    }}
                                />
                                <input
                                    type="text"
                                    value={editData.address?.zip || ''}
                                    onChange={(e) => setEditData({
                                        ...editData, 
                                        address: {...editData.address, zip: e.target.value}
                                    })}
                                    placeholder="ZIP"
                                    style={{ 
                                        padding: '8px', 
                                        borderRadius: 'var(--radius-sm)', 
                                        border: '1px solid var(--border-color)' 
                                    }}
                                />
                            </div>
                        ) : (
                            <p style={{ color: 'var(--text-primary)' }}>
                                {pirData.address ? 
                                    `${pirData.address.street || ''} ${pirData.address.city || ''}, ${pirData.address.state || ''} ${pirData.address.zip || ''}`.trim() : 
                                    'Not provided'}
                            </p>
                        )}
                    </div>
                </div>
            </div>

            {/* Assigned Coach Section */}
            <div style={{
                background: 'var(--text-white)',
                borderRadius: 'var(--radius-lg)',
                padding: '25px',
                boxShadow: 'var(--shadow-sm)',
                marginBottom: '20px'
            }}>
                <h3 style={{ marginBottom: '20px', color: 'var(--text-primary)' }}>Assigned Coach</h3>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
                    <div>
                        <label style={{ fontWeight: 'bold', color: 'var(--text-secondary)' }}>Current Coach</label>
                        {editing ? (
                            <select
                                value={editData.assignedCoach || ''}
                                onChange={(e) => setEditData({...editData, assignedCoach: e.target.value})}
                                style={{ 
                                    width: '100%', 
                                    padding: '8px', 
                                    borderRadius: 'var(--radius-sm)', 
                                    border: '1px solid var(--border-color)',
                                    fontSize: '14px'
                                }}
                            >
                                <option value="">-- No Coach Assigned --</option>
                                {availableCoaches.map(coach => (
                                    <option key={coach.id} value={coach.id}>
                                        {coach.displayName || coach.email} ({coach.role})
                                    </option>
                                ))}
                            </select>
                        ) : (
                            <p style={{ color: 'var(--text-primary)' }}>
                                {availableCoaches.find(c => c.id === pirData.assignedCoach)?.displayName || 
                                 availableCoaches.find(c => c.id === pirData.assignedCoach)?.email || 
                                 'No coach assigned'}
                            </p>
                        )}
                    </div>
                    <div>
                        <label style={{ fontWeight: 'bold', color: 'var(--text-secondary)' }}>Coach Email</label>
                        <p style={{ color: 'var(--text-primary)' }}>
                            {availableCoaches.find(c => c.id === pirData.assignedCoach)?.email || 'N/A'}
                        </p>
                    </div>
                </div>
                
                {pirData.coachAssignmentHistory && pirData.coachAssignmentHistory.length > 0 && (
                    <div style={{ marginTop: '20px', paddingTop: '20px', borderTop: '1px solid var(--border-color)' }}>
                        <h4 style={{ fontSize: '14px', color: 'var(--text-secondary)', marginBottom: '10px' }}>Assignment History</h4>
                        <div style={{ fontSize: '12px', color: 'var(--text-muted)' }}>
                            {pirData.coachAssignmentHistory.slice(0, 3).map((history, index) => (
                                <div key={index} style={{ padding: '5px 0' }}>
                                    {formatDate(history.assignedAt)} - Assigned to {history.coachName || 'Unknown'}
                                </div>
                            ))}
                        </div>
                    </div>
                )}
            </div>

            {/* Account Management Section */}
            <div style={{
                background: 'var(--text-white)',
                borderRadius: 'var(--radius-lg)',
                padding: '25px',
                boxShadow: 'var(--shadow-sm)',
                marginBottom: '20px',
                border: '2px solid var(--border-color)'
            }}>
                <h3 style={{ marginBottom: '20px', color: 'var(--text-primary)' }}>⚠️ Account Management</h3>
                
                <div style={{ display: 'grid', gap: '15px' }}>
                    {/* Active Status Control */}
                    <div style={{
                        padding: '15px',
                        background: pirData.active ? 'rgba(76, 175, 80, 0.1)' : 'rgba(255, 193, 7, 0.1)',
                        borderRadius: 'var(--radius-md)',
                        border: pirData.active ? '1px solid var(--success-color)' : '1px solid var(--warning-color)'
                    }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div>
                                <div style={{ fontWeight: 'bold', marginBottom: '5px', color: 'var(--text-primary)' }}>
                                    Account Status: {pirData.active ? '✅ Active' : '⚠️ Inactive'}
                                </div>
                                <div style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>
                                    {pirData.active ? 
                                        'PIR can log in and access all features' : 
                                        'PIR cannot log in. Activate to restore access.'}
                                </div>
                            </div>
                            {!pirData.deleted && (
                                <button
                                    onClick={handleToggleActiveStatus}
                                    style={{
                                        background: pirData.active ? 'var(--gradient-warning)' : 'var(--gradient-success)',
                                        color: 'var(--text-white)',
                                        border: 'none',
                                        padding: '10px 20px',
                                        borderRadius: 'var(--radius-sm)',
                                        cursor: 'pointer',
                                        fontWeight: 'bold',
                                        fontSize: '14px',
                                        transition: 'var(--transition-fast)'
                                    }}
                                    onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                                    onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                                >
                                    {pirData.active ? 'Deactivate Account' : 'Activate Account'}
                                </button>
                            )}
                        </div>
                    </div>

                    {/* Delete Account Control */}
                    {!pirData.deleted && (
                        <div style={{
                            padding: '15px',
                            background: 'rgba(244, 67, 54, 0.05)',
                            borderRadius: 'var(--radius-md)',
                            border: '2px solid var(--danger-color)'
                        }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <div>
                                    <div style={{ fontWeight: 'bold', marginBottom: '5px', color: 'var(--text-primary)' }}>
                                        🚫 Danger Zone: Delete Account
                                    </div>
                                    <div style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>
                                        Permanently mark account as deleted. Data preserved for compliance.
                                    </div>
                                </div>
                                <button
                                    onClick={handleDeleteAccount}
                                    style={{
                                        background: 'var(--gradient-danger)',
                                        color: 'var(--text-white)',
                                        border: 'none',
                                        padding: '10px 20px',
                                        borderRadius: 'var(--radius-sm)',
                                        cursor: 'pointer',
                                        fontWeight: 'bold',
                                        fontSize: '14px',
                                        transition: 'var(--transition-fast)'
                                    }}
                                    onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                                    onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                                >
                                    Delete Account
                                </button>
                            </div>
                        </div>
                    )}
                    
                    {/* Deleted Account Banner */}
                    {pirData.deleted && (
                        <div style={{
                            padding: '15px',
                            background: 'rgba(244, 67, 54, 0.1)',
                            borderRadius: 'var(--radius-md)',
                            border: '2px solid var(--danger-color)'
                        }}>
                            <div style={{ fontWeight: 'bold', marginBottom: '5px', color: 'var(--danger-color)' }}>
                                🚫 ACCOUNT DELETED
                            </div>
                            <div style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>
                                Deleted on: {pirData.deletedAt ? formatDateTime(pirData.deletedAt) : 'Unknown'}
                                <br />
                                PIR cannot log in. All data preserved for compliance.
                            </div>
                        </div>
                    )}
                </div>
            </div>

            {/* Emergency Contacts */}
            <div style={{
                background: 'var(--text-white)',
                borderRadius: 'var(--radius-lg)',
                padding: '25px',
                boxShadow: 'var(--shadow-sm)',
                marginBottom: '20px'
            }}>
                <h3 style={{ marginBottom: '20px', color: 'var(--text-primary)' }}>Emergency Contacts</h3>
                {pirData.emergencyContacts && pirData.emergencyContacts.length > 0 ? (
                    <div style={{ display: 'grid', gap: '15px' }}>
                        {pirData.emergencyContacts.map((contact, index) => (
                            <div key={index} style={{
                                padding: '15px',
                                background: contact.isPrimary ? 'rgba(76, 175, 80, 0.1)' : 'var(--background-secondary)',
                                borderRadius: 'var(--radius-md)',
                                border: contact.isPrimary ? '2px solid var(--success-color)' : '1px solid var(--border-color)'
                            }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <div>
                                        <div style={{ fontWeight: 'bold', fontSize: '16px', color: 'var(--text-primary)' }}>
                                            {contact.name} 
                                            {contact.isPrimary && (
                                                <span style={{
                                                    marginLeft: '10px',
                                                    background: 'var(--success-color)',
                                                    color: 'var(--text-white)',
                                                    padding: '2px 8px',
                                                    borderRadius: '12px',
                                                    fontSize: '12px'
                                                }}>PRIMARY</span>
                                            )}
                                        </div>
                                        <div style={{ color: 'var(--text-secondary)', marginTop: '5px' }}>
                                            {contact.relationship} • {contact.phone}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                ) : (
                    <p style={{ color: 'var(--text-secondary)' }}>No emergency contacts configured</p>
                )}
            </div>

            {/* Sponsor Information */}
            <div style={{
                background: 'var(--text-white)',
                borderRadius: 'var(--radius-lg)',
                padding: '25px',
                boxShadow: 'var(--shadow-sm)'
            }}>
                <h3 style={{ marginBottom: '20px', color: 'var(--text-primary)' }}>Sponsor Information</h3>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
                    <div>
                        <label style={{ fontWeight: 'bold', color: 'var(--text-secondary)' }}>Sponsor Name</label>
                        {editing ? (
                            <input
                                type="text"
                                value={editData.sponsorName || ''}
                                onChange={(e) => setEditData({...editData, sponsorName: e.target.value})}
                                style={{ 
                                    width: '100%', 
                                    padding: '8px', 
                                    borderRadius: 'var(--radius-sm)', 
                                    border: '1px solid var(--border-color)' 
                                }}
                            />
                        ) : (
                            <p style={{ color: 'var(--text-primary)' }}>{pirData.sponsorName || 'Not assigned'}</p>
                        )}
                    </div>
                    <div>
                        <label style={{ fontWeight: 'bold', color: 'var(--text-secondary)' }}>Sponsor Phone</label>
                        {editing ? (
                            <input
                                type="tel"
                                value={editData.sponsorPhone || ''}
                                onChange={(e) => setEditData({...editData, sponsorPhone: e.target.value})}
                                style={{ 
                                    width: '100%', 
                                    padding: '8px', 
                                    borderRadius: 'var(--radius-sm)', 
                                    border: '1px solid var(--border-color)' 
                                }}
                            />
                        ) : (
                            <p style={{ color: 'var(--text-primary)' }}>{pirData.sponsorPhone || 'Not provided'}</p>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
// ========== PROGRESS TAB - CSS VARIABLES + READABLE TEXT ==========
const renderProgressTab = () => (
    <div style={{ padding: '20px' }}>
        {/* Compliance Metrics */}
        <div style={{
            background: 'var(--text-white)',
            borderRadius: 'var(--radius-lg)',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: 'var(--shadow-sm)'
        }}>
            <h3 style={{ 
                marginBottom: '20px', 
                color: 'var(--text-primary)',
                fontSize: '18px',
                fontWeight: '600'
            }}>
                Compliance Metrics (Last {complianceData.daysTracked} Days)
            </h3>
            <div style={{ 
                display: 'grid', 
                gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', 
                gap: '20px' 
            }}>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ 
                        fontSize: '36px', 
                        fontWeight: 'bold', 
                        color: 'var(--success-color)' 
                    }}>
                        {complianceData.morningRate}%
                    </div>
                    <div style={{ color: 'var(--text-secondary)', fontSize: '14px' }}>
                        Morning Check-ins
                    </div>
                </div>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ 
                        fontSize: '36px', 
                        fontWeight: 'bold', 
                        color: 'var(--primary-color)' 
                    }}>
                        {complianceData.eveningRate}%
                    </div>
                    <div style={{ color: 'var(--text-secondary)', fontSize: '14px' }}>
                        Evening Reflections
                    </div>
                </div>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ 
                        fontSize: '36px', 
                        fontWeight: 'bold', 
                        color: 'var(--warning-color)' 
                    }}>
                        {complianceData.assignmentRate}%
                    </div>
                    <div style={{ color: 'var(--text-secondary)', fontSize: '14px' }}>
                        Assignments Complete
                    </div>
                </div>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ 
                        fontSize: '36px', 
                        fontWeight: 'bold', 
                        color: 'var(--secondary-color)' 
                    }}>
                        {complianceData.totalCheckIns}
                    </div>
                    <div style={{ color: 'var(--text-secondary)', fontSize: '14px' }}>
                        Total Check-ins
                    </div>
                </div>
            </div>
        </div>

        {/* Check-ins History Table */}
        <div style={{
            background: 'var(--text-white)',
            borderRadius: 'var(--radius-lg)',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: 'var(--shadow-sm)'
        }}>
            <h3 style={{ 
                marginBottom: '20px', 
                color: 'var(--text-primary)',
                fontSize: '18px',
                fontWeight: '600'
            }}>
                Check-in History
            </h3>
            <div style={{ overflowX: 'auto' }}>
                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                    <thead>
                        <tr style={{ 
                            borderBottom: '2px solid var(--border-color)', 
                            background: 'var(--background-secondary)' 
                        }}>
                            <th style={{ 
                                padding: '12px', 
                                textAlign: 'left', 
                                color: 'var(--text-primary)', 
                                fontWeight: 'bold',
                                fontSize: '14px'
                            }}>Date</th>
                            <th style={{ 
                                padding: '12px', 
                                textAlign: 'center', 
                                color: 'var(--text-primary)', 
                                fontWeight: 'bold',
                                fontSize: '14px'
                            }}>Morning</th>
                            <th style={{ 
                                padding: '12px', 
                                textAlign: 'center', 
                                color: 'var(--text-primary)', 
                                fontWeight: 'bold',
                                fontSize: '14px'
                            }}>Evening</th>
                            <th style={{ 
                                padding: '12px', 
                                textAlign: 'center', 
                                color: 'var(--text-primary)', 
                                fontWeight: 'bold',
                                fontSize: '14px'
                            }}>Mood</th>
                            <th style={{ 
                                padding: '12px', 
                                textAlign: 'center', 
                                color: 'var(--text-primary)', 
                                fontWeight: 'bold',
                                fontSize: '14px'
                            }}>Craving</th>
                            <th style={{ 
                                padding: '12px', 
                                textAlign: 'center', 
                                color: 'var(--text-primary)', 
                                fontWeight: 'bold',
                                fontSize: '14px'
                            }}>Sleep</th>
                            <th style={{ 
                                padding: '12px', 
                                textAlign: 'left', 
                                color: 'var(--text-primary)', 
                                fontWeight: 'bold',
                                fontSize: '14px'
                            }}>Daily Pledge</th>
                        </tr>
                    </thead>
                    <tbody>
                        {checkIns && checkIns.length > 0 ? (
                            checkIns.map((checkIn, index) => (
                                <tr key={checkIn.id} style={{ 
                                    borderBottom: '1px solid var(--border-color)',
                                    background: index % 2 === 0 ? 'var(--text-white)' : 'var(--background-secondary)'
                                }}>
                                    <td style={{ 
                                        padding: '10px', 
                                        color: 'var(--text-primary)', 
                                        fontWeight: '500',
                                        fontSize: '14px'
                                    }}>
                                        {formatDate(checkIn.createdAt)}
                                    </td>
                                    <td style={{ padding: '10px', textAlign: 'center' }}>
                                        {checkIn.morningData ? (
                                            <span style={{ 
                                                color: 'var(--success-color)', 
                                                fontSize: '18px', 
                                                fontWeight: 'bold' 
                                            }}>✓</span>
                                        ) : (
                                            <span style={{ 
                                                color: 'var(--text-muted)', 
                                                fontSize: '18px' 
                                            }}>✗</span>
                                        )}
                                    </td>
                                    <td style={{ padding: '10px', textAlign: 'center' }}>
                                        {checkIn.eveningData ? (
                                            <span style={{ 
                                                color: 'var(--primary-color)', 
                                                fontSize: '18px', 
                                                fontWeight: 'bold' 
                                            }}>✓</span>
                                        ) : (
                                            <span style={{ 
                                                color: 'var(--text-muted)', 
                                                fontSize: '18px' 
                                            }}>✗</span>
                                        )}
                                    </td>
                                    <td style={{ 
                                        padding: '10px', 
                                        textAlign: 'center', 
                                        color: 'var(--text-primary)', 
                                        fontWeight: '500',
                                        fontSize: '14px'
                                    }}>
                                        {checkIn.morningData?.mood || checkIn.eveningData?.mood || '-'}/10
                                    </td>
                                    <td style={{ 
                                        padding: '10px', 
                                        textAlign: 'center', 
                                        color: 'var(--text-primary)', 
                                        fontWeight: '500',
                                        fontSize: '14px'
                                    }}>
                                        {checkIn.morningData?.craving || checkIn.eveningData?.craving || '-'}/10
                                    </td>
                                    <td style={{ 
                                        padding: '10px', 
                                        textAlign: 'center', 
                                        color: 'var(--text-primary)', 
                                        fontWeight: '500',
                                        fontSize: '14px'
                                    }}>
                                        {checkIn.morningData?.sleepQuality || '-'}/10
                                    </td>
                                    <td style={{ padding: '10px' }}>
                                        <div style={{ 
                                            maxWidth: '200px', 
                                            overflow: 'hidden', 
                                            textOverflow: 'ellipsis',
                                            whiteSpace: 'nowrap',
                                            fontSize: '13px',
                                            color: 'var(--text-secondary)',
                                            fontWeight: '400'
                                        }}>
                                            {checkIn.morningData?.dailyPledge || '-'}
                                        </div>
                                    </td>
                                </tr>
                            ))
                        ) : (
                            <tr>
                                <td colSpan="7" style={{ 
                                    padding: '40px', 
                                    textAlign: 'center', 
                                    color: 'var(--text-secondary)',
                                    background: 'var(--background-secondary)',
                                    fontSize: '14px'
                                }}>
                                    No check-ins recorded yet
                                </td>
                            </tr>
                        )}
                    </tbody>
                </table>
            </div>
        </div>

        {/* Progress Charts */}
        <div style={{ 
            display: 'grid', 
            gridTemplateColumns: '1fr 1fr', 
            gap: '20px', 
            marginBottom: '20px' 
        }}>
            <div style={{
                background: 'var(--text-white)',
                borderRadius: 'var(--radius-lg)',
                padding: '20px',
                boxShadow: 'var(--shadow-sm)'
            }}>
                <h4 style={{ 
                    marginBottom: '15px', 
                    color: 'var(--text-primary)',
                    fontSize: '16px',
                    fontWeight: '600'
                }}>
                    30-Day Mood Trend
                </h4>
                <div style={{ height: '200px' }}>
                    <canvas id={`mood-chart-${pirId}`}></canvas>
                </div>
            </div>
            
            <div style={{
                background: 'var(--text-white)',
                borderRadius: 'var(--radius-lg)',
                padding: '20px',
                boxShadow: 'var(--shadow-sm)'
            }}>
                <h4 style={{ 
                    marginBottom: '15px', 
                    color: 'var(--text-primary)',
                    fontSize: '16px',
                    fontWeight: '600'
                }}>
                    30-Day Craving Trend
                </h4>
                <div style={{ height: '200px' }}>
                    <canvas id={`craving-chart-${pirId}`}></canvas>
                </div>
            </div>
            
            <div style={{
                background: 'var(--text-white)',
                borderRadius: 'var(--radius-lg)',
                padding: '20px',
                boxShadow: 'var(--shadow-sm)'
            }}>
                <h4 style={{ 
                    marginBottom: '15px', 
                    color: 'var(--text-primary)',
                    fontSize: '16px',
                    fontWeight: '600'
                }}>
                    30-Day Anxiety Trend
                </h4>
                <div style={{ height: '200px' }}>
                    <canvas id={`anxiety-chart-${pirId}`}></canvas>
                </div>
            </div>
            
            <div style={{
                background: 'var(--text-white)',
                borderRadius: 'var(--radius-lg)',
                padding: '20px',
                boxShadow: 'var(--shadow-sm)'
            }}>
                <h4 style={{ 
                    marginBottom: '15px', 
                    color: 'var(--text-primary)',
                    fontSize: '16px',
                    fontWeight: '600'
                }}>
                    30-Day Sleep Quality Trend
                </h4>
                <div style={{ height: '200px' }}>
                    <canvas id={`sleep-chart-${pirId}`}></canvas>
                </div>
            </div>
        </div>

        {/* Evening Reflections Section */}
        <div style={{
            background: 'var(--text-white)',
            borderRadius: 'var(--radius-lg)',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: 'var(--shadow-sm)'
        }}>
            <h3 style={{ 
                marginBottom: '20px', 
                color: 'var(--text-primary)',
                fontSize: '18px',
                fontWeight: '600'
            }}>
                Evening Reflections
            </h3>
            <div style={{ maxHeight: '500px', overflowY: 'auto' }}>
                {checkIns && checkIns.filter(c => c.eveningData).length > 0 ? (
                    checkIns.filter(c => c.eveningData).map((checkIn, index) => (
                        <div key={checkIn.id} style={{
                            padding: '20px',
                            marginBottom: '15px',
                            background: index % 2 === 0 ? 'var(--background-secondary)' : '#f5f5f5',
                            borderRadius: 'var(--radius-md)',
                            borderLeft: '4px solid var(--primary-color)'
                        }}>
                            <div style={{ 
                                display: 'flex', 
                                justifyContent: 'space-between', 
                                alignItems: 'center',
                                marginBottom: '15px'
                            }}>
                                <h5 style={{ 
                                    margin: 0, 
                                    color: 'var(--text-primary)',
                                    fontSize: '15px',
                                    fontWeight: '600'
                                }}>
                                    {formatDate(checkIn.createdAt)}
                                </h5>
                                <div style={{
                                    background: 'var(--primary-color)',
                                    color: 'var(--text-white)',
                                    padding: '4px 12px',
                                    borderRadius: '12px',
                                    fontSize: '12px',
                                    fontWeight: '500'
                                }}>
                                    Overall Day: {checkIn.eveningData.overallDay || 0}/10
                                </div>
                            </div>
                            
                            <div style={{ display: 'grid', gap: '12px' }}>
                                {checkIn.eveningData.gratitude && (
                                    <div>
                                        <strong style={{ 
                                            color: 'var(--success-color)', 
                                            fontSize: '13px',
                                            fontWeight: '600'
                                        }}>Gratitude:</strong>
                                        <p style={{ 
                                            margin: '4px 0', 
                                            color: 'var(--text-primary)', 
                                            fontSize: '14px',
                                            lineHeight: '1.5'
                                        }}>
                                            {checkIn.eveningData.gratitude}
                                        </p>
                                    </div>
                                )}
                                
                                {checkIn.eveningData.challenges && (
                                    <div>
                                        <strong style={{ 
                                            color: 'var(--warning-color)', 
                                            fontSize: '13px',
                                            fontWeight: '600'
                                        }}>Challenges:</strong>
                                        <p style={{ 
                                            margin: '4px 0', 
                                            color: 'var(--text-primary)', 
                                            fontSize: '14px',
                                            lineHeight: '1.5'
                                        }}>
                                            {checkIn.eveningData.challenges}
                                        </p>
                                    </div>
                                )}
                                
                                {checkIn.eveningData.tomorrowGoal && (
                                    <div>
                                        <strong style={{ 
                                            color: 'var(--secondary-color)', 
                                            fontSize: '13px',
                                            fontWeight: '600'
                                        }}>Tomorrow's Goal:</strong>
                                        <p style={{ 
                                            margin: '4px 0', 
                                            color: 'var(--text-primary)', 
                                            fontSize: '14px',
                                            lineHeight: '1.5'
                                        }}>
                                            {checkIn.eveningData.tomorrowGoal}
                                        </p>
                                    </div>
                                )}
                            </div>
                        </div>
                    ))
                ) : (
                    <div style={{ 
                        padding: '40px', 
                        textAlign: 'center', 
                        color: 'var(--text-secondary)',
                        fontSize: '14px'
                    }}>
                        No evening reflections recorded yet
                    </div>
                )}
            </div>
        </div>

        {/* Pledges Section */}
        <div style={{
            background: 'var(--text-white)',
            borderRadius: 'var(--radius-lg)',
            padding: '20px',
            boxShadow: 'var(--shadow-sm)'
        }}>
            <h3 style={{ 
                marginBottom: '20px', 
                color: 'var(--text-primary)',
                fontSize: '18px',
                fontWeight: '600'
            }}>
                Daily Pledges
            </h3>
            <div style={{ maxHeight: '400px', overflowY: 'auto' }}>
                {pledges && pledges.length > 0 ? (
                    pledges.map((pledge, index) => (
                        <div key={pledge.id} style={{
                            padding: '15px',
                            marginBottom: '10px',
                            background: index % 2 === 0 ? 'var(--background-secondary)' : '#f5f5f5',
                            borderRadius: 'var(--radius-sm)',
                            borderLeft: `4px solid ${pledge.completed ? 'var(--success-color)' : 'var(--warning-color)'}`
                        }}>
                            <div style={{ 
                                display: 'flex', 
                                justifyContent: 'space-between', 
                                alignItems: 'center',
                                marginBottom: '8px'
                            }}>
                                <span style={{ 
                                    fontSize: '12px', 
                                    color: 'var(--text-secondary)',
                                    fontWeight: '500'
                                }}>
                                    {formatDate(pledge.createdAt)}
                                </span>
                                {pledge.completed && (
                                    <span style={{ 
                                        color: 'var(--success-color)', 
                                        fontSize: '16px' 
                                    }}>✓</span>
                                )}
                            </div>
                            <p style={{ 
                                margin: 0, 
                                color: 'var(--text-primary)', 
                                fontSize: '14px',
                                lineHeight: '1.5'
                            }}>
                                {pledge.content || pledge.text || pledge.pledge}
                            </p>
                        </div>
                    ))
                ) : (
                    <div style={{ 
                        padding: '30px', 
                        textAlign: 'center', 
                        color: 'var(--text-secondary)',
                        fontSize: '14px'
                    }}>
                        No pledges recorded yet
                    </div>
                )}
            </div>
        </div>
    </div>
);

// ========== GOLDEN THREAD TAB - CSS VARIABLES + READABLE TEXT ==========
const renderGoldenThreadTab = () => {
    // Handler functions remain unchanged...
    const handleCreateGoldenThread = async (threadData) => {
        // ... same implementation
    };

    const handleAddGoal = async (goalData) => {
        // ... same implementation
    };

    const handleAddObjective = async (objectiveData) => {
        // ... same implementation
    };

    const handleAddAssignment = async (assignmentData) => {
        // ... same implementation
    };

    return (
        <div style={{ padding: '20px' }}>
            <div style={{ 
                display: 'flex', 
                justifyContent: 'space-between', 
                alignItems: 'center', 
                marginBottom: '20px' 
            }}>
                <h3 style={{ 
                    margin: 0, 
                    color: 'var(--text-primary)',
                    fontSize: '18px',
                    fontWeight: '600'
                }}>
                    Recovery Journey Structure
                </h3>
                <div style={{ display: 'flex', gap: '10px' }}>
                    <button
                        className="btn btn-primary"
                        onClick={() => setShowGoldenThread(true)}
                        style={{
                            background: 'var(--gradient-primary)',
                            border: 'none',
                            color: 'var(--text-white)',
                            padding: '10px 20px',
                            borderRadius: 'var(--radius-sm)',
                            cursor: 'pointer',
                            fontWeight: '500',
                            transition: 'var(--transition-fast)'
                        }}
                    >
                        + Golden Thread
                    </button>
                    <button
                        className="btn btn-secondary"
                        onClick={() => setShowAddGoal(true)}
                        style={{
                            background: 'var(--success-color)',
                            border: 'none',
                            color: 'var(--text-white)',
                            padding: '10px 20px',
                            borderRadius: 'var(--radius-sm)',
                            cursor: 'pointer',
                            fontWeight: '500',
                            transition: 'var(--transition-fast)'
                        }}
                    >
                        + Add Goal
                    </button>
                </div>
            </div>
            
            {/* Goals list */}
            {goals.length > 0 ? (
                goals.map(goal => (
                    <div key={goal.id} style={{
                        background: 'var(--text-white)',
                        borderRadius: 'var(--radius-lg)',
                        padding: '20px',
                        marginBottom: '20px',
                        boxShadow: 'var(--shadow-sm)',
                        borderLeft: `4px solid ${goal.status === 'completed' ? 'var(--success-color)' : 'var(--primary-color)'}`
                    }}>
                        <div 
                            style={{ 
                                display: 'flex', 
                                justifyContent: 'space-between', 
                                alignItems: 'center',
                                cursor: 'pointer'
                            }}
                            onClick={() => setExpandedGoals({...expandedGoals, [goal.id]: !expandedGoals[goal.id]})}
                        >
                            <div>
                                <h4 style={{ 
                                    margin: 0, 
                                    color: 'var(--text-primary)',
                                    fontSize: '16px',
                                    fontWeight: '600'
                                }}>
                                    {expandedGoals[goal.id] ? '▼' : '▶'} {goal.title}
                                </h4>
                                <p style={{ 
                                    margin: '5px 0', 
                                    color: 'var(--text-secondary)',
                                    fontSize: '14px'
                                }}>
                                    {goal.description}
                                </p>
                            </div>
                            <div style={{
                                background: `conic-gradient(var(--success-color) 0% ${goal.progress || 0}%, var(--border-color) ${goal.progress || 0}% 100%)`,
                                width: '60px',
                                height: '60px',
                                borderRadius: '50%',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center'
                            }}>
                                <div style={{
                                    background: 'var(--text-white)',
                                    width: '50px',
                                    height: '50px',
                                    borderRadius: '50%',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    fontWeight: 'bold',
                                    color: 'var(--text-primary)',
                                    fontSize: '14px'
                                }}>
                                    {goal.progress || 0}%
                                </div>
                            </div>
                        </div>
                        
                        {expandedGoals[goal.id] && (
                            <div style={{ marginTop: '20px' }}>
                                <div style={{ display: 'flex', gap: '10px', marginBottom: '15px' }}>
                                    <button 
                                        className="btn btn-secondary"
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            setSelectedGoalForObjective(goal);
                                            setShowAddObjective(true);
                                        }}
                                        style={{
                                            background: 'var(--primary-color)',
                                            border: 'none',
                                            color: 'var(--text-white)',
                                            padding: '8px 16px',
                                            borderRadius: 'var(--radius-sm)',
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            fontWeight: '500'
                                        }}
                                    >
                                        + Add Objective
                                    </button>
                                </div>
                                
                                {/* Objectives */}
                                <div style={{ marginBottom: '15px' }}>
                                    <h5 style={{ 
                                        color: 'var(--text-secondary)', 
                                        marginBottom: '10px',
                                        fontSize: '14px',
                                        fontWeight: '600'
                                    }}>
                                        Objectives
                                    </h5>
                                    {objectives.filter(o => o.goalId === goal.id).map(objective => (
                                        <div key={objective.id} style={{
                                            background: 'var(--background-secondary)',
                                            padding: '10px',
                                            borderRadius: 'var(--radius-sm)',
                                            marginBottom: '10px',
                                            borderLeft: `3px solid ${objective.status === 'completed' ? 'var(--success-color)' : 'var(--warning-color)'}`
                                        }}>
                                            <div style={{ 
                                                display: 'flex', 
                                                justifyContent: 'space-between', 
                                                alignItems: 'center' 
                                            }}>
                                                <strong style={{ 
                                                    color: 'var(--text-primary)',
                                                    fontSize: '14px',
                                                    fontWeight: '600'
                                                }}>
                                                    #{objective.order} - {objective.title}
                                                </strong>
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        setSelectedObjectiveForAssignment(objective);
                                                        setShowAddAssignment(true);
                                                    }}
                                                    style={{
                                                        background: 'var(--secondary-color)',
                                                        border: 'none',
                                                        color: 'var(--text-white)',
                                                        padding: '4px 12px',
                                                        borderRadius: 'var(--radius-sm)',
                                                        cursor: 'pointer',
                                                        fontSize: '12px',
                                                        fontWeight: '500'
                                                    }}
                                                >
                                                    + Assignment
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                
                                {/* Assignments */}
                                <div>
                                    <h5 style={{ 
                                        color: 'var(--text-secondary)', 
                                        marginBottom: '10px',
                                        fontSize: '14px',
                                        fontWeight: '600'
                                    }}>
                                        Assignments
                                    </h5>
                                    {assignments.filter(a => a.goalId === goal.id).map(assignment => (
                                        <div key={assignment.id} style={{
                                            background: '#f5f5f5',
                                            padding: '10px',
                                            borderRadius: 'var(--radius-sm)',
                                            marginBottom: '10px',
                                            borderLeft: `3px solid ${assignment.status === 'completed' ? 'var(--success-color)' : 'var(--primary-color)'}`
                                        }}>
                                            <strong style={{ 
                                                color: 'var(--text-primary)',
                                                fontSize: '14px',
                                                fontWeight: '600'
                                            }}>
                                                {assignment.title}
                                            </strong>
                                            <div style={{ 
                                                fontSize: '13px', 
                                                color: 'var(--text-secondary)',
                                                marginTop: '4px'
                                            }}>
                                                {assignment.description}
                                            </div>
                                            <div style={{ 
                                                fontSize: '12px', 
                                                color: 'var(--text-muted)', 
                                                marginTop: '5px' 
                                            }}>
                                                Due: {formatDate(assignment.dueDate)} • Status: {assignment.status}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                ))
            ) : (
                <div style={{
                    background: 'var(--text-white)',
                    borderRadius: 'var(--radius-lg)',
                    padding: '40px',
                    textAlign: 'center',
                    color: 'var(--text-secondary)',
                    boxShadow: 'var(--shadow-sm)'
                }}>
                    <p style={{ fontSize: '15px', margin: '0 0 10px 0' }}>
                        No goals configured yet
                    </p>
                    <p style={{ fontSize: '14px', margin: 0 }}>
                        Click "Golden Thread" or "Add Goal" to get started
                    </p>
                </div>
            )}

            {/* Modals remain the same */}
            {showGoldenThread && (
                <CreateGoalModal
                    type="goldenThread"
                    selectedPIR={{ id: pirId, displayName: pirData?.displayName, email: pirData?.email }}
                    selectedParent={null}
                    currentUser={user}
                    onSubmit={handleCreateGoldenThread}
                    onClose={() => setShowGoldenThread(false)}
                />
            )}

            {showAddGoal && (
                <CreateGoalModal
                    type="goal"
                    selectedPIR={{ id: pirId }}
                    selectedParent={null}
                    currentUser={user}
                    onSubmit={handleAddGoal}
                    onClose={() => setShowAddGoal(false)}
                />
            )}

            {showAddObjective && (
                <CreateGoalModal
                    type="objective"
                    selectedPIR={{ id: pirId }}
                    selectedParent={selectedGoalForObjective}
                    currentUser={user}
                    onSubmit={handleAddObjective}
                    onClose={() => {
                        setShowAddObjective(false);
                        setSelectedGoalForObjective(null);
                    }}
                />
            )}

            {showAddAssignment && (
                <CreateGoalModal
                    type="assignment"
                    selectedPIR={{ id: pirId }}
                    selectedParent={selectedObjectiveForAssignment}
                    currentUser={user}
                    onSubmit={handleAddAssignment}
                    onClose={() => {
                        setShowAddAssignment(false);
                        setSelectedObjectiveForAssignment(null);
                    }}
                />
            )}
        </div>
    );
};

  const renderMilestonesTab = () => {
    // Calculate milestones based on sobriety date using same logic as getRecoveryMilestones
    const calculateMilestones = () => {
        if (!pirData?.sobrietyDate) return [];
        
        // Parse sobriety date in LOCAL timezone (Pacific) - SAME AS getRecoveryMilestones
        let startYear, startMonth, startDay;
        
        if (typeof pirData.sobrietyDate === 'string' && pirData.sobrietyDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
            [startYear, startMonth, startDay] = pirData.sobrietyDate.split('-').map(Number);
        } else if (pirData.sobrietyDate.toDate) {
            const d = pirData.sobrietyDate.toDate();
            startYear = d.getFullYear();
            startMonth = d.getMonth() + 1;
            startDay = d.getDate();
        } else if (pirData.sobrietyDate.seconds) {
            const d = new Date(pirData.sobrietyDate.seconds * 1000);
            startYear = d.getFullYear();
            startMonth = d.getMonth() + 1;
            startDay = d.getDate();
        } else {
            const d = new Date(pirData.sobrietyDate);
            startYear = d.getFullYear();
            startMonth = d.getMonth() + 1;
            startDay = d.getDate();
        }
        
        const startDate = new Date(startYear, startMonth - 1, startDay, 0, 0, 0, 0);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const allMilestones = [];
        
        // DAY-BASED MILESTONES (count exact days)
        const dayBased = [
            { days: 1, title: '24 Hours Clean', icon: '🌟', description: 'The first day - the hardest step' },
            { days: 7, title: '1 Week Clean', icon: '📅', description: 'A full week of sobriety' },
            { days: 30, title: '1 Month Clean', icon: '🏆', description: 'First major milestone' },
            { days: 60, title: '2 Months Clean', icon: '💪', description: 'Establishing new habits' },
            { days: 90, title: '3 Months Clean', icon: '🎯', description: 'Quarter year achieved' },
            { days: 100, title: '100 Days Clean', icon: '💯', description: 'Triple digits!' },
            { days: 200, title: '200 Days Clean', icon: '✨', description: 'Incredible progress' },
            { days: 500, title: '500 Days Clean', icon: '🏆', description: 'Over a year of dedication' },
            { days: 1000, title: '1000 Days Clean', icon: '🏅', description: 'A thousand days strong' }
        ];
        
        dayBased.forEach(milestone => {
            const targetDate = new Date(startDate);
            targetDate.setDate(targetDate.getDate() + milestone.days - 1);
            const achieved = today >= targetDate;
            const daysUntil = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
            
            allMilestones.push({
                ...milestone,
                targetDate,
                achieved,
                daysUntil: achieved ? 0 : daysUntil,
                achievedDate: achieved ? targetDate : null,
                id: `day-${milestone.days}`
            });
        });
        
        // MONTHLY MILESTONES (same day of month)
        const monthBased = [
            { months: 4, title: '4 Months Clean', icon: '⭐', description: 'Solid foundation built' },
            { months: 5, title: '5 Months Clean', icon: '🌈', description: 'Five months of growth' },
            { months: 6, title: '6 Months Clean', icon: '🎉', description: 'Half year milestone' },
            { months: 7, title: '7 Months Clean', icon: '🌟', description: 'Seven months strong' },
            { months: 8, title: '8 Months Clean', icon: '🏅', description: 'Eight months of progress' },
            { months: 9, title: '9 Months Clean', icon: '💎', description: 'Nine months of recovery' },
            { months: 10, title: '10 Months Clean', icon: '🌺', description: 'Ten months achieved' },
            { months: 11, title: '11 Months Clean', icon: '🎊', description: 'Almost a year!' },
            { months: 12, title: '1 Year Clean', icon: '🎂', description: 'Full year of recovery' },
            { months: 18, title: '18 Months Clean', icon: '🌟', description: 'A year and a half strong' }
        ];
        
        monthBased.forEach(milestone => {
            const targetDate = new Date(startYear, (startMonth - 1) + milestone.months, startDay, 0, 0, 0, 0);
            const achieved = today >= targetDate;
            const daysUntil = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
            
            allMilestones.push({
                days: Math.floor((targetDate - startDate) / (1000 * 60 * 60 * 24)) + 2,
                title: milestone.title,
                icon: milestone.icon,
                description: milestone.description,
                targetDate,
                achieved,
                daysUntil: achieved ? 0 : daysUntil,
                achievedDate: achieved ? targetDate : null,
                id: `month-${milestone.months}`
            });
        });
        
        // YEARLY MILESTONES (same month & day every year)
        const yearBased = [
            { years: 2, title: '2 Years Clean', icon: '🎈', description: 'Two years of sobriety' },
            { years: 3, title: '3 Years Clean', icon: '🎉', description: 'Three years of growth' },
            { years: 4, title: '4 Years Clean', icon: '🌟', description: 'Four years strong' },
            { years: 5, title: '5 Years Clean', icon: '💫', description: 'Half a decade of recovery' },
            { years: 6, title: '6 Years Clean', icon: '🌟', description: 'Six years of dedication' },
            { years: 7, title: '7 Years Clean', icon: '🌟', description: 'Seven years achieved' },
            { years: 8, title: '8 Years Clean', icon: '🌟', description: 'Eight years of sobriety' },
            { years: 9, title: '9 Years Clean', icon: '🌟', description: 'Nine years strong' },
            { years: 10, title: '10 Years Clean', icon: '💎', description: 'A decade of sobriety' }
        ];
        
        // Add 11-20 years dynamically
        for (let year = 11; year <= 20; year++) {
            yearBased.push({
                years: year,
                title: `${year} Years Clean`,
                icon: '🌟',
                description: `${year} years of recovery`
            });
        }
        
        yearBased.forEach(milestone => {
            const targetDate = new Date(startYear + milestone.years, startMonth - 1, startDay, 0, 0, 0, 0);
            const achieved = today >= targetDate;
            const daysUntil = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
            
            allMilestones.push({
                days: Math.floor((targetDate - startDate) / (1000 * 60 * 60 * 24)) + 2,
                title: milestone.title,
                icon: milestone.icon,
                description: milestone.description,
                targetDate,
                achieved,
                daysUntil: achieved ? 0 : daysUntil,
                achievedDate: achieved ? targetDate : null,
                id: `year-${milestone.years}`
            });
        });
        
        // Sort by target date
        allMilestones.sort((a, b) => a.targetDate - b.targetDate);
        
        return allMilestones;
    };
    
    const allMilestones = calculateMilestones();
    const achievedMilestones = allMilestones.filter(m => m.achieved);
    const upcomingMilestones = allMilestones.filter(m => !m.achieved).slice(0, 6);
    
    return (
        <div style={{ padding: '20px' }}>
            <h3 style={{ 
                marginBottom: '30px', 
                color: 'var(--text-primary)',
                fontSize: '18px',
                fontWeight: '600'
            }}>
                Recovery Milestones
            </h3>
            
            {/* Summary Stats */}
            <div style={{
                background: 'var(--gradient-primary)',
                borderRadius: 'var(--radius-lg)',
                padding: '25px',
                marginBottom: '30px',
                color: 'var(--text-white)',
                textAlign: 'center',
                boxShadow: 'var(--shadow-primary)'
            }}>
                <div style={{ fontSize: '48px', fontWeight: 'bold', marginBottom: '10px' }}>
                    {achievedMilestones.length}
                </div>
                <div style={{ fontSize: '18px', opacity: 0.9 }}>
                    Milestones Achieved
                </div>
                <div style={{ fontSize: '14px', opacity: 0.8, marginTop: '10px' }}>
                    {pirData?.sobrietyDays || 0} days of continuous sobriety
                </div>
            </div>
            
            {/* Achieved Milestones Section */}
            {achievedMilestones.length > 0 && (
                <>
                    <h4 style={{ 
                        marginBottom: '20px', 
                        color: 'var(--text-primary)',
                        fontSize: '16px',
                        fontWeight: '600'
                    }}>
                        Achieved Milestones 🎉
                    </h4>
                    <div style={{ 
                        display: 'grid', 
                        gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
                        gap: '20px',
                        marginBottom: '40px'
                    }}>
                        {achievedMilestones.map((milestone, index) => (
                            <div key={milestone.id || index} style={{
                                background: 'var(--gradient-success)',
                                borderRadius: 'var(--radius-lg)',
                                padding: '20px',
                                boxShadow: 'var(--shadow-md)',
                                position: 'relative',
                                overflow: 'hidden',
                                transform: 'scale(1)',
                                transition: 'var(--transition-fast)',
                                cursor: 'pointer'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.05)'}
                            onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}>
                                <div style={{
                                    position: 'absolute',
                                    top: '10px',
                                    right: '10px',
                                    fontSize: '24px',
                                    color: 'rgba(255,255,255,0.9)'
                                }}>
                                    ✓
                                </div>
                                <div style={{
                                    fontSize: '36px',
                                    marginBottom: '10px',
                                    textAlign: 'center'
                                }}>
                                    {milestone.icon}
                                </div>
                                <h5 style={{
                                    margin: '0 0 10px 0',
                                    color: 'var(--text-white)',
                                    textAlign: 'center',
                                    fontSize: '16px',
                                    fontWeight: 'bold'
                                }}>
                                    {milestone.title}
                                </h5>
                                <p style={{
                                    fontSize: '12px',
                                    color: 'rgba(255,255,255,0.9)',
                                    textAlign: 'center',
                                    margin: '0 0 10px 0'
                                }}>
                                    {milestone.description}
                                </p>
                                <div style={{
                                    fontSize: '11px',
                                    color: 'rgba(255,255,255,0.8)',
                                    textAlign: 'center',
                                    fontWeight: 'bold'
                                }}>
                                    Achieved on {formatDate(milestone.achievedDate)}
                                </div>
                            </div>
                        ))}
                    </div>
                </>
            )}
            
            {/* Upcoming Milestones Section */}
            {upcomingMilestones.length > 0 && (
                <>
                    <h4 style={{ 
                        marginBottom: '20px', 
                        color: 'var(--text-primary)',
                        fontSize: '16px',
                        fontWeight: '600'
                    }}>
                        Upcoming Milestones 🎯
                    </h4>
                    <div style={{ 
                        display: 'grid', 
                        gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
                        gap: '20px' 
                    }}>
                        {upcomingMilestones.map((milestone, index) => (
                            <div key={milestone.id || index} style={{
                                background: 'var(--text-white)',
                                borderRadius: 'var(--radius-lg)',
                                padding: '20px',
                                boxShadow: 'var(--shadow-sm)',
                                border: '2px solid var(--border-color)',
                                position: 'relative',
                                overflow: 'hidden',
                                transform: 'scale(1)',
                                transition: 'var(--transition-fast)',
                                cursor: 'pointer'
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.transform = 'scale(1.05)';
                                e.currentTarget.style.borderColor = 'var(--primary-color)';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.transform = 'scale(1)';
                                e.currentTarget.style.borderColor = 'var(--border-color)';
                            }}>
                                {milestone.daysUntil <= 7 && (
                                    <div style={{
                                        position: 'absolute',
                                        top: '10px',
                                        right: '10px',
                                        background: 'var(--warning-color)',
                                        color: 'var(--text-white)',
                                        padding: '2px 8px',
                                        borderRadius: '12px',
                                        fontSize: '10px',
                                        fontWeight: 'bold'
                                    }}>
                                        SOON!
                                    </div>
                                )}
                                <div style={{
                                    fontSize: '36px',
                                    marginBottom: '10px',
                                    textAlign: 'center',
                                    opacity: 0.7
                                }}>
                                    {milestone.icon}
                                </div>
                                <h5 style={{
                                    margin: '0 0 10px 0',
                                    color: 'var(--text-primary)',
                                    textAlign: 'center',
                                    fontSize: '16px',
                                    fontWeight: 'bold'
                                }}>
                                    {milestone.title}
                                </h5>
                                <p style={{
                                    fontSize: '12px',
                                    color: 'var(--text-secondary)',
                                    textAlign: 'center',
                                    margin: '0 0 15px 0'
                                }}>
                                    {milestone.description}
                                </p>
                                <div style={{
                                    background: 'var(--background-secondary)',
                                    borderRadius: '20px',
                                    padding: '8px',
                                    textAlign: 'center'
                                }}>
                                    <div style={{
                                        fontSize: '20px',
                                        fontWeight: 'bold',
                                        color: milestone.daysUntil <= 7 ? 'var(--warning-color)' : 'var(--primary-color)'
                                    }}>
                                        {milestone.daysUntil}
                                    </div>
                                    <div style={{
                                        fontSize: '11px',
                                        color: 'var(--text-muted)',
                                        textTransform: 'uppercase'
                                    }}>
                                        days to go
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </>
            )}
            
            {allMilestones.length === 0 && (
                <div style={{
                    background: 'var(--text-white)',
                    borderRadius: 'var(--radius-lg)',
                    padding: '40px',
                    textAlign: 'center',
                    color: 'var(--text-secondary)',
                    boxShadow: 'var(--shadow-sm)'
                }}>
                    <p style={{ fontSize: '15px', margin: '0 0 10px 0' }}>
                        No milestones configured yet
                    </p>
                    <p style={{ fontSize: '14px', margin: 0 }}>
                        Milestones will appear once a sobriety date is set
                    </p>
                </div>
            )}
        </div>
    );
};

// Fixed renderCommunicationsTab
const renderCommunicationsTab = () => {
    const handleDeleteMessage = async (messageId, messageType) => {
        if (!confirm('Are you sure you want to delete this message?')) return;
        
        try {
            let collection = 'messages';
            if (messageType === 'community') collection = 'glrsChat';
            if (messageType === 'topic') collection = 'topicRoomMessages';
            
            await db.collection(collection).doc(messageId).delete();
            
            await db.collection('flaggedContent').add({
                originalCollection: collection,
                originalId: messageId,
                userId: pirId,
                flaggedBy: user.uid,
                reason: 'Deleted by coach',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await loadAllUserMessages();
            alert('Message deleted and flagged');
        } catch (error) {
            console.error('Error deleting message:', error);
            alert('Failed to delete message');
        }
    };
    
    return (
        <div style={{ padding: '20px' }}>
            <h3 style={{ 
                marginBottom: '20px', 
                color: 'var(--text-primary)',
                fontSize: '18px',
                fontWeight: '600'
            }}>
                Communication Activity
            </h3>
            
            {/* Message Stats */}
            <div style={{
                background: 'var(--text-white)',
                borderRadius: 'var(--radius-lg)',
                padding: '20px',
                marginBottom: '20px',
                boxShadow: 'var(--shadow-sm)'
            }}>
                <h4 style={{ 
                    marginBottom: '15px', 
                    color: 'var(--text-primary)',
                    fontSize: '16px',
                    fontWeight: '600'
                }}>
                    Engagement Metrics
                </h4>
                <div style={{ 
                    display: 'grid', 
                    gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', 
                    gap: '20px' 
                }}>
                    <div style={{ textAlign: 'center' }}>
                        <div style={{ 
                            fontSize: '36px', 
                            fontWeight: 'bold', 
                            color: 'var(--info-color)' 
                        }}>
                            {allMessages.length}
                        </div>
                        <div style={{ 
                            color: 'var(--text-secondary)',
                            fontSize: '14px'
                        }}>
                            Total Messages
                        </div>
                    </div>
                    <div style={{ textAlign: 'center' }}>
                        <div style={{ 
                            fontSize: '36px', 
                            fontWeight: 'bold', 
                            color: 'var(--success-color)' 
                        }}>
                            {allMessages.filter(m => m.type === 'community').length}
                        </div>
                        <div style={{ 
                            color: 'var(--text-secondary)',
                            fontSize: '14px'
                        }}>
                            Community Posts
                        </div>
                    </div>
                    <div style={{ textAlign: 'center' }}>
                        <div style={{ 
                            fontSize: '36px', 
                            fontWeight: 'bold', 
                            color: 'var(--warning-color)' 
                        }}>
                            {allMessages.filter(m => m.type === 'topic').length}
                        </div>
                        <div style={{ 
                            color: 'var(--text-secondary)',
                            fontSize: '14px'
                        }}>
                            Topic Room Posts
                        </div>
                    </div>
                    <div style={{ textAlign: 'center' }}>
                        <div style={{ 
                            fontSize: '36px', 
                            fontWeight: 'bold', 
                            color: 'var(--secondary-color)' 
                        }}>
                            {allMessages.filter(m => m.type === 'direct').length}
                        </div>
                        <div style={{ 
                            color: 'var(--text-secondary)',
                            fontSize: '14px'
                        }}>
                            Direct Messages
                        </div>
                    </div>
                </div>
            </div>

            {/* All Messages with Moderation Controls */}
            <div style={{
                background: 'var(--text-white)',
                borderRadius: 'var(--radius-lg)',
                padding: '20px',
                boxShadow: 'var(--shadow-sm)'
            }}>
                <h4 style={{ 
                    marginBottom: '15px', 
                    color: 'var(--text-primary)',
                    fontSize: '16px',
                    fontWeight: '600'
                }}>
                    Message History
                </h4>
                {allMessages.length > 0 ? (
                    <div style={{ maxHeight: '600px', overflowY: 'auto' }}>
                        {allMessages.map(message => (
                            <div key={message.id} style={{
                                padding: '15px',
                                borderBottom: '1px solid var(--border-color)',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'start'
                            }}>
                                <div style={{ flex: 1 }}>
                                    <div style={{ display: 'flex', gap: '10px', marginBottom: '5px' }}>
                                        <span style={{
                                            background: message.type === 'community' ? 'var(--success-color)' :
                                                       message.type === 'topic' ? 'var(--warning-color)' : 
                                                       'var(--info-color)',
                                            color: 'var(--text-white)',
                                            padding: '2px 8px',
                                            borderRadius: '12px',
                                            fontSize: '10px',
                                            fontWeight: 'bold'
                                        }}>
                                            {message.type.toUpperCase()}
                                        </span>
                                        {message.roomId && (
                                            <span style={{ 
                                                fontSize: '12px', 
                                                color: 'var(--text-muted)' 
                                            }}>
                                                Room: {message.roomId}
                                            </span>
                                        )}
                                        <span style={{ 
                                            fontSize: '12px', 
                                            color: 'var(--text-muted)' 
                                        }}>
                                            {formatTimeAgo(message.createdAt)}
                                        </span>
                                    </div>
                                    <div style={{ color: 'var(--text-primary)', fontSize: '14px' }}>
                                        {message.content || message.text || message.message || 'No content'}
                                    </div>
                                    {message.imageUrl && (
                                        <div style={{ marginTop: '10px' }}>
                                            <img 
                                                src={message.imageUrl} 
                                                alt="Message attachment" 
                                                style={{ 
                                                    maxWidth: '200px', 
                                                    borderRadius: 'var(--radius-sm)' 
                                                }}
                                            />
                                        </div>
                                    )}
                                </div>
                                <div style={{ display: 'flex', gap: '10px' }}>
                                    <button
                                        onClick={() => handleDeleteMessage(message.id, message.type)}
                                        style={{
                                            background: 'var(--danger-color)',
                                            color: 'var(--text-white)',
                                            border: 'none',
                                            padding: '5px 10px',
                                            borderRadius: 'var(--radius-sm)',
                                            cursor: 'pointer',
                                            fontSize: '12px',
                                            fontWeight: '500',
                                            transition: 'var(--transition-fast)'
                                        }}
                                    >
                                        Delete
                                    </button>
                                    <button
                                        onClick={async () => {
                                            try {
                                                await db.collection('flaggedContent').add({
                                                    messageId: message.id,
                                                    messageType: message.type,
                                                    userId: pirId,
                                                    flaggedBy: user.uid,
                                                    reason: 'Flagged for review',
                                                    content: message.content || message.text,
                                                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                                });
                                                alert('Message flagged for review');
                                            } catch (error) {
                                                console.error('Error flagging message:', error);
                                                alert('Failed to flag message');
                                            }
                                        }}
                                        style={{
                                            background: 'var(--warning-color)',
                                            color: 'var(--text-white)',
                                            border: 'none',
                                            padding: '5px 10px',
                                            borderRadius: 'var(--radius-sm)',
                                            cursor: 'pointer',
                                            fontSize: '12px',
                                            fontWeight: '500',
                                            transition: 'var(--transition-fast)'
                                        }}
                                    >
                                        Flag
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                ) : (
                    <p style={{ 
                        color: 'var(--text-secondary)', 
                        padding: '20px', 
                        textAlign: 'center',
                        fontSize: '14px'
                    }}>
                        No messages sent yet
                    </p>
                )}
            </div>
        </div>
    );
};

const renderResourcesTab = () => (
    <div style={{ padding: '20px' }}>
        <div style={{ 
            display: 'flex', 
            justifyContent: 'space-between', 
            alignItems: 'center', 
            marginBottom: '20px' 
        }}>
            <h3 style={{ 
                margin: 0, 
                color: 'var(--text-primary)',
                fontSize: '18px',
                fontWeight: '600'
            }}>
                Resource Management
            </h3>
            <div style={{ display: 'flex', gap: '10px' }}>
                <button
                    className="btn btn-primary"
                    onClick={() => setShowAssignResource(true)}
                    style={{
                        background: 'var(--gradient-success)',
                        border: 'none',
                        color: 'var(--text-white)',
                        padding: '10px 20px',
                        borderRadius: 'var(--radius-sm)',
                        cursor: 'pointer',
                        fontWeight: '500',
                        transition: 'var(--transition-fast)'
                    }}
                >
                    Assign Resource
                </button>
                <button
                    className="btn btn-primary"
                    onClick={() => setShowCreateResource(true)}
                    style={{
                        background: 'var(--gradient-secondary)',
                        border: 'none',
                        color: 'var(--text-white)',
                        padding: '10px 20px',
                        borderRadius: 'var(--radius-sm)',
                        cursor: 'pointer',
                        fontWeight: '500',
                        transition: 'var(--transition-fast)'
                    }}
                >
                    Create Resource
                </button>
            </div>
        </div>
        
        {['education', 'coping', 'daily', 'life', 'support', 'relapse'].map(category => {
            const categoryResources = resources.filter(r => r.category === category);
            if (categoryResources.length === 0) return null;
            
            return (
                <div key={category} style={{
                    background: 'var(--text-white)',
                    borderRadius: 'var(--radius-lg)',
                    padding: '20px',
                    marginBottom: '20px',
                    boxShadow: 'var(--shadow-sm)'
                }}>
                    <h4 style={{ 
                        marginBottom: '15px', 
                        color: 'var(--text-primary)', 
                        textTransform: 'capitalize',
                        fontSize: '16px',
                        fontWeight: '600'
                    }}>
                        {category} Resources ({categoryResources.length})
                    </h4>
                    <div style={{ display: 'grid', gap: '10px' }}>
                        {categoryResources.map(resource => (
                            <div key={resource.id} style={{
                                padding: '15px',
                                background: 'var(--background-secondary)',
                                borderRadius: 'var(--radius-md)',
                                borderLeft: `3px solid ${
                                    resourceProgress[resource.id]?.status === 'completed' ? 'var(--success-color)' :
                                    resourceProgress[resource.id]?.status === 'in-progress' ? 'var(--warning-color)' :
                                    'var(--info-color)'
                                }`,
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center'
                            }}>
                                <div style={{ flex: 1 }}>
                                    <strong style={{ 
                                        color: 'var(--text-primary)',
                                        fontSize: '14px',
                                        fontWeight: '600'
                                    }}>
                                        {resource.title}
                                    </strong>
                                    <p style={{ 
                                        fontSize: '12px', 
                                        color: 'var(--text-secondary)', 
                                        margin: '5px 0' 
                                    }}>
                                        {resource.description}
                                    </p>
                                    {resource.url && (
                                        <a 
                                            href={resource.url} 
                                            target="_blank" 
                                            rel="noopener noreferrer"
                                            style={{
                                                fontSize: '11px',
                                                color: 'var(--primary-color)',
                                                textDecoration: 'none',
                                                fontWeight: '500'
                                            }}
                                        >
                                            View Resource →
                                        </a>
                                    )}
                                </div>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                    <span style={{
                                        background: resourceProgress[resource.id]?.status === 'completed' ? 'var(--success-color)' :
                                                   resourceProgress[resource.id]?.status === 'in-progress' ? 'var(--warning-color)' :
                                                   'var(--border-color)',
                                        color: 'var(--text-white)',
                                        padding: '4px 8px',
                                        borderRadius: '12px',
                                        fontSize: '10px',
                                        fontWeight: 'bold'
                                    }}>
                                        {resourceProgress[resource.id]?.status || 'Not Started'}
                                    </span>
                                    <button
                                        onClick={async () => {
                                            if (confirm('Are you sure you want to unassign this resource?')) {
                                                try {
                                                    await db.collection('resources').doc(resource.id).update({
                                                        assignedTo: firebase.firestore.FieldValue.arrayRemove(pirId)
                                                    });
                                                    await loadResourcesData();
                                                    alert('Resource unassigned successfully');
                                                } catch (error) {
                                                    console.error('Error unassigning resource:', error);
                                                    alert('Failed to unassign resource');
                                                }
                                            }
                                        }}
                                        style={{
                                            background: 'var(--danger-color)',
                                            color: 'var(--text-white)',
                                            border: 'none',
                                            padding: '4px 8px',
                                            borderRadius: 'var(--radius-sm)',
                                            cursor: 'pointer',
                                            fontSize: '10px',
                                            fontWeight: '600',
                                            transition: 'var(--transition-fast)'
                                        }}
                                    >
                                        Unassign
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        })}

        {/* Assign Resource Modal */}
        {showAssignResource && (
            <div style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0,0,0,0.5)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 10000
            }}>
                <div style={{
                    background: 'var(--text-white)',
                    padding: '30px',
                    borderRadius: 'var(--radius-lg)',
                    width: '600px',
                    maxWidth: '90%',
                    maxHeight: '80vh',
                    overflow: 'auto',
                    boxShadow: 'var(--shadow-lg)'
                }}>
                    <h3 style={{ 
                        marginBottom: '20px',
                        color: 'var(--text-primary)',
                        fontSize: '18px',
                        fontWeight: '600'
                    }}>
                        Assign Resource to {pirData?.firstName || 'PIR'}
                    </h3>
                    
                    <div style={{ marginBottom: '20px' }}>
                        <label style={{ 
                            display: 'block', 
                            marginBottom: '10px', 
                            color: 'var(--text-secondary)',
                            fontSize: '14px',
                            fontWeight: '500'
                        }}>
                            Select Resource to Assign:
                        </label>
                        <select 
                            id="resource-select"
                            style={{
                                width: '100%',
                                padding: '10px',
                                borderRadius: 'var(--radius-sm)',
                                border: '1px solid var(--border-color)',
                                fontSize: '14px',
                                color: 'var(--text-primary)'
                            }}
                        >
                            <option value="">Choose a resource...</option>
                            {resources.filter(r => !r.assignedTo?.includes(pirId)).map(resource => (
                                <option key={resource.id} value={resource.id}>
                                    {resource.title} ({resource.category})
                                </option>
                            ))}
                        </select>
                    </div>
                    
                    <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                        <button
                            onClick={() => setShowAssignResource(false)}
                            style={{
                                padding: '10px 20px',
                                borderRadius: 'var(--radius-sm)',
                                border: '1px solid var(--border-color)',
                                background: 'var(--text-white)',
                                color: 'var(--text-primary)',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '500',
                                transition: 'var(--transition-fast)'
                            }}
                        >
                            Cancel
                        </button>
                        <button
                            onClick={async () => {
                                const select = document.getElementById('resource-select');
                                const resourceId = select.value;
                                if (resourceId) {
                                    try {
                                        await db.collection('resources').doc(resourceId).update({
                                            assignedTo: firebase.firestore.FieldValue.arrayUnion(pirId)
                                        });
                                        await loadResourcesData();
                                        setShowAssignResource(false);
                                        alert('Resource assigned successfully');
                                    } catch (error) {
                                        console.error('Error assigning resource:', error);
                                        alert('Failed to assign resource');
                                    }
                                } else {
                                    alert('Please select a resource');
                                }
                            }}
                            style={{
                                padding: '10px 20px',
                                borderRadius: 'var(--radius-sm)',
                                border: 'none',
                                background: 'var(--gradient-success)',
                                color: 'var(--text-white)',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '500',
                                transition: 'var(--transition-fast)'
                            }}
                        >
                            Assign Resource
                        </button>
                    </div>
                </div>
            </div>
        )}

        {/* Create Resource Modal */}
        {showCreateResource && (
            <div style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0,0,0,0.5)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 10000
            }}>
                <div style={{
                    background: 'var(--text-white)',
                    padding: '30px',
                    borderRadius: 'var(--radius-lg)',
                    width: '600px',
                    maxWidth: '90%',
                    boxShadow: 'var(--shadow-lg)'
                }}>
                    <h3 style={{ 
                        marginBottom: '20px',
                        color: 'var(--text-primary)',
                        fontSize: '18px',
                        fontWeight: '600'
                    }}>
                        Create New Resource
                    </h3>
                    
                    <form onSubmit={async (e) => {
                        e.preventDefault();
                        const form = e.target;
                        try {
                            await db.collection('resources').add({
                                title: form.title.value,
                                description: form.description.value,
                                category: form.category.value,
                                url: form.url.value || null,
                                assignedTo: [pirId],
                                createdBy: user.uid,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            await loadResourcesData();
                            setShowCreateResource(false);
                            alert('Resource created and assigned successfully');
                        } catch (error) {
                            console.error('Error creating resource:', error);
                            alert('Failed to create resource');
                        }
                    }}>
                        <div style={{ marginBottom: '15px' }}>
                            <label style={{ 
                                display: 'block', 
                                marginBottom: '5px',
                                color: 'var(--text-secondary)',
                                fontSize: '14px',
                                fontWeight: '500'
                            }}>
                                Title *
                            </label>
                            <input
                                name="title"
                                type="text"
                                required
                                style={{
                                    width: '100%',
                                    padding: '8px',
                                    borderRadius: 'var(--radius-sm)',
                                    border: '1px solid var(--border-color)',
                                    fontSize: '14px',
                                    color: 'var(--text-primary)'
                                }}
                            />
                        </div>
                        
                        <div style={{ marginBottom: '15px' }}>
                            <label style={{ 
                                display: 'block', 
                                marginBottom: '5px',
                                color: 'var(--text-secondary)',
                                fontSize: '14px',
                                fontWeight: '500'
                            }}>
                                Description *
                            </label>
                            <textarea
                                name="description"
                                required
                                rows="3"
                                style={{
                                    width: '100%',
                                    padding: '8px',
                                    borderRadius: 'var(--radius-sm)',
                                    border: '1px solid var(--border-color)',
                                    fontSize: '14px',
                                    color: 'var(--text-primary)'
                                }}
                            />
                        </div>
                        
                        <div style={{ marginBottom: '15px' }}>
                            <label style={{ 
                                display: 'block', 
                                marginBottom: '5px',
                                color: 'var(--text-secondary)',
                                fontSize: '14px',
                                fontWeight: '500'
                            }}>
                                Category *
                            </label>
                            <select
                                name="category"
                                required
                                style={{
                                    width: '100%',
                                    padding: '8px',
                                    borderRadius: 'var(--radius-sm)',
                                    border: '1px solid var(--border-color)',
                                    fontSize: '14px',
                                    color: 'var(--text-primary)'
                                }}
                            >
                                <option value="">Select category...</option>
                                <option value="education">Education</option>
                                <option value="coping">Coping</option>
                                <option value="daily">Daily</option>
                                <option value="life">Life</option>
                                <option value="support">Support</option>
                                <option value="relapse">Relapse Prevention</option>
                            </select>
                        </div>
                        
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{ 
                                display: 'block', 
                                marginBottom: '5px',
                                color: 'var(--text-secondary)',
                                fontSize: '14px',
                                fontWeight: '500'
                            }}>
                                URL (optional)
                            </label>
                            <input
                                name="url"
                                type="url"
                                placeholder="https://..."
                                style={{
                                    width: '100%',
                                    padding: '8px',
                                    borderRadius: 'var(--radius-sm)',
                                    border: '1px solid var(--border-color)',
                                    fontSize: '14px',
                                    color: 'var(--text-primary)'
                                }}
                            />
                        </div>
                        
                        <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                            <button
                                type="button"
                                onClick={() => setShowCreateResource(false)}
                                style={{
                                    padding: '10px 20px',
                                    borderRadius: 'var(--radius-sm)',
                                    border: '1px solid var(--border-color)',
                                    background: 'var(--text-white)',
                                    color: 'var(--text-primary)',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500',
                                    transition: 'var(--transition-fast)'
                                }}
                            >
                                Cancel
                            </button>
                            <button
                                type="submit"
                                style={{
                                    padding: '10px 20px',
                                    borderRadius: 'var(--radius-sm)',
                                    border: 'none',
                                    background: 'var(--gradient-secondary)',
                                    color: 'var(--text-white)',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500',
                                    transition: 'var(--transition-fast)'
                                }}
                            >
                                Create Resource
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        )}
    </div>
);

const renderActivityTab = () => (
    <div style={{ padding: '20px' }}>
        <h3 style={{ 
            marginBottom: '20px', 
            color: 'var(--text-primary)',
            fontSize: '18px',
            fontWeight: '600'
        }}>
            Complete Activity Feed
        </h3>
        
        <div style={{
            background: 'var(--text-white)',
            borderRadius: 'var(--radius-lg)',
            padding: '20px',
            boxShadow: 'var(--shadow-sm)'
        }}>
            <div style={{ maxHeight: '600px', overflowY: 'auto' }}>
                {activities.length > 0 ? (
                    activities.map(activity => (
                        <div key={activity.id} style={{
                            padding: '15px',
                            borderBottom: '1px solid var(--border-color)',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '15px'
                        }}>
                            <div style={{
                                width: '40px',
                                height: '40px',
                                borderRadius: '50%',
                                background: getActivityColor(activity.type),
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '20px',
                                flexShrink: 0
                            }}>
                                {getActivityIcon(activity.type)}
                            </div>
                            <div style={{ flex: 1 }}>
                                <div style={{ 
                                    fontWeight: 'bold', 
                                    color: 'var(--text-primary)',
                                    fontSize: '14px'
                                }}>
                                    {activity.description || activity.type?.replace(/_/g, ' ').toUpperCase()}
                                </div>
                                <div style={{ 
                                    fontSize: '11px', 
                                    color: 'var(--text-muted)', 
                                    marginTop: '5px' 
                                }}>
                                    {formatTimeAgo(activity.createdAt)}
                                </div>
                            </div>
                        </div>
                    ))
                ) : (
                    <p style={{ 
                        color: 'var(--text-secondary)',
                        textAlign: 'center',
                        padding: '20px',
                        fontSize: '14px'
                    }}>
                        No activity recorded
                    </p>
                )}
            </div>
        </div>
    </div>
);

const renderFinancialTab = () => (
    <div style={{ padding: '20px' }}>
        <h3 style={{ 
            marginBottom: '20px', 
            color: 'var(--text-primary)',
            fontSize: '18px',
            fontWeight: '600'
        }}>
            Financial Impact
        </h3>
        
        <div style={{
            background: 'var(--gradient-primary)',
            borderRadius: 'var(--radius-lg)',
            padding: '30px',
            marginBottom: '20px',
            color: 'var(--text-white)',
            textAlign: 'center',
            boxShadow: 'var(--shadow-primary)'
        }}>
            <div style={{ fontSize: '48px', fontWeight: 'bold' }}>
                ${pirData?.moneySaved || 0}
            </div>
            <div style={{ fontSize: '18px', opacity: 0.9 }}>
                Total Saved in Recovery
            </div>
            <div style={{ fontSize: '14px', opacity: 0.8, marginTop: '10px' }}>
                Based on ${pirData?.dailyCost || 20}/day
            </div>
        </div>

        <div style={{ 
            display: 'grid', 
            gridTemplateColumns: '1fr 1fr', 
            gap: '20px' 
        }}>
            <div style={{
                background: 'var(--text-white)',
                borderRadius: 'var(--radius-lg)',
                padding: '20px',
                boxShadow: 'var(--shadow-sm)'
            }}>
                <h4 style={{ 
                    marginBottom: '15px', 
                    color: 'var(--text-primary)',
                    fontSize: '16px',
                    fontWeight: '600'
                }}>
                    Monthly Projection
                </h4>
                <div style={{ 
                    fontSize: '32px', 
                    fontWeight: 'bold', 
                    color: 'var(--success-color)' 
                }}>
                    ${(pirData?.dailyCost || 20) * 30}
                </div>
                <div style={{ 
                    fontSize: '12px', 
                    color: 'var(--text-secondary)' 
                }}>
                    Saved per month
                </div>
            </div>

            <div style={{
                background: 'var(--text-white)',
                borderRadius: 'var(--radius-lg)',
                padding: '20px',
                boxShadow: 'var(--shadow-sm)'
            }}>
                <h4 style={{ 
                    marginBottom: '15px', 
                    color: 'var(--text-primary)',
                    fontSize: '16px',
                    fontWeight: '600'
                }}>
                    Yearly Projection
                </h4>
                <div style={{ 
                    fontSize: '32px', 
                    fontWeight: 'bold', 
                    color: 'var(--info-color)' 
                }}>
                    ${(pirData?.dailyCost || 20) * 365}
                </div>
                <div style={{ 
                    fontSize: '12px', 
                    color: 'var(--text-secondary)' 
                }}>
                    Saved per year
                </div>
            </div>
        </div>
    </div>
);

const renderCommunityTab = () => (
    <div style={{ padding: '20px' }}>
        <h3 style={{ 
            marginBottom: '30px', 
            color: 'var(--text-primary)',
            fontSize: '18px',
            fontWeight: '600'
        }}>
            Community Engagement
        </h3>
        
        {/* Community Stats Overview */}
        <div style={{
            background: 'var(--gradient-primary)',
            borderRadius: 'var(--radius-lg)',
            padding: '20px',
            marginBottom: '30px',
            color: 'var(--text-white)',
            boxShadow: 'var(--shadow-primary)'
        }}>
            <div style={{ 
                display: 'grid', 
                gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', 
                gap: '20px' 
            }}>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '32px', fontWeight: 'bold' }}>
                        {meetings.filter(m => m.status === 'scheduled').length}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.9 }}>Upcoming Meetings</div>
                </div>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '32px', fontWeight: 'bold' }}>
                        {topicRooms.filter(room => 
                            room.members?.includes(pirId) || room.activeParticipants?.includes(pirId)
                        ).length}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.9 }}>Topic Rooms</div>
                </div>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '32px', fontWeight: 'bold' }}>
                        {supportGroups.filter(group => 
                            group.members?.includes(pirId) || group.participants?.includes(pirId)
                        ).length}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.9 }}>Support Groups</div>
                </div>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '32px', fontWeight: 'bold' }}>
                        {allMessages.filter(m => m.type === 'community').length}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.9 }}>Community Posts</div>
                </div>
            </div>
        </div>

        {/* Scheduled Meetings Section */}
        <div style={{
            background: 'var(--text-white)',
            borderRadius: 'var(--radius-lg)',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: 'var(--shadow-sm)'
        }}>
            <h4 style={{ 
                marginBottom: '20px', 
                color: 'var(--text-primary)',
                fontSize: '16px',
                fontWeight: '600'
            }}>
                📅 Scheduled Meetings
            </h4>
            {meetings && meetings.filter(m => 
                (m.pirId === pirId || m.pirIds?.includes(pirId) || m.isGlobal) && 
                m.status === 'scheduled'
            ).length > 0 ? (
                <div style={{ display: 'grid', gap: '15px' }}>
                    {meetings.filter(m => 
                        (m.pirId === pirId || m.pirIds?.includes(pirId) || m.isGlobal) && 
                        m.status === 'scheduled'
                    ).map(meeting => (
                        <div key={meeting.id} style={{
                            padding: '15px',
                            background: 'var(--background-secondary)',
                            borderRadius: 'var(--radius-md)',
                            borderLeft: '4px solid var(--info-color)'
                        }}>
                            <div style={{ 
                                display: 'flex', 
                                justifyContent: 'space-between', 
                                alignItems: 'center' 
                            }}>
                                <div>
                                    <h5 style={{ 
                                        margin: '0 0 10px 0', 
                                        color: 'var(--text-primary)',
                                        fontSize: '15px',
                                        fontWeight: '600'
                                    }}>
                                        {meeting.meetingTitle || meeting.title || 'Recovery Session'}
                                    </h5>
                                    <div style={{ 
                                        display: 'flex', 
                                        gap: '15px', 
                                        fontSize: '13px', 
                                        color: 'var(--text-secondary)' 
                                    }}>
                                        <span>📅 {formatDate(meeting.scheduledTime)}</span>
                                        <span>🕐 {new Date(meeting.scheduledTime?.toDate ? 
                                            meeting.scheduledTime.toDate() : 
                                            meeting.scheduledTime).toLocaleTimeString('en-US', {
                                                hour: 'numeric',
                                                minute: '2-digit',
                                                hour12: true
                                            })}</span>
                                        <span>📝 {meeting.type || 'Group Session'}</span>
                                    </div>
                                    {meeting.notes && (
                                        <p style={{ 
                                            margin: '10px 0 0 0', 
                                            fontSize: '12px', 
                                            color: 'var(--text-secondary)' 
                                        }}>
                                            {meeting.notes}
                                        </p>
                                    )}
                                </div>
                                <div style={{ 
                                    display: 'flex', 
                                    flexDirection: 'column', 
                                    gap: '5px' 
                                }}>
                                    {meeting.isGlobal && (
                                        <span style={{
                                            background: 'var(--success-color)',
                                            color: 'var(--text-white)',
                                            padding: '4px 8px',
                                            borderRadius: '12px',
                                            fontSize: '10px',
                                            textAlign: 'center',
                                            fontWeight: 'bold'
                                        }}>
                                            ALL PIRS
                                        </span>
                                    )}
                                    {meeting.meetingLink && (
                                        <a 
                                            href={meeting.meetingLink} 
                                            target="_blank" 
                                            rel="noopener noreferrer"
                                            style={{
                                                background: 'var(--info-color)',
                                                color: 'var(--text-white)',
                                                padding: '6px 12px',
                                                borderRadius: 'var(--radius-sm)',
                                                textDecoration: 'none',
                                                fontSize: '12px',
                                                textAlign: 'center',
                                                fontWeight: '500'
                                            }}
                                        >
                                            Join Meeting
                                        </a>
                                    )}
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            ) : (
                <p style={{ 
                    color: 'var(--text-secondary)', 
                    textAlign: 'center', 
                    padding: '20px',
                    fontSize: '14px'
                }}>
                    No upcoming meetings scheduled
                </p>
            )}
        </div>

        {/* Topic Rooms Section */}
        <div style={{
            background: 'var(--text-white)',
            borderRadius: 'var(--radius-lg)',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: 'var(--shadow-sm)'
        }}>
            <h4 style={{ 
                marginBottom: '20px', 
                color: 'var(--text-primary)',
                fontSize: '16px',
                fontWeight: '600'
            }}>
                💬 Topic Rooms
            </h4>
            {topicRooms && topicRooms.length > 0 ? (
                <div style={{ 
                    display: 'grid', 
                    gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', 
                    gap: '15px' 
                }}>
                    {topicRooms.map(room => {
                        const isMember = room.members?.includes(pirId) || 
                                        room.activeParticipants?.includes(pirId);
                        return (
                            <div key={room.id} style={{
                                padding: '15px',
                                background: isMember ? 'rgba(33, 150, 243, 0.1)' : 'var(--background-secondary)',
                                borderRadius: 'var(--radius-md)',
                                border: isMember ? '2px solid var(--info-color)' : '1px solid var(--border-color)',
                                position: 'relative'
                            }}>
                                {isMember && (
                                    <span style={{
                                        position: 'absolute',
                                        top: '10px',
                                        right: '10px',
                                        background: 'var(--success-color)',
                                        color: 'var(--text-white)',
                                        padding: '2px 6px',
                                        borderRadius: '10px',
                                        fontSize: '10px',
                                        fontWeight: 'bold'
                                    }}>
                                        MEMBER
                                    </span>
                                )}
                                <h5 style={{ 
                                    margin: '0 0 10px 0', 
                                    color: 'var(--text-primary)',
                                    fontSize: '15px',
                                    fontWeight: '600'
                                }}>
                                    {room.name}
                                </h5>
                                <p style={{ 
                                    fontSize: '12px', 
                                    color: 'var(--text-secondary)', 
                                    margin: '0 0 10px 0' 
                                }}>
                                    {room.description}
                                </p>
                                <div style={{ 
                                    fontSize: '11px', 
                                    color: 'var(--text-muted)' 
                                }}>
                                    👥 {room.members?.length || 0} members
                                    {room.lastActivity && (
                                        <span style={{ marginLeft: '10px' }}>
                                            Last active: {formatTimeAgo(room.lastActivity)}
                                        </span>
                                    )}
                                </div>
                            </div>
                        );
                    })}
                </div>
            ) : (
                <p style={{ 
                    color: 'var(--text-secondary)', 
                    textAlign: 'center', 
                    padding: '20px',
                    fontSize: '14px'
                }}>
                    No topic rooms available
                </p>
            )}
        </div>

        {/* Support Groups Section */}
        <div style={{
            background: 'var(--text-white)',
            borderRadius: 'var(--radius-lg)',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: 'var(--shadow-sm)'
        }}>
            <h4 style={{ 
                marginBottom: '20px', 
                color: 'var(--text-primary)',
                fontSize: '16px',
                fontWeight: '600'
            }}>
                🤝 Support Groups
            </h4>
            {supportGroups && supportGroups.length > 0 ? (
                <div style={{ display: 'grid', gap: '15px' }}>
                    {supportGroups.map(group => {
                        const isMember = group.members?.includes(pirId) || 
                                        group.participants?.includes(pirId);
                        return (
                            <div key={group.id} style={{
                                padding: '20px',
                                background: isMember ? 'rgba(156, 39, 176, 0.05)' : 'var(--background-secondary)',
                                borderRadius: 'var(--radius-md)',
                                borderLeft: `4px solid ${isMember ? 'var(--secondary-color)' : 'var(--border-color)'}`
                            }}>
                                <div style={{ 
                                    display: 'flex', 
                                    justifyContent: 'space-between', 
                                    alignItems: 'start' 
                                }}>
                                    <div style={{ flex: 1 }}>
                                        <h5 style={{ 
                                            margin: '0 0 10px 0', 
                                            color: 'var(--text-primary)',
                                            fontSize: '15px',
                                            fontWeight: '600'
                                        }}>
                                            {group.name}
                                        </h5>
                                        <p style={{ 
                                            fontSize: '13px', 
                                            color: 'var(--text-secondary)', 
                                            margin: '0 0 10px 0' 
                                        }}>
                                            {group.description}
                                        </p>
                                        {group.meetingSchedule && (
                                            <div style={{ 
                                                fontSize: '12px', 
                                                color: 'var(--text-secondary)' 
                                            }}>
                                                📅 Meets: {group.meetingSchedule}
                                            </div>
                                        )}
                                        <div style={{ 
                                            fontSize: '11px', 
                                            color: 'var(--text-muted)', 
                                            marginTop: '10px' 
                                        }}>
                                            👥 {group.members?.length || 0} members
                                            {group.facilitator && (
                                                <span style={{ marginLeft: '15px' }}>
                                                    Facilitated by: {group.facilitator}
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                    {isMember && (
                                        <span style={{
                                            background: 'var(--secondary-color)',
                                            color: 'var(--text-white)',
                                            padding: '4px 12px',
                                            borderRadius: '12px',
                                            fontSize: '11px',
                                            fontWeight: 'bold'
                                        }}>
                                            ENROLLED
                                        </span>
                                    )}
                                </div>
                            </div>
                        );
                    })}
                </div>
            ) : (
                <p style={{ 
                    color: 'var(--text-secondary)', 
                    textAlign: 'center', 
                    padding: '20px',
                    fontSize: '14px'
                }}>
                    No support groups available
                </p>
            )}
        </div>

        {/* Recent Community Activity */}
        <div style={{
            background: 'var(--text-white)',
            borderRadius: 'var(--radius-lg)',
            padding: '20px',
            boxShadow: 'var(--shadow-sm)'
        }}>
            <h4 style={{ 
                marginBottom: '20px', 
                color: 'var(--text-primary)',
                fontSize: '16px',
                fontWeight: '600'
            }}>
                🌐 Recent Community Activity
            </h4>
            {allMessages.filter(m => m.type === 'community' || m.type === 'topic').length > 0 ? (
                <div style={{ maxHeight: '300px', overflowY: 'auto' }}>
                    {allMessages
                        .filter(m => m.type === 'community' || m.type === 'topic')
                        .slice(0, 10)
                        .map(message => (
                        <div key={message.id} style={{
                            padding: '10px',
                            borderBottom: '1px solid var(--border-color)',
                            fontSize: '13px'
                        }}>
                            <div style={{ 
                                display: 'flex', 
                                gap: '10px', 
                                marginBottom: '5px' 
                            }}>
                                <span style={{
                                    background: message.type === 'community' ? 'var(--success-color)' : 'var(--warning-color)',
                                    color: 'var(--text-white)',
                                    padding: '2px 6px',
                                    borderRadius: '8px',
                                    fontSize: '10px',
                                    fontWeight: 'bold'
                                }}>
                                    {message.type === 'community' ? 'COMMUNITY' : 'TOPIC'}
                                </span>
                                <span style={{ 
                                    color: 'var(--text-muted)', 
                                    fontSize: '11px' 
                                }}>
                                    {formatTimeAgo(message.createdAt)}
                                </span>
                            </div>
                            <div style={{ color: 'var(--text-primary)' }}>
                                {message.content || message.text || 'Posted a message'}
                            </div>
                        </div>
                    ))}
                </div>
            ) : (
                <p style={{ 
                    color: 'var(--text-secondary)', 
                    textAlign: 'center', 
                    padding: '20px',
                    fontSize: '14px'
                }}>
                    No recent community activity
                </p>
            )}
        </div>
    </div>
);
    // ========== MAIN MODAL RENDER ==========
    if (loading) {
        return (
            <div style={{
                position: 'fixed',
                top: 0, left: 0, right: 0, bottom: 0,
                background: 'rgba(0,0,0,0.7)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 10000
            }}>
                <div style={{
                    background: 'var(--text-white)',
                    padding: '40px',
                    borderRadius: 'var(--radius-lg)',
                    textAlign: 'center'
                }}>
                    <div style={{ fontSize: '24px', marginBottom: '20px' }}>⏳</div>
                    <div style={{ color: 'var(--text-primary)' }}>Loading PIR data...</div>
                </div>
            </div>
        );
    }

    if (!pirData) return null;
   return (
    <div className="modal-overlay" style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        background: 'rgba(0, 0, 0, 0.5)',
        backdropFilter: 'blur(5px)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        zIndex: 1000,
        animation: 'fadeIn 0.3s ease-in-out'
    }}>
        <div className="modal-content" style={{
            maxWidth: '1200px',
            width: '95%',
            maxHeight: '90vh',
            background: 'var(--text-white)',
            borderRadius: 'var(--radius-xl)',
            boxShadow: 'var(--shadow-xl)',
            display: 'flex',
            flexDirection: 'column',
            overflow: 'hidden',
            animation: 'slideUp 0.3s ease-out'
        }}>
            {/* MODAL HEADER */}
            <div className="modal-header" style={{
                background: 'var(--gradient-primary)',
                padding: '25px 30px',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                borderBottom: '1px solid rgba(255,255,255,0.1)'
            }}>
                <h3 style={{
                    margin: 0,
                    color: 'var(--text-white)',
                    fontSize: '24px',
                    fontWeight: '600',
                    letterSpacing: '-0.5px'
                }}>
                    {pirData?.firstName} {pirData?.lastName} - PIR Details
                </h3>
                <button 
                    className="close-btn" 
                    onClick={onClose}
                    style={{
                        background: 'rgba(255,255,255,0.2)',
                        border: 'none',
                        color: 'var(--text-white)',
                        fontSize: '28px',
                        width: '40px',
                        height: '40px',
                        borderRadius: '50%',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        transition: 'var(--transition-fast)',
                        fontWeight: '300'
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.background = 'rgba(255,255,255,0.3)';
                        e.currentTarget.style.transform = 'rotate(90deg)';
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.background = 'rgba(255,255,255,0.2)';
                        e.currentTarget.style.transform = 'rotate(0deg)';
                    }}
                >
                    ×
                </button>
            </div>
            
            {loading ? (
                <div className="loading-container" style={{
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    justifyContent: 'center',
                    minHeight: '400px',
                    gap: '20px'
                }}>
                    <div className="loading-spinner" style={{
                        width: '60px',
                        height: '60px',
                        border: '4px solid var(--background-secondary)',
                        borderTop: '4px solid var(--primary-color)',
                        borderRadius: '50%',
                        animation: 'spin 1s linear infinite'
                    }}></div>
                    <p style={{
                        color: 'var(--text-secondary)',
                        fontSize: '16px',
                        margin: 0
                    }}>
                        Loading PIR data...
                    </p>
                </div>
            ) : (
                <>
{/* TAB NAVIGATION */}
<div className="tab-nav" style={{
    display: 'flex',
    gap: '8px',
    padding: '20px 25px 0 25px',
    background: 'var(--background-secondary)',
    borderBottom: '2px solid var(--border-color)',
    overflowX: 'auto',
    position: 'sticky',
    top: 0,
    zIndex: 10
}}>
    <button 
        className={`tab-btn ${activeTab === 'overview' ? 'active' : ''}`}
        onClick={() => setActiveTab('overview')}
        style={{
            padding: '12px 20px',
            border: 'none',
            background: activeTab === 'overview' ? 'var(--gradient-primary)' : 'transparent',
            color: activeTab === 'overview' ? 'var(--text-white)' : 'var(--text-secondary)',
            borderRadius: 'var(--radius-md) var(--radius-md) 0 0',
            cursor: 'pointer',
            fontSize: '14px',
            fontWeight: activeTab === 'overview' ? '600' : '500',
            transition: 'var(--transition-fast)',
            whiteSpace: 'nowrap',
            boxShadow: activeTab === 'overview' ? 'var(--shadow-sm)' : 'none'
        }}
        onMouseEnter={(e) => {
            if (activeTab !== 'overview') {
                e.currentTarget.style.background = 'var(--background-primary)';
                e.currentTarget.style.color = 'var(--text-primary)';
            }
        }}
        onMouseLeave={(e) => {
            if (activeTab !== 'overview') {
                e.currentTarget.style.background = 'transparent';
                e.currentTarget.style.color = 'var(--text-secondary)';
            }
        }}
    >
        📊 Overview
    </button>
    <button 
        className={`tab-btn ${activeTab === 'progress' ? 'active' : ''}`}
        onClick={() => setActiveTab('progress')}
        style={{
            padding: '12px 20px',
            border: 'none',
            background: activeTab === 'progress' ? 'var(--gradient-primary)' : 'transparent',
            color: activeTab === 'progress' ? 'var(--text-white)' : 'var(--text-secondary)',
            borderRadius: 'var(--radius-md) var(--radius-md) 0 0',
            cursor: 'pointer',
            fontSize: '14px',
            fontWeight: activeTab === 'progress' ? '600' : '500',
            transition: 'var(--transition-fast)',
            whiteSpace: 'nowrap',
            boxShadow: activeTab === 'progress' ? 'var(--shadow-sm)' : 'none'
        }}
        onMouseEnter={(e) => {
            if (activeTab !== 'progress') {
                e.currentTarget.style.background = 'var(--background-primary)';
                e.currentTarget.style.color = 'var(--text-primary)';
            }
        }}
        onMouseLeave={(e) => {
            if (activeTab !== 'progress') {
                e.currentTarget.style.background = 'transparent';
                e.currentTarget.style.color = 'var(--text-secondary)';
            }
        }}
    >
        📈 Progress
    </button>
    <button 
        className={`tab-btn ${activeTab === 'goldenthread' ? 'active' : ''}`}
        onClick={() => setActiveTab('goldenthread')}
        style={{
            padding: '12px 20px',
            border: 'none',
            background: activeTab === 'goldenthread' ? 'var(--gradient-primary)' : 'transparent',
            color: activeTab === 'goldenthread' ? 'var(--text-white)' : 'var(--text-secondary)',
            borderRadius: 'var(--radius-md) var(--radius-md) 0 0',
            cursor: 'pointer',
            fontSize: '14px',
            fontWeight: activeTab === 'goldenthread' ? '600' : '500',
            transition: 'var(--transition-fast)',
            whiteSpace: 'nowrap',
            boxShadow: activeTab === 'goldenthread' ? 'var(--shadow-sm)' : 'none'
        }}
        onMouseEnter={(e) => {
            if (activeTab !== 'goldenthread') {
                e.currentTarget.style.background = 'var(--background-primary)';
                e.currentTarget.style.color = 'var(--text-primary)';
            }
        }}
        onMouseLeave={(e) => {
            if (activeTab !== 'goldenthread') {
                e.currentTarget.style.background = 'transparent';
                e.currentTarget.style.color = 'var(--text-secondary)';
            }
        }}
    >
        🧵 Golden Thread
    </button>
    <button 
        className={`tab-btn ${activeTab === 'milestones' ? 'active' : ''}`}
        onClick={() => setActiveTab('milestones')}
        style={{
            padding: '12px 20px',
            border: 'none',
            background: activeTab === 'milestones' ? 'var(--gradient-primary)' : 'transparent',
            color: activeTab === 'milestones' ? 'var(--text-white)' : 'var(--text-secondary)',
            borderRadius: 'var(--radius-md) var(--radius-md) 0 0',
            cursor: 'pointer',
            fontSize: '14px',
            fontWeight: activeTab === 'milestones' ? '600' : '500',
            transition: 'var(--transition-fast)',
            whiteSpace: 'nowrap',
            boxShadow: activeTab === 'milestones' ? 'var(--shadow-sm)' : 'none'
        }}
        onMouseEnter={(e) => {
            if (activeTab !== 'milestones') {
                e.currentTarget.style.background = 'var(--background-primary)';
                e.currentTarget.style.color = 'var(--text-primary)';
            }
        }}
        onMouseLeave={(e) => {
            if (activeTab !== 'milestones') {
                e.currentTarget.style.background = 'transparent';
                e.currentTarget.style.color = 'var(--text-secondary)';
            }
        }}
    >
        🏆 Milestones
    </button>
    <button 
        className={`tab-btn ${activeTab === 'resources' ? 'active' : ''}`}
        onClick={() => setActiveTab('resources')}
        style={{
            padding: '12px 20px',
            border: 'none',
            background: activeTab === 'resources' ? 'var(--gradient-primary)' : 'transparent',
            color: activeTab === 'resources' ? 'var(--text-white)' : 'var(--text-secondary)',
            borderRadius: 'var(--radius-md) var(--radius-md) 0 0',
            cursor: 'pointer',
            fontSize: '14px',
            fontWeight: activeTab === 'resources' ? '600' : '500',
            transition: 'var(--transition-fast)',
            whiteSpace: 'nowrap',
            boxShadow: activeTab === 'resources' ? 'var(--shadow-sm)' : 'none'
        }}
        onMouseEnter={(e) => {
            if (activeTab !== 'resources') {
                e.currentTarget.style.background = 'var(--background-primary)';
                e.currentTarget.style.color = 'var(--text-primary)';
            }
        }}
        onMouseLeave={(e) => {
            if (activeTab !== 'resources') {
                e.currentTarget.style.background = 'transparent';
                e.currentTarget.style.color = 'var(--text-secondary)';
            }
        }}
    >
        📚 Resources
    </button>
    <button 
        className={`tab-btn ${activeTab === 'communications' ? 'active' : ''}`}
        onClick={() => setActiveTab('communications')}
        style={{
            padding: '12px 20px',
            border: 'none',
            background: activeTab === 'communications' ? 'var(--gradient-primary)' : 'transparent',
            color: activeTab === 'communications' ? 'var(--text-white)' : 'var(--text-secondary)',
            borderRadius: 'var(--radius-md) var(--radius-md) 0 0',
            cursor: 'pointer',
            fontSize: '14px',
            fontWeight: activeTab === 'communications' ? '600' : '500',
            transition: 'var(--transition-fast)',
            whiteSpace: 'nowrap',
            boxShadow: activeTab === 'communications' ? 'var(--shadow-sm)' : 'none'
        }}
        onMouseEnter={(e) => {
            if (activeTab !== 'communications') {
                e.currentTarget.style.background = 'var(--background-primary)';
                e.currentTarget.style.color = 'var(--text-primary)';
            }
        }}
        onMouseLeave={(e) => {
            if (activeTab !== 'communications') {
                e.currentTarget.style.background = 'transparent';
                e.currentTarget.style.color = 'var(--text-secondary)';
            }
        }}
    >
        💬 Communications
    </button>
    <button 
        className={`tab-btn ${activeTab === 'activity' ? 'active' : ''}`}
        onClick={() => setActiveTab('activity')}
        style={{
            padding: '12px 20px',
            border: 'none',
            background: activeTab === 'activity' ? 'var(--gradient-primary)' : 'transparent',
            color: activeTab === 'activity' ? 'var(--text-white)' : 'var(--text-secondary)',
            borderRadius: 'var(--radius-md) var(--radius-md) 0 0',
            cursor: 'pointer',
            fontSize: '14px',
            fontWeight: activeTab === 'activity' ? '600' : '500',
            transition: 'var(--transition-fast)',
            whiteSpace: 'nowrap',
            boxShadow: activeTab === 'activity' ? 'var(--shadow-sm)' : 'none'
        }}
        onMouseEnter={(e) => {
            if (activeTab !== 'activity') {
                e.currentTarget.style.background = 'var(--background-primary)';
                e.currentTarget.style.color = 'var(--text-primary)';
            }
        }}
        onMouseLeave={(e) => {
            if (activeTab !== 'activity') {
                e.currentTarget.style.background = 'transparent';
                e.currentTarget.style.color = 'var(--text-secondary)';
            }
        }}
    >
        📋 Activity
    </button>
    <button 
        className={`tab-btn ${activeTab === 'financial' ? 'active' : ''}`}
        onClick={() => setActiveTab('financial')}
        style={{
            padding: '12px 20px',
            border: 'none',
            background: activeTab === 'financial' ? 'var(--gradient-primary)' : 'transparent',
            color: activeTab === 'financial' ? 'var(--text-white)' : 'var(--text-secondary)',
            borderRadius: 'var(--radius-md) var(--radius-md) 0 0',
            cursor: 'pointer',
            fontSize: '14px',
            fontWeight: activeTab === 'financial' ? '600' : '500',
            transition: 'var(--transition-fast)',
            whiteSpace: 'nowrap',
            boxShadow: activeTab === 'financial' ? 'var(--shadow-sm)' : 'none'
        }}
        onMouseEnter={(e) => {
            if (activeTab !== 'financial') {
                e.currentTarget.style.background = 'var(--background-primary)';
                e.currentTarget.style.color = 'var(--text-primary)';
            }
        }}
        onMouseLeave={(e) => {
            if (activeTab !== 'financial') {
                e.currentTarget.style.background = 'transparent';
                e.currentTarget.style.color = 'var(--text-secondary)';
            }
        }}
    >
        💰 Financial
    </button>
    <button 
        className={`tab-btn ${activeTab === 'community' ? 'active' : ''}`}
        onClick={() => setActiveTab('community')}
        style={{
            padding: '12px 20px',
            border: 'none',
            background: activeTab === 'community' ? 'var(--gradient-primary)' : 'transparent',
            color: activeTab === 'community' ? 'var(--text-white)' : 'var(--text-secondary)',
            borderRadius: 'var(--radius-md) var(--radius-md) 0 0',
            cursor: 'pointer',
            fontSize: '14px',
            fontWeight: activeTab === 'community' ? '600' : '500',
            transition: 'var(--transition-fast)',
            whiteSpace: 'nowrap',
            boxShadow: activeTab === 'community' ? 'var(--shadow-sm)' : 'none'
        }}
        onMouseEnter={(e) => {
            if (activeTab !== 'community') {
                e.currentTarget.style.background = 'var(--background-primary)';
                e.currentTarget.style.color = 'var(--text-primary)';
            }
        }}
        onMouseLeave={(e) => {
            if (activeTab !== 'community') {
                e.currentTarget.style.background = 'transparent';
                e.currentTarget.style.color = 'var(--text-secondary)';
            }
        }}
    >
        🌐 Community
    </button>
</div>

{/* TAB CONTENT - FIXED: Added position and zIndex */}
<div className="tab-content" style={{
    flex: 1,
    overflowY: 'auto',
    background: 'var(--background-secondary)',
    transition: 'opacity 0.3s ease-in-out',
    position: 'relative',
    zIndex: 1
}}>
    {activeTab === 'overview' && renderOverviewTab()}
    {activeTab === 'progress' && renderProgressTab()}
    {activeTab === 'goldenthread' && renderGoldenThreadTab()}
    {activeTab === 'milestones' && renderMilestonesTab()}
    {activeTab === 'resources' && renderResourcesTab()}
    {activeTab === 'communications' && renderCommunicationsTab()}
    {activeTab === 'activity' && renderActivityTab()}
    {activeTab === 'financial' && renderFinancialTab()}
    {activeTab === 'community' && renderCommunityTab()}
</div>
                </>
            )}
        </div>
    </div>
);
}; // This closes the UserDetailModal function
    
     // ========== COACH DETAIL MODAL - COMPLETE WITH TRAINING & CREDENTIALS ==========
function CoachDetailModal({ coach, onClose, onUpdate, currentUserId }) {
    // ========== CORE STATES ==========
    const [activeTab, setActiveTab] = useState('overview');
    const [loading, setLoading] = useState(true);
    const [currentUser, setCurrentUser] = useState(null);
    
    // ========== DATA STATES (15+ separate states) ==========
    const [coachProfile, setCoachProfile] = useState(null);
    const [assignedPIRs, setAssignedPIRs] = useState([]);
    const [activities, setActivities] = useState([]);
    const [assignments, setAssignments] = useState([]);
    const [checkInsReviewed, setCheckInsReviewed] = useState([]);
    const [alerts, setAlerts] = useState([]);
    const [sessions, setSessions] = useState([]);
    const [upcomingSessions, setUpcomingSessions] = useState([]);
    const [certifications, setCertifications] = useState([]);
    const [specializations, setSpecializations] = useState([]);
    const [trainings, setTrainings] = useState([]);
    const [languages, setLanguages] = useState([]);
    
    const [stats, setStats] = useState({
        totalPIRs: 0,
        checkInComplianceRate: 0,
        assignmentCompletionRate: 0,
        alertsHandled: 0,
        avgCaseloadDays: 0,
        lastActive: null,
        totalSessions: 0,
        upcomingSessions: 0,
        yearsExperience: 0
    });
    
    // ========== UI STATES (10+ states) ==========
    const [editing, setEditing] = useState(false);
    const [editData, setEditData] = useState({});
    const [showAssignPIRModal, setShowAssignPIRModal] = useState(false);
    const [showRemovePIRModal, setShowRemovePIRModal] = useState(false);
    const [showPIRDetailModal, setShowPIRDetailModal] = useState(false);
    const [selectedPIRId, setSelectedPIRId] = useState(null);
    const [selectedPIRForRemoval, setSelectedPIRForRemoval] = useState(null);
    const [expandedPIRs, setExpandedPIRs] = useState({});
    const [showAddCertModal, setShowAddCertModal] = useState(false);
    const [showAddTrainingModal, setShowAddTrainingModal] = useState(false);
    const [showDeleteConfirmModal, setShowDeleteConfirmModal] = useState(false);
    const [showExportModal, setShowExportModal] = useState(false);
    
    // ========== FORM STATES ==========
    const [assignPIRForm, setAssignPIRForm] = useState({ email: '', searchResults: [] });
    const [newCertification, setNewCertification] = useState({
        name: '',
        organization: '',
        dateObtained: '',
        expirationDate: '',
        status: 'active'
    });
    const [newTraining, setNewTraining] = useState({
        name: '',
        organization: '',
        dateCompleted: '',
        hours: 0,
        type: 'course'
    });
    const [assignPIRError, setAssignPIRError] = useState('');
    const [certError, setCertError] = useState('');
    const [assigning, setAssigning] = useState(false);
    const [removing, setRemoving] = useState(false);
    const [saving, setSaving] = useState(false);
    const [successMessage, setSuccessMessage] = useState('');
    
    // ========== FILTER/SORT STATES ==========
    const [pirSearchQuery, setPirSearchQuery] = useState('');
    const [pirStatusFilter, setPirStatusFilter] = useState('all');
    const [certStatusFilter, setCertStatusFilter] = useState('all');
    const [sortBy, setSortBy] = useState('name');
    
    // ========== CHART REFS ==========
    const workloadChartRef = useRef(null);
    const complianceChartRef = useRef(null);
    const chartInstances = useRef({});
    
    // ========== LOAD DATA ON MOUNT - PROMISE.ALL PATTERN ==========
    useEffect(() => {
        const loadAllData = async () => {
            if (!coach.id || (coach.role !== 'coach' && coach.role !== 'admin')) {
                setLoading(false);
                return;
            }
            
            try {
                setLoading(true);
                
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                // ✅ ONE PROMISE.ALL FOR ALL QUERIES - PARALLEL LOADING
                const [
                    coachDoc,
                    currentUserDoc,
                    pirsSnap,
                    assignmentsSnap,
                    activitiesSnap,
                    sessionsSnap,
                    upcomingSessionsSnap,
                    certificationsSnap,
                    specializationsSnap,
                    trainingsSnap
                ] = await Promise.all([
                    db.collection('users').doc(coach.id).get(),
                    db.collection('users').doc(currentUserId).get(),
                    db.collection('users')
                        .where('assignedCoach', '==', coach.id)
                        .where('role', '==', 'pir')
                        .where('tenantId', '==', CURRENT_TENANT)
                        .get(),
                    db.collection('assignments')
                        .where('createdBy', '==', coach.id)
                        .where('tenantId', '==', CURRENT_TENANT)
                        .orderBy('createdAt', 'desc')
                        .limit(50)
                        .get(),
                    db.collection('activities')
                        .where('userId', '==', coach.id)
                        .where('tenantId', '==', CURRENT_TENANT)
                        .orderBy('timestamp', 'desc')
                        .limit(50)
                        .get(),
                    db.collection('sessions')
                        .where('coachId', '==', coach.id)
                        .where('tenantId', '==', CURRENT_TENANT)
                        .where('date', '>=', thirtyDaysAgo)
                        .orderBy('date', 'desc')
                        .get(),
                    db.collection('sessions')
                        .where('coachId', '==', coach.id)
                        .where('tenantId', '==', CURRENT_TENANT)
                        .where('date', '>=', new Date())
                        .orderBy('date', 'asc')
                        .limit(10)
                        .get(),
                    db.collection('certifications')
                        .where('userId', '==', coach.id)
                        .where('tenantId', '==', CURRENT_TENANT)
                        .orderBy('dateObtained', 'desc')
                        .get(),
                    db.collection('specializations')
                        .where('userId', '==', coach.id)
                        .where('tenantId', '==', CURRENT_TENANT)
                        .get(),
                    db.collection('trainings')
                        .where('userId', '==', coach.id)
                        .where('tenantId', '==', CURRENT_TENANT)
                        .orderBy('dateCompleted', 'desc')
                        .get()
                ]);
                
                // Process coach profile
                const coachData = { id: coachDoc.id, ...coachDoc.data() };
                setCoachProfile(coachData);
                setEditData(coachData);
                
                // Process current user
                setCurrentUser({ id: currentUserDoc.id, ...currentUserDoc.data() });
                
                // Process PIRs
                const pirsData = [];
                const pirIds = [];
                pirsSnap.forEach(doc => {
                    const pirData = { id: doc.id, ...doc.data() };
                    pirsData.push(pirData);
                    pirIds.push(doc.id);
                });
                setAssignedPIRs(pirsData);
                
                // Process assignments
                const assignmentsData = [];
                let completedAssignments = 0;
                assignmentsSnap.forEach(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    assignmentsData.push(data);
                    if (data.status === 'completed') completedAssignments++;
                });
                setAssignments(assignmentsData);
                
                // Process activities
                const activitiesData = [];
                activitiesSnap.forEach(doc => {
                    activitiesData.push({ id: doc.id, ...doc.data() });
                });
                setActivities(activitiesData);
                
                // Process sessions
                const sessionsData = [];
                sessionsSnap.forEach(doc => {
                    sessionsData.push({ id: doc.id, ...doc.data() });
                });
                setSessions(sessionsData);
                
                const upcomingSessionsData = [];
                upcomingSessionsSnap.forEach(doc => {
                    upcomingSessionsData.push({ id: doc.id, ...doc.data() });
                });
                setUpcomingSessions(upcomingSessionsData);
                
                // Process certifications
                const certificationsData = [];
                certificationsSnap.forEach(doc => {
                    certificationsData.push({ id: doc.id, ...doc.data() });
                });
                setCertifications(certificationsData);
                
                // Process specializations
                const specializationsData = [];
                specializationsSnap.forEach(doc => {
                    specializationsData.push({ id: doc.id, ...doc.data() });
                });
                setSpecializations(specializationsData);
                
                // Process trainings
                const trainingsData = [];
                let totalTrainingHours = 0;
                trainingsSnap.forEach(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    trainingsData.push(data);
                    totalTrainingHours += data.hours || 0;
                });
                setTrainings(trainingsData);
                
                // If coach has PIRs, load additional PIR-specific data
                if (pirIds.length > 0) {
                    const checkInsPromises = pirIds.map(pirId =>
                        db.collection('checkIns')
                            .where('userId', '==', pirId)
                            .where('tenantId', '==', CURRENT_TENANT)
                            .where('createdAt', '>=', thirtyDaysAgo)
                            .get()
                    );
                    
                    const alertsPromises = pirIds.map(pirId =>
                        db.collection('alerts')
                            .where('userId', '==', pirId)
                            .where('tenantId', '==', CURRENT_TENANT)
                            .limit(10)
                            .get()
                    );
                    
                    const [checkInsSnapshots, alertsSnapshots] = await Promise.all([
                        Promise.all(checkInsPromises),
                        Promise.all(alertsPromises)
                    ]);
                    
                    // Process check-ins
                    const allCheckIns = [];
                    checkInsSnapshots.forEach(snapshot => {
                        snapshot.forEach(doc => {
                            allCheckIns.push({ id: doc.id, ...doc.data() });
                        });
                    });
                    setCheckInsReviewed(allCheckIns);
                    
                    // Process alerts
                    const allAlerts = [];
                    alertsSnapshots.forEach(snapshot => {
                        snapshot.forEach(doc => {
                            allAlerts.push({ id: doc.id, ...doc.data() });
                        });
                    });
                    setAlerts(allAlerts);
                    
                    // Calculate stats
                    const completedCheckIns = allCheckIns.filter(c => c.status === 'completed').length;
                    const expectedCheckIns = pirIds.length * 30; // Assuming daily check-ins
                    const complianceRate = expectedCheckIns > 0 ? (completedCheckIns / expectedCheckIns) * 100 : 0;
                    
                    const completionRate = assignmentsData.length > 0 
                        ? (completedAssignments / assignmentsData.length) * 100 
                        : 0;
                    
                    const totalDays = pirsData.reduce((sum, pir) => {
                        if (pir.assignedDate) {
                            const days = Math.floor((new Date() - pir.assignedDate.toDate()) / (1000 * 60 * 60 * 24));
                            return sum + days;
                        }
                        return sum;
                    }, 0);
                    const avgDays = pirsData.length > 0 ? Math.floor(totalDays / pirsData.length) : 0;
                    
                    setStats({
                        totalPIRs: pirsData.length,
                        checkInComplianceRate: Math.round(complianceRate),
                        assignmentCompletionRate: Math.round(completionRate),
                        alertsHandled: allAlerts.filter(a => a.status === 'resolved').length,
                        avgCaseloadDays: avgDays,
                        lastActive: coachData.lastActive || null,
                        totalSessions: sessionsData.length,
                        upcomingSessions: upcomingSessionsData.length,
                        yearsExperience: coachData.yearsExperience || 0
                    });
                } else {
                    // No PIRs assigned
                    setStats({
                        totalPIRs: 0,
                        checkInComplianceRate: 0,
                        assignmentCompletionRate: 0,
                        alertsHandled: 0,
                        avgCaseloadDays: 0,
                        lastActive: coachData.lastActive || null,
                        totalSessions: sessionsData.length,
                        upcomingSessions: upcomingSessionsData.length,
                        yearsExperience: coachData.yearsExperience || 0
                    });
                }
                
            } catch (error) {
                console.error('Error loading coach data:', error);
            } finally {
                setLoading(false);
            }
        };
        
        loadAllData();
    }, [coach.id, currentUserId]);
    
    // ========== CLEANUP CHART INSTANCES ON UNMOUNT ==========
    useEffect(() => {
        return () => {
            Object.values(chartInstances.current).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
        };
    }, []);
    
    // ========== AUTO-DISMISS SUCCESS MESSAGE ==========
    useEffect(() => {
        if (successMessage) {
            const timer = setTimeout(() => {
                setSuccessMessage('');
            }, 3000);
            return () => clearTimeout(timer);
        }
    }, [successMessage]);
    
    // ========== HELPER FUNCTIONS ==========
    const formatDate = (timestamp) => {
        if (!timestamp) return 'N/A';
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    };
    
    const formatDateTime = (timestamp) => {
        if (!timestamp) return 'N/A';
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleString('en-US', { 
            month: 'short', 
            day: 'numeric', 
            year: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
        });
    };
    
    const formatRole = (role) => {
        const roleMap = {
            'coach': '🎯 Coach',
            'admin': '🛡️ Administrator',
            'superadmin': '👑 Super Admin',
            'pir': '👤 PIR'
        };
        return roleMap[role] || role;
    };
    
    const formatPermissionLevel = (level) => {
        const levelMap = {
            'superadmin': '👑 Super Admin',
            'admin': '🛡️ Full Admin',
            'supervisor': '👨‍💼 Supervisor',
            'coach': '🎯 Coach'
        };
        return levelMap[level] || level;
    };
    
    const getPermissionLevelBadge = (level) => {
        const badgeMap = {
            'superadmin': 'danger',
            'admin': 'warning',
            'supervisor': 'info',
            'coach': 'success'
        };
        return badgeMap[level] || 'secondary';
    };
    
    // ========== HANDLER: SAVE PROFILE ==========
    const handleSaveProfile = async () => {
        setSaving(true);
        try {
            await db.collection('users').doc(coach.id).update({
                displayName: editData.displayName,
                email: editData.email,
                bio: editData.bio,
                phone: editData.phone,
                yearsExperience: editData.yearsExperience,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: currentUserId
            });
            
            setCoachProfile({...coachProfile, ...editData});
            setEditing(false);
            setSuccessMessage('✓ Profile updated successfully!');
            
            if (onUpdate) onUpdate();
        } catch (error) {
            console.error('Error updating profile:', error);
            alert('Error updating profile: ' + error.message);
        } finally {
            setSaving(false);
        }
    };
    
    // ========== HANDLER: TOGGLE ACTIVE STATUS ==========
    const handleToggleActiveStatus = async () => {
        const newStatus = !coachProfile.active;
        const confirmMsg = newStatus 
            ? 'Activate this coach account? They will be able to log in.' 
            : 'Deactivate this coach account? They will not be able to log in.';
        
        if (!window.confirm(confirmMsg)) return;
        
        setSaving(true);
        try {
            await db.collection('users').doc(coach.id).update({
                active: newStatus,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: currentUserId
            });
            
            setCoachProfile({...coachProfile, active: newStatus});
            setSuccessMessage(newStatus ? '✓ Coach activated!' : '✓ Coach deactivated!');
            
            if (onUpdate) onUpdate();
        } catch (error) {
            console.error('Error toggling status:', error);
            alert('Error updating status: ' + error.message);
        } finally {
            setSaving(false);
        }
    };
    
    // ========== HANDLER: SEARCH PIR FOR ASSIGNMENT ==========
    const handleSearchPIR = async (email) => {
        setAssignPIRForm({...assignPIRForm, email});
        setAssignPIRError('');
        
        if (email.length < 3) {
            setAssignPIRForm({...assignPIRForm, email, searchResults: []});
            return;
        }
        
        try {
            const pirsSnap = await db.collection('users')
                .where('role', '==', 'pir')
                .where('tenantId', '==', CURRENT_TENANT)
                .where('email', '>=', email)
                .where('email', '<=', email + '\uf8ff')
                .limit(10)
                .get();
            
            const results = [];
            pirsSnap.forEach(doc => {
                const data = { id: doc.id, ...doc.data() };
                // Only show unassigned PIRs
                if (!data.assignedCoach) {
                    results.push(data);
                }
            });
            
            setAssignPIRForm({...assignPIRForm, email, searchResults: results});
        } catch (error) {
            console.error('Error searching PIRs:', error);
            setAssignPIRError('Error searching PIRs: ' + error.message);
        }
    };
    
    // ========== HANDLER: ASSIGN PIR ==========
    const handleAssignPIR = async (pirId, pirName) => {
        setAssigning(true);
        setAssignPIRError('');
        
        try {
            await db.collection('users').doc(pirId).update({
                assignedCoach: coach.id,
                assignedDate: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: currentUserId
            });
            
            // Create notification
            await db.collection('notifications').add({
                tenantId: CURRENT_TENANT,
                recipientId: coach.id,
                type: 'pir_assigned',
                title: 'New PIR Assigned',
                message: `${pirName} has been assigned to you`,
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Log activity
            await logAudit({
                userId: currentUserId,
                tenantId: CURRENT_TENANT,
                action: 'pir-assigned',
                resourceType: 'user',
                resourceId: pirId,
                details: { coachId: coach.id, coachName: coachProfile.displayName }
            });
            
            setSuccessMessage(`✓ ${pirName} assigned successfully!`);
            setShowAssignPIRModal(false);
            setAssignPIRForm({ email: '', searchResults: [] });
            
            // Reload data
            window.location.reload();
        } catch (error) {
            console.error('Error assigning PIR:', error);
            setAssignPIRError('Failed to assign PIR: ' + error.message);
        } finally {
            setAssigning(false);
        }
    };
    
    // ========== HANDLER: REMOVE PIR ==========
    const handleRemovePIR = async () => {
        setRemoving(true);
        
        try {
            await db.collection('users').doc(selectedPIRForRemoval.id).update({
                assignedCoach: firebase.firestore.FieldValue.delete(),
                assignedDate: firebase.firestore.FieldValue.delete(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: currentUserId
            });
            
            // Create notification
            await db.collection('notifications').add({
                tenantId: CURRENT_TENANT,
                recipientId: coach.id,
                type: 'pir_removed',
                title: 'PIR Removed from Caseload',
                message: `${selectedPIRForRemoval.name} has been removed from your caseload`,
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Log activity
            await logAudit({
                userId: currentUserId,
                tenantId: CURRENT_TENANT,
                action: 'pir-removed',
                resourceType: 'user',
                resourceId: selectedPIRForRemoval.id,
                details: { coachId: coach.id, coachName: coachProfile.displayName }
            });
            
            setSuccessMessage(`✓ ${selectedPIRForRemoval.name} removed from caseload!`);
            setShowRemovePIRModal(false);
            setSelectedPIRForRemoval(null);
            
            // Reload data
            window.location.reload();
        } catch (error) {
            console.error('Error removing PIR:', error);
            alert('Error removing PIR: ' + error.message);
        } finally {
            setRemoving(false);
        }
    };
    
    // ========== HANDLER: VIEW PIR (Open UserDetailModal) ==========
    const handleViewPIR = (pirId) => {
        setSelectedPIRId(pirId);
        setShowPIRDetailModal(true);
    };
    
    // ========== HANDLER: ADD CERTIFICATION ==========
    const handleAddCertification = async () => {
        setCertError('');
        
        // Validation
        if (!newCertification.name || !newCertification.organization || !newCertification.dateObtained) {
            setCertError('Please fill in all required fields (Name, Organization, Date Obtained)');
            return;
        }
        
        setSaving(true);
        try {
            await db.collection('certifications').add({
                userId: coach.id,
                tenantId: CURRENT_TENANT,
                ...newCertification,
                dateObtained: firebase.firestore.Timestamp.fromDate(new Date(newCertification.dateObtained)),
                expirationDate: newCertification.expirationDate 
                    ? firebase.firestore.Timestamp.fromDate(new Date(newCertification.expirationDate))
                    : null,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: currentUserId
            });
            
            setSuccessMessage('✓ Certification added successfully!');
            setShowAddCertModal(false);
            setNewCertification({
                name: '',
                organization: '',
                dateObtained: '',
                expirationDate: '',
                status: 'active'
            });
            
            // Reload data
            window.location.reload();
        } catch (error) {
            console.error('Error adding certification:', error);
            setCertError('Error adding certification: ' + error.message);
        } finally {
            setSaving(false);
        }
    };
    
    // ========== HANDLER: ADD TRAINING ==========
    const handleAddTraining = async () => {
        setCertError('');
        
        if (!newTraining.name || !newTraining.organization || !newTraining.dateCompleted) {
            setCertError('Please fill in all required fields');
            return;
        }
        
        setSaving(true);
        try {
            await db.collection('trainings').add({
                userId: coach.id,
                tenantId: CURRENT_TENANT,
                ...newTraining,
                dateCompleted: firebase.firestore.Timestamp.fromDate(new Date(newTraining.dateCompleted)),
                hours: parseFloat(newTraining.hours) || 0,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: currentUserId
            });
            
            setSuccessMessage('✓ Training added successfully!');
            setShowAddTrainingModal(false);
            setNewTraining({
                name: '',
                organization: '',
                dateCompleted: '',
                hours: 0,
                type: 'course'
            });
            
            // Reload data
            window.location.reload();
        } catch (error) {
            console.error('Error adding training:', error);
            setCertError('Error adding training: ' + error.message);
        } finally {
            setSaving(false);
        }
    };
    
    // ========== HANDLER: DELETE COACH ==========
    const handleDeleteCoach = async () => {
        setSaving(true);
        try {
            // Soft delete - mark as deleted but keep data
            await db.collection('users').doc(coach.id).update({
                deleted: true,
                active: false,
                deletedAt: firebase.firestore.FieldValue.serverTimestamp(),
                deletedBy: currentUserId
            });
            
            // Log activity
            await logAudit({
                userId: currentUserId,
                tenantId: CURRENT_TENANT,
                action: 'coach-deleted',
                resourceType: 'user',
                resourceId: coach.id,
                details: { coachName: coachProfile.displayName }
            });
            
            setSuccessMessage('✓ Coach account deleted!');
            setTimeout(() => {
                onClose();
                if (onUpdate) onUpdate();
            }, 1500);
        } catch (error) {
            console.error('Error deleting coach:', error);
            alert('Error deleting coach: ' + error.message);
        } finally {
            setSaving(false);
            setShowDeleteConfirmModal(false);
        }
    };
    
  // ========== RENDER: OVERVIEW TAB ==========
const renderOverviewTab = () => {
    // Add null check at the beginning
    if (!coachProfile) {
        return (
            <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '400px' }}>
                <div className="loading-spinner"></div>
            </div>
        );
    }
    
    return (
        <div style={{ padding: '20px' }}>
            {/* Account Status Banner */}
            {(!coachProfile.active || coachProfile.deleted) && (
                <div style={{
                    background: coachProfile.deleted 
                        ? 'linear-gradient(135deg, var(--danger-color, #dc3545), var(--error-color, #c82333))' 
                        : 'linear-gradient(135deg, var(--warning-color, #ffc107), var(--warning-dark, #e0a800))',
                    padding: '15px 20px',
                    borderRadius: 'var(--radius-md, 12px)',
                    color: 'var(--text-white, white)',
                    marginBottom: '20px',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    fontWeight: 'bold',
                    boxShadow: 'var(--shadow-md, 0 4px 6px rgba(0,0,0,0.1))'
                }}>
                    <span>
                        {coachProfile.deleted ? '🚫 ACCOUNT DELETED' : '⚠️ ACCOUNT INACTIVE'}
                        {coachProfile.deleted && ' - Coach cannot log in. Data preserved for compliance.'}
                        {!coachProfile.deleted && !coachProfile.active && ' - Coach cannot log in until activated.'}
                    </span>
                    {!coachProfile.deleted && currentUser?.role === 'superadmin' && (
                        <button
                            onClick={handleToggleActiveStatus}
                            style={{
                                background: 'var(--text-white, white)',
                                color: coachProfile.active ? 'var(--warning-color, #ffc107)' : 'var(--success-color, #28a745)',
                                border: 'none',
                                padding: '8px 16px',
                                borderRadius: 'var(--radius-sm, 8px)',
                                cursor: 'pointer',
                                fontWeight: 'bold',
                                fontSize: '14px',
                                transition: 'var(--transition-fast, all 0.2s ease)'
                            }}
                        >
                            {coachProfile.active ? 'Deactivate' : 'Activate'}
                        </button>
                    )}
                </div>
            )}
            
            {/* Key Metrics Cards */}
            <div style={{ 
                display: 'grid', 
                gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
                gap: '20px',
                marginBottom: '30px'
            }}>
                <div style={{
                    background: 'linear-gradient(135deg, var(--primary-color, #0077CC), var(--primary-dark, #005fa3))',
                    padding: '20px',
                    borderRadius: 'var(--radius-lg, 16px)',
                    color: 'var(--text-white, white)',
                    boxShadow: 'var(--shadow-primary, 0 8px 16px rgba(0,119,204,0.3))',
                    transition: 'var(--transition-fast, all 0.2s ease)',
                    cursor: 'default'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Total PIRs</div>
                    <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{stats.totalPIRs}</div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Assigned to coach</div>
                </div>
                
                <div style={{
                    background: 'linear-gradient(135deg, var(--secondary-color, #008B8B), var(--secondary-dark, #006666))',
                    padding: '20px',
                    borderRadius: 'var(--radius-lg, 16px)',
                    color: 'var(--text-white, white)',
                    boxShadow: 'var(--shadow-md, 0 4px 6px rgba(0,0,0,0.1))',
                    transition: 'var(--transition-fast, all 0.2s ease)',
                    cursor: 'default'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Sessions</div>
                    <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{stats.totalSessions}</div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Last 30 days</div>
                </div>
                
                <div style={{
                    background: 'linear-gradient(135deg, var(--success-color, #28a745), var(--success-dark, #1e7e34))',
                    padding: '20px',
                    borderRadius: 'var(--radius-lg, 16px)',
                    color: 'var(--text-white, white)',
                    boxShadow: 'var(--shadow-md, 0 4px 6px rgba(0,0,0,0.1))',
                    transition: 'var(--transition-fast, all 0.2s ease)',
                    cursor: 'default'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Upcoming Sessions</div>
                    <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{stats.upcomingSessions}</div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Next 30 days</div>
                </div>
                
                <div style={{
                    background: 'linear-gradient(135deg, var(--info-color, #17a2b8), var(--info-dark, #117a8b))',
                    padding: '20px',
                    borderRadius: 'var(--radius-lg, 16px)',
                    color: 'var(--text-white, white)',
                    boxShadow: 'var(--shadow-md, 0 4px 6px rgba(0,0,0,0.1))',
                    transition: 'var(--transition-fast, all 0.2s ease)',
                    cursor: 'default'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Experience</div>
                    <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{stats.yearsExperience}</div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Years in field</div>
                </div>
            </div>
            
            {/* Profile Information */}
            <div style={{
                background: 'var(--text-white, white)',
                borderRadius: 'var(--radius-lg, 16px)',
                padding: '25px',
                boxShadow: 'var(--shadow-sm, 0 2px 4px rgba(0,0,0,0.05))',
                marginBottom: '20px'
            }}>
                <div style={{ 
                    display: 'flex', 
                    justifyContent: 'space-between', 
                    alignItems: 'center',
                    marginBottom: '20px'
                }}>
                    <h3 style={{ margin: 0, color: 'var(--text-primary, #333)' }}>Profile Information</h3>
                    {currentUser?.role === 'superadmin' && (
                        !editing ? (
                            <button 
                                className="btn btn-secondary"
                                onClick={() => setEditing(true)}
                                style={{
                                    background: 'linear-gradient(135deg, var(--secondary-color, #008B8B), var(--secondary-dark, #006666))',
                                    color: 'var(--text-white, white)',
                                    border: 'none',
                                    padding: '10px 20px',
                                    borderRadius: 'var(--radius-sm, 8px)',
                                    cursor: 'pointer',
                                    fontWeight: '500',
                                    transition: 'var(--transition-fast, all 0.2s ease)'
                                }}
                            >
                                Edit Profile
                            </button>
                        ) : (
                            <div style={{ display: 'flex', gap: '10px' }}>
                                <button 
                                    className="btn btn-primary"
                                    onClick={handleSaveProfile}
                                    disabled={saving}
                                    style={{
                                        background: 'linear-gradient(135deg, var(--primary-color, #0077CC), var(--primary-dark, #005fa3))',
                                        color: 'var(--text-white, white)',
                                        border: 'none',
                                        padding: '10px 20px',
                                        borderRadius: 'var(--radius-sm, 8px)',
                                        cursor: saving ? 'not-allowed' : 'pointer',
                                        fontWeight: '500',
                                        transition: 'var(--transition-fast, all 0.2s ease)'
                                    }}
                                >
                                    {saving ? 'Saving...' : 'Save Changes'}
                                </button>
                                <button 
                                    className="btn btn-secondary"
                                    onClick={() => {
                                        setEditing(false);
                                        setEditData(coachProfile);
                                    }}
                                    style={{
                                        background: 'var(--text-muted, #6c757d)',
                                        color: 'var(--text-white, white)',
                                        border: 'none',
                                        padding: '10px 20px',
                                        borderRadius: 'var(--radius-sm, 8px)',
                                        cursor: 'pointer',
                                        fontWeight: '500',
                                        transition: 'var(--transition-fast, all 0.2s ease)'
                                    }}
                                >
                                    Cancel
                                </button>
                            </div>
                        )
                    )}
                </div>
                
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
                    <div>
                        <label style={{ fontWeight: 'bold', color: 'var(--text-secondary, #666)', fontSize: '14px', display: 'block', marginBottom: '8px' }}>Full Name</label>
                        {editing ? (
                            <input
                                type="text"
                                className="form-control"
                                value={editData.displayName || ''}
                                onChange={(e) => setEditData({...editData, displayName: e.target.value})}
                                style={{
                                    width: '100%',
                                    padding: '10px',
                                    border: '1px solid var(--border-color, #ddd)',
                                    borderRadius: 'var(--radius-sm, 8px)',
                                    fontSize: '14px'
                                }}
                            />
                        ) : (
                            <div style={{ fontSize: '16px', color: 'var(--text-primary, #333)' }}>
                                {coachProfile.displayName || 'N/A'}
                            </div>
                        )}
                    </div>
                    
                    <div>
                        <label style={{ fontWeight: 'bold', color: 'var(--text-secondary, #666)', fontSize: '14px', display: 'block', marginBottom: '8px' }}>Email</label>
                        {editing ? (
                            <input
                                type="email"
                                className="form-control"
                                value={editData.email || ''}
                                onChange={(e) => setEditData({...editData, email: e.target.value})}
                                style={{
                                    width: '100%',
                                    padding: '10px',
                                    border: '1px solid var(--border-color, #ddd)',
                                    borderRadius: 'var(--radius-sm, 8px)',
                                    fontSize: '14px'
                                }}
                            />
                        ) : (
                            <div style={{ fontSize: '16px', color: 'var(--text-primary, #333)' }}>
                                {coachProfile.email || 'N/A'}
                            </div>
                        )}
                    </div>
                    
                    <div>
                        <label style={{ fontWeight: 'bold', color: 'var(--text-secondary, #666)', fontSize: '14px', display: 'block', marginBottom: '8px' }}>Phone</label>
                        {editing ? (
                            <input
                                type="tel"
                                className="form-control"
                                value={editData.phone || ''}
                                onChange={(e) => setEditData({...editData, phone: e.target.value})}
                                style={{
                                    width: '100%',
                                    padding: '10px',
                                    border: '1px solid var(--border-color, #ddd)',
                                    borderRadius: 'var(--radius-sm, 8px)',
                                    fontSize: '14px'
                                }}
                            />
                        ) : (
                            <div style={{ fontSize: '16px', color: 'var(--text-primary, #333)' }}>
                                {coachProfile.phone || 'N/A'}
                            </div>
                        )}
                    </div>
                    
                    <div>
                        <label style={{ fontWeight: 'bold', color: 'var(--text-secondary, #666)', fontSize: '14px', display: 'block', marginBottom: '8px' }}>Years of Experience</label>
                        {editing ? (
                            <input
                                type="number"
                                className="form-control"
                                value={editData.yearsExperience || 0}
                                onChange={(e) => setEditData({...editData, yearsExperience: parseInt(e.target.value) || 0})}
                                style={{
                                    width: '100%',
                                    padding: '10px',
                                    border: '1px solid var(--border-color, #ddd)',
                                    borderRadius: 'var(--radius-sm, 8px)',
                                    fontSize: '14px'
                                }}
                            />
                        ) : (
                            <div style={{ fontSize: '16px', color: 'var(--text-primary, #333)' }}>
                                {coachProfile.yearsExperience || 0} years
                            </div>
                        )}
                    </div>
                    
                    <div style={{ gridColumn: '1 / -1' }}>
                        <label style={{ fontWeight: 'bold', color: 'var(--text-secondary, #666)', fontSize: '14px', display: 'block', marginBottom: '8px' }}>Bio</label>
                        {editing ? (
                            <textarea
                                className="form-control"
                                value={editData.bio || ''}
                                onChange={(e) => setEditData({...editData, bio: e.target.value})}
                                rows={4}
                                style={{
                                    width: '100%',
                                    padding: '10px',
                                    border: '1px solid var(--border-color, #ddd)',
                                    borderRadius: 'var(--radius-sm, 8px)',
                                    fontSize: '14px',
                                    resize: 'vertical'
                                }}
                            />
                        ) : (
                            <div style={{ fontSize: '16px', color: 'var(--text-primary, #333)', whiteSpace: 'pre-wrap' }}>
                                {coachProfile.bio || 'No bio provided'}
                            </div>
                        )}
                    </div>
                </div>
            </div>
            
            {/* Account Information */}
            <div style={{
                background: 'var(--text-white, white)',
                borderRadius: 'var(--radius-lg, 16px)',
                padding: '25px',
                boxShadow: 'var(--shadow-sm, 0 2px 4px rgba(0,0,0,0.05))'
            }}>
                <h3 style={{ margin: '0 0 20px 0', color: 'var(--text-primary, #333)' }}>Account Information</h3>
                
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
                    <div>
                        <label style={{ fontWeight: 'bold', color: 'var(--text-secondary, #666)', fontSize: '14px', display: 'block', marginBottom: '8px' }}>Role</label>
                        <div style={{ fontSize: '16px', color: 'var(--text-primary, #333)' }}>
                            {formatRole(coachProfile.role)}
                        </div>
                    </div>
                    
                    {coachProfile.role === 'admin' && (
                        <div>
                            <label style={{ fontWeight: 'bold', color: 'var(--text-secondary, #666)', fontSize: '14px', display: 'block', marginBottom: '8px' }}>Permission Level</label>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <span className={`badge badge-${getPermissionLevelBadge(coachProfile.permissionLevel || 'admin')}`}>
                                    {formatPermissionLevel(coachProfile.permissionLevel || 'admin')}
                                </span>
                                {currentUser?.role === 'superadmin' && (
                                    <button
                                        onClick={() => setActiveTab('actions')}
                                        style={{
                                            fontSize: '12px',
                                            color: 'var(--primary-color, #0077CC)',
                                            background: 'none',
                                            border: 'none',
                                            cursor: 'pointer',
                                            textDecoration: 'underline',
                                            padding: 0
                                        }}
                                    >
                                        Edit Permissions
                                    </button>
                                )}
                            </div>
                        </div>
                    )}
                    
                    <div>
                        <label style={{ fontWeight: 'bold', color: 'var(--text-secondary, #666)', fontSize: '14px', display: 'block', marginBottom: '8px' }}>Status</label>
                        <span className={`badge badge-${coachProfile.active ? 'success' : 'danger'}`}>
                            {coachProfile.active ? 'Active' : 'Inactive'}
                        </span>
                    </div>
                    
                    <div>
                        <label style={{ fontWeight: 'bold', color: 'var(--text-secondary, #666)', fontSize: '14px', display: 'block', marginBottom: '8px' }}>Last Active</label>
                        <div style={{ fontSize: '16px', color: 'var(--text-primary, #333)' }}>
                            {formatDateTime(stats.lastActive)}
                        </div>
                    </div>
                    
                    <div>
                        <label style={{ fontWeight: 'bold', color: 'var(--text-secondary, #666)', fontSize: '14px', display: 'block', marginBottom: '8px' }}>Account Created</label>
                        <div style={{ fontSize: '16px', color: 'var(--text-primary, #333)' }}>
                            {formatDate(coachProfile.createdAt)}
                        </div>
                    </div>
                    
                    <div>
                        <label style={{ fontWeight: 'bold', color: 'var(--text-secondary, #666)', fontSize: '14px', display: 'block', marginBottom: '8px' }}>Last Updated</label>
                        <div style={{ fontSize: '16px', color: 'var(--text-primary, #333)' }}>
                            {formatDateTime(coachProfile.updatedAt)}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};
    
    // ========== RENDER: CASELOAD TAB ==========
    const renderCaseloadTab = () => (
        <div className="tab-content" style={{ padding: '20px' }}>
            <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                marginBottom: '20px'
            }}>
                <h3 style={{color: 'var(--text-primary, #333)'}}>
                    Assigned PIRs ({assignedPIRs.length})
                </h3>
                
                {currentUser?.role === 'superadmin' && (
                    <button
                        className="btn btn-primary"
                        onClick={() => setShowAssignPIRModal(true)}
                        style={{
                            background: 'linear-gradient(135deg, var(--primary-color, #0077CC), var(--primary-dark, #005fa3))',
                            color: 'var(--text-white, white)',
                            border: 'none',
                            padding: '10px 20px',
                            borderRadius: 'var(--radius-sm, 8px)',
                            cursor: 'pointer',
                            fontWeight: '500',
                            transition: 'var(--transition-fast, all 0.2s ease)'
                        }}
                    >
                        + Assign PIR
                    </button>
                )}
            </div>
            
            {assignedPIRs.length > 0 ? (
                <div style={{
                    background: 'var(--text-white, white)',
                    borderRadius: 'var(--radius-lg, 16px)',
                    boxShadow: 'var(--shadow-sm, 0 2px 4px rgba(0,0,0,0.05))',
                    overflow: 'hidden'
                }}>
                    <div className="table-container">
                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead>
                                <tr style={{
                                    background: 'linear-gradient(135deg, var(--primary-color, #0077CC), var(--secondary-color, #008B8B))',
                                    color: 'var(--text-white, white)'
                                }}>
                                    <th style={{ padding: '15px', textAlign: 'left' }}>Name</th>
                                    <th style={{ padding: '15px', textAlign: 'left' }}>Email</th>
                                    <th style={{ padding: '15px', textAlign: 'center' }}>Sobriety Days</th>
                                    <th style={{ padding: '15px', textAlign: 'center' }}>Last Check-in</th>
                                    <th style={{ padding: '15px', textAlign: 'center' }}>Status</th>
                                    <th style={{ padding: '15px', textAlign: 'center' }}>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {assignedPIRs.map(pir => (
                                    <tr key={pir.id} style={{
                                        borderBottom: '1px solid var(--border-color, #e0e0e0)',
                                        transition: 'var(--transition-fast, all 0.2s ease)'
                                    }}
                                    onMouseEnter={(e) => e.currentTarget.style.background = 'var(--background-hover, #f8f9fa)'}
                                    onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                                    >
                                        <td style={{ padding: '15px' }}>{pir.displayName || 'N/A'}</td>
                                        <td style={{ padding: '15px', color: 'var(--text-secondary, #666)' }}>{pir.email}</td>
                                        <td style={{ padding: '15px', textAlign: 'center', fontWeight: 'bold' }}>
                                            {pir.sobrietyDays || 0} days
                                        </td>
                                        <td style={{ padding: '15px', textAlign: 'center', color: 'var(--text-secondary, #666)', fontSize: '14px' }}>
                                            {pir.lastCheckIn ? formatDateTime(pir.lastCheckIn) : 'Never'}
                                        </td>
                                        <td style={{ padding: '15px', textAlign: 'center' }}>
                                            <span className={`badge badge-${pir.active ? 'success' : 'danger'}`}>
                                                {pir.active ? 'Active' : 'Inactive'}
                                            </span>
                                        </td>
                                        <td style={{ padding: '15px', textAlign: 'center' }}>
                                            <button
                                                className="btn btn-sm btn-secondary"
                                                onClick={() => handleViewPIR(pir.id)}
                                                style={{
                                                    background: 'linear-gradient(135deg, var(--secondary-color, #008B8B), var(--secondary-dark, #006666))',
                                                    color: 'var(--text-white, white)',
                                                    border: 'none',
                                                    padding: '6px 12px',
                                                    borderRadius: 'var(--radius-sm, 8px)',
                                                    marginRight: '8px',
                                                    cursor: 'pointer',
                                                    fontSize: '13px',
                                                    fontWeight: '500'
                                                }}
                                            >
                                                👁️ View PIR
                                            </button>
                                            
                                            {currentUser?.role === 'superadmin' && (
                                                <button
                                                    className="btn btn-sm btn-danger"
                                                    onClick={() => {
                                                        setSelectedPIRForRemoval({ id: pir.id, name: pir.displayName });
                                                        setShowRemovePIRModal(true);
                                                    }}
                                                    style={{
                                                        background: 'var(--danger-color, #dc3545)',
                                                        color: 'var(--text-white, white)',
                                                        border: 'none',
                                                        padding: '6px 12px',
                                                        borderRadius: 'var(--radius-sm, 8px)',
                                                        cursor: 'pointer',
                                                        fontSize: '13px',
                                                        fontWeight: '500'
                                                    }}
                                                >
                                                    Remove
                                                </button>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            ) : (
                <div className="empty-state" style={{
                    background: 'var(--text-white, white)',
                    borderRadius: 'var(--radius-lg, 16px)',
                    padding: '60px 40px',
                    textAlign: 'center',
                    boxShadow: 'var(--shadow-sm, 0 2px 4px rgba(0,0,0,0.05))'
                }}>
                    <div style={{ fontSize: '48px', marginBottom: '16px' }}>👥</div>
                    <h4 style={{ margin: '0 0 10px 0', color: 'var(--text-primary, #333)' }}>No PIRs Assigned</h4>
                    <p style={{ color: 'var(--text-secondary, #666)', marginBottom: '20px' }}>
                        This coach doesn't have any PIRs assigned yet.
                    </p>
                    {currentUser?.role === 'superadmin' && (
                        <button
                            className="btn btn-primary"
                            onClick={() => setShowAssignPIRModal(true)}
                            style={{
                                background: 'linear-gradient(135deg, var(--primary-color, #0077CC), var(--primary-dark, #005fa3))',
                                color: 'var(--text-white, white)',
                                border: 'none',
                                padding: '10px 24px',
                                borderRadius: 'var(--radius-sm, 8px)',
                                cursor: 'pointer',
                                fontWeight: '500'
                            }}
                        >
                            Assign First PIR
                        </button>
                    )}
                </div>
            )}
        </div>
    );
    
    // ========== RENDER: TRAINING & CREDENTIALS TAB ==========
    const renderTrainingTab = () => (
        <div className="tab-content" style={{ padding: '20px' }}>
            {/* Certifications Section */}
            <div style={{ marginBottom: '40px' }}>
                <div style={{
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    marginBottom: '20px'
                }}>
                    <h3 style={{color: 'var(--text-primary, #333)'}}>
                        🎓 Certifications ({certifications.length})
                    </h3>
                    
                    {currentUser?.role === 'superadmin' && (
                        <button
                            className="btn btn-primary"
                            onClick={() => setShowAddCertModal(true)}
                            style={{
                                background: 'linear-gradient(135deg, var(--primary-color, #0077CC), var(--primary-dark, #005fa3))',
                                color: 'var(--text-white, white)',
                                border: 'none',
                                padding: '10px 20px',
                                borderRadius: 'var(--radius-sm, 8px)',
                                cursor: 'pointer',
                                fontWeight: '500'
                            }}
                        >
                            + Add Certification
                        </button>
                    )}
                </div>
                
                {certifications.length > 0 ? (
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(350px, 1fr))', gap: '20px' }}>
                        {certifications.map(cert => {
                            const isExpired = cert.expirationDate && cert.expirationDate.toDate() < new Date();
                            const isExpiringSoon = cert.expirationDate && 
                                cert.expirationDate.toDate() > new Date() && 
                                cert.expirationDate.toDate() < new Date(Date.now() + 90 * 24 * 60 * 60 * 1000);
                            
                            return (
                                <div key={cert.id} style={{
                                    background: 'var(--text-white, white)',
                                    borderRadius: 'var(--radius-lg, 16px)',
                                    padding: '20px',
                                    boxShadow: 'var(--shadow-sm, 0 2px 4px rgba(0,0,0,0.05))',
                                    borderLeft: `4px solid ${isExpired ? 'var(--danger-color, #dc3545)' : isExpiringSoon ? 'var(--warning-color, #ffc107)' : 'var(--success-color, #28a745)'}`,
                                    transition: 'var(--transition-fast, all 0.2s ease)'
                                }}
                                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-3px)'}
                                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                                >
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '12px' }}>
                                        <h4 style={{ margin: 0, color: 'var(--text-primary, #333)', fontSize: '18px' }}>
                                            {cert.name}
                                        </h4>
                                        <span className={`badge badge-${isExpired ? 'danger' : isExpiringSoon ? 'warning' : 'success'}`}>
                                            {isExpired ? 'Expired' : isExpiringSoon ? 'Expiring Soon' : 'Active'}
                                        </span>
                                    </div>
                                    
                                    <div style={{ color: 'var(--text-secondary, #666)', fontSize: '14px', marginBottom: '8px' }}>
                                        <strong>Organization:</strong> {cert.organization}
                                    </div>
                                    
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', fontSize: '14px', color: 'var(--text-secondary, #666)' }}>
                                        <div>
                                            <strong>Obtained:</strong><br/>
                                            {formatDate(cert.dateObtained)}
                                        </div>
                                        {cert.expirationDate && (
                                            <div>
                                                <strong>Expires:</strong><br/>
                                                {formatDate(cert.expirationDate)}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                ) : (
                    <div className="empty-state" style={{
                        background: 'var(--text-white, white)',
                        borderRadius: 'var(--radius-lg, 16px)',
                        padding: '40px',
                        textAlign: 'center'
                    }}>
                        <div style={{ fontSize: '48px', marginBottom: '16px' }}>🎓</div>
                        <p style={{ color: 'var(--text-secondary, #666)' }}>No certifications added yet</p>
                    </div>
                )}
            </div>
            
            {/* Specializations Section */}
            <div style={{ marginBottom: '40px' }}>
                <h3 style={{color: 'var(--text-primary, #333)', marginBottom: '20px'}}>
                    ⭐ Specializations
                </h3>
                
                <div style={{
                    background: 'var(--text-white, white)',
                    borderRadius: 'var(--radius-lg, 16px)',
                    padding: '25px',
                    boxShadow: 'var(--shadow-sm, 0 2px 4px rgba(0,0,0,0.05))'
                }}>
                    {specializations.length > 0 ? (
                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '10px' }}>
                            {specializations.map(spec => (
                                <span key={spec.id} style={{
                                    background: 'linear-gradient(135deg, var(--primary-color, #0077CC), var(--secondary-color, #008B8B))',
                                    color: 'var(--text-white, white)',
                                    padding: '8px 16px',
                                    borderRadius: 'var(--radius-sm, 8px)',
                                    fontSize: '14px',
                                    fontWeight: '500'
                                }}>
                                    {spec.name}
                                </span>
                            ))}
                        </div>
                    ) : (
                        <p style={{ color: 'var(--text-secondary, #666)', textAlign: 'center', margin: 0 }}>
                            No specializations added yet
                        </p>
                    )}
                </div>
            </div>
            
            {/* Training History Section */}
            <div>
                <div style={{
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    marginBottom: '20px'
                }}>
                    <h3 style={{color: 'var(--text-primary, #333)'}}>
                        📚 Training History ({trainings.length})
                    </h3>
                    
                    {currentUser?.role === 'superadmin' && (
                        <button
                            className="btn btn-primary"
                            onClick={() => setShowAddTrainingModal(true)}
                            style={{
                                background: 'linear-gradient(135deg, var(--primary-color, #0077CC), var(--primary-dark, #005fa3))',
                                color: 'var(--text-white, white)',
                                border: 'none',
                                padding: '10px 20px',
                                borderRadius: 'var(--radius-sm, 8px)',
                                cursor: 'pointer',
                                fontWeight: '500'
                            }}
                        >
                            + Add Training
                        </button>
                    )}
                </div>
                
                {trainings.length > 0 ? (
                    <div style={{
                        background: 'var(--text-white, white)',
                        borderRadius: 'var(--radius-lg, 16px)',
                        boxShadow: 'var(--shadow-sm, 0 2px 4px rgba(0,0,0,0.05))',
                        overflow: 'hidden'
                    }}>
                        <div className="table-container">
                            <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                <thead>
                                    <tr style={{
                                        background: 'linear-gradient(135deg, var(--primary-color, #0077CC), var(--secondary-color, #008B8B))',
                                        color: 'var(--text-white, white)'
                                    }}>
                                        <th style={{ padding: '15px', textAlign: 'left' }}>Training Name</th>
                                        <th style={{ padding: '15px', textAlign: 'left' }}>Organization</th>
                                        <th style={{ padding: '15px', textAlign: 'center' }}>Type</th>
                                        <th style={{ padding: '15px', textAlign: 'center' }}>Hours</th>
                                        <th style={{ padding: '15px', textAlign: 'center' }}>Date Completed</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {trainings.map(training => (
                                        <tr key={training.id} style={{
                                            borderBottom: '1px solid var(--border-color, #e0e0e0)'
                                        }}>
                                            <td style={{ padding: '15px' }}>{training.name}</td>
                                            <td style={{ padding: '15px', color: 'var(--text-secondary, #666)' }}>{training.organization}</td>
                                            <td style={{ padding: '15px', textAlign: 'center' }}>
                                                <span className="badge badge-info">
                                                    {training.type}
                                                </span>
                                            </td>
                                            <td style={{ padding: '15px', textAlign: 'center', fontWeight: 'bold' }}>
                                                {training.hours} hrs
                                            </td>
                                            <td style={{ padding: '15px', textAlign: 'center', color: 'var(--text-secondary, #666)', fontSize: '14px' }}>
                                                {formatDate(training.dateCompleted)}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        
                        <div style={{
                            padding: '20px',
                            background: 'linear-gradient(135deg, var(--primary-color-light, rgba(0,119,204,0.1)), var(--secondary-color-light, rgba(0,139,139,0.1)))',
                            borderTop: '1px solid var(--border-color, #e0e0e0)'
                        }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <div>
                                    <strong style={{ color: 'var(--text-primary, #333)' }}>Total Training Hours:</strong>
                                </div>
                                <div style={{ fontSize: '24px', fontWeight: 'bold', color: 'var(--primary-color, #0077CC)' }}>
                                    {trainings.reduce((sum, t) => sum + (t.hours || 0), 0)} hours
                                </div>
                            </div>
                        </div>
                    </div>
                ) : (
                    <div className="empty-state" style={{
                        background: 'var(--text-white, white)',
                        borderRadius: 'var(--radius-lg, 16px)',
                        padding: '40px',
                        textAlign: 'center'
                    }}>
                        <div style={{ fontSize: '48px', marginBottom: '16px' }}>📚</div>
                        <p style={{ color: 'var(--text-secondary, #666)' }}>No training history added yet</p>
                    </div>
                )}
            </div>
        </div>
    );
    
    // ========== RENDER: WORKLOAD TAB ==========
    const renderWorkloadTab = () => {
        const maxRecommendedCaseload = 15;
        const capacityPercentage = (stats.totalPIRs / maxRecommendedCaseload) * 100;
        const isOverCapacity = stats.totalPIRs > maxRecommendedCaseload;
        
        return (
            <div className="tab-content" style={{ padding: '20px' }}>
                {/* Capacity Meter */}
                <div style={{
                    background: 'var(--text-white, white)',
                    borderRadius: 'var(--radius-lg, 16px)',
                    padding: '30px',
                    boxShadow: 'var(--shadow-sm, 0 2px 4px rgba(0,0,0,0.05))',
                    marginBottom: '30px'
                }}>
                    <h3 style={{ margin: '0 0 20px 0', color: 'var(--text-primary, #333)' }}>
                        Current Capacity
                    </h3>
                    
                    <div style={{ marginBottom: '20px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px' }}>
                            <span style={{ fontSize: '18px', fontWeight: 'bold', color: 'var(--text-primary, #333)' }}>
                                {stats.totalPIRs} / {maxRecommendedCaseload} PIRs
                            </span>
                            <span style={{ 
                                fontSize: '18px', 
                                fontWeight: 'bold',
                                color: isOverCapacity ? 'var(--danger-color, #dc3545)' : 'var(--success-color, #28a745)'
                            }}>
                                {Math.min(Math.round(capacityPercentage), 100)}%
                            </span>
                        </div>
                        
                        <div style={{
                            width: '100%',
                            height: '30px',
                            background: 'var(--background-light, #f0f0f0)',
                            borderRadius: 'var(--radius-sm, 8px)',
                            overflow: 'hidden',
                            position: 'relative'
                        }}>
                            <div style={{
                                width: `${Math.min(capacityPercentage, 100)}%`,
                                height: '100%',
                                background: isOverCapacity 
                                    ? 'linear-gradient(135deg, var(--danger-color, #dc3545), var(--error-color, #c82333))'
                                    : capacityPercentage > 80
                                    ? 'linear-gradient(135deg, var(--warning-color, #ffc107), var(--warning-dark, #e0a800))'
                                    : 'linear-gradient(135deg, var(--success-color, #28a745), var(--success-dark, #1e7e34))',
                                transition: 'width 0.5s ease',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                color: 'var(--text-white, white)',
                                fontWeight: 'bold',
                                fontSize: '14px'
                            }}>
                                {stats.totalPIRs > 0 && `${stats.totalPIRs} PIRs`}
                            </div>
                        </div>
                        
                        {isOverCapacity && (
                            <div style={{
                                marginTop: '15px',
                                padding: '12px 16px',
                                background: 'var(--danger-color-light, rgba(220,53,69,0.1))',
                                border: '1px solid var(--danger-color, #dc3545)',
                                borderRadius: 'var(--radius-sm, 8px)',
                                color: 'var(--danger-color, #dc3545)',
                                fontSize: '14px',
                                fontWeight: '500'
                            }}>
                                ⚠️ Warning: Coach is over recommended capacity. Consider redistributing PIRs.
                            </div>
                        )}
                    </div>
                </div>
                
                {/* Caseload Distribution */}
                <div style={{
                    background: 'var(--text-white, white)',
                    borderRadius: 'var(--radius-lg, 16px)',
                    padding: '30px',
                    boxShadow: 'var(--shadow-sm, 0 2px 4px rgba(0,0,0,0.05))',
                    marginBottom: '30px'
                }}>
                    <h3 style={{ margin: '0 0 20px 0', color: 'var(--text-primary, #333)' }}>
                        Caseload Distribution
                    </h3>
                    
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '15px' }}>
                        <div style={{
                            padding: '20px',
                            background: 'linear-gradient(135deg, var(--info-color, #17a2b8), var(--info-dark, #117a8b))',
                            borderRadius: 'var(--radius-md, 12px)',
                            color: 'var(--text-white, white)'
                        }}>
                            <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '8px' }}>New PIRs</div>
                            <div style={{ fontSize: '32px', fontWeight: 'bold' }}>
                                {assignedPIRs.filter(p => {
                                    if (!p.assignedDate) return false;
                                    const days = Math.floor((new Date() - p.assignedDate.toDate()) / (1000 * 60 * 60 * 24));
                                    return days < 30;
                                }).length}
                            </div>
                            <div style={{ fontSize: '12px', opacity: 0.8 }}>{'< 30 days'}</div>
                        </div>
                        
                        <div style={{
                            padding: '20px',
                            background: 'linear-gradient(135deg, var(--success-color, #28a745), var(--success-dark, #1e7e34))',
                            borderRadius: 'var(--radius-md, 12px)',
                            color: 'var(--text-white, white)'
                        }}>
                            <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '8px' }}>Stable PIRs</div>
                            <div style={{ fontSize: '32px', fontWeight: 'bold' }}>
                                {assignedPIRs.filter(p => {
                                    if (!p.assignedDate) return false;
                                    const days = Math.floor((new Date() - p.assignedDate.toDate()) / (1000 * 60 * 60 * 24));
                                    return days >= 30 && days <= 90;
                                }).length}
                            </div>
                            <div style={{ fontSize: '12px', opacity: 0.8 }}>30-90 days</div>
                        </div>
                        
                        <div style={{
                            padding: '20px',
                            background: 'linear-gradient(135deg, var(--primary-color, #0077CC), var(--primary-dark, #005fa3))',
                            borderRadius: 'var(--radius-md, 12px)',
                            color: 'var(--text-white, white)'
                        }}>
                            <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '8px' }}>Long-term PIRs</div>
                            <div style={{ fontSize: '32px', fontWeight: 'bold' }}>
                                {assignedPIRs.filter(p => {
                                    if (!p.assignedDate) return false;
                                    const days = Math.floor((new Date() - p.assignedDate.toDate()) / (1000 * 60 * 60 * 24));
                                    return days > 90;
                                }).length}
                            </div>
                            <div style={{ fontSize: '12px', opacity: 0.8 }}> {'> 90 days'}</div>
                        </div>
                    </div>
                </div>
                
                {/* Workload Summary */}
                <div style={{
                    background: 'var(--text-white, white)',
                    borderRadius: 'var(--radius-lg, 16px)',
                    padding: '30px',
                    boxShadow: 'var(--shadow-sm, 0 2px 4px rgba(0,0,0,0.05))'
                }}>
                    <h3 style={{ margin: '0 0 20px 0', color: 'var(--text-primary, #333)' }}>
                        Workload Summary
                    </h3>
                    
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
                        <div>
                            <label style={{ fontWeight: 'bold', color: 'var(--text-secondary, #666)', fontSize: '14px', display: 'block', marginBottom: '8px' }}>
                                Average Caseload Duration
                            </label>
                            <div style={{ fontSize: '24px', fontWeight: 'bold', color: 'var(--text-primary, #333)' }}>
                                {stats.avgCaseloadDays} days
                            </div>
                        </div>
                        
                        <div>
                            <label style={{ fontWeight: 'bold', color: 'var(--text-secondary, #666)', fontSize: '14px', display: 'block', marginBottom: '8px' }}>
                                Check-in Compliance Rate
                            </label>
                            <div style={{ fontSize: '24px', fontWeight: 'bold', color: stats.checkInComplianceRate >= 70 ? 'var(--success-color, #28a745)' : 'var(--warning-color, #ffc107)' }}>
                                {stats.checkInComplianceRate}%
                            </div>
                        </div>
                        
                        <div>
                            <label style={{ fontWeight: 'bold', color: 'var(--text-secondary, #666)', fontSize: '14px', display: 'block', marginBottom: '8px' }}>
                                Assignment Completion Rate
                            </label>
                            <div style={{ fontSize: '24px', fontWeight: 'bold', color: stats.assignmentCompletionRate >= 60 ? 'var(--success-color, #28a745)' : 'var(--warning-color, #ffc107)' }}>
                                {stats.assignmentCompletionRate}%
                            </div>
                        </div>
                        
                        <div>
                            <label style={{ fontWeight: 'bold', color: 'var(--text-secondary, #666)', fontSize: '14px', display: 'block', marginBottom: '8px' }}>
                                Alerts Handled
                            </label>
                            <div style={{ fontSize: '24px', fontWeight: 'bold', color: 'var(--text-primary, #333)' }}>
                                {stats.alertsHandled}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );
    };
    
    // ========== RENDER: ACTIVITY TAB ==========
    const renderActivityTab = () => (
        <div className="tab-content" style={{ padding: '20px' }}>
            <h3 style={{ margin: '0 0 20px 0', color: 'var(--text-primary, #333)' }}>
                Recent Activity
            </h3>
            
            {activities.length > 0 ? (
                <div style={{
                    background: 'var(--text-white, white)',
                    borderRadius: 'var(--radius-lg, 16px)',
                    boxShadow: 'var(--shadow-sm, 0 2px 4px rgba(0,0,0,0.05))',
                    overflow: 'hidden'
                }}>
                    {activities.map((activity, index) => (
                        <div key={activity.id} style={{
                            padding: '20px',
                            borderBottom: index < activities.length - 1 ? '1px solid var(--border-color, #e0e0e0)' : 'none',
                            display: 'flex',
                            alignItems: 'start',
                            gap: '15px',
                            transition: 'var(--transition-fast, all 0.2s ease)'
                        }}
                        onMouseEnter={(e) => e.currentTarget.style.background = 'var(--background-hover, #f8f9fa)'}
                        onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                        >
                            <div style={{
                                width: '40px',
                                height: '40px',
                                borderRadius: '50%',
                                background: 'linear-gradient(135deg, var(--primary-color, #0077CC), var(--secondary-color, #008B8B))',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                color: 'var(--text-white, white)',
                                fontWeight: 'bold',
                                flexShrink: 0
                            }}>
                                {activity.type === 'assignment' ? '📝' : 
                                 activity.type === 'session' ? '📅' :
                                 activity.type === 'alert' ? '🚨' : '📌'}
                            </div>
                            
                            <div style={{ flex: 1 }}>
                                <div style={{ fontWeight: 'bold', color: 'var(--text-primary, #333)', marginBottom: '4px' }}>
                                    {activity.title || activity.description}
                                </div>
                                <div style={{ color: 'var(--text-secondary, #666)', fontSize: '14px' }}>
                                    {formatDateTime(activity.timestamp)}
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            ) : (
                <div className="empty-state" style={{
                    background: 'var(--text-white, white)',
                    borderRadius: 'var(--radius-lg, 16px)',
                    padding: '60px 40px',
                    textAlign: 'center'
                }}>
                    <div style={{ fontSize: '48px', marginBottom: '16px' }}>📅</div>
                    <h4 style={{ margin: '0 0 10px 0', color: 'var(--text-primary, #333)' }}>No Recent Activity</h4>
                    <p style={{ color: 'var(--text-secondary, #666)' }}>
                        No recent activity to display
                    </p>
                </div>
            )}
        </div>
    );
    
    // ========== RENDER: ACTIONS TAB (ADMIN ONLY) ==========
    const renderActionsTab = () => {
        if (currentUser?.role !== 'superadmin') {
            return (
                <div className="tab-content" style={{ padding: '20px' }}>
                    <div className="empty-state" style={{
                        background: 'var(--text-white, white)',
                        borderRadius: 'var(--radius-lg, 16px)',
                        padding: '60px 40px',
                        textAlign: 'center'
                    }}>
                        <div style={{ fontSize: '48px', marginBottom: '16px' }}>🔒</div>
                        <h4 style={{ margin: '0 0 10px 0', color: 'var(--text-primary, #333)' }}>Access Restricted</h4>
                        <p style={{ color: 'var(--text-secondary, #666)' }}>
                            Only super admins can access this section
                        </p>
                    </div>
                </div>
            );
        }
        
        return (
            <div className="tab-content" style={{ padding: '20px' }}>
                <h3 style={{ margin: '0 0 20px 0', color: 'var(--text-primary, #333)' }}>
                    Administrative Actions
                </h3>
                
                <div style={{ display: 'grid', gap: '20px' }}>
                    {/* Activate/Deactivate Account */}
                    <div style={{
                        background: 'var(--text-white, white)',
                        borderRadius: 'var(--radius-lg, 16px)',
                        padding: '25px',
                        boxShadow: 'var(--shadow-sm, 0 2px 4px rgba(0,0,0,0.05))'
                    }}>
                        <h4 style={{ margin: '0 0 10px 0', color: 'var(--text-primary, #333)' }}>
                            Account Status
                        </h4>
                        <p style={{ color: 'var(--text-secondary, #666)', marginBottom: '15px' }}>
                            {coachProfile?.active 
                                ? 'Deactivating will prevent this coach from logging in'
                                : 'Activating will allow this coach to log in'}
                        </p>
                        <button
                            onClick={handleToggleActiveStatus}
                            disabled={saving}
                            style={{
                                background: coachProfile?.active 
                                    ? 'linear-gradient(135deg, var(--warning-color, #ffc107), var(--warning-dark, #e0a800))'
                                    : 'linear-gradient(135deg, var(--success-color, #28a745), var(--success-dark, #1e7e34))',
                                color: 'var(--text-white, white)',
                                border: 'none',
                                padding: '12px 24px',
                                borderRadius: 'var(--radius-sm, 8px)',
                                cursor: saving ? 'not-allowed' : 'pointer',
                                fontWeight: '500',
                                fontSize: '15px'
                            }}
                        >
                            {saving ? 'Processing...' : coachProfile?.active ? 'Deactivate Account' : 'Activate Account'}
                        </button>
                    </div>
                    
                    {/* Delete Account */}
                    {!coachProfile?.deleted && (
                        <div style={{
                            background: 'var(--text-white, white)',
                            borderRadius: 'var(--radius-lg, 16px)',
                            padding: '25px',
                            boxShadow: 'var(--shadow-sm, 0 2px 4px rgba(0,0,0,0.05))',
                            border: '2px solid var(--danger-color, #dc3545)'
                        }}>
                            <h4 style={{ margin: '0 0 10px 0', color: 'var(--danger-color, #dc3545)' }}>
                                ⚠️ Danger Zone
                            </h4>
                            <p style={{ color: 'var(--text-secondary, #666)', marginBottom: '15px' }}>
                                Deleting this coach will soft-delete the account. Data will be preserved for compliance but the account cannot be recovered.
                            </p>
                            <button
                                onClick={() => setShowDeleteConfirmModal(true)}
                                style={{
                                    background: 'var(--danger-color, #dc3545)',
                                    color: 'var(--text-white, white)',
                                    border: 'none',
                                    padding: '12px 24px',
                                    borderRadius: 'var(--radius-sm, 8px)',
                                    cursor: 'pointer',
                                    fontWeight: '500',
                                    fontSize: '15px'
                                }}
                            >
                                Delete Coach Account
                            </button>
                        </div>
                    )}
                    
                    {/* Permission Level (for admins) */}
                    {coachProfile?.role === 'admin' && (
                        <div style={{
                            background: 'var(--text-white, white)',
                            borderRadius: 'var(--radius-lg, 16px)',
                            padding: '25px',
                            boxShadow: 'var(--shadow-sm, 0 2px 4px rgba(0,0,0,0.05))'
                        }}>
                            <h4 style={{ margin: '0 0 10px 0', color: 'var(--text-primary, #333)' }}>
                                Permission Level
                            </h4>
                            <p style={{ color: 'var(--text-secondary, #666)', marginBottom: '15px' }}>
                                Current permission level: <strong>{formatPermissionLevel(coachProfile.permissionLevel || 'admin')}</strong>
                            </p>
                            <p style={{ color: 'var(--text-muted, #999)', fontSize: '14px', fontStyle: 'italic' }}>
                                Permission level management will be available after settings integration is complete
                            </p>
                        </div>
                    )}
                </div>
            </div>
        );
    };
    
    // ========== MAIN RENDER ==========
    if (!coach || !coach.id) {
        return null;
    }
    
    return (
        <div className="modal-overlay" onClick={onClose}>
            <div className="modal-content" style={{ maxWidth: '1200px', maxHeight: '90vh' }} onClick={(e) => e.stopPropagation()}>
                <div className="modal-header" style={{
                    background: 'linear-gradient(135deg, var(--primary-color, #0077CC), var(--secondary-color, #008B8B))',
                    color: 'var(--text-white, white)',
                    padding: '20px 30px',
                    borderRadius: '16px 16px 0 0'
                }}>
                    <div>
                        <h2 style={{ margin: '0 0 5px 0' }}>
                            {coachProfile?.displayName || coach.email}
                        </h2>
                        <p style={{ margin: 0, opacity: 0.9, fontSize: '14px' }}>
                            {formatRole(coach.role)} • {coach.email}
                        </p>
                    </div>
                    <button className="close-btn" onClick={onClose} style={{
                        background: 'var(--text-white, white)',
                        color: 'var(--primary-color, #0077CC)',
                        border: 'none',
                        fontSize: '24px',
                        width: '36px',
                        height: '36px',
                        borderRadius: '50%',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontWeight: 'bold'
                    }}>×</button>
                </div>
                
                {/* Success Message */}
                {successMessage && (
                    <div style={{
                        position: 'fixed',
                        top: '20px',
                        right: '20px',
                        background: 'linear-gradient(135deg, var(--success-color, #28a745), var(--success-dark, #1e7e34))',
                        color: 'var(--text-white, white)',
                        padding: '15px 25px',
                        borderRadius: 'var(--radius-md, 12px)',
                        boxShadow: 'var(--shadow-lg, 0 10px 25px rgba(0,0,0,0.2))',
                        fontWeight: '500',
                        zIndex: 10000,
                        animation: 'slideIn 0.3s ease'
                    }}>
                        {successMessage}
                    </div>
                )}
                
                {coach.role === 'coach' || coach.role === 'admin' ? (
                    <>
                        {/* Tabs */}
                        <div style={{
                            display: 'flex',
                            gap: '5px',
                            padding: '15px 20px 0',
                            borderBottom: '2px solid var(--border-color, #e0e0e0)',
                            overflowX: 'auto'
                        }}>
                            <button 
                                className={`tab-btn ${activeTab === 'overview' ? 'active' : ''}`}
                                onClick={() => setActiveTab('overview')}
                                style={{
                                    background: activeTab === 'overview' 
                                        ? 'linear-gradient(135deg, var(--primary-color, #0077CC), var(--secondary-color, #008B8B))'
                                        : 'transparent',
                                    color: activeTab === 'overview' ? 'var(--text-white, white)' : 'var(--text-secondary, #666)',
                                    border: 'none',
                                    padding: '12px 24px',
                                    borderRadius: 'var(--radius-sm, 8px) var(--radius-sm, 8px) 0 0',
                                    cursor: 'pointer',
                                    fontWeight: '500',
                                    transition: 'var(--transition-fast, all 0.2s ease)',
                                    whiteSpace: 'nowrap'
                                }}
                            >
                                Overview
                            </button>
                            <button 
                                className={`tab-btn ${activeTab === 'caseload' ? 'active' : ''}`}
                                onClick={() => setActiveTab('caseload')}
                                style={{
                                    background: activeTab === 'caseload' 
                                        ? 'linear-gradient(135deg, var(--primary-color, #0077CC), var(--secondary-color, #008B8B))'
                                        : 'transparent',
                                    color: activeTab === 'caseload' ? 'var(--text-white, white)' : 'var(--text-secondary, #666)',
                                    border: 'none',
                                    padding: '12px 24px',
                                    borderRadius: 'var(--radius-sm, 8px) var(--radius-sm, 8px) 0 0',
                                    cursor: 'pointer',
                                    fontWeight: '500',
                                    transition: 'var(--transition-fast, all 0.2s ease)',
                                    whiteSpace: 'nowrap'
                                }}
                            >
                                Caseload
                            </button>
                            <button 
                                className={`tab-btn ${activeTab === 'training' ? 'active' : ''}`}
                                onClick={() => setActiveTab('training')}
                                style={{
                                    background: activeTab === 'training' 
                                        ? 'linear-gradient(135deg, var(--primary-color, #0077CC), var(--secondary-color, #008B8B))'
                                        : 'transparent',
                                    color: activeTab === 'training' ? 'var(--text-white, white)' : 'var(--text-secondary, #666)',
                                    border: 'none',
                                    padding: '12px 24px',
                                    borderRadius: 'var(--radius-sm, 8px) var(--radius-sm, 8px) 0 0',
                                    cursor: 'pointer',
                                    fontWeight: '500',
                                    transition: 'var(--transition-fast, all 0.2s ease)',
                                    whiteSpace: 'nowrap'
                                }}
                            >
                                Training & Credentials
                            </button>
                            <button 
                                className={`tab-btn ${activeTab === 'workload' ? 'active' : ''}`}
                                onClick={() => setActiveTab('workload')}
                                style={{
                                    background: activeTab === 'workload' 
                                        ? 'linear-gradient(135deg, var(--primary-color, #0077CC), var(--secondary-color, #008B8B))'
                                        : 'transparent',
                                    color: activeTab === 'workload' ? 'var(--text-white, white)' : 'var(--text-secondary, #666)',
                                    border: 'none',
                                    padding: '12px 24px',
                                    borderRadius: 'var(--radius-sm, 8px) var(--radius-sm, 8px) 0 0',
                                    cursor: 'pointer',
                                    fontWeight: '500',
                                    transition: 'var(--transition-fast, all 0.2s ease)',
                                    whiteSpace: 'nowrap'
                                }}
                            >
                                Workload
                            </button>
                            <button 
                                className={`tab-btn ${activeTab === 'activity' ? 'active' : ''}`}
                                onClick={() => setActiveTab('activity')}
                                style={{
                                    background: activeTab === 'activity' 
                                        ? 'linear-gradient(135deg, var(--primary-color, #0077CC), var(--secondary-color, #008B8B))'
                                        : 'transparent',
                                    color: activeTab === 'activity' ? 'var(--text-white, white)' : 'var(--text-secondary, #666)',
                                    border: 'none',
                                    padding: '12px 24px',
                                    borderRadius: 'var(--radius-sm, 8px) var(--radius-sm, 8px) 0 0',
                                    cursor: 'pointer',
                                    fontWeight: '500',
                                    transition: 'var(--transition-fast, all 0.2s ease)',
                                    whiteSpace: 'nowrap'
                                }}
                            >
                                Activity
                            </button>
                            {currentUser?.role === 'superadmin' && (
                                <button 
                                    className={`tab-btn ${activeTab === 'actions' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('actions')}
                                    style={{
                                        background: activeTab === 'actions' 
                                            ? 'linear-gradient(135deg, var(--danger-color, #dc3545), var(--error-color, #c82333))'
                                            : 'transparent',
                                        color: activeTab === 'actions' ? 'var(--text-white, white)' : 'var(--text-secondary, #666)',
                                        border: 'none',
                                        padding: '12px 24px',
                                        borderRadius: 'var(--radius-sm, 8px) var(--radius-sm, 8px) 0 0',
                                        cursor: 'pointer',
                                        fontWeight: '500',
                                        transition: 'var(--transition-fast, all 0.2s ease)',
                                        whiteSpace: 'nowrap'
                                    }}
                                >
                                    Actions
                                </button>
                            )}
                        </div>
                        
                        {/* Tab Content */}
                        <div className="modal-body" style={{ maxHeight: '600px', overflowY: 'auto' }}>
                            {loading ? (
                                <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '400px' }}>
                                    <div className="loading-spinner"></div>
                                </div>
                            ) : (
                                <>
                                    {activeTab === 'overview' && renderOverviewTab()}
                                    {activeTab === 'caseload' && renderCaseloadTab()}
                                    {activeTab === 'training' && renderTrainingTab()}
                                    {activeTab === 'workload' && renderWorkloadTab()}
                                    {activeTab === 'activity' && renderActivityTab()}
                                    {activeTab === 'actions' && renderActionsTab()}
                                </>
                            )}
                        </div>
                    </>
                ) : (
                    <div className="modal-body" style={{ padding: '40px', textAlign: 'center' }}>
                        <div style={{ fontSize: '48px', marginBottom: '16px' }}>👤</div>
                        <p style={{ color: 'var(--text-secondary, #666)' }}>
                            This user is not a coach or admin.
                        </p>
                    </div>
                )}
            </div>
            
            {/* Assign PIR Modal */}
            {showAssignPIRModal && (
                <div className="modal-overlay" onClick={() => setShowAssignPIRModal(false)}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '600px' }}>
                        <div className="modal-header" style={{
                            background: 'linear-gradient(135deg, var(--primary-color, #0077CC), var(--secondary-color, #008B8B))',
                            color: 'var(--text-white, white)'
                        }}>
                            <h3 style={{ margin: 0 }}>Assign PIR to Coach</h3>
                            <button className="close-btn" onClick={() => setShowAssignPIRModal(false)} style={{
                                background: 'var(--text-white, white)',
                                color: 'var(--primary-color, #0077CC)',
                                border: 'none',
                                fontSize: '24px',
                                width: '32px',
                                height: '32px',
                                borderRadius: '50%',
                                cursor: 'pointer'
                            }}>×</button>
                        </div>
                        <div className="modal-body" style={{ padding: '25px' }}>
                            <div className="form-group" style={{ marginBottom: '20px' }}>
                                <label style={{ fontWeight: 'bold', color: 'var(--text-secondary, #666)', display: 'block', marginBottom: '8px' }}>
                                    Search PIR by Email
                                </label>
                                <input
                                    type="email"
                                    className="form-control"
                                    placeholder="Enter PIR email..."
                                    value={assignPIRForm.email}
                                    onChange={(e) => handleSearchPIR(e.target.value)}
                                    style={{
                                        width: '100%',
                                        padding: '10px',
                                        border: '1px solid var(--border-color, #ddd)',
                                        borderRadius: 'var(--radius-sm, 8px)',
                                        fontSize: '14px'
                                    }}
                                />
                                <small style={{color: 'var(--text-muted, #666)', fontSize: '13px', display: 'block', marginTop: '6px'}}>
                                    Type at least 3 characters to search for unassigned PIRs
                                </small>
                            </div>
                            
                            {assignPIRError && (
                                <div style={{
                                    background: 'var(--error-color, #dc3545)',
                                    color: 'var(--text-white, white)',
                                    padding: '12px 20px',
                                    borderRadius: 'var(--radius-sm, 8px)',
                                    marginBottom: '15px',
                                    fontWeight: '500'
                                }}>
                                    ✗ {assignPIRError}
                                </div>
                            )}
                            
                            {assignPIRForm.searchResults.length > 0 && (
                                <div style={{marginTop: '20px'}}>
                                    <h5 style={{ marginBottom: '10px', color: 'var(--text-primary, #333)' }}>Search Results</h5>
                                    <div style={{
                                        border: '1px solid var(--border-color, #ddd)',
                                        borderRadius: 'var(--radius-sm, 8px)',
                                        overflow: 'hidden'
                                    }}>
                                        {assignPIRForm.searchResults.map(pir => (
                                            <div key={pir.id} style={{
                                                display: 'flex',
                                                justifyContent: 'space-between',
                                                alignItems: 'center',
                                                padding: '12px 15px',
                                                borderBottom: '1px solid var(--border-color, #e0e0e0)'
                                            }}>
                                                <div>
                                                    <div style={{ fontWeight: 'bold', color: 'var(--text-primary, #333)' }}>
                                                        {pir.displayName || 'N/A'}
                                                    </div>
                                                    <div style={{ fontSize: '13px', color: 'var(--text-secondary, #666)' }}>
                                                        {pir.email}
                                                    </div>
                                                </div>
                                                <button
                                                    className="btn btn-primary btn-sm"
                                                    onClick={() => handleAssignPIR(pir.id, pir.displayName || pir.email)}
                                                    disabled={assigning}
                                                    style={{
                                                        background: 'linear-gradient(135deg, var(--primary-color, #0077CC), var(--primary-dark, #005fa3))',
                                                        color: 'var(--text-white, white)',
                                                        border: 'none',
                                                        padding: '6px 16px',
                                                        borderRadius: 'var(--radius-sm, 8px)',
                                                        cursor: assigning ? 'not-allowed' : 'pointer',
                                                        fontWeight: '500',
                                                        fontSize: '13px'
                                                    }}
                                                >
                                                    {assigning ? 'Assigning...' : 'Assign'}
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            
                            {assignPIRForm.email.length >= 3 && assignPIRForm.searchResults.length === 0 && (
                                <div className="empty-state" style={{
                                    padding: '30px',
                                    textAlign: 'center',
                                    background: 'var(--background-light, #f8f9fa)',
                                    borderRadius: 'var(--radius-sm, 8px)',
                                    marginTop: '20px'
                                }}>
                                    No unassigned PIRs found matching "{assignPIRForm.email}"
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            )}
            
            {/* Remove PIR Confirmation Modal */}
            {showRemovePIRModal && selectedPIRForRemoval && (
                <div className="modal-overlay" onClick={() => setShowRemovePIRModal(false)}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{maxWidth: '500px'}}>
                        <div className="modal-header" style={{
                            background: 'linear-gradient(135deg, var(--danger-color, #dc3545), var(--error-color, #c82333))',
                            color: 'var(--text-white, white)'
                        }}>
                            <h3 style={{ margin: 0 }}>Confirm Remove PIR</h3>
                            <button className="close-btn" onClick={() => setShowRemovePIRModal(false)} style={{
                                background: 'var(--text-white, white)',
                                color: 'var(--danger-color, #dc3545)',
                                border: 'none',
                                fontSize: '24px',
                                width: '32px',
                                height: '32px',
                                borderRadius: '50%',
                                cursor: 'pointer'
                            }}>×</button>
                        </div>
                        <div className="modal-body" style={{ padding: '25px' }}>
                            <p style={{marginBottom: '20px', color: 'var(--text-primary, #333)'}}>
                                Are you sure you want to remove <strong>{selectedPIRForRemoval.name}</strong> from this coach's caseload?
                            </p>
                            <p style={{color: 'var(--text-muted, #666)', fontSize: '14px'}}>
                                The PIR will become unassigned and can be assigned to another coach.
                            </p>
                            <div style={{display: 'flex', gap: '10px', marginTop: '20px', justifyContent: 'flex-end'}}>
                                <button
                                    className="btn btn-secondary"
                                    onClick={() => {
                                        setShowRemovePIRModal(false);
                                        setSelectedPIRForRemoval(null);
                                    }}
                                    disabled={removing}
                                    style={{
                                        background: 'var(--text-muted, #6c757d)',
                                        color: 'var(--text-white, white)',
                                        border: 'none',
                                        padding: '10px 20px',
                                        borderRadius: 'var(--radius-sm, 8px)',
                                        cursor: 'pointer',
                                        fontWeight: '500'
                                    }}
                                >
                                    Cancel
                                </button>
                                <button
                                    className="btn btn-danger"
                                    onClick={handleRemovePIR}
                                    disabled={removing}
                                    style={{
                                        background: 'var(--danger-color, #dc3545)',
                                        color: 'var(--text-white, white)',
                                        border: 'none',
                                        padding: '10px 20px',
                                        borderRadius: 'var(--radius-sm, 8px)',
                                        cursor: removing ? 'not-allowed' : 'pointer',
                                        fontWeight: '500'
                                    }}
                                >
                                    {removing ? 'Removing...' : 'Remove PIR'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}
            
            {/* Delete Coach Confirmation Modal */}
            {showDeleteConfirmModal && (
                <div className="modal-overlay" onClick={() => setShowDeleteConfirmModal(false)}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{maxWidth: '500px'}}>
                        <div className="modal-header" style={{
                            background: 'linear-gradient(135deg, var(--danger-color, #dc3545), var(--error-color, #c82333))',
                            color: 'var(--text-white, white)'
                        }}>
                            <h3 style={{ margin: 0 }}>⚠️ Confirm Delete</h3>
                            <button className="close-btn" onClick={() => setShowDeleteConfirmModal(false)} style={{
                                background: 'var(--text-white, white)',
                                color: 'var(--danger-color, #dc3545)',
                                border: 'none',
                                fontSize: '24px',
                                width: '32px',
                                height: '32px',
                                borderRadius: '50%',
                                cursor: 'pointer'
                            }}>×</button>
                        </div>
                        <div className="modal-body" style={{ padding: '25px' }}>
                            <p style={{marginBottom: '20px', color: 'var(--text-primary, #333)', fontWeight: 'bold'}}>
                                Are you sure you want to delete <strong>{coachProfile?.displayName}</strong>'s account?
                            </p>
                            <div style={{
                                background: 'var(--danger-color-light, rgba(220,53,69,0.1))',
                                padding: '15px',
                                borderRadius: 'var(--radius-sm, 8px)',
                                marginBottom: '20px',
                                border: '1px solid var(--danger-color, #dc3545)'
                            }}>
                                <p style={{margin: '0 0 10px 0', color: 'var(--danger-color, #dc3545)', fontWeight: 'bold'}}>
                                    This action will:
                                </p>
                                <ul style={{margin: 0, paddingLeft: '20px', color: 'var(--text-primary, #333)'}}>
                                    <li>Soft delete the account (data preserved)</li>
                                    <li>Prevent login access</li>
                                    <li>Unassign all PIRs</li>
                                    <li>Cannot be undone</li>
                                </ul>
                            </div>
                            <div style={{display: 'flex', gap: '10px', justifyContent: 'flex-end'}}>
                                <button
                                    className="btn btn-secondary"
                                    onClick={() => setShowDeleteConfirmModal(false)}
                                    disabled={saving}
                                    style={{
                                        background: 'var(--text-muted, #6c757d)',
                                        color: 'var(--text-white, white)',
                                        border: 'none',
                                        padding: '10px 20px',
                                        borderRadius: 'var(--radius-sm, 8px)',
                                        cursor: 'pointer',
                                        fontWeight: '500'
                                    }}
                                >
                                    Cancel
                                </button>
                                <button
                                    className="btn btn-danger"
                                    onClick={handleDeleteCoach}
                                    disabled={saving}
                                    style={{
                                        background: 'var(--danger-color, #dc3545)',
                                        color: 'var(--text-white, white)',
                                        border: 'none',
                                        padding: '10px 20px',
                                        borderRadius: 'var(--radius-sm, 8px)',
                                        cursor: saving ? 'not-allowed' : 'pointer',
                                        fontWeight: '500'
                                    }}
                                >
                                    {saving ? 'Deleting...' : 'Yes, Delete Account'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}
            
            {/* Add Certification Modal */}
            {showAddCertModal && (
                <div className="modal-overlay" onClick={() => setShowAddCertModal(false)}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{maxWidth: '600px'}}>
                        <div className="modal-header" style={{
                            background: 'linear-gradient(135deg, var(--primary-color, #0077CC), var(--secondary-color, #008B8B))',
                            color: 'var(--text-white, white)'
                        }}>
                            <h3 style={{ margin: 0 }}>Add Certification</h3>
                            <button className="close-btn" onClick={() => setShowAddCertModal(false)} style={{
                                background: 'var(--text-white, white)',
                                color: 'var(--primary-color, #0077CC)',
                                border: 'none',
                                fontSize: '24px',
                                width: '32px',
                                height: '32px',
                                borderRadius: '50%',
                                cursor: 'pointer'
                            }}>×</button>
                        </div>
                        <div className="modal-body" style={{ padding: '25px' }}>
                            {certError && (
                                <div style={{
                                    background: 'var(--error-color, #dc3545)',
                                    color: 'var(--text-white, white)',
                                    padding: '12px 20px',
                                    borderRadius: 'var(--radius-sm, 8px)',
                                    marginBottom: '15px',
                                    fontWeight: '500'
                                }}>
                                    ✗ {certError}
                                </div>
                            )}
                            
                            <div className="form-group" style={{ marginBottom: '20px' }}>
                                <label style={{ fontWeight: 'bold', color: 'var(--text-secondary, #666)', display: 'block', marginBottom: '8px' }}>
                                    Certification Name *
                                </label>
                                <input
                                    type="text"
                                    className="form-control"
                                    placeholder="e.g., CADC, LADC, NAADAC"
                                    value={newCertification.name}
                                    onChange={(e) => setNewCertification({...newCertification, name: e.target.value})}
                                    style={{
                                        width: '100%',
                                        padding: '10px',
                                        border: '1px solid var(--border-color, #ddd)',
                                        borderRadius: 'var(--radius-sm, 8px)',
                                        fontSize: '14px'
                                    }}
                                />
                            </div>
                            
                            <div className="form-group" style={{ marginBottom: '20px' }}>
                                <label style={{ fontWeight: 'bold', color: 'var(--text-secondary, #666)', display: 'block', marginBottom: '8px' }}>
                                    Issuing Organization *
                                </label>
                                <input
                                    type="text"
                                    className="form-control"
                                    placeholder="e.g., NAADAC, State Board"
                                    value={newCertification.organization}
                                    onChange={(e) => setNewCertification({...newCertification, organization: e.target.value})}
                                    style={{
                                        width: '100%',
                                        padding: '10px',
                                        border: '1px solid var(--border-color, #ddd)',
                                        borderRadius: 'var(--radius-sm, 8px)',
                                        fontSize: '14px'
                                    }}
                                />
                            </div>
                            
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px', marginBottom: '20px' }}>
                                <div className="form-group">
                                    <label style={{ fontWeight: 'bold', color: 'var(--text-secondary, #666)', display: 'block', marginBottom: '8px' }}>
                                        Date Obtained *
                                    </label>
                                    <input
                                        type="date"
                                        className="form-control"
                                        value={newCertification.dateObtained}
                                        onChange={(e) => setNewCertification({...newCertification, dateObtained: e.target.value})}
                                        style={{
                                            width: '100%',
                                            padding: '10px',
                                            border: '1px solid var(--border-color, #ddd)',
                                            borderRadius: 'var(--radius-sm, 8px)',
                                            fontSize: '14px'
                                        }}
                                    />
                                </div>
                                
                                <div className="form-group">
                                    <label style={{ fontWeight: 'bold', color: 'var(--text-secondary, #666)', display: 'block', marginBottom: '8px' }}>
                                        Expiration Date
                                    </label>
                                    <input
                                        type="date"
                                        className="form-control"
                                        value={newCertification.expirationDate}
                                        onChange={(e) => setNewCertification({...newCertification, expirationDate: e.target.value})}
                                        style={{
                                            width: '100%',
                                            padding: '10px',
                                            border: '1px solid var(--border-color, #ddd)',
                                            borderRadius: 'var(--radius-sm, 8px)',
                                            fontSize: '14px'
                                        }}
                                    />
                                </div>
                            </div>
                            
                            <div style={{display: 'flex', gap: '10px', justifyContent: 'flex-end'}}>
                                <button
                                    className="btn btn-secondary"
                                    onClick={() => {
                                        setShowAddCertModal(false);
                                        setNewCertification({
                                            name: '',
                                            organization: '',
                                            dateObtained: '',
                                            expirationDate: '',
                                            status: 'active'
                                        });
                                        setCertError('');
                                    }}
                                    disabled={saving}
                                    style={{
                                        background: 'var(--text-muted, #6c757d)',
                                        color: 'var(--text-white, white)',
                                        border: 'none',
                                        padding: '10px 20px',
                                        borderRadius: 'var(--radius-sm, 8px)',
                                        cursor: 'pointer',
                                        fontWeight: '500'
                                    }}
                                >
                                    Cancel
                                </button>
                                <button
                                    className="btn btn-primary"
                                    onClick={handleAddCertification}
                                    disabled={saving}
                                    style={{
                                        background: 'linear-gradient(135deg, var(--primary-color, #0077CC), var(--primary-dark, #005fa3))',
                                        color: 'var(--text-white, white)',
                                        border: 'none',
                                        padding: '10px 20px',
                                        borderRadius: 'var(--radius-sm, 8px)',
                                        cursor: saving ? 'not-allowed' : 'pointer',
                                        fontWeight: '500'
                                    }}
                                >
                                    {saving ? 'Adding...' : 'Add Certification'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}
            
            {/* Add Training Modal */}
            {showAddTrainingModal && (
                <div className="modal-overlay" onClick={() => setShowAddTrainingModal(false)}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{maxWidth: '600px'}}>
                        <div className="modal-header" style={{
                            background: 'linear-gradient(135deg, var(--primary-color, #0077CC), var(--secondary-color, #008B8B))',
                            color: 'var(--text-white, white)'
                        }}>
                            <h3 style={{ margin: 0 }}>Add Training</h3>
                            <button className="close-btn" onClick={() => setShowAddTrainingModal(false)} style={{
                                background: 'var(--text-white, white)',
                                color: 'var(--primary-color, #0077CC)',
                                border: 'none',
                                fontSize: '24px',
                                width: '32px',
                                height: '32px',
                                borderRadius: '50%',
                                cursor: 'pointer'
                            }}>×</button>
                        </div>
                        <div className="modal-body" style={{ padding: '25px' }}>
                            {certError && (
                                <div style={{
                                    background: 'var(--error-color, #dc3545)',
                                    color: 'var(--text-white, white)',
                                    padding: '12px 20px',
                                    borderRadius: 'var(--radius-sm, 8px)',
                                    marginBottom: '15px',
                                    fontWeight: '500'
                                }}>
                                    ✗ {certError}
                                </div>
                            )}
                            
                            <div className="form-group" style={{ marginBottom: '20px' }}>
                                <label style={{ fontWeight: 'bold', color: 'var(--text-secondary, #666)', display: 'block', marginBottom: '8px' }}>
                                    Training Name *
                                </label>
                                <input
                                    type="text"
                                    className="form-control"
                                    placeholder="e.g., Motivational Interviewing, CBT Workshop"
                                    value={newTraining.name}
                                    onChange={(e) => setNewTraining({...newTraining, name: e.target.value})}
                                    style={{
                                        width: '100%',
                                        padding: '10px',
                                        border: '1px solid var(--border-color, #ddd)',
                                        borderRadius: 'var(--radius-sm, 8px)',
                                        fontSize: '14px'
                                    }}
                                />
                            </div>
                            
                            <div className="form-group" style={{ marginBottom: '20px' }}>
                                <label style={{ fontWeight: 'bold', color: 'var(--text-secondary, #666)', display: 'block', marginBottom: '8px' }}>
                                    Organization *
                                </label>
                                <input
                                    type="text"
                                    className="form-control"
                                    placeholder="e.g., NAADAC, University Name"
                                    value={newTraining.organization}
                                    onChange={(e) => setNewTraining({...newTraining, organization: e.target.value})}
                                    style={{
                                        width: '100%',
                                        padding: '10px',
                                        border: '1px solid var(--border-color, #ddd)',
                                        borderRadius: 'var(--radius-sm, 8px)',
                                        fontSize: '14px'
                                    }}
                                />
                            </div>
                            
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '15px', marginBottom: '20px' }}>
                                <div className="form-group">
                                    <label style={{ fontWeight: 'bold', color: 'var(--text-secondary, #666)', display: 'block', marginBottom: '8px' }}>
                                        Date Completed *
                                    </label>
                                    <input
                                        type="date"
                                        className="form-control"
                                        value={newTraining.dateCompleted}
                                        onChange={(e) => setNewTraining({...newTraining, dateCompleted: e.target.value})}
                                        style={{
                                            width: '100%',
                                            padding: '10px',
                                            border: '1px solid var(--border-color, #ddd)',
                                            borderRadius: 'var(--radius-sm, 8px)',
                                            fontSize: '14px'
                                        }}
                                    />
                                </div>
                                
                                <div className="form-group">
                                    <label style={{ fontWeight: 'bold', color: 'var(--text-secondary, #666)', display: 'block', marginBottom: '8px' }}>
                                        Hours *
                                    </label>
                                    <input
                                        type="number"
                                        className="form-control"
                                        placeholder="0"
                                        value={newTraining.hours}
                                        onChange={(e) => setNewTraining({...newTraining, hours: e.target.value})}
                                        style={{
                                            width: '100%',
                                            padding: '10px',
                                            border: '1px solid var(--border-color, #ddd)',
                                            borderRadius: 'var(--radius-sm, 8px)',
                                            fontSize: '14px'
                                        }}
                                    />
                                </div>
                                
                                <div className="form-group">
                                    <label style={{ fontWeight: 'bold', color: 'var(--text-secondary, #666)', display: 'block', marginBottom: '8px' }}>
                                        Type
                                    </label>
                                    <select
                                        className="form-control"
                                        value={newTraining.type}
                                        onChange={(e) => setNewTraining({...newTraining, type: e.target.value})}
                                        style={{
                                            width: '100%',
                                            padding: '10px',
                                            border: '1px solid var(--border-color, #ddd)',
                                            borderRadius: 'var(--radius-sm, 8px)',
                                            fontSize: '14px'
                                        }}
                                    >
                                        <option value="course">Course</option>
                                        <option value="workshop">Workshop</option>
                                        <option value="conference">Conference</option>
                                        <option value="webinar">Webinar</option>
                                        <option value="certification">Certification</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style={{display: 'flex', gap: '10px', justifyContent: 'flex-end'}}>
                                <button
                                    className="btn btn-secondary"
                                    onClick={() => {
                                        setShowAddTrainingModal(false);
                                        setNewTraining({
                                            name: '',
                                            organization: '',
                                            dateCompleted: '',
                                            hours: 0,
                                            type: 'course'
                                        });
                                        setCertError('');
                                    }}
                                    disabled={saving}
                                    style={{
                                        background: 'var(--text-muted, #6c757d)',
                                        color: 'var(--text-white, white)',
                                        border: 'none',
                                        padding: '10px 20px',
                                        borderRadius: 'var(--radius-sm, 8px)',
                                        cursor: 'pointer',
                                        fontWeight: '500'
                                    }}
                                >
                                    Cancel
                                </button>
                                <button
                                    className="btn btn-primary"
                                    onClick={handleAddTraining}
                                    disabled={saving}
                                    style={{
                                        background: 'linear-gradient(135deg, var(--primary-color, #0077CC), var(--primary-dark, #005fa3))',
                                        color: 'var(--text-white, white)',
                                        border: 'none',
                                        padding: '10px 20px',
                                        borderRadius: 'var(--radius-sm, 8px)',
                                        cursor: saving ? 'not-allowed' : 'pointer',
                                        fontWeight: '500'
                                    }}
                                >
                                    {saving ? 'Adding...' : 'Add Training'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}
            
            {/* UserDetailModal for viewing PIR */}
            {showPIRDetailModal && selectedPIRId && (
                <UserDetailModal 
                    pirId={selectedPIRId}
                    onClose={() => {
                        setShowPIRDetailModal(false);
                        setSelectedPIRId(null);
                    }}
                />
            )}
        </div>
    );
}
 function GroupDetailModal({ group, onClose, onUpdate }) {
            const [addingMember, setAddingMember] = useState(false);
            const [newMemberEmail, setNewMemberEmail] = useState('');

            const addMember = async () => {
                if (!newMemberEmail) return;
                
                setAddingMember(true);
                try {
                    const userSnap = await db.collection('users')
                        .where('email', '==', newMemberEmail)
                        .get();
                    
                    if (userSnap.empty) {
                        alert('User not found');
                        return;
                    }
                    
                    const userId = userSnap.docs[0].id;
                    const members = group.members || [];
                    
                    if (members.includes(userId)) {
                        alert('User is already a member');
                        return;
                    }
                    
                    members.push(userId);
                    
                    await db.collection('groups').doc(group.id).update({
                        members: members
                    });
                    
                    alert('Member added successfully');
                    setNewMemberEmail('');
                    onUpdate();
                } catch (error) {
                    console.error('Error adding member:', error);
                    alert('Failed to add member');
                } finally {
                    setAddingMember(false);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">{group.name}</div>
                            <button className="modal-close" onClick={onClose}>×</button>
                        </div>
                        
                        <p style={{marginBottom: '20px', color: 'var(--text-secondary)'}}>{group.description}</p>

                        <div style={{marginBottom: '20px', color: 'var(--text-primary)'}}>
                            <strong>Schedule:</strong> {group.dayOfWeek} at {group.time}
                            {group.recurring && ' (Recurring)'}
                        </div>

                        {group.link && (
                            <div style={{marginBottom: '20px'}}>
                                <strong>Meeting Link:</strong>{' '}
                                <a href={group.link} target="_blank" rel="noopener noreferrer" style={{color: 'var(--primary-color)'}}>
                                    {group.link}
                                </a>
                            </div>
                        )}

                        <div style={{marginBottom: '20px'}}>
                            <h4 style={{marginBottom: '15px', color: 'var(--text-primary)'}}>Members ({group.membersData?.length || 0})</h4>

                            {group.membersData?.map(member => (
                                <div key={member.id} style={{
                                    padding: '10px',
                                    background: 'var(--bg-hover)',
                                    borderRadius: 'var(--radius-md)',
                                    marginBottom: '10px',
                                    color: 'var(--text-primary)'
                                }}>
                                    {member.name}
                                </div>
                            ))}

                            <div style={{display: 'flex', gap: '10px', marginTop: '15px'}}>
                                <input
                                    type="email"
                                    className="form-input"
                                    placeholder="Enter member email..."
                                    value={newMemberEmail}
                                    onChange={(e) => setNewMemberEmail(e.target.value)}
                                />
                                <button
                                    className="btn btn-primary"
                                    onClick={addMember}
                                    disabled={addingMember}
                                >
                                    {addingMember ? 'Adding...' : 'Add Member'}
                                </button>
                            </div>
                        </div>
                        
                        <button className="btn btn-secondary" onClick={onClose}>Close</button>
                    </div>
                </div>
            );
        }

      

       
    // Initialize App
        ReactDOM.render(<AdminApp />, document.getElementById('root'));
    </script>
</body>
</html>
