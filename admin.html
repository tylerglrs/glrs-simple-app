<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GLRS Admin Portal - Complete Command Center</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jsPDF for exports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
            min-height: 100vh;
            color: #e2e8f0;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Enhanced Sidebar */
        .sidebar {
            width: 280px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 20px;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #f4c430 0%, #ffd54f 100%);
            border-radius: 20px;
            color: #1a365d;
        }
        
        .logo {
            font-size: 36px;
        }
        
        .logo-text {
            font-size: 20px;
            font-weight: bold;
        }
        
        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .nav-section {
            margin-bottom: 25px;
        }
        
        .nav-section-title {
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 10px;
            padding-left: 10px;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.2s ease;
            width: 100%;
            font-size: 15px;
            text-align: left;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .nav-item.active {
            background: rgba(244, 196, 48, 0.2);
            color: #f4c430;
            border: 1px solid rgba(244, 196, 48, 0.3);
        }
        
        .nav-icon {
            font-size: 20px;
            width: 24px;
        }
        
        .nav-badge {
            margin-left: auto;
            background: #ff4757;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Header */
        .header {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .page-title {
            color: white;
            font-size: 28px;
            font-weight: bold;
        }
        
        .breadcrumb {
            display: flex;
            gap: 10px;
            align-items: center;
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .search-bar {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            padding: 8px 20px;
            width: 300px;
        }
        
        .search-bar input {
            background: transparent;
            border: none;
            color: white;
            flex: 1;
            outline: none;
            margin-left: 10px;
        }
        
        .search-bar input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .notification-btn {
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s ease;
        }
        
        .notification-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4757;
            color: white;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        /* Notifications Dropdown */
        .notifications-dropdown {
            position: absolute;
            top: 60px;
            right: 30px;
            width: 350px;
            background: rgba(26, 54, 93, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .notifications-header {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .notifications-title {
            font-weight: bold;
            color: white;
        }
        
        .mark-all-read {
            color: #f4c430;
            font-size: 13px;
            cursor: pointer;
        }
        
        .notifications-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .notification-item {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .notification-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .notification-item.unread {
            background: rgba(244, 196, 48, 0.05);
        }
        
        .admin-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            overflow: hidden;
        }
        
        .admin-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Content Area */
        .content-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }
        
        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .stat-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: white;
            margin-bottom: 10px;
        }
        
        .stat-change {
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .stat-change.positive {
            color: #00ff88;
        }
        
        .stat-change.negative {
            color: #ff4757;
        }
        
        /* Activity Feed */
        .activity-feed {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .feed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .feed-title {
            font-size: 20px;
            font-weight: bold;
            color: white;
        }
        
        .feed-filters {
            display: flex;
            gap: 10px;
        }
        
        .filter-btn {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .filter-btn.active {
            background: rgba(244, 196, 48, 0.2);
            border-color: #f4c430;
            color: #f4c430;
        }
        
        .activity-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .activity-item {
            display: flex;
            align-items: start;
            gap: 15px;
            padding: 15px;
            border-radius: 12px;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .activity-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .activity-icon.checkin {
            background: rgba(76, 175, 80, 0.2);
        }
        
        .activity-icon.message {
            background: rgba(33, 150, 243, 0.2);
        }
        
        .activity-icon.alert {
            background: rgba(255, 71, 87, 0.2);
        }
        
        .activity-icon.assignment {
            background: rgba(255, 152, 0, 0.2);
        }
        
        .activity-icon.feedback {
            background: rgba(156, 39, 176, 0.2);
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-title {
            color: white;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .activity-time {
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
        }
        
        .activity-action {
            padding: 6px 12px;
            background: rgba(244, 196, 48, 0.2);
            border: 1px solid #f4c430;
            color: #f4c430;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .activity-action:hover {
            background: rgba(244, 196, 48, 0.3);
        }
        
        /* User Grid */
        .user-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .user-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        .user-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            border-color: rgba(244, 196, 48, 0.3);
        }
        
        .user-status-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4caf50;
        }
        
        .user-status-indicator.inactive {
            background: #ff9800;
        }
        
        .user-status-indicator.alert {
            background: #ff4757;
        }
        
        .user-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            overflow: hidden;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            font-size: 18px;
            font-weight: bold;
            color: white;
            margin-bottom: 5px;
        }
        
        .user-role {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(244, 196, 48, 0.2);
            border-radius: 12px;
            color: #f4c430;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .user-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .user-stat {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .user-stat-value {
            font-size: 20px;
            font-weight: bold;
            color: white;
        }
        
        .user-stat-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            margin-top: 5px;
        }
        
        .user-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .user-action-btn {
            flex: 1;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 10px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .user-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* Message Center */
        .message-center {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            height: calc(100vh - 200px);
        }
        
        .conversation-list {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            overflow-y: auto;
        }
        
        .conversation-search {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 10px 15px;
            margin-bottom: 20px;
        }
        
        .conversation-search input {
            background: transparent;
            border: none;
            color: white;
            flex: 1;
            outline: none;
            margin-left: 10px;
        }
        
        .conversation-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 10px;
        }
        
        .conversation-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .conversation-item.active {
            background: rgba(244, 196, 48, 0.2);
            border: 1px solid rgba(244, 196, 48, 0.3);
        }
        
        .conversation-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .conversation-details {
            flex: 1;
            min-width: 0;
        }
        
        .conversation-name {
            color: white;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .conversation-preview {
            color: rgba(255, 255, 255, 0.6);
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .conversation-meta {
            text-align: right;
        }
        
        .conversation-time {
            color: rgba(255, 255, 255, 0.5);
            font-size: 11px;
            margin-bottom: 5px;
        }
        
        .unread-count {
            display: inline-block;
            background: #ff4757;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .chat-view {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chat-user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .chat-actions {
            display: flex;
            gap: 10px;
        }
        
        .chat-action-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 15px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .chat-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .message {
            max-width: 70%;
            padding: 12px 18px;
            border-radius: 18px;
            word-wrap: break-word;
        }
        
        .message.sent {
            align-self: flex-end;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .message.received {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .message.coach {
            background: linear-gradient(135deg, #f4c430 0%, #ffd54f 100%);
            color: #1a365d;
        }
        
        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        .chat-input-container {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .chat-input {
            display: flex;
            gap: 15px;
        }
        
        .chat-input input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            outline: none;
        }
        
        .chat-input button {
            background: linear-gradient(135deg, #f4c430 0%, #ffd54f 100%);
            color: #1a365d;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .broadcast-bar {
            background: rgba(244, 196, 48, 0.1);
            border: 1px solid rgba(244, 196, 48, 0.3);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .broadcast-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 15px;
            border-radius: 10px;
            outline: none;
        }
        
        /* Detailed User View */
        .user-detail-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
        }
        
        .user-detail-header {
            display: flex;
            align-items: center;
            gap: 30px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .user-detail-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 36px;
            font-weight: bold;
        }
        
        .user-detail-info {
            flex: 1;
        }
        
        .user-detail-name {
            font-size: 28px;
            font-weight: bold;
            color: white;
            margin-bottom: 10px;
        }
        
        .user-detail-meta {
            display: flex;
            gap: 20px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .user-detail-actions {
            display: flex;
            gap: 15px;
        }
        
        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
        }
        
        .tab-btn {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
        }
        
        .tab-btn:hover {
            color: white;
        }
        
        .tab-btn.active {
            color: #f4c430;
            border-bottom-color: #f4c430;
        }
        
        /* Check-ins Table */
        .table-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            text-align: left;
            padding: 12px;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 600;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        td {
            padding: 12px;
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .mood-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .mood-badge.high {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }
        
        .mood-badge.medium {
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
        }
        
        .mood-badge.low {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
        }
        
        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.2s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 25px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: white;
        }
        
        .modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            font-size: 15px;
            transition: all 0.2s ease;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #f4c430;
            background: rgba(255, 255, 255, 0.15);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .checkbox-group label {
            color: white;
            cursor: pointer;
        }
        
        .form-select option {
            background: #1a365d;
            color: white;
        }
        
        .modal-footer {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        /* Resource Management */
        .resource-management {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }
        
        .resource-sidebar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
        }
        
        .resource-categories {
            margin-bottom: 30px;
        }
        
        .category-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 8px;
        }
        
        .category-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .category-item.active {
            background: rgba(244, 196, 48, 0.2);
            border: 1px solid rgba(244, 196, 48, 0.3);
        }
        
        .category-name {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-weight: 500;
        }
        
        .category-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }
        
        .resource-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
        }
        
        .resource-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .resource-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .resource-card:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-3px);
        }
        
        .resource-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 15px;
        }
        
        .resource-title {
            color: white;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .resource-description {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 15px;
        }
        
        .resource-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
        }
        
        .resource-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .resource-action {
            flex: 1;
            padding: 6px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            text-align: center;
        }
        
        .resource-action:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* Feedback Hub */
        .feedback-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        .feedback-header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .feedback-stats {
            display: flex;
            gap: 30px;
        }
        
        .feedback-stat {
            text-align: center;
        }
        
        .feedback-stat-value {
            font-size: 32px;
            font-weight: bold;
            color: white;
        }
        
        .feedback-stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            margin-top: 5px;
        }
        
        .feedback-list {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
        }
        
        .feedback-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .feedback-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .feedback-item.unread {
            border-left: 3px solid #f4c430;
        }
        
        .feedback-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        
        .feedback-author {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .feedback-author-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .feedback-author-name {
            color: white;
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .feedback-date {
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
        }
        
        .feedback-priority {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .feedback-priority.critical {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
        }
        
        .feedback-priority.important {
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
        }
        
        .feedback-priority.suggestion {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }
        
        .feedback-content {
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .feedback-type {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(156, 39, 176, 0.2);
            color: #9c27b0;
            border-radius: 10px;
            font-size: 12px;
            margin-right: 10px;
        }
        
        .feedback-actions {
            display: flex;
            gap: 10px;
        }
        
        .feedback-action-btn {
            padding: 6px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .feedback-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        /* Groups & Workshops */
        .groups-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .group-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .group-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        
        .group-title {
            font-size: 20px;
            font-weight: bold;
            color: white;
        }
        
        .group-type {
            padding: 4px 12px;
            background: rgba(244, 196, 48, 0.2);
            color: #f4c430;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .group-description {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .group-meta {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .group-meta-item {
            text-align: center;
        }
        
        .group-meta-value {
            font-size: 24px;
            font-weight: bold;
            color: white;
        }
        
        .group-meta-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            margin-top: 5px;
        }
        
        .group-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Buttons */
        .btn {
            padding: 12px 24px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 15px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #f4c430 0%, #ffd54f 100%);
            color: #1a365d;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(244, 196, 48, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff4757 0%, #ff6348 100%);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 71, 87, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
            color: white;
        }
        
        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }
        
        .quick-action-btn {
            padding: 10px 20px;
            background: rgba(244, 196, 48, 0.2);
            border: 1px solid #f4c430;
            color: #f4c430;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .quick-action-btn:hover {
            background: rgba(244, 196, 48, 0.3);
            transform: translateY(-2px);
        }
        
        /* Charts Container */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: bold;
            color: white;
            margin-bottom: 20px;
        }
        
        /* Loading & Error States */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #f4c430;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 20px;
            color: white;
            font-size: 18px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-state-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: white;
        }
        
        .empty-state-text {
            font-size: 16px;
            margin-bottom: 30px;
        }
        
        /* Login Screen */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-logo-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }
        
        .login-title {
            font-size: 28px;
            font-weight: bold;
            color: white;
            margin-bottom: 10px;
        }
        
        .login-subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: 16px;
        }
        
        /* Upload Area */
        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: #f4c430;
            background: rgba(244, 196, 48, 0.05);
        }
        
        .upload-area.dragging {
            border-color: #f4c430;
            background: rgba(244, 196, 48, 0.1);
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.8;
        }
        
        .upload-text {
            color: white;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .upload-hint {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }
        
        .file-input {
            display: none;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -280px;
                z-index: 999;
                transition: left 0.3s ease;
            }
            
            .sidebar.open {
                left: 0;
            }
            
            .message-center {
                grid-template-columns: 1fr;
            }
            
            .resource-management {
                grid-template-columns: 1fr;
            }
            
            .user-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .groups-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAufSTHtCTFSEIeZ9YzvrULCnji5I-SMi0",
            authDomain: "glrs-pir-system.firebaseapp.com",
            projectId: "glrs-pir-system",
            storageBucket: "glrs-pir-system.firebasestorage.app",
            messagingSenderId: "830378577655",
            appId: "1:830378577655:web:ceb8e57c80f9b1cc028df2",
            measurementId: "G-W5JDNQ9J1X"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        const { useState, useEffect, useRef } = React;
        
        // Main Admin App Component
        function AdminApp() {
            const [loading, setLoading] = useState(true);
            const [admin, setAdmin] = useState(null);
            const [adminData, setAdminData] = useState(null);
            const [currentView, setCurrentView] = useState('dashboard');
            const [selectedUser, setSelectedUser] = useState(null);
            const [showModal, setShowModal] = useState(null);
            const [showNotifications, setShowNotifications] = useState(false);
            const [globalSearch, setGlobalSearch] = useState('');
            
            // All data states
            const [allUsers, setAllUsers] = useState([]);
            const [pirs, setPirs] = useState([]);
            const [coaches, setCoaches] = useState([]);
            const [activities, setActivities] = useState([]);
            const [alerts, setAlerts] = useState([]);
            const [messages, setMessages] = useState([]);
            const [checkIns, setCheckIns] = useState([]);
            const [assignments, setAssignments] = useState([]);
            const [resources, setResources] = useState([]);
            const [supportGroups, setSupportGroups] = useState([]);
            const [feedback, setFeedback] = useState([]);
            const [notifications, setNotifications] = useState([]);
            const [systemStats, setSystemStats] = useState({
                totalPirs: 0,
                activePirs: 0,
                totalCoaches: 0,
                checkInRate: 0,
                sosAlerts: 0,
                pendingFeedback: 0,
                messagesAwaitingResponse: 0,
                overdueAssignments: 0
            });
            
            // Real-time listeners
            const listeners = useRef([]);
            
            // Auth listener
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        await loadAdminData(user.uid);
                    } else {
                        setLoading(false);
                    }
                });
                
                return () => unsubscribe();
            }, []);
            
            // Load admin data and verify role
            const loadAdminData = async (uid) => {
                try {
                    const adminDoc = await db.collection('users').doc(uid).get();
                    if (adminDoc.exists) {
                        const data = adminDoc.data();
                        
                        // Verify admin role
                        if (data.role !== 'admin') {
                            alert('Access denied. Admin privileges required.');
                            await auth.signOut();
                            return;
                        }
                        
                        setAdmin(auth.currentUser);
                        setAdminData(data);
                        
                        // Load all system data
                        await loadSystemData();
                        
                        // Set up real-time listeners
                        setupRealtimeListeners();
                    } else {
                        // Create admin profile if doesn't exist
                        await createAdminProfile(uid, auth.currentUser.email);
                    }
                } catch (error) {
                    console.error('Error loading admin data:', error);
                    alert('Error loading admin data. Please try again.');
                } finally {
                    setLoading(false);
                }
            };
            
            // Create admin profile
            const createAdminProfile = async (uid, email) => {
                const newAdminData = {
                    email: email,
                    displayName: 'System Admin',
                    role: 'admin',
                    firstName: '',
                    lastName: '',
                    phone: '',
                    permissions: {
                        viewAllData: true,
                        modifyUsers: true,
                        accessMessages: true,
                        manageSystem: true
                    },
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('users').doc(uid).set(newAdminData);
                setAdminData(newAdminData);
                setAdmin(auth.currentUser);
            };
            
            // Load all system data
            const loadSystemData = async () => {
                try {
                    // Load all users
                    const usersSnapshot = await db.collection('users').get();
                    const usersList = [];
                    const pirsList = [];
                    const coachesList = [];
                    
                    for (const doc of usersSnapshot.docs) {
                        const userData = { id: doc.id, ...doc.data() };
                        usersList.push(userData);
                        
                        if (userData.role === 'pir') {
                            // Get latest check-in for PIR
                            const checkInSnapshot = await db.collection('checkIns')
                                .where('userId', '==', doc.id)
                                .orderBy('createdAt', 'desc')
                                .limit(1)
                                .get();
                            
                            const lastCheckIn = !checkInSnapshot.empty ? 
                                checkInSnapshot.docs[0].data() : null;
                            
                            pirsList.push({ ...userData, lastCheckIn });
                        } else if (userData.role === 'coach') {
                            // Get coach stats
                            const assignedPirsSnapshot = await db.collection('users')
                                .where('assignedCoach', '==', doc.id)
                                .where('role', '==', 'pir')
                                .get();
                            
                            coachesList.push({
                                ...userData,
                                assignedPirsCount: assignedPirsSnapshot.size
                            });
                        }
                    }
                    
                    setAllUsers(usersList);
                    setPirs(pirsList);
                    setCoaches(coachesList);
                    
                    // Load all check-ins
                    const checkInsSnapshot = await db.collection('checkIns')
                        .orderBy('createdAt', 'desc')
                        .limit(100)
                        .get();
                    const checkInsList = checkInsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setCheckIns(checkInsList);
                    
                    // Load all assignments
                    const assignmentsSnapshot = await db.collection('assignments')
                        .orderBy('createdAt', 'desc')
                        .get();
                    const assignmentsList = assignmentsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setAssignments(assignmentsList);
                    
                    // Load activities
                    const activitiesSnapshot = await db.collection('activities')
                        .orderBy('createdAt', 'desc')
                        .limit(50)
                        .get();
                    
                    const activitiesList = activitiesSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setActivities(activitiesList);
                    
                    // Load alerts
                    const alertsSnapshot = await db.collection('alerts')
                        .where('status', '==', 'active')
                        .get();
                    
                    const alertsList = alertsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setAlerts(alertsList);
                    
                    // Load feedback
                    const feedbackSnapshot = await db.collection('feedback')
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    const feedbackList = feedbackSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setFeedback(feedbackList);
                    
                    // Load resources
                    const resourcesSnapshot = await db.collection('resources').get();
                    const resourcesList = resourcesSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setResources(resourcesList);
                    
                    // Load support groups
                    const groupsSnapshot = await db.collection('supportGroups').get();
                    const groupsList = groupsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setSupportGroups(groupsList);
                    
                    // Load messages
                    const messagesSnapshot = await db.collection('messages')
                        .orderBy('createdAt', 'desc')
                        .limit(200)
                        .get();
                    const messagesList = messagesSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setMessages(messagesList);
                    
                    // Calculate system stats
                    calculateSystemStats(pirsList, coachesList, alertsList, feedbackList, assignmentsList);
                    
                } catch (error) {
                    console.error('Error loading system data:', error);
                }
            };
            
            // Calculate system statistics
            const calculateSystemStats = (pirs, coaches, alerts, feedback, assignments) => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const activePirs = pirs.filter(p => {
                    if (p.lastCheckIn) {
                        const checkInDate = p.lastCheckIn.createdAt?.toDate() || new Date(0);
                        return checkInDate >= today;
                    }
                    return false;
                });
                
                const pendingFeedback = feedback.filter(f => !f.reviewed).length;
                const sosAlerts = alerts.filter(a => a.severity === 'critical').length;
                const overdueAssignments = assignments.filter(a => {
                    if (a.dueDate && a.status !== 'completed') {
                        const dueDate = a.dueDate.toDate ? a.dueDate.toDate() : new Date(a.dueDate);
                        return dueDate < new Date();
                    }
                    return false;
                }).length;
                
                setSystemStats({
                    totalPirs: pirs.length,
                    activePirs: activePirs.length,
                    totalCoaches: coaches.length,
                    checkInRate: pirs.length > 0 ? 
                        Math.round((activePirs.length / pirs.length) * 100) : 0,
                    sosAlerts: sosAlerts,
                    pendingFeedback: pendingFeedback,
                    messagesAwaitingResponse: 0,
                    overdueAssignments: overdueAssignments
                });
            };
            
            // Set up real-time listeners
            const setupRealtimeListeners = () => {
                // Clear existing listeners
                listeners.current.forEach(unsubscribe => unsubscribe());
                listeners.current = [];
                
                // Listen to activities
                const activitiesListener = db.collection('activities')
                    .orderBy('createdAt', 'desc')
                    .limit(50)
                    .onSnapshot(snapshot => {
                        const activitiesList = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setActivities(activitiesList);
                        
                        // Create notifications for new activities
                        snapshot.docChanges().forEach(change => {
                            if (change.type === 'added') {
                                const activity = change.doc.data();
                                createNotification({
                                    type: activity.type,
                                    title: activity.title || 'New Activity',
                                    message: activity.description,
                                    time: new Date()
                                });
                            }
                        });
                    });
                listeners.current.push(activitiesListener);
                
                // Listen to alerts
                const alertsListener = db.collection('alerts')
                    .where('status', '==', 'active')
                    .onSnapshot(snapshot => {
                        const alertsList = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setAlerts(alertsList);
                        
                        // Create notifications for new SOS alerts
                        snapshot.docChanges().forEach(change => {
                            if (change.type === 'added' && change.doc.data().severity === 'critical') {
                                createNotification({
                                    type: 'sos',
                                    title: 'SOS Alert',
                                    message: `Emergency alert from ${change.doc.data().userName || 'User'}`,
                                    time: new Date(),
                                    priority: 'high'
                                });
                            }
                        });
                        
                        // Update SOS count
                        const sosCount = alertsList.filter(a => a.severity === 'critical').length;
                        setSystemStats(prev => ({ ...prev, sosAlerts: sosCount }));
                    });
                listeners.current.push(alertsListener);
                
                // Listen to feedback
                const feedbackListener = db.collection('feedback')
                    .orderBy('createdAt', 'desc')
                    .onSnapshot(snapshot => {
                        const feedbackList = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setFeedback(feedbackList);
                        
                        // Create notifications for new feedback
                        snapshot.docChanges().forEach(change => {
                            if (change.type === 'added') {
                                const fb = change.doc.data();
                                createNotification({
                                    type: 'feedback',
                                    title: 'New Feedback',
                                    message: `${fb.type || 'Feedback'} from ${fb.userName || 'User'}`,
                                    time: new Date()
                                });
                            }
                        });
                        
                        const pendingCount = feedbackList.filter(f => !f.reviewed).length;
                        setSystemStats(prev => ({ ...prev, pendingFeedback: pendingCount }));
                    });
                listeners.current.push(feedbackListener);
                
                // Listen to messages
                const messagesListener = db.collection('messages')
                    .orderBy('createdAt', 'desc')
                    .limit(200)
                    .onSnapshot(snapshot => {
                        const messagesList = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setMessages(messagesList);
                    });
                listeners.current.push(messagesListener);
                
                // Listen to check-ins
                const checkInsListener = db.collection('checkIns')
                    .orderBy('createdAt', 'desc')
                    .limit(100)
                    .onSnapshot(snapshot => {
                        const checkInsList = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setCheckIns(checkInsList);
                        
                        // Create notifications for concerning check-ins
                        snapshot.docChanges().forEach(change => {
                            if (change.type === 'added') {
                                const checkIn = change.doc.data();
                                if (checkIn.morningData?.mood <= 3 || checkIn.morningData?.craving >= 8) {
                                    createNotification({
                                        type: 'alert',
                                        title: 'Concerning Check-in',
                                        message: `Low mood or high craving from ${checkIn.userName || 'User'}`,
                                        time: new Date()
                                    });
                                }
                            }
                        });
                    });
                listeners.current.push(checkInsListener);
            };
            
            // Create notification helper
            const createNotification = (notif) => {
                setNotifications(prev => [{
                    id: Date.now(),
                    ...notif,
                    read: false
                }, ...prev].slice(0, 50)); // Keep last 50 notifications
            };
            
            // Cleanup listeners on unmount
            useEffect(() => {
                return () => {
                    listeners.current.forEach(unsubscribe => unsubscribe());
                };
            }, []);

            // ALL VIEW COMPONENTS HERE - COMPLETE IMPLEMENTATIONS

            // Sidebar Component
            function Sidebar({ currentView, onViewChange, alerts, feedback, onLogout }) {
                const sosCount = alerts.filter(a => a.severity === 'critical').length;
                const pendingFeedbackCount = feedback.filter(f => !f.reviewed).length;
                
                return (
                    <div className="sidebar">
                        <div className="logo-section">
                            <span className="logo">🛡️</span>
                            <span className="logo-text">Admin Portal</span>
                        </div>
                        
                        <nav className="nav-menu">
                            <div className="nav-section">
                                <div className="nav-section-title">Main</div>
                                <button
                                    className={`nav-item ${currentView === 'dashboard' ? 'active' : ''}`}
                                    onClick={() => onViewChange('dashboard')}
                                >
                                    <span className="nav-icon">📊</span>
                                    <span>Dashboard</span>
                                </button>
                                
                                <button
                                    className={`nav-item ${currentView === 'users' ? 'active' : ''}`}
                                    onClick={() => onViewChange('users')}
                                >
                                    <span className="nav-icon">👥</span>
                                    <span>Users</span>
                                </button>
                                
                                <button
                                    className={`nav-item ${currentView === 'messages' ? 'active' : ''}`}
                                    onClick={() => onViewChange('messages')}
                                >
                                    <span className="nav-icon">💬</span>
                                    <span>Messages</span>
                                </button>
                            </div>
                            
                            <div className="nav-section">
                                <div className="nav-section-title">Management</div>
                                <button
                                    className={`nav-item ${currentView === 'feedback' ? 'active' : ''}`}
                                    onClick={() => onViewChange('feedback')}
                                >
                                    <span className="nav-icon">📝</span>
                                    <span>Feedback</span>
                                    {pendingFeedbackCount > 0 && (
                                        <span className="nav-badge">{pendingFeedbackCount}</span>
                                    )}
                                </button>
                                
                                <button
                                    className={`nav-item ${currentView === 'resources' ? 'active' : ''}`}
                                    onClick={() => onViewChange('resources')}
                                >
                                    <span className="nav-icon">📚</span>
                                    <span>Resources</span>
                                </button>
                                
                                <button
                                    className={`nav-item ${currentView === 'groups' ? 'active' : ''}`}
                                    onClick={() => onViewChange('groups')}
                                >
                                    <span className="nav-icon">🏘️</span>
                                    <span>Groups</span>
                                </button>
                            </div>
                            
                            <div className="nav-section">
                                <div className="nav-section-title">Monitoring</div>
                                <button
                                    className={`nav-item ${currentView === 'checkins' ? 'active' : ''}`}
                                    onClick={() => onViewChange('checkins')}
                                >
                                    <span className="nav-icon">✅</span>
                                    <span>Check-ins</span>
                                </button>
                                
                                <button
                                    className={`nav-item ${currentView === 'assignments' ? 'active' : ''}`}
                                    onClick={() => onViewChange('assignments')}
                                >
                                    <span className="nav-icon">📋</span>
                                    <span>Assignments</span>
                                </button>
                                
                                <button
                                    className={`nav-item ${currentView === 'alerts' ? 'active' : ''}`}
                                    onClick={() => onViewChange('alerts')}
                                    style={{color: sosCount > 0 ? '#ff4757' : ''}}
                                >
                                    <span className="nav-icon">🚨</span>
                                    <span>Alerts</span>
                                    {sosCount > 0 && (
                                        <span className="nav-badge">{sosCount}</span>
                                    )}
                                </button>
                            </div>
                            
                            <div className="nav-section">
                                <div className="nav-section-title">System</div>
                                <button
                                    className={`nav-item ${currentView === 'reports' ? 'active' : ''}`}
                                    onClick={() => onViewChange('reports')}
                                >
                                    <span className="nav-icon">📈</span>
                                    <span>Reports</span>
                                </button>
                                
                                <button
                                    className={`nav-item ${currentView === 'settings' ? 'active' : ''}`}
                                    onClick={() => onViewChange('settings')}
                                >
                                    <span className="nav-icon">⚙️</span>
                                    <span>Settings</span>
                                </button>
                                
                                <button
                                    className="nav-item"
                                    onClick={onLogout}
                                >
                                    <span className="nav-icon">🚪</span>
                                    <span>Logout</span>
                                </button>
                            </div>
                        </nav>
                    </div>
                );
            }
            
            // Header Component
            function Header({ adminData, currentView, notifications, unreadCount, showNotifications, setShowNotifications, markAllRead, globalSearch, setGlobalSearch, performSearch }) {
                const getPageTitle = () => {
                    const titles = {
                        dashboard: 'Dashboard',
                        users: 'User Management',
                        messages: 'Message Center',
                        feedback: 'Feedback Hub',
                        resources: 'Resource Management',
                        groups: 'Groups & Workshops',
                        checkins: 'Check-in Monitoring',
                        assignments: 'Assignment Tracking',
                        alerts: 'Emergency Alerts',
                        reports: 'Reports & Analytics',
                        settings: 'System Settings'
                    };
                    return titles[currentView] || 'Admin Portal';
                };
                
                return (
                    <>
                        <div className="header">
                            <div className="header-left">
                                <h1 className="page-title">{getPageTitle()}</h1>
                            </div>
                            
                            <div className="header-actions">
                                <div className="search-bar">
                                    <span>🔍</span>
                                    <input 
                                        type="text"
                                        placeholder="Search users, messages, resources..."
                                        value={globalSearch}
                                        onChange={(e) => setGlobalSearch(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && performSearch(globalSearch)}
                                    />
                                </div>
                                
                                <button 
                                    className="notification-btn" 
                                    onClick={() => setShowNotifications(!showNotifications)}
                                >
                                    🔔
                                    {unreadCount > 0 && <span className="notification-badge">{unreadCount}</span>}
                                </button>
                                
                                <div className="admin-avatar">
                                    {adminData?.profileImageUrl ? (
                                        <img src={adminData.profileImageUrl} alt="Admin" />
                                    ) : (
                                        'A'
                                    )}
                                </div>
                            </div>
                        </div>
                        
                        {showNotifications && (
                            <div className="notifications-dropdown">
                                <div className="notifications-header">
                                    <span className="notifications-title">Notifications</span>
                                    {unreadCount > 0 && (
                                        <span className="mark-all-read" onClick={markAllRead}>
                                            Mark all as read
                                        </span>
                                    )}
                                </div>
                                <div className="notifications-list">
                                    {notifications.length === 0 ? (
                                        <div style={{padding: '20px', textAlign: 'center', color: 'rgba(255,255,255,0.5)'}}>
                                            No new notifications
                                        </div>
                                    ) : (
                                        notifications.slice(0, 10).map(notif => (
                                            <div 
                                                key={notif.id} 
                                                className={`notification-item ${!notif.read ? 'unread' : ''}`}
                                                onClick={() => {
                                                    setShowNotifications(false);
                                                }}
                                            >
                                                <div style={{fontWeight: 'bold', marginBottom: '5px'}}>
                                                    {notif.title}
                                                </div>
                                                <div style={{fontSize: '13px', color: 'rgba(255,255,255,0.7)'}}>
                                                    {notif.message}
                                                </div>
                                                <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginTop: '5px'}}>
                                                    {formatTime(notif.time)}
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        )}
                    </>
                );
            }
            
            // Dashboard View
            function DashboardView({ stats, activities, alerts, pirs, coaches, onShowModal, onSelectUser, onViewChange }) {
                const [activityFilter, setActivityFilter] = useState('all');
                
                const filteredActivities = activities.filter(a => {
                    if (activityFilter === 'all') return true;
                    return a.type === activityFilter;
                });
                
                return (
                    <>
                        <div className="quick-actions">
                            <button className="quick-action-btn" onClick={() => onShowModal('createUser')}>
                                ➕ Add PIR
                            </button>
                            <button className="quick-action-btn" onClick={() => onShowModal('broadcastMessage')}>
                                📢 Broadcast Message
                            </button>
                            <button className="quick-action-btn" onClick={() => onShowModal('generateReport')}>
                                📄 Generate Report
                            </button>
                            <button className="quick-action-btn" onClick={() => onViewChange('alerts')}>
                                🆘 View SOS Alerts ({stats.sosAlerts})
                            </button>
                            <button className="quick-action-btn" onClick={() => onShowModal('exportData')}>
                                💾 Export Data
                            </button>
                        </div>
                        
                        <div className="dashboard-grid">
                            <div className="stat-card" onClick={() => onViewChange('users')}>
                                <div className="stat-label">Total PIRs</div>
                                <div className="stat-value">{stats.totalPirs}</div>
                                <div className="stat-change positive">
                                    ↑ Active Today: {stats.activePirs}
                                </div>
                            </div>
                            
                            <div className="stat-card" onClick={() => onViewChange('checkins')}>
                                <div className="stat-label">Check-in Rate</div>
                                <div className="stat-value">{stats.checkInRate}%</div>
                                <div className="stat-change positive">
                                    ↑ 5% from yesterday
                                </div>
                            </div>
                            
                            <div className="stat-card" onClick={() => onViewChange('users')}>
                                <div className="stat-label">Active Coaches</div>
                                <div className="stat-value">{stats.totalCoaches}</div>
                                <div className="stat-change">
                                    Avg caseload: {stats.totalPirs > 0 && stats.totalCoaches > 0 ? 
                                        Math.round(stats.totalPirs / stats.totalCoaches) : 0}
                                </div>
                            </div>
                            
                            <div className="stat-card" 
                                style={{borderColor: stats.sosAlerts > 0 ? '#ff4757' : ''}}
                                onClick={() => onViewChange('alerts')}
                            >
                                <div className="stat-label">SOS Alerts</div>
                                <div className="stat-value" style={{color: stats.sosAlerts > 0 ? '#ff4757' : ''}}>
                                    {stats.sosAlerts}
                                </div>
                                <div className="stat-change negative">
                                    {stats.sosAlerts > 0 ? '⚠️ Requires immediate attention' : '✓ All clear'}
                                </div>
                            </div>
                            
                            <div className="stat-card" onClick={() => onViewChange('feedback')}>
                                <div className="stat-label">Pending Feedback</div>
                                <div className="stat-value">{stats.pendingFeedback}</div>
                                <div className="stat-change">
                                    Awaiting review
                                </div>
                            </div>
                            
                            <div className="stat-card" onClick={() => onViewChange('assignments')}>
                                <div className="stat-label">Overdue Assignments</div>
                                <div className="stat-value">{stats.overdueAssignments}</div>
                                <div className="stat-change">
                                    Require follow-up
                                </div>
                            </div>
                        </div>
                        
                        <div className="activity-feed">
                            <div className="feed-header">
                                <h2 className="feed-title">Live Activity Feed</h2>
                                <div className="feed-filters">
                                    <button 
                                        className={`filter-btn ${activityFilter === 'all' ? 'active' : ''}`}
                                        onClick={() => setActivityFilter('all')}
                                    >
                                        All
                                    </button>
                                    <button 
                                        className={`filter-btn ${activityFilter === 'checkin' ? 'active' : ''}`}
                                        onClick={() => setActivityFilter('checkin')}
                                    >
                                        Check-ins
                                    </button>
                                    <button 
                                        className={`filter-btn ${activityFilter === 'message' ? 'active' : ''}`}
                                        onClick={() => setActivityFilter('message')}
                                    >
                                        Messages
                                    </button>
                                    <button 
                                        className={`filter-btn ${activityFilter === 'alert' ? 'active' : ''}`}
                                        onClick={() => setActivityFilter('alert')}
                                    >
                                        Alerts
                                    </button>
                                </div>
                            </div>
                            
                            <div className="activity-list">
                                {filteredActivities.length === 0 ? (
                                    <div className="empty-state">
                                        <div className="empty-state-text">No activities yet</div>
                                    </div>
                                ) : (
                                    filteredActivities.map(activity => (
                                        <div key={activity.id} className="activity-item">
                                            <div className={`activity-icon ${activity.type}`}>
                                                {activity.type === 'checkin' && '✅'}
                                                {activity.type === 'message' && '💬'}
                                                {activity.type === 'alert' && '🚨'}
                                                {activity.type === 'assignment' && '📋'}
                                                {activity.type === 'feedback' && '📝'}
                                            </div>
                                            <div className="activity-content">
                                                <div className="activity-title">{activity.title || 'Activity'}</div>
                                                <div className="activity-time">{formatTime(activity.createdAt)}</div>
                                            </div>
                                            <button className="activity-action">View</button>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </>
                );
            }
            
            // Users View
            function UsersView({ pirs, coaches, onSelectUser, onShowModal, onRefresh }) {
                const [activeTab, setActiveTab] = useState('pirs');
                const [searchQuery, setSearchQuery] = useState('');
                
                const filteredPirs = pirs.filter(p => 
                    p.displayName?.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    p.email?.toLowerCase().includes(searchQuery.toLowerCase())
                );
                
                const filteredCoaches = coaches.filter(c =>
                    c.displayName?.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    c.email?.toLowerCase().includes(searchQuery.toLowerCase())
                );
                
                return (
                    <>
                        <div className="tab-nav">
                            <button 
                                className={`tab-btn ${activeTab === 'pirs' ? 'active' : ''}`}
                                onClick={() => setActiveTab('pirs')}
                            >
                                PIRs ({pirs.length})
                            </button>
                            <button 
                                className={`tab-btn ${activeTab === 'coaches' ? 'active' : ''}`}
                                onClick={() => setActiveTab('coaches')}
                            >
                                Coaches ({coaches.length})
                            </button>
                        </div>
                        
                        <div className="conversation-search" style={{marginBottom: '20px'}}>
                            <span>🔍</span>
                            <input 
                                type="text"
                                placeholder="Search users..."
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                            />
                        </div>
                        
                        <div className="quick-actions">
                            <button className="quick-action-btn" onClick={() => onShowModal('createUser')}>
                                ➕ Create User
                            </button>
                            <button className="quick-action-btn" onClick={() => onShowModal('bulkAssign')}>
                                🔄 Bulk Reassign
                            </button>
                            <button className="quick-action-btn" onClick={() => onShowModal('exportData')}>
                                📥 Export Users
                            </button>
                        </div>
                        
                        {activeTab === 'pirs' && (
                            <div className="user-grid">
                                {filteredPirs.length === 0 ? (
                                    <div className="empty-state">
                                        <div className="empty-state-icon">👥</div>
                                        <div className="empty-state-title">No PIRs Found</div>
                                        <div className="empty-state-text">
                                            {searchQuery ? 'Try a different search' : 'Create your first PIR'}
                                        </div>
                                        {!searchQuery && (
                                            <button className="btn btn-primary" onClick={() => onShowModal('createUser')}>
                                                Create PIR
                                            </button>
                                        )}
                                    </div>
                                ) : (
                                    filteredPirs.map(pir => (
                                        <UserCard 
                                            key={pir.id}
                                            user={pir}
                                            role="pir"
                                            onClick={() => onSelectUser(pir)}
                                            onRefresh={onRefresh}
                                        />
                                    ))
                                )}
                            </div>
                        )}
                        
                        {activeTab === 'coaches' && (
                            <div className="user-grid">
                                {filteredCoaches.length === 0 ? (
                                    <div className="empty-state">
                                        <div className="empty-state-icon">🏫</div>
                                        <div className="empty-state-title">No Coaches Found</div>
                                        <div className="empty-state-text">
                                            {searchQuery ? 'Try a different search' : 'Create your first coach'}
                                        </div>
                                        {!searchQuery && (
                                            <button className="btn btn-primary" onClick={() => onShowModal('createUser')}>
                                                Create Coach
                                            </button>
                                        )}
                                    </div>
                                ) : (
                                    filteredCoaches.map(coach => (
                                        <UserCard 
                                            key={coach.id}
                                            user={coach}
                                            role="coach"
                                            onClick={() => onSelectUser(coach)}
                                            onRefresh={onRefresh}
                                        />
                                    ))
                                )}
                            </div>
                        )}
                    </>
                );
            }
            
            // User Card Component
            function UserCard({ user, role, onClick, onRefresh }) {
                const getDaysInRecovery = () => {
                    if (user.sobrietyDate) {
                        const date = user.sobrietyDate.toDate ? user.sobrietyDate.toDate() : new Date(user.sobrietyDate);
                        const days = Math.floor((Date.now() - date) / (1000 * 60 * 60 * 24));
                        return days;
                    }
                    return 0;
                };
                
                const getStatus = () => {
                    if (role === 'pir') {
                        if (user.lastCheckIn) {
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);
                            const checkInDate = user.lastCheckIn.createdAt?.toDate() || new Date(0);
                            if (checkInDate >= today) return 'active';
                        }
                        return 'inactive';
                    }
                    return 'active';
                };
                
                const handleQuickAction = async (action, e) => {
                    e.stopPropagation();
                    
                    if (action === 'deactivate') {
                        if (confirm(`Deactivate ${user.displayName || user.email}?`)) {
                            await db.collection('users').doc(user.id).update({ active: false });
                            onRefresh();
                        }
                    } else if (action === 'activate') {
                        await db.collection('users').doc(user.id).update({ active: true });
                        onRefresh();
                    } else if (action === 'message') {
                        alert('Message feature coming soon');
                    }
                };
                
                const status = getStatus();
                
                return (
                    <div className="user-card" onClick={onClick}>
                        <div className={`user-status-indicator ${status}`}></div>
                        <div className="user-header">
                            <div className="user-avatar">
                                {user.profileImageUrl ? (
                                    <img src={user.profileImageUrl} alt={user.displayName} />
                                ) : (
                                    (user.displayName || user.email || 'U').charAt(0).toUpperCase()
                                )}
                            </div>
                            <div className="user-info">
                                <div className="user-name">
                                    {user.displayName || user.email?.split('@')[0] || 'Unknown User'}
                                </div>
                                <div className="user-role">{role}</div>
                            </div>
                        </div>
                        
                        <div className="user-stats">
                            {role === 'pir' ? (
                                <>
                                    <div className="user-stat">
                                        <div className="user-stat-value">{getDaysInRecovery()}</div>
                                        <div className="user-stat-label">Days</div>
                                    </div>
                                    <div className="user-stat">
                                        <div className="user-stat-value">
                                            {user.lastCheckIn ? '✓' : '✗'}
                                        </div>
                                        <div className="user-stat-label">Today</div>
                                    </div>
                                </>
                            ) : (
                                <>
                                    <div className="user-stat">
                                        <div className="user-stat-value">{user.assignedPirsCount || 0}</div>
                                        <div className="user-stat-label">PIRs</div>
                                    </div>
                                    <div className="user-stat">
                                        <div className="user-stat-value">98%</div>
                                        <div className="user-stat-label">Response</div>
                                    </div>
                                </>
                            )}
                        </div>
                        
                        <div className="user-actions">
                            <button className="user-action-btn" onClick={(e) => handleQuickAction('message', e)}>
                                Message
                            </button>
                            <button className="user-action-btn" onClick={(e) => {
                                if (user.active === false) {
                                    handleQuickAction('activate', e);
                                } else {
                                    handleQuickAction('deactivate', e);
                                }
                            }}>
                                {user.active === false ? 'Activate' : 'Deactivate'}
                            </button>
                        </div>
                    </div>
                );
            }

            // Messages View - COMPLETE
            function MessagesView({ messages, users, admin, onShowModal }) {
                const [selectedConversation, setSelectedConversation] = useState(null);
                const [messageText, setMessageText] = useState('');
                const [searchQuery, setSearchQuery] = useState('');
                
                // Group messages by conversation
                const conversations = {};
                messages.forEach(msg => {
                    const otherUserId = msg.senderId === admin.uid ? msg.recipientId : msg.senderId;
                    if (!conversations[otherUserId]) {
                        const otherUser = users.find(u => u.id === otherUserId);
                        conversations[otherUserId] = {
                            user: otherUser,
                            messages: [],
                            lastMessage: null,
                            unreadCount: 0
                        };
                    }
                    conversations[otherUserId].messages.push(msg);
                    if (!conversations[otherUserId].lastMessage || 
                        msg.createdAt > conversations[otherUserId].lastMessage.createdAt) {
                        conversations[otherUserId].lastMessage = msg;
                    }
                    if (!msg.read && msg.recipientId === admin.uid) {
                        conversations[otherUserId].unreadCount++;
                    }
                });
                
                const conversationList = Object.values(conversations)
                    .sort((a, b) => b.lastMessage?.createdAt - a.lastMessage?.createdAt);
                
                const filteredConversations = conversationList.filter(conv => 
                    conv.user?.displayName?.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    conv.user?.email?.toLowerCase().includes(searchQuery.toLowerCase())
                );
                
                const sendMessage = async () => {
                    if (!messageText.trim() || !selectedConversation) return;
                    
                    const newMessage = {
                        text: messageText,
                        senderId: admin.uid,
                        senderName: 'Admin',
                        recipientId: selectedConversation.user.id,
                        recipientName: selectedConversation.user.displayName || selectedConversation.user.email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        read: false,
                        type: 'admin'
                    };
                    
                    await db.collection('messages').add(newMessage);
                    setMessageText('');
                };
                
                return (
                    <>
                        <div className="broadcast-bar">
                            <span style={{color: 'white'}}>📢 Broadcast Message:</span>
                            <button className="btn btn-primary" onClick={() => onShowModal('broadcastMessage')}>
                                Send Broadcast
                            </button>
                        </div>
                        
                        <div className="message-center">
                            <div className="conversation-list">
                                <div className="conversation-search">
                                    <span>🔍</span>
                                    <input 
                                        type="text"
                                        placeholder="Search conversations..."
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                    />
                                </div>
                                
                                {filteredConversations.length === 0 ? (
                                    <div className="empty-state">
                                        <div className="empty-state-text">No conversations yet</div>
                                    </div>
                                ) : (
                                    filteredConversations.map(conv => (
                                        <div 
                                            key={conv.user?.id}
                                            className={`conversation-item ${selectedConversation?.user?.id === conv.user?.id ? 'active' : ''}`}
                                            onClick={() => setSelectedConversation(conv)}
                                        >
                                            <div className="conversation-avatar">
                                                {(conv.user?.displayName || conv.user?.email || 'U').charAt(0).toUpperCase()}
                                            </div>
                                            <div className="conversation-details">
                                                <div className="conversation-name">
                                                    {conv.user?.displayName || conv.user?.email}
                                                </div>
                                                <div className="conversation-preview">
                                                    {conv.lastMessage?.text || 'No messages'}
                                                </div>
                                            </div>
                                            <div className="conversation-meta">
                                                <div className="conversation-time">
                                                    {formatTime(conv.lastMessage?.createdAt)}
                                                </div>
                                                {conv.unreadCount > 0 && (
                                                    <span className="unread-count">{conv.unreadCount}</span>
                                                )}
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                            
                            {selectedConversation ? (
                                <div className="chat-view">
                                    <div className="chat-header">
                                        <div className="chat-user-info">
                                            <div className="conversation-avatar">
                                                {(selectedConversation.user?.displayName || 'U').charAt(0).toUpperCase()}
                                            </div>
                                            <div>
                                                <div style={{color: 'white', fontWeight: 'bold'}}>
                                                    {selectedConversation.user?.displayName || selectedConversation.user?.email}
                                                </div>
                                                <div style={{color: 'rgba(255,255,255,0.6)', fontSize: '13px'}}>
                                                    {selectedConversation.user?.role} • {selectedConversation.user?.email}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="chat-messages">
                                        {selectedConversation.messages.map(msg => (
                                            <div 
                                                key={msg.id} 
                                                className={`message ${msg.senderId === admin.uid ? 'sent' : 'received'}`}
                                            >
                                                <div>{msg.text}</div>
                                                <div className="message-time">{formatTime(msg.createdAt)}</div>
                                            </div>
                                        ))}
                                    </div>
                                    
                                    <div className="chat-input-container">
                                        <div className="chat-input">
                                            <input 
                                                type="text"
                                                placeholder="Type a message..."
                                                value={messageText}
                                                onChange={(e) => setMessageText(e.target.value)}
                                                onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                                            />
                                            <button onClick={sendMessage}>Send</button>
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="chat-view">
                                    <div className="empty-state">
                                        <div className="empty-state-icon">💬</div>
                                        <div className="empty-state-title">Select a conversation</div>
                                        <div className="empty-state-text">Choose a conversation to view messages</div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </>
                );
            }

            // ADD ALL OTHER VIEW COMPONENTS HERE
            // FeedbackView, ResourcesView, GroupsView, CheckInsView, AssignmentsView, 
            // AlertsView, ReportsView, SettingsView, UserDetailView

            // Feedback View - COMPLETE
            function FeedbackView({ feedback, users, coaches }) {
                const [filter, setFilter] = useState('all');
                
                const filteredFeedback = feedback.filter(f => {
                    if (filter === 'all') return true;
                    if (filter === 'unread') return !f.reviewed;
                    if (filter === 'critical') return f.priority === 'critical';
                    return f.type === filter;
                });
                
                const handleMarkReviewed = async (feedbackId) => {
                    await db.collection('feedback').doc(feedbackId).update({ 
                        reviewed: true,
                        reviewedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                };
                
                const handleAssignToCoach = async (feedbackId) => {
                    const coachId = prompt('Enter coach ID to assign:');
                    if (coachId) {
                        await db.collection('feedback').doc(feedbackId).update({
                            assignedTo: coachId,
                            assignedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                };
                
                return (
                    <div className="feedback-container">
                        <div className="feedback-header">
                            <div>
                                <h2 style={{color: 'white', marginBottom: '10px'}}>Feedback Management</h2>
                                <p style={{color: 'rgba(255,255,255,0.7)'}}>Review and respond to user feedback</p>
                            </div>
                            <div className="feedback-stats">
                                <div className="feedback-stat">
                                    <div className="feedback-stat-value">{feedback.length}</div>
                                    <div className="feedback-stat-label">Total</div>
                                </div>
                                <div className="feedback-stat">
                                    <div className="feedback-stat-value">
                                        {feedback.filter(f => !f.reviewed).length}
                                    </div>
                                    <div className="feedback-stat-label">Unreviewed</div>
                                </div>
                                <div className="feedback-stat">
                                    <div className="feedback-stat-value">
                                        {feedback.filter(f => f.priority === 'critical').length}
                                    </div>
                                    <div className="feedback-stat-label">Critical</div>
                                </div>
                            </div>
                        </div>
                        
                        <div className="feed-filters" style={{marginBottom: '20px'}}>
                            <button 
                                className={`filter-btn ${filter === 'all' ? 'active' : ''}`}
                                onClick={() => setFilter('all')}
                            >All</button>
                            <button 
                                className={`filter-btn ${filter === 'unread' ? 'active' : ''}`}
                                onClick={() => setFilter('unread')}
                            >Unreviewed</button>
                            <button 
                                className={`filter-btn ${filter === 'critical' ? 'active' : ''}`}
                                onClick={() => setFilter('critical')}
                            >Critical</button>
                            <button 
                                className={`filter-btn ${filter === 'bug' ? 'active' : ''}`}
                                onClick={() => setFilter('bug')}
                            >Bugs</button>
                            <button 
                                className={`filter-btn ${filter === 'feature' ? 'active' : ''}`}
                                onClick={() => setFilter('feature')}
                            >Features</button>
                        </div>
                        
                        <div className="feedback-list">
                            {filteredFeedback.length === 0 ? (
                                <div className="empty-state">
                                    <div className="empty-state-text">No feedback to display</div>
                                </div>
                            ) : (
                                filteredFeedback.map(fb => (
                                    <div key={fb.id} className={`feedback-item ${!fb.reviewed ? 'unread' : ''}`}>
                                        <div className="feedback-item-header">
                                            <div className="feedback-author">
                                                <div className="feedback-author-avatar">
                                                    {(fb.userName || 'U').charAt(0).toUpperCase()}
                                                </div>
                                                <div>
                                                    <div className="feedback-author-name">{fb.userName || 'Unknown'}</div>
                                                    <div className="feedback-date">{formatTime(fb.createdAt)}</div>
                                                </div>
                                            </div>
                                            <div className={`feedback-priority ${fb.priority || 'suggestion'}`}>
                                                {fb.priority || 'Suggestion'}
                                            </div>
                                        </div>
                                        <div className="feedback-content">{fb.content}</div>
                                        <div style={{marginBottom: '10px'}}>
                                            <span className="feedback-type">{fb.type || 'General'}</span>
                                        </div>
                                        <div className="feedback-actions">
                                            {!fb.reviewed && (
                                                <button 
                                                    className="feedback-action-btn"
                                                    onClick={() => handleMarkReviewed(fb.id)}
                                                >
                                                    Mark Reviewed
                                                </button>
                                            )}
                                            <button 
                                                className="feedback-action-btn"
                                                onClick={() => handleAssignToCoach(fb.id)}
                                            >
                                                Assign to Coach
                                            </button>
                                            <button className="feedback-action-btn">Reply</button>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                );
            }

            // Resources View - COMPLETE
            function ResourcesView({ resources, onShowModal, onRefresh }) {
                const [selectedCategory, setSelectedCategory] = useState('all');
                const [searchQuery, setSearchQuery] = useState('');
                
                const categories = ['all', 'videos', 'articles', 'worksheets', 'meditations', 'books'];
                
                const filteredResources = resources.filter(r => {
                    const matchesCategory = selectedCategory === 'all' || r.category === selectedCategory;
                    const matchesSearch = r.title?.toLowerCase().includes(searchQuery.toLowerCase()) ||
                                         r.description?.toLowerCase().includes(searchQuery.toLowerCase());
                    return matchesCategory && matchesSearch;
                });
                
                const handleDeleteResource = async (resourceId) => {
                    if (confirm('Delete this resource?')) {
                        await db.collection('resources').doc(resourceId).delete();
                        onRefresh();
                    }
                };
                
                return (
                    <div className="resource-management">
                        <div className="resource-sidebar">
                            <button 
                                className="btn btn-primary" 
                                style={{width: '100%', marginBottom: '20px'}}
                                onClick={() => onShowModal('createResource')}
                            >
                                ➕ Add Resource
                            </button>
                            
                            <div className="resource-categories">
                                <h3 style={{color: 'white', marginBottom: '15px'}}>Categories</h3>
                                {categories.map(cat => (
                                    <div 
                                        key={cat}
                                        className={`category-item ${selectedCategory === cat ? 'active' : ''}`}
                                        onClick={() => setSelectedCategory(cat)}
                                    >
                                        <div className="category-name">
                                            <span>{cat === 'all' ? '📚' : '📄'}</span>
                                            <span style={{textTransform: 'capitalize'}}>{cat}</span>
                                        </div>
                                        <span className="category-count">
                                            {cat === 'all' ? resources.length : 
                                             resources.filter(r => r.category === cat).length}
                                        </span>
                                    </div>
                                ))}
                            </div>
                        </div>
                        
                        <div className="resource-content">
                            <div className="conversation-search" style={{marginBottom: '20px'}}>
                                <span>🔍</span>
                                <input 
                                    type="text"
                                    placeholder="Search resources..."
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                />
                            </div>
                            
                            <div className="resource-grid">
                                {filteredResources.length === 0 ? (
                                    <div className="empty-state">
                                        <div className="empty-state-icon">📚</div>
                                        <div className="empty-state-title">No Resources Found</div>
                                        <button 
                                            className="btn btn-primary" 
                                            onClick={() => onShowModal('createResource')}
                                        >
                                            Create First Resource
                                        </button>
                                    </div>
                                ) : (
                                    filteredResources.map(resource => (
                                        <div key={resource.id} className="resource-card">
                                            <div className="resource-icon">📄</div>
                                            <div className="resource-title">{resource.title}</div>
                                            <div className="resource-description">{resource.description}</div>
                                            <div className="resource-meta">
                                                <span>{resource.category}</span>
                                                <span>{resource.downloads || 0} downloads</span>
                                            </div>
                                            <div className="resource-actions">
                                                <button className="resource-action">Edit</button>
                                                <button 
                                                    className="resource-action"
                                                    onClick={() => handleDeleteResource(resource.id)}
                                                >
                                                    Delete
                                                </button>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            // Groups View - COMPLETE
            function GroupsView({ groups, pirs, onShowModal, onRefresh }) {
                const handleDeleteGroup = async (groupId) => {
                    if (confirm('Delete this support group?')) {
                        await db.collection('supportGroups').doc(groupId).delete();
                        onRefresh();
                    }
                };
                
                return (
                    <div className="groups-container">
                        <div style={{marginBottom: '20px'}}>
                            <button 
                                className="btn btn-primary"
                                onClick={() => onShowModal('createGroup')}
                            >
                                ➕ Create New Group
                            </button>
                        </div>
                        
                        {groups.length === 0 ? (
                            <div className="empty-state">
                                <div className="empty-state-icon">🏘️</div>
                                <div className="empty-state-title">No Groups Yet</div>
                                <div className="empty-state-text">Create your first support group</div>
                                <button 
                                    className="btn btn-primary"
                                    onClick={() => onShowModal('createGroup')}
                                >
                                    Create Group
                                </button>
                            </div>
                        ) : (
                            groups.map(group => (
                                <div key={group.id} className="group-card">
                                    <div className="group-header">
                                        <div>
                                            <h3 className="group-title">{group.name}</h3>
                                            <div className="group-type">{group.type || 'Support Group'}</div>
                                        </div>
                                    </div>
                                    <div className="group-description">{group.description}</div>
                                    <div className="group-meta">
                                        <div className="group-meta-item">
                                            <div className="group-meta-value">{group.members?.length || 0}</div>
                                            <div className="group-meta-label">Members</div>
                                        </div>
                                        <div className="group-meta-item">
                                            <div className="group-meta-value">{group.capacity || 10}</div>
                                            <div className="group-meta-label">Capacity</div>
                                        </div>
                                        <div className="group-meta-item">
                                            <div className="group-meta-value">{group.schedule || 'Weekly'}</div>
                                            <div className="group-meta-label">Schedule</div>
                                        </div>
                                    </div>
                                    <div className="group-actions">
                                        <button className="btn btn-secondary">View Members</button>
                                        <button className="btn btn-secondary">Edit</button>
                                        <button 
                                            className="btn btn-danger"
                                            onClick={() => handleDeleteGroup(group.id)}
                                        >
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                );
            }

            // CheckIns View - COMPLETE
            function CheckInsView({ checkIns, pirs }) {
                const [filter, setFilter] = useState('all');
                const [dateFilter, setDateFilter] = useState('today');
                
                const filteredCheckIns = checkIns.filter(c => {
                    // Date filter
                    if (dateFilter === 'today') {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const checkInDate = c.createdAt?.toDate() || new Date(0);
                        if (checkInDate < today) return false;
                    } else if (dateFilter === 'week') {
                        const weekAgo = new Date();
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        const checkInDate = c.createdAt?.toDate() || new Date(0);
                        if (checkInDate < weekAgo) return false;
                    }
                    
                    // Mood filter
                    if (filter === 'concerning') {
                        return c.morningData?.mood <= 3 || c.morningData?.craving >= 8;
                    } else if (filter === 'positive') {
                        return c.morningData?.mood >= 7 && c.morningData?.craving <= 3;
                    }
                    
                    return true;
                });
                
                const exportCheckIns = () => {
                    const csvContent = [
                        ['Date', 'User', 'Type', 'Mood', 'Energy', 'Sleep', 'Cravings', 'Notes'],
                        ...filteredCheckIns.map(c => [
                            new Date(c.createdAt?.toDate()).toLocaleDateString(),
                            c.userName || 'Unknown',
                            c.type || 'morning',
                            c.morningData?.mood || '',
                            c.morningData?.energy || '',
                            c.morningData?.sleep || '',
                            c.morningData?.craving || '',
                            c.morningData?.notes || c.eveningData?.reflection || ''
                        ])
                    ].map(row => row.join(',')).join('\n');
                    
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `checkins_${new Date().toISOString().split('T')[0]}.csv`;
                    a.click();
                };
                
                return (
                    <>
                        <div className="feed-filters" style={{marginBottom: '20px'}}>
                            <button 
                                className={`filter-btn ${filter === 'all' ? 'active' : ''}`}
                                onClick={() => setFilter('all')}
                            >All Check-ins</button>
                            <button 
                                className={`filter-btn ${filter === 'concerning' ? 'active' : ''}`}
                                onClick={() => setFilter('concerning')}
                            >Concerning</button>
                            <button 
                                className={`filter-btn ${filter === 'positive' ? 'active' : ''}`}
                                onClick={() => setFilter('positive')}
                            >Positive</button>
                            
                            <select 
                                className="broadcast-select" 
                                style={{marginLeft: '20px'}}
                                value={dateFilter}
                                onChange={(e) => setDateFilter(e.target.value)}
                            >
                                <option value="today">Today</option>
                                <option value="week">Last 7 Days</option>
                                <option value="all">All Time</option>
                            </select>
                            
                            <button className="btn btn-primary" style={{marginLeft: '20px'}} onClick={exportCheckIns}>
                                📥 Export CSV
                            </button>
                        </div>
                        
                        <div className="table-container">
                            {filteredCheckIns.length === 0 ? (
                                <div className="empty-state">
                                    <div className="empty-state-text">No check-ins found</div>
                                </div>
                            ) : (
                                <table>
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Date/Time</th>
                                            <th>Type</th>
                                            <th>Mood</th>
                                            <th>Energy</th>
                                            <th>Sleep</th>
                                            <th>Cravings</th>
                                            <th>Notes</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredCheckIns.map(checkIn => (
                                            <tr key={checkIn.id}>
                                                <td>{checkIn.userName || 'Unknown'}</td>
                                                <td>{new Date(checkIn.createdAt?.toDate()).toLocaleString()}</td>
                                                <td>{checkIn.type || 'morning'}</td>
                                                <td>
                                                    <span className={`mood-badge ${
                                                        checkIn.morningData?.mood >= 7 ? 'high' :
                                                        checkIn.morningData?.mood >= 4 ? 'medium' : 'low'
                                                    }`}>
                                                        {checkIn.morningData?.mood || '-'}/10
                                                    </span>
                                                </td>
                                                <td>{checkIn.morningData?.energy || '-'}/10</td>
                                                <td>{checkIn.morningData?.sleep || '-'}/10</td>
                                                <td>{checkIn.morningData?.craving || '-'}/10</td>
                                                <td>{checkIn.morningData?.notes || checkIn.eveningData?.reflection || '-'}</td>
                                                <td>
                                                    <button className="feedback-action-btn">Flag</button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                        </div>
                    </>
                );
            }

            // Assignments View - COMPLETE
            function AssignmentsView({ assignments, pirs, coaches, onShowModal }) {
                const [filter, setFilter] = useState('all');
                
                const filteredAssignments = assignments.filter(a => {
                    if (filter === 'overdue') {
                        if (a.dueDate && a.status !== 'completed') {
                            const dueDate = a.dueDate.toDate ? a.dueDate.toDate() : new Date(a.dueDate);
                            return dueDate < new Date();
                        }
                        return false;
                    }
                    if (filter === 'pending') return a.status === 'pending';
                    if (filter === 'completed') return a.status === 'completed';
                    return true;
                });
                
                const handleCompleteAssignment = async (assignmentId) => {
                    await db.collection('assignments').doc(assignmentId).update({
                        status: 'completed',
                        completedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                };
                
                return (
                    <>
                        <div className="quick-actions">
                            <button className="quick-action-btn" onClick={() => onShowModal('createAssignment')}>
                                ➕ Create Assignment
                            </button>
                        </div>
                        
                        <div className="feed-filters" style={{marginBottom: '20px'}}>
                            <button 
                                className={`filter-btn ${filter === 'all' ? 'active' : ''}`}
                                onClick={() => setFilter('all')}
                            >All ({assignments.length})</button>
                            <button 
                                className={`filter-btn ${filter === 'pending' ? 'active' : ''}`}
                                onClick={() => setFilter('pending')}
                            >Pending</button>
                            <button 
                                className={`filter-btn ${filter === 'overdue' ? 'active' : ''}`}
                                onClick={() => setFilter('overdue')}
                            >Overdue</button>
                            <button 
                                className={`filter-btn ${filter === 'completed' ? 'active' : ''}`}
                                onClick={() => setFilter('completed')}
                            >Completed</button>
                        </div>
                        
                        <div className="table-container">
                            {filteredAssignments.length === 0 ? (
                                <div className="empty-state">
                                    <div className="empty-state-text">No assignments found</div>
                                </div>
                            ) : (
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>PIR</th>
                                            <th>Coach</th>
                                            <th>Due Date</th>
                                            <th>Status</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredAssignments.map(assignment => (
                                            <tr key={assignment.id}>
                                                <td>{assignment.title}</td>
                                                <td>{assignment.pirName || 'Unknown'}</td>
                                                <td>{assignment.coachName || 'Unknown'}</td>
                                                <td>{assignment.dueDate ? new Date(assignment.dueDate.toDate ? assignment.dueDate.toDate() : assignment.dueDate).toLocaleDateString() : '-'}</td>
                                                <td>
                                                    <span className={`mood-badge ${
                                                        assignment.status === 'completed' ? 'high' :
                                                        assignment.status === 'pending' ? 'medium' : 'low'
                                                    }`}>
                                                        {assignment.status}
                                                    </span>
                                                </td>
                                                <td>{formatTime(assignment.createdAt)}</td>
                                                <td>
                                                    {assignment.status !== 'completed' && (
                                                        <button 
                                                            className="feedback-action-btn"
                                                            onClick={() => handleCompleteAssignment(assignment.id)}
                                                        >
                                                            Complete
                                                        </button>
                                                    )}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                        </div>
                    </>
                );
            }

            // Alerts View - COMPLETE
            function AlertsView({ alerts, users }) {
                const [filter, setFilter] = useState('all');
                
                const filteredAlerts = alerts.filter(a => {
                    if (filter === 'critical') return a.severity === 'critical';
                    if (filter === 'resolved') return a.status === 'resolved';
                    if (filter === 'active') return a.status === 'active';
                    return true;
                });
                
                const handleResolveAlert = async (alertId) => {
                    await db.collection('alerts').doc(alertId).update({
                        status: 'resolved',
                        resolvedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                };
                
                return (
                    <>
                        <div className="feed-filters" style={{marginBottom: '20px'}}>
                            <button 
                                className={`filter-btn ${filter === 'all' ? 'active' : ''}`}
                                onClick={() => setFilter('all')}
                            >All Alerts</button>
                            <button 
                                className={`filter-btn ${filter === 'critical' ? 'active' : ''}`}
                                onClick={() => setFilter('critical')}
                                style={{color: '#ff4757'}}
                            >SOS ({alerts.filter(a => a.severity === 'critical').length})</button>
                            <button 
                                className={`filter-btn ${filter === 'active' ? 'active' : ''}`}
                                onClick={() => setFilter('active')}
                            >Active</button>
                            <button 
                                className={`filter-btn ${filter === 'resolved' ? 'active' : ''}`}
                                onClick={() => setFilter('resolved')}
                            >Resolved</button>
                        </div>
                        
                        {filteredAlerts.length === 0 ? (
                            <div className="empty-state">
                                <div className="empty-state-icon">✅</div>
                                <div className="empty-state-title">No Alerts</div>
                                <div className="empty-state-text">All clear - no active alerts</div>
                            </div>
                        ) : (
                            <div className="user-grid">
                                {filteredAlerts.map(alert => {
                                    const user = users.find(u => u.id === alert.userId);
                                    return (
                                        <div key={alert.id} className="user-card" style={{
                                            borderColor: alert.severity === 'critical' ? '#ff4757' : ''
                                        }}>
                                            <div className="user-header">
                                                <div className="user-avatar">🚨</div>
                                                <div className="user-info">
                                                    <div className="user-name">{alert.userName || user?.displayName || 'Unknown'}</div>
                                                    <div className="user-role" style={{
                                                        background: alert.severity === 'critical' ? 'rgba(255, 71, 87, 0.2)' : '',
                                                        color: alert.severity === 'critical' ? '#ff4757' : ''
                                                    }}>
                                                        {alert.severity === 'critical' ? 'SOS ALERT' : alert.type}
                                                    </div>
                                                </div>
                                            </div>
                                            <div style={{padding: '15px 0'}}>
                                                <p style={{color: 'rgba(255,255,255,0.9)', marginBottom: '10px'}}>
                                                    {alert.message || 'Emergency alert triggered'}
                                                </p>
                                                <p style={{color: 'rgba(255,255,255,0.6)', fontSize: '13px'}}>
                                                    {formatTime(alert.createdAt)}
                                                </p>
                                            </div>
                                            {user?.emergencyContacts && user.emergencyContacts.length > 0 && (
                                                <div style={{marginBottom: '15px', padding: '10px', background: 'rgba(255,255,255,0.05)', borderRadius: '10px'}}>
                                                    <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.6)', marginBottom: '5px'}}>
                                                        Emergency Contacts:
                                                    </div>
                                                    {user.emergencyContacts.map((contact, idx) => (
                                                        <div key={idx} style={{color: 'white', fontSize: '14px'}}>
                                                            {contact.name}: {contact.phone}
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                            <div className="user-actions">
                                                {alert.status === 'active' && (
                                                    <button 
                                                        className="btn btn-danger" 
                                                        style={{width: '100%'}}
                                                        onClick={() => handleResolveAlert(alert.id)}
                                                    >
                                                        Resolve Alert
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </>
                );
            }

            // Reports View - COMPLETE
            function ReportsView({ pirs, coaches, activities, checkIns, assignments, systemStats }) {
                const [reportType, setReportType] = useState('system');
                const [dateRange, setDateRange] = useState('month');
                
                const generateReport = () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Add header
                    doc.setFontSize(20);
                    doc.text('GLRS System Report', 20, 20);
                    
                    // Add date
                    doc.setFontSize(12);
                    doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 30);
                    
                    // Add stats
                    doc.setFontSize(14);
                    doc.text('System Statistics', 20, 45);
                    
                    doc.setFontSize(12);
                    doc.text(`Total PIRs: ${systemStats.totalPirs}`, 20, 55);
                    doc.text(`Active PIRs: ${systemStats.activePirs}`, 20, 65);
                    doc.text(`Total Coaches: ${systemStats.totalCoaches}`, 20, 75);
                    doc.text(`Check-in Rate: ${systemStats.checkInRate}%`, 20, 85);
                    doc.text(`SOS Alerts: ${systemStats.sosAlerts}`, 20, 95);
                    doc.text(`Pending Feedback: ${systemStats.pendingFeedback}`, 20, 105);
                    
                    // Save the PDF
                    doc.save(`GLRS_Report_${new Date().toISOString().split('T')[0]}.pdf`);
                };
                
                return (
                    <>
                        <div style={{marginBottom: '20px'}}>
                            <select 
                                className="form-select" 
                                value={reportType}
                                onChange={(e) => setReportType(e.target.value)}
                                style={{marginRight: '15px', width: '200px'}}
                            >
                                <option value="system">System Report</option>
                                <option value="users">User Report</option>
                                <option value="checkins">Check-ins Report</option>
                                <option value="assignments">Assignments Report</option>
                            </select>
                            
                            <select 
                                className="form-select"
                                value={dateRange}
                                onChange={(e) => setDateRange(e.target.value)}
                                style={{marginRight: '15px', width: '200px'}}
                            >
                                <option value="week">Last Week</option>
                                <option value="month">Last Month</option>
                                <option value="quarter">Last Quarter</option>
                                <option value="year">Last Year</option>
                            </select>
                            
                            <button className="btn btn-primary" onClick={generateReport}>
                                📄 Generate PDF Report
                            </button>
                        </div>
                        
                        <div className="dashboard-grid">
                            <div className="stat-card">
                                <div className="stat-label">Total PIRs</div>
                                <div className="stat-value">{systemStats.totalPirs}</div>
                                <div className="stat-change positive">Active: {systemStats.activePirs}</div>
                            </div>
                            
                            <div className="stat-card">
                                <div className="stat-label">Check-in Compliance</div>
                                <div className="stat-value">{systemStats.checkInRate}%</div>
                                <div className="stat-change">Daily average</div>
                            </div>
                            
                            <div className="stat-card">
                                <div className="stat-label">Assignments Completed</div>
                                <div className="stat-value">
                                    {assignments.filter(a => a.status === 'completed').length}
                                </div>
                                <div className="stat-change">
                                    Of {assignments.length} total
                                </div>
                            </div>
                            
                            <div className="stat-card">
                                <div className="stat-label">Average Mood</div>
                                <div className="stat-value">
                                    {checkIns.length > 0 ? 
                                        (checkIns.reduce((sum, c) => sum + (c.morningData?.mood || 0), 0) / 
                                         checkIns.filter(c => c.morningData?.mood).length).toFixed(1) : '0'}
                                </div>
                                <div className="stat-change">Last 7 days</div>
                            </div>
                        </div>
                    </>
                );
            }

            // Settings View - COMPLETE
            function SettingsView({ adminData, onUpdate }) {
                const [formData, setFormData] = useState({
                    firstName: adminData?.firstName || '',
                    lastName: adminData?.lastName || '',
                    email: adminData?.email || '',
                    phone: adminData?.phone || '',
                    notifications: adminData?.notifications || {
                        sosAlerts: true,
                        newPirs: true,
                        feedback: true,
                        checkIns: false
                    }
                });
                
                const handleSave = async () => {
                    await onUpdate(formData);
                    alert('Settings saved successfully!');
                };
                
                const handlePasswordReset = () => {
                    auth.sendPasswordResetEmail(adminData.email)
                        .then(() => alert('Password reset email sent!'))
                        .catch(error => alert('Error: ' + error.message));
                };
                
                return (
                    <div className="user-detail-container">
                        <h2 style={{color: 'white', marginBottom: '30px'}}>System Settings</h2>
                        
                        <div className="tab-nav">
                            <button className="tab-btn active">Profile</button>
                            <button className="tab-btn">Notifications</button>
                            <button className="tab-btn">Security</button>
                        </div>
                        
                        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '30px', marginTop: '30px'}}>
                            <div>
                                <h3 style={{color: 'white', marginBottom: '20px'}}>Admin Profile</h3>
                                <div className="form-group">
                                    <label className="form-label">First Name</label>
                                    <input 
                                        type="text"
                                        className="form-input"
                                        value={formData.firstName}
                                        onChange={(e) => setFormData({...formData, firstName: e.target.value})}
                                    />
                                </div>
                                
                                <div className="form-group">
                                    <label className="form-label">Last Name</label>
                                    <input 
                                        type="text"
                                        className="form-input"
                                        value={formData.lastName}
                                        onChange={(e) => setFormData({...formData, lastName: e.target.value})}
                                    />
                                </div>
                                
                                <div className="form-group">
                                    <label className="form-label">Email</label>
                                    <input 
                                        type="email"
                                        className="form-input"
                                        value={formData.email}
                                        onChange={(e) => setFormData({...formData, email: e.target.value})}
                                    />
                                </div>
                                
                                <div className="form-group">
                                    <label className="form-label">Phone</label>
                                    <input 
                                        type="tel"
                                        className="form-input"
                                        value={formData.phone}
                                        onChange={(e) => setFormData({...formData, phone: e.target.value})}
                                    />
                                </div>
                            </div>
                            
                            <div>
                                <h3 style={{color: 'white', marginBottom: '20px'}}>Notification Preferences</h3>
                                
                                <div className="checkbox-group">
                                    <input 
                                        type="checkbox"
                                        id="sos"
                                        checked={formData.notifications.sosAlerts}
                                        onChange={(e) => setFormData({
                                            ...formData,
                                            notifications: {...formData.notifications, sosAlerts: e.target.checked}
                                        })}
                                    />
                                    <label htmlFor="sos">SOS Alerts</label>
                                </div>
                                
                                <div className="checkbox-group">
                                    <input 
                                        type="checkbox"
                                        id="newpirs"
                                        checked={formData.notifications.newPirs}
                                        onChange={(e) => setFormData({
                                            ...formData,
                                            notifications: {...formData.notifications, newPirs: e.target.checked}
                                        })}
                                    />
                                    <label htmlFor="newpirs">New PIR Registrations</label>
                                </div>
                                
                                <div className="checkbox-group">
                                    <input 
                                        type="checkbox"
                                        id="feedback"
                                        checked={formData.notifications.feedback}
                                        onChange={(e) => setFormData({
                                            ...formData,
                                            notifications: {...formData.notifications, feedback: e.target.checked}
                                        })}
                                    />
                                    <label htmlFor="feedback">New Feedback</label>
                                </div>
                                
                                <div className="checkbox-group">
                                    <input 
                                        type="checkbox"
                                        id="checkins"
                                        checked={formData.notifications.checkIns}
                                        onChange={(e) => setFormData({
                                            ...formData,
                                            notifications: {...formData.notifications, checkIns: e.target.checked}
                                        })}
                                    />
                                    <label htmlFor="checkins">Low Mood Check-ins</label>
                                </div>
                                
                                <h3 style={{color: 'white', margin: '30px 0 20px'}}>Security</h3>
                                <button className="btn btn-secondary" onClick={handlePasswordReset}>
                                    Reset Password
                                </button>
                            </div>
                        </div>
                        
                        <div style={{marginTop: '30px'}}>
                            <button className="btn btn-primary" onClick={handleSave}>
                                Save Settings
                            </button>
                        </div>
                    </div>
                );
            }

            // User Detail View - COMPLETE
            function UserDetailView({ user, checkIns, assignments, messages, onBack, onShowModal, onRefresh }) {
                const [activeTab, setActiveTab] = useState('overview');
                
                const userCheckIns = checkIns.filter(c => c.userId === user.id);
                const userAssignments = assignments.filter(a => a.pirId === user.id);
                const userMessages = messages.filter(m => 
                    m.senderId === user.id || m.recipientId === user.id
                );
                
                const handleReassign = async () => {
                    const newCoachId = prompt('Enter new coach ID:');
                    if (newCoachId) {
                        await db.collection('users').doc(user.id).update({
                            assignedCoach: newCoachId
                        });
                        alert('Coach reassigned successfully!');
                        onRefresh();
                    }
                };
                
                const handleExport = () => {
                    const userData = {
                        profile: user,
                        checkIns: userCheckIns,
                        assignments: userAssignments,
                        messages: userMessages
                    };
                    
                    const dataStr = JSON.stringify(userData, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    
                    const exportFileDefaultName = `${user.displayName || user.id}_data.json`;
                    
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', exportFileDefaultName);
                    linkElement.click();
                };
                
                return (
                    <div className="user-detail-container">
                        <button onClick={onBack} className="btn btn-secondary" style={{marginBottom: '20px'}}>
                            ← Back to Users
                        </button>
                        
                        <div className="user-detail-header">
                            <div className="user-detail-avatar">
                                {user.profileImageUrl ? (
                                    <img src={user.profileImageUrl} alt={user.displayName} style={{width: '100%', height: '100%', borderRadius: '50%', objectFit: 'cover'}} />
                                ) : (
                                    (user.displayName || user.email || 'U').charAt(0).toUpperCase()
                                )}
                            </div>
                            <div className="user-detail-info">
                                <div className="user-detail-name">
                                    {user.displayName || user.email?.split('@')[0] || 'Unknown User'}
                                </div>
                                <div className="user-detail-meta">
                                    <span>📧 {user.email}</span>
                                    <span>📞 {user.phone || 'No phone'}</span>
                                    <span>📅 Joined {formatTime(user.createdAt)}</span>
                                </div>
                            </div>
                            <div className="user-detail-actions">
                                <button className="btn btn-primary">View as User</button>
                                {user.role === 'pir' && (
                                    <button className="btn btn-secondary" onClick={handleReassign}>
                                        Reassign Coach
                                    </button>
                                )}
                                <button className="btn btn-secondary" onClick={handleExport}>
                                    Export Data
                                </button>
                            </div>
                        </div>
                        
                        <div className="tab-nav">
                            <button 
                                className={`tab-btn ${activeTab === 'overview' ? 'active' : ''}`}
                                onClick={() => setActiveTab('overview')}
                            >
                                Overview
                            </button>
                            <button 
                                className={`tab-btn ${activeTab === 'checkins' ? 'active' : ''}`}
                                onClick={() => setActiveTab('checkins')}
                            >
                                Check-ins ({userCheckIns.length})
                            </button>
                            <button 
                                className={`tab-btn ${activeTab === 'assignments' ? 'active' : ''}`}
                                onClick={() => setActiveTab('assignments')}
                            >
                                Assignments ({userAssignments.length})
                            </button>
                            <button 
                                className={`tab-btn ${activeTab === 'messages' ? 'active' : ''}`}
                                onClick={() => setActiveTab('messages')}
                            >
                                Messages ({userMessages.length})
                            </button>
                        </div>
                        
                        {activeTab === 'overview' && (
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px', marginTop: '20px'}}>
                                <div className="table-container">
                                    <h3 style={{marginBottom: '15px', color: 'white'}}>Personal Information</h3>
                                    <table>
                                        <tbody>
                                            <tr><td>Name</td><td>{user.firstName} {user.lastName}</td></tr>
                                            <tr><td>Email</td><td>{user.email}</td></tr>
                                            <tr><td>Phone</td><td>{user.phone || 'Not provided'}</td></tr>
                                            <tr><td>Role</td><td>{user.role}</td></tr>
                                            <tr><td>Status</td><td>{user.active === false ? 'Inactive' : 'Active'}</td></tr>
                                            {user.sobrietyDate && (
                                                <tr>
                                                    <td>Sobriety Date</td>
                                                    <td>{user.sobrietyDate.toDate ? 
                                                        new Date(user.sobrietyDate.toDate()).toLocaleDateString() :
                                                        new Date(user.sobrietyDate).toLocaleDateString()}</td>
                                                </tr>
                                            )}
                                            {user.assignedCoach && (
                                                <tr><td>Assigned Coach</td><td>{user.assignedCoach}</td></tr>
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                                
                                {user.emergencyContacts && user.emergencyContacts.length > 0 && (
                                    <div className="table-container">
                                        <h3 style={{marginBottom: '15px', color: 'white'}}>Emergency Contacts</h3>
                                        <table>
                                            <tbody>
                                                {user.emergencyContacts.map((contact, index) => (
                                                    <tr key={index}>
                                                        <td>{contact.name}</td>
                                                        <td>{contact.phone}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {activeTab === 'checkins' && (
                            <div className="table-container" style={{marginTop: '20px'}}>
                                {userCheckIns.length === 0 ? (
                                    <div className="empty-state">
                                        <div className="empty-state-text">No check-ins yet</div>
                                    </div>
                                ) : (
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Time</th>
                                                <th>Mood</th>
                                                <th>Energy</th>
                                                <th>Sleep</th>
                                                <th>Cravings</th>
                                                <th>Notes</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {userCheckIns.map(checkIn => (
                                                <tr key={checkIn.id}>
                                                    <td>{checkIn.createdAt?.toDate ? 
                                                        new Date(checkIn.createdAt.toDate()).toLocaleDateString() : '-'}</td>
                                                    <td>{checkIn.type || 'morning'}</td>
                                                    <td>
                                                        <span className={`mood-badge ${
                                                            checkIn.morningData?.mood >= 7 ? 'high' :
                                                            checkIn.morningData?.mood >= 4 ? 'medium' : 'low'
                                                        }`}>
                                                            {checkIn.morningData?.mood || '-'}/10
                                                        </span>
                                                    </td>
                                                    <td>{checkIn.morningData?.energy || '-'}/10</td>
                                                    <td>{checkIn.morningData?.sleep || '-'}/10</td>
                                                    <td>{checkIn.morningData?.craving || '-'}/10</td>
                                                    <td>{checkIn.morningData?.notes || checkIn.eveningData?.reflection || '-'}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                )}
                            </div>
                        )}
                        
                        {activeTab === 'assignments' && (
                            <div className="table-container" style={{marginTop: '20px'}}>
                                {userAssignments.length === 0 ? (
                                    <div className="empty-state">
                                        <div className="empty-state-text">No assignments yet</div>
                                    </div>
                                ) : (
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Title</th>
                                                <th>Description</th>
                                                <th>Due Date</th>
                                                <th>Status</th>
                                                <th>Created</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {userAssignments.map(assignment => (
                                                <tr key={assignment.id}>
                                                    <td>{assignment.title}</td>
                                                    <td>{assignment.description}</td>
                                                    <td>{assignment.dueDate ? 
                                                        (assignment.dueDate.toDate ? 
                                                            new Date(assignment.dueDate.toDate()).toLocaleDateString() :
                                                            new Date(assignment.dueDate).toLocaleDateString()) : '-'}</td>
                                                    <td>
                                                        <span className={`mood-badge ${
                                                            assignment.status === 'completed' ? 'high' :
                                                            assignment.status === 'pending' ? 'medium' : 'low'
                                                        }`}>
                                                            {assignment.status}
                                                        </span>
                                                    </td>
                                                    <td>{formatTime(assignment.createdAt)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                )}
                            </div>
                        )}
                        
                        {activeTab === 'messages' && (
                            <div style={{marginTop: '20px'}}>
                                {userMessages.length === 0 ? (
                                    <div className="empty-state">
                                        <div className="empty-state-text">No messages yet</div>
                                    </div>
                                ) : (
                                    <div style={{maxHeight: '400px', overflowY: 'auto', background: 'rgba(255,255,255,0.05)', borderRadius: '15px', padding: '20px'}}>
                                        {userMessages.map(message => (
                                            <div key={message.id} className={`message ${message.senderId === user.id ? 'received' : 'sent'}`}>
                                                <div>{message.text}</div>
                                                <div className="message-time">{formatTime(message.createdAt)}</div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                );
            }

            // Login Screen Component
            function LoginScreen() {
                const [email, setEmail] = useState('');
                const [password, setPassword] = useState('');
                const [loading, setLoading] = useState(false);
                const [error, setError] = useState('');
                
                const handleLogin = async (e) => {
                    e.preventDefault();
                    setLoading(true);
                    setError('');
                    
                    try {
                        await auth.signInWithEmailAndPassword(email, password);
                    } catch (error) {
                        console.error('Login error:', error);
                        if (error.code === 'auth/wrong-password') {
                            setError('Incorrect password');
                        } else if (error.code === 'auth/user-not-found') {
                            setError('User not found');
                        } else {
                            setError('Login failed. Please try again.');
                        }
                    } finally {
                        setLoading(false);
                    }
                };
                
                return (
                    <div className="login-container">
                        <div className="login-card">
                            <div className="login-logo">
                                <div className="login-logo-icon">🛡️</div>
                                <h1 className="login-title">Admin Portal</h1>
                                <p className="login-subtitle">GLRS Command Center</p>
                            </div>
                            
                            <form onSubmit={handleLogin}>
                                <div className="form-group">
                                    <label className="form-label">Email</label>
                                    <input 
                                        type="email"
                                        className="form-input"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        required
                                        placeholder="admin@example.com"
                                    />
                                </div>
                                
                                <div className="form-group">
                                    <label className="form-label">Password</label>
                                    <input 
                                        type="password"
                                        className="form-input"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        required
                                        placeholder="••••••••"
                                    />
                                </div>
                                
                                {error && (
                                    <div style={{
                                        background: 'rgba(255, 71, 87, 0.1)',
                                        border: '1px solid #ff4757',
                                        color: '#ff4757',
                                        padding: '10px',
                                        borderRadius: '10px',
                                        marginBottom: '20px',
                                        fontSize: '14px'
                                    }}>
                                        {error}
                                    </div>
                                )}
                                
                                <button 
                                    type="submit"
                                    className="btn btn-primary"
                                    style={{width: '100%'}}
                                    disabled={loading}
                                >
                                    {loading ? 'Logging in...' : 'Login'}
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }

            // Modal Component - COMPLETE WITH ALL TYPES
            function Modal({ type, onClose, users, coaches, pirs, onRefresh }) {
                const [formData, setFormData] = useState({});
                const [loading, setLoading] = useState(false);
                const [selectedFile, setSelectedFile] = useState(null);
                
                const getModalTitle = () => {
                    const titles = {
                        createUser: 'Create New User',
                        broadcastMessage: 'Broadcast Message',
                        createResource: 'Add Resource',
                        createGroup: 'Create Support Group',
                        createAssignment: 'Create Assignment',
                        exportData: 'Export Data',
                        generateReport: 'Generate Report'
                    };
                    return titles[type] || 'Modal';
                };
                
                // Create User Handler
                const handleCreateUser = async () => {
                    setLoading(true);
                    try {
                        // Create auth account
                        const userCredential = await auth.createUserWithEmailAndPassword(
                            formData.email,
                            formData.password || 'TempPassword123!'
                        );
                        
                        // Create Firestore profile
                        await db.collection('users').doc(userCredential.user.uid).set({
                            email: formData.email,
                            displayName: `${formData.firstName} ${formData.lastName}`,
                            firstName: formData.firstName,
                            lastName: formData.lastName,
                            phone: formData.phone || '',
                            role: formData.role,
                            assignedCoach: formData.role === 'pir' ? formData.assignedCoach : null,
                            active: true,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // Send password reset email
                        await auth.sendPasswordResetEmail(formData.email);
                        
                        alert('User created successfully! Password reset email sent.');
                        onRefresh();
                        onClose();
                    } catch (error) {
                        alert('Error creating user: ' + error.message);
                    } finally {
                        setLoading(false);
                    }
                };
                
                // Broadcast Message Handler
                const handleBroadcastMessage = async () => {
                    setLoading(true);
                    try {
                        const recipients = formData.recipient === 'pirs' ? pirs :
                                         formData.recipient === 'coaches' ? coaches :
                                         [...pirs, ...coaches];
                        
                        for (const recipient of recipients) {
                            await db.collection('messages').add({
                                text: formData.message,
                                senderId: admin.uid,
                                senderName: 'Admin',
                                recipientId: recipient.id,
                                recipientName: recipient.displayName || recipient.email,
                                type: 'broadcast',
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                read: false
                            });
                        }
                        
                        alert('Broadcast sent successfully!');
                        onClose();
                    } catch (error) {
                        alert('Error sending broadcast: ' + error.message);
                    } finally {
                        setLoading(false);
                    }
                };
                
                // Create Resource Handler
                const handleCreateResource = async () => {
                    setLoading(true);
                    try {
                        let resourceUrl = formData.url || '';
                        
                        // Upload file if selected
                        if (selectedFile) {
                            const storageRef = storage.ref(`resources/${Date.now()}_${selectedFile.name}`);
                            const uploadTask = await storageRef.put(selectedFile);
                            resourceUrl = await uploadTask.ref.getDownloadURL();
                        }
                        
                        await db.collection('resources').add({
                            title: formData.title,
                            description: formData.description,
                            category: formData.category,
                            url: resourceUrl,
                            type: selectedFile ? 'file' : 'link',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            downloads: 0
                        });
                        
                        alert('Resource created successfully!');
                        onRefresh();
                        onClose();
                    } catch (error) {
                        alert('Error creating resource: ' + error.message);
                    } finally {
                        setLoading(false);
                    }
                };
                
                // Create Group Handler
                const handleCreateGroup = async () => {
                    setLoading(true);
                    try {
                        await db.collection('supportGroups').add({
                            name: formData.name,
                            description: formData.description,
                            type: formData.type || 'Support Group',
                            capacity: parseInt(formData.capacity) || 10,
                            schedule: formData.schedule || 'Weekly',
                            meetingLink: formData.meetingLink || '',
                            members: [],
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        alert('Support group created successfully!');
                        onRefresh();
                        onClose();
                    } catch (error) {
                        alert('Error creating group: ' + error.message);
                    } finally {
                        setLoading(false);
                    }
                };
                
                // Create Assignment Handler
                const handleCreateAssignment = async () => {
                    setLoading(true);
                    try {
                        const pir = pirs.find(p => p.id === formData.pirId);
                        const coach = coaches.find(c => c.id === formData.coachId);
                        
                        await db.collection('assignments').add({
                            title: formData.title,
                            description: formData.description,
                            pirId: formData.pirId,
                            pirName: pir?.displayName || pir?.email,
                            coachId: formData.coachId || admin.uid,
                            coachName: coach?.displayName || 'Admin',
                            dueDate: formData.dueDate ? new Date(formData.dueDate) : null,
                            status: 'pending',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        alert('Assignment created successfully!');
                        onRefresh();
                        onClose();
                    } catch (error) {
                        alert('Error creating assignment: ' + error.message);
                    } finally {
                        setLoading(false);
                    }
                };
                
                // Export Data Handler
                const handleExportData = () => {
                    const data = {
                        users: users,
                        checkIns: checkIns,
                        assignments: assignments,
                        resources: resources,
                        exportedAt: new Date().toISOString()
                    };
                    
                    const dataStr = JSON.stringify(data, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    
                    const exportFileDefaultName = `GLRS_Export_${new Date().toISOString().split('T')[0]}.json`;
                    
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', exportFileDefaultName);
                    linkElement.click();
                    
                    onClose();
                };
                
                const handleSubmit = () => {
                    switch (type) {
                        case 'createUser':
                            handleCreateUser();
                            break;
                        case 'broadcastMessage':
                            handleBroadcastMessage();
                            break;
                        case 'createResource':
                            handleCreateResource();
                            break;
                        case 'createGroup':
                            handleCreateGroup();
                            break;
                        case 'createAssignment':
                            handleCreateAssignment();
                            break;
                        case 'exportData':
                            handleExportData();
                            break;
                        default:
                            onClose();
                    }
                };
                
                return (
                    <div className="modal-overlay" onClick={(e) => e.target === e.currentTarget && onClose()}>
                        <div className="modal">
                            <div className="modal-header">
                                <h2 className="modal-title">{getModalTitle()}</h2>
                                <button className="modal-close" onClick={onClose}>×</button>
                            </div>
                            
                            {type === 'createUser' && (
                                <>
                                    <div className="form-row">
                                        <div className="form-group">
                                            <label className="form-label">First Name</label>
                                            <input 
                                                type="text"
                                                className="form-input"
                                                onChange={(e) => setFormData({...formData, firstName: e.target.value})}
                                                required
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Last Name</label>
                                            <input 
                                                type="text"
                                                className="form-input"
                                                onChange={(e) => setFormData({...formData, lastName: e.target.value})}
                                                required
                                            />
                                        </div>
                                    </div>
                                    
                                    <div className="form-group">
                                        <label className="form-label">Email</label>
                                        <input 
                                            type="email"
                                            className="form-input"
                                            onChange={(e) => setFormData({...formData, email: e.target.value})}
                                            required
                                        />
                                    </div>
                                    
                                    <div className="form-group">
                                        <label className="form-label">Phone (Optional)</label>
                                        <input 
                                            type="tel"
                                            className="form-input"
                                            onChange={(e) => setFormData({...formData, phone: e.target.value})}
                                        />
                                    </div>
                                    
                                    <div className="form-group">
                                        <label className="form-label">Role</label>
                                        <select 
                                            className="form-select"
                                            onChange={(e) => setFormData({...formData, role: e.target.value})}
                                            required
                                        >
                                            <option value="">Select Role</option>
                                            <option value="pir">PIR</option>
                                            <option value="coach">Coach</option>
                                        </select>
                                    </div>
                                    
                                    {formData.role === 'pir' && (
                                        <div className="form-group">
                                            <label className="form-label">Assign to Coach</label>
                                            <select 
                                                className="form-select"
                                                onChange={(e) => setFormData({...formData, assignedCoach: e.target.value})}
                                            >
                                                <option value="">Select Coach</option>
                                                {coaches.map(coach => (
                                                    <option key={coach.id} value={coach.id}>
                                                        {coach.displayName || coach.email}
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                    )}
                                </>
                            )}
                            
                            {type === 'broadcastMessage' && (
                                <>
                                    <div className="form-group">
                                        <label className="form-label">Recipients</label>
                                        <select 
                                            className="form-select"
                                            onChange={(e) => setFormData({...formData, recipient: e.target.value})}
                                            required
                                        >
                                            <option value="">Select Recipients</option>
                                            <option value="pirs">All PIRs</option>
                                            <option value="coaches">All Coaches</option>
                                            <option value="everyone">Everyone</option>
                                        </select>
                                    </div>
                                    
                                    <div className="form-group">
                                        <label className="form-label">Message</label>
                                        <textarea 
                                            className="form-textarea"
                                            rows="5"
                                            onChange={(e) => setFormData({...formData, message: e.target.value})}
                                            required
                                        ></textarea>
                                    </div>
                                </>
                            )}
                            
                            {type === 'createResource' && (
                                <>
                                    <div className="form-group">
                                        <label className="form-label">Title</label>
                                        <input 
                                            type="text"
                                            className="form-input"
                                            onChange={(e) => setFormData({...formData, title: e.target.value})}
                                            required
                                        />
                                    </div>
                                    
                                    <div className="form-group">
                                        <label className="form-label">Description</label>
                                        <textarea 
                                            className="form-textarea"
                                            rows="3"
                                            onChange={(e) => setFormData({...formData, description: e.target.value})}
                                            required
                                        ></textarea>
                                    </div>
                                    
                                    <div className="form-group">
                                        <label className="form-label">Category</label>
                                        <select 
                                            className="form-select"
                                            onChange={(e) => setFormData({...formData, category: e.target.value})}
                                            required
                                        >
                                            <option value="">Select Category</option>
                                            <option value="videos">Videos</option>
                                            <option value="articles">Articles</option>
                                            <option value="worksheets">Worksheets</option>
                                            <option value="meditations">Meditations</option>
                                            <option value="books">Books</option>
                                        </select>
                                    </div>
                                    
                                    <div className="form-group">
                                        <label className="form-label">Upload File or Add URL</label>
                                        <input 
                                            type="file"
                                            className="form-input"
                                            onChange={(e) => setSelectedFile(e.target.files[0])}
                                        />
                                        <p style={{margin: '10px 0', color: 'rgba(255,255,255,0.6)'}}>OR</p>
                                        <input 
                                            type="url"
                                            className="form-input"
                                            placeholder="Resource URL"
                                            onChange={(e) => setFormData({...formData, url: e.target.value})}
                                        />
                                    </div>
                                </>
                            )}
                            
                            {type === 'createGroup' && (
                                <>
                                    <div className="form-group">
                                        <label className="form-label">Group Name</label>
                                        <input 
                                            type="text"
                                            className="form-input"
                                            onChange={(e) => setFormData({...formData, name: e.target.value})}
                                            required
                                        />
                                    </div>
                                    
                                    <div className="form-group">
                                        <label className="form-label">Description</label>
                                        <textarea 
                                            className="form-textarea"
                                            rows="3"
                                            onChange={(e) => setFormData({...formData, description: e.target.value})}
                                            required
                                        ></textarea>
                                    </div>
                                    
                                    <div className="form-row">
                                        <div className="form-group">
                                            <label className="form-label">Capacity</label>
                                            <input 
                                                type="number"
                                                className="form-input"
                                                min="1"
                                                onChange={(e) => setFormData({...formData, capacity: e.target.value})}
                                                placeholder="10"
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Schedule</label>
                                            <select 
                                                className="form-select"
                                                onChange={(e) => setFormData({...formData, schedule: e.target.value})}
                                            >
                                                <option value="Weekly">Weekly</option>
                                                <option value="Bi-weekly">Bi-weekly</option>
                                                <option value="Monthly">Monthly</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div className="form-group">
                                        <label className="form-label">Meeting Link (Optional)</label>
                                        <input 
                                            type="url"
                                            className="form-input"
                                            placeholder="Zoom/Meet link"
                                            onChange={(e) => setFormData({...formData, meetingLink: e.target.value})}
                                        />
                                    </div>
                                </>
                            )}
                            
                            {type === 'createAssignment' && (
                                <>
                                    <div className="form-group">
                                        <label className="form-label">Title</label>
                                        <input 
                                            type="text"
                                            className="form-input"
                                            onChange={(e) => setFormData({...formData, title: e.target.value})}
                                            required
                                        />
                                    </div>
                                    
                                    <div className="form-group">
                                        <label className="form-label">Description</label>
                                        <textarea 
                                            className="form-textarea"
                                            rows="3"
                                            onChange={(e) => setFormData({...formData, description: e.target.value})}
                                            required
                                        ></textarea>
                                    </div>
                                    
                                    <div className="form-group">
                                        <label className="form-label">Assign to PIR</label>
                                        <select 
                                            className="form-select"
                                            onChange={(e) => setFormData({...formData, pirId: e.target.value})}
                                            required
                                        >
                                            <option value="">Select PIR</option>
                                            {pirs.map(pir => (
                                                <option key={pir.id} value={pir.id}>
                                                    {pir.displayName || pir.email}
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                    
                                    <div className="form-group">
                                        <label className="form-label">Due Date (Optional)</label>
                                        <input 
                                            type="date"
                                            className="form-input"
                                            onChange={(e) => setFormData({...formData, dueDate: e.target.value})}
                                        />
                                    </div>
                                </>
                            )}
                            
                            {type === 'exportData' && (
                                <div style={{padding: '20px', textAlign: 'center'}}>
                                    <p style={{color: 'white', marginBottom: '20px'}}>
                                        This will export all system data as a JSON file. 
                                        The export includes users, check-ins, assignments, and resources.
                                    </p>
                                </div>
                            )}
                            
                            <div className="modal-footer">
                                <button 
                                    className="btn btn-primary" 
                                    onClick={handleSubmit}
                                    disabled={loading}
                                >
                                    {loading ? 'Processing...' : 
                                     type === 'exportData' ? 'Export' : 'Create'}
                                </button>
                                <button className="btn btn-secondary" onClick={onClose}>
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // Utility functions
            function formatTime(timestamp) {
                if (!timestamp) return '';
                
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                const now = new Date();
                const diff = now - date;
                
                if (diff < 60000) return 'just now';
                if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
                if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
                
                return date.toLocaleDateString();
            }
            
            // Handle logout
            const handleLogout = async () => {
                try {
                    listeners.current.forEach(unsubscribe => unsubscribe());
                    listeners.current = [];
                    await auth.signOut();
                    window.location.reload();
                } catch (error) {
                    console.error('Error logging out:', error);
                    alert('Error logging out. Please try again.');
                }
            };
            
            // Mark all notifications as read
            const markAllNotificationsRead = () => {
                setNotifications(prev => prev.map(n => ({ ...n, read: true })));
            };
            
            // Get unread notification count
            const unreadCount = notifications.filter(n => !n.read).length;
            
            // Global search filter
            const performGlobalSearch = (query) => {
                if (!query) return;
                
                const results = {
                    users: allUsers.filter(u => 
                        u.displayName?.toLowerCase().includes(query.toLowerCase()) ||
                        u.email?.toLowerCase().includes(query.toLowerCase())
                    ),
                    messages: messages.filter(m =>
                        m.text?.toLowerCase().includes(query.toLowerCase())
                    ),
                    feedback: feedback.filter(f =>
                        f.content?.toLowerCase().includes(query.toLowerCase())
                    )
                };
                
                console.log('Search results:', results);
                alert(`Found: ${results.users.length} users, ${results.messages.length} messages, ${results.feedback.length} feedback items`);
            };
            
            // MAIN RENDER LOGIC
            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="loading-spinner"></div>
                        <div className="loading-text">Loading Admin Portal...</div>
                    </div>
                );
            }
            
            if (!admin) {
                return <LoginScreen />;
            }
            
            return (
                <div className="app-container">
                    <Sidebar 
                        currentView={currentView}
                        onViewChange={setCurrentView}
                        alerts={alerts}
                        feedback={feedback}
                        onLogout={handleLogout}
                    />
                    
                    <div className="main-content">
                        <Header 
                            adminData={adminData}
                            currentView={currentView}
                            notifications={notifications}
                            unreadCount={unreadCount}
                            showNotifications={showNotifications}
                            setShowNotifications={setShowNotifications}
                            markAllRead={markAllNotificationsRead}
                            globalSearch={globalSearch}
                            setGlobalSearch={setGlobalSearch}
                            performSearch={performGlobalSearch}
                        />
                        
                        <div className="content-area">
                            {currentView === 'dashboard' && (
                                <DashboardView 
                                    stats={systemStats}
                                    activities={activities}
                                    alerts={alerts}
                                    pirs={pirs}
                                    coaches={coaches}
                                    onShowModal={setShowModal}
                                    onSelectUser={setSelectedUser}
                                    onViewChange={setCurrentView}
                                />
                            )}
                            
                            {currentView === 'users' && !selectedUser && (
                                <UsersView 
                                    pirs={pirs}
                                    coaches={coaches}
                                    onSelectUser={setSelectedUser}
                                    onShowModal={setShowModal}
                                    onRefresh={loadSystemData}
                                />
                            )}
                            
                            {currentView === 'messages' && (
                                <MessagesView 
                                    messages={messages}
                                    users={allUsers}
                                    admin={admin}
                                    onShowModal={setShowModal}
                                />
                            )}
                            
                            {currentView === 'feedback' && (
                                <FeedbackView 
                                    feedback={feedback}
                                    users={allUsers}
                                    coaches={coaches}
                                />
                            )}
                            
                            {currentView === 'resources' && (
                                <ResourcesView 
                                    resources={resources}
                                    onShowModal={setShowModal}
                                    onRefresh={loadSystemData}
                                />
                            )}
                            
                            {currentView === 'checkins' && (
                                <CheckInsView 
                                    checkIns={checkIns}
                                    pirs={pirs}
                                />
                            )}
                            
                            {currentView === 'assignments' && (
                                <AssignmentsView 
                                    assignments={assignments}
                                    pirs={pirs}
                                    coaches={coaches}
                                    onShowModal={setShowModal}
                                />
                            )}
                            
                            {currentView === 'groups' && (
                                <GroupsView 
                                    groups={supportGroups}
                                    pirs={pirs}
                                    onShowModal={setShowModal}
                                    onRefresh={loadSystemData}
                                />
                            )}
                            
                            {currentView === 'alerts' && (
                                <AlertsView 
                                    alerts={alerts}
                                    users={allUsers}
                                />
                            )}
                            
                            {currentView === 'reports' && (
                                <ReportsView 
                                    pirs={pirs}
                                    coaches={coaches}
                                    activities={activities}
                                    checkIns={checkIns}
                                    assignments={assignments}
                                    systemStats={systemStats}
                                />
                            )}
                            
                            {currentView === 'settings' && (
                                <SettingsView 
                                    adminData={adminData}
                                    onUpdate={async (data) => {
                                        await db.collection('users').doc(admin.uid).update(data);
                                        setAdminData(prev => ({...prev, ...data}));
                                    }}
                                />
                            )}
                            
                            {selectedUser && (
                                <UserDetailView 
                                    user={selectedUser}
                                    checkIns={checkIns}
                                    assignments={assignments}
                                    messages={messages}
                                    onBack={() => setSelectedUser(null)}
                                    onShowModal={setShowModal}
                                    onRefresh={loadSystemData}
                                />
                            )}
                        </div>
                    </div>
                    
                    {showModal && (
                        <Modal 
                            type={showModal}
                            onClose={() => setShowModal(null)}
                            users={allUsers}
                            coaches={coaches}
                            pirs={pirs}
                            onRefresh={loadSystemData}
                        />
                    )}
                </div>
            );
        }
        
        // Render the app
        ReactDOM.render(<AdminApp />, document.getElementById('root'));
    </script>
</body>
</html>
