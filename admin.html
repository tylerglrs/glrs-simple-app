<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GLRS Admin Portal</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jsPDF for PDF exports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1f3a 0%, #0d1117 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }

        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Connection Status Bar */
        .connection-status {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 5px;
            text-align: center;
            font-size: 12px;
            z-index: 2000;
            transition: all 0.3s ease;
        }

        .connection-status.online {
            background: #4caf50;
            transform: translateY(-100%);
        }

        .connection-status.offline {
            background: #f44336;
            transform: translateY(0);
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            color: #000;
            font-weight: bold;
            font-size: 18px;
            text-align: center;
        }

        .nav-section {
            padding: 10px;
        }

        .nav-section-title {
            font-size: 11px;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.5);
            padding: 10px;
            letter-spacing: 1px;
        }

        .nav-item {
            padding: 12px 15px;
            margin: 5px 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            color: #000;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            padding: 20px 30px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .search-bar {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            color: white;
            width: 300px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-bar:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #f4c430;
        }

        .refresh-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
            padding: 10px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .notification-bell:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .notification-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
        }

        .content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        /* Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .stat-label {
            font-size: 12px;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .stat-change {
            font-size: 12px;
            color: #4caf50;
        }

        /* Tables */
        .table-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        th {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.8);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        td {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.9);
        }

        tr:hover td {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
            outline: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            color: #000;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 196, 48, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: #1a1f3a;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #f4c430;
        }

        select.form-input {
            cursor: pointer;
        }

        textarea.form-input {
            resize: vertical;
            min-height: 100px;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
        }

        .page-btn {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .page-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.2);
        }

        .page-btn.active {
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            color: #000;
            border: none;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Loading */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #f4c430;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 50px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-container {
            text-align: center;
            padding: 50px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 50px;
            color: rgba(255, 255, 255, 0.5);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .empty-state-text {
            font-size: 16px;
        }

        /* User Avatar */
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            color: white;
        }

        /* Status Badges */
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .badge-success {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
            border: 1px solid #4caf50;
        }

        .badge-warning {
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
            border: 1px solid #ff9800;
        }

        .badge-danger {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
            border: 1px solid #f44336;
        }

        .badge-info {
            background: rgba(33, 150, 243, 0.2);
            color: #2196f3;
            border: 1px solid #2196f3;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-btn:hover {
            color: rgba(255, 255, 255, 0.9);
        }

        .tab-btn.active {
            color: #f4c430;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
        }

        /* Notification Dropdown */
        .notification-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            width: 400px;
            background: #1a1f3a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin-top: 10px;
            max-height: 500px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .notification-header {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-item {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .notification-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .notification-item.unread {
            background: rgba(244, 196, 48, 0.1);
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            transition: width 0.3s ease;
        }

        /* File Upload */
        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #f4c430;
            background: rgba(244, 196, 48, 0.05);
        }

        .upload-area.dragging {
            border-color: #f4c430;
            background: rgba(244, 196, 48, 0.1);
        }

        /* Charts Container */
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            height: 400px;
            position: relative;
        }

        /* Messages */
        .message-bubble {
            padding: 10px 15px;
            border-radius: 15px;
            margin-bottom: 10px;
            max-width: 70%;
        }

        .message-bubble.sent {
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            color: #000;
            align-self: flex-end;
            margin-left: auto;
        }

        .message-bubble.received {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
        }

        /* Groups */
        .group-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .group-title {
            font-size: 18px;
            font-weight: 600;
        }

        .group-members {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .member-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            border: 2px solid #1a1f3a;
        }

        /* Resources */
        .resource-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .resource-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .resource-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .resource-type {
            display: inline-block;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            font-size: 11px;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .resource-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .resource-description {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 15px;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1f3a 0%, #0d1117 100%);
        }

        .login-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-title {
            font-size: 32px;
            font-weight: bold;
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .error-message {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid #f44336;
            color: #f44336;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .success-message {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid #4caf50;
            color: #4caf50;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        /* Checkbox */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        /* Filters */
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            font-size: 12px;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.6);
            letter-spacing: 1px;
        }

        .filter-select {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            outline: none;
            transition: all 0.3s ease;
        }

        .filter-select:focus {
            border-color: #f4c430;
            background: rgba(255, 255, 255, 0.15);
        }

        /* Date Range Picker */
        .date-range {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .date-input {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            outline: none;
        }

        /* Mood Rating Display */
        .mood-scale {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .mood-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .mood-1 { background: #ff4444; }
        .mood-2 { background: #ff6b44; }
        .mood-3 { background: #ff9944; }
        .mood-4 { background: #ffaa44; }
        .mood-5 { background: #ffcc44; }
        .mood-6 { background: #eedd44; }
        .mood-7 { background: #bbdd44; }
        .mood-8 { background: #99dd44; }
        .mood-9 { background: #66dd44; }
        .mood-10 { background: #44dd44; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAufSTHtCTFSEIeZ9YzvrULCnji5I-SMi0",
            authDomain: "glrs-pir-system.firebaseapp.com",
            projectId: "glrs-pir-system",
            storageBucket: "glrs-pir-system.appspot.com",
            messagingSenderId: "830378577655",
            appId: "1:830378577655:web:your-app-id"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        const { useState, useEffect, useRef, useMemo, useCallback } = React;

       function formatDate(date) {
    if (!date) return '';
    const d = date?.toDate ? date.toDate() : new Date(date);
    return d.toLocaleDateString('en-US', { timeZone: 'UTC' });
}

        function formatDateTime(date) {
            if (!date) return '-';
            const d = date?.toDate ? date.toDate() : new Date(date);
            if (isNaN(d.getTime())) return '-';
            return d.toLocaleString();
        }

        function formatTimeAgo(date) {
            if (!date) return '-';
            const d = date?.toDate ? date.toDate() : new Date(date);
            if (isNaN(d.getTime())) return '-';
            const now = new Date();
            const seconds = Math.floor((now - d) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)} mins ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)} days ago`;
            return d.toLocaleDateString();
        }

        // Debounce utility
        function useDebounce(value, delay) {
            const [debouncedValue, setDebouncedValue] = useState(value);
            
            useEffect(() => {
                const handler = setTimeout(() => {
                    setDebouncedValue(value);
                }, delay);
                
                return () => clearTimeout(handler);
            }, [value, delay]);
            
            return debouncedValue;
        }

        // Connection Status Hook
        function useConnectionStatus() {
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            
            useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);
                
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);
            
            return isOnline;
        }

        // Batch query utility - handles Firestore's 10-item 'in' query limit
        async function batchQuery(collection, field, values, additionalConstraints = []) {
            if (values.length === 0) return [];
            
            const results = [];
            const chunks = [];
            
            // Split into chunks of 10
            for (let i = 0; i < values.length; i += 10) {
                chunks.push(values.slice(i, i + 10));
            }
            
            // Query each chunk
            for (const chunk of chunks) {
                let query = db.collection(collection).where(field, 'in', chunk);
                
                // Add additional constraints
                for (const constraint of additionalConstraints) {
                    query = query[constraint.method](...constraint.args);
                }
                
                const snapshot = await query.get();
                snapshot.forEach(doc => {
                    results.push({ id: doc.id, ...doc.data() });
                });
            }
            
            return results;
        }

        // Export utilities
        function exportToJSON(data, filename) {
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportToCSV(data, filename) {
            if (!data || data.length === 0) {
                alert('No data to export');
                return;
            }
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => 
                    headers.map(header => {
                        const cell = row[header];
                        const value = cell === null || cell === undefined ? '' : String(cell);
                        return value.includes(',') || value.includes('"') || value.includes('\n') 
                            ? `"${value.replace(/"/g, '""')}"` 
                            : value;
                    }).join(',')
                )
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportToPDF(data, title) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.text(title, 20, 20);
            
            if (Array.isArray(data) && data.length > 0) {
                const headers = Object.keys(data[0]);
                const rows = data.map(item => headers.map(header => String(item[header] || '')));
                
                doc.autoTable({
                    head: [headers],
                    body: rows,
                    startY: 30,
                });
            } else {
                doc.setFontSize(12);
                doc.text(JSON.stringify(data, null, 2), 20, 40);
            }
            
            doc.save(`${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // Main App Component
function AdminApp() {
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(true);
    const [currentView, setCurrentView] = useState('dashboard');
    const [searchQuery, setSearchQuery] = useState('');
    const [notifications, setNotifications] = useState([]);
    const [showNotifications, setShowNotifications] = useState(false);
    const isOnline = useConnectionStatus();
    
    // FIX: Move useDebounce here at component level
    const debouncedSearchQuery = useDebounce(searchQuery, 300);
    
    // Firestore listeners cleanup
    const unsubscribers = useRef([]);

    useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged(async (authUser) => {
            if (authUser) {
                try {
                    const userDoc = await db.collection('users').doc(authUser.uid).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        if (userData.role === 'admin') {
                            setUser({ uid: authUser.uid, ...userData });
                            setupRealtimeListeners(authUser.uid);
                        } else {
                            auth.signOut();
                            alert('Access denied. Admin access required.');
                        }
                    } else {
                        auth.signOut();
                        alert('User profile not found.');
                    }
                } catch (error) {
                    console.error('Error loading user:', error);
                    auth.signOut();
                }
            } else {
                setUser(null);
                cleanupListeners();
            }
            setLoading(false);
        });

        return () => {
            unsubscribe();
            cleanupListeners();
        };
    }, []);

    const setupRealtimeListeners = (userId) => {
        // Clean up existing listeners
        cleanupListeners();
        
        // Listen to notifications
        try {
            const notifQuery = db.collection('notifications')
                .where('recipientId', '==', userId)
                .orderBy('createdAt', 'desc')
                .limit(50);
            
            const unsubNotif = notifQuery.onSnapshot(
                snapshot => {
                    const notifs = [];
                    snapshot.forEach(doc => {
                        notifs.push({ id: doc.id, ...doc.data() });
                    });
                    setNotifications(notifs);
                },
                error => {
                    console.error('Error loading notifications:', error);
                }
            );
            
            unsubscribers.current.push(unsubNotif);
        } catch (error) {
            console.error('Error setting up listeners:', error);
        }
    };

    const cleanupListeners = () => {
        unsubscribers.current.forEach(unsub => {
            try {
                unsub();
            } catch (error) {
                console.error('Error cleaning up listener:', error);
            }
        });
        unsubscribers.current = [];
    };

    const handleLogout = async () => {
        try {
            cleanupListeners();
            await auth.signOut();
            setUser(null);
            setCurrentView('dashboard');
        } catch (error) {
            console.error('Logout error:', error);
            alert('Error logging out. Please try again.');
        }
    };

    const handleImpersonate = (targetUser) => {
        // Open PIR view in new tab/window
        const pirViewUrl = `pir-view.html?userId=${targetUser.id}`;
        window.open(pirViewUrl, '_blank');
    };

    if (loading) {
        return (
            <div className="loading-container">
                <div className="loading-spinner"></div>
                <p style={{marginTop: '20px'}}>Loading Admin Portal...</p>
            </div>
        );
    }

    if (!user) {
        return <LoginScreen />;
    }

   return (
    <>
        <div className={`connection-status ${isOnline ? 'online' : 'offline'}`}>
            {!isOnline && '⚠️ Offline - Some features may be limited'}
        </div>
        
        <div style={{ display: 'flex', flexDirection: 'column', minHeight: '100vh' }}>
            {/* Header FIRST */}
            <Header 
                currentView={currentView}
                searchQuery={searchQuery}
                setSearchQuery={setSearchQuery}
                notifications={notifications}
                showNotifications={showNotifications}
                setShowNotifications={setShowNotifications}
                onLogout={handleLogout}
                user={user}
            />
            
            {/* TopNav SECOND */}
            <TopNav 
                currentView={currentView}
                setCurrentView={setCurrentView}
            />
            
          <div className="content" style={{ flex: 1, background: '#c4c9cf' }}>
                {renderView(currentView, debouncedSearchQuery, user, handleImpersonate)}
            </div>
        </div>
    </>
);
}

// View Renderer - NO HOOKS HERE
function renderView(view, searchQuery, user, onImpersonate) {
    // REMOVED: const debouncedSearchQuery = useDebounce(searchQuery, 300);
    // Now searchQuery is already debounced when passed in
    
    switch(view) {
        case 'dashboard':
            return <DashboardView user={user} />;
        case 'users':
            return <UsersView searchQuery={searchQuery} user={user} onImpersonate={onImpersonate} />;
        case 'profile':
            return <ProfileView user={user} />;
            case 'mypirs':
    return <MyPIRsView searchQuery={searchQuery} user={user} />;
        case 'feedback':
            return <FeedbackView searchQuery={searchQuery} user={user} />;
        case 'resources':
            return <ResourcesView user={user} searchQuery={searchQuery} />;
        case 'groups':
            return <GroupsView user={user} searchQuery={searchQuery} />;
            case 'community':
    return <CommunityView searchQuery={searchQuery} user={user} />;
        case 'checkins':
            return <CheckInsView searchQuery={searchQuery} />;
        case 'assignments':
            return <AssignmentsView searchQuery={searchQuery} user={user} />;
            case 'goals':
    return <GoalsView searchQuery={searchQuery} user={user} />;
        case 'alerts':
            return <AlertsView searchQuery={searchQuery} user={user} />;
        case 'reports':
            return <ReportsView user={user} />;
        case 'settings':
            return <SettingsView user={user} />;
        default:
            return <div className="empty-state">View not found</div>;
    }
}

// Top Navigation Component with Full-Height Profile Card
function TopNav({ currentView, setCurrentView }) {
    const [user, setUser] = useState(null);
    const [showCreateUserModal, setShowCreateUserModal] = useState(false);
    const [createUserRole, setCreateUserRole] = useState('pir');

    useEffect(() => {
        const currentUser = auth.currentUser;
        if (currentUser) {
            db.collection('users').doc(currentUser.uid).get()
                .then(doc => {
                    if (doc.exists) {
                        setUser({ uid: currentUser.uid, ...doc.data() });
                    }
                })
                .catch(err => console.error('Error loading user:', err));
        }
    }, []);

    const handleCreatePIR = () => {
        setCreateUserRole('pir');
        setShowCreateUserModal(true);
    };

    const handleAddCoach = () => {
        setCreateUserRole('coach');
        setShowCreateUserModal(true);
    };

    const handleAddResource = () => {
        setCurrentView('resources');
    };

    const handleCreateGroup = () => {
        setCurrentView('groups');
    };

    const menuItems = [
        { id: 'dashboard', label: 'Dashboard', icon: '📊' },
        { id: 'users', label: 'Users', icon: '👥' },
        { id: 'mypirs', label: 'My PIRs', icon: '🎯' },
        { id: 'profile', label: 'My Profile', icon: '👤' },
        { id: 'feedback', label: 'Feedback', icon: '📝' },
        { id: 'resources', label: 'Resources', icon: '📚' },
        { id: 'groups', label: 'Groups', icon: '👫' },
        { id: 'goals', label: 'Goals', icon: '🎯' },
        { id: 'community', label: 'Community', icon: '💬' },
        { id: 'checkins', label: 'Check-ins', icon: '✅' },
        { id: 'assignments', label: 'Assignments', icon: '📋' },
        { id: 'alerts', label: 'Alerts', icon: '🚨' },
        { id: 'reports', label: 'Reports', icon: '📈' },
        { id: 'settings', label: 'Settings', icon: '⚙️' }
    ];

    const row1 = [menuItems[0], menuItems[1], menuItems[2], menuItems[3]];
    const row2 = [menuItems[4], menuItems[5], menuItems[6], menuItems[7]];
    const row3 = [menuItems[8], menuItems[9], menuItems[10], menuItems[11]];
    const row4 = [menuItems[12], menuItems[13]];

    return (
        <>
            <div style={{
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                padding: '10px 20px',
                boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                position: 'sticky',
                top: 0,
                zIndex: 100,
                display: 'flex',
                gap: '20px',
                minHeight: '140px'
            }}>
                {/* Left Side - Logo and Navigation */}
                <div style={{ flex: 1, display: 'flex', flexDirection: 'column', gap: '8px' }}>
                    {/* Logo */}
                    <div style={{
                        color: 'white',
                        fontSize: '18px',
                        fontWeight: 'bold',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px',
                        marginBottom: '4px'
                    }}>
                        🛡️ GLRS Admin
                    </div>

                    {/* Navigation Buttons - Staggered */}
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
                        {/* Row 1 */}
                        <div style={{ display: 'flex', gap: '10px', paddingLeft: '0px' }}>
                            {row1.map(item => (
                                <button
                                    key={item.id}
                                    onClick={() => setCurrentView(item.id)}
                                    style={{
                                        padding: '6px 16px',
                                        background: currentView === item.id ? 'white' : 'rgba(255,255,255,0.1)',
                                        border: currentView === item.id 
                                            ? '2px solid rgba(255,255,255,0.8)' 
                                            : '2px solid transparent',
                                        borderRadius: '8px',
                                        color: currentView === item.id ? '#667eea' : 'white',
                                        cursor: 'pointer',
                                        fontSize: '13px',
                                        fontWeight: currentView === item.id ? '600' : '500',
                                        transition: 'all 0.3s',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '6px',
                                        backdropFilter: 'blur(10px)',
                                        boxShadow: currentView === item.id 
                                            ? '0 4px 12px rgba(0,0,0,0.2)' 
                                            : 'none',
                                        whiteSpace: 'nowrap'
                                    }}
                                    onMouseEnter={(e) => {
                                        if (currentView !== item.id) {
                                            e.currentTarget.style.background = 'rgba(255,255,255,0.2)';
                                            e.currentTarget.style.transform = 'translateY(-2px)';
                                        }
                                    }}
                                    onMouseLeave={(e) => {
                                        if (currentView !== item.id) {
                                            e.currentTarget.style.background = 'rgba(255,255,255,0.1)';
                                            e.currentTarget.style.transform = 'translateY(0)';
                                        }
                                    }}
                                >
                                    <span style={{ fontSize: '15px' }}>{item.icon}</span>
                                    {item.label}
                                </button>
                            ))}
                        </div>

                        {/* Row 2 - Offset */}
                        <div style={{ display: 'flex', gap: '10px', paddingLeft: '70px' }}>
                            {row2.map(item => (
                                <button
                                    key={item.id}
                                    onClick={() => setCurrentView(item.id)}
                                    style={{
                                        padding: '6px 16px',
                                        background: currentView === item.id ? 'white' : 'rgba(255,255,255,0.1)',
                                        border: currentView === item.id 
                                            ? '2px solid rgba(255,255,255,0.8)' 
                                            : '2px solid transparent',
                                        borderRadius: '8px',
                                        color: currentView === item.id ? '#667eea' : 'white',
                                        cursor: 'pointer',
                                        fontSize: '13px',
                                        fontWeight: currentView === item.id ? '600' : '500',
                                        transition: 'all 0.3s',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '6px',
                                        backdropFilter: 'blur(10px)',
                                        boxShadow: currentView === item.id 
                                            ? '0 4px 12px rgba(0,0,0,0.2)' 
                                            : 'none',
                                        whiteSpace: 'nowrap'
                                    }}
                                    onMouseEnter={(e) => {
                                        if (currentView !== item.id) {
                                            e.currentTarget.style.background = 'rgba(255,255,255,0.2)';
                                            e.currentTarget.style.transform = 'translateY(-2px)';
                                        }
                                    }}
                                    onMouseLeave={(e) => {
                                        if (currentView !== item.id) {
                                            e.currentTarget.style.background = 'rgba(255,255,255,0.1)';
                                            e.currentTarget.style.transform = 'translateY(0)';
                                        }
                                    }}
                                >
                                    <span style={{ fontSize: '15px' }}>{item.icon}</span>
                                    {item.label}
                                </button>
                            ))}
                        </div>

                        {/* Row 3 - Offset */}
                        <div style={{ display: 'flex', gap: '10px', paddingLeft: '35px' }}>
                            {row3.map(item => (
                                <button
                                    key={item.id}
                                    onClick={() => setCurrentView(item.id)}
                                    style={{
                                        padding: '6px 16px',
                                        background: currentView === item.id ? 'white' : 'rgba(255,255,255,0.1)',
                                        border: currentView === item.id 
                                            ? '2px solid rgba(255,255,255,0.8)' 
                                            : '2px solid transparent',
                                        borderRadius: '8px',
                                        color: currentView === item.id ? '#667eea' : 'white',
                                        cursor: 'pointer',
                                        fontSize: '13px',
                                        fontWeight: currentView === item.id ? '600' : '500',
                                        transition: 'all 0.3s',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '6px',
                                        backdropFilter: 'blur(10px)',
                                        boxShadow: currentView === item.id 
                                            ? '0 4px 12px rgba(0,0,0,0.2)' 
                                            : 'none',
                                        whiteSpace: 'nowrap'
                                    }}
                                    onMouseEnter={(e) => {
                                        if (currentView !== item.id) {
                                            e.currentTarget.style.background = 'rgba(255,255,255,0.2)';
                                            e.currentTarget.style.transform = 'translateY(-2px)';
                                        }
                                    }}
                                    onMouseLeave={(e) => {
                                        if (currentView !== item.id) {
                                            e.currentTarget.style.background = 'rgba(255,255,255,0.1)';
                                            e.currentTarget.style.transform = 'translateY(0)';
                                        }
                                    }}
                                >
                                    <span style={{ fontSize: '15px' }}>{item.icon}</span>
                                    {item.label}
                                </button>
                            ))}
                        </div>

                        {/* Row 4 - Offset */}
                        <div style={{ display: 'flex', gap: '10px', paddingLeft: '105px' }}>
                            {row4.map(item => (
                                <button
                                    key={item.id}
                                    onClick={() => setCurrentView(item.id)}
                                    style={{
                                        padding: '6px 16px',
                                        background: currentView === item.id ? 'white' : 'rgba(255,255,255,0.1)',
                                        border: currentView === item.id 
                                            ? '2px solid rgba(255,255,255,0.8)' 
                                            : '2px solid transparent',
                                        borderRadius: '8px',
                                        color: currentView === item.id ? '#667eea' : 'white',
                                        cursor: 'pointer',
                                        fontSize: '13px',
                                        fontWeight: currentView === item.id ? '600' : '500',
                                        transition: 'all 0.3s',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '6px',
                                        backdropFilter: 'blur(10px)',
                                        boxShadow: currentView === item.id 
                                            ? '0 4px 12px rgba(0,0,0,0.2)' 
                                            : 'none',
                                        whiteSpace: 'nowrap'
                                    }}
                                    onMouseEnter={(e) => {
                                        if (currentView !== item.id) {
                                            e.currentTarget.style.background = 'rgba(255,255,255,0.2)';
                                            e.currentTarget.style.transform = 'translateY(-2px)';
                                        }
                                    }}
                                    onMouseLeave={(e) => {
                                        if (currentView !== item.id) {
                                            e.currentTarget.style.background = 'rgba(255,255,255,0.1)';
                                            e.currentTarget.style.transform = 'translateY(0)';
                                        }
                                    }}
                                >
                                    <span style={{ fontSize: '15px' }}>{item.icon}</span>
                                    {item.label}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>

                {/* Right Side - User Profile Card (Full Height) */}
                <div style={{
                    background: 'rgba(255,255,255,0.15)',
                    backdropFilter: 'blur(10px)',
                    borderRadius: '12px',
                    padding: '15px',
                    width: '250px',
                    border: '1px solid rgba(255,255,255,0.2)',
                    display: 'flex',
                    flexDirection: 'column',
                    justifyContent: 'center',
                    gap: '12px'
                }}>
                    {/* User Info */}
                    <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '10px'
                    }}>
                        <div style={{
                            width: '40px',
                            height: '40px',
                            borderRadius: '50%',
                            background: 'white',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            color: '#667eea',
                            fontWeight: 'bold',
                            fontSize: '18px',
                            flexShrink: 0
                        }}>
                            {user?.displayName?.charAt(0) || user?.email?.charAt(0) || 'A'}
                        </div>
                        <div style={{ flex: 1, minWidth: 0 }}>
                            <div style={{
                                color: 'white',
                                fontWeight: '600',
                                fontSize: '13px',
                                marginBottom: '3px',
                                whiteSpace: 'nowrap',
                                overflow: 'hidden',
                                textOverflow: 'ellipsis'
                            }}>
                                {user?.displayName || user?.email || 'Admin User'}
                            </div>
                            <div style={{
                                color: 'rgba(255,255,255,0.8)',
                                fontSize: '11px',
                                textTransform: 'capitalize'
                            }}>
                                {user?.role || 'Admin'} • Online
                            </div>
                        </div>
                    </div>

                    {/* Quick Action Buttons */}
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: '1fr 1fr',
                        gap: '8px'
                    }}>
                        <button
                            onClick={handleCreatePIR}
                            style={{
                                padding: '8px 10px',
                                background: 'white',
                                border: 'none',
                                borderRadius: '6px',
                                color: '#667eea',
                                cursor: 'pointer',
                                fontSize: '11px',
                                fontWeight: '600',
                                transition: 'all 0.2s',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '4px'
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.transform = 'translateY(-2px)';
                                e.currentTarget.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.transform = 'translateY(0)';
                                e.currentTarget.style.boxShadow = 'none';
                            }}
                        >
                            + Create PIR
                        </button>

                        <button
                            onClick={handleAddCoach}
                            style={{
                                padding: '8px 10px',
                                background: 'white',
                                border: 'none',
                                borderRadius: '6px',
                                color: '#667eea',
                                cursor: 'pointer',
                                fontSize: '11px',
                                fontWeight: '600',
                                transition: 'all 0.2s',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '4px'
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.transform = 'translateY(-2px)';
                                e.currentTarget.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.transform = 'translateY(0)';
                                e.currentTarget.style.boxShadow = 'none';
                            }}
                        >
                            + Add Coach
                        </button>

                        <button
                            onClick={handleAddResource}
                            style={{
                                padding: '8px 10px',
                                background: 'white',
                                border: 'none',
                                borderRadius: '6px',
                                color: '#667eea',
                                cursor: 'pointer',
                                fontSize: '11px',
                                fontWeight: '600',
                                transition: 'all 0.2s',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '4px'
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.transform = 'translateY(-2px)';
                                e.currentTarget.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.transform = 'translateY(0)';
                                e.currentTarget.style.boxShadow = 'none';
                            }}
                        >
                            + Add Resource
                        </button>

                        <button
                            onClick={handleCreateGroup}
                            style={{
                                padding: '8px 10px',
                                background: 'white',
                                border: 'none',
                                borderRadius: '6px',
                                color: '#667eea',
                                cursor: 'pointer',
                                fontSize: '11px',
                                fontWeight: '600',
                                transition: 'all 0.2s',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '4px'
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.transform = 'translateY(-2px)';
                                e.currentTarget.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.transform = 'translateY(0)';
                                e.currentTarget.style.boxShadow = 'none';
                            }}
                        >
                            + Create Group
                        </button>
                    </div>
                </div>
            </div>

            {/* Create User Modal */}
            {showCreateUserModal && (
                <CreateUserModal 
                    onClose={() => setShowCreateUserModal(false)}
                    onSuccess={() => {
                        setShowCreateUserModal(false);
                        if (currentView === 'users') {
                            window.location.reload();
                        }
                    }}
                    defaultRole={createUserRole}
                />
            )}
        </>
    );
}
      // Enhanced Header Component  
function Header({ currentView, searchQuery, setSearchQuery, notifications, showNotifications, setShowNotifications, onLogout, user }) {
    const [refreshing, setRefreshing] = useState(false);
    const notificationRef = useRef(null);
    
    const unreadCount = notifications.filter(n => !n.read).length;

    const handleRefresh = () => {
        setRefreshing(true);
        setTimeout(() => {
            window.location.reload();
        }, 500);
    };

    const clearNotification = async (notifId) => {
        try {
            await db.collection('notifications').doc(notifId).update({ read: true });
        } catch (error) {
            console.error('Error clearing notification:', error);
        }
    };

    const clearAllNotifications = async () => {
        try {
            const batch = db.batch();
            notifications.forEach(notif => {
                if (!notif.read) {
                    batch.update(db.collection('notifications').doc(notif.id), { read: true });
                }
            });
            await batch.commit();
        } catch (error) {
            console.error('Error clearing all notifications:', error);
        }
    };

    const handleNotificationClick = (notif) => {
        clearNotification(notif.id);
        setShowNotifications(false);
    };

    useEffect(() => {
        const handleClickOutside = (event) => {
            if (notificationRef.current && !notificationRef.current.contains(event.target)) {
                setShowNotifications(false);
            }
        };
        
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, []);

    return (
        <div style={{
            background: 'white',
            padding: '15px 30px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            position: 'sticky',
            top: 0,
            zIndex: 99
        }}>
            <div style={{
                fontSize: '18px',
                fontWeight: '600',
                color: '#333'
            }}>
                {user.displayName || user.email}
            </div>
            
            <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                <input
                    type="text"
                    placeholder="Search users, messages, resources..."
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    style={{
                        padding: '10px 20px',
                        borderRadius: '25px',
                        border: '2px solid #e0e0e0',
                        width: '350px',
                        fontSize: '14px',
                        transition: 'all 0.3s'
                    }}
                    onFocus={(e) => e.currentTarget.style.borderColor = '#667eea'}
                    onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                />
                
                <button 
                    onClick={handleRefresh}
                    disabled={refreshing}
                    style={{
                        padding: '10px 20px',
                        background: refreshing ? '#e0e0e0' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: refreshing ? 'not-allowed' : 'pointer',
                        fontSize: '14px',
                        fontWeight: '500',
                        transition: 'all 0.2s',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px'
                    }}
                    onMouseEnter={(e) => {
                        if (!refreshing) {
                            e.currentTarget.style.transform = 'translateY(-2px)';
                            e.currentTarget.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.4)';
                        }
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = 'none';
                    }}
                >
                    {refreshing ? '⟳' : '↻'} Refresh
                </button>
                
                <div style={{ position: 'relative' }} ref={notificationRef}>
                    <button
                        onClick={() => setShowNotifications(!showNotifications)}
                        style={{
                            background: 'transparent',
                            border: 'none',
                            cursor: 'pointer',
                            fontSize: '24px',
                            position: 'relative',
                            padding: '8px'
                        }}
                    >
                        🔔
                        {unreadCount > 0 && (
                            <div style={{
                                position: 'absolute',
                                top: '4px',
                                right: '4px',
                                background: '#f44336',
                                color: 'white',
                                borderRadius: '50%',
                                width: '20px',
                                height: '20px',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '10px',
                                fontWeight: 'bold'
                            }}>
                                {unreadCount > 99 ? '99+' : unreadCount}
                            </div>
                        )}
                    </button>
                    
                    {showNotifications && (
                        <div style={{
                            position: 'absolute',
                            top: '100%',
                            right: 0,
                            marginTop: '10px',
                            background: 'white',
                            borderRadius: '10px',
                            boxShadow: '0 4px 20px rgba(0,0,0,0.15)',
                            width: '350px',
                            maxHeight: '400px',
                            overflowY: 'auto',
                            zIndex: 1000
                        }}>
                            <div style={{
                                padding: '15px',
                                borderBottom: '1px solid #f0f0f0',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                position: 'sticky',
                                top: 0,
                                background: 'white'
                            }}>
                                <span style={{ fontWeight: '600', color: '#333' }}>
                                    Notifications ({unreadCount})
                                </span>
                                <button 
                                    onClick={clearAllNotifications}
                                    style={{
                                        padding: '5px 10px',
                                        fontSize: '12px',
                                        background: '#f0f0f0',
                                        border: 'none',
                                        borderRadius: '5px',
                                        cursor: 'pointer'
                                    }}
                                >
                                    Clear All
                                </button>
                            </div>
                            
                            {notifications.length === 0 ? (
                                <div style={{ padding: '30px', textAlign: 'center', color: '#999' }}>
                                    No notifications
                                </div>
                            ) : (
                                notifications.slice(0, 20).map(notif => (
                                    <div 
                                        key={notif.id}
                                        onClick={() => handleNotificationClick(notif)}
                                        style={{
                                            padding: '15px',
                                            borderBottom: '1px solid #f0f0f0',
                                            cursor: 'pointer',
                                            background: notif.read ? 'white' : '#f0f4ff',
                                            transition: 'background 0.2s'
                                        }}
                                        onMouseEnter={(e) => e.currentTarget.style.background = '#f8f9fa'}
                                        onMouseLeave={(e) => e.currentTarget.style.background = notif.read ? 'white' : '#f0f4ff'}
                                    >
                                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '5px' }}>
                                            <span style={{ fontSize: '14px', color: '#333' }}>{notif.message}</span>
                                            {notif.urgent && (
                                                <span style={{
                                                    background: '#f44336',
                                                    color: 'white',
                                                    padding: '2px 6px',
                                                    borderRadius: '10px',
                                                    fontSize: '10px'
                                                }}>
                                                    Urgent
                                                </span>
                                            )}
                                        </div>
                                        <div style={{ fontSize: '11px', color: '#999' }}>
                                            {formatTimeAgo(notif.createdAt)}
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    )}
                </div>
                
                <button 
                    onClick={onLogout}
                    style={{
                        padding: '10px 20px',
                        background: '#6c757d',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontSize: '14px',
                        fontWeight: '500',
                        transition: 'all 0.2s'
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.background = '#5a6268';
                        e.currentTarget.style.transform = 'translateY(-2px)';
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.background = '#6c757d';
                        e.currentTarget.style.transform = 'translateY(0)';
                    }}
                >
                    Logout
                </button>
            </div>
        </div>
    );
}

        // Login Screen
        function LoginScreen() {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    setError(error.message);
                    setLoading(false);
                }
            };

            return (
                <div className="login-container">
                    <div className="login-card">
                        <div className="login-header">
                            <div className="login-title">GLRS Admin Portal</div>
                            <p style={{color: 'rgba(255,255,255,0.7)'}}>Administrator Access Only</p>
                        </div>
                        
                        {error && <div className="error-message">{error}</div>}
                        
                        <form onSubmit={handleLogin}>
                            <div className="form-group">
                                <label className="form-label">Email</label>
                                <input
                                    type="email"
                                    className="form-input"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    required
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Password</label>
                                <input
                                    type="password"
                                    className="form-input"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    required
                                />
                            </div>
                            
                            <button 
                                type="submit"
                                className="btn btn-primary"
                                style={{width: '100%'}}
                                disabled={loading}
                            >
                                {loading ? 'Logging in...' : 'Login'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

       
        // Enhanced Dashboard View with Charts and Stats
function DashboardView({ user }) {
    const [stats, setStats] = useState({
        totalPirs: 0,
        totalCoaches: 0,
        alertsToday: 0,
        avgCompliance: 0
    });
    const [chartData, setChartData] = useState({
        mood: { labels: [], data: [], average: 0 },
        craving: { labels: [], data: [], average: 0 },
        anxiety: { labels: [], data: [], average: 0 },
        sleep: { labels: [], data: [], average: 0 }
    });
    const [sobrietyData, setSobrietyData] = useState({ labels: [], data: [], average: 0 });
    const [recentActivity, setRecentActivity] = useState([]);
    const [loading, setLoading] = useState(true);

    // Chart refs
    const moodChartRef = useRef(null);
    const cravingChartRef = useRef(null);
    const anxietyChartRef = useRef(null);
    const sleepChartRef = useRef(null);
    const sobrietyChartRef = useRef(null);

    // Chart instances
    const chartInstances = useRef({});

    useEffect(() => {
        loadDashboardData();

        return () => {
            // Cleanup all charts
            Object.values(chartInstances.current).forEach(chart => {
                if (chart) chart.destroy();
            });
        };
    }, []);

    useEffect(() => {
        if (!loading) {
            renderAllCharts();
        }
    }, [chartData, sobrietyData, loading]);

    const loadDashboardData = async () => {
        try {
            // Load basic stats
            const usersSnap = await db.collection('users').get();
            let totalPirs = 0;
            let totalCoaches = 0;
            const pirIds = [];

            usersSnap.forEach(doc => {
                const data = doc.data();
                if (data.role === 'pir') {
                    totalPirs++;
                    pirIds.push(doc.id);
                }
                if (data.role === 'coach') totalCoaches++;
            });

            // Get today's alerts
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const alertsSnap = await db.collection('alerts')
                .where('createdAt', '>=', today)
                .get();

            // Calculate 30-day trends for all PIRs
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            const checkInsSnap = await db.collection('checkIns')
                .where('createdAt', '>=', thirtyDaysAgo)
                .get();

            // Process check-ins data
            const last30Days = [];
            const moodData = [];
            const cravingData = [];
            const anxietyData = [];
            const sleepData = [];

            // All-time data for averages
            const allCheckInsSnap = await db.collection('checkIns').get();
            let allTimeMood = [];
            let allTimeCraving = [];
            let allTimeAnxiety = [];
            let allTimeSleep = [];

            allCheckInsSnap.forEach(doc => {
                const data = doc.data();
                if (data.morningData) {
                    if (data.morningData.mood) allTimeMood.push(data.morningData.mood);
                    if (data.morningData.craving) allTimeCraving.push(data.morningData.craving);
                    if (data.morningData.anxietyLevel) allTimeAnxiety.push(data.morningData.anxietyLevel);
                    if (data.morningData.sleepQuality) allTimeSleep.push(data.morningData.sleepQuality);
                }
                if (data.eveningData) {
                    if (data.eveningData.mood) allTimeMood.push(data.eveningData.mood);
                    if (data.eveningData.craving) allTimeCraving.push(data.eveningData.craving);
                }
            });

            // Calculate all-time averages
            const avgMood = allTimeMood.length > 0 
                ? (allTimeMood.reduce((a, b) => a + b, 0) / allTimeMood.length).toFixed(1)
                : 0;
            const avgCraving = allTimeCraving.length > 0 
                ? (allTimeCraving.reduce((a, b) => a + b, 0) / allTimeCraving.length).toFixed(1)
                : 0;
            const avgAnxiety = allTimeAnxiety.length > 0 
                ? (allTimeAnxiety.reduce((a, b) => a + b, 0) / allTimeAnxiety.length).toFixed(1)
                : 0;
            const avgSleep = allTimeSleep.length > 0 
                ? (allTimeSleep.reduce((a, b) => a + b, 0) / allTimeSleep.length).toFixed(1)
                : 0;

            // Build 30-day data
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                last30Days.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));

                const dayCheckIns = [];
                checkInsSnap.forEach(doc => {
                    const checkInDate = doc.data().createdAt?.toDate 
                        ? doc.data().createdAt.toDate() 
                        : new Date(doc.data().createdAt);
                    if (checkInDate.toDateString() === date.toDateString()) {
                        dayCheckIns.push(doc.data());
                    }
                });

                // Calculate averages for the day
                const dayMoods = [];
                const dayCravings = [];
                const dayAnxiety = [];
                const daySleep = [];

                dayCheckIns.forEach(checkIn => {
                    if (checkIn.morningData) {
                        if (checkIn.morningData.mood) dayMoods.push(checkIn.morningData.mood);
                        if (checkIn.morningData.craving) dayCravings.push(checkIn.morningData.craving);
                        if (checkIn.morningData.anxietyLevel) dayAnxiety.push(checkIn.morningData.anxietyLevel);
                        if (checkIn.morningData.sleepQuality) daySleep.push(checkIn.morningData.sleepQuality);
                    }
                    if (checkIn.eveningData) {
                        if (checkIn.eveningData.mood) dayMoods.push(checkIn.eveningData.mood);
                        if (checkIn.eveningData.craving) dayCravings.push(checkIn.eveningData.craving);
                    }
                });

                moodData.push(dayMoods.length > 0 ? dayMoods.reduce((a, b) => a + b) / dayMoods.length : null);
                cravingData.push(dayCravings.length > 0 ? dayCravings.reduce((a, b) => a + b) / dayCravings.length : null);
                anxietyData.push(dayAnxiety.length > 0 ? dayAnxiety.reduce((a, b) => a + b) / dayAnxiety.length : null);
                sleepData.push(daySleep.length > 0 ? daySleep.reduce((a, b) => a + b) / daySleep.length : null);
            }

            setChartData({
                mood: { labels: last30Days, data: moodData, average: avgMood },
                craving: { labels: last30Days, data: cravingData, average: avgCraving },
                anxiety: { labels: last30Days, data: anxietyData, average: avgAnxiety },
                sleep: { labels: last30Days, data: sleepData, average: avgSleep }
            });

            // Load sobriety data
            const sobrietyLabels = [];
            const sobrietyDays = [];
            let totalSobrietyDays = 0;

            for (const pirId of pirIds.slice(0, 20)) { // Limit to 20 PIRs for readability
                const pirDoc = await db.collection('users').doc(pirId).get();
                if (pirDoc.exists) {
                    const pirData = pirDoc.data();
                    if (pirData.sobrietyDate) {
                        const sobrietyDate = pirData.sobrietyDate.toDate 
                            ? pirData.sobrietyDate.toDate() 
                            : new Date(pirData.sobrietyDate);
                        const today = new Date();
                        const days = Math.floor((today - sobrietyDate) / (1000 * 60 * 60 * 24));
                        
                        sobrietyLabels.push(pirData.displayName || pirData.email?.split('@')[0] || 'PIR');
                        sobrietyDays.push(days);
                        totalSobrietyDays += days;
                    }
                }
            }

            const avgSobriety = sobrietyDays.length > 0 
                ? Math.round(totalSobrietyDays / sobrietyDays.length)
                : 0;

            setSobrietyData({
                labels: sobrietyLabels,
                data: sobrietyDays,
                average: avgSobriety
            });

            // Calculate compliance
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const recentCheckIns = await db.collection('checkIns')
                .where('createdAt', '>=', sevenDaysAgo)
                .get();

            const avgCompliance = totalPirs > 0 
                ? Math.round((recentCheckIns.size / (totalPirs * 14)) * 100)
                : 0;

            setStats({
                totalPirs,
                totalCoaches,
                alertsToday: alertsSnap.size,
                avgCompliance: Math.min(avgCompliance, 100)
            });

            // Load recent activity
            const activityData = [];
            
            // Recent check-ins
            const recentCheckInsSnap = await db.collection('checkIns')
                .orderBy('createdAt', 'desc')
                .limit(5)
                .get();
            
            recentCheckInsSnap.forEach(doc => {
                const data = doc.data();
                activityData.push({
                    type: 'check-in',
                    message: `${data.userName || 'PIR'} completed check-in`,
                    time: data.createdAt
                });
            });

            // Recent alerts
            const recentAlertsSnap = await db.collection('alerts')
                .orderBy('createdAt', 'desc')
                .limit(3)
                .get();
            
            recentAlertsSnap.forEach(doc => {
                const data = doc.data();
                activityData.push({
                    type: 'alert',
                    message: `Alert: ${data.message || 'New alert triggered'}`,
                    time: data.createdAt
                });
            });

            // Sort by time and limit
            activityData.sort((a, b) => {
                const timeA = a.time?.toDate ? a.time.toDate() : new Date(a.time);
                const timeB = b.time?.toDate ? b.time.toDate() : new Date(b.time);
                return timeB - timeA;
            });

            setRecentActivity(activityData.slice(0, 10));

        } catch (error) {
            console.error('Error loading dashboard data:', error);
        } finally {
            setLoading(false);
        }
    };

    const renderAllCharts = () => {
        // Destroy existing charts
        Object.values(chartInstances.current).forEach(chart => {
            if (chart) chart.destroy();
        });

        const chartConfig = {
            type: 'line',
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 10,
                        ticks: { stepSize: 1 }
                    }
                },
                plugins: {
                    legend: { display: true }
                }
            }
        };

        // Mood Chart
        if (moodChartRef.current) {
            chartInstances.current.mood = new Chart(moodChartRef.current, {
                ...chartConfig,
                data: {
                    labels: chartData.mood.labels,
                    datasets: [{
                        label: 'Mood',
                        data: chartData.mood.data,
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4,
                        spanGaps: true
                    }]
                }
            });
        }

        // Craving Chart
        if (cravingChartRef.current) {
            chartInstances.current.craving = new Chart(cravingChartRef.current, {
                ...chartConfig,
                data: {
                    labels: chartData.craving.labels,
                    datasets: [{
                        label: 'Craving',
                        data: chartData.craving.data,
                        borderColor: '#FF9800',
                        backgroundColor: 'rgba(255, 152, 0, 0.1)',
                        tension: 0.4,
                        spanGaps: true
                    }]
                }
            });
        }

        // Anxiety Chart
        if (anxietyChartRef.current) {
            chartInstances.current.anxiety = new Chart(anxietyChartRef.current, {
                ...chartConfig,
                data: {
                    labels: chartData.anxiety.labels,
                    datasets: [{
                        label: 'Anxiety',
                        data: chartData.anxiety.data,
                        borderColor: '#f44336',
                        backgroundColor: 'rgba(244, 67, 54, 0.1)',
                        tension: 0.4,
                        spanGaps: true
                    }]
                }
            });
        }

        // Sleep Chart
        if (sleepChartRef.current) {
            chartInstances.current.sleep = new Chart(sleepChartRef.current, {
                ...chartConfig,
                data: {
                    labels: chartData.sleep.labels,
                    datasets: [{
                        label: 'Sleep Quality',
                        data: chartData.sleep.data,
                        borderColor: '#9C27B0',
                        backgroundColor: 'rgba(156, 39, 176, 0.1)',
                        tension: 0.4,
                        spanGaps: true
                    }]
                }
            });
        }

        // Sobriety Bar Chart
        if (sobrietyChartRef.current) {
            chartInstances.current.sobriety = new Chart(sobrietyChartRef.current, {
                type: 'bar',
                data: {
                    labels: sobrietyData.labels,
                    datasets: [{
                        label: 'Sobriety Days',
                        data: sobrietyData.data,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: '#667eea',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 30 }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    },
                    plugins: {
                        legend: { display: true }
                    }
                }
            });
        }
    };

    if (loading) {
        return (
            <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                minHeight: '400px',
                gap: '20px'
            }}>
                <div style={{
                    width: '60px',
                    height: '60px',
                    border: '4px solid #f3f3f3',
                    borderTop: '4px solid #667eea',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite'
                }}></div>
                <p style={{ color: '#666' }}>Loading dashboard...</p>
            </div>
        );
    }

    return (
        <div style={{ padding: '30px', animation: 'fadeIn 0.5s' }}>
            {/* Stats Cards */}
            <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))',
                gap: '20px',
                marginBottom: '40px'
            }}>
                <div style={{
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(102, 126, 234, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Total PIRs</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.totalPirs}
                    </div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(240, 147, 251, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Total Coaches</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.totalCoaches}
                    </div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(79, 172, 254, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Alerts Today</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.alertsToday}
                    </div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(250, 112, 154, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Avg Compliance</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.avgCompliance}%
                    </div>
                </div>
            </div>

            {/* Trend Charts */}
            <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(400px, 1fr))',
                gap: '25px',
                marginBottom: '40px'
            }}>
                {/* Mood Chart */}
                <div style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '25px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                }}>
                    <h3 style={{ marginBottom: '15px', color: '#333' }}>30-Day Mood Trend</h3>
                    <div style={{ height: '250px' }}>
                        <canvas ref={moodChartRef}></canvas>
                    </div>
                    <div style={{
                        marginTop: '15px',
                        padding: '15px',
                        background: '#f8f9fa',
                        borderRadius: '10px',
                        textAlign: 'center'
                    }}>
                        <div style={{ fontSize: '12px', color: '#666', marginBottom: '5px' }}>
                            All-Time Average
                        </div>
                        <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#4CAF50' }}>
                            {chartData.mood.average}/10
                        </div>
                    </div>
                </div>

                {/* Craving Chart */}
                <div style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '25px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                }}>
                    <h3 style={{ marginBottom: '15px', color: '#333' }}>30-Day Craving Trend</h3>
                    <div style={{ height: '250px' }}>
                        <canvas ref={cravingChartRef}></canvas>
                    </div>
                    <div style={{
                        marginTop: '15px',
                        padding: '15px',
                        background: '#f8f9fa',
                        borderRadius: '10px',
                        textAlign: 'center'
                    }}>
                        <div style={{ fontSize: '12px', color: '#666', marginBottom: '5px' }}>
                            All-Time Average
                        </div>
                        <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#FF9800' }}>
                            {chartData.craving.average}/10
                        </div>
                    </div>
                </div>

                {/* Anxiety Chart */}
                <div style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '25px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                }}>
                    <h3 style={{ marginBottom: '15px', color: '#333' }}>30-Day Anxiety Trend</h3>
                    <div style={{ height: '250px' }}>
                        <canvas ref={anxietyChartRef}></canvas>
                    </div>
                    <div style={{
                        marginTop: '15px',
                        padding: '15px',
                        background: '#f8f9fa',
                        borderRadius: '10px',
                        textAlign: 'center'
                    }}>
                        <div style={{ fontSize: '12px', color: '#666', marginBottom: '5px' }}>
                            All-Time Average
                        </div>
                        <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#f44336' }}>
                            {chartData.anxiety.average}/10
                        </div>
                    </div>
                </div>

                {/* Sleep Chart */}
                <div style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '25px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                }}>
                    <h3 style={{ marginBottom: '15px', color: '#333' }}>30-Day Sleep Quality Trend</h3>
                    <div style={{ height: '250px' }}>
                        <canvas ref={sleepChartRef}></canvas>
                    </div>
                    <div style={{
                        marginTop: '15px',
                        padding: '15px',
                        background: '#f8f9fa',
                        borderRadius: '10px',
                        textAlign: 'center'
                    }}>
                        <div style={{ fontSize: '12px', color: '#666', marginBottom: '5px' }}>
                            All-Time Average
                        </div>
                        <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#9C27B0' }}>
                            {chartData.sleep.average}/10
                        </div>
                    </div>
                </div>
            </div>

            {/* Sobriety Bar Chart */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '25px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
                marginBottom: '40px'
            }}>
                <h3 style={{ marginBottom: '15px', color: '#333' }}>PIR Sobriety Days</h3>
                <div style={{ height: '350px' }}>
                    <canvas ref={sobrietyChartRef}></canvas>
                </div>
                <div style={{
                    marginTop: '20px',
                    padding: '20px',
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    borderRadius: '10px',
                    textAlign: 'center',
                    color: 'white'
                }}>
                    <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '5px' }}>
                        Average Sobriety Days (All PIRs)
                    </div>
                    <div style={{ fontSize: '36px', fontWeight: 'bold' }}>
                        {sobrietyData.average} days
                    </div>
                </div>
            </div>

            {/* Recent Activity */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '25px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
            }}>
                <h3 style={{ marginBottom: '20px', color: '#333' }}>Recent Activity</h3>
                {recentActivity.length === 0 ? (
                    <div style={{
                        padding: '40px',
                        textAlign: 'center',
                        color: '#999'
                    }}>
                        No recent activity
                    </div>
                ) : (
                    <div>
                        {recentActivity.map((activity, index) => (
                            <div key={index} style={{
                                padding: '15px',
                                borderBottom: index < recentActivity.length - 1 ? '1px solid #f0f0f0' : 'none',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center'
                            }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                                    <div style={{
                                        width: '40px',
                                        height: '40px',
                                        borderRadius: '50%',
                                        background: activity.type === 'check-in' 
                                            ? 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)' 
                                            : 'linear-gradient(135deg, #f44336 0%, #e53935 100%)',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        color: 'white',
                                        fontSize: '18px'
                                    }}>
                                        {activity.type === 'check-in' ? '✓' : '⚠'}
                                    </div>
                                    <div>
                                        <div style={{ fontWeight: '500', color: '#333' }}>
                                            {activity.message}
                                        </div>
                                        <div style={{ fontSize: '12px', color: '#999', marginTop: '4px' }}>
                                            {formatTimeAgo(activity.time)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        </div>
    );
}

     // Enhanced Users View with Full Features
function UsersView({ searchQuery, user, onImpersonate }) {
    const [users, setUsers] = useState([]);
    const [filteredUsers, setFilteredUsers] = useState([]);
    const [loading, setLoading] = useState(true);
    const [currentPage, setCurrentPage] = useState(1);
    const [showCreateModal, setShowCreateModal] = useState(false);
    const [selectedUser, setSelectedUser] = useState(null);
    const [activeTab, setActiveTab] = useState('pir');
    
    // New state for enhancements
    const [stats, setStats] = useState({
        totalPIRs: 0,
        activePIRs: 0,
        avgCompliance: 0,
        criticalAlerts: 0,
        newThisWeek: 0
    });
    const [selectedUsers, setSelectedUsers] = useState(new Set());
    const [showBulkActions, setShowBulkActions] = useState(false);
    const [statusFilter, setStatusFilter] = useState('all'); // 'all', 'active', 'inactive', 'critical'
    const [complianceFilter, setComplianceFilter] = useState('all'); // 'all', 'high', 'medium', 'low'
    const [pirHealthData, setPirHealthData] = useState({}); // Store compliance and last check-in per PIR
    
    const itemsPerPage = 20;

    // Separate users by role
    const pirUsers = useMemo(() => users.filter(u => u.role === 'pir'), [users]);
    const coachUsers = useMemo(() => users.filter(u => u.role === 'coach'), [users]);
    const adminUsers = useMemo(() => users.filter(u => u.role === 'admin'), [users]);

    useEffect(() => {
        loadUsers();
    }, []);

    useEffect(() => {
        if (activeTab === 'pir') {
            loadPIRHealthData();
            calculateStats();
        }
    }, [users, activeTab]);

    useEffect(() => {
        filterUsers();
        setCurrentPage(1);
    }, [users, searchQuery, activeTab, statusFilter, complianceFilter]);

    const loadUsers = async () => {
        try {
            setLoading(true);
            
            const usersSnap = await db.collection('users')
                .orderBy('createdAt', 'desc')
                .get();
            
            const usersData = [];
            const coachIds = new Set();
            
            usersSnap.forEach(doc => {
                const userData = { id: doc.id, ...doc.data() };
                usersData.push(userData);
                if (userData.assignedCoach) {
                    coachIds.add(userData.assignedCoach);
                }
            });
            
            // Batch load coaches
            const coachesMap = {};
            if (coachIds.size > 0) {
                const coachResults = await batchQuery('users', 
                    firebase.firestore.FieldPath.documentId(), 
                    Array.from(coachIds)
                );
                
                coachResults.forEach(coach => {
                    coachesMap[coach.id] = coach.displayName || coach.email;
                });
            }
            
            usersData.forEach(user => {
                if (user.assignedCoach && coachesMap[user.assignedCoach]) {
                    user.coachName = coachesMap[user.assignedCoach];
                }
            });
            
            setUsers(usersData);
            
        } catch (error) {
            console.error('Error loading users:', error);
            alert('Failed to load users. Please refresh the page.');
        } finally {
            setLoading(false);
        }
    };

    const loadPIRHealthData = async () => {
        try {
            const healthData = {};
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            // Load check-ins for all PIRs from last 7 days
            const checkInsSnap = await db.collection('checkIns')
                .where('createdAt', '>=', sevenDaysAgo)
                .get();
            
            const pirCheckIns = {};
            checkInsSnap.forEach(doc => {
                const data = doc.data();
                if (!pirCheckIns[data.userId]) {
                    pirCheckIns[data.userId] = [];
                }
                pirCheckIns[data.userId].push(data);
            });
            
            // Calculate compliance and last check-in for each PIR
            pirUsers.forEach(pir => {
                const checkIns = pirCheckIns[pir.id] || [];
                const compliance = Math.round((checkIns.length / 14) * 100); // 2 check-ins per day * 7 days
                
                const lastCheckIn = checkIns.length > 0 
                    ? checkIns.reduce((latest, current) => {
                        const currentDate = current.createdAt?.toDate ? current.createdAt.toDate() : new Date(current.createdAt);
                        const latestDate = latest.createdAt?.toDate ? latest.createdAt.toDate() : new Date(latest.createdAt);
                        return currentDate > latestDate ? current : latest;
                    }).createdAt
                    : null;
                
                healthData[pir.id] = {
                    compliance: Math.min(compliance, 100),
                    lastCheckIn,
                    checkInCount: checkIns.length,
                    status: compliance >= 70 ? 'good' : compliance >= 40 ? 'moderate' : 'critical'
                };
            });
            
            setPirHealthData(healthData);
            
        } catch (error) {
            console.error('Error loading PIR health data:', error);
        }
    };

    const calculateStats = async () => {
        try {
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            // Count active PIRs
            const activePIRs = pirUsers.filter(p => p.active !== false).length;
            
            // Calculate average compliance
            const complianceValues = Object.values(pirHealthData).map(h => h.compliance || 0);
            const avgCompliance = complianceValues.length > 0 
                ? Math.round(complianceValues.reduce((a, b) => a + b, 0) / complianceValues.length)
                : 0;
            
            // Count critical alerts
            const alertsSnap = await db.collection('alerts')
                .where('resolved', '==', false)
                .where('priority', '==', 'critical')
                .get();
            
            // Count new PIRs this week
            const newThisWeek = pirUsers.filter(p => {
                const createdAt = p.createdAt?.toDate ? p.createdAt.toDate() : new Date(p.createdAt);
                return createdAt >= oneWeekAgo;
            }).length;
            
            setStats({
                totalPIRs: pirUsers.length,
                activePIRs,
                avgCompliance,
                criticalAlerts: alertsSnap.size,
                newThisWeek
            });
            
        } catch (error) {
            console.error('Error calculating stats:', error);
        }
    };

    const filterUsers = () => {
        let tabFiltered = [];
        if (activeTab === 'pir') {
            tabFiltered = pirUsers;
        } else if (activeTab === 'coach') {
            tabFiltered = coachUsers;
        } else if (activeTab === 'admin') {
            tabFiltered = adminUsers;
        }

        // Apply status filter
        if (statusFilter !== 'all') {
            if (statusFilter === 'active') {
                tabFiltered = tabFiltered.filter(u => u.active !== false);
            } else if (statusFilter === 'inactive') {
                tabFiltered = tabFiltered.filter(u => u.active === false);
            } else if (statusFilter === 'critical') {
                tabFiltered = tabFiltered.filter(u => pirHealthData[u.id]?.status === 'critical');
            }
        }

        // Apply compliance filter (PIRs only)
        if (activeTab === 'pir' && complianceFilter !== 'all') {
            if (complianceFilter === 'high') {
                tabFiltered = tabFiltered.filter(u => (pirHealthData[u.id]?.compliance || 0) >= 70);
            } else if (complianceFilter === 'medium') {
                tabFiltered = tabFiltered.filter(u => {
                    const comp = pirHealthData[u.id]?.compliance || 0;
                    return comp >= 40 && comp < 70;
                });
            } else if (complianceFilter === 'low') {
                tabFiltered = tabFiltered.filter(u => (pirHealthData[u.id]?.compliance || 0) < 40);
            }
        }

        // Apply search filter
        if (searchQuery) {
            const query = searchQuery.toLowerCase();
            tabFiltered = tabFiltered.filter(user => 
                user.email?.toLowerCase().includes(query) ||
                user.displayName?.toLowerCase().includes(query) ||
                user.firstName?.toLowerCase().includes(query) ||
                user.lastName?.toLowerCase().includes(query) ||
                user.phone?.toLowerCase().includes(query) ||
                user.coachName?.toLowerCase().includes(query)
            );
        }
        
        setFilteredUsers(tabFiltered);
    };

    const paginatedUsers = useMemo(() => {
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        return filteredUsers.slice(start, end);
    }, [filteredUsers, currentPage]);

    const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);

    const handleSelectAll = () => {
        if (selectedUsers.size === paginatedUsers.length) {
            setSelectedUsers(new Set());
        } else {
            setSelectedUsers(new Set(paginatedUsers.map(u => u.id)));
        }
    };

    const handleSelectUser = (userId) => {
        const newSelected = new Set(selectedUsers);
        if (newSelected.has(userId)) {
            newSelected.delete(userId);
        } else {
            newSelected.add(userId);
        }
        setSelectedUsers(newSelected);
    };

    const handleBulkAssignCoach = async () => {
        const coachId = prompt('Enter coach ID to assign:');
        if (!coachId) return;
        
        try {
            const batch = db.batch();
            selectedUsers.forEach(userId => {
                const userRef = db.collection('users').doc(userId);
                batch.update(userRef, { assignedCoach: coachId });
            });
            
            await batch.commit();
            alert(`Assigned coach to ${selectedUsers.size} users`);
            setSelectedUsers(new Set());
            loadUsers();
        } catch (error) {
            console.error('Error in bulk assign:', error);
            alert('Failed to assign coach');
        }
    };

    const handleBulkToggleStatus = async () => {
        try {
            const batch = db.batch();
            selectedUsers.forEach(userId => {
                const user = users.find(u => u.id === userId);
                const userRef = db.collection('users').doc(userId);
                batch.update(userRef, { active: user.active === false });
            });
            
            await batch.commit();
            alert(`Updated status for ${selectedUsers.size} users`);
            setSelectedUsers(new Set());
            loadUsers();
        } catch (error) {
            console.error('Error in bulk status toggle:', error);
            alert('Failed to update status');
        }
    };

    const handleExport = (format) => {
        const exportData = filteredUsers.map(user => ({
            name: user.displayName || 'N/A',
            email: user.email,
            role: user.role,
            status: user.active !== false ? 'Active' : 'Inactive',
            coach: user.coachName || 'N/A',
            compliance: activeTab === 'pir' ? `${pirHealthData[user.id]?.compliance || 0}%` : 'N/A',
            phone: user.phone || 'N/A',
            joined: formatDate(user.createdAt)
        }));

        if (format === 'json') {
            exportToJSON(exportData, `${activeTab}_users`);
        } else if (format === 'csv') {
            exportToCSV(exportData, `${activeTab}_users`);
        } else if (format === 'pdf') {
            exportToPDF(exportData, `${activeTab.toUpperCase()} Users Report`);
        }
    };

    const getHealthBadgeColor = (status) => {
        if (status === 'good') return '#4CAF50';
        if (status === 'moderate') return '#FF9800';
        return '#f44336';
    };

    if (loading) {
        return (
            <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                minHeight: '400px',
                gap: '20px'
            }}>
                <div style={{
                    width: '60px',
                    height: '60px',
                    border: '4px solid #f3f3f3',
                    borderTop: '4px solid #667eea',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite'
                }}></div>
                <p style={{ color: '#666', fontSize: '16px' }}>Loading users...</p>
            </div>
        );
    }

    return (
        <div style={{ animation: 'fadeIn 0.3s ease-in' }}>
            {/* Stats Cards - PIRs Only */}
            {activeTab === 'pir' && (
                <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                    gap: '20px',
                    marginBottom: '30px'
                }}>
                    <div style={{
                        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        borderRadius: '15px',
                        padding: '25px',
                        color: 'white',
                        boxShadow: '0 4px 15px rgba(102, 126, 234, 0.3)',
                        transition: 'transform 0.2s',
                        cursor: 'pointer'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                    onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                    >
                        <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '10px' }}>Total PIRs</div>
                        <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{stats.totalPIRs}</div>
                        <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '10px' }}>
                            {stats.activePIRs} active
                        </div>
                    </div>

                    <div style={{
                        background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                        borderRadius: '15px',
                        padding: '25px',
                        color: 'white',
                        boxShadow: '0 4px 15px rgba(240, 147, 251, 0.3)',
                        transition: 'transform 0.2s',
                        cursor: 'pointer'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                    onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                    >
                        <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '10px' }}>Avg Compliance</div>
                        <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{stats.avgCompliance}%</div>
                        <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '10px' }}>
                            Last 7 days
                        </div>
                    </div>

                    <div style={{
                        background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                        borderRadius: '15px',
                        padding: '25px',
                        color: 'white',
                        boxShadow: '0 4px 15px rgba(79, 172, 254, 0.3)',
                        transition: 'transform 0.2s',
                        cursor: 'pointer'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                    onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                    >
                        <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '10px' }}>Critical Alerts</div>
                        <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{stats.criticalAlerts}</div>
                        <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '10px' }}>
                            Require attention
                        </div>
                    </div>

                    <div style={{
                        background: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                        borderRadius: '15px',
                        padding: '25px',
                        color: 'white',
                        boxShadow: '0 4px 15px rgba(250, 112, 154, 0.3)',
                        transition: 'transform 0.2s',
                        cursor: 'pointer'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                    onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                    >
                        <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '10px' }}>New This Week</div>
                        <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{stats.newThisWeek}</div>
                        <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '10px' }}>
                            Recent additions
                        </div>
                    </div>
                </div>
            )}

            {/* Tab Navigation with enhanced design */}
            <div style={{
                display: 'flex',
                gap: '10px',
                marginBottom: '25px',
                borderBottom: '2px solid #e9ecef',
                paddingBottom: '5px'
            }}>
                <button 
                    onClick={() => setActiveTab('pir')}
                    style={{
                        padding: '12px 24px',
                        border: 'none',
                        background: activeTab === 'pir' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'transparent',
                        color: activeTab === 'pir' ? 'white' : '#666',
                        borderRadius: '10px 10px 0 0',
                        cursor: 'pointer',
                        fontSize: '15px',
                        fontWeight: activeTab === 'pir' ? '600' : '500',
                        transition: 'all 0.3s',
                        boxShadow: activeTab === 'pir' ? '0 -2px 10px rgba(102, 126, 234, 0.3)' : 'none',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                    }}
                    onMouseEnter={(e) => {
                        if (activeTab !== 'pir') {
                            e.currentTarget.style.background = '#f8f9fa';
                            e.currentTarget.style.color = '#333';
                        }
                    }}
                    onMouseLeave={(e) => {
                        if (activeTab !== 'pir') {
                            e.currentTarget.style.background = 'transparent';
                            e.currentTarget.style.color = '#666';
                        }
                    }}
                >
                    <span style={{ fontSize: '18px' }}>👥</span>
                    PIRs ({pirUsers.length})
                </button>
                <button 
                    onClick={() => setActiveTab('coach')}
                    style={{
                        padding: '12px 24px',
                        border: 'none',
                        background: activeTab === 'coach' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'transparent',
                        color: activeTab === 'coach' ? 'white' : '#666',
                        borderRadius: '10px 10px 0 0',
                        cursor: 'pointer',
                        fontSize: '15px',
                        fontWeight: activeTab === 'coach' ? '600' : '500',
                        transition: 'all 0.3s',
                        boxShadow: activeTab === 'coach' ? '0 -2px 10px rgba(102, 126, 234, 0.3)' : 'none',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                    }}
                    onMouseEnter={(e) => {
                        if (activeTab !== 'coach') {
                            e.currentTarget.style.background = '#f8f9fa';
                            e.currentTarget.style.color = '#333';
                        }
                    }}
                    onMouseLeave={(e) => {
                        if (activeTab !== 'coach') {
                            e.currentTarget.style.background = 'transparent';
                            e.currentTarget.style.color = '#666';
                        }
                    }}
                >
                    <span style={{ fontSize: '18px' }}>🎓</span>
                    Coaches ({coachUsers.length})
                </button>
                <button 
                    onClick={() => setActiveTab('admin')}
                    style={{
                        padding: '12px 24px',
                        border: 'none',
                        background: activeTab === 'admin' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'transparent',
                        color: activeTab === 'admin' ? 'white' : '#666',
                        borderRadius: '10px 10px 0 0',
                        cursor: 'pointer',
                        fontSize: '15px',
                        fontWeight: activeTab === 'admin' ? '600' : '500',
                        transition: 'all 0.3s',
                        boxShadow: activeTab === 'admin' ? '0 -2px 10px rgba(102, 126, 234, 0.3)' : 'none',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                    }}
                    onMouseEnter={(e) => {
                        if (activeTab !== 'admin') {
                            e.currentTarget.style.background = '#f8f9fa';
                            e.currentTarget.style.color = '#333';
                        }
                    }}
                    onMouseLeave={(e) => {
                        if (activeTab !== 'admin') {
                            e.currentTarget.style.background = 'transparent';
                            e.currentTarget.style.color = '#666';
                        }
                    }}
                >
                    <span style={{ fontSize: '18px' }}>⚙️</span>
                    Admins ({adminUsers.length})
                </button>
            </div>

            {/* Filters and Actions Bar */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                marginBottom: '20px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                flexWrap: 'wrap',
                gap: '15px'
            }}>
                <div style={{ display: 'flex', gap: '10px', alignItems: 'center', flexWrap: 'wrap' }}>
                    {/* Status Filter */}
                    <select 
                        value={statusFilter}
                        onChange={(e) => setStatusFilter(e.target.value)}
                        style={{
                            padding: '8px 12px',
                            borderRadius: '8px',
                            border: '1px solid #ddd',
                            background: 'white',
                            cursor: 'pointer',
                            fontSize: '14px'
                        }}
                    >
                        <option value="all">All Status</option>
                        <option value="active">Active Only</option>
                        <option value="inactive">Inactive Only</option>
                        {activeTab === 'pir' && <option value="critical">Critical Status</option>}
                    </select>

                    {/* Compliance Filter - PIRs only */}
                    {activeTab === 'pir' && (
                        <select 
                            value={complianceFilter}
                            onChange={(e) => setComplianceFilter(e.target.value)}
                            style={{
                                padding: '8px 12px',
                                borderRadius: '8px',
                                border: '1px solid #ddd',
                                background: 'white',
                                cursor: 'pointer',
                                fontSize: '14px'
                            }}
                        >
                            <option value="all">All Compliance</option>
                            <option value="high">High (70%+)</option>
                            <option value="medium">Medium (40-70%)</option>
                            <option value="low">Low (&lt;40%)</option>
                        </select>
                    )}

                    <div style={{ 
                        fontSize: '14px', 
                        color: '#666',
                        padding: '8px 12px',
                        background: '#f8f9fa',
                        borderRadius: '8px'
                    }}>
                        Showing {paginatedUsers.length} of {filteredUsers.length} {activeTab}s
                        {searchQuery && ' (filtered)'}
                    </div>
                </div>

                <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                    {/* Bulk Actions - PIRs only */}
                    {activeTab === 'pir' && selectedUsers.size > 0 && (
                        <>
                            <button 
                                onClick={handleBulkAssignCoach}
                                style={{
                                    padding: '10px 16px',
                                    background: 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500',
                                    transition: 'transform 0.2s',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px'
                                }}
                                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                            >
                                Assign Coach ({selectedUsers.size})
                            </button>
                            <button 
                                onClick={handleBulkToggleStatus}
                                style={{
                                    padding: '10px 16px',
                                    background: 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500',
                                    transition: 'transform 0.2s',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px'
                                }}
                                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                            >
                                Toggle Status ({selectedUsers.size})
                            </button>
                        </>
                    )}

                    {/* Export Buttons */}
                    <button 
                        onClick={() => handleExport('csv')}
                        style={{
                            padding: '10px 16px',
                            background: '#6c757d',
                            color: 'white',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500',
                            transition: 'all 0.2s'
                        }}
                        onMouseEnter={(e) => {
                            e.currentTarget.style.background = '#5a6268';
                            e.currentTarget.style.transform = 'translateY(-2px)';
                        }}
                        onMouseLeave={(e) => {
                            e.currentTarget.style.background = '#6c757d';
                            e.currentTarget.style.transform = 'translateY(0)';
                        }}
                    >
                        Export CSV
                    </button>
                    
                    <button 
                        onClick={() => setShowCreateModal(true)}
                        style={{
                            padding: '10px 20px',
                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            color: 'white',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '600',
                            transition: 'all 0.2s',
                            boxShadow: '0 4px 12px rgba(102, 126, 234, 0.4)',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px'
                        }}
                        onMouseEnter={(e) => {
                            e.currentTarget.style.transform = 'translateY(-2px)';
                            e.currentTarget.style.boxShadow = '0 6px 16px rgba(102, 126, 234, 0.5)';
                        }}
                        onMouseLeave={(e) => {
                            e.currentTarget.style.transform = 'translateY(0)';
                            e.currentTarget.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.4)';
                        }}
                    >
                        <span style={{ fontSize: '16px' }}>+</span> Create User
                    </button>
                </div>
            </div>
            
            {/* Enhanced Table */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                overflow: 'hidden',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                    <thead>
                        <tr style={{ background: '#f8f9fa', borderBottom: '2px solid #e9ecef' }}>
                            {activeTab === 'pir' && (
                                <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>
                                    <input 
                                        type="checkbox"
                                        checked={selectedUsers.size === paginatedUsers.length && paginatedUsers.length > 0}
                                        onChange={handleSelectAll}
                                        style={{ cursor: 'pointer', width: '16px', height: '16px' }}
                                    />
                                </th>
                            )}
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Name</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Email</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Status</th>
                            {activeTab === 'pir' && <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Health</th>}
                            {activeTab === 'pir' && <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Assigned Coach</th>}
                            {activeTab === 'pir' && <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Last Check-in</th>}
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Phone</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Joined</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {paginatedUsers.map((user, index) => (
                            <tr key={user.id} style={{
                                borderBottom: '1px solid #f0f0f0',
                                transition: 'all 0.2s',
                                background: selectedUsers.has(user.id) ? '#f0f4ff' : 'white'
                            }}
                            onMouseEnter={(e) => {
                                if (!selectedUsers.has(user.id)) {
                                    e.currentTarget.style.background = '#f8f9fa';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (!selectedUsers.has(user.id)) {
                                    e.currentTarget.style.background = 'white';
                                }
                            }}
                            >
                                {activeTab === 'pir' && (
                                    <td style={{ padding: '15px' }}>
                                        <input 
                                            type="checkbox"
                                            checked={selectedUsers.has(user.id)}
                                            onChange={() => handleSelectUser(user.id)}
                                            style={{ cursor: 'pointer', width: '16px', height: '16px' }}
                                        />
                                    </td>
                                )}
                                <td style={{ padding: '15px' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                        <div style={{
                                            width: '40px',
                                            height: '40px',
                                            borderRadius: '50%',
                                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            color: 'white',
                                            fontWeight: '600',
                                            fontSize: '16px'
                                        }}>
                                            {(user.displayName || user.email || 'U').charAt(0).toUpperCase()}
                                        </div>
                                        <span style={{ fontWeight: '500', color: '#333' }}>
                                            {user.displayName || 'N/A'}
                                        </span>
                                    </div>
                                </td>
                                <td style={{ padding: '15px', color: '#666' }}>{user.email}</td>
                                <td style={{ padding: '15px' }}>
                                    <span style={{
                                        padding: '4px 12px',
                                        borderRadius: '20px',
                                        fontSize: '12px',
                                        fontWeight: '500',
                                        background: user.active !== false ? '#d4edda' : '#f8d7da',
                                        color: user.active !== false ? '#155724' : '#721c24'
                                    }}>
                                        {user.active !== false ? 'Active' : 'Inactive'}
                                    </span>
                                </td>
                                {activeTab === 'pir' && (
                                    <td style={{ padding: '15px' }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            <div style={{
                                                width: '8px',
                                                height: '8px',
                                                borderRadius: '50%',
                                                background: getHealthBadgeColor(pirHealthData[user.id]?.status)
                                            }}></div>
                                            <span style={{ 
                                                fontSize: '13px',
                                                fontWeight: '500',
                                                color: '#666'
                                            }}>
                                                {pirHealthData[user.id]?.compliance || 0}%
                                            </span>
                                        </div>
                                    </td>
                                )}
                                {activeTab === 'pir' && <td style={{ padding: '15px', color: '#666' }}>{user.coachName || '-'}</td>}
                                {activeTab === 'pir' && (
                                    <td style={{ padding: '15px', color: '#666' }}>
                                        {pirHealthData[user.id]?.lastCheckIn ? formatTimeAgo(pirHealthData[user.id].lastCheckIn) : 'Never'}
                                    </td>
                                )}
                                <td style={{ padding: '15px', color: '#666' }}>{user.phone || '-'}</td>
                                <td style={{ padding: '15px', color: '#666' }}>{formatDate(user.createdAt)}</td>
                                <td style={{ padding: '15px' }}>
                                    <div style={{ display: 'flex', gap: '8px' }}>
                                        <button 
                                            onClick={() => setSelectedUser(user)}
                                            style={{
                                                padding: '6px 12px',
                                                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '6px',
                                                cursor: 'pointer',
                                                fontSize: '13px',
                                                fontWeight: '500',
                                                transition: 'transform 0.2s'
                                            }}
                                            onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.05)'}
                                            onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
                                        >
                                            View
                                        </button>
                                        {user.role === 'pir' && (
                                            <button 
                                                onClick={() => onImpersonate(user)}
                                                style={{
                                                    padding: '6px 12px',
                                                    background: '#6c757d',
                                                    color: 'white',
                                                    border: 'none',
                                                    borderRadius: '6px',
                                                    cursor: 'pointer',
                                                    fontSize: '13px',
                                                    fontWeight: '500',
                                                    transition: 'all 0.2s'
                                                }}
                                                onMouseEnter={(e) => {
                                                    e.currentTarget.style.background = '#5a6268';
                                                    e.currentTarget.style.transform = 'scale(1.05)';
                                                }}
                                                onMouseLeave={(e) => {
                                                    e.currentTarget.style.background = '#6c757d';
                                                    e.currentTarget.style.transform = 'scale(1)';
                                                }}
                                            >
                                                View As
                                            </button>
                                        )}
                                    </div>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
                
                {filteredUsers.length === 0 && (
                    <div style={{
                        padding: '60px 20px',
                        textAlign: 'center',
                        color: '#999'
                    }}>
                        <div style={{ fontSize: '48px', marginBottom: '15px' }}>🔍</div>
                        <div style={{ fontSize: '18px', fontWeight: '500', marginBottom: '8px' }}>
                            {searchQuery ? `No ${activeTab}s found matching your search` : `No ${activeTab}s found`}
                        </div>
                        <div style={{ fontSize: '14px' }}>
                            {searchQuery ? 'Try adjusting your search terms' : `Click "Create User" to add a new ${activeTab}`}
                        </div>
                    </div>
                )}
            </div>
            
            {totalPages > 1 && (
                <div style={{ marginTop: '20px' }}>
                    <Pagination 
                        currentPage={currentPage}
                        totalPages={totalPages}
                        onPageChange={setCurrentPage}
                    />
                </div>
            )}
            
            {showCreateModal && (
                <CreateUserModal 
                    onClose={() => setShowCreateModal(false)}
                    onSuccess={() => {
                        setShowCreateModal(false);
                        loadUsers();
                    }}
                />
            )}
            
            {selectedUser && (
                selectedUser.role === 'coach' || selectedUser.role === 'admin' ? (
                    <CoachDetailModal 
                        coach={selectedUser}
                        onClose={() => setSelectedUser(null)}
                        onUpdate={() => {
                            setSelectedUser(null);
                            loadUsers();
                        }}
                        currentUserId={user.uid}
                    />
                ) : (
                    <UserDetailModal 
                        user={selectedUser}
                        onClose={() => setSelectedUser(null)}
                        onUpdate={() => {
                            setSelectedUser(null);
                            loadUsers();
                        }}
                        currentUserId={user.uid}
                    />
                )
            )}
        </div>
    );
}
        // My PIRs View - Admin's own caseload management
function MyPIRsView({ searchQuery, user }) {
    const [myPIRs, setMyPIRs] = useState([]);
    const [filteredPIRs, setFilteredPIRs] = useState([]);
    const [loading, setLoading] = useState(true);
    const [selectedPIR, setSelectedPIR] = useState(null);
    const [activeFilter, setActiveFilter] = useState('all'); // all, needsAttention, compliant
    const [recentCheckIns, setRecentCheckIns] = useState([]);
    const [pendingAlerts, setPendingAlerts] = useState([]);
    
    useEffect(() => {
        loadMyPIRs();
    }, [user]);

    useEffect(() => {
        filterPIRs();
    }, [searchQuery, myPIRs, activeFilter]);

    const loadMyPIRs = async () => {
        try {
            setLoading(true);
            
            // Get PIRs assigned to current admin
            const pirsSnap = await db.collection('users')
                .where('assignedCoach', '==', user.uid)
                .where('role', '==', 'pir')
                .get();

            const pirsData = [];
            const pirIds = [];
            
            for (const doc of pirsSnap.docs) {
                const pirData = { id: doc.id, ...doc.data() };
                pirIds.push(doc.id);
                
                // Get last check-in for each PIR
                const lastCheckInSnap = await db.collection('checkIns')
                    .where('userId', '==', doc.id)
                    .orderBy('createdAt', 'desc')
                    .limit(1)
                    .get();
                
                if (!lastCheckInSnap.empty) {
                    pirData.lastCheckIn = lastCheckInSnap.docs[0].data();
                    pirData.lastCheckInDate = lastCheckInSnap.docs[0].data().createdAt;
                }
                
                // Calculate days clean
                if (pirData.sobrietyDate) {
                    const sobrietyDate = pirData.sobrietyDate.toDate ? 
                        pirData.sobrietyDate.toDate() : new Date(pirData.sobrietyDate);
                    pirData.daysClean = Math.floor((new Date() - sobrietyDate) / (1000 * 60 * 60 * 24));
                } else {
                    pirData.daysClean = 0;
                }
                
                // Check compliance (last 7 days)
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                
                const recentCheckInsSnap = await db.collection('checkIns')
                    .where('userId', '==', doc.id)
                    .where('createdAt', '>=', sevenDaysAgo)
                    .get();
                
                pirData.weeklyCheckIns = recentCheckInsSnap.size;
                pirData.complianceRate = Math.round((recentCheckInsSnap.size / 7) * 100);
                
                // Check for active alerts
                const alertsSnap = await db.collection('alerts')
                    .where('userId', '==', doc.id)
                    .where('status', '==', 'active')
                    .get();
                
                pirData.activeAlerts = alertsSnap.size;
                
                pirsData.push(pirData);
            }
            
            // Load recent check-ins from all PIRs
            if (pirIds.length > 0) {
                const checkInsPromises = pirIds.map(id =>
                    db.collection('checkIns')
                        .where('userId', '==', id)
                        .orderBy('createdAt', 'desc')
                        .limit(3)
                        .get()
                );
                
                const checkInsSnapshots = await Promise.all(checkInsPromises);
                const allCheckIns = [];
                
                checkInsSnapshots.forEach((snapshot, index) => {
                    snapshot.forEach(doc => {
                        const checkInData = { id: doc.id, ...doc.data() };
                        const pir = pirsData.find(p => p.id === pirIds[index]);
                        checkInData.pirName = pir?.displayName || pir?.email || 'Unknown';
                        checkInData.pirId = pirIds[index];
                        allCheckIns.push(checkInData);
                    });
                });
                
                // Sort by date
                allCheckIns.sort((a, b) => {
                    const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
                    const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
                    return dateB - dateA;
                });
                
                setRecentCheckIns(allCheckIns.slice(0, 10));
                
                // Load pending alerts
                const alertsPromises = pirIds.map(id =>
                    db.collection('alerts')
                        .where('userId', '==', id)
                        .where('status', '==', 'active')
                        .get()
                );
                
                const alertsSnapshots = await Promise.all(alertsPromises);
                const allAlerts = [];
                
                alertsSnapshots.forEach((snapshot, index) => {
                    snapshot.forEach(doc => {
                        const alertData = { id: doc.id, ...doc.data() };
                        const pir = pirsData.find(p => p.id === pirIds[index]);
                        alertData.pirName = pir?.displayName || pir?.email || 'Unknown';
                        alertData.pirId = pirIds[index];
                        allAlerts.push(alertData);
                    });
                });
                
                setPendingAlerts(allAlerts);
            }
            
            setMyPIRs(pirsData);
            setFilteredPIRs(pirsData);
            
        } catch (error) {
            console.error('Error loading my PIRs:', error);
        } finally {
            setLoading(false);
        }
    };

    const filterPIRs = () => {
        let filtered = [...myPIRs];
        
        // Apply status filter
        if (activeFilter === 'needsAttention') {
            filtered = filtered.filter(pir => 
                pir.complianceRate < 50 || 
                pir.activeAlerts > 0 ||
                !pir.lastCheckInDate ||
                (pir.lastCheckInDate && daysSince(pir.lastCheckInDate) > 2)
            );
        } else if (activeFilter === 'compliant') {
            filtered = filtered.filter(pir => 
                pir.complianceRate >= 70 && 
                pir.activeAlerts === 0
            );
        }
        
        // Apply search filter
        if (searchQuery) {
            const query = searchQuery.toLowerCase();
            filtered = filtered.filter(pir =>
                pir.email?.toLowerCase().includes(query) ||
                pir.displayName?.toLowerCase().includes(query) ||
                pir.firstName?.toLowerCase().includes(query) ||
                pir.lastName?.toLowerCase().includes(query)
            );
        }
        
        setFilteredPIRs(filtered);
    };

    const daysSince = (date) => {
        const checkDate = date?.toDate ? date.toDate() : new Date(date);
        return Math.floor((new Date() - checkDate) / (1000 * 60 * 60 * 24));
    };

    const handleQuickAssignment = async (pirId) => {
        const title = prompt('Assignment Title:');
        if (title) {
            const description = prompt('Assignment Description:');
            const dueDate = prompt('Due Date (YYYY-MM-DD):');
            
            try {
                await db.collection('assignments').add({
                    userId: pirId,
                    title: title,
                    description: description || '',
                    dueDate: dueDate || '',
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: user.uid
                });
                
                alert('Assignment created successfully!');
            } catch (error) {
                console.error('Error creating assignment:', error);
                alert('Failed to create assignment');
            }
        }
    };

    const handleResolveAlert = async (alertId) => {
        try {
            await db.collection('alerts').doc(alertId).update({
                status: 'resolved',
                resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                resolvedBy: user.uid
            });
            
            // Reload data
            loadMyPIRs();
        } catch (error) {
            console.error('Error resolving alert:', error);
            alert('Failed to resolve alert');
        }
    };

    const getStatusColor = (pir) => {
        if (pir.activeAlerts > 0) return '#ff4757';
        if (pir.complianceRate < 50) return '#ff9800';
        if (pir.complianceRate >= 70) return '#4CAF50';
        return '#ffc107';
    };

    const getStatusLabel = (pir) => {
        if (pir.activeAlerts > 0) return 'Alert';
        if (!pir.lastCheckInDate) return 'No Check-in';
        if (daysSince(pir.lastCheckInDate) > 2) return 'Overdue';
        if (pir.complianceRate >= 70) return 'Good';
        if (pir.complianceRate >= 50) return 'Fair';
        return 'Needs Attention';
    };

    if (loading) {
        return (
            <div className="loading-container">
                <div className="loading-spinner"></div>
            </div>
        );
    }

    return (
        <div className="my-pirs-container">
            {/* Header Stats */}
            <div className="stats-row">
                <div className="stat-card">
                    <div className="stat-value">{myPIRs.length}</div>
                    <div className="stat-label">Total PIRs</div>
                </div>
                <div className="stat-card">
                    <div className="stat-value" style={{color: '#ff4757'}}>
                        {pendingAlerts.length}
                    </div>
                    <div className="stat-label">Active Alerts</div>
                </div>
                <div className="stat-card">
                    <div className="stat-value">
                        {myPIRs.filter(p => p.complianceRate >= 70).length}
                    </div>
                    <div className="stat-label">Compliant PIRs</div>
                </div>
                <div className="stat-card">
                    <div className="stat-value">
                        {Math.round(myPIRs.reduce((acc, p) => acc + p.daysClean, 0) / (myPIRs.length || 1))}
                    </div>
                    <div className="stat-label">Avg Days Clean</div>
                </div>
            </div>

            {/* Alerts Section */}
            {pendingAlerts.length > 0 && (
                <div className="alerts-section" style={{marginBottom: '20px'}}>
                    <h3 style={{color: '#ff4757', marginBottom: '15px'}}>⚠️ Pending Alerts</h3>
                    {pendingAlerts.map(alert => (
                        <div key={alert.id} className="alert-item" style={{
                            background: 'rgba(255, 71, 87, 0.1)',
                            border: '1px solid #ff4757',
                            borderRadius: '10px',
                            padding: '15px',
                            marginBottom: '10px'
                        }}>
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                <div>
                                    <strong>{alert.pirName}</strong> - {alert.type}
                                    <div style={{fontSize: '14px', opacity: 0.8}}>
                                        {alert.message}
                                    </div>
                                    <div style={{fontSize: '12px', opacity: 0.6}}>
                                        {formatTimeAgo(alert.timestamp)}
                                    </div>
                                </div>
                                <button 
                                    className="btn btn-sm btn-primary"
                                    onClick={() => handleResolveAlert(alert.id)}
                                >
                                    Resolve
                                </button>
                            </div>
                        </div>
                    ))}
                </div>
            )}

            {/* Filter Buttons */}
            <div className="filter-row" style={{marginBottom: '20px'}}>
                <button 
                    className={`filter-btn ${activeFilter === 'all' ? 'active' : ''}`}
                    onClick={() => setActiveFilter('all')}
                >
                    All ({myPIRs.length})
                </button>
                <button 
                    className={`filter-btn ${activeFilter === 'needsAttention' ? 'active' : ''}`}
                    onClick={() => setActiveFilter('needsAttention')}
                >
                    Needs Attention ({myPIRs.filter(p => 
                        p.complianceRate < 50 || p.activeAlerts > 0 || daysSince(p.lastCheckInDate) > 2
                    ).length})
                </button>
                <button 
                    className={`filter-btn ${activeFilter === 'compliant' ? 'active' : ''}`}
                    onClick={() => setActiveFilter('compliant')}
                >
                    Compliant ({myPIRs.filter(p => p.complianceRate >= 70 && p.activeAlerts === 0).length})
                </button>
            </div>

            {/* PIRs Grid */}
            <div className="pirs-grid">
                {filteredPIRs.map(pir => (
                    <div key={pir.id} className="pir-card" style={{
                        borderLeft: `4px solid ${getStatusColor(pir)}`
                    }}>
                        <div className="pir-header">
                            <div>
                                <h4>{pir.displayName || pir.email}</h4>
                                <span className="badge" style={{
                                    backgroundColor: getStatusColor(pir)
                                }}>
                                    {getStatusLabel(pir)}
                                </span>
                            </div>
                            {pir.activeAlerts > 0 && (
                                <span className="alert-badge">
                                    🚨 {pir.activeAlerts}
                                </span>
                            )}
                        </div>
                        
                        <div className="pir-stats">
                            <div className="stat-item">
                                <span className="stat-label">Days Clean:</span>
                                <span className="stat-value">{pir.daysClean}</span>
                            </div>
                            <div className="stat-item">
                                <span className="stat-label">Weekly Compliance:</span>
                                <span className="stat-value">{pir.complianceRate}%</span>
                            </div>
                            <div className="stat-item">
                                <span className="stat-label">Last Check-in:</span>
                                <span className="stat-value">
                                    {pir.lastCheckInDate ? formatTimeAgo(pir.lastCheckInDate) : 'Never'}
                                </span>
                            </div>
                            {pir.lastCheckIn && (
                                <>
                                    <div className="stat-item">
    <span className="stat-label">Mood:</span>
    <span className="stat-value">{pir.lastCheckIn.morningData?.mood || '--'}/5</span>
</div>
<div className="stat-item">
    <span className="stat-label">Cravings:</span>
    <span className="stat-value">{pir.lastCheckIn.morningData?.craving || '--'}/5</span>
</div>
</>
)}
</div>
                        
                        <div className="pir-actions">
                            <button 
                                className="action-btn btn-primary"
                                onClick={() => setSelectedPIR(pir)}
                            >
                                View Details
                            </button>
                            <button 
                                className="action-btn btn-secondary"
                                onClick={() => handleQuickAssignment(pir.id)}
                            >
                                + Assignment
                            </button>
                        </div>
                    </div>
                ))}
            </div>

            {filteredPIRs.length === 0 && (
                <div className="empty-state">
                    {myPIRs.length === 0 ? 
                        'You have no PIRs assigned to you.' : 
                        'No PIRs match your filter criteria.'}
                </div>
            )}

           {/* Recent Check-ins Section */}
{recentCheckIns.length > 0 && (
    <div className="recent-section" style={{marginTop: '30px'}}>
        <h3>Recent Check-ins</h3>
        <div className="checkins-list">
            {recentCheckIns.map(checkIn => (
                <div key={checkIn.id} className="checkin-item">
                    <div className="checkin-header">
                        <strong>{checkIn.pirName}</strong>
                        <span>{formatTimeAgo(checkIn.createdAt)}</span>
                    </div>
                    <div className="checkin-content">
                        <span>Mood: {checkIn.morningData?.mood || '--'}/5</span>
                        <span>Cravings: {checkIn.morningData?.craving || '--'}/5</span>
                        {checkIn.attendedMeeting && <span>✓ Attended Meeting</span>}
                    </div>
                    {checkIn.morningData?.notes && (
                        <div className="checkin-notes">
                            Notes: {checkIn.morningData.notes}
                        </div>
                    )}
                </div>
            ))}
        </div>
    </div>
)}
            {/* Show PIR Detail Modal if selected */}
            {selectedPIR && (
                <UserDetailModal
                    user={selectedPIR}
                    onClose={() => setSelectedPIR(null)}
                    onUpdate={() => {
                        setSelectedPIR(null);
                        loadMyPIRs();
                    }}
                    currentUserId={user.uid}
                />
            )}
        </div>
    );
}
       // Community Management View - Enhanced with Groups, Support Groups, and Meetings
function CommunityView({ searchQuery, user }) {
    const [activeTab, setActiveTab] = useState('chat');
    const [loading, setLoading] = useState(true);
    const [messages, setMessages] = useState([]);
    const [topicRooms, setTopicRooms] = useState([]);
    const [flaggedMessages, setFlaggedMessages] = useState([]);
    const [supportGroups, setSupportGroups] = useState([]);
    const [groups, setGroups] = useState([]);
    const [meetings, setMeetings] = useState([]);
    const [selectedRoom, setSelectedRoom] = useState('main');
    const [newMessage, setNewMessage] = useState('');
    const [showCreateRoom, setShowCreateRoom] = useState(false);
    const [showCreateModal, setShowCreateModal] = useState(false);
    const [modalType, setModalType] = useState(''); // room, supportGroup, group, meeting
    const [selectedItem, setSelectedItem] = useState(null);
    const [selectedImage, setSelectedImage] = useState(null);
    const [messageListener, setMessageListener] = useState(null);
    const [stats, setStats] = useState({
        totalMessages: 0,
        activeUsers: 0,
        flaggedCount: 0,
        roomsCount: 0,
        supportGroupsCount: 0,
        groupsCount: 0,
        meetingsCount: 0
    });

    useEffect(() => {
        loadCommunityData();
        return () => {
            if (messageListener) {
                messageListener();
            }
        };
    }, []);

    useEffect(() => {
        if (selectedRoom) {
            loadMessages(selectedRoom);
        }
    }, [selectedRoom]);

    const loadCommunityData = async () => {
        try {
            setLoading(true);

            // Load topic rooms
            const roomsSnap = await db.collection('topicRooms').get();
            const roomsData = [];
            roomsSnap.forEach(doc => {
                roomsData.push({ id: doc.id, ...doc.data() });
            });
            setTopicRooms(roomsData);

            // Load support groups
            const supportGroupsSnap = await db.collection('supportGroups')
                .orderBy('createdAt', 'desc')
                .get();
            const supportGroupsData = [];
            supportGroupsSnap.forEach(doc => {
                supportGroupsData.push({ id: doc.id, ...doc.data() });
            });
            setSupportGroups(supportGroupsData);

            

           // Load meetings (group sessions)
const meetingsSnap = await db.collection('meetings')
    .where('coachId', '==', user.uid)
    .orderBy('scheduledTime', 'desc')
    .limit(50)
    .get();
const meetingsData = [];
for (const doc of meetingsSnap.docs) {
    const meetingData = { id: doc.id, ...doc.data() };
    
    // Get PIR names if specific PIRs assigned
    if (meetingData.assignedPIRs && meetingData.assignedPIRs.length > 0) {
        const pirNames = [];
        for (const pirId of meetingData.assignedPIRs) {
            const pirDoc = await db.collection('users').doc(pirId).get();
            if (pirDoc.exists) {
                const pirData = pirDoc.data();
                pirNames.push(pirData.displayName || `${pirData.firstName} ${pirData.lastName}` || pirData.email);
            }
        }
        meetingData.pirNames = pirNames;
    }
    meetingsData.push(meetingData);
}
setMeetings(meetingsData);

            // Load flagged messages
            const flaggedSnap = await db.collection('messages')
                .where('flagged', '==', true)
                .where('resolved', '==', false)
                .orderBy('flaggedAt', 'desc')
                .limit(20)
                .get();

            const flaggedData = [];
            for (const doc of flaggedSnap.docs) {
                const messageData = { id: doc.id, ...doc.data() };
                
                if (messageData.userId) {
                    const userDoc = await db.collection('users').doc(messageData.userId).get();
                    if (userDoc.exists) {
                        messageData.userName = userDoc.data().displayName || userDoc.data().email;
                    }
                }
                
                flaggedData.push(messageData);
            }
            setFlaggedMessages(flaggedData);

            // Calculate stats
            const messagesSnap = await db.collection('messages')
                .where('roomId', '==', 'main')
                .orderBy('createdAt', 'desc')
                .limit(100)
                .get();

            const uniqueUsers = new Set();
            messagesSnap.forEach(doc => {
                const data = doc.data();
                if (data.userId) uniqueUsers.add(data.userId);
            });

            setStats({
                totalMessages: messagesSnap.size,
                activeUsers: uniqueUsers.size,
                flaggedCount: flaggedData.length,
                roomsCount: roomsData.length,
                supportGroupsCount: supportGroupsData.length,
                groupsCount: groupsData.length,
                meetingsCount: meetingsData.length
            });

        } catch (error) {
            console.error('Error loading community data:', error);
        } finally {
            setLoading(false);
        }
    };

    const loadMessages = async (roomId) => {
        if (messageListener) {
            messageListener();
        }

        const listener = db.collection('messages')
            .where('roomId', '==', roomId)
            .orderBy('createdAt', 'desc')
            .limit(50)
            .onSnapshot(async snapshot => {
                const messagesData = [];
                
                for (const doc of snapshot.docs) {
                    const messageData = { id: doc.id, ...doc.data() };
                    
                    if (messageData.userId) {
                        const userDoc = await db.collection('users').doc(messageData.userId).get();
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            messageData.userName = userData.displayName || userData.email;
                            messageData.userRole = userData.role;
                        }
                    }
                    
                    messagesData.push(messageData);
                }
                
                setMessages(messagesData);
            });

        setMessageListener(() => listener);
    };

    const handleSendMessage = async () => {
        if (!newMessage.trim()) return;

        try {
            await db.collection('messages').add({
                roomId: selectedRoom,
                userId: user.uid,
                content: newMessage,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                edited: false,
                flagged: false,
                resolved: false,
                fromAdmin: true
            });

            setNewMessage('');
        } catch (error) {
            console.error('Error sending message:', error);
            alert('Failed to send message');
        }
    };

    const handleDeleteMessage = async (messageId) => {
        if (confirm('Delete this message permanently?')) {
            try {
                await db.collection('messages').doc(messageId).delete();
                alert('Message deleted');
            } catch (error) {
                console.error('Error deleting message:', error);
                alert('Failed to delete message');
            }
        }
    };

    const handleFlagResolve = async (messageId, action) => {
        try {
            if (action === 'delete') {
                await db.collection('messages').doc(messageId).delete();
            } else if (action === 'unflag') {
                await db.collection('messages').doc(messageId).update({
                    flagged: false,
                    resolved: true,
                    resolvedBy: user.uid,
                    resolvedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            loadCommunityData();
        } catch (error) {
            console.error('Error resolving flag:', error);
            alert('Failed to resolve flag');
        }
    };

    const handleCreateRoom = async (roomData) => {
        try {
            await db.collection('topicRooms').add({
                ...roomData,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: user.uid,
                active: true,
                messageCount: 0
            });

            alert('Topic room created successfully!');
            setShowCreateRoom(false);
            loadCommunityData();
        } catch (error) {
            console.error('Error creating room:', error);
            alert('Failed to create room');
        }
    };

    const handleToggleRoom = async (roomId, currentStatus) => {
        try {
            await db.collection('topicRooms').doc(roomId).update({
                active: !currentStatus
            });
            loadCommunityData();
        } catch (error) {
            console.error('Error toggling room:', error);
            alert('Failed to update room status');
        }
    };

    const handleDeleteRoom = async (roomId) => {
        if (confirm('Delete this topic room? All messages will be preserved but the room will be removed.')) {
            try {
                await db.collection('topicRooms').doc(roomId).delete();
                alert('Room deleted');
                loadCommunityData();
            } catch (error) {
                console.error('Error deleting room:', error);
                alert('Failed to delete room');
            }
        }
    };

    const handleCreateSupportGroup = async (groupData) => {
        try {
            await db.collection('supportGroups').add({
                ...groupData,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: user.uid,
                active: true
            });
            alert('Support group created successfully!');
            setShowCreateModal(false);
            loadCommunityData();
        } catch (error) {
            console.error('Error creating support group:', error);
            alert('Failed to create support group');
        }
    };

    const handleCreateGroup = async (groupData) => {
        try {
            await db.collection('groups').add({
                ...groupData,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: user.uid,
                memberIds: [],
                active: true
            });
            alert('Group created successfully!');
            setShowCreateModal(false);
            loadCommunityData();
        } catch (error) {
            console.error('Error creating group:', error);
            alert('Failed to create group');
        }
    };

    const handleCreateMeeting = async (meetingData) => {
        try {
            await db.collection('meetings').add({
                ...meetingData,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                coachId: user.uid,
                status: 'scheduled'
            });
            alert('Meeting scheduled successfully!');
            setShowCreateModal(false);
            loadCommunityData();
        } catch (error) {
            console.error('Error creating meeting:', error);
            alert('Failed to schedule meeting');
        }
    };

    const renderChatTab = () => (
        <div className="chat-container">
            <div className="chat-sidebar">
                <h4>Chat Rooms</h4>
                <div 
                    className={`room-item ${selectedRoom === 'main' ? 'active' : ''}`}
                    onClick={() => setSelectedRoom('main')}
                >
                    <span className="room-icon">🏠</span>
                    <span className="room-name">GLRS Main Chat</span>
                </div>
                
                {topicRooms.filter(room => room.active).map(room => (
                    <div 
                        key={room.id}
                        className={`room-item ${selectedRoom === room.id ? 'active' : ''}`}
                        onClick={() => setSelectedRoom(room.id)}
                    >
                        <span className="room-icon">{room.icon || '💬'}</span>
                        <span className="room-name">{room.name}</span>
                    </div>
                ))}
            </div>

            <div className="chat-main">
                <div className="chat-header">
                    <h4>
                        {selectedRoom === 'main' ? 'GLRS Community Chat' : 
                         topicRooms.find(r => r.id === selectedRoom)?.name || 'Chat'}
                    </h4>
                    <span className="chat-info">
                        {messages.length} messages loaded
                    </span>
                </div>

                <div className="messages-container">
                    {messages.map(message => (
                        <div key={message.id} className={`message-item ${message.fromAdmin ? 'admin-message' : ''}`}>
                            <div className="message-header">
                                <span className="message-author">
                                    {message.userName || 'Unknown User'}
                                    {message.userRole === 'admin' && ' 🛡️'}
                                    {message.userRole === 'coach' && ' 👤'}
                                </span>
                                <span className="message-time">
                                    {formatTimeAgo(message.createdAt)}
                                </span>
                            </div>
                            <div className="message-content">
                                {message.content}
                                
                                {/* Image display for base64 images */}
                                {message.imageUrl && (
                                    <div className="message-image-container" style={{marginTop: '10px'}}>
                                        <img 
                                            src={message.imageUrl} 
                                            alt="Shared image"
                                            style={{
                                                maxWidth: '300px',
                                                maxHeight: '300px',
                                                borderRadius: '8px',
                                                cursor: 'pointer',
                                                display: 'block'
                                            }}
                                            onClick={() => setSelectedImage(message.imageUrl)}
                                        />
                                    </div>
                                )}
                            </div>
                            <div className="message-actions">
                                <button 
                                    className="action-btn btn-sm"
                                    onClick={() => handleDeleteMessage(message.id)}
                                >
                                    Delete
                                </button>
                                {message.flagged && (
                                    <span className="flag-indicator">🚩 Flagged</span>
                                )}
                            </div>
                        </div>
                    ))}
                    
                    {messages.length === 0 && (
                        <div className="empty-state">No messages in this room</div>
                    )}
                </div>

                <div className="chat-input-container">
                    <input
                        type="text"
                        className="chat-input"
                        placeholder="Type a message as admin..."
                        value={newMessage}
                        onChange={(e) => setNewMessage(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                    />
                    <button 
                        className="btn btn-primary"
                        onClick={handleSendMessage}
                    >
                        Send
                    </button>
                </div>
            </div>
        </div>
    );

    const renderRoomsTab = () => (
        <div className="rooms-management">
            <div className="rooms-header">
                <h3>Topic Rooms Management</h3>
                <button 
                    className="btn btn-primary"
                    onClick={() => setShowCreateRoom(true)}
                >
                    + Create Room
                </button>
            </div>

            <div className="rooms-grid">
                {topicRooms.map(room => (
                    <div key={room.id} className="room-card">
                        <div className="room-card-header">
                            <span className="room-icon-large">{room.icon || '💬'}</span>
                            <h4>{room.name}</h4>
                        </div>
                        
                        <div className="room-info">
                            <p>{room.description}</p>
                            <div className="room-meta">
                                <span>Created: {formatDate(room.createdAt)}</span>
                                <span>Messages: {room.messageCount || 0}</span>
                            </div>
                        </div>
                        
                        <div className="room-status">
                            <span className={`badge ${room.active ? 'badge-success' : 'badge-danger'}`}>
                                {room.active ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                        
                        <div className="room-actions">
                            <button 
                                className={`btn btn-sm ${room.active ? 'btn-warning' : 'btn-success'}`}
                                onClick={() => handleToggleRoom(room.id, room.active)}
                            >
                                {room.active ? 'Deactivate' : 'Activate'}
                            </button>
                            <button 
                                className="btn btn-sm btn-danger"
                                onClick={() => handleDeleteRoom(room.id)}
                            >
                                Delete
                            </button>
                        </div>
                    </div>
                ))}
            </div>

            {topicRooms.length === 0 && (
                <div className="empty-state">
                    No topic rooms created yet. Create one to get started!
                </div>
            )}

            {showCreateRoom && (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <div className="modal-header">
                            <h3>Create Topic Room</h3>
                            <button className="close-btn" onClick={() => setShowCreateRoom(false)}>×</button>
                        </div>
                        <CreateRoomForm 
                            onSubmit={handleCreateRoom}
                            onCancel={() => setShowCreateRoom(false)}
                        />
                    </div>
                </div>
            )}
        </div>
    );

    const renderSupportGroupsTab = () => (
        <div className="support-groups-container">
            <div className="support-groups-header">
                <h3>Support Groups</h3>
                <button 
                    className="btn btn-primary"
                    onClick={() => {
                        setModalType('supportGroup');
                        setSelectedItem(null);
                        setShowCreateModal(true);
                    }}
                >
                    + Add Support Group
                </button>
            </div>

            <div className="support-groups-grid">
                {supportGroups.map(group => (
                    <div key={group.id} className="support-group-card">
                        <div className="group-header">
                            <h4>{group.name}</h4>
                            <span className={`badge badge-${group.type === 'AA' ? 'primary' : 
                                group.type === 'NA' ? 'warning' : 
                                group.type === 'SMART' ? 'success' : 'secondary'}`}>
                                {group.type}
                            </span>
                        </div>
                        <div className="group-details">
                            <span>📅 {group.day}</span>
                            <span>🕐 {group.time}</span>
                            {group.link && (
                                <a href={group.link} target="_blank" rel="noopener noreferrer">
                                    🔗 Join Meeting
                                </a>
                            )}
                        </div>
                        <div className="group-actions">
                            <button 
                                className={`btn btn-sm ${group.active ? 'btn-success' : 'btn-secondary'}`}
                                onClick={async () => {
                                    await db.collection('supportGroups').doc(group.id).update({
                                        active: !group.active
                                    });
                                    loadCommunityData();
                                }}
                            >
                                {group.active ? 'Active' : 'Inactive'}
                            </button>
                            <button 
                                className="btn btn-sm btn-danger"
                                onClick={async () => {
                                    if (confirm('Delete this support group?')) {
                                        await db.collection('supportGroups').doc(group.id).delete();
                                        loadCommunityData();
                                    }
                                }}
                            >
                                Delete
                            </button>
                        </div>
                    </div>
                ))}
            </div>

            {supportGroups.length === 0 && (
                <div className="empty-state">
                    No support groups created. Add support groups for PIRs to join.
                </div>
            )}
        </div>
    );

   

    const renderMeetingsTab = () => (
    <div className="meetings-container">
        <div className="meetings-header">
            <h3>Group Meetings</h3>
            <button 
                className="btn btn-primary"
                onClick={() => {
                    setModalType('meeting');
                    setSelectedItem(null);
                    setShowCreateModal(true);
                }}
            >
                + Schedule Group Meeting
            </button>
        </div>

        <div className="meetings-list">
            {meetings.map(meeting => (
                <div key={meeting.id} className="meeting-card">
                    <div className="meeting-header">
                        <h4>{meeting.meetingTitle || 'Group Recovery Session'}</h4>
                        <span className={`badge badge-${
                            meeting.status === 'completed' ? 'success' :
                            meeting.status === 'scheduled' ? 'primary' :
                            meeting.status === 'cancelled' ? 'danger' : 'secondary'
                        }`}>
                            {meeting.status}
                        </span>
                    </div>
                    
                    <div className="meeting-participants">
                        {meeting.isGlobal ? (
                            <div className="participant-badge">
                                🌍 All PIRs Invited
                            </div>
                        ) : meeting.pirNames && meeting.pirNames.length > 0 ? (
                            <div>
                                <strong>Participants ({meeting.pirNames.length}):</strong>
                                <div className="participant-list">
                                    {meeting.pirNames.slice(0, 3).map((name, idx) => (
                                        <span key={idx} className="participant-name">{name}</span>
                                    ))}
                                    {meeting.pirNames.length > 3 && (
                                        <span className="participant-more">
                                            +{meeting.pirNames.length - 3} more
                                        </span>
                                    )}
                                </div>
                            </div>
                        ) : (
                            <div className="participant-badge">
                                No PIRs assigned
                            </div>
                        )}
                    </div>

                    <div className="meeting-details">
                        <span>📅 {formatDate(meeting.scheduledTime)}</span>
                        <span>🕐 {new Date(meeting.scheduledTime?.toDate ? meeting.scheduledTime.toDate() : meeting.scheduledTime).toLocaleTimeString()}</span>
                        <span>📝 {meeting.type || 'Group Session'}</span>
                        {meeting.meetingLink && (
                            <a href={meeting.meetingLink} target="_blank" rel="noopener noreferrer">
                                🔗 Join Meeting
                            </a>
                        )}
                    </div>
                    
                    {meeting.notes && (
                        <p className="meeting-notes">{meeting.notes}</p>
                    )}
                    
                    <div className="meeting-actions">
                        <button 
                            className="btn btn-sm btn-info"
                            onClick={() => {
                                setSelectedItem(meeting);
                                setModalType('meeting');
                                setShowCreateModal(true);
                            }}
                        >
                            Edit
                        </button>
                        <button 
                            className="btn btn-sm btn-success"
                            onClick={async () => {
                                await db.collection('meetings').doc(meeting.id).update({
                                    status: 'completed',
                                    completedAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                loadCommunityData();
                            }}
                            disabled={meeting.status === 'completed'}
                        >
                            Mark Complete
                        </button>
                        <button 
                            className="btn btn-sm btn-warning"
                            onClick={async () => {
                                if (confirm('Cancel this meeting?')) {
                                    await db.collection('meetings').doc(meeting.id).update({
                                        status: 'cancelled'
                                    });
                                    loadCommunityData();
                                }
                            }}
                            disabled={meeting.status === 'cancelled'}
                        >
                            Cancel
                        </button>
                        <button 
                            className="btn btn-sm btn-danger"
                            onClick={async () => {
                                if (confirm('Delete this meeting permanently?')) {
                                    await db.collection('meetings').doc(meeting.id).delete();
                                    loadCommunityData();
                                }
                            }}
                        >
                            Delete
                        </button>
                    </div>
                </div>
            ))}
        </div>

        {meetings.length === 0 && (
            <div className="empty-state">
                No group meetings scheduled. Schedule group meetings for PIRs.
            </div>
        )}
    </div>
);
    const renderModerationTab = () => (
        <div className="moderation-container">
            <h3>Flagged Messages ({flaggedMessages.length})</h3>
            
            {flaggedMessages.length > 0 ? (
                <div className="flagged-list">
                    {flaggedMessages.map(message => (
                        <div key={message.id} className="flagged-item">
                            <div className="flagged-header">
                                <span className="flagged-user">{message.userName || 'Unknown User'}</span>
                                <span className="flagged-time">{formatTimeAgo(message.flaggedAt)}</span>
                            </div>
                            <div className="flagged-content">
                                {message.content}
                                {message.imageUrl && (
                                    <img 
                                        src={message.imageUrl} 
                                        alt="Flagged content"
                                        style={{
                                            maxWidth: '200px',
                                            marginTop: '10px',
                                            borderRadius: '4px'
                                        }}
                                    />
                                )}
                            </div>
                            <div className="flagged-reason">
                                Reason: {message.flagReason || 'No reason provided'}
                            </div>
                            <div className="flagged-actions">
                                <button 
                                    className="btn btn-sm btn-danger"
                                    onClick={() => handleFlagResolve(message.id, 'delete')}
                                >
                                    Delete Message
                                </button>
                                <button 
                                    className="btn btn-sm btn-warning"
                                    onClick={() => handleFlagResolve(message.id, 'unflag')}
                                >
                                    Unflag & Keep
                                </button>
                            </div>
                        </div>
                    ))}
                </div>
            ) : (
                <div className="empty-state">
                    No flagged messages. Community is clean! 🎉
                </div>
            )}

            <div className="moderation-stats">
                <h4>Community Statistics</h4>
                <div className="stats-grid">
                    <div className="stat-card">
                        <div className="stat-value">{stats.totalMessages}</div>
                        <div className="stat-label">Recent Messages</div>
                    </div>
                    <div className="stat-card">
                        <div className="stat-value">{stats.activeUsers}</div>
                        <div className="stat-label">Active Users</div>
                    </div>
                    <div className="stat-card">
                        <div className="stat-value">{stats.roomsCount}</div>
                        <div className="stat-label">Topic Rooms</div>
                    </div>
                    <div className="stat-card">
                        <div className="stat-value">{stats.supportGroupsCount}</div>
                        <div className="stat-label">Support Groups</div>
                    </div>
                </div>
            </div>
        </div>
    );

    if (loading) {
        return (
            <div className="loading-container">
                <div className="loading-spinner"></div>
            </div>
        );
    }

    return (
        <div className="community-view">
            <div className="tab-nav">
                <button 
                    className={`tab-btn ${activeTab === 'chat' ? 'active' : ''}`}
                    onClick={() => setActiveTab('chat')}
                >
                    Community Chat
                </button>
                <button 
                    className={`tab-btn ${activeTab === 'rooms' ? 'active' : ''}`}
                    onClick={() => setActiveTab('rooms')}
                >
                    Topic Rooms ({topicRooms.length})
                </button>
                <button 
                    className={`tab-btn ${activeTab === 'supportGroups' ? 'active' : ''}`}
                    onClick={() => setActiveTab('supportGroups')}
                >
                    Support Groups ({supportGroups.length})
                </button>
                <button 
                    className={`tab-btn ${activeTab === 'meetings' ? 'active' : ''}`}
                    onClick={() => setActiveTab('meetings')}
                >
                    Meetings ({meetings.length})
                </button>
                <button 
                    className={`tab-btn ${activeTab === 'moderation' ? 'active' : ''}`}
                    onClick={() => setActiveTab('moderation')}
                >
                    Moderation {flaggedMessages.length > 0 && `(${flaggedMessages.length})`}
                </button>
            </div>

            {activeTab === 'chat' && renderChatTab()}
            {activeTab === 'rooms' && renderRoomsTab()}
            {activeTab === 'supportGroups' && renderSupportGroupsTab()}
            {activeTab === 'meetings' && renderMeetingsTab()}
            {activeTab === 'moderation' && renderModerationTab()}

            {/* Image Modal */}
            {selectedImage && (
                <div className="modal-overlay" onClick={() => setSelectedImage(null)} style={{
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                    cursor: 'pointer'
                }}>
                    <img 
                        src={selectedImage} 
                        alt="Full size"
                        style={{
                            maxWidth: '90vw',
                            maxHeight: '90vh',
                            objectFit: 'contain'
                        }}
                        onClick={(e) => e.stopPropagation()}
                    />
                    <button 
                        className="close-btn" 
                        onClick={() => setSelectedImage(null)}
                        style={{
                            position: 'absolute',
                            top: '20px',
                            right: '20px',
                            color: 'white',
                            fontSize: '30px',
                            background: 'none',
                            border: 'none',
                            cursor: 'pointer'
                        }}
                    >×</button>
                </div>
            )}

            {/* Create Modal for Support Groups/Groups/Meetings */}
            {showCreateModal && (
                <CommunityCreateModal
                    type={modalType}
                    item={selectedItem}
                    onSubmit={(data) => {
                        if (modalType === 'supportGroup') {
                            handleCreateSupportGroup(data);
                        } else if (modalType === 'group') {
                            handleCreateGroup(data);
                        } else if (modalType === 'meeting') {
                            handleCreateMeeting(data);
                        }
                    }}
                    onClose={() => {
                        setShowCreateModal(false);
                        setSelectedItem(null);
                    }}
                />
            )}
        </div>
    );
}

// Keep the existing CreateRoomForm component as is
function CreateRoomForm({ onSubmit, onCancel }) {
    const [formData, setFormData] = useState({
        name: '',
        description: '',
        icon: '💬',
        rules: ''
    });

    const icons = ['💬', '🎯', '💪', '🧘', '📖', '🌟', '❤️', '🙏', '🎨', '🎵'];

    const handleSubmit = (e) => {
        e.preventDefault();
        if (!formData.name || !formData.description) {
            alert('Please fill in all required fields');
            return;
        }
        onSubmit(formData);
    };

    return (
        <form onSubmit={handleSubmit} className="create-room-form">
            <div className="form-group">
                <label>Room Name *</label>
                <input
                    type="text"
                    value={formData.name}
                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                    placeholder="e.g., Daily Reflections"
                    required
                />
            </div>

            <div className="form-group">
                <label>Description *</label>
                <textarea
                    value={formData.description}
                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                    placeholder="What is this room about?"
                    rows="3"
                    required
                />
            </div>

            <div className="form-group">
                <label>Icon</label>
                <div className="icon-picker">
                    {icons.map(icon => (
                        <button
                            key={icon}
                            type="button"
                            className={`icon-option ${formData.icon === icon ? 'selected' : ''}`}
                            onClick={() => setFormData({...formData, icon})}
                        >
                            {icon}
                        </button>
                    ))}
                </div>
            </div>

            <div className="form-group">
                <label>Room Rules (optional)</label>
                <textarea
                    value={formData.rules}
                    onChange={(e) => setFormData({...formData, rules: e.target.value})}
                    placeholder="Any specific guidelines for this room?"
                    rows="2"
                />
            </div>

            <div className="form-actions">
                <button type="submit" className="btn btn-primary">Create Room</button>
                <button type="button" className="btn btn-secondary" onClick={onCancel}>Cancel</button>
            </div>
        </form>
    );
}
        // Community Create Modal - For Support Groups and Meetings
function CommunityCreateModal({ type, item, onSubmit, onClose }) {
    const [formData, setFormData] = useState(() => {
        if (item) {
            return {
                ...item,
                assignedPIRs: item.assignedPIRs || []
            };
        }
        
        if (type === 'supportGroup') {
            return {
                name: '',
                type: 'AA',
                day: 'Monday',
                time: '',
                link: '',
                location: '',
                description: '',
                active: true
            };
        } else if (type === 'meeting') {
            return {
                meetingTitle: '',
                scheduledTime: '',
                type: 'Group Session',
                meetingLink: '',
                duration: '60',
                isGlobal: false,
                assignedPIRs: [],
                notes: '',
                sendReminder: true,
                status: 'scheduled'
            };
        }
    });

    const [allPIRs, setAllPIRs] = useState([]);
    const [selectedPIRs, setSelectedPIRs] = useState(item?.assignedPIRs || []);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        loadPIRs();
    }, []);

    const loadPIRs = async () => {
        try {
            const pirsSnap = await db.collection('users')
                .where('role', '==', 'pir')
                .where('active', '!=', false)
                .get();
            
            const pirsData = [];
            pirsSnap.forEach(doc => {
                const data = doc.data();
                pirsData.push({
                    id: doc.id,
                    name: data.displayName || `${data.firstName} ${data.lastName}` || data.email,
                    email: data.email
                });
            });
            setAllPIRs(pirsData);
        } catch (error) {
            console.error('Error loading PIRs:', error);
        } finally {
            setLoading(false);
        }
    };

    const handleSubmit = (e) => {
        e.preventDefault();
        
        if (type === 'supportGroup') {
            if (!formData.name || !formData.day || !formData.time) {
                alert('Please fill in all required fields');
                return;
            }
            onSubmit(formData);
        } else if (type === 'meeting') {
            if (!formData.meetingTitle || !formData.scheduledTime) {
                alert('Please provide a meeting title and scheduled time');
                return;
            }
            
            // Convert datetime-local to Firebase timestamp
            const scheduledDate = new Date(formData.scheduledTime);
            
            const finalData = {
                ...formData,
                scheduledTime: firebase.firestore.Timestamp.fromDate(scheduledDate),
                assignedPIRs: formData.isGlobal ? [] : selectedPIRs
            };
            
            onSubmit(finalData);
        }
    };

    const handlePIRSelection = (pirId) => {
        if (selectedPIRs.includes(pirId)) {
            setSelectedPIRs(selectedPIRs.filter(id => id !== pirId));
        } else {
            setSelectedPIRs([...selectedPIRs, pirId]);
        }
    };

    const selectAllPIRs = () => {
        setSelectedPIRs(allPIRs.map(pir => pir.id));
    };

    const clearSelection = () => {
        setSelectedPIRs([]);
    };

    // Get current datetime for min attribute (can't schedule in the past)
    const getCurrentDateTime = () => {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        return now.toISOString().slice(0, 16);
    };

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{maxWidth: '700px', maxHeight: '90vh', overflowY: 'auto'}}>
                <div className="modal-header">
                    <h3>
                        {item ? 'Edit' : 'Create'} 
                        {type === 'supportGroup' ? ' Support Group' : ' Group Meeting'}
                    </h3>
                    <button className="close-btn" onClick={onClose}>×</button>
                </div>
                
                <form onSubmit={handleSubmit} className="modal-body">
                    {type === 'supportGroup' && (
                        <>
                            <div className="form-group">
                                <label>Group Name *</label>
                                <input
                                    type="text"
                                    value={formData.name}
                                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                                    placeholder="e.g., Wednesday Night NA Meeting"
                                    required
                                />
                            </div>
                            
                            <div className="form-row">
                                <div className="form-group">
                                    <label>Type *</label>
                                    <select
                                        value={formData.type}
                                        onChange={(e) => setFormData({...formData, type: e.target.value})}
                                    >
                                        <option value="AA">AA</option>
                                        <option value="NA">NA</option>
                                        <option value="Al-Anon">Al-Anon</option>
                                        <option value="SMART">SMART Recovery</option>
                                        <option value="Celebrate Recovery">Celebrate Recovery</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                
                                <div className="form-group">
                                    <label>Day *</label>
                                    <select
                                        value={formData.day}
                                        onChange={(e) => setFormData({...formData, day: e.target.value})}
                                    >
                                        <option value="Monday">Monday</option>
                                        <option value="Tuesday">Tuesday</option>
                                        <option value="Wednesday">Wednesday</option>
                                        <option value="Thursday">Thursday</option>
                                        <option value="Friday">Friday</option>
                                        <option value="Saturday">Saturday</option>
                                        <option value="Sunday">Sunday</option>
                                        <option value="Daily">Daily</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div className="form-group">
                                <label>Time *</label>
                                <input
                                    type="time"
                                    value={formData.time}
                                    onChange={(e) => setFormData({...formData, time: e.target.value})}
                                    required
                                />
                            </div>
                            
                            <div className="form-group">
                                <label>Meeting Link (for virtual meetings)</label>
                                <input
                                    type="url"
                                    value={formData.link}
                                    onChange={(e) => setFormData({...formData, link: e.target.value})}
                                    placeholder="https://zoom.us/j/..."
                                />
                            </div>
                            
                            <div className="form-group">
                                <label>Location (for in-person meetings)</label>
                                <input
                                    type="text"
                                    value={formData.location || ''}
                                    onChange={(e) => setFormData({...formData, location: e.target.value})}
                                    placeholder="e.g., Community Center, 123 Main St"
                                />
                            </div>
                            
                            <div className="form-group">
                                <label>Description</label>
                                <textarea
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                    placeholder="Additional details about this support group"
                                    rows="3"
                                />
                            </div>
                            
                            <div className="form-group">
                                <label style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                                    <input
                                        type="checkbox"
                                        checked={formData.active}
                                        onChange={(e) => setFormData({...formData, active: e.target.checked})}
                                    />
                                    <span>Support group is active</span>
                                </label>
                            </div>
                        </>
                    )}
                    
                    {type === 'meeting' && (
                        <>
                            <div className="form-group">
                                <label>Meeting Title *</label>
                                <input
                                    type="text"
                                    value={formData.meetingTitle}
                                    onChange={(e) => setFormData({...formData, meetingTitle: e.target.value})}
                                    placeholder="e.g., Weekly Progress Review"
                                    required
                                />
                            </div>
                            
                            <div className="form-row">
                                <div className="form-group">
                                    <label>Date & Time *</label>
                                    <input
                                        type="datetime-local"
                                        value={formData.scheduledTime}
                                        onChange={(e) => setFormData({...formData, scheduledTime: e.target.value})}
                                        min={getCurrentDateTime()}
                                        required
                                    />
                                </div>
                                
                                <div className="form-group">
                                    <label>Duration</label>
                                    <select
                                        value={formData.duration}
                                        onChange={(e) => setFormData({...formData, duration: e.target.value})}
                                    >
                                        <option value="30">30 minutes</option>
                                        <option value="60">60 minutes</option>
                                        <option value="90">90 minutes</option>
                                        <option value="120">2 hours</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div className="form-group">
                                <label>Meeting Type</label>
                                <select
                                    value={formData.type}
                                    onChange={(e) => setFormData({...formData, type: e.target.value})}
                                >
                                    <option value="Group Session">Group Session</option>
                                    <option value="Progress Review">Progress Review</option>
                                    <option value="Educational">Educational</option>
                                    <option value="Group Therapy">Group Therapy</option>
                                    <option value="Special Topic">Special Topic</option>
                                    <option value="Check-in">Check-in</option>
                                </select>
                            </div>
                            
                            <div className="form-group">
                                <label>Meeting Link (for virtual meetings)</label>
                                <input
                                    type="url"
                                    value={formData.meetingLink}
                                    onChange={(e) => setFormData({...formData, meetingLink: e.target.value})}
                                    placeholder="https://zoom.us/j/..."
                                />
                            </div>
                            
                            <div className="form-group">
                                <label style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                                    <input
                                        type="checkbox"
                                        checked={formData.isGlobal}
                                        onChange={(e) => setFormData({...formData, isGlobal: e.target.checked})}
                                    />
                                    <span>Invite all PIRs (Global Meeting)</span>
                                </label>
                            </div>
                            
                            {!formData.isGlobal && (
                                <div className="form-group">
                                    <label>Select PIRs to Invite</label>
                                    <div style={{marginBottom: '10px'}}>
                                        <button type="button" className="btn btn-sm" onClick={selectAllPIRs}>
                                            Select All
                                        </button>
                                        <button type="button" className="btn btn-sm" onClick={clearSelection} style={{marginLeft: '10px'}}>
                                            Clear All
                                        </button>
                                        <span style={{marginLeft: '10px'}}>
                                            {selectedPIRs.length} selected
                                        </span>
                                    </div>
                                    <div style={{
                                        maxHeight: '200px',
                                        overflowY: 'auto',
                                        border: '1px solid #ddd',
                                        borderRadius: '4px',
                                        padding: '10px'
                                    }}>
                                        {loading ? (
                                            <div style={{textAlign: 'center', padding: '20px'}}>
                                                Loading PIRs...
                                            </div>
                                        ) : allPIRs.length > 0 ? (
                                            allPIRs.map(pir => (
                                                <label key={pir.id} style={{
                                                    display: 'block',
                                                    padding: '5px',
                                                    cursor: 'pointer',
                                                    backgroundColor: selectedPIRs.includes(pir.id) ? '#e3f2fd' : 'transparent',
                                                    borderRadius: '4px',
                                                    marginBottom: '2px'
                                                }}>
                                                    <input
                                                        type="checkbox"
                                                        checked={selectedPIRs.includes(pir.id)}
                                                        onChange={() => handlePIRSelection(pir.id)}
                                                        style={{marginRight: '10px'}}
                                                    />
                                                    {pir.name} ({pir.email})
                                                </label>
                                            ))
                                        ) : (
                                            <div style={{color: '#999', textAlign: 'center'}}>
                                                No PIRs available
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                            
                            <div className="form-group">
                                <label>Meeting Notes</label>
                                <textarea
                                    value={formData.notes}
                                    onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                    placeholder="Topics to cover, preparation needed, etc."
                                    rows="3"
                                />
                            </div>
                            
                            <div className="form-group">
                                <label style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                                    <input
                                        type="checkbox"
                                        checked={formData.sendReminder}
                                        onChange={(e) => setFormData({...formData, sendReminder: e.target.checked})}
                                    />
                                    <span>Send reminder to participants</span>
                                </label>
                            </div>
                        </>
                    )}
                    
                    <div className="modal-footer">
                        <button type="submit" className="btn btn-primary">
                            {item ? 'Update' : 'Create'}
                        </button>
                        <button type="button" className="btn btn-secondary" onClick={onClose}>
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
}
     // PIR-Centric Goals & Objectives Management View with Enhanced UI - FIXED VERSION
function GoalsView({ searchQuery, user }) {
    const [selectedPIR, setSelectedPIR] = useState(null);
    const [pirs, setPirs] = useState([]);
    const [loading, setLoading] = useState(true);
    const [expandedGoals, setExpandedGoals] = useState(new Set());
    const [expandedObjectives, setExpandedObjectives] = useState(new Set());
    const [showCreateModal, setShowCreateModal] = useState(false);
    const [modalType, setModalType] = useState('');
    const [selectedParent, setSelectedParent] = useState(null);
    const [pirGoalsData, setPirGoalsData] = useState({
        goals: [],
        objectives: [],
        assignments: [],
        milestones: [],
        customMilestones: []
    });
    const [activeTab, setActiveTab] = useState('overview');

    useEffect(() => {
        loadPIRsWithStats();
    }, []);

    useEffect(() => {
        if (selectedPIR) {
            loadPIRGoalsData(selectedPIR.id);
        }
    }, [selectedPIR]);

    const loadPIRsWithStats = async () => {
        try {
            setLoading(true);
            const pirsSnap = await db.collection('users')
                .where('role', '==', 'pir')
                .where('active', '!=', false)
                .get();
            
            const pirsData = [];
            
            for (const doc of pirsSnap.docs) {
                const pirData = { id: doc.id, ...doc.data() };
                
                // Get ALL goals (both active and completed) for stats
                const goalsSnap = await db.collection('goals')
                    .where('userId', '==', doc.id)
                    .get();
                
                let totalProgress = 0;
                let overdueCount = 0;
                let nearCompletion = 0;
                let activeGoalsCount = 0;
                let completedGoalsCount = 0;
                
                for (const goalDoc of goalsSnap.docs) {
                    const goalData = goalDoc.data();
                    if (goalData.status === 'active') activeGoalsCount++;
                    if (goalData.status === 'completed') completedGoalsCount++;
                    
                    // Get assignments for this goal
                    const assignmentsSnap = await db.collection('assignments')
                        .where('goalId', '==', goalDoc.id)
                        .get();
                    
                    let completed = 0;
                    let total = assignmentsSnap.size;
                    
                    assignmentsSnap.forEach(assignDoc => {
                        const assignment = assignDoc.data();
                        if (assignment.status === 'completed') completed++;
                        if (assignment.dueDate && new Date(assignment.dueDate.toDate()) < new Date() && assignment.status !== 'completed') {
                            overdueCount++;
                        }
                    });
                    
                    const goalProgress = total > 0 ? (completed / total) * 100 : 0;
                    totalProgress += goalProgress;
                    if (goalProgress >= 80 && goalData.status === 'active') nearCompletion++;
                }
                
                pirData.activeGoals = activeGoalsCount;
                pirData.completedGoals = completedGoalsCount;
                pirData.totalGoals = goalsSnap.size;
                pirData.overallProgress = goalsSnap.size > 0 ? Math.round(totalProgress / goalsSnap.size) : 0;
                pirData.overdueAssignments = overdueCount;
                pirData.nearCompletion = nearCompletion;
                
                pirsData.push(pirData);
            }
            
            setPirs(pirsData);
        } catch (error) {
            console.error('Error loading PIRs:', error);
        } finally {
            setLoading(false);
        }
    };

    const loadPIRGoalsData = async (pirId) => {
        try {
            setLoading(true);
            
            // Get ALL goals, not just active ones
            const goalsSnap = await db.collection('goals')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .get();

            const goalsData = [];
            const objectivesData = [];
            const assignmentsData = [];

            for (const goalDoc of goalsSnap.docs) {
                const goalData = { id: goalDoc.id, ...goalDoc.data() };
                
                // Get ALL objectives for this goal
                const objectivesSnap = await db.collection('objectives')
                    .where('goalId', '==', goalDoc.id)
                    .orderBy('order', 'asc')
                    .get();
                
                let goalAssignments = 0;
                let completedAssignments = 0;
                
                for (const objDoc of objectivesSnap.docs) {
                    const objData = { id: objDoc.id, ...objDoc.data() };
                    objectivesData.push(objData);
                    
                    // Get ALL assignments for this objective
                    const assignmentsSnap = await db.collection('assignments')
                        .where('objectiveId', '==', objDoc.id)
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    assignmentsSnap.forEach(assignDoc => {
                        const assignData = { id: assignDoc.id, ...assignDoc.data() };
                        assignmentsData.push(assignData);
                        goalAssignments++;
                        if (assignData.status === 'completed') completedAssignments++;
                    });
                }
                
                goalData.progress = goalAssignments > 0 
                    ? Math.round((completedAssignments / goalAssignments) * 100)
                    : 0;
                
                goalsData.push(goalData);
            }

            const recoveryMilestones = getRecoveryMilestones(selectedPIR.sobrietyDate);
            
            const customMilestonesSnap = await db.collection('milestones')
                .where('userId', '==', pirId)
                .where('type', '==', 'custom')
                .orderBy('targetDate', 'asc')
                .get();
            
            const customMilestonesData = [];
            customMilestonesSnap.forEach(doc => {
                customMilestonesData.push({ id: doc.id, ...doc.data() });
            });

            setPirGoalsData({
                goals: goalsData,
                objectives: objectivesData,
                assignments: assignmentsData,
                milestones: recoveryMilestones,
                customMilestones: customMilestonesData
            });

        } catch (error) {
            console.error('Error loading PIR goals:', error);
        } finally {
            setLoading(false);
        }
    };

    const getRecoveryMilestones = (sobrietyDate) => {
        if (!sobrietyDate) return [];
        
        const milestoneDefinitions = [
            { days: 1, title: '24 Hours', icon: '🌟' },
            { days: 7, title: 'One Week', icon: '📅' },
            { days: 30, title: 'One Month', icon: '🗓️' },
            { days: 60, title: 'Two Months', icon: '📆' },
            { days: 90, title: 'Three Months', icon: '🏆' },
            { days: 120, title: 'Four Months', icon: '💪' },
            { days: 150, title: 'Five Months', icon: '⭐' },
            { days: 180, title: 'Six Months', icon: '🎯' },
            { days: 270, title: 'Nine Months', icon: '🌈' },
            { days: 365, title: 'One Year', icon: '🎉' },
            { days: 548, title: '18 Months', icon: '🌟' },
            { days: 730, title: 'Two Years', icon: '👑' },
            { days: 1095, title: 'Three Years', icon: '💎' },
            { days: 1825, title: 'Five Years', icon: '🏅' },
            { days: 3650, title: 'Ten Years', icon: '🔥' }
        ];

        const sobrietyDateObj = new Date(sobrietyDate);
        const today = new Date();
        const daysSober = Math.floor((today - sobrietyDateObj) / (1000 * 60 * 60 * 24));

        return milestoneDefinitions.map(milestone => ({
            ...milestone,
            achieved: daysSober >= milestone.days,
            achievedDate: daysSober >= milestone.days 
                ? new Date(sobrietyDateObj.getTime() + milestone.days * 24 * 60 * 60 * 1000)
                : null,
            targetDate: new Date(sobrietyDateObj.getTime() + milestone.days * 24 * 60 * 60 * 1000),
            type: 'recovery'
        }));
    };

    const toggleGoalExpand = (goalId) => {
        const newExpanded = new Set(expandedGoals);
        if (newExpanded.has(goalId)) {
            newExpanded.delete(goalId);
        } else {
            newExpanded.add(goalId);
        }
        setExpandedGoals(newExpanded);
    };

    const toggleObjectiveExpand = (objId) => {
        const newExpanded = new Set(expandedObjectives);
        if (newExpanded.has(objId)) {
            newExpanded.delete(objId);
        } else {
            newExpanded.add(objId);
        }
        setExpandedObjectives(newExpanded);
    };

    const handleCompleteGoal = async (goalId) => {
        if (!confirm('Mark this goal as complete? Only coaches can complete goals.')) return;
        
        try {
            await db.collection('goals').doc(goalId).update({
                status: 'completed',
                completedBy: user.uid,
                completedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            loadPIRGoalsData(selectedPIR.id);
        } catch (error) {
            console.error('Error completing goal:', error);
        }
    };

    const handleCompleteObjective = async (objectiveId) => {
        if (!confirm('Mark this objective as complete? Only coaches can complete objectives.')) return;
        
        try {
            await db.collection('objectives').doc(objectiveId).update({
                status: 'completed',
                completedBy: user.uid,
                completedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            loadPIRGoalsData(selectedPIR.id);
        } catch (error) {
            console.error('Error completing objective:', error);
        }
    };

    const handleCreateGoal = async (goalData) => {
        try {
            await db.collection('goals').add({
                userId: selectedPIR.id,
                title: goalData.title,
                description: goalData.description,
                dueDate: goalData.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(goalData.dueDate)) : null,
                status: 'active',
                createdBy: user.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            alert('Goal created successfully!');
            setShowCreateModal(false);
            loadPIRGoalsData(selectedPIR.id);
        } catch (error) {
            console.error('Error creating goal:', error);
            alert('Failed to create goal');
        }
    };

    const handleCreateObjective = async (objectiveData) => {
        try {
            const objectivesSnap = await db.collection('objectives')
                .where('goalId', '==', objectiveData.goalId)
                .get();
            
            await db.collection('objectives').add({
                goalId: objectiveData.goalId,
                userId: selectedPIR.id,
                title: objectiveData.title,
                order: objectivesSnap.size + 1,
                dueDate: objectiveData.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(objectiveData.dueDate)) : null,
                status: 'active',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            alert('Objective created successfully!');
            setShowCreateModal(false);
            loadPIRGoalsData(selectedPIR.id);
        } catch (error) {
            console.error('Error creating objective:', error);
            alert('Failed to create objective');
        }
    };

    const handleCreateAssignment = async (assignmentData) => {
        try {
            await db.collection('assignments').add({
                goalId: assignmentData.goalId,
                objectiveId: assignmentData.objectiveId,
                userId: selectedPIR.id,  // CHANGED FROM pirId to userId
                pirName: selectedPIR.displayName || selectedPIR.email,
                coachId: user.uid,
                coachName: user.displayName || user.email,
                title: assignmentData.title,
                description: assignmentData.description,
                dueDate: assignmentData.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(assignmentData.dueDate)) : null,
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Send notification to PIR
            await db.collection('notifications').add({
                userId: selectedPIR.id,
                type: 'assignment_created',
                title: 'New Assignment',
                message: `You have a new assignment: ${assignmentData.title}`,
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            alert('Assignment created successfully!');
            setShowCreateModal(false);
            loadPIRGoalsData(selectedPIR.id);
        } catch (error) {
            console.error('Error creating assignment:', error);
            alert('Failed to create assignment');
        }
    };

    const handleCreateMilestone = async (milestoneData) => {
        try {
            await db.collection('milestones').add({
                userId: selectedPIR.id,
                title: milestoneData.title,
                description: milestoneData.description,
                targetDate: firebase.firestore.Timestamp.fromDate(new Date(milestoneData.targetDate)),
                type: 'custom',
                achieved: false,
                icon: milestoneData.icon || '🎯',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            alert('Milestone created successfully!');
            setShowCreateModal(false);
            loadPIRGoalsData(selectedPIR.id);
        } catch (error) {
            console.error('Error creating milestone:', error);
            alert('Failed to create milestone');
        }
    };

    const PIRCard = ({ pir, onClick }) => (
        <div 
            className="pir-card-enhanced"
            onClick={onClick}
            style={{
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                borderRadius: '12px',
                padding: '20px',
                marginBottom: '15px',
                cursor: 'pointer',
                transition: 'transform 0.2s, box-shadow 0.2s',
                color: 'white',
                boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
            }}
            onMouseEnter={(e) => {
                e.currentTarget.style.transform = 'translateY(-2px)';
                e.currentTarget.style.boxShadow = '0 6px 12px rgba(0,0,0,0.15)';
            }}
            onMouseLeave={(e) => {
                e.currentTarget.style.transform = 'translateY(0)';
                e.currentTarget.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
            }}
        >
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start' }}>
                <div>
                    <h3 style={{ margin: '0 0 10px 0', fontSize: '1.4em' }}>
                        👤 {pir.displayName || `${pir.firstName} ${pir.lastName}` || pir.email}
                    </h3>
                    <div style={{ display: 'flex', gap: '20px', fontSize: '0.95em', opacity: '0.95' }}>
                        <span>📊 {pir.activeGoals || 0} Active</span>
                        <span>✅ {pir.completedGoals || 0} Complete</span>
                        <span>📈 {pir.overallProgress || 0}% Progress</span>
                    </div>
                </div>
                <div style={{ 
                    background: 'rgba(255,255,255,0.2)', 
                    borderRadius: '20px', 
                    padding: '8px 16px',
                    fontSize: '2em',
                    fontWeight: 'bold'
                }}>
                    {pir.overallProgress || 0}%
                </div>
            </div>
            
            {(pir.overdueAssignments > 0 || pir.nearCompletion > 0) && (
                <div style={{ 
                    marginTop: '15px', 
                    paddingTop: '15px', 
                    borderTop: '1px solid rgba(255,255,255,0.2)'
                }}>
                    {pir.overdueAssignments > 0 && (
                        <span style={{ 
                            background: 'rgba(255,100,100,0.3)', 
                            padding: '4px 12px', 
                            borderRadius: '15px',
                            marginRight: '10px',
                            fontSize: '0.9em'
                        }}>
                            ⚠️ {pir.overdueAssignments} Overdue
                        </span>
                    )}
                    {pir.nearCompletion > 0 && (
                        <span style={{ 
                            background: 'rgba(100,255,100,0.3)', 
                            padding: '4px 12px', 
                            borderRadius: '15px',
                            fontSize: '0.9em'
                        }}>
                            🎯 {pir.nearCompletion} Near Completion
                        </span>
                    )}
                </div>
            )}
        </div>
    );

    const ActionButton = ({ icon, label, onClick, variant = 'primary' }) => {
        const colors = {
            primary: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            success: 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)',
            warning: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
            info: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)'
        };

        return (
            <button
                onClick={onClick}
                style={{
                    background: colors[variant],
                    border: 'none',
                    borderRadius: '8px',
                    color: 'white',
                    padding: '10px 20px',
                    fontSize: '0.95em',
                    fontWeight: '500',
                    cursor: 'pointer',
                    transition: 'transform 0.2s',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.05)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
            >
                <span style={{ fontSize: '1.2em' }}>{icon}</span>
                {label}
            </button>
        );
    };

    const GoalItem = ({ goal }) => {
        const isExpanded = expandedGoals.has(goal.id);
        const objectives = pirGoalsData.objectives.filter(obj => obj.goalId === goal.id);
        const isCompleted = goal.status === 'completed';
        
        return (
            <div style={{
                background: isCompleted ? '#f0f8ff' : 'white',
                borderRadius: '10px',
                padding: '20px',
                marginBottom: '15px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                transition: 'all 0.3s',
                opacity: isCompleted ? 0.9 : 1
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <div 
                        onClick={() => toggleGoalExpand(goal.id)}
                        style={{ cursor: 'pointer', flex: 1 }}
                    >
                        <h4 style={{ margin: 0, color: '#333', display: 'flex', alignItems: 'center', gap: '10px' }}>
                            <span>{isExpanded ? '▼' : '▶'}</span>
                            {goal.title}
                            <span style={{
                                background: isCompleted ? '#4CAF50' : `linear-gradient(90deg, #667eea ${goal.progress}%, #e0e0e0 ${goal.progress}%)`,
                                padding: '2px 10px',
                                borderRadius: '12px',
                                fontSize: '0.8em',
                                color: 'white'
                            }}>
                                {isCompleted ? 'Completed' : `${goal.progress}%`}
                            </span>
                        </h4>
                        <div style={{ marginTop: '5px', fontSize: '0.9em', color: '#666' }}>
                            Created: {formatDate(goal.createdAt)} 
                            {goal.dueDate && ` • Due: ${formatDate(goal.dueDate)}`}
                            {goal.completedAt && ` • Completed: ${formatDate(goal.completedAt)}`}
                        </div>
                        {goal.description && (
                            <div style={{ marginTop: '8px', fontSize: '0.9em', color: '#555' }}>
                                {goal.description}
                            </div>
                        )}
                    </div>
                    <div style={{ display: 'flex', gap: '10px' }}>
                        {!isCompleted && (
                            <>
                                <button
                                    onClick={() => {
                                        setSelectedParent({ type: 'goal', id: goal.id, title: goal.title });
                                        setModalType('objective');
                                        setShowCreateModal(true);
                                    }}
                                    style={{
                                        background: '#4CAF50',
                                        border: 'none',
                                        borderRadius: '6px',
                                        color: 'white',
                                        padding: '6px 12px',
                                        cursor: 'pointer',
                                        fontSize: '0.85em'
                                    }}
                                >
                                    + Objective
                                </button>
                                <button
                                    onClick={() => handleCompleteGoal(goal.id)}
                                    style={{
                                        background: '#2196F3',
                                        border: 'none',
                                        borderRadius: '6px',
                                        color: 'white',
                                        padding: '6px 12px',
                                        cursor: 'pointer',
                                        fontSize: '0.85em'
                                    }}
                                >
                                    Complete
                                </button>
                            </>
                        )}
                    </div>
                </div>
                
                {isExpanded && (
                    <div style={{ marginTop: '20px', paddingLeft: '30px' }}>
                        {objectives.map(objective => (
                            <ObjectiveItem key={objective.id} objective={objective} goal={goal} />
                        ))}
                        {objectives.length === 0 && (
                            <p style={{ color: '#999', fontSize: '0.9em' }}>No objectives yet</p>
                        )}
                    </div>
                )}
            </div>
        );
    };

    const ObjectiveItem = ({ objective, goal }) => {
        const isExpanded = expandedObjectives.has(objective.id);
        const assignments = pirGoalsData.assignments.filter(a => a.objectiveId === objective.id);
        const isCompleted = objective.status === 'completed';
        
        return (
            <div style={{
                background: isCompleted ? '#f5fff5' : '#f8f9fa',
                borderLeft: `3px solid ${isCompleted ? '#4CAF50' : '#667eea'}`,
                padding: '15px',
                marginBottom: '10px',
                borderRadius: '6px',
                opacity: isCompleted ? 0.9 : 1
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <div 
                        onClick={() => toggleObjectiveExpand(objective.id)}
                        style={{ cursor: 'pointer', flex: 1 }}
                    >
                        <h5 style={{ margin: 0, color: '#555', display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <span>{isExpanded ? '▼' : '▶'}</span>
                            {objective.title}
                            <span style={{
                                background: isCompleted ? '#4CAF50' : '#FFA726',
                                padding: '2px 8px',
                                borderRadius: '10px',
                                fontSize: '0.75em',
                                color: 'white'
                            }}>
                                {isCompleted ? 'completed' : 'active'}
                            </span>
                        </h5>
                        <div style={{ marginTop: '5px', fontSize: '0.85em', color: '#777' }}>
                            {objective.dueDate && `Due: ${formatDate(objective.dueDate)}`}
                            {objective.completedAt && ` • Completed: ${formatDate(objective.completedAt)}`}
                        </div>
                    </div>
                    <div style={{ display: 'flex', gap: '10px' }}>
                        {!isCompleted && (
                            <>
                                <button
                                    onClick={() => {
                                        setSelectedParent({
                                            type: 'objective',
                                            id: objective.id,
                                            goalId: goal.id,
                                            title: `${goal.title} > ${objective.title}`
                                        });
                                        setModalType('assignment');
                                        setShowCreateModal(true);
                                    }}
                                    style={{
                                        background: '#9C27B0',
                                        border: 'none',
                                        borderRadius: '6px',
                                        color: 'white',
                                        padding: '5px 10px',
                                        cursor: 'pointer',
                                        fontSize: '0.8em'
                                    }}
                                >
                                    + Assignment
                                </button>
                                <button
                                    onClick={() => handleCompleteObjective(objective.id)}
                                    style={{
                                        background: '#FF9800',
                                        border: 'none',
                                        borderRadius: '6px',
                                        color: 'white',
                                        padding: '5px 10px',
                                        cursor: 'pointer',
                                        fontSize: '0.8em'
                                    }}
                                >
                                    Complete
                                </button>
                            </>
                        )}
                    </div>
                </div>
                
                {isExpanded && (
                    <div style={{ marginTop: '15px', paddingLeft: '20px' }}>
                        {assignments.map(assignment => (
                            <AssignmentItem key={assignment.id} assignment={assignment} />
                        ))}
                        {assignments.length === 0 && (
                            <p style={{ color: '#999', fontSize: '0.9em' }}>No assignments yet</p>
                        )}
                    </div>
                )}
            </div>
        );
    };

    const AssignmentItem = ({ assignment }) => {
        const isCompleted = assignment.status === 'completed';
        
        return (
            <div style={{
                background: isCompleted ? '#f0fff0' : 'white',
                border: `1px solid ${isCompleted ? '#c8e6c9' : '#e0e0e0'}`,
                padding: '12px',
                marginBottom: '8px',
                borderRadius: '4px',
                display: 'flex',
                alignItems: 'flex-start',
                gap: '10px'
            }}>
                <span style={{ fontSize: '1.2em', marginTop: '2px' }}>
                    {isCompleted ? '✅' : '⏳'}
                </span>
                <div style={{ flex: 1 }}>
                    <div style={{ fontWeight: '500', color: '#333' }}>
                        {assignment.title}
                    </div>
                    {assignment.description && (
                        <div style={{ fontSize: '0.85em', color: '#666', marginTop: '4px' }}>
                            {assignment.description}
                        </div>
                    )}
                    {assignment.reflection && (
                        <div style={{
                            background: '#e3f2fd',
                            padding: '8px',
                            borderRadius: '4px',
                            marginTop: '8px',
                            fontSize: '0.85em',
                            borderLeft: '3px solid #2196F3'
                        }}>
                            <strong style={{ color: '#1565C0' }}>PIR Reflection:</strong>
                            <div style={{ marginTop: '4px', color: '#424242' }}>
                                {assignment.reflection}
                            </div>
                        </div>
                    )}
                    <div style={{ fontSize: '0.8em', color: '#999', marginTop: '6px' }}>
                        {assignment.createdAt && `Created: ${formatDate(assignment.createdAt)}`}
                        {assignment.dueDate && ` • Due: ${formatDate(assignment.dueDate)}`}
                        {assignment.completedAt && ` • Completed: ${formatDate(assignment.completedAt)}`}
                    </div>
                </div>
            </div>
        );
    };

    // Rest of component remains the same...
    if (loading) {
        return (
            <div style={{ 
                display: 'flex', 
                justifyContent: 'center', 
                alignItems: 'center', 
                height: '400px' 
            }}>
                <div className="loading-spinner"></div>
            </div>
        );
    }

    if (selectedPIR) {
        return (
            <div style={{ padding: '20px' }}>
                <div style={{ 
                    display: 'flex', 
                    justifyContent: 'space-between', 
                    alignItems: 'center',
                    marginBottom: '30px',
                    background: 'white',
                    padding: '20px',
                    borderRadius: '10px',
                    boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                }}>
                    <div>
                        <button
                            onClick={() => setSelectedPIR(null)}
                            style={{
                                background: 'none',
                                border: 'none',
                                color: '#667eea',
                                cursor: 'pointer',
                                fontSize: '1em',
                                marginBottom: '10px',
                                padding: 0
                            }}
                        >
                            ← Back to PIR List
                        </button>
                        <h2 style={{ margin: 0, color: '#333' }}>
                            {selectedPIR.displayName || selectedPIR.email}'s Recovery Plan
                        </h2>
                        <div style={{ 
                            marginTop: '10px',
                            fontSize: '1.2em',
                            color: '#666'
                        }}>
                            Overall Progress: {Math.round(pirGoalsData.goals.reduce((acc, g) => acc + g.progress, 0) / (pirGoalsData.goals.length || 1))}%
                        </div>
                    </div>
                    
                    <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                        <ActionButton 
                            icon="🧵" 
                            label="Golden Thread" 
                            variant="primary"
                            onClick={() => {
                                setModalType('goldenThread');
                                setShowCreateModal(true);
                            }}
                        />
                        <ActionButton 
                            icon="🎯" 
                            label="Add Goal" 
                            variant="success"
                            onClick={() => {
                                setModalType('goal');
                                setShowCreateModal(true);
                            }}
                        />
                        <ActionButton 
                            icon="⭐" 
                            label="Add Milestone" 
                            variant="warning"
                            onClick={() => {
                                setModalType('milestone');
                                setShowCreateModal(true);
                            }}
                        />
                    </div>
                </div>

                <div style={{ marginTop: '20px' }}>
                    {pirGoalsData.goals.map(goal => (
                        <GoalItem key={goal.id} goal={goal} />
                    ))}
                    
                    {pirGoalsData.goals.length === 0 && (
                        <div style={{
                            background: 'white',
                            borderRadius: '10px',
                            padding: '40px',
                            textAlign: 'center',
                            color: '#999'
                        }}>
                            <h3>No goals assigned yet</h3>
                            <p>Start with a Golden Thread to create a structured recovery plan</p>
                        </div>
                    )}
                </div>

                {/* MODAL RENDERING */}
                {showCreateModal && (
                    <CreateGoalModal
                        type={modalType}
                        selectedPIR={selectedPIR}
                        selectedParent={selectedParent}
                        onSubmit={(data) => {
                            if (modalType === 'goldenThread') {
                                // Golden thread handles its own submit
                                return;
                            } else if (modalType === 'goal') {
                                handleCreateGoal(data);
                            } else if (modalType === 'objective') {
                                handleCreateObjective(data);
                            } else if (modalType === 'assignment') {
                                handleCreateAssignment(data);
                            } else if (modalType === 'milestone') {
                                handleCreateMilestone(data);
                            }
                        }}
                        onClose={() => {
                            setShowCreateModal(false);
                            setSelectedParent(null);
                        }}
                    />
                )}
            </div>
        );
    }

    return (
        <div style={{ padding: '20px' }}>
            <h2 style={{ marginBottom: '30px', color: '#333' }}>PIR Goals Management</h2>
            <div>
                {pirs.map(pir => (
                    <PIRCard 
                        key={pir.id} 
                        pir={pir} 
                        onClick={() => setSelectedPIR(pir)}
                    />
                ))}
                
                {pirs.length === 0 && (
                    <div style={{
                        background: 'white',
                        borderRadius: '10px',
                        padding: '40px',
                        textAlign: 'center',
                        color: '#999'
                    }}>
                        <h3>No active PIRs found</h3>
                        <p>PIRs will appear here once they are added to the system</p>
                    </div>
                )}
            </div>

            {/* MODAL RENDERING FOR MAIN VIEW */}
            {showCreateModal && (
                <CreateGoalModal
                    type={modalType}
                    selectedPIR={selectedPIR}
                    selectedParent={selectedParent}
                    onSubmit={(data) => {
                        if (modalType === 'goldenThread') {
                            // Golden thread handles its own submit
                            return;
                        } else if (modalType === 'goal') {
                            handleCreateGoal(data);
                        } else if (modalType === 'objective') {
                            handleCreateObjective(data);
                        } else if (modalType === 'assignment') {
                            handleCreateAssignment(data);
                        } else if (modalType === 'milestone') {
                            handleCreateMilestone(data);
                        }
                    }}
                    onClose={() => {
                        setShowCreateModal(false);
                        setSelectedParent(null);
                    }}
                />
            )}
        </div>
    );
}

// Enhanced Golden Thread Modal with FIXED userId field
function CreateGoalModal({ type, selectedPIR, selectedParent, onSubmit, onClose }) {
    const [goldenThreadData, setGoldenThreadData] = useState({
        goals: [
            {
                title: '',
                description: '',
                dueDate: '',
                objectives: [
                    { title: '', dueDate: '', assignments: [{ title: '', description: '', dueDate: '' }] },
                    { title: '', dueDate: '', assignments: [{ title: '', description: '', dueDate: '' }] }
                ]
            },
            {
                title: '',
                description: '',
                dueDate: '',
                objectives: [
                    { title: '', dueDate: '', assignments: [{ title: '', description: '', dueDate: '' }] },
                    { title: '', dueDate: '', assignments: [{ title: '', description: '', dueDate: '' }] }
                ]
            }
        ]
    });

    const [singleFormData, setSingleFormData] = useState({
        title: '',
        description: '',
        dueDate: '',
        targetDate: '',
        icon: '🎯',
        goalId: selectedParent?.goalId || '',
        objectiveId: selectedParent?.id || ''
    });

    const addGoal = () => {
        setGoldenThreadData({
            ...goldenThreadData,
            goals: [...goldenThreadData.goals, {
                title: '',
                description: '',
                dueDate: '',
                objectives: [
                    { title: '', dueDate: '', assignments: [{ title: '', description: '', dueDate: '' }] }
                ]
            }]
        });
    };

    const addObjective = (goalIndex) => {
        const newGoals = [...goldenThreadData.goals];
        newGoals[goalIndex].objectives.push({
            title: '',
            dueDate: '',
            assignments: [{ title: '', description: '', dueDate: '' }]
        });
        setGoldenThreadData({ ...goldenThreadData, goals: newGoals });
    };

    const addAssignment = (goalIndex, objIndex) => {
        const newGoals = [...goldenThreadData.goals];
        newGoals[goalIndex].objectives[objIndex].assignments.push({
            title: '',
            description: '',
            dueDate: ''
        });
        setGoldenThreadData({ ...goldenThreadData, goals: newGoals });
    };

    const updateGoal = (index, field, value) => {
        const newGoals = [...goldenThreadData.goals];
        newGoals[index][field] = value;
        setGoldenThreadData({ ...goldenThreadData, goals: newGoals });
    };

    const updateObjective = (goalIndex, objIndex, field, value) => {
        const newGoals = [...goldenThreadData.goals];
        newGoals[goalIndex].objectives[objIndex][field] = value;
        setGoldenThreadData({ ...goldenThreadData, goals: newGoals });
    };

    const updateAssignment = (goalIndex, objIndex, assignIndex, field, value) => {
        const newGoals = [...goldenThreadData.goals];
        newGoals[goalIndex].objectives[objIndex].assignments[assignIndex][field] = value;
        setGoldenThreadData({ ...goldenThreadData, goals: newGoals });
    };

    const handleGoldenThreadSubmit = async () => {
        try {
            for (const goal of goldenThreadData.goals) {
                if (!goal.title) continue;
                
                const goalRef = await db.collection('goals').add({
                    userId: selectedPIR.id,
                    title: goal.title,
                    description: goal.description,
                    dueDate: goal.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(goal.dueDate)) : null,
                    status: 'active',
                    createdBy: auth.currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                for (let i = 0; i < goal.objectives.length; i++) {
                    const objective = goal.objectives[i];
                    if (!objective.title) continue;
                    
                    const objectiveRef = await db.collection('objectives').add({
                        goalId: goalRef.id,
                        userId: selectedPIR.id,
                        title: objective.title,
                        order: i + 1,
                        dueDate: objective.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(objective.dueDate)) : null,
                        status: 'active',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    for (const assignment of objective.assignments) {
                        if (!assignment.title) continue;
                        
                        await db.collection('assignments').add({
                            goalId: goalRef.id,
                            objectiveId: objectiveRef.id,
                            userId: selectedPIR.id,  // CHANGED FROM pirId to userId
                            pirName: selectedPIR.displayName || selectedPIR.email,
                            coachId: auth.currentUser.uid,
                            coachName: auth.currentUser.displayName || auth.currentUser.email,
                            title: assignment.title,
                            description: assignment.description,
                            dueDate: assignment.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(assignment.dueDate)) : null,
                            status: 'pending',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }
            }

            alert('Golden Thread created successfully!');
            onClose();
            window.location.reload(); // Reload to show new data
        } catch (error) {
            console.error('Error creating golden thread:', error);
            alert('Failed to create golden thread');
        }
    };

    if (type === 'goldenThread') {
        return (
            <div className="modal-overlay" style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0,0,0,0.5)',
                display: 'flex',
                justifyContent: 'center',
                alignItems: 'center',
                zIndex: 1000,
                overflow: 'auto'
            }}>
                <div style={{
                    background: 'white',
                    borderRadius: '12px',
                    width: '90%',
                    maxWidth: '900px',
                    maxHeight: '90vh',
                    overflow: 'auto',
                    padding: '30px'
                }}>
                    <div style={{ 
                        display: 'flex', 
                        justifyContent: 'space-between', 
                        alignItems: 'center',
                        marginBottom: '20px'
                    }}>
                        <h2 style={{ margin: 0 }}>Create Golden Thread</h2>
                        <button 
                            onClick={onClose}
                            style={{
                                background: 'none',
                                border: 'none',
                                fontSize: '24px',
                                cursor: 'pointer'
                            }}
                        >
                            ×
                        </button>
                    </div>

                    {goldenThreadData.goals.map((goal, goalIndex) => (
                        <div key={goalIndex} style={{
                            background: '#f8f9fa',
                            borderRadius: '8px',
                            padding: '20px',
                            marginBottom: '20px'
                        }}>
                            <h3 style={{ color: '#667eea', marginTop: 0 }}>Goal {goalIndex + 1}</h3>
                            <input
                                type="text"
                                placeholder="Goal Title"
                                value={goal.title}
                                onChange={(e) => updateGoal(goalIndex, 'title', e.target.value)}
                                style={{
                                    width: '100%',
                                    padding: '10px',
                                    marginBottom: '10px',
                                    border: '1px solid #ddd',
                                    borderRadius: '6px'
                                }}
                            />
                            <textarea
                                placeholder="Goal Description"
                                value={goal.description}
                                onChange={(e) => updateGoal(goalIndex, 'description', e.target.value)}
                                style={{
                                    width: '100%',
                                    padding: '10px',
                                    marginBottom: '10px',
                                    border: '1px solid #ddd',
                                    borderRadius: '6px',
                                    minHeight: '60px'
                                }}
                            />
                            <input
                                type="date"
                                value={goal.dueDate}
                                onChange={(e) => updateGoal(goalIndex, 'dueDate', e.target.value)}
                                style={{
                                    padding: '10px',
                                    marginBottom: '20px',
                                    border: '1px solid #ddd',
                                    borderRadius: '6px'
                                }}
                            />

                            {goal.objectives.map((objective, objIndex) => (
                                <div key={objIndex} style={{
                                    background: 'white',
                                    borderLeft: '3px solid #667eea',
                                    padding: '15px',
                                    marginLeft: '20px',
                                    marginBottom: '15px',
                                    borderRadius: '4px'
                                }}>
                                    <h4 style={{ color: '#555', marginTop: 0 }}>Objective {objIndex + 1}</h4>
                                    <input
                                        type="text"
                                        placeholder="Objective Title"
                                        value={objective.title}
                                        onChange={(e) => updateObjective(goalIndex, objIndex, 'title', e.target.value)}
                                        style={{
                                            width: '100%',
                                            padding: '8px',
                                            marginBottom: '8px',
                                            border: '1px solid #ddd',
                                            borderRadius: '4px'
                                        }}
                                    />
                                    <input
                                        type="date"
                                        value={objective.dueDate}
                                        onChange={(e) => updateObjective(goalIndex, objIndex, 'dueDate', e.target.value)}
                                        style={{
                                            padding: '8px',
                                            marginBottom: '15px',
                                            border: '1px solid #ddd',
                                            borderRadius: '4px'
                                        }}
                                    />

                                    {objective.assignments.map((assignment, assignIndex) => (
                                        <div key={assignIndex} style={{
                                            background: '#f8f9fa',
                                            padding: '10px',
                                            marginLeft: '20px',
                                            marginBottom: '8px',
                                            borderRadius: '4px'
                                        }}>
                                            <div style={{ color: '#777', fontSize: '0.9em', marginBottom: '5px' }}>
                                                Assignment {assignIndex + 1}
                                            </div>
                                            <input
                                                type="text"
                                                placeholder="Assignment Title"
                                                value={assignment.title}
                                                onChange={(e) => updateAssignment(goalIndex, objIndex, assignIndex, 'title', e.target.value)}
                                                style={{
                                                    width: '100%',
                                                    padding: '6px',
                                                    marginBottom: '6px',
                                                    border: '1px solid #ddd',
                                                    borderRadius: '4px'
                                                }}
                                            />
                                            <input
                                                type="text"
                                                placeholder="Assignment Description"
                                                value={assignment.description}
                                                onChange={(e) => updateAssignment(goalIndex, objIndex, assignIndex, 'description', e.target.value)}
                                                style={{
                                                    width: '100%',
                                                    padding: '6px',
                                                    marginBottom: '6px',
                                                    border: '1px solid #ddd',
                                                    borderRadius: '4px'
                                                }}
                                            />
                                            <input
                                                type="date"
                                                value={assignment.dueDate}
                                                onChange={(e) => updateAssignment(goalIndex, objIndex, assignIndex, 'dueDate', e.target.value)}
                                                style={{
                                                    padding: '6px',
                                                    border: '1px solid #ddd',
                                                    borderRadius: '4px'
                                                }}
                                            />
                                        </div>
                                    ))}
                                    
                                    <button
                                        onClick={() => addAssignment(goalIndex, objIndex)}
                                        style={{
                                            marginLeft: '20px',
                                            marginTop: '5px',
                                            background: '#9C27B0',
                                            border: 'none',
                                            borderRadius: '4px',
                                            color: 'white',
                                            padding: '6px 12px',
                                            cursor: 'pointer',
                                            fontSize: '0.85em'
                                        }}
                                    >
                                        + Add Assignment
                                    </button>
                                </div>
                            ))}
                            
                            <button
                                onClick={() => addObjective(goalIndex)}
                                style={{
                                    marginLeft: '20px',
                                    background: '#4CAF50',
                                    border: 'none',
                                    borderRadius: '4px',
                                    color: 'white',
                                    padding: '8px 16px',
                                    cursor: 'pointer'
                                }}
                            >
                                + Add Objective
                            </button>
                        </div>
                    ))}
                    
                    <button
                        onClick={addGoal}
                        style={{
                            background: '#2196F3',
                            border: 'none',
                            borderRadius: '6px',
                            color: 'white',
                            padding: '10px 20px',
                            cursor: 'pointer',
                            marginBottom: '20px'
                        }}
                    >
                        + Add Another Goal
                    </button>
                    
                    <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                        <button
                            onClick={onClose}
                            style={{
                                background: '#e0e0e0',
                                border: 'none',
                                borderRadius: '6px',
                                padding: '12px 24px',
                                cursor: 'pointer'
                            }}
                        >
                            Cancel
                        </button>
                        <button
                            onClick={handleGoldenThreadSubmit}
                            style={{
                                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                border: 'none',
                                borderRadius: '6px',
                                color: 'white',
                                padding: '12px 24px',
                                cursor: 'pointer',
                                fontWeight: 'bold'
                            }}
                        >
                            Create Golden Thread
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // Regular single item creation forms
    return (
        <div className="modal-overlay" style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0,0,0,0.5)',
            display: 'flex',
            justifyContent: 'center',
            alignItems: 'center',
            zIndex: 1000
        }}>
            <div style={{
                background: 'white',
                borderRadius: '12px',
                width: '90%',
                maxWidth: '500px',
                padding: '30px'
            }}>
                <div style={{ 
                    display: 'flex', 
                    justifyContent: 'space-between', 
                    alignItems: 'center',
                    marginBottom: '20px'
                }}>
                    <h2 style={{ margin: 0 }}>
                        {type === 'goal' && 'Add New Goal'}
                        {type === 'objective' && `Add Objective to: ${selectedParent?.title}`}
                        {type === 'assignment' && `Add Assignment to: ${selectedParent?.title}`}
                        {type === 'milestone' && 'Add Custom Milestone'}
                    </h2>
                    <button 
                        onClick={onClose}
                        style={{
                            background: 'none',
                            border: 'none',
                            fontSize: '24px',
                            cursor: 'pointer'
                        }}
                    >
                        ×
                    </button>
                </div>

                <form onSubmit={(e) => {
                    e.preventDefault();
                    onSubmit({...singleFormData, ...selectedParent});
                }}>
                    <input
                        type="text"
                        placeholder="Title"
                        value={singleFormData.title}
                        onChange={(e) => setSingleFormData({...singleFormData, title: e.target.value})}
                        required
                        style={{
                            width: '100%',
                            padding: '10px',
                            marginBottom: '15px',
                            border: '1px solid #ddd',
                            borderRadius: '6px'
                        }}
                    />
                    
                    {(type === 'goal' || type === 'assignment' || type === 'milestone') && (
                        <textarea
                            placeholder="Description"
                            value={singleFormData.description}
                            onChange={(e) => setSingleFormData({...singleFormData, description: e.target.value})}
                            style={{
                                width: '100%',
                                padding: '10px',
                                marginBottom: '15px',
                                border: '1px solid #ddd',
                                borderRadius: '6px',
                                minHeight: '80px'
                            }}
                        />
                    )}
                    
                    <input
                        type="date"
                        value={singleFormData.dueDate || singleFormData.targetDate}
                        onChange={(e) => setSingleFormData({
                            ...singleFormData, 
                            dueDate: e.target.value,
                            targetDate: e.target.value
                        })}
                        style={{
                            width: '100%',
                            padding: '10px',
                            marginBottom: '15px',
                            border: '1px solid #ddd',
                            borderRadius: '6px'
                        }}
                    />
                    
                    <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                        <button
                            type="button"
                            onClick={onClose}
                            style={{
                                background: '#e0e0e0',
                                border: 'none',
                                borderRadius: '6px',
                                padding: '10px 20px',
                                cursor: 'pointer'
                            }}
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            style={{
                                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                border: 'none',
                                borderRadius: '6px',
                                color: 'white',
                                padding: '10px 20px',
                                cursor: 'pointer',
                                fontWeight: 'bold'
                            }}
                        >
                            Create
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
}
        // Profile View
        function ProfileView({ user }) {
            const [editing, setEditing] = useState(false);
            const [profileData, setProfileData] = useState({
                displayName: user.displayName || '',
                firstName: user.firstName || '',
                lastName: user.lastName || '',
                phone: user.phone || '',
                email: user.email
            });
            const [saving, setSaving] = useState(false);
            const [passwordData, setPasswordData] = useState({
                currentPassword: '',
                newPassword: '',
                confirmPassword: ''
            });

            const handleSaveProfile = async () => {
                setSaving(true);
                try {
                    await db.collection('users').doc(user.uid).update({
                        displayName: `${profileData.firstName} ${profileData.lastName}`,
                        firstName: profileData.firstName,
                        lastName: profileData.lastName,
                        phone: profileData.phone,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    alert('Profile updated successfully!');
                    setEditing(false);
                    // Refresh page to update user context
                    setTimeout(() => window.location.reload(), 500);
                } catch (error) {
                    console.error('Error updating profile:', error);
                    alert('Failed to update profile');
                } finally {
                    setSaving(false);
                }
            };

            const handleChangePassword = async () => {
                if (passwordData.newPassword !== passwordData.confirmPassword) {
                    alert('New passwords do not match');
                    return;
                }
                
                if (passwordData.newPassword.length < 6) {
                    alert('Password must be at least 6 characters');
                    return;
                }
                
                setSaving(true);
                try {
                    // Re-authenticate user
                    const credential = firebase.auth.EmailAuthProvider.credential(
                        user.email,
                        passwordData.currentPassword
                    );
                    
                    await auth.currentUser.reauthenticateWithCredential(credential);
                    await auth.currentUser.updatePassword(passwordData.newPassword);
                    
                    alert('Password changed successfully!');
                    setPasswordData({
                        currentPassword: '',
                        newPassword: '',
                        confirmPassword: ''
                    });
                } catch (error) {
                    console.error('Error changing password:', error);
                    alert('Failed to change password: ' + error.message);
                } finally {
                    setSaving(false);
                }
            };

            return (
                <div>
                    <div className="table-container">
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                            <h3>Profile Information</h3>
                            <button 
                                className={`btn ${editing ? 'btn-success' : 'btn-primary'}`}
                                onClick={() => editing ? handleSaveProfile() : setEditing(true)}
                                disabled={saving}
                            >
                                {saving ? 'Saving...' : editing ? 'Save Changes' : 'Edit Profile'}
                            </button>
                        </div>
                        
                        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px'}}>
                            <div className="form-group">
                                <label className="form-label">First Name</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    value={profileData.firstName}
                                    onChange={(e) => setProfileData({...profileData, firstName: e.target.value})}
                                    disabled={!editing}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Last Name</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    value={profileData.lastName}
                                    onChange={(e) => setProfileData({...profileData, lastName: e.target.value})}
                                    disabled={!editing}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Email</label>
                                <input
                                    type="email"
                                    className="form-input"
                                    value={profileData.email}
                                    disabled
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Phone</label>
                                <input
                                    type="tel"
                                    className="form-input"
                                    value={profileData.phone}
                                    onChange={(e) => setProfileData({...profileData, phone: e.target.value})}
                                    disabled={!editing}
                                />
                            </div>
                        </div>
                        
                        {editing && (
                            <button 
                                className="btn btn-secondary"
                                onClick={() => {
                                    setEditing(false);
                                    setProfileData({
                                        displayName: user.displayName || '',
                                        firstName: user.firstName || '',
                                        lastName: user.lastName || '',
                                        phone: user.phone || '',
                                        email: user.email
                                    });
                                }}
                            >
                                Cancel
                            </button>
                        )}
                    </div>
                    
                    <div className="table-container" style={{marginTop: '30px'}}>
                        <h3 style={{marginBottom: '20px'}}>Change Password</h3>
                        
                        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '20px'}}>
                            <div className="form-group">
                                <label className="form-label">Current Password</label>
                                <input
                                    type="password"
                                    className="form-input"
                                    value={passwordData.currentPassword}
                                    onChange={(e) => setPasswordData({...passwordData, currentPassword: e.target.value})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">New Password</label>
                                <input
                                    type="password"
                                    className="form-input"
                                    value={passwordData.newPassword}
                                    onChange={(e) => setPasswordData({...passwordData, newPassword: e.target.value})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Confirm New Password</label>
                                <input
                                    type="password"
                                    className="form-input"
                                    value={passwordData.confirmPassword}
                                    onChange={(e) => setPasswordData({...passwordData, confirmPassword: e.target.value})}
                                />
                            </div>
                        </div>
                        
                        <button 
                            className="btn btn-primary"
                            onClick={handleChangePassword}
                            disabled={saving || !passwordData.currentPassword || !passwordData.newPassword}
                        >
                            {saving ? 'Changing...' : 'Change Password'}
                        </button>
                    </div>
                    
                    <div className="table-container" style={{marginTop: '30px'}}>
                        <h3 style={{marginBottom: '20px'}}>Account Information</h3>
                        <table>
                            <tbody>
                                <tr>
                                    <td><strong>User ID:</strong></td>
                                    <td>{user.uid}</td>
                                </tr>
                                <tr>
                                    <td><strong>Role:</strong></td>
                                    <td><span className="badge badge-info">Administrator</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Account Created:</strong></td>
                                    <td>{formatDate(user.createdAt)}</td>
                                </tr>
                                <tr>
                                    <td><strong>Last Updated:</strong></td>
                                    <td>{formatDate(user.updatedAt)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

    

        // Groups View
        function GroupsView({ user, searchQuery }) {
            const [groups, setGroups] = useState([]);
            const [filteredGroups, setFilteredGroups] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showCreateModal, setShowCreateModal] = useState(false);
            const [selectedGroup, setSelectedGroup] = useState(null);
            const [viewMode, setViewMode] = useState('all');
            
            const daysOfWeek = ['All', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

            useEffect(() => {
                loadGroups();
            }, []);

            useEffect(() => {
                filterGroups();
            }, [groups, viewMode, searchQuery]);

            const loadGroups = async () => {
                try {
                    const groupsSnap = await db.collection('groups')
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    const groupsData = [];
                    
                    for (const doc of groupsSnap.docs) {
                        const groupData = { id: doc.id, ...doc.data() };
                        
                        // Get member details if they exist
                        if (groupData.members && groupData.members.length > 0) {
                            const memberResults = await batchQuery('users',
                                firebase.firestore.FieldPath.documentId(),
                                groupData.members
                            );
                            
                            groupData.membersData = memberResults.map(member => ({
                                id: member.id,
                                name: member.displayName || member.email
                            }));
                        } else {
                            groupData.membersData = [];
                        }
                        
                        groupsData.push(groupData);
                    }
                    
                    setGroups(groupsData);
                    setFilteredGroups(groupsData);
                } catch (error) {
                    console.error('Error loading groups:', error);
                } finally {
                    setLoading(false);
                }
            };

            const filterGroups = () => {
                let filtered = groups;
                
                if (viewMode !== 'all') {
                    filtered = filtered.filter(group => 
                        group.dayOfWeek?.toLowerCase() === viewMode.toLowerCase()
                    );
                }
                
                if (searchQuery) {
                    const query = searchQuery.toLowerCase();
                    filtered = filtered.filter(group =>
                        group.name?.toLowerCase().includes(query) ||
                        group.description?.toLowerCase().includes(query)
                    );
                }
                
                setFilteredGroups(filtered);
            };

            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="loading-spinner"></div>
                    </div>
                );
            }

            return (
                <div>
                    <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '20px'}}>
                        <div className="tab-nav">
                            {daysOfWeek.map(day => (
                                <button
                                    key={day}
                                    className={`tab-btn ${viewMode === day.toLowerCase() ? 'active' : ''}`}
                                    onClick={() => setViewMode(day.toLowerCase())}
                                >
                                    {day}
                                </button>
                            ))}
                        </div>
                        
                        <button className="btn btn-primary" onClick={() => setShowCreateModal(true)}>
                            + Create Group
                        </button>
                    </div>
                    
                    {filteredGroups.length === 0 ? (
                        <div className="empty-state">
                            <div className="empty-state-icon">👫</div>
                            <div className="empty-state-text">
                                {viewMode === 'all' ? 'No groups yet' : `No groups on ${viewMode}`}
                            </div>
                        </div>
                    ) : (
                        filteredGroups.map(group => (
                            <div key={group.id} className="group-card">
                                <div className="group-header">
                                    <div>
                                        <div className="group-title">{group.name}</div>
                                        <div style={{fontSize: '14px', opacity: 0.7, marginTop: '5px'}}>
                                            {group.dayOfWeek} at {group.time} • {group.recurring ? 'Recurring' : 'One-time'}
                                        </div>
                                    </div>
                                    <button 
                                        className="btn btn-secondary"
                                        onClick={() => setSelectedGroup(group)}
                                    >
                                        View Details
                                    </button>
                                </div>
                                
                                <p style={{margin: '15px 0', opacity: 0.9}}>
                                    {group.description}
                                </p>
                                
                                {group.link && (
                                    <a 
                                        href={group.link}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        style={{color: '#f4c430', textDecoration: 'none', marginBottom: '15px', display: 'inline-block'}}
                                    >
                                        🔗 Meeting Link
                                    </a>
                                )}
                                
                                <div style={{marginTop: '15px'}}>
                                    <div style={{fontSize: '14px', marginBottom: '10px', opacity: 0.7}}>
                                        Members ({group.membersData?.length || 0})
                                    </div>
                                    <div className="group-members">
                                        {group.membersData?.slice(0, 10).map(member => (
                                            <div key={member.id} className="member-avatar" title={member.name}>
                                                {member.name.charAt(0).toUpperCase()}
                                            </div>
                                        ))}
                                        {group.membersData?.length > 10 && (
                                            <div className="member-avatar">+{group.membersData.length - 10}</div>
                                        )}
                                        {(!group.membersData || group.membersData.length === 0) && (
                                            <span style={{opacity: 0.5}}>No members yet</span>
                                        )}
                                    </div>
                                </div>
                            </div>
                        ))
                    )}
                    
                    {showCreateModal && (
                        <CreateGroupModal 
                            onClose={() => setShowCreateModal(false)}
                            onSuccess={() => {
                                setShowCreateModal(false);
                                loadGroups();
                            }}
                            adminId={user.uid}
                        />
                    )}
                    
                    {selectedGroup && (
                        <GroupDetailModal 
                            group={selectedGroup}
                            onClose={() => setSelectedGroup(null)}
                            onUpdate={() => loadGroups()}
                        />
                    )}
                </div>
            );
        }

       // Modern Enhanced Resources Management View - Resources Only
function ResourcesView({ user, searchQuery }) {
    const [loading, setLoading] = useState(true);
    const [resources, setResources] = useState([]);
    const [filteredItems, setFilteredItems] = useState([]);
    const [showCreateModal, setShowCreateModal] = useState(false);
    const [selectedItem, setSelectedItem] = useState(null);
    const [filterCategory, setFilterCategory] = useState('all');
    const [allPIRs, setAllPIRs] = useState([]);
    const [stats, setStats] = useState({
        activeResources: 0,
        pirAssignments: 0,
        completionRate: 0,
        engagementScore: 0,
        categoryBreakdown: {}
    });
    const [topResources, setTopResources] = useState([]);

    useEffect(() => {
        loadResourcesData();
        loadPIRs();
    }, []);

    useEffect(() => {
        filterItems();
    }, [searchQuery, resources, filterCategory]);

    const loadPIRs = async () => {
        try {
            const pirsSnap = await db.collection('users')
                .where('role', '==', 'pir')
                .get();
            
            const pirsData = [];
            pirsSnap.forEach(doc => {
                const data = doc.data();
                pirsData.push({
                    id: doc.id,
                    name: data.displayName || `${data.firstName} ${data.lastName}` || data.email,
                    email: data.email
                });
            });
            setAllPIRs(pirsData);
        } catch (error) {
            console.error('Error loading PIRs:', error);
        }
    };

    const loadResourcesData = async () => {
        try {
            setLoading(true);

            // Load all resources
            const resourcesSnap = await db.collection('resources')
                .orderBy('addedAt', 'desc')
                .get();
            
            const resourcesData = [];
            let activeCount = 0;
            let assignedCount = 0;
            let totalViews = 0;
            let completedCount = 0;
            let totalAssigned = 0;
            const categoryCount = {
                coping: 0,
                relapse: 0,
                daily: 0,
                education: 0,
                support: 0,
                life: 0
            };
            const resourceViewCounts = [];
            
            for (const doc of resourcesSnap.docs) {
                const data = { id: doc.id, ...doc.data() };
                
                // Count active resources
                if (data.active) activeCount++;
                
                // Count PIR assignments
                if (data.assignedTo && data.assignedTo.length > 0) {
                    assignedCount += data.assignedTo.length;
                    totalAssigned++;
                }
                
                // Category breakdown
                if (data.category && categoryCount[data.category] !== undefined) {
                    categoryCount[data.category]++;
                }
                
                // Count views from subcollections
                try {
                    const viewsSnap = await db.collectionGroup('resourceViews')
                        .where('resourceId', '==', doc.id)
                        .get();
                    data.viewCount = viewsSnap.size;
                    totalViews += data.viewCount;
                    
                    resourceViewCounts.push({
                        id: doc.id,
                        title: data.title,
                        viewCount: data.viewCount,
                        category: data.category
                    });
                } catch (error) {
                    data.viewCount = 0;
                }
                
                // Count completions
                try {
                    const progressSnap = await db.collectionGroup('resourceProgress')
                        .where('resourceId', '==', doc.id)
                        .where('status', '==', 'completed')
                        .get();
                    data.completionCount = progressSnap.size;
                    completedCount += data.completionCount;
                } catch (error) {
                    data.completionCount = 0;
                }
                
                resourcesData.push(data);
            }
            
            // Sort for top resources
            const sortedByViews = resourceViewCounts.sort((a, b) => b.viewCount - a.viewCount);
            setTopResources(sortedByViews.slice(0, 5));
            
            // Calculate stats
            const completionRate = totalAssigned > 0 ? 
                Math.round((completedCount / assignedCount) * 100) : 0;
            
            const engagementScore = activeCount > 0 ? 
                Math.round((totalViews / activeCount) * 10) : 0;
            
            setStats({
                activeResources: activeCount,
                pirAssignments: assignedCount,
                completionRate: completionRate,
                engagementScore: Math.min(engagementScore, 100),
                categoryBreakdown: categoryCount
            });
            
            setResources(resourcesData);

        } catch (error) {
            console.error('Error loading resources:', error);
        } finally {
            setLoading(false);
        }
    };

    const filterItems = () => {
        let items = filterCategory === 'all' ? 
            resources : 
            resources.filter(r => r.category === filterCategory);

        if (searchQuery) {
            const query = searchQuery.toLowerCase();
            items = items.filter(item =>
                item.title?.toLowerCase().includes(query) ||
                item.description?.toLowerCase().includes(query)
            );
        }

        setFilteredItems(items);
    };

    const handleCreateResource = async (resourceData) => {
        try {
            await db.collection('resources').add({
                ...resourceData,
                addedAt: firebase.firestore.FieldValue.serverTimestamp(),
                addedBy: user.uid,
                active: true
            });

            alert('Resource created successfully!');
            setShowCreateModal(false);
            loadResourcesData();
        } catch (error) {
            console.error('Error creating resource:', error);
            alert('Failed to create resource');
        }
    };

    const handleToggleActive = async (itemId, currentStatus) => {
        try {
            await db.collection('resources').doc(itemId).update({
                active: !currentStatus
            });
            loadResourcesData();
        } catch (error) {
            console.error('Error updating status:', error);
        }
    };

    const handleDelete = async (itemId, itemName) => {
        if (confirm(`Delete "${itemName}"? This cannot be undone.`)) {
            try {
                await db.collection('resources').doc(itemId).delete();
                alert('Resource deleted successfully');
                loadResourcesData();
            } catch (error) {
                console.error('Error deleting resource:', error);
                alert('Failed to delete resource');
            }
        }
    };

    const handleEdit = (item) => {
        setSelectedItem(item);
        setShowCreateModal(true);
    };

    const formatDate = (date) => {
        if (!date) return 'N/A';
        const d = date?.toDate ? date.toDate() : new Date(date);
        return d.toLocaleDateString();
    };

    return (
        <div className="resources-view">
            {/* Modern Stats Section */}
            <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                gap: '20px',
                marginBottom: '30px'
            }}>
                <div style={{
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    borderRadius: '15px',
                    padding: '20px',
                    color: 'white',
                    boxShadow: '0 10px 30px rgba(0,0,0,0.2)',
                    transform: 'translateY(0)',
                    transition: 'transform 0.3s ease',
                    cursor: 'pointer'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}>
                    <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{stats.activeResources}</div>
                    <div style={{ fontSize: '14px', opacity: 0.9, marginTop: '5px' }}>Active Resources</div>
                    <div style={{ fontSize: '12px', opacity: 0.7, marginTop: '5px' }}>
                        Currently available
                    </div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    borderRadius: '15px',
                    padding: '20px',
                    color: 'white',
                    boxShadow: '0 10px 30px rgba(0,0,0,0.2)',
                    transform: 'translateY(0)',
                    transition: 'transform 0.3s ease',
                    cursor: 'pointer'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}>
                    <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{stats.pirAssignments}</div>
                    <div style={{ fontSize: '14px', opacity: 0.9, marginTop: '5px' }}>PIR Assignments</div>
                    <div style={{ fontSize: '12px', opacity: 0.7, marginTop: '5px' }}>
                        Total assigned
                    </div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    borderRadius: '15px',
                    padding: '20px',
                    color: 'white',
                    boxShadow: '0 10px 30px rgba(0,0,0,0.2)',
                    transform: 'translateY(0)',
                    transition: 'transform 0.3s ease',
                    cursor: 'pointer'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}>
                    <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{stats.completionRate}%</div>
                    <div style={{ fontSize: '14px', opacity: 0.9, marginTop: '5px' }}>Completion Rate</div>
                    <div style={{ fontSize: '12px', opacity: 0.7, marginTop: '5px' }}>
                        Resource effectiveness
                    </div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    borderRadius: '15px',
                    padding: '20px',
                    color: 'white',
                    boxShadow: '0 10px 30px rgba(0,0,0,0.2)',
                    transform: 'translateY(0)',
                    transition: 'transform 0.3s ease',
                    cursor: 'pointer'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}>
                    <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{stats.engagementScore}</div>
                    <div style={{ fontSize: '14px', opacity: 0.9, marginTop: '5px' }}>Engagement Score</div>
                    <div style={{ fontSize: '12px', opacity: 0.7, marginTop: '5px' }}>
                        Average views/resource
                    </div>
                </div>
            </div>

            {/* Category Distribution */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                marginBottom: '20px',
                boxShadow: '0 5px 15px rgba(0,0,0,0.1)'
            }}>
                <h4 style={{ marginBottom: '15px', color: '#333' }}>Category Distribution</h4>
                <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                    {Object.entries(stats.categoryBreakdown).map(([category, count]) => (
                        <div key={category} style={{
                            background: count > 0 ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#e0e0e0',
                            color: count > 0 ? 'white' : '#666',
                            padding: '8px 16px',
                            borderRadius: '20px',
                            fontSize: '14px',
                            fontWeight: '500'
                        }}>
                            {category}: {count}
                        </div>
                    ))}
                </div>
            </div>

            {/* Top Resources */}
            {topResources.length > 0 && (
                <div style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '20px',
                    marginBottom: '20px',
                    boxShadow: '0 5px 15px rgba(0,0,0,0.1)'
                }}>
                    <h4 style={{ marginBottom: '15px', color: '#333' }}>Most Viewed Resources</h4>
                    <div style={{ display: 'grid', gap: '10px' }}>
                        {topResources.map((resource, index) => (
                            <div key={resource.id} style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                padding: '10px',
                                background: '#f5f5f5',
                                borderRadius: '8px'
                            }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                    <span style={{
                                        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                        color: 'white',
                                        width: '25px',
                                        height: '25px',
                                        borderRadius: '50%',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        fontSize: '12px',
                                        fontWeight: 'bold'
                                    }}>
                                        {index + 1}
                                    </span>
                                    <span style={{ fontSize: '14px', color: '#333' }}>{resource.title}</span>
                                </div>
                                <span style={{
                                    background: '#667eea',
                                    color: 'white',
                                    padding: '2px 8px',
                                    borderRadius: '12px',
                                    fontSize: '12px'
                                }}>
                                    {resource.viewCount} views
                                </span>
                            </div>
                        ))}
                    </div>
                </div>
            )}

            {/* Resources Section */}
            <div className="resources-container">
                <div style={{
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    marginBottom: '20px'
                }}>
                    <h3 style={{ margin: 0, color: '#333' }}>Recovery Resources</h3>
                    <button 
                        onClick={() => {
                            setSelectedItem(null);
                            setShowCreateModal(true);
                        }}
                        style={{
                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            color: 'white',
                            border: 'none',
                            padding: '12px 24px',
                            borderRadius: '25px',
                            cursor: 'pointer',
                            fontWeight: '500',
                            boxShadow: '0 5px 15px rgba(102, 126, 234, 0.4)',
                            transition: 'all 0.3s ease',
                            fontSize: '14px'
                        }}
                        onMouseEnter={(e) => {
                            e.target.style.transform = 'translateY(-2px)';
                            e.target.style.boxShadow = '0 8px 20px rgba(102, 126, 234, 0.5)';
                        }}
                        onMouseLeave={(e) => {
                            e.target.style.transform = 'translateY(0)';
                            e.target.style.boxShadow = '0 5px 15px rgba(102, 126, 234, 0.4)';
                        }}
                    >
                        + Add Resource
                    </button>
                </div>

                <div className="filter-row" style={{
                    display: 'flex',
                    gap: '10px',
                    marginBottom: '20px',
                    flexWrap: 'wrap'
                }}>
                    <button 
                        className={`filter-btn ${filterCategory === 'all' ? 'active' : ''}`}
                        onClick={() => setFilterCategory('all')}
                        style={{
                            padding: '8px 16px',
                            borderRadius: '20px',
                            border: filterCategory === 'all' ? 'none' : '1px solid #ddd',
                            background: filterCategory === 'all' ? 
                                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'white',
                            color: filterCategory === 'all' ? 'white' : '#666',
                            cursor: 'pointer',
                            transition: 'all 0.3s ease'
                        }}
                    >
                        All ({resources.length})
                    </button>
                    {['coping', 'relapse', 'daily', 'education', 'support', 'life'].map(category => (
                        <button 
                            key={category}
                            className={`filter-btn ${filterCategory === category ? 'active' : ''}`}
                            onClick={() => setFilterCategory(category)}
                            style={{
                                padding: '8px 16px',
                                borderRadius: '20px',
                                border: filterCategory === category ? 'none' : '1px solid #ddd',
                                background: filterCategory === category ? 
                                    'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'white',
                                color: filterCategory === category ? 'white' : '#666',
                                cursor: 'pointer',
                                transition: 'all 0.3s ease',
                                textTransform: 'capitalize'
                            }}
                        >
                            {category === 'coping' ? 'Coping Skills' :
                             category === 'relapse' ? 'Relapse Prevention' :
                             category === 'daily' ? 'Daily Recovery' :
                             category === 'education' ? 'Education' :
                             category === 'support' ? 'Support' :
                             'Life Skills'}
                        </button>
                    ))}
                </div>

                <div className="resources-grid" style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(auto-fill, minmax(350px, 1fr))',
                    gap: '20px'
                }}>
                    {filteredItems.map(resource => (
                        <div key={resource.id} style={{
                            background: 'white',
                            borderRadius: '15px',
                            padding: '20px',
                            boxShadow: '0 5px 15px rgba(0,0,0,0.1)',
                            transition: 'all 0.3s ease',
                            cursor: 'pointer'
                        }}
                        onMouseEnter={(e) => {
                            e.currentTarget.style.transform = 'translateY(-5px)';
                            e.currentTarget.style.boxShadow = '0 10px 30px rgba(0,0,0,0.15)';
                        }}
                        onMouseLeave={(e) => {
                            e.currentTarget.style.transform = 'translateY(0)';
                            e.currentTarget.style.boxShadow = '0 5px 15px rgba(0,0,0,0.1)';
                        }}>
                            <div style={{ marginBottom: '15px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start' }}>
                                    <h4 style={{ margin: 0, color: '#333' }}>{resource.title}</h4>
                                    <div style={{ display: 'flex', gap: '5px', alignItems: 'center' }}>
                                        {resource.isGlobal && (
                                            <span style={{
                                                background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                                                color: 'white',
                                                padding: '4px 8px',
                                                borderRadius: '12px',
                                                fontSize: '10px'
                                            }}>🌍 Global</span>
                                        )}
                                        <span style={{
                                            background: resource.category === 'coping' ? '#4CAF50' :
                                                       resource.category === 'relapse' ? '#ff9500' :
                                                       resource.category === 'daily' ? '#2196F3' :
                                                       resource.category === 'education' ? '#9c27b0' :
                                                       resource.category === 'support' ? '#00bcd4' :
                                                       '#ff5722',
                                            color: 'white',
                                            padding: '4px 8px',
                                            borderRadius: '12px',
                                            fontSize: '10px',
                                            textTransform: 'capitalize'
                                        }}>
                                            {resource.category}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <p style={{ color: '#666', fontSize: '14px', marginBottom: '15px' }}>
                                {resource.description}
                            </p>

                            {resource.url && (
                                <a href={resource.url} target="_blank" rel="noopener noreferrer" 
                                   style={{ color: '#667eea', fontSize: '13px', textDecoration: 'none' }}>
                                    🔗 External Link
                                </a>
                            )}
                            
                            {resource.fileURL && (
                                <a href={resource.fileURL} target="_blank" rel="noopener noreferrer"
                                   style={{ color: '#667eea', fontSize: '13px', textDecoration: 'none', marginLeft: '10px' }}>
                                    📄 Download
                                </a>
                            )}

                            <div style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                marginTop: '15px',
                                paddingTop: '15px',
                                borderTop: '1px solid #eee'
                            }}>
                                <div style={{ display: 'flex', gap: '15px', fontSize: '12px', color: '#999' }}>
                                    <span>👁️ {resource.viewCount || 0}</span>
                                    <span>✅ {resource.completionCount || 0}</span>
                                    <span>📅 {formatDate(resource.addedAt)}</span>
                                </div>
                                
                                <div style={{ display: 'flex', gap: '5px' }}>
                                    <button 
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            handleToggleActive(resource.id, resource.active);
                                        }}
                                        style={{
                                            background: resource.active ? '#4CAF50' : '#999',
                                            color: 'white',
                                            border: 'none',
                                            padding: '5px 10px',
                                            borderRadius: '5px',
                                            fontSize: '11px',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        {resource.active ? 'Active' : 'Inactive'}
                                    </button>
                                    <button 
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            handleEdit(resource);
                                        }}
                                        style={{
                                            background: '#2196F3',
                                            color: 'white',
                                            border: 'none',
                                            padding: '5px 10px',
                                            borderRadius: '5px',
                                            fontSize: '11px',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        Edit
                                    </button>
                                    <button 
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            handleDelete(resource.id, resource.title);
                                        }}
                                        style={{
                                            background: '#f44336',
                                            color: 'white',
                                            border: 'none',
                                            padding: '5px 10px',
                                            borderRadius: '5px',
                                            fontSize: '11px',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        Delete
                                    </button>
                                </div>
                            </div>

                            {!resource.isGlobal && resource.assignedTo && resource.assignedTo.length > 0 && (
                                <div style={{
                                    marginTop: '10px',
                                    padding: '8px',
                                    background: '#f5f5f5',
                                    borderRadius: '8px',
                                    fontSize: '12px',
                                    color: '#666'
                                }}>
                                    Assigned to {resource.assignedTo.length} PIR(s)
                                </div>
                            )}
                        </div>
                    ))}
                </div>

                {filteredItems.length === 0 && (
                    <div style={{
                        textAlign: 'center',
                        padding: '60px 20px',
                        color: '#999'
                    }}>
                        {resources.length === 0 ? 
                            'No resources added yet. Click "Add Resource" to create your first resource.' : 
                            'No resources match your filter.'}
                    </div>
                )}
            </div>

            {loading && (
                <div style={{
                    position: 'absolute',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(255,255,255,0.9)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                }}>
                    <div className="loading-spinner"></div>
                </div>
            )}

            {showCreateModal && (
                <ResourceModal
                    resource={selectedItem}
                    allPIRs={allPIRs}
                    onSave={handleCreateResource}
                    onClose={() => {
                        setShowCreateModal(false);
                        setSelectedItem(null);
                    }}
                />
            )}
        </div>
    );
}

// Keep the existing ResourceModal component as-is but remove meeting functionality
function ResourceModal({ resource, allPIRs, onSave, onClose }) {
    // Keep only the resource part of the modal, same as before
    const [formData, setFormData] = useState(() => {
        if (resource) {
            return {
                ...resource,
                assignedTo: resource.assignedTo || []
            };
        }
        
        return {
            title: '',
            description: '',
            category: 'coping',
            contentType: 'link',
            url: '',
            content: '',
            fileURL: '',
            embedUrl: '',
            isGlobal: false,
            assignedTo: [],
            active: true
        };
    });

    const [selectedPIRs, setSelectedPIRs] = useState(resource?.assignedTo || []);

    const handleSubmit = (e) => {
        e.preventDefault();
        
        if (!formData.title || !formData.description || !formData.category) {
            alert('Please fill in all required fields');
            return;
        }
        
        // Validate content based on type
        if (formData.contentType === 'link' && !formData.url) {
            alert('Please provide a URL');
            return;
        }
        if (formData.contentType === 'text' && !formData.content) {
            alert('Please provide content');
            return;
        }
        
        // Set assignedTo based on global status
        const finalData = {
            ...formData,
            assignedTo: formData.isGlobal ? [] : selectedPIRs
        };
        
        onSave(finalData);
    };

    const handlePIRSelection = (pirId) => {
        if (selectedPIRs.includes(pirId)) {
            setSelectedPIRs(selectedPIRs.filter(id => id !== pirId));
        } else {
            setSelectedPIRs([...selectedPIRs, pirId]);
        }
    };

    const selectAllPIRs = () => {
        setSelectedPIRs(allPIRs.map(pir => pir.id));
    };

    const clearSelection = () => {
        setSelectedPIRs([]);
    };

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{maxWidth: '700px', maxHeight: '90vh', overflowY: 'auto'}}>
                <div className="modal-header">
                    <h3>{resource ? 'Edit' : 'Create'} Resource</h3>
                    <button className="close-btn" onClick={onClose}>×</button>
                </div>
                
                <form onSubmit={handleSubmit} className="modal-body">
                    <div className="form-group">
                        <label>Title *</label>
                        <input
                            type="text"
                            value={formData.title}
                            onChange={(e) => setFormData({...formData, title: e.target.value})}
                            placeholder="Resource title"
                            required
                        />
                    </div>
                    
                    <div className="form-group">
                        <label>Description *</label>
                        <textarea
                            value={formData.description}
                            onChange={(e) => setFormData({...formData, description: e.target.value})}
                            placeholder="Describe this resource"
                            rows="3"
                            required
                        />
                    </div>
                    
                    <div className="form-row">
                        <div className="form-group">
                            <label>Category *</label>
                            <select
                                value={formData.category}
                                onChange={(e) => setFormData({...formData, category: e.target.value})}
                            >
                                <option value="coping">Coping Skills</option>
                                <option value="relapse">Relapse Prevention</option>
                                <option value="daily">Daily Recovery</option>
                                <option value="education">Education</option>
                                <option value="support">Support</option>
                                <option value="life">Life Skills</option>
                            </select>
                        </div>
                        
                        <div className="form-group">
                            <label>Content Type</label>
                            <select
                                value={formData.contentType}
                                onChange={(e) => setFormData({...formData, contentType: e.target.value})}
                            >
                                <option value="link">External Link</option>
                                <option value="text">Text Content</option>
                                <option value="file">File Upload</option>
                                <option value="embed">Embedded Content</option>
                            </select>
                        </div>
                    </div>
                    
                    {formData.contentType === 'link' && (
                        <div className="form-group">
                            <label>URL</label>
                            <input
                                type="url"
                                value={formData.url}
                                onChange={(e) => setFormData({...formData, url: e.target.value})}
                                placeholder="https://..."
                            />
                        </div>
                    )}
                    
                    {formData.contentType === 'text' && (
                        <div className="form-group">
                            <label>Content</label>
                            <textarea
                                value={formData.content}
                                onChange={(e) => setFormData({...formData, content: e.target.value})}
                                placeholder="Enter content"
                                rows="6"
                            />
                        </div>
                    )}
                    
                    {formData.contentType === 'file' && (
                        <div className="form-group">
                            <label>File URL</label>
                            <input
                                type="url"
                                value={formData.fileURL}
                                onChange={(e) => setFormData({...formData, fileURL: e.target.value})}
                                placeholder="URL to downloadable file"
                            />
                        </div>
                    )}
                    
                    {formData.contentType === 'embed' && (
                        <div className="form-group">
                            <label>Embed URL</label>
                            <input
                                type="url"
                                value={formData.embedUrl}
                                onChange={(e) => setFormData({...formData, embedUrl: e.target.value})}
                                placeholder="YouTube, Vimeo, etc."
                            />
                        </div>
                    )}
                    
                    <div className="form-group">
                        <label style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                            <input
                                type="checkbox"
                                checked={formData.isGlobal}
                                onChange={(e) => setFormData({...formData, isGlobal: e.target.checked})}
                            />
                            <span>Make this a global resource (available to all PIRs)</span>
                        </label>
                    </div>
                    
                    {!formData.isGlobal && (
                        <div className="form-group">
                            <label>Assign to PIRs</label>
                            <div style={{marginBottom: '10px'}}>
                                <button type="button" className="btn btn-sm" onClick={selectAllPIRs}>
                                    Select All
                                </button>
                                <button type="button" className="btn btn-sm" onClick={clearSelection} style={{marginLeft: '10px'}}>
                                    Clear All
                                </button>
                                <span style={{marginLeft: '10px'}}>
                                    {selectedPIRs.length} selected
                                </span>
                            </div>
                            <div style={{
                                maxHeight: '200px',
                                overflowY: 'auto',
                                border: '1px solid #ddd',
                                borderRadius: '4px',
                                padding: '10px'
                            }}>
                                {allPIRs.map(pir => (
                                    <label key={pir.id} style={{
                                        display: 'block',
                                        padding: '5px',
                                        cursor: 'pointer',
                                        backgroundColor: selectedPIRs.includes(pir.id) ? '#e3f2fd' : 'transparent'
                                    }}>
                                        <input
                                            type="checkbox"
                                            checked={selectedPIRs.includes(pir.id)}
                                            onChange={() => handlePIRSelection(pir.id)}
                                            style={{marginRight: '10px'}}
                                        />
                                        {pir.name} ({pir.email})
                                    </label>
                                ))}
                                {allPIRs.length === 0 && (
                                    <div style={{color: '#999', textAlign: 'center'}}>
                                        No PIRs available
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                    
                    <div className="form-group">
                        <label style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                            <input
                                type="checkbox"
                                checked={formData.active}
                                onChange={(e) => setFormData({...formData, active: e.target.checked})}
                            />
                            <span>Resource is active</span>
                        </label>
                    </div>
                    
                    <div className="modal-footer">
                        <button type="submit" className="btn btn-primary">
                            {resource ? 'Update' : 'Create'}
                        </button>
                        <button type="button" className="btn btn-secondary" onClick={onClose}>
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
}
        // FULLY FUNCTIONAL CheckInsView 
        function CheckInsView({ searchQuery }) {
            const [checkIns, setCheckIns] = useState([]);
            const [filteredCheckIns, setFilteredCheckIns] = useState([]);
            const [loading, setLoading] = useState(true);
            const [currentPage, setCurrentPage] = useState(1);
            const [filterUser, setFilterUser] = useState('all');
            const [filterMood, setFilterMood] = useState('all');
            const [filterDate, setFilterDate] = useState('all');
            const [users, setUsers] = useState([]);
            const [selectedCheckIn, setSelectedCheckIn] = useState(null);
            const itemsPerPage = 20;

            useEffect(() => {
                loadCheckInsAndUsers();
            }, []);

            useEffect(() => {
                filterCheckIns();
            }, [checkIns, filterUser, filterMood, filterDate, searchQuery]);

            const loadCheckInsAndUsers = async () => {
                try {
                    // Load users for filter dropdown
                    const usersSnap = await db.collection('users')
                        .where('role', '==', 'pir')
                        .get();
                    
                    const usersData = [];
                    const userMap = {};
                    
                    usersSnap.forEach(doc => {
                        const user = { id: doc.id, ...doc.data() };
                        usersData.push(user);
                        userMap[doc.id] = user.displayName || user.email;
                    });
                    
                    setUsers(usersData);

                    // Load check-ins
                    const checkInsSnap = await db.collection('checkIns')
                        .orderBy('createdAt', 'desc')
                        .limit(500)
                        .get();
                    
                    const checkInsData = [];
                    checkInsSnap.forEach(doc => {
                        const checkIn = { id: doc.id, ...doc.data() };
                        checkIn.userName = userMap[checkIn.userId] || 'Unknown User';
                        checkInsData.push(checkIn);
                    });
                    
                    setCheckIns(checkInsData);
                    setFilteredCheckIns(checkInsData);
                } catch (error) {
                    console.error('Error loading check-ins:', error);
                    alert('Failed to load check-ins');
                } finally {
                    setLoading(false);
                }
            };

            const filterCheckIns = () => {
                let filtered = checkIns;
                
                // Filter by user
                if (filterUser !== 'all') {
                    filtered = filtered.filter(checkIn => checkIn.userId === filterUser);
                }
                
                // Filter by mood
                if (filterMood !== 'all') {
                    const moodValue = parseInt(filterMood);
                    if (moodValue === 1) {
                        filtered = filtered.filter(checkIn => checkIn.mood <= 3);
                    } else if (moodValue === 2) {
                        filtered = filtered.filter(checkIn => checkIn.mood >= 4 && checkIn.mood <= 6);
                    } else if (moodValue === 3) {
                        filtered = filtered.filter(checkIn => checkIn.mood >= 7);
                    }
                }
                
                // Filter by date
                if (filterDate !== 'all') {
                    const now = new Date();
                    const startDate = new Date();
                    
                    if (filterDate === 'today') {
                        startDate.setHours(0, 0, 0, 0);
                    } else if (filterDate === 'week') {
                        startDate.setDate(now.getDate() - 7);
                    } else if (filterDate === 'month') {
                        startDate.setMonth(now.getMonth() - 1);
                    }
                    
                    filtered = filtered.filter(checkIn => {
                        const checkInDate = checkIn.createdAt?.toDate ? checkIn.createdAt.toDate() : new Date(checkIn.createdAt);
                        return checkInDate >= startDate;
                    });
                }
                
                // Filter by search query
                if (searchQuery) {
                    const query = searchQuery.toLowerCase();
                    filtered = filtered.filter(checkIn =>
                        checkIn.userName?.toLowerCase().includes(query) ||
                        checkIn.notes?.toLowerCase().includes(query) ||
                        checkIn.gratitude?.toLowerCase().includes(query)
                    );
                }
                
                setFilteredCheckIns(filtered);
                setCurrentPage(1);
            };

            const paginatedCheckIns = useMemo(() => {
                const start = (currentPage - 1) * itemsPerPage;
                const end = start + itemsPerPage;
                return filteredCheckIns.slice(start, end);
            }, [filteredCheckIns, currentPage]);

            const totalPages = Math.ceil(filteredCheckIns.length / itemsPerPage);

            const handleExport = (format) => {
                const exportData = filteredCheckIns.map(checkIn => ({
                    user: checkIn.userName,
                    date: formatDateTime(checkIn.createdAt),
                    mood: checkIn.mood,
                    cravings: checkIn.cravings,
                    gratitude: checkIn.gratitude || '',
                    notes: checkIn.notes || ''
                }));

                if (format === 'json') {
                    exportToJSON(exportData, 'checkins');
                } else if (format === 'csv') {
                    exportToCSV(exportData, 'checkins');
                } else if (format === 'pdf') {
                    exportToPDF(exportData, 'Check-ins Report');
                }
            };

            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="loading-spinner"></div>
                    </div>
                );
            }

            return (
                <div>
                    <div className="filter-bar">
                        <div className="filter-group">
                            <label className="filter-label">User</label>
                            <select 
                                className="filter-select"
                                value={filterUser}
                                onChange={(e) => setFilterUser(e.target.value)}
                            >
                                <option value="all">All Users</option>
                                {users.map(user => (
                                    <option key={user.id} value={user.id}>
                                        {user.displayName || user.email}
                                    </option>
                                ))}
                            </select>
                        </div>
                        
                        <div className="filter-group">
                            <label className="filter-label">Mood Level</label>
                            <select 
                                className="filter-select"
                                value={filterMood}
                                onChange={(e) => setFilterMood(e.target.value)}
                            >
                                <option value="all">All Moods</option>
                                <option value="1">Low (1-3)</option>
                                <option value="2">Medium (4-6)</option>
                                <option value="3">High (7-10)</option>
                            </select>
                        </div>
                        
                        <div className="filter-group">
                            <label className="filter-label">Time Period</label>
                            <select 
                                className="filter-select"
                                value={filterDate}
                                onChange={(e) => setFilterDate(e.target.value)}
                            >
                                <option value="all">All Time</option>
                                <option value="today">Today</option>
                                <option value="week">Last 7 Days</option>
                                <option value="month">Last 30 Days</option>
                            </select>
                        </div>
                        
                        <div style={{marginLeft: 'auto', display: 'flex', gap: '10px'}}>
                            <button className="btn btn-secondary" onClick={() => handleExport('csv')}>
                                Export CSV
                            </button>
                            <button className="btn btn-secondary" onClick={() => handleExport('json')}>
                                Export JSON
                            </button>
                            <button className="btn btn-secondary" onClick={() => handleExport('pdf')}>
                                Export PDF
                            </button>
                        </div>
                    </div>
                    
                    <div className="table-container">
    <table>
        <thead>
            <tr>
                <th>User</th>
                <th>Date/Time</th>
                <th>Mood</th>
                <th>Cravings</th>
                <th>Gratitude</th>
                <th>Notes</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {paginatedCheckIns.map(checkIn => (
                <tr key={checkIn.id}>
                    <td>{checkIn.userName}</td>
                    <td>{formatDateTime(checkIn.createdAt)}</td>
                    <td>
                        <div className="mood-scale">
                            <div className={`mood-circle mood-${checkIn.morningData?.mood || 0}`}>
                                {checkIn.morningData?.mood || '--'}
                            </div>
                        </div>
                    </td>
                    <td>
                        <div className="mood-scale">
                            <div className={`mood-circle mood-${11 - (checkIn.morningData?.craving || 0)}`}>
                                {checkIn.morningData?.craving || '--'}
                            </div>
                        </div>
                    </td>
                    <td style={{maxWidth: '200px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>
                        {checkIn.eveningData?.gratitude || '-'}
                    </td>
                    <td style={{maxWidth: '200px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>
                        {checkIn.morningData?.notes || checkIn.eveningData?.notes || '-'}
                    </td>
                    <td>
                        <button 
                            className="action-btn"
                            onClick={() => setSelectedCheckIn(checkIn)}
                        >
                            View
                        </button>
                    </td>
                </tr>
            ))}
        </tbody>
    </table>
                        
                        {filteredCheckIns.length === 0 && (
                            <div className="empty-state">
                                <div className="empty-state-text">
                                    {searchQuery ? 'No check-ins found matching your search' : 'No check-ins found'}
                                </div>
                            </div>
                        )}
                    </div>
                    
                    {totalPages > 1 && (
                        <Pagination 
                            currentPage={currentPage}
                            totalPages={totalPages}
                            onPageChange={setCurrentPage}
                        />
                    )}
                    
                    {selectedCheckIn && (
                        <CheckInDetailModal 
                            checkIn={selectedCheckIn}
                            onClose={() => setSelectedCheckIn(null)}
                        />
                    )}
                </div>
            );
        }

        // FULLY FUNCTIONAL AssignmentsView
        function AssignmentsView({ searchQuery, user }) {
            const [assignments, setAssignments] = useState([]);
            const [filteredAssignments, setFilteredAssignments] = useState([]);
            const [loading, setLoading] = useState(true);
            const [currentPage, setCurrentPage] = useState(1);
            const [filterStatus, setFilterStatus] = useState('all');
            const [filterUser, setFilterUser] = useState('all');
            const [showCreateModal, setShowCreateModal] = useState(false);
            const [selectedAssignment, setSelectedAssignment] = useState(null);
            const [users, setUsers] = useState([]);
            const itemsPerPage = 20;

            useEffect(() => {
                loadAssignmentsAndUsers();
            }, []);

            useEffect(() => {
                filterAssignments();
            }, [assignments, filterStatus, filterUser, searchQuery]);

            const loadAssignmentsAndUsers = async () => {
                try {
                    // Load PIRs for filter and assignment
                    const usersSnap = await db.collection('users')
                        .where('role', '==', 'pir')
                        .get();
                    
                    const usersData = [];
                    const userMap = {};
                    
                    usersSnap.forEach(doc => {
                        const user = { id: doc.id, ...doc.data() };
                        usersData.push(user);
                        userMap[doc.id] = user.displayName || user.email;
                    });
                    
                    setUsers(usersData);

                    // Load assignments
                    const assignmentsSnap = await db.collection('assignments')
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    const assignmentsData = [];
                    assignmentsSnap.forEach(doc => {
                        const assignment = { id: doc.id, ...doc.data() };
                        assignment.userName = userMap[assignment.userId] || 'Unknown User';
                        
                        // Check if overdue
                        if (assignment.dueDate && assignment.status !== 'completed') {
                            const dueDate = assignment.dueDate.toDate ? assignment.dueDate.toDate() : new Date(assignment.dueDate);
                            if (dueDate < new Date()) {
                                assignment.overdue = true;
                            }
                        }
                        
                        assignmentsData.push(assignment);
                    });
                    
                    setAssignments(assignmentsData);
                    setFilteredAssignments(assignmentsData);
                } catch (error) {
                    console.error('Error loading assignments:', error);
                    alert('Failed to load assignments');
                } finally {
                    setLoading(false);
                }
            };

            const filterAssignments = () => {
                let filtered = assignments;
                
                // Filter by status
                if (filterStatus !== 'all') {
                    if (filterStatus === 'overdue') {
                        filtered = filtered.filter(assignment => assignment.overdue);
                    } else {
                        filtered = filtered.filter(assignment => assignment.status === filterStatus);
                    }
                }
                
                // Filter by user
                if (filterUser !== 'all') {
                    filtered = filtered.filter(assignment => assignment.userId === filterUser);
                }
                
                // Filter by search
                if (searchQuery) {
                    const query = searchQuery.toLowerCase();
                    filtered = filtered.filter(assignment =>
                        assignment.userName?.toLowerCase().includes(query) ||
                        assignment.title?.toLowerCase().includes(query) ||
                        assignment.description?.toLowerCase().includes(query)
                    );
                }
                
                setFilteredAssignments(filtered);
                setCurrentPage(1);
            };

            const handleStatusUpdate = async (assignmentId, newStatus) => {
                try {
                    await db.collection('assignments').doc(assignmentId).update({
                        status: newStatus,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Update local state
                    setAssignments(prev => prev.map(a => 
                        a.id === assignmentId ? { ...a, status: newStatus } : a
                    ));
                    
                    alert('Assignment status updated');
                } catch (error) {
                    console.error('Error updating assignment:', error);
                    alert('Failed to update assignment');
                }
            };

            const handleDelete = async (assignmentId) => {
                if (!confirm('Are you sure you want to delete this assignment?')) return;
                
                try {
                    await db.collection('assignments').doc(assignmentId).delete();
                    setAssignments(prev => prev.filter(a => a.id !== assignmentId));
                    alert('Assignment deleted');
                } catch (error) {
                    console.error('Error deleting assignment:', error);
                    alert('Failed to delete assignment');
                }
            };

            const paginatedAssignments = useMemo(() => {
                const start = (currentPage - 1) * itemsPerPage;
                const end = start + itemsPerPage;
                return filteredAssignments.slice(start, end);
            }, [filteredAssignments, currentPage]);

            const totalPages = Math.ceil(filteredAssignments.length / itemsPerPage);

            const handleExport = (format) => {
                const exportData = filteredAssignments.map(assignment => ({
                    user: assignment.userName,
                    title: assignment.title,
                    description: assignment.description,
                    status: assignment.status,
                    dueDate: assignment.dueDate ? formatDate(assignment.dueDate) : 'N/A',
                    createdAt: formatDate(assignment.createdAt),
                    overdue: assignment.overdue ? 'Yes' : 'No'
                }));

                if (format === 'json') {
                    exportToJSON(exportData, 'assignments');
                } else if (format === 'csv') {
                    exportToCSV(exportData, 'assignments');
                } else if (format === 'pdf') {
                    exportToPDF(exportData, 'Assignments Report');
                }
            };

            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="loading-spinner"></div>
                    </div>
                );
            }

            return (
                <div>
                    <div className="filter-bar">
                        <div className="filter-group">
                            <label className="filter-label">Status</label>
                            <select 
                                className="filter-select"
                                value={filterStatus}
                                onChange={(e) => setFilterStatus(e.target.value)}
                            >
                                <option value="all">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="in_progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="overdue">Overdue</option>
                            </select>
                        </div>
                        
                        <div className="filter-group">
                            <label className="filter-label">User</label>
                            <select 
                                className="filter-select"
                                value={filterUser}
                                onChange={(e) => setFilterUser(e.target.value)}
                            >
                                <option value="all">All Users</option>
                                {users.map(user => (
                                    <option key={user.id} value={user.id}>
                                        {user.displayName || user.email}
                                    </option>
                                ))}
                            </select>
                        </div>
                        
                        <div style={{marginLeft: 'auto', display: 'flex', gap: '10px'}}>
                            <button className="btn btn-secondary" onClick={() => handleExport('csv')}>
                                Export CSV
                            </button>
                            <button className="btn btn-secondary" onClick={() => handleExport('json')}>
                                Export JSON
                            </button>
                            <button className="btn btn-primary" onClick={() => setShowCreateModal(true)}>
                                + Create Assignment
                            </button>
                        </div>
                    </div>
                    
                    <div className="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Title</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th>Due Date</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {paginatedAssignments.map(assignment => (
                                    <tr key={assignment.id}>
                                        <td>{assignment.userName}</td>
                                        <td>{assignment.title}</td>
                                        <td style={{maxWidth: '200px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>
                                            {assignment.description}
                                        </td>
                                        <td>
                                            <span className={`badge ${
                                                assignment.overdue ? 'badge-danger' :
                                                assignment.status === 'completed' ? 'badge-success' :
                                                assignment.status === 'in_progress' ? 'badge-warning' :
                                                'badge-info'
                                            }`}>
                                                {assignment.overdue ? 'Overdue' : assignment.status?.replace('_', ' ')}
                                            </span>
                                        </td>
                                        <td>{assignment.dueDate ? formatDate(assignment.dueDate) : '-'}</td>
                                        <td>{formatDate(assignment.createdAt)}</td>
                                        <td>
                                            <div className="action-buttons">
                                                <button 
                                                    className="action-btn"
                                                    onClick={() => setSelectedAssignment(assignment)}
                                                >
                                                    View
                                                </button>
                                                {assignment.status !== 'completed' && (
                                                    <button 
                                                        className="action-btn"
                                                        onClick={() => handleStatusUpdate(assignment.id, 
                                                            assignment.status === 'pending' ? 'in_progress' : 'completed'
                                                        )}
                                                    >
                                                        {assignment.status === 'pending' ? 'Start' : 'Complete'}
                                                    </button>
                                                )}
                                                <button 
                                                    className="action-btn"
                                                    onClick={() => handleDelete(assignment.id)}
                                                    style={{color: '#f44336'}}
                                                >
                                                    Delete
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        
                        {filteredAssignments.length === 0 && (
                            <div className="empty-state">
                                <div className="empty-state-text">
                                    {searchQuery ? 'No assignments found matching your search' : 'No assignments found'}
                                </div>
                            </div>
                        )}
                    </div>
                    
                    {totalPages > 1 && (
                        <Pagination 
                            currentPage={currentPage}
                            totalPages={totalPages}
                            onPageChange={setCurrentPage}
                        />
                    )}
                    
                    {showCreateModal && (
                        <CreateAssignmentModal 
                            onClose={() => setShowCreateModal(false)}
                            onSuccess={() => {
                                setShowCreateModal(false);
                                loadAssignmentsAndUsers();
                            }}
                            users={users}
                            createdBy={user.uid}
                        />
                    )}
                    
                    {selectedAssignment && (
                        <AssignmentDetailModal 
                            assignment={selectedAssignment}
                            onClose={() => setSelectedAssignment(null)}
                            onUpdate={() => loadAssignmentsAndUsers()}
                        />
                    )}
                </div>
            );
        }

       // FULLY ENHANCED FeedbackView with All Features
function FeedbackView({ searchQuery, user }) {
    const [feedbacks, setFeedbacks] = useState([]);
    const [filteredFeedbacks, setFilteredFeedbacks] = useState([]);
    const [loading, setLoading] = useState(true);
    const [currentPage, setCurrentPage] = useState(1);
    const [filterStatus, setFilterStatus] = useState('all');
    const [filterType, setFilterType] = useState('all');
    const [filterSentiment, setFilterSentiment] = useState('all');
    const [selectedFeedback, setSelectedFeedback] = useState(null);
    const [selectedFeedbacks, setSelectedFeedbacks] = useState(new Set());
    const [stats, setStats] = useState({
        total: 0,
        pending: 0,
        avgRating: 0,
        responseRate: 0
    });
    const itemsPerPage = 20;

    useEffect(() => {
        loadFeedbacks();
    }, []);

    useEffect(() => {
        filterFeedbacks();
        calculateStats();
    }, [feedbacks, filterStatus, filterType, filterSentiment, searchQuery]);

    const analyzeSentiment = (feedback) => {
        const text = (feedback.message + ' ' + feedback.subject).toLowerCase();
        const positiveWords = ['great', 'excellent', 'amazing', 'love', 'perfect', 'fantastic', 'wonderful', 'helpful', 'thank'];
        const negativeWords = ['bad', 'terrible', 'awful', 'hate', 'worst', 'horrible', 'disappointed', 'frustrated', 'angry', 'useless'];
        
        let score = 0;
        positiveWords.forEach(word => { if (text.includes(word)) score++; });
        negativeWords.forEach(word => { if (text.includes(word)) score--; });
        
        if (score > 1) return 'positive';
        if (score < -1) return 'negative';
        return 'neutral';
    };

    const loadFeedbacks = async () => {
        try {
            const feedbacksSnap = await db.collection('feedback')
                .orderBy('createdAt', 'desc')
                .get();
            
            const feedbacksData = [];
            const userIds = new Set();
            
            feedbacksSnap.forEach(doc => {
                const feedback = { id: doc.id, ...doc.data() };
                feedback.sentiment = analyzeSentiment(feedback);
                feedbacksData.push(feedback);
                if (feedback.userId) userIds.add(feedback.userId);
            });
            
            if (userIds.size > 0) {
                const userResults = await batchQuery('users',
                    firebase.firestore.FieldPath.documentId(),
                    Array.from(userIds)
                );
                
                const userMap = {};
                userResults.forEach(user => {
                    userMap[user.id] = user.displayName || user.email;
                });
                
                feedbacksData.forEach(feedback => {
                    feedback.userName = userMap[feedback.userId] || 'Anonymous';
                });
            }
            
            setFeedbacks(feedbacksData);
            setFilteredFeedbacks(feedbacksData);
        } catch (error) {
            console.error('Error loading feedback:', error);
            alert('Failed to load feedback');
        } finally {
            setLoading(false);
        }
    };

    const calculateStats = () => {
        const total = feedbacks.length;
        const pending = feedbacks.filter(f => !f.reviewed).length;
        const ratings = feedbacks.filter(f => f.rating).map(f => f.rating);
        const avgRating = ratings.length > 0 ? (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1) : 0;
        const responded = feedbacks.filter(f => f.response).length;
        const responseRate = total > 0 ? Math.round((responded / total) * 100) : 0;
        
        setStats({ total, pending, avgRating, responseRate });
    };

    const filterFeedbacks = () => {
        let filtered = feedbacks;
        
        if (filterStatus !== 'all') {
            filtered = filtered.filter(feedback => 
                filterStatus === 'reviewed' ? feedback.reviewed : !feedback.reviewed
            );
        }
        
        if (filterType !== 'all') {
            filtered = filtered.filter(feedback => feedback.type === filterType);
        }
        
        if (filterSentiment !== 'all') {
            filtered = filtered.filter(feedback => feedback.sentiment === filterSentiment);
        }
        
        if (searchQuery) {
            const query = searchQuery.toLowerCase();
            filtered = filtered.filter(feedback =>
                feedback.userName?.toLowerCase().includes(query) ||
                feedback.subject?.toLowerCase().includes(query) ||
                feedback.message?.toLowerCase().includes(query)
            );
        }
        
        setFilteredFeedbacks(filtered);
        setCurrentPage(1);
    };

    const quickFilter = (type) => {
        if (type === 'urgent') {
            setFilterType('complaint');
            setFilterStatus('pending');
        } else if (type === 'high-priority') {
            setFilterSentiment('negative');
            setFilterStatus('pending');
        } else if (type === 'needs-response') {
            setFilterStatus('pending');
        }
    };

    const handleSelectAll = () => {
        if (selectedFeedbacks.size === paginatedFeedbacks.length) {
            setSelectedFeedbacks(new Set());
        } else {
            setSelectedFeedbacks(new Set(paginatedFeedbacks.map(f => f.id)));
        }
    };

    const handleSelectFeedback = (feedbackId) => {
        const newSelected = new Set(selectedFeedbacks);
        if (newSelected.has(feedbackId)) {
            newSelected.delete(feedbackId);
        } else {
            newSelected.add(feedbackId);
        }
        setSelectedFeedbacks(newSelected);
    };

    const handleBulkMarkReviewed = async () => {
        try {
            const batch = db.batch();
            selectedFeedbacks.forEach(feedbackId => {
                const feedbackRef = db.collection('feedback').doc(feedbackId);
                batch.update(feedbackRef, {
                    reviewed: true,
                    reviewedBy: user.uid,
                    reviewedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            });
            
            await batch.commit();
            
            setFeedbacks(prev => prev.map(f => 
                selectedFeedbacks.has(f.id) ? { ...f, reviewed: true } : f
            ));
            setSelectedFeedbacks(new Set());
            alert(`Marked ${selectedFeedbacks.size} feedbacks as reviewed`);
        } catch (error) {
            console.error('Error bulk updating:', error);
            alert('Failed to update feedbacks');
        }
    };

    const handleMarkReviewed = async (feedbackId, reviewed = true) => {
        try {
            await db.collection('feedback').doc(feedbackId).update({
                reviewed: reviewed,
                reviewedBy: user.uid,
                reviewedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            setFeedbacks(prev => prev.map(f => 
                f.id === feedbackId ? { ...f, reviewed } : f
            ));
            
            alert('Feedback marked as ' + (reviewed ? 'reviewed' : 'unreviewed'));
        } catch (error) {
            console.error('Error updating feedback:', error);
            alert('Failed to update feedback');
        }
    };

    const handleRespond = async (feedbackId, response) => {
        try {
            await db.collection('feedback').doc(feedbackId).update({
                response: response,
                respondedBy: user.uid,
                respondedAt: firebase.firestore.FieldValue.serverTimestamp(),
                reviewed: true
            });
            
            setFeedbacks(prev => prev.map(f => 
                f.id === feedbackId ? { ...f, response, reviewed: true } : f
            ));
            
            alert('Response sent successfully');
        } catch (error) {
            console.error('Error responding to feedback:', error);
            alert('Failed to send response');
        }
    };

    const handleDelete = async (feedbackId) => {
        if (!confirm('Are you sure you want to delete this feedback?')) return;
        
        try {
            await db.collection('feedback').doc(feedbackId).delete();
            setFeedbacks(prev => prev.filter(f => f.id !== feedbackId));
            alert('Feedback deleted');
        } catch (error) {
            console.error('Error deleting feedback:', error);
            alert('Failed to delete feedback');
        }
    };

    const renderStars = (rating) => {
        if (!rating) return '-';
        return (
            <div style={{ display: 'flex', gap: '2px' }}>
                {[1, 2, 3, 4, 5].map(star => (
                    <span key={star} style={{ 
                        color: star <= rating ? '#FFD700' : '#ddd',
                        fontSize: '16px'
                    }}>
                        ★
                    </span>
                ))}
            </div>
        );
    };

    const getSentimentColor = (sentiment) => {
        if (sentiment === 'positive') return '#4CAF50';
        if (sentiment === 'negative') return '#f44336';
        return '#9E9E9E';
    };

    const paginatedFeedbacks = useMemo(() => {
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        return filteredFeedbacks.slice(start, end);
    }, [filteredFeedbacks, currentPage]);

    const totalPages = Math.ceil(filteredFeedbacks.length / itemsPerPage);

    const handleExport = (format) => {
        const exportData = filteredFeedbacks.map(feedback => ({
            user: feedback.userName,
            type: feedback.type,
            subject: feedback.subject,
            message: feedback.message,
            rating: feedback.rating || 'N/A',
            sentiment: feedback.sentiment,
            status: feedback.reviewed ? 'Reviewed' : 'Pending',
            createdAt: formatDate(feedback.createdAt),
            response: feedback.response || 'No response yet'
        }));

        if (format === 'json') {
            exportToJSON(exportData, 'feedback');
        } else if (format === 'csv') {
            exportToCSV(exportData, 'feedback');
        } else if (format === 'pdf') {
            exportToPDF(exportData, 'Feedback Report');
        }
    };

    if (loading) {
        return (
            <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                minHeight: '400px',
                gap: '20px'
            }}>
                <div style={{
                    width: '60px',
                    height: '60px',
                    border: '4px solid #f3f3f3',
                    borderTop: '4px solid #667eea',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite'
                }}></div>
                <p style={{ color: '#666' }}>Loading feedback...</p>
            </div>
        );
    }

    return (
        <div style={{ padding: '20px', animation: 'fadeIn 0.5s' }}>
            {/* Stats Cards */}
            <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(240px, 1fr))',
                gap: '20px',
                marginBottom: '30px'
            }}>
                <div style={{
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(102, 126, 234, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Total Feedback</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.total}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>All time</div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(240, 147, 251, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Pending Reviews</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.pending}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Awaiting action</div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(79, 172, 254, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Average Rating</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.avgRating}/5
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>From rated feedback</div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(250, 112, 154, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Response Rate</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.responseRate}%
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Responded to</div>
                </div>
            </div>

            {/* Quick Filters */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '15px 20px',
                marginBottom: '20px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                display: 'flex',
                gap: '10px',
                flexWrap: 'wrap',
                alignItems: 'center'
            }}>
                <span style={{ fontWeight: '600', color: '#333', marginRight: '10px' }}>Quick Filters:</span>
                <button
                    onClick={() => quickFilter('urgent')}
                    style={{
                        padding: '8px 16px',
                        background: 'linear-gradient(135deg, #f44336 0%, #e53935 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontSize: '13px',
                        fontWeight: '500',
                        transition: 'transform 0.2s'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                    onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    Urgent Complaints
                </button>
                <button
                    onClick={() => quickFilter('high-priority')}
                    style={{
                        padding: '8px 16px',
                        background: 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontSize: '13px',
                        fontWeight: '500',
                        transition: 'transform 0.2s'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                    onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    High Priority
                </button>
                <button
                    onClick={() => quickFilter('needs-response')}
                    style={{
                        padding: '8px 16px',
                        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontSize: '13px',
                        fontWeight: '500',
                        transition: 'transform 0.2s'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                    onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    Needs Response
                </button>
            </div>

            {/* Filters and Actions Bar */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                marginBottom: '20px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', flexWrap: 'wrap', gap: '15px' }}>
                    <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                        <select 
                            value={filterStatus}
                            onChange={(e) => setFilterStatus(e.target.value)}
                            style={{
                                padding: '8px 12px',
                                borderRadius: '8px',
                                border: '1px solid #ddd',
                                background: 'white',
                                cursor: 'pointer',
                                fontSize: '14px'
                            }}
                        >
                            <option value="all">All Status</option>
                            <option value="pending">Pending Review</option>
                            <option value="reviewed">Reviewed</option>
                        </select>
                        
                        <select 
                            value={filterType}
                            onChange={(e) => setFilterType(e.target.value)}
                            style={{
                                padding: '8px 12px',
                                borderRadius: '8px',
                                border: '1px solid #ddd',
                                background: 'white',
                                cursor: 'pointer',
                                fontSize: '14px'
                            }}
                        >
                            <option value="all">All Types</option>
                            <option value="bug">Bug Report</option>
                            <option value="feature">Feature Request</option>
                            <option value="general">General Feedback</option>
                            <option value="complaint">Complaint</option>
                            <option value="praise">Praise</option>
                        </select>

                        <select 
                            value={filterSentiment}
                            onChange={(e) => setFilterSentiment(e.target.value)}
                            style={{
                                padding: '8px 12px',
                                borderRadius: '8px',
                                border: '1px solid #ddd',
                                background: 'white',
                                cursor: 'pointer',
                                fontSize: '14px'
                            }}
                        >
                            <option value="all">All Sentiments</option>
                            <option value="positive">Positive</option>
                            <option value="neutral">Neutral</option>
                            <option value="negative">Negative</option>
                        </select>
                    </div>
                    
                    <div style={{ display: 'flex', gap: '10px' }}>
                        {selectedFeedbacks.size > 0 && (
                            <button 
                                onClick={handleBulkMarkReviewed}
                                style={{
                                    padding: '10px 16px',
                                    background: 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500'
                                }}
                            >
                                Mark {selectedFeedbacks.size} as Reviewed
                            </button>
                        )}
                        <button 
                            onClick={() => handleExport('csv')}
                            style={{
                                padding: '10px 16px',
                                background: '#6c757d',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '500'
                            }}
                        >
                            Export CSV
                        </button>
                    </div>
                </div>
            </div>
            
            {/* Enhanced Table */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                overflow: 'hidden',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                    <thead>
                        <tr style={{ background: '#f8f9fa', borderBottom: '2px solid #e9ecef' }}>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>
                                <input 
                                    type="checkbox"
                                    checked={selectedFeedbacks.size === paginatedFeedbacks.length && paginatedFeedbacks.length > 0}
                                    onChange={handleSelectAll}
                                    style={{ cursor: 'pointer', width: '16px', height: '16px' }}
                                />
                            </th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>User</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Type</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Subject</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Rating</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Sentiment</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Status</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Date</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {paginatedFeedbacks.map(feedback => (
                            <tr key={feedback.id} style={{
                                borderBottom: '1px solid #f0f0f0',
                                transition: 'all 0.2s',
                                background: selectedFeedbacks.has(feedback.id) ? '#f0f4ff' : 'white'
                            }}
                            onMouseEnter={(e) => {
                                if (!selectedFeedbacks.has(feedback.id)) {
                                    e.currentTarget.style.background = '#f8f9fa';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (!selectedFeedbacks.has(feedback.id)) {
                                    e.currentTarget.style.background = 'white';
                                }
                            }}
                            >
                                <td style={{ padding: '15px' }}>
                                    <input 
                                        type="checkbox"
                                        checked={selectedFeedbacks.has(feedback.id)}
                                        onChange={() => handleSelectFeedback(feedback.id)}
                                        style={{ cursor: 'pointer', width: '16px', height: '16px' }}
                                    />
                                </td>
                                <td style={{ padding: '15px', fontWeight: '500', color: '#333' }}>
                                    {feedback.userName}
                                </td>
                                <td style={{ padding: '15px' }}>
                                    <span style={{
                                        padding: '4px 12px',
                                        borderRadius: '20px',
                                        fontSize: '12px',
                                        fontWeight: '500',
                                        background: '#e3f2fd',
                                        color: '#1976d2'
                                    }}>
                                        {feedback.type}
                                    </span>
                                </td>
                                <td style={{ padding: '15px', color: '#666', maxWidth: '200px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                    {feedback.subject}
                                </td>
                                <td style={{ padding: '15px' }}>{renderStars(feedback.rating)}</td>
                                <td style={{ padding: '15px' }}>
                                    <div style={{
                                        width: '10px',
                                        height: '10px',
                                        borderRadius: '50%',
                                        background: getSentimentColor(feedback.sentiment),
                                        display: 'inline-block'
                                    }}></div>
                                </td>
                                <td style={{ padding: '15px' }}>
                                    <span style={{
                                        padding: '4px 12px',
                                        borderRadius: '20px',
                                        fontSize: '12px',
                                        fontWeight: '500',
                                        background: feedback.reviewed ? '#d4edda' : '#fff3cd',
                                        color: feedback.reviewed ? '#155724' : '#856404'
                                    }}>
                                        {feedback.reviewed ? 'Reviewed' : 'Pending'}
                                    </span>
                                </td>
                                <td style={{ padding: '15px', color: '#666' }}>{formatDate(feedback.createdAt)}</td>
                                <td style={{ padding: '15px' }}>
                                    <button 
                                        onClick={() => setSelectedFeedback(feedback)}
                                        style={{
                                            padding: '6px 12px',
                                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            fontWeight: '500'
                                        }}
                                    >
                                        View
                                    </button>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
                
                {filteredFeedbacks.length === 0 && (
                    <div style={{
                        padding: '60px 20px',
                        textAlign: 'center',
                        color: '#999'
                    }}>
                        <div style={{ fontSize: '48px', marginBottom: '15px' }}>📝</div>
                        <div style={{ fontSize: '18px', fontWeight: '500', marginBottom: '8px' }}>
                            No feedback found
                        </div>
                        <div style={{ fontSize: '14px' }}>
                            {searchQuery ? 'Try adjusting your search terms' : 'Feedback will appear here when submitted'}
                        </div>
                    </div>
                )}
            </div>
            
            {totalPages > 1 && (
                <div style={{ marginTop: '20px' }}>
                    <Pagination 
                        currentPage={currentPage}
                        totalPages={totalPages}
                        onPageChange={setCurrentPage}
                    />
                </div>
            )}
            
            {selectedFeedback && (
                <FeedbackDetailModal 
                    feedback={selectedFeedback}
                    onClose={() => setSelectedFeedback(null)}
                    onRespond={handleRespond}
                    onMarkReviewed={handleMarkReviewed}
                    getSentimentColor={getSentimentColor}
                    renderStars={renderStars}
                />
            )}
        </div>
    );
}

// Enhanced Feedback Detail Modal
function FeedbackDetailModal({ feedback, onClose, onRespond, onMarkReviewed, getSentimentColor, renderStars }) {
    const [response, setResponse] = useState(feedback.response || '');
    const [submitting, setSubmitting] = useState(false);

    const handleSubmit = async () => {
        if (!response.trim()) {
            alert('Please enter a response');
            return;
        }
        
        setSubmitting(true);
        await onRespond(feedback.id, response);
        setSubmitting(false);
        onClose();
    };

    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000,
            padding: '20px',
            animation: 'fadeIn 0.2s'
        }}>
            <div style={{
                background: 'white',
                borderRadius: '20px',
                maxWidth: '700px',
                width: '100%',
                maxHeight: '90vh',
                overflow: 'auto',
                boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
                animation: 'slideUp 0.3s'
            }}>
                {/* Header */}
                <div style={{
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    padding: '25px 30px',
                    borderRadius: '20px 20px 0 0',
                    color: 'white',
                    position: 'sticky',
                    top: 0,
                    zIndex: 1
                }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <h2 style={{ margin: 0, fontSize: '24px' }}>Feedback Details</h2>
                        <button 
                            onClick={onClose}
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                border: 'none',
                                color: 'white',
                                fontSize: '24px',
                                width: '36px',
                                height: '36px',
                                borderRadius: '50%',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                transition: 'background 0.2s'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.3)'}
                            onMouseLeave={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.2)'}
                        >
                            ×
                        </button>
                    </div>
                </div>

                {/* Content */}
                <div style={{ padding: '30px' }}>
                    {/* Info Grid */}
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(2, 1fr)',
                        gap: '20px',
                        marginBottom: '25px'
                    }}>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>User</div>
                            <div style={{ fontSize: '16px', fontWeight: '500', color: '#333' }}>
                                {feedback.userName}
                            </div>
                        </div>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Type</div>
                            <div style={{ fontSize: '16px', fontWeight: '500', color: '#333' }}>
                                {feedback.type}
                            </div>
                        </div>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Rating</div>
                            {renderStars(feedback.rating)}
                        </div>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Sentiment</div>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                <div style={{
                                    width: '12px',
                                    height: '12px',
                                    borderRadius: '50%',
                                    background: getSentimentColor(feedback.sentiment)
                                }}></div>
                                <span style={{ textTransform: 'capitalize' }}>{feedback.sentiment}</span>
                            </div>
                        </div>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Date</div>
                            <div style={{ fontSize: '16px', fontWeight: '500', color: '#333' }}>
                                {formatDate(feedback.createdAt)}
                            </div>
                        </div>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Status</div>
                            <span style={{
                                padding: '4px 12px',
                                borderRadius: '20px',
                                fontSize: '12px',
                                fontWeight: '500',
                                background: feedback.reviewed ? '#d4edda' : '#fff3cd',
                                color: feedback.reviewed ? '#155724' : '#856404'
                            }}>
                                {feedback.reviewed ? 'Reviewed' : 'Pending'}
                            </span>
                        </div>
                    </div>

                    {/* Subject */}
                    <div style={{ marginBottom: '20px' }}>
                        <div style={{ fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                            Subject
                        </div>
                        <div style={{
                            padding: '15px',
                            background: '#f8f9fa',
                            borderRadius: '10px',
                            color: '#666'
                        }}>
                            {feedback.subject}
                        </div>
                    </div>

                    {/* Message */}
                    <div style={{ marginBottom: '25px' }}>
                        <div style={{ fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                            Message
                        </div>
                        <div style={{
                            padding: '15px',
                            background: '#f8f9fa',
                            borderRadius: '10px',
                            color: '#666',
                            lineHeight: '1.6',
                            whiteSpace: 'pre-wrap'
                        }}>
                            {feedback.message}
                        </div>
                    </div>

                    {/* Response Section */}
                    <div style={{ marginBottom: '20px' }}>
                        <div style={{ fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                            {feedback.response ? 'Your Response' : 'Add Response'}
                        </div>
                        <textarea
                            value={response}
                            onChange={(e) => setResponse(e.target.value)}
                            placeholder="Type your response here..."
                            style={{
                                width: '100%',
                                minHeight: '120px',
                                padding: '15px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '10px',
                                fontSize: '14px',
                                fontFamily: 'inherit',
                                resize: 'vertical',
                                transition: 'border-color 0.2s'
                            }}
                            onFocus={(e) => e.currentTarget.style.borderColor = '#667eea'}
                            onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                        />
                    </div>

                    {/* Actions */}
                    <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                        {!feedback.reviewed && (
                            <button
                                onClick={() => {
                                    onMarkReviewed(feedback.id, true);
                                    onClose();
                                }}
                                style={{
                                    padding: '12px 24px',
                                    background: '#6c757d',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500',
                                    transition: 'background 0.2s'
                                }}
                                onMouseEnter={(e) => e.currentTarget.style.background = '#5a6268'}
                                onMouseLeave={(e) => e.currentTarget.style.background = '#6c757d'}
                            >
                                Mark as Reviewed
                            </button>
                        )}
                        <button
                            onClick={handleSubmit}
                            disabled={submitting || !response.trim()}
                            style={{
                                padding: '12px 24px',
                                background: submitting || !response.trim() 
                                    ? '#ccc' 
                                    : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: submitting || !response.trim() ? 'not-allowed' : 'pointer',
                                fontSize: '14px',
                                fontWeight: '500',
                                transition: 'transform 0.2s'
                            }}
                            onMouseEnter={(e) => {
                                if (!submitting && response.trim()) {
                                    e.currentTarget.style.transform = 'translateY(-2px)';
                                }
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.transform = 'translateY(0)';
                            }}
                        >
                            {submitting ? 'Sending...' : 'Send Response'}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
}

        // FULLY ENHANCED AlertsView with All Features
function AlertsView({ searchQuery, user }) {
    const [alerts, setAlerts] = useState([]);
    const [filteredAlerts, setFilteredAlerts] = useState([]);
    const [loading, setLoading] = useState(true);
    const [currentPage, setCurrentPage] = useState(1);
    const [filterType, setFilterType] = useState('all');
    const [filterPriority, setFilterPriority] = useState('all');
    const [filterResolved, setFilterResolved] = useState('unresolved');
    const [selectedAlert, setSelectedAlert] = useState(null);
    const [stats, setStats] = useState({
        total: 0,
        active: 0,
        avgResponseTime: 0,
        critical: 0
    });
    const [frequencyData, setFrequencyData] = useState([]);
    const frequencyChartRef = useRef(null);
    const chartInstance = useRef(null);
    const itemsPerPage = 20;

    useEffect(() => {
        loadAlerts();
        
        const unsubscribe = db.collection('alerts')
            .where('type', '==', 'sos')
            .where('resolved', '==', false)
            .onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const alert = { id: change.doc.id, ...change.doc.data() };
                        if (alert.createdAt?.toDate() > new Date(Date.now() - 5000)) {
                            showSOSNotification(alert);
                        }
                    }
                });
            });
        
        return () => {
            unsubscribe();
            if (chartInstance.current) {
                chartInstance.current.destroy();
            }
        };
    }, []);

    useEffect(() => {
        filterAlerts();
        calculateStats();
        prepareFrequencyData();
    }, [alerts, filterType, filterPriority, filterResolved, searchQuery]);

    useEffect(() => {
        if (frequencyData.length > 0) {
            renderFrequencyChart();
        }
    }, [frequencyData]);

    const showSOSNotification = async (alert) => {
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification('🚨 SOS ALERT', {
                body: `Emergency alert from ${alert.userName}`,
                icon: '/favicon.ico',
                requireInteraction: true
            });
        } else if ('Notification' in window && Notification.permission !== 'denied') {
            Notification.requestPermission();
        }
        
        await db.collection('notifications').add({
            type: 'sos',
            message: `SOS Alert from ${alert.userName}`,
            recipientId: user.uid,
            relatedId: alert.id,
            urgent: true,
            read: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    };

    const loadAlerts = async () => {
        try {
            const alertsSnap = await db.collection('alerts')
                .orderBy('createdAt', 'desc')
                .get();
            
            const alertsData = [];
            const userIds = new Set();
            
            alertsSnap.forEach(doc => {
                const alert = { id: doc.id, ...doc.data() };
                alertsData.push(alert);
                if (alert.userId) userIds.add(alert.userId);
            });
            
            if (userIds.size > 0) {
                const userResults = await batchQuery('users',
                    firebase.firestore.FieldPath.documentId(),
                    Array.from(userIds)
                );
                
                const userMap = {};
                userResults.forEach(user => {
                    userMap[user.id] = user.displayName || user.email;
                });
                
                alertsData.forEach(alert => {
                    alert.userName = userMap[alert.userId] || 'Unknown User';
                });
            }
            
            setAlerts(alertsData);
            setFilteredAlerts(alertsData);
        } catch (error) {
            console.error('Error loading alerts:', error);
            alert('Failed to load alerts');
        } finally {
            setLoading(false);
        }
    };

    const calculateStats = () => {
        const total = alerts.length;
        const active = alerts.filter(a => !a.resolved).length;
        const critical = alerts.filter(a => a.priority === 'critical' && !a.resolved).length;
        
        const resolvedAlerts = alerts.filter(a => a.resolved && a.createdAt && a.resolvedAt);
        let totalMinutes = 0;
        resolvedAlerts.forEach(alert => {
            const created = alert.createdAt.toDate ? alert.createdAt.toDate() : new Date(alert.createdAt);
            const resolved = alert.resolvedAt.toDate ? alert.resolvedAt.toDate() : new Date(alert.resolvedAt);
            const minutes = (resolved - created) / 1000 / 60;
            totalMinutes += minutes;
        });
        
        const avgResponseTime = resolvedAlerts.length > 0 
            ? Math.round(totalMinutes / resolvedAlerts.length) 
            : 0;
        
        setStats({ total, active, avgResponseTime, critical });
    };

    const prepareFrequencyData = () => {
        const last7Days = [];
        const counts = [];
        
        for (let i = 6; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            date.setHours(0, 0, 0, 0);
            
            const nextDay = new Date(date);
            nextDay.setDate(nextDay.getDate() + 1);
            
            const dayAlerts = alerts.filter(alert => {
                const alertDate = alert.createdAt?.toDate ? alert.createdAt.toDate() : new Date(alert.createdAt);
                return alertDate >= date && alertDate < nextDay;
            });
            
            last7Days.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
            counts.push(dayAlerts.length);
        }
        
        setFrequencyData({ labels: last7Days, data: counts });
    };

    const renderFrequencyChart = () => {
        if (chartInstance.current) {
            chartInstance.current.destroy();
        }
        
        const ctx = frequencyChartRef.current?.getContext('2d');
        if (ctx) {
            chartInstance.current = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: frequencyData.labels,
                    datasets: [{
                        label: 'Alerts',
                        data: frequencyData.data,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: '#667eea',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
    };

    const filterAlerts = () => {
        let filtered = alerts;
        
        if (filterType !== 'all') {
            filtered = filtered.filter(alert => alert.type === filterType);
        }
        
        if (filterPriority !== 'all') {
            filtered = filtered.filter(alert => alert.priority === filterPriority);
        }
        
        if (filterResolved === 'resolved') {
            filtered = filtered.filter(alert => alert.resolved);
        } else if (filterResolved === 'unresolved') {
            filtered = filtered.filter(alert => !alert.resolved);
        }
        
        if (searchQuery) {
            const query = searchQuery.toLowerCase();
            filtered = filtered.filter(alert =>
                alert.userName?.toLowerCase().includes(query) ||
                alert.message?.toLowerCase().includes(query) ||
                alert.type?.toLowerCase().includes(query)
            );
        }
        
        setFilteredAlerts(filtered);
        setCurrentPage(1);
    };

    const handleQuickResolve = async (alertId) => {
        try {
            await db.collection('alerts').doc(alertId).update({
                resolved: true,
                resolvedBy: user.uid,
                resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                resolutionNotes: 'Quick resolved'
            });
            
            setAlerts(prev => prev.map(a => 
                a.id === alertId ? { ...a, resolved: true, resolutionNotes: 'Quick resolved' } : a
            ));
        } catch (error) {
            console.error('Error quick resolving:', error);
            alert('Failed to resolve alert');
        }
    };

    const handleResolve = async (alertId, notes = '') => {
        try {
            await db.collection('alerts').doc(alertId).update({
                resolved: true,
                resolvedBy: user.uid,
                resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                resolutionNotes: notes
            });
            
            setAlerts(prev => prev.map(a => 
                a.id === alertId ? { ...a, resolved: true, resolutionNotes: notes } : a
            ));
            
            alert('Alert resolved successfully');
        } catch (error) {
            console.error('Error resolving alert:', error);
            alert('Failed to resolve alert');
        }
    };

    const handleDelete = async (alertId) => {
        if (!confirm('Are you sure you want to delete this alert?')) return;
        
        try {
            await db.collection('alerts').doc(alertId).delete();
            setAlerts(prev => prev.filter(a => a.id !== alertId));
            alert('Alert deleted');
        } catch (error) {
            console.error('Error deleting alert:', error);
            alert('Failed to delete alert');
        }
    };

    const getPriorityColor = (priority) => {
        if (priority === 'critical') return '#f44336';
        if (priority === 'high') return '#FF9800';
        if (priority === 'medium') return '#FFC107';
        return '#4CAF50';
    };

    const paginatedAlerts = useMemo(() => {
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        return filteredAlerts.slice(start, end);
    }, [filteredAlerts, currentPage]);

    const totalPages = Math.ceil(filteredAlerts.length / itemsPerPage);

    const handleExport = (format) => {
        const exportData = filteredAlerts.map(alert => ({
            user: alert.userName,
            type: alert.type,
            priority: alert.priority || 'Normal',
            message: alert.message,
            status: alert.resolved ? 'Resolved' : 'Active',
            createdAt: formatDateTime(alert.createdAt),
            resolvedAt: alert.resolvedAt ? formatDateTime(alert.resolvedAt) : 'N/A',
            resolutionNotes: alert.resolutionNotes || 'N/A'
        }));

        if (format === 'json') {
            exportToJSON(exportData, 'alerts');
        } else if (format === 'csv') {
            exportToCSV(exportData, 'alerts');
        } else if (format === 'pdf') {
            exportToPDF(exportData, 'Alerts Report');
        }
    };

    if (loading) {
        return (
            <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                minHeight: '400px',
                gap: '20px'
            }}>
                <div style={{
                    width: '60px',
                    height: '60px',
                    border: '4px solid #f3f3f3',
                    borderTop: '4px solid #667eea',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite'
                }}></div>
                <p style={{ color: '#666' }}>Loading alerts...</p>
            </div>
        );
    }

    return (
        <div style={{ padding: '20px', animation: 'fadeIn 0.5s' }}>
            {/* Stats Cards */}
            <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(240px, 1fr))',
                gap: '20px',
                marginBottom: '30px'
            }}>
                <div style={{
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(102, 126, 234, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Total Alerts</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.total}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>All time</div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(240, 147, 251, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Active Alerts</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.active}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Need attention</div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(79, 172, 254, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Avg Response Time</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.avgResponseTime}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Minutes</div>
                </div>

                <div style={{
                    background: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    borderRadius: '15px',
                    padding: '25px',
                    color: 'white',
                    boxShadow: '0 4px 15px rgba(250, 112, 154, 0.3)',
                    transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '14px', opacity: 0.9 }}>Critical Alerts</div>
                    <div style={{ fontSize: '42px', fontWeight: 'bold', margin: '10px 0' }}>
                        {stats.critical}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.8 }}>Active critical</div>
                </div>
            </div>

            {/* Alert Frequency Chart */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '25px',
                marginBottom: '30px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <h3 style={{ margin: '0 0 20px 0', color: '#333' }}>Alert Frequency - Last 7 Days</h3>
                <div style={{ height: '250px' }}>
                    <canvas ref={frequencyChartRef}></canvas>
                </div>
            </div>

            {/* SOS Alert Banner */}
            {filteredAlerts.filter(a => a.type === 'sos' && !a.resolved).length > 0 && (
                <div style={{
                    background: 'linear-gradient(135deg, #ff4444, #cc0000)',
                    padding: '20px',
                    borderRadius: '15px',
                    marginBottom: '20px',
                    animation: 'pulse 2s infinite',
                    boxShadow: '0 4px 15px rgba(255, 68, 68, 0.4)'
                }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '15px', color: 'white' }}>
                        <span style={{ fontSize: '32px' }}>🚨</span>
                        <div>
                            <div style={{ fontSize: '18px', fontWeight: 'bold', marginBottom: '5px' }}>
                                {filteredAlerts.filter(a => a.type === 'sos' && !a.resolved).length} Active SOS Alert(s)
                            </div>
                            <div style={{ fontSize: '14px', opacity: 0.9 }}>
                                Immediate attention required
                            </div>
                        </div>
                    </div>
                </div>
            )}
            
            {/* Filters and Actions Bar */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                marginBottom: '20px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', flexWrap: 'wrap', gap: '15px' }}>
                    <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                        <select 
                            value={filterType}
                            onChange={(e) => setFilterType(e.target.value)}
                            style={{
                                padding: '8px 12px',
                                borderRadius: '8px',
                                border: '1px solid #ddd',
                                background: 'white',
                                cursor: 'pointer',
                                fontSize: '14px'
                            }}
                        >
                            <option value="all">All Types</option>
                            <option value="sos">SOS Emergency</option>
                            <option value="missed_checkin">Missed Check-in</option>
                            <option value="low_mood">Low Mood</option>
                            <option value="high_craving">High Craving</option>
                            <option value="system">System Alert</option>
                        </select>
                        
                        <select 
                            value={filterPriority}
                            onChange={(e) => setFilterPriority(e.target.value)}
                            style={{
                                padding: '8px 12px',
                                borderRadius: '8px',
                                border: '1px solid #ddd',
                                background: 'white',
                                cursor: 'pointer',
                                fontSize: '14px'
                            }}
                        >
                            <option value="all">All Priorities</option>
                            <option value="critical">Critical</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                        
                        <select 
                            value={filterResolved}
                            onChange={(e) => setFilterResolved(e.target.value)}
                            style={{
                                padding: '8px 12px',
                                borderRadius: '8px',
                                border: '1px solid #ddd',
                                background: 'white',
                                cursor: 'pointer',
                                fontSize: '14px'
                            }}
                        >
                            <option value="all">All Status</option>
                            <option value="unresolved">Active</option>
                            <option value="resolved">Resolved</option>
                        </select>
                    </div>
                    
                    <div style={{ display: 'flex', gap: '10px' }}>
                        <button 
                            onClick={() => handleExport('csv')}
                            style={{
                                padding: '10px 16px',
                                background: '#6c757d',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: '500'
                            }}
                        >
                            Export CSV
                        </button>
                    </div>
                </div>
            </div>
            
            {/* Enhanced Table */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                overflow: 'hidden',
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
            }}>
                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                    <thead>
                        <tr style={{ background: '#f8f9fa', borderBottom: '2px solid #e9ecef' }}>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Priority</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>User</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Type</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Message</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Status</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Created</th>
                            <th style={{ padding: '15px', textAlign: 'left', fontWeight: '600', color: '#495057' }}>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {paginatedAlerts.map(alert => (
                            <tr key={alert.id} style={{
                                borderBottom: '1px solid #f0f0f0',
                                transition: 'all 0.2s',
                                background: alert.type === 'sos' && !alert.resolved ? 'rgba(244, 67, 54, 0.05)' : 'white',
                                borderLeft: `4px solid ${getPriorityColor(alert.priority || 'low')}`
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.background = '#f8f9fa';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.background = alert.type === 'sos' && !alert.resolved ? 'rgba(244, 67, 54, 0.05)' : 'white';
                            }}
                            >
                                <td style={{ padding: '15px' }}>
                                    <div style={{
                                        width: '12px',
                                        height: '12px',
                                        borderRadius: '50%',
                                        background: getPriorityColor(alert.priority || 'low')
                                    }}></div>
                                </td>
                                <td style={{ padding: '15px', fontWeight: '500', color: '#333' }}>
                                    {alert.userName}
                                </td>
                                <td style={{ padding: '15px' }}>
                                    <span style={{
                                        padding: '4px 12px',
                                        borderRadius: '20px',
                                        fontSize: '12px',
                                        fontWeight: '500',
                                        background: alert.type === 'sos' ? '#ffebee' : '#e3f2fd',
                                        color: alert.type === 'sos' ? '#c62828' : '#1565c0'
                                    }}>
                                        {alert.type === 'sos' ? '🚨 SOS' : alert.type?.replace('_', ' ')}
                                    </span>
                                </td>
                                <td style={{ padding: '15px', color: '#666', maxWidth: '200px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                    {alert.message}
                                </td>
                                <td style={{ padding: '15px' }}>
                                    <span style={{
                                        padding: '4px 12px',
                                        borderRadius: '20px',
                                        fontSize: '12px',
                                        fontWeight: '500',
                                        background: alert.resolved ? '#d4edda' : '#f8d7da',
                                        color: alert.resolved ? '#155724' : '#721c24'
                                    }}>
                                        {alert.resolved ? 'Resolved' : 'Active'}
                                    </span>
                                </td>
                                <td style={{ padding: '15px', color: '#666' }}>{formatTimeAgo(alert.createdAt)}</td>
                                <td style={{ padding: '15px' }}>
                                    <div style={{ display: 'flex', gap: '8px' }}>
                                        <button 
                                            onClick={() => setSelectedAlert(alert)}
                                            style={{
                                                padding: '6px 12px',
                                                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '6px',
                                                cursor: 'pointer',
                                                fontSize: '13px',
                                                fontWeight: '500'
                                            }}
                                        >
                                            View
                                        </button>
                                        {!alert.resolved && (
                                            <button 
                                                onClick={() => handleQuickResolve(alert.id)}
                                                style={{
                                                    padding: '6px 12px',
                                                    background: '#4CAF50',
                                                    color: 'white',
                                                    border: 'none',
                                                    borderRadius: '6px',
                                                    cursor: 'pointer',
                                                    fontSize: '13px',
                                                    fontWeight: '500'
                                                }}
                                            >
                                                Quick Resolve
                                            </button>
                                        )}
                                    </div>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
                
                {filteredAlerts.length === 0 && (
                    <div style={{
                        padding: '60px 20px',
                        textAlign: 'center',
                        color: '#999'
                    }}>
                        <div style={{ fontSize: '48px', marginBottom: '15px' }}>🔔</div>
                        <div style={{ fontSize: '18px', fontWeight: '500', marginBottom: '8px' }}>
                            No alerts found
                        </div>
                        <div style={{ fontSize: '14px' }}>
                            {searchQuery ? 'Try adjusting your search terms' : 'Alerts will appear here when triggered'}
                        </div>
                    </div>
                )}
            </div>
            
            {totalPages > 1 && (
                <div style={{ marginTop: '20px' }}>
                    <Pagination 
                        currentPage={currentPage}
                        totalPages={totalPages}
                        onPageChange={setCurrentPage}
                    />
                </div>
            )}
            
            {selectedAlert && (
                <AlertDetailModal 
                    alert={selectedAlert}
                    onClose={() => setSelectedAlert(null)}
                    onResolve={handleResolve}
                    getPriorityColor={getPriorityColor}
                />
            )}
        </div>
    );
}

// Enhanced Alert Detail Modal
function AlertDetailModal({ alert, onClose, onResolve, getPriorityColor }) {
    const [notes, setNotes] = useState(alert.resolutionNotes || '');
    const [submitting, setSubmitting] = useState(false);

    const handleSubmit = async () => {
        setSubmitting(true);
        await onResolve(alert.id, notes);
        setSubmitting(false);
        onClose();
    };

    return (
        <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000,
            padding: '20px',
            animation: 'fadeIn 0.2s'
        }}>
            <div style={{
                background: 'white',
                borderRadius: '20px',
                maxWidth: '700px',
                width: '100%',
                maxHeight: '90vh',
                overflow: 'auto',
                boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
                animation: 'slideUp 0.3s'
            }}>
                {/* Header */}
                <div style={{
                    background: alert.type === 'sos' 
                        ? 'linear-gradient(135deg, #f44336 0%, #e53935 100%)'
                        : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    padding: '25px 30px',
                    borderRadius: '20px 20px 0 0',
                    color: 'white',
                    position: 'sticky',
                    top: 0,
                    zIndex: 1
                }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <h2 style={{ margin: 0, fontSize: '24px' }}>
                            {alert.type === 'sos' ? '🚨 SOS Alert Details' : 'Alert Details'}
                        </h2>
                        <button 
                            onClick={onClose}
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                border: 'none',
                                color: 'white',
                                fontSize: '24px',
                                width: '36px',
                                height: '36px',
                                borderRadius: '50%',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                transition: 'background 0.2s'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.3)'}
                            onMouseLeave={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.2)'}
                        >
                            ×
                        </button>
                    </div>
                </div>

                {/* Content */}
                <div style={{ padding: '30px' }}>
                    {/* Info Grid */}
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(2, 1fr)',
                        gap: '20px',
                        marginBottom: '25px'
                    }}>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>User</div>
                            <div style={{ fontSize: '16px', fontWeight: '500', color: '#333' }}>
                                {alert.userName}
                            </div>
                        </div>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Type</div>
                            <div style={{ fontSize: '16px', fontWeight: '500', color: '#333' }}>
                                {alert.type?.replace('_', ' ')}
                            </div>
                        </div>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Priority</div>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                <div style={{
                                    width: '12px',
                                    height: '12px',
                                    borderRadius: '50%',
                                    background: getPriorityColor(alert.priority || 'low')
                                }}></div>
                                <span style={{ textTransform: 'capitalize' }}>{alert.priority || 'Low'}</span>
                            </div>
                        </div>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Status</div>
                            <span style={{
                                padding: '4px 12px',
                                borderRadius: '20px',
                                fontSize: '12px',
                                fontWeight: '500',
                                background: alert.resolved ? '#d4edda' : '#f8d7da',
                                color: alert.resolved ? '#155724' : '#721c24'
                            }}>
                                {alert.resolved ? 'Resolved' : 'Active'}
                            </span>
                        </div>
                        <div>
                            <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Created</div>
                            <div style={{ fontSize: '16px', fontWeight: '500', color: '#333' }}>
                                {formatDateTime(alert.createdAt)}
                            </div>
                        </div>
                        {alert.resolvedAt && (
                            <div>
                                <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px' }}>Resolved</div>
                                <div style={{ fontSize: '16px', fontWeight: '500', color: '#333' }}>
                                    {formatDateTime(alert.resolvedAt)}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Message */}
                    <div style={{ marginBottom: '25px' }}>
                        <div style={{ fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                            Message
                        </div>
                        <div style={{
                            padding: '15px',
                            background: '#f8f9fa',
                            borderRadius: '10px',
                            color: '#666',
                            lineHeight: '1.6',
                            whiteSpace: 'pre-wrap'
                        }}>
                            {alert.message || 'No message provided'}
                        </div>
                    </div>

                    {/* Resolution Notes Section */}
                    {!alert.resolved && (
                        <div style={{ marginBottom: '20px' }}>
                            <div style={{ fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                Resolution Notes
                            </div>
                            <textarea
                                value={notes}
                                onChange={(e) => setNotes(e.target.value)}
                                placeholder="Add resolution notes (optional)..."
                                style={{
                                    width: '100%',
                                    minHeight: '100px',
                                    padding: '15px',
                                    border: '2px solid #e0e0e0',
                                    borderRadius: '10px',
                                    fontSize: '14px',
                                    fontFamily: 'inherit',
                                    resize: 'vertical',
                                    transition: 'border-color 0.2s'
                                }}
                                onFocus={(e) => e.currentTarget.style.borderColor = '#667eea'}
                                onBlur={(e) => e.currentTarget.style.borderColor = '#e0e0e0'}
                            />
                        </div>
                    )}

                    {alert.resolutionNotes && alert.resolved && (
                        <div style={{ marginBottom: '20px' }}>
                            <div style={{ fontSize: '14px', fontWeight: '600', color: '#333', marginBottom: '8px' }}>
                                Resolution Notes
                            </div>
                            <div style={{
                                padding: '15px',
                                background: '#e8f5e9',
                                borderRadius: '10px',
                                color: '#2e7d32',
                                lineHeight: '1.6'
                            }}>
                                {alert.resolutionNotes}
                            </div>
                        </div>
                    )}

                    {/* Actions */}
                    {!alert.resolved && (
                        <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                            <button
                                onClick={onClose}
                                style={{
                                    padding: '12px 24px',
                                    background: '#6c757d',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500',
                                    transition: 'background 0.2s'
                                }}
                                onMouseEnter={(e) => e.currentTarget.style.background = '#5a6268'}
                                onMouseLeave={(e) => e.currentTarget.style.background = '#6c757d'}
                            >
                                Cancel
                            </button>
                            <button
                                onClick={handleSubmit}
                                disabled={submitting}
                                style={{
                                    padding: '12px 24px',
                                    background: submitting 
                                        ? '#ccc' 
                                        : 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: submitting ? 'not-allowed' : 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '500',
                                    transition: 'transform 0.2s'
                                }}
                                onMouseEnter={(e) => {
                                    if (!submitting) {
                                        e.currentTarget.style.transform = 'translateY(-2px)';
                                    }
                                }}
                                onMouseLeave={(e) => {
                                    e.currentTarget.style.transform = 'translateY(0)';
                                }}
                            >
                                {submitting ? 'Resolving...' : 'Resolve Alert'}
                            </button>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
}
        // FULLY FUNCTIONAL ReportsView
        function ReportsView({ user }) {
            const [reportType, setReportType] = useState('overview');
            const [startDate, setStartDate] = useState(() => {
                const date = new Date();
                date.setMonth(date.getMonth() - 1);
                return date.toISOString().split('T')[0];
            });
            const [endDate, setEndDate] = useState(() => {
                return new Date().toISOString().split('T')[0];
            });
            const [reportData, setReportData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [chartInstances, setChartInstances] = useState({});

            useEffect(() => {
                // Cleanup charts on unmount
                return () => {
                    Object.values(chartInstances).forEach(chart => {
                        if (chart) chart.destroy();
                    });
                };
            }, []);

            const generateReport = async () => {
                setLoading(true);
                try {
                    const start = new Date(startDate);
                    start.setHours(0, 0, 0, 0);
                    const end = new Date(endDate);
                    end.setHours(23, 59, 59, 999);
                    
                    let data = {};
                    
                    switch (reportType) {
                        case 'overview':
                            data = await generateOverviewReport(start, end);
                            break;
                        case 'checkins':
                            data = await generateCheckInsReport(start, end);
                            break;
                        case 'users':
                            data = await generateUsersReport(start, end);
                            break;
                        case 'assignments':
                            data = await generateAssignmentsReport(start, end);
                            break;
                        case 'alerts':
                            data = await generateAlertsReport(start, end);
                            break;
                        case 'groups':
                            data = await generateGroupsReport(start, end);
                            break;
                    }
                    
                    setReportData(data);
                    
                    // Render charts after data is set
                    setTimeout(() => renderCharts(data), 100);
                    
                } catch (error) {
                    console.error('Error generating report:', error);
                    alert('Failed to generate report');
                } finally {
                    setLoading(false);
                }
            };

            const generateOverviewReport = async (start, end) => {
                // Get all relevant data
                const [usersSnap, checkInsSnap, assignmentsSnap, alertsSnap, messagesSnap, groupsSnap] = await Promise.all([
                    db.collection('users').get(),
                    db.collection('checkIns')
                        .where('createdAt', '>=', start)
                        .where('createdAt', '<=', end)
                        .get(),
                    db.collection('assignments')
                        .where('createdAt', '>=', start)
                        .where('createdAt', '<=', end)
                        .get(),
                    db.collection('alerts')
                        .where('createdAt', '>=', start)
                        .where('createdAt', '<=', end)
                        .get(),
                    db.collection('messages')
                        .where('createdAt', '>=', start)
                        .where('createdAt', '<=', end)
                        .get(),
                    db.collection('groups').get()
                ]);
                
                const totalPirs = usersSnap.docs.filter(doc => doc.data().role === 'pir').length;
                const activePirs = usersSnap.docs.filter(doc => doc.data().role === 'pir' && doc.data().active !== false).length;
                const totalCoaches = usersSnap.docs.filter(doc => doc.data().role === 'coach').length;
                
                const checkIns = checkInsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const avgMood = checkIns.length > 0 ? 
                    (checkIns.reduce((sum, c) => sum + (c.mood || 0), 0) / checkIns.length).toFixed(1) : 0;
                const avgCravings = checkIns.length > 0 ? 
                    (checkIns.reduce((sum, c) => sum + (c.cravings || 0), 0) / checkIns.length).toFixed(1) : 0;
                
                const completedAssignments = assignmentsSnap.docs.filter(doc => doc.data().status === 'completed').length;
                const sosAlerts = alertsSnap.docs.filter(doc => doc.data().type === 'sos').length;
                const resolvedAlerts = alertsSnap.docs.filter(doc => doc.data().resolved).length;
                
                return {
                    summary: {
                        totalPirs,
                        activePirs,
                        totalCoaches,
                        totalCheckIns: checkInsSnap.size,
                        avgMood,
                        avgCravings,
                        totalAssignments: assignmentsSnap.size,
                        completedAssignments,
                        totalAlerts: alertsSnap.size,
                        sosAlerts,
                        resolvedAlerts,
                        totalMessages: messagesSnap.size,
                        totalGroups: groupsSnap.size
                    },
                    charts: {
                        dailyCheckIns: await getDailyCheckInCounts(start, end),
                        moodTrends: await getMoodTrends(start, end),
                        cravingTrends: await getCravingTrends(start, end)
                    }
                };
            };

            const generateCheckInsReport = async (start, end) => {
                const checkInsSnap = await db.collection('checkIns')
                    .where('createdAt', '>=', start)
                    .where('createdAt', '<=', end)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const checkIns = checkInsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const byUser = {};
                checkIns.forEach(checkIn => {
                    if (!byUser[checkIn.userId]) {
                        byUser[checkIn.userId] = {
                            count: 0,
                            totalMood: 0,
                            totalCravings: 0
                        };
                    }
                    byUser[checkIn.userId].count++;
                    byUser[checkIn.userId].totalMood += checkIn.mood || 0;
                    byUser[checkIn.userId].totalCravings += checkIn.cravings || 0;
                });
                
                const userStats = Object.entries(byUser).map(([userId, stats]) => ({
                    userId,
                    checkIns: stats.count,
                    avgMood: (stats.totalMood / stats.count).toFixed(1),
                    avgCravings: (stats.totalCravings / stats.count).toFixed(1)
                }));
                
                return {
                    total: checkIns.length,
                    userStats,
                    moodDistribution: getMoodDistribution(checkIns),
                    cravingDistribution: getCravingDistribution(checkIns),
                    dailyCounts: await getDailyCheckInCounts(start, end)
                };
            };

            const generateUsersReport = async (start, end) => {
                const usersSnap = await db.collection('users')
                    .where('createdAt', '>=', start)
                    .where('createdAt', '<=', end)
                    .get();
                
                const newUsers = usersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const byRole = {
                    pir: newUsers.filter(u => u.role === 'pir').length,
                    coach: newUsers.filter(u => u.role === 'coach').length,
                    admin: newUsers.filter(u => u.role === 'admin').length
                };
                
                const activeCount = newUsers.filter(u => u.active !== false).length;
                
                return {
                    newUsers: newUsers.length,
                    byRole,
                    activeCount,
                    inactiveCount: newUsers.length - activeCount,
                    userList: newUsers
                };
            };

            const generateAssignmentsReport = async (start, end) => {
                const assignmentsSnap = await db.collection('assignments')
                    .where('createdAt', '>=', start)
                    .where('createdAt', '<=', end)
                    .get();
                
                const assignments = assignmentsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const byStatus = {
                    pending: assignments.filter(a => a.status === 'pending').length,
                    in_progress: assignments.filter(a => a.status === 'in_progress').length,
                    completed: assignments.filter(a => a.status === 'completed').length
                };
                
                const overdueCount = assignments.filter(a => {
                    if (a.dueDate && a.status !== 'completed') {
                        const dueDate = a.dueDate.toDate ? a.dueDate.toDate() : new Date(a.dueDate);
                        return dueDate < new Date();
                    }
                    return false;
                }).length;
                
                return {
                    total: assignments.length,
                    byStatus,
                    overdueCount,
                    completionRate: assignments.length > 0 ? 
                        ((byStatus.completed / assignments.length) * 100).toFixed(1) : 0
                };
            };

            const generateAlertsReport = async (start, end) => {
                const alertsSnap = await db.collection('alerts')
                    .where('createdAt', '>=', start)
                    .where('createdAt', '<=', end)
                    .get();
                
                const alerts = alertsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const byType = {};
                const byPriority = {};
                
                alerts.forEach(alert => {
                    byType[alert.type] = (byType[alert.type] || 0) + 1;
                    byPriority[alert.priority || 'normal'] = (byPriority[alert.priority || 'normal'] || 0) + 1;
                });
                
                const resolved = alerts.filter(a => a.resolved).length;
                const avgResolutionTime = calculateAvgResolutionTime(alerts.filter(a => a.resolved));
                
                return {
                    total: alerts.length,
                    byType,
                    byPriority,
                    resolved,
                    unresolved: alerts.length - resolved,
                    avgResolutionTime
                };
            };

            const generateGroupsReport = async (start, end) => {
                const groupsSnap = await db.collection('groups').get();
                const groups = groupsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const totalMembers = groups.reduce((sum, g) => sum + (g.members?.length || 0), 0);
                const avgMembersPerGroup = groups.length > 0 ? (totalMembers / groups.length).toFixed(1) : 0;
                
                const byDay = {};
                groups.forEach(group => {
                    byDay[group.dayOfWeek] = (byDay[group.dayOfWeek] || 0) + 1;
                });
                
                return {
                    totalGroups: groups.length,
                    totalMembers,
                    avgMembersPerGroup,
                    byDay,
                    recurringGroups: groups.filter(g => g.recurring).length,
                    oneTimeGroups: groups.filter(g => !g.recurring).length
                };
            };

            const getDailyCheckInCounts = async (start, end) => {
                const dates = [];
                const counts = [];
                const current = new Date(start);
                
                while (current <= end) {
                    const dayStart = new Date(current);
                    dayStart.setHours(0, 0, 0, 0);
                    const dayEnd = new Date(current);
                    dayEnd.setHours(23, 59, 59, 999);
                    
                    const dayCheckIns = await db.collection('checkIns')
                        .where('createdAt', '>=', dayStart)
                        .where('createdAt', '<=', dayEnd)
                        .get();
                    
                    dates.push(current.toLocaleDateString());
                    counts.push(dayCheckIns.size);
                    
                    current.setDate(current.getDate() + 1);
                }
                
                return { dates, counts };
            };

            const getMoodTrends = async (start, end) => {
                const dates = [];
                const avgMoods = [];
                const current = new Date(start);
                
                while (current <= end) {
                    const dayStart = new Date(current);
                    dayStart.setHours(0, 0, 0, 0);
                    const dayEnd = new Date(current);
                    dayEnd.setHours(23, 59, 59, 999);
                    
                    const dayCheckIns = await db.collection('checkIns')
                        .where('createdAt', '>=', dayStart)
                        .where('createdAt', '<=', dayEnd)
                        .get();
                    
                    const moods = dayCheckIns.docs.map(doc => doc.data().mood || 0);
                    const avgMood = moods.length > 0 ? 
                        (moods.reduce((sum, m) => sum + m, 0) / moods.length).toFixed(1) : 0;
                    
                    dates.push(current.toLocaleDateString());
                    avgMoods.push(avgMood);
                    
                    current.setDate(current.getDate() + 1);
                }
                
                return { dates, avgMoods };
            };

            const getCravingTrends = async (start, end) => {
                const dates = [];
                const avgCravings = [];
                const current = new Date(start);
                
                while (current <= end) {
                    const dayStart = new Date(current);
                    dayStart.setHours(0, 0, 0, 0);
                    const dayEnd = new Date(current);
                    dayEnd.setHours(23, 59, 59, 999);
                    
                    const dayCheckIns = await db.collection('checkIns')
                        .where('createdAt', '>=', dayStart)
                        .where('createdAt', '<=', dayEnd)
                        .get();
                    
                    const cravings = dayCheckIns.docs.map(doc => doc.data().cravings || 0);
                    const avgCraving = cravings.length > 0 ? 
                        (cravings.reduce((sum, c) => sum + c, 0) / cravings.length).toFixed(1) : 0;
                    
                    dates.push(current.toLocaleDateString());
                    avgCravings.push(avgCraving);
                    
                    current.setDate(current.getDate() + 1);
                }
                
                return { dates, avgCravings };
            };

            const getMoodDistribution = (checkIns) => {
                const distribution = Array(10).fill(0);
                checkIns.forEach(c => {
                    if (c.mood >= 1 && c.mood <= 10) {
                        distribution[c.mood - 1]++;
                    }
                });
                return distribution;
            };

            const getCravingDistribution = (checkIns) => {
                const distribution = Array(10).fill(0);
                checkIns.forEach(c => {
                    if (c.cravings >= 1 && c.cravings <= 10) {
                        distribution[c.cravings - 1]++;
                    }
                });
                return distribution;
            };

            const calculateAvgResolutionTime = (resolvedAlerts) => {
                if (resolvedAlerts.length === 0) return 'N/A';
                
                const times = resolvedAlerts.map(alert => {
                    const created = alert.createdAt?.toDate ? alert.createdAt.toDate() : new Date(alert.createdAt);
                    const resolved = alert.resolvedAt?.toDate ? alert.resolvedAt.toDate() : new Date(alert.resolvedAt);
                    return resolved - created;
                });
                
                const avgTime = times.reduce((sum, t) => sum + t, 0) / times.length;
                const hours = Math.floor(avgTime / (1000 * 60 * 60));
                const minutes = Math.floor((avgTime % (1000 * 60 * 60)) / (1000 * 60));
                
                return `${hours}h ${minutes}m`;
            };

            const renderCharts = (data) => {
                // Clean up existing charts
                Object.values(chartInstances).forEach(chart => {
                    if (chart) chart.destroy();
                });
                
                const newCharts = {};
                
                // Render charts based on report type
                if (reportType === 'overview' && data.charts) {
                    // Daily Check-ins Chart
                    const checkInsCtx = document.getElementById('dailyCheckInsChart')?.getContext('2d');
                    if (checkInsCtx) {
                        newCharts.dailyCheckIns = new Chart(checkInsCtx, {
                            type: 'line',
                            data: {
                                labels: data.charts.dailyCheckIns.dates,
                                datasets: [{
                                    label: 'Daily Check-ins',
                                    data: data.charts.dailyCheckIns.counts,
                                    borderColor: '#f4c430',
                                    backgroundColor: 'rgba(244, 196, 48, 0.2)',
                                    tension: 0.1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                        ticks: { color: 'rgba(255, 255, 255, 0.7)' }
                                    },
                                    x: {
                                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                        ticks: { color: 'rgba(255, 255, 255, 0.7)' }
                                    }
                                },
                                plugins: {
                                    legend: {
                                        labels: { color: 'rgba(255, 255, 255, 0.9)' }
                                    }
                                }
                            }
                        });
                    }
                    
                    // Mood Trends Chart
                    const moodCtx = document.getElementById('moodTrendsChart')?.getContext('2d');
                    if (moodCtx) {
                        newCharts.moodTrends = new Chart(moodCtx, {
                            type: 'line',
                            data: {
                                labels: data.charts.moodTrends.dates,
                                datasets: [{
                                    label: 'Average Mood',
                                    data: data.charts.moodTrends.avgMoods,
                                    borderColor: '#4caf50',
                                    backgroundColor: 'rgba(76, 175, 80, 0.2)',
                                    tension: 0.1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 10,
                                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                        ticks: { color: 'rgba(255, 255, 255, 0.7)' }
                                    },
                                    x: {
                                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                        ticks: { color: 'rgba(255, 255, 255, 0.7)' }
                                    }
                                },
                                plugins: {
                                    legend: {
                                        labels: { color: 'rgba(255, 255, 255, 0.9)' }
                                    }
                                }
                            }
                        });
                    }
                }
                
                setChartInstances(newCharts);
            };

            const exportReport = (format) => {
                if (!reportData) {
                    alert('Please generate a report first');
                    return;
                }
                
                const fileName = `${reportType}_report_${startDate}_to_${endDate}`;
                
                if (format === 'json') {
                    exportToJSON(reportData, fileName);
                } else if (format === 'pdf') {
                    exportToPDF(reportData, `${reportType.charAt(0).toUpperCase() + reportType.slice(1)} Report`);
                }
            };

            return (
                <div>
                    <div className="filter-bar">
                        <div className="filter-group">
                            <label className="filter-label">Report Type</label>
                            <select 
                                className="filter-select"
                                value={reportType}
                                onChange={(e) => setReportType(e.target.value)}
                            >
                                <option value="overview">Overview Report</option>
                                <option value="checkins">Check-ins Report</option>
                                <option value="users">Users Report</option>
                                <option value="assignments">Assignments Report</option>
                                <option value="alerts">Alerts Report</option>
                                <option value="groups">Groups Report</option>
                            </select>
                        </div>
                        
                        <div className="date-range">
                            <div className="filter-group">
                                <label className="filter-label">Start Date</label>
                                <input 
                                    type="date"
                                    className="date-input"
                                    value={startDate}
                                    onChange={(e) => setStartDate(e.target.value)}
                                />
                            </div>
                            
                            <div className="filter-group">
                                <label className="filter-label">End Date</label>
                                <input 
                                    type="date"
                                    className="date-input"
                                    value={endDate}
                                    onChange={(e) => setEndDate(e.target.value)}
                                />
                            </div>
                        </div>
                        
                        <div style={{marginLeft: 'auto', display: 'flex', gap: '10px'}}>
                            <button 
                                className="btn btn-primary"
                                onClick={generateReport}
                                disabled={loading}
                            >
                                {loading ? 'Generating...' : 'Generate Report'}
                            </button>
                            {reportData && (
                                <>
                                    <button className="btn btn-secondary" onClick={() => exportReport('json')}>
                                        Export JSON
                                    </button>
                                    <button className="btn btn-secondary" onClick={() => exportReport('pdf')}>
                                        Export PDF
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                    
                    {loading && (
                        <div className="loading-container">
                            <div className="loading-spinner"></div>
                        </div>
                    )}
                    
                    {reportData && !loading && (
                        <div>
                            {reportType === 'overview' && (
                                <div>
                                    <div className="stats-grid">
                                        <div className="stat-card">
                                            <div className="stat-label">Total PIRs</div>
                                            <div className="stat-value">{reportData.summary.totalPirs}</div>
                                            <div className="stat-change">{reportData.summary.activePirs} active</div>
                                        </div>
                                        <div className="stat-card">
                                            <div className="stat-label">Total Coaches</div>
                                            <div className="stat-value">{reportData.summary.totalCoaches}</div>
                                        </div>
                                        <div className="stat-card">
                                            <div className="stat-label">Check-ins</div>
                                            <div className="stat-value">{reportData.summary.totalCheckIns}</div>
                                            <div className="stat-change">Avg Mood: {reportData.summary.avgMood}</div>
                                        </div>
                                        <div className="stat-card">
                                            <div className="stat-label">Assignments</div>
                                            <div className="stat-value">{reportData.summary.totalAssignments}</div>
                                            <div className="stat-change">{reportData.summary.completedAssignments} completed</div>
                                        </div>
                                        <div className="stat-card">
                                            <div className="stat-label">Alerts</div>
                                            <div className="stat-value">{reportData.summary.totalAlerts}</div>
                                            <div className="stat-change">{reportData.summary.sosAlerts} SOS</div>
                                        </div>
                                        <div className="stat-card">
                                            <div className="stat-label">Messages</div>
                                            <div className="stat-value">{reportData.summary.totalMessages}</div>
                                        </div>
                                    </div>
                                    
                                    <div className="chart-container" style={{marginTop: '30px'}}>
                                        <h3 style={{marginBottom: '20px'}}>Daily Check-ins</h3>
                                        <canvas id="dailyCheckInsChart"></canvas>
                                    </div>
                                    
                                    <div className="chart-container" style={{marginTop: '30px'}}>
                                        <h3 style={{marginBottom: '20px'}}>Mood Trends</h3>
                                        <canvas id="moodTrendsChart"></canvas>
                                    </div>
                                </div>
                            )}
                            
                            {reportType !== 'overview' && (
                                <div className="table-container">
                                    <h3 style={{marginBottom: '20px'}}>
                                        {reportType.charAt(0).toUpperCase() + reportType.slice(1)} Report Results
                                    </h3>
                                    <pre style={{
                                        background: 'rgba(255,255,255,0.05)',
                                        padding: '20px',
                                        borderRadius: '10px',
                                        overflow: 'auto'
                                    }}>
                                        {JSON.stringify(reportData, null, 2)}
                                    </pre>
                                </div>
                            )}
                        </div>
                    )}
                    
                    {!reportData && !loading && (
                        <div className="empty-state">
                            <div className="empty-state-icon">📈</div>
                            <div className="empty-state-text">Select report parameters and click Generate Report</div>
                        </div>
                    )}
                </div>
            );
        }

        // FULLY FUNCTIONAL SettingsView
        function SettingsView({ user }) {
            const [settings, setSettings] = useState({
                checkInReminder: true,
                checkInReminderTime: '09:00',
                sosNotifications: true,
                emailNotifications: false,
                smsNotifications: false,
                lowMoodThreshold: 3,
                highCravingThreshold: 7,
                autoArchiveMessages: 30,
                dataRetentionDays: 365,
                maintenanceMode: false
            });
            const [saving, setSaving] = useState(false);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                loadSettings();
            }, []);

            const loadSettings = async () => {
                try {
                    const settingsDoc = await db.collection('settings').doc('system').get();
                    if (settingsDoc.exists) {
                        setSettings(settingsDoc.data());
                    }
                } catch (error) {
                    console.error('Error loading settings:', error);
                } finally {
                    setLoading(false);
                }
            };

            const saveSettings = async () => {
                setSaving(true);
                try {
                    await db.collection('settings').doc('system').set({
                        ...settings,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: user.uid
                    });
                    alert('Settings saved successfully');
                } catch (error) {
                    console.error('Error saving settings:', error);
                    alert('Failed to save settings');
                } finally {
                    setSaving(false);
                }
            };

            const handleBackup = async () => {
                if (!confirm('This will create a full backup of all data. Continue?')) return;
                
                try {
                    const collections = ['users', 'checkIns', 'assignments', 'alerts', 'messages', 'groups', 'resources', 'feedback'];
                    const backup = {};
                    
                    for (const collection of collections) {
                        const snapshot = await db.collection(collection).get();
                        backup[collection] = [];
                        snapshot.forEach(doc => {
                            backup[collection].push({ id: doc.id, ...doc.data() });
                        });
                    }
                    
                    const fileName = `glrs_backup_${new Date().toISOString().split('T')[0]}`;
                    exportToJSON(backup, fileName);
                    alert('Backup created successfully');
                } catch (error) {
                    console.error('Error creating backup:', error);
                    alert('Failed to create backup');
                }
            };

            const handleCleanup = async (type) => {
                let message = '';
                let query;
                
                const cutoffDate = new Date();
                
                switch (type) {
                    case 'old_notifications':
                        cutoffDate.setDate(cutoffDate.getDate() - 30);
                        message = 'Delete notifications older than 30 days?';
                        query = db.collection('notifications')
                            .where('createdAt', '<', cutoffDate)
                            .where('read', '==', true);
                        break;
                    case 'old_messages':
                        cutoffDate.setDate(cutoffDate.getDate() - settings.autoArchiveMessages);
                        message = `Archive messages older than ${settings.autoArchiveMessages} days?`;
                        query = db.collection('messages')
                            .where('createdAt', '<', cutoffDate);
                        break;
                    case 'resolved_alerts':
                        cutoffDate.setDate(cutoffDate.getDate() - 90);
                        message = 'Delete resolved alerts older than 90 days?';
                        query = db.collection('alerts')
                            .where('resolved', '==', true)
                            .where('resolvedAt', '<', cutoffDate);
                        break;
                    default:
                        return;
                }
                
                if (!confirm(message)) return;
                
                try {
                    const snapshot = await query.get();
                    const batch = db.batch();
                    let count = 0;
                    
                    snapshot.forEach(doc => {
                        if (type === 'old_messages') {
                            // Archive instead of delete
                            batch.update(doc.ref, { archived: true });
                        } else {
                            batch.delete(doc.ref);
                        }
                        count++;
                        
                        // Firestore batch limit is 500
                        if (count % 500 === 0) {
                            batch.commit();
                            batch = db.batch();
                        }
                    });
                    
                    await batch.commit();
                    alert(`${count} items processed successfully`);
                } catch (error) {
                    console.error('Error during cleanup:', error);
                    alert('Cleanup failed: ' + error.message);
                }
            };

            const handleCheckMissedCheckIns = async () => {
                try {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    yesterday.setHours(0, 0, 0, 0);
                    
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    // Get all active PIRs
                    const pirsSnap = await db.collection('users')
                        .where('role', '==', 'pir')
                        .where('active', '==', true)
                        .get();
                    
                    const pirIds = pirsSnap.docs.map(doc => doc.id);
                    
                    // Get yesterday's check-ins
                    const checkInsSnap = await db.collection('checkIns')
                        .where('createdAt', '>=', yesterday)
                        .where('createdAt', '<', today)
                        .get();
                    
                    const checkedInUsers = new Set(checkInsSnap.docs.map(doc => doc.data().userId));
                    
                    const missedUsers = pirIds.filter(id => !checkedInUsers.has(id));
                    
                    // Create alerts for missed check-ins
                    const batch = db.batch();
                    missedUsers.forEach(userId => {
                        const alertRef = db.collection('alerts').doc();
                        batch.set(alertRef, {
                            type: 'missed_checkin',
                            userId: userId,
                            message: `Missed daily check-in on ${yesterday.toLocaleDateString()}`,
                            priority: 'medium',
                            resolved: false,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });
                    
                    await batch.commit();
                    alert(`${missedUsers.length} missed check-in alerts created`);
                } catch (error) {
                    console.error('Error checking missed check-ins:', error);
                    alert('Failed to check missed check-ins');
                }
            };

            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="loading-spinner"></div>
                    </div>
                );
            }

            return (
                <div>
                    <div className="table-container">
                        <h3 style={{marginBottom: '20px'}}>System Settings</h3>
                        
                        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px'}}>
                            <div className="form-group">
                                <label className="form-label">Check-in Reminder Time</label>
                                <input
                                    type="time"
                                    className="form-input"
                                    value={settings.checkInReminderTime}
                                    onChange={(e) => setSettings({...settings, checkInReminderTime: e.target.value})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Low Mood Threshold (1-10)</label>
                                <input
                                    type="number"
                                    className="form-input"
                                    min="1"
                                    max="10"
                                    value={settings.lowMoodThreshold}
                                    onChange={(e) => setSettings({...settings, lowMoodThreshold: parseInt(e.target.value)})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">High Craving Threshold (1-10)</label>
                                <input
                                    type="number"
                                    className="form-input"
                                    min="1"
                                    max="10"
                                    value={settings.highCravingThreshold}
                                    onChange={(e) => setSettings({...settings, highCravingThreshold: parseInt(e.target.value)})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Auto-archive Messages (days)</label>
                                <input
                                    type="number"
                                    className="form-input"
                                    min="7"
                                    max="365"
                                    value={settings.autoArchiveMessages}
                                    onChange={(e) => setSettings({...settings, autoArchiveMessages: parseInt(e.target.value)})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Data Retention (days)</label>
                                <input
                                    type="number"
                                    className="form-input"
                                    min="90"
                                    max="2555"
                                    value={settings.dataRetentionDays}
                                    onChange={(e) => setSettings({...settings, dataRetentionDays: parseInt(e.target.value)})}
                                />
                            </div>
                        </div>
                        
                        <div style={{marginTop: '20px'}}>
                            <h4 style={{marginBottom: '15px'}}>Notification Settings</h4>
                            
                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="checkInReminder"
                                    checked={settings.checkInReminder}
                                    onChange={(e) => setSettings({...settings, checkInReminder: e.target.checked})}
                                />
                                <label htmlFor="checkInReminder">Enable Check-in Reminders</label>
                            </div>
                            
                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="sosNotifications"
                                    checked={settings.sosNotifications}
                                    onChange={(e) => setSettings({...settings, sosNotifications: e.target.checked})}
                                />
                                <label htmlFor="sosNotifications">Enable SOS Notifications</label>
                            </div>
                            
                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="emailNotifications"
                                    checked={settings.emailNotifications}
                                    onChange={(e) => setSettings({...settings, emailNotifications: e.target.checked})}
                                />
                                <label htmlFor="emailNotifications">Enable Email Notifications</label>
                            </div>
                            
                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="smsNotifications"
                                    checked={settings.smsNotifications}
                                    onChange={(e) => setSettings({...settings, smsNotifications: e.target.checked})}
                                />
                                <label htmlFor="smsNotifications">Enable SMS Notifications</label>
                            </div>
                            
                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="maintenanceMode"
                                    checked={settings.maintenanceMode}
                                    onChange={(e) => setSettings({...settings, maintenanceMode: e.target.checked})}
                                />
                                <label htmlFor="maintenanceMode">Maintenance Mode (PIRs see maintenance message)</label>
                            </div>
                        </div>
                        
                        <button 
                            className="btn btn-primary"
                            onClick={saveSettings}
                            disabled={saving}
                            style={{marginTop: '20px'}}
                        >
                            {saving ? 'Saving...' : 'Save Settings'}
                        </button>
                    </div>
                    
                    <div className="table-container" style={{marginTop: '30px'}}>
                        <h3 style={{marginBottom: '20px'}}>System Actions</h3>
                        
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '20px'}}>
                            <div>
                                <h4>Data Management</h4>
                                <button 
                                    className="btn btn-secondary"
                                    onClick={handleBackup}
                                    style={{width: '100%', marginTop: '10px'}}
                                >
                                    🗄️ Create Full Backup
                                </button>
                                <button 
                                    className="btn btn-secondary"
                                    onClick={() => handleCleanup('old_notifications')}
                                    style={{width: '100%', marginTop: '10px'}}
                                >
                                    🧹 Clean Old Notifications
                                </button>
                                <button 
                                    className="btn btn-secondary"
                                    onClick={() => handleCleanup('old_messages')}
                                    style={{width: '100%', marginTop: '10px'}}
                                >
                                    📧 Archive Old Messages
                                </button>
                                <button 
                                    className="btn btn-secondary"
                                    onClick={() => handleCleanup('resolved_alerts')}
                                    style={{width: '100%', marginTop: '10px'}}
                                >
                                    🚨 Clean Resolved Alerts
                                </button>
                            </div>
                            
                            <div>
                                <h4>Monitoring</h4>
                                <button 
                                    className="btn btn-secondary"
                                    onClick={handleCheckMissedCheckIns}
                                    style={{width: '100%', marginTop: '10px'}}
                                >
                                    ✅ Check Missed Check-ins
                                </button>
                                <button 
                                    className="btn btn-secondary"
                                    onClick={async () => {
                                        const stats = await db.collection('users').get();
                                        alert(`Database Statistics:\n\nTotal Users: ${stats.size}\nEstimated Storage: ${(stats.size * 5 / 1024).toFixed(2)} MB`);
                                    }}
                                    style={{width: '100%', marginTop: '10px'}}
                                >
                                    📊 Database Statistics
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div className="table-container" style={{marginTop: '30px'}}>
                        <h3 style={{marginBottom: '20px'}}>System Information</h3>
                        <table>
                            <tbody>
                                <tr>
                                    <td><strong>Firebase Project:</strong></td>
                                    <td>glrs-pir-system</td>
                                </tr>
                                <tr>
                                    <td><strong>Environment:</strong></td>
                                    <td>Production</td>
                                </tr>
                                <tr>
                                    <td><strong>Version:</strong></td>
                                    <td>3.0.0</td>
                                </tr>
                                <tr>
                                    <td><strong>Last Settings Update:</strong></td>
                                    <td>{settings.updatedAt ? formatDateTime(settings.updatedAt) : 'Never'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Browser:</strong></td>
                                    <td>{navigator.userAgent}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // Modal Components
        function CreateUserModal({ onClose, onSuccess, coaches }) {
            const [formData, setFormData] = useState({
                email: '',
                password: 'TempPassword123!',
                firstName: '',
                lastName: '',
                role: 'pir',
                assignedCoach: '',
                phone: ''
            });
            const [coachesList, setCoachesList] = useState([]);
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                loadCoaches();
            }, []);

            const loadCoaches = async () => {
                const coachesSnap = await db.collection('users')
                    .where('role', '==', 'coach')
                    .get();
                
                const coachesData = [];
                coachesSnap.forEach(doc => {
                    coachesData.push({ id: doc.id, ...doc.data() });
                });
                setCoachesList(coachesData);
            };

            const validateEmail = (email) => {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                if (!validateEmail(formData.email)) {
                    alert('Please enter a valid email address');
                    return;
                }
                
                setLoading(true);
                
                let secondaryApp;
                try {
                    // Clean up any existing secondary app
                    try {
                        secondaryApp = firebase.app('SecondaryApp');
                        await secondaryApp.delete();
                    } catch (e) {
                        // App doesn't exist
                    }
                    
                    // Create new secondary app
                    secondaryApp = firebase.initializeApp(firebaseConfig, 'SecondaryApp');
                    const secondaryAuth = secondaryApp.auth();
                    
                    // Create auth user
                    const userCredential = await secondaryAuth.createUserWithEmailAndPassword(
                        formData.email,
                        formData.password
                    );
                    
                    // Prepare user data
                    const userData = {
                        email: formData.email,
                        displayName: `${formData.firstName} ${formData.lastName}`,
                        firstName: formData.firstName,
                        lastName: formData.lastName,
                        phone: formData.phone,
                        role: formData.role,
                        active: true,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    // Add coach assignment if PIR
                    if (formData.role === 'pir' && formData.assignedCoach) {
                        userData.assignedCoach = formData.assignedCoach;
                        // Also denormalize coach name for performance
                        const coach = coachesList.find(c => c.id === formData.assignedCoach);
                        if (coach) {
                            userData.assignedCoachName = coach.displayName || coach.email;
                        }
                    }
                    
                    // Create Firestore profile
                    await db.collection('users').doc(userCredential.user.uid).set(userData);
                    
                    // Send password reset email
                    await auth.sendPasswordResetEmail(formData.email);
                    
                    // Create notification
                    await db.collection('notifications').add({
                        type: 'user-created',
                        message: `New ${formData.role} created: ${userData.displayName}`,
                        recipientId: auth.currentUser.uid,
                        relatedId: userCredential.user.uid,
                        read: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Clean up secondary app
                    await secondaryApp.delete();
                    
                    alert('User created successfully! Password reset email sent.');
                    onSuccess();
                } catch (error) {
                    console.error('Error creating user:', error);
                    alert('Error creating user: ' + error.message);
                    
                    // Clean up on error
                    if (secondaryApp) {
                        try {
                            await secondaryApp.delete();
                        } catch (e) {
                            // Ignore
                        }
                    }
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">Create New User</div>
                            <button className="modal-close" onClick={onClose}>×</button>
                        </div>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Email *</label>
                                <input
                                    type="email"
                                    className="form-input"
                                    value={formData.email}
                                    onChange={(e) => setFormData({...formData, email: e.target.value})}
                                    required
                                />
                            </div>
                            
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px'}}>
                                <div className="form-group">
                                    <label className="form-label">First Name *</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={formData.firstName}
                                        onChange={(e) => setFormData({...formData, firstName: e.target.value})}
                                        required
                                    />
                                </div>
                                
                                <div className="form-group">
                                    <label className="form-label">Last Name *</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={formData.lastName}
                                        onChange={(e) => setFormData({...formData, lastName: e.target.value})}
                                        required
                                    />
                                </div>
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Phone</label>
                                <input
                                    type="tel"
                                    className="form-input"
                                    value={formData.phone}
                                    onChange={(e) => setFormData({...formData, phone: e.target.value})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Role *</label>
                                <select 
                                    className="form-input"
                                    value={formData.role}
                                    onChange={(e) => setFormData({...formData, role: e.target.value})}
                                    required
                                >
                                    <option value="pir">PIR</option>
                                    <option value="coach">Coach</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                            
                            {formData.role === 'pir' && (
                                <div className="form-group">
                                    <label className="form-label">Assigned Coach</label>
                                    <select 
                                        className="form-input"
                                        value={formData.assignedCoach}
                                        onChange={(e) => setFormData({...formData, assignedCoach: e.target.value})}
                                    >
                                        <option value="">Select Coach</option>
                                        {coachesList.map(coach => (
                                            <option key={coach.id} value={coach.id}>
                                                {coach.displayName || coach.email}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            )}
                            
                            <div style={{display: 'flex', gap: '10px', marginTop: '20px'}}>
                                <button 
                                    type="submit"
                                    className="btn btn-primary"
                                    disabled={loading}
                                >
                                    {loading ? 'Creating...' : 'Create User'}
                                </button>
                                <button 
                                    type="button"
                                    className="btn btn-secondary"
                                    onClick={onClose}
                                >
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // Additional Modal Components
        function CheckInDetailModal({ checkIn, onClose }) {
            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">Check-in Details</div>
                            <button className="modal-close" onClick={onClose}>×</button>
                        </div>
                        
                        <div style={{marginBottom: '20px'}}>
                            <strong>User:</strong> {checkIn.userName}<br />
                            <strong>Date/Time:</strong> {formatDateTime(checkIn.createdAt)}
                        </div>
                        
                        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px', marginBottom: '20px'}}>
                            <div>
                                <strong>Mood:</strong>
                                <div className="mood-scale" style={{marginTop: '10px'}}>
                                    <div className={`mood-circle mood-${checkIn.mood}`} style={{width: '40px', height: '40px', fontSize: '18px'}}>
                                        {checkIn.mood}
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <strong>Cravings:</strong>
                                <div className="mood-scale" style={{marginTop: '10px'}}>
                                    <div className={`mood-circle mood-${11 - checkIn.cravings}`} style={{width: '40px', height: '40px', fontSize: '18px'}}>
                                        {checkIn.cravings}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {checkIn.gratitude && (
                            <div style={{marginBottom: '20px'}}>
                                <strong>Gratitude:</strong>
                                <p style={{marginTop: '10px', padding: '15px', background: 'rgba(255,255,255,0.05)', borderRadius: '10px'}}>
                                    {checkIn.gratitude}
                                </p>
                            </div>
                        )}
                        
                        {checkIn.notes && (
                            <div style={{marginBottom: '20px'}}>
                                <strong>Notes:</strong>
                                <p style={{marginTop: '10px', padding: '15px', background: 'rgba(255,255,255,0.05)', borderRadius: '10px'}}>
                                    {checkIn.notes}
                                </p>
                            </div>
                        )}
                        
                        <button className="btn btn-secondary" onClick={onClose}>Close</button>
                    </div>
                </div>
            );
        }

        function CreateAssignmentModal({ onClose, onSuccess, users, createdBy }) {
            const [formData, setFormData] = useState({
                title: '',
                description: '',
                userId: '',
                dueDate: '',
                priority: 'medium',
                status: 'pending'
            });
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                
                try {
                    await db.collection('assignments').add({
                        ...formData,
                        createdBy: createdBy,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    alert('Assignment created successfully!');
                    onSuccess();
                } catch (error) {
                    console.error('Error creating assignment:', error);
                    alert('Failed to create assignment');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">Create Assignment</div>
                            <button className="modal-close" onClick={onClose}>×</button>
                        </div>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Title *</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    value={formData.title}
                                    onChange={(e) => setFormData({...formData, title: e.target.value})}
                                    required
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Description *</label>
                                <textarea
                                    className="form-input"
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                    required
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Assign To *</label>
                                <select 
                                    className="form-input"
                                    value={formData.userId}
                                    onChange={(e) => setFormData({...formData, userId: e.target.value})}
                                    required
                                >
                                    <option value="">Select PIR</option>
                                    {users.map(user => (
                                        <option key={user.id} value={user.id}>
                                            {user.displayName || user.email}
                                        </option>
                                    ))}
                                </select>
                            </div>
                            
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px'}}>
                                <div className="form-group">
                                    <label className="form-label">Due Date</label>
                                    <input
                                        type="date"
                                        className="form-input"
                                        value={formData.dueDate}
                                        onChange={(e) => setFormData({...formData, dueDate: e.target.value})}
                                    />
                                </div>
                                
                                <div className="form-group">
                                    <label className="form-label">Priority</label>
                                    <select 
                                        className="form-input"
                                        value={formData.priority}
                                        onChange={(e) => setFormData({...formData, priority: e.target.value})}
                                    >
                                        <option value="low">Low</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style={{display: 'flex', gap: '10px', marginTop: '20px'}}>
                                <button 
                                    type="submit"
                                    className="btn btn-primary"
                                    disabled={loading}
                                >
                                    {loading ? 'Creating...' : 'Create Assignment'}
                                </button>
                                <button 
                                    type="button"
                                    className="btn btn-secondary"
                                    onClick={onClose}
                                >
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

       

        function FeedbackDetailModal({ feedback, onClose, onRespond, onMarkReviewed }) {
            const [response, setResponse] = useState(feedback.response || '');
            const [responding, setResponding] = useState(false);

            const handleRespond = async () => {
                setResponding(true);
                await onRespond(feedback.id, response);
                setResponding(false);
                onClose();
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">Feedback Details</div>
                            <button className="modal-close" onClick={onClose}>×</button>
                        </div>
                        
                        <div style={{marginBottom: '20px'}}>
                            <strong>From:</strong> {feedback.userName}<br />
                            <strong>Type:</strong> {feedback.type}<br />
                            <strong>Subject:</strong> {feedback.subject}<br />
                            {feedback.rating && <><strong>Rating:</strong> {feedback.rating}/5<br /></>}
                            <strong>Date:</strong> {formatDateTime(feedback.createdAt)}
                        </div>
                        
                        <div style={{marginBottom: '20px', padding: '15px', background: 'rgba(255,255,255,0.05)', borderRadius: '10px'}}>
                            <strong>Message:</strong><br />
                            {feedback.message}
                        </div>
                        
                        {feedback.response && (
                            <div style={{marginBottom: '20px', padding: '15px', background: 'rgba(76,175,80,0.1)', borderRadius: '10px'}}>
                                <strong>Response:</strong><br />
                                {feedback.response}
                            </div>
                        )}
                        
                        {!feedback.response && (
                            <>
                                <div className="form-group">
                                    <label className="form-label">Your Response</label>
                                    <textarea
                                        className="form-input"
                                        value={response}
                                        onChange={(e) => setResponse(e.target.value)}
                                        rows="4"
                                    />
                                </div>
                                
                                <button 
                                    className="btn btn-primary"
                                    onClick={handleRespond}
                                    disabled={!response.trim() || responding}
                                >
                                    {responding ? 'Sending...' : 'Send Response'}
                                </button>
                            </>
                        )}
                        
                        {!feedback.reviewed && (
                            <button 
                                className="btn btn-secondary"
                                onClick={() => {
                                    onMarkReviewed(feedback.id);
                                    onClose();
                                }}
                                style={{marginLeft: '10px'}}
                            >
                                Mark as Reviewed
                            </button>
                        )}
                    </div>
                </div>
            );
        }

        function AlertDetailModal({ alert, onClose, onResolve }) {
            const [notes, setNotes] = useState('');
            const [resolving, setResolving] = useState(false);

            const handleResolve = async () => {
                setResolving(true);
                await onResolve(alert.id, notes);
                setResolving(false);
                onClose();
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">
                                {alert.type === 'sos' ? '🚨 SOS ALERT' : 'Alert Details'}
                            </div>
                            <button className="modal-close" onClick={onClose}>×</button>
                        </div>
                        
                        <div style={{marginBottom: '20px'}}>
                            <strong>User:</strong> {alert.userName}<br />
                            <strong>Type:</strong> {alert.type}<br />
                            <strong>Priority:</strong> {alert.priority || 'Normal'}<br />
                            <strong>Created:</strong> {formatDateTime(alert.createdAt)}<br />
                            <strong>Status:</strong> {alert.resolved ? 'Resolved' : 'Active'}
                        </div>
                        
                        <div style={{marginBottom: '20px', padding: '15px', background: 'rgba(255,255,255,0.05)', borderRadius: '10px'}}>
                            <strong>Message:</strong><br />
                            {alert.message}
                        </div>
                        
                        {alert.resolved && alert.resolutionNotes && (
                            <div style={{marginBottom: '20px', padding: '15px', background: 'rgba(76,175,80,0.1)', borderRadius: '10px'}}>
                                <strong>Resolution Notes:</strong><br />
                                {alert.resolutionNotes}<br />
                                <small>Resolved at: {formatDateTime(alert.resolvedAt)}</small>
                            </div>
                        )}
                        
                        {!alert.resolved && (
                            <>
                                <div className="form-group">
                                    <label className="form-label">Resolution Notes (optional)</label>
                                    <textarea
                                        className="form-input"
                                        value={notes}
                                        onChange={(e) => setNotes(e.target.value)}
                                        rows="3"
                                    />
                                </div>
                                
                                <button 
                                    className="btn btn-success"
                                    onClick={handleResolve}
                                    disabled={resolving}
                                >
                                    {resolving ? 'Resolving...' : 'Mark as Resolved'}
                                </button>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        // Other existing modals remain the same...

        // Pagination Component
        function Pagination({ currentPage, totalPages, onPageChange }) {
            return (
                <div className="pagination">
                    <button 
                        className="page-btn"
                        onClick={() => onPageChange(currentPage - 1)}
                        disabled={currentPage === 1}
                    >
                        Previous
                    </button>
                    
                    {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                        let pageNum;
                        if (totalPages <= 5) {
                            pageNum = i + 1;
                        } else if (currentPage <= 3) {
                            pageNum = i + 1;
                        } else if (currentPage >= totalPages - 2) {
                            pageNum = totalPages - 4 + i;
                        } else {
                            pageNum = currentPage - 2 + i;
                        }
                        
                        return (
                            <button
                                key={pageNum}
                                className={`page-btn ${currentPage === pageNum ? 'active' : ''}`}
                                onClick={() => onPageChange(pageNum)}
                            >
                                {pageNum}
                            </button>
                        );
                    })}
                    
                    <button 
                        className="page-btn"
                        onClick={() => onPageChange(currentPage + 1)}
                        disabled={currentPage === totalPages}
                    >
                        Next
                    </button>
                </div>
            );
        }

// Complete Enhanced PIR Detail View Component - All Fixes Applied
function UserDetailModal({ user, onClose, onUpdate }) {
    // Extract ID from user object
    const pirId = user?.id;
    
    // Core States
    const [pirData, setPirData] = useState(null);
    const [loading, setLoading] = useState(true);
    const [activeTab, setActiveTab] = useState('overview');
    
    // Data States
    const [activities, setActivities] = useState([]);
    const [checkIns, setCheckIns] = useState([]);
    const [assignments, setAssignments] = useState([]);
    const [goals, setGoals] = useState([]);
    const [objectives, setObjectives] = useState([]);
    const [alerts, setAlerts] = useState([]);
    const [meetings, setMeetings] = useState([]);
    const [resources, setResources] = useState([]);
    const [milestones, setMilestones] = useState([]);
    const [messages, setMessages] = useState([]);
    const [supportGroups, setSupportGroups] = useState([]);
    const [pledges, setPledges] = useState([]);
    const [notifications, setNotifications] = useState([]);
    const [topicRooms, setTopicRooms] = useState([]);
    const [resourceProgress, setResourceProgress] = useState({});
    const [resourceNotes, setResourceNotes] = useState({});
    const [streakData, setStreakData] = useState({});
    const [complianceData, setComplianceData] = useState({});
    const [allMessages, setAllMessages] = useState([]);
    
    // UI States
    const [editing, setEditing] = useState(false);
    const [editData, setEditData] = useState({});
    const [chartData, setChartData] = useState(null);
    const [expandedGoals, setExpandedGoals] = useState({});
    const [showAddGoal, setShowAddGoal] = useState(false);
    const [showAddObjective, setShowAddObjective] = useState(false);
    const [showAddAssignment, setShowAddAssignment] = useState(false);
    const [selectedGoalId, setSelectedGoalId] = useState(null);
    const [selectedObjectiveId, setSelectedObjectiveId] = useState(null);
    const [showAssignResource, setShowAssignResource] = useState(false);
    const [showCreateResource, setShowCreateResource] = useState(false);

     // Golden Thread specific states - ADD THESE THREE
    const [showGoldenThread, setShowGoldenThread] = useState(false);
    const [selectedGoalForObjective, setSelectedGoalForObjective] = useState(null);
    const [selectedObjectiveForAssignment, setSelectedObjectiveForAssignment] = useState(null);
    
    
    // Chart refs
    const moodChartRef = useRef(null);
    const cravingChartRef = useRef(null);
    const anxietyChartRef = useRef(null);
    const sleepChartRef = useRef(null);

    useEffect(() => {
        if (pirId) {
            loadCompletePIRData();
        }
    }, [pirId]);

    const loadCompletePIRData = async () => {
        try {
            setLoading(true);
            
            // Load main user data
            const userDoc = await db.collection('users').doc(pirId).get();
            if (!userDoc.exists) {
                alert('PIR not found');
                onClose();
                return;
            }
            
            const userData = { id: userDoc.id, ...userDoc.data() };
            
            // Fix timezone issues for dates
            userData.sobrietyDays = calculateSobrietyDaysFixed(userData.sobrietyDate);
            userData.accountAge = daysSince(userData.createdAt);
            
            // Get last login from auth or user doc
            userData.lastLoginFormatted = await getLastLoginFormatted(pirId, userData);
            userData.firstLoginFormatted = formatFirstLogin(userData.createdAt);
            userData.moneySaved = userData.sobrietyDays * (userData.dailyCost || 20);
            
            setPirData(userData);
            setEditData(userData);
            
            // Load all related data in parallel
            await Promise.all([
                loadActivitiesData(),
                loadCheckInsData(),
                loadAssignmentsData(),
                loadGoalsData(),
                loadObjectivesData(),
                loadAlertsData(),
                loadMeetingsData(),
                loadResourcesData(),
                loadMilestonesData(),
                loadMessagesData(),
                loadAllUserMessages(),
                loadSupportGroupsData(),
                loadPledgesData(),
                loadNotificationsData(),
                loadTopicRoomsData(),
                loadResourceProgressData(),
                loadStreakData(),
                loadComplianceDataFixed(userData.createdAt),
                loadProgressChartData()
            ]);
            
        } catch (error) {
            console.error('Error loading PIR data:', error);
            alert('Failed to load PIR data: ' + error.message);
        } finally {
            setLoading(false);
        }
    };

   const calculateSobrietyDaysFixed = (sobrietyDate) => {
    if (!sobrietyDate) return 0;
    
    let sobriety;
    
    // Handle string dates more carefully
    if (typeof sobrietyDate === 'string') {
        // For YYYY-MM-DD format, parse components directly to avoid timezone issues
        if (sobrietyDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
            const [year, month, day] = sobrietyDate.split('-').map(Number);
            sobriety = new Date(year, month - 1, day); // month is 0-indexed
        } else {
            sobriety = new Date(sobrietyDate);
        }
    } else if (sobrietyDate.toDate) {
        sobriety = sobrietyDate.toDate();
    } else if (sobrietyDate.seconds) {
        sobriety = new Date(sobrietyDate.seconds * 1000);
    } else {
        sobriety = new Date(sobrietyDate);
    }
    
    // Set to midnight
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    sobriety.setHours(0, 0, 0, 0);
    
    // Calculate difference
    const diffTime = today.getTime() - sobriety.getTime();
    const days = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 2;
    
    return days >= 0 ? days : 0;
};

    const getLastLoginFormatted = async (userId, userData) => {
        try {
            // Try to get from user document first
            if (userData.lastLogin) {
                const lastLogin = userData.lastLogin.toDate ? userData.lastLogin.toDate() : new Date(userData.lastLogin);
                return lastLogin.toLocaleString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric',
                    hour: 'numeric', 
                    minute: '2-digit', 
                    hour12: true 
                });
            }
            
            // Check activities for last login
            const loginActivity = await db.collection('activities')
                .where('userId', '==', userId)
                .where('type', '==', 'login')
                .orderBy('createdAt', 'desc')
                .limit(1)
                .get();
            
            if (!loginActivity.empty) {
                const lastLogin = loginActivity.docs[0].data().createdAt.toDate();
                return lastLogin.toLocaleString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric',
                    hour: 'numeric', 
                    minute: '2-digit', 
                    hour12: true 
                });
            }
            
            return 'No login recorded';
        } catch (error) {
            console.error('Error getting last login:', error);
            return 'Unable to determine';
        }
    };


    const formatFirstLogin = (createdAt) => {
        if (!createdAt) return 'Unknown';
        const date = createdAt.toDate ? createdAt.toDate() : new Date(createdAt);
        return date.toLocaleString('en-US', { 
            month: 'short', 
            day: 'numeric', 
            year: 'numeric'
        });
    };

    // Fixed compliance calculation function
const loadComplianceDataFixed = async (accountCreatedAt) => {
    try {
        // Calculate days since account creation
        const accountDate = accountCreatedAt?.toDate ? accountCreatedAt.toDate() : new Date(accountCreatedAt);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        accountDate.setHours(0, 0, 0, 0);
        
        const daysSinceCreation = Math.floor((today - accountDate) / (1000 * 60 * 60 * 24));
        const daysToCheck = Math.min(daysSinceCreation, 30); // Max 30 days
        
        if (daysToCheck <= 0) {
            setComplianceData({
                morningRate: 0,
                eveningRate: 0,
                assignmentRate: 0,
                totalCheckIns: 0,
                daysTracked: 0,
                recentCheckIns: []
            });
            return;
        }
        
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - daysToCheck);
        startDate.setHours(0, 0, 0, 0);
        
        // Get ALL check-ins for display
        const allCheckInsSnap = await db.collection('checkIns')
            .where('userId', '==', pirId)
            .orderBy('createdAt', 'desc')
            .get();
        
        // Get check-ins for compliance calculation (last 30 days max)
        const complianceCheckInsSnap = await db.collection('checkIns')
            .where('userId', '==', pirId)
            .where('createdAt', '>=', startDate)
            .get();
        
        // Process all check-ins for display
        const allCheckInsData = [];
        allCheckInsSnap.forEach(doc => {
            const data = doc.data();
            allCheckInsData.push({
                id: doc.id,
                ...data,
                date: data.createdAt?.toDate ? data.createdAt.toDate() : new Date(data.createdAt)
            });
        });
        
        // Calculate compliance metrics
        let morningCount = 0;
        let eveningCount = 0;
        const dateMap = new Map();
        
        complianceCheckInsSnap.forEach(doc => {
            const data = doc.data();
            const checkInDate = data.createdAt?.toDate ? data.createdAt.toDate() : new Date(data.createdAt);
            const dateKey = checkInDate.toDateString();
            
            if (!dateMap.has(dateKey)) {
                dateMap.set(dateKey, { morning: false, evening: false });
            }
            
            if (data.morningData && !dateMap.get(dateKey).morning) {
                morningCount++;
                dateMap.get(dateKey).morning = true;
            }
            if (data.eveningData && !dateMap.get(dateKey).evening) {
                eveningCount++;
                dateMap.get(dateKey).evening = true;
            }
        });
        
        // Calculate assignment compliance
        const completedAssignments = assignments.filter(a => a.status === 'completed').length;
        const totalAssignments = assignments.length;
        
        // Cap percentages at 100%
        const morningRate = Math.min(100, Math.round((morningCount / daysToCheck) * 100));
        const eveningRate = Math.min(100, Math.round((eveningCount / daysToCheck) * 100));
        const assignmentRate = totalAssignments > 0 ? 
            Math.min(100, Math.round((completedAssignments / totalAssignments) * 100)) : 0;
        
        setComplianceData({
            morningRate,
            eveningRate,
            assignmentRate,
            totalCheckIns: morningCount + eveningCount,
            daysTracked: daysToCheck,
            recentCheckIns: allCheckInsData // Store all check-ins for display
        });
        
        // Also update the checkIns state for the table
        setCheckIns(allCheckInsData);
        
    } catch (error) {
        console.error('Error calculating compliance:', error);
        setComplianceData({
            morningRate: 0,
            eveningRate: 0,
            assignmentRate: 0,
            totalCheckIns: 0,
            daysTracked: 0,
            recentCheckIns: []
        });
    }
};

    

    // Fixed milestones loading
    const loadMilestonesData = async () => {
        try {
            const milestonesList = [];
            
            // Try to load custom milestones
            try {
                const milestonesSnap = await db.collection('milestones')
                    .where('userId', '==', pirId)
                    .get();
                
                milestonesSnap.forEach(doc => {
                    milestonesList.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.error('Error loading custom milestones:', error);
            }
            
            // Add standard recovery milestones based on sobriety date
            if (pirData?.sobrietyDate) {
                const standardMilestones = getStandardMilestones(pirData.sobrietyDate);
                milestonesList.push(...standardMilestones);
            }
            
            setMilestones(milestonesList);
        } catch (error) {
            console.error('Error loading milestones:', error);
            setMilestones([]);
        }
    };

    const getStandardMilestones = (sobrietyDate) => {
        const milestones = [
            { days: 1, title: '24 Hours', icon: '🌅', description: 'First day of recovery' },
            { days: 7, title: 'One Week', icon: '📅', description: 'A week of sobriety' },
            { days: 30, title: 'One Month', icon: '📆', description: 'First month milestone' },
            { days: 60, title: 'Two Months', icon: '📅', description: 'Two months strong' },
            { days: 90, title: 'Three Months', icon: '🏆', description: 'Quarter year achieved' },
            { days: 180, title: 'Six Months', icon: '⭐', description: 'Half year milestone' },
            { days: 365, title: 'One Year', icon: '🎉', description: 'Full year of recovery' },
            { days: 730, title: 'Two Years', icon: '🎊', description: 'Two years of sobriety' }
        ];
        
        const sobrietyDateObj = sobrietyDate?.toDate ? sobrietyDate.toDate() : new Date(sobrietyDate);
        const today = new Date();
        
        return milestones.map(m => {
            const targetDate = new Date(sobrietyDateObj);
            targetDate.setDate(targetDate.getDate() + m.days);
            const achieved = today >= targetDate;
            const daysUntil = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
            
            return {
                ...m,
                targetDate,
                achieved,
                daysUntil: achieved ? 0 : daysUntil,
                type: 'standard',
                id: `standard-${m.days}`
            };
        });
    };

    // Add Goal function
    const handleAddGoal = async (goalData) => {
        try {
            await db.collection('goals').add({
                ...goalData,
                userId: pirId,
                createdBy: user.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await loadGoalsData();
            setShowAddGoal(false);
            alert('Goal added successfully');
        } catch (error) {
            console.error('Error adding goal:', error);
            alert('Failed to add goal');
        }
    };

    // Assign Resource function
    const handleAssignResource = async (resourceId) => {
        try {
            const resourceDoc = await db.collection('resources').doc(resourceId).get();
            const resourceData = resourceDoc.data();
            
            const currentAssigned = resourceData.assignedTo || [];
            if (!currentAssigned.includes(pirId)) {
                await db.collection('resources').doc(resourceId).update({
                    assignedTo: firebase.firestore.FieldValue.arrayUnion(pirId)
                });
                
                await loadResourcesData();
                alert('Resource assigned successfully');
            } else {
                alert('Resource already assigned to this PIR');
            }
        } catch (error) {
            console.error('Error assigning resource:', error);
            alert('Failed to assign resource');
        }
    };

    // All other data loading functions remain the same...
    const loadActivitiesData = async () => {
        try {
            const activitiesSnap = await db.collection('activities')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .limit(100)
                .get();
            
            const activitiesList = [];
            activitiesSnap.forEach(doc => {
                activitiesList.push({ id: doc.id, ...doc.data() });
            });
            setActivities(activitiesList);
        } catch (error) {
            console.error('Error loading activities:', error);
            setActivities([]);
        }
    };

    const loadCheckInsData = async () => {
        try {
            const checkInsSnap = await db.collection('checkIns')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .limit(60)
                .get();
            
            const checkInsList = [];
            checkInsSnap.forEach(doc => {
                checkInsList.push({ id: doc.id, ...doc.data() });
            });
            setCheckIns(checkInsList);
        } catch (error) {
            console.error('Error loading check-ins:', error);
            setCheckIns([]);
        }
    };

    const loadAssignmentsData = async () => {
        try {
            const assignmentsSnap = await db.collection('assignments')
                .where('userId', '==', pirId)
                .get();
            
            const assignmentsList = [];
            assignmentsSnap.forEach(doc => {
                assignmentsList.push({ id: doc.id, ...doc.data() });
            });
            setAssignments(assignmentsList);
        } catch (error) {
            console.error('Error loading assignments:', error);
            setAssignments([]);
        }
    };

    const loadGoalsData = async () => {
        try {
            const goalsSnap = await db.collection('goals')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .get();
            
            const goalsList = [];
            for (const doc of goalsSnap.docs) {
                const goalData = { id: doc.id, ...doc.data() };
                goalData.progress = await calculateGoalProgress(doc.id);
                goalsList.push(goalData);
            }
            setGoals(goalsList);
        } catch (error) {
            console.error('Error loading goals:', error);
            setGoals([]);
        }
    };

    const loadObjectivesData = async () => {
        try {
            const objectivesSnap = await db.collection('objectives')
                .where('userId', '==', pirId)
                .orderBy('order', 'asc')
                .get();
            
            const objectivesList = [];
            objectivesSnap.forEach(doc => {
                objectivesList.push({ id: doc.id, ...doc.data() });
            });
            setObjectives(objectivesList);
        } catch (error) {
            console.error('Error loading objectives:', error);
            setObjectives([]);
        }
    };

    const loadAlertsData = async () => {
        try {
            const alertsSnap = await db.collection('alerts')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .limit(50)
                .get();
            
            const alertsList = [];
            alertsSnap.forEach(doc => {
                alertsList.push({ id: doc.id, ...doc.data() });
            });
            setAlerts(alertsList);
        } catch (error) {
            console.error('Error loading alerts:', error);
            setAlerts([]);
        }
    };

    const loadMeetingsData = async () => {
        try {
            const meetingsSnap = await db.collection('meetings')
                .where('pirId', '==', pirId)
                .orderBy('scheduledTime', 'desc')
                .get();
            
            const meetingsList = [];
            meetingsSnap.forEach(doc => {
                meetingsList.push({ id: doc.id, ...doc.data() });
            });
            setMeetings(meetingsList);
        } catch (error) {
            console.error('Error loading meetings:', error);
            setMeetings([]);
        }
    };

    const loadResourcesData = async () => {
        try {
            // Try multiple approaches to load resources
            const resourcesList = [];
            
            // Try loading with array-contains
            try {
                const assignedResources = await db.collection('resources')
                    .where('assignedTo', 'array-contains', pirId)
                    .get();
                
                assignedResources.forEach(doc => {
                    resourcesList.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.log('Array-contains query failed, trying alternative');
            }
            
            // Also load global resources
            try {
                const globalResources = await db.collection('resources')
                    .where('isGlobal', '==', true)
                    .get();
                
                globalResources.forEach(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    if (!resourcesList.find(r => r.id === doc.id)) {
                        resourcesList.push(data);
                    }
                });
            } catch (error) {
                console.log('Global resources query failed');
            }
            
            setResources(resourcesList);
        } catch (error) {
            console.error('Error loading resources:', error);
            setResources([]);
        }
    };

    const loadMessagesData = async () => {
        try {
            const messagesSnap = await db.collection('messages')
                .where('senderId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .limit(50)
                .get();
            
            const messagesList = [];
            messagesSnap.forEach(doc => {
                messagesList.push({ id: doc.id, ...doc.data() });
            });
            setMessages(messagesList);
        } catch (error) {
            console.error('Error loading messages:', error);
            setMessages([]);
        }
    };

    const loadSupportGroupsData = async () => {
        try {
            const supportGroupsSnap = await db.collection('supportGroups')
                .where('active', '==', true)
                .get();
            
            const supportGroupsList = [];
            supportGroupsSnap.forEach(doc => {
                supportGroupsList.push({ id: doc.id, ...doc.data() });
            });
            setSupportGroups(supportGroupsList);
        } catch (error) {
            console.error('Error loading support groups:', error);
            setSupportGroups([]);
        }
    };

    const loadPledgesData = async () => {
        try {
            const pledgesSnap = await db.collection('pledges')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .limit(30)
                .get();
            
            const pledgesList = [];
            pledgesSnap.forEach(doc => {
                pledgesList.push({ id: doc.id, ...doc.data() });
            });
            setPledges(pledgesList);
        } catch (error) {
            console.error('Error loading pledges:', error);
            setPledges([]);
        }
    };

    const loadNotificationsData = async () => {
        try {
            const notificationsSnap = await db.collection('notifications')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .limit(50)
                .get();
            
            const notificationsList = [];
            notificationsSnap.forEach(doc => {
                notificationsList.push({ id: doc.id, ...doc.data() });
            });
            setNotifications(notificationsList);
        } catch (error) {
            console.error('Error loading notifications:', error);
            setNotifications([]);
        }
    };

    const loadTopicRoomsData = async () => {
        try {
            const topicRoomsSnap = await db.collection('topicRooms')
                .get();
            
            const topicRoomsList = [];
            topicRoomsSnap.forEach(doc => {
                topicRoomsList.push({ id: doc.id, ...doc.data() });
            });
            setTopicRooms(topicRoomsList);
        } catch (error) {
            console.error('Error loading topic rooms:', error);
            setTopicRooms([]);
        }
    };

    const loadResourceProgressData = async () => {
        try {
            const progressDoc = await db.collection('users').doc(pirId)
                .collection('resourcePreferences').doc('progress').get();
            
            if (progressDoc.exists) {
                setResourceProgress(progressDoc.data() || {});
            }
            
            const notesDoc = await db.collection('users').doc(pirId)
                .collection('resourcePreferences').doc('notes').get();
            
            if (notesDoc.exists) {
                setResourceNotes(notesDoc.data() || {});
            }
        } catch (error) {
            console.error('Error loading resource progress:', error);
        }
    };

    const loadStreakData = async () => {
        try {
            const streakDoc = await db.collection('streaks').doc(pirId).get();
            if (streakDoc.exists) {
                setStreakData(streakDoc.data());
            }
        } catch (error) {
            console.error('Error loading streak data:', error);
        }
    };

    const loadProgressChartData = async () => {
        try {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const checkInsSnap = await db.collection('checkIns')
                .where('userId', '==', pirId)
                .where('createdAt', '>=', thirtyDaysAgo)
                .orderBy('createdAt', 'asc')
                .get();
            
            const chartLabels = [];
            const moodData = [];
            const cravingData = [];
            const anxietyData = [];
            const sleepData = [];
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                chartLabels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                
                let dayCheckIn = null;
                checkInsSnap.forEach(doc => {
                    const checkInDate = doc.data().createdAt?.toDate() || new Date(doc.data().createdAt);
                    if (checkInDate.toDateString() === date.toDateString()) {
                        dayCheckIn = doc.data();
                    }
                });
                
                moodData.push(dayCheckIn?.morningData?.mood ?? null);
                cravingData.push(dayCheckIn?.morningData?.craving ?? null);
                anxietyData.push(dayCheckIn?.morningData?.anxietyLevel ?? null);
                sleepData.push(dayCheckIn?.morningData?.sleepQuality ?? null);
            }
            
            setChartData({
                labels: chartLabels,
                mood: moodData,
                craving: cravingData,
                anxiety: anxietyData,
                sleep: sleepData
            });
        } catch (error) {
            console.error('Error loading chart data:', error);
        }
    };

    // Utility functions
    const daysSince = (date) => {
        if (!date) return 0;
        const start = date?.toDate ? date.toDate() : new Date(date);
        const today = new Date();
        const diffTime = Math.abs(today - start);
        return Math.floor(diffTime / (1000 * 60 * 60 * 24));
    };

    const formatTimeAgo = (date) => {
        if (!date) return 'Never';
        const d = date?.toDate ? date.toDate() : new Date(date);
        const now = new Date();
        const diff = Math.floor((now - d) / 1000);
        
        if (diff < 60) return 'Just now';
        if (diff < 3600) return Math.floor(diff / 60) + ' minutes ago';
        if (diff < 86400) return Math.floor(diff / 3600) + ' hours ago';
        if (diff < 604800) return Math.floor(diff / 86400) + ' days ago';
        return d.toLocaleDateString();
    };

    // Also fix the formatDate function to display dates correctly
const formatDate = (date) => {
    if (!date) return 'N/A';
    
    let d;
    
    // Handle Firestore Timestamp
    if (date?.toDate) {
        d = date.toDate();
    }
    // Handle timestamp object with seconds
    else if (date?.seconds) {
        d = new Date(date.seconds * 1000);
    }
    // Handle string
    else if (typeof date === 'string') {
        // Add timezone handling for date strings
        if (!date.includes('T')) {
            d = new Date(date + 'T00:00:00');
        } else {
            d = new Date(date);
        }
    }
    // Handle Date object
    else {
        d = new Date(date);
    }
    
    // Format as locale date string
    return d.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
};

    const formatDateTime = (date) => {
        if (!date) return 'N/A';
        const d = date?.toDate ? date.toDate() : new Date(date);
        return d.toLocaleString();
    };

    const calculateGoalProgress = async (goalId) => {
        const goalAssignments = assignments.filter(a => a.goalId === goalId);
        const completed = goalAssignments.filter(a => a.status === 'completed').length;
        return goalAssignments.length > 0 ? Math.round((completed / goalAssignments.length) * 100) : 0;
    };

    const getActivityIcon = (type) => {
        const icons = {
            'check_in': '✅',
            'assignment_completed': '📝',
            'goal_completed': '🎯',
            'objective_completed': '🎯',
            'message_sent': '💬',
            'sos_triggered': '🚨',
            'login': '🔑',
            'profile_updated': '👤',
            'pledge_completed': '🤝',
            'resource_viewed': '📚',
            'milestone_achieved': '🏆',
            'streak_update': '🔥'
        };
        return icons[type] || '📌';
    };

    const getActivityColor = (type) => {
        const colors = {
            'check_in': '#4CAF50',
            'assignment_completed': '#2196F3',
            'goal_completed': '#FF9800',
            'message_sent': '#9C27B0',
            'sos_triggered': '#F44336',
            'login': '#607D8B',
            'profile_updated': '#795548'
        };
        return colors[type] || '#9E9E9E';
    };

    // Chart rendering
    useEffect(() => {
        if (chartData && activeTab === 'progress') {
            setTimeout(() => {
                renderCharts();
            }, 100);
        }
    }, [chartData, activeTab]);

    const renderCharts = () => {
        const chartConfig = {
            type: 'line',
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 10,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true
                    },
                    tooltip: {
                        enabled: true
                    }
                }
            }
        };

        // Destroy existing charts
        if (moodChartRef.current) moodChartRef.current.destroy();
        if (cravingChartRef.current) cravingChartRef.current.destroy();
        if (anxietyChartRef.current) anxietyChartRef.current.destroy();
        if (sleepChartRef.current) sleepChartRef.current.destroy();

        // Create new charts
        const moodCanvas = document.getElementById(`mood-chart-${pirId}`);
        if (moodCanvas) {
            moodChartRef.current = new Chart(moodCanvas, {
                ...chartConfig,
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Mood',
                        data: chartData.mood,
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4,
                        spanGaps: true
                    }]
                }
            });
        }

        const cravingCanvas = document.getElementById(`craving-chart-${pirId}`);
        if (cravingCanvas) {
            cravingChartRef.current = new Chart(cravingCanvas, {
                ...chartConfig,
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Craving',
                        data: chartData.craving,
                        borderColor: '#ff9800',
                        backgroundColor: 'rgba(255, 152, 0, 0.1)',
                        tension: 0.4,
                        spanGaps: true
                    }]
                }
            });
        }

        const anxietyCanvas = document.getElementById(`anxiety-chart-${pirId}`);
        if (anxietyCanvas) {
            anxietyChartRef.current = new Chart(anxietyCanvas, {
                ...chartConfig,
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Anxiety',
                        data: chartData.anxiety,
                        borderColor: '#f44336',
                        backgroundColor: 'rgba(244, 67, 54, 0.1)',
                        tension: 0.4,
                        spanGaps: true
                    }]
                }
            });
        }

        const sleepCanvas = document.getElementById(`sleep-chart-${pirId}`);
        if (sleepCanvas) {
            sleepChartRef.current = new Chart(sleepCanvas, {
                ...chartConfig,
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Sleep Quality',
                        data: chartData.sleep,
                        borderColor: '#9c27b0',
                        backgroundColor: 'rgba(156, 39, 176, 0.1)',
                        tension: 0.4,
                        spanGaps: true
                    }]
                }
            });
        }
    };

    // Save profile
    const handleSaveProfile = async () => {
        try {
            await db.collection('users').doc(pirId).update({
                ...editData,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await db.collection('activities').add({
                userId: pirId,
                type: 'profile_updated',
                description: 'Profile information updated',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            setPirData(editData);
            setEditing(false);
            alert('Profile updated successfully');
            if (onUpdate) onUpdate();
        } catch (error) {
            console.error('Error updating profile:', error);
            alert('Failed to update profile');
        }
    };
     // Fixed loadAllUserMessages function - add this to your load functions
const loadAllUserMessages = async () => {
    try {
        const messagesData = [];
        
        // Get direct messages where user is the sender
        try {
            const directMessages = await db.collection('messages')
                .where('senderId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .get();
            
            directMessages.forEach(doc => {
                messagesData.push({ 
                    id: doc.id, 
                    ...doc.data(), 
                    type: 'direct' 
                });
            });
        } catch (error) {
            console.log('Error loading direct messages:', error);
        }
        
        // Also get direct messages where user is the recipient
        try {
            const receivedMessages = await db.collection('messages')
                .where('userId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .get();
            
            receivedMessages.forEach(doc => {
                const data = doc.data();
                if (data.senderId === pirId) {  // Only include if they sent it
                    messagesData.push({ 
                        id: doc.id, 
                        ...data, 
                        type: 'direct' 
                    });
                }
            });
        } catch (error) {
            console.log('Error loading received messages:', error);
        }
        
        // Get community messages (if collection exists)
        try {
            const communityMessages = await db.collection('glrsChat')
                .where('senderId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .limit(50)
                .get();
            
            communityMessages.forEach(doc => {
                messagesData.push({ 
                    id: doc.id, 
                    ...doc.data(), 
                    type: 'community' 
                });
            });
        } catch (error) {
            console.log('Community chat collection may not exist:', error);
        }
        
        // Get topic room messages
        try {
            const topicMessages = await db.collection('topicRoomMessages')
                .where('senderId', '==', pirId)
                .orderBy('createdAt', 'desc')
                .limit(50)
                .get();
            
            topicMessages.forEach(doc => {
                messagesData.push({ 
                    id: doc.id, 
                    ...doc.data(), 
                    type: 'topic' 
                });
            });
        } catch (error) {
            console.log('Topic room messages may not exist:', error);
        }
        
        // Sort all messages by date
        messagesData.sort((a, b) => {
            const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
            const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
            return dateB - dateA;
        });
        
        setAllMessages(messagesData);
        console.log(`Loaded ${messagesData.length} total messages for PIR`);
        
    } catch (error) {
        console.error('Error loading user messages:', error);
        setAllMessages([]);
    }
};

    // Delete message function
    const handleDeleteMessage = async (messageId, messageType) => {
        if (!confirm('Are you sure you want to delete this message?')) return;
        
        try {
            let collection = 'messages';
            if (messageType === 'community') collection = 'glrsChat';
            if (messageType === 'topic') collection = 'topicRoomMessages';
            
            await db.collection(collection).doc(messageId).delete();
            
            // Flag content for moderation record
            await db.collection('flaggedContent').add({
                originalCollection: collection,
                originalId: messageId,
                userId: pirId,
                flaggedBy: user.uid,
                reason: 'Deleted by coach',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await loadAllUserMessages();
            alert('Message deleted and flagged');
        } catch (error) {
            console.error('Error deleting message:', error);
            alert('Failed to delete message');
        }
    };

  const renderOverviewTab = () => (
    <div style={{ padding: '20px' }}>
        {/* Key Metrics Cards */}
        <div style={{ 
            display: 'grid', 
            gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
            gap: '20px',
            marginBottom: '30px'
        }}>
            <div style={{
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                padding: '20px',
                borderRadius: '15px',
                color: 'white',
                boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
            }}>
                <div style={{ fontSize: '14px', opacity: 0.9 }}>Sobriety Days</div>
                <div style={{ fontSize: '36px', fontWeight: 'bold' }}>
                    {pirData.sobrietyDays}
                </div>
                <div style={{ fontSize: '12px', opacity: 0.8 }}>
                    Since {formatDate(pirData.sobrietyDate)}
                </div>
            </div>

            <div style={{
                background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                padding: '20px',
                borderRadius: '15px',
                color: 'white',
                boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
            }}>
                <div style={{ fontSize: '14px', opacity: 0.9 }}>Current Streak</div>
                <div style={{ fontSize: '36px', fontWeight: 'bold' }}>
                    {streakData.currentStreak || 0} 🔥
                </div>
                <div style={{ fontSize: '12px', opacity: 0.8 }}>
                    Best: {streakData.longestStreak || 0} days
                </div>
            </div>

            <div style={{
                background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                padding: '20px',
                borderRadius: '15px',
                color: 'white',
                boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
            }}>
                <div style={{ fontSize: '14px', opacity: 0.9 }}>Last Login</div>
                <div style={{ fontSize: '16px', fontWeight: 'bold' }}>
                    {pirData.lastLoginFormatted}
                </div>
                <div style={{ fontSize: '12px', opacity: 0.8 }}>
                    Account age: {pirData.accountAge} days
                </div>
            </div>

            <div style={{
                background: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                padding: '20px',
                borderRadius: '15px',
                color: 'white',
                boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
            }}>
                <div style={{ fontSize: '14px', opacity: 0.9 }}>Money Saved</div>
                <div style={{ fontSize: '36px', fontWeight: 'bold' }}>
                    ${pirData.moneySaved}
                </div>
                <div style={{ fontSize: '12px', opacity: 0.8 }}>
                    ${pirData.dailyCost || 20}/day saved
                </div>
            </div>
        </div>
        
        {/* Profile Information */}
        <div style={{
            background: 'white',
            borderRadius: '15px',
            padding: '25px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
            marginBottom: '20px'
        }}>
            <div style={{ 
                display: 'flex', 
                justifyContent: 'space-between', 
                alignItems: 'center',
                marginBottom: '20px'
            }}>
                <h3 style={{ margin: 0, color: '#333' }}>Profile Information</h3>
                {!editing ? (
                    <button 
                        className="btn btn-secondary"
                        onClick={() => setEditing(true)}
                    >
                        Edit Profile
                    </button>
                ) : (
                    <div style={{ display: 'flex', gap: '10px' }}>
                        <button 
                            className="btn btn-primary"
                            onClick={handleSaveProfile}
                        >
                            Save Changes
                        </button>
                        <button 
                            className="btn btn-secondary"
                            onClick={() => {
                                setEditing(false);
                                setEditData(pirData);
                            }}
                        >
                            Cancel
                        </button>
                    </div>
                )}
            </div>

            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
                <div>
                    <label style={{ fontWeight: 'bold', color: '#666' }}>Full Name</label>
                    {editing ? (
                        <div style={{ display: 'flex', gap: '10px' }}>
                            <input
                                type="text"
                                value={editData.firstName || ''}
                                onChange={(e) => setEditData({...editData, firstName: e.target.value})}
                                style={{ flex: 1, padding: '8px', borderRadius: '5px', border: '1px solid #ddd' }}
                            />
                            <input
                                type="text"
                                value={editData.lastName || ''}
                                onChange={(e) => setEditData({...editData, lastName: e.target.value})}
                                style={{ flex: 1, padding: '8px', borderRadius: '5px', border: '1px solid #ddd' }}
                            />
                        </div>
                    ) : (
                        <p style={{ color: '#333' }}>{pirData.firstName} {pirData.lastName}</p>
                    )}
                </div>

                <div>
                    <label style={{ fontWeight: 'bold', color: '#666' }}>Email</label>
                    <p style={{ color: '#333' }}>{pirData.email}</p>
                </div>

                <div>
                    <label style={{ fontWeight: 'bold', color: '#666' }}>Phone</label>
                    {editing ? (
                        <input
                            type="tel"
                            value={editData.phone || ''}
                            onChange={(e) => setEditData({...editData, phone: e.target.value})}
                            style={{ width: '100%', padding: '8px', borderRadius: '5px', border: '1px solid #ddd' }}
                        />
                    ) : (
                        <p style={{ color: '#333' }}>{pirData.phone || 'Not provided'}</p>
                    )}
                </div>

                <div>
                    <label style={{ fontWeight: 'bold', color: '#666' }}>Date of Birth</label>
                    {editing ? (
                        <input
                            type="date"
                            value={editData.dateOfBirth || ''}
                            onChange={(e) => setEditData({...editData, dateOfBirth: e.target.value})}
                            style={{ width: '100%', padding: '8px', borderRadius: '5px', border: '1px solid #ddd' }}
                        />
                    ) : (
                        <p style={{ color: '#333' }}>{pirData.dateOfBirth || 'Not provided'}</p>
                    )}
                </div>

                <div>
                    <label style={{ fontWeight: 'bold', color: '#666' }}>Sobriety Date</label>
                    {editing ? (
                        <input
                            type="date"
                            value={editData.sobrietyDate || ''}
                            onChange={(e) => setEditData({...editData, sobrietyDate: e.target.value})}
                            style={{ width: '100%', padding: '8px', borderRadius: '5px', border: '1px solid #ddd' }}
                        />
                    ) : (
                        <p style={{ color: '#333' }}>{formatDate(pirData.sobrietyDate)}</p>
                    )}
                </div>

                <div>
                    <label style={{ fontWeight: 'bold', color: '#666' }}>Substance</label>
                    <p style={{ color: '#333' }}>{pirData.substance || 'Not specified'}</p>
                </div>

                <div style={{ gridColumn: 'span 2' }}>
                    <label style={{ fontWeight: 'bold', color: '#666' }}>Address</label>
                    {editing ? (
                        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr 1fr', gap: '10px' }}>
                            <input
                                type="text"
                                value={editData.address?.street || ''}
                                onChange={(e) => setEditData({
                                    ...editData, 
                                    address: {...editData.address, street: e.target.value}
                                })}
                                placeholder="Street Address"
                                style={{ padding: '8px', borderRadius: '5px', border: '1px solid #ddd' }}
                            />
                            <input
                                type="text"
                                value={editData.address?.city || ''}
                                onChange={(e) => setEditData({
                                    ...editData, 
                                    address: {...editData.address, city: e.target.value}
                                })}
                                placeholder="City"
                                style={{ padding: '8px', borderRadius: '5px', border: '1px solid #ddd' }}
                            />
                            <input
                                type="text"
                                value={editData.address?.state || ''}
                                onChange={(e) => setEditData({
                                    ...editData, 
                                    address: {...editData.address, state: e.target.value}
                                })}
                                placeholder="State"
                                style={{ padding: '8px', borderRadius: '5px', border: '1px solid #ddd' }}
                            />
                            <input
                                type="text"
                                value={editData.address?.zip || ''}
                                onChange={(e) => setEditData({
                                    ...editData, 
                                    address: {...editData.address, zip: e.target.value}
                                })}
                                placeholder="ZIP"
                                style={{ padding: '8px', borderRadius: '5px', border: '1px solid #ddd' }}
                            />
                        </div>
                    ) : (
                        <p style={{ color: '#333' }}>
                            {pirData.address ? 
                                `${pirData.address.street || ''} ${pirData.address.city || ''}, ${pirData.address.state || ''} ${pirData.address.zip || ''}`.trim() : 
                                'Not provided'}
                        </p>
                    )}
                </div>
            </div>
        </div>

        {/* Emergency Contacts */}
        <div style={{
            background: 'white',
            borderRadius: '15px',
            padding: '25px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
            marginBottom: '20px'
        }}>
            <h3 style={{ marginBottom: '20px', color: '#333' }}>Emergency Contacts</h3>
            {pirData.emergencyContacts && pirData.emergencyContacts.length > 0 ? (
                <div style={{ display: 'grid', gap: '15px' }}>
                    {pirData.emergencyContacts.map((contact, index) => (
                        <div key={index} style={{
                            padding: '15px',
                            background: contact.isPrimary ? '#f0f8ff' : '#f9f9f9',
                            borderRadius: '10px',
                            border: contact.isPrimary ? '2px solid #4CAF50' : '1px solid #ddd'
                        }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <div>
                                    <div style={{ fontWeight: 'bold', fontSize: '16px', color: '#333' }}>
                                        {contact.name} 
                                        {contact.isPrimary && (
                                            <span style={{
                                                marginLeft: '10px',
                                                background: '#4CAF50',
                                                color: 'white',
                                                padding: '2px 8px',
                                                borderRadius: '12px',
                                                fontSize: '12px'
                                            }}>PRIMARY</span>
                                        )}
                                    </div>
                                    <div style={{ color: '#666', marginTop: '5px' }}>
                                        {contact.relationship} • {contact.phone}
                                    </div>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            ) : (
                <p style={{ color: '#666' }}>No emergency contacts configured</p>
            )}
        </div>

        {/* Sponsor Information */}
        <div style={{
            background: 'white',
            borderRadius: '15px',
            padding: '25px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
            <h3 style={{ marginBottom: '20px', color: '#333' }}>Sponsor Information</h3>
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
                <div>
                    <label style={{ fontWeight: 'bold', color: '#666' }}>Sponsor Name</label>
                    {editing ? (
                        <input
                            type="text"
                            value={editData.sponsorName || ''}
                            onChange={(e) => setEditData({...editData, sponsorName: e.target.value})}
                            style={{ width: '100%', padding: '8px', borderRadius: '5px', border: '1px solid #ddd' }}
                        />
                    ) : (
                        <p style={{ color: '#333' }}>{pirData.sponsorName || 'Not assigned'}</p>
                    )}
                </div>
                <div>
                    <label style={{ fontWeight: 'bold', color: '#666' }}>Sponsor Phone</label>
                    {editing ? (
                        <input
                            type="tel"
                            value={editData.sponsorPhone || ''}
                            onChange={(e) => setEditData({...editData, sponsorPhone: e.target.value})}
                            style={{ width: '100%', padding: '8px', borderRadius: '5px', border: '1px solid #ddd' }}
                        />
                    ) : (
                        <p style={{ color: '#333' }}>{pirData.sponsorPhone || 'Not provided'}</p>
                    )}
                </div>
            </div>
        </div>
    </div>
);

  const renderGoldenThreadTab = () => {
    // Handler functions for creating items
    const handleCreateGoldenThread = async (threadData) => {
        try {
            for (const goal of threadData.goals) {
                if (!goal.title) continue;
                
                const goalRef = await db.collection('goals').add({
                    userId: pirId,
                    title: goal.title,
                    description: goal.description,
                    dueDate: goal.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(goal.dueDate)) : null,
                    status: 'active',
                    createdBy: user.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                for (let i = 0; i < goal.objectives.length; i++) {
                    const objective = goal.objectives[i];
                    if (!objective.title) continue;
                    
                    const objectiveRef = await db.collection('objectives').add({
                        goalId: goalRef.id,
                        userId: pirId,
                        title: objective.title,
                        order: i + 1,
                        dueDate: objective.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(objective.dueDate)) : null,
                        status: 'active',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    for (const assignment of objective.assignments) {
                        if (!assignment.title) continue;
                        
                        await db.collection('assignments').add({
                            goalId: goalRef.id,
                            objectiveId: objectiveRef.id,
                            userId: pirId,
                            pirName: pirData.displayName || pirData.email,
                            coachId: user.uid,
                            coachName: user.displayName || user.email,
                            title: assignment.title,
                            description: assignment.description,
                            dueDate: assignment.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(assignment.dueDate)) : null,
                            status: 'pending',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }
            }
            
            await loadGoalsData();
            await loadObjectivesData();
            await loadAssignmentsData();
            setShowGoldenThread(false);
            alert('Golden Thread created successfully!');
        } catch (error) {
            console.error('Error creating golden thread:', error);
            alert('Failed to create golden thread');
        }
    };

    const handleAddGoal = async (goalData) => {
        try {
            await db.collection('goals').add({
                userId: pirId,
                title: goalData.title,
                description: goalData.description,
                dueDate: goalData.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(goalData.dueDate)) : null,
                status: 'active',
                createdBy: user.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await loadGoalsData();
            setShowAddGoal(false);
            alert('Goal added successfully');
        } catch (error) {
            console.error('Error adding goal:', error);
            alert('Failed to add goal');
        }
    };

    const handleAddObjective = async (objectiveData) => {
        try {
            const objectivesCount = objectives.filter(o => o.goalId === selectedGoalForObjective.id).length;
            
            await db.collection('objectives').add({
                goalId: selectedGoalForObjective.id,
                userId: pirId,
                title: objectiveData.title,
                order: objectivesCount + 1,
                dueDate: objectiveData.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(objectiveData.dueDate)) : null,
                status: 'active',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await loadObjectivesData();
            setShowAddObjective(false);
            setSelectedGoalForObjective(null);
            alert('Objective added successfully');
        } catch (error) {
            console.error('Error adding objective:', error);
            alert('Failed to add objective');
        }
    };

    const handleAddAssignment = async (assignmentData) => {
        try {
            await db.collection('assignments').add({
                goalId: selectedObjectiveForAssignment.goalId,
                objectiveId: selectedObjectiveForAssignment.id,
                userId: pirId,
                pirName: pirData.displayName || pirData.email,
                coachId: user.uid,
                coachName: user.displayName || user.email,
                title: assignmentData.title,
                description: assignmentData.description,
                dueDate: assignmentData.dueDate ? firebase.firestore.Timestamp.fromDate(new Date(assignmentData.dueDate)) : null,
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await loadAssignmentsData();
            setShowAddAssignment(false);
            setSelectedObjectiveForAssignment(null);
            alert('Assignment added successfully');
        } catch (error) {
            console.error('Error adding assignment:', error);
            alert('Failed to add assignment');
        }
    };

    return (
        <div style={{ padding: '20px' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                <h3 style={{ margin: 0, color: '#333' }}>Recovery Journey Structure</h3>
                <div style={{ display: 'flex', gap: '10px' }}>
                    <button
                        className="btn btn-primary"
                        onClick={() => setShowGoldenThread(true)}
                        style={{
                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            border: 'none',
                            color: 'white',
                            padding: '10px 20px',
                            borderRadius: '8px',
                            cursor: 'pointer'
                        }}
                    >
                        + Golden Thread
                    </button>
                    <button
                        className="btn btn-secondary"
                        onClick={() => setShowAddGoal(true)}
                        style={{
                            background: '#4CAF50',
                            border: 'none',
                            color: 'white',
                            padding: '10px 20px',
                            borderRadius: '8px',
                            cursor: 'pointer'
                        }}
                    >
                        + Add Goal
                    </button>
                </div>
            </div>
            
            {/* Goals list with add objective/assignment capabilities */}
            {goals.length > 0 ? (
                goals.map(goal => (
                    <div key={goal.id} style={{
                        background: 'white',
                        borderRadius: '15px',
                        padding: '20px',
                        marginBottom: '20px',
                        boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                        borderLeft: `4px solid ${goal.status === 'completed' ? '#4CAF50' : '#2196F3'}`
                    }}>
                        <div 
                            style={{ 
                                display: 'flex', 
                                justifyContent: 'space-between', 
                                alignItems: 'center',
                                cursor: 'pointer'
                            }}
                            onClick={() => setExpandedGoals({...expandedGoals, [goal.id]: !expandedGoals[goal.id]})}
                        >
                            <div>
                                <h4 style={{ margin: 0, color: '#333' }}>
                                    {expandedGoals[goal.id] ? '▼' : '▶'} {goal.title}
                                </h4>
                                <p style={{ margin: '5px 0', color: '#666' }}>{goal.description}</p>
                            </div>
                            <div style={{
                                background: `conic-gradient(#4CAF50 0% ${goal.progress || 0}%, #e0e0e0 ${goal.progress || 0}% 100%)`,
                                width: '60px',
                                height: '60px',
                                borderRadius: '50%',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center'
                            }}>
                                <div style={{
                                    background: 'white',
                                    width: '50px',
                                    height: '50px',
                                    borderRadius: '50%',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    fontWeight: 'bold',
                                    color: '#333'
                                }}>
                                    {goal.progress || 0}%
                                </div>
                            </div>
                        </div>
                        
                        {expandedGoals[goal.id] && (
                            <div style={{ marginTop: '20px' }}>
                                <div style={{ display: 'flex', gap: '10px', marginBottom: '15px' }}>
                                    <button 
                                        className="btn btn-secondary"
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            setSelectedGoalForObjective(goal);
                                            setShowAddObjective(true);
                                        }}
                                        style={{
                                            background: '#2196F3',
                                            border: 'none',
                                            color: 'white',
                                            padding: '8px 16px',
                                            borderRadius: '5px',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        + Add Objective
                                    </button>
                                </div>
                                
                                {/* Objectives */}
                                <div style={{ marginBottom: '15px' }}>
                                    <h5 style={{ color: '#666', marginBottom: '10px' }}>Objectives</h5>
                                    {objectives.filter(o => o.goalId === goal.id).map(objective => (
                                        <div key={objective.id} style={{
                                            background: '#f9f9f9',
                                            padding: '10px',
                                            borderRadius: '8px',
                                            marginBottom: '10px',
                                            borderLeft: `3px solid ${objective.status === 'completed' ? '#4CAF50' : '#FF9800'}`
                                        }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                <strong style={{ color: '#333' }}>#{objective.order} - {objective.title}</strong>
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        setSelectedObjectiveForAssignment(objective);
                                                        setShowAddAssignment(true);
                                                    }}
                                                    style={{
                                                        background: '#9C27B0',
                                                        border: 'none',
                                                        color: 'white',
                                                        padding: '4px 12px',
                                                        borderRadius: '4px',
                                                        cursor: 'pointer',
                                                        fontSize: '12px'
                                                    }}
                                                >
                                                    + Assignment
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                
                                {/* Assignments */}
                                <div>
                                    <h5 style={{ color: '#666', marginBottom: '10px' }}>Assignments</h5>
                                    {assignments.filter(a => a.goalId === goal.id).map(assignment => (
                                        <div key={assignment.id} style={{
                                            background: '#f5f5f5',
                                            padding: '10px',
                                            borderRadius: '8px',
                                            marginBottom: '10px',
                                            borderLeft: `3px solid ${assignment.status === 'completed' ? '#4CAF50' : '#2196F3'}`
                                        }}>
                                            <strong style={{ color: '#333' }}>{assignment.title}</strong>
                                            <div style={{ fontSize: '12px', color: '#666' }}>
                                                {assignment.description}
                                            </div>
                                            <div style={{ fontSize: '11px', color: '#999', marginTop: '5px' }}>
                                                Due: {formatDate(assignment.dueDate)} • Status: {assignment.status}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                ))
            ) : (
                <div style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '40px',
                    textAlign: 'center',
                    color: '#666'
                }}>
                    <p>No goals configured yet</p>
                    <p style={{ fontSize: '14px' }}>Click "Golden Thread" or "Add Goal" to get started</p>
                </div>
            )}

            {/* Golden Thread Modal */}
            {showGoldenThread && (
                <CreateGoalModal
                    type="goldenThread"
                    selectedPIR={{ id: pirId, displayName: pirData?.displayName, email: pirData?.email }}
                    selectedParent={null}
                    onSubmit={handleCreateGoldenThread}
                    onClose={() => setShowGoldenThread(false)}
                />
            )}

            {/* Add Goal Modal */}
            {showAddGoal && (
                <CreateGoalModal
                    type="goal"
                    selectedPIR={{ id: pirId }}
                    selectedParent={null}
                    onSubmit={handleAddGoal}
                    onClose={() => setShowAddGoal(false)}
                />
            )}

            {/* Add Objective Modal */}
            {showAddObjective && (
                <CreateGoalModal
                    type="objective"
                    selectedPIR={{ id: pirId }}
                    selectedParent={selectedGoalForObjective}
                    onSubmit={handleAddObjective}
                    onClose={() => {
                        setShowAddObjective(false);
                        setSelectedGoalForObjective(null);
                    }}
                />
            )}

            {/* Add Assignment Modal */}
            {showAddAssignment && (
                <CreateGoalModal
                    type="assignment"
                    selectedPIR={{ id: pirId }}
                    selectedParent={selectedObjectiveForAssignment}
                    onSubmit={handleAddAssignment}
                    onClose={() => {
                        setShowAddAssignment(false);
                        setSelectedObjectiveForAssignment(null);
                    }}
                />
            )}
        </div>
    );
};  // FIXED: Removed the extra closing brace here

  const renderProgressTab = () => (
    <div style={{ padding: '20px' }}>
        {/* Compliance Metrics */}
        <div style={{
            background: 'white',
            borderRadius: '15px',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
            <h3 style={{ marginBottom: '20px', color: '#333' }}>
                Compliance Metrics (Last {complianceData.daysTracked} Days)
            </h3>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '20px' }}>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '36px', fontWeight: 'bold', color: '#4CAF50' }}>
                        {complianceData.morningRate}%
                    </div>
                    <div style={{ color: '#666' }}>Morning Check-ins</div>
                </div>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '36px', fontWeight: 'bold', color: '#2196F3' }}>
                        {complianceData.eveningRate}%
                    </div>
                    <div style={{ color: '#666' }}>Evening Reflections</div>
                </div>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '36px', fontWeight: 'bold', color: '#FF9800' }}>
                        {complianceData.assignmentRate}%
                    </div>
                    <div style={{ color: '#666' }}>Assignments Complete</div>
                </div>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '36px', fontWeight: 'bold', color: '#9C27B0' }}>
                        {complianceData.totalCheckIns}
                    </div>
                    <div style={{ color: '#666' }}>Total Check-ins</div>
                </div>
            </div>
        </div>

        {/* Check-ins History Table - Keep as is */}
        <div style={{
            background: 'white',
            borderRadius: '15px',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
            <h3 style={{ marginBottom: '20px', color: '#333' }}>Check-in History</h3>
            <div style={{ overflowX: 'auto' }}>
                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                    <thead>
                        <tr style={{ borderBottom: '2px solid #333', background: '#f0f0f0' }}>
                            <th style={{ padding: '12px', textAlign: 'left', color: '#333', fontWeight: 'bold' }}>Date</th>
                            <th style={{ padding: '12px', textAlign: 'center', color: '#333', fontWeight: 'bold' }}>Morning</th>
                            <th style={{ padding: '12px', textAlign: 'center', color: '#333', fontWeight: 'bold' }}>Evening</th>
                            <th style={{ padding: '12px', textAlign: 'center', color: '#333', fontWeight: 'bold' }}>Mood</th>
                            <th style={{ padding: '12px', textAlign: 'center', color: '#333', fontWeight: 'bold' }}>Craving</th>
                            <th style={{ padding: '12px', textAlign: 'center', color: '#333', fontWeight: 'bold' }}>Sleep</th>
                            <th style={{ padding: '12px', textAlign: 'left', color: '#333', fontWeight: 'bold' }}>Daily Pledge</th>
                        </tr>
                    </thead>
                    <tbody>
                        {checkIns && checkIns.length > 0 ? (
                            checkIns.map((checkIn, index) => (
                                <tr key={checkIn.id} style={{ 
                                    borderBottom: '1px solid #ddd',
                                    background: index % 2 === 0 ? '#ffffff' : '#f8f9fa'
                                }}>
                                    <td style={{ padding: '10px', color: '#333', fontWeight: '500' }}>
                                        {formatDate(checkIn.createdAt)}
                                    </td>
                                    <td style={{ padding: '10px', textAlign: 'center' }}>
                                        {checkIn.morningData ? (
                                            <span style={{ color: '#4CAF50', fontSize: '18px', fontWeight: 'bold' }}>✓</span>
                                        ) : (
                                            <span style={{ color: '#e0e0e0', fontSize: '18px' }}>✗</span>
                                        )}
                                    </td>
                                    <td style={{ padding: '10px', textAlign: 'center' }}>
                                        {checkIn.eveningData ? (
                                            <span style={{ color: '#2196F3', fontSize: '18px', fontWeight: 'bold' }}>✓</span>
                                        ) : (
                                            <span style={{ color: '#e0e0e0', fontSize: '18px' }}>✗</span>
                                        )}
                                    </td>
                                    <td style={{ padding: '10px', textAlign: 'center', color: '#333', fontWeight: '500' }}>
                                        {checkIn.morningData?.mood || checkIn.eveningData?.mood || '-'}/10
                                    </td>
                                    <td style={{ padding: '10px', textAlign: 'center', color: '#333', fontWeight: '500' }}>
                                        {checkIn.morningData?.craving || checkIn.eveningData?.craving || '-'}/10
                                    </td>
                                    <td style={{ padding: '10px', textAlign: 'center', color: '#333', fontWeight: '500' }}>
                                        {checkIn.morningData?.sleepQuality || '-'}/10
                                    </td>
                                    <td style={{ padding: '10px' }}>
                                        <div style={{ 
                                            maxWidth: '200px', 
                                            overflow: 'hidden', 
                                            textOverflow: 'ellipsis',
                                            whiteSpace: 'nowrap',
                                            fontSize: '12px',
                                            color: '#555',
                                            fontWeight: '400'
                                        }}>
                                            {checkIn.morningData?.dailyPledge || '-'}
                                        </div>
                                    </td>
                                </tr>
                            ))
                        ) : (
                            <tr>
                                <td colSpan="7" style={{ 
                                    padding: '40px', 
                                    textAlign: 'center', 
                                    color: '#666',
                                    background: '#f8f9fa'
                                }}>
                                    No check-ins recorded yet
                                </td>
                            </tr>
                        )}
                    </tbody>
                </table>
            </div>
        </div>

        {/* Progress Charts */}
        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px', marginBottom: '20px' }}>
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
            }}>
                <h4 style={{ marginBottom: '15px', color: '#333' }}>30-Day Mood Trend</h4>
                <div style={{ height: '200px' }}>
                    <canvas id={`mood-chart-${pirId}`}></canvas>
                </div>
            </div>
            
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
            }}>
                <h4 style={{ marginBottom: '15px', color: '#333' }}>30-Day Craving Trend</h4>
                <div style={{ height: '200px' }}>
                    <canvas id={`craving-chart-${pirId}`}></canvas>
                </div>
            </div>
            
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
            }}>
                <h4 style={{ marginBottom: '15px', color: '#333' }}>30-Day Anxiety Trend</h4>
                <div style={{ height: '200px' }}>
                    <canvas id={`anxiety-chart-${pirId}`}></canvas>
                </div>
            </div>
            
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
            }}>
                <h4 style={{ marginBottom: '15px', color: '#333' }}>30-Day Sleep Quality Trend</h4>
                <div style={{ height: '200px' }}>
                    <canvas id={`sleep-chart-${pirId}`}></canvas>
                </div>
            </div>
        </div>

        {/* Evening Reflections Section */}
        <div style={{
            background: 'white',
            borderRadius: '15px',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
            <h3 style={{ marginBottom: '20px', color: '#333' }}>Evening Reflections</h3>
            <div style={{ maxHeight: '500px', overflowY: 'auto' }}>
                {checkIns && checkIns.filter(c => c.eveningData).length > 0 ? (
                    checkIns.filter(c => c.eveningData).map((checkIn, index) => (
                        <div key={checkIn.id} style={{
                            padding: '20px',
                            marginBottom: '15px',
                            background: index % 2 === 0 ? '#f9f9f9' : '#f5f5f5',
                            borderRadius: '10px',
                            borderLeft: '4px solid #2196F3'
                        }}>
                            <div style={{ 
                                display: 'flex', 
                                justifyContent: 'space-between', 
                                alignItems: 'center',
                                marginBottom: '15px'
                            }}>
                                <h5 style={{ margin: 0, color: '#333' }}>
                                    {formatDate(checkIn.createdAt)}
                                </h5>
                                <div style={{
                                    background: '#2196F3',
                                    color: 'white',
                                    padding: '4px 12px',
                                    borderRadius: '12px',
                                    fontSize: '12px'
                                }}>
                                    Overall Day: {checkIn.eveningData.overallDay || 0}/10
                                </div>
                            </div>
                            
                            <div style={{ display: 'grid', gap: '12px' }}>
                                {checkIn.eveningData.gratitude && (
                                    <div>
                                        <strong style={{ color: '#4CAF50', fontSize: '13px' }}>Gratitude:</strong>
                                        <p style={{ 
                                            margin: '4px 0', 
                                            color: '#333', 
                                            fontSize: '14px',
                                            lineHeight: '1.5'
                                        }}>
                                            {checkIn.eveningData.gratitude}
                                        </p>
                                    </div>
                                )}
                                
                                {checkIn.eveningData.challenges && (
                                    <div>
                                        <strong style={{ color: '#FF9800', fontSize: '13px' }}>Challenges:</strong>
                                        <p style={{ 
                                            margin: '4px 0', 
                                            color: '#333', 
                                            fontSize: '14px',
                                            lineHeight: '1.5'
                                        }}>
                                            {checkIn.eveningData.challenges}
                                        </p>
                                    </div>
                                )}
                                
                                {checkIn.eveningData.tomorrowGoal && (
                                    <div>
                                        <strong style={{ color: '#9C27B0', fontSize: '13px' }}>Tomorrow's Goal:</strong>
                                        <p style={{ 
                                            margin: '4px 0', 
                                            color: '#333', 
                                            fontSize: '14px',
                                            lineHeight: '1.5'
                                        }}>
                                            {checkIn.eveningData.tomorrowGoal}
                                        </p>
                                    </div>
                                )}
                            </div>
                        </div>
                    ))
                ) : (
                    <div style={{ 
                        padding: '40px', 
                        textAlign: 'center', 
                        color: '#666' 
                    }}>
                        No evening reflections recorded yet
                    </div>
                )}
            </div>
        </div>

        {/* Pledges Section */}
        <div style={{
            background: 'white',
            borderRadius: '15px',
            padding: '20px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
            <h3 style={{ marginBottom: '20px', color: '#333' }}>Daily Pledges</h3>
            <div style={{ maxHeight: '400px', overflowY: 'auto' }}>
                {pledges && pledges.length > 0 ? (
                    pledges.map((pledge, index) => (
                        <div key={pledge.id} style={{
                            padding: '15px',
                            marginBottom: '10px',
                            background: index % 2 === 0 ? '#f9f9f9' : '#f5f5f5',
                            borderRadius: '8px',
                            borderLeft: `4px solid ${pledge.completed ? '#4CAF50' : '#FF9800'}`
                        }}>
                            <div style={{ 
                                display: 'flex', 
                                justifyContent: 'space-between', 
                                alignItems: 'center',
                                marginBottom: '8px'
                            }}>
                                <span style={{ 
                                    fontSize: '12px', 
                                    color: '#666' 
                                }}>
                                    {formatDate(pledge.createdAt)}
                                </span>
                                {pledge.completed && (
                                    <span style={{ 
                                        color: '#4CAF50', 
                                        fontSize: '16px' 
                                    }}>✓</span>
                                )}
                            </div>
                            <p style={{ 
                                margin: 0, 
                                color: '#333', 
                                fontSize: '14px',
                                lineHeight: '1.5'
                            }}>
                                {pledge.content || pledge.text || pledge.pledge}
                            </p>
                        </div>
                    ))
                ) : (
                    <div style={{ 
                        padding: '30px', 
                        textAlign: 'center', 
                        color: '#666' 
                    }}>
                        No pledges recorded yet
                    </div>
                )}
            </div>
        </div>
    </div>
);
  
    const renderMilestonesTab = () => {
    // Calculate milestones based on sobriety date
    const calculateMilestones = () => {
        if (!pirData?.sobrietyDate) return [];
        
        const sobrietyDate = pirData.sobrietyDate?.toDate ? pirData.sobrietyDate.toDate() : new Date(pirData.sobrietyDate);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        sobrietyDate.setHours(0, 0, 0, 0);  // FIXED: Changed from 'sobriety' to 'sobrietyDate'
        
        const standardMilestones = [
            { days: 1, title: '24 Hours', icon: '🌅', description: 'The first day - the hardest step' },
            { days: 3, title: '3 Days', icon: '💪', description: 'Past the acute phase' },
            { days: 7, title: 'One Week', icon: '📅', description: 'A full week of sobriety' },
            { days: 14, title: 'Two Weeks', icon: '🌟', description: 'Building momentum' },
            { days: 30, title: 'One Month', icon: '📆', description: 'First major milestone' },
            { days: 60, title: 'Two Months', icon: '🏃', description: 'Establishing new habits' },
            { days: 90, title: 'Three Months', icon: '🏆', description: 'Quarter year achieved' },
            { days: 120, title: 'Four Months', icon: '🎯', description: 'Solid foundation built' },
            { days: 180, title: 'Six Months', icon: '⭐', description: 'Half year milestone' },
            { days: 365, title: 'One Year', icon: '🎉', description: 'Full year of recovery' },
            { days: 548, title: '18 Months', icon: '🌈', description: 'A year and a half strong' },
            { days: 730, title: 'Two Years', icon: '🎊', description: 'Two years of sobriety' },
            { days: 1095, title: 'Three Years', icon: '🏅', description: 'Three years of growth' },
            { days: 1825, title: 'Five Years', icon: '👑', description: 'Half a decade of recovery' },
            { days: 3650, title: 'Ten Years', icon: '💎', description: 'A decade of sobriety' }
        ];
        
        return standardMilestones.map(m => {
            const targetDate = new Date(sobrietyDate);
            targetDate.setDate(targetDate.getDate() + m.days);
            const achieved = today >= targetDate;
            const daysUntil = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
            
            return {
                ...m,
                targetDate,
                achieved,
                daysUntil: achieved ? 0 : daysUntil,
                achievedDate: achieved ? targetDate : null,
                id: `standard-${m.days}`
            };
        });
    };
    
    const allMilestones = calculateMilestones();
    const achievedMilestones = allMilestones.filter(m => m.achieved);
    const upcomingMilestones = allMilestones.filter(m => !m.achieved).slice(0, 6); // Next 6 upcoming
    
    return (
        <div style={{ padding: '20px' }}>
            <h3 style={{ marginBottom: '30px', color: '#333' }}>Recovery Milestones</h3>
            
            {/* Summary Stats */}
            <div style={{
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                borderRadius: '15px',
                padding: '25px',
                marginBottom: '30px',
                color: 'white',
                textAlign: 'center'
            }}>
                <div style={{ fontSize: '48px', fontWeight: 'bold', marginBottom: '10px' }}>
                    {achievedMilestones.length}
                </div>
                <div style={{ fontSize: '18px', opacity: 0.9 }}>
                    Milestones Achieved
                </div>
                <div style={{ fontSize: '14px', opacity: 0.8, marginTop: '10px' }}>
                    {pirData?.sobrietyDays || 0} days of continuous sobriety
                </div>
            </div>
            
            {/* Achieved Milestones Section */}
            {achievedMilestones.length > 0 && (
                <>
                    <h4 style={{ marginBottom: '20px', color: '#333' }}>Achieved Milestones 🎉</h4>
                    <div style={{ 
                        display: 'grid', 
                        gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
                        gap: '20px',
                        marginBottom: '40px'
                    }}>
                        {achievedMilestones.map((milestone, index) => (
                            <div key={milestone.id || index} style={{
                                background: 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)',
                                borderRadius: '15px',
                                padding: '20px',
                                boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                                position: 'relative',
                                overflow: 'hidden',
                                transform: 'scale(1)',
                                transition: 'transform 0.2s',
                                cursor: 'pointer'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.05)'}
                            onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}>
                                <div style={{
                                    position: 'absolute',
                                    top: '10px',
                                    right: '10px',
                                    fontSize: '24px',
                                    color: 'rgba(255,255,255,0.9)'
                                }}>
                                    ✓
                                </div>
                                <div style={{
                                    fontSize: '36px',
                                    marginBottom: '10px',
                                    textAlign: 'center'
                                }}>
                                    {milestone.icon}
                                </div>
                                <h5 style={{
                                    margin: '0 0 10px 0',
                                    color: 'white',
                                    textAlign: 'center',
                                    fontSize: '16px',
                                    fontWeight: 'bold'
                                }}>
                                    {milestone.title}
                                </h5>
                                <p style={{
                                    fontSize: '12px',
                                    color: 'rgba(255,255,255,0.9)',
                                    textAlign: 'center',
                                    margin: '0 0 10px 0'
                                }}>
                                    {milestone.description}
                                </p>
                                <div style={{
                                    fontSize: '11px',
                                    color: 'rgba(255,255,255,0.8)',
                                    textAlign: 'center',
                                    fontWeight: 'bold'
                                }}>
                                    Achieved on {formatDate(milestone.achievedDate)}
                                </div>
                            </div>
                        ))}
                    </div>
                </>
            )}
            
            {/* Upcoming Milestones Section */}
            {upcomingMilestones.length > 0 && (
                <>
                    <h4 style={{ marginBottom: '20px', color: '#333' }}>Upcoming Milestones 🎯</h4>
                    <div style={{ 
                        display: 'grid', 
                        gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
                        gap: '20px' 
                    }}>
                        {upcomingMilestones.map((milestone, index) => (
                            <div key={milestone.id || index} style={{
                                background: 'white',
                                borderRadius: '15px',
                                padding: '20px',
                                boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                                border: '2px solid #e0e0e0',
                                position: 'relative',
                                overflow: 'hidden',
                                transform: 'scale(1)',
                                transition: 'all 0.2s',
                                cursor: 'pointer'
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.transform = 'scale(1.05)';
                                e.currentTarget.style.borderColor = '#667eea';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.transform = 'scale(1)';
                                e.currentTarget.style.borderColor = '#e0e0e0';
                            }}>
                                {milestone.daysUntil <= 7 && (
                                    <div style={{
                                        position: 'absolute',
                                        top: '10px',
                                        right: '10px',
                                        background: '#FF9800',
                                        color: 'white',
                                        padding: '2px 8px',
                                        borderRadius: '12px',
                                        fontSize: '10px',
                                        fontWeight: 'bold'
                                    }}>
                                        SOON!
                                    </div>
                                )}
                                <div style={{
                                    fontSize: '36px',
                                    marginBottom: '10px',
                                    textAlign: 'center',
                                    opacity: 0.7
                                }}>
                                    {milestone.icon}
                                </div>
                                <h5 style={{
                                    margin: '0 0 10px 0',
                                    color: '#333',
                                    textAlign: 'center',
                                    fontSize: '16px',
                                    fontWeight: 'bold'
                                }}>
                                    {milestone.title}
                                </h5>
                                <p style={{
                                    fontSize: '12px',
                                    color: '#666',
                                    textAlign: 'center',
                                    margin: '0 0 15px 0'
                                }}>
                                    {milestone.description}
                                </p>
                                <div style={{
                                    background: '#f5f5f5',
                                    borderRadius: '20px',
                                    padding: '8px',
                                    textAlign: 'center'
                                }}>
                                    <div style={{
                                        fontSize: '20px',
                                        fontWeight: 'bold',
                                        color: milestone.daysUntil <= 7 ? '#FF9800' : '#667eea'
                                    }}>
                                        {milestone.daysUntil}
                                    </div>
                                    <div style={{
                                        fontSize: '11px',
                                        color: '#999',
                                        textTransform: 'uppercase'
                                    }}>
                                        days to go
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </>
            )}
            
            {allMilestones.length === 0 && (
                <div style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '40px',
                    textAlign: 'center',
                    color: '#666'
                }}>
                    <p>No milestones configured yet</p>
                    <p style={{ fontSize: '14px', marginTop: '10px' }}>
                        Milestones will appear once a sobriety date is set
                    </p>
                </div>
            )}
        </div>
    );
};

   

// Fixed renderCommunicationsTab
const renderCommunicationsTab = () => {
    // Add a delete message handler if not already defined
    const handleDeleteMessage = async (messageId, messageType) => {
        if (!confirm('Are you sure you want to delete this message?')) return;
        
        try {
            let collection = 'messages';
            if (messageType === 'community') collection = 'glrsChat';
            if (messageType === 'topic') collection = 'topicRoomMessages';
            
            await db.collection(collection).doc(messageId).delete();
            
            // Flag content for moderation record
            await db.collection('flaggedContent').add({
                originalCollection: collection,
                originalId: messageId,
                userId: pirId,
                flaggedBy: user.uid,
                reason: 'Deleted by coach',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await loadAllUserMessages();
            alert('Message deleted and flagged');
        } catch (error) {
            console.error('Error deleting message:', error);
            alert('Failed to delete message');
        }
    };
    
    return (
        <div style={{ padding: '20px' }}>
            <h3 style={{ marginBottom: '20px', color: '#333' }}>Communication Activity</h3>
            
            {/* Message Stats */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                marginBottom: '20px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
            }}>
                <h4 style={{ marginBottom: '15px', color: '#333' }}>Engagement Metrics</h4>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '20px' }}>
                    <div style={{ textAlign: 'center' }}>
                        <div style={{ fontSize: '36px', fontWeight: 'bold', color: '#2196F3' }}>
                            {allMessages.length}
                        </div>
                        <div style={{ color: '#666' }}>Total Messages</div>
                    </div>
                    <div style={{ textAlign: 'center' }}>
                        <div style={{ fontSize: '36px', fontWeight: 'bold', color: '#4CAF50' }}>
                            {allMessages.filter(m => m.type === 'community').length}
                        </div>
                        <div style={{ color: '#666' }}>Community Posts</div>
                    </div>
                    <div style={{ textAlign: 'center' }}>
                        <div style={{ fontSize: '36px', fontWeight: 'bold', color: '#FF9800' }}>
                            {allMessages.filter(m => m.type === 'topic').length}
                        </div>
                        <div style={{ color: '#666' }}>Topic Room Posts</div>
                    </div>
                    <div style={{ textAlign: 'center' }}>
                        <div style={{ fontSize: '36px', fontWeight: 'bold', color: '#9C27B0' }}>
                            {allMessages.filter(m => m.type === 'direct').length}
                        </div>
                        <div style={{ color: '#666' }}>Direct Messages</div>
                    </div>
                </div>
            </div>

            {/* All Messages with Moderation Controls */}
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
            }}>
                <h4 style={{ marginBottom: '15px', color: '#333' }}>Message History</h4>
                {allMessages.length > 0 ? (
                    <div style={{ maxHeight: '600px', overflowY: 'auto' }}>
                        {allMessages.map(message => (
                            <div key={message.id} style={{
                                padding: '15px',
                                borderBottom: '1px solid #eee',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'start'
                            }}>
                                <div style={{ flex: 1 }}>
                                    <div style={{ display: 'flex', gap: '10px', marginBottom: '5px' }}>
                                        <span style={{
                                            background: message.type === 'community' ? '#4CAF50' :
                                                       message.type === 'topic' ? '#FF9800' : '#2196F3',
                                            color: 'white',
                                            padding: '2px 8px',
                                            borderRadius: '12px',
                                            fontSize: '10px'
                                        }}>
                                            {message.type.toUpperCase()}
                                        </span>
                                        {message.roomId && (
                                            <span style={{ fontSize: '12px', color: '#999' }}>
                                                Room: {message.roomId}
                                            </span>
                                        )}
                                        <span style={{ fontSize: '12px', color: '#999' }}>
                                            {formatTimeAgo(message.createdAt)}
                                        </span>
                                    </div>
                                    <div style={{ color: '#333' }}>
                                        {message.content || message.text || message.message || 'No content'}
                                    </div>
                                    {message.imageUrl && (
                                        <div style={{ marginTop: '10px' }}>
                                            <img 
                                                src={message.imageUrl} 
                                                alt="Message attachment" 
                                                style={{ maxWidth: '200px', borderRadius: '8px' }}
                                            />
                                        </div>
                                    )}
                                </div>
                                <div style={{ display: 'flex', gap: '10px' }}>
                                    <button
                                        onClick={() => handleDeleteMessage(message.id, message.type)}
                                        style={{
                                            background: '#f44336',
                                            color: 'white',
                                            border: 'none',
                                            padding: '5px 10px',
                                            borderRadius: '5px',
                                            cursor: 'pointer',
                                            fontSize: '12px'
                                        }}
                                    >
                                        Delete
                                    </button>
                                    <button
                                        onClick={async () => {
                                            try {
                                                await db.collection('flaggedContent').add({
                                                    messageId: message.id,
                                                    messageType: message.type,
                                                    userId: pirId,
                                                    flaggedBy: user.uid,
                                                    reason: 'Flagged for review',
                                                    content: message.content || message.text,
                                                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                                });
                                                alert('Message flagged for review');
                                            } catch (error) {
                                                console.error('Error flagging message:', error);
                                                alert('Failed to flag message');
                                            }
                                        }}
                                        style={{
                                            background: '#FF9800',
                                            color: 'white',
                                            border: 'none',
                                            padding: '5px 10px',
                                            borderRadius: '5px',
                                            cursor: 'pointer',
                                            fontSize: '12px'
                                        }}
                                    >
                                        Flag
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                ) : (
                    <p style={{ color: '#666', padding: '20px', textAlign: 'center' }}>
                        No messages sent yet
                    </p>
                )}
            </div>
        </div>
    );
};

// Continue with renderResourcesTab, renderActivityTab, etc... (the rest of the code from my previous message)
// All render functions remain the same as provided earlier

// The return statement continues from my previous response...

  // This closes the UserDetailModal function
   const renderResourcesTab = () => (
    <div style={{ padding: '20px' }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
            <h3 style={{ margin: 0, color: '#333' }}>Resource Management</h3>
            <div style={{ display: 'flex', gap: '10px' }}>
                <button
                    className="btn btn-primary"
                    onClick={() => setShowAssignResource(true)}
                    style={{
                        background: 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)',
                        border: 'none',
                        color: 'white',
                        padding: '10px 20px',
                        borderRadius: '8px',
                        cursor: 'pointer'
                    }}
                >
                    Assign Resource
                </button>
                <button
                    className="btn btn-primary"
                    onClick={() => setShowCreateResource(true)}
                    style={{
                        background: 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)',
                        border: 'none',
                        color: 'white',
                        padding: '10px 20px',
                        borderRadius: '8px',
                        cursor: 'pointer'
                    }}
                >
                    Create Resource
                </button>
            </div>
        </div>
        
        {['education', 'coping', 'daily', 'life', 'support', 'relapse'].map(category => {
            const categoryResources = resources.filter(r => r.category === category);
            if (categoryResources.length === 0) return null;
            
            return (
                <div key={category} style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '20px',
                    marginBottom: '20px',
                    boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                }}>
                    <h4 style={{ marginBottom: '15px', color: '#333', textTransform: 'capitalize' }}>
                        {category} Resources ({categoryResources.length})
                    </h4>
                    <div style={{ display: 'grid', gap: '10px' }}>
                        {categoryResources.map(resource => (
                            <div key={resource.id} style={{
                                padding: '15px',
                                background: '#f9f9f9',
                                borderRadius: '8px',
                                borderLeft: `3px solid ${
                                    resourceProgress[resource.id]?.status === 'completed' ? '#4CAF50' :
                                    resourceProgress[resource.id]?.status === 'in-progress' ? '#FF9800' :
                                    '#2196F3'
                                }`,
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center'
                            }}>
                                <div style={{ flex: 1 }}>
                                    <strong style={{ color: '#333' }}>{resource.title}</strong>
                                    <p style={{ fontSize: '12px', color: '#666', margin: '5px 0' }}>
                                        {resource.description}
                                    </p>
                                    {resource.url && (
                                        <a href={resource.url} target="_blank" style={{
                                            fontSize: '11px',
                                            color: '#2196F3'
                                        }}>
                                            View Resource →
                                        </a>
                                    )}
                                </div>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                    <span style={{
                                        background: resourceProgress[resource.id]?.status === 'completed' ? '#4CAF50' :
                                                   resourceProgress[resource.id]?.status === 'in-progress' ? '#FF9800' :
                                                   '#e0e0e0',
                                        color: 'white',
                                        padding: '4px 8px',
                                        borderRadius: '12px',
                                        fontSize: '10px'
                                    }}>
                                        {resourceProgress[resource.id]?.status || 'Not Started'}
                                    </span>
                                    <button
                                        onClick={async () => {
                                            if (confirm('Are you sure you want to unassign this resource?')) {
                                                try {
                                                    await db.collection('resources').doc(resource.id).update({
                                                        assignedTo: firebase.firestore.FieldValue.arrayRemove(pirId)
                                                    });
                                                    await loadResourcesData();
                                                    alert('Resource unassigned successfully');
                                                } catch (error) {
                                                    console.error('Error unassigning resource:', error);
                                                    alert('Failed to unassign resource');
                                                }
                                            }
                                        }}
                                        style={{
                                            background: '#f44336',
                                            color: 'white',
                                            border: 'none',
                                            padding: '4px 8px',
                                            borderRadius: '5px',
                                            cursor: 'pointer',
                                            fontSize: '10px'
                                        }}
                                    >
                                        Unassign
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        })}

        {/* Assign Resource Modal */}
        {showAssignResource && (
            <div style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0,0,0,0.5)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 10000
            }}>
                <div style={{
                    background: 'white',
                    padding: '30px',
                    borderRadius: '15px',
                    width: '600px',
                    maxWidth: '90%',
                    maxHeight: '80vh',
                    overflow: 'auto'
                }}>
                    <h3 style={{ marginBottom: '20px' }}>Assign Resource to {pirData?.firstName || 'PIR'}</h3>
                    
                    <div style={{ marginBottom: '20px' }}>
                        <label style={{ display: 'block', marginBottom: '10px', color: '#666' }}>
                            Select Resource to Assign:
                        </label>
                        <select 
                            id="resource-select"
                            style={{
                                width: '100%',
                                padding: '10px',
                                borderRadius: '5px',
                                border: '1px solid #ddd'
                            }}
                        >
                            <option value="">Choose a resource...</option>
                            {resources.filter(r => !r.assignedTo?.includes(pirId)).map(resource => (
                                <option key={resource.id} value={resource.id}>
                                    {resource.title} ({resource.category})
                                </option>
                            ))}
                        </select>
                    </div>
                    
                    <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                        <button
                            onClick={() => setShowAssignResource(false)}
                            style={{
                                padding: '10px 20px',
                                borderRadius: '5px',
                                border: '1px solid #ddd',
                                background: 'white',
                                cursor: 'pointer'
                            }}
                        >
                            Cancel
                        </button>
                        <button
                            onClick={async () => {
                                const select = document.getElementById('resource-select');
                                const resourceId = select.value;
                                if (resourceId) {
                                    try {
                                        await db.collection('resources').doc(resourceId).update({
                                            assignedTo: firebase.firestore.FieldValue.arrayUnion(pirId)
                                        });
                                        await loadResourcesData();
                                        setShowAssignResource(false);
                                        alert('Resource assigned successfully');
                                    } catch (error) {
                                        console.error('Error assigning resource:', error);
                                        alert('Failed to assign resource');
                                    }
                                } else {
                                    alert('Please select a resource');
                                }
                            }}
                            style={{
                                padding: '10px 20px',
                                borderRadius: '5px',
                                border: 'none',
                                background: 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)',
                                color: 'white',
                                cursor: 'pointer'
                            }}
                        >
                            Assign Resource
                        </button>
                    </div>
                </div>
            </div>
        )}

        {/* Create Resource Modal */}
        {showCreateResource && (
            <div style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0,0,0,0.5)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 10000
            }}>
                <div style={{
                    background: 'white',
                    padding: '30px',
                    borderRadius: '15px',
                    width: '600px',
                    maxWidth: '90%'
                }}>
                    <h3 style={{ marginBottom: '20px' }}>Create New Resource</h3>
                    
                    <form onSubmit={async (e) => {
                        e.preventDefault();
                        const form = e.target;
                        try {
                            await db.collection('resources').add({
                                title: form.title.value,
                                description: form.description.value,
                                category: form.category.value,
                                url: form.url.value || null,
                                assignedTo: [pirId],
                                createdBy: user.uid,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            await loadResourcesData();
                            setShowCreateResource(false);
                            alert('Resource created and assigned successfully');
                        } catch (error) {
                            console.error('Error creating resource:', error);
                            alert('Failed to create resource');
                        }
                    }}>
                        <div style={{ marginBottom: '15px' }}>
                            <label style={{ display: 'block', marginBottom: '5px' }}>Title *</label>
                            <input
                                name="title"
                                type="text"
                                required
                                style={{
                                    width: '100%',
                                    padding: '8px',
                                    borderRadius: '5px',
                                    border: '1px solid #ddd'
                                }}
                            />
                        </div>
                        
                        <div style={{ marginBottom: '15px' }}>
                            <label style={{ display: 'block', marginBottom: '5px' }}>Description *</label>
                            <textarea
                                name="description"
                                required
                                rows="3"
                                style={{
                                    width: '100%',
                                    padding: '8px',
                                    borderRadius: '5px',
                                    border: '1px solid #ddd'
                                }}
                            />
                        </div>
                        
                        <div style={{ marginBottom: '15px' }}>
                            <label style={{ display: 'block', marginBottom: '5px' }}>Category *</label>
                            <select
                                name="category"
                                required
                                style={{
                                    width: '100%',
                                    padding: '8px',
                                    borderRadius: '5px',
                                    border: '1px solid #ddd'
                                }}
                            >
                                <option value="">Select category...</option>
                                <option value="education">Education</option>
                                <option value="coping">Coping</option>
                                <option value="daily">Daily</option>
                                <option value="life">Life</option>
                                <option value="support">Support</option>
                                <option value="relapse">Relapse Prevention</option>
                            </select>
                        </div>
                        
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{ display: 'block', marginBottom: '5px' }}>URL (optional)</label>
                            <input
                                name="url"
                                type="url"
                                placeholder="https://..."
                                style={{
                                    width: '100%',
                                    padding: '8px',
                                    borderRadius: '5px',
                                    border: '1px solid #ddd'
                                }}
                            />
                        </div>
                        
                        <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                            <button
                                type="button"
                                onClick={() => setShowCreateResource(false)}
                                style={{
                                    padding: '10px 20px',
                                    borderRadius: '5px',
                                    border: '1px solid #ddd',
                                    background: 'white',
                                    cursor: 'pointer'
                                }}
                            >
                                Cancel
                            </button>
                            <button
                                type="submit"
                                style={{
                                    padding: '10px 20px',
                                    borderRadius: '5px',
                                    border: 'none',
                                    background: 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)',
                                    color: 'white',
                                    cursor: 'pointer'
                                }}
                            >
                                Create Resource
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        )}
    </div>
);

const renderActivityTab = () => (
    <div style={{ padding: '20px' }}>
        <h3 style={{ marginBottom: '20px', color: '#333' }}>Complete Activity Feed</h3>
        
        <div style={{
            background: 'white',
            borderRadius: '15px',
            padding: '20px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
            <div style={{ maxHeight: '600px', overflowY: 'auto' }}>
                {activities.length > 0 ? (
                    activities.map(activity => (
                        <div key={activity.id} style={{
                            padding: '15px',
                            borderBottom: '1px solid #eee',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '15px'
                        }}>
                            <div style={{
                                width: '40px',
                                height: '40px',
                                borderRadius: '50%',
                                background: getActivityColor(activity.type),
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '20px'
                            }}>
                                {getActivityIcon(activity.type)}
                            </div>
                            <div style={{ flex: 1 }}>
                                <div style={{ fontWeight: 'bold', color: '#333' }}>
                                    {activity.description || activity.type?.replace(/_/g, ' ').toUpperCase()}
                                </div>
                                <div style={{ fontSize: '11px', color: '#999', marginTop: '5px' }}>
                                    {formatTimeAgo(activity.createdAt)}
                                </div>
                            </div>
                        </div>
                    ))
                ) : (
                    <p style={{ color: '#666' }}>No activity recorded</p>
                )}
            </div>
        </div>
    </div>
);

const renderFinancialTab = () => (
    <div style={{ padding: '20px' }}>
        <h3 style={{ marginBottom: '20px', color: '#333' }}>Financial Impact</h3>
        
        <div style={{
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            borderRadius: '15px',
            padding: '30px',
            marginBottom: '20px',
            color: 'white',
            textAlign: 'center'
        }}>
            <div style={{ fontSize: '48px', fontWeight: 'bold' }}>
                ${pirData?.moneySaved || 0}
            </div>
            <div style={{ fontSize: '18px', opacity: 0.9 }}>
                Total Saved in Recovery
            </div>
            <div style={{ fontSize: '14px', opacity: 0.8, marginTop: '10px' }}>
                Based on ${pirData?.dailyCost || 20}/day
            </div>
        </div>

        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
            }}>
                <h4 style={{ marginBottom: '15px', color: '#333' }}>Monthly Projection</h4>
                <div style={{ fontSize: '32px', fontWeight: 'bold', color: '#4CAF50' }}>
                    ${(pirData?.dailyCost || 20) * 30}
                </div>
                <div style={{ fontSize: '12px', color: '#666' }}>
                    Saved per month
                </div>
            </div>

            <div style={{
                background: 'white',
                borderRadius: '15px',
                padding: '20px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
            }}>
                <h4 style={{ marginBottom: '15px', color: '#333' }}>Yearly Projection</h4>
                <div style={{ fontSize: '32px', fontWeight: 'bold', color: '#2196F3' }}>
                    ${(pirData?.dailyCost || 20) * 365}
                </div>
                <div style={{ fontSize: '12px', color: '#666' }}>
                    Saved per year
                </div>
            </div>
        </div>
    </div>
);

const renderCommunityTab = () => (
    <div style={{ padding: '20px' }}>
        <h3 style={{ marginBottom: '30px', color: '#333' }}>Community Engagement</h3>
        
        {/* Community Stats Overview */}
        <div style={{
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            borderRadius: '15px',
            padding: '20px',
            marginBottom: '30px',
            color: 'white'
        }}>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '20px' }}>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '32px', fontWeight: 'bold' }}>
                        {meetings.filter(m => m.status === 'scheduled').length}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.9 }}>Upcoming Meetings</div>
                </div>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '32px', fontWeight: 'bold' }}>
                        {topicRooms.filter(room => 
                            room.members?.includes(pirId) || room.activeParticipants?.includes(pirId)
                        ).length}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.9 }}>Topic Rooms</div>
                </div>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '32px', fontWeight: 'bold' }}>
                        {supportGroups.filter(group => 
                            group.members?.includes(pirId) || group.participants?.includes(pirId)
                        ).length}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.9 }}>Support Groups</div>
                </div>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '32px', fontWeight: 'bold' }}>
                        {allMessages.filter(m => m.type === 'community').length}
                    </div>
                    <div style={{ fontSize: '12px', opacity: 0.9 }}>Community Posts</div>
                </div>
            </div>
        </div>

        {/* Scheduled Meetings Section */}
        <div style={{
            background: 'white',
            borderRadius: '15px',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
            <h4 style={{ marginBottom: '20px', color: '#333' }}>📅 Scheduled Meetings</h4>
            {meetings && meetings.filter(m => 
                (m.pirId === pirId || m.pirIds?.includes(pirId) || m.isGlobal) && 
                m.status === 'scheduled'
            ).length > 0 ? (
                <div style={{ display: 'grid', gap: '15px' }}>
                    {meetings.filter(m => 
                        (m.pirId === pirId || m.pirIds?.includes(pirId) || m.isGlobal) && 
                        m.status === 'scheduled'
                    ).map(meeting => (
                        <div key={meeting.id} style={{
                            padding: '15px',
                            background: '#f9f9f9',
                            borderRadius: '10px',
                            borderLeft: '4px solid #2196F3'
                        }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <div>
                                    <h5 style={{ margin: '0 0 10px 0', color: '#333' }}>
                                        {meeting.meetingTitle || meeting.title || 'Recovery Session'}
                                    </h5>
                                    <div style={{ display: 'flex', gap: '15px', fontSize: '13px', color: '#666' }}>
                                        <span>📅 {formatDate(meeting.scheduledTime)}</span>
                                        <span>🕐 {new Date(meeting.scheduledTime?.toDate ? 
                                            meeting.scheduledTime.toDate() : 
                                            meeting.scheduledTime).toLocaleTimeString('en-US', {
                                                hour: 'numeric',
                                                minute: '2-digit',
                                                hour12: true
                                            })}</span>
                                        <span>📝 {meeting.type || 'Group Session'}</span>
                                    </div>
                                    {meeting.notes && (
                                        <p style={{ margin: '10px 0 0 0', fontSize: '12px', color: '#555' }}>
                                            {meeting.notes}
                                        </p>
                                    )}
                                </div>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '5px' }}>
                                    {meeting.isGlobal && (
                                        <span style={{
                                            background: '#4CAF50',
                                            color: 'white',
                                            padding: '4px 8px',
                                            borderRadius: '12px',
                                            fontSize: '10px',
                                            textAlign: 'center'
                                        }}>
                                            ALL PIRS
                                        </span>
                                    )}
                                    {meeting.meetingLink && (
                                        <a 
                                            href={meeting.meetingLink} 
                                            target="_blank" 
                                            rel="noopener noreferrer"
                                            style={{
                                                background: '#2196F3',
                                                color: 'white',
                                                padding: '6px 12px',
                                                borderRadius: '5px',
                                                textDecoration: 'none',
                                                fontSize: '12px',
                                                textAlign: 'center'
                                            }}
                                        >
                                            Join Meeting
                                        </a>
                                    )}
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            ) : (
                <p style={{ color: '#666', textAlign: 'center', padding: '20px' }}>
                    No upcoming meetings scheduled
                </p>
            )}
        </div>

        {/* Topic Rooms Section */}
        <div style={{
            background: 'white',
            borderRadius: '15px',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
            <h4 style={{ marginBottom: '20px', color: '#333' }}>💬 Topic Rooms</h4>
            {topicRooms && topicRooms.length > 0 ? (
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '15px' }}>
                    {topicRooms.map(room => {
                        const isMember = room.members?.includes(pirId) || 
                                        room.activeParticipants?.includes(pirId);
                        return (
                            <div key={room.id} style={{
                                padding: '15px',
                                background: isMember ? '#e3f2fd' : '#f5f5f5',
                                borderRadius: '10px',
                                border: isMember ? '2px solid #2196F3' : '1px solid #ddd',
                                position: 'relative'
                            }}>
                                {isMember && (
                                    <span style={{
                                        position: 'absolute',
                                        top: '10px',
                                        right: '10px',
                                        background: '#4CAF50',
                                        color: 'white',
                                        padding: '2px 6px',
                                        borderRadius: '10px',
                                        fontSize: '10px'
                                    }}>
                                        MEMBER
                                    </span>
                                )}
                                <h5 style={{ margin: '0 0 10px 0', color: '#333' }}>
                                    {room.name}
                                </h5>
                                <p style={{ fontSize: '12px', color: '#666', margin: '0 0 10px 0' }}>
                                    {room.description}
                                </p>
                                <div style={{ fontSize: '11px', color: '#999' }}>
                                    👥 {room.members?.length || 0} members
                                    {room.lastActivity && (
                                        <span style={{ marginLeft: '10px' }}>
                                            Last active: {formatTimeAgo(room.lastActivity)}
                                        </span>
                                    )}
                                </div>
                            </div>
                        );
                    })}
                </div>
            ) : (
                <p style={{ color: '#666', textAlign: 'center', padding: '20px' }}>
                    No topic rooms available
                </p>
            )}
        </div>

        {/* Support Groups Section */}
        <div style={{
            background: 'white',
            borderRadius: '15px',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
            <h4 style={{ marginBottom: '20px', color: '#333' }}>🤝 Support Groups</h4>
            {supportGroups && supportGroups.length > 0 ? (
                <div style={{ display: 'grid', gap: '15px' }}>
                    {supportGroups.map(group => {
                        const isMember = group.members?.includes(pirId) || 
                                        group.participants?.includes(pirId);
                        return (
                            <div key={group.id} style={{
                                padding: '20px',
                                background: isMember ? '#f3e5f5' : '#f9f9f9',
                                borderRadius: '10px',
                                borderLeft: `4px solid ${isMember ? '#9C27B0' : '#ddd'}`
                            }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start' }}>
                                    <div style={{ flex: 1 }}>
                                        <h5 style={{ margin: '0 0 10px 0', color: '#333' }}>
                                            {group.name}
                                        </h5>
                                        <p style={{ fontSize: '13px', color: '#666', margin: '0 0 10px 0' }}>
                                            {group.description}
                                        </p>
                                        {group.meetingSchedule && (
                                            <div style={{ fontSize: '12px', color: '#555' }}>
                                                📅 Meets: {group.meetingSchedule}
                                            </div>
                                        )}
                                        <div style={{ fontSize: '11px', color: '#999', marginTop: '10px' }}>
                                            👥 {group.members?.length || 0} members
                                            {group.facilitator && (
                                                <span style={{ marginLeft: '15px' }}>
                                                    Facilitated by: {group.facilitator}
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                    {isMember && (
                                        <span style={{
                                            background: '#9C27B0',
                                            color: 'white',
                                            padding: '4px 12px',
                                            borderRadius: '12px',
                                            fontSize: '11px'
                                        }}>
                                            ENROLLED
                                        </span>
                                    )}
                                </div>
                            </div>
                        );
                    })}
                </div>
            ) : (
                <p style={{ color: '#666', textAlign: 'center', padding: '20px' }}>
                    No support groups available
                </p>
            )}
        </div>

        {/* Recent Community Activity */}
        <div style={{
            background: 'white',
            borderRadius: '15px',
            padding: '20px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
            <h4 style={{ marginBottom: '20px', color: '#333' }}>🌐 Recent Community Activity</h4>
            {allMessages.filter(m => m.type === 'community' || m.type === 'topic').length > 0 ? (
                <div style={{ maxHeight: '300px', overflowY: 'auto' }}>
                    {allMessages
                        .filter(m => m.type === 'community' || m.type === 'topic')
                        .slice(0, 10)
                        .map(message => (
                        <div key={message.id} style={{
                            padding: '10px',
                            borderBottom: '1px solid #eee',
                            fontSize: '13px'
                        }}>
                            <div style={{ display: 'flex', gap: '10px', marginBottom: '5px' }}>
                                <span style={{
                                    background: message.type === 'community' ? '#4CAF50' : '#FF9800',
                                    color: 'white',
                                    padding: '2px 6px',
                                    borderRadius: '8px',
                                    fontSize: '10px'
                                }}>
                                    {message.type === 'community' ? 'COMMUNITY' : 'TOPIC'}
                                </span>
                                <span style={{ color: '#999', fontSize: '11px' }}>
                                    {formatTimeAgo(message.createdAt)}
                                </span>
                            </div>
                            <div style={{ color: '#333' }}>
                                {message.content || message.text || 'Posted a message'}
                            </div>
                        </div>
                    ))}
                </div>
            ) : (
                <p style={{ color: '#666', textAlign: 'center', padding: '20px' }}>
                    No recent community activity
                </p>
            )}
        </div>
    </div>
);

return (
    <div className="modal-overlay" style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        background: 'rgba(0, 0, 0, 0.5)',
        backdropFilter: 'blur(5px)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        zIndex: 1000,
        animation: 'fadeIn 0.3s ease-in-out'
    }}>
        <div className="modal-content" style={{
            maxWidth: '1200px',
            width: '95%',
            maxHeight: '90vh',
            background: 'white',
            borderRadius: '20px',
            boxShadow: '0 20px 60px rgba(0,0,0,0.3)',
            display: 'flex',
            flexDirection: 'column',
            overflow: 'hidden',
            animation: 'slideUp 0.3s ease-out'
        }}>
            <div className="modal-header" style={{
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                padding: '25px 30px',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                borderBottom: '1px solid rgba(255,255,255,0.1)'
            }}>
                <h3 style={{
                    margin: 0,
                    color: 'white',
                    fontSize: '24px',
                    fontWeight: '600',
                    letterSpacing: '-0.5px'
                }}>
                    {pirData?.firstName} {pirData?.lastName} - PIR Details
                </h3>
                <button 
                    className="close-btn" 
                    onClick={onClose}
                    style={{
                        background: 'rgba(255,255,255,0.2)',
                        border: 'none',
                        color: 'white',
                        fontSize: '28px',
                        width: '40px',
                        height: '40px',
                        borderRadius: '50%',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        transition: 'all 0.2s',
                        fontWeight: '300'
                    }}
                    onMouseEnter={(e) => {
                        e.currentTarget.style.background = 'rgba(255,255,255,0.3)';
                        e.currentTarget.style.transform = 'rotate(90deg)';
                    }}
                    onMouseLeave={(e) => {
                        e.currentTarget.style.background = 'rgba(255,255,255,0.2)';
                        e.currentTarget.style.transform = 'rotate(0deg)';
                    }}
                >
                    ×
                </button>
            </div>
            
            {loading ? (
                <div className="loading-container" style={{
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    justifyContent: 'center',
                    minHeight: '400px',
                    gap: '20px'
                }}>
                    <div className="loading-spinner" style={{
                        width: '60px',
                        height: '60px',
                        border: '4px solid #f3f3f3',
                        borderTop: '4px solid #667eea',
                        borderRadius: '50%',
                        animation: 'spin 1s linear infinite'
                    }}></div>
                    <p style={{
                        color: '#666',
                        fontSize: '16px',
                        margin: 0
                    }}>
                        Loading PIR data...
                    </p>
                </div>
            ) : (
                <>
                    <div className="tab-nav" style={{
                        display: 'flex',
                        gap: '8px',
                        padding: '20px 25px 0 25px',
                        background: '#f8f9fa',
                        borderBottom: '2px solid #e9ecef',
                        overflowX: 'auto',
                        position: 'sticky',
                        top: 0,
                        zIndex: 10
                    }}>
                        <button 
                            className={`tab-btn ${activeTab === 'overview' ? 'active' : ''}`}
                            onClick={() => setActiveTab('overview')}
                            style={{
                                padding: '12px 20px',
                                border: 'none',
                                background: activeTab === 'overview' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'transparent',
                                color: activeTab === 'overview' ? 'white' : '#666',
                                borderRadius: '10px 10px 0 0',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: activeTab === 'overview' ? '600' : '500',
                                transition: 'all 0.3s',
                                whiteSpace: 'nowrap',
                                boxShadow: activeTab === 'overview' ? '0 -2px 10px rgba(102, 126, 234, 0.3)' : 'none'
                            }}
                            onMouseEnter={(e) => {
                                if (activeTab !== 'overview') {
                                    e.currentTarget.style.background = '#e9ecef';
                                    e.currentTarget.style.color = '#333';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (activeTab !== 'overview') {
                                    e.currentTarget.style.background = 'transparent';
                                    e.currentTarget.style.color = '#666';
                                }
                            }}
                        >
                            📊 Overview
                        </button>
                        <button 
                            className={`tab-btn ${activeTab === 'progress' ? 'active' : ''}`}
                            onClick={() => setActiveTab('progress')}
                            style={{
                                padding: '12px 20px',
                                border: 'none',
                                background: activeTab === 'progress' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'transparent',
                                color: activeTab === 'progress' ? 'white' : '#666',
                                borderRadius: '10px 10px 0 0',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: activeTab === 'progress' ? '600' : '500',
                                transition: 'all 0.3s',
                                whiteSpace: 'nowrap',
                                boxShadow: activeTab === 'progress' ? '0 -2px 10px rgba(102, 126, 234, 0.3)' : 'none'
                            }}
                            onMouseEnter={(e) => {
                                if (activeTab !== 'progress') {
                                    e.currentTarget.style.background = '#e9ecef';
                                    e.currentTarget.style.color = '#333';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (activeTab !== 'progress') {
                                    e.currentTarget.style.background = 'transparent';
                                    e.currentTarget.style.color = '#666';
                                }
                            }}
                        >
                            📈 Progress
                        </button>
                        <button 
                            className={`tab-btn ${activeTab === 'goldenthread' ? 'active' : ''}`}
                            onClick={() => setActiveTab('goldenthread')}
                            style={{
                                padding: '12px 20px',
                                border: 'none',
                                background: activeTab === 'goldenthread' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'transparent',
                                color: activeTab === 'goldenthread' ? 'white' : '#666',
                                borderRadius: '10px 10px 0 0',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: activeTab === 'goldenthread' ? '600' : '500',
                                transition: 'all 0.3s',
                                whiteSpace: 'nowrap',
                                boxShadow: activeTab === 'goldenthread' ? '0 -2px 10px rgba(102, 126, 234, 0.3)' : 'none'
                            }}
                            onMouseEnter={(e) => {
                                if (activeTab !== 'goldenthread') {
                                    e.currentTarget.style.background = '#e9ecef';
                                    e.currentTarget.style.color = '#333';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (activeTab !== 'goldenthread') {
                                    e.currentTarget.style.background = 'transparent';
                                    e.currentTarget.style.color = '#666';
                                }
                            }}
                        >
                            🧵 Golden Thread
                        </button>
                        <button 
                            className={`tab-btn ${activeTab === 'milestones' ? 'active' : ''}`}
                            onClick={() => setActiveTab('milestones')}
                            style={{
                                padding: '12px 20px',
                                border: 'none',
                                background: activeTab === 'milestones' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'transparent',
                                color: activeTab === 'milestones' ? 'white' : '#666',
                                borderRadius: '10px 10px 0 0',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: activeTab === 'milestones' ? '600' : '500',
                                transition: 'all 0.3s',
                                whiteSpace: 'nowrap',
                                boxShadow: activeTab === 'milestones' ? '0 -2px 10px rgba(102, 126, 234, 0.3)' : 'none'
                            }}
                            onMouseEnter={(e) => {
                                if (activeTab !== 'milestones') {
                                    e.currentTarget.style.background = '#e9ecef';
                                    e.currentTarget.style.color = '#333';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (activeTab !== 'milestones') {
                                    e.currentTarget.style.background = 'transparent';
                                    e.currentTarget.style.color = '#666';
                                }
                            }}
                        >
                            🏆 Milestones
                        </button>
                        <button 
                            className={`tab-btn ${activeTab === 'resources' ? 'active' : ''}`}
                            onClick={() => setActiveTab('resources')}
                            style={{
                                padding: '12px 20px',
                                border: 'none',
                                background: activeTab === 'resources' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'transparent',
                                color: activeTab === 'resources' ? 'white' : '#666',
                                borderRadius: '10px 10px 0 0',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: activeTab === 'resources' ? '600' : '500',
                                transition: 'all 0.3s',
                                whiteSpace: 'nowrap',
                                boxShadow: activeTab === 'resources' ? '0 -2px 10px rgba(102, 126, 234, 0.3)' : 'none'
                            }}
                            onMouseEnter={(e) => {
                                if (activeTab !== 'resources') {
                                    e.currentTarget.style.background = '#e9ecef';
                                    e.currentTarget.style.color = '#333';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (activeTab !== 'resources') {
                                    e.currentTarget.style.background = 'transparent';
                                    e.currentTarget.style.color = '#666';
                                }
                            }}
                        >
                            📚 Resources
                        </button>
                        <button 
                            className={`tab-btn ${activeTab === 'communications' ? 'active' : ''}`}
                            onClick={() => setActiveTab('communications')}
                            style={{
                                padding: '12px 20px',
                                border: 'none',
                                background: activeTab === 'communications' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'transparent',
                                color: activeTab === 'communications' ? 'white' : '#666',
                                borderRadius: '10px 10px 0 0',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: activeTab === 'communications' ? '600' : '500',
                                transition: 'all 0.3s',
                                whiteSpace: 'nowrap',
                                boxShadow: activeTab === 'communications' ? '0 -2px 10px rgba(102, 126, 234, 0.3)' : 'none'
                            }}
                            onMouseEnter={(e) => {
                                if (activeTab !== 'communications') {
                                    e.currentTarget.style.background = '#e9ecef';
                                    e.currentTarget.style.color = '#333';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (activeTab !== 'communications') {
                                    e.currentTarget.style.background = 'transparent';
                                    e.currentTarget.style.color = '#666';
                                }
                            }}
                        >
                            💬 Communications
                        </button>
                        <button 
                            className={`tab-btn ${activeTab === 'activity' ? 'active' : ''}`}
                            onClick={() => setActiveTab('activity')}
                            style={{
                                padding: '12px 20px',
                                border: 'none',
                                background: activeTab === 'activity' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'transparent',
                                color: activeTab === 'activity' ? 'white' : '#666',
                                borderRadius: '10px 10px 0 0',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: activeTab === 'activity' ? '600' : '500',
                                transition: 'all 0.3s',
                                whiteSpace: 'nowrap',
                                boxShadow: activeTab === 'activity' ? '0 -2px 10px rgba(102, 126, 234, 0.3)' : 'none'
                            }}
                            onMouseEnter={(e) => {
                                if (activeTab !== 'activity') {
                                    e.currentTarget.style.background = '#e9ecef';
                                    e.currentTarget.style.color = '#333';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (activeTab !== 'activity') {
                                    e.currentTarget.style.background = 'transparent';
                                    e.currentTarget.style.color = '#666';
                                }
                            }}
                        >
                            📋 Activity
                        </button>
                        <button 
                            className={`tab-btn ${activeTab === 'financial' ? 'active' : ''}`}
                            onClick={() => setActiveTab('financial')}
                            style={{
                                padding: '12px 20px',
                                border: 'none',
                                background: activeTab === 'financial' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'transparent',
                                color: activeTab === 'financial' ? 'white' : '#666',
                                borderRadius: '10px 10px 0 0',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: activeTab === 'financial' ? '600' : '500',
                                transition: 'all 0.3s',
                                whiteSpace: 'nowrap',
                                boxShadow: activeTab === 'financial' ? '0 -2px 10px rgba(102, 126, 234, 0.3)' : 'none'
                            }}
                            onMouseEnter={(e) => {
                                if (activeTab !== 'financial') {
                                    e.currentTarget.style.background = '#e9ecef';
                                    e.currentTarget.style.color = '#333';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (activeTab !== 'financial') {
                                    e.currentTarget.style.background = 'transparent';
                                    e.currentTarget.style.color = '#666';
                                }
                            }}
                        >
                            💰 Financial
                        </button>
                        <button 
                            className={`tab-btn ${activeTab === 'community' ? 'active' : ''}`}
                            onClick={() => setActiveTab('community')}
                            style={{
                                padding: '12px 20px',
                                border: 'none',
                                background: activeTab === 'community' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'transparent',
                                color: activeTab === 'community' ? 'white' : '#666',
                                borderRadius: '10px 10px 0 0',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: activeTab === 'community' ? '600' : '500',
                                transition: 'all 0.3s',
                                whiteSpace: 'nowrap',
                                boxShadow: activeTab === 'community' ? '0 -2px 10px rgba(102, 126, 234, 0.3)' : 'none'
                            }}
                            onMouseEnter={(e) => {
                                if (activeTab !== 'community') {
                                    e.currentTarget.style.background = '#e9ecef';
                                    e.currentTarget.style.color = '#333';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (activeTab !== 'community') {
                                    e.currentTarget.style.background = 'transparent';
                                    e.currentTarget.style.color = '#666';
                                }
                            }}
                        >
                            🌐 Community
                        </button>
                    </div>
                    
                    <div className="tab-content" style={{
                        flex: 1,
                        overflowY: 'auto',
                        background: '#f8f9fa',
                        transition: 'opacity 0.3s ease-in-out'
                    }}>
                        {activeTab === 'overview' && renderOverviewTab()}
                        {activeTab === 'progress' && renderProgressTab()}
                        {activeTab === 'goldenthread' && renderGoldenThreadTab()}
                        {activeTab === 'milestones' && renderMilestonesTab()}
                        {activeTab === 'resources' && renderResourcesTab()}
                        {activeTab === 'communications' && renderCommunicationsTab()}
                        {activeTab === 'activity' && renderActivityTab()}
                        {activeTab === 'financial' && renderFinancialTab()}
                        {activeTab === 'community' && renderCommunityTab()}
                    </div>
                </>
            )}
        </div>
    </div>
);
}

  
        
    
      // Enhanced Coach Detail Modal with Tabs for admin viewing coaches
function CoachDetailModal({ coach, onClose, onUpdate, currentUserId }) {
    const [activeTab, setActiveTab] = useState('overview');
    const [loading, setLoading] = useState(true);
    const [coachData, setCoachData] = useState({
        assignedPIRs: [],
        activities: [],
        assignments: [],
        checkInsReviewed: [],
        alerts: [],
        stats: {
            totalPIRs: 0,
            avgResponseTime: 0,
            checkInComplianceRate: 0,
            assignmentCompletionRate: 0,
            alertsHandled: 0,
            avgCaseloadDays: 0,
            lastActive: null,
            satisfactionScore: 0
        }
    });

    useEffect(() => {
        if (coach.role === 'coach' || coach.role === 'admin') {
            loadCoachData();
        } else {
            setLoading(false);
        }
    }, [coach]);

    const loadCoachData = async () => {
        try {
            setLoading(true);

            // Get all PIRs assigned to this coach
            const pirsSnap = await db.collection('users')
                .where('assignedCoach', '==', coach.id)
                .where('role', '==', 'pir')
                .get();

            const assignedPIRs = [];
            const pirIds = [];
            pirsSnap.forEach(doc => {
                const pirData = { id: doc.id, ...doc.data() };
                assignedPIRs.push(pirData);
                pirIds.push(doc.id);
            });

            // If coach has no PIRs, set empty data
            if (pirIds.length === 0) {
                setCoachData({
                    assignedPIRs: [],
                    activities: [],
                    assignments: [],
                    checkInsReviewed: [],
                    alerts: [],
                    stats: {
                        totalPIRs: 0,
                        avgResponseTime: 0,
                        checkInComplianceRate: 0,
                        assignmentCompletionRate: 0,
                        alertsHandled: 0,
                        avgCaseloadDays: 0,
                        lastActive: coach.lastActive || null,
                        satisfactionScore: 0
                    }
                });
                setLoading(false);
                return;
            }

            // Get assignments created by this coach
            const assignmentsSnap = await db.collection('assignments')
                .where('createdBy', '==', coach.id)
                .limit(50)
                .get();

            const assignments = [];
            let completedAssignments = 0;
            assignmentsSnap.forEach(doc => {
                const data = { id: doc.id, ...doc.data() };
                assignments.push(data);
                if (data.status === 'completed') completedAssignments++;
            });

            // Get recent check-ins for coach's PIRs (last 30 days)
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            // We'll need to batch query for PIR check-ins
            const checkInsPromises = pirIds.map(pirId => 
                db.collection('checkIns')
                    .where('userId', '==', pirId)
                    .where('createdAt', '>=', thirtyDaysAgo)
                    .get()
            );

            const checkInsSnapshots = await Promise.all(checkInsPromises);
            const allCheckIns = [];
            checkInsSnapshots.forEach(snapshot => {
                snapshot.forEach(doc => {
                    allCheckIns.push({ id: doc.id, ...doc.data() });
                });
            });

            // Get alerts for coach's PIRs
            const alertsPromises = pirIds.map(pirId =>
                db.collection('alerts')
                    .where('userId', '==', pirId)
                    .limit(10)
                    .get()
            );

            const alertsSnapshots = await Promise.all(alertsPromises);
            const alerts = [];
            alertsSnapshots.forEach(snapshot => {
                snapshot.forEach(doc => {
                    alerts.push({ id: doc.id, ...doc.data() });
                });
            });

            // Calculate statistics
            const now = new Date();
            const checkInComplianceRate = assignedPIRs.length > 0 ? 
                Math.round((allCheckIns.length / (assignedPIRs.length * 30)) * 100) : 0;

            const assignmentCompletionRate = assignments.length > 0 ?
                Math.round((completedAssignments / assignments.length) * 100) : 0;

            // Calculate average days with coach
            let totalDays = 0;
            assignedPIRs.forEach(pir => {
                if (pir.assignedDate) {
                    const assignedDate = pir.assignedDate.toDate ? pir.assignedDate.toDate() : new Date(pir.assignedDate);
                    totalDays += Math.floor((now - assignedDate) / (1000 * 60 * 60 * 24));
                }
            });
            const avgCaseloadDays = assignedPIRs.length > 0 ? Math.round(totalDays / assignedPIRs.length) : 0;

            // Get feedback scores for satisfaction
            const feedbackPromises = pirIds.map(pirId =>
                db.collection('feedback')
                    .where('userId', '==', pirId)
                    .where('type', '==', 'coach_rating')
                    .get()
            );

            const feedbackSnapshots = await Promise.all(feedbackPromises);
            let totalRating = 0;
            let ratingCount = 0;
            feedbackSnapshots.forEach(snapshot => {
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.rating) {
                        totalRating += data.rating;
                        ratingCount++;
                    }
                });
            });
            const satisfactionScore = ratingCount > 0 ? (totalRating / ratingCount).toFixed(1) : 0;

            // Sort data by date
            assignments.sort((a, b) => {
                const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
                const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
                return dateB - dateA;
            });

            alerts.sort((a, b) => {
                const dateA = a.timestamp?.toDate ? a.timestamp.toDate() : new Date(a.timestamp || 0);
                const dateB = b.timestamp?.toDate ? b.timestamp.toDate() : new Date(b.timestamp || 0);
                return dateB - dateA;
            });

            setCoachData({
                assignedPIRs,
                activities: [], // Would need activity logging to populate
                assignments,
                checkInsReviewed: allCheckIns,
                alerts,
                stats: {
                    totalPIRs: assignedPIRs.length,
                    avgResponseTime: 0, // Would need response tracking
                    checkInComplianceRate,
                    assignmentCompletionRate,
                    alertsHandled: alerts.filter(a => a.status === 'resolved').length,
                    avgCaseloadDays,
                    lastActive: coach.lastActive || null,
                    satisfactionScore
                }
            });

        } catch (error) {
            console.error('Error loading coach data:', error);
        } finally {
            setLoading(false);
        }
    };

    const handleAssignPIR = async () => {
        const pirEmail = prompt('Enter PIR email to assign:');
        if (pirEmail) {
            try {
                // Find PIR by email
                const pirQuery = await db.collection('users')
                    .where('email', '==', pirEmail)
                    .where('role', '==', 'pir')
                    .limit(1)
                    .get();

                if (pirQuery.empty) {
                    alert('PIR not found');
                    return;
                }

                const pirDoc = pirQuery.docs[0];
                await pirDoc.ref.update({
                    assignedCoach: coach.id,
                    assignedDate: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('PIR assigned successfully!');
                loadCoachData();
            } catch (error) {
                console.error('Error assigning PIR:', error);
                alert('Failed to assign PIR');
            }
        }
    };

    const handleRemovePIR = async (pirId) => {
        if (confirm('Remove this PIR from coach?')) {
            try {
                await db.collection('users').doc(pirId).update({
                    assignedCoach: null,
                    assignedDate: null
                });
                alert('PIR removed from coach');
                loadCoachData();
            } catch (error) {
                console.error('Error removing PIR:', error);
                alert('Failed to remove PIR');
            }
        }
    };

    const handleExportReport = () => {
        const report = {
            coach: {
                name: coach.displayName || coach.email,
                email: coach.email,
                role: coach.role,
                lastActive: coach.lastActive
            },
            stats: coachData.stats,
            assignedPIRs: coachData.assignedPIRs.map(pir => ({
                name: pir.displayName || pir.email,
                email: pir.email,
                daysWithCoach: pir.assignedDate ? 
                    Math.floor((new Date() - new Date(pir.assignedDate)) / (1000 * 60 * 60 * 24)) : 0,
                lastCheckIn: pir.lastCheckIn
            })),
            recentAssignments: coachData.assignments.slice(0, 20).map(a => ({
                title: a.title,
                status: a.status,
                createdAt: formatDate(a.createdAt)
            }))
        };

        const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `coach-report-${coach.email}-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
    };

    const renderOverviewTab = () => (
        <div className="tab-content">
            <div className="stats-grid">
                <div className="stat-card">
                    <div className="stat-label">Total PIRs</div>
                    <div className="stat-value" style={{fontSize: '2em'}}>
                        {coachData.stats.totalPIRs}
                    </div>
                </div>
                
                <div className="stat-card">
                    <div className="stat-label">PIR Compliance Rate</div>
                    <div className="stat-value" style={{fontSize: '2em', 
                        color: coachData.stats.checkInComplianceRate >= 70 ? '#4CAF50' : '#ff9800'}}>
                        {coachData.stats.checkInComplianceRate}%
                    </div>
                    <div className="stat-sublabel">Check-ins last 30 days</div>
                </div>
                
                <div className="stat-card">
                    <div className="stat-label">Assignment Completion</div>
                    <div className="stat-value" style={{fontSize: '2em'}}>
                        {coachData.stats.assignmentCompletionRate}%
                    </div>
                </div>
                
                <div className="stat-card">
                    <div className="stat-label">Satisfaction Score</div>
                    <div className="stat-value" style={{fontSize: '2em'}}>
                        {coachData.stats.satisfactionScore}/5
                    </div>
                </div>
            </div>

            <div className="info-section">
                <h4>Coach Information</h4>
                <div className="info-grid">
                    <div><strong>Email:</strong> {coach.email}</div>
                    <div><strong>Name:</strong> {coach.displayName || 'N/A'}</div>
                    <div><strong>Role:</strong> {coach.role}</div>
                    <div><strong>Status:</strong> 
                        <span className={`badge ${coach.active !== false ? 'badge-success' : 'badge-danger'}`}>
                            {coach.active !== false ? 'Active' : 'Inactive'}
                        </span>
                    </div>
                    <div><strong>Last Active:</strong> {coach.lastActive ? formatTimeAgo(coach.lastActive) : 'N/A'}</div>
                    <div><strong>Joined:</strong> {formatDate(coach.createdAt)}</div>
                </div>
            </div>
        </div>
    );

    const renderCaseloadTab = () => (
        <div className="tab-content">
            <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '20px'}}>
                <h4>Assigned PIRs ({coachData.assignedPIRs.length})</h4>
                <button className="btn btn-primary" onClick={handleAssignPIR}>
                    + Assign PIR
                </button>
            </div>
            
            <div className="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>PIR Name</th>
                            <th>Email</th>
                            <th>Days with Coach</th>
                            <th>Last Check-in</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {coachData.assignedPIRs.map(pir => {
                            const daysWithCoach = pir.assignedDate ? 
                                Math.floor((new Date() - new Date(pir.assignedDate)) / (1000 * 60 * 60 * 24)) : 0;
                            
                            return (
                                <tr key={pir.id}>
                                    <td>{pir.displayName || 'N/A'}</td>
                                    <td>{pir.email}</td>
                                    <td>{daysWithCoach} days</td>
                                    <td>{pir.lastCheckIn ? formatTimeAgo(pir.lastCheckIn) : 'Never'}</td>
                                    <td>
                                        <span className={`badge ${pir.active !== false ? 'badge-success' : 'badge-danger'}`}>
                                            {pir.active !== false ? 'Active' : 'Inactive'}
                                        </span>
                                    </td>
                                    <td>
                                        <button 
                                            className="action-btn"
                                            onClick={() => handleRemovePIR(pir.id)}
                                        >
                                            Remove
                                        </button>
                                    </td>
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
                {coachData.assignedPIRs.length === 0 && (
                    <div className="empty-state">No PIRs assigned to this coach</div>
                )}
            </div>
        </div>
    );

    const renderActivityTab = () => (
        <div className="tab-content">
            <h4>Recent Activity</h4>
            
            <div className="activity-section">
                <h5>Recent Assignments Created ({coachData.assignments.length})</h5>
                {coachData.assignments.slice(0, 10).map(assignment => (
                    <div key={assignment.id} className="activity-item">
                        <div className="activity-header">
                            <span className="activity-title">{assignment.title}</span>
                            <span className="activity-time">{formatTimeAgo(assignment.createdAt)}</span>
                        </div>
                        <div className="activity-meta">
                            Status: <span className={`badge ${
                                assignment.status === 'completed' ? 'badge-success' :
                                assignment.status === 'in_progress' ? 'badge-warning' :
                                'badge-secondary'
                            }`}>{assignment.status}</span>
                        </div>
                    </div>
                ))}
                {coachData.assignments.length === 0 && (
                    <div className="empty-state">No assignments created</div>
                )}
            </div>

            <div className="activity-section">
                <h5>Alerts from PIRs</h5>
                {coachData.alerts.slice(0, 10).map(alert => (
                    <div key={alert.id} className={`alert alert-${alert.type}`}>
                        <div className="alert-header">
                            <span className="alert-type">{alert.type.toUpperCase()}</span>
                            <span className="alert-time">{formatTimeAgo(alert.timestamp)}</span>
                        </div>
                        <div className="alert-message">{alert.message}</div>
                    </div>
                ))}
                {coachData.alerts.length === 0 && (
                    <div className="empty-state">No alerts</div>
                )}
            </div>
        </div>
    );

    const renderPerformanceTab = () => (
        <div className="tab-content">
            <h4>Performance Metrics</h4>
            
            <div className="performance-grid">
                <div className="metric-card">
                    <h5>PIR Outcomes</h5>
                    <div className="metric-item">
                        <span>Average Days with Coach:</span>
                        <strong>{coachData.stats.avgCaseloadDays} days</strong>
                    </div>
                    <div className="metric-item">
                        <span>Alerts Handled:</span>
                        <strong>{coachData.stats.alertsHandled}</strong>
                    </div>
                </div>

                <div className="metric-card">
                    <h5>Engagement</h5>
                    <div className="metric-item">
                        <span>Assignments Created:</span>
                        <strong>{coachData.assignments.length}</strong>
                    </div>
                    <div className="metric-item">
                        <span>Completion Rate:</span>
                        <strong>{coachData.stats.assignmentCompletionRate}%</strong>
                    </div>
                </div>

                <div className="metric-card">
                    <h5>Quality Indicators</h5>
                    <div className="metric-item">
                        <span>PIR Satisfaction:</span>
                        <strong>{coachData.stats.satisfactionScore}/5</strong>
                    </div>
                    <div className="metric-item">
                        <span>Check-in Compliance:</span>
                        <strong>{coachData.stats.checkInComplianceRate}%</strong>
                    </div>
                </div>
            </div>
        </div>
    );

    const renderWorkloadTab = () => (
        <div className="tab-content">
            <h4>Workload Analysis</h4>
            
            <div className="workload-section">
                <div className="workload-card">
                    <h5>Current Capacity</h5>
                    <div className="capacity-meter">
                        <div className="capacity-bar" style={{
                            width: `${Math.min(coachData.stats.totalPIRs * 10, 100)}%`,
                            backgroundColor: coachData.stats.totalPIRs > 10 ? '#ff9800' : '#4CAF50'
                        }}></div>
                    </div>
                    <p>{coachData.stats.totalPIRs} PIRs assigned (Recommended max: 10)</p>
                </div>

                <div className="workload-card">
                    <h5>PIR Distribution</h5>
                    {coachData.assignedPIRs.map(pir => {
                        const daysClean = pir.sobrietyDate ? 
                            Math.floor((new Date() - new Date(pir.sobrietyDate)) / (1000 * 60 * 60 * 24)) : 0;
                        
                        return (
                            <div key={pir.id} className="pir-workload-item">
                                <span>{pir.displayName || pir.email}</span>
                                <span className="badge badge-info">{daysClean} days clean</span>
                            </div>
                        );
                    })}
                </div>

                <div className="workload-recommendations">
                    <h5>Recommendations</h5>
                    {coachData.stats.totalPIRs > 10 && (
                        <div className="recommendation-item">
                            ⚠️ Consider redistributing caseload - coach has more than 10 PIRs
                        </div>
                    )}
                    {coachData.stats.checkInComplianceRate < 50 && (
                        <div className="recommendation-item">
                            ⚠️ Low check-in compliance - coach may need support or training
                        </div>
                    )}
                    {coachData.stats.totalPIRs === 0 && (
                        <div className="recommendation-item">
                            ℹ️ Coach has no assigned PIRs - ready for new assignments
                        </div>
                    )}
                </div>
            </div>
        </div>
    );

    const renderActionsTab = () => (
        <div className="tab-content">
            <h4>Admin Actions</h4>
            <div className="actions-grid">
                <button className="action-card" onClick={handleAssignPIR}>
                    <span className="action-icon">➕</span>
                    <span>Assign PIR</span>
                </button>
                
                <button className="action-card" onClick={handleExportReport}>
                    <span className="action-icon">📊</span>
                    <span>Export Report</span>
                </button>
                
                <button className="action-card" onClick={() => {
                    const newStatus = coach.active === false ? true : false;
                    db.collection('users').doc(coach.id).update({ active: newStatus })
                        .then(() => {
                            alert(`Coach ${newStatus ? 'activated' : 'deactivated'}`);
                            onUpdate();
                        });
                }}>
                    <span className="action-icon">{coach.active !== false ? '🚫' : '✅'}</span>
                    <span>{coach.active !== false ? 'Deactivate' : 'Activate'}</span>
                </button>
                
                <button className="action-card" onClick={() => loadCoachData()}>
                    <span className="action-icon">🔄</span>
                    <span>Refresh Data</span>
                </button>
            </div>
        </div>
    );

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{maxWidth: '900px', maxHeight: '80vh', overflowY: 'auto'}}>
                <div className="modal-header">
                    <h3>{coach.displayName || coach.email} - Coach View</h3>
                    <button className="close-btn" onClick={onClose}>×</button>
                </div>
                
                {coach.role === 'coach' || coach.role === 'admin' ? (
                    <>
                        <div className="tab-nav">
                            <button 
                                className={`tab-btn ${activeTab === 'overview' ? 'active' : ''}`}
                                onClick={() => setActiveTab('overview')}
                            >
                                Overview
                            </button>
                            <button 
                                className={`tab-btn ${activeTab === 'caseload' ? 'active' : ''}`}
                                onClick={() => setActiveTab('caseload')}
                            >
                                Caseload
                            </button>
                            <button 
                                className={`tab-btn ${activeTab === 'activity' ? 'active' : ''}`}
                                onClick={() => setActiveTab('activity')}
                            >
                                Activity
                            </button>
                            <button 
                                className={`tab-btn ${activeTab === 'performance' ? 'active' : ''}`}
                                onClick={() => setActiveTab('performance')}
                            >
                                Performance
                            </button>
                            <button 
                                className={`tab-btn ${activeTab === 'workload' ? 'active' : ''}`}
                                onClick={() => setActiveTab('workload')}
                            >
                                Workload
                            </button>
                            <button 
                                className={`tab-btn ${activeTab === 'actions' ? 'active' : ''}`}
                                onClick={() => setActiveTab('actions')}
                            >
                                Actions
                            </button>
                        </div>
                        
                        {loading ? (
                            <div className="loading-container">
                                <div className="loading-spinner"></div>
                            </div>
                        ) : (
                            <>
                                {activeTab === 'overview' && renderOverviewTab()}
                                {activeTab === 'caseload' && renderCaseloadTab()}
                                {activeTab === 'activity' && renderActivityTab()}
                                {activeTab === 'performance' && renderPerformanceTab()}
                                {activeTab === 'workload' && renderWorkloadTab()}
                                {activeTab === 'actions' && renderActionsTab()}
                            </>
                        )}
                    </>
                ) : (
                    <div className="modal-body">
                        <p>This user is not a coach.</p>
                    </div>
                )}
            </div>
        </div>
    );
}

        function CreateGroupModal({ onClose, onSuccess, adminId }) {
            const [formData, setFormData] = useState({
                name: '',
                description: '',
                dayOfWeek: 'Monday',
                time: '18:00',
                recurring: true,
                link: '',
                members: []
            });
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                
                try {
                    await db.collection('groups').add({
                        ...formData,
                        coachId: adminId,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        nextMeeting: calculateNextMeeting(formData.dayOfWeek, formData.time),
                        attendance: {}
                    });
                    
                    alert('Group created successfully!');
                    onSuccess();
                } catch (error) {
                    console.error('Error creating group:', error);
                    alert('Failed to create group');
                } finally {
                    setLoading(false);
                }
            };

            const calculateNextMeeting = (dayOfWeek, time) => {
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const targetDay = days.indexOf(dayOfWeek);
                const now = new Date();
                const currentDay = now.getDay();
                
                let daysUntilTarget = targetDay - currentDay;
                if (daysUntilTarget <= 0) {
                    daysUntilTarget += 7;
                }
                
                const nextMeeting = new Date();
                nextMeeting.setDate(nextMeeting.getDate() + daysUntilTarget);
                const [hours, minutes] = time.split(':');
                nextMeeting.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                
                return nextMeeting;
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">Create New Group</div>
                            <button className="modal-close" onClick={onClose}>×</button>
                        </div>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Group Name *</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    value={formData.name}
                                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                                    required
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Description *</label>
                                <textarea
                                    className="form-input"
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                    required
                                />
                            </div>
                            
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px'}}>
                                <div className="form-group">
                                    <label className="form-label">Day of Week *</label>
                                    <select 
                                        className="form-input"
                                        value={formData.dayOfWeek}
                                        onChange={(e) => setFormData({...formData, dayOfWeek: e.target.value})}
                                        required
                                    >
                                        <option value="Monday">Monday</option>
                                        <option value="Tuesday">Tuesday</option>
                                        <option value="Wednesday">Wednesday</option>
                                        <option value="Thursday">Thursday</option>
                                        <option value="Friday">Friday</option>
                                        <option value="Saturday">Saturday</option>
                                        <option value="Sunday">Sunday</option>
                                    </select>
                                </div>
                                
                                <div className="form-group">
                                    <label className="form-label">Time *</label>
                                    <input
                                        type="time"
                                        className="form-input"
                                        value={formData.time}
                                        onChange={(e) => setFormData({...formData, time: e.target.value})}
                                        required
                                    />
                                </div>
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Meeting Link (optional)</label>
                                <input
                                    type="url"
                                    className="form-input"
                                    placeholder="https://zoom.us/..."
                                    value={formData.link}
                                    onChange={(e) => setFormData({...formData, link: e.target.value})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <div className="checkbox-group">
                                    <input
                                        type="checkbox"
                                        id="recurring"
                                        checked={formData.recurring}
                                        onChange={(e) => setFormData({...formData, recurring: e.target.checked})}
                                    />
                                    <label htmlFor="recurring">Recurring Weekly</label>
                                </div>
                            </div>
                            
                            <div style={{display: 'flex', gap: '10px', marginTop: '20px'}}>
                                <button 
                                    type="submit"
                                    className="btn btn-primary"
                                    disabled={loading}
                                >
                                    {loading ? 'Creating...' : 'Create Group'}
                                </button>
                                <button 
                                    type="button"
                                    className="btn btn-secondary"
                                    onClick={onClose}
                                >
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }
 function GroupDetailModal({ group, onClose, onUpdate }) {
            const [addingMember, setAddingMember] = useState(false);
            const [newMemberEmail, setNewMemberEmail] = useState('');

            const addMember = async () => {
                if (!newMemberEmail) return;
                
                setAddingMember(true);
                try {
                    const userSnap = await db.collection('users')
                        .where('email', '==', newMemberEmail)
                        .get();
                    
                    if (userSnap.empty) {
                        alert('User not found');
                        return;
                    }
                    
                    const userId = userSnap.docs[0].id;
                    const members = group.members || [];
                    
                    if (members.includes(userId)) {
                        alert('User is already a member');
                        return;
                    }
                    
                    members.push(userId);
                    
                    await db.collection('groups').doc(group.id).update({
                        members: members
                    });
                    
                    alert('Member added successfully');
                    setNewMemberEmail('');
                    onUpdate();
                } catch (error) {
                    console.error('Error adding member:', error);
                    alert('Failed to add member');
                } finally {
                    setAddingMember(false);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">{group.name}</div>
                            <button className="modal-close" onClick={onClose}>×</button>
                        </div>
                        
                        <p style={{marginBottom: '20px'}}>{group.description}</p>
                        
                        <div style={{marginBottom: '20px'}}>
                            <strong>Schedule:</strong> {group.dayOfWeek} at {group.time}
                            {group.recurring && ' (Recurring)'}
                        </div>
                        
                        {group.link && (
                            <div style={{marginBottom: '20px'}}>
                                <strong>Meeting Link:</strong>{' '}
                                <a href={group.link} target="_blank" rel="noopener noreferrer" style={{color: '#f4c430'}}>
                                    {group.link}
                                </a>
                            </div>
                        )}
                        
                        <div style={{marginBottom: '20px'}}>
                            <h4 style={{marginBottom: '15px'}}>Members ({group.membersData?.length || 0})</h4>
                            
                            {group.membersData?.map(member => (
                                <div key={member.id} style={{
                                    padding: '10px',
                                    background: 'rgba(255,255,255,0.05)',
                                    borderRadius: '10px',
                                    marginBottom: '10px'
                                }}>
                                    {member.name}
                                </div>
                            ))}
                            
                            <div style={{display: 'flex', gap: '10px', marginTop: '15px'}}>
                                <input
                                    type="email"
                                    className="form-input"
                                    placeholder="Enter member email..."
                                    value={newMemberEmail}
                                    onChange={(e) => setNewMemberEmail(e.target.value)}
                                />
                                <button 
                                    className="btn btn-primary"
                                    onClick={addMember}
                                    disabled={addingMember}
                                >
                                    {addingMember ? 'Adding...' : 'Add Member'}
                                </button>
                            </div>
                        </div>
                        
                        <button className="btn btn-secondary" onClick={onClose}>Close</button>
                    </div>
                </div>
            );
        }

        function CreateResourceModal({ onClose, onSuccess }) {
            const [formData, setFormData] = useState({
                title: '',
                description: '',
                type: 'Link',
                url: '',
                content: '',
                category: 'General',
                isGlobal: true,
                assignedTo: []
            });
            const [file, setFile] = useState(null);
            const [uploadProgress, setUploadProgress] = useState(0);
            const [loading, setLoading] = useState(false);

            const handleFileChange = (e) => {
                const selectedFile = e.target.files[0];
                if (selectedFile) {
                    // Check file size (10MB limit)
                    if (selectedFile.size > 10 * 1024 * 1024) {
                        alert('File size must be less than 10MB');
                        return;
                    }
                    
                    // Check file type
                    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'image/webp'];
                    if (!allowedTypes.includes(selectedFile.type)) {
                        alert('Only PDF and image files are allowed');
                        return;
                    }
                    
                    setFile(selectedFile);
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                
                try {
                    const resourceData = {
                        ...formData,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: auth.currentUser.uid
                    };
                    
                    // If file upload is needed
                    if (file && formData.type !== 'Link') {
                        const resourceRef = db.collection('resources').doc();
                        const storageRef = storage.ref(`resources/${resourceRef.id}/${file.name}`);
                        
                        // Upload file with progress tracking
                        const uploadTask = storageRef.put(file);
                        
                        uploadTask.on('state_changed',
                            (snapshot) => {
                                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                setUploadProgress(progress);
                            },
                            (error) => {
                                console.error('Upload error:', error);
                                alert('Failed to upload file');
                                setLoading(false);
                            },
                            async () => {
                                // Get download URL
                                const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                                resourceData.fileURL = downloadURL;
                                resourceData.fileName = file.name;
                                
                                // Save to Firestore
                                await resourceRef.set(resourceData);
                                alert('Resource created successfully!');
                                onSuccess();
                            }
                        );
                    } else {
                        // No file upload, just save data
                        await db.collection('resources').add(resourceData);
                        alert('Resource created successfully!');
                        onSuccess();
                    }
                } catch (error) {
                    console.error('Error creating resource:', error);
                    alert('Failed to create resource');
                    setLoading(false);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">Add New Resource</div>
                            <button className="modal-close" onClick={onClose}>×</button>
                        </div>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Title *</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    value={formData.title}
                                    onChange={(e) => setFormData({...formData, title: e.target.value})}
                                    required
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Description *</label>
                                <textarea
                                    className="form-input"
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                    required
                                />
                            </div>
                            
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px'}}>
                                <div className="form-group">
                                    <label className="form-label">Type *</label>
                                    <select 
                                        className="form-input"
                                        value={formData.type}
                                        onChange={(e) => setFormData({...formData, type: e.target.value})}
                                        required
                                    >
                                        <option value="Link">Link</option>
                                        <option value="PDF">PDF</option>
                                        <option value="Video">Video</option>
                                        <option value="Article">Article</option>
                                        <option value="Audio">Audio</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                
                                <div className="form-group">
                                    <label className="form-label">Category</label>
                                    <select 
                                        className="form-input"
                                        value={formData.category}
                                        onChange={(e) => setFormData({...formData, category: e.target.value})}
                                    >
                                        <option value="General">General</option>
                                        <option value="Educational">Educational</option>
                                        <option value="Motivational">Motivational</option>
                                        <option value="Tools">Tools</option>
                                        <option value="Exercises">Exercises</option>
                                    </select>
                                </div>
                            </div>
                            
                            {formData.type === 'Link' ? (
                                <div className="form-group">
                                    <label className="form-label">URL *</label>
                                    <input
                                        type="url"
                                        className="form-input"
                                        value={formData.url}
                                        onChange={(e) => setFormData({...formData, url: e.target.value})}
                                        required
                                    />
                                </div>
                            ) : (
                                <div className="form-group">
                                    <label className="form-label">Upload File (Max 10MB)</label>
                                    <input
                                        type="file"
                                        className="form-input"
                                        onChange={handleFileChange}
                                        accept=".pdf,image/*"
                                    />
                                    {uploadProgress > 0 && uploadProgress < 100 && (
                                        <div style={{marginTop: '10px'}}>
                                            <div className="progress-bar">
                                                <div className="progress-fill" style={{width: `${uploadProgress}%`}}></div>
                                            </div>
                                            <div style={{fontSize: '12px', marginTop: '5px'}}>
                                                Uploading: {Math.round(uploadProgress)}%
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            {formData.type !== 'Link' && (
                                <div className="form-group">
                                    <label className="form-label">Additional Content/Notes</label>
                                    <textarea
                                        className="form-input"
                                        value={formData.content}
                                        onChange={(e) => setFormData({...formData, content: e.target.value})}
                                        placeholder="Add any additional notes or instructions..."
                                        rows="3"
                                    />
                                </div>
                            )}
                            
                            <div className="form-group">
                                <div className="checkbox-group">
                                    <input
                                        type="checkbox"
                                        id="isGlobal"
                                        checked={formData.isGlobal}
                                        onChange={(e) => setFormData({...formData, isGlobal: e.target.checked})}
                                    />
                                    <label htmlFor="isGlobal">Available to all PIRs</label>
                                </div>
                            </div>
                            
                            <div style={{display: 'flex', gap: '10px', marginTop: '20px'}}>
                                <button 
                                    type="submit"
                                    className="btn btn-primary"
                                    disabled={loading}
                                >
                                    {loading ? 'Creating...' : 'Create Resource'}
                                </button>
                                <button 
                                    type="button"
                                    className="btn btn-secondary"
                                    onClick={onClose}
                                    disabled={loading}
                                >
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function ResourceDetailModal({ resource, onClose }) {
            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">{resource.title}</div>
                            <button className="modal-close" onClick={onClose}>×</button>
                        </div>
                        
                        <div style={{marginBottom: '20px'}}>
                            <span className="badge badge-info">{resource.type}</span>
                            <span className="badge badge-info" style={{marginLeft: '10px'}}>{resource.category}</span>
                        </div>
                        
                        <p style={{marginBottom: '20px'}}>{resource.description}</p>
                        
                        {(resource.url || resource.fileURL) && (
                            <div style={{marginBottom: '20px'}}>
                                <a 
                                    href={resource.url || resource.fileURL}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="btn btn-primary"
                                >
                                    Open Resource
                                </a>
                            </div>
                        )}
                        
                        {resource.content && (
                            <div style={{
                                padding: '20px',
                                background: 'rgba(255,255,255,0.05)',
                                borderRadius: '10px',
                                whiteSpace: 'pre-wrap'
                            }}>
                                {resource.content}
                            </div>
                        )}
                    </div>
                </div>
            );
        }     
    // Initialize App
        ReactDOM.render(<AdminApp />, document.getElementById('root'));
    </script>
</body>
</html>
