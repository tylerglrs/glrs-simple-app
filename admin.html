<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GLRS Admin Portal - Complete</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1f3a 0%, #0d1117 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }

        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            color: #000;
            font-weight: bold;
            font-size: 18px;
            text-align: center;
        }

        .nav-section {
            padding: 10px;
        }

        .nav-section-title {
            font-size: 11px;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.5);
            padding: 10px;
            letter-spacing: 1px;
        }

        .nav-item {
            padding: 12px 15px;
            margin: 5px 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            color: #000;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            padding: 20px 30px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .search-bar {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            color: white;
            width: 300px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-bar:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #f4c430;
        }

        .refresh-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
            padding: 10px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .notification-bell:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .notification-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
        }

        .content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        /* Card Styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .stat-label {
            font-size: 12px;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .stat-change {
            font-size: 12px;
            color: #4caf50;
        }

        /* Table Styles */
        .table-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        th {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.8);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        td {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.9);
        }

        tr:hover td {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Button Styles */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
            outline: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            color: #000;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 196, 48, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: #1a1f3a;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #f4c430;
        }

        select.form-input {
            cursor: pointer;
        }

        textarea.form-input {
            resize: vertical;
            min-height: 100px;
        }

        /* Pagination Styles */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
        }

        .page-btn {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .page-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .page-btn.active {
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            color: #000;
            border: none;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Loading Spinner */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #f4c430;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 50px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-container {
            text-align: center;
            padding: 50px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 50px;
            color: rgba(255, 255, 255, 0.5);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .empty-state-text {
            font-size: 16px;
        }

        /* User Avatar */
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            color: white;
        }

        /* Status Badges */
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .badge-success {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
            border: 1px solid #4caf50;
        }

        .badge-warning {
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
            border: 1px solid #ff9800;
        }

        .badge-danger {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
            border: 1px solid #f44336;
        }

        .badge-info {
            background: rgba(33, 150, 243, 0.2);
            color: #2196f3;
            border: 1px solid #2196f3;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-btn:hover {
            color: rgba(255, 255, 255, 0.9);
        }

        .tab-btn.active {
            color: #f4c430;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
        }

        /* Notification Dropdown */
        .notification-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            width: 400px;
            background: #1a1f3a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin-top: 10px;
            max-height: 500px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .notification-header {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-item {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .notification-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .notification-item.unread {
            background: rgba(244, 196, 48, 0.1);
        }

        /* Charts */
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            height: 400px;
            position: relative;
        }

        /* Messages */
        .message-bubble {
            padding: 10px 15px;
            border-radius: 15px;
            margin-bottom: 10px;
            max-width: 70%;
        }

        .message-bubble.sent {
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            color: #000;
            align-self: flex-end;
            margin-left: auto;
        }

        .message-bubble.received {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
        }

        /* Groups */
        .group-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .group-title {
            font-size: 18px;
            font-weight: 600;
        }

        .group-members {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .member-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            border: 2px solid #1a1f3a;
        }

        /* Resources */
        .resource-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .resource-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .resource-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .resource-type {
            display: inline-block;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            font-size: 11px;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .resource-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .resource-description {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 15px;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1f3a 0%, #0d1117 100%);
        }

        .login-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-title {
            font-size: 32px;
            font-weight: bold;
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .error-message {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid #f44336;
            color: #f44336;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .success-message {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid #4caf50;
            color: #4caf50;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        /* Checkbox */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAufSTHtCTFSEIeZ9YzvrULCnji5I-SMi0",
            authDomain: "glrs-pir-system.firebaseapp.com",
            projectId: "glrs-pir-system",
            storageBucket: "glrs-pir-system.appspot.com",
            messagingSenderId: "830378577655",
            appId: "1:830378577655:web:your-app-id"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const { useState, useEffect, useRef, useMemo } = React;

        // Main App Component
        function AdminApp() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [currentView, setCurrentView] = useState('dashboard');
            const [searchQuery, setSearchQuery] = useState('');
            const [notifications, setNotifications] = useState([]);
            const [showNotifications, setShowNotifications] = useState(false);
            const [isCoachView, setIsCoachView] = useState(false);
            const [impersonatingUser, setImpersonatingUser] = useState(null);

            // Firestore listeners
            const unsubscribers = useRef([]);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (authUser) => {
                    if (authUser) {
                        // Check if admin
                        const userDoc = await db.collection('users').doc(authUser.uid).get();
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            if (userData.role === 'admin' || userData.role === 'coach') {
                                setUser({ uid: authUser.uid, ...userData });
                                setupRealtimeListeners(authUser.uid, userData.role);
                            } else {
                                auth.signOut();
                                alert('Access denied. Admin or Coach access required.');
                            }
                        } else {
                            auth.signOut();
                        }
                    } else {
                        setUser(null);
                        cleanupListeners();
                    }
                    setLoading(false);
                });

                return () => {
                    unsubscribe();
                    cleanupListeners();
                };
            }, []);

            const setupRealtimeListeners = (userId, role) => {
                // Listen to notifications
                const notifQuery = db.collection('notifications')
                    .where('recipientId', '==', userId)
                    .orderBy('createdAt', 'desc')
                    .limit(50);
                
                const unsubNotif = notifQuery.onSnapshot(snapshot => {
                    const notifs = [];
                    snapshot.forEach(doc => {
                        notifs.push({ id: doc.id, ...doc.data() });
                    });
                    setNotifications(notifs);
                });
                
                unsubscribers.current.push(unsubNotif);
            };

            const cleanupListeners = () => {
                unsubscribers.current.forEach(unsub => unsub());
                unsubscribers.current = [];
            };

            const handleLogout = async () => {
                try {
                    await auth.signOut();
                    setUser(null);
                    setCurrentView('dashboard');
                    setIsCoachView(false);
                    setImpersonatingUser(null);
                } catch (error) {
                    console.error('Logout error:', error);
                }
            };

            const handleImpersonate = (targetUser) => {
                setImpersonatingUser(targetUser);
                setIsCoachView(targetUser.role === 'coach');
            };

            const stopImpersonation = () => {
                setImpersonatingUser(null);
                setIsCoachView(false);
            };

            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="loading-spinner"></div>
                        <p style={{marginTop: '20px'}}>Loading Admin Portal...</p>
                    </div>
                );
            }

            if (!user) {
                return <LoginScreen />;
            }

            // If impersonating a PIR, show their view
            if (impersonatingUser && impersonatingUser.role === 'pir') {
                return <PIRViewScreen user={impersonatingUser} onBack={stopImpersonation} />;
            }

            const effectiveUser = impersonatingUser || user;
            const effectiveRole = isCoachView ? 'coach' : effectiveUser.role;

            return (
                <div className="app-container">
                    <Sidebar 
                        currentView={currentView}
                        setCurrentView={setCurrentView}
                        userRole={effectiveRole}
                        isImpersonating={!!impersonatingUser}
                        onStopImpersonation={stopImpersonation}
                    />
                    
                    <div className="main-content">
                        <Header 
                            currentView={currentView}
                            searchQuery={searchQuery}
                            setSearchQuery={setSearchQuery}
                            notifications={notifications}
                            showNotifications={showNotifications}
                            setShowNotifications={setShowNotifications}
                            onLogout={handleLogout}
                            user={effectiveUser}
                            isImpersonating={!!impersonatingUser}
                        />
                        
                        <div className="content">
                            {renderView(currentView, searchQuery, effectiveUser, effectiveRole, handleImpersonate)}
                        </div>
                    </div>
                </div>
            );
        }

        // Sidebar Component
        function Sidebar({ currentView, setCurrentView, userRole, isImpersonating, onStopImpersonation }) {
            const adminMenuItems = [
                { section: 'MAIN', items: [
                    { id: 'dashboard', label: 'Dashboard', icon: 'üìä' },
                    { id: 'users', label: 'Users', icon: 'üë•' },
                    { id: 'messages', label: 'Messages', icon: 'üí¨' }
                ]},
                { section: 'MANAGEMENT', items: [
                    { id: 'feedback', label: 'Feedback', icon: 'üìù' },
                    { id: 'resources', label: 'Resources', icon: 'üìö' },
                    { id: 'groups', label: 'Groups', icon: 'üë´' }
                ]},
                { section: 'MONITORING', items: [
                    { id: 'checkins', label: 'Check-ins', icon: '‚úÖ' },
                    { id: 'assignments', label: 'Assignments', icon: 'üìã' },
                    { id: 'alerts', label: 'Alerts', icon: 'üö®' }
                ]},
                { section: 'SYSTEM', items: [
                    { id: 'reports', label: 'Reports', icon: 'üìà' },
                    { id: 'settings', label: 'Settings', icon: '‚öôÔ∏è' }
                ]}
            ];

            const coachMenuItems = [
                { section: 'MAIN', items: [
                    { id: 'dashboard', label: 'Dashboard', icon: 'üìä' },
                    { id: 'users', label: 'My PIRs', icon: 'üë•' },
                    { id: 'messages', label: 'Messages', icon: 'üí¨' }
                ]},
                { section: 'MANAGEMENT', items: [
                    { id: 'resources', label: 'Resources', icon: 'üìö' },
                    { id: 'groups', label: 'My Groups', icon: 'üë´' }
                ]},
                { section: 'MONITORING', items: [
                    { id: 'checkins', label: 'Check-ins', icon: '‚úÖ' },
                    { id: 'assignments', label: 'Assignments', icon: 'üìã' }
                ]}
            ];

            const menuItems = userRole === 'admin' ? adminMenuItems : coachMenuItems;

            return (
                <div className="sidebar">
                    <div className="sidebar-header">
                        üõ°Ô∏è GLRS Admin Portal
                        {isImpersonating && (
                            <div style={{fontSize: '12px', marginTop: '5px'}}>
                                (Viewing as {userRole})
                            </div>
                        )}
                    </div>
                    
                    {isImpersonating && (
                        <div style={{padding: '10px'}}>
                            <button 
                                className="btn btn-secondary"
                                style={{width: '100%'}}
                                onClick={onStopImpersonation}
                            >
                                ‚Üê Stop Impersonation
                            </button>
                        </div>
                    )}
                    
                    {menuItems.map(section => (
                        <div key={section.section} className="nav-section">
                            <div className="nav-section-title">{section.section}</div>
                            {section.items.map(item => (
                                <div
                                    key={item.id}
                                    className={`nav-item ${currentView === item.id ? 'active' : ''}`}
                                    onClick={() => setCurrentView(item.id)}
                                >
                                    <span>{item.icon}</span>
                                    <span>{item.label}</span>
                                </div>
                            ))}
                        </div>
                    ))}
                </div>
            );
        }

        // Header Component
        function Header({ currentView, searchQuery, setSearchQuery, notifications, showNotifications, setShowNotifications, onLogout, user, isImpersonating }) {
            const [refreshing, setRefreshing] = useState(false);
            const notificationRef = useRef(null);
            
            const unreadCount = notifications.filter(n => !n.read).length;

            const handleRefresh = () => {
                setRefreshing(true);
                window.location.reload();
            };

            const clearNotification = async (notifId) => {
                try {
                    await db.collection('notifications').doc(notifId).update({ read: true });
                } catch (error) {
                    console.error('Error clearing notification:', error);
                }
            };

            const clearAllNotifications = async () => {
                try {
                    const batch = db.batch();
                    notifications.forEach(notif => {
                        if (!notif.read) {
                            batch.update(db.collection('notifications').doc(notif.id), { read: true });
                        }
                    });
                    await batch.commit();
                } catch (error) {
                    console.error('Error clearing all notifications:', error);
                }
            };

            const handleNotificationClick = (notif) => {
                clearNotification(notif.id);
                setShowNotifications(false);
                
                // Navigate based on notification type
                if (notif.type === 'sos') {
                    window.location.hash = `#user/${notif.relatedId}`;
                } else if (notif.type === 'checkin') {
                    window.location.hash = `#checkin/${notif.relatedId}`;
                } else if (notif.type === 'message') {
                    window.location.hash = `#messages/${notif.relatedId}`;
                } else if (notif.type === 'assignment') {
                    window.location.hash = `#assignment/${notif.relatedId}`;
                }
            };

            // Close notifications when clicking outside
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (notificationRef.current && !notificationRef.current.contains(event.target)) {
                        setShowNotifications(false);
                    }
                };
                
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            const getViewTitle = () => {
                const titles = {
                    dashboard: 'Dashboard',
                    users: user.role === 'coach' ? 'My PIRs' : 'User Management',
                    messages: 'Messages',
                    feedback: 'Feedback',
                    resources: 'Resources',
                    groups: 'Groups & Workshops',
                    checkins: 'Check-ins',
                    assignments: 'Assignments',
                    alerts: 'Alerts',
                    reports: 'Reports',
                    settings: 'System Settings'
                };
                return titles[currentView] || 'Admin Portal';
            };

            return (
                <div className="header">
                    <div className="header-title">
                        {getViewTitle()}
                        {isImpersonating && (
                            <span style={{fontSize: '14px', marginLeft: '10px', opacity: 0.7}}>
                                (Viewing as {user.displayName})
                            </span>
                        )}
                    </div>
                    
                    <div className="header-actions">
                        <input
                            type="text"
                            className="search-bar"
                            placeholder="Search users, messages, resources..."
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                        />
                        
                        <button 
                            className="refresh-btn"
                            onClick={handleRefresh}
                            disabled={refreshing}
                        >
                            {refreshing ? '‚ü≥' : '‚Üª'} Refresh
                        </button>
                        
                        <div className="notification-bell" ref={notificationRef}>
                            <div onClick={() => setShowNotifications(!showNotifications)}>
                                üîî
                                {unreadCount > 0 && (
                                    <div className="notification-badge">{unreadCount}</div>
                                )}
                            </div>
                            
                            {showNotifications && (
                                <div className="notification-dropdown">
                                    <div className="notification-header">
                                        <span>Notifications ({unreadCount})</span>
                                        <button 
                                            className="btn btn-secondary"
                                            style={{padding: '5px 10px', fontSize: '12px'}}
                                            onClick={clearAllNotifications}
                                        >
                                            Clear All
                                        </button>
                                    </div>
                                    
                                    {notifications.length === 0 ? (
                                        <div className="empty-state" style={{padding: '20px'}}>
                                            <div className="empty-state-text">No notifications</div>
                                        </div>
                                    ) : (
                                        notifications.map(notif => (
                                            <div 
                                                key={notif.id}
                                                className={`notification-item ${notif.read ? '' : 'unread'}`}
                                                onClick={() => handleNotificationClick(notif)}
                                            >
                                                <div style={{display: 'flex', justifyContent: 'space-between'}}>
                                                    <span>{notif.message}</span>
                                                    {notif.urgent && <span className="badge badge-danger">Urgent</span>}
                                                </div>
                                                <div style={{fontSize: '12px', opacity: 0.7, marginTop: '5px'}}>
                                                    {formatTimeAgo(notif.createdAt)}
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            )}
                        </div>
                        
                        <button className="btn btn-secondary" onClick={onLogout}>
                            Logout
                        </button>
                    </div>
                </div>
            );
        }

        // Login Screen
        function LoginScreen() {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    setError(error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="login-container">
                    <div className="login-card">
                        <div className="login-header">
                            <div className="login-title">GLRS Admin Portal</div>
                            <p style={{color: 'rgba(255,255,255,0.7)'}}>Administrator & Coach Access</p>
                        </div>
                        
                        {error && <div className="error-message">{error}</div>}
                        
                        <form onSubmit={handleLogin}>
                            <div className="form-group">
                                <label className="form-label">Email</label>
                                <input
                                    type="email"
                                    className="form-input"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    required
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Password</label>
                                <input
                                    type="password"
                                    className="form-input"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    required
                                />
                            </div>
                            
                            <button 
                                type="submit"
                                className="btn btn-primary"
                                style={{width: '100%'}}
                                disabled={loading}
                            >
                                {loading ? 'Logging in...' : 'Login'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // PIR View Screen (when viewing as user)
        function PIRViewScreen({ user, onBack }) {
            const [checkIns, setCheckIns] = useState([]);
            const [assignments, setAssignments] = useState([]);
            const [messages, setMessages] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                loadPIRData();
            }, [user.id]);

            const loadPIRData = async () => {
                try {
                    // Load check-ins
                    const checkInsSnap = await db.collection('checkIns')
                        .where('userId', '==', user.id)
                        .orderBy('createdAt', 'desc')
                        .limit(30)
                        .get();
                    
                    const checkInsData = [];
                    checkInsSnap.forEach(doc => {
                        checkInsData.push({ id: doc.id, ...doc.data() });
                    });
                    setCheckIns(checkInsData);

                    // Load assignments
                    const assignmentsSnap = await db.collection('assignments')
                        .where('pirId', '==', user.id)
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    const assignmentsData = [];
                    assignmentsSnap.forEach(doc => {
                        assignmentsData.push({ id: doc.id, ...doc.data() });
                    });
                    setAssignments(assignmentsData);

                    // Load messages
                    const messagesSnap = await db.collection('messages')
                        .where('recipientId', '==', user.id)
                        .orderBy('createdAt', 'desc')
                        .limit(50)
                        .get();
                    
                    const messagesData = [];
                    messagesSnap.forEach(doc => {
                        messagesData.push({ id: doc.id, ...doc.data() });
                    });
                    setMessages(messagesData);

                } catch (error) {
                    console.error('Error loading PIR data:', error);
                } finally {
                    setLoading(false);
                }
            };

            const calculateDaysSober = () => {
                if (!user.sobrietyDate) return 0;
                const sobrietyDate = user.sobrietyDate.toDate ? user.sobrietyDate.toDate() : new Date(user.sobrietyDate);
                const today = new Date();
                const diffTime = Math.abs(today - sobrietyDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays;
            };

            const getLatestMood = () => {
                if (checkIns.length === 0) return 'N/A';
                const latest = checkIns[0];
                return latest.morningData?.mood || latest.eveningData?.mood || 'N/A';
            };

            const getLatestCraving = () => {
                if (checkIns.length === 0) return 'N/A';
                const latest = checkIns[0];
                return latest.morningData?.craving || latest.eveningData?.craving || 'N/A';
            };

            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="loading-spinner"></div>
                        <p style={{marginTop: '20px'}}>Loading PIR View...</p>
                    </div>
                );
            }

            return (
                <div style={{padding: '20px', minHeight: '100vh', background: 'linear-gradient(135deg, #1a1f3a 0%, #0d1117 100%)'}}>
                    <button className="btn btn-secondary" onClick={onBack} style={{marginBottom: '20px'}}>
                        ‚Üê Back to Admin Portal
                    </button>
                    
                    <h1 style={{marginBottom: '30px'}}>Viewing as: {user.displayName || user.email}</h1>
                    
                    {/* Stats Overview */}
                    <div className="stats-grid">
                        <div className="stat-card">
                            <div className="stat-label">Days Sober</div>
                            <div className="stat-value">{calculateDaysSober()}</div>
                            <div className="stat-change">Keep going!</div>
                        </div>
                        
                        <div className="stat-card">
                            <div className="stat-label">Latest Mood</div>
                            <div className="stat-value">{getLatestMood()}/10</div>
                        </div>
                        
                        <div className="stat-card">
                            <div className="stat-label">Latest Craving</div>
                            <div className="stat-value">{getLatestCraving()}/10</div>
                        </div>
                        
                        <div className="stat-card">
                            <div className="stat-label">Assignments</div>
                            <div className="stat-value">{assignments.filter(a => a.status !== 'completed').length}</div>
                            <div className="stat-change">Pending</div>
                        </div>
                    </div>
                    
                    {/* Progress Charts */}
                    <div className="table-container" style={{marginTop: '30px'}}>
                        <h3 style={{marginBottom: '20px'}}>Progress Overview</h3>
                        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px'}}>
                            <MoodChart checkIns={checkIns} />
                            <CravingChart checkIns={checkIns} />
                        </div>
                    </div>
                    
                    {/* Recent Check-ins */}
                    <div className="table-container" style={{marginTop: '30px'}}>
                        <h3 style={{marginBottom: '20px'}}>Recent Check-ins</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Mood</th>
                                    <th>Craving</th>
                                    <th>Sleep</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {checkIns.slice(0, 10).map(checkIn => (
                                    <tr key={checkIn.id}>
                                        <td>{formatDate(checkIn.createdAt)}</td>
                                        <td>{checkIn.type || 'Morning'}</td>
                                        <td>{checkIn.morningData?.mood || checkIn.eveningData?.mood || '-'}</td>
                                        <td>{checkIn.morningData?.craving || checkIn.eveningData?.craving || '-'}</td>
                                        <td>{checkIn.morningData?.sleep || '-'}</td>
                                        <td>{checkIn.morningData?.notes || checkIn.eveningData?.reflection || '-'}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    
                    {/* Active Assignments */}
                    <div className="table-container" style={{marginTop: '30px'}}>
                        <h3 style={{marginBottom: '20px'}}>Active Assignments</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Description</th>
                                    <th>Due Date</th>
                                    <th>Status</th>
                                    <th>Progress</th>
                                </tr>
                            </thead>
                            <tbody>
                                {assignments.filter(a => a.status !== 'completed').map(assignment => (
                                    <tr key={assignment.id}>
                                        <td>{assignment.title}</td>
                                        <td>{assignment.description}</td>
                                        <td>{formatDate(assignment.dueDate)}</td>
                                        <td>
                                            <span className={`badge ${
                                                assignment.status === 'completed' ? 'badge-success' :
                                                assignment.status === 'in-progress' ? 'badge-warning' :
                                                'badge-info'
                                            }`}>
                                                {assignment.status}
                                            </span>
                                        </td>
                                        <td>
                                            <div className="progress-bar">
                                                <div className="progress-fill" style={{width: `${assignment.progress || 0}%`}}></div>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // View Renderer
        function renderView(view, searchQuery, user, userRole, onImpersonate) {
            switch(view) {
                case 'dashboard':
                    return <DashboardView user={user} userRole={userRole} />;
                case 'users':
                    return <UsersView searchQuery={searchQuery} user={user} userRole={userRole} onImpersonate={onImpersonate} />;
                case 'messages':
                    return <MessagesView user={user} userRole={userRole} />;
                case 'feedback':
                    return userRole === 'admin' ? <FeedbackView /> : <div className="empty-state">Access Denied</div>;
                case 'resources':
                    return <ResourcesView user={user} userRole={userRole} />;
                case 'groups':
                    return <GroupsView user={user} userRole={userRole} />;
                case 'checkins':
                    return <CheckInsView user={user} userRole={userRole} />;
                case 'assignments':
                    return <AssignmentsView user={user} userRole={userRole} />;
                case 'alerts':
                    return userRole === 'admin' ? <AlertsView /> : <div className="empty-state">Access Denied</div>;
                case 'reports':
                    return userRole === 'admin' ? <ReportsView /> : <div className="empty-state">Access Denied</div>;
                case 'settings':
                    return userRole === 'admin' ? <SettingsView /> : <div className="empty-state">Access Denied</div>;
                default:
                    return <div className="empty-state">View not found</div>;
            }
        }

        // Dashboard View
        function DashboardView({ user, userRole }) {
            const [stats, setStats] = useState({
                totalPirs: 0,
                activePirs: 0,
                totalCoaches: 0,
                checkInRate: 0,
                sosAlerts: 0,
                pendingAssignments: 0,
                unreadMessages: 0,
                upcomingGroups: 0
            });
            const [recentActivity, setRecentActivity] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                loadDashboardData();
            }, [user.uid, userRole]);

            const loadDashboardData = async () => {
                try {
                    if (userRole === 'admin') {
                        // Admin sees all data
                        const usersSnap = await db.collection('users').get();
                        const pirs = [];
                        const coaches = [];
                        
                        usersSnap.forEach(doc => {
                            const data = doc.data();
                            if (data.role === 'pir') pirs.push({ id: doc.id, ...data });
                            if (data.role === 'coach') coaches.push({ id: doc.id, ...data });
                        });

                        // Get today's check-ins
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const checkInsSnap = await db.collection('checkIns')
                            .where('createdAt', '>=', today)
                            .get();
                        
                        const checkInRate = pirs.length > 0 ? 
                            Math.round((checkInsSnap.size / pirs.length) * 100) : 0;

                        // Get SOS alerts
                        const sosSnap = await db.collection('alerts')
                            .where('type', '==', 'sos')
                            .where('resolved', '==', false)
                            .get();

                        // Get pending assignments
                        const assignmentsSnap = await db.collection('assignments')
                            .where('status', '!=', 'completed')
                            .get();

                        // Get unread messages
                        const messagesSnap = await db.collection('messages')
                            .where('recipientId', '==', user.uid)
                            .where('read', '==', false)
                            .get();

                        // Get upcoming groups
                        const groupsSnap = await db.collection('groups')
                            .where('nextMeeting', '>=', new Date())
                            .get();

                        setStats({
                            totalPirs: pirs.length,
                            activePirs: pirs.filter(p => p.active !== false).length,
                            totalCoaches: coaches.length,
                            checkInRate: checkInRate,
                            sosAlerts: sosSnap.size,
                            pendingAssignments: assignmentsSnap.size,
                            unreadMessages: messagesSnap.size,
                            upcomingGroups: groupsSnap.size
                        });

                    } else if (userRole === 'coach') {
                        // Coach sees only their PIRs
                        const pirsSnap = await db.collection('users')
                            .where('role', '==', 'pir')
                            .where('assignedCoach', '==', user.uid)
                            .get();
                        
                        const pirs = [];
                        pirsSnap.forEach(doc => {
                            pirs.push({ id: doc.id, ...doc.data() });
                        });

                        // Get today's check-ins for coach's PIRs
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        
                        let checkInCount = 0;
                        for (const pir of pirs) {
                            const checkInSnap = await db.collection('checkIns')
                                .where('userId', '==', pir.id)
                                .where('createdAt', '>=', today)
                                .limit(1)
                                .get();
                            if (!checkInSnap.empty) checkInCount++;
                        }
                        
                        const checkInRate = pirs.length > 0 ? 
                            Math.round((checkInCount / pirs.length) * 100) : 0;

                        // Get pending assignments for coach's PIRs
                        let pendingAssignments = 0;
                        for (const pir of pirs) {
                            const assignmentsSnap = await db.collection('assignments')
                                .where('pirId', '==', pir.id)
                                .where('status', '!=', 'completed')
                                .get();
                            pendingAssignments += assignmentsSnap.size;
                        }

                        // Get unread messages
                        const messagesSnap = await db.collection('messages')
                            .where('recipientId', '==', user.uid)
                            .where('read', '==', false)
                            .get();

                        // Get coach's groups
                        const groupsSnap = await db.collection('groups')
                            .where('coachId', '==', user.uid)
                            .where('nextMeeting', '>=', new Date())
                            .get();

                        setStats({
                            totalPirs: pirs.length,
                            activePirs: pirs.filter(p => p.active !== false).length,
                            totalCoaches: 1,
                            checkInRate: checkInRate,
                            sosAlerts: 0,
                            pendingAssignments: pendingAssignments,
                            unreadMessages: messagesSnap.size,
                            upcomingGroups: groupsSnap.size
                        });
                    }

                    // Load recent activity
                    const activitySnap = await db.collection('notifications')
                        .where('recipientId', '==', user.uid)
                        .orderBy('createdAt', 'desc')
                        .limit(10)
                        .get();
                    
                    const activity = [];
                    activitySnap.forEach(doc => {
                        activity.push({ id: doc.id, ...doc.data() });
                    });
                    setRecentActivity(activity);

                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                } finally {
                    setLoading(false);
                }
            };

            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="loading-spinner"></div>
                    </div>
                );
            }

            return (
                <div>
                    <div className="stats-grid">
                        <div className="stat-card">
                            <div className="stat-label">Total PIRs</div>
                            <div className="stat-value">{stats.totalPirs}</div>
                            <div className="stat-change">{stats.activePirs} active</div>
                        </div>
                        
                        {userRole === 'admin' && (
                            <div className="stat-card">
                                <div className="stat-label">Total Coaches</div>
                                <div className="stat-value">{stats.totalCoaches}</div>
                            </div>
                        )}
                        
                        <div className="stat-card">
                            <div className="stat-label">Check-in Rate</div>
                            <div className="stat-value">{stats.checkInRate}%</div>
                            <div className="stat-change">Today</div>
                        </div>
                        
                        {userRole === 'admin' && (
                            <div className="stat-card">
                                <div className="stat-label">SOS Alerts</div>
                                <div className="stat-value">{stats.sosAlerts}</div>
                                <div className="stat-change" style={{color: stats.sosAlerts > 0 ? '#f44336' : '#4caf50'}}>
                                    {stats.sosAlerts > 0 ? 'Needs attention' : 'All clear'}
                                </div>
                            </div>
                        )}
                        
                        <div className="stat-card">
                            <div className="stat-label">Pending Assignments</div>
                            <div className="stat-value">{stats.pendingAssignments}</div>
                        </div>
                        
                        <div className="stat-card">
                            <div className="stat-label">Unread Messages</div>
                            <div className="stat-value">{stats.unreadMessages}</div>
                        </div>
                        
                        <div className="stat-card">
                            <div className="stat-label">Upcoming Groups</div>
                            <div className="stat-value">{stats.upcomingGroups}</div>
                        </div>
                    </div>
                    
                    <div className="table-container" style={{marginTop: '30px'}}>
                        <h3 style={{marginBottom: '20px'}}>Recent Activity</h3>
                        {recentActivity.length === 0 ? (
                            <div className="empty-state">
                                <div className="empty-state-text">No recent activity</div>
                            </div>
                        ) : (
                            <table>
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Type</th>
                                        <th>Message</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {recentActivity.map(item => (
                                        <tr key={item.id}>
                                            <td>{formatTimeAgo(item.createdAt)}</td>
                                            <td>
                                                <span className={`badge ${
                                                    item.type === 'sos' ? 'badge-danger' :
                                                    item.type === 'checkin' ? 'badge-success' :
                                                    item.type === 'message' ? 'badge-info' :
                                                    'badge-warning'
                                                }`}>
                                                    {item.type}
                                                </span>
                                            </td>
                                            <td>{item.message}</td>
                                            <td>{item.read ? 'Read' : 'Unread'}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        )}
                    </div>
                </div>
            );
        }

        // Users View
        function UsersView({ searchQuery, user, userRole, onImpersonate }) {
            const [users, setUsers] = useState([]);
            const [filteredUsers, setFilteredUsers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [currentPage, setCurrentPage] = useState(1);
            const [showCreateModal, setShowCreateModal] = useState(false);
            const [selectedUser, setSelectedUser] = useState(null);
            const itemsPerPage = 20;

            useEffect(() => {
                loadUsers();
            }, [user.uid, userRole]);

            useEffect(() => {
                filterUsers();
            }, [users, searchQuery]);

            const loadUsers = async () => {
                try {
                    let query = db.collection('users');
                    
                    if (userRole === 'coach') {
                        // Coach sees only their PIRs
                        query = query.where('role', '==', 'pir')
                                   .where('assignedCoach', '==', user.uid);
                    }
                    
                    const snapshot = await query.get();
                    const usersData = [];
                    
                    for (const doc of snapshot.docs) {
                        const userData = { id: doc.id, ...doc.data() };
                        
                        // Get coach name if user has assignedCoach
                        if (userData.assignedCoach) {
                            const coachDoc = await db.collection('users').doc(userData.assignedCoach).get();
                            if (coachDoc.exists) {
                                userData.coachName = coachDoc.data().displayName || coachDoc.data().email;
                            }
                        }
                        
                        // Get last check-in
                        const checkInSnap = await db.collection('checkIns')
                            .where('userId', '==', doc.id)
                            .orderBy('createdAt', 'desc')
                            .limit(1)
                            .get();
                        
                        if (!checkInSnap.empty) {
                            userData.lastCheckIn = checkInSnap.docs[0].data().createdAt;
                        }
                        
                        usersData.push(userData);
                    }
                    
                    setUsers(usersData);
                    setFilteredUsers(usersData);
                } catch (error) {
                    console.error('Error loading users:', error);
                } finally {
                    setLoading(false);
                }
            };

            const filterUsers = () => {
                if (!searchQuery) {
                    setFilteredUsers(users);
                    return;
                }
                
                const query = searchQuery.toLowerCase();
                const filtered = users.filter(user => 
                    user.email?.toLowerCase().includes(query) ||
                    user.displayName?.toLowerCase().includes(query) ||
                    user.firstName?.toLowerCase().includes(query) ||
                    user.lastName?.toLowerCase().includes(query)
                );
                setFilteredUsers(filtered);
                setCurrentPage(1);
            };

            const paginatedUsers = filteredUsers.slice(
                (currentPage - 1) * itemsPerPage,
                currentPage * itemsPerPage
            );

            const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);

            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="loading-spinner"></div>
                    </div>
                );
            }

            return (
                <div>
                    <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '20px'}}>
                        <div>
                            Showing {paginatedUsers.length} of {filteredUsers.length} users
                        </div>
                        {userRole === 'admin' && (
                            <button className="btn btn-primary" onClick={() => setShowCreateModal(true)}>
                                + Create User
                            </button>
                        )}
                    </div>
                    
                    <div className="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Assigned Coach</th>
                                    <th>Last Check-in</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {paginatedUsers.map(user => (
                                    <tr key={user.id}>
                                        <td>
                                            <div style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                                                <div className="user-avatar">
                                                    {(user.displayName || user.email || 'U').charAt(0).toUpperCase()}
                                                </div>
                                                <span>{user.displayName || 'N/A'}</span>
                                            </div>
                                        </td>
                                        <td>{user.email}</td>
                                        <td>
                                            <span className="badge badge-info">{user.role}</span>
                                        </td>
                                        <td>
                                            <span className={`badge ${user.active !== false ? 'badge-success' : 'badge-danger'}`}>
                                                {user.active !== false ? 'Active' : 'Inactive'}
                                            </span>
                                        </td>
                                        <td>{user.coachName || '-'}</td>
                                        <td>{user.lastCheckIn ? formatTimeAgo(user.lastCheckIn) : 'Never'}</td>
                                        <td>
                                            <div className="action-buttons">
                                                <button 
                                                    className="action-btn"
                                                    onClick={() => setSelectedUser(user)}
                                                >
                                                    View
                                                </button>
                                                {user.role !== 'admin' && (
                                                    <button 
                                                        className="action-btn"
                                                        onClick={() => onImpersonate(user)}
                                                    >
                                                        View As
                                                    </button>
                                                )}
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        
                        {filteredUsers.length === 0 && (
                            <div className="empty-state">
                                <div className="empty-state-text">No users found</div>
                            </div>
                        )}
                    </div>
                    
                    {totalPages > 1 && (
                        <Pagination 
                            currentPage={currentPage}
                            totalPages={totalPages}
                            onPageChange={setCurrentPage}
                        />
                    )}
                    
                    {showCreateModal && (
                        <CreateUserModal 
                            onClose={() => setShowCreateModal(false)}
                            onSuccess={() => {
                                setShowCreateModal(false);
                                loadUsers();
                            }}
                        />
                    )}
                    
                    {selectedUser && (
                        <UserDetailModal 
                            user={selectedUser}
                            onClose={() => setSelectedUser(null)}
                            onUpdate={() => loadUsers()}
                            currentUserId={user.uid}
                            userRole={userRole}
                        />
                    )}
                </div>
            );
        }

        // Messages View
        function MessagesView({ user, userRole }) {
            const [conversations, setConversations] = useState([]);
            const [selectedConversation, setSelectedConversation] = useState(null);
            const [messages, setMessages] = useState([]);
            const [messageText, setMessageText] = useState('');
            const [loading, setLoading] = useState(true);
            const [sendingMessage, setSendingMessage] = useState(false);

            useEffect(() => {
                loadConversations();
            }, [user.uid]);

            useEffect(() => {
                if (selectedConversation) {
                    const unsubscribe = db.collection('messages')
                        .where('conversationId', '==', selectedConversation.id)
                        .orderBy('createdAt', 'asc')
                        .onSnapshot(snapshot => {
                            const msgs = [];
                            snapshot.forEach(doc => {
                                msgs.push({ id: doc.id, ...doc.data() });
                            });
                            setMessages(msgs);
                            
                            // Mark messages as read
                            msgs.forEach(msg => {
                                if (msg.recipientId === user.uid && !msg.read) {
                                    db.collection('messages').doc(msg.id).update({ read: true });
                                }
                            });
                        });
                    
                    return () => unsubscribe();
                }
            }, [selectedConversation]);

            const loadConversations = async () => {
                try {
                    // Get all messages where user is sender or recipient
                    const sentQuery = await db.collection('messages')
                        .where('senderId', '==', user.uid)
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    const receivedQuery = await db.collection('messages')
                        .where('recipientId', '==', user.uid)
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    const conversationsMap = new Map();
                    
                    // Process sent messages
                    sentQuery.forEach(doc => {
                        const msg = doc.data();
                        const otherUserId = msg.recipientId;
                        if (!conversationsMap.has(otherUserId)) {
                            conversationsMap.set(otherUserId, {
                                id: otherUserId,
                                userId: otherUserId,
                                userName: msg.recipientName,
                                lastMessage: msg.text,
                                lastMessageTime: msg.createdAt,
                                unread: false
                            });
                        }
                    });
                    
                    // Process received messages
                    receivedQuery.forEach(doc => {
                        const msg = doc.data();
                        const otherUserId = msg.senderId;
                        if (!conversationsMap.has(otherUserId)) {
                            conversationsMap.set(otherUserId, {
                                id: otherUserId,
                                userId: otherUserId,
                                userName: msg.senderName,
                                lastMessage: msg.text,
                                lastMessageTime: msg.createdAt,
                                unread: !msg.read
                            });
                        } else {
                            const conv = conversationsMap.get(otherUserId);
                            if (!msg.read) conv.unread = true;
                            if (msg.createdAt > conv.lastMessageTime) {
                                conv.lastMessage = msg.text;
                                conv.lastMessageTime = msg.createdAt;
                            }
                        }
                    });
                    
                    const convArray = Array.from(conversationsMap.values());
                    convArray.sort((a, b) => b.lastMessageTime - a.lastMessageTime);
                    
                    setConversations(convArray);
                } catch (error) {
                    console.error('Error loading conversations:', error);
                } finally {
                    setLoading(false);
                }
            };

            const sendMessage = async () => {
                if (!messageText.trim() || !selectedConversation) return;
                
                setSendingMessage(true);
                try {
                    const recipientDoc = await db.collection('users').doc(selectedConversation.userId).get();
                    const recipientData = recipientDoc.data();
                    
                    await db.collection('messages').add({
                        text: messageText,
                        senderId: user.uid,
                        senderName: user.displayName || user.email,
                        recipientId: selectedConversation.userId,
                        recipientName: recipientData.displayName || recipientData.email,
                        conversationId: selectedConversation.id,
                        type: 'direct',
                        read: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Create notification
                    await db.collection('notifications').add({
                        type: 'message',
                        message: `New message from ${user.displayName || user.email}`,
                        recipientId: selectedConversation.userId,
                        relatedId: user.uid,
                        read: false,
                        urgent: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    setMessageText('');
                } catch (error) {
                    console.error('Error sending message:', error);
                    alert('Failed to send message');
                } finally {
                    setSendingMessage(false);
                }
            };

            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="loading-spinner"></div>
                    </div>
                );
            }

            return (
                <div style={{display: 'flex', gap: '20px', height: 'calc(100vh - 200px)'}}>
                    {/* Conversations List */}
                    <div style={{width: '300px', background: 'rgba(255,255,255,0.05)', borderRadius: '15px', padding: '20px', overflowY: 'auto'}}>
                        <h3 style={{marginBottom: '20px'}}>Conversations</h3>
                        {conversations.length === 0 ? (
                            <div className="empty-state">
                                <div className="empty-state-text">No conversations</div>
                            </div>
                        ) : (
                            conversations.map(conv => (
                                <div
                                    key={conv.id}
                                    onClick={() => setSelectedConversation(conv)}
                                    style={{
                                        padding: '15px',
                                        margin: '10px 0',
                                        background: selectedConversation?.id === conv.id ? 'rgba(244,196,48,0.2)' : 'rgba(255,255,255,0.05)',
                                        borderRadius: '10px',
                                        cursor: 'pointer',
                                        borderLeft: conv.unread ? '3px solid #f4c430' : 'none'
                                    }}
                                >
                                    <div style={{fontWeight: 'bold', marginBottom: '5px'}}>
                                        {conv.userName}
                                    </div>
                                    <div style={{fontSize: '14px', opacity: 0.7, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>
                                        {conv.lastMessage}
                                    </div>
                                    <div style={{fontSize: '12px', opacity: 0.5, marginTop: '5px'}}>
                                        {formatTimeAgo(conv.lastMessageTime)}
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                    
                    {/* Messages Area */}
                    <div style={{flex: 1, background: 'rgba(255,255,255,0.05)', borderRadius: '15px', padding: '20px', display: 'flex', flexDirection: 'column'}}>
                        {selectedConversation ? (
                            <>
                                <h3 style={{marginBottom: '20px'}}>
                                    Conversation with {selectedConversation.userName}
                                </h3>
                                
                                <div style={{flex: 1, overflowY: 'auto', marginBottom: '20px', display: 'flex', flexDirection: 'column'}}>
                                    {messages.map(msg => (
                                        <div
                                            key={msg.id}
                                            className={`message-bubble ${msg.senderId === user.uid ? 'sent' : 'received'}`}
                                        >
                                            <div>{msg.text}</div>
                                            <div className="message-time">
                                                {formatTimeAgo(msg.createdAt)}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                
                                <div style={{display: 'flex', gap: '10px'}}>
                                    <input
                                        type="text"
                                        className="form-input"
                                        placeholder="Type a message..."
                                        value={messageText}
                                        onChange={(e) => setMessageText(e.target.value)}
                                        onKeyPress={(e) => {
                                            if (e.key === 'Enter' && !e.shiftKey) {
                                                e.preventDefault();
                                                sendMessage();
                                            }
                                        }}
                                    />
                                    <button 
                                        className="btn btn-primary"
                                        onClick={sendMessage}
                                        disabled={!messageText.trim() || sendingMessage}
                                    >
                                        {sendingMessage ? 'Sending...' : 'Send'}
                                    </button>
                                </div>
                            </>
                        ) : (
                            <div className="empty-state">
                                <div className="empty-state-icon">üí¨</div>
                                <div className="empty-state-text">Select a conversation to start messaging</div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Groups View
        function GroupsView({ user, userRole }) {
            const [groups, setGroups] = useState([]);
            const [filteredGroups, setFilteredGroups] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showCreateModal, setShowCreateModal] = useState(false);
            const [selectedGroup, setSelectedGroup] = useState(null);
            const [viewMode, setViewMode] = useState('all'); // 'all', 'monday', 'tuesday', etc.

            const daysOfWeek = ['All', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

            useEffect(() => {
                loadGroups();
            }, [user.uid, userRole]);

            useEffect(() => {
                filterGroups();
            }, [groups, viewMode]);

            const loadGroups = async () => {
                try {
                    let query = db.collection('groups');
                    
                    if (userRole === 'coach') {
                        query = query.where('coachId', '==', user.uid);
                    }
                    
                    const snapshot = await query.orderBy('createdAt', 'desc').get();
                    const groupsData = [];
                    
                    for (const doc of snapshot.docs) {
                        const groupData = { id: doc.id, ...doc.data() };
                        
                        // Get members info
                        if (groupData.members && groupData.members.length > 0) {
                            const membersData = [];
                            for (const memberId of groupData.members) {
                                const memberDoc = await db.collection('users').doc(memberId).get();
                                if (memberDoc.exists) {
                                    membersData.push({
                                        id: memberId,
                                        name: memberDoc.data().displayName || memberDoc.data().email
                                    });
                                }
                            }
                            groupData.membersData = membersData;
                        } else {
                            groupData.membersData = [];
                        }
                        
                        groupsData.push(groupData);
                    }
                    
                    setGroups(groupsData);
                    setFilteredGroups(groupsData);
                } catch (error) {
                    console.error('Error loading groups:', error);
                } finally {
                    setLoading(false);
                }
            };

            const filterGroups = () => {
                if (viewMode === 'all') {
                    setFilteredGroups(groups);
                } else {
                    const filtered = groups.filter(group => 
                        group.dayOfWeek?.toLowerCase() === viewMode.toLowerCase()
                    );
                    setFilteredGroups(filtered);
                }
            };

            const markAttendance = async (groupId, memberId) => {
                try {
                    const today = new Date().toISOString().split('T')[0];
                    await db.collection('groups').doc(groupId).update({
                        [`attendance.${today}.${memberId}`]: true
                    });
                    
                    alert('Attendance marked successfully');
                    loadGroups();
                } catch (error) {
                    console.error('Error marking attendance:', error);
                    alert('Failed to mark attendance');
                }
            };

            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="loading-spinner"></div>
                    </div>
                );
            }

            return (
                <div>
                    <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '20px'}}>
                        <div className="tab-nav">
                            {daysOfWeek.map(day => (
                                <button
                                    key={day}
                                    className={`tab-btn ${viewMode === day.toLowerCase() ? 'active' : ''}`}
                                    onClick={() => setViewMode(day.toLowerCase())}
                                >
                                    {day}
                                </button>
                            ))}
                        </div>
                        
                        {(userRole === 'admin' || userRole === 'coach') && (
                            <button className="btn btn-primary" onClick={() => setShowCreateModal(true)}>
                                + Create Group
                            </button>
                        )}
                    </div>
                    
                    {filteredGroups.length === 0 ? (
                        <div className="empty-state">
                            <div className="empty-state-icon">üë´</div>
                            <div className="empty-state-text">
                                {viewMode === 'all' ? 'No groups yet' : `No groups on ${viewMode}`}
                            </div>
                        </div>
                    ) : (
                        filteredGroups.map(group => (
                            <div key={group.id} className="group-card">
                                <div className="group-header">
                                    <div>
                                        <div className="group-title">{group.name}</div>
                                        <div style={{fontSize: '14px', opacity: 0.7, marginTop: '5px'}}>
                                            {group.dayOfWeek} at {group.time} ‚Ä¢ {group.recurring ? 'Recurring' : 'One-time'}
                                        </div>
                                    </div>
                                    <button 
                                        className="btn btn-secondary"
                                        onClick={() => setSelectedGroup(group)}
                                    >
                                        View Details
                                    </button>
                                </div>
                                
                                <p style={{margin: '15px 0', opacity: 0.9}}>
                                    {group.description}
                                </p>
                                
                                {group.link && (
                                    <a 
                                        href={group.link}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        style={{color: '#f4c430', textDecoration: 'none', marginBottom: '15px', display: 'inline-block'}}
                                    >
                                        üîó {group.link}
                                    </a>
                                )}
                                
                                <div style={{marginTop: '15px'}}>
                                    <div style={{fontSize: '14px', marginBottom: '10px', opacity: 0.7}}>
                                        Members ({group.membersData?.length || 0})
                                    </div>
                                    <div className="group-members">
                                        {group.membersData?.map(member => (
                                            <div key={member.id} className="member-avatar" title={member.name}>
                                                {member.name.charAt(0).toUpperCase()}
                                            </div>
                                        ))}
                                        {(!group.membersData || group.membersData.length === 0) && (
                                            <span style={{opacity: 0.5}}>No members yet</span>
                                        )}
                                    </div>
                                </div>
                            </div>
                        ))
                    )}
                    
                    {showCreateModal && (
                        <CreateGroupModal 
                            onClose={() => setShowCreateModal(false)}
                            onSuccess={() => {
                                setShowCreateModal(false);
                                loadGroups();
                            }}
                            coachId={user.uid}
                            userRole={userRole}
                        />
                    )}
                    
                    {selectedGroup && (
                        <GroupDetailModal 
                            group={selectedGroup}
                            onClose={() => setSelectedGroup(null)}
                            onUpdate={() => loadGroups()}
                            onMarkAttendance={markAttendance}
                        />
                    )}
                </div>
            );
        }

        // Resources View
        function ResourcesView({ user, userRole }) {
            const [resources, setResources] = useState([]);
            const [filteredResources, setFilteredResources] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showCreateModal, setShowCreateModal] = useState(false);
            const [selectedResource, setSelectedResource] = useState(null);
            const [filterCategory, setFilterCategory] = useState('all');

            const categories = ['All', 'PDF', 'Video', 'Link', 'Article', 'Audio', 'Other'];

            useEffect(() => {
                loadResources();
            }, []);

            useEffect(() => {
                filterResources();
            }, [resources, filterCategory]);

            const loadResources = async () => {
                try {
                    const snapshot = await db.collection('resources')
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    const resourcesData = [];
                    snapshot.forEach(doc => {
                        resourcesData.push({ id: doc.id, ...doc.data() });
                    });
                    
                    setResources(resourcesData);
                    setFilteredResources(resourcesData);
                } catch (error) {
                    console.error('Error loading resources:', error);
                } finally {
                    setLoading(false);
                }
            };

            const filterResources = () => {
                if (filterCategory === 'all') {
                    setFilteredResources(resources);
                } else {
                    const filtered = resources.filter(resource => 
                        resource.type?.toLowerCase() === filterCategory.toLowerCase()
                    );
                    setFilteredResources(filtered);
                }
            };

            const handleResourceClick = (resource) => {
                if (resource.type === 'Link' && resource.url) {
                    window.open(resource.url, '_blank');
                } else {
                    setSelectedResource(resource);
                }
            };

            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="loading-spinner"></div>
                    </div>
                );
            }

            return (
                <div>
                    <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '20px'}}>
                        <div className="tab-nav">
                            {categories.map(cat => (
                                <button
                                    key={cat}
                                    className={`tab-btn ${filterCategory === cat.toLowerCase() ? 'active' : ''}`}
                                    onClick={() => setFilterCategory(cat.toLowerCase())}
                                >
                                    {cat}
                                </button>
                            ))}
                        </div>
                        
                        {userRole === 'admin' && (
                            <button className="btn btn-primary" onClick={() => setShowCreateModal(true)}>
                                + Add Resource
                            </button>
                        )}
                    </div>
                    
                    <div className="resource-grid">
                        {filteredResources.length === 0 ? (
                            <div className="empty-state" style={{gridColumn: '1/-1'}}>
                                <div className="empty-state-icon">üìö</div>
                                <div className="empty-state-text">
                                    {filterCategory === 'all' ? 'No resources available' : `No ${filterCategory} resources`}
                                </div>
                            </div>
                        ) : (
                            filteredResources.map(resource => (
                                <div 
                                    key={resource.id}
                                    className="resource-card"
                                    onClick={() => handleResourceClick(resource)}
                                >
                                    <div className="resource-type">{resource.type}</div>
                                    <div className="resource-title">{resource.title}</div>
                                    <div className="resource-description">{resource.description}</div>
                                    <div style={{fontSize: '12px', opacity: 0.7}}>
                                        {resource.isGlobal ? 'üåç Global' : `üë§ ${resource.assignedTo?.length || 0} PIRs`}
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                    
                    {showCreateModal && (
                        <CreateResourceModal 
                            onClose={() => setShowCreateModal(false)}
                            onSuccess={() => {
                                setShowCreateModal(false);
                                loadResources();
                            }}
                        />
                    )}
                    
                    {selectedResource && (
                        <ResourceDetailModal 
                            resource={selectedResource}
                            onClose={() => setSelectedResource(null)}
                        />
                    )}
                </div>
            );
        }

        // Check-ins View
        function CheckInsView({ user, userRole }) {
            const [checkIns, setCheckIns] = useState([]);
            const [loading, setLoading] = useState(true);
            const [currentPage, setCurrentPage] = useState(1);
            const [filterUser, setFilterUser] = useState('all');
            const [users, setUsers] = useState([]);
            const itemsPerPage = 20;

            useEffect(() => {
                loadData();
            }, [user.uid, userRole]);

            const loadData = async () => {
                try {
                    // Load users for filter
                    let usersQuery = db.collection('users').where('role', '==', 'pir');
                    
                    if (userRole === 'coach') {
                        usersQuery = usersQuery.where('assignedCoach', '==', user.uid);
                    }
                    
                    const usersSnap = await usersQuery.get();
                    const usersData = [];
                    const userIds = [];
                    
                    usersSnap.forEach(doc => {
                        const userData = { id: doc.id, ...doc.data() };
                        usersData.push(userData);
                        userIds.push(doc.id);
                    });
                    setUsers(usersData);
                    
                    // Load check-ins
                    if (userIds.length > 0) {
                        const checkInsData = [];
                        
                        // Firestore has a limit on 'in' queries (10 items), so we need to batch
                        const chunks = [];
                        for (let i = 0; i < userIds.length; i += 10) {
                            chunks.push(userIds.slice(i, i + 10));
                        }
                        
                        for (const chunk of chunks) {
                            const checkInsSnap = await db.collection('checkIns')
                                .where('userId', 'in', chunk)
                                .orderBy('createdAt', 'desc')
                                .limit(100)
                                .get();
                            
                            checkInsSnap.forEach(doc => {
                                const checkInData = { id: doc.id, ...doc.data() };
                                // Add user name
                                const user = usersData.find(u => u.id === checkInData.userId);
                                checkInData.userName = user?.displayName || user?.email || 'Unknown';
                                checkInsData.push(checkInData);
                            });
                        }
                        
                        // Sort by date
                        checkInsData.sort((a, b) => b.createdAt - a.createdAt);
                        setCheckIns(checkInsData);
                    }
                } catch (error) {
                    console.error('Error loading check-ins:', error);
                } finally {
                    setLoading(false);
                }
            };

            const filteredCheckIns = filterUser === 'all' 
                ? checkIns 
                : checkIns.filter(c => c.userId === filterUser);
            
            const paginatedCheckIns = filteredCheckIns.slice(
                (currentPage - 1) * itemsPerPage,
                currentPage * itemsPerPage
            );
            
            const totalPages = Math.ceil(filteredCheckIns.length / itemsPerPage);

            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="loading-spinner"></div>
                    </div>
                );
            }

            return (
                <div>
                    <div style={{marginBottom: '20px'}}>
                        <select 
                            className="form-input"
                            style={{width: '250px'}}
                            value={filterUser}
                            onChange={(e) => {
                                setFilterUser(e.target.value);
                                setCurrentPage(1);
                            }}
                        >
                            <option value="all">All PIRs</option>
                            {users.map(user => (
                                <option key={user.id} value={user.id}>
                                    {user.displayName || user.email}
                                </option>
                            ))}
                        </select>
                    </div>
                    
                    <div className="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>PIR</th>
                                    <th>Type</th>
                                    <th>Mood</th>
                                    <th>Craving</th>
                                    <th>Sleep</th>
                                    <th>Triggers</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {paginatedCheckIns.map(checkIn => (
                                    <tr key={checkIn.id}>
                                        <td>{formatDate(checkIn.createdAt)}</td>
                                        <td>{checkIn.userName}</td>
                                        <td>
                                            <span className="badge badge-info">
                                                {checkIn.type || 'Morning'}
                                            </span>
                                        </td>
                                        <td>
                                            <span className={`badge ${
                                                (checkIn.morningData?.mood || checkIn.eveningData?.mood || 0) >= 7 ? 'badge-success' :
                                                (checkIn.morningData?.mood || checkIn.eveningData?.mood || 0) >= 4 ? 'badge-warning' :
                                                'badge-danger'
                                            }`}>
                                                {checkIn.morningData?.mood || checkIn.eveningData?.mood || '-'}/10
                                            </span>
                                        </td>
                                        <td>
                                            <span className={`badge ${
                                                (checkIn.morningData?.craving || checkIn.eveningData?.craving || 0) <= 3 ? 'badge-success' :
                                                (checkIn.morningData?.craving || checkIn.eveningData?.craving || 0) <= 6 ? 'badge-warning' :
                                                'badge-danger'
                                            }`}>
                                                {checkIn.morningData?.craving || checkIn.eveningData?.craving || '-'}/10
                                            </span>
                                        </td>
                                        <td>{checkIn.morningData?.sleep || '-'}/10</td>
                                        <td>{checkIn.morningData?.triggers?.join(', ') || checkIn.eveningData?.challenges || '-'}</td>
                                        <td>{checkIn.morningData?.notes || checkIn.eveningData?.reflection || '-'}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        
                        {filteredCheckIns.length === 0 && (
                            <div className="empty-state">
                                <div className="empty-state-text">No check-ins found</div>
                            </div>
                        )}
                    </div>
                    
                    {totalPages > 1 && (
                        <Pagination 
                            currentPage={currentPage}
                            totalPages={totalPages}
                            onPageChange={setCurrentPage}
                        />
                    )}
                </div>
            );
        }

        // Assignments View
        function AssignmentsView({ user, userRole }) {
            const [assignments, setAssignments] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showCreateModal, setShowCreateModal] = useState(false);
            const [filterStatus, setFilterStatus] = useState('all');
            const [filterUser, setFilterUser] = useState('all');
            const [users, setUsers] = useState([]);

            useEffect(() => {
                loadData();
            }, [user.uid, userRole]);

            const loadData = async () => {
                try {
                    // Load users for filter
                    let usersQuery = db.collection('users').where('role', '==', 'pir');
                    
                    if (userRole === 'coach') {
                        usersQuery = usersQuery.where('assignedCoach', '==', user.uid);
                    }
                    
                    const usersSnap = await usersQuery.get();
                    const usersData = [];
                    const userIds = [];
                    
                    usersSnap.forEach(doc => {
                        const userData = { id: doc.id, ...doc.data() };
                        usersData.push(userData);
                        userIds.push(doc.id);
                    });
                    setUsers(usersData);
                    
                    // Load assignments
                    if (userIds.length > 0) {
                        const assignmentsData = [];
                        
                        for (const userId of userIds) {
                            const assignmentsSnap = await db.collection('assignments')
                                .where('pirId', '==', userId)
                                .orderBy('createdAt', 'desc')
                                .get();
                            
                            assignmentsSnap.forEach(doc => {
                                const assignmentData = { id: doc.id, ...doc.data() };
                                // Add user name
                                const user = usersData.find(u => u.id === assignmentData.pirId);
                                assignmentData.userName = user?.displayName || user?.email || 'Unknown';
                                assignmentsData.push(assignmentData);
                            });
                        }
                        
                        setAssignments(assignmentsData);
                    }
                } catch (error) {
                    console.error('Error loading assignments:', error);
                } finally {
                    setLoading(false);
                }
            };

            const filteredAssignments = assignments.filter(assignment => {
                if (filterStatus !== 'all' && assignment.status !== filterStatus) return false;
                if (filterUser !== 'all' && assignment.pirId !== filterUser) return false;
                return true;
            });

            const updateAssignmentStatus = async (assignmentId, newStatus) => {
                try {
                    await db.collection('assignments').doc(assignmentId).update({
                        status: newStatus,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    loadData();
                } catch (error) {
                    console.error('Error updating assignment:', error);
                    alert('Failed to update assignment status');
                }
            };

            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="loading-spinner"></div>
                    </div>
                );
            }

            return (
                <div>
                    <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '20px'}}>
                        <div style={{display: 'flex', gap: '10px'}}>
                            <select 
                                className="form-input"
                                style={{width: '150px'}}
                                value={filterStatus}
                                onChange={(e) => setFilterStatus(e.target.value)}
                            >
                                <option value="all">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="in-progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="overdue">Overdue</option>
                            </select>
                            
                            <select 
                                className="form-input"
                                style={{width: '200px'}}
                                value={filterUser}
                                onChange={(e) => setFilterUser(e.target.value)}
                            >
                                <option value="all">All PIRs</option>
                                {users.map(user => (
                                    <option key={user.id} value={user.id}>
                                        {user.displayName || user.email}
                                    </option>
                                ))}
                            </select>
                        </div>
                        
                        <button className="btn btn-primary" onClick={() => setShowCreateModal(true)}>
                            + Create Assignment
                        </button>
                    </div>
                    
                    <div className="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>PIR</th>
                                    <th>Title</th>
                                    <th>Description</th>
                                    <th>Due Date</th>
                                    <th>Status</th>
                                    <th>Progress</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredAssignments.map(assignment => {
                                    const isOverdue = assignment.dueDate && 
                                        new Date(assignment.dueDate.toDate ? assignment.dueDate.toDate() : assignment.dueDate) < new Date() &&
                                        assignment.status !== 'completed';
                                    
                                    return (
                                        <tr key={assignment.id}>
                                            <td>{assignment.userName}</td>
                                            <td>{assignment.title}</td>
                                            <td>{assignment.description}</td>
                                            <td>
                                                {formatDate(assignment.dueDate)}
                                                {isOverdue && (
                                                    <span style={{color: '#f44336', marginLeft: '5px'}}>
                                                        (Overdue)
                                                    </span>
                                                )}
                                            </td>
                                            <td>
                                                <select
                                                    className="form-input"
                                                    style={{width: '120px', padding: '5px'}}
                                                    value={assignment.status}
                                                    onChange={(e) => updateAssignmentStatus(assignment.id, e.target.value)}
                                                >
                                                    <option value="pending">Pending</option>
                                                    <option value="in-progress">In Progress</option>
                                                    <option value="completed">Completed</option>
                                                </select>
                                            </td>
                                            <td>
                                                <div className="progress-bar">
                                                    <div 
                                                        className="progress-fill"
                                                        style={{
                                                            width: `${
                                                                assignment.status === 'completed' ? 100 :
                                                                assignment.status === 'in-progress' ? 50 :
                                                                0
                                                            }%`
                                                        }}
                                                    />
                                                </div>
                                            </td>
                                            <td>
                                                <button
                                                    className="action-btn"
                                                    onClick={() => {
                                                        if (confirm('Delete this assignment?')) {
                                                            db.collection('assignments').doc(assignment.id).delete()
                                                                .then(() => loadData());
                                                        }
                                                    }}
                                                >
                                                    Delete
                                                </button>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                        
                        {filteredAssignments.length === 0 && (
                            <div className="empty-state">
                                <div className="empty-state-text">No assignments found</div>
                            </div>
                        )}
                    </div>
                    
                    {showCreateModal && (
                        <CreateAssignmentModal 
                            onClose={() => setShowCreateModal(false)}
                            onSuccess={() => {
                                setShowCreateModal(false);
                                loadData();
                            }}
                            users={users}
                        />
                    )}
                </div>
            );
        }

        // Feedback View (Admin only)
        function FeedbackView() {
            const [feedback, setFeedback] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const unsubscribe = db.collection('feedback')
                    .orderBy('createdAt', 'desc')
                    .onSnapshot(snapshot => {
                        const feedbackData = [];
                        snapshot.forEach(doc => {
                            feedbackData.push({ id: doc.id, ...doc.data() });
                        });
                        setFeedback(feedbackData);
                        setLoading(false);
                    });
                
                return () => unsubscribe();
            }, []);

            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="loading-spinner"></div>
                    </div>
                );
            }

            return (
                <div className="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>User</th>
                                <th>Type</th>
                                <th>Rating</th>
                                <th>Message</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {feedback.map(item => (
                                <tr key={item.id}>
                                    <td>{formatDate(item.createdAt)}</td>
                                    <td>{item.userName || item.userEmail || 'Anonymous'}</td>
                                    <td>
                                        <span className="badge badge-info">{item.type || 'General'}</span>
                                    </td>
                                    <td>{item.rating ? `${item.rating}/5` : '-'}</td>
                                    <td>{item.message}</td>
                                    <td>
                                        <span className={`badge ${item.resolved ? 'badge-success' : 'badge-warning'}`}>
                                            {item.resolved ? 'Resolved' : 'Pending'}
                                        </span>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                    
                    {feedback.length === 0 && (
                        <div className="empty-state">
                            <div className="empty-state-text">No feedback received yet</div>
                        </div>
                    )}
                </div>
            );
        }

        // Alerts View (Admin only)
        function AlertsView() {
            const [alerts, setAlerts] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const unsubscribe = db.collection('alerts')
                    .orderBy('createdAt', 'desc')
                    .onSnapshot(snapshot => {
                        const alertsData = [];
                        snapshot.forEach(doc => {
                            alertsData.push({ id: doc.id, ...doc.data() });
                        });
                        setAlerts(alertsData);
                        setLoading(false);
                    });
                
                return () => unsubscribe();
            }, []);

            const resolveAlert = async (alertId) => {
                try {
                    await db.collection('alerts').doc(alertId).update({
                        resolved: true,
                        resolvedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Error resolving alert:', error);
                    alert('Failed to resolve alert');
                }
            };

            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="loading-spinner"></div>
                    </div>
                );
            }

            return (
                <div className="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>PIR</th>
                                <th>Message</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {alerts.map(alert => (
                                <tr key={alert.id}>
                                    <td>{formatDate(alert.createdAt)}</td>
                                    <td>
                                        <span className={`badge ${
                                            alert.type === 'sos' ? 'badge-danger' :
                                            alert.type === 'missed-checkin' ? 'badge-warning' :
                                            'badge-info'
                                        }`}>
                                            {alert.type}
                                        </span>
                                    </td>
                                    <td>{alert.userName || alert.userEmail}</td>
                                    <td>{alert.message}</td>
                                    <td>
                                        <span className={`badge ${alert.resolved ? 'badge-success' : 'badge-danger'}`}>
                                            {alert.resolved ? 'Resolved' : 'Active'}
                                        </span>
                                    </td>
                                    <td>
                                        {!alert.resolved && (
                                            <button 
                                                className="btn btn-success"
                                                style={{padding: '5px 15px', fontSize: '12px'}}
                                                onClick={() => resolveAlert(alert.id)}
                                            >
                                                Resolve
                                            </button>
                                        )}
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                    
                    {alerts.length === 0 && (
                        <div className="empty-state">
                            <div className="empty-state-text">No alerts</div>
                        </div>
                    )}
                </div>
            );
        }

        // Reports View (Admin only)
        function ReportsView() {
            const [reportType, setReportType] = useState('overview');
            const [dateRange, setDateRange] = useState('month');
            const [reportData, setReportData] = useState(null);
            const [loading, setLoading] = useState(false);

            const generateReport = async () => {
                setLoading(true);
                try {
                    // Calculate date range
                    const endDate = new Date();
                    const startDate = new Date();
                    
                    if (dateRange === 'week') {
                        startDate.setDate(startDate.getDate() - 7);
                    } else if (dateRange === 'month') {
                        startDate.setMonth(startDate.getMonth() - 1);
                    } else if (dateRange === 'quarter') {
                        startDate.setMonth(startDate.getMonth() - 3);
                    } else if (dateRange === 'year') {
                        startDate.setFullYear(startDate.getFullYear() - 1);
                    }

                    const data = {};

                    if (reportType === 'overview' || reportType === 'all') {
                        // Get user stats
                        const usersSnap = await db.collection('users').get();
                        data.totalUsers = usersSnap.size;
                        data.pirs = 0;
                        data.coaches = 0;
                        
                        usersSnap.forEach(doc => {
                            const user = doc.data();
                            if (user.role === 'pir') data.pirs++;
                            if (user.role === 'coach') data.coaches++;
                        });

                        // Get check-in stats
                        const checkInsSnap = await db.collection('checkIns')
                            .where('createdAt', '>=', startDate)
                            .where('createdAt', '<=', endDate)
                            .get();
                        data.totalCheckIns = checkInsSnap.size;

                        // Get assignment stats
                        const assignmentsSnap = await db.collection('assignments')
                            .where('createdAt', '>=', startDate)
                            .where('createdAt', '<=', endDate)
                            .get();
                        data.totalAssignments = assignmentsSnap.size;
                        data.completedAssignments = 0;
                        
                        assignmentsSnap.forEach(doc => {
                            if (doc.data().status === 'completed') {
                                data.completedAssignments++;
                            }
                        });

                        // Get message stats
                        const messagesSnap = await db.collection('messages')
                            .where('createdAt', '>=', startDate)
                            .where('createdAt', '<=', endDate)
                            .get();
                        data.totalMessages = messagesSnap.size;
                    }

                    setReportData(data);
                } catch (error) {
                    console.error('Error generating report:', error);
                    alert('Failed to generate report');
                } finally {
                    setLoading(false);
                }
            };

            const exportReport = () => {
                if (!reportData) return;
                
                const reportText = JSON.stringify(reportData, null, 2);
                const blob = new Blob([reportText], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `report_${reportType}_${dateRange}_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            return (
                <div>
                    <div className="table-container">
                        <h3 style={{marginBottom: '20px'}}>Generate Reports</h3>
                        
                        <div style={{display: 'flex', gap: '20px', marginBottom: '20px'}}>
                            <div className="form-group" style={{flex: 1}}>
                                <label className="form-label">Report Type</label>
                                <select 
                                    className="form-input"
                                    value={reportType}
                                    onChange={(e) => setReportType(e.target.value)}
                                >
                                    <option value="overview">Overview</option>
                                    <option value="users">Users Report</option>
                                    <option value="checkins">Check-ins Report</option>
                                    <option value="assignments">Assignments Report</option>
                                    <option value="all">Complete Report</option>
                                </select>
                            </div>
                            
                            <div className="form-group" style={{flex: 1}}>
                                <label className="form-label">Date Range</label>
                                <select 
                                    className="form-input"
                                    value={dateRange}
                                    onChange={(e) => setDateRange(e.target.value)}
                                >
                                    <option value="week">Last Week</option>
                                    <option value="month">Last Month</option>
                                    <option value="quarter">Last Quarter</option>
                                    <option value="year">Last Year</option>
                                    <option value="all">All Time</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style={{display: 'flex', gap: '10px'}}>
                            <button 
                                className="btn btn-primary"
                                onClick={generateReport}
                                disabled={loading}
                            >
                                {loading ? 'Generating...' : 'Generate Report'}
                            </button>
                            
                            {reportData && (
                                <button 
                                    className="btn btn-secondary"
                                    onClick={exportReport}
                                >
                                    Export JSON
                                </button>
                            )}
                        </div>
                    </div>
                    
                    {reportData && (
                        <div className="table-container" style={{marginTop: '20px'}}>
                            <h3 style={{marginBottom: '20px'}}>Report Results</h3>
                            <pre style={{
                                background: 'rgba(0, 0, 0, 0.3)',
                                padding: '20px',
                                borderRadius: '10px',
                                color: '#f4c430',
                                fontFamily: 'monospace'
                            }}>
                                {JSON.stringify(reportData, null, 2)}
                            </pre>
                        </div>
                    )}
                </div>
            );
        }

        // Settings View (Admin only)
        function SettingsView() {
            const [settings, setSettings] = useState({
                emailNotifications: false,
                autoAssignCoach: false,
                checkInReminders: true,
                dataRetention: '7years',
                maxPIRsPerCoach: 20
            });
            const [saving, setSaving] = useState(false);

            useEffect(() => {
                loadSettings();
            }, []);

            const loadSettings = async () => {
                try {
                    const settingsDoc = await db.collection('settings').doc('system').get();
                    if (settingsDoc.exists) {
                        setSettings(settingsDoc.data());
                    }
                } catch (error) {
                    console.error('Error loading settings:', error);
                }
            };

            const saveSettings = async () => {
                setSaving(true);
                try {
                    await db.collection('settings').doc('system').set(settings);
                    alert('Settings saved successfully');
                } catch (error) {
                    console.error('Error saving settings:', error);
                    alert('Failed to save settings');
                } finally {
                    setSaving(false);
                }
            };

            const exportAllData = async () => {
                if (!confirm('This will export all system data. Continue?')) return;
                
                try {
                    const data = {
                        users: [],
                        checkIns: [],
                        assignments: [],
                        messages: [],
                        groups: [],
                        resources: [],
                        exportDate: new Date().toISOString()
                    };
                    
                    // Export all collections
                    const collections = ['users', 'checkIns', 'assignments', 'messages', 'groups', 'resources'];
                    
                    for (const collection of collections) {
                        const snapshot = await db.collection(collection).get();
                        snapshot.forEach(doc => {
                            data[collection].push({ id: doc.id, ...doc.data() });
                        });
                    }
                    
                    const jsonStr = JSON.stringify(data, null, 2);
                    const blob = new Blob([jsonStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `glrs_full_export_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('Error exporting data:', error);
                    alert('Failed to export data');
                }
            };

            const clearOldNotifications = async () => {
                if (!confirm('Clear notifications older than 30 days?')) return;
                
                try {
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    
                    const snapshot = await db.collection('notifications')
                        .where('createdAt', '<', thirtyDaysAgo)
                        .get();
                    
                    const batch = db.batch();
                    snapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    await batch.commit();
                    alert(`Cleared ${snapshot.size} old notifications`);
                } catch (error) {
                    console.error('Error clearing notifications:', error);
                    alert('Failed to clear notifications');
                }
            };

            return (
                <div>
                    <div className="table-container">
                        <h3 style={{marginBottom: '20px'}}>System Settings</h3>
                        
                        <div className="form-group">
                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="emailNotifications"
                                    checked={settings.emailNotifications}
                                    onChange={(e) => setSettings({...settings, emailNotifications: e.target.checked})}
                                />
                                <label htmlFor="emailNotifications">Enable Email Notifications</label>
                            </div>
                        </div>
                        
                        <div className="form-group">
                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="autoAssignCoach"
                                    checked={settings.autoAssignCoach}
                                    onChange={(e) => setSettings({...settings, autoAssignCoach: e.target.checked})}
                                />
                                <label htmlFor="autoAssignCoach">Auto-assign Coach to New PIRs</label>
                            </div>
                        </div>
                        
                        <div className="form-group">
                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="checkInReminders"
                                    checked={settings.checkInReminders}
                                    onChange={(e) => setSettings({...settings, checkInReminders: e.target.checked})}
                                />
                                <label htmlFor="checkInReminders">Send Check-in Reminders</label>
                            </div>
                        </div>
                        
                        <div className="form-group">
                            <label className="form-label">Data Retention Period</label>
                            <select 
                                className="form-input"
                                value={settings.dataRetention}
                                onChange={(e) => setSettings({...settings, dataRetention: e.target.value})}
                            >
                                <option value="1year">1 Year</option>
                                <option value="3years">3 Years</option>
                                <option value="7years">7 Years (HIPAA Compliant)</option>
                                <option value="forever">Forever</option>
                            </select>
                        </div>
                        
                        <div className="form-group">
                            <label className="form-label">Max PIRs per Coach</label>
                            <input
                                type="number"
                                className="form-input"
                                value={settings.maxPIRsPerCoach}
                                onChange={(e) => setSettings({...settings, maxPIRsPerCoach: parseInt(e.target.value)})}
                            />
                        </div>
                        
                        <button 
                            className="btn btn-primary"
                            onClick={saveSettings}
                            disabled={saving}
                        >
                            {saving ? 'Saving...' : 'Save Settings'}
                        </button>
                    </div>
                    
                    <div className="table-container" style={{marginTop: '20px'}}>
                        <h3 style={{marginBottom: '20px'}}>System Actions</h3>
                        
                        <div style={{display: 'flex', gap: '10px', flexWrap: 'wrap'}}>
                            <button className="btn btn-secondary" onClick={exportAllData}>
                                Export All Data
                            </button>
                            
                            <button className="btn btn-secondary" onClick={clearOldNotifications}>
                                Clear Old Notifications
                            </button>
                            
                            <button 
                                className="btn btn-danger"
                                onClick={() => {
                                    if (confirm('This will check for missed check-ins and send notifications. Continue?')) {
                                        checkMissedCheckIns();
                                    }
                                }}
                            >
                                Check Missed Check-ins
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Modals
        function CreateUserModal({ onClose, onSuccess }) {
            const [formData, setFormData] = useState({
                email: '',
                password: 'TempPassword123!',
                firstName: '',
                lastName: '',
                role: 'pir',
                assignedCoach: '',
                phone: ''
            });
            const [coaches, setCoaches] = useState([]);
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                loadCoaches();
            }, []);

            const loadCoaches = async () => {
                const coachesSnap = await db.collection('users')
                    .where('role', '==', 'coach')
                    .get();
                
                const coachesData = [];
                coachesSnap.forEach(doc => {
                    coachesData.push({ id: doc.id, ...doc.data() });
                });
                setCoaches(coachesData);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                
                let secondaryApp;
                try {
                    // Create secondary app to prevent signing out admin
                    try {
                        secondaryApp = firebase.app('SecondaryApp');
                        await secondaryApp.delete();
                    } catch (e) {
                        // App doesn't exist, that's fine
                    }
                    
                    secondaryApp = firebase.initializeApp(firebaseConfig, 'SecondaryApp');
                    const secondaryAuth = secondaryApp.auth();
                    
                    // Create auth user
                    const userCredential = await secondaryAuth.createUserWithEmailAndPassword(
                        formData.email,
                        formData.password
                    );
                    
                    // Create Firestore profile
                    await db.collection('users').doc(userCredential.user.uid).set({
                        email: formData.email,
                        displayName: `${formData.firstName} ${formData.lastName}`,
                        firstName: formData.firstName,
                        lastName: formData.lastName,
                        phone: formData.phone,
                        role: formData.role,
                        assignedCoach: formData.role === 'pir' ? formData.assignedCoach : null,
                        active: true,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Send password reset email
                    await auth.sendPasswordResetEmail(formData.email);
                    
                    // Create notification
                    await db.collection('notifications').add({
                        type: 'user-created',
                        message: `New ${formData.role} created: ${formData.firstName} ${formData.lastName}`,
                        recipientId: auth.currentUser.uid,
                        read: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    await secondaryApp.delete();
                    
                    alert('User created successfully! Password reset email sent.');
                    onSuccess();
                } catch (error) {
                    console.error('Error creating user:', error);
                    alert('Error creating user: ' + error.message);
                    
                    if (secondaryApp) {
                        try {
                            await secondaryApp.delete();
                        } catch (e) {
                            // Ignore cleanup errors
                        }
                    }
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">Create New User</div>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Email *</label>
                                <input
                                    type="email"
                                    className="form-input"
                                    value={formData.email}
                                    onChange={(e) => setFormData({...formData, email: e.target.value})}
                                    required
                                />
                            </div>
                            
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px'}}>
                                <div className="form-group">
                                    <label className="form-label">First Name *</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={formData.firstName}
                                        onChange={(e) => setFormData({...formData, firstName: e.target.value})}
                                        required
                                    />
                                </div>
                                
                                <div className="form-group">
                                    <label className="form-label">Last Name *</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={formData.lastName}
                                        onChange={(e) => setFormData({...formData, lastName: e.target.value})}
                                        required
                                    />
                                </div>
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Phone</label>
                                <input
                                    type="tel"
                                    className="form-input"
                                    value={formData.phone}
                                    onChange={(e) => setFormData({...formData, phone: e.target.value})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Role *</label>
                                <select 
                                    className="form-input"
                                    value={formData.role}
                                    onChange={(e) => setFormData({...formData, role: e.target.value})}
                                    required
                                >
                                    <option value="pir">PIR</option>
                                    <option value="coach">Coach</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                            
                            {formData.role === 'pir' && (
                                <div className="form-group">
                                    <label className="form-label">Assigned Coach</label>
                                    <select 
                                        className="form-input"
                                        value={formData.assignedCoach}
                                        onChange={(e) => setFormData({...formData, assignedCoach: e.target.value})}
                                    >
                                        <option value="">Select Coach</option>
                                        {coaches.map(coach => (
                                            <option key={coach.id} value={coach.id}>
                                                {coach.displayName || coach.email}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            )}
                            
                            <div style={{display: 'flex', gap: '10px', marginTop: '20px'}}>
                                <button 
                                    type="submit"
                                    className="btn btn-primary"
                                    disabled={loading}
                                >
                                    {loading ? 'Creating...' : 'Create User'}
                                </button>
                                <button 
                                    type="button"
                                    className="btn btn-secondary"
                                    onClick={onClose}
                                >
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function UserDetailModal({ user, onClose, onUpdate, currentUserId, userRole }) {
            const [activeTab, setActiveTab] = useState('overview');
            const [userCheckIns, setUserCheckIns] = useState([]);
            const [userAssignments, setUserAssignments] = useState([]);
            const [userMessages, setUserMessages] = useState([]);
            const [messageText, setMessageText] = useState('');
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                loadUserData();
            }, [user.id]);

            const loadUserData = async () => {
                try {
                    // Load check-ins
                    const checkInsSnap = await db.collection('checkIns')
                        .where('userId', '==', user.id)
                        .orderBy('createdAt', 'desc')
                        .limit(50)
                        .get();
                    
                    const checkInsData = [];
                    checkInsSnap.forEach(doc => {
                        checkInsData.push({ id: doc.id, ...doc.data() });
                    });
                    setUserCheckIns(checkInsData);

                    // Load assignments
                    const assignmentsSnap = await db.collection('assignments')
                        .where('pirId', '==', user.id)
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    const assignmentsData = [];
                    assignmentsSnap.forEach(doc => {
                        assignmentsData.push({ id: doc.id, ...doc.data() });
                    });
                    setUserAssignments(assignmentsData);

                    // Load messages
                    const sentQuery = await db.collection('messages')
                        .where('senderId', '==', user.id)
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    const receivedQuery = await db.collection('messages')
                        .where('recipientId', '==', user.id)
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    const messagesData = [];
                    sentQuery.forEach(doc => {
                        messagesData.push({ id: doc.id, ...doc.data() });
                    });
                    receivedQuery.forEach(doc => {
                        messagesData.push({ id: doc.id, ...doc.data() });
                    });
                    
                    messagesData.sort((a, b) => b.createdAt - a.createdAt);
                    setUserMessages(messagesData);

                } catch (error) {
                    console.error('Error loading user data:', error);
                } finally {
                    setLoading(false);
                }
            };

            const sendMessage = async () => {
                if (!messageText.trim()) return;
                
                try {
                    await db.collection('messages').add({
                        text: messageText,
                        senderId: currentUserId,
                        senderName: 'Admin',
                        recipientId: user.id,
                        recipientName: user.displayName || user.email,
                        type: 'direct',
                        read: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    setMessageText('');
                    loadUserData();
                } catch (error) {
                    console.error('Error sending message:', error);
                    alert('Failed to send message');
                }
            };

            const toggleUserStatus = async () => {
                try {
                    await db.collection('users').doc(user.id).update({
                        active: !user.active
                    });
                    alert(`User ${user.active ? 'deactivated' : 'activated'} successfully`);
                    onUpdate();
                } catch (error) {
                    console.error('Error updating user status:', error);
                    alert('Failed to update user status');
                }
            };

            const reassignCoach = async () => {
                const newCoachId = prompt('Enter new coach user ID:');
                if (newCoachId) {
                    try {
                        await db.collection('users').doc(user.id).update({
                            assignedCoach: newCoachId
                        });
                        alert('Coach reassigned successfully');
                        onUpdate();
                    } catch (error) {
                        console.error('Error reassigning coach:', error);
                        alert('Failed to reassign coach');
                    }
                }
            };

            const exportUserData = () => {
                const exportData = {
                    profile: user,
                    checkIns: userCheckIns,
                    assignments: userAssignments,
                    messages: userMessages,
                    exportDate: new Date().toISOString()
                };
                
                const jsonStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `user_${user.id}_export.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            if (loading) {
                return (
                    <div className="modal-overlay">
                        <div className="modal">
                            <div className="loading-spinner"></div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="modal-overlay">
                    <div className="modal" style={{maxWidth: '800px'}}>
                        <div className="modal-header">
                            <div className="modal-title">{user.displayName || user.email}</div>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        
                        <div style={{marginBottom: '20px', display: 'flex', gap: '10px'}}>
                            {userRole === 'admin' && (
                                <>
                                    <button 
                                        className={`btn ${user.active !== false ? 'btn-danger' : 'btn-success'}`}
                                        onClick={toggleUserStatus}
                                    >
                                        {user.active !== false ? 'Deactivate' : 'Activate'}
                                    </button>
                                    {user.role === 'pir' && (
                                        <button className="btn btn-secondary" onClick={reassignCoach}>
                                            Reassign Coach
                                        </button>
                                    )}
                                </>
                            )}
                            <button className="btn btn-secondary" onClick={exportUserData}>
                                Export Data
                            </button>
                        </div>
                        
                        <div className="tab-nav">
                            <button 
                                className={`tab-btn ${activeTab === 'overview' ? 'active' : ''}`}
                                onClick={() => setActiveTab('overview')}
                            >
                                Overview
                            </button>
                            <button 
                                className={`tab-btn ${activeTab === 'checkins' ? 'active' : ''}`}
                                onClick={() => setActiveTab('checkins')}
                            >
                                Check-ins ({userCheckIns.length})
                            </button>
                            <button 
                                className={`tab-btn ${activeTab === 'assignments' ? 'active' : ''}`}
                                onClick={() => setActiveTab('assignments')}
                            >
                                Assignments ({userAssignments.length})
                            </button>
                            <button 
                                className={`tab-btn ${activeTab === 'messages' ? 'active' : ''}`}
                                onClick={() => setActiveTab('messages')}
                            >
                                Messages
                            </button>
                        </div>
                        
                        {activeTab === 'overview' && (
                            <div style={{marginTop: '20px'}}>
                                <table>
                                    <tbody>
                                        <tr><td><strong>Email:</strong></td><td>{user.email}</td></tr>
                                        <tr><td><strong>Name:</strong></td><td>{user.firstName} {user.lastName}</td></tr>
                                        <tr><td><strong>Phone:</strong></td><td>{user.phone || 'Not provided'}</td></tr>
                                        <tr><td><strong>Role:</strong></td><td>{user.role}</td></tr>
                                        <tr><td><strong>Status:</strong></td><td>{user.active !== false ? 'Active' : 'Inactive'}</td></tr>
                                        {user.assignedCoach && (
                                            <tr><td><strong>Coach:</strong></td><td>{user.coachName || user.assignedCoach}</td></tr>
                                        )}
                                        {user.sobrietyDate && (
                                            <tr><td><strong>Sobriety Date:</strong></td><td>{formatDate(user.sobrietyDate)}</td></tr>
                                        )}
                                        <tr><td><strong>Joined:</strong></td><td>{formatDate(user.createdAt)}</td></tr>
                                    </tbody>
                                </table>
                                
                                {user.role === 'pir' && userCheckIns.length > 0 && (
                                    <div style={{marginTop: '30px'}}>
                                        <h4 style={{marginBottom: '15px'}}>Progress Charts</h4>
                                        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px'}}>
                                            <MoodChart checkIns={userCheckIns} />
                                            <CravingChart checkIns={userCheckIns} />
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {activeTab === 'checkins' && (
                            <div style={{marginTop: '20px', maxHeight: '400px', overflowY: 'auto'}}>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Type</th>
                                            <th>Mood</th>
                                            <th>Craving</th>
                                            <th>Sleep</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {userCheckIns.map(checkIn => (
                                            <tr key={checkIn.id}>
                                                <td>{formatDate(checkIn.createdAt)}</td>
                                                <td>{checkIn.type || 'Morning'}</td>
                                                <td>{checkIn.morningData?.mood || checkIn.eveningData?.mood || '-'}</td>
                                                <td>{checkIn.morningData?.craving || checkIn.eveningData?.craving || '-'}</td>
                                                <td>{checkIn.morningData?.sleep || '-'}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                {userCheckIns.length === 0 && (
                                    <div className="empty-state">No check-ins yet</div>
                                )}
                            </div>
                        )}
                        
                        {activeTab === 'assignments' && (
                            <div style={{marginTop: '20px', maxHeight: '400px', overflowY: 'auto'}}>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>Due Date</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {userAssignments.map(assignment => (
                                            <tr key={assignment.id}>
                                                <td>{assignment.title}</td>
                                                <td>{formatDate(assignment.dueDate)}</td>
                                                <td>
                                                    <span className={`badge ${
                                                        assignment.status === 'completed' ? 'badge-success' :
                                                        assignment.status === 'in-progress' ? 'badge-warning' :
                                                        'badge-info'
                                                    }`}>
                                                        {assignment.status}
                                                    </span>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                {userAssignments.length === 0 && (
                                    <div className="empty-state">No assignments yet</div>
                                )}
                            </div>
                        )}
                        
                        {activeTab === 'messages' && (
                            <div style={{marginTop: '20px'}}>
                                <div style={{display: 'flex', gap: '10px', marginBottom: '20px'}}>
                                    <input
                                        type="text"
                                        className="form-input"
                                        placeholder="Type a message..."
                                        value={messageText}
                                        onChange={(e) => setMessageText(e.target.value)}
                                        onKeyPress={(e) => {
                                            if (e.key === 'Enter') {
                                                sendMessage();
                                            }
                                        }}
                                    />
                                    <button className="btn btn-primary" onClick={sendMessage}>
                                        Send
                                    </button>
                                </div>
                                
                                <div style={{maxHeight: '300px', overflowY: 'auto'}}>
                                    {userMessages.filter(m => m.senderId === currentUserId || m.recipientId === currentUserId).map(msg => (
                                        <div 
                                            key={msg.id}
                                            className={`message-bubble ${msg.senderId === currentUserId ? 'sent' : 'received'}`}
                                        >
                                            <div>{msg.text}</div>
                                            <div className="message-time">{formatTimeAgo(msg.createdAt)}</div>
                                        </div>
                                    ))}
                                    {userMessages.length === 0 && (
                                        <div className="empty-state">No messages yet</div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function CreateGroupModal({ onClose, onSuccess, coachId, userRole }) {
            const [formData, setFormData] = useState({
                name: '',
                description: '',
                dayOfWeek: 'Monday',
                time: '18:00',
                recurring: true,
                link: '',
                members: []
            });
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                
                try {
                    await db.collection('groups').add({
                        ...formData,
                        coachId: coachId,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        nextMeeting: calculateNextMeeting(formData.dayOfWeek, formData.time),
                        attendance: {}
                    });
                    
                    alert('Group created successfully!');
                    onSuccess();
                } catch (error) {
                    console.error('Error creating group:', error);
                    alert('Failed to create group');
                } finally {
                    setLoading(false);
                }
            };

            const calculateNextMeeting = (dayOfWeek, time) => {
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const targetDay = days.indexOf(dayOfWeek);
                const now = new Date();
                const currentDay = now.getDay();
                
                let daysUntilTarget = targetDay - currentDay;
                if (daysUntilTarget <= 0) {
                    daysUntilTarget += 7;
                }
                
                const nextMeeting = new Date();
                nextMeeting.setDate(nextMeeting.getDate() + daysUntilTarget);
                const [hours, minutes] = time.split(':');
                nextMeeting.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                
                return nextMeeting;
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">Create New Group</div>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Group Name *</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    value={formData.name}
                                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                                    required
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Description *</label>
                                <textarea
                                    className="form-input"
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                    required
                                />
                            </div>
                            
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px'}}>
                                <div className="form-group">
                                    <label className="form-label">Day of Week *</label>
                                    <select 
                                        className="form-input"
                                        value={formData.dayOfWeek}
                                        onChange={(e) => setFormData({...formData, dayOfWeek: e.target.value})}
                                        required
                                    >
                                        <option value="Monday">Monday</option>
                                        <option value="Tuesday">Tuesday</option>
                                        <option value="Wednesday">Wednesday</option>
                                        <option value="Thursday">Thursday</option>
                                        <option value="Friday">Friday</option>
                                        <option value="Saturday">Saturday</option>
                                        <option value="Sunday">Sunday</option>
                                    </select>
                                </div>
                                
                                <div className="form-group">
                                    <label className="form-label">Time *</label>
                                    <input
                                        type="time"
                                        className="form-input"
                                        value={formData.time}
                                        onChange={(e) => setFormData({...formData, time: e.target.value})}
                                        required
                                    />
                                </div>
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Meeting Link (optional)</label>
                                <input
                                    type="url"
                                    className="form-input"
                                    placeholder="https://zoom.us/..."
                                    value={formData.link}
                                    onChange={(e) => setFormData({...formData, link: e.target.value})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <div className="checkbox-group">
                                    <input
                                        type="checkbox"
                                        id="recurring"
                                        checked={formData.recurring}
                                        onChange={(e) => setFormData({...formData, recurring: e.target.checked})}
                                    />
                                    <label htmlFor="recurring">Recurring Weekly</label>
                                </div>
                            </div>
                            
                            <div style={{display: 'flex', gap: '10px', marginTop: '20px'}}>
                                <button 
                                    type="submit"
                                    className="btn btn-primary"
                                    disabled={loading}
                                >
                                    {loading ? 'Creating...' : 'Create Group'}
                                </button>
                                <button 
                                    type="button"
                                    className="btn btn-secondary"
                                    onClick={onClose}
                                >
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function GroupDetailModal({ group, onClose, onUpdate, onMarkAttendance }) {
            const [addingMember, setAddingMember] = useState(false);
            const [newMemberEmail, setNewMemberEmail] = useState('');

            const addMember = async () => {
                if (!newMemberEmail) return;
                
                setAddingMember(true);
                try {
                    // Find user by email
                    const userSnap = await db.collection('users')
                        .where('email', '==', newMemberEmail)
                        .get();
                    
                    if (userSnap.empty) {
                        alert('User not found');
                        return;
                    }
                    
                    const userId = userSnap.docs[0].id;
                    const members = group.members || [];
                    
                    if (members.includes(userId)) {
                        alert('User is already a member');
                        return;
                    }
                    
                    members.push(userId);
                    
                    await db.collection('groups').doc(group.id).update({
                        members: members
                    });
                    
                    alert('Member added successfully');
                    setNewMemberEmail('');
                    onUpdate();
                } catch (error) {
                    console.error('Error adding member:', error);
                    alert('Failed to add member');
                } finally {
                    setAddingMember(false);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">{group.name}</div>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        
                        <p style={{marginBottom: '20px'}}>{group.description}</p>
                        
                        <div style={{marginBottom: '20px'}}>
                            <strong>Schedule:</strong> {group.dayOfWeek} at {group.time}
                            {group.recurring && ' (Recurring)'}
                        </div>
                        
                        {group.link && (
                            <div style={{marginBottom: '20px'}}>
                                <strong>Meeting Link:</strong>{' '}
                                <a href={group.link} target="_blank" rel="noopener noreferrer" style={{color: '#f4c430'}}>
                                    {group.link}
                                </a>
                            </div>
                        )}
                        
                        <div style={{marginBottom: '20px'}}>
                            <h4 style={{marginBottom: '15px'}}>Members ({group.membersData?.length || 0})</h4>
                            
                            {group.membersData?.map(member => (
                                <div key={member.id} style={{
                                    padding: '10px',
                                    background: 'rgba(255,255,255,0.05)',
                                    borderRadius: '10px',
                                    marginBottom: '10px',
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center'
                                }}>
                                    <span>{member.name}</span>
                                    <button 
                                        className="btn btn-secondary"
                                        style={{padding: '5px 10px', fontSize: '12px'}}
                                        onClick={() => onMarkAttendance(group.id, member.id)}
                                    >
                                        Mark Attendance
                                    </button>
                                </div>
                            ))}
                            
                            <div style={{display: 'flex', gap: '10px', marginTop: '15px'}}>
                                <input
                                    type="email"
                                    className="form-input"
                                    placeholder="Enter member email..."
                                    value={newMemberEmail}
                                    onChange={(e) => setNewMemberEmail(e.target.value)}
                                />
                                <button 
                                    className="btn btn-primary"
                                    onClick={addMember}
                                    disabled={addingMember}
                                >
                                    {addingMember ? 'Adding...' : 'Add Member'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function CreateResourceModal({ onClose, onSuccess }) {
            const [formData, setFormData] = useState({
                title: '',
                description: '',
                type: 'Link',
                url: '',
                content: '',
                category: 'General',
                isGlobal: true,
                assignedTo: []
            });
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                
                try {
                    await db.collection('resources').add({
                        ...formData,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: auth.currentUser.uid
                    });
                    
                    alert('Resource created successfully!');
                    onSuccess();
                } catch (error) {
                    console.error('Error creating resource:', error);
                    alert('Failed to create resource');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">Add New Resource</div>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Title *</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    value={formData.title}
                                    onChange={(e) => setFormData({...formData, title: e.target.value})}
                                    required
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Description *</label>
                                <textarea
                                    className="form-input"
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                    required
                                />
                            </div>
                            
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px'}}>
                                <div className="form-group">
                                    <label className="form-label">Type *</label>
                                    <select 
                                        className="form-input"
                                        value={formData.type}
                                        onChange={(e) => setFormData({...formData, type: e.target.value})}
                                        required
                                    >
                                        <option value="Link">Link</option>
                                        <option value="PDF">PDF</option>
                                        <option value="Video">Video</option>
                                        <option value="Article">Article</option>
                                        <option value="Audio">Audio</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                
                                <div className="form-group">
                                    <label className="form-label">Category</label>
                                    <select 
                                        className="form-input"
                                        value={formData.category}
                                        onChange={(e) => setFormData({...formData, category: e.target.value})}
                                    >
                                        <option value="General">General</option>
                                        <option value="Educational">Educational</option>
                                        <option value="Motivational">Motivational</option>
                                        <option value="Tools">Tools</option>
                                        <option value="Exercises">Exercises</option>
                                    </select>
                                </div>
                            </div>
                            
                            {formData.type === 'Link' && (
                                <div className="form-group">
                                    <label className="form-label">URL *</label>
                                    <input
                                        type="url"
                                        className="form-input"
                                        value={formData.url}
                                        onChange={(e) => setFormData({...formData, url: e.target.value})}
                                        required={formData.type === 'Link'}
                                    />
                                </div>
                            )}
                            
                            {formData.type !== 'Link' && (
                                <div className="form-group">
                                    <label className="form-label">Content</label>
                                    <textarea
                                        className="form-input"
                                        value={formData.content}
                                        onChange={(e) => setFormData({...formData, content: e.target.value})}
                                        placeholder="Paste content here or provide instructions..."
                                        rows="5"
                                    />
                                </div>
                            )}
                            
                            <div className="form-group">
                                <div className="checkbox-group">
                                    <input
                                        type="checkbox"
                                        id="isGlobal"
                                        checked={formData.isGlobal}
                                        onChange={(e) => setFormData({...formData, isGlobal: e.target.checked})}
                                    />
                                    <label htmlFor="isGlobal">Available to all PIRs</label>
                                </div>
                            </div>
                            
                            <div style={{display: 'flex', gap: '10px', marginTop: '20px'}}>
                                <button 
                                    type="submit"
                                    className="btn btn-primary"
                                    disabled={loading}
                                >
                                    {loading ? 'Creating...' : 'Create Resource'}
                                </button>
                                <button 
                                    type="button"
                                    className="btn btn-secondary"
                                    onClick={onClose}
                                >
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function ResourceDetailModal({ resource, onClose }) {
            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">{resource.title}</div>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        
                        <div style={{marginBottom: '20px'}}>
                            <span className="badge badge-info">{resource.type}</span>
                            <span className="badge badge-info" style={{marginLeft: '10px'}}>{resource.category}</span>
                        </div>
                        
                        <p style={{marginBottom: '20px'}}>{resource.description}</p>
                        
                        {resource.url && (
                            <div style={{marginBottom: '20px'}}>
                                <a 
                                    href={resource.url}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="btn btn-primary"
                                >
                                    Open Resource
                                </a>
                            </div>
                        )}
                        
                        {resource.content && (
                            <div style={{
                                padding: '20px',
                                background: 'rgba(255,255,255,0.05)',
                                borderRadius: '10px',
                                whiteSpace: 'pre-wrap'
                            }}>
                                {resource.content}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function CreateAssignmentModal({ onClose, onSuccess, users }) {
            const [formData, setFormData] = useState({
                title: '',
                description: '',
                pirId: '',
                dueDate: '',
                status: 'pending'
            });
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                
                try {
                    await db.collection('assignments').add({
                        ...formData,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: auth.currentUser.uid
                    });
                    
                    // Create notification for PIR
                    await db.collection('notifications').add({
                        type: 'assignment',
                        message: `New assignment: ${formData.title}`,
                        recipientId: formData.pirId,
                        relatedId: formData.pirId,
                        read: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    alert('Assignment created successfully!');
                    onSuccess();
                } catch (error) {
                    console.error('Error creating assignment:', error);
                    alert('Failed to create assignment');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">Create Assignment</div>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">PIR *</label>
                                <select 
                                    className="form-input"
                                    value={formData.pirId}
                                    onChange={(e) => setFormData({...formData, pirId: e.target.value})}
                                    required
                                >
                                    <option value="">Select PIR</option>
                                    {users.map(user => (
                                        <option key={user.id} value={user.id}>
                                            {user.displayName || user.email}
                                        </option>
                                    ))}
                                </select>
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Title *</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    value={formData.title}
                                    onChange={(e) => setFormData({...formData, title: e.target.value})}
                                    required
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Description *</label>
                                <textarea
                                    className="form-input"
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                    required
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Due Date *</label>
                                <input
                                    type="date"
                                    className="form-input"
                                    value={formData.dueDate}
                                    onChange={(e) => setFormData({...formData, dueDate: e.target.value})}
                                    required
                                />
                            </div>
                            
                            <div style={{display: 'flex', gap: '10px', marginTop: '20px'}}>
                                <button 
                                    type="submit"
                                    className="btn btn-primary"
                                    disabled={loading}
                                >
                                    {loading ? 'Creating...' : 'Create Assignment'}
                                </button>
                                <button 
                                    type="button"
                                    className="btn btn-secondary"
                                    onClick={onClose}
                                >
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // Chart Components
        function MoodChart({ checkIns }) {
            const canvasRef = useRef(null);
            
            useEffect(() => {
                if (!canvasRef.current || checkIns.length === 0) return;
                
                const ctx = canvasRef.current.getContext('2d');
                const last30Days = checkIns.slice(0, 30).reverse();
                
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: last30Days.map(c => formatDate(c.createdAt)),
                        datasets: [{
                            label: 'Mood',
                            data: last30Days.map(c => c.morningData?.mood || c.eveningData?.mood || 0),
                            borderColor: '#f4c430',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 10
                            }
                        }
                    }
                });
            }, [checkIns]);
            
            return (
                <div style={{height: '200px'}}>
                    <canvas ref={canvasRef}></canvas>
                </div>
            );
        }

        function CravingChart({ checkIns }) {
            const canvasRef = useRef(null);
            
            useEffect(() => {
                if (!canvasRef.current || checkIns.length === 0) return;
                
                const ctx = canvasRef.current.getContext('2d');
                const last30Days = checkIns.slice(0, 30).reverse();
                
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: last30Days.map(c => formatDate(c.createdAt)),
                        datasets: [{
                            label: 'Craving',
                            data: last30Days.map(c => c.morningData?.craving || c.eveningData?.craving || 0),
                            borderColor: '#ff4444',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 10
                            }
                        }
                    }
                });
            }, [checkIns]);
            
            return (
                <div style={{height: '200px'}}>
                    <canvas ref={canvasRef}></canvas>
                </div>
            );
        }

        // Pagination Component
        function Pagination({ currentPage, totalPages, onPageChange }) {
            return (
                <div className="pagination">
                    <button 
                        className="page-btn"
                        onClick={() => onPageChange(currentPage - 1)}
                        disabled={currentPage === 1}
                    >
                        Previous
                    </button>
                    
                    {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                        let pageNum;
                        if (totalPages <= 5) {
                            pageNum = i + 1;
                        } else if (currentPage <= 3) {
                            pageNum = i + 1;
                        } else if (currentPage >= totalPages - 2) {
                            pageNum = totalPages - 4 + i;
                        } else {
                            pageNum = currentPage - 2 + i;
                        }
                        
                        return (
                            <button
                                key={pageNum}
                                className={`page-btn ${currentPage === pageNum ? 'active' : ''}`}
                                onClick={() => onPageChange(pageNum)}
                            >
                                {pageNum}
                            </button>
                        );
                    })}
                    
                    <button 
                        className="page-btn"
                        onClick={() => onPageChange(currentPage + 1)}
                        disabled={currentPage === totalPages}
                    >
                        Next
                    </button>
                </div>
            );
        }

        // Helper Functions
        function formatDate(date) {
            if (!date) return '-';
            const d = date.toDate ? date.toDate() : new Date(date);
            return d.toLocaleDateString();
        }

        function formatTimeAgo(date) {
            if (!date) return '-';
            const d = date.toDate ? date.toDate() : new Date(date);
            const now = new Date();
            const seconds = Math.floor((now - d) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)} mins ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)} days ago`;
            return d.toLocaleDateString();
        }

        async function checkMissedCheckIns() {
            try {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                yesterday.setHours(0, 0, 0, 0);
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                // Get all active PIRs
                const pirsSnap = await db.collection('users')
                    .where('role', '==', 'pir')
                    .where('active', '==', true)
                    .get();
                
                const missedPIRs = [];
                
                for (const doc of pirsSnap.docs) {
                    const checkInSnap = await db.collection('checkIns')
                        .where('userId', '==', doc.id)
                        .where('createdAt', '>=', yesterday)
                        .where('createdAt', '<', today)
                        .get();
                    
                    if (checkInSnap.empty) {
                        missedPIRs.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    }
                }
                
                // Create notifications for missed check-ins
                for (const pir of missedPIRs) {
                    // Notify coach
                    if (pir.assignedCoach) {
                        await db.collection('notifications').add({
                            type: 'missed-checkin',
                            message: `${pir.displayName || pir.email} missed yesterday's check-in`,
                            recipientId: pir.assignedCoach,
                            relatedId: pir.id,
                            read: false,
                            urgent: false,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                    // Create alert
                    await db.collection('alerts').add({
                        type: 'missed-checkin',
                        userId: pir.id,
                        userName: pir.displayName || pir.email,
                        userEmail: pir.email,
                        message: 'Missed daily check-in',
                        resolved: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                alert(`Found ${missedPIRs.length} missed check-ins. Notifications sent.`);
            } catch (error) {
                console.error('Error checking missed check-ins:', error);
                alert('Failed to check missed check-ins');
            }
        }

        // Initialize App
        ReactDOM.render(<AdminApp />, document.getElementById('root'));
    </script>
</body>
</html>
