<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GLRS Admin Portal</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jsPDF for PDF exports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1f3a 0%, #0d1117 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }

        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Connection Status Bar */
        .connection-status {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 5px;
            text-align: center;
            font-size: 12px;
            z-index: 2000;
            transition: all 0.3s ease;
        }

        .connection-status.online {
            background: #4caf50;
            transform: translateY(-100%);
        }

        .connection-status.offline {
            background: #f44336;
            transform: translateY(0);
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            color: #000;
            font-weight: bold;
            font-size: 18px;
            text-align: center;
        }

        .nav-section {
            padding: 10px;
        }

        .nav-section-title {
            font-size: 11px;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.5);
            padding: 10px;
            letter-spacing: 1px;
        }

        .nav-item {
            padding: 12px 15px;
            margin: 5px 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            color: #000;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            padding: 20px 30px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .search-bar {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            color: white;
            width: 300px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-bar:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #f4c430;
        }

        .refresh-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
            padding: 10px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .notification-bell:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .notification-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
        }

        .content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        /* Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .stat-label {
            font-size: 12px;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .stat-change {
            font-size: 12px;
            color: #4caf50;
        }

        /* Tables */
        .table-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        th {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.8);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        td {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.9);
        }

        tr:hover td {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
            outline: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            color: #000;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 196, 48, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: #1a1f3a;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #f4c430;
        }

        select.form-input {
            cursor: pointer;
        }

        textarea.form-input {
            resize: vertical;
            min-height: 100px;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
        }

        .page-btn {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .page-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.2);
        }

        .page-btn.active {
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            color: #000;
            border: none;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Loading */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #f4c430;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 50px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-container {
            text-align: center;
            padding: 50px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 50px;
            color: rgba(255, 255, 255, 0.5);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .empty-state-text {
            font-size: 16px;
        }

        /* User Avatar */
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            color: white;
        }

        /* Status Badges */
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .badge-success {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
            border: 1px solid #4caf50;
        }

        .badge-warning {
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
            border: 1px solid #ff9800;
        }

        .badge-danger {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
            border: 1px solid #f44336;
        }

        .badge-info {
            background: rgba(33, 150, 243, 0.2);
            color: #2196f3;
            border: 1px solid #2196f3;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-btn:hover {
            color: rgba(255, 255, 255, 0.9);
        }

        .tab-btn.active {
            color: #f4c430;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
        }

        /* Notification Dropdown */
        .notification-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            width: 400px;
            background: #1a1f3a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin-top: 10px;
            max-height: 500px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .notification-header {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-item {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .notification-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .notification-item.unread {
            background: rgba(244, 196, 48, 0.1);
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            transition: width 0.3s ease;
        }

        /* File Upload */
        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #f4c430;
            background: rgba(244, 196, 48, 0.05);
        }

        .upload-area.dragging {
            border-color: #f4c430;
            background: rgba(244, 196, 48, 0.1);
        }

        /* Charts Container */
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            height: 400px;
            position: relative;
        }

        /* Messages */
        .message-bubble {
            padding: 10px 15px;
            border-radius: 15px;
            margin-bottom: 10px;
            max-width: 70%;
        }

        .message-bubble.sent {
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            color: #000;
            align-self: flex-end;
            margin-left: auto;
        }

        .message-bubble.received {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
        }

        /* Groups */
        .group-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .group-title {
            font-size: 18px;
            font-weight: 600;
        }

        .group-members {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .member-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            border: 2px solid #1a1f3a;
        }

        /* Resources */
        .resource-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .resource-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .resource-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .resource-type {
            display: inline-block;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            font-size: 11px;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .resource-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .resource-description {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 15px;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1f3a 0%, #0d1117 100%);
        }

        .login-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-title {
            font-size: 32px;
            font-weight: bold;
            background: linear-gradient(135deg, #f4c430 0%, #ff9500 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .error-message {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid #f44336;
            color: #f44336;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .success-message {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid #4caf50;
            color: #4caf50;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        /* Checkbox */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        /* Filters */
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            font-size: 12px;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.6);
            letter-spacing: 1px;
        }

        .filter-select {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            outline: none;
            transition: all 0.3s ease;
        }

        .filter-select:focus {
            border-color: #f4c430;
            background: rgba(255, 255, 255, 0.15);
        }

        /* Date Range Picker */
        .date-range {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .date-input {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            outline: none;
        }

        /* Mood Rating Display */
        .mood-scale {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .mood-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .mood-1 { background: #ff4444; }
        .mood-2 { background: #ff6b44; }
        .mood-3 { background: #ff9944; }
        .mood-4 { background: #ffaa44; }
        .mood-5 { background: #ffcc44; }
        .mood-6 { background: #eedd44; }
        .mood-7 { background: #bbdd44; }
        .mood-8 { background: #99dd44; }
        .mood-9 { background: #66dd44; }
        .mood-10 { background: #44dd44; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAufSTHtCTFSEIeZ9YzvrULCnji5I-SMi0",
            authDomain: "glrs-pir-system.firebaseapp.com",
            projectId: "glrs-pir-system",
            storageBucket: "glrs-pir-system.appspot.com",
            messagingSenderId: "830378577655",
            appId: "1:830378577655:web:your-app-id"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // Utility Functions
        function formatDate(date) {
            if (!date) return '-';
            const d = date?.toDate ? date.toDate() : new Date(date);
            if (isNaN(d.getTime())) return '-';
            return d.toLocaleDateString();
        }

        function formatDateTime(date) {
            if (!date) return '-';
            const d = date?.toDate ? date.toDate() : new Date(date);
            if (isNaN(d.getTime())) return '-';
            return d.toLocaleString();
        }

        function formatTimeAgo(date) {
            if (!date) return '-';
            const d = date?.toDate ? date.toDate() : new Date(date);
            if (isNaN(d.getTime())) return '-';
            const now = new Date();
            const seconds = Math.floor((now - d) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)} mins ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)} days ago`;
            return d.toLocaleDateString();
        }

        // Debounce utility
        function useDebounce(value, delay) {
            const [debouncedValue, setDebouncedValue] = useState(value);
            
            useEffect(() => {
                const handler = setTimeout(() => {
                    setDebouncedValue(value);
                }, delay);
                
                return () => clearTimeout(handler);
            }, [value, delay]);
            
            return debouncedValue;
        }

        // Connection Status Hook
        function useConnectionStatus() {
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            
            useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);
                
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);
            
            return isOnline;
        }

        // Batch query utility - handles Firestore's 10-item 'in' query limit
        async function batchQuery(collection, field, values, additionalConstraints = []) {
            if (values.length === 0) return [];
            
            const results = [];
            const chunks = [];
            
            // Split into chunks of 10
            for (let i = 0; i < values.length; i += 10) {
                chunks.push(values.slice(i, i + 10));
            }
            
            // Query each chunk
            for (const chunk of chunks) {
                let query = db.collection(collection).where(field, 'in', chunk);
                
                // Add additional constraints
                for (const constraint of additionalConstraints) {
                    query = query[constraint.method](...constraint.args);
                }
                
                const snapshot = await query.get();
                snapshot.forEach(doc => {
                    results.push({ id: doc.id, ...doc.data() });
                });
            }
            
            return results;
        }

        // Export utilities
        function exportToJSON(data, filename) {
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportToCSV(data, filename) {
            if (!data || data.length === 0) {
                alert('No data to export');
                return;
            }
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => 
                    headers.map(header => {
                        const cell = row[header];
                        const value = cell === null || cell === undefined ? '' : String(cell);
                        return value.includes(',') || value.includes('"') || value.includes('\n') 
                            ? `"${value.replace(/"/g, '""')}"` 
                            : value;
                    }).join(',')
                )
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportToPDF(data, title) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.text(title, 20, 20);
            
            if (Array.isArray(data) && data.length > 0) {
                const headers = Object.keys(data[0]);
                const rows = data.map(item => headers.map(header => String(item[header] || '')));
                
                doc.autoTable({
                    head: [headers],
                    body: rows,
                    startY: 30,
                });
            } else {
                doc.setFontSize(12);
                doc.text(JSON.stringify(data, null, 2), 20, 40);
            }
            
            doc.save(`${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // Main App Component
function AdminApp() {
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(true);
    const [currentView, setCurrentView] = useState('dashboard');
    const [searchQuery, setSearchQuery] = useState('');
    const [notifications, setNotifications] = useState([]);
    const [showNotifications, setShowNotifications] = useState(false);
    const isOnline = useConnectionStatus();
    
    // FIX: Move useDebounce here at component level
    const debouncedSearchQuery = useDebounce(searchQuery, 300);
    
    // Firestore listeners cleanup
    const unsubscribers = useRef([]);

    useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged(async (authUser) => {
            if (authUser) {
                try {
                    const userDoc = await db.collection('users').doc(authUser.uid).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        if (userData.role === 'admin') {
                            setUser({ uid: authUser.uid, ...userData });
                            setupRealtimeListeners(authUser.uid);
                        } else {
                            auth.signOut();
                            alert('Access denied. Admin access required.');
                        }
                    } else {
                        auth.signOut();
                        alert('User profile not found.');
                    }
                } catch (error) {
                    console.error('Error loading user:', error);
                    auth.signOut();
                }
            } else {
                setUser(null);
                cleanupListeners();
            }
            setLoading(false);
        });

        return () => {
            unsubscribe();
            cleanupListeners();
        };
    }, []);

    const setupRealtimeListeners = (userId) => {
        // Clean up existing listeners
        cleanupListeners();
        
        // Listen to notifications
        try {
            const notifQuery = db.collection('notifications')
                .where('recipientId', '==', userId)
                .orderBy('createdAt', 'desc')
                .limit(50);
            
            const unsubNotif = notifQuery.onSnapshot(
                snapshot => {
                    const notifs = [];
                    snapshot.forEach(doc => {
                        notifs.push({ id: doc.id, ...doc.data() });
                    });
                    setNotifications(notifs);
                },
                error => {
                    console.error('Error loading notifications:', error);
                }
            );
            
            unsubscribers.current.push(unsubNotif);
        } catch (error) {
            console.error('Error setting up listeners:', error);
        }
    };

    const cleanupListeners = () => {
        unsubscribers.current.forEach(unsub => {
            try {
                unsub();
            } catch (error) {
                console.error('Error cleaning up listener:', error);
            }
        });
        unsubscribers.current = [];
    };

    const handleLogout = async () => {
        try {
            cleanupListeners();
            await auth.signOut();
            setUser(null);
            setCurrentView('dashboard');
        } catch (error) {
            console.error('Logout error:', error);
            alert('Error logging out. Please try again.');
        }
    };

    const handleImpersonate = (targetUser) => {
        // Open PIR view in new tab/window
        const pirViewUrl = `pir-view.html?userId=${targetUser.id}`;
        window.open(pirViewUrl, '_blank');
    };

    if (loading) {
        return (
            <div className="loading-container">
                <div className="loading-spinner"></div>
                <p style={{marginTop: '20px'}}>Loading Admin Portal...</p>
            </div>
        );
    }

    if (!user) {
        return <LoginScreen />;
    }

    return (
        <>
            <div className={`connection-status ${isOnline ? 'online' : 'offline'}`}>
                {!isOnline && '‚ö†Ô∏è Offline - Some features may be limited'}
            </div>
            
            <div className="app-container">
                <Sidebar 
                    currentView={currentView}
                    setCurrentView={setCurrentView}
                />
                
                <div className="main-content">
                    <Header 
                        currentView={currentView}
                        searchQuery={searchQuery}
                        setSearchQuery={setSearchQuery}
                        notifications={notifications}
                        showNotifications={showNotifications}
                        setShowNotifications={setShowNotifications}
                        onLogout={handleLogout}
                        user={user}
                    />
                    
                    <div className="content">
                        {/* FIX: Pass debouncedSearchQuery instead of searchQuery */}
                        {renderView(currentView, debouncedSearchQuery, user, handleImpersonate)}
                    </div>
                </div>
            </div>
        </>
    );
}

// View Renderer - NO HOOKS HERE
function renderView(view, searchQuery, user, onImpersonate) {
    // REMOVED: const debouncedSearchQuery = useDebounce(searchQuery, 300);
    // Now searchQuery is already debounced when passed in
    
    switch(view) {
        case 'dashboard':
            return <DashboardView user={user} />;
        case 'users':
            return <UsersView searchQuery={searchQuery} user={user} onImpersonate={onImpersonate} />;
        case 'profile':
            return <ProfileView user={user} />;
        case 'feedback':
            return <FeedbackView searchQuery={searchQuery} user={user} />;
        case 'resources':
            return <ResourcesView user={user} searchQuery={searchQuery} />;
        case 'groups':
            return <GroupsView user={user} searchQuery={searchQuery} />;
        case 'checkins':
            return <CheckInsView searchQuery={searchQuery} />;
        case 'assignments':
            return <AssignmentsView searchQuery={searchQuery} user={user} />;
        case 'alerts':
            return <AlertsView searchQuery={searchQuery} user={user} />;
        case 'reports':
            return <ReportsView user={user} />;
        case 'settings':
            return <SettingsView user={user} />;
        default:
            return <div className="empty-state">View not found</div>;
    }
}

        // Sidebar Component
        function Sidebar({ currentView, setCurrentView }) {
            const menuItems = [
                { section: 'MAIN', items: [
                    { id: 'dashboard', label: 'Dashboard', icon: 'üìä' },
                    { id: 'users', label: 'Users', icon: 'üë•' },
                    { id: 'profile', label: 'My Profile', icon: 'üë§' },
                ]},
                { section: 'MANAGEMENT', items: [
                    { id: 'feedback', label: 'Feedback', icon: 'üìù' },
                    { id: 'resources', label: 'Resources', icon: 'üìö' },
                    { id: 'groups', label: 'Groups', icon: 'üë´' }
                ]},
                { section: 'MONITORING', items: [
                    { id: 'checkins', label: 'Check-ins', icon: '‚úÖ' },
                    { id: 'assignments', label: 'Assignments', icon: 'üìã' },
                    { id: 'alerts', label: 'Alerts', icon: 'üö®' }
                ]},
                { section: 'SYSTEM', items: [
                    { id: 'reports', label: 'Reports', icon: 'üìà' },
                    { id: 'settings', label: 'Settings', icon: '‚öôÔ∏è' }
                ]}
            ];

            return (
                <div className="sidebar">
                    <div className="sidebar-header">
                        üõ°Ô∏è GLRS Admin
                    </div>
                    
                    {menuItems.map(section => (
                        <div key={section.section} className="nav-section">
                            <div className="nav-section-title">{section.section}</div>
                            {section.items.map(item => (
                                <div
                                    key={item.id}
                                    className={`nav-item ${currentView === item.id ? 'active' : ''}`}
                                    onClick={() => setCurrentView(item.id)}
                                >
                                    <span>{item.icon}</span>
                                    <span>{item.label}</span>
                                </div>
                            ))}
                        </div>
                    ))}
                </div>
            );
        }

        // Header Component  
        function Header({ currentView, searchQuery, setSearchQuery, notifications, showNotifications, setShowNotifications, onLogout, user }) {
            const [refreshing, setRefreshing] = useState(false);
            const notificationRef = useRef(null);
            const debouncedSearchQuery = useDebounce(searchQuery, 300);
            
            const unreadCount = notifications.filter(n => !n.read).length;

            const handleRefresh = () => {
                setRefreshing(true);
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            };

            const handleSearchKeyPress = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    // Search is reactive through useEffect in views
                }
            };

            const clearNotification = async (notifId) => {
                try {
                    await db.collection('notifications').doc(notifId).update({ read: true });
                } catch (error) {
                    console.error('Error clearing notification:', error);
                }
            };

            const clearAllNotifications = async () => {
                try {
                    const batch = db.batch();
                    notifications.forEach(notif => {
                        if (!notif.read) {
                            batch.update(db.collection('notifications').doc(notif.id), { read: true });
                        }
                    });
                    await batch.commit();
                } catch (error) {
                    console.error('Error clearing all notifications:', error);
                }
            };

            const handleNotificationClick = (notif) => {
                clearNotification(notif.id);
                setShowNotifications(false);
                
                // Navigate based on notification type - using React state navigation
                if (notif.type === 'sos' || notif.type === 'user-created') {
                    // Would navigate to user view with the relatedId
                } else if (notif.type === 'checkin') {
                    // Would navigate to check-in view
                } else if (notif.type === 'message') {
                    // Would navigate to messages
                }
            };

            // Close notifications when clicking outside
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (notificationRef.current && !notificationRef.current.contains(event.target)) {
                        setShowNotifications(false);
                    }
                };
                
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            const getViewTitle = () => {
                const titles = {
                    dashboard: 'Dashboard',
                    users: 'User Management',
                    profile: 'My Profile',
                    messages: 'Messages',
                    feedback: 'Feedback',
                    resources: 'Resources',
                    groups: 'Groups & Workshops',
                    checkins: 'Check-ins',
                    assignments: 'Assignments',
                    alerts: 'Alerts',
                    reports: 'Reports',
                    settings: 'System Settings'
                };
                return titles[currentView] || 'Admin Portal';
            };

            return (
                <div className="header">
                    <div className="header-title">{getViewTitle()}</div>
                    
                    <div className="header-actions">
                        <input
                            type="text"
                            className="search-bar"
                            placeholder="Search users, messages, resources..."
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            onKeyPress={handleSearchKeyPress}
                        />
                        
                        <button 
                            className="refresh-btn"
                            onClick={handleRefresh}
                            disabled={refreshing}
                        >
                            {refreshing ? '‚ü≥' : '‚Üª'} Refresh
                        </button>
                        
                        <div className="notification-bell" ref={notificationRef}>
                            <div onClick={() => setShowNotifications(!showNotifications)}>
                                üîî
                                {unreadCount > 0 && (
                                    <div className="notification-badge">{unreadCount > 99 ? '99+' : unreadCount}</div>
                                )}
                            </div>
                            
                            {showNotifications && (
                                <div className="notification-dropdown">
                                    <div className="notification-header">
                                        <span>Notifications ({unreadCount})</span>
                                        <button 
                                            className="btn btn-secondary"
                                            style={{padding: '5px 10px', fontSize: '12px'}}
                                            onClick={clearAllNotifications}
                                        >
                                            Clear All
                                        </button>
                                    </div>
                                    
                                    {notifications.length === 0 ? (
                                        <div className="empty-state" style={{padding: '20px'}}>
                                            <div className="empty-state-text">No notifications</div>
                                        </div>
                                    ) : (
                                        notifications.slice(0, 20).map(notif => (
                                            <div 
                                                key={notif.id}
                                                className={`notification-item ${notif.read ? '' : 'unread'}`}
                                                onClick={() => handleNotificationClick(notif)}
                                            >
                                                <div style={{display: 'flex', justifyContent: 'space-between'}}>
                                                    <span>{notif.message}</span>
                                                    {notif.urgent && <span className="badge badge-danger">Urgent</span>}
                                                </div>
                                                <div style={{fontSize: '12px', opacity: 0.7, marginTop: '5px'}}>
                                                    {formatTimeAgo(notif.createdAt)}
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            )}
                        </div>
                        
                        <button className="btn btn-secondary" onClick={onLogout}>
                            Logout
                        </button>
                    </div>
                </div>
            );
        }

        // Login Screen
        function LoginScreen() {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    setError(error.message);
                    setLoading(false);
                }
            };

            return (
                <div className="login-container">
                    <div className="login-card">
                        <div className="login-header">
                            <div className="login-title">GLRS Admin Portal</div>
                            <p style={{color: 'rgba(255,255,255,0.7)'}}>Administrator Access Only</p>
                        </div>
                        
                        {error && <div className="error-message">{error}</div>}
                        
                        <form onSubmit={handleLogin}>
                            <div className="form-group">
                                <label className="form-label">Email</label>
                                <input
                                    type="email"
                                    className="form-input"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    required
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Password</label>
                                <input
                                    type="password"
                                    className="form-input"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    required
                                />
                            </div>
                            
                            <button 
                                type="submit"
                                className="btn btn-primary"
                                style={{width: '100%'}}
                                disabled={loading}
                            >
                                {loading ? 'Logging in...' : 'Login'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

       
        // Dashboard View
        function DashboardView({ user }) {
            const [stats, setStats] = useState({
                totalPirs: 0,
                activePirs: 0,
                totalCoaches: 0,
                checkInRate: 0,
                sosAlerts: 0,
                pendingAssignments: 0,
                unreadMessages: 0,
                upcomingGroups: 0
            });
            const [recentActivity, setRecentActivity] = useState([]);
            const [loading, setLoading] = useState(true);
            const [chartData, setChartData] = useState({ labels: [], datasets: [] });
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                loadDashboardData();
                
                return () => {
                    // Cleanup chart
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, []);

            useEffect(() => {
                // Update chart when data changes
                if (chartData.labels.length > 0) {
                    renderChart();
                }
            }, [chartData]);

            const loadDashboardData = async () => {
                try {
                    // Get all users efficiently
                    const usersSnap = await db.collection('users').get();
                    const users = [];
                    const pirs = [];
                    const coaches = [];
                    
                    usersSnap.forEach(doc => {
                        const data = { id: doc.id, ...doc.data() };
                        users.push(data);
                        if (data.role === 'pir') pirs.push(data);
                        if (data.role === 'coach') coaches.push(data);
                    });

                    // Get today's check-ins
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    const checkInsSnap = await db.collection('checkIns')
                        .where('createdAt', '>=', today)
                        .get();
                    
                    const checkInRate = pirs.length > 0 ? 
                        Math.round((checkInsSnap.size / pirs.length) * 100) : 0;

                    // Get SOS alerts
                    const sosSnap = await db.collection('alerts')
                        .where('type', '==', 'sos')
                        .where('resolved', '==', false)
                        .get();

                    // Get pending assignments
                    const assignmentsSnap = await db.collection('assignments')
                        .where('status', '!=', 'completed')
                        .get();

                    // Get unread messages
                    const messagesSnap = await db.collection('messages')
                        .where('recipientId', '==', user.uid)
                        .where('read', '==', false)
                        .get();

                    // Get upcoming groups
                    const groupsSnap = await db.collection('groups')
                        .where('nextMeeting', '>=', new Date())
                        .get();

                    setStats({
                        totalPirs: pirs.length,
                        activePirs: pirs.filter(p => p.active !== false).length,
                        totalCoaches: coaches.length,
                        checkInRate: checkInRate,
                        sosAlerts: sosSnap.size,
                        pendingAssignments: assignmentsSnap.size,
                        unreadMessages: messagesSnap.size,
                        upcomingGroups: groupsSnap.size
                    });

                    // Load recent activity
                    const activitySnap = await db.collection('notifications')
                        .where('recipientId', '==', user.uid)
                        .orderBy('createdAt', 'desc')
                        .limit(10)
                        .get();
                    
                    const activity = [];
                    activitySnap.forEach(doc => {
                        activity.push({ id: doc.id, ...doc.data() });
                    });
                    setRecentActivity(activity);

                    // Prepare chart data - Last 7 days check-ins
                    const last7Days = [];
                    const checkInCounts = [];
                    
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        date.setHours(0, 0, 0, 0);
                        
                        const nextDay = new Date(date);
                        nextDay.setDate(nextDay.getDate() + 1);
                        
                        const dayCheckIns = await db.collection('checkIns')
                            .where('createdAt', '>=', date)
                            .where('createdAt', '<', nextDay)
                            .get();
                        
                        last7Days.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
                        checkInCounts.push(dayCheckIns.size);
                    }

                    setChartData({
                        labels: last7Days,
                        datasets: [{
                            label: 'Check-ins',
                            data: checkInCounts,
                            borderColor: '#f4c430',
                            backgroundColor: 'rgba(244, 196, 48, 0.2)',
                            tension: 0.1
                        }]
                    });

                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                } finally {
                    setLoading(false);
                }
            };

            const renderChart = () => {
                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }
                
                const ctx = chartRef.current?.getContext('2d');
                if (ctx) {
                    chartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    },
                                    ticks: {
                                        color: 'rgba(255, 255, 255, 0.7)'
                                    }
                                },
                                x: {
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    },
                                    ticks: {
                                        color: 'rgba(255, 255, 255, 0.7)'
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    labels: {
                                        color: 'rgba(255, 255, 255, 0.9)'
                                    }
                                }
                            }
                        }
                    });
                }
            };

            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="loading-spinner"></div>
                    </div>
                );
            }

            return (
                <div>
                    <div className="stats-grid">
                        <div className="stat-card">
                            <div className="stat-label">Total PIRs</div>
                            <div className="stat-value">{stats.totalPirs}</div>
                            <div className="stat-change">{stats.activePirs} active</div>
                        </div>
                        
                        <div className="stat-card">
                            <div className="stat-label">Total Coaches</div>
                            <div className="stat-value">{stats.totalCoaches}</div>
                        </div>
                        
                        <div className="stat-card">
                            <div className="stat-label">Check-in Rate</div>
                            <div className="stat-value">{stats.checkInRate}%</div>
                            <div className="stat-change">Today</div>
                        </div>
                        
                        <div className="stat-card">
                            <div className="stat-label">SOS Alerts</div>
                            <div className="stat-value">{stats.sosAlerts}</div>
                            <div className="stat-change" style={{color: stats.sosAlerts > 0 ? '#f44336' : '#4caf50'}}>
                                {stats.sosAlerts > 0 ? 'Needs attention' : 'All clear'}
                            </div>
                        </div>
                        
                        <div className="stat-card">
                            <div className="stat-label">Pending Assignments</div>
                            <div className="stat-value">{stats.pendingAssignments}</div>
                        </div>
                        
                        <div className="stat-card">
                            <div className="stat-label">Unread Messages</div>
                            <div className="stat-value">{stats.unreadMessages}</div>
                        </div>
                        
                        <div className="stat-card">
                            <div className="stat-label">Upcoming Groups</div>
                            <div className="stat-value">{stats.upcomingGroups}</div>
                        </div>
                    </div>
                    
                    <div className="chart-container" style={{marginTop: '30px'}}>
                        <h3 style={{marginBottom: '20px'}}>Check-ins - Last 7 Days</h3>
                        <canvas ref={chartRef}></canvas>
                    </div>
                    
                    <div className="table-container" style={{marginTop: '30px'}}>
                        <h3 style={{marginBottom: '20px'}}>Recent Activity</h3>
                        {recentActivity.length === 0 ? (
                            <div className="empty-state">
                                <div className="empty-state-text">No recent activity</div>
                            </div>
                        ) : (
                            <table>
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Type</th>
                                        <th>Message</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {recentActivity.map(item => (
                                        <tr key={item.id}>
                                            <td>{formatTimeAgo(item.createdAt)}</td>
                                            <td>
                                                <span className={`badge ${
                                                    item.type === 'sos' ? 'badge-danger' :
                                                    item.type === 'checkin' ? 'badge-success' :
                                                    item.type === 'message' ? 'badge-info' :
                                                    'badge-warning'
                                                }`}>
                                                    {item.type}
                                                </span>
                                            </td>
                                            <td>{item.message}</td>
                                            <td>{item.read ? 'Read' : 'Unread'}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        )}
                    </div>
                </div>
            );
        }

        // Users View - Optimized with batch loading
        function UsersView({ searchQuery, user, onImpersonate }) {
            const [users, setUsers] = useState([]);
            const [coaches, setCoaches] = useState({});
            const [filteredUsers, setFilteredUsers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [currentPage, setCurrentPage] = useState(1);
            const [showCreateModal, setShowCreateModal] = useState(false);
            const [selectedUser, setSelectedUser] = useState(null);
            const [lastDoc, setLastDoc] = useState(null);
            const [hasMore, setHasMore] = useState(true);
            const itemsPerPage = 20;

            useEffect(() => {
                loadUsers();
            }, []);

            useEffect(() => {
                filterUsers();
            }, [users, searchQuery]);

            const loadUsers = async () => {
                try {
                    setLoading(true);
                    
                    // Load all users first
                    const usersSnap = await db.collection('users')
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    const usersData = [];
                    const coachIds = new Set();
                    
                    usersSnap.forEach(doc => {
                        const userData = { id: doc.id, ...doc.data() };
                        usersData.push(userData);
                        if (userData.assignedCoach) {
                            coachIds.add(userData.assignedCoach);
                        }
                    });
                    
                    // Batch load coaches if needed
                    const coachesMap = {};
                    if (coachIds.size > 0) {
                        const coachResults = await batchQuery('users', 
                            firebase.firestore.FieldPath.documentId(), 
                            Array.from(coachIds)
                        );
                        
                        coachResults.forEach(coach => {
                            coachesMap[coach.id] = coach.displayName || coach.email;
                        });
                    }
                    
                    // Add coach names to users
                    usersData.forEach(user => {
                        if (user.assignedCoach && coachesMap[user.assignedCoach]) {
                            user.coachName = coachesMap[user.assignedCoach];
                        }
                    });
                    
                    setCoaches(coachesMap);
                    setUsers(usersData);
                    setFilteredUsers(usersData);
                    
                } catch (error) {
                    console.error('Error loading users:', error);
                    alert('Failed to load users. Please refresh the page.');
                } finally {
                    setLoading(false);
                }
            };

            const filterUsers = () => {
                if (!searchQuery) {
                    setFilteredUsers(users);
                    return;
                }
                
                const query = searchQuery.toLowerCase();
                const filtered = users.filter(user => 
                    user.email?.toLowerCase().includes(query) ||
                    user.displayName?.toLowerCase().includes(query) ||
                    user.firstName?.toLowerCase().includes(query) ||
                    user.lastName?.toLowerCase().includes(query) ||
                    user.phone?.toLowerCase().includes(query) ||
                    user.coachName?.toLowerCase().includes(query)
                );
                setFilteredUsers(filtered);
                setCurrentPage(1);
            };

            const paginatedUsers = useMemo(() => {
                const start = (currentPage - 1) * itemsPerPage;
                const end = start + itemsPerPage;
                return filteredUsers.slice(start, end);
            }, [filteredUsers, currentPage]);

            const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);

            const handleExport = (format) => {
                const exportData = filteredUsers.map(user => ({
                    name: user.displayName || 'N/A',
                    email: user.email,
                    role: user.role,
                    status: user.active !== false ? 'Active' : 'Inactive',
                    coach: user.coachName || 'N/A',
                    phone: user.phone || 'N/A',
                    joined: formatDate(user.createdAt)
                }));

                if (format === 'json') {
                    exportToJSON(exportData, 'users');
                } else if (format === 'csv') {
                    exportToCSV(exportData, 'users');
                } else if (format === 'pdf') {
                    exportToPDF(exportData, 'User Report');
                }
            };

            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="loading-spinner"></div>
                    </div>
                );
            }

            return (
                <div>
                    <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '20px'}}>
                        <div>
                            Showing {paginatedUsers.length} of {filteredUsers.length} users
                        </div>
                        <div style={{display: 'flex', gap: '10px'}}>
                            <button className="btn btn-secondary" onClick={() => handleExport('csv')}>
                                Export CSV
                            </button>
                            <button className="btn btn-secondary" onClick={() => handleExport('json')}>
                                Export JSON
                            </button>
                            <button className="btn btn-secondary" onClick={() => handleExport('pdf')}>
                                Export PDF
                            </button>
                            <button className="btn btn-primary" onClick={() => setShowCreateModal(true)}>
                                + Create User
                            </button>
                        </div>
                    </div>
                    
                    <div className="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Assigned Coach</th>
                                    <th>Phone</th>
                                    <th>Joined</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {paginatedUsers.map(user => (
                                    <tr key={user.id}>
                                        <td>
                                            <div style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                                                <div className="user-avatar">
                                                    {(user.displayName || user.email || 'U').charAt(0).toUpperCase()}
                                                </div>
                                                <span>{user.displayName || 'N/A'}</span>
                                            </div>
                                        </td>
                                        <td>{user.email}</td>
                                        <td>
                                            <span className="badge badge-info">{user.role}</span>
                                        </td>
                                        <td>
                                            <span className={`badge ${user.active !== false ? 'badge-success' : 'badge-danger'}`}>
                                                {user.active !== false ? 'Active' : 'Inactive'}
                                            </span>
                                        </td>
                                        <td>{user.coachName || '-'}</td>
                                        <td>{user.phone || '-'}</td>
                                        <td>{formatDate(user.createdAt)}</td>
                                        <td>
                                            <div className="action-buttons">
                                                <button 
                                                    className="action-btn"
                                                    onClick={() => setSelectedUser(user)}
                                                >
                                                    View
                                                </button>
                                                {user.role === 'pir' && (
                                                    <button 
                                                        className="action-btn"
                                                        onClick={() => onImpersonate(user)}
                                                    >
                                                        View As
                                                    </button>
                                                )}
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        
                        {filteredUsers.length === 0 && (
                            <div className="empty-state">
                                <div className="empty-state-text">
                                    {searchQuery ? 'No users found matching your search' : 'No users found'}
                                </div>
                            </div>
                        )}
                    </div>
                    
                    {totalPages > 1 && (
                        <Pagination 
                            currentPage={currentPage}
                            totalPages={totalPages}
                            onPageChange={setCurrentPage}
                        />
                    )}
                    
                    {showCreateModal && (
                        <CreateUserModal 
                            onClose={() => setShowCreateModal(false)}
                            onSuccess={() => {
                                setShowCreateModal(false);
                                loadUsers();
                            }}
                            coaches={coaches}
                        />
                    )}
                    
                    {selectedUser && (
                        <UserDetailModal 
                            user={selectedUser}
                            onClose={() => setSelectedUser(null)}
                            onUpdate={() => {
                                setSelectedUser(null);
                                loadUsers();
                            }}
                            currentUserId={user.uid}
                        />
                    )}
                </div>
            );
        }

        // Profile View
        function ProfileView({ user }) {
            const [editing, setEditing] = useState(false);
            const [profileData, setProfileData] = useState({
                displayName: user.displayName || '',
                firstName: user.firstName || '',
                lastName: user.lastName || '',
                phone: user.phone || '',
                email: user.email
            });
            const [saving, setSaving] = useState(false);
            const [passwordData, setPasswordData] = useState({
                currentPassword: '',
                newPassword: '',
                confirmPassword: ''
            });

            const handleSaveProfile = async () => {
                setSaving(true);
                try {
                    await db.collection('users').doc(user.uid).update({
                        displayName: `${profileData.firstName} ${profileData.lastName}`,
                        firstName: profileData.firstName,
                        lastName: profileData.lastName,
                        phone: profileData.phone,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    alert('Profile updated successfully!');
                    setEditing(false);
                    // Refresh page to update user context
                    setTimeout(() => window.location.reload(), 500);
                } catch (error) {
                    console.error('Error updating profile:', error);
                    alert('Failed to update profile');
                } finally {
                    setSaving(false);
                }
            };

            const handleChangePassword = async () => {
                if (passwordData.newPassword !== passwordData.confirmPassword) {
                    alert('New passwords do not match');
                    return;
                }
                
                if (passwordData.newPassword.length < 6) {
                    alert('Password must be at least 6 characters');
                    return;
                }
                
                setSaving(true);
                try {
                    // Re-authenticate user
                    const credential = firebase.auth.EmailAuthProvider.credential(
                        user.email,
                        passwordData.currentPassword
                    );
                    
                    await auth.currentUser.reauthenticateWithCredential(credential);
                    await auth.currentUser.updatePassword(passwordData.newPassword);
                    
                    alert('Password changed successfully!');
                    setPasswordData({
                        currentPassword: '',
                        newPassword: '',
                        confirmPassword: ''
                    });
                } catch (error) {
                    console.error('Error changing password:', error);
                    alert('Failed to change password: ' + error.message);
                } finally {
                    setSaving(false);
                }
            };

            return (
                <div>
                    <div className="table-container">
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                            <h3>Profile Information</h3>
                            <button 
                                className={`btn ${editing ? 'btn-success' : 'btn-primary'}`}
                                onClick={() => editing ? handleSaveProfile() : setEditing(true)}
                                disabled={saving}
                            >
                                {saving ? 'Saving...' : editing ? 'Save Changes' : 'Edit Profile'}
                            </button>
                        </div>
                        
                        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px'}}>
                            <div className="form-group">
                                <label className="form-label">First Name</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    value={profileData.firstName}
                                    onChange={(e) => setProfileData({...profileData, firstName: e.target.value})}
                                    disabled={!editing}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Last Name</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    value={profileData.lastName}
                                    onChange={(e) => setProfileData({...profileData, lastName: e.target.value})}
                                    disabled={!editing}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Email</label>
                                <input
                                    type="email"
                                    className="form-input"
                                    value={profileData.email}
                                    disabled
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Phone</label>
                                <input
                                    type="tel"
                                    className="form-input"
                                    value={profileData.phone}
                                    onChange={(e) => setProfileData({...profileData, phone: e.target.value})}
                                    disabled={!editing}
                                />
                            </div>
                        </div>
                        
                        {editing && (
                            <button 
                                className="btn btn-secondary"
                                onClick={() => {
                                    setEditing(false);
                                    setProfileData({
                                        displayName: user.displayName || '',
                                        firstName: user.firstName || '',
                                        lastName: user.lastName || '',
                                        phone: user.phone || '',
                                        email: user.email
                                    });
                                }}
                            >
                                Cancel
                            </button>
                        )}
                    </div>
                    
                    <div className="table-container" style={{marginTop: '30px'}}>
                        <h3 style={{marginBottom: '20px'}}>Change Password</h3>
                        
                        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '20px'}}>
                            <div className="form-group">
                                <label className="form-label">Current Password</label>
                                <input
                                    type="password"
                                    className="form-input"
                                    value={passwordData.currentPassword}
                                    onChange={(e) => setPasswordData({...passwordData, currentPassword: e.target.value})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">New Password</label>
                                <input
                                    type="password"
                                    className="form-input"
                                    value={passwordData.newPassword}
                                    onChange={(e) => setPasswordData({...passwordData, newPassword: e.target.value})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Confirm New Password</label>
                                <input
                                    type="password"
                                    className="form-input"
                                    value={passwordData.confirmPassword}
                                    onChange={(e) => setPasswordData({...passwordData, confirmPassword: e.target.value})}
                                />
                            </div>
                        </div>
                        
                        <button 
                            className="btn btn-primary"
                            onClick={handleChangePassword}
                            disabled={saving || !passwordData.currentPassword || !passwordData.newPassword}
                        >
                            {saving ? 'Changing...' : 'Change Password'}
                        </button>
                    </div>
                    
                    <div className="table-container" style={{marginTop: '30px'}}>
                        <h3 style={{marginBottom: '20px'}}>Account Information</h3>
                        <table>
                            <tbody>
                                <tr>
                                    <td><strong>User ID:</strong></td>
                                    <td>{user.uid}</td>
                                </tr>
                                <tr>
                                    <td><strong>Role:</strong></td>
                                    <td><span className="badge badge-info">Administrator</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Account Created:</strong></td>
                                    <td>{formatDate(user.createdAt)}</td>
                                </tr>
                                <tr>
                                    <td><strong>Last Updated:</strong></td>
                                    <td>{formatDate(user.updatedAt)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

    

        // Groups View
        function GroupsView({ user, searchQuery }) {
            const [groups, setGroups] = useState([]);
            const [filteredGroups, setFilteredGroups] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showCreateModal, setShowCreateModal] = useState(false);
            const [selectedGroup, setSelectedGroup] = useState(null);
            const [viewMode, setViewMode] = useState('all');
            
            const daysOfWeek = ['All', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

            useEffect(() => {
                loadGroups();
            }, []);

            useEffect(() => {
                filterGroups();
            }, [groups, viewMode, searchQuery]);

            const loadGroups = async () => {
                try {
                    const groupsSnap = await db.collection('groups')
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    const groupsData = [];
                    
                    for (const doc of groupsSnap.docs) {
                        const groupData = { id: doc.id, ...doc.data() };
                        
                        // Get member details if they exist
                        if (groupData.members && groupData.members.length > 0) {
                            const memberResults = await batchQuery('users',
                                firebase.firestore.FieldPath.documentId(),
                                groupData.members
                            );
                            
                            groupData.membersData = memberResults.map(member => ({
                                id: member.id,
                                name: member.displayName || member.email
                            }));
                        } else {
                            groupData.membersData = [];
                        }
                        
                        groupsData.push(groupData);
                    }
                    
                    setGroups(groupsData);
                    setFilteredGroups(groupsData);
                } catch (error) {
                    console.error('Error loading groups:', error);
                } finally {
                    setLoading(false);
                }
            };

            const filterGroups = () => {
                let filtered = groups;
                
                if (viewMode !== 'all') {
                    filtered = filtered.filter(group => 
                        group.dayOfWeek?.toLowerCase() === viewMode.toLowerCase()
                    );
                }
                
                if (searchQuery) {
                    const query = searchQuery.toLowerCase();
                    filtered = filtered.filter(group =>
                        group.name?.toLowerCase().includes(query) ||
                        group.description?.toLowerCase().includes(query)
                    );
                }
                
                setFilteredGroups(filtered);
            };

            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="loading-spinner"></div>
                    </div>
                );
            }

            return (
                <div>
                    <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '20px'}}>
                        <div className="tab-nav">
                            {daysOfWeek.map(day => (
                                <button
                                    key={day}
                                    className={`tab-btn ${viewMode === day.toLowerCase() ? 'active' : ''}`}
                                    onClick={() => setViewMode(day.toLowerCase())}
                                >
                                    {day}
                                </button>
                            ))}
                        </div>
                        
                        <button className="btn btn-primary" onClick={() => setShowCreateModal(true)}>
                            + Create Group
                        </button>
                    </div>
                    
                    {filteredGroups.length === 0 ? (
                        <div className="empty-state">
                            <div className="empty-state-icon">üë´</div>
                            <div className="empty-state-text">
                                {viewMode === 'all' ? 'No groups yet' : `No groups on ${viewMode}`}
                            </div>
                        </div>
                    ) : (
                        filteredGroups.map(group => (
                            <div key={group.id} className="group-card">
                                <div className="group-header">
                                    <div>
                                        <div className="group-title">{group.name}</div>
                                        <div style={{fontSize: '14px', opacity: 0.7, marginTop: '5px'}}>
                                            {group.dayOfWeek} at {group.time} ‚Ä¢ {group.recurring ? 'Recurring' : 'One-time'}
                                        </div>
                                    </div>
                                    <button 
                                        className="btn btn-secondary"
                                        onClick={() => setSelectedGroup(group)}
                                    >
                                        View Details
                                    </button>
                                </div>
                                
                                <p style={{margin: '15px 0', opacity: 0.9}}>
                                    {group.description}
                                </p>
                                
                                {group.link && (
                                    <a 
                                        href={group.link}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        style={{color: '#f4c430', textDecoration: 'none', marginBottom: '15px', display: 'inline-block'}}
                                    >
                                        üîó Meeting Link
                                    </a>
                                )}
                                
                                <div style={{marginTop: '15px'}}>
                                    <div style={{fontSize: '14px', marginBottom: '10px', opacity: 0.7}}>
                                        Members ({group.membersData?.length || 0})
                                    </div>
                                    <div className="group-members">
                                        {group.membersData?.slice(0, 10).map(member => (
                                            <div key={member.id} className="member-avatar" title={member.name}>
                                                {member.name.charAt(0).toUpperCase()}
                                            </div>
                                        ))}
                                        {group.membersData?.length > 10 && (
                                            <div className="member-avatar">+{group.membersData.length - 10}</div>
                                        )}
                                        {(!group.membersData || group.membersData.length === 0) && (
                                            <span style={{opacity: 0.5}}>No members yet</span>
                                        )}
                                    </div>
                                </div>
                            </div>
                        ))
                    )}
                    
                    {showCreateModal && (
                        <CreateGroupModal 
                            onClose={() => setShowCreateModal(false)}
                            onSuccess={() => {
                                setShowCreateModal(false);
                                loadGroups();
                            }}
                            adminId={user.uid}
                        />
                    )}
                    
                    {selectedGroup && (
                        <GroupDetailModal 
                            group={selectedGroup}
                            onClose={() => setSelectedGroup(null)}
                            onUpdate={() => loadGroups()}
                        />
                    )}
                </div>
            );
        }

        // Resources View with Firebase Storage
        function ResourcesView({ user, searchQuery }) {
            const [resources, setResources] = useState([]);
            const [filteredResources, setFilteredResources] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showCreateModal, setShowCreateModal] = useState(false);
            const [selectedResource, setSelectedResource] = useState(null);
            const [filterCategory, setFilterCategory] = useState('all');
            
            const categories = ['All', 'PDF', 'Video', 'Link', 'Article', 'Audio', 'Other'];

            useEffect(() => {
                loadResources();
            }, []);

            useEffect(() => {
                filterResources();
            }, [resources, filterCategory, searchQuery]);

            const loadResources = async () => {
                try {
                    const snapshot = await db.collection('resources')
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    const resourcesData = [];
                    snapshot.forEach(doc => {
                        resourcesData.push({ id: doc.id, ...doc.data() });
                    });
                    
                    setResources(resourcesData);
                    setFilteredResources(resourcesData);
                } catch (error) {
                    console.error('Error loading resources:', error);
                } finally {
                    setLoading(false);
                }
            };

            const filterResources = () => {
                let filtered = resources;
                
                if (filterCategory !== 'all') {
                    filtered = filtered.filter(resource => 
                        resource.type?.toLowerCase() === filterCategory.toLowerCase()
                    );
                }
                
                if (searchQuery) {
                    const query = searchQuery.toLowerCase();
                    filtered = filtered.filter(resource =>
                        resource.title?.toLowerCase().includes(query) ||
                        resource.description?.toLowerCase().includes(query) ||
                        resource.category?.toLowerCase().includes(query)
                    );
                }
                
                setFilteredResources(filtered);
            };

            const handleResourceClick = async (resource) => {
                if (resource.type === 'Link' && resource.url) {
                    window.open(resource.url, '_blank');
                } else if (resource.fileURL) {
                    window.open(resource.fileURL, '_blank');
                } else {
                    setSelectedResource(resource);
                }
            };

            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="loading-spinner"></div>
                    </div>
                );
            }

            return (
                <div>
                    <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '20px'}}>
                        <div className="tab-nav">
                            {categories.map(cat => (
                                <button
                                    key={cat}
                                    className={`tab-btn ${filterCategory === cat.toLowerCase() ? 'active' : ''}`}
                                    onClick={() => setFilterCategory(cat.toLowerCase())}
                                >
                                    {cat}
                                </button>
                            ))}
                        </div>
                        
                        <button className="btn btn-primary" onClick={() => setShowCreateModal(true)}>
                            + Add Resource
                        </button>
                    </div>
                    
                    <div className="resource-grid">
                        {filteredResources.length === 0 ? (
                            <div className="empty-state" style={{gridColumn: '1/-1'}}>
                                <div className="empty-state-icon">üìö</div>
                                <div className="empty-state-text">
                                    {filterCategory === 'all' ? 'No resources available' : `No ${filterCategory} resources`}
                                </div>
                            </div>
                        ) : (
                            filteredResources.map(resource => (
                                <div 
                                    key={resource.id}
                                    className="resource-card"
                                    onClick={() => handleResourceClick(resource)}
                                >
                                    <div className="resource-type">{resource.type}</div>
                                    <div className="resource-title">{resource.title}</div>
                                    <div className="resource-description">{resource.description}</div>
                                    <div style={{fontSize: '12px', opacity: 0.7}}>
                                        {resource.isGlobal ? 'üåç Global' : `üë§ ${resource.assignedTo?.length || 0} PIRs`}
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                    
                    {showCreateModal && (
                        <CreateResourceModal 
                            onClose={() => setShowCreateModal(false)}
                            onSuccess={() => {
                                setShowCreateModal(false);
                                loadResources();
                            }}
                        />
                    )}
                    
                    {selectedResource && (
                        <ResourceDetailModal 
                            resource={selectedResource}
                            onClose={() => setSelectedResource(null)}
                        />
                    )}
                </div>
            );
        }

        // FULLY FUNCTIONAL CheckInsView 
        function CheckInsView({ searchQuery }) {
            const [checkIns, setCheckIns] = useState([]);
            const [filteredCheckIns, setFilteredCheckIns] = useState([]);
            const [loading, setLoading] = useState(true);
            const [currentPage, setCurrentPage] = useState(1);
            const [filterUser, setFilterUser] = useState('all');
            const [filterMood, setFilterMood] = useState('all');
            const [filterDate, setFilterDate] = useState('all');
            const [users, setUsers] = useState([]);
            const [selectedCheckIn, setSelectedCheckIn] = useState(null);
            const itemsPerPage = 20;

            useEffect(() => {
                loadCheckInsAndUsers();
            }, []);

            useEffect(() => {
                filterCheckIns();
            }, [checkIns, filterUser, filterMood, filterDate, searchQuery]);

            const loadCheckInsAndUsers = async () => {
                try {
                    // Load users for filter dropdown
                    const usersSnap = await db.collection('users')
                        .where('role', '==', 'pir')
                        .get();
                    
                    const usersData = [];
                    const userMap = {};
                    
                    usersSnap.forEach(doc => {
                        const user = { id: doc.id, ...doc.data() };
                        usersData.push(user);
                        userMap[doc.id] = user.displayName || user.email;
                    });
                    
                    setUsers(usersData);

                    // Load check-ins
                    const checkInsSnap = await db.collection('checkIns')
                        .orderBy('createdAt', 'desc')
                        .limit(500)
                        .get();
                    
                    const checkInsData = [];
                    checkInsSnap.forEach(doc => {
                        const checkIn = { id: doc.id, ...doc.data() };
                        checkIn.userName = userMap[checkIn.userId] || 'Unknown User';
                        checkInsData.push(checkIn);
                    });
                    
                    setCheckIns(checkInsData);
                    setFilteredCheckIns(checkInsData);
                } catch (error) {
                    console.error('Error loading check-ins:', error);
                    alert('Failed to load check-ins');
                } finally {
                    setLoading(false);
                }
            };

            const filterCheckIns = () => {
                let filtered = checkIns;
                
                // Filter by user
                if (filterUser !== 'all') {
                    filtered = filtered.filter(checkIn => checkIn.userId === filterUser);
                }
                
                // Filter by mood
                if (filterMood !== 'all') {
                    const moodValue = parseInt(filterMood);
                    if (moodValue === 1) {
                        filtered = filtered.filter(checkIn => checkIn.mood <= 3);
                    } else if (moodValue === 2) {
                        filtered = filtered.filter(checkIn => checkIn.mood >= 4 && checkIn.mood <= 6);
                    } else if (moodValue === 3) {
                        filtered = filtered.filter(checkIn => checkIn.mood >= 7);
                    }
                }
                
                // Filter by date
                if (filterDate !== 'all') {
                    const now = new Date();
                    const startDate = new Date();
                    
                    if (filterDate === 'today') {
                        startDate.setHours(0, 0, 0, 0);
                    } else if (filterDate === 'week') {
                        startDate.setDate(now.getDate() - 7);
                    } else if (filterDate === 'month') {
                        startDate.setMonth(now.getMonth() - 1);
                    }
                    
                    filtered = filtered.filter(checkIn => {
                        const checkInDate = checkIn.createdAt?.toDate ? checkIn.createdAt.toDate() : new Date(checkIn.createdAt);
                        return checkInDate >= startDate;
                    });
                }
                
                // Filter by search query
                if (searchQuery) {
                    const query = searchQuery.toLowerCase();
                    filtered = filtered.filter(checkIn =>
                        checkIn.userName?.toLowerCase().includes(query) ||
                        checkIn.notes?.toLowerCase().includes(query) ||
                        checkIn.gratitude?.toLowerCase().includes(query)
                    );
                }
                
                setFilteredCheckIns(filtered);
                setCurrentPage(1);
            };

            const paginatedCheckIns = useMemo(() => {
                const start = (currentPage - 1) * itemsPerPage;
                const end = start + itemsPerPage;
                return filteredCheckIns.slice(start, end);
            }, [filteredCheckIns, currentPage]);

            const totalPages = Math.ceil(filteredCheckIns.length / itemsPerPage);

            const handleExport = (format) => {
                const exportData = filteredCheckIns.map(checkIn => ({
                    user: checkIn.userName,
                    date: formatDateTime(checkIn.createdAt),
                    mood: checkIn.mood,
                    cravings: checkIn.cravings,
                    gratitude: checkIn.gratitude || '',
                    notes: checkIn.notes || ''
                }));

                if (format === 'json') {
                    exportToJSON(exportData, 'checkins');
                } else if (format === 'csv') {
                    exportToCSV(exportData, 'checkins');
                } else if (format === 'pdf') {
                    exportToPDF(exportData, 'Check-ins Report');
                }
            };

            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="loading-spinner"></div>
                    </div>
                );
            }

            return (
                <div>
                    <div className="filter-bar">
                        <div className="filter-group">
                            <label className="filter-label">User</label>
                            <select 
                                className="filter-select"
                                value={filterUser}
                                onChange={(e) => setFilterUser(e.target.value)}
                            >
                                <option value="all">All Users</option>
                                {users.map(user => (
                                    <option key={user.id} value={user.id}>
                                        {user.displayName || user.email}
                                    </option>
                                ))}
                            </select>
                        </div>
                        
                        <div className="filter-group">
                            <label className="filter-label">Mood Level</label>
                            <select 
                                className="filter-select"
                                value={filterMood}
                                onChange={(e) => setFilterMood(e.target.value)}
                            >
                                <option value="all">All Moods</option>
                                <option value="1">Low (1-3)</option>
                                <option value="2">Medium (4-6)</option>
                                <option value="3">High (7-10)</option>
                            </select>
                        </div>
                        
                        <div className="filter-group">
                            <label className="filter-label">Time Period</label>
                            <select 
                                className="filter-select"
                                value={filterDate}
                                onChange={(e) => setFilterDate(e.target.value)}
                            >
                                <option value="all">All Time</option>
                                <option value="today">Today</option>
                                <option value="week">Last 7 Days</option>
                                <option value="month">Last 30 Days</option>
                            </select>
                        </div>
                        
                        <div style={{marginLeft: 'auto', display: 'flex', gap: '10px'}}>
                            <button className="btn btn-secondary" onClick={() => handleExport('csv')}>
                                Export CSV
                            </button>
                            <button className="btn btn-secondary" onClick={() => handleExport('json')}>
                                Export JSON
                            </button>
                            <button className="btn btn-secondary" onClick={() => handleExport('pdf')}>
                                Export PDF
                            </button>
                        </div>
                    </div>
                    
                    <div className="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Date/Time</th>
                                    <th>Mood</th>
                                    <th>Cravings</th>
                                    <th>Gratitude</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {paginatedCheckIns.map(checkIn => (
                                    <tr key={checkIn.id}>
                                        <td>{checkIn.userName}</td>
                                        <td>{formatDateTime(checkIn.createdAt)}</td>
                                        <td>
                                            <div className="mood-scale">
                                                <div className={`mood-circle mood-${checkIn.mood}`}>
                                                    {checkIn.mood}
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div className="mood-scale">
                                                <div className={`mood-circle mood-${11 - checkIn.cravings}`}>
                                                    {checkIn.cravings}
                                                </div>
                                            </div>
                                        </td>
                                        <td style={{maxWidth: '200px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>
                                            {checkIn.gratitude || '-'}
                                        </td>
                                        <td style={{maxWidth: '200px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>
                                            {checkIn.notes || '-'}
                                        </td>
                                        <td>
                                            <button 
                                                className="action-btn"
                                                onClick={() => setSelectedCheckIn(checkIn)}
                                            >
                                                View
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        
                        {filteredCheckIns.length === 0 && (
                            <div className="empty-state">
                                <div className="empty-state-text">
                                    {searchQuery ? 'No check-ins found matching your search' : 'No check-ins found'}
                                </div>
                            </div>
                        )}
                    </div>
                    
                    {totalPages > 1 && (
                        <Pagination 
                            currentPage={currentPage}
                            totalPages={totalPages}
                            onPageChange={setCurrentPage}
                        />
                    )}
                    
                    {selectedCheckIn && (
                        <CheckInDetailModal 
                            checkIn={selectedCheckIn}
                            onClose={() => setSelectedCheckIn(null)}
                        />
                    )}
                </div>
            );
        }

        // FULLY FUNCTIONAL AssignmentsView
        function AssignmentsView({ searchQuery, user }) {
            const [assignments, setAssignments] = useState([]);
            const [filteredAssignments, setFilteredAssignments] = useState([]);
            const [loading, setLoading] = useState(true);
            const [currentPage, setCurrentPage] = useState(1);
            const [filterStatus, setFilterStatus] = useState('all');
            const [filterUser, setFilterUser] = useState('all');
            const [showCreateModal, setShowCreateModal] = useState(false);
            const [selectedAssignment, setSelectedAssignment] = useState(null);
            const [users, setUsers] = useState([]);
            const itemsPerPage = 20;

            useEffect(() => {
                loadAssignmentsAndUsers();
            }, []);

            useEffect(() => {
                filterAssignments();
            }, [assignments, filterStatus, filterUser, searchQuery]);

            const loadAssignmentsAndUsers = async () => {
                try {
                    // Load PIRs for filter and assignment
                    const usersSnap = await db.collection('users')
                        .where('role', '==', 'pir')
                        .get();
                    
                    const usersData = [];
                    const userMap = {};
                    
                    usersSnap.forEach(doc => {
                        const user = { id: doc.id, ...doc.data() };
                        usersData.push(user);
                        userMap[doc.id] = user.displayName || user.email;
                    });
                    
                    setUsers(usersData);

                    // Load assignments
                    const assignmentsSnap = await db.collection('assignments')
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    const assignmentsData = [];
                    assignmentsSnap.forEach(doc => {
                        const assignment = { id: doc.id, ...doc.data() };
                        assignment.userName = userMap[assignment.userId] || 'Unknown User';
                        
                        // Check if overdue
                        if (assignment.dueDate && assignment.status !== 'completed') {
                            const dueDate = assignment.dueDate.toDate ? assignment.dueDate.toDate() : new Date(assignment.dueDate);
                            if (dueDate < new Date()) {
                                assignment.overdue = true;
                            }
                        }
                        
                        assignmentsData.push(assignment);
                    });
                    
                    setAssignments(assignmentsData);
                    setFilteredAssignments(assignmentsData);
                } catch (error) {
                    console.error('Error loading assignments:', error);
                    alert('Failed to load assignments');
                } finally {
                    setLoading(false);
                }
            };

            const filterAssignments = () => {
                let filtered = assignments;
                
                // Filter by status
                if (filterStatus !== 'all') {
                    if (filterStatus === 'overdue') {
                        filtered = filtered.filter(assignment => assignment.overdue);
                    } else {
                        filtered = filtered.filter(assignment => assignment.status === filterStatus);
                    }
                }
                
                // Filter by user
                if (filterUser !== 'all') {
                    filtered = filtered.filter(assignment => assignment.userId === filterUser);
                }
                
                // Filter by search
                if (searchQuery) {
                    const query = searchQuery.toLowerCase();
                    filtered = filtered.filter(assignment =>
                        assignment.userName?.toLowerCase().includes(query) ||
                        assignment.title?.toLowerCase().includes(query) ||
                        assignment.description?.toLowerCase().includes(query)
                    );
                }
                
                setFilteredAssignments(filtered);
                setCurrentPage(1);
            };

            const handleStatusUpdate = async (assignmentId, newStatus) => {
                try {
                    await db.collection('assignments').doc(assignmentId).update({
                        status: newStatus,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Update local state
                    setAssignments(prev => prev.map(a => 
                        a.id === assignmentId ? { ...a, status: newStatus } : a
                    ));
                    
                    alert('Assignment status updated');
                } catch (error) {
                    console.error('Error updating assignment:', error);
                    alert('Failed to update assignment');
                }
            };

            const handleDelete = async (assignmentId) => {
                if (!confirm('Are you sure you want to delete this assignment?')) return;
                
                try {
                    await db.collection('assignments').doc(assignmentId).delete();
                    setAssignments(prev => prev.filter(a => a.id !== assignmentId));
                    alert('Assignment deleted');
                } catch (error) {
                    console.error('Error deleting assignment:', error);
                    alert('Failed to delete assignment');
                }
            };

            const paginatedAssignments = useMemo(() => {
                const start = (currentPage - 1) * itemsPerPage;
                const end = start + itemsPerPage;
                return filteredAssignments.slice(start, end);
            }, [filteredAssignments, currentPage]);

            const totalPages = Math.ceil(filteredAssignments.length / itemsPerPage);

            const handleExport = (format) => {
                const exportData = filteredAssignments.map(assignment => ({
                    user: assignment.userName,
                    title: assignment.title,
                    description: assignment.description,
                    status: assignment.status,
                    dueDate: assignment.dueDate ? formatDate(assignment.dueDate) : 'N/A',
                    createdAt: formatDate(assignment.createdAt),
                    overdue: assignment.overdue ? 'Yes' : 'No'
                }));

                if (format === 'json') {
                    exportToJSON(exportData, 'assignments');
                } else if (format === 'csv') {
                    exportToCSV(exportData, 'assignments');
                } else if (format === 'pdf') {
                    exportToPDF(exportData, 'Assignments Report');
                }
            };

            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="loading-spinner"></div>
                    </div>
                );
            }

            return (
                <div>
                    <div className="filter-bar">
                        <div className="filter-group">
                            <label className="filter-label">Status</label>
                            <select 
                                className="filter-select"
                                value={filterStatus}
                                onChange={(e) => setFilterStatus(e.target.value)}
                            >
                                <option value="all">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="in_progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="overdue">Overdue</option>
                            </select>
                        </div>
                        
                        <div className="filter-group">
                            <label className="filter-label">User</label>
                            <select 
                                className="filter-select"
                                value={filterUser}
                                onChange={(e) => setFilterUser(e.target.value)}
                            >
                                <option value="all">All Users</option>
                                {users.map(user => (
                                    <option key={user.id} value={user.id}>
                                        {user.displayName || user.email}
                                    </option>
                                ))}
                            </select>
                        </div>
                        
                        <div style={{marginLeft: 'auto', display: 'flex', gap: '10px'}}>
                            <button className="btn btn-secondary" onClick={() => handleExport('csv')}>
                                Export CSV
                            </button>
                            <button className="btn btn-secondary" onClick={() => handleExport('json')}>
                                Export JSON
                            </button>
                            <button className="btn btn-primary" onClick={() => setShowCreateModal(true)}>
                                + Create Assignment
                            </button>
                        </div>
                    </div>
                    
                    <div className="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Title</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th>Due Date</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {paginatedAssignments.map(assignment => (
                                    <tr key={assignment.id}>
                                        <td>{assignment.userName}</td>
                                        <td>{assignment.title}</td>
                                        <td style={{maxWidth: '200px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>
                                            {assignment.description}
                                        </td>
                                        <td>
                                            <span className={`badge ${
                                                assignment.overdue ? 'badge-danger' :
                                                assignment.status === 'completed' ? 'badge-success' :
                                                assignment.status === 'in_progress' ? 'badge-warning' :
                                                'badge-info'
                                            }`}>
                                                {assignment.overdue ? 'Overdue' : assignment.status?.replace('_', ' ')}
                                            </span>
                                        </td>
                                        <td>{assignment.dueDate ? formatDate(assignment.dueDate) : '-'}</td>
                                        <td>{formatDate(assignment.createdAt)}</td>
                                        <td>
                                            <div className="action-buttons">
                                                <button 
                                                    className="action-btn"
                                                    onClick={() => setSelectedAssignment(assignment)}
                                                >
                                                    View
                                                </button>
                                                {assignment.status !== 'completed' && (
                                                    <button 
                                                        className="action-btn"
                                                        onClick={() => handleStatusUpdate(assignment.id, 
                                                            assignment.status === 'pending' ? 'in_progress' : 'completed'
                                                        )}
                                                    >
                                                        {assignment.status === 'pending' ? 'Start' : 'Complete'}
                                                    </button>
                                                )}
                                                <button 
                                                    className="action-btn"
                                                    onClick={() => handleDelete(assignment.id)}
                                                    style={{color: '#f44336'}}
                                                >
                                                    Delete
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        
                        {filteredAssignments.length === 0 && (
                            <div className="empty-state">
                                <div className="empty-state-text">
                                    {searchQuery ? 'No assignments found matching your search' : 'No assignments found'}
                                </div>
                            </div>
                        )}
                    </div>
                    
                    {totalPages > 1 && (
                        <Pagination 
                            currentPage={currentPage}
                            totalPages={totalPages}
                            onPageChange={setCurrentPage}
                        />
                    )}
                    
                    {showCreateModal && (
                        <CreateAssignmentModal 
                            onClose={() => setShowCreateModal(false)}
                            onSuccess={() => {
                                setShowCreateModal(false);
                                loadAssignmentsAndUsers();
                            }}
                            users={users}
                            createdBy={user.uid}
                        />
                    )}
                    
                    {selectedAssignment && (
                        <AssignmentDetailModal 
                            assignment={selectedAssignment}
                            onClose={() => setSelectedAssignment(null)}
                            onUpdate={() => loadAssignmentsAndUsers()}
                        />
                    )}
                </div>
            );
        }

        // FULLY FUNCTIONAL FeedbackView
        function FeedbackView({ searchQuery, user }) {
            const [feedbacks, setFeedbacks] = useState([]);
            const [filteredFeedbacks, setFilteredFeedbacks] = useState([]);
            const [loading, setLoading] = useState(true);
            const [currentPage, setCurrentPage] = useState(1);
            const [filterStatus, setFilterStatus] = useState('all');
            const [filterType, setFilterType] = useState('all');
            const [selectedFeedback, setSelectedFeedback] = useState(null);
            const itemsPerPage = 20;

            useEffect(() => {
                loadFeedbacks();
            }, []);

            useEffect(() => {
                filterFeedbacks();
            }, [feedbacks, filterStatus, filterType, searchQuery]);

            const loadFeedbacks = async () => {
                try {
                    // Load feedbacks
                    const feedbacksSnap = await db.collection('feedback')
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    const feedbacksData = [];
                    const userIds = new Set();
                    
                    feedbacksSnap.forEach(doc => {
                        const feedback = { id: doc.id, ...doc.data() };
                        feedbacksData.push(feedback);
                        if (feedback.userId) userIds.add(feedback.userId);
                    });
                    
                    // Batch load user names
                    if (userIds.size > 0) {
                        const userResults = await batchQuery('users',
                            firebase.firestore.FieldPath.documentId(),
                            Array.from(userIds)
                        );
                        
                        const userMap = {};
                        userResults.forEach(user => {
                            userMap[user.id] = user.displayName || user.email;
                        });
                        
                        feedbacksData.forEach(feedback => {
                            feedback.userName = userMap[feedback.userId] || 'Anonymous';
                        });
                    }
                    
                    setFeedbacks(feedbacksData);
                    setFilteredFeedbacks(feedbacksData);
                } catch (error) {
                    console.error('Error loading feedback:', error);
                    alert('Failed to load feedback');
                } finally {
                    setLoading(false);
                }
            };

            const filterFeedbacks = () => {
                let filtered = feedbacks;
                
                // Filter by status
                if (filterStatus !== 'all') {
                    filtered = filtered.filter(feedback => 
                        filterStatus === 'reviewed' ? feedback.reviewed : !feedback.reviewed
                    );
                }
                
                // Filter by type
                if (filterType !== 'all') {
                    filtered = filtered.filter(feedback => feedback.type === filterType);
                }
                
                // Filter by search
                if (searchQuery) {
                    const query = searchQuery.toLowerCase();
                    filtered = filtered.filter(feedback =>
                        feedback.userName?.toLowerCase().includes(query) ||
                        feedback.subject?.toLowerCase().includes(query) ||
                        feedback.message?.toLowerCase().includes(query)
                    );
                }
                
                setFilteredFeedbacks(filtered);
                setCurrentPage(1);
            };

            const handleMarkReviewed = async (feedbackId, reviewed = true) => {
                try {
                    await db.collection('feedback').doc(feedbackId).update({
                        reviewed: reviewed,
                        reviewedBy: user.uid,
                        reviewedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Update local state
                    setFeedbacks(prev => prev.map(f => 
                        f.id === feedbackId ? { ...f, reviewed } : f
                    ));
                    
                    alert('Feedback marked as ' + (reviewed ? 'reviewed' : 'unreviewed'));
                } catch (error) {
                    console.error('Error updating feedback:', error);
                    alert('Failed to update feedback');
                }
            };

            const handleRespond = async (feedbackId, response) => {
                try {
                    await db.collection('feedback').doc(feedbackId).update({
                        response: response,
                        respondedBy: user.uid,
                        respondedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        reviewed: true
                    });
                    
                    // Update local state
                    setFeedbacks(prev => prev.map(f => 
                        f.id === feedbackId ? { ...f, response, reviewed: true } : f
                    ));
                    
                    alert('Response sent successfully');
                } catch (error) {
                    console.error('Error responding to feedback:', error);
                    alert('Failed to send response');
                }
            };

            const handleDelete = async (feedbackId) => {
                if (!confirm('Are you sure you want to delete this feedback?')) return;
                
                try {
                    await db.collection('feedback').doc(feedbackId).delete();
                    setFeedbacks(prev => prev.filter(f => f.id !== feedbackId));
                    alert('Feedback deleted');
                } catch (error) {
                    console.error('Error deleting feedback:', error);
                    alert('Failed to delete feedback');
                }
            };

            const paginatedFeedbacks = useMemo(() => {
                const start = (currentPage - 1) * itemsPerPage;
                const end = start + itemsPerPage;
                return filteredFeedbacks.slice(start, end);
            }, [filteredFeedbacks, currentPage]);

            const totalPages = Math.ceil(filteredFeedbacks.length / itemsPerPage);

            const handleExport = (format) => {
                const exportData = filteredFeedbacks.map(feedback => ({
                    user: feedback.userName,
                    type: feedback.type,
                    subject: feedback.subject,
                    message: feedback.message,
                    rating: feedback.rating || 'N/A',
                    status: feedback.reviewed ? 'Reviewed' : 'Pending',
                    createdAt: formatDate(feedback.createdAt),
                    response: feedback.response || 'No response yet'
                }));

                if (format === 'json') {
                    exportToJSON(exportData, 'feedback');
                } else if (format === 'csv') {
                    exportToCSV(exportData, 'feedback');
                } else if (format === 'pdf') {
                    exportToPDF(exportData, 'Feedback Report');
                }
            };

            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="loading-spinner"></div>
                    </div>
                );
            }

            return (
                <div>
                    <div className="filter-bar">
                        <div className="filter-group">
                            <label className="filter-label">Status</label>
                            <select 
                                className="filter-select"
                                value={filterStatus}
                                onChange={(e) => setFilterStatus(e.target.value)}
                            >
                                <option value="all">All Status</option>
                                <option value="pending">Pending Review</option>
                                <option value="reviewed">Reviewed</option>
                            </select>
                        </div>
                        
                        <div className="filter-group">
                            <label className="filter-label">Type</label>
                            <select 
                                className="filter-select"
                                value={filterType}
                                onChange={(e) => setFilterType(e.target.value)}
                            >
                                <option value="all">All Types</option>
                                <option value="bug">Bug Report</option>
                                <option value="feature">Feature Request</option>
                                <option value="general">General Feedback</option>
                                <option value="complaint">Complaint</option>
                                <option value="praise">Praise</option>
                            </select>
                        </div>
                        
                        <div style={{marginLeft: 'auto', display: 'flex', gap: '10px'}}>
                            <button className="btn btn-secondary" onClick={() => handleExport('csv')}>
                                Export CSV
                            </button>
                            <button className="btn btn-secondary" onClick={() => handleExport('json')}>
                                Export JSON
                            </button>
                            <button className="btn btn-secondary" onClick={() => handleExport('pdf')}>
                                Export PDF
                            </button>
                        </div>
                    </div>
                    
                    <div className="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Type</th>
                                    <th>Subject</th>
                                    <th>Message</th>
                                    <th>Rating</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {paginatedFeedbacks.map(feedback => (
                                    <tr key={feedback.id}>
                                        <td>{feedback.userName}</td>
                                        <td>
                                            <span className="badge badge-info">{feedback.type}</span>
                                        </td>
                                        <td>{feedback.subject}</td>
                                        <td style={{maxWidth: '200px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>
                                            {feedback.message}
                                        </td>
                                        <td>{feedback.rating ? `${feedback.rating}/5` : '-'}</td>
                                        <td>
                                            <span className={`badge ${feedback.reviewed ? 'badge-success' : 'badge-warning'}`}>
                                                {feedback.reviewed ? 'Reviewed' : 'Pending'}
                                            </span>
                                        </td>
                                        <td>{formatDate(feedback.createdAt)}</td>
                                        <td>
                                            <div className="action-buttons">
                                                <button 
                                                    className="action-btn"
                                                    onClick={() => setSelectedFeedback(feedback)}
                                                >
                                                    View
                                                </button>
                                                {!feedback.reviewed && (
                                                    <button 
                                                        className="action-btn"
                                                        onClick={() => handleMarkReviewed(feedback.id)}
                                                    >
                                                        Mark Reviewed
                                                    </button>
                                                )}
                                                <button 
                                                    className="action-btn"
                                                    onClick={() => handleDelete(feedback.id)}
                                                    style={{color: '#f44336'}}
                                                >
                                                    Delete
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        
                        {filteredFeedbacks.length === 0 && (
                            <div className="empty-state">
                                <div className="empty-state-text">
                                    {searchQuery ? 'No feedback found matching your search' : 'No feedback found'}
                                </div>
                            </div>
                        )}
                    </div>
                    
                    {totalPages > 1 && (
                        <Pagination 
                            currentPage={currentPage}
                            totalPages={totalPages}
                            onPageChange={setCurrentPage}
                        />
                    )}
                    
                    {selectedFeedback && (
                        <FeedbackDetailModal 
                            feedback={selectedFeedback}
                            onClose={() => setSelectedFeedback(null)}
                            onRespond={handleRespond}
                            onMarkReviewed={handleMarkReviewed}
                        />
                    )}
                </div>
            );
        }

        // FULLY FUNCTIONAL AlertsView
        function AlertsView({ searchQuery, user }) {
            const [alerts, setAlerts] = useState([]);
            const [filteredAlerts, setFilteredAlerts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [currentPage, setCurrentPage] = useState(1);
            const [filterType, setFilterType] = useState('all');
            const [filterPriority, setFilterPriority] = useState('all');
            const [filterResolved, setFilterResolved] = useState('unresolved');
            const [selectedAlert, setSelectedAlert] = useState(null);
            const itemsPerPage = 20;

            useEffect(() => {
                loadAlerts();
                
                // Set up real-time listener for SOS alerts
                const unsubscribe = db.collection('alerts')
                    .where('type', '==', 'sos')
                    .where('resolved', '==', false)
                    .onSnapshot(snapshot => {
                        snapshot.docChanges().forEach(change => {
                            if (change.type === 'added') {
                                const alert = { id: change.doc.id, ...change.doc.data() };
                                if (alert.createdAt?.toDate() > new Date(Date.now() - 5000)) {
                                    // New SOS alert - show immediate notification
                                    showSOSNotification(alert);
                                }
                            }
                        });
                    });
                
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                filterAlerts();
            }, [alerts, filterType, filterPriority, filterResolved, searchQuery]);

            const showSOSNotification = async (alert) => {
                // Browser notification if supported
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('üö® SOS ALERT', {
                        body: `Emergency alert from ${alert.userName}`,
                        icon: '/favicon.ico',
                        requireInteraction: true
                    });
                } else if ('Notification' in window && Notification.permission !== 'denied') {
                    Notification.requestPermission();
                }
                
                // Also create in-app notification
                await db.collection('notifications').add({
                    type: 'sos',
                    message: `SOS Alert from ${alert.userName}`,
                    recipientId: user.uid,
                    relatedId: alert.id,
                    urgent: true,
                    read: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            };

            const loadAlerts = async () => {
                try {
                    // Load alerts
                    const alertsSnap = await db.collection('alerts')
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    const alertsData = [];
                    const userIds = new Set();
                    
                    alertsSnap.forEach(doc => {
                        const alert = { id: doc.id, ...doc.data() };
                        alertsData.push(alert);
                        if (alert.userId) userIds.add(alert.userId);
                    });
                    
                    // Batch load user names
                    if (userIds.size > 0) {
                        const userResults = await batchQuery('users',
                            firebase.firestore.FieldPath.documentId(),
                            Array.from(userIds)
                        );
                        
                        const userMap = {};
                        userResults.forEach(user => {
                            userMap[user.id] = user.displayName || user.email;
                        });
                        
                        alertsData.forEach(alert => {
                            alert.userName = userMap[alert.userId] || 'Unknown User';
                        });
                    }
                    
                    setAlerts(alertsData);
                    setFilteredAlerts(alertsData);
                } catch (error) {
                    console.error('Error loading alerts:', error);
                    alert('Failed to load alerts');
                } finally {
                    setLoading(false);
                }
            };

            const filterAlerts = () => {
                let filtered = alerts;
                
                // Filter by type
                if (filterType !== 'all') {
                    filtered = filtered.filter(alert => alert.type === filterType);
                }
                
                // Filter by priority
                if (filterPriority !== 'all') {
                    filtered = filtered.filter(alert => alert.priority === filterPriority);
                }
                
                // Filter by resolved status
                if (filterResolved === 'resolved') {
                    filtered = filtered.filter(alert => alert.resolved);
                } else if (filterResolved === 'unresolved') {
                    filtered = filtered.filter(alert => !alert.resolved);
                }
                
                // Filter by search
                if (searchQuery) {
                    const query = searchQuery.toLowerCase();
                    filtered = filtered.filter(alert =>
                        alert.userName?.toLowerCase().includes(query) ||
                        alert.message?.toLowerCase().includes(query) ||
                        alert.type?.toLowerCase().includes(query)
                    );
                }
                
                setFilteredAlerts(filtered);
                setCurrentPage(1);
            };

            const handleResolve = async (alertId, notes = '') => {
                try {
                    await db.collection('alerts').doc(alertId).update({
                        resolved: true,
                        resolvedBy: user.uid,
                        resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        resolutionNotes: notes
                    });
                    
                    // Update local state
                    setAlerts(prev => prev.map(a => 
                        a.id === alertId ? { ...a, resolved: true, resolutionNotes: notes } : a
                    ));
                    
                    alert('Alert resolved successfully');
                } catch (error) {
                    console.error('Error resolving alert:', error);
                    alert('Failed to resolve alert');
                }
            };

            const handleDelete = async (alertId) => {
                if (!confirm('Are you sure you want to delete this alert?')) return;
                
                try {
                    await db.collection('alerts').doc(alertId).delete();
                    setAlerts(prev => prev.filter(a => a.id !== alertId));
                    alert('Alert deleted');
                } catch (error) {
                    console.error('Error deleting alert:', error);
                    alert('Failed to delete alert');
                }
            };

            const paginatedAlerts = useMemo(() => {
                const start = (currentPage - 1) * itemsPerPage;
                const end = start + itemsPerPage;
                return filteredAlerts.slice(start, end);
            }, [filteredAlerts, currentPage]);

            const totalPages = Math.ceil(filteredAlerts.length / itemsPerPage);

            const handleExport = (format) => {
                const exportData = filteredAlerts.map(alert => ({
                    user: alert.userName,
                    type: alert.type,
                    priority: alert.priority || 'Normal',
                    message: alert.message,
                    status: alert.resolved ? 'Resolved' : 'Active',
                    createdAt: formatDateTime(alert.createdAt),
                    resolvedAt: alert.resolvedAt ? formatDateTime(alert.resolvedAt) : 'N/A',
                    resolutionNotes: alert.resolutionNotes || 'N/A'
                }));

                if (format === 'json') {
                    exportToJSON(exportData, 'alerts');
                } else if (format === 'csv') {
                    exportToCSV(exportData, 'alerts');
                } else if (format === 'pdf') {
                    exportToPDF(exportData, 'Alerts Report');
                }
            };

            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="loading-spinner"></div>
                    </div>
                );
            }

            return (
                <div>
                    <div className="filter-bar">
                        <div className="filter-group">
                            <label className="filter-label">Type</label>
                            <select 
                                className="filter-select"
                                value={filterType}
                                onChange={(e) => setFilterType(e.target.value)}
                            >
                                <option value="all">All Types</option>
                                <option value="sos">SOS Emergency</option>
                                <option value="missed_checkin">Missed Check-in</option>
                                <option value="low_mood">Low Mood</option>
                                <option value="high_craving">High Craving</option>
                                <option value="system">System Alert</option>
                            </select>
                        </div>
                        
                        <div className="filter-group">
                            <label className="filter-label">Priority</label>
                            <select 
                                className="filter-select"
                                value={filterPriority}
                                onChange={(e) => setFilterPriority(e.target.value)}
                            >
                                <option value="all">All Priorities</option>
                                <option value="critical">Critical</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        
                        <div className="filter-group">
                            <label className="filter-label">Status</label>
                            <select 
                                className="filter-select"
                                value={filterResolved}
                                onChange={(e) => setFilterResolved(e.target.value)}
                            >
                                <option value="all">All Status</option>
                                <option value="unresolved">Active</option>
                                <option value="resolved">Resolved</option>
                            </select>
                        </div>
                        
                        <div style={{marginLeft: 'auto', display: 'flex', gap: '10px'}}>
                            <button className="btn btn-secondary" onClick={() => handleExport('csv')}>
                                Export CSV
                            </button>
                            <button className="btn btn-secondary" onClick={() => handleExport('json')}>
                                Export JSON
                            </button>
                        </div>
                    </div>
                    
                    {/* SOS Alert Banner for active emergencies */}
                    {filteredAlerts.filter(a => a.type === 'sos' && !a.resolved).length > 0 && (
                        <div style={{
                            background: 'linear-gradient(135deg, #ff4444, #cc0000)',
                            padding: '15px',
                            borderRadius: '10px',
                            marginBottom: '20px',
                            animation: 'pulse 2s infinite'
                        }}>
                            <div style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                                <span style={{fontSize: '24px'}}>üö®</span>
                                <span style={{fontSize: '16px', fontWeight: 'bold'}}>
                                    {filteredAlerts.filter(a => a.type === 'sos' && !a.resolved).length} Active SOS Alert(s)
                                </span>
                            </div>
                        </div>
                    )}
                    
                    <div className="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Type</th>
                                    <th>Priority</th>
                                    <th>Message</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {paginatedAlerts.map(alert => (
                                    <tr key={alert.id} style={{
                                        background: alert.type === 'sos' && !alert.resolved ? 
                                            'rgba(244, 67, 54, 0.1)' : 'transparent'
                                    }}>
                                        <td>{alert.userName}</td>
                                        <td>
                                            <span className={`badge ${
                                                alert.type === 'sos' ? 'badge-danger' :
                                                alert.type === 'missed_checkin' ? 'badge-warning' :
                                                'badge-info'
                                            }`}>
                                                {alert.type === 'sos' ? 'üö® SOS' : alert.type?.replace('_', ' ')}
                                            </span>
                                        </td>
                                        <td>
                                            <span className={`badge ${
                                                alert.priority === 'critical' ? 'badge-danger' :
                                                alert.priority === 'high' ? 'badge-warning' :
                                                'badge-info'
                                            }`}>
                                                {alert.priority || 'Normal'}
                                            </span>
                                        </td>
                                        <td style={{maxWidth: '200px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>
                                            {alert.message}
                                        </td>
                                        <td>
                                            <span className={`badge ${alert.resolved ? 'badge-success' : 'badge-danger'}`}>
                                                {alert.resolved ? 'Resolved' : 'Active'}
                                            </span>
                                        </td>
                                        <td>{formatTimeAgo(alert.createdAt)}</td>
                                        <td>
                                            <div className="action-buttons">
                                                <button 
                                                    className="action-btn"
                                                    onClick={() => setSelectedAlert(alert)}
                                                >
                                                    View
                                                </button>
                                                {!alert.resolved && (
                                                    <button 
                                                        className="action-btn"
                                                        onClick={() => {
                                                            const notes = prompt('Resolution notes (optional):');
                                                            if (notes !== null) {
                                                                handleResolve(alert.id, notes);
                                                            }
                                                        }}
                                                        style={{color: '#4caf50'}}
                                                    >
                                                        Resolve
                                                    </button>
                                                )}
                                                <button 
                                                    className="action-btn"
                                                    onClick={() => handleDelete(alert.id)}
                                                    style={{color: '#f44336'}}
                                                >
                                                    Delete
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        
                        {filteredAlerts.length === 0 && (
                            <div className="empty-state">
                                <div className="empty-state-text">
                                    {searchQuery ? 'No alerts found matching your search' : 'No alerts found'}
                                </div>
                            </div>
                        )}
                    </div>
                    
                    {totalPages > 1 && (
                        <Pagination 
                            currentPage={currentPage}
                            totalPages={totalPages}
                            onPageChange={setCurrentPage}
                        />
                    )}
                    
                    {selectedAlert && (
                        <AlertDetailModal 
                            alert={selectedAlert}
                            onClose={() => setSelectedAlert(null)}
                            onResolve={handleResolve}
                        />
                    )}
                </div>
            );
        }

        // FULLY FUNCTIONAL ReportsView
        function ReportsView({ user }) {
            const [reportType, setReportType] = useState('overview');
            const [startDate, setStartDate] = useState(() => {
                const date = new Date();
                date.setMonth(date.getMonth() - 1);
                return date.toISOString().split('T')[0];
            });
            const [endDate, setEndDate] = useState(() => {
                return new Date().toISOString().split('T')[0];
            });
            const [reportData, setReportData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [chartInstances, setChartInstances] = useState({});

            useEffect(() => {
                // Cleanup charts on unmount
                return () => {
                    Object.values(chartInstances).forEach(chart => {
                        if (chart) chart.destroy();
                    });
                };
            }, []);

            const generateReport = async () => {
                setLoading(true);
                try {
                    const start = new Date(startDate);
                    start.setHours(0, 0, 0, 0);
                    const end = new Date(endDate);
                    end.setHours(23, 59, 59, 999);
                    
                    let data = {};
                    
                    switch (reportType) {
                        case 'overview':
                            data = await generateOverviewReport(start, end);
                            break;
                        case 'checkins':
                            data = await generateCheckInsReport(start, end);
                            break;
                        case 'users':
                            data = await generateUsersReport(start, end);
                            break;
                        case 'assignments':
                            data = await generateAssignmentsReport(start, end);
                            break;
                        case 'alerts':
                            data = await generateAlertsReport(start, end);
                            break;
                        case 'groups':
                            data = await generateGroupsReport(start, end);
                            break;
                    }
                    
                    setReportData(data);
                    
                    // Render charts after data is set
                    setTimeout(() => renderCharts(data), 100);
                    
                } catch (error) {
                    console.error('Error generating report:', error);
                    alert('Failed to generate report');
                } finally {
                    setLoading(false);
                }
            };

            const generateOverviewReport = async (start, end) => {
                // Get all relevant data
                const [usersSnap, checkInsSnap, assignmentsSnap, alertsSnap, messagesSnap, groupsSnap] = await Promise.all([
                    db.collection('users').get(),
                    db.collection('checkIns')
                        .where('createdAt', '>=', start)
                        .where('createdAt', '<=', end)
                        .get(),
                    db.collection('assignments')
                        .where('createdAt', '>=', start)
                        .where('createdAt', '<=', end)
                        .get(),
                    db.collection('alerts')
                        .where('createdAt', '>=', start)
                        .where('createdAt', '<=', end)
                        .get(),
                    db.collection('messages')
                        .where('createdAt', '>=', start)
                        .where('createdAt', '<=', end)
                        .get(),
                    db.collection('groups').get()
                ]);
                
                const totalPirs = usersSnap.docs.filter(doc => doc.data().role === 'pir').length;
                const activePirs = usersSnap.docs.filter(doc => doc.data().role === 'pir' && doc.data().active !== false).length;
                const totalCoaches = usersSnap.docs.filter(doc => doc.data().role === 'coach').length;
                
                const checkIns = checkInsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const avgMood = checkIns.length > 0 ? 
                    (checkIns.reduce((sum, c) => sum + (c.mood || 0), 0) / checkIns.length).toFixed(1) : 0;
                const avgCravings = checkIns.length > 0 ? 
                    (checkIns.reduce((sum, c) => sum + (c.cravings || 0), 0) / checkIns.length).toFixed(1) : 0;
                
                const completedAssignments = assignmentsSnap.docs.filter(doc => doc.data().status === 'completed').length;
                const sosAlerts = alertsSnap.docs.filter(doc => doc.data().type === 'sos').length;
                const resolvedAlerts = alertsSnap.docs.filter(doc => doc.data().resolved).length;
                
                return {
                    summary: {
                        totalPirs,
                        activePirs,
                        totalCoaches,
                        totalCheckIns: checkInsSnap.size,
                        avgMood,
                        avgCravings,
                        totalAssignments: assignmentsSnap.size,
                        completedAssignments,
                        totalAlerts: alertsSnap.size,
                        sosAlerts,
                        resolvedAlerts,
                        totalMessages: messagesSnap.size,
                        totalGroups: groupsSnap.size
                    },
                    charts: {
                        dailyCheckIns: await getDailyCheckInCounts(start, end),
                        moodTrends: await getMoodTrends(start, end),
                        cravingTrends: await getCravingTrends(start, end)
                    }
                };
            };

            const generateCheckInsReport = async (start, end) => {
                const checkInsSnap = await db.collection('checkIns')
                    .where('createdAt', '>=', start)
                    .where('createdAt', '<=', end)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const checkIns = checkInsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const byUser = {};
                checkIns.forEach(checkIn => {
                    if (!byUser[checkIn.userId]) {
                        byUser[checkIn.userId] = {
                            count: 0,
                            totalMood: 0,
                            totalCravings: 0
                        };
                    }
                    byUser[checkIn.userId].count++;
                    byUser[checkIn.userId].totalMood += checkIn.mood || 0;
                    byUser[checkIn.userId].totalCravings += checkIn.cravings || 0;
                });
                
                const userStats = Object.entries(byUser).map(([userId, stats]) => ({
                    userId,
                    checkIns: stats.count,
                    avgMood: (stats.totalMood / stats.count).toFixed(1),
                    avgCravings: (stats.totalCravings / stats.count).toFixed(1)
                }));
                
                return {
                    total: checkIns.length,
                    userStats,
                    moodDistribution: getMoodDistribution(checkIns),
                    cravingDistribution: getCravingDistribution(checkIns),
                    dailyCounts: await getDailyCheckInCounts(start, end)
                };
            };

            const generateUsersReport = async (start, end) => {
                const usersSnap = await db.collection('users')
                    .where('createdAt', '>=', start)
                    .where('createdAt', '<=', end)
                    .get();
                
                const newUsers = usersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const byRole = {
                    pir: newUsers.filter(u => u.role === 'pir').length,
                    coach: newUsers.filter(u => u.role === 'coach').length,
                    admin: newUsers.filter(u => u.role === 'admin').length
                };
                
                const activeCount = newUsers.filter(u => u.active !== false).length;
                
                return {
                    newUsers: newUsers.length,
                    byRole,
                    activeCount,
                    inactiveCount: newUsers.length - activeCount,
                    userList: newUsers
                };
            };

            const generateAssignmentsReport = async (start, end) => {
                const assignmentsSnap = await db.collection('assignments')
                    .where('createdAt', '>=', start)
                    .where('createdAt', '<=', end)
                    .get();
                
                const assignments = assignmentsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const byStatus = {
                    pending: assignments.filter(a => a.status === 'pending').length,
                    in_progress: assignments.filter(a => a.status === 'in_progress').length,
                    completed: assignments.filter(a => a.status === 'completed').length
                };
                
                const overdueCount = assignments.filter(a => {
                    if (a.dueDate && a.status !== 'completed') {
                        const dueDate = a.dueDate.toDate ? a.dueDate.toDate() : new Date(a.dueDate);
                        return dueDate < new Date();
                    }
                    return false;
                }).length;
                
                return {
                    total: assignments.length,
                    byStatus,
                    overdueCount,
                    completionRate: assignments.length > 0 ? 
                        ((byStatus.completed / assignments.length) * 100).toFixed(1) : 0
                };
            };

            const generateAlertsReport = async (start, end) => {
                const alertsSnap = await db.collection('alerts')
                    .where('createdAt', '>=', start)
                    .where('createdAt', '<=', end)
                    .get();
                
                const alerts = alertsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const byType = {};
                const byPriority = {};
                
                alerts.forEach(alert => {
                    byType[alert.type] = (byType[alert.type] || 0) + 1;
                    byPriority[alert.priority || 'normal'] = (byPriority[alert.priority || 'normal'] || 0) + 1;
                });
                
                const resolved = alerts.filter(a => a.resolved).length;
                const avgResolutionTime = calculateAvgResolutionTime(alerts.filter(a => a.resolved));
                
                return {
                    total: alerts.length,
                    byType,
                    byPriority,
                    resolved,
                    unresolved: alerts.length - resolved,
                    avgResolutionTime
                };
            };

            const generateGroupsReport = async (start, end) => {
                const groupsSnap = await db.collection('groups').get();
                const groups = groupsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const totalMembers = groups.reduce((sum, g) => sum + (g.members?.length || 0), 0);
                const avgMembersPerGroup = groups.length > 0 ? (totalMembers / groups.length).toFixed(1) : 0;
                
                const byDay = {};
                groups.forEach(group => {
                    byDay[group.dayOfWeek] = (byDay[group.dayOfWeek] || 0) + 1;
                });
                
                return {
                    totalGroups: groups.length,
                    totalMembers,
                    avgMembersPerGroup,
                    byDay,
                    recurringGroups: groups.filter(g => g.recurring).length,
                    oneTimeGroups: groups.filter(g => !g.recurring).length
                };
            };

            const getDailyCheckInCounts = async (start, end) => {
                const dates = [];
                const counts = [];
                const current = new Date(start);
                
                while (current <= end) {
                    const dayStart = new Date(current);
                    dayStart.setHours(0, 0, 0, 0);
                    const dayEnd = new Date(current);
                    dayEnd.setHours(23, 59, 59, 999);
                    
                    const dayCheckIns = await db.collection('checkIns')
                        .where('createdAt', '>=', dayStart)
                        .where('createdAt', '<=', dayEnd)
                        .get();
                    
                    dates.push(current.toLocaleDateString());
                    counts.push(dayCheckIns.size);
                    
                    current.setDate(current.getDate() + 1);
                }
                
                return { dates, counts };
            };

            const getMoodTrends = async (start, end) => {
                const dates = [];
                const avgMoods = [];
                const current = new Date(start);
                
                while (current <= end) {
                    const dayStart = new Date(current);
                    dayStart.setHours(0, 0, 0, 0);
                    const dayEnd = new Date(current);
                    dayEnd.setHours(23, 59, 59, 999);
                    
                    const dayCheckIns = await db.collection('checkIns')
                        .where('createdAt', '>=', dayStart)
                        .where('createdAt', '<=', dayEnd)
                        .get();
                    
                    const moods = dayCheckIns.docs.map(doc => doc.data().mood || 0);
                    const avgMood = moods.length > 0 ? 
                        (moods.reduce((sum, m) => sum + m, 0) / moods.length).toFixed(1) : 0;
                    
                    dates.push(current.toLocaleDateString());
                    avgMoods.push(avgMood);
                    
                    current.setDate(current.getDate() + 1);
                }
                
                return { dates, avgMoods };
            };

            const getCravingTrends = async (start, end) => {
                const dates = [];
                const avgCravings = [];
                const current = new Date(start);
                
                while (current <= end) {
                    const dayStart = new Date(current);
                    dayStart.setHours(0, 0, 0, 0);
                    const dayEnd = new Date(current);
                    dayEnd.setHours(23, 59, 59, 999);
                    
                    const dayCheckIns = await db.collection('checkIns')
                        .where('createdAt', '>=', dayStart)
                        .where('createdAt', '<=', dayEnd)
                        .get();
                    
                    const cravings = dayCheckIns.docs.map(doc => doc.data().cravings || 0);
                    const avgCraving = cravings.length > 0 ? 
                        (cravings.reduce((sum, c) => sum + c, 0) / cravings.length).toFixed(1) : 0;
                    
                    dates.push(current.toLocaleDateString());
                    avgCravings.push(avgCraving);
                    
                    current.setDate(current.getDate() + 1);
                }
                
                return { dates, avgCravings };
            };

            const getMoodDistribution = (checkIns) => {
                const distribution = Array(10).fill(0);
                checkIns.forEach(c => {
                    if (c.mood >= 1 && c.mood <= 10) {
                        distribution[c.mood - 1]++;
                    }
                });
                return distribution;
            };

            const getCravingDistribution = (checkIns) => {
                const distribution = Array(10).fill(0);
                checkIns.forEach(c => {
                    if (c.cravings >= 1 && c.cravings <= 10) {
                        distribution[c.cravings - 1]++;
                    }
                });
                return distribution;
            };

            const calculateAvgResolutionTime = (resolvedAlerts) => {
                if (resolvedAlerts.length === 0) return 'N/A';
                
                const times = resolvedAlerts.map(alert => {
                    const created = alert.createdAt?.toDate ? alert.createdAt.toDate() : new Date(alert.createdAt);
                    const resolved = alert.resolvedAt?.toDate ? alert.resolvedAt.toDate() : new Date(alert.resolvedAt);
                    return resolved - created;
                });
                
                const avgTime = times.reduce((sum, t) => sum + t, 0) / times.length;
                const hours = Math.floor(avgTime / (1000 * 60 * 60));
                const minutes = Math.floor((avgTime % (1000 * 60 * 60)) / (1000 * 60));
                
                return `${hours}h ${minutes}m`;
            };

            const renderCharts = (data) => {
                // Clean up existing charts
                Object.values(chartInstances).forEach(chart => {
                    if (chart) chart.destroy();
                });
                
                const newCharts = {};
                
                // Render charts based on report type
                if (reportType === 'overview' && data.charts) {
                    // Daily Check-ins Chart
                    const checkInsCtx = document.getElementById('dailyCheckInsChart')?.getContext('2d');
                    if (checkInsCtx) {
                        newCharts.dailyCheckIns = new Chart(checkInsCtx, {
                            type: 'line',
                            data: {
                                labels: data.charts.dailyCheckIns.dates,
                                datasets: [{
                                    label: 'Daily Check-ins',
                                    data: data.charts.dailyCheckIns.counts,
                                    borderColor: '#f4c430',
                                    backgroundColor: 'rgba(244, 196, 48, 0.2)',
                                    tension: 0.1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                        ticks: { color: 'rgba(255, 255, 255, 0.7)' }
                                    },
                                    x: {
                                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                        ticks: { color: 'rgba(255, 255, 255, 0.7)' }
                                    }
                                },
                                plugins: {
                                    legend: {
                                        labels: { color: 'rgba(255, 255, 255, 0.9)' }
                                    }
                                }
                            }
                        });
                    }
                    
                    // Mood Trends Chart
                    const moodCtx = document.getElementById('moodTrendsChart')?.getContext('2d');
                    if (moodCtx) {
                        newCharts.moodTrends = new Chart(moodCtx, {
                            type: 'line',
                            data: {
                                labels: data.charts.moodTrends.dates,
                                datasets: [{
                                    label: 'Average Mood',
                                    data: data.charts.moodTrends.avgMoods,
                                    borderColor: '#4caf50',
                                    backgroundColor: 'rgba(76, 175, 80, 0.2)',
                                    tension: 0.1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 10,
                                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                        ticks: { color: 'rgba(255, 255, 255, 0.7)' }
                                    },
                                    x: {
                                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                        ticks: { color: 'rgba(255, 255, 255, 0.7)' }
                                    }
                                },
                                plugins: {
                                    legend: {
                                        labels: { color: 'rgba(255, 255, 255, 0.9)' }
                                    }
                                }
                            }
                        });
                    }
                }
                
                setChartInstances(newCharts);
            };

            const exportReport = (format) => {
                if (!reportData) {
                    alert('Please generate a report first');
                    return;
                }
                
                const fileName = `${reportType}_report_${startDate}_to_${endDate}`;
                
                if (format === 'json') {
                    exportToJSON(reportData, fileName);
                } else if (format === 'pdf') {
                    exportToPDF(reportData, `${reportType.charAt(0).toUpperCase() + reportType.slice(1)} Report`);
                }
            };

            return (
                <div>
                    <div className="filter-bar">
                        <div className="filter-group">
                            <label className="filter-label">Report Type</label>
                            <select 
                                className="filter-select"
                                value={reportType}
                                onChange={(e) => setReportType(e.target.value)}
                            >
                                <option value="overview">Overview Report</option>
                                <option value="checkins">Check-ins Report</option>
                                <option value="users">Users Report</option>
                                <option value="assignments">Assignments Report</option>
                                <option value="alerts">Alerts Report</option>
                                <option value="groups">Groups Report</option>
                            </select>
                        </div>
                        
                        <div className="date-range">
                            <div className="filter-group">
                                <label className="filter-label">Start Date</label>
                                <input 
                                    type="date"
                                    className="date-input"
                                    value={startDate}
                                    onChange={(e) => setStartDate(e.target.value)}
                                />
                            </div>
                            
                            <div className="filter-group">
                                <label className="filter-label">End Date</label>
                                <input 
                                    type="date"
                                    className="date-input"
                                    value={endDate}
                                    onChange={(e) => setEndDate(e.target.value)}
                                />
                            </div>
                        </div>
                        
                        <div style={{marginLeft: 'auto', display: 'flex', gap: '10px'}}>
                            <button 
                                className="btn btn-primary"
                                onClick={generateReport}
                                disabled={loading}
                            >
                                {loading ? 'Generating...' : 'Generate Report'}
                            </button>
                            {reportData && (
                                <>
                                    <button className="btn btn-secondary" onClick={() => exportReport('json')}>
                                        Export JSON
                                    </button>
                                    <button className="btn btn-secondary" onClick={() => exportReport('pdf')}>
                                        Export PDF
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                    
                    {loading && (
                        <div className="loading-container">
                            <div className="loading-spinner"></div>
                        </div>
                    )}
                    
                    {reportData && !loading && (
                        <div>
                            {reportType === 'overview' && (
                                <div>
                                    <div className="stats-grid">
                                        <div className="stat-card">
                                            <div className="stat-label">Total PIRs</div>
                                            <div className="stat-value">{reportData.summary.totalPirs}</div>
                                            <div className="stat-change">{reportData.summary.activePirs} active</div>
                                        </div>
                                        <div className="stat-card">
                                            <div className="stat-label">Total Coaches</div>
                                            <div className="stat-value">{reportData.summary.totalCoaches}</div>
                                        </div>
                                        <div className="stat-card">
                                            <div className="stat-label">Check-ins</div>
                                            <div className="stat-value">{reportData.summary.totalCheckIns}</div>
                                            <div className="stat-change">Avg Mood: {reportData.summary.avgMood}</div>
                                        </div>
                                        <div className="stat-card">
                                            <div className="stat-label">Assignments</div>
                                            <div className="stat-value">{reportData.summary.totalAssignments}</div>
                                            <div className="stat-change">{reportData.summary.completedAssignments} completed</div>
                                        </div>
                                        <div className="stat-card">
                                            <div className="stat-label">Alerts</div>
                                            <div className="stat-value">{reportData.summary.totalAlerts}</div>
                                            <div className="stat-change">{reportData.summary.sosAlerts} SOS</div>
                                        </div>
                                        <div className="stat-card">
                                            <div className="stat-label">Messages</div>
                                            <div className="stat-value">{reportData.summary.totalMessages}</div>
                                        </div>
                                    </div>
                                    
                                    <div className="chart-container" style={{marginTop: '30px'}}>
                                        <h3 style={{marginBottom: '20px'}}>Daily Check-ins</h3>
                                        <canvas id="dailyCheckInsChart"></canvas>
                                    </div>
                                    
                                    <div className="chart-container" style={{marginTop: '30px'}}>
                                        <h3 style={{marginBottom: '20px'}}>Mood Trends</h3>
                                        <canvas id="moodTrendsChart"></canvas>
                                    </div>
                                </div>
                            )}
                            
                            {reportType !== 'overview' && (
                                <div className="table-container">
                                    <h3 style={{marginBottom: '20px'}}>
                                        {reportType.charAt(0).toUpperCase() + reportType.slice(1)} Report Results
                                    </h3>
                                    <pre style={{
                                        background: 'rgba(255,255,255,0.05)',
                                        padding: '20px',
                                        borderRadius: '10px',
                                        overflow: 'auto'
                                    }}>
                                        {JSON.stringify(reportData, null, 2)}
                                    </pre>
                                </div>
                            )}
                        </div>
                    )}
                    
                    {!reportData && !loading && (
                        <div className="empty-state">
                            <div className="empty-state-icon">üìà</div>
                            <div className="empty-state-text">Select report parameters and click Generate Report</div>
                        </div>
                    )}
                </div>
            );
        }

        // FULLY FUNCTIONAL SettingsView
        function SettingsView({ user }) {
            const [settings, setSettings] = useState({
                checkInReminder: true,
                checkInReminderTime: '09:00',
                sosNotifications: true,
                emailNotifications: false,
                smsNotifications: false,
                lowMoodThreshold: 3,
                highCravingThreshold: 7,
                autoArchiveMessages: 30,
                dataRetentionDays: 365,
                maintenanceMode: false
            });
            const [saving, setSaving] = useState(false);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                loadSettings();
            }, []);

            const loadSettings = async () => {
                try {
                    const settingsDoc = await db.collection('settings').doc('system').get();
                    if (settingsDoc.exists) {
                        setSettings(settingsDoc.data());
                    }
                } catch (error) {
                    console.error('Error loading settings:', error);
                } finally {
                    setLoading(false);
                }
            };

            const saveSettings = async () => {
                setSaving(true);
                try {
                    await db.collection('settings').doc('system').set({
                        ...settings,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: user.uid
                    });
                    alert('Settings saved successfully');
                } catch (error) {
                    console.error('Error saving settings:', error);
                    alert('Failed to save settings');
                } finally {
                    setSaving(false);
                }
            };

            const handleBackup = async () => {
                if (!confirm('This will create a full backup of all data. Continue?')) return;
                
                try {
                    const collections = ['users', 'checkIns', 'assignments', 'alerts', 'messages', 'groups', 'resources', 'feedback'];
                    const backup = {};
                    
                    for (const collection of collections) {
                        const snapshot = await db.collection(collection).get();
                        backup[collection] = [];
                        snapshot.forEach(doc => {
                            backup[collection].push({ id: doc.id, ...doc.data() });
                        });
                    }
                    
                    const fileName = `glrs_backup_${new Date().toISOString().split('T')[0]}`;
                    exportToJSON(backup, fileName);
                    alert('Backup created successfully');
                } catch (error) {
                    console.error('Error creating backup:', error);
                    alert('Failed to create backup');
                }
            };

            const handleCleanup = async (type) => {
                let message = '';
                let query;
                
                const cutoffDate = new Date();
                
                switch (type) {
                    case 'old_notifications':
                        cutoffDate.setDate(cutoffDate.getDate() - 30);
                        message = 'Delete notifications older than 30 days?';
                        query = db.collection('notifications')
                            .where('createdAt', '<', cutoffDate)
                            .where('read', '==', true);
                        break;
                    case 'old_messages':
                        cutoffDate.setDate(cutoffDate.getDate() - settings.autoArchiveMessages);
                        message = `Archive messages older than ${settings.autoArchiveMessages} days?`;
                        query = db.collection('messages')
                            .where('createdAt', '<', cutoffDate);
                        break;
                    case 'resolved_alerts':
                        cutoffDate.setDate(cutoffDate.getDate() - 90);
                        message = 'Delete resolved alerts older than 90 days?';
                        query = db.collection('alerts')
                            .where('resolved', '==', true)
                            .where('resolvedAt', '<', cutoffDate);
                        break;
                    default:
                        return;
                }
                
                if (!confirm(message)) return;
                
                try {
                    const snapshot = await query.get();
                    const batch = db.batch();
                    let count = 0;
                    
                    snapshot.forEach(doc => {
                        if (type === 'old_messages') {
                            // Archive instead of delete
                            batch.update(doc.ref, { archived: true });
                        } else {
                            batch.delete(doc.ref);
                        }
                        count++;
                        
                        // Firestore batch limit is 500
                        if (count % 500 === 0) {
                            batch.commit();
                            batch = db.batch();
                        }
                    });
                    
                    await batch.commit();
                    alert(`${count} items processed successfully`);
                } catch (error) {
                    console.error('Error during cleanup:', error);
                    alert('Cleanup failed: ' + error.message);
                }
            };

            const handleCheckMissedCheckIns = async () => {
                try {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    yesterday.setHours(0, 0, 0, 0);
                    
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    // Get all active PIRs
                    const pirsSnap = await db.collection('users')
                        .where('role', '==', 'pir')
                        .where('active', '==', true)
                        .get();
                    
                    const pirIds = pirsSnap.docs.map(doc => doc.id);
                    
                    // Get yesterday's check-ins
                    const checkInsSnap = await db.collection('checkIns')
                        .where('createdAt', '>=', yesterday)
                        .where('createdAt', '<', today)
                        .get();
                    
                    const checkedInUsers = new Set(checkInsSnap.docs.map(doc => doc.data().userId));
                    
                    const missedUsers = pirIds.filter(id => !checkedInUsers.has(id));
                    
                    // Create alerts for missed check-ins
                    const batch = db.batch();
                    missedUsers.forEach(userId => {
                        const alertRef = db.collection('alerts').doc();
                        batch.set(alertRef, {
                            type: 'missed_checkin',
                            userId: userId,
                            message: `Missed daily check-in on ${yesterday.toLocaleDateString()}`,
                            priority: 'medium',
                            resolved: false,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });
                    
                    await batch.commit();
                    alert(`${missedUsers.length} missed check-in alerts created`);
                } catch (error) {
                    console.error('Error checking missed check-ins:', error);
                    alert('Failed to check missed check-ins');
                }
            };

            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="loading-spinner"></div>
                    </div>
                );
            }

            return (
                <div>
                    <div className="table-container">
                        <h3 style={{marginBottom: '20px'}}>System Settings</h3>
                        
                        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px'}}>
                            <div className="form-group">
                                <label className="form-label">Check-in Reminder Time</label>
                                <input
                                    type="time"
                                    className="form-input"
                                    value={settings.checkInReminderTime}
                                    onChange={(e) => setSettings({...settings, checkInReminderTime: e.target.value})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Low Mood Threshold (1-10)</label>
                                <input
                                    type="number"
                                    className="form-input"
                                    min="1"
                                    max="10"
                                    value={settings.lowMoodThreshold}
                                    onChange={(e) => setSettings({...settings, lowMoodThreshold: parseInt(e.target.value)})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">High Craving Threshold (1-10)</label>
                                <input
                                    type="number"
                                    className="form-input"
                                    min="1"
                                    max="10"
                                    value={settings.highCravingThreshold}
                                    onChange={(e) => setSettings({...settings, highCravingThreshold: parseInt(e.target.value)})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Auto-archive Messages (days)</label>
                                <input
                                    type="number"
                                    className="form-input"
                                    min="7"
                                    max="365"
                                    value={settings.autoArchiveMessages}
                                    onChange={(e) => setSettings({...settings, autoArchiveMessages: parseInt(e.target.value)})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Data Retention (days)</label>
                                <input
                                    type="number"
                                    className="form-input"
                                    min="90"
                                    max="2555"
                                    value={settings.dataRetentionDays}
                                    onChange={(e) => setSettings({...settings, dataRetentionDays: parseInt(e.target.value)})}
                                />
                            </div>
                        </div>
                        
                        <div style={{marginTop: '20px'}}>
                            <h4 style={{marginBottom: '15px'}}>Notification Settings</h4>
                            
                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="checkInReminder"
                                    checked={settings.checkInReminder}
                                    onChange={(e) => setSettings({...settings, checkInReminder: e.target.checked})}
                                />
                                <label htmlFor="checkInReminder">Enable Check-in Reminders</label>
                            </div>
                            
                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="sosNotifications"
                                    checked={settings.sosNotifications}
                                    onChange={(e) => setSettings({...settings, sosNotifications: e.target.checked})}
                                />
                                <label htmlFor="sosNotifications">Enable SOS Notifications</label>
                            </div>
                            
                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="emailNotifications"
                                    checked={settings.emailNotifications}
                                    onChange={(e) => setSettings({...settings, emailNotifications: e.target.checked})}
                                />
                                <label htmlFor="emailNotifications">Enable Email Notifications</label>
                            </div>
                            
                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="smsNotifications"
                                    checked={settings.smsNotifications}
                                    onChange={(e) => setSettings({...settings, smsNotifications: e.target.checked})}
                                />
                                <label htmlFor="smsNotifications">Enable SMS Notifications</label>
                            </div>
                            
                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="maintenanceMode"
                                    checked={settings.maintenanceMode}
                                    onChange={(e) => setSettings({...settings, maintenanceMode: e.target.checked})}
                                />
                                <label htmlFor="maintenanceMode">Maintenance Mode (PIRs see maintenance message)</label>
                            </div>
                        </div>
                        
                        <button 
                            className="btn btn-primary"
                            onClick={saveSettings}
                            disabled={saving}
                            style={{marginTop: '20px'}}
                        >
                            {saving ? 'Saving...' : 'Save Settings'}
                        </button>
                    </div>
                    
                    <div className="table-container" style={{marginTop: '30px'}}>
                        <h3 style={{marginBottom: '20px'}}>System Actions</h3>
                        
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '20px'}}>
                            <div>
                                <h4>Data Management</h4>
                                <button 
                                    className="btn btn-secondary"
                                    onClick={handleBackup}
                                    style={{width: '100%', marginTop: '10px'}}
                                >
                                    üóÑÔ∏è Create Full Backup
                                </button>
                                <button 
                                    className="btn btn-secondary"
                                    onClick={() => handleCleanup('old_notifications')}
                                    style={{width: '100%', marginTop: '10px'}}
                                >
                                    üßπ Clean Old Notifications
                                </button>
                                <button 
                                    className="btn btn-secondary"
                                    onClick={() => handleCleanup('old_messages')}
                                    style={{width: '100%', marginTop: '10px'}}
                                >
                                    üìß Archive Old Messages
                                </button>
                                <button 
                                    className="btn btn-secondary"
                                    onClick={() => handleCleanup('resolved_alerts')}
                                    style={{width: '100%', marginTop: '10px'}}
                                >
                                    üö® Clean Resolved Alerts
                                </button>
                            </div>
                            
                            <div>
                                <h4>Monitoring</h4>
                                <button 
                                    className="btn btn-secondary"
                                    onClick={handleCheckMissedCheckIns}
                                    style={{width: '100%', marginTop: '10px'}}
                                >
                                    ‚úÖ Check Missed Check-ins
                                </button>
                                <button 
                                    className="btn btn-secondary"
                                    onClick={async () => {
                                        const stats = await db.collection('users').get();
                                        alert(`Database Statistics:\n\nTotal Users: ${stats.size}\nEstimated Storage: ${(stats.size * 5 / 1024).toFixed(2)} MB`);
                                    }}
                                    style={{width: '100%', marginTop: '10px'}}
                                >
                                    üìä Database Statistics
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div className="table-container" style={{marginTop: '30px'}}>
                        <h3 style={{marginBottom: '20px'}}>System Information</h3>
                        <table>
                            <tbody>
                                <tr>
                                    <td><strong>Firebase Project:</strong></td>
                                    <td>glrs-pir-system</td>
                                </tr>
                                <tr>
                                    <td><strong>Environment:</strong></td>
                                    <td>Production</td>
                                </tr>
                                <tr>
                                    <td><strong>Version:</strong></td>
                                    <td>3.0.0</td>
                                </tr>
                                <tr>
                                    <td><strong>Last Settings Update:</strong></td>
                                    <td>{settings.updatedAt ? formatDateTime(settings.updatedAt) : 'Never'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Browser:</strong></td>
                                    <td>{navigator.userAgent}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // Modal Components
        function CreateUserModal({ onClose, onSuccess, coaches }) {
            const [formData, setFormData] = useState({
                email: '',
                password: 'TempPassword123!',
                firstName: '',
                lastName: '',
                role: 'pir',
                assignedCoach: '',
                phone: ''
            });
            const [coachesList, setCoachesList] = useState([]);
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                loadCoaches();
            }, []);

            const loadCoaches = async () => {
                const coachesSnap = await db.collection('users')
                    .where('role', '==', 'coach')
                    .get();
                
                const coachesData = [];
                coachesSnap.forEach(doc => {
                    coachesData.push({ id: doc.id, ...doc.data() });
                });
                setCoachesList(coachesData);
            };

            const validateEmail = (email) => {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                if (!validateEmail(formData.email)) {
                    alert('Please enter a valid email address');
                    return;
                }
                
                setLoading(true);
                
                let secondaryApp;
                try {
                    // Clean up any existing secondary app
                    try {
                        secondaryApp = firebase.app('SecondaryApp');
                        await secondaryApp.delete();
                    } catch (e) {
                        // App doesn't exist
                    }
                    
                    // Create new secondary app
                    secondaryApp = firebase.initializeApp(firebaseConfig, 'SecondaryApp');
                    const secondaryAuth = secondaryApp.auth();
                    
                    // Create auth user
                    const userCredential = await secondaryAuth.createUserWithEmailAndPassword(
                        formData.email,
                        formData.password
                    );
                    
                    // Prepare user data
                    const userData = {
                        email: formData.email,
                        displayName: `${formData.firstName} ${formData.lastName}`,
                        firstName: formData.firstName,
                        lastName: formData.lastName,
                        phone: formData.phone,
                        role: formData.role,
                        active: true,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    // Add coach assignment if PIR
                    if (formData.role === 'pir' && formData.assignedCoach) {
                        userData.assignedCoach = formData.assignedCoach;
                        // Also denormalize coach name for performance
                        const coach = coachesList.find(c => c.id === formData.assignedCoach);
                        if (coach) {
                            userData.assignedCoachName = coach.displayName || coach.email;
                        }
                    }
                    
                    // Create Firestore profile
                    await db.collection('users').doc(userCredential.user.uid).set(userData);
                    
                    // Send password reset email
                    await auth.sendPasswordResetEmail(formData.email);
                    
                    // Create notification
                    await db.collection('notifications').add({
                        type: 'user-created',
                        message: `New ${formData.role} created: ${userData.displayName}`,
                        recipientId: auth.currentUser.uid,
                        relatedId: userCredential.user.uid,
                        read: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Clean up secondary app
                    await secondaryApp.delete();
                    
                    alert('User created successfully! Password reset email sent.');
                    onSuccess();
                } catch (error) {
                    console.error('Error creating user:', error);
                    alert('Error creating user: ' + error.message);
                    
                    // Clean up on error
                    if (secondaryApp) {
                        try {
                            await secondaryApp.delete();
                        } catch (e) {
                            // Ignore
                        }
                    }
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">Create New User</div>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Email *</label>
                                <input
                                    type="email"
                                    className="form-input"
                                    value={formData.email}
                                    onChange={(e) => setFormData({...formData, email: e.target.value})}
                                    required
                                />
                            </div>
                            
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px'}}>
                                <div className="form-group">
                                    <label className="form-label">First Name *</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={formData.firstName}
                                        onChange={(e) => setFormData({...formData, firstName: e.target.value})}
                                        required
                                    />
                                </div>
                                
                                <div className="form-group">
                                    <label className="form-label">Last Name *</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={formData.lastName}
                                        onChange={(e) => setFormData({...formData, lastName: e.target.value})}
                                        required
                                    />
                                </div>
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Phone</label>
                                <input
                                    type="tel"
                                    className="form-input"
                                    value={formData.phone}
                                    onChange={(e) => setFormData({...formData, phone: e.target.value})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Role *</label>
                                <select 
                                    className="form-input"
                                    value={formData.role}
                                    onChange={(e) => setFormData({...formData, role: e.target.value})}
                                    required
                                >
                                    <option value="pir">PIR</option>
                                    <option value="coach">Coach</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                            
                            {formData.role === 'pir' && (
                                <div className="form-group">
                                    <label className="form-label">Assigned Coach</label>
                                    <select 
                                        className="form-input"
                                        value={formData.assignedCoach}
                                        onChange={(e) => setFormData({...formData, assignedCoach: e.target.value})}
                                    >
                                        <option value="">Select Coach</option>
                                        {coachesList.map(coach => (
                                            <option key={coach.id} value={coach.id}>
                                                {coach.displayName || coach.email}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            )}
                            
                            <div style={{display: 'flex', gap: '10px', marginTop: '20px'}}>
                                <button 
                                    type="submit"
                                    className="btn btn-primary"
                                    disabled={loading}
                                >
                                    {loading ? 'Creating...' : 'Create User'}
                                </button>
                                <button 
                                    type="button"
                                    className="btn btn-secondary"
                                    onClick={onClose}
                                >
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // Additional Modal Components
        function CheckInDetailModal({ checkIn, onClose }) {
            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">Check-in Details</div>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        
                        <div style={{marginBottom: '20px'}}>
                            <strong>User:</strong> {checkIn.userName}<br />
                            <strong>Date/Time:</strong> {formatDateTime(checkIn.createdAt)}
                        </div>
                        
                        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px', marginBottom: '20px'}}>
                            <div>
                                <strong>Mood:</strong>
                                <div className="mood-scale" style={{marginTop: '10px'}}>
                                    <div className={`mood-circle mood-${checkIn.mood}`} style={{width: '40px', height: '40px', fontSize: '18px'}}>
                                        {checkIn.mood}
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <strong>Cravings:</strong>
                                <div className="mood-scale" style={{marginTop: '10px'}}>
                                    <div className={`mood-circle mood-${11 - checkIn.cravings}`} style={{width: '40px', height: '40px', fontSize: '18px'}}>
                                        {checkIn.cravings}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {checkIn.gratitude && (
                            <div style={{marginBottom: '20px'}}>
                                <strong>Gratitude:</strong>
                                <p style={{marginTop: '10px', padding: '15px', background: 'rgba(255,255,255,0.05)', borderRadius: '10px'}}>
                                    {checkIn.gratitude}
                                </p>
                            </div>
                        )}
                        
                        {checkIn.notes && (
                            <div style={{marginBottom: '20px'}}>
                                <strong>Notes:</strong>
                                <p style={{marginTop: '10px', padding: '15px', background: 'rgba(255,255,255,0.05)', borderRadius: '10px'}}>
                                    {checkIn.notes}
                                </p>
                            </div>
                        )}
                        
                        <button className="btn btn-secondary" onClick={onClose}>Close</button>
                    </div>
                </div>
            );
        }

        function CreateAssignmentModal({ onClose, onSuccess, users, createdBy }) {
            const [formData, setFormData] = useState({
                title: '',
                description: '',
                userId: '',
                dueDate: '',
                priority: 'medium',
                status: 'pending'
            });
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                
                try {
                    await db.collection('assignments').add({
                        ...formData,
                        createdBy: createdBy,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    alert('Assignment created successfully!');
                    onSuccess();
                } catch (error) {
                    console.error('Error creating assignment:', error);
                    alert('Failed to create assignment');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">Create Assignment</div>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Title *</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    value={formData.title}
                                    onChange={(e) => setFormData({...formData, title: e.target.value})}
                                    required
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Description *</label>
                                <textarea
                                    className="form-input"
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                    required
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Assign To *</label>
                                <select 
                                    className="form-input"
                                    value={formData.userId}
                                    onChange={(e) => setFormData({...formData, userId: e.target.value})}
                                    required
                                >
                                    <option value="">Select PIR</option>
                                    {users.map(user => (
                                        <option key={user.id} value={user.id}>
                                            {user.displayName || user.email}
                                        </option>
                                    ))}
                                </select>
                            </div>
                            
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px'}}>
                                <div className="form-group">
                                    <label className="form-label">Due Date</label>
                                    <input
                                        type="date"
                                        className="form-input"
                                        value={formData.dueDate}
                                        onChange={(e) => setFormData({...formData, dueDate: e.target.value})}
                                    />
                                </div>
                                
                                <div className="form-group">
                                    <label className="form-label">Priority</label>
                                    <select 
                                        className="form-input"
                                        value={formData.priority}
                                        onChange={(e) => setFormData({...formData, priority: e.target.value})}
                                    >
                                        <option value="low">Low</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style={{display: 'flex', gap: '10px', marginTop: '20px'}}>
                                <button 
                                    type="submit"
                                    className="btn btn-primary"
                                    disabled={loading}
                                >
                                    {loading ? 'Creating...' : 'Create Assignment'}
                                </button>
                                <button 
                                    type="button"
                                    className="btn btn-secondary"
                                    onClick={onClose}
                                >
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function AssignmentDetailModal({ assignment, onClose, onUpdate }) {
            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">{assignment.title}</div>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        
                        <p>{assignment.description}</p>
                        
                        <div style={{marginTop: '20px'}}>
                            <strong>Assigned to:</strong> {assignment.userName}<br />
                            <strong>Status:</strong> {assignment.status}<br />
                            <strong>Priority:</strong> {assignment.priority}<br />
                            <strong>Due Date:</strong> {assignment.dueDate ? formatDate(assignment.dueDate) : 'No due date'}<br />
                            <strong>Created:</strong> {formatDate(assignment.createdAt)}
                        </div>
                        
                        <button className="btn btn-secondary" onClick={onClose} style={{marginTop: '20px'}}>Close</button>
                    </div>
                </div>
            );
        }

        function FeedbackDetailModal({ feedback, onClose, onRespond, onMarkReviewed }) {
            const [response, setResponse] = useState(feedback.response || '');
            const [responding, setResponding] = useState(false);

            const handleRespond = async () => {
                setResponding(true);
                await onRespond(feedback.id, response);
                setResponding(false);
                onClose();
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">Feedback Details</div>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        
                        <div style={{marginBottom: '20px'}}>
                            <strong>From:</strong> {feedback.userName}<br />
                            <strong>Type:</strong> {feedback.type}<br />
                            <strong>Subject:</strong> {feedback.subject}<br />
                            {feedback.rating && <><strong>Rating:</strong> {feedback.rating}/5<br /></>}
                            <strong>Date:</strong> {formatDateTime(feedback.createdAt)}
                        </div>
                        
                        <div style={{marginBottom: '20px', padding: '15px', background: 'rgba(255,255,255,0.05)', borderRadius: '10px'}}>
                            <strong>Message:</strong><br />
                            {feedback.message}
                        </div>
                        
                        {feedback.response && (
                            <div style={{marginBottom: '20px', padding: '15px', background: 'rgba(76,175,80,0.1)', borderRadius: '10px'}}>
                                <strong>Response:</strong><br />
                                {feedback.response}
                            </div>
                        )}
                        
                        {!feedback.response && (
                            <>
                                <div className="form-group">
                                    <label className="form-label">Your Response</label>
                                    <textarea
                                        className="form-input"
                                        value={response}
                                        onChange={(e) => setResponse(e.target.value)}
                                        rows="4"
                                    />
                                </div>
                                
                                <button 
                                    className="btn btn-primary"
                                    onClick={handleRespond}
                                    disabled={!response.trim() || responding}
                                >
                                    {responding ? 'Sending...' : 'Send Response'}
                                </button>
                            </>
                        )}
                        
                        {!feedback.reviewed && (
                            <button 
                                className="btn btn-secondary"
                                onClick={() => {
                                    onMarkReviewed(feedback.id);
                                    onClose();
                                }}
                                style={{marginLeft: '10px'}}
                            >
                                Mark as Reviewed
                            </button>
                        )}
                    </div>
                </div>
            );
        }

        function AlertDetailModal({ alert, onClose, onResolve }) {
            const [notes, setNotes] = useState('');
            const [resolving, setResolving] = useState(false);

            const handleResolve = async () => {
                setResolving(true);
                await onResolve(alert.id, notes);
                setResolving(false);
                onClose();
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">
                                {alert.type === 'sos' ? 'üö® SOS ALERT' : 'Alert Details'}
                            </div>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        
                        <div style={{marginBottom: '20px'}}>
                            <strong>User:</strong> {alert.userName}<br />
                            <strong>Type:</strong> {alert.type}<br />
                            <strong>Priority:</strong> {alert.priority || 'Normal'}<br />
                            <strong>Created:</strong> {formatDateTime(alert.createdAt)}<br />
                            <strong>Status:</strong> {alert.resolved ? 'Resolved' : 'Active'}
                        </div>
                        
                        <div style={{marginBottom: '20px', padding: '15px', background: 'rgba(255,255,255,0.05)', borderRadius: '10px'}}>
                            <strong>Message:</strong><br />
                            {alert.message}
                        </div>
                        
                        {alert.resolved && alert.resolutionNotes && (
                            <div style={{marginBottom: '20px', padding: '15px', background: 'rgba(76,175,80,0.1)', borderRadius: '10px'}}>
                                <strong>Resolution Notes:</strong><br />
                                {alert.resolutionNotes}<br />
                                <small>Resolved at: {formatDateTime(alert.resolvedAt)}</small>
                            </div>
                        )}
                        
                        {!alert.resolved && (
                            <>
                                <div className="form-group">
                                    <label className="form-label">Resolution Notes (optional)</label>
                                    <textarea
                                        className="form-input"
                                        value={notes}
                                        onChange={(e) => setNotes(e.target.value)}
                                        rows="3"
                                    />
                                </div>
                                
                                <button 
                                    className="btn btn-success"
                                    onClick={handleResolve}
                                    disabled={resolving}
                                >
                                    {resolving ? 'Resolving...' : 'Mark as Resolved'}
                                </button>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        // Other existing modals remain the same...

        // Pagination Component
        function Pagination({ currentPage, totalPages, onPageChange }) {
            return (
                <div className="pagination">
                    <button 
                        className="page-btn"
                        onClick={() => onPageChange(currentPage - 1)}
                        disabled={currentPage === 1}
                    >
                        Previous
                    </button>
                    
                    {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                        let pageNum;
                        if (totalPages <= 5) {
                            pageNum = i + 1;
                        } else if (currentPage <= 3) {
                            pageNum = i + 1;
                        } else if (currentPage >= totalPages - 2) {
                            pageNum = totalPages - 4 + i;
                        } else {
                            pageNum = currentPage - 2 + i;
                        }
                        
                        return (
                            <button
                                key={pageNum}
                                className={`page-btn ${currentPage === pageNum ? 'active' : ''}`}
                                onClick={() => onPageChange(pageNum)}
                            >
                                {pageNum}
                            </button>
                        );
                    })}
                    
                    <button 
                        className="page-btn"
                        onClick={() => onPageChange(currentPage + 1)}
                        disabled={currentPage === totalPages}
                    >
                        Next
                    </button>
                </div>
            );
        }

        // Additional Modal Components (continued)
        function UserDetailModal({ user, onClose, onUpdate, currentUserId }) {
            const [editing, setEditing] = useState(false);
            const [formData, setFormData] = useState({...user});

            const handleSave = async () => {
                try {
                    await db.collection('users').doc(user.id).update({
                        displayName: `${formData.firstName} ${formData.lastName}`,
                        firstName: formData.firstName,
                        lastName: formData.lastName,
                        phone: formData.phone,
                        active: formData.active,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert('User updated successfully');
                    onUpdate();
                } catch (error) {
                    console.error('Error updating user:', error);
                    alert('Failed to update user');
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">{user.displayName || user.email}</div>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        
                        {!editing ? (
                            <div>
                                <table style={{width: '100%'}}>
                                    <tbody>
                                        <tr>
                                            <td><strong>Email:</strong></td>
                                            <td>{user.email}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>First Name:</strong></td>
                                            <td>{user.firstName || '-'}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Last Name:</strong></td>
                                            <td>{user.lastName || '-'}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Phone:</strong></td>
                                            <td>{user.phone || '-'}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Role:</strong></td>
                                            <td><span className="badge badge-info">{user.role}</span></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Status:</strong></td>
                                            <td>
                                                <span className={`badge ${user.active !== false ? 'badge-success' : 'badge-danger'}`}>
                                                    {user.active !== false ? 'Active' : 'Inactive'}
                                                </span>
                                            </td>
                                        </tr>
                                        {user.assignedCoach && (
                                            <tr>
                                                <td><strong>Assigned Coach:</strong></td>
                                                <td>{user.coachName || user.assignedCoach}</td>
                                            </tr>
                                        )}
                                        <tr>
                                            <td><strong>Joined:</strong></td>
                                            <td>{formatDate(user.createdAt)}</td>
                                        </tr>
                                    </tbody>
                                </table>
                                
                                <div style={{marginTop: '20px', display: 'flex', gap: '10px'}}>
                                    <button className="btn btn-primary" onClick={() => setEditing(true)}>
                                        Edit User
                                    </button>
                                    <button className="btn btn-secondary" onClick={onClose}>
                                        Close
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <div>
                                <div className="form-group">
                                    <label className="form-label">First Name</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={formData.firstName || ''}
                                        onChange={(e) => setFormData({...formData, firstName: e.target.value})}
                                    />
                                </div>
                                
                                <div className="form-group">
                                    <label className="form-label">Last Name</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={formData.lastName || ''}
                                        onChange={(e) => setFormData({...formData, lastName: e.target.value})}
                                    />
                                </div>
                                
                                <div className="form-group">
                                    <label className="form-label">Phone</label>
                                    <input
                                        type="tel"
                                        className="form-input"
                                        value={formData.phone || ''}
                                        onChange={(e) => setFormData({...formData, phone: e.target.value})}
                                    />
                                </div>
                                
                                <div className="checkbox-group">
                                    <input
                                        type="checkbox"
                                        id="activeStatus"
                                        checked={formData.active !== false}
                                        onChange={(e) => setFormData({...formData, active: e.target.checked})}
                                    />
                                    <label htmlFor="activeStatus">Active</label>
                                </div>
                                
                                <div style={{marginTop: '20px', display: 'flex', gap: '10px'}}>
                                    <button className="btn btn-primary" onClick={handleSave}>
                                        Save Changes
                                    </button>
                                    <button className="btn btn-secondary" onClick={() => setEditing(false)}>
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function CreateGroupModal({ onClose, onSuccess, adminId }) {
            const [formData, setFormData] = useState({
                name: '',
                description: '',
                dayOfWeek: 'Monday',
                time: '18:00',
                recurring: true,
                link: '',
                members: []
            });
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                
                try {
                    await db.collection('groups').add({
                        ...formData,
                        coachId: adminId,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        nextMeeting: calculateNextMeeting(formData.dayOfWeek, formData.time),
                        attendance: {}
                    });
                    
                    alert('Group created successfully!');
                    onSuccess();
                } catch (error) {
                    console.error('Error creating group:', error);
                    alert('Failed to create group');
                } finally {
                    setLoading(false);
                }
            };

            const calculateNextMeeting = (dayOfWeek, time) => {
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const targetDay = days.indexOf(dayOfWeek);
                const now = new Date();
                const currentDay = now.getDay();
                
                let daysUntilTarget = targetDay - currentDay;
                if (daysUntilTarget <= 0) {
                    daysUntilTarget += 7;
                }
                
                const nextMeeting = new Date();
                nextMeeting.setDate(nextMeeting.getDate() + daysUntilTarget);
                const [hours, minutes] = time.split(':');
                nextMeeting.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                
                return nextMeeting;
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">Create New Group</div>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Group Name *</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    value={formData.name}
                                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                                    required
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Description *</label>
                                <textarea
                                    className="form-input"
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                    required
                                />
                            </div>
                            
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px'}}>
                                <div className="form-group">
                                    <label className="form-label">Day of Week *</label>
                                    <select 
                                        className="form-input"
                                        value={formData.dayOfWeek}
                                        onChange={(e) => setFormData({...formData, dayOfWeek: e.target.value})}
                                        required
                                    >
                                        <option value="Monday">Monday</option>
                                        <option value="Tuesday">Tuesday</option>
                                        <option value="Wednesday">Wednesday</option>
                                        <option value="Thursday">Thursday</option>
                                        <option value="Friday">Friday</option>
                                        <option value="Saturday">Saturday</option>
                                        <option value="Sunday">Sunday</option>
                                    </select>
                                </div>
                                
                                <div className="form-group">
                                    <label className="form-label">Time *</label>
                                    <input
                                        type="time"
                                        className="form-input"
                                        value={formData.time}
                                        onChange={(e) => setFormData({...formData, time: e.target.value})}
                                        required
                                    />
                                </div>
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Meeting Link (optional)</label>
                                <input
                                    type="url"
                                    className="form-input"
                                    placeholder="https://zoom.us/..."
                                    value={formData.link}
                                    onChange={(e) => setFormData({...formData, link: e.target.value})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <div className="checkbox-group">
                                    <input
                                        type="checkbox"
                                        id="recurring"
                                        checked={formData.recurring}
                                        onChange={(e) => setFormData({...formData, recurring: e.target.checked})}
                                    />
                                    <label htmlFor="recurring">Recurring Weekly</label>
                                </div>
                            </div>
                            
                            <div style={{display: 'flex', gap: '10px', marginTop: '20px'}}>
                                <button 
                                    type="submit"
                                    className="btn btn-primary"
                                    disabled={loading}
                                >
                                    {loading ? 'Creating...' : 'Create Group'}
                                </button>
                                <button 
                                    type="button"
                                    className="btn btn-secondary"
                                    onClick={onClose}
                                >
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function GroupDetailModal({ group, onClose, onUpdate }) {
            const [addingMember, setAddingMember] = useState(false);
            const [newMemberEmail, setNewMemberEmail] = useState('');

            const addMember = async () => {
                if (!newMemberEmail) return;
                
                setAddingMember(true);
                try {
                    const userSnap = await db.collection('users')
                        .where('email', '==', newMemberEmail)
                        .get();
                    
                    if (userSnap.empty) {
                        alert('User not found');
                        return;
                    }
                    
                    const userId = userSnap.docs[0].id;
                    const members = group.members || [];
                    
                    if (members.includes(userId)) {
                        alert('User is already a member');
                        return;
                    }
                    
                    members.push(userId);
                    
                    await db.collection('groups').doc(group.id).update({
                        members: members
                    });
                    
                    alert('Member added successfully');
                    setNewMemberEmail('');
                    onUpdate();
                } catch (error) {
                    console.error('Error adding member:', error);
                    alert('Failed to add member');
                } finally {
                    setAddingMember(false);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">{group.name}</div>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        
                        <p style={{marginBottom: '20px'}}>{group.description}</p>
                        
                        <div style={{marginBottom: '20px'}}>
                            <strong>Schedule:</strong> {group.dayOfWeek} at {group.time}
                            {group.recurring && ' (Recurring)'}
                        </div>
                        
                        {group.link && (
                            <div style={{marginBottom: '20px'}}>
                                <strong>Meeting Link:</strong>{' '}
                                <a href={group.link} target="_blank" rel="noopener noreferrer" style={{color: '#f4c430'}}>
                                    {group.link}
                                </a>
                            </div>
                        )}
                        
                        <div style={{marginBottom: '20px'}}>
                            <h4 style={{marginBottom: '15px'}}>Members ({group.membersData?.length || 0})</h4>
                            
                            {group.membersData?.map(member => (
                                <div key={member.id} style={{
                                    padding: '10px',
                                    background: 'rgba(255,255,255,0.05)',
                                    borderRadius: '10px',
                                    marginBottom: '10px'
                                }}>
                                    {member.name}
                                </div>
                            ))}
                            
                            <div style={{display: 'flex', gap: '10px', marginTop: '15px'}}>
                                <input
                                    type="email"
                                    className="form-input"
                                    placeholder="Enter member email..."
                                    value={newMemberEmail}
                                    onChange={(e) => setNewMemberEmail(e.target.value)}
                                />
                                <button 
                                    className="btn btn-primary"
                                    onClick={addMember}
                                    disabled={addingMember}
                                >
                                    {addingMember ? 'Adding...' : 'Add Member'}
                                </button>
                            </div>
                        </div>
                        
                        <button className="btn btn-secondary" onClick={onClose}>Close</button>
                    </div>
                </div>
            );
        }

        function CreateResourceModal({ onClose, onSuccess }) {
            const [formData, setFormData] = useState({
                title: '',
                description: '',
                type: 'Link',
                url: '',
                content: '',
                category: 'General',
                isGlobal: true,
                assignedTo: []
            });
            const [file, setFile] = useState(null);
            const [uploadProgress, setUploadProgress] = useState(0);
            const [loading, setLoading] = useState(false);

            const handleFileChange = (e) => {
                const selectedFile = e.target.files[0];
                if (selectedFile) {
                    // Check file size (10MB limit)
                    if (selectedFile.size > 10 * 1024 * 1024) {
                        alert('File size must be less than 10MB');
                        return;
                    }
                    
                    // Check file type
                    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'image/webp'];
                    if (!allowedTypes.includes(selectedFile.type)) {
                        alert('Only PDF and image files are allowed');
                        return;
                    }
                    
                    setFile(selectedFile);
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                
                try {
                    const resourceData = {
                        ...formData,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: auth.currentUser.uid
                    };
                    
                    // If file upload is needed
                    if (file && formData.type !== 'Link') {
                        const resourceRef = db.collection('resources').doc();
                        const storageRef = storage.ref(`resources/${resourceRef.id}/${file.name}`);
                        
                        // Upload file with progress tracking
                        const uploadTask = storageRef.put(file);
                        
                        uploadTask.on('state_changed',
                            (snapshot) => {
                                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                setUploadProgress(progress);
                            },
                            (error) => {
                                console.error('Upload error:', error);
                                alert('Failed to upload file');
                                setLoading(false);
                            },
                            async () => {
                                // Get download URL
                                const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                                resourceData.fileURL = downloadURL;
                                resourceData.fileName = file.name;
                                
                                // Save to Firestore
                                await resourceRef.set(resourceData);
                                alert('Resource created successfully!');
                                onSuccess();
                            }
                        );
                    } else {
                        // No file upload, just save data
                        await db.collection('resources').add(resourceData);
                        alert('Resource created successfully!');
                        onSuccess();
                    }
                } catch (error) {
                    console.error('Error creating resource:', error);
                    alert('Failed to create resource');
                    setLoading(false);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">Add New Resource</div>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Title *</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    value={formData.title}
                                    onChange={(e) => setFormData({...formData, title: e.target.value})}
                                    required
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Description *</label>
                                <textarea
                                    className="form-input"
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                    required
                                />
                            </div>
                            
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px'}}>
                                <div className="form-group">
                                    <label className="form-label">Type *</label>
                                    <select 
                                        className="form-input"
                                        value={formData.type}
                                        onChange={(e) => setFormData({...formData, type: e.target.value})}
                                        required
                                    >
                                        <option value="Link">Link</option>
                                        <option value="PDF">PDF</option>
                                        <option value="Video">Video</option>
                                        <option value="Article">Article</option>
                                        <option value="Audio">Audio</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                
                                <div className="form-group">
                                    <label className="form-label">Category</label>
                                    <select 
                                        className="form-input"
                                        value={formData.category}
                                        onChange={(e) => setFormData({...formData, category: e.target.value})}
                                    >
                                        <option value="General">General</option>
                                        <option value="Educational">Educational</option>
                                        <option value="Motivational">Motivational</option>
                                        <option value="Tools">Tools</option>
                                        <option value="Exercises">Exercises</option>
                                    </select>
                                </div>
                            </div>
                            
                            {formData.type === 'Link' ? (
                                <div className="form-group">
                                    <label className="form-label">URL *</label>
                                    <input
                                        type="url"
                                        className="form-input"
                                        value={formData.url}
                                        onChange={(e) => setFormData({...formData, url: e.target.value})}
                                        required
                                    />
                                </div>
                            ) : (
                                <div className="form-group">
                                    <label className="form-label">Upload File (Max 10MB)</label>
                                    <input
                                        type="file"
                                        className="form-input"
                                        onChange={handleFileChange}
                                        accept=".pdf,image/*"
                                    />
                                    {uploadProgress > 0 && uploadProgress < 100 && (
                                        <div style={{marginTop: '10px'}}>
                                            <div className="progress-bar">
                                                <div className="progress-fill" style={{width: `${uploadProgress}%`}}></div>
                                            </div>
                                            <div style={{fontSize: '12px', marginTop: '5px'}}>
                                                Uploading: {Math.round(uploadProgress)}%
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            {formData.type !== 'Link' && (
                                <div className="form-group">
                                    <label className="form-label">Additional Content/Notes</label>
                                    <textarea
                                        className="form-input"
                                        value={formData.content}
                                        onChange={(e) => setFormData({...formData, content: e.target.value})}
                                        placeholder="Add any additional notes or instructions..."
                                        rows="3"
                                    />
                                </div>
                            )}
                            
                            <div className="form-group">
                                <div className="checkbox-group">
                                    <input
                                        type="checkbox"
                                        id="isGlobal"
                                        checked={formData.isGlobal}
                                        onChange={(e) => setFormData({...formData, isGlobal: e.target.checked})}
                                    />
                                    <label htmlFor="isGlobal">Available to all PIRs</label>
                                </div>
                            </div>
                            
                            <div style={{display: 'flex', gap: '10px', marginTop: '20px'}}>
                                <button 
                                    type="submit"
                                    className="btn btn-primary"
                                    disabled={loading}
                                >
                                    {loading ? 'Creating...' : 'Create Resource'}
                                </button>
                                <button 
                                    type="button"
                                    className="btn btn-secondary"
                                    onClick={onClose}
                                    disabled={loading}
                                >
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function ResourceDetailModal({ resource, onClose }) {
            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">
                            <div className="modal-title">{resource.title}</div>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        
                        <div style={{marginBottom: '20px'}}>
                            <span className="badge badge-info">{resource.type}</span>
                            <span className="badge badge-info" style={{marginLeft: '10px'}}>{resource.category}</span>
                        </div>
                        
                        <p style={{marginBottom: '20px'}}>{resource.description}</p>
                        
                        {(resource.url || resource.fileURL) && (
                            <div style={{marginBottom: '20px'}}>
                                <a 
                                    href={resource.url || resource.fileURL}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="btn btn-primary"
                                >
                                    Open Resource
                                </a>
                            </div>
                        )}
                        
                        {resource.content && (
                            <div style={{
                                padding: '20px',
                                background: 'rgba(255,255,255,0.05)',
                                borderRadius: '10px',
                                whiteSpace: 'pre-wrap'
                            }}>
                                {resource.content}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Initialize App
        ReactDOM.render(<AdminApp />, document.getElementById('root'));
    </script>
</body>
</html>
