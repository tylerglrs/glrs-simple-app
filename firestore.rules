rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin'];
    }

    function isCoach() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['coach', 'admin', 'superadmin'];
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ============================================
    // USER MANAGEMENT
    // ============================================

    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isCoach() ||
        (isOwner(userId) &&
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'active', 'tenantId']));
      allow delete: if isAdmin();

      // User subcollections
      match /preferences/{document} {
        allow read, write: if isOwner(userId) || isCoach();
      }

      match /resourceViews/{document} {
        allow read, write: if isOwner(userId) || isCoach();
      }

      match /resourcePreferences/{document} {
        allow read, write: if isOwner(userId) || isCoach();
      }

      // NEW: Insights (created by Cloud Functions)
      match /insights/{document} {
        allow read: if isOwner(userId) || isCoach();
        allow write: if true; // Cloud Functions write here
      }

      // NEW: Savings Preferences (Finances tab user data)
      match /savingsPreferences/{document} {
        allow read, write: if isOwner(userId) || isCoach();
      }
    }

    // ============================================
    // CHECK-INS & REFLECTIONS
    // ============================================

    match /checkIns/{checkInId} {
      allow read: if isCoach() ||
        (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isCoach() ||
        (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow delete: if isCoach();
    }

    match /pledges/{pledgeId} {
      allow read: if isCoach() ||
        (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isCoach() ||
        (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow delete: if isCoach();
    }

    match /streaks/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId) || isCoach();
    }

    // ============================================
    // GOALS, OBJECTIVES & ASSIGNMENTS
    // ============================================

    match /goals/{goalId} {
      allow read: if isCoach() ||
        (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow create: if isCoach();
      allow update: if isCoach() ||
        (isAuthenticated() &&
         resource.data.userId == request.auth.uid &&
         request.resource.data.diff(resource.data).affectedKeys()
           .hasOnly(['progress', 'status', 'completedAt', 'updatedAt']));
      allow delete: if isCoach();
    }

    match /objectives/{objectiveId} {
      allow read: if isCoach() ||
        (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow create: if isCoach();
      allow update: if isCoach() ||
        (isAuthenticated() &&
         resource.data.userId == request.auth.uid &&
         request.resource.data.diff(resource.data).affectedKeys()
           .hasOnly(['status', 'completedAt', 'updatedAt']));
      allow delete: if isCoach();
    }

    match /assignments/{assignmentId} {
      allow read: if isCoach() ||
        (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow create: if isCoach();
      allow update: if isCoach() ||
        (isAuthenticated() &&
         resource.data.userId == request.auth.uid &&
         request.resource.data.diff(resource.data).affectedKeys()
           .hasOnly(['status', 'reflection', 'completedAt', 'updatedAt']));
      allow delete: if isCoach();
    }

    match /milestones/{milestoneId} {
      allow read: if isCoach() ||
        (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow create: if isCoach();
      allow update: if isCoach() ||
        (isAuthenticated() &&
         resource.data.userId == request.auth.uid &&
         request.resource.data.diff(resource.data).affectedKeys()
           .hasOnly(['achieved', 'achievedDate', 'updatedAt']));
      allow delete: if isCoach();
    }

    // ============================================
    // RESOURCES
    // ============================================

    match /resources/{resourceId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isCoach();
    }

    match /resourceFeedback/{feedbackId} {
      allow read: if isCoach() ||
        (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow create: if isAuthenticated();
      allow update: if isCoach();
      allow delete: if isAdmin();
    }

    match /resourceViews/{viewId} {
      allow read: if isCoach() ||
        (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }

    // ============================================
    // MESSAGING & COMMUNITY
    // ============================================

    match /messages/{messageId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isCoach() ||
        (isAuthenticated() && resource.data.senderId == request.auth.uid);
      allow delete: if isCoach();
    }

    match /glrsChat/{messageId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isCoach() ||
        (isAuthenticated() && resource.data.senderId == request.auth.uid);
      allow delete: if isCoach();
    }

    match /topicRoomMessages/{messageId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isCoach() ||
        (isAuthenticated() && resource.data.senderId == request.auth.uid);
      allow delete: if isCoach();
    }

    match /topicRooms/{roomId} {
      allow read: if isAuthenticated();
      allow create, update: if isCoach();
      allow delete: if isAdmin();
    }

    match /messageReactions/{reactionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // COACH NOTES (COACH-ONLY)
    // ============================================

    match /coachNotes/{noteId} {
      allow read, write: if isCoach();
    }

    match /pirNotes/{noteId} {
      allow read, write: if isCoach();
    }

    match /checkInReviews/{reviewId} {
      allow read, write: if isCoach();
    }

    match /sessionFlags/{flagId} {
      allow read, write: if isCoach();
    }

    // ============================================
    // NOTIFICATIONS & ALERTS
    // ============================================

    match /notifications/{notificationId} {
      allow read: if isCoach() ||
        (isAuthenticated() && resource.data.recipientId == request.auth.uid);
      allow create: if isAuthenticated();
      allow update: if isCoach() ||
        (isAuthenticated() && resource.data.recipientId == request.auth.uid);
      allow delete: if isAdmin() ||
        (isAuthenticated() && resource.data.recipientId == request.auth.uid);
    }

    match /alerts/{alertId} {
      allow read: if isCoach() ||
        (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow create: if isAuthenticated();
      allow update: if isCoach() ||
        (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow delete: if isCoach();
    }

    match /activities/{activityId} {
      allow read: if isCoach() ||
        (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow create: if isAuthenticated();
      allow update: if isCoach();
      allow delete: if isAdmin();
    }

    // ============================================
    // SUPPORT GROUPS & MEETINGS
    // ============================================

    match /supportGroups/{groupId} {
      allow read: if isAuthenticated();
      allow write: if isCoach();

      match /members/{memberId} {
        allow read: if isAuthenticated();
        allow write: if isCoach() || isOwner(memberId);
      }
    }

    match /groups/{groupId} {
      allow read: if isAuthenticated();
      allow write: if isCoach();

      match /members/{memberId} {
        allow read: if isAuthenticated();
        allow write: if isCoach() || isOwner(memberId);
      }
    }

    match /meetings/{meetingId} {
      allow read: if isAuthenticated();
      allow write: if isCoach();
    }

    match /meetingAttendance/{attendanceId} {
      allow read: if isAuthenticated();
      allow create, update: if isCoach();
      allow delete: if isAdmin();
    }

    // ============================================
    // FEEDBACK & MODERATION
    // ============================================

    match /feedback/{feedbackId} {
      allow read: if isCoach() ||
        (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow create: if isAuthenticated();
      allow update: if isAdmin() ||
        (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow delete: if isAdmin();
    }

    match /flaggedContent/{flagId} {
      allow read: if isCoach();
      allow create: if isAuthenticated();
      allow update, delete: if isCoach();
    }

    match /moderationActions/{actionId} {
      allow read, write: if isCoach();
    }

    match /userWarnings/{warningId} {
      allow read, write: if isCoach();
    }

    // ============================================
    // SYSTEM & ADMIN - READABLE BY ALL
    // ============================================

    match /dailyInspirations/{inspirationId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /goalTemplates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if isCoach();
    }

    match /broadcasts/{broadcastId} {
      allow read: if isAuthenticated();
      allow write: if isCoach();
    }

    match /settings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /auditLogs/{logId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
    }

    match /presence/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }

    // ============================================
    // FINANCES SYSTEM (Journey Tab - Finances)
    // ============================================

    match /savingsItems/{itemId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /savingsGoals/{goalId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /moneyMapStops/{stopId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ============================================
    // EMAIL SYSTEM
    // ============================================

    match /mail/{mailId} {
      allow create, read: if isAuthenticated();
      allow update: if false;
      allow delete: if isAdmin();
    }

    match /emailLog/{logId} {
      allow read: if isCoach();
      allow create: if isCoach();
      allow update, delete: if isAdmin();
    }

    match /emailQueue/{queueId} {
      allow read, create, update, delete: if isCoach();
    }

    match /emailTemplates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /emailPreferences/{userId} {
      allow read, write: if isOwner(userId) || isCoach();
    }

    // ============================================
    // REPORTING & AUTOMATION
    // ============================================

    match /reportLinks/{linkId} {
      allow read, create, update: if isCoach();
      allow delete: if isAdmin();
    }

    match /automationConfig/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create, update: if isCoach() && request.auth.uid == userId;
      allow delete: if isAdmin();
    }

    // ============================================
    // COACH MANAGEMENT
    // ============================================

    match /certifications/{certId} {
      allow read: if isAuthenticated();
      allow create, update: if isCoach();
      allow delete: if isAdmin();
    }

    match /specializations/{specId} {
      allow read: if isAuthenticated();
      allow create, update: if isCoach();
      allow delete: if isAdmin();
    }

    match /trainings/{trainingId} {
      allow read: if isAuthenticated();
      allow create, update: if isCoach();
      allow delete: if isAdmin();
    }

    match /sessions/{sessionId} {
      allow read: if isAuthenticated();
      allow create, update: if isCoach();
      allow delete: if isAdmin();
    }

    // ============================================
    // CLOUD FUNCTIONS COLLECTIONS (NEW)
    // ============================================

    // Gratitude insights (created by analyzeGratitude function)
    match /gratitudeInsights/{insightId} {
      allow read: if isAuthenticated();
      allow write: if true; // Cloud Functions write here
    }

    // Challenge insights (created by analyzeChallenge function)
    match /challengeInsights/{insightId} {
      allow read: if isAuthenticated();
      allow write: if true; // Cloud Functions write here
    }

    // Breakthrough detection (created by detectBreakthroughs function)
    match /breakthroughs/{breakthroughId} {
      allow read: if isAuthenticated();
      allow write: if true; // Cloud Functions write here
    }

    // Daily computed insights (created by dailyInsightsComputation function)
    match /dailyInsights/{insightId} {
      allow read: if isAuthenticated();
      allow write: if true; // Cloud Functions write here
    }

    // Goal achievement tracking
    match /goalAchievements/{achievementId} {
      allow read: if isAuthenticated();
      allow write: if true; // Cloud Functions write here
    }

    // ============================================
    // TENANT SYSTEM (For future white-label)
    // ============================================

    match /tenants/{tenantId} {
      allow read: if isAdmin();
      allow write: if isAdmin();

      match /{collection}/{document} {
        allow read, write: if isAdmin();
      }
    }
  }
}
