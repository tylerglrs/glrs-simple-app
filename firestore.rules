rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Helper function to check if user is the assigned coach for a PIR
    function isAssignedCoach(pirUserId) {
      return request.auth.uid == get(/databases/$(database)/documents/users/$(pirUserId)).data.assignedCoach;
    }

    // Helper function to check if user has staff role (coach, admin, or superadmin)
    function isStaffRole() {
      let userData = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      return userData.role in ['coach', 'admin', 'superadmin', 'superadmin1'];
    }

    // Helper function to check if user has admin role (admin or superadmin)
    function isAdminRole() {
      let userData = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      return userData.role in ['admin', 'superadmin', 'superadmin1'];
    }

    // Helper function to check if user has superadmin role
    function isSuperAdminRole() {
      let userData = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      return userData.role in ['superadmin', 'superadmin1'];
    }

    // Users collection
    match /users/{userId} {
      allow read: if isSignedIn();
      allow write: if isOwner(userId) || request.auth.uid == resource.data.assignedCoach;

      // User preferences subcollection (for ResourcesTab settings, view tracking, etc.)
      match /preferences/{prefId} {
        allow read, write: if isSignedIn() && isOwner(userId);
      }

      // Resource views tracking subcollection (for ResourcesTab view history)
      match /resourceViews/{resourceId} {
        allow read, write: if isSignedIn() && isOwner(userId);
      }

      // Anchor audit logs subcollection (Phase 6/Task 6.4: Compliance logging)
      // Users can only create their own logs, staff can read for compliance review
      match /anchorAuditLogs/{logId} {
        allow create: if isSignedIn() && isOwner(userId);
        allow read: if isSignedIn() && (isOwner(userId) || isStaffRole());
        allow update: if isSignedIn() && isOwner(userId);
        // Delete is not allowed (7 year retention for compliance)
        allow delete: if false;
      }

      // ========================================================================
      // PHASE 2: AI INSIGHTS SUBCOLLECTIONS
      // ========================================================================

      // AI Insights - stored by Cloud Functions, read by user
      match /aiInsights/{insightId} {
        allow read: if isSignedIn() && isOwner(userId);
        allow write: if false; // Only Cloud Functions write
      }

      // Weekly Summaries - generated Sunday nights
      match /weeklySummaries/{weekId} {
        allow read: if isSignedIn() && isOwner(userId);
        allow write: if false; // Only Cloud Functions write
      }

      // Monthly Summaries - generated end of month
      match /monthlySummaries/{monthId} {
        allow read: if isSignedIn() && isOwner(userId);
        allow write: if false; // Only Cloud Functions write
      }

      // Weekly Insights - AI pattern analysis (Phase 6)
      match /weeklyInsights/{insightId} {
        allow read: if isSignedIn() && isOwner(userId);
        allow write: if false; // Only Cloud Functions write
      }

      // User Memory - AI's accumulated knowledge
      match /memory/{docId} {
        allow read: if isSignedIn() && isOwner(userId);
        allow write: if false; // Only Cloud Functions write
      }

      // AI Responses - Phase 4: Log all AI responses with 30-day retention
      match /aiResponses/{responseId} {
        allow read: if isSignedIn() && isOwner(userId);
        allow create: if isSignedIn() && isOwner(userId);
        allow update: if false; // Responses are immutable once created
        allow delete: if isSignedIn() && isOwner(userId); // Allow user to delete old responses
      }

      // AI Context - Aggregated user context for AI features
      // Users can read/write their own, staff can read for support
      match /aiContext/{contextId} {
        allow read: if isSignedIn() && (isOwner(userId) || isStaffRole());
        allow write: if isSignedIn() && (isOwner(userId) || isStaffRole());
      }
    }
    
    // Check-ins collection (legacy lowercase - deprecated)
    match /checkins/{checkinId} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.userId ||
        request.auth.uid == get(/databases/$(database)/documents/users/$(resource.data.userId)).data.assignedCoach ||
        isStaffRole()
      );
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.userId;
    }

    // Check-ins collection (camelCase - active)
    match /checkIns/{checkinId} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.userId ||
        request.auth.uid == get(/databases/$(database)/documents/users/$(resource.data.userId)).data.assignedCoach ||
        isStaffRole()
      );
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.userId;
    }

    // Goals collection
    match /goals/{goalId} {
      allow read: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        request.auth.uid == get(/databases/$(database)/documents/users/$(resource.data.userId)).data.assignedCoach ||
        isStaffRole()
      );
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        request.auth.uid == get(/databases/$(database)/documents/users/$(resource.data.userId)).data.assignedCoach ||
        isStaffRole()
      );
    }
    
    // Assignments collection
    // Note: Supports both userId and pirId fields for backwards compatibility
    match /assignments/{assignmentId} {
      allow read: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        isOwner(resource.data.pirId) ||
        request.auth.uid == resource.data.createdBy ||
        isStaffRole()
      );
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        isOwner(resource.data.pirId) ||
        request.auth.uid == resource.data.createdBy ||
        isStaffRole()
      );
      allow delete: if isSignedIn() && (request.auth.uid == resource.data.createdBy || isStaffRole());
    }
    
    // Conversations collection (DM conversations)
    match /conversations/{conversationId} {
      allow read: if isSignedIn() && request.auth.uid in resource.data.participants;
      allow create: if isSignedIn() && request.auth.uid in request.resource.data.participants;
      allow update: if isSignedIn() && request.auth.uid in resource.data.participants;
      allow delete: if false; // Don't allow deletion
    }

    // Messages collection (both DM and community messages)
    match /messages/{messageId} {
      // Allow read if user is sender, recipient, community message, or staff
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.senderId ||
        request.auth.uid == resource.data.recipientId ||
        request.auth.uid == resource.data.receiverId ||
        resource.data.type == 'community' ||
        isStaffRole()
      );
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.senderId;
      allow update: if isSignedIn() && (
        request.auth.uid == resource.data.senderId ||
        request.auth.uid == resource.data.recipientId
      );
      allow delete: if isSignedIn() && request.auth.uid == resource.data.senderId;

      // Comments subcollection
      match /comments/{commentId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn() &&
          request.resource.data.userId == request.auth.uid &&
          request.resource.data.content.size() > 0 &&
          request.resource.data.content.size() <= 280;
        allow update, delete: if isSignedIn() &&
          resource.data.userId == request.auth.uid;
      }
    }
    
    // Community messages collection
    match /communityMessages/{messageId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.userId;
    }
    
    // Gratitude entries collection
    match /gratitudes/{gratitudeId} {
      allow read: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        isAssignedCoach(resource.data.userId) ||
        isStaffRole()
      );
      allow create: if isSignedIn() && isOwner(request.resource.data.userId);
      allow update, delete: if isSignedIn() && isOwner(resource.data.userId);
    }

    // Reflections collection
    match /reflections/{reflectionId} {
      allow read: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        isAssignedCoach(resource.data.userId) ||
        isStaffRole()
      );
      allow create: if isSignedIn() && isOwner(request.resource.data.userId);
      allow update, delete: if isSignedIn() && isOwner(resource.data.userId);
    }

    // Habits collection
    match /habits/{habitId} {
      allow read: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        isAssignedCoach(resource.data.userId) ||
        isStaffRole()
      );
      allow create: if isSignedIn() && isOwner(request.resource.data.userId);
      allow update, delete: if isSignedIn() && isOwner(resource.data.userId);
    }

    // Habit completions collection
    match /habitCompletions/{completionId} {
      allow read: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        isAssignedCoach(resource.data.userId) ||
        isStaffRole()
      );
      allow create: if isSignedIn() && isOwner(request.resource.data.userId);
      allow update, delete: if isSignedIn() && isOwner(resource.data.userId);
    }
    
    // Quick reflections collection
    match /quickReflections/{reflectionId} {
      allow read: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        isAssignedCoach(resource.data.userId) ||
        isStaffRole()
      );
      allow create: if isSignedIn() && isOwner(request.resource.data.userId);
      allow update, delete: if isSignedIn() && isOwner(resource.data.userId);
    }

    // Today wins collection
    match /todayWins/{winId} {
      allow read: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        isAssignedCoach(resource.data.userId) ||
        isStaffRole()
      );
      allow create: if isSignedIn() && isOwner(request.resource.data.userId);
      allow update, delete: if isSignedIn() && isOwner(resource.data.userId);
    }

    // Wins collection (alias for todayWins - used by test data generator)
    match /wins/{winId} {
      allow read: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        isAssignedCoach(resource.data.userId) ||
        isStaffRole()
      );
      allow create: if isSignedIn() && isOwner(request.resource.data.userId);
      allow update, delete: if isSignedIn() && isOwner(resource.data.userId);
    }

    // Breakthroughs collection
    match /breakthroughs/{breakthroughId} {
      allow read: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        isAssignedCoach(resource.data.userId) ||
        isStaffRole()
      );
      allow create: if isSignedIn() && isOwner(request.resource.data.userId);
      allow update, delete: if isSignedIn() && isOwner(resource.data.userId);
    }
    
    // Savings items collection
    match /savingsItems/{itemId} {
      allow read: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        isAssignedCoach(resource.data.userId) ||
        isStaffRole()
      );
      allow create: if isSignedIn() && isOwner(request.resource.data.userId);
      allow update, delete: if isSignedIn() && isOwner(resource.data.userId);
    }

    // Savings goals collection
    match /savingsGoals/{goalId} {
      allow read: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        isAssignedCoach(resource.data.userId) ||
        isStaffRole()
      );
      allow create: if isSignedIn() && isOwner(request.resource.data.userId);
      allow update, delete: if isSignedIn() && isOwner(resource.data.userId);
    }

    // Money map stops collection
    match /moneyMapStops/{stopId} {
      allow read: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        isAssignedCoach(resource.data.userId) ||
        isStaffRole()
      );
      allow create: if isSignedIn() && isOwner(request.resource.data.userId);
      allow update, delete: if isSignedIn() && isOwner(resource.data.userId);
    }
    
    // Resources collection (read by all users, written by staff only)
    match /resources/{resourceId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && isStaffRole();
    }
    
    // Topic rooms collection (read by all, written by staff only)
    match /topicRooms/{roomId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && isStaffRole();
    }
    
    // Support groups collection (read by all, written by staff only)
    match /supportGroups/{groupId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && isStaffRole();
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      allow read: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        isAssignedCoach(resource.data.userId) ||
        isStaffRole()
      );
      allow create: if isSignedIn();
      allow update: if isSignedIn() && isOwner(resource.data.userId) &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt']);
      allow delete: if isSignedIn() && isOwner(resource.data.userId);
    }
    
    // Broadcasts collection (read by all, written by admins only)
    match /broadcasts/{broadcastId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && isAdminRole();
    }

    // Activities collection
    match /activities/{activityId} {
      allow read: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        isAssignedCoach(resource.data.userId) ||
        isStaffRole()
      );
      allow write: if isSignedIn() && isOwner(request.resource.data.userId);
    }

    // Alerts collection (staff can create, admin can update/delete)
    match /alerts/{alertId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && isStaffRole();
      allow delete: if isSignedIn() && isAdminRole();
    }

    // Challenges tracking collection
    match /challenges_tracking/{challengeId} {
      allow read: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        isAssignedCoach(resource.data.userId) ||
        isStaffRole()
      );
      allow write: if isSignedIn() && isOwner(request.resource.data.userId);
    }

    // Coach notes collection
    match /coachNotes/{noteId} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.coachId ||
        request.auth.uid == resource.data.userId ||
        isStaffRole()
      );
      allow write: if isSignedIn() && request.auth.uid == request.resource.data.coachId;
    }

    // Daily inspirations collection (admin only write)
    match /dailyInspirations/{inspirationId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && isAdminRole();
    }

    // Daily quotes collection (admin only write)
    match /dailyQuotes/{quoteId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && isAdminRole();
    }

    // Flagged content collection (staff only read/update/delete)
    match /flaggedContent/{flagId} {
      allow read: if isSignedIn() && isStaffRole();
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && isStaffRole();
    }

    // Goals tracking collection
    match /goals_tracking/{trackingId} {
      allow read: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        isAssignedCoach(resource.data.userId) ||
        isStaffRole()
      );
      allow write: if isSignedIn() && isOwner(request.resource.data.userId);
    }

    // Meetings collection (user-logged meeting attendance)
    match /meetings/{meetingId} {
      allow read: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        isAssignedCoach(resource.data.userId) ||
        isStaffRole()
      );
      allow create: if isSignedIn() && isOwner(request.resource.data.userId);
      allow update, delete: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        isStaffRole()
      );
    }

    // Milestones collection (global reference data)
    match /milestones/{milestoneId} {
      allow read: if isSignedIn();  // Any authenticated user can read global milestones
      allow write: if false;  // Only admins via Admin SDK can write
    }

    // Pledges collection
    match /pledges/{pledgeId} {
      allow read: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        isAssignedCoach(resource.data.userId) ||
        isStaffRole()
      );
      allow write: if isSignedIn() && isOwner(request.resource.data.userId);
    }

    // Streaks collection (document ID is user ID)
    match /streaks/{streakId} {
      allow read: if isSignedIn() && (
        streakId == request.auth.uid ||
        isAssignedCoach(streakId) ||
        isStaffRole()
      );
      allow write: if isSignedIn() && streakId == request.auth.uid;
    }

    // Objectives collection (goal objectives/sub-tasks)
    match /objectives/{objectiveId} {
      allow read: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        request.auth.uid == get(/databases/$(database)/documents/users/$(resource.data.userId)).data.assignedCoach
      );
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        request.auth.uid == get(/databases/$(database)/documents/users/$(resource.data.userId)).data.assignedCoach
      );
    }

    // Custom countdown goals collection (Life tab custom milestones)
    match /customCountdownGoals/{goalId} {
      allow read: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        isAssignedCoach(resource.data.userId) ||
        isStaffRole()
      );
      allow create: if isSignedIn() && isOwner(request.resource.data.userId);
      allow update, delete: if isSignedIn() && isOwner(resource.data.userId);
    }

    // Quotes collection (daily inspirational quotes - admin only write)
    match /quotes/{quoteId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && isAdminRole();
    }

    // Emergency resources collection (crisis hotlines and resources - admin only write)
    match /emergencyResources/{resourceId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && isAdminRole();
    }

    // Daily Posts collection ("My Day" feature - reflections + wins combined)
    match /dailyPosts/{postId} {
      // Anyone authenticated can read non-hidden posts, staff can read all
      allow read: if isSignedIn() &&
        (resource.data.hidden == false ||
         isStaffRole() ||
         isOwner(resource.data.userId) ||
         isAssignedCoach(resource.data.userId));

      // Anyone can create (with userId validation)
      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.content.size() > 0 &&
        request.resource.data.content.size() <= 500 &&
        request.resource.data.type in ['reflection', 'win'];

      // Only author can update/delete
      allow update, delete: if isSignedIn() &&
        resource.data.userId == request.auth.uid;

      // Comments subcollection
      match /comments/{commentId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn() &&
          request.resource.data.userId == request.auth.uid &&
          request.resource.data.content.size() > 0 &&
          request.resource.data.content.size() <= 280;
        allow update, delete: if isSignedIn() &&
          resource.data.userId == request.auth.uid;
      }
    }

    // Reported content collection (PHASE 3 - staff only read/update/delete)
    match /reportedContent/{reportId} {
      allow read: if isSignedIn() && isStaffRole();
      allow create: if isSignedIn() &&
        request.resource.data.reportedBy == request.auth.uid &&
        request.resource.data.contentType != null &&
        request.resource.data.reason != null;
      allow update, delete: if isSignedIn() && isStaffRole();
    }

    // Blocked users collection (PHASE 3)
    match /blockedUsers/{blockId} {
      allow read: if isSignedIn() && resource.data.blockedBy == request.auth.uid;
      allow create: if isSignedIn() &&
        request.resource.data.blockedBy == request.auth.uid &&
        request.resource.data.blockedUserId != null;
      allow delete: if isSignedIn() && resource.data.blockedBy == request.auth.uid;
    }

    // External meetings collection (AA/NA meetings from syncAAMeetings Cloud Function)
    match /externalMeetings/{meetingId} {
      allow read: if isSignedIn(); // Any authenticated user can read external meetings
      allow write: if false; // Only Cloud Functions can write (via Admin SDK)
    }

    // Sync logs collection (Phase 3 - admin read-only)
    match /syncLogs/{logId} {
      allow read: if isSignedIn() &&
        (request.auth.token.role == 'admin' || request.auth.token.role == 'superadmin');
      allow write: if false; // Only Cloud Functions can write via Admin SDK
    }

    // Favorite meetings subcollection (Phase 3)
    match /users/{userId}/favorites/{favoriteId} {
      allow read, write: if isSignedIn() && isOwner(userId);
    }

    // Tenants collection (multi-tenant portal management - superadmin only write)
    match /tenants/{tenantId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && isSuperAdminRole();
    }

    // Meeting attendance collection (Phase D - Meetings page)
    // Users can log their own attendance, staff can read all
    match /meetingAttendance/{attendanceId} {
      allow read: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        isAssignedCoach(resource.data.userId) ||
        isStaffRole()
      );
      allow create: if isSignedIn() && isOwner(request.resource.data.userId);
      allow update, delete: if isSignedIn() && isOwner(resource.data.userId);
    }

    // Resource progress collection (tracks PIR progress through educational resources)
    match /resourceProgress/{progressId} {
      allow read: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        isAssignedCoach(resource.data.userId) ||
        isStaffRole()
      );
      allow write: if isSignedIn() && isOwner(request.resource.data.userId);
    }

    // Documentation collection (clinical documentation)
    match /documentation/{docId} {
      allow read: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        isAssignedCoach(resource.data.userId) ||
        isStaffRole()
      );
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && isStaffRole();
    }

    // Saved meetings collection (user's saved external meetings)
    match /savedMeetings/{savedId} {
      allow read: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        isAssignedCoach(resource.data.userId) ||
        isStaffRole()
      );
      allow write: if isSignedIn() && isOwner(request.resource.data.userId);
    }

    // Guide notes collection (coach notes on resources/guides)
    match /guideNotes/{noteId} {
      allow read: if isSignedIn() && (
        isOwner(resource.data.pirId) ||
        isAssignedCoach(resource.data.pirId) ||
        isStaffRole()
      );
      allow write: if isSignedIn() && isStaffRole();
    }

    // Templates collection (document templates for e-signatures)
    match /templates/{templateId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && isStaffRole();
    }

    // Agreements collection (e-signature agreements sent for signing)
    // Note: Public read allowed for signers accessing via token (token validated in app)
    // Signers may not be authenticated users - they access via email link with token
    match /agreements/{agreementId} {
      allow read: if true; // Token validation happens in app layer
      allow create: if isSignedIn() && isStaffRole();
      allow update: if true; // Signers need to update to sign (token validated in app)
      allow delete: if isSignedIn() && isStaffRole();
    }

    // Mail collection (Firebase Email Extension - Trigger Email)
    // Allow unauthenticated create for e-signature notifications (signers access via token, not auth)
    match /mail/{mailId} {
      allow read: if isSignedIn() && isStaffRole();
      allow create: if true; // Allow from signing flow (token-authenticated signers)
      allow update, delete: if false; // Only processed by Firebase Extension
    }

    // Signed documents collection (completed e-signature documents)
    match /signedDocuments/{documentId} {
      allow read: if isSignedIn() && (
        isOwner(resource.data.pirId) ||
        isAssignedCoach(resource.data.pirId) ||
        isStaffRole()
      );
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (
        isOwner(resource.data.pirId) ||
        isStaffRole()
      );
      allow delete: if isSignedIn() && isStaffRole();
    }

    // Audit logs collection (admin portal activity tracking)
    match /auditLogs/{logId} {
      allow read: if isSignedIn() && isStaffRole();
      allow create: if isSignedIn() && isStaffRole();
      allow update, delete: if isSignedIn() && isAdminRole();
    }

    // Feedback collection (user feedback and suggestions)
    match /feedback/{feedbackId} {
      allow read: if isSignedIn() && isStaffRole();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && isStaffRole();
      allow delete: if isSignedIn() && isAdminRole();
    }

    // Technique completions collection (coping technique daily completions)
    // Supports both flat documents AND subcollection structure
    match /techniqueCompletions/{docId} {
      // Flat document structure (used by test data generator)
      allow read: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        isAssignedCoach(resource.data.userId) ||
        isStaffRole()
      );
      allow create: if isSignedIn() && isOwner(request.resource.data.userId);
      allow update, delete: if isSignedIn() && isOwner(resource.data.userId);

      // Daily completions subcollection (per-user structure)
      match /daily/{dateString} {
        allow read: if isSignedIn() && (
          isOwner(docId) ||
          isAssignedCoach(docId) ||
          isStaffRole()
        );
        allow write: if isSignedIn() && isOwner(docId);
      }
    }

    // ========================================================================
    // PHASE 8B: SAFETY & CRISIS RESPONSE SYSTEM
    // ========================================================================

    // Crisis alerts collection (Phase 8E - Admin Crisis Dashboard)
    // Read: Admin, coach assigned to PIR, superadmins
    // Create: Only system (Cloud Functions)
    // Update: Admin or assigned coach (status, notes, responseLog)
    // Delete: Never (audit trail) - admins can archive
    match /crisisAlerts/{alertId} {
      // Read: Staff can read all, coaches can read alerts for their PIRs
      allow read: if isSignedIn() && (
        isStaffRole() ||
        resource.data.coachId == request.auth.uid
      );

      // Create: Only Cloud Functions can create via Admin SDK
      allow create: if false;

      // Update: Staff or assigned coach can update specific fields only
      allow update: if isSignedIn() && (
        isStaffRole() ||
        resource.data.coachId == request.auth.uid
      ) && (
        // Only allow updating specific workflow fields
        request.resource.data.diff(resource.data).affectedKeys().hasOnly([
          'status',
          'acknowledgedAt', 'acknowledgedBy',
          'respondedAt', 'respondedBy',
          'responseNotes',
          'responseLog',
          'escalatedAt', 'escalatedTo',
          'resolvedAt', 'resolvedBy',
          'updatedAt'
        ])
      );

      // Delete: Only admins can delete (for audit purposes, prefer archiving)
      allow delete: if isSignedIn() && isAdminRole();
    }

    // Crisis detection logs collection (Phase 8B - analytics/audit)
    // Staff can read for analytics. Only Cloud Functions can write via Admin SDK
    match /crisisDetectionLogs/{logId} {
      allow read: if isSignedIn() && isStaffRole();
      allow write: if false; // Only Cloud Functions can write via Admin SDK
    }

    // AI rate limits collection (Phase 7 - rate limiting for AI features)
    // User can read/write own, staff can read all for monitoring
    match /aiRateLimits/{userId} {
      allow read: if isSignedIn() && (
        isOwner(userId) ||
        isStaffRole()
      );
      allow write: if false; // Only Cloud Functions can write via Admin SDK
    }

    // AI interactions collection (Phase 7 - AI usage logging)
    // Staff can read for analytics. Only Cloud Functions can write via Admin SDK
    match /aiInteractions/{interactionId} {
      allow read: if isSignedIn() && isStaffRole();
      allow write: if false; // Only Cloud Functions can write via Admin SDK
    }

    // OpenAI config collection (Phase 7 - Assistants API configuration)
    // Only Cloud Functions can read/write via Admin SDK
    match /_config/{configId} {
      allow read: if false;
      allow write: if false;
    }

    // ========================================================================
    // PHASE 9: AI PERSONALIZATION COLLECTIONS
    // ========================================================================

    // User preferences collection (Phase 9/Task 5.5 - Anchor preferences tracking)
    match /userPreferences/{userId} {
      allow read: if isSignedIn() && (
        isOwner(userId) ||
        isStaffRole()
      );
      allow write: if isSignedIn() && isOwner(userId);

      // Technique history subcollection
      match /techniqueHistory/{historyId} {
        allow read: if isSignedIn() && (
          isOwner(userId) ||
          isStaffRole()
        );
        allow write: if isSignedIn() && isOwner(userId);
      }

      // Insight history subcollection
      match /insightHistory/{historyId} {
        allow read: if isSignedIn() && (
          isOwner(userId) ||
          isStaffRole()
        );
        allow write: if isSignedIn() && isOwner(userId);
      }
    }

    // User oracles collection (Phase 7D - DailyOracle caching)
    match /userOracles/{userId} {
      allow read: if isSignedIn() && isOwner(userId);
      allow write: if isSignedIn() && isOwner(userId);

      // Daily oracles subcollection (cached by date)
      match /daily/{dateString} {
        allow read: if isSignedIn() && isOwner(userId);
        allow write: if isSignedIn() && isOwner(userId);
      }
    }
  }
}
